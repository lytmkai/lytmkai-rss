<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路]]></title>    <link>https://juejin.cn/post/7590421489998299155</link>    <guid>https://juejin.cn/post/7590421489998299155</guid>    <pubDate>2026-01-03T14:10:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998299155" data-draft-id="7590283328176537643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路"/> <meta itemprop="keywords" content="Kubernetes,DBA,云原生"/> <meta itemprop="datePublished" content="2026-01-03T14:10:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小猿姐"/> <meta itemprop="url" content="https://juejin.cn/user/1286882438155148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286882438155148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小猿姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:10:37.000Z" title="Sat Jan 03 2026 14:10:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>引言：</strong></h3>
<p>在云原生浪潮席卷全球的今天，各行各业都在加速数字化转型。对于构建云数据库服务（DBaaS）的团队而言，如何在保证高性能、高可用性的同时，快速迭代、降低运维复杂度，成为了核心挑战。今天，我们有幸邀请到移动云大云海山数据库管控系统的架构师丁顺，他将与我们分享移动云团队如何利用 KubeBlocks，在资源与时间有限的情况下，高效构建起其核心 DBaaS 服务的故事。他的经历不仅展现了 KubeBlocks 在实际生产环境中的强大价值，也为我们带来了对云原生数据库管理未来发展的深刻洞察。</p>
<hr/>
<h2 data-id="heading-1"><strong>第一部分：与移动云 DBaaS 架构师丁顺对话</strong></h2>
<p><strong>Q1：丁顺您好，请您简单介绍一下自己和您的工作？</strong></p>
<p><strong>丁顺：</strong> 大家好，我是丁顺，目前在移动云担任大云海山数据库管控系统的架构师。我的主要职责是规划和实现移动云自研数据库大云海山数据库的云产品化，为用户提供高效、稳定的 DBaaS 服务。</p>
<p><strong>Q2：移动云在数据库领域扮演怎样的角色？</strong></p>
<p><strong>丁顺：</strong> 移动云是中国移动旗下的云计算品牌，致力于提供全面的云服务。我们是云服务提供商，主要深耕于云原生数据库领域，在 Kubernetes 之上构建大云海山数据库的 DBaaS 服务，以满足不同企业级客户对高性能、高可靠数据库的需求。</p>
<p><strong>Q3：刚刚您提到了移动云自研的大云海山数据库。能否展开讲讲这是一款怎样的数据库产品？</strong></p>
<p><strong>丁顺：</strong> 大云海山数据库是移动云自研的数据库，是中国移动重点打造的自有品牌。它具备高扩展、高性能、高可用、高安全及低成本等特性，并全面适配主流国产芯片和操作系统，旨在为业界提供即开即用、安全可靠的数据库服务。值得一提的是，今年 8 月，大云海山数据库顺利通过了<strong>国家安全可靠测评</strong>，这是国家对其产品能力、企业资质、运维能力、未来发展的认可。</p>
<p><strong>Q4：能否分享一下当前支撑移动云 DBaaS 平台的基础技术栈？</strong></p>
<p><strong>丁顺：</strong> 我们的核心技术栈完全基于 Kubernetes 构建。作为云提供商，我们利用 Kubernetes 的强大编排和管理能力，为大云海山数据库提供稳定、弹性的运行环境。我们目前专注于构建和维护大云海山数据库的 DBaaS 服务，确保其在云环境中能够提供业界领先的数据库管理能力。</p>
<hr/>
<h2 data-id="heading-2"><strong>第二部分：困境与破局：为什么是 KubeBlocks？</strong></h2>
<p><strong>Q1：您是如何发现 KubeBlocks 的？</strong></p>
<p><strong>丁顺：</strong> 当时我们正面临从零开始构建大云海山数据库的 DBaaS 管控系统的巨大挑战，时间紧、人力缺。在技术选型调研阶段，有同事推荐了 KubeBlocks，这为我们打开了一扇新的大门。</p>
<p><strong>Q2：在接触 KubeBlocks 之前，移动云在 Kubernetes 上构建数据库服务时，主要面临哪些核心痛点和挑战？</strong></p>
<p><strong>丁顺：</strong> 痛点非常明显，可以总结为内忧和外患。</p>
<p>首先是技术上的“<strong>烟囱式开发</strong>”和“<strong>伪云原生</strong>”问题。以往每引入一种新数据库，就得从头写 Operator 和 CRD，不仅重复造轮子，而且质量参差不齐。很多自研 Operator 只是把数据库简单的“搬”上 K8s，却没解决共享内存、ulimit 等深层问题，导致性能不如人意。</p>
<p>其次是项目背景带来的<strong>资源挑战</strong>。当时我们需要在极短的时间内、用极其有限的人力，从零构建出大云海山数据库的 DBaaS 服务。同时，我们还希望它不仅是为了解决眼下的问题，更要是一个能适配多种引擎的<strong>通用管控底座</strong>。这对我们当时的团队来说，几乎是一个“不可能三角”。</p>
<p><strong>Q3：这听起来确实极具挑战。那么，KubeBlocks 是凭借什么特性打动了您，让您觉得它可以解决这些难题？</strong></p>
<p><strong>丁顺：</strong> 主要是它的“<strong>低代码模式</strong>”、“<strong>通用架构</strong>”和“<strong>强大的抽象模型</strong>”完美契合了我们的需求。</p>
<p>第一，它把数据库复杂的生命周期管理抽象成了统一的 Operator，我们<strong>只需要编写配置文件的形式开发 Addon（插件）</strong>，就能快速接入新引擎。这直接将 Operator 开发的复杂度降维了，极大地缓解了我们人力不足的压力。</p>
<p>第二，我们在做通用性 DBaaS 管控系统设计的架构选型时其实对比过三种架构方案，KubeBlocks 的设计理念（即在 Operator 层展现通用能力）与我们构想的终极方案<strong>不谋而合</strong>。它不仅能救火（解决上线时间问题），又符合我们将来的长期战略（构建通用底座）。这种高度的契合，促使我们最终决定将其作为核心底座。</p>
<p>第三，大云海山数据库作为一个持续演进的自研数据库产品，它的内核架构需要不断迭代以适应新的业务场景。这对底层的 DBaaS 管控系统提出了极高的要求：Operator 必须具备极强的灵活性，以应对未来架构的升级变化。这也是我们选择 KubeBlocks 的关键原因——其强大的<strong>抽象模型</strong>能够灵活适配大云海山数据库未来的架构演进，为我们持续迭代、提供稳定的云上服务提供了坚实的底座保障。</p>
<hr/>
<h2 data-id="heading-3"><strong>第三部分：从 0 到 1 的落地实践与价值</strong></h2>
<p><strong>Q4：目前 KubeBlocks 在移动云的落地情况如何？主要应用在哪些场景？</strong></p>
<p><strong>丁顺：</strong> 我们已经在<strong>生产环境</strong>全量上线。目前，移动云的每个大云海山数据库部署区域（Region）都部署了一套 KubeBlocks，作为大云海山数据库管控系统的核心 <strong>Operator 层</strong>。</p>
<p>它不仅支撑了大云海山数据库实例的<strong>创建、备份/恢复、扩缩容、高可用管理</strong>等核心功能，我们也正在利用它的通用性适配更多开源数据库，以验证其作为通用底座的能力。</p>
<p><strong>Q5：在将 KubeBlocks 集成到移动云现有的庞大云管体系中时，你们团队做了哪些架构层面的设计？</strong></p>
<p><strong>丁顺：</strong> 我们把 KubeBlocks 作为<strong>原子能力的提供者</strong>，集成在我们的“大云海山数据库管控平台”内部。</p>
<p>我们构建了一套<strong>三层管控平台架构</strong>：最上层是<strong>统一的业务服务层</strong>，负责处理移动云特有的计费、鉴权及容量管理等业务逻辑；中间层是<strong>管控服务层</strong>，提供独立于特定业务底座的通用数据库管控能力；底层则是<strong>Operator 层</strong>，我们基于 KubeBlocks 框架，利用其 Addon 机制来实现不同数据库引擎的组件编排、高可用切换及备份等核心运维能力。</p>
<p>这种分层的架构设计，既保留了移动云业务的灵活性，又充分利用了开源社区的技术红利。这也是我们团队在 DBaaS 架构演进中的一次重要实践。</p>
<p><strong>Q6：将核心管控层交给 KubeBlocks 后，为移动云带来了哪些实质性的改变？</strong></p>
<p><strong>丁顺：</strong> 最直观的改变就是<strong>研发效率的质变</strong>。</p>
<p>以前我们对于每个产品都需要组建一支团队去开发和维护 Operator，现在我们投入比以前更少的人力开发 KubeBlocks Addon，就能获得成熟的数据库编排能力。这让我们能把宝贵的研发资源集中在<strong>数据库自研内核的优化</strong>上，而不是消耗在重复的 K8s 运维逻辑中。</p>
<p>此外，它帮我们实现了<strong>运维经验的复用</strong>。因为 API 模型是统一的，我们为大云海山数据库积累的运维能力，可以无缝迁移到其他数据库产品上，大大降低了长期的运维成本。</p>
<p><strong>Q7：在使用过程中，遇到过什么挑战或痛点吗？</strong></p>
<p><strong>丁顺：</strong> 虽然 KubeBlocks 带来了巨大价值，但在使用过程中我们也遇到了一些挑战，希望能与社区共同探讨：</p>
<ol>
<li>
<p><strong>Addon 开发调试：</strong> 目前 Addon 开发过程中的问题调试还是个难点，有时报错信息不够明确，排查难度较大。</p>
</li>
<li>
<p><strong>API 命名相似：</strong> 我们生产环境上线较早（从 0.8 版本开始），后续的 KubeBlocks 版本中由于前向兼容或其他原因, 某些 API 字段得以保留，但是导致了新版本的一些字段和这些历史遗留的字段名称过于相似，在使用新版本 KubeBlocks 接口开发 AddOn 时容易混淆，例如 <code>cluster.spec.componentSpecs.componentDef</code> (新版本) 和 <code>cluster.spec.componentSpecs.componentDefRef</code> (老版本) 。我觉得社区有一些其它开发者可能会有同样的困扰。</p>
</li>
</ol>
<p><strong>Q8：作为一个深耕云原生技术的团队，移动云在享用开源红利的同时，是否也参与了 KubeBlocks 社区的共建？</strong></p>
<p><strong>丁顺：</strong> 当然。我们团队始终秉持“源于开源，回馈开源”的理念。在适配大云海山数据库的实战过程中，我们将在 Addon 开发及大规模生产运维中遇到的深层问题，积极整理并反馈给社区。同时，我们也贡献了大量 PR，涵盖了<strong>对 KubeBlocks 框架本身的优化</strong>以及<strong>对现有开源 Addon 的功能增强</strong>。通过与社区的紧密协作，我们不仅提升了自身产品的稳定性，也共同推动了整个开源生态的成熟。这种技术与生态的“双向奔赴”，是我们非常看重的合作模式。</p>
<hr/>
<h2 data-id="heading-4"><strong>第四部分：对未来的展望</strong></h2>
<p><strong>Q1：您是否有其他反馈或建议想和社区分享？</strong></p>
<p><strong>丁顺：</strong> 我有一个大胆的想法，有没有可能把 KubeBlocks Addon 的开发相关的流程和最佳实践，打包为一个对应的 Claude Skill？这样让 Claude Code 这样的 AI agent 具有自动开发、修改和调试 KubeBlocks Addon 的能力，那将极大地提升开发效率！</p>
<p><strong>Q2：对于刚开始评估 KubeBlocks 的同行，您会给出什么建议？</strong></p>
<p><strong>丁顺：</strong> 结合我们的经验，KubeBlocks 对于希望在 Kubernetes 上构建通用、高性能 DBaaS 平台的团队来说，是一个极其有价值的解决方案。</p>
<p>它能帮助你<strong>大幅缩短开发周期，降低运维成本，并避免重复造轮子</strong>。虽然在刚开始学习 Addon 开发时会有些挑战，但其带来的长期收益，尤其是对于希望标准化数据库运营的团队来说，是巨大的。建议深入研究其设计理念，并多参考社区现有的 Addon 案例。</p>
<hr/>
<h3 data-id="heading-5"><strong>结语：</strong></h3>
<p>感谢丁顺的精彩分享！移动云利用 KubeBlocks 成功构建大云海山数据库 DBaaS 平台的经验，充分证明了 KubeBlocks 在云原生数据库管理领域的强大能力和巨大潜力。同时，丁顺提出的挑战和建议，也为 KubeBlocks 社区指明了未来的优化方向。KubeBlocks 社区将持续听取用户反馈，不断打磨产品，致力于为开发者提供更易用、更强大、更成熟的云原生数据库管理解决方案。我们期待与更多像丁顺一样的先行者，共同推动云原生数据库生态的发展！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现自定义数据坐标系]]></title>    <link>https://juejin.cn/post/7590403249561092111</link>    <guid>https://juejin.cn/post/7590403249561092111</guid>    <pubDate>2026-01-03T14:58:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561092111" data-draft-id="7590403249561075727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现自定义数据坐标系"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T14:58:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现自定义数据坐标系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:58:24.000Z" title="Sat Jan 03 2026 14:58:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>在GIS开发中，经常需要进行数据的转换处理，特别是Shapefile数据的投影转换更是重中之重，如何高效、准确的将源数据坐标系转换到目标坐标系是我们需要研究解决的问题。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<code>GDAL</code>实现自定义数据坐标系。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 数据重投影</h2>
<p>定义一个方法<code>ShpProjection</code>用于实现Shp数据的投影转换，其中参数<code>sourcePath</code>为源数据路径，<code>targetPath</code>为目标文件路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：Shapfile 文件重投影
参数：
    -sourcePath：Shp 源文件路径
    -targetPath：投影文件目标路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ShpProjection</span>(<span class="hljs-params">sourcePath,targetPath</span>):
</code></pre>
<p>先检查源数据文件是否存在，若不存在则退出程序</p>
<pre><code class="hljs language-lua" lang="lua"># 检查Shp源文件是否存在
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(sourcePath):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"源文件存在！"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"源文件不存在：{sourcePath}"</span>)
    <span class="hljs-keyword">return</span>
</code></pre>
<p>添加<code>Shp</code>数据驱动用于创建<code>Shp</code>数据源和图层，<code>GetDriverByName</code>方法需要一个驱动器名称。还需要检查一下目标数据路径是否正常，只有在目标路径正常时才创建数据源。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 获取Shp数据驱动</span>
shpDriver = gdal.GetDriverByName(<span class="hljs-string">"ESRI Shapefile"</span>)

<span class="hljs-comment"># 检查Shp文件是否存在</span>
<span class="hljs-keyword">if</span> os.path.exists(targetPath):
    <span class="hljs-keyword">try</span>:
        shpDriver.DeleteDataSource(targetPath)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件已删除！"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件路径不存在！：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
<span class="hljs-comment"># 创建数据源</span>
targetDataSource = shpDriver.CreateDataSource(targetPath)
</code></pre>
<p>获取源数据图层信息并创建坐标系统。<code>osr</code>模块下的<code>SpatialReference</code>方法用于定义空间参考信息。其中空间参考信息具有三种形式，可以传递字符串名称，<code>EPSG</code>代码或者<code>wkt</code>形式的坐标定义内容。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1639376ec055431b9fa77b590fa03f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=n4DYVGxxLkyeDdBARLUS8CRw45c%3D" alt="" loading="lazy"/>如下采用<code>name</code>参数形式。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取Shp数据图层</span>
<span class="hljs-attr">sourceDataSource</span> = ogr.Open(sourcePath)
<span class="hljs-attr">sourceLayer</span> = sourceDataSource.GetLayer()

<span class="hljs-comment"># 获取坐标系</span>
<span class="hljs-attr">srs</span> = osr.SpatialReference(epsg=<span class="hljs-number">5646</span>)
print(f"坐标系统名称：{srs.GetName()}")
</code></pre>
<p>打印坐标系统名称如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7277df6c8ff24ab1b9c0e6f11ede6d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=d4jnjq9uhuxcUa3XCd6urVLnj2g%3D" alt="" loading="lazy"/></p>
<p>使用<code>CreateLayer</code>方法创建目标图层，本例中数据类型为<code>LineString</code>，所以<code>geom_type</code>参数为<code>ogr.wkbLineString</code>。之后遍历源图层数据，将属性字段和要素值写入投影图层之中。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Shp投影数据图层</span>
<span class="hljs-attr">geomType</span> = sourceLayer.GetGeomType()
<span class="hljs-attr">shpProjectLayer</span> = targetDataSource.CreateLayer(
    "layer",
    <span class="hljs-attr">srs</span>=srs,
    <span class="hljs-attr">geom_type</span>=ogr.wkbLineString
)

<span class="hljs-comment"># 获取源图层属性结构</span>
<span class="hljs-attr">layerDefn</span> = sourceLayer.GetLayerDefn()
print(layerDefn.GetFieldCount())

<span class="hljs-attr">fieldCount</span> = layerDefn.GetFieldCount()

<span class="hljs-comment"># 添加属性字段</span>
for i in range(fieldCount):
    <span class="hljs-attr">fieldDefn</span> = layerDefn.GetFieldDefn(i)
    shpProjectLayer.CreateField(fieldDefn)

for feature in sourceLayer:
    shpProjectLayer.CreateFeature(feature)

if <span class="hljs-attr">__name__</span>  == <span class="hljs-string">"__main__"</span>:

    <span class="hljs-attr">sourcePath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river.shp"</span>
    <span class="hljs-attr">targetPath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river_project.shp"</span>

    ShpProjection(sourcePath,targetPath)
</code></pre>
<p>运行成功之后在<code>ArcGIS</code>中打开图层属性显示如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58e526113b684b6ab3c1af7cba6721c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=kJCNyeaK0ESY2WN1chJlvzZCLk8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a4dc4a644747c482828b899e928d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=TA%2Bdz3eLQy7BEMr9kaxycOyFzRo%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ddc3c0830445109943f91df517fef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=5MeapY95NCsPpzrpD0U5vpjCbkk%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8788d47b19ab46e187f596a9b5b99b44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=MnbBwt0VVHVdoNfD9Adx1JhZTsY%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/669f936658fb476f860e9a0184728e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=3tyqHSDgdtfMfXDZ7XrK4P4DNws%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394d4909e484434da58150e19f584944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=i%2FccFaDaXIXAe4ImwxN0xSFgzCI%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb58e5f63a843d79505c4cfafe2d5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=bL4umKNXBbiCXQGIpIdrlZQJ2qA%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPGxwhRbuiRUKIpT2D2cVGQ" target="_blank" title="https://mp.weixin.qq.com/s/PGxwhRbuiRUKIpT2D2cVGQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据读写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi77nCatd4V2nuybZFIs-xA" target="_blank" title="https://mp.weixin.qq.com/s/i77nCatd4V2nuybZFIs-xA" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAVXeDrd13EexedVqOdLuxA" target="_blank" title="https://mp.weixin.qq.com/s/AVXeDrd13EexedVqOdLuxA" ref="nofollow noopener noreferrer">百度宣布，良心画图工具停服！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frk-Jxqnn5E9aXDxQiomIIg" target="_blank" title="https://mp.weixin.qq.com/s/rk-Jxqnn5E9aXDxQiomIIg" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 Shp 转换为 GeoJSON 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJg0-96t5C2CIlAB5K38kbw" target="_blank" title="https://mp.weixin.qq.com/s/Jg0-96t5C2CIlAB5K38kbw" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5lRetXg_dHYO-ZXKQnbi5Q" target="_blank" title="https://mp.weixin.qq.com/s/5lRetXg_dHYO-ZXKQnbi5Q" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真]]></title>    <link>https://juejin.cn/post/7590654280900263979</link>    <guid>https://juejin.cn/post/7590654280900263979</guid>    <pubDate>2026-01-03T13:02:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280900263979" data-draft-id="7590421489998151699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-03T13:02:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:02:56.000Z" title="Sat Jan 03 2026 13:02:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，我们已经听腻了“AI智能体”这个词。但在大多数时候，所谓的智能体还是像个只会答题的书呆子——你让它写首诗行，但让它帮你用手机订张从北京到上海的高铁票，再顺手发给秘书？它大概率会卡在第一步，或者胡乱点击一通。</p>
<p>为什么？因为它们不懂手机屏幕，也不懂人。</p>
<p>不过，阿里巴巴通义实验室最近扔出的这张王炸——<strong>MAI-UI</strong>，可能真的要改变这个局面了。这不仅仅是一个新的多模态模型，更像是一个给手机装上的“自动驾驶系统”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276979052866838949967.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276979052866838949967.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53fef54055248eabef1f09b98a04cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=Lxwv%2Bfdp2N14XnPoG1zi9ENPaZw%3D" alt="6390276979052866838949967" loading="lazy"/></a></p>
<h2 data-id="heading-0">终于学会了“张嘴问人”</h2>
<p>现在的GUI Agent（图形界面智能体）有个通病：死脑筋。</p>
<p>举个例子，你跟它说：“把我的简历发给HR。” 传统的AI会直接愣住，或者开始在他的训练数据里瞎猜，甚至可能把你的购物清单发出去。</p>
<p>MAI-UI最大的不同在于，它拥有了<strong>原生的人机交互能力</strong>。面对模糊指令，它不会盲目操作，而是会暂停下来问你：“老板，你要发哪一份简历？HR的邮箱是哪个？”</p>
<p>这听起来很简单，但在技术上却是巨大的飞跃。阿里团队在训练中引入了“拒绝采样”和专门的交互动作，治好了AI喜欢“不懂装懂”的毛病。这让它不仅仅是一个执行脚本，更像是一个懂得和你确认需求的真实助理。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276977443088257701246.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276977443088257701246.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464943b979be4fb79253c26df536882d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=%2FOyog8Kd%2BmTmOwg0uZXAwPlTrSY%3D" alt="6390276977443088257701246" loading="lazy"/></a></p>
<h2 data-id="heading-1">抄近道：不只是傻傻点屏幕</h2>
<p>以前的屏幕智能体完全依赖视觉识别——找图标、模拟点击、滑动。这在复杂APP里很容易出错，效率也低。</p>
<p>MAI-UI引入了一个很极客的功能：<strong>MCP工具调用</strong>。</p>
<p>简单说，它是个“双面手”。对于简单的界面，它像人一样去点击；但对于复杂的任务，比如“查询GitHub某仓库的最近提交”或者“计算两地驾车距离”，它会直接跳过繁琐的UI操作，在后台调用API接口（MCP）直接拿数据。</p>
<p>这一招“抄近道”，把原本需要几十次点击、容易出错的流程，压缩成了几次精准的代码调用。在MobileWorld的测试中，这让它的成功率直接甩开了最好的竞争对手30多个百分点。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfsdgdfg-1024x448.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfsdgdfg-1024x448.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26086cf21b9740c98f0fff5fe5a47d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=91zeQx0Y1IDMabXwbjI582TDJEU%3D" alt="asfsdgdfg" loading="lazy"/></a></p>
<h2 data-id="heading-2">大小脑配合，隐私也没落下</h2>
<p>把所有操作都交给云端大模型，不仅慢，还让人担心隐私——谁愿意把银行卡密码传到云端去识别？</p>
<p>MAI-UI搞了一套<strong>端云协同</strong>的架构。</p>
<ul>
<li><strong>端侧小模型（2B版本）：</strong> 住在你的手机里，反应快，负责处理日常琐事，盯着屏幕状态，绝不泄露隐私。</li>
<li><strong>云端大模型（235B版本）：</strong> 遇到复杂的逻辑推理难题时，端侧搞不定了，才会请云端的大脑介入。</li>
</ul>
<p>这种动态调度，让端侧任务成功率提升了33%，同时还可以减少40%的云端调用。既省了流量和算力，又保住了你的隐私。</p>
<h2 data-id="heading-3">战绩如何？数据说话</h2>
<p>别光听概念，看看硬指标。在目前的GUI智能体竞技场上，MAI-UI的表现可以用“霸榜”来形容。</p>
<p>在著名的<strong>AndroidWorld</strong>基准测试中，MAI-UI拿下了<strong>76.7%<strong>的成功率。 这个成绩意味着什么？它直接超越了Google的</strong>Gemini-2.5-Pro</strong>，也击败了之前的开源强者<strong>UI-Tars-2</strong>。即便是只有2B参数的端侧小模型，其表现也比同级别的Ferret-UI Lite高出了整整21个百分点。</p>
<p>这背后，是阿里在一个拥有500多个并行环境的“虚拟手机农场”里，通过大规模在线强化学习（Online RL）反复操练的结果。它见识过各种弹窗广告、UI漂移和突发状况，所以比温室里长大的模型更抗造。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdasddfgsfg.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdasddfgsfg.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4652c3f24374a2dade0c75619dab6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=wcQj1xDs6Rw93IkeXrUd1lKAmxU%3D" alt="asdasddfgsfg" loading="lazy"/></a></p>
<h2 data-id="heading-4">写在最后</h2>
<p>好消息是，通义实验室并没有把这个好东西藏着掖着。目前，<strong>MAI-UI的2B和8B模型权重、代码已经在GitHub开源</strong>，连同那个高难度的评测基准MobileWorld也一并放了出来。</p>
<p>对于开发者来说，这意味着我们离“动动嘴，手机自动帮我搞定一切”的科幻场景，又近了一大步。或许不久的将来，你的手机操作系统里，就住着这样一个不仅看得懂屏幕，还懂得这什么时候该问你、什么时候该自己动手的“真·智能助理”。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用另一种方式让《留白》继续存在下去]]></title>    <link>https://juejin.cn/post/7590592594675449866</link>    <guid>https://juejin.cn/post/7590592594675449866</guid>    <pubDate>2026-01-03T13:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594675449866" data-draft-id="7590608345923321882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 用另一种方式让《留白》继续存在下去"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codelang"/> <meta itemprop="url" content="https://juejin.cn/user/184373682638727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             用另一种方式让《留白》继续存在下去
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373682638727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codelang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:16:00.000Z" title="Sat Jan 03 2026 13:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近翻阅相册，旧旧的照片有一张独特的排版，思绪一下就把我拉回了从前，这张照片是《留白》App 编辑生成的，一款非常具有艺术感的 App。《留白》是我前司创始人开发的 App，当时用户量还挺多的，首页还会推荐一些摄影师拍摄的作品。</p>
<p>最近想从 App Store 重新下载把玩下发现，该应用下架很多年了，并且从一些三方渠道拿到的 Apk 都是 32 位的，现在主流的手机已经无法安装了，通过知乎发现，已经很久没有维护了：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e38667791f4f02953aaabf7afa0121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=Z41Ogiw49Fu8sN4sqHgbU%2BqutQ8%3D" alt="" width="50%" loading="lazy"/></p>
<p>这款独特又小众的 App 无法使用着实有点可惜，留白的 preview 页：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb00349a20b94d2594b4a2308891c7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=mck2h5tJ621XSN2xKz%2FWJUKX2%2B0%3D" alt="" width="30%" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b5756d58718459789f3f06c268c0d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=UDcVQcUKYZXHWj5iGGDUHPEbw0U%3D" alt="" width="30%" loading="lazy"/></p>
<p>所以，我萌生了一个想法，基于强大的 AI 能力，让这款产品重新再现一下，说干就干。</p>
<p>开发步骤：</p>
<ul>
<li>技术选型：最主要是实现快，能快速验证思路与想法，最终敲定下来用 react</li>
<li>AI 编码：最终敲定下来是 claude clode(后文简称 cc) + 智谱 GLM-4.7</li>
<li>部署体验：将 react 部署到线上体验</li>
<li>终极体验：将 react 实现的能力，让 AI 翻译成微信小程序，部署到微信小程序中</li>
</ul>
<p>在技术选型中，我最先思考的是如何快速实现自己想要的效果，相比较知识库与社区的成熟度，对于 AI 来说，生成前端的正确率会比移动端会高点，并且能快速的调试。我将留白 preview 图片丢给了 cc，让 cc 按照该图生成前端应用，并为该图增加了滤镜、字体、主题等一类设置，如下是实现效果，你也可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fliubai-white.vercel.app%2F" target="_blank" title="https://liubai-white.vercel.app/" ref="nofollow noopener noreferrer">liubai-white.vercel.app/</a> 进行试玩：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31964fc0a39548f5ac52c0ae5421a470~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=ioLPMdUyc6mQLDFMPHf5UHbQj8Q%3D" alt="" width="30%" loading="lazy"/></p>
<p>cc + 智谱 GLM-4.7 的生成效果与正确率还是蛮惊艳的，并没有因为一个错误的解决而无限陷入另一种错误。</p>
<p>在经过各种细节与优化中，我发现这种方案可行，但提供网页让用户使用的话，一个是体验不佳，另一个是没有人会记住一个网址，所以，我决定将这个方案的实现迁移到微信小程序。</p>
<p>起初，我了解到 Taro + react 是可以生成微信小程序代码的，我尝试让 cc 将 react 转成 Taro 模式，然后让 Taro 编译 react 代码生成微信小程序项目，但经过我各种调试，都无法达成满意的效果，最主要的原因是 react 很多库的实现，在微信小程序上没有，Taro 无法进行转译，所以，这种方案我立马放弃了。</p>
<p>最终还是直接让 cc 翻译了 react 的项目结构，并生成了项目的功能指南，接着我让 cc 重新创建了个 miniapp 的目录，让他读取 react 代码与功能指南，重新生成微信小程序项目。</p>
<blockquote>
<p><em>未来，AI 也可能是跨端的另一种实现</em></p>
</blockquote>
<p>转义的效果依然非常惊艳，第一把就成功了，预览效果与 react 差不多，但细节还需要再做下处理，本以为没啥大问题，当我将图片下载下来时发现，各种排版错乱。检查了下项目代码实现，在微信小程序中，页面布局的展示是通过 wxml 渲染的，但生成图片是通过 canvas 画的，也就是说，canvas 要对着 wxml 的 css 进行转义，而且 AI 的转义能力特别弱，即使我用 cursor+opus 尝试过，也是一塌糊涂，如果界面渲染排版发生了变动，AI 又会忘了 canvas 也要变动， 在这块的调试上吃了太多力气。那怎么办呢，只能给 cc 添加更多的 rules 规则，去定制规则并且限制他的随意发挥。</p>
<p>经过各种调试对垒，第一版的 留白 微信小程序实现啦，效果图如下：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed6829a1d65b4f3fbda8401d15784330~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=yq4URonmqcw2Pq%2FfYAvMtyIc5fI%3D" alt="" width="30%" loading="lazy"/></p>
<p>如果你想体验的话，可以扫如下的小程序码：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b519caccf89c4499bf0250eb2b20b89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=C6Yr8XXlm93u7GVXEvWr15zSUSI%3D" alt="" width="30%" loading="lazy"/></p>
<p>有任何体验的问题，或是对 AI Coding 有想法的，都可以在公众号中找到我的联系方式。</p>
<p>元旦这三天智谱的 tokens 消耗：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30c892a91c24216be5ade417fd9d903~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=NSQhzkjXeKSD6%2F3Ze6RP2GtdNfE%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>对于 AI Coding ，我有一点想说：</p>
<blockquote>
<p>随着大模型越来越强，我觉得用谁家的模型会变得没那么重要，比如我用的智谱GLM 就能帮我实现非常惊艳的能力，我觉得当前最重要的还是工具，我非常推荐 claude code，Anthropic 这家公司一直走在 AI Coding 的最前沿，无论是 mcp、cli，还是最近非常火热的 skills 、subAgent，他总能从工程化思维去解决你的问题，让 AI 代码生成的更可靠。比如 prompt 的拆解与注入、token 如何减少消耗、上下文污染如何规避等等。</p>
<p>2026 年，AI Coding 一定是往更可靠的大方向走，但要想更可靠，交给开发者肯定是不足够的，一定是有很多工具去辅助开发者更可靠才行。</p>
<p>正如 Anthropic 首席产品官 Mike Krieger 所说的：</p>
<p><strong/> 能可靠地接过你手里的活儿。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025我常用的 AI 产品]]></title>    <link>https://juejin.cn/post/7590309337861373993</link>    <guid>https://juejin.cn/post/7590309337861373993</guid>    <pubDate>2026-01-03T13:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861373993" data-draft-id="7590283328176504875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025我常用的 AI 产品"/> <meta itemprop="keywords" content="程序员,全栈,招聘"/> <meta itemprop="datePublished" content="2026-01-03T13:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KaneLogger"/> <meta itemprop="url" content="https://juejin.cn/user/3650034333917031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025我常用的 AI 产品
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034333917031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KaneLogger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:40:34.000Z" title="Sat Jan 03 2026 13:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>宗旨：用"好 AI"，用好 AI。</p>
</blockquote>
<p>之前专门写过一篇文章，里面有很多产品，但是品类太多了，其实平时用的也就那么几个，写这篇文章的目的也是总结自己平时使用的产品，以及自己是如何使用的。</p>
<p>在用好 AI 之前，应该多用用业界最好的 AI 产品。</p>
<p>如何知道现在哪类模型好呢？除了用户评价，还可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2Fzh%2Fleaderboard" target="_blank" title="https://lmarena.ai/zh/leaderboard" ref="nofollow noopener noreferrer">lmarena</a> 大模型竞技场上找找，当然最重要的还是多用多体验。</p>
<h3 data-id="heading-0">对话</h3>









































<table><thead><tr><th>平台</th><th>响应速度</th><th>应用场景</th><th>费用</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">Gemini</a></td><td>⭐⭐⭐⭐⭐</td><td>长文本、图片（nano banana）</td><td>Pro 版：140 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.doubao.com" target="_blank" title="https://www.doubao.com" ref="nofollow noopener noreferrer">豆包</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2Fai-tool%2Fhome" target="_blank" title="https://jimeng.jianying.com/ai-tool/home" ref="nofollow noopener noreferrer">即梦</a>)</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com" target="_blank" title="https://www.kimi.com" ref="nofollow noopener noreferrer">Kimi</a></td><td>⭐⭐⭐⭐</td><td>长文本</td><td>Andante 49 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.qwen.ai%2F" target="_blank" title="https://chat.qwen.ai/" ref="nofollow noopener noreferrer">通义千问</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fi%2Fgrok" target="_blank" title="https://x.com/i/grok" ref="nofollow noopener noreferrer">Grok</a></td><td>⭐⭐⭐⭐</td><td>特攻：推特爬虫</td><td>免费就够用了</td></tr></tbody></table>
<h3 data-id="heading-1">图像</h3>
<p>这个赛道比较窄，z-image\mj\flux 能用，艺术感强，光影细节处理也很成熟，但是上手成本也比较高，适合专业人士做商业插图。我常用的只有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fapp" target="_blank" title="https://gemini.google.com/app" ref="nofollow noopener noreferrer">nano banana</a> 可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">ai studio</a> 中使用，缺点是没有系统给的提示词，也可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fboards" target="_blank" title="https://youmind.com/boards" ref="nofollow noopener noreferrer">youmind</a> 这些产品中使用。官网每天三张，API 调用，平均一张 2k 图 1 元。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2F" target="_blank" title="https://jimeng.jianying.com/" ref="nofollow noopener noreferrer">即梦</a> 基础会员 69 元/月，每日 60 免费积分，可生成 20-50 张图。</li>
</ul>
<h3 data-id="heading-2">编程</h3>
<ul>
<li>【terminal】Claude code + 国产模型 minmax/kimi k2/GLM-4.6 Pro</li>
<li>【IDE】trae 首月 21rmb/月 后续 70rmb/月</li>
<li>【IDE】cursor 付费 pro 140rmb/月 pro+ 420rmb/月 ultra400rmb/月</li>
<li>【terminal】gemini cli</li>
<li>【IDE】其他偶尔可薅羊毛 qcoder、CodeBuddy、antigravity、kiro、vs code</li>
</ul>
<h3 data-id="heading-3">全家桶</h3>
<ul>
<li>Gemini 全家桶
<ul>
<li>Gemini + nano banana + notebookLM 办公套件</li>
<li>Veo 文生视频</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstitch.withgoogle.com%2F" target="_blank" title="https://stitch.withgoogle.com/" ref="nofollow noopener noreferrer">stitch</a> Google 推出的 AI 辅助 UI 原型设计工具</li>
<li>antigravity 编辑器</li>
<li>gemini cli 终端工具</li>
</ul>
</li>
<li>豆包 全家桶
<ul>
<li>豆包</li>
<li>seedream 文生图</li>
<li>seedance 文生视频</li>
<li>trae 编辑器</li>
</ul>
</li>
<li>gpt 全家桶
<ul>
<li>chatGPT 对话、图片</li>
<li>sora 视频</li>
<li>codex</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">我的订阅</h3>
<ul>
<li>对话(画图)部分：Gemini + 豆包 + kimi + 偶尔 qwen + 爬虫 Grok</li>
<li>编程：claude code(minmax) + cursor</li>
<li>知识库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnotebooklm.google.com%2F" target="_blank" title="https://notebooklm.google.com/" ref="nofollow noopener noreferrer">notebookLM(ppt 思维导图)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2F" target="_blank" title="https://ima.qq.com/" ref="nofollow noopener noreferrer">ima（知识库管理）</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fzh-CN%2F" target="_blank" title="https://youmind.com/zh-CN/" ref="nofollow noopener noreferrer">youmind（整理碎片想法信息）</a></li>
<li>工作流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2F" target="_blank" title="https://www.coze.cn/" ref="nofollow noopener noreferrer">coze(配合飞书)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n（本地工作流）</a></li>
</ul>
<h4 data-id="heading-5">智能体</h4>
<p>还没花过钱，基本上用在研报上。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.coze.cn%2Fspace-intro" target="_blank" title="https://space.coze.cn/space-intro" ref="nofollow noopener noreferrer">扣子空间</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.manus.ai%2F" target="_blank" title="https://www.manus.ai/" ref="nofollow noopener noreferrer">manus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fautoglm.zhipuai.cn%2F" target="_blank" title="https://autoglm.zhipuai.cn/" ref="nofollow noopener noreferrer">AutoGLM</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fithy.com%2F" target="_blank" title="https://ithy.com/" ref="nofollow noopener noreferrer">ithy</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.perplexity.ai%2F" target="_blank" title="https://www.perplexity.ai/" ref="nofollow noopener noreferrer">Perplexity（国外网站）</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔 AI 搜索</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目]]></title>    <link>https://juejin.cn/post/7590330924001148991</link>    <guid>https://juejin.cn/post/7590330924001148991</guid>    <pubDate>2026-01-03T12:05:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001148991" data-draft-id="7590283328176422955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:05:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:05:46.000Z" title="Sat Jan 03 2026 12:05:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目</h2>
<h3 data-id="heading-1">一、项目背景：为什么要做“乱停放识别”？</h3>
<p>随着共享单车在城市中的高密度投放，“最后一公里”出行问题得到了极大缓解，但随之而来的<strong>随意停放、占道堆积、盲道阻塞</strong>等问题，也成为城市治理中的一大痛点。</p>
<p>在实际城市管理中，传统处理方式主要依赖以下手段：</p>
<ul>
<li>人工巡查（成本高、效率低）</li>
<li>群众举报（滞后、不可控）</li>
<li>简单规则检测（误报率高）</li>
</ul>
<p>这些方式很难应对<strong>大规模、全天候、动态变化</strong>的街景环境。因此，<strong>基于计算机视觉的自动化识别方案</strong>成为一种必然选择。</p>
<p>本项目的目标是：</p>
<blockquote>
<p>🎯 <strong>构建一套完整、可落地的共享单车/自行车乱停放智能识别系统</strong>
覆盖：<strong>数据 → 训练 → 推理 → UI → 部署</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a011a718814ebebcfa89fa2a0d3276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=EMuSVG2QJHBt%2BMjPU6xwCqk0938%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-2">源码下载与效果演示</h4>
<p>哔哩哔哩视频下方观看：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HxKbzSEco%2F" target="_blank" title="https://www.bilibili.com/video/BV1HxKbzSEco/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Hx…</a></p>
</blockquote>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae2a78a2ee443b49eead838e20fbf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YnLoovTWrUtxjAbHV5GXDljxZWU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计思路</h3>
<p>从工程角度出发，本项目并非“单一模型测试”，而是完整的软件系统，整体架构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">数据采集 → 数据标注 → YOLOv8模型训练
<span class="hljs-code">        ↓
   模型评估与调优
        ↓
PyQt5 可视化检测系统
        ↓
图片 / 视频 / 摄像头 / 批量检测
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02eadcd68dd64b5ab658d627540a6c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=bCht76tGG1NlMQ96bRbU4kutmjU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124b8b176c804f628f43cb20330e1206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YWdzfvfft27MtoRLQnhi7hc2DLk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4">系统核心组成模块</h4>

































<table><thead><tr><th>模块</th><th>说明</th></tr></thead><tbody><tr><td>目标检测模型</td><td>YOLOv8 Detection</td></tr><tr><td>深度学习框架</td><td>PyTorch</td></tr><tr><td>图形界面</td><td>PyQt5</td></tr><tr><td>推理方式</td><td>图片 / 文件夹 / 视频 / 摄像头</td></tr><tr><td>输出形式</td><td>标注图像 / 视频文件</td></tr><tr><td>使用方式</td><td>开箱即用 / 可二次开发</td></tr></tbody></table>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90dbc7fbcbf448e29f1210bcd805b078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=8BfBVWK6S4uGZRVSOaHbnEgsl2o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">三、YOLOv8 模型选型与原理分析</h3>
<h4 data-id="heading-6">3.1 为什么选择 YOLOv8？</h4>
<p>在众多目标检测模型中（Faster R-CNN、SSD、YOLOv5/7 等），YOLOv8 具备以下明显优势：</p>
<ul>
<li><strong>Anchor-Free 架构</strong>：减少人为超参依赖</li>
<li><strong>更高的推理速度</strong>：适合实时摄像头场景</li>
<li><strong>Ultralytics 官方生态完善</strong>：训练、推理、导出一步到位</li>
<li><strong>对小目标更友好</strong>：适合街景中密集单车检测</li>
</ul>
<h4 data-id="heading-7">3.2 YOLOv8 Detection 架构概览</h4>
<p>YOLOv8 仍然遵循经典的三段式结构：</p>
<ul>
<li><strong>Backbone</strong>：特征提取（C2f + CSP 思想）</li>
<li><strong>Neck</strong>：多尺度特征融合（FPN + PAN）</li>
<li><strong>Head</strong>：Anchor-Free 检测头</li>
</ul>
<p>其核心改进点在于：</p>
<ul>
<li>Task-Aligned Assigner</li>
<li>解耦式检测头</li>
<li>DFL（Distribution Focal Loss）</li>
</ul>
<p>这些设计显著提升了模型在复杂场景下的稳定性。</p>
<hr/>
<h3 data-id="heading-8">四、数据集构建与标注规范</h3>
<h4 data-id="heading-9">4.1 数据来源与采集</h4>
<p>数据主要来自：</p>
<ul>
<li>城市街景实拍</li>
<li>公共道路监控截图</li>
<li>不同天气 / 光照 / 角度场景</li>
</ul>
<p>重点覆盖以下情况：</p>
<ul>
<li>随意堆叠停放</li>
<li>占用盲道、人行道</li>
<li>路口密集区域</li>
<li>单车与背景高度相似场景</li>
</ul>
<h4 data-id="heading-10">4.2 YOLO 数据集结构</h4>
<p>采用标准 YOLOv8 数据集格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
├── labels/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
</code></pre>
<h4 data-id="heading-11">4.3 标注格式说明</h4>
<p>每一行标签格式如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">class_id</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">x_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">y_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">width</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">height</span>&gt;</span>
</code></pre>
<p>坐标全部采用 <strong>归一化比例值</strong>，便于模型泛化。</p>
<hr/>
<h3 data-id="heading-12">五、模型训练流程与参数配置</h3>
<h4 data-id="heading-13">5.1 训练命令示例</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
  data=dataset/bike.yaml \
  model=yolov8n.pt \
  epochs=100 \
  batch=16 \
  imgsz=640 \
  lr0=0.001
</code></pre>
<h4 data-id="heading-14">5.2 训练过程关注指标</h4>
<ul>
<li>box_loss（定位误差）</li>
<li>cls_loss（分类误差）</li>
<li>dfl_loss（边界框分布）</li>
<li>mAP@0.5 / mAP@0.5:0.95</li>
</ul>
<blockquote>
<p>在实验中，当 mAP@0.5 稳定在 <strong>90% 以上</strong>，模型已具备实际部署价值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">六、模型推理与检测结果分析</h3>
<h4 data-id="heading-16">6.1 Python 推理示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-17">6.2 输出结果内容</h4>
<ul>
<li>检测框位置</li>
<li>类别名称</li>
<li>置信度评分</li>
<li>自动保存标注图像</li>
</ul>
<p>模型在复杂街景、遮挡场景下仍能保持较好鲁棒性。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab73f230ad842a8ad2bbe8bce614cc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=hJZBS6Qioq1WdLE72RqO69jOOYU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">七、PyQt5 可视化检测系统设计</h3>
<h4 data-id="heading-19">7.1 为什么要做 GUI？</h4>
<p>对于实际使用者（城管、运营人员、学生演示）来说：</p>
<blockquote>
<p>❌ 命令行 ≠ 易用
✅ 可视化界面 = 真正可用系统</p>
</blockquote>
<h4 data-id="heading-20">7.2 支持功能一览</h4>
<ul>
<li>📷 单张图片检测</li>
<li>📁 文件夹批量检测</li>
<li>🎞️ 视频文件检测</li>
<li>🎥 实时摄像头检测</li>
<li>💾 结果保存开关</li>
</ul>
<h4 data-id="heading-21">7.3 系统运行方式</h4>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>无需任何深度学习基础，即可完成检测。</p>
<hr/>
<h3 data-id="heading-22">八、工程落地与应用场景</h3>
<p>本系统可直接应用于：</p>
<ul>
<li>🚦 城市智慧城管</li>
<li>🏙️ 智慧园区管理</li>
<li>🚴‍♂️ 共享单车运维监管</li>
<li>🎓 计算机视觉教学/毕设</li>
</ul>
<p>同时，该项目也可作为 <strong>YOLOv8 + GUI 工程模板</strong>，快速迁移到其他检测任务。</p>
<hr/>
<h3 data-id="heading-23">九、完整源码与资源说明</h3>
<p>项目已打包提供：</p>
<ul>
<li>✔️ 完整训练代码</li>
<li>✔️ 数据集与标注</li>
<li>✔️ 训练权重文件</li>
<li>✔️ PyQt5 可视化系统</li>
<li>✔️ 一键运行脚本</li>
</ul>
<p>适合：</p>
<blockquote>
<p>毕业设计 / 科研实验 / 技术复现 / 二次开发</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">十、总结</h3>
<p>本项目不仅是一次 YOLOv8 模型实践，更是一套<strong>从算法到系统、从实验到落地</strong>的完整工程方案。</p>
<p>如果你希望：</p>
<ul>
<li>系统性掌握目标检测工程</li>
<li>做一个“真正能跑”的 AI 项目</li>
<li>拥有可展示、可部署、可扩展的成果</li>
</ul>
<p>那么，这个项目会是一个非常理想的起点。</p>
<p>本文围绕共享单车/自行车乱停放这一典型的城市治理痛点，完整介绍了一套基于 YOLOv8 目标检测模型 + PyQt5 可视化界面 的智能识别系统。从问题背景出发，系统性地阐述了模型选型理由、数据集构建方式、训练与评估流程，以及多输入源（图片、视频、摄像头、批量文件）的工程化落地实现。该项目不仅在算法层面验证了 YOLOv8 在复杂街景下的高精度与实时性优势，更通过图形化界面降低了使用门槛，使模型真正具备可部署、可使用、可扩展的工程价值。整体方案兼顾技术深度与实用性，既可直接应用于智慧城管与共享单车监管场景，也可作为目标检测教学、毕业设计和二次开发的完整实践范例。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于大模型的智能读报助手]]></title>    <link>https://juejin.cn/post/7590330924001165375</link>    <guid>https://juejin.cn/post/7590330924001165375</guid>    <pubDate>2026-01-03T12:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001165375" data-draft-id="7590309337861226537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于大模型的智能读报助手"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-03T12:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Livingbody"/> <meta itemprop="url" content="https://juejin.cn/user/4213771487417944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于大模型的智能读报助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4213771487417944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Livingbody
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:10:10.000Z" title="Sat Jan 03 2026 12:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、《人民日报》工具箱简介</h2>
<p>这是一个用于人民日报PDF完整工作流程的Python工具集，支持从网站下载、文本提取到AI智能分析的全流程处理。</p>
<h3 data-id="heading-1">1.🎯 功能特性</h3>
<h4 data-id="heading-2">1.1📥 <strong>PDF下载功能</strong></h4>
<ul>
<li>🌐 自动从人民日报官网下载指定日期的PDF版报纸</li>
<li>📄 自动检测报纸版面数量（通常8-16版）</li>
<li>🔄 智能合并多个版面为一个完整的PDF文件</li>
<li>⏰ 支持指定日期下载和批量下载</li>
</ul>
<h4 data-id="heading-3">1.2📖 <strong>PDF文本提取</strong></h4>
<ul>
<li>🔍 使用PyPDF2库精确提取PDF文件中的文本内容</li>
<li>📝 处理各种PDF格式和编码</li>
<li>🛡️ 容错处理，防止提取失败影响整体流程</li>
</ul>
<h4 data-id="heading-4">1.3🤖 <strong>AI智能分析</strong></h4>
<ul>
<li>🧠 基于大语言模型对人民日报内容进行深度分析</li>
<li>📊 自动分类识别：重大事件、评论文章、金句典故、优秀词组</li>
<li>📋 生成结构化的Markdown格式分析报告</li>
<li>💡 支持流式输出，实时显示分析过程</li>
</ul>
<h3 data-id="heading-5">2.🎯 扩展用例</h3>
<ul>
<li>🧠 手机端定时爬取《人民日报》，如每天早晨7:00爬取当日《人民日报》</li>
<li>📊 自动分析当日报纸精华，并存入obsidian笔记</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29815171f81744d0b647e45d3e516d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=qspHGVvg7x4C9cnYPre%2BWPtg4FY%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31ca22469dd4c02bfe394be5545c8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=JxK8BTyq3T44tAzyaeiPhENcMFk%3D" alt="" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c6db3ba59ad45b7bc93b83fe7875aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGl2aW5nYm9keQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768047203&amp;x-signature=LpiBytdhBlmAathg%2Byif5NALMW0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.🏗️ 项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">xx/
├── rmrb_down.py              <span class="hljs-comment"># 人民日报PDF下载工具</span>
├── readpdf.py                <span class="hljs-comment"># PDF文本提取工具  </span>
├── note_for_rmrb.py          <span class="hljs-comment"># 人民日报AI智能分析工具</span>
├── requirements.txt          <span class="hljs-comment"># 项目依赖列表</span>
├── README.md                <span class="hljs-comment"># 项目说明文档</span>
└── storage/
    └── downloads/
        └── rmrb/            <span class="hljs-comment"># 下载的PDF文件存储目录</span>
            └── rmrb_YYYY-MM-DD.pdf
└── 人民日报_YYYY-MM-DD.md    <span class="hljs-comment"># AI分析结果输出文件</span>
</code></pre>
<h2 data-id="heading-7">二、安装说明</h2>
<h3 data-id="heading-8">1. 环境准备</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保Python版本 &gt;= 3.7</span>
python --version
</code></pre>
<h3 data-id="heading-9">2. 克隆项目</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/livingbody/People_Daily_Toolkit
<span class="hljs-built_in">cd</span> People_Daily_Toolkit
</code></pre>
<h3 data-id="heading-10">3. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<p><strong>依赖库列表</strong>：</p>
<ul>
<li><code>requests==2.31.0</code> - HTTP请求库，用于网页抓取</li>
<li><code>beautifulsoup4==4.12.2</code> - HTML解析库，用于网页内容解析</li>
<li><code>PyPDF2==3.0.1</code> - PDF处理库，用于文件读取和合并</li>
<li><code>openai==1.58.1</code> - OpenAI API库，用于大模型调用</li>
</ul>
<pre><code class="hljs language-python" lang="python">!git clone https://github.com/livingbody/People_Daily_Toolkit
!pip install -r People_Daily_Toolkit/requirements.txt
</code></pre>
<h2 data-id="heading-11">三、使用方法</h2>
<h3 data-id="heading-12">1.报纸PDF下载</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 本项目用于从人民日报网站下载指定日期的PDF版报纸，并将多个版面合并为一个完整的PDF文件</span>
<span class="hljs-comment"># 作者: livingbody</span>
<span class="hljs-comment"># pip install requests beautifulsoup4 PyPDF2</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">import</span> PyPDF2
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date, datetime, timedelta
<span class="hljs-keyword">import</span> re


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_page_count</span>(<span class="hljs-params">url</span>):
    <span class="hljs-string">"""
    获取报纸的总版面数
    
    参数:
        url: 报纸版面目录页的URL
    
    返回值:
        int: 总版面数
    """</span>
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=<span class="hljs-number">10</span>)
        response.encoding = <span class="hljs-string">'utf-8'</span>
        soup = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
        
        <span class="hljs-comment"># 查找所有版面链接</span>
        page_links = soup.find_all(<span class="hljs-string">'a'</span>, href=<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">and</span> <span class="hljs-string">'node_'</span> <span class="hljs-keyword">in</span> x <span class="hljs-keyword">and</span> <span class="hljs-string">'.html'</span> <span class="hljs-keyword">in</span> x)
        
        <span class="hljs-comment"># 提取版面编号并找到最大的编号</span>
        max_page = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> page_links:
            <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r'node_(\d+)\.html'</span>, link.get(<span class="hljs-string">'href'</span>))
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
                page_num = <span class="hljs-built_in">int</span>(<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>))
                max_page = <span class="hljs-built_in">max</span>(max_page, page_num)
                
        <span class="hljs-keyword">return</span> max_page
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取版面数量失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>  <span class="hljs-comment"># 默认返回8版</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pdf_urls</span>(<span class="hljs-params">base_url, date_str</span>):
    <span class="hljs-string">"""
    获取所有版面的PDF文件URL
    
    参数:
        base_url: 人民日报网站的基础URL
        date_str: 日期字符串，格式为'YYYY-MM-DD'
    
    返回值:
        list: PDF文件URL列表
    """</span>
    year, month, day = date_str.split(<span class="hljs-string">'-'</span>)
    
    <span class="hljs-comment"># 构建版面目录页URL</span>
    catalog_url = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/node_01.html"</span>
    
    <span class="hljs-comment"># 获取版面数量</span>
    page_count = get_page_count(catalog_url)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发现 <span class="hljs-subst">{page_count}</span> 个版面"</span>)
    
    pdf_urls = []
    
    <span class="hljs-comment"># 遍历所有版面</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, page_count + <span class="hljs-number">1</span>):
        <span class="hljs-comment"># 构建当前版面的URL</span>
        page_url = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/node_<span class="hljs-subst">{i:02d}</span>.html"</span>
        
        <span class="hljs-keyword">try</span>:
            response = requests.get(page_url, timeout=<span class="hljs-number">10</span>)
            response.encoding = <span class="hljs-string">'utf-8'</span>
            soup = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
            
            <span class="hljs-comment"># 查找PDF链接</span>
            pdf_link = soup.find(<span class="hljs-string">'a'</span>, href=<span class="hljs-keyword">lambda</span> x: x <span class="hljs-keyword">and</span> x.endswith(<span class="hljs-string">'.pdf'</span>))
            
            <span class="hljs-keyword">if</span> pdf_link:
                pdf_href = pdf_link.get(<span class="hljs-string">'href'</span>)
                <span class="hljs-comment"># 如果是相对URL，则构建绝对URL</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pdf_href.startswith(<span class="hljs-string">'http'</span>):
                    <span class="hljs-keyword">if</span> pdf_href.startswith(<span class="hljs-string">'/'</span>):
                        pdf_href = base_url + pdf_href
                    <span class="hljs-keyword">else</span>:
                        pdf_href = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/rmrb/pc/layout/<span class="hljs-subst">{year}</span><span class="hljs-subst">{month}</span>/<span class="hljs-subst">{day}</span>/<span class="hljs-subst">{pdf_href}</span>"</span>
                
                pdf_urls.append(pdf_href)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到版面 <span class="hljs-subst">{i}</span> 的PDF链接: <span class="hljs-subst">{pdf_href}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未找到版面 <span class="hljs-subst">{i}</span> 的PDF链接"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取版面 <span class="hljs-subst">{i}</span> 的PDF链接失败: <span class="hljs-subst">{e}</span>"</span>)
            
    <span class="hljs-keyword">return</span> pdf_urls


<span class="hljs-keyword">def</span> <span class="hljs-title function_">download_pdfs</span>(<span class="hljs-params">pdf_urls, date_str</span>):
    <span class="hljs-string">"""
    下载所有PDF文件
    
    参数:
        pdf_urls: PDF文件URL列表
        date_str: 日期字符串，用于命名下载的文件
    
    返回值:
        list: 下载的PDF文件路径列表
    """</span>
    downloaded_files = []
    
    <span class="hljs-comment"># 创建临时目录存储下载的文件</span>
    temp_dir = <span class="hljs-string">f"temp_pdfs_<span class="hljs-subst">{date_str}</span>"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(temp_dir):
        os.makedirs(temp_dir)
    
    <span class="hljs-comment"># 下载每个PDF文件</span>
    <span class="hljs-keyword">for</span> i, pdf_url <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(pdf_urls):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建保存的文件名</span>
            file_name = <span class="hljs-string">f"<span class="hljs-subst">{temp_dir}</span>/rmrb_<span class="hljs-subst">{date_str}</span>_<span class="hljs-subst">{i+<span class="hljs-number">1</span>:02d}</span>.pdf"</span>
            
            <span class="hljs-comment"># 下载文件</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件..."</span>)
            response = requests.get(pdf_url, timeout=<span class="hljs-number">30</span>)
            
            <span class="hljs-comment"># 保存文件</span>
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_name, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:
                f.write(response.content)
            
            downloaded_files.append(file_name)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件下载完成: <span class="hljs-subst">{file_name}</span>"</span>)
            
            <span class="hljs-comment"># 添加下载间隔，避免请求过于频繁</span>
            time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载版面 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 的PDF文件失败: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">return</span> downloaded_files


<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_pdfs</span>(<span class="hljs-params">pdf_files, output_file</span>):
    <span class="hljs-string">"""
    合并多个PDF文件为一个
    
    参数:
        pdf_files: 要合并的PDF文件路径列表
        output_file: 合并后的输出文件路径
    
    返回值:
        bool: 合并是否成功
    """</span>
    <span class="hljs-keyword">try</span>:
        pdf_writer = PyPDF2.PdfWriter()
        
        <span class="hljs-comment"># 遍历每个PDF文件</span>
        <span class="hljs-keyword">for</span> pdf_file <span class="hljs-keyword">in</span> pdf_files:
            <span class="hljs-keyword">try</span>:
                pdf_reader = PyPDF2.PdfReader(pdf_file, strict=<span class="hljs-literal">False</span>)
                
                <span class="hljs-comment"># 添加每一页到写入器</span>
                <span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(pdf_reader.pages)):
                    pdf_writer.add_page(pdf_reader.pages[page_num])
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"读取文件 <span class="hljs-subst">{pdf_file}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
        
        <span class="hljs-comment"># 写入合并后的文件</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_file, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> out:
            pdf_writer.write(out)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文件合并完成: <span class="hljs-subst">{output_file}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文件合并失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_temp_files</span>(<span class="hljs-params">temp_files</span>):
    <span class="hljs-string">"""
    清理临时文件
    
    参数:
        temp_files: 临时文件路径列表
    """</span>
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> temp_files:
        <span class="hljs-keyword">try</span>:
            os.remove(file)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除临时文件 <span class="hljs-subst">{file}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-comment"># 尝试删除临时目录</span>
    <span class="hljs-keyword">if</span> temp_files:
        temp_dir = os.path.dirname(temp_files[<span class="hljs-number">0</span>])
        <span class="hljs-keyword">try</span>:
            os.rmdir(temp_dir)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除临时目录 <span class="hljs-subst">{temp_dir}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">download_rmrb_pdf</span>(<span class="hljs-params">date_str=<span class="hljs-literal">None</span>, base_url=<span class="hljs-string">"https://paper.people.com.cn"</span></span>):
    <span class="hljs-string">"""
    下载指定日期的人民日报PDF并合并
    
    参数:
        date_str: 日期字符串，格式为'YYYY-MM-DD'，默认为当天
        base_url: 人民日报网站的基础URL
    
    返回值:
        str: 合并后的PDF文件路径，如果失败则返回None
    """</span>
    <span class="hljs-comment"># 如果未指定日期，则使用当天日期</span>
    <span class="hljs-keyword">if</span> date_str <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        date_str = datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载 <span class="hljs-subst">{date_str}</span> 的人民日报PDF..."</span>)
    
    <span class="hljs-comment"># 获取所有版面的PDF链接</span>
    pdf_urls = get_pdf_urls(base_url, date_str)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> pdf_urls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"未找到任何PDF链接，下载失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 下载PDF文件</span>
    downloaded_files = download_pdfs(pdf_urls, date_str)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> downloaded_files:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有PDF文件下载失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 构建输出文件名</span>
    output_file = <span class="hljs-string">f"rmrb_<span class="hljs-subst">{date_str}</span>.pdf"</span>
    
    <span class="hljs-comment"># 合并PDF文件</span>
    <span class="hljs-keyword">if</span> merge_pdfs(downloaded_files, output_file):
        <span class="hljs-comment"># 清理临时文件</span>
        clean_temp_files(downloaded_files)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"人民日报 <span class="hljs-subst">{date_str}</span> PDF下载和合并完成！"</span>)
        <span class="hljs-keyword">return</span> output_file
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 即使合并失败，也清理临时文件</span>
        clean_temp_files(downloaded_files)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 示例用法：下载当天的人民日报PDF</span>
    <span class="hljs-comment"># 如果需要下载特定日期的报纸，可以传入日期参数，例如：download_rmrb_pdf('2025-09-29')</span>
    <span class="hljs-comment"># 如果未指定日期，则使用当天日期</span>
    today=datetime.now()
    download_rmrb_pdf()
 
</code></pre>
<pre><code class="hljs language-bash" lang="bash">开始下载 2026-01-03 的人民日报PDF...
发现 8 个版面
找到版面 1 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/a34b8d91-e465-4b84-9c08-c07900f5d536.pdf
找到版面 2 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/dee045f0-a680-450a-933d-03b6b038ee3d.pdf
找到版面 3 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/0c5046c0-6919-4194-931b-145f8e7fa90f.pdf
找到版面 4 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/1c61519d-506a-4c83-925d-b9c79e7609f7.pdf
找到版面 5 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/7a2392d1-d4fb-4b9d-93e3-28ed039d1de3.pdf
找到版面 6 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/32f4a6e9-3959-411a-bcaf-ebf638a7239c.pdf
找到版面 7 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/a864bc77-c935-4d50-b3ce-5e9eb8ba2fc2.pdf
找到版面 8 的PDF链接: https://paper.people.com.cn/rmrb/pc/layout/202601/03/../../../attachement/202601/03/1c86d66b-66c3-4633-9b78-0c85e34d23a8.pdf
开始下载版面 1 的PDF文件...
版面 1 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_01.pdf
开始下载版面 2 的PDF文件...
版面 2 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_02.pdf
开始下载版面 3 的PDF文件...
版面 3 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_03.pdf
开始下载版面 4 的PDF文件...
版面 4 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_04.pdf
开始下载版面 5 的PDF文件...
版面 5 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_05.pdf
开始下载版面 6 的PDF文件...
版面 6 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_06.pdf
开始下载版面 7 的PDF文件...
版面 7 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_07.pdf
开始下载版面 8 的PDF文件...
版面 8 的PDF文件下载完成: temp_pdfs_2026-01-03/rmrb_2026-01-03_08.pdf

PDF文件合并完成: rmrb_2026-01-03.pdf
人民日报 2026-01-03 PDF下载和合并完成！
</code></pre>
<p>根据日志可见：</p>
<ul>
<li>按照版面依次下载pdf文件</li>
<li>合并所有版面成报纸
另外保存目录等自己可以调整。</li>
</ul>
<h3 data-id="heading-13">2.使用ERNIE大模型对《人民日报》进行智能分析</h3>
<h4 data-id="heading-14">2.1 读取PDF</h4>
<pre><code class="hljs">从PDF文件中提取文本内容， 使用PyPDF2库读取PDF文件，提取所有页面的文本内容，各页面文本用单换行符连接。
</code></pre>
<h4 data-id="heading-15">2.2 使用ERNIE大语言模型对文本内容进行智能分析</h4>
<p>主要完成下列任务：</p>
<ul>
<li>1.报纸中出现的重大事件；</li>
<li>2.评论员文章；</li>
<li>3.金句、典故、古语；</li>
<li>4.优秀词组、新词。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-string">"""
人民日报PDF智能分析工具
=========================

这个模块提供了对人民日报PDF文件的智能分析功能，能够：
1. 自动提取PDF文本内容
2. 使用大语言模型进行智能分析
3. 生成结构化的分析报告

主要功能：
- 提取人民日报PDF文本
- AI智能分析识别重大事件、评论文章、金句典故、优秀词组
- 生成Markdown格式的分析报告
- 自动按日期命名输出文件

依赖库：
- PyPDF2: PDF文件读取
- OpenAI: 大模型API调用
- datetime: 日期时间处理

"""</span>

<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> PyPDF2 <span class="hljs-keyword">import</span> PdfReader

<span class="hljs-comment"># 获取当前日期字符串，用于文件名命名</span>
date_str = datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d'</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_pdf</span>(<span class="hljs-params">pdf_path</span>):
    <span class="hljs-string">"""
    从PDF文件中提取文本内容
    
    使用PyPDF2库读取PDF文件，提取所有页面的文本内容，
    各页面文本用单换行符连接。
    
    Args:
        pdf_path (str): PDF文件的完整路径
        
    Returns:
        str: 从PDF中提取的文本内容，各页面之间用换行符分隔
        
    Note:
        这个函数与readpdf.py中的read_pdf函数类似，但连接符不同
        这里使用单换行符，适合后续的AI分析处理
    """</span>
    <span class="hljs-comment"># 创建PDF阅读器对象并读取文件</span>
    reader = PdfReader(pdf_path)
    
    <span class="hljs-comment"># 提取所有页面的文本内容</span>
    <span class="hljs-comment"># page.extract_text() 可能返回None，使用or ""处理空页面</span>
    <span class="hljs-comment"># 各页面文本用换行符连接，保持一定分隔但比双换行符更紧凑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(page.extract_text() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span> <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> reader.pages)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_info</span>(<span class="hljs-params">content</span>):
    <span class="hljs-string">"""
    使用大语言模型对文本内容进行智能分析
    
    该函数调用百度AI Studio的ernie-4.5-turbo-vl模型，
    对输入的文本内容进行结构化分析，识别和分类各种信息。
    
    Args:
        content (str): 待分析的文本内容（通常是从PDF提取的报纸内容）
        
    Returns:
        str: AI分析生成的结构化文本内容
        
    Note:
        - 使用流式输出，实时显示AI思考过程和分析结果
        - 分析结果包含重大事件、评论文章、金句典故、优秀词组四个维度
        - 模型配置为低温度(0.2)以确保输出稳定性
    """</span>
    <span class="hljs-comment"># 初始化OpenAI客户端</span>
    <span class="hljs-comment"># 注意：API密钥应从环境变量或配置文件获取，避免硬编码</span>
    client = OpenAI(
        <span class="hljs-comment"># API密钥配置 - 生产环境中应使用环境变量xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
        api_key=<span class="hljs-string">"生产环境中应使用环境变量xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>,
        <span class="hljs-comment"># 百度AI Studio大模型API服务地址</span>
        base_url=<span class="hljs-string">"https://aistudio.baidu.com/llm/lmapi/v3"</span>,
    )

    <span class="hljs-comment"># 创建聊天完成请求</span>
    chat_completion = client.chat.completions.create(
        <span class="hljs-comment"># 使用ernie-4.5-turbo-vl模型进行多模态分析</span>
        model=<span class="hljs-string">"ernie-4.5-turbo-vl"</span>,
        
        <span class="hljs-comment"># 构建对话消息</span>
        messages=[
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
                <span class="hljs-string">"content"</span>: (
                    <span class="hljs-string">"该内容是报纸pdf识别的，内容连续性可能有问题，请你理顺后，"</span>
                    <span class="hljs-string">"然后详尽完成下列任务，要详细，尽可能多："</span>
                    <span class="hljs-string">"1.报纸中出现的重大事件；"</span>
                    <span class="hljs-string">"2.评论员文章；"</span>
                    <span class="hljs-string">"3.金句、典故、古语；"</span>
                    <span class="hljs-string">"4.优秀词组、新词。"</span>
                ),
            },
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: content},
        ],
        
        <span class="hljs-comment"># 启用流式输出，实时显示结果</span>
        stream=<span class="hljs-literal">True</span>,
        
        <span class="hljs-comment"># 额外的模型参数配置</span>
        extra_body={
            <span class="hljs-string">"penalty_score"</span>: <span class="hljs-number">1</span>,      <span class="hljs-comment"># 重复惩罚分数，控制内容重复度</span>
            <span class="hljs-string">"enable_thinking"</span>: <span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用思考模式，提高分析质量</span>
        },
        
        <span class="hljs-comment"># 模型生成参数</span>
        max_completion_tokens=<span class="hljs-number">12000</span>,  <span class="hljs-comment"># 最大输出token数，确保详细分析</span>
        temperature=<span class="hljs-number">0.2</span>,              <span class="hljs-comment"># 温度参数，低温度保证输出稳定性</span>
        top_p=<span class="hljs-number">0.8</span>,                    <span class="hljs-comment"># 核采样参数</span>
        frequency_penalty=<span class="hljs-number">0</span>,          <span class="hljs-comment"># 频率惩罚，避免重复内容</span>
        presence_penalty=<span class="hljs-number">0</span>            <span class="hljs-comment"># 存在惩罚，鼓励新话题</span>
    )

    <span class="hljs-comment"># 处理流式输出</span>
    mycontent = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chat_completion:
        <span class="hljs-comment"># 检查是否有有效的选择结果</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk.choices <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(chunk.choices) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">continue</span>
            
        choice = chunk.choices[<span class="hljs-number">0</span>]
        
        <span class="hljs-comment"># 处理AI思考过程内容（如果启用思考模式）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(choice.delta, <span class="hljs-string">"reasoning_content"</span>) <span class="hljs-keyword">and</span> choice.delta.reasoning_content:
            <span class="hljs-comment"># 实时显示AI的思考过程</span>
            <span class="hljs-built_in">print</span>(choice.delta.reasoning_content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
            
        <span class="hljs-comment"># 处理实际的分析内容</span>
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(choice.delta, <span class="hljs-string">"content"</span>) <span class="hljs-keyword">and</span> choice.delta.content:
            <span class="hljs-comment"># 实时显示分析结果</span>
            <span class="hljs-built_in">print</span>(choice.delta.content, end=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
            <span class="hljs-comment"># 累积完整内容用于返回</span>
            mycontent = mycontent + choice.delta.content
            
    <span class="hljs-comment"># 返回完整的分析结果</span>
    <span class="hljs-keyword">return</span> mycontent


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""
    主函数 - 程序执行入口
    
    执行完整的PDF分析流程：
    1. 构建当日人民日报PDF文件名
    2. 读取PDF文本内容
    3. 使用AI进行智能分析
    4. 保存分析结果到Markdown文件
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 构建当日人民日报PDF文件名 (格式: rmrb_YYYY-MM-DD.pdf)</span>
        rmrb_pdf_file = <span class="hljs-string">f"rmrb_<span class="hljs-subst">{date_str}</span>.pdf"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在读取PDF文件: <span class="hljs-subst">{rmrb_pdf_file}</span>"</span>)
        
        <span class="hljs-comment"># 提取PDF文本内容</span>
        content = read_pdf(rmrb_pdf_file)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PDF文本提取完成，内容长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span> 字符"</span>)
        
        <span class="hljs-comment"># 使用AI进行智能分析</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n开始AI分析..."</span>)
        markdown_note = extract_info(content)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nAI分析完成"</span>)
        
        <span class="hljs-comment"># 重新获取日期字符串（确保文件名日期准确）</span>
        current_date = datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d"</span>)
        output_filename = <span class="hljs-string">f"人民日报_<span class="hljs-subst">{current_date}</span>.md"</span>
        
        <span class="hljs-comment"># 保存分析结果到Markdown文件</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_filename, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> file:
            <span class="hljs-built_in">print</span>(markdown_note, file=file)
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n分析结果已保存到: <span class="hljs-subst">{output_filename}</span>"</span>)
        
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: 找不到文件 '<span class="hljs-subst">{rmrb_pdf_file}</span>'"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请确保当日的人民日报PDF文件存在且命名格式正确"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理过程中发生错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请检查网络连接和API配置"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#开始对报纸内容分析</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-16">四、报纸摘要示例</h2>
<h4 data-id="heading-17">一、报纸中出现的重大事件</h4>
<ol>
<li>
<p><strong>经济数据发布</strong></p>
<ul>
<li>2025年我国全年电影票房达518.32亿元，同比增长21.95%，国产影片占比79.67%。</li>
<li>元旦假期首日（2026年1月1日）全国跨区域人员流动量超2亿人次，同比增长20.3%。</li>
</ul>
</li>
<li>
<p><strong>科技与能源成就</strong></p>
<ul>
<li>“华龙一号”漳州核电2号机组投入商业运行，标志漳州核电一期工程全面投产，单台机组年发电量约100亿千瓦时。</li>
<li>“深海一号”气田2025年油气总产量突破450万吨，与陆地中型油田规模相当。</li>
</ul>
</li>
<li>
<p><strong>政策调整与经济措施</strong></p>
<ul>
<li>国家发展改革委优化“两新”政策（设备更新与消费品以旧换新），扩大资金支持范围，降低企业申报门槛。</li>
<li>2026年提前批“两重”建设项目清单下达，约2950亿元投资聚焦城市地下管网、高标准农田等领域。</li>
</ul>
</li>
<li>
<p><strong>国际合作与外交</strong></p>
<ul>
<li>多国重申坚持一个中国原则，反对干涉中国内政，包括巴基斯坦、孟加拉国、吉布提等。</li>
<li>中国助力非洲数字化转型，如承建博茨瓦纳国家数据中心、助力肯尼亚电商发展（Kilimall平台）等。</li>
</ul>
</li>
<li>
<p><strong>社会民生与乡村振兴</strong></p>
<ul>
<li>吉林省镇赉县创业村通过盐碱地改良实现水稻丰收，打造“镇赉大米”品牌，村集体收入突破50万元。</li>
<li>浙江舟山实施“小岛迁、大岛建”工程，改善海岛老人养老条件，同时盘活小岛资源发展特色产业。</li>
</ul>
</li>
<li>
<p><strong>文化与法治建设</strong></p>
<ul>
<li>中国法治论坛聚焦“十五五”法治保障，强调构建法学自主知识体系，推动法治赋能高质量发展。</li>
<li>《哪吒之魔童闹海》票房破154亿元，推动中国电影工业水平提升。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">二、评论员文章</h4>
<ol>
<li>
<p><strong>《继续回答好延安“窑洞之问”》</strong></p>
<ul>
<li>核心观点：坚持自我革命，保持党同人民血肉联系，通过从严治党净化政治生态，确保“十五五”良好开局。</li>
<li>关键论据：从“让人民监督政府”到“自我革命”，历史周期率的两个答案彰显党与人民风雨同舟。</li>
</ul>
</li>
<li>
<p><strong>《优化实施“两新”政策，推动高质量发展》</strong></p>
<ul>
<li>核心观点：通过资金分配优化、监管强化和范围拓展，提升政策惠及面，支持企业设备更新与消费升级。</li>
<li>关键论据：2025年消费品以旧换新暴露问题，2026年针对性优化，如增加老旧小区电梯改造、商业综合体设备更新等。</li>
</ul>
</li>
<li>
<p><strong>《中国助力非洲数字化转型》</strong></p>
<ul>
<li>核心观点：通过数字基建、电商培育、人才培训，中国助力非洲弥合数字鸿沟，推动可持续发展。</li>
<li>关键论据：博茨瓦纳数据中心、肯尼亚Kilimall平台、卢旺达鲁班工坊等案例体现中非合作成果。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-19">三、金句、典故、古语</h4>
<ol>
<li>
<p><strong>领导人金句</strong></p>
<ul>
<li>“党兴方能国强。”（新年贺词）</li>
<li>“我国成为创新力上升最快的经济体之一。”（2026年新年贺词）</li>
<li>“信心，来自经济实力的拾级而上。”（新年贺词解读）</li>
</ul>
</li>
<li>
<p><strong>典故与古语</strong></p>
<ul>
<li>“民惟邦本”（《尚书》），用于阐释“以人民为中心”的治理理念。</li>
<li>“四水归堂”（传统建筑智慧），象征民居文化中“聚财聚气”的生态设计。</li>
<li>“逐梦星辰大海”，形容科技发展的远大志向。</li>
</ul>
</li>
<li>
<p><strong>文化引用</strong></p>
<ul>
<li>侗族款约“不会唱歌难娶亲”，体现非遗文化传承与社区治理结合。</li>
<li>“风物长宜放眼量”，用于鼓励长期主义发展观。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-20">四、优秀词组、新词</h4>
<ol>
<li>
<p><strong>政策术语</strong></p>
<ul>
<li><strong>“两新”政策</strong>：设备更新与消费品以旧换新。</li>
<li><strong>“两重”建设</strong>：重大战略、重点领域安全能力建设。</li>
<li><strong>“新质生产力”</strong>：以创新驱动的高质量发展动能。</li>
</ul>
</li>
<li>
<p><strong>经济与科技新词</strong></p>
<ul>
<li><strong>“地理信息产业”</strong>：自动驾驶地图标准体系、实景三维中国建设。</li>
<li><strong>“同一起跑线”</strong>：形容未来产业布局的公平竞争环境。</li>
</ul>
</li>
<li>
<p><strong>社会民生词汇</strong></p>
<ul>
<li><strong>“小岛迁、大岛建”</strong>：海岛乡村振兴模式。</li>
<li><strong>“盐碱地上创业”</strong>：通过科技改良实现农业突破。</li>
</ul>
</li>
<li>
<p><strong>文化与国际传播</strong></p>
<ul>
<li><strong>“文化出海‘新三样’”</strong>：网文、网剧、网游成为文化输出新渠道。</li>
<li><strong>“最佳旅游乡村”</strong>：黄岗村等通过文旅融合实现乡村振兴。</li>
</ul>
</li>
<li>
<p><strong>法治与治理概念</strong></p>
<ul>
<li><strong>“全国统一大市场”</strong>：破除地方壁垒，促进要素自由流动。</li>
<li><strong>“法治赋能高质量发展”</strong>：通过立法保障经济转型。</li>
</ul>
</li>
</ol>
<hr/>
<p>以上内容基于报纸PDF识别材料整理，涵盖时政、经济、科技、文化等多领域，体现中国在政策、创新、民生及国际合作中的动态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！]]></title>    <link>https://juejin.cn/post/7590309337861161001</link>    <guid>https://juejin.cn/post/7590309337861161001</guid>    <pubDate>2026-01-03T11:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861161001" data-draft-id="7590654280900100139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！"/> <meta itemprop="keywords" content="开源,AIGC,DeepSeek"/> <meta itemprop="datePublished" content="2026-01-03T11:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在手搓流程图？DeepSeek+Draw.io王炸组合，一句话秒出可编辑源文件！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T11:24:34.000Z" title="Sat Jan 03 2026 11:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小肥肠！今天给大家分享一个一句话生成流程图的AI工具，支持在线编辑，使用方法也很简单，5分钟即可完成部署轻松上手，感兴趣就速速码住哦~</p>
<h2 data-id="heading-0">1. 效果展示</h2>
<p>昨天剪辑AI漫剧的空隙刷了一下AI资讯（超绝不经意展示我在做的AI漫剧，嘻嘻）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6335589a7fd14ae089d1ead42f1d9018~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=gUwA1YzYm6UiM4H1%2BTdI6WYPmOc%3D" alt="" loading="lazy"/></p>
<p>偶然发现了一个让我眼前一亮的项目—<code>next-ai-draw-io</code>。咱们的老粉应该记得，之前我分享过一篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fpa23ntdf1gf.feishu.cn%2Fwiki%2FVZjZwnhLcimViBkJTVQcAipQnFR%3Ffrom%3Dfrom_copylink" target="_blank" title="https://pa23ntdf1gf.feishu.cn/wiki/VZjZwnhLcimViBkJTVQcAipQnFR?from=from_copylink" ref="nofollow noopener noreferrer">让Mermaid听懂人话：用Coze空间+MCP一句话搞定所有业务图</a>。那个方案虽然好用，但是有个缺点就是不能在线修改，而今天这个工具，<strong>直接把AI嵌入到了我们最熟悉的 draw.io 里！</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92a4f502842b4c7bb58724a5d17cd7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=73rXssncvw2GSjH%2F2Z5z1vpqXXA%3D" alt="" loading="lazy"/></p>
<p>以前上班画架构图、流程图，draw.io 是绝对的T0级别工具，现在加上了 AI 的加持，简直是如虎添翼。我花了5分钟在本地部署了一套，接入了 DeepSeek 模型，效果直接炸裂：<strong>一句话生成规范流程图，不满意还能直接在右侧 UI 界面手动微调。</strong></p>
<p>首先是流程图：</p>
<pre><code class="hljs">帮我画一个电商用户的购物流程图。从用户浏览商品开始，包括加入购物车、结账、支付成功/失败的判断，一直到发货和确认收货
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d96d33f4650458a89f840308da40f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=L%2FD%2FtfLa02JHDY75m7aahVIHmRw%3D" alt="" loading="lazy"/></p>
<p>又试了一下带动态效果的架构图：</p>
<pre><code class="hljs">我画一个简单的网络架构图，包含一个‘客户端’图标和一个‘服务器’图标。请使用带有明显动画效果的连接线（animated connector）将它们连接起来，方向从客户端指向服务器，生动地展示数据正在传输的过程。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9a445ffd5d44f0487218c0a873b50d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=JGweJWC9wAM7e1URAQtCWjCw8ww%3D" alt="" loading="lazy"/></p>
<p><strong>生成的流程图经过修改后，可以直接将源文件下载到本地使用。</strong> 话不多说直接教大家来部署使用，<strong>结尾还送小肥肠配置好的next-ai-draw-io压缩包，大家可以直接拿过去部署使用~</strong></p>
<h2 data-id="heading-1">2. 部署使用</h2>
<h3 data-id="heading-2">2.1. docker安装</h3>
<p><strong>1.</strong> <strong>安装 WSL 2（适用于 Windows 10 版本 2004 及以上）：</strong></p>
<p>Windows 子系统 Linux 2（WSL 2）提供了一个完整的 Linux 内核，Docker Desktop 依赖于此。win+R打开命令窗口，输入winver查看系统版本，确保内部版本高于19041：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd2858af300e42c6b3e0f518f7cceba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=SwBkN9DIskESUhsbg2nXKEs89iI%3D" alt="" loading="lazy"/></p>
<p>以管理员身份打开 PowerShell，运行以下命令：</p>
<pre><code class="hljs language-css" lang="css">wsl <span class="hljs-attr">--install</span>
</code></pre>
<p>安装完成后需要重启一下计算机。</p>
<p><strong>2.</strong> <strong>安装DockerDesktop</strong></p>
<p>安装 Docker Desktop 之前，确保你已经安装并启用了 WSL 2。可以通过在 <strong>PowerShell</strong> 运行以下命令来检查：</p>
<pre><code class="hljs language-css" lang="css">wsl <span class="hljs-attr">--list</span> <span class="hljs-attr">--verbose</span>
</code></pre>
<p><strong>下载 Docker Desktop</strong>：访问 Docker 官方网站，下载适用于 Windows 的 Docker Desktop 安装包。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd851de54ec942038f8dafd3cd70c5bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=V%2Foy2yruAccrUDywZctVGJItARA%3D" alt="" loading="lazy"/></p>
<p><strong>安装 Docker Desktop</strong>：</p>
<ul>
<li>双击下载的安装文件 <code>Docker Desktop Installer.exe</code>。</li>
<li>按照提示完成安装过程。</li>
<li>安装完成后，系统可能提示重启计算机，建议重启以确保所有组件正常工作。</li>
</ul>
<p><strong>启动 Docker Desktop</strong>：电脑重启后，启动<strong>Docker Desktop，</strong> 初次启动可能需要一些时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0861cd7ab92946d781353158bb2651aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=%2Bd5G6JdqV0YaAPl3SWskH4Vg3LU%3D" alt="" loading="lazy"/></p>
<p>配置一下docker镜像源地址：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a258e9e948994b19bd85eff78e3084ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=9SR7wY035L4%2BYCwN6WRl4%2BjdNDg%3D" alt="" loading="lazy"/></p>
<p>以下镜像源地址为国内地址，你不想用我的也可以自己找：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"builder"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"gc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"defaultKeepStorage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"20GB"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://docker.1panel.live"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://hub.rat.dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://docker.chenby.cn"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://docker.m.daocloud.io"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">2.2. next-ai-draw-io安装</h3>
<p>来到next-ai-draw-io仓库页面<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">github.com/DayuanJiang…</a> 点击下载压缩包按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4541c8504a44a4194042006610b33a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=o7DtHPegnav28wPQ%2FAZm2Cga2XY%3D" alt="" loading="lazy"/></p>
<p>将下载好的压缩包解压到任意目录，如有git可以用git clone命令直接下载项目到文件夹中：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/DayuanJiang/next-ai-draw-io
</code></pre>
<p>复制一份env.example文件并改名为.env。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb9eb7a619764bee95a79cee1752c22e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=PBX8kTSQ2XEZkqfSU1xaDxblWs4%3D" alt="" loading="lazy"/></p>
<p>在.env文件中进行大模型配置用来驱动drawio绘图操作，下图中我配置的是deepseek，你也可以配置其他模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c50b785a2d4be2ad2e4e9f7fe8e547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=WaV5t3hFWerk0bBkyW2i24d2wOI%3D" alt="" loading="lazy"/></p>
<p>打开docker-compose.ym文件在进行如下配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04a509e96bb94405a272be038f13d225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=DJ9EsXRmHuToAh%2Bxhb2fiN3gaMo%3D" alt="" loading="lazy"/></p>
<p><strong>注意：为了防止和本地其他服务冲突，我将 drawio 的端口修改为了 8818。如果你本地 8080 没被占用，保持默认即可；如果占用了，记得像我截图里一样，同时修改</strong> <code>ports</code> <strong>和</strong> <code>env</code> <strong>文件里的端口号。</strong></p>
<p>回到next-ai-draw-io文件目录，在文件路径处输入cmd打开命令提示符，输入命令docker-compose up -d --build</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/769e50497f7d4c59a4c04695601c3446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=G6d090tiqD%2FZp7OBVYSdyT8k1RY%3D" alt="" loading="lazy"/></p>
<p>等待next-ai-draw-io安装，成功后打开网址<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fzh%25E5%258D%25B3%25E5%258F%25AF%25E8%25BF%259B%25E5%2585%25A5next-ai-draw-io%25E6%2593%258D%25E4%25BD%259C%25E7%2595%258C%25E9%259D%25A2%25EF%25BC%258C%25E6%2588%2591%25E4%25BB%25AC%25E5%258F%25AF%25E4%25BB%25A5%25E5%25BC%2580%25E5%25A7%258B%25E8%25BF%259B%25E8%25A1%258C%25E4%25B8%2580%25E5%258F%25A5%25E8%25AF%259D%25E7%2594%259F%25E6%2588%2590%25E6%25B5%2581%25E7%25A8%258B%25E5%259B%25BE%25E7%259A%2584%25E6%2593%258D%25E4%25BD%259C%25E4%25BA%2586%25EF%25BC%259A" target="_blank" title="http://localhost:3000/zh%E5%8D%B3%E5%8F%AF%E8%BF%9B%E5%85%A5next-ai-draw-io%E6%93%8D%E4%BD%9C%E7%95%8C%E9%9D%A2%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8C%E4%B8%80%E5%8F%A5%E8%AF%9D%E7%94%9F%E6%88%90%E6%B5%81%E7%A8%8B%E5%9B%BE%E7%9A%84%E6%93%8D%E4%BD%9C%E4%BA%86%EF%BC%9A" ref="nofollow noopener noreferrer">http://localhost:3000/zh即可进入next-ai-draw-io操作界面，我们可以开始进行一句话生成流程图的操作了：</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d5ac4fa217f4cdb85477953d96f87da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=DcEIzm2SQaGhOFUc%2FSdGQFjXZgo%3D" alt="" loading="lazy"/></p>
<p>以上就是本期教程的完整内容，想获取小肥肠已经配置好的next-ai-draw-io压缩包可以评论区说流程图哦~</p>
<h2 data-id="heading-4">3. 结语</h2>
<p>无论你是产品经理、开发人员还是架构师，这套 <code>DeepSeek + next-ai-draw-io</code> 的组合，绝对能成为提高工作效率的一把利器。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/190eaed60f004d77b7c9d04831a96ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768044273&amp;x-signature=QqxprKbvQnRLGJi6Han3FANhcDM%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己]]></title>    <link>https://juejin.cn/post/7590699877630378022</link>    <guid>https://juejin.cn/post/7590699877630378022</guid>    <pubDate>2026-01-03T11:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630378022" data-draft-id="7590699877630328870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2026-01-03T11:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱敲代码的小黄"/> <meta itemprop="url" content="https://juejin.cn/user/598584558627246"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里人的 2025 年终总结：买房、晋升、订婚、投资，遇见更清晰的自己
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/598584558627246/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱敲代码的小黄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T11:55:59.000Z" title="Sat Jan 03 2026 11:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdb9b40d45524053bfdc3e50beb9a6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=SCWvo1D6E14W%2BrPgI7QETYVJSlI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、引言</h2>
<p>又到了一年一度的年终复盘时刻。</p>
<p>复盘，从来不只是回看已经发生的事情，更重要的是——为尚未发生的未来，提前铺路、校准方向。</p>
<p>回望 2025 年，其实很长一段时间里，我始终没有真正找到自己的方向。工作之外，谈不上热爱，也谈不上笃定，只是在惯性中前行。</p>
<p>直到 2025 年的尾声，才终于看清了一些东西：哪些是必须坚持的，哪些是可以放下的，也逐渐摸索出几条更属于自己的路径。这一年，并非突然开悟，而是反复碰壁后的沉淀与取舍。</p>
<p>依旧按照惯例，沿着时间的轨迹，回到 2025 年的起点，梳理这一整年里的得与失、进与退，也为下一阶段的自己，留下些什么。</p>
<h2 data-id="heading-1">二、技术（AI驱动）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dd262c4e24e496fabdd11b579b4e447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=bXK%2FP%2Bsa1ph7wID8PtEk0SNAOu0%3D" alt="" loading="lazy"/></p>
<p>2025 年，是 AI 加速演进的一年。</p>
<p>这一年里，我写博客明显少了，最直接的原因，正是 AI 带来的冲击。曾经需要熬夜查资料、翻文档、啃源码的事情，在今天的 AI 面前显得异常高效——只需要给出合适的关键词，答案往往已经被系统性地整理好。</p>
<p>从宏观来看，2025 年的主旋律，几乎全部围绕着<strong>大模型基础设施</strong>展开。各大厂商持续投入巨额资金，用于模型规模、算力和训练能力的迭代升级。但与之形成鲜明对比的是：​<strong>大模型的应用落地，依然是一个尚未被彻底解决的问题</strong>​。</p>
<p>这就像高速公路已经修好，但真正决定胜负的，是谁家的车最先跑起来、跑得最稳。</p>
<p>基于这一判断，我越来越坚定地认为：<strong>2026 年的主旋律，一定是 AI 的落地与应用。</strong></p>
<p>对技术人而言，未来不再只是把业务“做深做熟”，而是在既有业务基础上，思考如何与大模型更好地结合、适配、放大价值——这或许才是更长远的终局。</p>
<p>纯业务型技术路线，势必会遭遇一定冲击。原因并不复杂：当业务格局趋于稳定，公司往往不会再在传统方向上投入重资产。努力当然重要，但在技术浪潮面前，​<strong>方向的优先级，永远高于努力本身</strong>​。风口之上，选择往往比埋头苦干更关键。</p>
<p>坦白说，我曾长期对 AI 保持距离。并非否定它的价值，而是因为它太新——标准未定、路径未明、变量太多。这种不确定性，本能地让人抗拒。</p>
<p>真正的转折，来自一次和老板的绩效沟通。在 AI 飞速演进的节点，如果只是站在一旁观望，等别人把位置站稳、红利吃完，再回头跟进，我们注定只能咀嚼别人剩下的成果，且永远慢一步。</p>
<p>从那次谈话之后，我逐渐接受了一个事实：<strong>AI 不是选修，而是必须正视的方向。</strong></p>
<p>客观来说，2025 年我并没有系统性地学习太多 AI 知识。但我也越来越确信，学习本身并不是最难的事，真正重要的，是先选对方向。</p>
<p>立下 2026 年的第一个 Flag：<strong>持续系统性地学习 AI，构建完整的技术体系，至少让自己始终站在行业前列。</strong></p>
<h2 data-id="heading-2">三、工作（Agent/晋升）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81797c49750b482bb9b4ff32fbe321ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=hTx7eH3BNbIJDpzCjHm79Rq6TRM%3D" alt="" loading="lazy"/></p>
<p>2025 年，几乎可以被视为 ​<strong>Agent 的元年</strong>​。</p>
<p>对风控工程师而言，这是一个难得的历史窗口期。大模型天然擅长图文理解，而内容风控的核心风险，恰恰集中在图文与多模态层面，二者之间的契合度，几乎是为内容风控量身定做。</p>
<p>在过去一年里，我们更多是在​<strong>夯实底层能力</strong>​：包括大模型与小模型的协同、向量检索体系、敏感词与规则匹配等基础设施建设。而今年，则顺应技术演进的方向，在此之上，开始系统性地推进​<strong>内容风控 Agent 的建设</strong>​。</p>
<p>从系统设计角度看，传统架构往往以同步模式为主。但在大模型时代，推理延迟不可避免地成为整体架构的瓶颈，在高 QPS 场景下，单纯依赖同步调用已难以支撑规模化落地。因此，架构形态也不得不随之演进，从同步模式逐步向<strong>异步化、任务化</strong>转变。</p>
<p>不过，相比架构调整，Agent 本身长期存在的两个核心问题更加关键：<strong>幻觉问题</strong>与​<strong>成本问题</strong>​。</p>
<p>对于幻觉问题，业界较为成熟的做法，是通过 Workflow 对大模型的行为路径进行约束，让其在预设的流程和边界内完成推理，从而降低不确定性。</p>
<p>而成本问题则更具挑战性。目前主流思路可以拆解为两个方向：一是<strong>降低大模型</strong>​​<strong>的调用频次</strong>​，二是​<strong>降低单次调用成本</strong>​。前者往往引入搜广推体系中的粗排 / 精排架构，由小模型或规则先行过滤，仅将必要样本交由大模型处理；后者则更多依赖自建推理服务，通过部署开源模型（如千问、DeepSeek 等）来降低整体成本。</p>
<p>更进一步来看，自建模型还有一个明显优势：当前开源模型大多是通用基模，而真实业务更需要的是​<strong>领域大模型</strong>​。这也意味着，必须通过微调、蒸馏等手段，构建并持续演进真正贴合业务的模型体系。</p>
<p>整体来看，这一阶段的工作，相比传统开发，多了更多的不确定性，但也因此更具挑战性和成长空间，是真正与 AI 深度接轨的一段经历。</p>
<p>也幸运地得到了老板的认可，拿到了来之不易的晋升名额，完成了职业生涯中的第二次晋升——上一次是在上一家公司。回头看，确实有运气成分，也更需要珍惜。</p>
<p>立下新年的第二个 Flag：<strong>2026 年，持续精进 Agent 架构能力，从整体设计到细节实现全面吃透，建立真正的体系化掌控力，同时对自己保持足够严格的技术要求，始终心存技术敬畏。</strong></p>
<h2 data-id="heading-3">四、健康（运动/旅游）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36bf0b698075439cb956a218b2300aa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=Dbt23RYbuX%2FWfAMeVns%2BTfpRvJI%3D" alt="" loading="lazy"/></p>
<p>又到了这个多少有些老生常谈的栏目。</p>
<p>坦率地说，2025 年的运动状态可以用全面崩盘来形容。不仅没有瘦下来，反而稳步增重，这一项只能毫不留情地给自己打一个最低分，甚至有点不忍直视。唯一能做的，大概只能把希望寄托在 2026 年，重新做人。</p>
<p>相比之下，生活并非全然失守。这一年，还是走了不少地方。公司团建去了昆明、大理，看到了心心念念的洱海；个人也陆续去了深圳、香港、天津、北戴河、南京等城市，在不同的节奏里切换视角，多少算是给自己留了一些喘息的空间。</p>
<p>也期待明年能继续把“在路上”这件事延续下去——更重要的是，明年对象终于有年假了。</p>
<p>立下新年的第三个 Flag：<strong>坚持运动，至少别再继续发胖；同时走进几个尚未抵达过的城市，让生活保持一点新的变量。</strong></p>
<h2 data-id="heading-4">五、家庭（买房/订婚）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4d32b143f04958a3e3fe5ead1bf0c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=CII2ImBQTkDqAkJ%2FrEUBkAYTSeo%3D" alt="" loading="lazy"/></p>
<p>去年看过的房子，最终还是和对象商量后定了下来。位置在县城里算是比较成熟的小区，四面都有学校，整体价格也在可承受范围内。房贷已经还了一年，对日常生活的影响并不大。</p>
<p>唯一的遗憾是交付时间要到 2027 年，目前仍在建设中。不过好在并不着急，慢一点也无妨。地理位置也和去年设想的一样——我和亲姐选择了同一个小区、同一个单元、上下楼，只需要一分钟，就能“传送”到她家蹭饭。考虑到我和对象都不太擅长做饭，这个选择现在看起来，格外明智。</p>
<p>另一件重要的事情，是订婚。和对象谈了七年恋爱，最终还是给了彼此一个相对笃定、也让双方家庭都满意的答案。整个过程比预想中顺利得多，几乎没有在流程或观念上产生大的分歧。订婚前和订婚后，心态确实发生了一些变化——一种更明确的“我们已经是一家人了”的心理确认。</p>
<p>当然，现实层面仍然存在异地的问题。对象在老家县医院工作，我则在北京从事互联网相关工作。所幸的是，老家县城今年将开通直达北京的高铁，往返的成本和难度都会降低，这也算是一个不小的利好。</p>
<p>整体来看，家庭这一块在 2025 年算是比较稳定的一年，没有突发的波折，一切都在预期内向前推进。</p>
<p>立下新年的第三个 Flag：<strong>家庭层面继续顺其自然、稳步发展；如果房子能提前交付，也不排除提前去拍个婚纱照——不强制，慢慢来。</strong></p>
<h2 data-id="heading-5">六、投资（美股/港股/A股）</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c0c4aa816b54c2887c67f46ad0491a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=oUVrfCJ4rBH%2FYQjo1wDFpCqZNuk%3D" alt="" loading="lazy"/></p>
<p>2025 年，也算是我个人投资生涯的起点。</p>
<p>在长桥关门前开通了账户，在汇丰调整政策前办好了银行卡，时间点刚好卡在一个“来得及”的窗口期。12 月份正式进入美股市场后，才真正意识到：投资这件事，本身就像一门需要长期修炼的技术。</p>
<p>这一阶段，最大的收获并不在于盈亏，而是对投资这件事的​<strong>认知重构</strong>​。至少有几件事，是必须补上的基础能力。</p>
<p>第一，是​<strong>仓位控制</strong>​。如何在不踏空的前提下，避免一次性打光子弹，是非常难的一件事。仓位过低，行情来了只能旁观；仓位过高，下跌时却失去补仓空间。合理的仓位，本质上是为了​<strong>尽可能长时间地留在牌桌上</strong>​。</p>
<p>第二，是​<strong>买卖策略</strong>​。不同股票对应不同策略：有的适合长期持有，有的更偏交易属性。对陌生标的，更需要分批建仓，区分观察仓、交易仓与核心仓，而不是一次性下注。</p>
<p>第三，是​<strong>情绪管理</strong>​。这一点的冲击远超预期。下跌时容易冲动补仓，情绪持续低落；上涨时又容易过度乐观，放松纪律。回头看，绝大多数错误操作，都不是判断失误，而是典型的“情绪杀”。</p>
<p>第四，是​<strong>交易复盘</strong>​。 每一笔交易都值得被复盘：究竟是基于清晰逻辑做出的决策，还是随市场情绪跟风的结果。如果连自己为什么买、为什么卖都说不清楚，那么这笔交易本身就是不合格的。</p>
<p>事实上，这些问题最终都可以归结为一个核心：<strong>是否拥有一套成熟、可执行、可复盘的交易系统。</strong></p>
<p>只有在系统的约束下交易，才能尽可能屏蔽情绪干扰，让结果更多由概率而非情绪决定。</p>
<p>某种程度上，这和前面提到的技术路径并无本质区别——就像 2026 年是 Agent 的关键一年一样，投资领域同样需要系统化思维。在美股市场中，也有不少值得长期观察的优质标的，新的一年，我会重点关注：​<strong>谷歌、英伟达、台积电、特斯拉</strong>​。</p>
<p>立下新年的第四个 Flag：<strong>建立并持续迭代属于自己的交易系统，在控制风险的前提下，争取 2026 年实现 10% 的年度收益目标。</strong></p>
<h2 data-id="heading-6">七、总结</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a693e4a41f7b4ef88b8e289db317bdb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=yZS3xbyt6I%2BWBFnTO7XW4j5SvAc%3D" alt="" loading="lazy"/></p>
<p>2025 年过得很快，一转眼就到了年末。回头算了一下，自己已经毕业四年半了。</p>
<p>还记得刚毕业的时候，对周围的一切都充满好奇，对技术保持着最纯粹的热情。那时知道的不多，需要承担的事情也不多，反而简单、专注，也更容易感到快乐。</p>
<p>随着年龄和阅历的增长，不得不考虑的事情越来越多，责任与压力也随之而来，这是成长过程中无法回避的一部分。</p>
<p>回看从毕业到现在的这几年，多少还是带着一些运气。整体来看，很少在关键节点上做出错误选择，生活与事业也在持续向更好的方向推进。正因如此，也愈发珍惜当下所拥有的一切。</p>
<p>但运气从来不是全部。对我而言，更重要的是始终保持一种行动上的自觉—<strong>想到就去做，决定了方向，就尽力把事情做成。</strong></p>
<p>接下来，也对 2025 年年初立下的 Flag 做一次完整复盘，给自己这一年的选择与投入，留下一份相对坦诚的答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd26e1988c3445589b73ee542e6c38c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5pWy5Luj56CB55qE5bCP6buE:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046158&amp;x-signature=cPAs%2B64LwTL6WHzi1qqdjTKQ0jU%3D" alt="" loading="lazy"/></p>
<p>回到终点，再看起点，会发现很多事情并非一蹴而就，而是在一次次选择中逐渐变得清晰。</p>
<p>这一年，没有奇迹，也没有偏航。有的，只是在关键问题上站对方向，在重要事情上持续投入。</p>
<p>花有重开日，人无再少年。<strong>2026，让我们顶峰相见。</strong></p>
<p>如果你也对 <strong>后端架构</strong> 和 <strong>中间件源码</strong> 感兴趣，欢迎添加博主微信：​<strong>hls1793929520</strong>​，一起学习，一起成长。</p>
<p>我是 <strong>​爱敲代码的小黄，​</strong>阿里巴巴 Java 开发工程师，CSDN 博客专家，专注后端架构与中间件源码。</p>
<blockquote>
<p>我从清晨走过，也拥抱夜晚的星辰。人生没有捷径，你我皆平凡。<strong>你好，陌生人，一起共勉。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从随叫随到到规范配送：现代物流系统与 REST API 的登场]]></title>    <link>https://juejin.cn/post/7590421489997889555</link>    <guid>https://juejin.cn/post/7590421489997889555</guid>    <pubDate>2026-01-03T10:07:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489997889555" data-draft-id="7590421489997856787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从随叫随到到规范配送：现代物流系统与 REST API 的登场"/> <meta itemprop="keywords" content="后端,Python,全栈"/> <meta itemprop="datePublished" content="2026-01-03T10:07:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩师傅"/> <meta itemprop="url" content="https://juejin.cn/user/286348958252526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从随叫随到到规范配送：现代物流系统与 REST API 的登场
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/286348958252526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:07:30.000Z" title="Sat Jan 03 2026 10:07:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：第三代物流系统（Flask、Django、Express）带来了路由系统和持续运行，给进程减负了。前后端分离让灵狐法师登场，REST API 作为"物流法典"为不同系统建立了统一的配送标准。</p>
<h2 data-id="heading-0">📜 第三代：现代物流系统（Flask、Django、Express）</h2>
<h3 data-id="heading-1">时代背景</h3>
<p>🐍 大蟒蛇法师："现代物流系统出现了，比如我的 Flask、Django，还有夜狐法师的 Express。从这一代开始，有了本质的改变：进程持续运行，有固定的路由系统，可以只取用仓库中的部分内容，不依赖之前订单的运输团队。"</p>
<p><strong>关键分割点</strong>：</p>
<ul>
<li><strong>从第三代开始</strong>：核心是给进程减负了</li>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>之前的运送任务</strong>（第一、二代）：需要做过这一单子的运输团队，运输团队需要记录路径</li>
<li><strong>到了第三代</strong>：
<ul>
<li>有固定的路线（路由系统）</li>
<li>能够知道需要去哪些仓库取哪些东西</li>
<li>这些成了文档，记录在了内存里面</li>
<li>任务就变得简单了</li>
</ul>
</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>Flask（Python）</strong>：大蟒蛇法师的轻量级物流系统，灵活</li>
<li><strong>Django（Python）</strong>：大蟒蛇法师的全功能物流系统，功能丰富</li>
<li><strong>Express（Node.js）</strong>：夜狐法师的物流系统，JavaScript 世界的物流系统</li>
<li><strong>持续运行</strong>：不需要每次请求都重新启动</li>
<li><strong>路由系统</strong>：可以定义不同的配送路线</li>
<li><strong>中间件支持</strong>：可以添加物流中心点</li>
</ul>
<p><strong>比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务

之前的运送任务（第一、二代）：
  需要做过这一单子的运输团队
  运输团队需要记录路径
  任务复杂，需要运输团队记住路径

到了第三代：
  有固定的路线（路由系统）
  能够知道需要去哪些仓库取哪些东西
  这些成了文档，记录在了内存里面
  任务就变得简单了
  ↓
收到订单：
  🐍 大蟒蛇法师："物流系统一直在运行，直接处理订单..."
  ↓
通过路由系统（固定的路线文档）知道需要打开哪些仓库
  ↓
只取用仓库中的部分内容（函数、类等）
  ↓
处理订单（任务变简单了）
  ↓
返回结果
  ↓
进程继续运行，等待下一个订单
</code></pre>
<p><strong>与 CGI/PHP 的本质区别</strong>：</p>
<p><strong>CGI/PHP（第一、二代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务
每次请求：
  启动/复用进程 → 加载整个文件 → 处理订单 → 进程结束/保留
  运输团队每次都要重新装货，一个个仓库去开
  需要做过这一单子的运输团队，运输团队需要记录路径
  任务复杂
</code></pre>
<p><strong>现代物流系统（第三代开始）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">进程 = 整个送货的任务
核心是给进程减负了

有固定的路线（路由系统）
能够知道需要去哪些仓库取哪些东西
这些成了文档，记录在了内存里面
任务就变得简单了
  ↓
收到订单：
  通过路由系统（固定的路线文档）知道需要打开哪些仓库
  ↓
只取用仓库中的部分内容（函数、类等）
  ↓
处理订单（任务变简单了）
  ↓
进程继续运行，等待下一个订单
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6564002c7a984037a8eb73c8f66b029a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=8m2KkHRKloN9YVszWSmaj9NG3XQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 核心是给进程减负了：任务变简单了</li>
<li>✅ 持续运行，不需要每次重新启动</li>
<li>✅ 路由系统（固定的路线文档），可以定义不同的配送路线</li>
<li>✅ 能够知道需要去哪些仓库取哪些东西，记录在了内存里面</li>
<li>✅ 可以只取用仓库中的部分内容，不需要加载整个文件</li>
<li>✅ 不需要做过这一单子的运输团队，任务就变得简单了</li>
<li>✅ 中间件支持，可以添加物流中心点</li>
<li>✅ 效率高，可以处理大量订单</li>
</ul>
<p><strong>权衡：持续运行的资源消耗</strong></p>
<p>🐍 大蟒蛇法师："确实，到了第三代，运输任务（进程）一直存在，一直有人待命，这确实有资源消耗。但这是一个权衡："</p>
<p><strong>持续运行的消耗</strong>：</p>
<ul>
<li>⚠️ <strong>内存消耗</strong>：进程一直占用内存，即使没有订单</li>
<li>⚠️ <strong>CPU 消耗</strong>：需要一直监听订单请求（虽然很少，但确实在消耗）</li>
<li>⚠️ <strong>资源占用</strong>：运输团队一直待命，占用资源</li>
</ul>
<p><strong>但避免了什么</strong>：</p>
<ul>
<li>✅ <strong>避免每次启动进程的开销</strong>：第一代每次都要重新启动进程，启动成本很高</li>
<li>✅ <strong>避免每次加载代码的开销</strong>：不需要每次重新加载整个文件</li>
<li>✅ <strong>避免每次初始化的开销</strong>：不需要每次重新初始化环境</li>
<li>✅ <strong>响应速度更快</strong>：收到订单立即处理，不需要等待启动</li>
</ul>
<p><strong>权衡结果</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">第一代（CGI）：
  没有订单时：0 消耗（进程不存在）
  有订单时：高消耗（启动进程 + 加载代码 + 初始化 + 处理）
  = 按需消耗，但每次启动成本高

第三代（Flask/Django）：
  没有订单时：低消耗（进程在监听，占用内存）
  有订单时：低消耗（直接处理，不需要启动）
  = 持续低消耗，但响应速度快
</code></pre>
<p><strong>什么时候用哪种方式</strong>：</p>
<ul>
<li><strong>第一代（按需启动）</strong>：适合订单很少的场景，没有订单时完全不消耗资源</li>
<li><strong>第三代（持续运行）</strong>：适合订单频繁的场景，用持续的资源消耗换取更快的响应速度</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>⚠️ 但还没有统一的"配送标准"（REST API 概念）</li>
</ul>
<p><strong>前后端分离带来的革命性改变</strong>：</p>
<p>🐍 大蟒蛇法师："从第三代开始，灵狐法师出现了，前后端分离带来了革命性的改变。这不仅仅是技术上的改变，更是整个物流系统的升级。"</p>
<p><strong>前后端分离的价值</strong>：</p>
<ol>
<li><strong>货物集中到灵狐法师处打包和售卖</strong>：
<ul>
<li>之前：每个法师都要自己打包、自己卖货，各自为政</li>
<li>现在：所有法师的货物都送到灵狐法师那里，统一打包和售卖</li>
<li>好处：专业化分工，每个法师专注自己的核心能力</li>
</ul>
</li>
<li><strong>将备货和送货固定下来</strong>：
<ul>
<li>之前：每次订单都要重新准备，备货流程不固定</li>
<li>现在：备货和送货流程固定下来，有标准化的路线</li>
<li>好处：效率提升，错误减少</li>
</ul>
</li>
<li><strong>能够售卖的货物种类变多了</strong>：
<ul>
<li>之前：每个法师只能卖自己擅长的货物，种类有限</li>
<li>现在：灵狐法师可以整合多个法师的货物，提供更多种类的商品</li>
<li>好处：客户选择更多，满足更多需求</li>
</ul>
</li>
<li><strong>路线可以固定了下来</strong>：
<ul>
<li>之前：每次都要重新规划路线，运输团队需要记录路径</li>
<li>现在：路线固定下来，记录在路由系统中，不需要每次都重新规划</li>
<li>好处：任务变简单了，效率更高</li>
</ul>
</li>
<li><strong>能够得到灵狐法师更好的包装了</strong>：
<ul>
<li>之前：每个法师自己包装，包装质量参差不齐</li>
<li>现在：灵狐法师专业包装，包装精美，用户体验更好</li>
<li>好处：统一的用户体验，更好的交互</li>
</ul>
</li>
<li><strong>给很多法师带来了便利</strong>：
<ul>
<li>🐍 大蟒蛇法师："我不需要关心前端展示，只需要专注配制魔药，返回 JSON 数据就行。"</li>
<li>🌙 夜狐法师："我可以隐藏于黑暗中，专注后端逻辑，前端交给兄弟灵狐法师。"</li>
<li>☕ 黑水甲瓦法师："现代模式下，我也可以与灵狐法师合作，提供 REST API，不需要自己处理前端。"</li>
<li>🛡️ 蓝盾法师："现代模式下，我的 ASP.NET Core Web API 也可以与灵狐法师合作，前后端分离。"</li>
</ul>
</li>
</ol>
<p><strong>前后端分离的比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">之前（传统模式）：
  法师 → 自己打包 → 自己卖货 → 客户
  每个法师都要做所有事情，效率低，种类少

现在（前后端分离）：
  法师 → 返回 JSON 数据 → 灵狐法师统一打包和售卖 → 客户
  法师专注核心能力，灵狐法师专业包装和展示
  货物种类更多，包装更好，路线固定
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d8f77aba8c04f739f94165fa40019a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=qgIXuJuXGBk76gzK9wpftDPFVnc%3D" alt="image.png" loading="lazy"/></p>
<p>🧠 小结：从这一代开始，物流系统终于有了“路线图”和“打包团队”。虽然还不是统一标准，但各地法师之间，开始用同一种语言交流送货方式了。</p>
<p><strong>世界观解释</strong>：</p>
<ul>
<li>🐍 大蟒蛇法师："从第三代开始，我的 Flask 和 Django 物流系统有了本质的改变。核心是给进程减负了。进程是整个送货的任务，不是车马。之前的运送任务需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂。到了第三代，有固定的路线（路由系统），能够知道需要去哪些仓库取哪些东西，这些成了文档，记录在了内存里面，任务就变得简单了。虽然运输任务一直存在，一直有人待命，这确实有资源消耗（内存、CPU），但这是一个权衡：用持续的资源消耗，换取更快的响应速度。因为避免了每次启动进程、加载代码、初始化的开销，所以整体效率更高。更重要的是，灵狐法师的出现带来了前后端分离，这给整个物流系统带来了革命性的改变：货物可以集中到灵狐法师处打包和售卖，备货和送货固定下来，能够售卖的货物种类变多了，路线可以固定下来，并且能够得到灵狐法师更好的包装。这其实是给很多法师带来了便利，我们只需要专注核心能力，返回 JSON 数据，灵狐法师负责专业包装和展示。"</li>
<li>🌙 夜狐法师："我的 Express 物流系统也是这样的。虽然我隐藏于黑暗中，不露面，但我的物流系统一直在运行，与兄弟灵狐法师合作。我负责后端配置，灵狐法师负责卖货给客户。虽然一直待命有资源消耗，但响应速度快，适合订单频繁的场景。前后端分离让我可以专注后端逻辑，不需要关心前端展示，这给我带来了很大的便利。"</li>
<li>🦊 灵狐法师："前后端分离让我可以整合多个法师的货物，提供更多种类的商品给客户。我可以专业包装，提供更好的用户体验。路线固定下来后，我的工作也变得更简单了，不需要每次都重新规划。这其实是一个双赢的局面，法师们专注核心能力，我负责专业包装和展示。"</li>
</ul>
<hr/>
<h2 data-id="heading-2">📦 第四代：标准化物流系统（REST API 概念登场）</h2>
<h3 data-id="heading-3">REST API 是什么？</h3>
<p>🐍 大蟒蛇法师："REST API 不是某个具体的物流系统，它更像是整个魔法世界的《物流法典》。它定义了‘怎么发货、怎么收货、用什么格式沟通’，让所有系统都能彼此听懂、协同送达。"</p>
<p><strong>REST API = 标准化配送流程（概念）</strong>：</p>
<ul>
<li><strong>REST</strong>：Representational State Transfer（表现层状态转移）</li>
<li><strong>不是具体的物流系统</strong>：而是一个设计概念</li>
<li><strong>定义了配送标准</strong>：如何设计 API 接口</li>
<li><strong>让不同系统可以互相理解</strong>：遵循相同的标准</li>
</ul>
<p><strong>REST API 的核心原则</strong>：</p>
<ol>
<li><strong>资源（Resource）</strong>：
<ul>
<li>每个魔药都是一个资源</li>
<li>用 URL 表示资源（如 <code>/api/potions/123</code>）</li>
</ul>
</li>
<li><strong>HTTP 方法（Method）</strong>：
<ul>
<li>GET：查询魔药</li>
<li>POST：创建魔药</li>
<li>PUT：更新魔药</li>
<li>DELETE：删除魔药</li>
</ul>
</li>
<li><strong>无状态（Stateless）</strong>：
<ul>
<li>每次订单都是独立的</li>
<li>不依赖之前的订单</li>
</ul>
</li>
<li><strong>统一接口（Uniform Interface）</strong>：
<ul>
<li>所有接口都遵循相同的格式</li>
<li>使用标准的 HTTP 方法</li>
</ul>
</li>
<li><strong>分层系统（Layered System）</strong>：
<ul>
<li>可以有多个物流中心点（中间件）</li>
<li>每个层次负责不同的功能</li>
</ul>
</li>
</ol>
<p><strong>比喻</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">REST API = 标准化配送流程

就像所有物流公司都遵循相同的配送标准：
- 订单格式统一（JSON）
- 配送路线统一（URL 路径）
- 配送方法统一（HTTP 方法）
- 配送结果统一（HTTP 状态码）

这样，不同的物流系统（Flask、Django、FastAPI）都可以互相理解
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76ae4a4bc53c4d92964ecb059ed8b393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040796&amp;x-signature=MkuEAY2vrDDmH%2FoQowzY1jfGDJU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>重要理解</strong>：</p>
<ul>
<li>✅ REST API 是一个<strong>概念</strong>，不是某个具体的物流系统</li>
<li>✅ 不同的物流系统（Flask、Django、FastAPI）都可以遵循 REST API 概念</li>
<li>✅ 遵循 REST API 概念，可以让不同的系统互相理解</li>
</ul>
<hr/>
<hr/>
<h2 data-id="heading-4">📚 系列导航</h2>
<p><strong>系列名称</strong>：Web API 演进史：从 CGI 到 FastAPI<br/>
<em>（用物流系统比喻讲解 Web API 演进）</em></p>
<ul>
<li><a href="https://juejin.cn/post/7589932422655344676" target="_blank" title="https://juejin.cn/post/7589932422655344676">片段1：从重启马车到常驻运输队</a></li>
<li><a href="https://juejin.cn/post/7590421489997889555" target="_blank" title="https://juejin.cn/post/7590421489997889555">片段2：从随叫随到到规范配送</a> ← 当前文章</li>
<li><a href="https://juejin.cn/post/7590421489997922323" target="_blank" title="https://juejin.cn/post/7590421489997922323">片段3：从物流法典到智能调度</a></li>
</ul>
<hr/>
<blockquote>
<p>📝 片段2 结束<br/>
🔄 下一片段预告：<br/>
有了《物流法典》之后，各大法师开始制定自己的送货规章——REST API 的细节约定、FastAPI 的登场与智能化的调度中心也即将现身。最后的进化阶段，要开始了……</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[zustand源码解析]]></title>    <link>https://juejin.cn/post/7590592594674417674</link>    <guid>https://juejin.cn/post/7590592594674417674</guid>    <pubDate>2026-01-03T08:19:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594674417674" data-draft-id="7590592594674401290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="zustand源码解析"/> <meta itemprop="keywords" content="源码阅读,前端"/> <meta itemprop="datePublished" content="2026-01-03T08:19:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lzh_hz"/> <meta itemprop="url" content="https://juejin.cn/user/2348212566891831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            zustand源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212566891831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lzh_hz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T08:19:16.000Z" title="Sat Jan 03 2026 08:19:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">zustand是什么，如何使用</h2>
<p>Zustand 是一个轻量级的 React 状态管理库，比 Redux 简单，比 Context 高效。</p>
<ul>
<li>核心代码约 100 行，API 简单直观。</li>
<li>无Provider</li>
<li>符合 React Hooks 使用习惯</li>
<li>只更新订阅了变化状态的组件。</li>
<li>完整的类型推断和支持。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>

<span class="hljs-comment">// 1️⃣ 定义类型（TypeScript）</span>
interface <span class="hljs-title class_">BearStore</span> {
  <span class="hljs-attr">bears</span>: number
  <span class="hljs-attr">fish</span>: number
  <span class="hljs-attr">addBear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
  <span class="hljs-attr">eatFish</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span>
}

<span class="hljs-comment">// 2️⃣ 创建 Store</span>
<span class="hljs-keyword">const</span> useBearStore = create&lt;<span class="hljs-title class_">BearStore</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">bears</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">fish</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">addBear</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">bears</span>: s.<span class="hljs-property">bears</span> + <span class="hljs-number">1</span> })),
  <span class="hljs-attr">eatFish</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">fish</span>: s.<span class="hljs-property">fish</span> - <span class="hljs-number">1</span> })),
  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">bears</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">fish</span>: <span class="hljs-number">10</span> })
}))

<span class="hljs-comment">// 3️⃣ 组件 A：只订阅 bears</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BearCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bears = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">bears</span>)
  <span class="hljs-keyword">const</span> addBear = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">addBear</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>🐻 Bears: {bears}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{addBear}</span>&gt;</span>Add Bear<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 4️⃣ 组件 B：只订阅 fish</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FishCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fish = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">fish</span>)
  <span class="hljs-keyword">const</span> eatFish = <span class="hljs-title function_">useBearStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">eatFish</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>🐟 Fish: {fish}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{eatFish}</span>&gt;</span>Eat Fish<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 5️⃣ 主应用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">BearCounter</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FishCounter</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-1">当调用zustand的create时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> create <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: s.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> }))
}))
</code></pre>
<p>create 方法最终会调用vanvailla.ts中的createStoreImp 函数</p>
<p>createStoreImp主要完成的功能:</p>
<ul>
<li>创建zustand的api(setSate,getState,getInitialState, subscribe)</li>
<li>在调用时会执行传入的函数，将最终结果赋值给 initialState</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的createState是下面这个函数</span>
<span class="hljs-comment">// (set) =&gt; ({</span>
<span class="hljs-comment">//   count: 0,</span>
<span class="hljs-comment">//   increment: () =&gt; set((s) =&gt; ({ count: s.count + 1 }))</span>
<span class="hljs-comment">// })</span>
<span class="hljs-comment">// 最终initialState的值是</span>
<span class="hljs-comment">// { </span>
<span class="hljs-comment">//   count:0,</span>
<span class="hljs-comment">//   increment:() =&gt; set((s) =&gt; ({ count: s.count + 1 }))</span>
<span class="hljs-comment">// }</span>

<span class="hljs-keyword">const</span> initialState = (state = <span class="hljs-title function_">createState</span>(setState, getState, api))
<span class="hljs-keyword">return</span> api <span class="hljs-keyword">as</span> any
</code></pre>
<p>createStoreImp返回的api会在react.ts中的createImp中使用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./vanilla.ts'</span>
<span class="hljs-keyword">const</span> createImpl = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">createState: StateCreator&lt;T, [], []&gt;</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> api = <span class="hljs-title function_">createStore</span>(createState)

  <span class="hljs-keyword">const</span> <span class="hljs-attr">useBoundStore</span>: any = <span class="hljs-function">(<span class="hljs-params">selector?: any</span>) =&gt;</span> <span class="hljs-title function_">useStore</span>(api, selector)

  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(useBoundStore, api)

  <span class="hljs-keyword">return</span> useBoundStore
}
</code></pre>
<p>useStore会创建一个hook, 将获取到的api 传入React.useSyncExternalStore()方法，从而实现当setSate时，订阅了这个state的组件都会触发重新渲染.</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useStore&lt;<span class="hljs-title class_">TState</span>, <span class="hljs-title class_">StateSlice</span>&gt;(
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">ReadonlyStoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;,
  <span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">state: TState</span>) =&gt;</span> <span class="hljs-title class_">StateSlice</span> = identity <span class="hljs-keyword">as</span> any,
) {
  <span class="hljs-keyword">const</span> slice = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useSyncExternalStore</span>(
    api.<span class="hljs-property">subscribe</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getState</span>()), [api, selector]),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getInitialState</span>()), [api, selector]),
  )
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useDebugValue</span>(slice)
  <span class="hljs-keyword">return</span> slice
}
</code></pre>
<p>当在一个组件调用useStore时，都会执行React.useSyncExternalStore()，useSyncExternalStore() 会执行api.subscribe.  api.subscibe定义在vanilla.ts的createStoreImp函数中</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的listener是由react的useSyncExtenalStore传入的callback function, 会注册到listeners里</span>
<span class="hljs-comment">// 调用callback function会触发组件重新渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">subscribe</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'subscribe'</span>] = <span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> {
    listeners.<span class="hljs-title function_">add</span>(listener)
    <span class="hljs-comment">// Unsubscribe</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> listeners.<span class="hljs-title function_">delete</span>(listener)
  }
<span class="hljs-comment">// 当 setSate里，会执行listeners里的callback function, 从而实现组件更新</span>
 <span class="hljs-keyword">const</span> <span class="hljs-attr">setState</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'setState'</span>] = <span class="hljs-function">(<span class="hljs-params">partial, replace</span>) =&gt;</span> {
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Remove type assertion once https://github.com/microsoft/TypeScript/issues/37663 is resolved</span>
    <span class="hljs-comment">// https://github.com/microsoft/TypeScript/issues/37663#issuecomment-759728342</span>
    <span class="hljs-keyword">const</span> nextState =
      <span class="hljs-keyword">typeof</span> partial === <span class="hljs-string">'function'</span>
        ? (partial <span class="hljs-keyword">as</span> (<span class="hljs-attr">state</span>: <span class="hljs-title class_">TState</span>) =&gt; <span class="hljs-title class_">TState</span>)(state)
        : partial
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(nextState, state)) {
      <span class="hljs-keyword">const</span> previousState = state
      state =
        (replace ?? (<span class="hljs-keyword">typeof</span> nextState !== <span class="hljs-string">'object'</span> || nextState === <span class="hljs-literal">null</span>))
          ? (nextState <span class="hljs-keyword">as</span> <span class="hljs-title class_">TState</span>)
          : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, state, nextState)
      <span class="hljs-comment">// 关键实现</span>
      listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> <span class="hljs-title function_">listener</span>(state, previousState))
    }
  }

</code></pre>
<p>再回到react.ts中的createImpl函数，会返回一个hook给业务组件去调用</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> api = <span class="hljs-title function_">createStore</span>(...)  <span class="hljs-comment">// api 已创建                         │</span>
│                                                                      │
│  <span class="hljs-comment">// 创建 Hook 函数                                                    │</span>
│  <span class="hljs-keyword">const</span> <span class="hljs-title function_">useBoundStore</span> = (<span class="hljs-params">selector</span>) =&gt; <span class="hljs-title function_">useStore</span>(api, selector)         │
│  <span class="hljs-comment">//                                     │                            │</span>
│  <span class="hljs-comment">//  闭包捕获 api ◄─────────────────────┘                            │</span>
│                                                                      │
│  <span class="hljs-comment">// 将 api 方法挂载到 Hook 上                                         │</span>
│  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(useBoundStore, api)                                   │
│  <span class="hljs-comment">//                                                                  │</span>
│  <span class="hljs-comment">//  useBoundStore.getState = api.getState                           │</span>
│  <span class="hljs-comment">//  useBoundStore.setState = api.setState                           │</span>
│  <span class="hljs-comment">//  useBoundStore.subscribe = api.subscribe                         │</span>
│                                                                      │
│  <span class="hljs-keyword">return</span> useBoundStore                                                │
│                           
</code></pre>
<p>create函数主要作了以下三件事:</p>
<ul>
<li>创建 vanilla store (包含zustand的api)</li>
<li>调用用户函数</li>
<li>包装成hook</li>
</ul>
<h2 data-id="heading-2">当getState时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'zustand'</span>
}))

<span class="hljs-comment">// 获取当前状态</span>
<span class="hljs-keyword">const</span> state = useStore.<span class="hljs-title function_">getState</span>()
<span class="hljs-comment">// { count: 0, name: 'zustand' }</span>

<span class="hljs-comment">// 获取特定字段</span>
<span class="hljs-keyword">const</span> count = useStore.<span class="hljs-title function_">getState</span>().<span class="hljs-property">count</span>
<span class="hljs-comment">// 0</span>
</code></pre>
<p>根据上面的create实现解析，useStore的getState()最终会调用定义在vanilla.ts中的createStoreImpl中的getState</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-attr">getState</span>: <span class="hljs-title class_">StoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;[<span class="hljs-string">'getState'</span>] = <span class="hljs-function">() =&gt;</span> state
<span class="hljs-comment">// 如果调用时未触发setState， 获取到的是用户在ceate时传入的state, 调用create时会执行以下代码</span>
<span class="hljs-keyword">const</span> initialState = (state = <span class="hljs-title function_">createState</span>(setState, getState, api))

</code></pre>
<h2 data-id="heading-3">当setState时会发生什么</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>
}))

<span class="hljs-comment">// 在任何地方</span>
useStore.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">10</span> })
</code></pre>
<p>据上面的create实现解析，useStore的getState()最终会调用定义在vanilla.ts中的createStoreImpl中的setSate</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">setState</span> = (<span class="hljs-params">partial, replace</span>) =&gt; {
  <span class="hljs-comment">// 1️⃣ 计算新状态</span>
  <span class="hljs-keyword">const</span> nextState =
    <span class="hljs-keyword">typeof</span> partial === <span class="hljs-string">'function'</span>
      ? <span class="hljs-title function_">partial</span>(state)    <span class="hljs-comment">// 函数式：调用函数得到新状态</span>
      : partial           <span class="hljs-comment">// 对象式：直接使用</span>

  <span class="hljs-comment">// 2️⃣ 检查是否真的变化</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(nextState, state)) {
    <span class="hljs-keyword">const</span> previousState = state
    
    <span class="hljs-comment">// 3️⃣ 决定合并还是替换</span>
    state =
      (replace ?? (<span class="hljs-keyword">typeof</span> nextState !== <span class="hljs-string">'object'</span> || nextState === <span class="hljs-literal">null</span>))
        ? nextState                         <span class="hljs-comment">// 替换</span>
        : <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, state, nextState)  <span class="hljs-comment">// 浅合并</span>

    <span class="hljs-comment">// 4️⃣ 通知所有订阅者</span>
    listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">listener</span>) =&gt;</span> <span class="hljs-title function_">listener</span>(state, previousState))
  }
}
</code></pre>
<p>setSate时不会触发所有组件的更新，只会触发订阅了相关state的组件更新</p>
<pre><code class="hljs language-javascript" lang="javascript">onst useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'zustand'</span>,
  <span class="hljs-attr">updateCount</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }),
  <span class="hljs-attr">updateName</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'bear'</span> })
}))

<span class="hljs-comment">// 组件 A：只订阅 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterA</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterA 渲染'</span>)
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">count</span>)  <span class="hljs-comment">// ← 只关心 count</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 组件 B：只订阅 name</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterB</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterB 渲染'</span>)
  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> s.<span class="hljs-property">name</span>)  <span class="hljs-comment">// ← 只关心 name</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-comment">// 组件 C：订阅全部</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterC</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CounterC 渲染'</span>)
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useStore</span>()  <span class="hljs-comment">// ← 关心所有</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{state.count} - {state.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<p>当组件A调用userStore时，最终会执行react.ts中的useStore</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这里的select就是组件A传入的(s) =&gt; s.name</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useStore&lt;<span class="hljs-title class_">TState</span>, <span class="hljs-title class_">StateSlice</span>&gt;(
  <span class="hljs-attr">api</span>: <span class="hljs-title class_">ReadonlyStoreApi</span>&lt;<span class="hljs-title class_">TState</span>&gt;,
  <span class="hljs-attr">selector</span>: <span class="hljs-function">(<span class="hljs-params">state: TState</span>) =&gt;</span> <span class="hljs-title class_">StateSlice</span> = identity <span class="hljs-keyword">as</span> any,
) {
  <span class="hljs-comment">// getSnapshot 通过 selector 只取需要的部分, 只有需要的部分的值发送变化时，才会触发更新</span>
  <span class="hljs-keyword">const</span> slice = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useSyncExternalStore</span>(
    api.<span class="hljs-property">subscribe</span>,
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getState</span>()), [api, selector]),
    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selector</span>(api.<span class="hljs-title function_">getInitialState</span>()), [api, selector]),
  )
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useDebugValue</span>(slice)
  <span class="hljs-keyword">return</span> slice
}
</code></pre>
<p>具体流程</p>
<ol>
<li>
<p>setState 改变状态</p>
</li>
<li>
<p>通知所有订阅的组件（所有使用 useStore 的组件）</p>
</li>
<li>
<p>每个组件执行自己的 selector(newState)</p>
</li>
<li>
<p>比较 selector 返回的新旧值</p>
<pre><code class="hljs">│

├── 相等 → 不重渲染

│

└── 不等 → 重渲染
</code></pre>
</li>
</ol>
<h2 data-id="heading-4">Rect.useSyncExternalStore解析</h2>
<p>react 18 新增的 Hook，用于安全地订阅外部数据源。</p>
<p>简化实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useSyncExternalStore</span>(<span class="hljs-params">subscribe, getSnapshot, getServerSnapshot</span>) {
  <span class="hljs-comment">// 存储当前快照</span>
  <span class="hljs-keyword">const</span> [snapshot, setSnapshot] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// SSR 时用 getServerSnapshot</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span> 
      ? getServerSnapshot?.() 
      : <span class="hljs-title function_">getSnapshot</span>()
  })

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// React 创建的 callback</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">callback</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> newSnapshot = <span class="hljs-title function_">getSnapshot</span>()
      <span class="hljs-comment">// 只有真正变化才更新</span>
      <span class="hljs-title function_">setSnapshot</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(prev, newSnapshot)) {
          <span class="hljs-keyword">return</span> prev  <span class="hljs-comment">// 返回旧值，不触发更新</span>
        }
        <span class="hljs-keyword">return</span> newSnapshot
      })
    }

    <span class="hljs-comment">// 订阅</span>
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title function_">subscribe</span>(callback)

    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">return</span> unsubscribe
  }, [subscribe, getSnapshot])

  <span class="hljs-keyword">return</span> snapshot
}
</code></pre>
<p>具体流程：</p>
<ol>
<li>Mount<br/>
├── 1.1 getSnapshot() → 初始值<br/>
├── 1.2 subscribe(callback) → 注册<br/>
└── 1.3 return 初始值</li>
<li>状态变化<br/>
├── 2.1 你调用 callback()<br/>
├── 2.2 React 调用 getSnapshot() → 新值<br/>
├── 2.3 Object.is(旧值, 新值)<br/>
└── 2.4 相等？<br/>
├── 2.4.1 是 → 跳过<br/>
└── 2.4.2 否 → 重渲染</li>
<li>Unmount<br/>
└── 3.1 调用 unsubscribe()</li>
</ol>
<h2 data-id="heading-5">总结</h2>
<p>核心实现是使用React.useSyncExternalStore hook， 创建一个store， 当state里的值发生改变时，触发订阅了state的值的组件重新渲染。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[图文+示例，带你彻底搞清楚那些加密手段...！]]></title>    <link>https://juejin.cn/post/7590213554798542883</link>    <guid>https://juejin.cn/post/7590213554798542883</guid>    <pubDate>2026-01-03T09:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798542883" data-draft-id="7590128405351792640" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="图文+示例，带你彻底搞清楚那些加密手段...！"/> <meta itemprop="keywords" content="安全,程序员"/> <meta itemprop="datePublished" content="2026-01-03T09:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="momo06117"/> <meta itemprop="url" content="https://juejin.cn/user/3103246594353275"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            图文+示例，带你彻底搞清楚那些加密手段...！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3103246594353275/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    momo06117
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:02:39.000Z" title="Sat Jan 03 2026 09:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近，小编在学习的过程中有了解到加密的手段，因此想来分享一下自己学到的一些新知识。如有讲得不好或遗漏 欢迎各位大佬在评论区指出。</p>
<h2 data-id="heading-1">关于加密</h2>
<p>加密是<strong>指通过特定手段将明文存储的内容加密成密文</strong>。那么为什么要进行加密呢？</p>
<p>互联网中各种攻击防不胜防，如果敏感内容不加密存储，例如用户密码之类的（一想到自己的密码明晃晃的暴露在传输过程中，是不是有点后背一凉的感觉~），那攻击者就能够轻易获取用户隐私信息并实施攻击。</p>
<p>因此加密是必不可少的。那么<strong>加密的手段有哪些？或者我们在针对什么场景应该做什么加密？</strong></p>
<p>下面小编一一介绍并通过node手段简单实现。</p>
<h3 data-id="heading-2">hash加密</h3>
<p>加密手段中，最常见的就是hash加密，指通过一定的算法将明文转化为密文。</p>
<blockquote>
<p>比如将密码abc随机后退3格加密成为dfg，这是一种最简单的加密手段。</p>
</blockquote>
<p>现代常见最常见的加密手段有<code>MD5</code>，<code>SHA</code>加密等，由于其复杂性hash加密是不可逆的。但是由于hash算法固定，<strong>因此同一个密码加密后是相同的密文</strong>，因此攻击者想到可以通过<code>彩虹表</code>攻击。</p>
<p>故实际生产中，我们往往会往明文先<strong>加盐</strong>（一段随机的字符串插入），然后再进行hash加密。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b918c32c6e5948ae95d5726730937fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=tKXDFYKI31YbGog63yv84hp9l%2FM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>使用场景</strong>： 数据库中的<strong>密码存储</strong>（由于hash不可逆，实则程序员也不知道你的密码）</p>
<p><strong>实现示例</strong>： 使用bcrypt进行加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//自动加盐并且内嵌</span>
<span class="hljs-keyword">const</span> hashPassword = bcrypt.<span class="hljs-title function_">hashSync</span>(password,<span class="hljs-number">10</span>) 
<span class="hljs-comment">//解密</span>
<span class="hljs-keyword">const</span> compareResult = bcrypt.<span class="hljs-title function_">compareSync</span>(userinfo.<span class="hljs-property">password</span>,result[<span class="hljs-number">0</span>].<span class="hljs-property">password</span>)
</code></pre>
<h3 data-id="heading-3">对称加密</h3>
<p><em>上面说到了hash算法，但由于hash算法是不可逆的，故常用于存储加密，而实际开发中我们会经常用到传输加密，故对称加密应运而生。</em></p>
<p>对称加密是指将<strong>密码通过密钥加密后生成密文</strong>，对方再<strong>通过同一密钥破解生成的密文。</strong></p>
<p><strong>常见手段</strong>：<code>AES加密</code></p>
<p><strong>优缺点</strong>：加密简单，解密<strong>速度快</strong>。但密钥的管理和传输困难。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/192a49f73a87464d8ff1b625fee4f428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=yahfUQEuuQj%2Bi05fLJdFlPaqz5k%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>：大量需要被加密的内容</p>
<p><strong>实现示例</strong>：使用<code>CryptoJS</code>进行AES加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cryptoJs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto-js'</span>)

<span class="hljs-keyword">const</span> message = <span class="hljs-string">'hello word'</span>
<span class="hljs-keyword">const</span> key = <span class="hljs-string">'this is key'</span> <span class="hljs-comment">//实际过程中 对称密钥通常是随机生成的</span>

<span class="hljs-comment">//加密</span>
<span class="hljs-keyword">const</span> encrypted = cryptoJs.<span class="hljs-property">AES</span>.<span class="hljs-title function_">encrypt</span>(message, key)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'对称加密密文：'</span>,encrypted.<span class="hljs-title function_">toString</span>())

<span class="hljs-comment">//将密文解密</span>
<span class="hljs-keyword">const</span> decryptedMessage  = cryptoJs.<span class="hljs-property">AES</span>.<span class="hljs-title function_">decrypt</span>(encrypted,key)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解密：'</span>,decryptedMessage.<span class="hljs-title function_">toString</span>(cryptoJs.<span class="hljs-property">enc</span>.<span class="hljs-property">Utf8</span>))
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00ad039ab7b42898bf6f5de2f307e04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=UkhfZ2z3D2m2NjxIsKkyoF7f9ko%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">非对称加密</h3>
<p><em>目的是为了解决上面提到的密钥安全问题，对称加密密钥被截获，密文也就轻易可知了。</em></p>
<p>非对称加密是指发送端用<strong>公钥</strong>进行加密，然后采用<strong>私钥</strong>进行解密，公钥是公开的，私钥是只有接受方才有的。就像一个箱子，发送方把用锁把箱子锁上，接收方用钥匙解锁。</p>
<p><strong>常见手段</strong>:<code> RSA非对称加密</code></p>
<p><strong>优缺点</strong>： 由于私钥只有接收方可知，<strong>保密性好</strong>。但加密和解密比较耗时。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02606218f9b5453897aa65a0e75d0c88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=AQGSXsc4exWRSckuaEzxKQNImwo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>： 密钥交换，数字签名</p>
<p><strong>实现示例</strong>： 使用node原生crypto进行RSA非对称加密</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-comment">// 生成RSA密钥对</span>
<span class="hljs-keyword">const</span> { publicKey, privateKey } = crypto.<span class="hljs-title function_">generateKeyPairSync</span>(<span class="hljs-string">'rsa'</span>, {
  <span class="hljs-attr">modulusLength</span>: <span class="hljs-number">2048</span>, <span class="hljs-comment">// 密钥长度</span>
  <span class="hljs-attr">publicKeyEncoding</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'spki'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'pem'</span>
  },
  <span class="hljs-attr">privateKeyEncoding</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'pkcs8'</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">'pem'</span>
  }
})

<span class="hljs-keyword">const</span> data = <span class="hljs-string">'hello word'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始数据:'</span>, data);

<span class="hljs-comment">// 使用公钥加密</span>
<span class="hljs-keyword">const</span> encryptedData = crypto.<span class="hljs-title function_">publicEncrypt</span>(
  {
    <span class="hljs-attr">key</span>: publicKey,
    <span class="hljs-attr">padding</span>: crypto.<span class="hljs-property">constants</span>.<span class="hljs-property">RSA_PKCS1_OAEP_PADDING</span>
  },
  <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(data)
)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'加密后 (base64):'</span>, encryptedData.<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>))

<span class="hljs-comment">// 使用私钥解密</span>
<span class="hljs-keyword">const</span> decryptedData = crypto.<span class="hljs-title function_">privateDecrypt</span>(
  {
    <span class="hljs-attr">key</span>: privateKey,
    <span class="hljs-attr">padding</span>: crypto.<span class="hljs-property">constants</span>.<span class="hljs-property">RSA_PKCS1_OAEP_PADDING</span>
  },
  encryptedData
)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解密后:'</span>, decryptedData.<span class="hljs-title function_">toString</span>())
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/107deb59b637439c97f0e2c6d48ac996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=HiSrp0WC1E5VMgoREVlpENEe2mc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">混合加密</h3>
<p>上面有说到对称加密和非对称加密的优缺点，那么有没有集两者大成，既适合传输大量内容又密钥管理安全的方案呢？
答案是有的，那就是混合加密。</p>
<p>混合加密是指用<code>非对称加密</code> 加密 <code>对称加密的密钥</code>，可能有点绕，下面详细介绍一下。</p>
<p><strong>加密过程</strong>：</p>
<ol>
<li>服务器生成一对公钥和私钥，<strong>将公钥发送给客户端</strong></li>
<li>客户端收到私钥后，<strong>随机生成一对会话密钥（对称密钥）用服务器的公钥加密后发送</strong></li>
<li>服务器收到密文后，<strong>用私钥解密，会话密钥</strong></li>
<li>此时，服务器和客户端都有会话密钥，此后都使用<strong>会话密钥加密对话</strong></li>
</ol>
<p><strong>优缺点</strong>：只需要前期少量资源用于非对称加密，后期可用对称加密传输大量内容，但实现比较复杂</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69da4ac4205b40c0872c21fb559f953b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=lN9rmh9ZcQknNrzvO7ocq0VrGaM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>实际场景</strong>： http加密的重要手段，现代大量加密场景等。</p>
<h2 data-id="heading-6">总结</h2>
<p>总的来说，加密是我们开发过程中必不可少的一环，针对不同的环境，做出不同的加密手段是我们作为开发者必不可少的综合技能~</p>















































<table><thead><tr><th>特性</th><th>Hash加密</th><th>对称加密</th><th>非对称加密</th><th>混合加密</th></tr></thead><tbody><tr><td><strong>加密类型</strong></td><td>加密存储</td><td>加密传输</td><td>加密传输</td><td>加密传输</td></tr><tr><td><strong>核心原理</strong></td><td>单向散列函数</td><td>相同密钥加解密</td><td>公钥加密，私钥解密</td><td>非对称加密保护对称密钥</td></tr><tr><td><strong>密钥数量</strong></td><td>无密钥（有盐值）</td><td>1个共享密钥</td><td>2个密钥（公钥+私钥）</td><td>3个密钥（非对称对+对称密钥）</td></tr><tr><td><strong>安全性</strong></td><td>防篡改，不可逆</td><td>依赖密钥安全</td><td>依赖数学难题安全</td><td>综合安全等级最高</td></tr><tr><td><strong>推荐场景</strong></td><td>需要验证但不需要解密的场景</td><td>内部系统、大量加密</td><td>密钥分发、身份认证</td><td>公网通信、高安全要求</td></tr></tbody></table>
<p><em>制作不易 礼貌集赞</em></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f971a67e95f456aa4c8a14f1fdce448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9tbzA2MTE3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768035759&amp;x-signature=PYkD7YOu1mrO7DWRHOIq6Rfu8eQ%3D" alt="image.png" width="30%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 之 自定义 Hooks 🚀]]></title>    <link>https://juejin.cn/post/7590292192988971048</link>    <guid>https://juejin.cn/post/7590292192988971048</guid>    <pubDate>2026-01-03T09:15:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192988971048" data-draft-id="7590403249560633359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React  之  自定义 Hooks 🚀"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2026-01-03T09:15:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React  之  自定义 Hooks 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:15:48.000Z" title="Sat Jan 03 2026 09:15:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义 Hooks 🚀</h2>
<p>在 React 的世界里，Hooks 就像一把神奇的钥匙，为函数组件打开了状态管理和生命周期的大门。今天我们就来深入探索自定义 Hooks 的奥秘，看看它如何让我们的代码更优雅、更可复用！</p>
<h3 data-id="heading-1">一、hooks 详解 🧐</h3>
<h4 data-id="heading-2">1. 什么是 hooks ？</h4>
<p>Hooks 是 React 16.8 引入的新特性，它是一种<strong>函数编程思想的实践</strong>，允许我们在不编写类组件的情况下，在函数组件中使用状态（State）和其他 React 特性（如生命周期）。简单来说，Hooks 就是 “钩子”，能让我们轻松 “钩入” React 的内部特性，让函数组件拥有更强大的能力。</p>
<h4 data-id="heading-3">2. hooks 分类</h4>
<p>Hooks 主要分为两类：</p>
<ul>
<li><strong>React 内置 Hooks</strong>：如<code>useState</code>（管理状态）、<code>useEffect</code>（处理副作用）、<code>useContext</code>（共享上下文）等，这些是 React 官方提供的基础工具。</li>
<li><strong>自定义 Hooks</strong>：由开发者根据业务需求封装的 Hooks，命名以<code>use</code>开头，本质是对内置 Hooks 和业务逻辑的组合封装，方便复用。</li>
</ul>
<p>（前面我们讲解过 React 内置的 hooks 函数，感兴趣的小伙伴可以去翻翻我前面的文章看看）</p>
<h4 data-id="heading-4">3. hooks 有什么作用？</h4>
<ul>
<li>让函数组件具备状态管理能力，摆脱类组件的繁琐语法（如<code>this</code>绑定、生命周期函数嵌套）。</li>
<li>将组件中的相关逻辑聚合在一起，而非分散在不同的生命周期函数中（比如类组件中<code>componentDidMount</code>和<code>componentDidUpdate</code>可能写重复逻辑）。</li>
<li>实现逻辑复用，通过自定义 Hooks 将相同的状态逻辑抽离，供多个组件使用。</li>
</ul>
<h4 data-id="heading-5">4. 为什么需要自定义 hooks ？</h4>
<p>在开发中，我们经常会遇到多个组件需要共享相同状态逻辑的场景。比如：多个组件都需要监听鼠标位置、都需要处理本地存储数据、都需要发起相同的 API 请求等。</p>
<p>如果没有自定义 Hooks，我们可能会通过 “复制粘贴代码” 或 “高阶组件”“render props” 等方式复用逻辑，但这些方式要么导致代码冗余，要么增加组件层级复杂度。</p>
<p>而自定义 Hooks 就像一个 “逻辑容器”，能将这些重复逻辑抽离成独立函数，让组件只关注 UI 渲染，极大提升代码的复用性和可维护性！</p>
<h3 data-id="heading-6">二、先来看一个简单案例：响应式显示鼠标的位置 🖱️</h3>
<h4 data-id="heading-7">1. 需求分析</h4>
<p>我们要实现一个包含两个核心功能的小应用：</p>
<p>（1）<strong>计数功能</strong>：一个计数器，点击按钮可以增加数字。</p>
<p>（2）<strong>条件显示鼠标位置</strong>：当计数器的值为偶数时，显示鼠标在页面上的实时坐标；为奇数时，不显示。</p>
<h4 data-id="heading-8">2. 核心实现（两个文件）</h4>
<p>（1）<code>App2.jsx</code>：主组件，负责管理计数器状态和根据计数奇偶性条件渲染鼠标位置组件。</p>
<p>（2）<code>useMouse.js</code>：自定义 Hooks，封装鼠标位置监听的逻辑，提供<code>x</code>、<code>y</code>坐标供组件使用（向外暴露的状态和方法放在 return 中返回）。</p>
<h4 data-id="heading-9">3. 代码展示</h4>
<h5 data-id="heading-10">（1）App2.jsx</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useMouse } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useMouse.js'</span>;

<span class="hljs-comment">// 鼠标位置展示组件（纯UI组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 调用自定义Hook获取鼠标坐标</span>
    <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                鼠标位置：{x}, {y}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 定义计数器状态，初始值为0</span>
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {/* 显示当前计数 */}
            {count}
            {/* 点击按钮增加计数（使用函数式更新确保获取最新count） */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount((count) =&gt; count + 1)}&gt;
                点击增加
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            {/* 当count为偶数时，渲染MouseMove组件显示鼠标位置 */}
            {count % 2 === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">MouseMove</span> /&gt;</span>}
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<p><strong>代码逻辑详解</strong>：</p>
<ul>
<li><code>App</code>组件通过<code>useState</code>管理计数器<code>count</code>的状态，点击按钮时通过<code>setCount</code>更新值。</li>
<li>定义了<code>MouseMove</code>组件，它不包含任何业务逻辑，仅通过调用<code>useMouse()</code>获取鼠标坐标并渲染，是一个纯 UI 组件。</li>
<li>通过条件渲染<code>{count % 2 === 0 &amp;&amp; &lt;MouseMove /&gt;}</code>实现 “偶数显示鼠标位置，奇数不显示” 的需求。</li>
</ul>
<h5 data-id="heading-11">（2）useMouse.js</h5>
<p>js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 自定义Hook：封装鼠标位置监听逻辑（命名以use开头）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 定义状态存储鼠标x、y坐标，初始值为0</span>
    <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// 副作用：监听鼠标移动事件</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 事件处理函数：更新x、y坐标</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'/////'</span>);
            <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>); <span class="hljs-comment">// 更新x坐标为鼠标相对于文档的水平位置</span>
            <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>); <span class="hljs-comment">// 更新y坐标为鼠标相对于文档的垂直位置</span>
        }
        <span class="hljs-comment">// 绑定mousemove事件，触发时调用update更新坐标</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'||||| 挂载'</span>); <span class="hljs-comment">// 组件挂载时打印</span>

        <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听，避免内存泄漏</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update); <span class="hljs-comment">// 移除相同的事件处理函数</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'===== 清除'</span>); <span class="hljs-comment">// 清理时打印</span>
        }
    }, []); <span class="hljs-comment">// 空依赖数组：仅在组件挂载时执行一次，卸载时执行清理</span>

    <span class="hljs-comment">// 返回鼠标坐标，供组件使用</span>
    <span class="hljs-keyword">return</span> {
        x,
        y,
    }
}
</code></pre>
<p><strong>代码逻辑详解</strong>：</p>
<ul>
<li>
<p><code>useMouse</code>遵循命名规范（以<code>use</code>开头），内部可以调用内置 Hooks（<code>useState</code>、<code>useEffect</code>）。</p>
</li>
<li>
<p>用<code>useState</code>定义<code>x</code>和<code>y</code>状态，分别存储鼠标的水平和垂直坐标。</p>
</li>
<li>
<p>用<code>useEffect</code>处理鼠标监听的副作用：</p>
<ul>
<li>挂载时：绑定<code>mousemove</code>事件，鼠标移动时触发<code>update</code>函数更新<code>x</code>、<code>y</code>。</li>
<li>卸载时：通过<code>useEffect</code>的返回函数移除<code>mousemove</code>事件监听，避免组件已卸载但事件仍触发的内存泄漏（比如当<code>count</code>为奇数时，<code>MouseMove</code>组件卸载，此时会执行清理函数）。</li>
</ul>
</li>
<li>
<p>最后返回包含<code>x</code>和<code>y</code>的对象，让组件可以获取鼠标坐标。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b705405c85ef47a5b17e097ff41195ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=ouEpwutZVO56nhLVP1NUDhXOMrI%3D" alt="QQ20260103-184336.png" loading="lazy"/></p>
<h4 data-id="heading-12">4. 效果展示：</h4>
<ul>
<li>当点击按钮使<code>count</code>为 0、2、4 等偶数时，页面会显示 “鼠标位置：x, y”，移动鼠标时坐标会实时更新，控制台打印 “||||| 挂载”。</li>
<li>当点击按钮使<code>count</code>为 0、2、4 等偶数时，移动鼠标，控制台打印“/////”</li>
<li>当<code>count</code>为 1、3、5 等奇数时，鼠标位置不显示，控制台打印 “===== 清除”且不打印“/////”（表示事件监听已移除）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e85e9f21c8cb4672bcec43e966698393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=N8wjjJQcE2e5MpwEBStosoiuzZg%3D" alt="QQ202613-165111.gif" loading="lazy"/></p>
<h3 data-id="heading-13">三、详解自定义 hooks 📚</h3>
<p>通过上面的简单案例，我们可以总结出关于自定义 Hooks 的必备知识：</p>
<h4 data-id="heading-14">1. 什么时候需要自定义 hooks ？</h4>
<p>（1）<strong>逻辑复用场景</strong>当多个组件需要共享相同的状态逻辑时，通过自定义 Hook 封装可避免代码重复。上面案例中，<code>useMouse</code>封装了鼠标位置监听的完整逻辑（状态管理、事件绑定 / 解绑），使得<code>MouseMove</code>组件无需重复编写该逻辑。若其他组件（如 “鼠标轨迹绘制组件”）也需要获取鼠标位置，可直接复用<code>useMouse</code>。</p>
<p>（2）<strong>分离 UI 与业务逻辑</strong>当组件中同时包含 UI 渲染和复杂业务逻辑（如事件监听、数据处理）时，自定义 Hooks 可将业务逻辑抽离，让组件只专注于 UI 展示。上面案例中，<code>MouseMove</code>组件仅负责渲染鼠标坐标（纯 UI 逻辑），而鼠标监听的业务逻辑被封装在<code>useMouse</code>中，使组件代码更简洁易维护。</p>
<p>（3）<strong>抽象复杂副作用逻辑</strong>当逻辑涉及<code>useState</code>、<code>useEffect</code>等 Hook 的组合使用（如状态管理 + 副作用处理）时，自定义 Hook 可将其抽象为独立单元，提高可读性。上面案例中<code>useMouse</code>整合了<code>useState</code>（管理 x、y 坐标）和<code>useEffect</code>（鼠标事件监听 / 清理），将分散的逻辑聚合为可复用的单元。</p>
<h4 data-id="heading-15">2. 如何自定义 hooks？</h4>
<p>（1）<strong>遵循命名规范</strong>函数名必须以<code>use</code>开头（如<code>useMouse</code>、<code>useTodos</code>），这是 React 的强制约定，确保 React 能识别 Hook 的调用规则（如只能在组件或其他 Hook 中使用）。</p>
<p>（2）<strong>封装核心逻辑</strong>在函数内部可调用其他 Hook（如<code>useState</code>、<code>useEffect</code>），并通过<code>return</code>暴露需要的状态或方法。案例中<code>useMouse</code>的实现步骤：</p>
<ul>
<li>用<code>useState</code>定义<code>x</code>和<code>y</code>状态，存储鼠标坐标；</li>
<li>用<code>useEffect</code>绑定<code>mousemove</code>事件，实时更新坐标；</li>
<li>通过<code>return { x, y }</code>将坐标暴露给组件使用。</li>
</ul>
<p>（3）<strong>设计返回值</strong>根据需求返回状态、方法或对象，方便组件灵活使用。案例中返回包含<code>x</code>和<code>y</code>的对象，组件通过<code>const { x, y } = useMouse()</code>直接获取坐标；若逻辑复杂（如待办事项管理），可返回状态和操作方法的集合（如<code>{ todos, addTodo, deleteTodo }</code>）。</p>
<h4 data-id="heading-16">3. 自定义 hooks 有什么注意事项？</h4>
<p>（1）<strong>严格遵循 Hook 调用规则</strong></p>
<ul>
<li>只能在组件函数或其他自定义 Hook 中调用（上面案例中<code>useMouse</code>在<code>MouseMove</code>组件中调用，符合规则）；</li>
<li>不能在循环、条件判断或普通函数中调用（避免 React 无法保证 Hook 调用顺序的一致性）。</li>
</ul>
<p>（2）<strong>清理副作用，避免内存泄漏</strong>若 Hook 包含副作用（如事件监听、定时器、API 请求），必须在<code>useEffect</code>的清理函数中移除副作用。上面案例中，<code>useMouse</code>在<code>useEffect</code>的返回函数中调用<code>removeEventListener</code>，确保<code>MouseMove</code>组件卸载时（<code>count</code>为奇数时）移除鼠标监听，避免组件已卸载但事件仍触发的内存泄漏（控制台会打印 “===== 清除” 验证）。</p>
<p>（3）<strong>保持单一职责</strong>一个自定义 Hook 应专注于解决一个特定问题。上面案例中<code>useMouse</code>仅负责鼠标位置监听，职责单一；若强行加入其他逻辑（如键盘监听）会导致 Hook 臃肿，降低复用性。</p>
<h3 data-id="heading-17">四、复杂案例实战：待办事项（Todo List）应用 📝</h3>
<h4 data-id="heading-18">1. 需求分析：</h4>
<p>本案例是一个基于 React 的待办事项应用，核心需求围绕待办事项的全生命周期管理，具体包括：</p>
<ul>
<li>输入框输入待办内容，点击添加按钮创建新待办；</li>
<li>勾选复选框标记待办事项为 “已完成” 或 “未完成”；</li>
<li>点击删除按钮移除特定待办事项；</li>
<li>页面刷新后，已添加的待办数据不丢失（本地持久化）；</li>
<li>无待办事项时显示空状态提示。</li>
</ul>
<p>核心痛点：如何将数据管理逻辑与 UI 渲染逻辑分离，实现代码复用和维护性提升 —— 这正是自定义 Hook 的核心应用场景。</p>
<h4 data-id="heading-19">2. 实现架构设计：</h4>
<p>（1）<strong>整体架构</strong>采用 “UI 组件 + 自定义 Hook” 的分离模式：</p>
<ul>
<li>UI 组件：负责渲染界面和处理用户交互（输入、点击等）；</li>
<li>自定义 Hooks（<code>useTodos</code>）：封装数据状态、业务逻辑和持久化操作。</li>
</ul>
<p>（2）<strong>核心设计：自定义 hooks 的职责</strong><code>useTodos</code>作为数据和逻辑的 “中央处理器”，承担以下职责：</p>
<ul>
<li>管理待办事项的响应式状态（<code>todos</code>数组）；</li>
<li>提供操作待办的方法（添加、切换状态、删除）；</li>
<li>实现数据本地持久化（<code>localStorage</code>读写）。</li>
</ul>
<h4 data-id="heading-20">3. 代码展示（核心代码）</h4>
<h5 data-id="heading-21">（1）自定义 Hook：useTodos.js</h5>
<p>js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 封装响应式的todos业务逻辑</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 定义localStorage的键名，用于存储待办数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>;

<span class="hljs-comment">// 从localStorage加载待办数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorge</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">StoredTodos</span> = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>);
    <span class="hljs-comment">// 若有数据则解析为JSON，否则返回空数组</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">StoredTodos</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">StoredTodos</span>) : [];
}

<span class="hljs-comment">// 将待办数据保存到localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTodos</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 初始化todos状态：从localStorage加载（useState接收函数，确保只执行一次）</span>
    <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(loadFromStorge);

    <span class="hljs-comment">// 监听todos变化，实时保存到localStorage（持久化）</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">saveToStorage</span>(todos);
    }, [todos]); <span class="hljs-comment">// 依赖todos：只有todos变化时才执行</span>

    <span class="hljs-comment">// 添加待办事项</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>([
            ...todos, <span class="hljs-comment">// 复制现有待办</span>
            { 
                <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 用时间戳作为唯一ID</span>
                text, <span class="hljs-comment">// 待办内容</span>
                <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 初始状态为未完成</span>
            }
        ]);
    }

    <span class="hljs-comment">// 切换待办事项的完成状态</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>(
            todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> {
                <span class="hljs-comment">// 找到目标待办，反转completed状态</span>
                <span class="hljs-keyword">if</span> (todo.<span class="hljs-property">id</span> === id) {
                    <span class="hljs-keyword">return</span> { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> };
                }
                <span class="hljs-keyword">return</span> todo; <span class="hljs-comment">// 非目标待办不变</span>
            })
        );
    }

    <span class="hljs-comment">// 删除待办事项</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
        <span class="hljs-title function_">setTodos</span>(
            todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">id</span> !== id) <span class="hljs-comment">// 过滤掉要删除的待办</span>
        );
    }

    <span class="hljs-comment">// 暴露状态和方法给组件使用</span>
    <span class="hljs-keyword">return</span> {
        todos,
        addTodo,
        toggleTodo,
        deleteTodo,
    }
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li><code>loadFromStorge</code>和<code>saveToStorage</code>：封装<code>localStorage</code>的读写逻辑，实现数据持久化（页面刷新后数据不丢失）。</li>
<li><code>useTodos</code>内部用<code>useState</code>管理<code>todos</code>状态，初始化时从本地存储加载数据。</li>
<li>用<code>useEffect</code>监听<code>todos</code>变化，每次变化都调用<code>saveToStorage</code>保存到本地，确保数据实时同步。</li>
<li>提供<code>addTodo</code>（添加）、<code>toggleTodo</code>（切换状态）、<code>deleteTodo</code>（删除）三个方法，通过<code>setTodos</code>更新状态，遵循 “不可变数据” 原则（用扩展运算符、<code>map</code>、<code>filter</code>创建新数组）。</li>
<li>最后返回<code>todos</code>状态和操作方法，供 UI 组件使用。</li>
</ul>
<h5 data-id="heading-22">（2）UI 组件：App.jsx（主组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useTodos } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 调用自定义Hook获取待办数据和操作方法</span>
    <span class="hljs-keyword">const</span> { todos, addTodo, deleteTodo, toggleTodo } = <span class="hljs-title function_">useTodos</span>();

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {/* 输入组件：传递addTodo方法用于添加待办 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">addTodo</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
            {/* 条件渲染：有待办时显示列表，否则显示空状态 */}
            {
                todos.length &gt; 0 ?
                    <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span>
                        <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
                        <span class="hljs-attr">deleteTodo</span>=<span class="hljs-string">{deleteTodo}</span>
                        <span class="hljs-attr">toggleTodo</span>=<span class="hljs-string">{toggleTodo}</span>
                    /&gt;</span> : 
                    (<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>)
            }
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li><code>App</code>组件作为入口，通过<code>useTodos()</code>获取待办数据（<code>todos</code>）和操作方法（<code>addTodo</code>等）。</li>
<li>渲染<code>TodoInput</code>组件（负责输入待办）并传递<code>addTodo</code>方法，让输入组件能触发添加操作。</li>
<li>渲染<code>TodoList</code>组件（负责展示待办列表）并传递<code>todos</code>、<code>deleteTodo</code>、<code>toggleTodo</code>，让列表组件能展示数据和处理删除 / 切换操作。</li>
<li>通过条件渲染实现 “无待办时显示空提示” 的需求。</li>
</ul>
<h5 data-id="heading-23">（3）UI 组件：TodoInput.jsx（输入组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoInput</span>(<span class="hljs-params">{ addTodo }</span>) {
    <span class="hljs-comment">// 管理输入框文本状态（受控组件）</span>
    <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

    <span class="hljs-comment">// 输入框变化时更新text状态</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
        <span class="hljs-title function_">setText</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
    }

    <span class="hljs-comment">// 表单提交时添加待办</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
        e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止表单默认提交行为</span>
        <span class="hljs-keyword">if</span> (text.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span>) { <span class="hljs-comment">// 过滤空输入</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">addTodo</span>(text); <span class="hljs-comment">// 调用父组件传递的addTodo方法添加待办</span>
        <span class="hljs-title function_">setText</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// 清空输入框</span>
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'todo-input'</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
            {/* 受控组件：value绑定text，变化触发handleChange */}
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text'</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'submit'</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>纯 UI 组件，仅负责输入框的状态管理和提交逻辑，不关心数据如何存储或处理。</li>
<li>通过<code>useState</code>管理输入框的<code>text</code>状态，实现 “受控组件”（输入框值由 React 状态控制）。</li>
<li>表单提交时调用<code>addTodo</code>（从<code>App</code>组件传递的方法）添加待办，并清空输入框。</li>
</ul>
<h5 data-id="heading-24">（4）UI 组件：TodoList.jsx（列表组件）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TodoItem.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">{ todos, deleteTodo, toggleTodo }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
            {/* 遍历todos数组，为每个待办渲染TodoItem组件 */}
            {todos.map((todo) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> 
                 <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> // <span class="hljs-attr">唯一key</span>
                 <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span> // <span class="hljs-attr">传递单个待办数据</span>
                 <span class="hljs-attr">deleteTodo</span>=<span class="hljs-string">{deleteTodo}</span> // <span class="hljs-attr">传递删除方法</span>
                 <span class="hljs-attr">toggleTodo</span>=<span class="hljs-string">{toggleTodo}</span> // <span class="hljs-attr">传递切换状态方法</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>接收<code>todos</code>数组，通过<code>map</code>遍历渲染每个待办项（<code>TodoItem</code>）。</li>
<li>仅负责列表渲染，将单个待办的数据和操作方法传递给<code>TodoItem</code>，自身不处理业务逻辑。</li>
</ul>
<h5 data-id="heading-25">（5）UI 组件：TodoItem.jsx（单个待办项）</h5>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoItem</span>(<span class="hljs-params">{ todo, deleteTodo, toggleTodo }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-item"</span>&gt;</span>
            {/* 复选框：状态绑定todo.completed，点击触发toggleTodo */}
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
                <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(todo.id)}
            /&gt;
            {/* 待办文本：已完成时添加completed类（可用于样式区分） */}
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? '<span class="hljs-attr">completed</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
                {todo.text}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            {/* 删除按钮：点击触发deleteTodo */}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> deleteTodo(todo.id)}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
    )
}
</code></pre>
<p><strong>逻辑详解</strong>：</p>
<ul>
<li>接收单个待办数据（<code>todo</code>）和操作方法，渲染复选框、文本和删除按钮。</li>
<li>复选框状态与<code>todo.completed</code>绑定，点击时调用<code>toggleTodo</code>切换状态。</li>
<li>文本根据<code>completed</code>状态添加样式类（如划线效果），删除按钮点击时调用<code>deleteTodo</code>删除当前待办。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ecafc5f10844369f5f6d214b0f4dbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=zB6qg6oQzohfCNDDp5pyupcUres%3D" alt="QQ20260103-170824.png" loading="lazy"/></p>
<h4 data-id="heading-26">4. 效果展示：</h4>
<ul>
<li>输入框输入内容，点击 “添加” 按钮，待办列表会新增一项。</li>
<li>勾选复选框，待办文本会显示为 “已完成” 样式。</li>
<li>点击 “删除” 按钮，对应待办项会从列表中移除。</li>
<li>刷新页面后，所有待办数据依然存在（本地存储生效）。</li>
<li>当列表为空时，页面显示 “暂无待办事项”。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93a8817cc396405f9b478e994a276f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768041866&amp;x-signature=T3RIj4Slvx24PmkVxphO2UIB2Pc%3D" alt="QQ202613-1709.gif" loading="lazy"/></p>
<h4 data-id="heading-27">5. 案例总结：</h4>
<ul>
<li><strong>逻辑复用最大化</strong>：<code>useTodos</code>封装了待办事项的所有核心逻辑（状态管理、CRUD 操作、本地持久化），若其他组件（如 “待办统计组件”）需要使用待办数据，可直接调用<code>useTodos</code>，无需重复编写逻辑。</li>
<li><strong>UI 与业务彻底分离</strong>：所有 UI 组件（<code>TodoInput</code>、<code>TodoList</code>等）仅负责渲染和传递交互，不包含任何数据处理逻辑，代码结构清晰，维护成本低。</li>
<li><strong>副作用集中管理</strong>：本地存储的读写逻辑被封装在<code>useTodos</code>的<code>useEffect</code>中，避免副作用分散在多个组件中，便于统一维护。</li>
</ul>
<h3 data-id="heading-28">五、面试官会问 🤔</h3>
<ol>
<li><strong>自定义 Hook 和普通函数有什么区别？</strong> 自定义 Hook 以<code>use</code>开头，内部可以调用其他 Hook（如<code>useState</code>、<code>useEffect</code>），且必须遵循 Hook 调用规则（只能在组件或其他 Hook 中调用）；普通函数不能调用 Hook，也没有命名限制。</li>
<li><strong>为什么自定义 Hook 必须以 use 开头？</strong> 这是 React 的约定，确保 React 能通过命名识别 Hook，从而验证 Hook 的调用规则（如避免在条件语句中调用），防止出现逻辑错误。</li>
<li><strong>如何避免自定义 Hook 中的内存泄漏？</strong> 若 Hook 包含副作用（如事件监听、定时器），必须在<code>useEffect</code>的清理函数中移除副作用（如<code>removeEventListener</code>、<code>clearTimeout</code>），确保组件卸载时副作用被清除。</li>
<li><strong>自定义 Hook 如何实现状态隔离？</strong> 每个组件调用自定义 Hook 时，React 都会为其创建独立的状态实例，不同组件之间的状态互不干扰（如两个组件调用<code>useMouse</code>，会分别维护自己的<code>x</code>、<code>y</code>状态）。</li>
<li><strong>什么时候应该抽离自定义 Hook？</strong> 当多个组件需要共享相同的状态逻辑，或组件中业务逻辑过于复杂（导致 UI 与逻辑混杂）时，就应该抽离为自定义 Hook。</li>
</ol>
<h3 data-id="heading-29">六、结语 🌟</h3>
<p>自定义 Hooks 是 React 中 “逻辑复用” 的最佳实践，它让我们的代码从 “重复冗余” 走向 “简洁高效”，从 “UI 与逻辑混杂” 走向 “职责清晰分离”。</p>
<p>通过本文的两个案例（鼠标位置监听和待办事项应用），我们可以看到：一个设计良好的自定义 Hook，就像一个 “功能模块”，能让组件专注于 UI 渲染，让逻辑专注于业务处理。</p>
<p>希望大家在实际开发中多思考、多实践，将自定义 Hooks 运用到项目中，让代码更优雅、更可维护！🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该熟悉的概念(6)Fine-tuning和RAG]]></title>    <link>https://juejin.cn/post/7590452143016656934</link>    <guid>https://juejin.cn/post/7590452143016656934</guid>    <pubDate>2026-01-03T07:49:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590452143016656934" data-draft-id="7590469811409010715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该熟悉的概念(6)Fine-tuning和RAG"/> <meta itemprop="keywords" content="人工智能,架构,算法"/> <meta itemprop="datePublished" content="2026-01-03T07:49:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘立军"/> <meta itemprop="url" content="https://juejin.cn/user/2830599308981642"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该熟悉的概念(6)Fine-tuning和RAG
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2830599308981642/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘立军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T07:49:42.000Z" title="Sat Jan 03 2026 07:49:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大语言模型/LLM</strong> 通常是由海量通用知识（如语法、常识、逻辑）训练的，在面对具体场景（如医疗问诊、法律文书生成）时，能力往往不足。<br/>
<strong>Fine-tuning/微调</strong> 正是为解决这一问题而生的核心技术，其本质是在预训练模型的基础上，用特定领域 / 任务的小数据集进一步训练，让模型 <strong>适配具体需求</strong>，最终输出更精准、更贴合场景的结果。</p>

<h2 data-id="heading-0">微调（Fine-tuning）的核心定义</h2>
<p>微调的技术逻辑可拆解为两步：</p>
<ol>
<li>基础：预训练模型<br/>
模型已通过万亿级通用数据（如全网文本、书籍、论文）学习了通用语言规律（如 “猫是哺乳动物”“合同需包含当事人信息”），但对 “儿科常见病症用药”、“知识产权合同纠纷条款” 等细分领域知识掌握薄弱。</li>
<li>关键：针对性训练<br/>
用该领域的小数据集（通常几千～几万条，远少于预训练数据），以 “少量迭代更新模型参数” 的方式，让模型重点学习细分领域的知识、话术和规则。<br/>
例如用 1 万条 “医生与儿科患者对话” 数据微调模型，使其能像儿科医生一样回答家长的问诊问题。</li>
</ol>
<p>简单类比：<strong>预训练模型</strong>是 <strong>高中毕业的通用人才</strong>，<strong>微调</strong>（Fine-tuning） 是 <strong>针对医生 / 律师 / 程序员岗位的岗前培训</strong>，最终让模型成为 <strong>领域专才</strong>。</p>
<h2 data-id="heading-1">微调的优点与缺点</h2>
<p>微调的核心价值在于 <strong>让模型深度适配场景</strong>，但也受限于数据、成本和灵活性，具体优劣势如下：</p>






























<table><thead><tr><th>维度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>输出精准度</strong></td><td>能深度融合领域知识，输出结果的专业性、准确性更高（如法律微调模型能精准引用法条）。</td><td>对训练数据质量要求极高：若数据存在错误 / 偏见，微调后模型会 “固化错误”（如数据含误诊案例，模型会重复误诊）。</td></tr><tr><td><strong>响应效率</strong></td><td>微调后的模型可 “本地化部署”，无需实时调用外部数据，响应速度快（毫秒级）。</td><td>训练成本高：需专业算法工程师操作，且 GPU 算力消耗大（一次医疗模型微调可能需数万元算力成本）。</td></tr><tr><td><strong>场景适配性</strong></td><td>能适配 “无公开数据参考” 的私有场景（如企业内部客户服务话术、专属产品知识库）。</td><td>灵活性差：若场景需求变化（如医疗指南更新、法律条文修订），需重新准备数据并再次微调，周期长（通常 1~2 周）。</td></tr><tr><td><strong>数据依赖度</strong></td><td>相比预训练，仅需 “小数据集” 即可生效（适合数据稀缺的细分领域）。</td><td>存在 “灾难性遗忘” 风险：过度微调可能导致模型忘记预训练的通用知识（如仅学法律后，无法回答基础常识问题）。</td></tr></tbody></table>
<blockquote>
<p>这个世界不存在完美，尤其是工程技术：）</p>
</blockquote>
<h2 data-id="heading-2">微调与 RAG 的对比：优势与劣势</h2>
<blockquote>
<p>如果您想了解 RAG，可参见：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwfcoding.com%2Farticles%2Fpractice%2F0318%2F" target="_blank" title="http://wfcoding.com/articles/practice/0318/" ref="nofollow noopener noreferrer">用langgraph实现RAG(Retrieval Augmented Generation,检索增强生成)</a></p>
</blockquote>
<p>在实际应用中，微调常与<strong>RAG（检索增强生成，Retrieval-Augmented Generation）</strong> 相比，两者都是 “让模型适配具体场景” 的技术，但底层逻辑完全不同：</p>
<ul>
<li><strong>微调</strong>：把领域知识 “灌进模型参数里”（让模型 “记住” 知识）；</li>
<li><strong>RAG</strong>：让模型在生成答案前，先 “检索外部数据库”（让模型 “参考” 实时 / 私有知识）。</li>
</ul>
<p>两者的优劣势对比可通过下表清晰呈现：</p>








































<table><thead><tr><th>对比维度</th><th>微调（Fine-tuning）</th><th>RAG（检索增强生成）</th></tr></thead><tbody><tr><td><strong>知识更新成本</strong></td><td>高：知识变化（如法规修订、产品迭代）需重新准备数据、重新训练，周期长（1~2 周）。</td><td>低：只需更新外部数据库（如替换 Excel 表格、同步文档），无需修改模型，即时生效。</td></tr><tr><td><strong>数据要求</strong></td><td>高：需高质量、结构化的标注数据（如 “问题 + 标准答案” 对），无数据则无法启动。</td><td>低：支持非结构化数据（如 PDF、Word、聊天记录），无需标注，“扔进去就能用”，数据门槛低。</td></tr><tr><td><strong>响应速度</strong></td><td>快：知识存在模型内部，生成答案时无需外部调用，响应时间短（毫秒级）。</td><td>慢：需先检索外部数据库（依赖数据库性能），响应时间长（百毫秒～秒级）。</td></tr><tr><td><strong>私有性与安全</strong></td><td>高：可本地化部署，数据不对外传输，适合涉密场景（如军工、金融核心数据）。</td><td>中：若用第三方数据库（如云端向量库），存在数据传输风险；本地化部署可提升安全性。</td></tr><tr><td><strong>适用场景</strong></td><td>1. 知识稳定、长期不变的领域（如数学公式、经典医学理论）；2. 需极致响应速度的场景（如实时客服、工业控制）；3. 涉密 / 私有性要求高的场景。</td><td>1. 知识高频更新的领域（如新闻、电商商品、政策法规）；2. 数据非结构化、标注困难的场景（如企业历史文档、用户聊天记录）；3. 需 “溯源引用” 的场景（如学术写作、法律论证，需标注答案来源）。</td></tr><tr><td><strong>成本（长期）</strong></td><td>高：除首次训练成本，后续知识更新需持续投入算力和人力。</td><td>低：主要成本是数据库存储与维护，无重复训练成本，长期更经济。</td></tr></tbody></table>
<blockquote>
<p>在<code>RAG</code>场景中，一般的分为两步：</p>
<ol>
<li>将用户的问题矢量化并通过知识库进行语义检索，找出最贴近的答案；</li>
<li>使用大模型结合知识库的答案，推理出流畅的自然语言给出答案。</li>
</ol>
<p>如果数据量不太大，语义检索在性能好一点的CPU下运行速度也会很快，所以性能的瓶颈通常在于大模型的推理。</p>
</blockquote>
<h2 data-id="heading-3">总结：如何选择微调与 RAG？</h2>
<p>两者并非 “非此即彼”，实际应用中常结合使用（如 “微调 + RAG” 混合方案），核心选择逻辑如下：</p>
<ul>
<li>若你的场景<strong>知识稳定、数据质量高、需极致速度或强隐私</strong>（如医疗设备实时诊断、军工文档分析），优先选<strong>微调（Fine-tuning）</strong>；</li>
<li>若你的场景<strong>知识高频更新、数据零散无标注、需低成本快速落地</strong>（如电商商品问答、企业周报生成），优先选 <strong>RAG(Retrieval Augmented Generation,检索增强生成)</strong>；</li>
<li>若需 “兼顾专业度与灵活性”（如法律智能助手：既需精准法条引用，又需实时更新新规），可采用 “先用微调让模型掌握法律通用逻辑，再用 RAG 检索最新法条” 的混合方案。</li>
</ul>
<blockquote>
<p>如果对成本比较敏感，通过选择 <strong>参数小的大模型 + 知识库</strong> 的 <strong>RAG</strong> 是最优方案。</p>
</blockquote>
<hr/>
<p>🪐感谢观看，祝好运🪐</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计]]></title>    <link>https://juejin.cn/post/7590403249560797199</link>    <guid>https://juejin.cn/post/7590403249560797199</guid>    <pubDate>2026-01-03T10:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249560797199" data-draft-id="7590213554798723107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计"/> <meta itemprop="keywords" content="后端,RocketMQ,面试"/> <meta itemprop="datePublished" content="2026-01-03T10:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ 为什么读得这么快？揭秘 ConsumeQueue 的异步索引设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:15:04.000Z" title="Sat Jan 03 2026 10:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：写得快不够，还要读得快</h2>
<p><a href="https://juejin.cn/post/7589962224795713574" target="_blank" title="https://juejin.cn/post/7589962224795713574">上一篇</a>我们解决了写入问题：CommitLog顺序写，让RocketMQ写入TPS达到十万级别。</p>
<p>但写得快只是第一步。<strong>消费者怎么快速读取消息？</strong></p>
<p>设想一个场景：</p>
<ul>
<li>CommitLog有100GB数据，包含1000个Topic</li>
<li>Consumer只关心其中一个Topic（1GB数据）</li>
<li>从头扫描？读取100GB，丢弃99GB？</li>
</ul>
<p>实测数据：扫描100MB的CommitLog找2万条消息，耗时102ms。如果是100GB？那就是10万ms，即100秒。</p>
<p>完全不可行。</p>
<p><strong>RocketMQ的答案：ConsumeQueue异步索引。</strong></p>
<ul>
<li>20字节定长结构</li>
<li>查询速度提升34倍（102ms → 3ms）</li>
<li>数据量减少272倍（100MB → 0.37MB）</li>
</ul>
<p>今天拆解三个核心问题：</p>
<ol>
<li><strong>ConsumeQueue是什么？</strong> - 20字节索引如何设计</li>
<li><strong>为什么异步构建？</strong> - 写入性能如何保持</li>
<li><strong>怎么配合工作？</strong> - 读写如何分离</li>
</ol>
<h2 data-id="heading-1">一、ConsumeQueue是什么？</h2>
<h3 data-id="heading-2">1.1 核心设计</h3>
<p>ConsumeQueue是CommitLog的索引，采用<strong>定长、异步构建</strong>的设计。</p>
<p>每个Topic的每个Queue都有一个独立的ConsumeQueue文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-variable">$ROCKETMQ_HOME</span>/store/consumequeue/
├── TopicA/
│   ├── 0/                    ← Queue-0的索引
│   │   └── 00000000000000000000
│   ├── 1/                    ← Queue-1的索引
│   │   └── 00000000000000000000
└── TopicB/
    ├── 0/
    │   └── 00000000000000000000
</code></pre>
<h3 data-id="heading-3">1.2 索引条目结构</h3>
<p>每个索引条目固定20字节，包含3个字段：</p>
<pre><code class="hljs language-scss" lang="scss">+-------------------+-------------------+-------------------+
|   CommitLog偏移量  |     消息大小       |      TagsCode     |
|      (<span class="hljs-number">8</span>字节)       |     (<span class="hljs-number">4</span>字节)       |      (<span class="hljs-number">8</span>字节)      |
+-------------------+-------------------+-------------------+
</code></pre>
<p><strong>为什么是20字节？</strong></p>
<p>定长设计的好处：</p>
<ol>
<li><strong>快速定位</strong> - 第N条索引位置 = N × 20，O(1)复杂度</li>
<li><strong>空间高效</strong> - 1KB消息 → 20字节索引，压缩比51:1</li>
<li><strong>批量读取</strong> - 连续存储，PageCache友好</li>
</ol>
<h3 data-id="heading-4">1.3 读写分离的设计</h3>
<p>ConsumeQueue和CommitLog分工明确：</p>
<p><strong>CommitLog：物理存储层</strong></p>
<ul>
<li>所有消息顺序写入</li>
<li>不关心Topic和Queue</li>
<li>只管追加，写入极快</li>
</ul>
<p><strong>ConsumeQueue：逻辑索引层</strong></p>
<ul>
<li>按Topic/Queue组织</li>
<li>只存20字节索引</li>
<li>快速定位消息</li>
</ul>
<p><strong>协作方式：写入快速，读取精准</strong></p>
<h2 data-id="heading-5">二、为什么不直接扫描CommitLog？</h2>
<h3 data-id="heading-6">2.1 性能对比测试</h3>
<p>我写了一个简化版的实现，对比两种查询方式：</p>
<p><strong>测试场景：</strong></p>
<ul>
<li>消息总数：10万条，每条1KB</li>
<li>Topic数量：5个（消息随机分布）</li>
<li>查询目标：找出Topic-2的所有消息（约2万条）</li>
</ul>
<p><strong>方式A：直接扫描CommitLog</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 从头到尾扫描，逐条解析</span>
<span class="hljs-keyword">for</span> (Message msg : commitLog.scanAll()) {
    <span class="hljs-keyword">if</span> (msg.getTopic().equals(<span class="hljs-string">"Topic-2"</span>)) {
        results.add(msg);
    }
}
</code></pre>
<p><strong>方式B：通过ConsumeQueue索引</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取索引，直接定位</span>
<span class="hljs-type">ConsumeQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> getQueue(<span class="hljs-string">"Topic-2"</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">for</span> (IndexEntry entry : queue.getAll()) {
    <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> commitLog.read(entry.offset, entry.size);
    results.add(msg);
}
</code></pre>
<h3 data-id="heading-7">2.2 测试结果</h3>





























<table><thead><tr><th>指标</th><th>直接扫描</th><th>索引查询</th><th>差距</th></tr></thead><tbody><tr><td>查询耗时</td><td>102 ms</td><td>3 ms</td><td><strong>34倍</strong></td></tr><tr><td>扫描数据量</td><td>100.00 MB</td><td>0.37 MB</td><td><strong>272倍</strong></td></tr><tr><td>找到消息数</td><td>19,384条</td><td>19,384条</td><td>相同</td></tr></tbody></table>
<p><strong>为什么差距这么大？</strong></p>
<ul>
<li><strong>数据量差异</strong>：100MB vs 0.37MB，减少272倍IO</li>
<li><strong>解析开销</strong>：全部9.6万条 vs 目标1.9万条，减少5倍解析</li>
<li><strong>缓存命中</strong>：索引小全在内存，CommitLog太大命中率低</li>
</ul>
<h3 data-id="heading-8">2.3 不同消息数量下的性能</h3>



































<table><thead><tr><th>消息总数</th><th>直接扫描</th><th>索引查询</th><th>性能提升</th></tr></thead><tbody><tr><td>1万</td><td>14 ms</td><td>1 ms</td><td>14倍</td></tr><tr><td>5万</td><td>55 ms</td><td>2 ms</td><td>27.5倍</td></tr><tr><td>10万</td><td>76 ms</td><td>1 ms</td><td>76倍</td></tr><tr><td>20万</td><td>59 ms</td><td>1 ms</td><td>59倍</td></tr></tbody></table>
<p><strong>趋势分析：</strong></p>
<ul>
<li>直接扫描：耗时随消息数量线性增长</li>
<li>索引查询：耗时基本恒定（1-2ms）</li>
<li>消息越多，索引优势越明显</li>
</ul>
<p><strong>关于20万条数据的说明：</strong>
细心的读者会发现，20万条消息的扫描耗时（59ms）反而比10万条（76ms）少。这不符合线性增长的预期。</p>
<p>原因是<strong>PageCache效应</strong>：</p>
<ul>
<li>测试按1万→5万→10万→20万顺序执行</li>
<li>前面的测试让大量数据进入PageCache</li>
<li>20万测试时，很多数据已在内存中</li>
<li>磁盘IO大幅减少，耗时反而降低</li>
</ul>
<p>这个现象恰好说明：</p>
<ol>
<li>PageCache对顺序读取的优化很强</li>
<li>真实生产环境中，冷启动时性能会更差</li>
<li>索引查询因为数据量小，不受PageCache波动影响</li>
</ol>
<p><strong>结论：直接扫描CommitLog是不可行的。生产环境百万、千万级消息，扫描耗时会达到秒级甚至分钟级，完全无法接受。</strong></p>
<p><strong>两种查询方式对比：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer查询Topic-2消息] --&gt; B{选择方式}
    B --&gt;|方式A| C[扫描100MB CommitLog]
    B --&gt;|方式B| D[读取0.37MB索引]
    C --&gt; E[解析96,465条消息]
    D --&gt; F[解析19,384条消息]
    E --&gt; G[耗时102ms]
    F --&gt; H[耗时3ms]
    
    style C fill:#ffe1e1
    style D fill:#e8f5e9
    style G fill:#ffe1e1
    style H fill:#e8f5e9
</code></pre>
<h2 data-id="heading-9">三、异步构建机制</h2>
<h3 data-id="heading-10">3.1 为什么要异步？</h3>
<p>同步构建会拖累写入性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 同步构建（性能差）</span>
commitLog.append(msg);
consumeQueue.buildIndex(msg);  <span class="hljs-comment">// ← 阻塞等待</span>
<span class="hljs-keyword">return</span> success;

<span class="hljs-comment">// 异步构建（高性能）</span>
commitLog.append(msg);
<span class="hljs-keyword">return</span> success;  <span class="hljs-comment">// ← 立即返回，后台线程异步构建</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>同步构建需要等待索引完成</li>
<li>索引文件分散，写入变随机IO</li>
<li>1000个Topic = 1000个索引文件同时写，性能崩溃</li>
</ul>
<p><strong>异步优势：</strong></p>
<ul>
<li>写入立即返回，不等索引</li>
<li>后台线程统一处理，批量高效</li>
<li>写入性能100%保留</li>
</ul>
<h3 data-id="heading-11">3.2 ReputMessageService实现</h3>
<p>RocketMQ使用ReputMessageService线程异步分发消息到ConsumeQueue。</p>
<p><strong>异步构建流程：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Producer写入] --&gt; B[CommitLog]
    B -.-&gt;|立即返回| A
    C[ReputService后台线程] -.-&gt;|轮询| B
    C --&gt; D[读取新消息]
    D --&gt; E[解析消息]
    E --&gt; F[写入ConsumeQueue]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style F fill:#ffe1e1
</code></pre>
<p><strong>核心逻辑：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReputMessageService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">reputFromOffset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 已处理位置</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (running) {
            <span class="hljs-type">long</span> <span class="hljs-variable">maxOffset</span> <span class="hljs-operator">=</span> commitLog.getMaxOffset();
            
            <span class="hljs-keyword">if</span> (reputFromOffset &lt; maxOffset) {
                <span class="hljs-comment">// 解析消息并分发到ConsumeQueue</span>
                <span class="hljs-type">DispatchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> parseMessage(reputFromOffset);
                doDispatch(request);
                reputFromOffset += request.getMsgSize();
            } <span class="hljs-keyword">else</span> {
                Thread.sleep(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 无新消息，休眠1ms</span>
            }
        }
    }
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li>轮询间隔：1ms</li>
<li>每次处理：1条消息</li>
<li>延迟窗口：&lt;10ms</li>
</ul>
<h3 data-id="heading-12">3.3 延迟窗口验证</h3>
<p>写入1000条消息的过程中：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">写入期间（保持20-50条延迟）：</span>
  <span class="hljs-attr">CommitLog:</span>    <span class="hljs-number">200</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████</span>
  <span class="hljs-attr">ConsumeQueue:</span> <span class="hljs-number">180</span><span class="hljs-string">条</span> <span class="hljs-string">██████████████████</span>
  <span class="hljs-string">延迟:</span> <span class="hljs-number">20</span><span class="hljs-string">条</span> <span class="hljs-string">(~20ms)</span>

<span class="hljs-string">写入停止后10ms（完全追上）：</span>
  <span class="hljs-attr">CommitLog:</span>    <span class="hljs-number">1000</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████████████████████████</span>
  <span class="hljs-attr">ConsumeQueue:</span> <span class="hljs-number">1000</span><span class="hljs-string">条</span> <span class="hljs-string">████████████████████████████████████████</span>
  <span class="hljs-string">延迟:</span> <span class="hljs-number">0</span><span class="hljs-string">条</span>
</code></pre>
<p><strong>延迟特点：</strong></p>
<ul>
<li>写入期间保持小幅延迟（20-50条消息）</li>
<li>停止写入后10ms内完全追上</li>
<li>对消费者影响可忽略（消费者本身异步）</li>
</ul>
<h2 data-id="heading-13">四、设计权衡</h2>
<h3 data-id="heading-14">4.1 三种方案对比</h3>





































<table><thead><tr><th>方案</th><th>写入性能</th><th>读取性能</th><th>复杂度</th><th>一致性</th><th>适用场景</th></tr></thead><tbody><tr><td>直接扫描CommitLog</td><td>高</td><td>极低</td><td>简单</td><td>强一致</td><td>不适用</td></tr><tr><td>同步构建ConsumeQueue</td><td>低</td><td>高</td><td>中等</td><td>强一致</td><td>小规模</td></tr><tr><td>异步构建ConsumeQueue</td><td>高</td><td>高</td><td>较高</td><td>最终一致</td><td>大规模生产</td></tr></tbody></table>
<p><strong>为什么选择异步构建？</strong></p>
<p>核心权衡：</p>
<ul>
<li>写入性能100%保留（不等索引）</li>
<li>查询性能34倍提升（通过索引）</li>
<li>延迟&lt;10ms可接受（消费者本身异步）</li>
</ul>
<p><strong>一致性问题：</strong></p>
<p>Consumer不会读到不一致数据，因为：</p>
<ol>
<li>Consumer定期拉取（默认每秒1次），感知不到10ms延迟</li>
<li>Offset管理保证不漏消息，只是新消息晚几毫秒可见</li>
<li>Broker重启后ReputService从断点继续构建</li>
</ol>
<p>最坏情况：宕机瞬间丢失&lt;1ms的索引，重启后重建，对消费者透明。</p>
<h2 data-id="heading-15">五、CommitLog与ConsumeQueue的协作</h2>
<h3 data-id="heading-16">5.1 完整的消息流转</h3>
<p><strong>写入路径（Producer → Broker）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Producer] --&gt;|1.发送消息| B[CommitLog]
    B --&gt;|2.立即返回| A
    B -.-&gt;|3.异步通知| C[ReputService]
    C --&gt;|4.构建索引| D[ConsumeQueue]
    
    style B fill:#e1f5ff
    style C fill:#fff4e1
    style D fill:#ffe1e1
</code></pre>
<ol>
<li>Producer发送消息到Broker</li>
<li>Broker写入CommitLog（顺序追加）</li>
<li>返回成功给Producer</li>
<li>ReputService异步读取CommitLog</li>
<li>构建ConsumeQueue索引</li>
</ol>
<p><strong>读取路径（Consumer → Broker）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer] --&gt;|1.请求消息| B[ConsumeQueue]
    B --&gt;|2.返回offset| A
    A --&gt;|3.读取消息| C[CommitLog]
    C --&gt;|4.返回数据| A
    
    style B fill:#ffe1e1
    style C fill:#e1f5ff
</code></pre>
<ol>
<li>Consumer向Broker请求消息</li>
<li>Broker查询ConsumeQueue索引</li>
<li>获得消息在CommitLog的offset和size</li>
<li>从CommitLog读取完整消息</li>
<li>返回给Consumer</li>
</ol>
<h3 data-id="heading-17">5.2 设计思想</h3>
<p><strong>CommitLog（写入侧）：</strong></p>
<ul>
<li>顺序写，充分利用磁盘性能</li>
<li>不关心Topic和Queue</li>
<li>只管追加，简单高效</li>
</ul>
<p><strong>ConsumeQueue（读取侧）：</strong></p>
<ul>
<li>按Topic/Queue组织</li>
<li>定长索引，快速定位</li>
<li>只读关心的消息</li>
</ul>
<p>核心：<strong>读写分离，各自优化到极致。</strong></p>
<h3 data-id="heading-18">5.3 文件布局</h3>
<pre><code class="hljs language-perl" lang="perl">store/
├── commitlog/
│   ├── <span class="hljs-number">00000000000000000000</span>           <span class="hljs-comment"># 1GB</span>
│   └── <span class="hljs-number">00000001073741</span>824              <span class="hljs-comment"># 1GB</span>
│
├── consumequeue/
│   ├── TopicA/
│   │   ├── <span class="hljs-number">0</span>/<span class="hljs-number">00000000000000000000</span>    <span class="hljs-comment"># 5.7MB (30万条)</span>
│   │   └── <span class="hljs-number">1</span>/<span class="hljs-number">00000000000000000000</span>
│   └── TopicB/
│       ├── <span class="hljs-number">0</span>/<span class="hljs-number">00000000000000000000</span>
│       └── <span class="hljs-number">1</span>/<span class="hljs-number">00000000000000000000</span>
│
└── <span class="hljs-keyword">index</span>/                             <span class="hljs-comment"># 按Key查询（可选）</span>
    └── <span class="hljs-number">20250103120000000</span>
</code></pre>
<p><strong>空间占用（10万条消息）：</strong></p>
<ul>
<li>CommitLog：100 MB（完整消息）</li>
<li>ConsumeQueue：1.9 MB（索引）</li>
<li>索引开销：仅1.9%</li>
</ul>
<h2 data-id="heading-19">六、升华：主数据 + 异步索引模式</h2>
<p>ConsumeQueue的设计，本质是<strong>主数据 + 异步索引</strong>模式。</p>
<h3 data-id="heading-20">6.1 核心模式</h3>
<pre><code class="hljs">主数据层（写优化） → 异步构建 → 索引层（读优化）
</code></pre>
<p><strong>设计原则：</strong></p>
<ol>
<li>主数据优先写入 - 保证不丢</li>
<li>索引异步构建 - 不阻塞</li>
<li>读取走索引 - 快速定位</li>
<li>最终一致 - 可接受延迟</li>
</ol>
<h3 data-id="heading-21">6.2 典型应用</h3>
<p><strong>MySQL的二级索引：</strong></p>
<ul>
<li>主键索引 = CommitLog（数据存储）</li>
<li>二级索引 = ConsumeQueue（查询加速）</li>
<li>Change Buffer异步合并索引</li>
</ul>
<p><strong>Elasticsearch的倒排索引：</strong></p>
<ul>
<li>_source字段 = 原始文档（CommitLog）</li>
<li>倒排索引 = 查询索引（ConsumeQueue）</li>
<li>refresh间隔控制延迟（默认1秒）</li>
</ul>
<p><strong>数据仓库的物化视图：</strong></p>
<ul>
<li>明细表 = 原始数据</li>
<li>聚合表 = 查询视图</li>
<li>定时任务计算更新</li>
</ul>
<h3 data-id="heading-22">6.3 适用条件</h3>
<p><strong>适合：</strong></p>
<ul>
<li>写多读少，查询必须快</li>
<li>可容忍秒级延迟</li>
<li>索引构建代价高</li>
</ul>
<p><strong>不适合：</strong></p>
<ul>
<li>强一致性要求</li>
<li>查询简单（全表扫描也能接受）</li>
</ul>
<h2 data-id="heading-23">总结</h2>
<p>ConsumeQueue用20字节定长索引 + 异步构建，解决了CommitLog的读取问题。</p>
<p><strong>核心数据：</strong></p>
<ul>
<li>查询速度：提升34倍（102ms → 3ms）</li>
<li>数据量：减少272倍（100MB → 0.37MB）</li>
<li>异步延迟：&lt;10ms，对消费者透明</li>
</ul>
<p><strong>设计精髓：</strong></p>
<ul>
<li>定长索引：offset(8) + size(4) + tagsCode(8) = 20字节</li>
<li>异步构建：写入不等待，后台ReputService轮询处理</li>
<li>读写分离：CommitLog写入极致，ConsumeQueue查询极致</li>
</ul>
<p><strong>通用模式：</strong></p>
<p>主数据 + 异步索引 = 写快 + 读快 + 最终一致</p>
<p>这个模式在MySQL二级索引、ES倒排索引、数据仓库物化视图中都能看到。</p>
<p>核心是：<strong>用可接受的延迟，换取读写性能的极致。</strong></p>
<p>下一篇：刷盘策略 —— SYNC_FLUSH和ASYNC_FLUSH到底差多少性能？</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2F" target="_blank" title="https://rocketmq.apache.org/" ref="nofollow noopener noreferrer">RocketMQ官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Frocketmq%2Fblob%2Fmaster%2Fdocs%2Fcn%2Fdesign.md" target="_blank" title="https://github.com/apache/rocketmq/blob/master/docs/cn/design.md" ref="nofollow noopener noreferrer">RocketMQ Design</a></li>
<li>《RocketMQ技术内幕》第三章 - 消息存储</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Turborepo 的 Docker 化实战]]></title>    <link>https://juejin.cn/post/7590292192989151272</link>    <guid>https://juejin.cn/post/7590292192989151272</guid>    <pubDate>2026-01-03T10:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192989151272" data-draft-id="7590403249560780815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Turborepo 的 Docker 化实战"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-03T10:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无声2017"/> <meta itemprop="url" content="https://juejin.cn/user/1618116899507735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Turborepo 的 Docker 化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1618116899507735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无声2017
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:14:35.000Z" title="Sat Jan 03 2026 10:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>从 2025-07 开始，我开始在 Vue 项目中使用 Docker + Workflow 的方式进行打包部署，在此简单列举几个好处，例如：</p>
<ul>
<li>开发、测试、生产环境完全一致，Docker 镜像封装了 OS、Node.js 版本、依赖、构建工具等，避免因环境差异导致的构建失败或运行时错误。</li>
<li>节省人力，无需手动登录服务器执行命令。</li>
<li>每次部署对应一个带 tag 的 Docker 镜像，出现问题时，一键回滚到上一个镜像版本，无需重新构建。</li>
</ul>
<p>本文将先简单回顾传统 Vue 项目 Docker 打包部署的方式与 Turborepo 的项目结构。说明如何在 Turborepo 架构的项目中通过 Docker 打包部署 Vue 项目。</p>
<h2 data-id="heading-1">Vue 项目 Docker 打包部署</h2>
<p>分为 Node 镜像构建以及 Nginx 部署两个阶段，Dockerfile 内容如下：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 第一阶段：node镜像打包
FROM node:latest AS frontend-builder
WORKDIR /build-app
COPY . .
RUN npm install
RUN npm run build

# 第二阶段：nginx打包
FROM nginx:latest
EXPOSE 80
WORKDIR /app
# 替换nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf
# 将第一阶段的静态文件复制到nginx中
RUN rm -rf /usr/share/nginx/html
RUN mkdir /usr/share/nginx/html
COPY --from=frontend-builder /build-app/dist /usr/share/nginx/html

# 运行
CMD ["nginx", "-g", "daemon off;"]
</code></pre>
<p><code>nginx.conf</code> 是在项目根目录下的自定义 Nginx 配置文件，详情可见<code>个人相关配置</code>。</p>
<h2 data-id="heading-2">Turborepo 项目结构回顾</h2>
<p>Turborepo 本身不是构建工具，而是一个高性能的 Monorepo 任务编排器。它依赖底层包管理器（如 pnpm、yarn）来管理依赖，通过智能缓存和并行执行加速构建、测试等任务。</p>
<p>一个典型的 Turborepo + pnpm 项目结构如下：</p>
<pre><code class="hljs language-tex" lang="tex">my-turborepo/
├── apps/
│   ├── app1/               # 前端应用（如 Vue/React）
│   │   ├── src/
│   │   ├── public/
│   │   ├── package.json   ← name: "app1"
│   │   └── vite.config.ts
│   └── app2/
│       ├── ...
│       └── package.json   ← name: "app2"
├── packages/              # ← 缺失则 workspace 依赖安装失败
│   ├── ui/                # 共享 UI 组件库
│   │   └── package.json   ← name: "@my/ui"
│   └── utils/             # 工具函数
│       └── package.json   ← name: "@my/utils"
├── package.json           # 根工作区配置 + turbo 脚本
├── pnpm-workspace.yaml    # ← 缺失则 turbo 找不到 app1
├── turbo.json             # Turborepo 任务流水线配置
└── .npmrc                 # pnpm 配置（含 hoist 等）
</code></pre>
<p>Turborepo 的核心特点与 Docker 相关性如下：</p>






























<table><thead><tr><th>特性</th><th>说明</th><th>对 Docker 的影响 ❗</th></tr></thead><tbody><tr><td><strong>Workspace 结构</strong></td><td>所有子项目（apps/packages）通过 <code>pnpm-workspace.yaml</code> 被识别为 workspace 包</td><td>Docker 构建时必须复制该文件，否则 pnpm 无法识别子包</td></tr><tr><td><strong>依赖链接（Linking）</strong></td><td>子项目间通过 <code>workspace:*</code> 协议引用（如 <code>"@my/ui": "workspace:*"</code>），实际是符号链接</td><td>不能只复制单个 app 目录，必须复制整个 <code>apps/</code> 和 <code>packages/</code></td></tr><tr><td><strong>根目录统一安装</strong></td><td>所有依赖在根目录通过 <code>pnpm install</code> 安装，<code>node_modules</code> 位于根目录</td><td>构建命令必须在根目录执行，不能进入 <code>apps/web</code> 后再 <code>pnpm install</code></td></tr><tr><td><strong>Turbo 任务驱动</strong></td><td>通过 <code>turbo run build</code> 并指定 <code>--filter=app1</code> 来构建特定应用</td><td>需确保 <code>turbo.json</code> 和子项目的 <code>name</code> 正确，否则 filter 失败</td></tr></tbody></table>
<h2 data-id="heading-3">编写 Turborepo 中的 Dockerfile</h2>
<p>首先展示我最终的 <code>Dockerfile.dev</code>（prod、test 中会使用到公司的镜像源），代码如下：</p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 第一阶段：构建
FROM node:22-alpine AS frontend-builder

WORKDIR /build-app

# 启用 pnpm（通过 Corepack）
ENV COREPACK_NPM_REGISTRY=https://registry.npmmirror.com
RUN corepack enable
RUN echo "Corepack registry: $COREPACK_NPM_REGISTRY" &amp;&amp; \
    corepack prepare pnpm@10.24.0 --activate

# 复制所有配置文件
COPY .npmrc ./
COPY pnpm-workspace.yaml ./
COPY turbo.json ./
COPY package.json pnpm-lock.yaml ./
COPY apps/ apps/
COPY packages/ packages/

# 安装所有依赖（含 devDependencies）
RUN pnpm install

# 构建 icic（在原始位置）
RUN pnpm turbo build --filter icic -- --mode production

# 第二阶段：Nginx
FROM nginx:alpine
EXPOSE 80
COPY apps/icic/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=frontend-builder /build-app/apps/icic/dist /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
</code></pre>
<p>两者的核心差异对比如下：</p>








































<table><thead><tr><th>维度</th><th>普通 Vue 项目</th><th>Turborepo（Monorepo）</th></tr></thead><tbody><tr><td><strong>项目结构</strong></td><td>单一目录，<code>package.json</code> 在根目录</td><td>多包结构，Vue 项目在 <code>apps/xxx/</code>，根目录是 workspace</td></tr><tr><td><strong>依赖安装位置</strong></td><td>直接在项目根目录 <code>npm install</code> / <code>pnpm install</code></td><td>必须在 <strong>workspace 根目录</strong> 安装所有依赖</td></tr><tr><td><strong>构建命令</strong></td><td><code>npm run build</code> 或 <code>vite build</code></td><td>必须用 <code>turbo run build --filter=xxx</code>（或进入子目录构建）</td></tr><tr><td><strong>关键配置文件</strong></td><td>只需 <code>package.json</code>、<code>vite.config.js</code> 等</td><td>还需： • <code>pnpm-workspace.yaml</code> • <code>turbo.json</code> • 根目录 <code>.npmrc</code></td></tr><tr><td><strong>Dockerfile COPY 范围</strong></td><td>只需复制当前项目文件</td><td>必须复制： • 整个 <code>apps/</code> • 整个 <code>packages/</code> • 所有根配置文件</td></tr><tr><td><strong>node_modules 位置</strong></td><td>在项目根目录</td><td>在 workspace 根目录，子项目通过链接使用</td></tr></tbody></table>
<h2 data-id="heading-4">总结</h2>
<p><strong>普通 Vue 项目只关注自身；Turborepo 项目需要关注整个 workspace。</strong> Docker 构建时，必须还原完整的 workspace 上下文，否则依赖解析会断裂。</p>
<h2 data-id="heading-5">其他</h2>
<h3 data-id="heading-6">常见错误排查</h3>






























<table><thead><tr><th>错误现象</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>pnpm: not found</code></td><td>未运行 <code>corepack enable</code></td><td>添加 <code>RUN corepack enable</code></td></tr><tr><td><code>No package found 'app1'</code></td><td>缺少 <code>pnpm-workspace.yaml</code></td><td>确保 <code>COPY pnpm-workspace.yaml ./</code></td></tr><tr><td><code>Cannot resolve @my/utils</code></td><td>未复制 <code>packages/</code></td><td>添加 <code>COPY packages/ packages/</code></td></tr><tr><td>构建成功但页面空白</td><td>Nginx 未配置 <code>try_files</code></td><td>检查 <code>nginx.conf</code> 是否包含 <code>try_files $uri $uri/ /index.html;</code></td></tr></tbody></table>
<h3 data-id="heading-7">个人相关配置</h3>
<p><code>nginx.conf</code></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen       80;
    listen  [::]:80;
    server_name  localhost;

    access_log  /var/log/nginx/host.access.log  main;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;

        # 新增下面这句，其他是默认nginx配置
        # 解决部分前端框架的路由问题，在浏览器刷新报错404
        try_files $uri $uri/ /index.html;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

</code></pre>
<p><code>pnpm-workspace</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">packages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"apps/*"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"packages/*"</span>
</code></pre>
<p><code>.npmrc</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># China mirror of npm</span>
<span class="hljs-attr">registry</span> = https://registry.npmmirror.com

<span class="hljs-comment"># 安装依赖时锁定版本号</span>
<span class="hljs-attr">save-exact</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># 启用 hoist，让 bin 文件提升到根目录</span>
<span class="hljs-attr">shamefully-hoist</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">hoist</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">public-hoist-pattern</span>=*
</code></pre>
<h2 data-id="heading-8">参考</h2>
<ul>
<li><a href="https://juejin.cn/post/7302268383316213787" target="_blank" title="https://juejin.cn/post/7302268383316213787">前端项目容器化(Docker)打包部署 - 掘金</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fturbo.build%2Frepo%2Fdocs%2Fcrafting-your-repository%2Fmanaging-dependencies%23best-practices-for-dependency-installation" target="_blank" title="https://turbo.build/repo/docs/crafting-your-repository/managing-dependencies#best-practices-for-dependency-installation" ref="nofollow noopener noreferrer">Best practices for dependency installation - Turborepo</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结：再次选择、沪漂、第一次演讲、相亲无果]]></title>    <link>https://juejin.cn/post/7590309337861046313</link>    <guid>https://juejin.cn/post/7590309337861046313</guid>    <pubDate>2026-01-03T10:24:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861046313" data-draft-id="7590421489997905939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结：再次选择、沪漂、第一次演讲、相亲无果"/> <meta itemprop="keywords" content="后端,GitHub,程序员"/> <meta itemprop="datePublished" content="2026-01-03T10:24:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卷福同学"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291098686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结：再次选择、沪漂、第一次演讲、相亲无果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291098686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卷福同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T10:24:34.000Z" title="Sat Jan 03 2026 10:24:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>选择大于努力</p>
</blockquote>
<p>友友们，我是卷福同学，上次写2024年终总结的时候还在武汉，谁能想到一年之后会在上海写2025的年终总结。今年下半年经历的事情比较多，总结来说就是，人生经历又丰富了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d4b9f9591204760a981657d4ec02993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=1Ku9jUlS5bTfj9kFxMm%2BOmMxnXA%3D" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-0">1.再次选择</h2>
<blockquote>
<p>去一线大城市闯荡人生还是留在武汉岁月静好呢？</p>
</blockquote>
<h3 data-id="heading-1">1月</h3>
<p>1月时候还在武汉国企里呢，彼时因为项目变少了，武汉人员要重新分配，没分到项目组的人要进资源池等候下一步安排。而我这个小组之前武汉是有2个人的，北京1个项目经理，给我分配了半个人的工时，另一个人直接让去资源池。关于这个项目经理，去年也写过吐槽的帖子。这个人在武汉的名声非常不好，就完全是对待牛马一样对待底下干活的人。</p>
<p>我想着以后的日子可能过得更难受，还不如直接进资源池算了。于是就和他说了，他倒也爽快，想着再从武汉随便捞个人进来呗，反正还有很多人没安排项目组的。没想到的是，他接连找了两个人，但是因为武汉的人都听说过他的名号，都表示不想去他的项目组。最后，他把项目给外包人员做了。武汉的人，宁愿待池子里，也不想跟着他干。。。</p>
<p>这让我想起以前上小学的时候，以前农村小学的老师，打学生都很厉害的。而打的原因不仅仅是因为调皮捣蛋，我那个班教数学的老师，就是其中打人最厉害的。上课的讲台两边会有两个座位嘛，每次她讲课的时候，都会从这两个座位的学生手里拿课后作业讲，要是讲的时候发现写错了，直接冲过去打头，提耳朵等等。有一次因为班上写错作业的人太多了，直接一节课没上，轮流上去扎马步。而我呢，又恰巧有一学期是坐在讲台旁边的座位，于是这学期每逢她的课必挨打，打到后面，居然在课上说，卷福坐在这，已经被我打肿了，你们再敢做错题试试。到第二学期开学的时候，大家选座位直接把前面两个位置空着了，有两个人宁愿在后面站着也不坐那位置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b5f332d13c4859972db360a8ca3b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=r6ZLKEctA2tjKGPgp1e%2FHQfXnS0%3D" alt="插图.png" loading="lazy"/></p>
<p>我感觉是不是历史又一次重演了呢？</p>
<p>现在回头看，当时没继续跟着他的选择是对的。在武汉，也没有岁月静好啊。</p>
<h3 data-id="heading-2">再次选择</h3>
<p>虽然5月份的时候拿了上海的offer，但是等真的要走的时候，还是会纠结的。就和刚毕业的时候去北京一样，一切都要重头开始了。走的那天，出租屋里只有个保洁阿姨在打扫卫生，就和我刚回武汉的时候一样。不同的是，上次阿姨说的是房子很快就打扫好了，这次说的是，祝老板以后去上海了发大财啊</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2be2b17b617a4bb7a3faf3d2c9074c04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=AOdkmQYk4RxmTMzV6cRsZNc40Q8%3D" alt="2.jpg" loading="lazy"/></p>
<h2 data-id="heading-3">2.沪漂</h2>
<h3 data-id="heading-4">探索新事物</h3>
<p>上海就是机会多啊，休息日都会出去逛逛，探索些新事物。想想来上海之后，去周边城市参加徒步、参加ChinaJoy漫展、看了开心麻花的话剧《疯狂理发店》、还有市区内的一些公园、大学、图书馆、动物园、演唱活动等等，生活非常丰富多彩。</p>
<ul>
<li>徒步活动在小红书上找个团报就行，很多都是一天游，一半时间都在路上</li>
<li>漫展里的coser都美如画，非常适合集邮</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3860a27a7254d9d9109944c11b9a04f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=X1639NmL2uou67k%2FLBD2Ebgqt9A%3D" alt="3_1.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/860e0dd37239494197cbc0ccc91efd8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=EI4%2BiQXCxngICiO4iwGvDPbpVa4%3D" alt="3.jpg" loading="lazy"/></p>
<h2 data-id="heading-5">3.第一次演讲</h2>
<h3 data-id="heading-6">3月</h3>
<p>今年参加的线下活动还比较多呢，3月份的时候受腾讯云社区的邀请去杭州参加线下的技术训练营活动，主要也是想趁机会多认识些大佬，说不定大佬招人，有内推机会。倒也认识了不少人，喵喵、小智，还有社区的泽敏姐。晚上一起吃饭交流的时候，泽敏姐说下次有机会让我上去演讲。当时只以为是说说而已，毕竟社区里大佬太多了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f3329c59cd4e3f90242d1e4a327bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=tYs1ISPbWqnPjBzxrY7nWPLpjYs%3D" alt="4.jpg" loading="lazy"/></p>
<h3 data-id="heading-7">9月</h3>
<p>9月份的时候收到社区的邀请，去深圳参加腾讯全球数字生态大会，作为讲师上去做分享。我是非常想去的，这样就能达成从学生到老师角色转变的目标，输入变输出。比较纠结的是分享什么内容比较好呢，想了一晚上，最后觉得分享自己用AI两年的经历、沉淀的一些使用心得体、还有变现方式会比较好。</p>
<p>现场的分享也是比较顺利，讲完下来的时候和小智老师沟通上台演讲体验，小智说我讲的非常干货，讲的很稳，刚才他自己讲的时候非常紧张，腿都在抖。我说，我也是啊，腿都在打颤，反而看你讲一点也不慌的样子。。。</p>
<p>第二天又和喵喵一起去腾讯数码大厦找泽敏姐，非常感谢泽敏姐的邀请，第一次到腾讯的大楼参观。期间见识到了超豪华的二次元工位，满墙的手办，非常震惊。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aea58b73cdb64e668e524f847b7e1eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=DTnnUTPaDcRhBSOhLgpWMCJPdKc%3D" alt="5.jpg" loading="lazy"/></p>
<h2 data-id="heading-8">4.AI探索</h2>
<p>选择适合自己的方向比较重要，2024年投入了很多时间在AI视频、绘画上，虽然也有涨粉嘛，但是变现不行，一年下来也就三位数的收益。今年主要在写作还有AI编程方向投入，因为换工作的原因，其实投入精力没去年那么多。反而收益还更多了，有四位数的收益。也产出了百万阅读的文章和10w+播放量的视频</p>
<p>出爆款的诀窍就是追热点，这是普通人出爆款最容易的方式了。比如年初的Deepseek，国庆期间的sora2，趁着刚出来热度最高的时候，随便写点东西或者做个视频，流量都非常好的。那像现在再去写Deepseek，流量肯定不如之前了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b85c581680094c2ca0e1ca5089a4c222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=fIRfY%2B6x9CKUlm5hMv6rTnUrC5g%3D" alt="6.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb43c628f8c453595d6e1f307ae8e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=lqSh8rJGUVgPnpdaTBi5sBUB5a4%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-9">11月</h3>
<p>11月看到小智老师发的华为鸿蒙线下编程活动的信息，拉着在上海的一个前同事一起去参加玩玩，前同事是我在北京阿里工作时同组的，后来来了上海后，我居然在一个公交站碰到他了，也是十分震惊，居然在上海遇到曾在北京的前同事。鸿蒙的编程活动都是基础的操作，正好也买了Codebuddy的会员，用AI编程轻松解决了，拿到个小礼品</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b13a9495b7542348ccb215b9aff7507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=jb9UrnNikT2CW8y7DmuocBmDi%2FQ%3D" alt="8.jpg" loading="lazy"/></p>
<h3 data-id="heading-10">12月</h3>
<p>年底了，AI破局俱乐部在深圳举办行动家大会，我看分享嘉宾和内容挺干货的，也报名跑去深圳参加了，到现场才发现，高手云集，天下英雄如过江之鲫。我把这次参会了解的东西整理了下：</p>
<ul>
<li>
<p>AIPPT.com ：赵充老师以肯德基为例分享做产品不要做全家桶，用户只想要个甜筒（不要做大而全的产品，而是在垂直领域找到需求，在单点，堵上一切）</p>
</li>
<li>
<p>AI编程出海：老外付费意愿更强，大公司不愿意做的垂直小市场，才是个人最大的机会。remove.bg网站仅有去除背景这一项功能，流量却非常高</p>
</li>
<li>
<p>搜索流量比推荐流量更值钱：用户主动搜的，说明有明确需求。而平台推的，用户只是随便看看。获取搜索流量的方法：研究用户搜索的关键词，围绕关键词输出内容，时间久了，用户搜索这个关键词，自然就找到你了</p>
</li>
</ul>
<p>活动分享的内容挺多的啊，这里就不继续写了。</p>
<p>同样的听课，结果可能完全不同，会场的1000人，参加完会回去后，可能大部分人就是感慨一下，然后继续原来的生活</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe6186ae197474ea445c4f433376e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=aop67PVesi1FzhUKctc1rJhi60s%3D" alt="9.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd7d0e18fa7648e892747043f3cb538c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=l8KeqHH2idwkR7HW%2BcEAkvkpD4U%3D" alt="10.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8cff48febf7483cb76fae6ecc532660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2356aP5ZCM5a2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768040674&amp;x-signature=sI5JR9WEmGfYodGKCwwfQQ964%2BY%3D" alt="11.jpg" loading="lazy"/></p>
<h2 data-id="heading-11">5.相亲</h2>
<p>离开武汉前，和大学同学聚餐，聊了下发现同学要准备去女方家提亲了，问对象是从哪里找的，说了个相亲软件。不过也很难，同学相亲了十几个女生，才和现在这个走到谈结婚这一步。知道了相亲软件（青藤）后，我来上海也开始了相亲之旅，到目前为止，还没有一个相上的，简单说下相亲的几个女生吧：</p>
<ul>
<li>91年，初中老师。其实是在武汉相亲的，家里给介绍的。感觉年龄差的太大了，差不多5岁了，不过因为是家里介绍的，还是得见上一面。3月的时候，武大樱花还开着，便想去武大里逛逛聊聊。让她把身份证号发我，用校友通道预约。然后犹犹豫豫半天没有发我，说是个人隐私等等之类的，要自己预约。结果没约上，想再用校友通道时已经约满了，无奈只好约着去学校旁边一家冷锅鱼店吃饭好了，计划约的12点见面，我预估12点半应该能吃上饭（不知道为什么，武汉相亲的女生都迟到），没想到她直到1点多才到，迟到1个多小时，期间也就各种尬聊，回去后两人都没再发消息了，凉凉</li>
<li>93年，上海公务员。家里的亲戚介绍的，是我相亲过的最优秀的女生了。以前的高考文科状元，武大校友，长得像袁咏仪，聊天说话情商也很高。接触了一个月吧，期间也一起吃过饭，看过话剧。最后一次见面聊天说起她前男友，海归，年入百万，金融行业。长相没说啊，应该也不差，妥妥高富帅。我一听这条件，心里顿时凉凉，差距太大了。问起为什么分了呢，说是男的虽然有钱，但是不给女的花，什么事都要AA。就是网上那种观念：钱是给女人看的，不是给女人花的。这次聊完之后就结束了，又凉凉。</li>
<li>95年，幼师。在上海相亲的，青藤上找的，见面后感觉非常漂亮啊。不过性格比较强势，刚开始聊的还是开心的话题，突然画风一转，她就开始吐槽模式，吐槽支教的山里小学的领导等等，后半段全是听她吐槽，没再聊相亲的话题了。回去后又聊了几周，但是幼师可能时间太紧，也可能她同时聊的人太多，后面想再约见面就没时间了，于是凉凉</li>
<li>97年，互联网数据分析师。来上海后相亲的第一个女生，也是非常漂亮，加上好友，看了我动态后，说非常崇拜技术大佬（多写博客还是有好处的嘛），想请我吃饭。于是爽快赴约，期间聊分布式、高并发等等，最后吃完饭结束的时候，说感觉身高不够</li>
<li>00年，主业机械设计，副业自媒体。遇到同行了，聊天话题特别多，情绪价值拉满。约线下去CJ漫展玩，让她把身份证号发我来买票，本来还想着怎么解释说明的，下一秒就把身份证号和手机号发来了，没有任何犹豫。约好了早上9点半去会展中心，没想到她早早到我这边来等我一起过去，连零食和水都买好了。遂开心前往，妹子是第一次逛漫展，逛的非常开心。只不过回去后还是说了性格不合，只好当朋友了。后续还是保持联系，偶尔见面</li>
</ul>
<p>这里列出不同年龄段的相亲女生，其他还有一些都是软件上匹配了没说话，或者说两句话就不继续聊了的。给兄弟们做个负面教材的参考啊，今年的相亲就到此为止，明年再说吧。。。</p>
<h2 data-id="heading-12">6.2026目标</h2>
<p>最后不都得展望下未来吗，2026年你们又给自己制定了哪些目标和规划呢，我给自己定下的目标，希望明年都能做到</p>
<ul>
<li>神山转山</li>
<li>樱花巡礼</li>
<li>新手上路</li>
<li>恰老外米</li>
</ul>
<p>最后，感兴趣的朋友可以关注我的公众号:<strong>卷福同学</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis日志模块详解]]></title>    <link>https://juejin.cn/post/7590452143016771622</link>    <guid>https://juejin.cn/post/7590452143016771622</guid>    <pubDate>2026-01-03T09:08:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590452143016771622" data-draft-id="7590503651115958322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis日志模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-03T09:08:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis日志模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:08:19.000Z" title="Sat Jan 03 2026 09:08:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作为持久层框架的佼佼者，MyBatis的日志模块为SQL调试、性能优化提供了强大支持。本文将带你深入理解其设计精髓与实战技巧。</p>
</blockquote>
<h2 data-id="heading-0">一、整体架构：日志模块的战略位置</h2>
<p>在深入探讨之前，让我们先从宏观视角理解MyBatis的分层架构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6e674c197024d6f9435d89e6f9c2228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=9V53VHuzn71eO1CV%2BkAYk9Oe8bY%3D" alt="" loading="lazy"/></p>
<p>从架构图可以看出，日志模块位于<strong>基础支撑层</strong>，它就像一个忠实的记录员，默默记录着系统运行的每一个关键时刻。</p>
<h2 data-id="heading-1">日志模块的六大核心职责</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 记录SQL执行日志 - 完整捕获执行的SQL语句
<span class="hljs-bullet">2.</span> 记录参数日志 - 追踪SQL参数的传递过程
<span class="hljs-bullet">3.</span> 记录结果日志 - 可选的查询结果记录
<span class="hljs-bullet">4.</span> 记录性能日志 - 精准统计SQL执行耗时
<span class="hljs-bullet">5.</span> 记录异常日志 - 详尽的错误信息捕获
<span class="hljs-bullet">6.</span> 集成日志框架 - 无缝适配主流日志组件
</code></pre>
<h2 data-id="heading-2">为什么日志如此重要？</h2>
<p>在实际开发中，日志扮演着三个关键角色：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">1</span>、开发调试阶段
  <span class="hljs-number">1</span>、查看实际执行的<span class="hljs-keyword">SQL</span>语句
  <span class="hljs-number">2</span>、检查参数绑定是否正确
  <span class="hljs-number">3</span>、快速排查<span class="hljs-keyword">SQL</span>语法错误
<span class="hljs-number">2</span>、性能优化阶段
  <span class="hljs-number">1</span>、识别执行缓慢的<span class="hljs-keyword">SQL</span>查询
  <span class="hljs-number">2</span>、分析<span class="hljs-keyword">SQL</span>执行频率分布
  <span class="hljs-number">3</span>、指导索引优化方向
<span class="hljs-number">3</span>、生产运维阶段
  <span class="hljs-number">1</span>、问题快速定位与追踪
  <span class="hljs-number">2</span>、数据操作行为审计
  <span class="hljs-number">3</span>、业务数据深度分析
</code></pre>
<h2 data-id="heading-3">MyBatis日志的五大特点</h2>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>自动集成</td><td>智能检测并使用项目中的日志框架</td></tr><tr><td>多框架支持</td><td>支持SLF4J、Log4j、Log4j2、JDK Logging等</td></tr><tr><td>分级记录</td><td>支持DEBUG、INFO、WARN、ERROR等级别</td></tr><tr><td>性能考虑</td><td>使用延迟加载，避免不必要的字符串拼接</td></tr><tr><td>JDBC日志</td><td>专门记录JDBC操作的详细日志</td></tr></tbody></table>
<h2 data-id="heading-4">二、接口架构：统一而灵活的设计</h2>
<p>MyBatis采用接口+适配器的经典设计模式，实现了与日志框架的解耦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec980824a08499f841a162244c593b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=9mmX%2B6Xy8AZ2UxdtLFbOhURyiCw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">核心接口：Log</h2>
<p>MyBatis定义了简洁而强大的日志接口：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface Log {
    <span class="hljs-comment">// 是否启用DEBUG级别</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">isDebugEnabled</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// 是否启用ERROR级别</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">isErrorEnabled</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// DEBUG级别日志</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span></span>;

    <span class="hljs-comment">// ERROR级别日志</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span></span>;

    <span class="hljs-comment">// ERROR级别日志（带异常）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> s, Throwable e)</span></span>;

    <span class="hljs-comment">// WARN级别日志（带异常）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">warn</span><span class="hljs-params">(<span class="hljs-type">String</span> s, Throwable e)</span></span>;
}
</code></pre>
<p><strong>日志框架适配器家族</strong>MyBatis通过适配器模式支持多种主流日志框架：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e78b04ff596642149f66c9b6fea98c45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=yvum4mm5MytERF0YrBWN9zoEivY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">Slf4jImpl实现示例</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Slf4jImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Log</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Logger</span> log;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Slf4</span>jImpl(<span class="hljs-title class_">String</span> clazz) {
        <span class="hljs-comment">// 通过SLF4J工厂创建Logger</span>
        log = <span class="hljs-title class_">LoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(clazz);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDebugEnabled</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> log.<span class="hljs-title function_">isDebugEnabled</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {
        log.<span class="hljs-title function_">debug</span>(s);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">error</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        log.<span class="hljs-title function_">error</span>(s, e);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">warn</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        log.<span class="hljs-title function_">warn</span>(s, e);
    }
}
</code></pre>
<h2 data-id="heading-7">LogFactory工厂类：智能选择最佳日志框架</h2>
<p>LogFactory负责按照优先级自动检测并创建合适的Log实现：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFactory</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> Constructor<span class="hljs-meta">&lt;?</span> <span class="hljs-keyword">extends</span> Log&gt; logConstructor;

    <span class="hljs-built_in">static</span> {
        <span class="hljs-comment">// 按优先级依次尝试加载日志框架</span>
        <span class="hljs-comment">// 1. 优先尝试SLF4J</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Slf4jImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"SLF4J"</span>);
        <span class="hljs-comment">// 2. 然后尝试Log4j2</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Log4j2Impl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"Log4j 2"</span>);
        <span class="hljs-comment">// 3. 继续尝试Log4j</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Log4jImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"Log4j"</span>);
        <span class="hljs-comment">// 4. 尝试JDK内置日志</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(Jdk14LoggingImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"JDK logging"</span>);
        <span class="hljs-comment">// 5. 降级到标准输出</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(StdOutImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"stdout"</span>);
        <span class="hljs-comment">// 6. 最后使用空实现</span>
        <span class="hljs-title function_ invoke__">tryImplementation</span>(NoOpImpl.<span class="hljs-keyword">class</span>, <span class="hljs-string">"noop"</span>);
    }

    <span class="hljs-comment">// 获取Log实例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Log <span class="hljs-title function_ invoke__">getLog</span>(Class&lt;?&gt; clazz) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">getLog</span>(clazz.<span class="hljs-title function_ invoke__">getName</span>());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Log <span class="hljs-title function_ invoke__">getLog</span>(String logger) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> logConstructor.<span class="hljs-title function_ invoke__">newInstance</span>(logger);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> t) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(
                <span class="hljs-string">"Error creating logger for "</span> + logger, t);
        }
    }

    <span class="hljs-comment">// 支持自定义日志实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">useCustomLogging</span>(
        Class&lt;? <span class="hljs-keyword">extends</span> Log&gt; clazz) {
        <span class="hljs-title function_ invoke__">setImplementation</span>(clazz);
    }
}
</code></pre>
<h2 data-id="heading-8">三、日志配置：灵活多样的配置方式</h2>
<p>MyBatis提供了多种配置方式，满足不同场景需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ddd4bb5b7234b269aa823981fe198d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=VSgedxv7z3scvAIPAVQ1I%2FuzxOY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">方式1：mybatis-config.xml配置</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 可选：显式指定日志实现 --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="SLF4J"/&gt; --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="LOG4J2"/&gt; --&gt;</span>
        <span class="hljs-comment">&lt;!-- &lt;setting name="logImpl" value="STDOUT_LOGGING"/&gt; --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-10">方式2：Log4j2详细配置</h2>
<p><strong>log4j2.xml：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configuration</span> <span class="hljs-attr">status</span>=<span class="hljs-string">"WARN"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Appenders</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Console</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Console"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"SYSTEM_OUT"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> 
                <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Console</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 文件输出（滚动策略） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"RollingFile"</span> 
                     <span class="hljs-attr">fileName</span>=<span class="hljs-string">"logs/mybatis.log"</span>
                     <span class="hljs-attr">filePattern</span>=<span class="hljs-string">"logs/mybatis-%d{yyyy-MM-dd}-%i.log.gz"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> 
                <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 每天滚动 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">"1"</span>/&gt;</span>
                <span class="hljs-comment">&lt;!-- 单文件最大100MB --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"100 MB"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 最多保留30天 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"30"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Appenders</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Loggers</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- MyBatis核心日志 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">"false"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- SQL语句日志 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis.jdbc.SQL"</span> 
                <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span> <span class="hljs-attr">additivity</span>=<span class="hljs-string">"false"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Root Logger --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"Console"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Root</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Loggers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-11">方式3：Logback配置</h2>
<p><strong>logback.xml：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CONSOLE"</span> 
              <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 文件输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> 
              <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>logs/mybatis.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> 
            <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>logs/mybatis-%d{yyyy-MM-dd}.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MyBatis日志配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.Connection"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.Statement"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"java.sql.PreparedStatement"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Root配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"CONSOLE"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">方式4：Spring Boot配置</h2>
<p><strong>application.yml：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-comment"># MyBatis SQL日志</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.Connection:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.Statement:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.PreparedStatement:</span> <span class="hljs-string">DEBUG</span>
    <span class="hljs-attr">java.sql.ResultSet:</span> <span class="hljs-string">WARN</span>
  <span class="hljs-comment"># 日志文件配置</span>
  <span class="hljs-attr">file:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">logs</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">myapp.log</span>
    <span class="hljs-attr">max-size:</span> <span class="hljs-string">100MB</span>
    <span class="hljs-attr">max-history:</span> <span class="hljs-number">30</span>
  <span class="hljs-comment"># 日志格式</span>
  <span class="hljs-attr">pattern:</span>
    <span class="hljs-attr">console:</span> <span class="hljs-string">"%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"</span>
    <span class="hljs-attr">file:</span> <span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"</span>
</code></pre>
<h2 data-id="heading-13">四、JDBC日志：细粒度的操作追踪</h2>
<p><strong>MyBatis提供了专门的JDBC日志记录机制，可以追踪每一个JDBC操作的细节。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5da0ae4cc6eb4e73bbdba0f3458070d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=jvuOpcBqFGp8JFVPIcsLjt8Q8Gg%3D" alt="" loading="lazy"/></p>
<p><strong>JDBC日志记录内容</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15bc48f40d6547979a9ebcd35f24d70f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=B9h84ioMds2D81cMCIZGZ9UBw2c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">BaseJdbcLogger基础类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseJdbcLogger</span> {
    <span class="hljs-comment">// 日志对象</span>
    <span class="hljs-keyword">protected</span> Log statementLog;
    <span class="hljs-keyword">protected</span> Log connectionLog;

    <span class="hljs-comment">// 调试开关</span>
    <span class="hljs-keyword">protected</span> boolean isDebugEnabled;

    <span class="hljs-comment">// 慢查询阈值（毫秒）</span>
    <span class="hljs-keyword">protected</span> int slowQueryThreshold;

    <span class="hljs-keyword">public</span> BaseJdbcLogger(Log log, int queryThreshold) {
        <span class="hljs-keyword">this</span>.statementLog = log;
        <span class="hljs-keyword">this</span>.connectionLog = log;
        <span class="hljs-keyword">this</span>.isDebugEnabled = log.isDebugEnabled();
        <span class="hljs-keyword">this</span>.slowQueryThreshold = queryThreshold;
    }

    <span class="hljs-comment">// 记录SQL执行</span>
    <span class="hljs-keyword">protected</span> void debug(String s, boolean isSql) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDebugEnabled) {
            <span class="hljs-keyword">this</span>.statementLog.debug(s);
        }
    }

    <span class="hljs-comment">// 记录连接创建</span>
    <span class="hljs-keyword">protected</span> void connectionCreated(Connection conn) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connectionLog.isDebugEnabled()) {
            <span class="hljs-keyword">this</span>.connectionLog.debug(<span class="hljs-string">"==&gt;  Opening JDBC Connection"</span>);
        }
    }

    <span class="hljs-comment">// 记录连接关闭</span>
    <span class="hljs-keyword">protected</span> void connectionClosed(Connection conn) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.connectionLog.isDebugEnabled()) {
            <span class="hljs-keyword">this</span>.connectionLog.debug(<span class="hljs-string">"&lt;==  Closing JDBC Connection"</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-15">ConnectionLogger连接日志</h2>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseJdbcLogger</span> </span>
    implements <span class="hljs-type">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Connection</span> connection;

    public <span class="hljs-type">ConnectionLogger</span>(<span class="hljs-type">Connection</span> conn, <span class="hljs-type">Log</span> log, int queryThreshold) {
        <span class="hljs-keyword">super</span>(log, queryThreshold);
        <span class="hljs-keyword">this</span>.connection = conn;
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">Object</span> invoke(<span class="hljs-type">Object</span> proxy, <span class="hljs-type">Method</span> method, <span class="hljs-type">Object</span>[] args) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">Throwable</span> {
        <span class="hljs-type">String</span> methodName = method.getName();

        <span class="hljs-comment">// 记录PreparedStatement创建</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"prepareStatement"</span>.equals(methodName) || 
            <span class="hljs-string">"prepareCall"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (isDebugEnabled()) {
                debug(<span class="hljs-string">"Preparing: "</span> + 
                    removeBreakingWhitespace((<span class="hljs-type">String</span>) args[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span>);
            }
        }

        <span class="hljs-comment">// 记录连接关闭</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"close"</span>.equals(methodName)) {
            connectionClosed(connection);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 执行原方法</span>
        <span class="hljs-keyword">return</span> method.invoke(connection, args);
    }
}
</code></pre>
<h2 data-id="heading-16">PreparedStatementLogger语句日志</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> 
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PreparedStatement statement;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object[] parameterValues;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> 
        <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();

        <span class="hljs-comment">// 记录参数设置</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"setString"</span>.equals(methodName) || 
            <span class="hljs-string">"setInt"</span>.equals(methodName) ||
            <span class="hljs-string">"setLong"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">2</span>) {
                <span class="hljs-type">int</span> <span class="hljs-variable">paramIndex</span> <span class="hljs-operator">=</span> (Integer) args[<span class="hljs-number">0</span>];
                <span class="hljs-type">Object</span> <span class="hljs-variable">paramValue</span> <span class="hljs-operator">=</span> args[<span class="hljs-number">1</span>];
                parameterValues[paramIndex - <span class="hljs-number">1</span>] = paramValue;

                <span class="hljs-keyword">if</span> (isDebugEnabled) {
                    debug(<span class="hljs-string">"Parameters: "</span> + paramIndex + 
                        <span class="hljs-string">" =&gt; "</span> + paramValue, <span class="hljs-literal">true</span>);
                }
            }
        }

        <span class="hljs-comment">// 记录SQL执行</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"execute"</span>.equals(methodName) || 
            <span class="hljs-string">"executeUpdate"</span>.equals(methodName) ||
            <span class="hljs-string">"executeQuery"</span>.equals(methodName)) {

            <span class="hljs-keyword">if</span> (isDebugEnabled) {
                debug(<span class="hljs-string">"==&gt;  Executing: "</span> + sql, <span class="hljs-literal">true</span>);
                debug(<span class="hljs-string">"==&gt; Parameters: "</span> + 
                    getParameterString(), <span class="hljs-literal">true</span>);
            }

            <span class="hljs-comment">// 计时执行</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(statement, args);
            <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

            <span class="hljs-keyword">if</span> (isDebugEnabled) {
                debug(<span class="hljs-string">"&lt;==  Total: "</span> + cost + <span class="hljs-string">" ms"</span>, <span class="hljs-literal">true</span>);
            }

            <span class="hljs-comment">// 慢查询告警</span>
            <span class="hljs-keyword">if</span> (slowQueryThreshold &gt; <span class="hljs-number">0</span> &amp;&amp; cost &gt; slowQueryThreshold) {
                connectionLog.warn(<span class="hljs-string">"Slow query detected: "</span> + 
                    cost + <span class="hljs-string">" ms"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">return</span> method.invoke(statement, args);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getParameterString</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterValues.length; i++) {
            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) sb.append(<span class="hljs-string">", "</span>);
            sb.append(i + <span class="hljs-number">1</span>).append(<span class="hljs-string">" =&gt; "</span>).append(parameterValues[i]);
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
}
</code></pre>
<h2 data-id="heading-17">ResultSetLogger结果集日志</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultSetLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> 
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultSet resultSet;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> 
        <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
        <span class="hljs-comment">// 记录列名</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"next"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (columnNames.isEmpty()) {
                <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> resultSet.getMetaData();
                <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) {
                    columnNames.add(metaData.getColumnName(i));
                }
            }
        }
        <span class="hljs-comment">// 记录结果值</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"getString"</span>.equals(methodName) || 
            <span class="hljs-string">"getInt"</span>.equals(methodName) ||
            <span class="hljs-string">"getObject"</span>.equals(methodName)) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(resultSet, args);
            <span class="hljs-keyword">if</span> (isDebugEnabled &amp;&amp; result != <span class="hljs-literal">null</span>) {
                <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> columnNames.isEmpty() ? 
                    <span class="hljs-string">"?"</span> : columnNames.get(columnValues.size());
                columnValues.add(columnName + <span class="hljs-string">" = "</span> + result);
            }
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-comment">// 记录结果集关闭</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"close"</span>.equals(methodName)) {
            <span class="hljs-keyword">if</span> (isDebugEnabled &amp;&amp; !columnValues.isEmpty()) {
                debug(<span class="hljs-string">"&lt;==    Columns: "</span> + columnNames, <span class="hljs-literal">true</span>);
                debug(<span class="hljs-string">"&lt;==        Row: "</span> + columnValues, <span class="hljs-literal">true</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> method.invoke(resultSet, args);
    }
}
</code></pre>
<h2 data-id="heading-18">五、日志适配器：优雅的框架集成</h2>
<h2 data-id="heading-19">MyBatis通过适配器模式实现了与各种日志框架的无缝集成。</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a4b1e8cfcd842c8b3780da146c9054b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=aoe60Wez%2BnP3zk2dpXgpvsuVKU8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">日志适配器的工作流程</h2>
<pre><code class="hljs language-markdown" lang="markdown">MyBatis Log接口
<span class="hljs-code">    ↓
日志适配器 (Log4j2Impl)
    ↓
Log4j2 Logger
    ↓
日志输出（控制台/文件）
</span></code></pre>
<h2 data-id="heading-21">日志输出（控制台/文件）</h2>
<p>LogFactory按照优先级自动检测并选择日志框架：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> SLF4J (优先级最高)
<span class="hljs-bullet">2.</span> Log4j2
<span class="hljs-bullet">3.</span> Log4j
<span class="hljs-bullet">4.</span> JDK Logging
<span class="hljs-bullet">5.</span> STDOUT (标准输出)
<span class="hljs-bullet">6.</span> NOOP (无日志
</code></pre>
<p><strong>自定义日志适配器</strong></p>
<p>如果需要使用自定义日志框架，可以轻松扩展：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomLog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Log</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">CustomLogger</span> logger;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomLog</span>(<span class="hljs-title class_">String</span> clazz) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span> = <span class="hljs-title class_">CustomLoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(clazz);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDebugEnabled</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> logger.<span class="hljs-title function_">isDebugEnabled</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s</span>) {
        logger.<span class="hljs-title function_">debug</span>(s);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">error</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        logger.<span class="hljs-title function_">error</span>(s, e);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">warn</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> s, Throwable e</span>) {
        logger.<span class="hljs-title function_">warn</span>(s, e);
    }
}

<span class="hljs-comment">// 使用自定义日志</span>
<span class="hljs-title class_">LogFactory</span>.<span class="hljs-title function_">useCustomLogging</span>(<span class="hljs-title class_">CustomLog</span>.<span class="hljs-property">class</span>);
</code></pre>
<h2 data-id="heading-22">主流日志框架对比</h2>









































<table><thead><tr><th>日志框架</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>SLF4J</td><td>统一日志门面性能优秀</td><td>需要绑定实现</td><td>大型项目</td></tr><tr><td>Log4j2</td><td>性能最佳功能强大</td><td>配置相对复杂</td><td>高并发系统</td></tr><tr><td>Log4j</td><td>成熟稳定社区活跃</td><td>性能一般</td><td>老项目维护</td></tr><tr><td>JDK Logging</td><td>无需额外依赖简单轻量</td><td>功能有限</td><td>简单项目</td></tr><tr><td>STDOUT</td><td>配置简单即开即用</td><td>无格式化不可配置</td><td>开发测试</td></tr></tbody></table>
<h2 data-id="heading-23">六、实战应用：日志在开发中的运用</h2>
<p>让我们通过实际场景看看日志如何帮助我们解决问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26edd45c03754ffab9a62d69e79144ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768036099&amp;x-signature=pZ3bRAdX6da0Dp1Hu98O6pylXYM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-24">场景1：SQL调试日志</h2>
<p>记录完整的SQL语句和参数，快速定位问题：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 执行查询
<span class="hljs-keyword">User</span> <span class="hljs-keyword">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">1</span>L);

<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 控制台输出：
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>  Preparing: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> ?
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Parameters: <span class="hljs-number">1</span>(<span class="hljs-type">Integer</span>)
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>    Columns: id, name, email, age, create_time
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>        <span class="hljs-type">Row</span>: <span class="hljs-number">1</span>, 张三, zhangsan<span class="hljs-variable">@example</span>.com, <span class="hljs-number">25</span>, <span class="hljs-number">2024</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>  Total: <span class="hljs-number">15</span> ms
</code></pre>
<h2 data-id="heading-25">场景2：性能监控日志</h2>
<p>识别慢查询，优化系统性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">query</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> SQLException {
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
        <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">cost</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

        <span class="hljs-comment">// 慢查询告警</span>
        <span class="hljs-keyword">if</span> (cost &gt; slowQueryThreshold) {
            logger.warn(<span class="hljs-string">"Slow query: {} ms - SQL: {}"</span>, 
                cost, sql);
        }

        <span class="hljs-keyword">if</span> (isDebugEnabled) {
            logger.debug(<span class="hljs-string">"Query cost: {} ms"</span>, cost);
        }
    }
}
</code></pre>
<h2 data-id="heading-26">场景3：参数日志</h2>
<p>检查参数绑定是否正确：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 查询用户
List<span class="hljs-operator">&lt;</span><span class="hljs-keyword">User</span><span class="hljs-operator">&gt;</span> users <span class="hljs-operator">=</span> userMapper.selectByCondition("张", <span class="hljs-number">25</span>);

<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 日志输出：
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span>  Preparing: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user 
     <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> CONCAT(<span class="hljs-string">'%'</span>, ?, <span class="hljs-string">'%'</span>) <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ?
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Parameters: 张(String), <span class="hljs-number">25</span>(<span class="hljs-type">Integer</span>)
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>  Total: <span class="hljs-number">22</span> ms
<span class="hljs-operator">&lt;=</span><span class="hljs-operator">=</span>      <span class="hljs-keyword">Rows</span>: <span class="hljs-number">5</span>
</code></pre>
<h2 data-id="heading-27">场景4：结果日志（开发环境）</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 日志输出：</span>
&lt;==    <span class="hljs-attribute">Columns</span>: id, name, email
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">1</span>, 张三, zhangsan<span class="hljs-variable">@example</span>.com
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">2</span>, 李四, lisi<span class="hljs-variable">@example</span>.com
&lt;==        <span class="hljs-attribute">Row</span>: <span class="hljs-number">3</span>, 王五, wangwu<span class="hljs-variable">@example</span>.com
&lt;==  <span class="hljs-attribute">Total</span>: <span class="hljs-number">3</span> rows
</code></pre>
<h2 data-id="heading-28">场景5：异常日志</h2>
<p>详细记录SQL执行异常：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span> {
    userMapper.insert(user);
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 日志输出：</span>
    ==&gt;  Preparing: <span class="hljs-function">INSERT INTO <span class="hljs-title">t_user</span> (<span class="hljs-params">name, email</span>) <span class="hljs-title">VALUES</span> (<span class="hljs-params">?, ?</span>)</span>
    ==&gt; Parameters: 张三(String), invalid-email(String)
    <span class="hljs-meta">### Error updating database.</span>
    <span class="hljs-meta">### Cause: java.sql.SQLException: Incorrect string value</span>
    <span class="hljs-meta">### The <span class="hljs-keyword">error</span> may exist in UserMapper.xml</span>
    <span class="hljs-meta">### The <span class="hljs-keyword">error</span> may involve UserMapper.insert</span>
    <span class="hljs-meta">### SQL: INSERT INTO t_user (name, email) VALUES (?, ?)</span>
    <span class="hljs-meta">### Cause: java.sql.SQLException: Incorrect string value</span>
}
</code></pre>
<h2 data-id="heading-29">场景6：事务日志</h2>
<p>追踪事务的完整生命周期：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 开启事务</span>
SqlSession session = sqlSessionFactory.openSession();

<span class="hljs-comment">// 日志输出：</span>
==&gt;  Opening JDBC Connection
==&gt;  Setting autocommit to <span class="hljs-keyword">false</span> <span class="hljs-keyword">on</span> JDBC Connection

<span class="hljs-comment">// 提交事务</span>
session.commit();

<span class="hljs-comment">// 日志输出：</span>
==&gt;  Committing JDBC Connection
&lt;==  Closing JDBC Connection
</code></pre>
<h2 data-id="heading-30">七、最佳实践</h2>
<h2 data-id="heading-31">不同环境的日志配置策略</h2>
<h2 data-id="heading-32">开发环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">DEBUG</span>
  <span class="hljs-comment"># 启用DEBUG级别</span>
  <span class="hljs-comment"># 记录SQL和参数</span>
  <span class="hljs-comment"># 记录结果集</span>
  <span class="hljs-comment"># 记录执行时间</span>
</code></pre>
<h2 data-id="heading-33">测试环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">INFO</span>
  <span class="hljs-comment"># 启用INFO级别</span>
  <span class="hljs-comment"># 记录SQL和参数</span>
  <span class="hljs-comment"># 记录慢查询（&gt;1秒）</span>
  <span class="hljs-comment"># 记录异常信息</span>
</code></pre>
<h2 data-id="heading-34">生产环境配置</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.apache.ibatis:</span> <span class="hljs-string">WARN</span>
  <span class="hljs-comment"># 启用WARN级别</span>
  <span class="hljs-comment"># 仅记录慢查询（&gt;3秒）</span>
  <span class="hljs-comment"># 记录错误和异常</span>
</code></pre>
<h2 data-id="heading-35">性能优化</h2>
<h2 data-id="heading-36">1️⃣ 合理设置日志级别</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 生产环境使用INFO或WARN级别 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"WARN"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-37">2️⃣ 使用异步日志</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Log4j2异步日志配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Async</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"AsyncAppender"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"RollingFile"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Async</span>&gt;</span>
</code></pre>
<h2 data-id="heading-38">3️⃣ SQL日志单独存储</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- SQL日志独立文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RollingFile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SqlLog"</span> <span class="hljs-attr">fileName</span>=<span class="hljs-string">"logs/sql.log"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">PatternLayout</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">"%d{yyyy-MM-dd HH:mm:ss} - %msg%n"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">RollingFile</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">Logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"org.apache.ibatis.jdbc"</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"DEBUG"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AppenderRef</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"SqlLog"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Logger</span>&gt;</span>
</code></pre>
<h2 data-id="heading-39">4️⃣ 日志文件滚动策略</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Policies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 每天滚动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TimeBasedTriggeringPolicy</span> <span class="hljs-attr">interval</span>=<span class="hljs-string">"1"</span>/&gt;</span>
    <span class="hljs-comment">&lt;!-- 单文件最大100MB --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SizeBasedTriggeringPolicy</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"100 MB"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Policies</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 最多保留30天 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">DefaultRolloverStrategy</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"30"</span>/&gt;</span>
</code></pre>
<h2 data-id="heading-40">八、总结</h2>
<p>MyBatis的日志模块为开发调试和性能优化提供了强大的支持。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Log接口 - MyBatis定义的统一日志接口，实现与框架解耦
<span class="hljs-bullet">2.</span> 日志适配器 -通过适配器模式支持多种日志框架
<span class="hljs-bullet">3.</span> JDBC日志 - 细粒度的JDBC操作日志记录
<span class="hljs-bullet">4.</span> 灵活配置 - 支持多种配置方式，适应不同场景
<span class="hljs-bullet">5.</span> 性能监控 - 通过日志识别性能瓶颈
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史]]></title>    <link>https://juejin.cn/post/7589932422655344676</link>    <guid>https://juejin.cn/post/7589932422655344676</guid>    <pubDate>2026-01-03T09:00:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589932422655344676" data-draft-id="7589932422655311908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史"/> <meta itemprop="keywords" content="后端,PHP,Java"/> <meta itemprop="datePublished" content="2026-01-03T09:00:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩师傅"/> <meta itemprop="url" content="https://juejin.cn/user/286348958252526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从重启马车到常驻运输队：CGI 与 PHP 的物流系统演进简史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/286348958252526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩师傅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T09:00:30.000Z" title="Sat Jan 03 2026 09:00:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要</strong>：从 CGI 每次重启进程的"外包临工"模式，到 PHP 进程复用的"自家雇员"模式。第一代和第二代物流系统的关键差异在于进程是否可以复用，这是 Web API 演进史上的第一个重要转折点。</p>
<h2 data-id="heading-0">🚚 物流系统的演进史</h2>
<h3 data-id="heading-1">大蟒蛇法师的困惑</h3>
<p>🐍 大蟒蛇法师："灵狐法师问我，FastAPI 是不是第一代物流系统？其实不是的。在 FastAPI 之前，已经有很多物流系统了。让我给你讲讲物流系统的演进史，以及不同法师们的物流系统。"</p>
<p><strong>核心理解</strong>：</p>
<ul>
<li>FastAPI 不是第一代物流系统</li>
<li>在 FastAPI 之前，已经有很多物流系统（Flask、Django、Express 等）</li>
<li>这些物流系统都在不断演进，适应不同的需求</li>
<li>REST API 是一个<strong>概念</strong>，不是某个具体的物流系统</li>
<li>不同的法师有不同的物流系统</li>
</ul>
<h3 data-id="heading-2">法师角色介绍</h3>
<p>在魔法世界里，不同的法师负责不同的后端技术：</p>
<ul>
<li>🐍 <strong>大蟒蛇法师</strong>：Python 后端，负责 Flask、Django、FastAPI 等 Python 物流系统，<strong>需要与灵狐法师合作</strong>（前后端分离）</li>
<li>🦊 <strong>灵狐法师</strong>：前端开发（JavaScript），负责卖货给客户，与大蟒蛇法师、夜狐法师合作</li>
<li>🌙 <strong>夜狐法师</strong>：Node.js 后端，隐藏于黑暗中，不露面，与兄弟灵狐法师合作，负责后端配置（前后端分离）</li>
<li>🧵 <strong>PHP 织布师</strong>：PHP 后端，负责 PHP 物流系统，<strong>不需要与灵狐法师合作</strong>（传统全栈模式，直接返回 HTML）</li>
<li>☕ <strong>黑水甲瓦法师</strong>：Java 后端，负责 Servlet、Spring 等 Java 物流系统
<ul>
<li><strong>Servlet 时代（1990s）</strong>：主要是传统模式，Servlet + JSP，直接返回 HTML，<strong>不需要与灵狐法师合作</strong>（前后端不分离）</li>
<li><strong>现代模式（Spring MVC，2010s+）</strong>：可以前后端分离，提供 REST API，<strong>需要与灵狐法师合作</strong></li>
</ul>
</li>
<li>🛡️ <strong>蓝盾法师</strong>：ASP.NET 后端，概念法师，从彩色方块世界来的，没人见过他的真身，只有外号
<ul>
<li><strong>传统模式</strong>：类似 PHP 织布师，直接返回 HTML，<strong>不需要与灵狐法师合作</strong></li>
<li><strong>现代模式</strong>：ASP.NET Core Web API，<strong>需要与灵狐法师合作</strong>（前后端分离）</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-3">📜 第一代：原始物流系统（CGI、Servlet）</h2>
<h3 data-id="heading-4">时代背景</h3>
<p>🐍 大蟒蛇法师："最早的物流系统，就像最原始的送货任务。每次订单都要重新启动整个送货任务，效率很低。那时候，CGI 和黑水甲瓦法师（Java）的 Servlet 系统就是这样的。"</p>
<h3 data-id="heading-5">CGI 是什么？</h3>
<p>🐍 大蟒蛇法师："CGI（Common Gateway Interface，通用网关接口）是一个<strong>接口标准</strong>，定义了 Web 服务器如何与外部程序通信。在原始时代，没有完整的备货流程，每次订单都要重新开始。"</p>
<p><strong>CGI = 启动马车和道路的方法（接口标准）</strong>：</p>
<ul>
<li><strong>不是完整的物流系统</strong>：而是"如何启动马车和道路"的方法（接口标准）</li>
<li><strong>定义了接口标准</strong>：定义了 Web 服务器如何调用外部程序的接口标准</li>
<li><strong>不是具体的物流系统</strong>：而是一个接口标准，定义了如何与外部程序通信</li>
<li><strong>通用接口</strong>：所有法师都可以使用这个接口标准</li>
<li><strong>每次请求都要启动新进程</strong>：每次订单都要重新启动程序进程（整个送货的任务）</li>
<li><strong>处理完就结束</strong>：程序处理完订单后，进程（整个送货的任务）就结束了</li>
</ul>
<p><strong>CGI 的定位</strong>：</p>
<ul>
<li><strong>CGI = 接口标准</strong>：定义了"如何启动马车和道路"的方法</li>
<li><strong>不是完整的物流系统</strong>：只是定义了如何调用外部程序的接口</li>
<li><strong>FastAPI 比它完整得多</strong>：FastAPI 是完整的物流系统（框架），包含路由系统、中间件、数据验证等</li>
</ul>
<p><strong>CGI 时代 = 原始时代，没有完整的备货流程</strong></p>
<p>☕ 黑水甲瓦法师："在 CGI 时代，没有完整的备货流程。收到订单之后，我会启动整个送货任务，去到每个仓库，每个仓库的大门都需要大开，从材料的查找开始，一个个去找，然后再制作。每次来新订单，都要重新启动整个送货任务，一个个仓库去开，然后做产品。同样的流程没有被记录和筛检，所以等于每次都是新的。"</p>
<p><strong>CGI 的工作方式（魔法仓库比喻）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">客户下单
  ↓
🛡️ 阿帕奇守护者（Web 服务器）收到订单
  ↓
☕ 黑水甲瓦法师："启动整个送货任务！"（启动新的 CGI 程序进程）
  ↓
☕ 进程 = 整个送货的任务
  ↓
☕ 需要做过这一单子的运输团队
  ↓
☕ 运输团队需要记录路径（任务复杂）
  ↓
☕ 去到每个仓库（加载整个脚本文件）
  ↓
☕ 每个仓库的大门都需要大开（整个文件都要被加载）
  ↓
☕ 从材料的查找开始，一个个去找（脚本里的所有代码都要执行）
  ↓
☕ 然后再制作（处理订单）
  ↓
☕ 完成，整个送货任务结束，进程结束
  ↓
下次订单又要重新启动整个送货任务，重新开仓库，重新找材料
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d51acdcc50c4d8585fa010b359e4300~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=zyGkY57GPqc%2F0p0OF69n1vZSAFw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键特点</strong>：</p>
<ul>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>需要做过这一单子的运输团队</strong>：每次都要重新组织运输团队</li>
<li><strong>运输团队需要记录路径</strong>：任务复杂，需要运输团队记住路径</li>
<li><strong>没有固定的备货流程</strong>：没有路由系统，每个脚本都是独立的</li>
<li><strong>每次都要重新开始</strong>：每次请求都要重新启动进程（整个送货的任务），重新加载文件</li>
<li><strong>整个文件都要被加载</strong>：可能一个文件里面只跑一个函数，但还是要请求整个文件</li>
<li><strong>同样的流程没有被记录和筛检</strong>：没有路由系统，没有固定的流程</li>
<li><strong>所以等于每次都是新的</strong>：每次请求都是独立的，没有复用</li>
</ul>
<p><strong>Servlet 是什么？</strong></p>
<p>☕ 黑水甲瓦法师："Servlet 是我的代码仓库，专门用来做 CGI 这样的物流过程。它比 CGI 更完整，有生命周期管理，可以复用，但每次请求还是要重新处理整个送货任务。"</p>
<p><strong>Servlet = 代码仓库，专门用来做 CGI 这样的物流过程</strong>：</p>
<ul>
<li><strong>是 Java 的 Web 处理技术</strong>：黑水甲瓦法师用来处理 Web 请求的技术</li>
<li><strong>类似 CGI，但更完整</strong>：有生命周期管理、可以复用</li>
<li><strong>专门用来做 CGI 这样的物流过程</strong>：实现类似 CGI 的功能，但更高效</li>
<li><strong>每次请求还是要重新处理</strong>：虽然可以复用，但每次请求还是要重新处理整个送货任务</li>
<li><strong>进程 = 整个送货的任务</strong>：需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
</ul>
<p><strong>Servlet 时代的前后端模式</strong>：</p>
<p>🐍 大蟒蛇法师："Servlet 时代（1990s）主要是传统模式，前后端不分离。那时候还没有灵狐法师（现代前端框架），所以黑水甲瓦法师直接返回 HTML 页面（JSP）。"</p>
<p>☕ 黑水甲瓦法师："是的，在 Servlet 时代，我主要是用 Servlet + JSP 的方式，直接返回 HTML 页面，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。但 Servlet 技术本身可以支持前后端分离（提供 API），只是那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>Servlet 时代（1990s）</strong>：主要是传统模式，Servlet + JSP，直接返回 HTML，<strong>前后端不分离</strong></li>
<li><strong>Servlet 技术本身</strong>：可以支持前后端分离（提供 API），但那时候前端技术还没成熟</li>
<li><strong>现代 Servlet（Spring MVC，2010s+）</strong>：可以前后端分离，与灵狐法师合作，提供 REST API</li>
<li><strong>前后端分离的时代</strong>：2010s+，现代前端框架（React/Vue/Angular）兴起，后端提供 API</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 每次订单都要重新启动整个送货任务，效率太低</li>
<li>❌ 需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
<li>❌ 资源消耗大（每次都要启动新进程）</li>
<li>❌ 无法处理大量订单（高并发时性能瓶颈明显）</li>
</ul>
<hr/>
<h2 data-id="heading-6">📜 第二代：改进的物流系统（PHP、ASP.NET）</h2>
<h3 data-id="heading-7">时代背景</h3>
<p>🐍 大蟒蛇法师："后来有了改进的物流系统，比如 PHP 织布师的物流系统。进程（整个送货的任务）可以复用，但还是要重新准备。还有蓝盾法师的 ASP.NET 系统。"</p>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>PHP</strong>：PHP 织布师的物流系统，进程（整个送货的任务）可以复用</li>
<li><strong>ASP.NET</strong>：蓝盾法师的物流系统，从彩色方块世界来的</li>
<li><strong>可以复用资源</strong>：但每次请求还是要重新初始化</li>
<li><strong>效率提升</strong>：比第一代快，但还不够</li>
</ul>
<h3 data-id="heading-8">PHP 的改进：进程（整个送货的任务）可以复用</h3>
<p>🧵 PHP 织布师："我织布师也不是吃素的！我的送货团队早就养在厂里，随时待命。订单一来，运输马车立刻出发，省时又省马草。虽然每次还得亲自装货、一个仓库一个仓库跑，但这可比临时招人强多了。"</p>
<p><strong>PHP 的工作方式（进程可以复用）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">第一次请求：
  🛡️ 阿帕奇守护者："启动 PHP 进程"
  ↓
  🧵 PHP 织布师："进程（整个送货的任务）准备好了"
  ↓
  🧵 进程 = 整个送货的任务
  ↓
  🧵 需要做过这一单子的运输团队
  ↓
  🧵 运输团队需要记录路径（任务复杂）
  ↓
  🧵 处理订单（一个个仓库去开）
  ↓
  🧵 进程保留（整个送货的任务还在，运输团队没有遣散）

第二次请求：
  🛡️ 阿帕奇守护者："复用 PHP 进程"
  ↓
  🧵 PHP 织布师："进程（整个送货的任务）还在，但我需要重新装货..."
  ↓
  🧵 重新初始化 PHP 环境（重新装货）
  ↓
  🧵 需要做过这一单子的运输团队
  ↓
  🧵 运输团队需要记录路径（任务复杂）
  ↓
  🧵 处理订单（还是要一个个仓库去开）
  ↓
  🧵 进程保留（整个送货的任务还在，运输团队没有遣散）
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dddb27d751cd4b949d9e13b227b5a582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=EkyDsfJYDiSa5Iou%2F3fpSZFLBnM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>进程 = 整个送货的任务</strong>：不是车马，而是整个送货的任务</li>
<li><strong>进程（整个送货的任务）一直在</strong>：PHP 进程可以保留，不需要每次都重新启动</li>
<li><strong>同样的运输团队，并没有遣散，随时待命</strong>：进程可以复用，随时待命</li>
<li><strong>需要做过这一单子的运输团队</strong>：每次请求还是要重新组织运输团队</li>
<li><strong>运输团队需要记录路径</strong>：任务复杂，需要运输团队记住路径</li>
<li><strong>执行一样的运输任务，就会识路</strong>：进程可以复用，可能有一些缓存或优化</li>
<li><strong>但还是要一个个仓库去开</strong>：每次请求还是要重新加载和执行 PHP 脚本文件</li>
</ul>
<p><strong>与 CGI 的对比</strong>：</p>
<p><strong>CGI（第一代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">每次请求：
  启动新进程（整个送货的任务） → 处理订单 → 进程结束
  需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂
  整个送货任务用完就没了，运输团队遣散了
</code></pre>
<p><strong>PHP（第二代）</strong>：</p>
<pre><code class="hljs language-plain" lang="plain">每次请求：
  复用进程（整个送货的任务） → 处理订单 → 进程保留
  需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂
  整个送货任务一直在，运输团队没有遣散，随时待命
</code></pre>
<p><strong>改进</strong>：</p>
<ul>
<li>✅ 进程（整个送货的任务）可以复用，不需要每次都重新启动</li>
<li>✅ 同样的运输团队，并没有遣散，随时待命</li>
<li>✅ 效率比第一代高</li>
<li>⚠️ 但每次请求还是要重新初始化（重新装货）</li>
<li>⚠️ 但还是要一个个仓库去开（重新加载和执行脚本文件）</li>
<li>⚠️ 但还是要需要做过这一单子的运输团队，运输团队需要记录路径，任务复杂</li>
</ul>
<p>🐍 大蟒蛇法师："所以说，从第一代到第二代，物流团队从‘外包临工’进化成了‘自家雇员’，虽然搬货流程还不够自动化，但起码省去了每次重启团队的烦恼。"</p>
<h3 data-id="heading-9">🔄 第一代 vs 第二代：关键差异对比</h3>
<p>🐍 大蟒蛇法师："虽然第一代和第二代都是传统模式，但它们有一个关键差异：<strong>进程是否可以复用</strong>。让我用一个对照表来说明。"</p>








































<table><thead><tr><th>特性</th><th>第一代（CGI/Servlet）</th><th>第二代（PHP/ASP.NET）</th></tr></thead><tbody><tr><td><strong>进程复用</strong></td><td>❌ 每次请求都重新启动进程</td><td>✅ 进程可以复用，保留在内存中</td></tr><tr><td><strong>运输团队</strong></td><td>每次都要重新组织，用完就遣散</td><td>运输团队不遣散，随时待命</td></tr><tr><td><strong>启动成本</strong></td><td>高（每次都要启动新进程）</td><td>低（复用已有进程）</td></tr><tr><td><strong>资源消耗</strong></td><td>按需消耗，但启动成本高</td><td>持续占用，但响应更快</td></tr><tr><td><strong>效率</strong></td><td>低（每次都要重新开始）</td><td>较高（进程复用带来效率提升）</td></tr><tr><td><strong>适用场景</strong></td><td>订单很少的场景</td><td>订单频繁的场景</td></tr></tbody></table>
<p><strong>核心差异</strong>：</p>
<ul>
<li><strong>第一代</strong>：每次订单都要重新启动整个送货任务，进程用完就结束，运输团队遣散</li>
<li><strong>第二代</strong>：进程（整个送货的任务）可以复用，运输团队不遣散，随时待命，但每次请求还是要重新初始化</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/796571d6e9504739a7705dde5f7c1c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5biI5YKF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768038764&amp;x-signature=o5cceDLNSun54zjQF0Q4NzUW3m4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第二代时代的前后端模式</strong>：</p>
<p>🐍 大蟒蛇法师："第二代时代（2000s）主要是传统模式，前后端不分离。那时候还没有灵狐法师（现代前端框架），所以 PHP 织布师和蓝盾法师直接返回 HTML 页面。"</p>
<p>🧵 PHP 织布师："是的，在 PHP 时代（2000s），我主要是直接返回 HTML 页面，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。PHP 技术本身可以支持前后端分离（提供 API），但那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p>🛡️ 蓝盾法师："虽然没人见过我的真身，但我的 ASP.NET 系统也是这样的。在 ASP.NET 时代（2000s），我主要是传统模式，直接返回 HTML，前后端不分离。那时候还没有灵狐法师，所以我不需要与灵狐法师合作。但 ASP.NET 技术本身可以支持前后端分离（提供 API），只是那时候前端技术还没成熟，所以主要是传统模式。"</p>
<p><strong>关键理解</strong>：</p>
<ul>
<li><strong>第二代时代（2000s）</strong>：主要是传统模式，PHP/ASP.NET 直接返回 HTML，<strong>前后端不分离</strong></li>
<li><strong>PHP/ASP.NET 技术本身</strong>：可以支持前后端分离（提供 API），但那时候前端技术还没成熟</li>
<li><strong>现代 PHP/ASP.NET（2010s+）</strong>：可以前后端分离，与灵狐法师合作，提供 REST API</li>
<li><strong>前后端分离的时代</strong>：2010s+，现代前端框架（React/Vue/Angular）兴起，后端提供 API</li>
</ul>
<hr/>
<h2 data-id="heading-10">📚 系列导航</h2>
<p><strong>系列名称</strong>：Web API 演进史：从 CGI 到 FastAPI<br/>
<em>（用物流系统比喻讲解 Web API 演进）</em></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段1：从重启马车到常驻运输队</a> ← 当前文章</li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段2：从随叫随到到规范配送</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">片段3：从物流法典到智能调度</a></li>
</ul>
<hr/>
<blockquote>
<p>📝 片段1 结束<br/>
🔄 下一片段预告：<br/>
运输团队终于不用手动写地址了！REST API 标准登场，为物流世界带来了"送货协议"与"资源派发规则"。<br/>
前后端开始真正分工，一场现代物流革命悄然发生……</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Wireshark TS | 超时重传时间不翻倍]]></title>    <link>https://juejin.cn/post/7589962224795762726</link>    <guid>https://juejin.cn/post/7589962224795762726</guid>    <pubDate>2026-01-02T06:38:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589962224795762726" data-draft-id="7589958976226557962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Wireshark TS | 超时重传时间不翻倍"/> <meta itemprop="keywords" content="Wireshark,TCP/IP,网络协议"/> <meta itemprop="datePublished" content="2026-01-02T06:38:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="7ACE"/> <meta itemprop="url" content="https://juejin.cn/user/4033458369739741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Wireshark TS | 超时重传时间不翻倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4033458369739741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    7ACE
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T06:38:01.000Z" title="Fri Jan 02 2026 06:38:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>看图猜故障系列，来自于技术群讨论的又一个问题，数据包如下图，No.4900 原始数据包，No.4901 间隔208ms第一次重传，No.4903 间隔208ms第二次重传。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aecb2aafa0d84c0faf743008b4fbfaa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN0FDRQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767940681&amp;x-signature=2NG%2Fiu4ZxywZHPStU7GDT3bFzZE%3D" alt="" loading="lazy"/></p>
<p><strong>问题就是数据包第二次超时重传，间隔时间为什么没有翻倍。</strong></p>
<h2 data-id="heading-1">问题分析</h2>
<p>说实话，刚看到这个数据包文件截图时，记忆中竟然没有一丝相似的故障现象，略感纳闷。实际解读，也没有特别反常的迹象，只是在间隔 384s 后，客户端所发送的数据段由于得不到 ACK 确认，进行了重传的过程。当然由于第二次重传的超时时间未翻倍的原因，所以首先我并没有把这些重传全部定义为是超时重传。</p>
<p>但既然是一个数据段的重传，没有其他输入的信息，那么可以先简单模拟超时重传，对比看下。</p>
<pre><code class="hljs language-plain" lang="plain"># cat test.pkt 
0  socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
+0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
+0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1) = 0

+0 &lt; S 0:0(0) win 10000 &lt;mss 1000&gt;
+0 &gt; S. 0:0(0) ack 1 &lt;...&gt;
+0.01 &lt; . 1:1(0) ack 1 win 10000
+0 accept(3, ..., ...) = 4

+0.1 write(4,...,100) = 100

+0 `sleep 5`
#
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下。</p>
<p>可以看到发出数据段后，第一次重传间隔时间为213ms，而第二次重传间隔时间为436ms，也就是说都符合超时重传的现象，超时时间是正常翻倍了。</p>
<pre><code class="hljs language-plain" lang="plain"># packetdrill test.pkt
#


# tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
22:25:38.983501 tun0  In  IP 192.0.2.1.34827 &gt; 192.168.209.238.8080: Flags [S], seq 0, win 10000, options [mss 1000], length 0
22:25:38.983536 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [S.], seq 3745491915, ack 1, win 64240, options [mss 1460], length 0
22:25:38.993637 tun0  In  IP 192.0.2.1.34827 &gt; 192.168.209.238.8080: Flags [.], ack 1, win 10000, length 0
22:25:39.093744 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:39.307178 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:39.743184 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:40.607187 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:25:42.335186 tun0  Out IP 192.168.209.238.8080 &gt; 192.0.2.1.34827: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>当然，由于第一个测试并没有支持 SACK，因此继续可以增加尝试测试。</p>
<pre><code class="hljs language-plain" lang="plain"># cat test.pkt 
0  socket(..., SOCK_STREAM, IPPROTO_TCP) = 3
+0 setsockopt(3, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0
+0 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0
+0 bind(3, ..., ...) = 0
+0 listen(3, 1) = 0

+0 &lt; S 0:0(0) win 10000 &lt;mss 1000,nop,nop,sackOK&gt;
+0 &gt; S. 0:0(0) ack 1 &lt;...&gt;
+0.01 &lt; . 1:1(0) ack 1 win 10000
+0 accept(3, ..., ...) = 4

+0.1 write(4,...,100) = 100

+0 `sleep 5`
#
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下。</p>
<p>可以看到发出数据段后，第一次重传间隔时间为213ms，而第二次重传间隔时间为216ms，和问题截图一模一样的现象，第二次重传的超时时间并未翻倍。</p>
<pre><code class="hljs language-plain" lang="plain"># packetdrill test.pkt
#


# tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
22:35:37.983481 tun0  In  IP 192.0.2.1.54829 &gt; 192.168.44.251.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
22:35:37.983508 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [S.], seq 2010255923, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
22:35:37.993598 tun0  In  IP 192.0.2.1.54829 &gt; 192.168.44.251.8080: Flags [.], ack 1, win 10000, length 0
22:35:38.093722 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.307185 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.523213 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:38.975187 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:39.839188 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
22:35:41.567190 tun0  Out IP 192.168.44.251.8080 &gt; 192.0.2.1.54829: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>通过两次实验对比，可知仅仅是增加了 SACK 的支持，就产生了不一样的结果，同时结合数据包的重传时间，可以判断出第一次重传并不是普通的超时重传，而在它发出之后，看到的第二次重传，才是真正的第一次超时重传，之后的也才是 RTO 不断翻倍后的超时重传过程。</p>
<p>那么第一次重传是什么？<strong>在 linux 系统中，它实际是一个 TLP 数据包，在SACK开启下，TLP 会重传强制传输还没有收到 ACK 确认的报文里面的最后一个报文或者未发送的新报文。</strong> 而在上面的测试以及问题截图场景中，也比较特殊，因为只发送了一个报文，所以第一次重传也就是发送了 TLP 定义中的最后一个报文，乍看起来，确实像是在进行超时重传。</p>
<h2 data-id="heading-2">TLP 介绍</h2>
<p>Tail Loss Probe (TLP)是一个发送端算法，主要目的是使用快速重传取代RTO超时重传来处理尾包丢失场景。如果TCP尾包丢失，如果依靠RTO超时进行重传会带来比较大的延迟，进而影响用户体验。</p>
<p>那么如果一个TCP连接没有在一段时间内没有收到ACK报文，TLP会强制传输还没有收到ACK确认的报文里面的最后一个报文或者未发送的新报文(传输的这个报文就叫做loss probe)。</p>
<p><strong>tcp_early_retrans - INTEGER</strong></p>
<p>Enable Early Retransmit (ER), per RFC 5827. ER lowers the threshold for triggering fast retransmit when the amount of outstanding data is small and when no previously unsent data can be transmitted (such that limited transmit could be used). Also controls the use of Tail loss probe (TLP) that converts RTOs occurring due to tail losses into fast recovery (draft-dukkipati-tcpm-tcp-loss-probe-01).</p>
<p>Possible values:</p>
<p>0 disables ER</p>
<p>1 enables ER</p>
<p>2 enables ER but delays fast recovery and fast retransmit by a fourth of RTT. This mitigates connection falsely recovers when network has a small degree of reordering (less than 3 packets).</p>
<p>3 enables delayed ER and TLP.</p>
<p>4 enables TLP only.</p>
<p>Default: 3</p>
<h2 data-id="heading-3">证明实验</h2>
<p>在 linux 中 <strong>tcp_early_retrans</strong> 参数默认值为 3，也就是同时启用了 Delayed ER 和 TLP。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 3
# 
</code></pre>
<p>如果想证明确实和 TLP 相关，可以从三个方面测试下：</p>
<ol>
<li>关闭 SACK；（上述实验已测试）</li>
<li>net.ipv4.tcp_early_retrans 值修改为 4，仅开启 TLP；</li>
<li>net.ipv4.tcp_early_retrans 值修改为 0，关闭 ER 以及 TLP。</li>
</ol>
<p>首先仅开启 TLP 的情况，继续测试在 SACK 开启的脚本。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -q net.ipv4.tcp_early_retrans=4
# sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 4
# 
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下，可以看到与默认值 3 的测试结果一致，说明了和 ER 重传无关，与 TLP 可能有关（严谨的说法，因为也有可能是某某重传引起）。</p>
<pre><code class="hljs language-plain" lang="plain"># tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
10:12:36.563494 tun0  In  IP 192.0.2.1.50647 &gt; 192.168.165.47.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
10:12:36.563526 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [S.], seq 3170095082, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
10:12:36.573627 tun0  In  IP 192.0.2.1.50647 &gt; 192.168.165.47.8080: Flags [.], ack 1, win 10000, length 0
10:12:36.673761 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:36.887178 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:37.103192 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:37.535174 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:38.399184 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:12:40.127180 tun0  Out IP 192.168.165.47.8080 &gt; 192.0.2.1.50647: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<p>继续关闭 TLP 的情况，仍然是测试 SACK 开启的脚本。</p>
<pre><code class="hljs language-plain" lang="plain"># sysctl -q net.ipv4.tcp_early_retrans=0
# sysctl -a|grep early_retrans
net.ipv4.tcp_early_retrans = 0
# 
</code></pre>
<p>执行脚本，同时通过 tcpdump 抓取数据包，现象如下，可以看到与关闭 SACK 的首次测试结果一致，标准的超时重传现象。对于关闭 TLP 和开启 TLP 的两次实验结果，可得知第一次重传数据包确实是 TLP 报文。</p>
<pre><code class="hljs language-plain" lang="plain"># tcpdump -i any -nn port 8080
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
10:17:24.423493 tun0  In  IP 192.0.2.1.35821 &gt; 192.168.117.180.8080: Flags [S], seq 0, win 10000, options [mss 1000,nop,nop,sackOK], length 0
10:17:24.423527 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [S.], seq 1548070828, ack 1, win 64240, options [mss 1460,nop,nop,sackOK], length 0
10:17:24.433632 tun0  In  IP 192.0.2.1.35821 &gt; 192.168.117.180.8080: Flags [.], ack 1, win 10000, length 0
10:17:24.533759 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:24.751193 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:25.183189 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:26.047181 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
10:17:27.775172 tun0  Out IP 192.168.117.180.8080 &gt; 192.0.2.1.35821: Flags [P.], seq 1:101, ack 1, win 64240, length 100: HTTP
#
</code></pre>
<h2 data-id="heading-4">问题总结</h2>
<p>实际上对于重传触发出来的原因，或者说重传的归类，远远不止众所周知的超时重传、快速重传这两种，后续再慢慢展开分享吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现矢量数据读写]]></title>    <link>https://juejin.cn/post/7590213554798428195</link>    <guid>https://juejin.cn/post/7590213554798428195</guid>    <pubDate>2026-01-03T08:13:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798428195" data-draft-id="7590292192988807208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现矢量数据读写"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T08:13:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现矢量数据读写
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T08:13:28.000Z" title="Sat Jan 03 2026 08:13:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>❝</strong>GIS 数据的读写作为一个基础操作，是每一个GISer的必修课。在使用<code>GDAL</code>读取矢量数据时，需要掌握其基本的数据结构与类型，了解常用的数据读取方法，这样开发时才会起到事半功倍的效果。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解<code>GDAL</code>实现矢量数据读写。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-0">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-1">2. 矢量数据读取接口</h2>
<p>在<code>GDAL</code>中，矢量数据模型遵循下图所示结构，<strong>数据驱动-&gt;数据源-&gt;图层-&gt;属性。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1638b36a0a8d49b4ac570b6cfe2bb8dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=YwTmJjiislGhwTTXbEu%2BjO77he8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>2.1. 获取数据源</strong></h2>
<p><code>GDAL</code>中可以使用<code>Open</code>方法直接打开数据源，进而读取图层数据。在GDAL Python API中，<code>Driver</code>和<code>Dataset</code> 类在Raster API文档中，既适用于矢量数据，也适用于栅格数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：用于打开数据源
参数：
    -utf8_path：字符串，数据源路径
    -update：布尔值类型，默认值False，是否以更新模式打开数据集（默认为只读模式）
返回值：返回数据集或者None
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">Open</span>(<span class="hljs-params">utf8_path,update=<span class="hljs-literal">False</span></span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f14b274d6a0e4530bb0ec8cdd6d168af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=oSm%2Fa0So1q04%2B2zkUHSTRk7eUsE%3D" alt="" loading="lazy"/></p>
<p>如下以只读模式打开<code>Shp</code>数据源。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dataSource</span> = ogr.Open(shpPath,<span class="hljs-literal">False</span>) <span class="hljs-comment"># False表示只读，True表示可写</span>
</code></pre>
<p>除了<code>ogr</code>的<code>Open</code>方法之外，也可以使用<code>gdal</code>模块的打开方法</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22bf2df4de5348b88effcab1588cc086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=q9G1Yo0GPnvYlLGbAVF3MPluZbc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>2.2. 获取图层</strong></h2>
<p><code>GDAL</code>获取图层的常用方法为<code>GetLayer</code>，该方法只有一个参数。<code>iLayer</code>值固定为0，对<code>shapefile</code>图层来说是可选项。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：从数据集获取图层
参数：
    -iLayer：整型或字符串，图层名称或者基于0的图层索引值。
返回值：返回图层或者None
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">GetLayer</span>(<span class="hljs-params">iLayer=<span class="hljs-number">0</span></span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65dee974c774438f94a654fa9d92bfda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=YV6KHhW4CM1kvRoqyEl6zViqCBc%3D" alt="" loading="lazy"/></p>
<p>获取数据集中索引值为0的图层。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取图层</span>
<span class="hljs-attr">layer</span> = dataSource.GetLayer(<span class="hljs-number">0</span>)
</code></pre>
<p>除了<code>GetLayer</code>方法之外，还有一个<code>GetLayerByIndex</code>方法用于获取图层。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：根据索引获取图层
参数：
    -index：整型，图层索引值。
返回值：返回图层或者None
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">GetLayerByIndex</span>(<span class="hljs-params">index</span>)
</code></pre>
<p>图层索引值处于<code>0</code>和<code>GetLayerCount() - 1</code>之间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/433259b061cd4c7c8cf5310df60fd27f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=ZyM1yNKuYnq%2BTWVigAaY5TXW6Ms%3D" alt="" loading="lazy"/></p>
<p>最后还有个<code>GetLayerCount</code>方法用于获取图层数量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97174e825fd489f8518634abf88e395~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=nBc2xA08iQiKVWEZhymA2a5cn3o%3D" alt="" loading="lazy"/></p>
<p>从数据集中获取图层数量。</p>
<pre><code class="hljs language-python" lang="python"> <span class="hljs-comment"># 获取图层数量</span>
layerCount = dataset.GetLayerCount()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"图层数量：<span class="hljs-subst">{layerCount}</span>"</span>)
</code></pre>
<h2 data-id="heading-4"><strong>2.3. 获取投影信息</strong></h2>
<p><code>GetProjection</code>和<code>GetProjectionRef</code>方法都可以用于读取坐标系统，两者都返回一个字符串类型<code>WKT</code>格式的数据集空间参考信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18cdee8a721d43dc96d00c890760ebd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=Gx%2FrytPpB9Fzp5PQjjzCa3rLepU%3D" alt="" loading="lazy"/></p>
<p>从图层获取投影信息。</p>
<pre><code class="hljs language-python" lang="python"> <span class="hljs-comment"># 图层投影</span>
projectionRef = layer.GetProjectionRef()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"空间参考：<span class="hljs-subst">{projectionRef}</span>"</span>)
</code></pre>
<p>此外还有一个方法<code>GetSpatialRef</code>也可用于获取数据集空间参考信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6815bc5806b844de908ebd36ed65ac3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=jjmSPRnHFgaiBO3DKHC%2FCMxfJAo%3D" alt="" loading="lazy"/></p>
<p>从图层获取空间参考信息。</p>
<pre><code class="hljs language-python" lang="python"> <span class="hljs-comment"># 图层空间参考</span>
spatialRef = layer.GetSpatialRef()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"空间参考：<span class="hljs-subst">{spatialRef}</span>"</span>)
</code></pre>
<h2 data-id="heading-5"><strong>2.4. 获取要素</strong></h2>
<p>在知道<code>FId</code>(要素编号)的情况下，可以直接使用<code>GetFeature</code>方法获取要素。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b1174d9b39b4d9d8f70f03b5dc86f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=eKVFoU5W%2BMcaWjJpsPP2l%2BtSSMY%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取指定要素</span>
<span class="hljs-attr">feature</span> = layer.GetFeature(<span class="hljs-number">0</span>)
</code></pre>
<p>也可以通过<code>GetNextFeature</code>方法遍历要素特征，并且返回一个要素<code>Feature</code>。此方法适用于少数几个<code>OGRLayer.GetNextFeature()</code>效率不高的驱动程序，但总体而言，<code>OGRLayer.GetNextFeature()</code>是一个更自然的API。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7655ad96e6324e188c36f5804a033123~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=d5CpoHkCpZZdBmWaEVq%2BQCNdJQ4%3D" alt="" loading="lazy"/></p>
<p>从图层读取要素特征。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取要素</span>
<span class="hljs-attr">feature</span> = layer.GetNextFeature()
<span class="hljs-attr">limitCount</span> = <span class="hljs-number">0</span>
 <span class="hljs-comment"># 限制打印前十个要素</span>
while feature and limitCount &lt; 10:
    print(f"打印第【{limitCount+1}】个要素")
</code></pre>
<p><code>GetFeatureCount</code>方法用于获取图层要素数量。</p>
<pre><code class="hljs language-python" lang="python"> <span class="hljs-comment"># 获取图层要素数量</span>
layerFeatureCount = layer.GetFeatureCount()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"要素数量：<span class="hljs-subst">{layerFeatureCount}</span>"</span>)
</code></pre>
<h2 data-id="heading-6"><strong>2.5. 获取属性结构</strong></h2>
<p><code>GetLayerDefn</code>方法用于获取图层属性表，返回要素定义信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3daaf88f78c481c9102b7a986ef4cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=G%2FS9M7ZNKZcDy%2BCmz89AWRov718%3D" alt="" loading="lazy"/></p>
<p>获取图层属性。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取图层属性</span>
<span class="hljs-attr">layerProperty</span> = layer.GetLayerDefn()
</code></pre>
<p><code>GetFieldCount</code>方法用于获取字段数量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6671f785e34f23882e6326b806fce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=KfVKVbqrElF2Jpowc3MGXzKyWnA%3D" alt="" loading="lazy"/></p>
<p>读取图层要素数量。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取图层名称</span>
<span class="hljs-attr">layerName</span> = layer.GetName()
 <span class="hljs-comment"># 获取图层要素数量</span>
<span class="hljs-attr">layerFeatureCount</span> = layer.GetFeatureCount()
</code></pre>
<p><code>GetFieldDefn</code>用于获取字段定义信息，其中包括字段名称，字段类型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e19f33e75e40ac9f50779d24b3bac4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=hHUcF8Nr4LdfOJNORulOAFhtoVY%3D" alt="" loading="lazy"/></p>
<p>读取属性表结构。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取图层属性</span>
<span class="hljs-attr">layerProperty</span> = layer.GetLayerDefn()
 <span class="hljs-comment"># 获取图层字段数量</span>
<span class="hljs-attr">fieldCount</span> = layerProperty.GetFieldCount()
print(f"字段数量：{fieldCount}")

 <span class="hljs-comment"># 获取字段信息</span>
for j in range(fieldCount):
    <span class="hljs-comment"># 获取字段属性对象</span>
    <span class="hljs-attr">fieldProperty</span> = layerProperty.GetFieldDefn(j)
    <span class="hljs-comment"># 获取字段属性名称</span>
    <span class="hljs-attr">fieldName</span> = fieldProperty.GetName()
    <span class="hljs-comment"># 获取字段属性类型</span>
    <span class="hljs-attr">fieldType</span> = fieldProperty.GetTypeName()

    print(f"第 【{j}】 个字段名称：{fieldName}，字段类型：{fieldType}")
</code></pre>
<p><code>GetField</code>用于获取属性字段值，参数可以是字符串字段名，也可以是字段索引值。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b7d4cc728e044a587d65e2da090c555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=llwHNuBdqIlTfTuowsbRJQwVjYo%3D" alt="" loading="lazy"/></p>
<p><code>GetGeometryRef</code>方法用于获取要素几何对象信息。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/215abfd682a546fbaa68385176db4184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=Aq4ev%2BNLGfiWf2vbxRkoxIU8gq4%3D" alt="" loading="lazy"/></p>
<p>读取几何对象。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 读取几何属性</span>
<span class="hljs-attr">geom</span> = feature.GetGeometryRef()
</code></pre>
<h2 data-id="heading-7"><strong>2.6. 获取图层范围</strong></h2>
<p><code>GetExtent</code>获取图层四至范围。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 获取范围</span>
<span class="hljs-attr">extent</span> = layer.GetExtent()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d6d1410aedc45a78fe16026d31b52cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=boETROS2Y2SCknA%2BOk%2B4LLi6uOM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">3. 矢量数据修改接口</h2>
<p><strong>Driver</strong>(驱动程序)是一个知道如何执行特定功能的对象与某种数据类型（如<code>shapefile</code>），为了读写数据，就需要一个合适的驱动程序。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87a6c91d3ad54b849c591f7af237e3f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=7zLTju4hWPGY016eNHoHnc82uHk%3D" alt="" loading="lazy"/></p>
<p>本文以下的数据修改都已<code>shapefile</code>驱动为例进行讲解。</p>
<h2 data-id="heading-9"><strong>3.1. 获取目标数据驱动</strong></h2>
<p>首先需要导入<code>ogr</code>模块用于处理矢量数据。<code>GetDriverByName</code>方法可以根据名称获取数据驱动。</p>
<pre><code class="hljs language-ini" lang="ini">from osgeo import ogr,osr

 <span class="hljs-comment"># 获取Shp数据驱动</span>
<span class="hljs-attr">shpDriver</span> = ogr.GetDriverByName(<span class="hljs-string">'ESRI Shapefile'</span>)
</code></pre>
<h2 data-id="heading-10"><strong>3.2. 创建数据源</strong></h2>
<p><code>CreateDataSource</code>方法根据文件路径创建数据源。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2e3c8c79c2f47d793e37bdc218fc13c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=BFJGfBrjKIcKB8x9H0GBnUrwk48%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 创建Shp数据源</span>
<span class="hljs-attr">shpDataSource</span> = shpDriver.CreateDataSource(shpPath)
</code></pre>
<h2 data-id="heading-11"><strong>3.3. 创建图层</strong></h2>
<p>通过<code>CreateLayer</code>方法创建图层，该方法具有四个参数，图层名称、坐标系统以及几何类型是必传。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12850c7cd14542f49ebcd6573d09f9a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=Bp5Dk6R0UPI%2BH1TF3EZvP6glGyM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 创建点图层</span>
<span class="hljs-attr">layer</span> = shpDataSource.CreateLayer(<span class="hljs-string">"points"</span>,srs,ogr.wkbPoint)
</code></pre>
<h2 data-id="heading-12"><strong>3.4. 创建属性字段</strong></h2>
<p>通过<code>CreateField</code>方法创建属性字段。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62bd13fe78274e329389faf844cba4b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=McGqsXBhdcANHFPh1ffFDOhZ7lM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">if field not in <span class="hljs-section">[lonField, latField]</span>:
    <span class="hljs-comment"># 创建字段定义</span>
    <span class="hljs-attr">fieldDefn</span> = ogr.FieldDefn(field, ogr.OFTString)
    fieldDefn.SetWidth(254)
    <span class="hljs-comment"># 直接创建字段，不要存储 FieldDefn 对象</span>
    layer.CreateField(fieldDefn)
</code></pre>
<h2 data-id="heading-13"><strong>3.5. 创建几何对象</strong></h2>
<p>要素对象方法<code>SetGeometry</code>可以创建几何对象。</p>
<pre><code class="hljs language-arduino" lang="arduino"> # 创建几何对象
point = ogr.<span class="hljs-built_in">Geometry</span>(ogr.wkbPoint)
point.<span class="hljs-built_in">AddPoint</span>(lon,lat)
feature.<span class="hljs-built_in">SetGeometry</span>(point)
</code></pre>
<h2 data-id="heading-14"><strong>3.6. 创建要素</strong></h2>
<p>通过图层方法<code>CreateFeature</code>创建要素。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 创建要素</span>
<span class="hljs-attr">feature</span> = ogr.Feature(layer.GetLayerDefn())

 <span class="hljs-comment"># 设置属性</span>
for field in fieldnames:
    if field not in <span class="hljs-section">[lonField, latField]</span>:
        feature.SetField(field, str(row<span class="hljs-section">[field]</span>))
 <span class="hljs-comment"># 创建几何</span>
<span class="hljs-attr">point</span> = ogr.Geometry(ogr.wkbPoint)
point.AddPoint(lon,lat)
feature.SetGeometry(point)

 <span class="hljs-comment"># 保存要素</span>
layer.CreateFeature(feature)
</code></pre>
<h2 data-id="heading-15">4. 关闭数据源</h2>
<p>为了防止内存泄露问题发生，在确定数据读取完成后需要关闭数据源。</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-comment"># 关闭数据源</span>
<span class="hljs-attr">dataSource</span> = None

 <span class="hljs-comment"># 关闭要素</span>
feature.Destroy()
 <span class="hljs-comment"># feature = None</span>
</code></pre>
<p>小提示</p>
<p><code>GDAL</code>中的方法采用大驼峰命名法</p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a22b17e405bf4df58c0efcfc3057b761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=LEgZykvjqMfgzWGqevs5GG2h7mo%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p><strong>❝</strong>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong><br/>
全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
<p><strong>❝<em>GIS之路</em></strong> 公众号已经接入了<strong>智能助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3947937cf2bc4152b92a1ad881d9d6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=Mx%2Fs8rzGsFgGnALslGzUES2SkXI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bc19458495f43d192ab944059fdd1fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768032807&amp;x-signature=sGp0cQ0n4OEen%2Bwy2MdH%2FFr88SM%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi77nCatd4V2nuybZFIs-xA" target="_blank" title="https://mp.weixin.qq.com/s/i77nCatd4V2nuybZFIs-xA" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAVXeDrd13EexedVqOdLuxA" target="_blank" title="https://mp.weixin.qq.com/s/AVXeDrd13EexedVqOdLuxA" ref="nofollow noopener noreferrer">百度宣布，良心画图工具停服！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fo7Kl8OpNngpvMa7oIkCPRQ" target="_blank" title="https://mp.weixin.qq.com/s/o7Kl8OpNngpvMa7oIkCPRQ" ref="nofollow noopener noreferrer">自然资源部：我国地理信息产业总产值将超9000亿元</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frk-Jxqnn5E9aXDxQiomIIg" target="_blank" title="https://mp.weixin.qq.com/s/rk-Jxqnn5E9aXDxQiomIIg" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 Shp 转换为 GeoJSON 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJg0-96t5C2CIlAB5K38kbw" target="_blank" title="https://mp.weixin.qq.com/s/Jg0-96t5C2CIlAB5K38kbw" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5lRetXg_dHYO-ZXKQnbi5Q" target="_blank" title="https://mp.weixin.qq.com/s/5lRetXg_dHYO-ZXKQnbi5Q" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上期方案太难？Antigravity桌面工具来了，5分钟白嫖Claude Opus 4.5]]></title>    <link>https://juejin.cn/post/7590213554798510115</link>    <guid>https://juejin.cn/post/7590213554798510115</guid>    <pubDate>2026-01-03T08:32:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798510115" data-draft-id="7590403249560666127" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上期方案太难？Antigravity桌面工具来了，5分钟白嫖Claude Opus 4.5"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T08:32:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上期方案太难？Antigravity桌面工具来了，5分钟白嫖Claude Opus 4.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T08:32:33.000Z" title="Sat Jan 03 2026 08:32:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.前言</h2>
<p>昨天给大家分享了《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUAA-8pEStyLVBqtSBIokCA" target="_blank" title="https://mp.weixin.qq.com/s/UAA-8pEStyLVBqtSBIokCA" ref="nofollow noopener noreferrer">白嫖Google Antigravity！Claude Opus 4.5免费用，告别token焦虑</a>》这篇文章，通过CLIProxyAPI项目实现了Google Antigravity的API反代部署。不少小伙伴反馈说方案确实不错，免费额度用起来很爽，但是部署过程有点复杂——需要安装Docker、拉取镜像、配置config.yaml、还要用EasyCLI客户端导出授权文件再导入后台......好家伙，对于不熟悉命令行操作的新手来说，这一套流程下来确实有点头大。</p>
<p>今天就给大家介绍一个更简单的方案——<strong>Antigravity-Manager</strong>（又名Antigravity Tools）。这是一款专业的AI账号管理与协议转换桌面应用程序，相比CLIProxyAPI的"命令行+Docker"部署方式，Antigravity Tools直接提供了可视化图形界面，支持一键OAuth授权、多账号管理、实时额度监控，整个配置过程鼠标点点就能搞定，对新手极其友好。更重要的是，它同时支持Windows和macOS平台，不管你用什么系统都能轻松上手。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56be24b0aa5242ae99f5b92d99f044e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=ru1XZ7tLRxHRL6AjKX9MFFfEgek%3D" alt="Antigravity-Manager应用界面图" loading="lazy"/></p>
<p>这2天Antigravity Tools在社区非常火爆（GitHub已有6.8k+ Stars），今天我们就手把手教大家如何安装配置这个工具，让你5分钟内就能在本地跑通Antigravity反代，在Cherry Studio、Claude Code等各种工具中畅快使用免费的Claude Opus 4.5和Gemini 3！</p>
<h2 data-id="heading-1">2.部署实战</h2>
<h3 data-id="heading-2">Antigravity-Manager安装</h3>
<p>我打开<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flbjlaq%2FAntigravity-Manager" target="_blank" title="https://github.com/lbjlaq/Antigravity-Manager" ref="nofollow noopener noreferrer">github.com/lbjlaq/Anti…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2171707e2a64595844c913f5bd9398c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=cdRD2nBo21PFHWA6x2ta9bBj9mM%3D" alt="image-20260103150159174" loading="lazy"/></p>
<p>找到最新版本下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flbjlaq%2FAntigravity-Manager%2Freleases%2Fdownload%2Fv3.3.13%2FAntigravity.Tools_3.3.13_x64-setup.exe" target="_blank" title="https://github.com/lbjlaq/Antigravity-Manager/releases/download/v3.3.13/Antigravity.Tools_3.3.13_x64-setup.exe" ref="nofollow noopener noreferrer">Antigravity.Tools_3.3.13_x64-setup.exe</a> 我这里使用windows平台安装包为案例，大家可以根据自己的操作系统选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5958b40cec654c30bb24c2205d45564f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=OsTLCv765cpZJ2KaGDWvZbReYEE%3D" alt="image-20260103150226859" loading="lazy"/></p>
<p>​        下载完成后点击安装即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b29ba02ed424b6da7bfd941b4557ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=k7PiKaRWO4S3i%2BvTBadMQIyzPdM%3D" alt="image-20260103150449452" loading="lazy"/></p>
<p>上面的截图就是刚刚安装好的Antigravity Tools 工具。</p>
<h3 data-id="heading-3">Antigravity-Manager配置</h3>
<p>我们点击账号管理，点击“添加账号”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d2cd465086542cdb96f21d954f67b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=sB5ucThBM4q3UTNtFP3V8frbFfA%3D" alt="image-20260103150818437" loading="lazy"/></p>
<p>弹出下面对话框</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fd3bcaa927f46af8f46834ecf5db20f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=6pYfwJrGyxjhsTcbMGxFoJ77rMg%3D" alt="image-20260103150842658" loading="lazy"/></p>
<p>​    工具提供三种授权方式，我们这里点击OAuth授权。点击“开始授权”安全打开浏览器授权google登录页面(我的浏览器已经授权登录过google账号)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c733cf3936847f6bab2b7e31c112e8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=bq98gV6SpqXc93Mu2isqBp3YwXg%3D" alt="image-20260103151102502" loading="lazy"/></p>
<p>因为我浏览器之前记录2个google 的账号，所以我这边点击授权。弹出“Google Antigravity” 授权页面，点击登录按钮</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/299f3f20842f429a904180d074b6a159~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=n4DJAiGbNiNMuDhHEvUCjXaGz9Y%3D" alt="image-20260102164054542" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7688788de0554807b55d9d82bc70e77c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=6mFBgeZ7h4Q2bGpGvprYATZzze8%3D" alt="image-20260103151217281" loading="lazy"/></p>
<p>完成授权。</p>
<p>这里需要注意的是由于Google 的限制，我们需要把自己的国家和地区改成非中国地区（包括香港），建议直接改美国。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpolicies.google.com%2Fterms%3Fhl%3Dzh_CN" target="_blank" title="https://policies.google.com/terms?hl=zh_CN" ref="nofollow noopener noreferrer">policies.google.com/terms?hl=zh…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/308277d5817d413b91f0eb7ff84e91e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=QRihgwT3Gl%2B67jsA6Gg0K3ET7ww%3D" alt="image-20260102164542133" loading="lazy"/></p>
<p>授权成功后我们看到Antigravity Tools 就看到管理账号授权界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/568e9f44d2ef412bbe3a1d2358efbb22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=6g18enUH0trp%2FFmkTXkc0hgtVWc%3D" alt="image-20260103151302153" loading="lazy"/></p>
<p>用同样的方法可以把手上的多个google账号授权成功。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c88a703791ce42b4a148402a159f208d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=hrbXZWC%2FIvarWH2Hx2Ud02Ogn%2Bs%3D" alt="image-20260103151424721" loading="lazy"/></p>
<p>这里我们很方便查看到账号授权模型使用额度。通过上面的方式我们就完成了Antigravity 反带了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798778e3bfd649c3966adb4ff69da3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=uXTslpDqzuv6h9ahclMW9oIgDIM%3D" alt="image-20260103151707409" loading="lazy"/></p>
<h3 data-id="heading-4">api反代介绍</h3>
<p>默认端口使用8045，允许局域网访问</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b057326da2d840b998e6adc3cee4fb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=M9oip4BnZXRE82H5Biwsb0KNGtw%3D" alt="image-20260103151955401" loading="lazy"/></p>
<p>模型路由中心 这里有简单模型对应映射，大家根据自己的需要选择</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8928c26b42c4f4eb9f453635e85898d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=B8lpy3t85ylHEBTjnb%2BeqzOWqls%3D" alt="image-20260103152246794" loading="lazy"/></p>
<p>模型列表详细列举出Antigravity 支持的所有模型</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d014be4961846c4aa4a0b1328f08440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=pjty4C50idet6cImoLdSoOE3%2FOk%3D" alt="image-20260103152359209" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a0248cdbdeb454ba50ac2286bb4881a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=7Fqt0mmAnzvgey15J67nl09VeH4%3D" alt="image-20260103152446805" loading="lazy"/></p>
<p>右边还非常贴心的显示openai 代理标准接口。下面我们使用第三方平台验证测试。</p>
<h2 data-id="heading-5">3.第三方平台使用</h2>
<p>接下来我们就可以在第三方平台上使用者这个免费的反带API 了</p>
<h3 data-id="heading-6">cherry stuido</h3>
<p>我们使用cherry stuido 这个第三方工具来测试验证一下反带的效果。</p>
<p>我们先在cherry stuido配置一下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bab412c835ea442691f5a40ca0a8bbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=5xPkALzynHmpGx0UuJ34%2F4g1hBg%3D" alt="image-20260103152832112" loading="lazy"/></p>
<p>填写api秘钥 api地址 我们填写本地地址<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8045" target="_blank" title="http://localhost:8045" ref="nofollow noopener noreferrer">http://localhost:8045</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11890e1f81a47d79b36879b4206c431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=PJqYGVbh0ZWF6Lt7i1SsmOOgJiQ%3D" alt="image-20260103153150219" loading="lazy"/></p>
<p>​      以上我们就完成了模型基本设置。</p>
<p>​      接下来我们在聊天对话中验证测试</p>
<p>​      选择gemini-3-flash-preview</p>
<p>​      <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f31407df14634fbcb00a724ada2c1a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=rO00nwzwxtWRoP%2F1VwK5xqBl20g%3D" alt="image-20260103153250961" loading="lazy"/></p>
<h3 data-id="heading-7">claude code 使用</h3>
<p>接下来我们使用本地claude code 来实现。这里配置我们使用cc-switch配置。关于cc-switch配置 配置不熟悉的可以看我之前的文章</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxuwAwfZZiYzKhnPVrvitug" target="_blank" title="https://mp.weixin.qq.com/s/xuwAwfZZiYzKhnPVrvitug" ref="nofollow noopener noreferrer">CC-Switch配置切换神器：5秒搞定多设备同步，坚果云让配置永不丢失</a>》</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be1ef5e463814a15bbe9ea3909aabdcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=8BJFF0qkSzMEU%2FYeLj8YgMtLYCw%3D" alt="image-20260103153433227" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85525e0383e3431b98cc46065912f64c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=oFITlcKOgK54MCGqQ7CShyXpe38%3D" alt="image-20260103153804368" loading="lazy"/></p>
<p>cc-switch完成后，我们启动本地claud code</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9440b30d092e44cb8562f0a82dd9aef3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=aeNWA87NVN98BbpNF9MOjn8l%2B7A%3D" alt="image-20260103153551699" loading="lazy"/></p>
<p>我们验证测试一下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/266dd60618514d4b95d93d1852588190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=Uccj6TB1rxqPDqQ9NHOOdnLm1GE%3D" alt="image-20260103153638147" loading="lazy"/></p>
<p>OK  默认使用了claude-sonnet-4-5 模型来运行的。</p>
<h2 data-id="heading-8">4.一些常见问题</h2>
<h3 data-id="heading-9">网络代理的问题</h3>
<p>由于Antigravity Tools 是客户端工具，在本地运行。所以本地的网络需要通过一些网络代理设置，我这里开启了tun模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28672d4376274818a420fddedd8d2c24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=a7FTCp3xgI2dkovwuiQGbEFEJHU%3D" alt="image-20260103154051894" loading="lazy"/></p>
<p>如果使用上期文章中介绍的CLIProxyAPI方式，把CLIProxyAPI部署到服务器上，这样本地网络就不需要这样设置了。</p>
<h3 data-id="heading-10">模型额度的问题</h3>
<p>默认情况下google 是5个小时重置一次额度，如果你额度用完了可以换个模型或则多个账号使用，如果账号额度都用完了就等5个小时之后重置了。额度可以在面板中查看到</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af627668c0b54d5ebfcbc33b79207eff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768033953&amp;x-signature=UMhOhauXP%2B2EE%2Fb2U%2BEDn3GCi50%3D" alt="image-20260103154435393" loading="lazy"/></p>
<h2 data-id="heading-11">5.总结</h2>
<p>今天主要带大家了解并实现了Antigravity Tools桌面应用的完整部署流程，该工具以"可视化界面+一键OAuth授权"为核心优势，结合开发者对顶级大模型免费使用的强烈需求，通过图形化的账号管理面板与内置API反代服务，形成了一套从Google账号授权到标准API调用的全链路白嫖方案。相比昨天介绍的CLIProxyAPI方案，Antigravity Tools无需Docker环境、无需命令行操作、无需手动导入导出授权文件，整个配置过程鼠标点击即可完成，5分钟内就能跑通反代服务，对新手极其友好。</p>
<p>在实际应用中，两种方案各有所长——CLIProxyAPI适合有服务器、需要远程部署、团队共享使用的场景，支持将反代服务部署到云端供多人访问；而Antigravity Tools则更适合个人使用、本地运行、追求简单易用的场景，提供了实时额度监控、多账号一键切换、智能模型路由等贴心功能。特别值得一提的是，Antigravity Tools的仪表盘可以直观查看所有账号的配额使用情况，再也不用担心额度用超了才发现。需要注意的是，由于Antigravity Tools是本地客户端，网络需要开启代理（建议TUN模式），同时Google账号地区需设置为美国等非受限地区才能正常使用。</p>
<p>感兴趣的小伙伴可以根据自己的实际需求选择合适的方案——追求简单就用Antigravity Tools，需要远程部署就用CLIProxyAPI，两个方案搭配使用效果更佳。今天的分享就到这里结束了，我们下一篇文章见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 父子组件双向绑定的终极指南：告别数据同步烦恼！]]></title>    <link>https://juejin.cn/post/7590469811408830491</link>    <guid>https://juejin.cn/post/7590469811408830491</guid>    <pubDate>2026-01-03T05:08:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590469811408830491" data-draft-id="7590292138347069450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 父子组件双向绑定的终极指南：告别数据同步烦恼！"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-03T05:08:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 父子组件双向绑定的终极指南：告别数据同步烦恼！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T05:08:27.000Z" title="Sat Jan 03 2026 05:08:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 父子组件双向绑定的终极指南：告别数据同步烦恼！</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/530c134e2a6a486b912cc273e384633f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768021707&amp;x-signature=JU8Tp9StTfefsHjDR3UkZpXWCso%3D" alt="Vue父子组件绑定头图" loading="lazy"/></p>
<h3 data-id="heading-1">引言</h3>
<p>在Vue开发中，父子组件之间的数据通信是每个开发者都会遇到的挑战。当父组件需要控制子组件状态，同时子组件也需要更新父组件数据时，如何优雅地实现双向绑定就成了关键问题。</p>
<p>今天，我将为你详细介绍Vue中实现父子组件双向绑定的4种核心方法，从基础到高级，让你彻底掌握这一重要技能！</p>
<h3 data-id="heading-2">一、基础知识：单向数据流原则</h3>
<p>在深入解决方案之前，我们先理解Vue的核心设计原则——单向数据流：</p>
<pre><code class="hljs">父组件 → Props → 子组件
子组件 → Events → 父组件
</code></pre>
<p>这种设计保证了数据流向的可预测性，但当我们确实需要双向绑定时，就需要一些技巧来实现。</p>
<h3 data-id="heading-3">二、方法一：Props + $emit（基础方法）</h3>
<p>这是Vue官方推荐的"单向数据流"实现双向绑定的标准方式。</p>
<h4 data-id="heading-4">实现原理</h4>
<ol>
<li>父组件通过props向子组件传递数据</li>
<li>子组件通过$emit触发事件通知父组件更新数据</li>
</ol>
<h4 data-id="heading-5">代码实现</h4>
<p><strong>子组件 ChildComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="child"&gt;
    &lt;h3&gt;子组件&lt;/h3&gt;
    &lt;input 
      :value="value" 
      @input="$emit('update:value', $event.target.value)"
      placeholder="输入内容..."
    /&gt;
    &lt;p&gt;当前值: {{ value }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'ChildComponent',
  props: {
    value: {
      type: String,
      required: true
    }
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>父组件 ParentComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="parent"&gt;
    &lt;h2&gt;父组件&lt;/h2&gt;
    &lt;p&gt;父组件中的值: {{ parentValue }}&lt;/p&gt;
    
    &lt;ChildComponent 
      :value="parentValue" 
      @update:value="parentValue = $event"
    /&gt;
    
    &lt;button @click="resetValue"&gt;重置为默认值&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import ChildComponent from './ChildComponent.vue'

export default {
  name: 'ParentComponent',
  components: {
    ChildComponent
  },
  data() {
    return {
      parentValue: '初始值'
    }
  },
  methods: {
    resetValue() {
      this.parentValue = '默认值'
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-6">流程图解</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[父组件数据变更] --&gt; B[Props传递给子组件]
    B --&gt; C[子组件接收数据]
    D[子组件用户输入] --&gt; E[$emit触发更新事件]
    E --&gt; F[父组件监听并更新数据]
    F --&gt; A
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style F fill:#e8f5e8
</code></pre>
<h4 data-id="heading-7">优缺点分析</h4>
<p><strong>优点：</strong></p>
<ul>
<li>符合Vue设计哲学</li>
<li>代码清晰，数据流向明确</li>
<li>易于调试和维护</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要编写较多样板代码</li>
<li>对于深层嵌套组件略显繁琐</li>
</ul>
<h3 data-id="heading-8">三、方法二：v-model指令（语法糖）</h3>
<p>Vue 2.2.0+ 提供了<code>.sync</code>修饰符的替代方案，使用自定义组件的<code>v-model</code>。</p>
<h4 data-id="heading-9">实现原理</h4>
<p><code>v-model</code>在组件上实际上是以下写法的语法糖：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;ChildComponent 
  :value="parentValue"
  @input="parentValue = $event"
/&gt;
</code></pre>
<h4 data-id="heading-10">代码实现</h4>
<p><strong>子组件 ChildComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="child"&gt;
    &lt;h3&gt;子组件 (v-model)&lt;/h3&gt;
    &lt;select :value="value" @change="$emit('input', $event.target.value)"&gt;
      &lt;option value="vue"&gt;Vue.js&lt;/option&gt;
      &lt;option value="react"&gt;React&lt;/option&gt;
      &lt;option value="angular"&gt;Angular&lt;/option&gt;
    &lt;/select&gt;
    &lt;p&gt;选中的框架: {{ value }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'ChildComponent',
  props: {
    value: {
      type: String,
      required: true
    }
  },
  model: {
    prop: 'value',    // 指定v-model绑定的prop名
    event: 'input'    // 指定v-model监听的事件名
  }
}
&lt;/script&gt;
</code></pre>
<p><strong>父组件 ParentComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="parent"&gt;
    &lt;h2&gt;父组件 (v-model示例)&lt;/h2&gt;
    &lt;p&gt;选择的框架: {{ selectedFramework }}&lt;/p&gt;
    
    &lt;!-- 使用v-model语法糖 --&gt;
    &lt;ChildComponent v-model="selectedFramework" /&gt;
    
    &lt;!-- 等价于 --&gt;
    &lt;!-- &lt;ChildComponent :value="selectedFramework" @input="selectedFramework = $event" /&gt; --&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import ChildComponent from './ChildComponent.vue'

export default {
  name: 'ParentComponent',
  components: {
    ChildComponent
  },
  data() {
    return {
      selectedFramework: 'vue'
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-11">多个v-model绑定（Vue 2.3.0+）</h4>
<p>从Vue 2.3.0开始，可以通过<code>model</code>选项配置不同的prop和event，但在Vue 3中更加简化：</p>
<p><strong>Vue 3中的多个v-model</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 父组件 --&gt;
&lt;UserName
  v-model:first-name="firstName"
  v-model:last-name="lastName"
/&gt;

&lt;!-- 子组件 --&gt;
&lt;script setup&gt;
defineProps({
  firstName: String,
  lastName: String
})

defineEmits(['update:firstName', 'update:lastName'])
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-12">四、方法三：.sync修饰符（Vue 2.3.0+）</h3>
<p><code>.sync</code>修饰符是另一种语法糖，用于实现prop的"双向绑定"。</p>
<h4 data-id="heading-13">实现原理</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 使用.sync --&gt;
&lt;ChildComponent :title.sync="pageTitle" /&gt;

&lt;!-- 等价于 --&gt;
&lt;ChildComponent 
  :title="pageTitle" 
  @update:title="pageTitle = $event"
/&gt;
</code></pre>
<h4 data-id="heading-14">代码实现</h4>
<p><strong>子组件 ChildComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="child"&gt;
    &lt;h3&gt;子组件 (.sync修饰符)&lt;/h3&gt;
    &lt;div class="counter"&gt;
      &lt;button @click="decrement"&gt;-&lt;/button&gt;
      &lt;span&gt;{{ count }}&lt;/span&gt;
      &lt;button @click="increment"&gt;+&lt;/button&gt;
    &lt;/div&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'ChildComponent',
  props: {
    count: {
      type: Number,
      required: true
    }
  },
  methods: {
    increment() {
      this.$emit('update:count', this.count + 1)
    },
    decrement() {
      this.$emit('update:count', this.count - 1)
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.counter {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}
.counter button {
  padding: 5px 15px;
  font-size: 16px;
}
&lt;/style&gt;
</code></pre>
<p><strong>父组件 ParentComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="parent"&gt;
    &lt;h2&gt;父组件 (.sync示例)&lt;/h2&gt;
    &lt;p&gt;当前计数: {{ counter }}&lt;/p&gt;
    
    &lt;!-- 使用.sync修饰符 --&gt;
    &lt;ChildComponent :count.sync="counter" /&gt;
    
    &lt;!-- 可以同时绑定多个prop --&gt;
    &lt;!-- &lt;ChildComponent :count.sync="counter" :title.sync="pageTitle" /&gt; --&gt;
    
    &lt;button @click="counter = 0"&gt;重置计数&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import ChildComponent from './ChildComponent.vue'

export default {
  name: 'ParentComponent',
  components: {
    ChildComponent
  },
  data() {
    return {
      counter: 0
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">.sync与v-model的区别</h4>






























<table><thead><tr><th>特性</th><th>v-model</th><th>.sync修饰符</th></tr></thead><tbody><tr><td>绑定数量</td><td>一个组件通常一个</td><td>可以多个</td></tr><tr><td>事件名</td><td>默认<code>input</code></td><td><code>update:propName</code></td></tr><tr><td>Prop名</td><td>默认<code>value</code></td><td>任意prop名</td></tr><tr><td>Vue 3支持</td><td>有变化</td><td>已移除，用v-model代替</td></tr></tbody></table>
<h3 data-id="heading-16">五、方法四：Vuex状态管理（复杂场景）</h3>
<p>对于大型应用或深层嵌套组件，使用Vuex进行状态管理是最佳选择。</p>
<h4 data-id="heading-17">实现架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[组件] --&gt; B[触发Action]
    B --&gt; C[提交Mutation]
    C --&gt; D[更新State]
    D --&gt; E[响应式更新所有组件]
    
    subgraph "Vuex Store"
        C
        D
    end
    
    style D fill:#fff3e0
    style E fill:#e8f5e8
</code></pre>
<h4 data-id="heading-18">代码实现</h4>
<p><strong>store/index.js</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">userSettings</span>: {
      <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
      <span class="hljs-attr">notifications</span>: <span class="hljs-literal">true</span>
    }
  },
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-title function_">UPDATE_SETTING</span>(<span class="hljs-params">state, { key, value }</span>) {
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> state.<span class="hljs-property">userSettings</span>) {
        state.<span class="hljs-property">userSettings</span>[key] = value
      }
    },
    <span class="hljs-title function_">UPDATE_SETTINGS</span>(<span class="hljs-params">state, settings</span>) {
      state.<span class="hljs-property">userSettings</span> = { ...state.<span class="hljs-property">userSettings</span>, ...settings }
    }
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">updateSetting</span>(<span class="hljs-params">{ commit }, payload</span>) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'UPDATE_SETTING'</span>, payload)
    },
    <span class="hljs-title function_">resetSettings</span>(<span class="hljs-params">{ commit }</span>) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'UPDATE_SETTINGS'</span>, {
        <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">notifications</span>: <span class="hljs-literal">true</span>
      })
    }
  },
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">userSettings</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">userSettings</span>,
    <span class="hljs-attr">darkMode</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">userSettings</span>.<span class="hljs-property">theme</span> === <span class="hljs-string">'dark'</span>
  }
})
</code></pre>
<p><strong>子组件 SettingsEditor.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="settings-editor" :class="settings.theme"&gt;
    &lt;h3&gt;设置编辑器 (Vuex)&lt;/h3&gt;
    
    &lt;div class="setting-item"&gt;
      &lt;label&gt;主题模式：&lt;/label&gt;
      &lt;select :value="settings.theme" @change="updateSetting('theme', $event.target.value)"&gt;
        &lt;option value="light"&gt;浅色&lt;/option&gt;
        &lt;option value="dark"&gt;深色&lt;/option&gt;
      &lt;/select&gt;
    &lt;/div&gt;
    
    &lt;div class="setting-item"&gt;
      &lt;label&gt;字体大小：&lt;/label&gt;
      &lt;input 
        type="range" 
        min="10" 
        max="24" 
        :value="settings.fontSize"
        @input="updateSetting('fontSize', parseInt($event.target.value))"
      /&gt;
      &lt;span&gt;{{ settings.fontSize }}px&lt;/span&gt;
    &lt;/div&gt;
    
    &lt;div class="setting-item"&gt;
      &lt;label&gt;
        &lt;input 
          type="checkbox" 
          :checked="settings.notifications"
          @change="updateSetting('notifications', $event.target.checked)"
        /&gt;
        启用通知
      &lt;/label&gt;
    &lt;/div&gt;
    
    &lt;p&gt;当前主题: {{ settings.theme }} | 字体大小: {{ settings.fontSize }}px&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import { mapState, mapActions } from 'vuex'

export default {
  name: 'SettingsEditor',
  computed: {
    ...mapState(['userSettings']),
    settings() {
      return this.userSettings
    }
  },
  methods: {
    ...mapActions(['updateSetting'])
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.settings-editor {
  padding: 20px;
  border-radius: 8px;
  transition: all 0.3s;
}
.settings-editor.light {
  background-color: #ffffff;
  color: #333333;
}
.settings-editor.dark {
  background-color: #333333;
  color: #ffffff;
}
.setting-item {
  margin: 15px 0;
}
.setting-item label {
  margin-right: 10px;
}
&lt;/style&gt;
</code></pre>
<p><strong>父组件 ParentComponent.vue</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="parent"&gt;
    &lt;h2&gt;父组件 (Vuex示例)&lt;/h2&gt;
    
    &lt;div class="settings-display"&gt;
      &lt;h3&gt;当前设置&lt;/h3&gt;
      &lt;ul&gt;
        &lt;li&gt;主题: {{ userSettings.theme }}&lt;/li&gt;
        &lt;li&gt;字体大小: {{ userSettings.fontSize }}px&lt;/li&gt;
        &lt;li&gt;通知: {{ userSettings.notifications ? '开启' : '关闭' }}&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
    
    &lt;SettingsEditor /&gt;
    
    &lt;div class="actions"&gt;
      &lt;button @click="resetSettings"&gt;恢复默认设置&lt;/button&gt;
      &lt;button @click="toggleTheme"&gt;切换主题&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import { mapState, mapActions, mapGetters } from 'vuex'
import SettingsEditor from './SettingsEditor.vue'

export default {
  name: 'ParentComponent',
  components: {
    SettingsEditor
  },
  computed: {
    ...mapState(['userSettings']),
    ...mapGetters(['darkMode'])
  },
  methods: {
    ...mapActions(['updateSetting', 'resetSettings']),
    toggleTheme() {
      const newTheme = this.darkMode ? 'light' : 'dark'
      this.updateSetting({ key: 'theme', value: newTheme })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-19">六、方法对比与选择指南</h3>
<h4 data-id="heading-20">方法对比表</h4>













































<table><thead><tr><th>方法</th><th>适用场景</th><th>优点</th><th>缺点</th><th>Vue 2支持</th><th>Vue 3支持</th></tr></thead><tbody><tr><td>Props + $emit</td><td>简单父子通信</td><td>官方推荐，清晰易懂</td><td>代码量多</td><td>✓</td><td>✓</td></tr><tr><td>v-model</td><td>表单类组件</td><td>语法简洁，使用广泛</td><td>单个绑定有限制</td><td>✓</td><td>✓ (增强)</td></tr><tr><td>.sync修饰符</td><td>多个prop需要双向绑定</td><td>支持多个绑定</td><td>Vue 3已移除</td><td>✓</td><td>✗</td></tr><tr><td>Vuex</td><td>复杂应用/多组件共享</td><td>集中管理，响应式</td><td>增加复杂度</td><td>✓</td><td>✓</td></tr></tbody></table>
<h4 data-id="heading-21">选择流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开始选择双向绑定方案] --&gt; B{数据共享范围}
    
    B --&gt;|父子组件| C{绑定复杂度}
    B --&gt;|多个组件共享| D[使用Vuex/Pinia]
    
    C --&gt;|简单绑定| E{vue版本?}
    C --&gt;|多个prop绑定| F{Vue版本?}
    
    E --&gt;|Vue 2| G[Props + $emit 或 v-model]
    E --&gt;|Vue 3| H[v-model]
    
    F --&gt;|Vue 2| I[.sync修饰符]
    F --&gt;|Vue 3| J[多个v-model]
    
    G --&gt; K[完成选择]
    H --&gt; K
    I --&gt; K
    J --&gt; K
    D --&gt; K
</code></pre>
<h3 data-id="heading-22">七、实战技巧与最佳实践</h3>
<h4 data-id="heading-23">1. 使用计算属性优化</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  props: ['value'],
  computed: {
    internalValue: {
      get() {
        return this.value
      },
      set(newValue) {
        this.$emit('input', newValue)
      }
    }
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;input v-model="internalValue" /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-24">2. 深度监听对象变化</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  props: {
    config: {
      type: Object,
      required: true
    }
  },
  watch: {
    config: {
      handler(newVal) {
        // 处理对象变化
        this.$emit('update:config', { ...newVal })
      },
      deep: true
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-25">3. 使用Provide/Inject处理深层嵌套</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 祖先组件 --&gt;
&lt;script&gt;
export default {
  provide() {
    return {
      sharedState: this.sharedState,
      updateSharedState: this.updateSharedState
    }
  },
  data() {
    return {
      sharedState: {
        theme: 'light',
        language: 'zh'
      }
    }
  },
  methods: {
    updateSharedState(key, value) {
      this.sharedState[key] = value
    }
  }
}
&lt;/script&gt;

&lt;!-- 深层子组件 --&gt;
&lt;script&gt;
export default {
  inject: ['sharedState', 'updateSharedState'],
  methods: {
    changeTheme(theme) {
      this.updateSharedState('theme', theme)
    }
  }
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-26">八、Vue 3的Composition API新玩法</h3>
<p>Vue 3的Composition API为双向绑定带来了更灵活的解决方案：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件 --&gt;
&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps(['modelValue'])
const emit = defineEmits(['update:modelValue'])

const value = computed({
  get: () =&gt; props.modelValue,
  set: (newValue) =&gt; emit('update:modelValue', newValue)
})
&lt;/script&gt;

&lt;template&gt;
  &lt;input v-model="value" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-27">总结</h3>
<p>掌握Vue父子组件双向绑定的多种方法，能让你在不同场景下选择最合适的解决方案：</p>
<ol>
<li><strong>简单场景</strong>：使用Props + $emit，保持代码清晰</li>
<li><strong>表单组件</strong>：使用v-model，提高开发效率</li>
<li><strong>多个绑定</strong>：Vue 2用.sync，Vue 3用多个v-model</li>
<li><strong>复杂应用</strong>：使用Vuex/Pinia，集中管理状态</li>
</ol>
<p>记住，没有绝对的最佳方案，只有最适合当前场景的选择。希望这篇文章能帮助你在Vue开发中游刃有余地处理组件通信问题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI设计类产品分析：Lovart]]></title>    <link>https://juejin.cn/post/7590213554798313507</link>    <guid>https://juejin.cn/post/7590213554798313507</guid>    <pubDate>2026-01-03T06:14:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798313507" data-draft-id="7590159073989787700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI设计类产品分析：Lovart"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T06:14:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="听风说图"/> <meta itemprop="url" content="https://juejin.cn/user/198345371681864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI设计类产品分析：Lovart
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/198345371681864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    听风说图
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T06:14:37.000Z" title="Sat Jan 03 2026 06:14:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>核心观点</strong>：AI 设计类产品的两大核心壁垒——<strong>矢量渲染引擎是底座，结构化转换是灵魂</strong>。AI 大模型本身不是护城河。</p>
<hr/>
<h2 data-id="heading-0">1. 核心结论（先说结论）</h2>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────┐
│           用户感知层（产品体验）                      │
├─────────────────────────────────────────────────────┤
│     结构化转换层（灵魂）                             │  ← 决定<span class="hljs-string">"好不好用"</span>
│     - 混沌 AI 输出 → 语义化图层树                   │
│     - 静态布局 → 响应式约束                         │
│     - 位图 → 可编辑矢量                             │
├─────────────────────────────────────────────────────┤
│     矢量渲染引擎（底座）                             │  ← 决定<span class="hljs-string">"能不能做"</span>
│     - 路径渲染 / 图层混合 / <span class="hljs-number">60f</span>ps 性能              │
│     - 所有上层能力的物理承载                         │
├─────────────────────────────────────────────────────┤
│     AI 生成模型（水电煤）                            │  ← 可购买，非壁垒
│     - Sora / Midjourney / Veo 等                   │
└─────────────────────────────────────────────────────┘
</code></pre>
<p><strong>一句话总结</strong>：</p>
<p><strong>铁打的引擎，流水的模型。</strong> 用户住的是房子（渲染引擎），不是水电煤（AI 模型）。而结构化转换层决定了房子住得舒不舒服。</p>
<hr/>
<h2 data-id="heading-1">2. Lovart 简介</h2>
<p><strong>Lovart</strong> 是一款定位为「AI 设计智能体（Design Agent）」的产品，由 Resonate International INC 开发。其核心能力是将用户的自然语言需求，自动转化为专业级的设计产出（图像、视频、3D 等）。</p>
<ul>
<li><strong>官网</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lovart.ai" target="_blank" title="https://www.lovart.ai" ref="nofollow noopener noreferrer">www.lovart.ai</a></li>
<li><strong>定位</strong>：全球首个 AI 设计智能体</li>
<li><strong>Slogan</strong>：「让设计更加智能，让交付更加高效」</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 产品架构分析</h2>
<p>Lovart 的产品架构可以分为三层：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    用户交互层 (UI)                           │
│         自然语言输入 → 实时画布渲染 → 可视化编辑              │
├─────────────────────────────────────────────────────────────┤
│                  结构化转换层 (灵魂)                         │
│       AI 输出解析 | 图层分离 | 布局推断 | 语义理解            │
├─────────────────────────────────────────────────────────────┤
│                   AI 模型聚合层 (水电煤)                     │
│   Sora2 | Veo3<span class="hljs-selector-class">.1</span> | Midjourney | Kling | Hailuo | Seedream  │
├─────────────────────────────────────────────────────────────┤
│                   矢量渲染引擎层 (底座)                      │
│         矢量渲染 | 图层管理 | 实时预览 | 导出交付             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">关键洞察</h3>
<p><strong>Lovart 并没有自研大部分 AI 生成模型</strong>——它聚合了市面上几乎所有顶级的图像/视频生成模型（Sora、Veo、Midjourney、Kling、Hailuo 等），通过统一的 API 调用提供给用户。</p>
<p>这意味着：<strong>AI 生成能力是「可购买」的标准化服务，不是 Lovart 的护城河。</strong></p>
<hr/>
<h2 data-id="heading-4">4. 壁垒一：矢量渲染引擎（底座）</h2>
<p><strong>没有渲染引擎，一切都是空中楼阁。</strong></p>
<h3 data-id="heading-5">4.1 为什么是「底座」？</h3>





























<table><thead><tr><th>挑战</th><th>说明</th></tr></thead><tbody><tr><td><strong>工程复杂度</strong></td><td>专业级设计软件需要处理矢量路径、布局约束、图层混合、渐变/阴影等，工程量巨大</td></tr><tr><td><strong>性能要求</strong></td><td>实时预览需要 60fps 流畅渲染，对 WebGL/WebGPU 有极高要求</td></tr><tr><td><strong>交互体验</strong></td><td>拖拽、缩放、对齐等交互需要毫秒级响应，前端优化深度决定用户体验</td></tr><tr><td><strong>格式兼容</strong></td><td>需要支持与 Figma、Sketch、Adobe 等工具的格式互通</td></tr><tr><td><strong>长期积累</strong></td><td>这类技术无法靠资金快速堆积，需要团队长期沉淀</td></tr></tbody></table>
<h3 data-id="heading-6">4.2 可替代性分析</h3>



































<table><thead><tr><th>环节</th><th>技术实现</th><th>可替代性</th></tr></thead><tbody><tr><td>AI 生成</td><td>调用第三方 API（Sora、Midjourney 等）</td><td><strong>极高</strong>，任何人都可以接入</td></tr><tr><td>自然语言理解</td><td>LLM（GPT 等）</td><td><strong>极高</strong>，标准化 API</td></tr><tr><td><strong>实时画布渲染</strong></td><td>自研前端矢量引擎</td><td><strong>极低</strong>，需要大量工程投入</td></tr><tr><td><strong>图层编辑系统</strong></td><td>自研图层管理</td><td><strong>极低</strong>，专业级设计软件门槛</td></tr><tr><td><strong>设计元素组合</strong></td><td>布局/对齐/变换系统</td><td><strong>极低</strong>，Figma 级的工程复杂度</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">5. 壁垒二：结构化转换层（灵魂）</h2>
<p><strong>渲染引擎决定「能不能做」，结构化转换决定「好不好用」。</strong></p>
<h3 data-id="heading-8">5.1 核心问题：AI 输出 ≠ 可编辑设计稿</h3>
<p>很多人假设 AI 生成的内容可以直接进入引擎编辑，但实际上：</p>





















<table><thead><tr><th>AI 输出</th><th>渲染引擎需要</th></tr></thead><tbody><tr><td>位图（Pixels）</td><td>结构化矢量路径</td></tr><tr><td>杂乱的 SVG</td><td>清晰的图层树</td></tr><tr><td>无语义的像素块</td><td>带命名的组件/约束</td></tr></tbody></table>
<h3 data-id="heading-9">5.2 真正的技术深水区</h3>
<p><strong>不仅仅是「渲染」，而是「如何将 AI 的混沌输出瞬间转化为有序的图层结构」</strong>：</p>
<pre><code class="hljs language-css" lang="css">AI 生成结果 → <span class="hljs-selector-attr">[结构化转换层]</span> → 可编辑的设计稿
                    ↑
              这里才是灵魂
</code></pre>
<p>核心能力包括：</p>
<ul>
<li><strong>自动矢量化</strong>：位图 → 可编辑矢量路径</li>
<li><strong>自动图层分离</strong>：混沌像素 → 语义化图层树</li>
<li><strong>自动建立约束</strong>：静态布局 → AutoLayout 响应式结构</li>
<li><strong>自动命名/分组</strong>：无序元素 → 符合设计规范的组件</li>
</ul>
<p><strong>这才是让设计师觉得「好用」的关键</strong>——用户不是想要一张图，而是想要一个<strong>可以继续编辑的设计稿</strong>。</p>
<hr/>
<h2 data-id="heading-10">6. 为什么 AI 模型不是壁垒？</h2>
<ol>
<li><strong>模型同质化</strong>：Sora、Veo、Midjourney 等模型的 API 对所有人开放，成本差异仅在于规模效应。</li>
<li><strong>模型迭代快</strong>：今天的最强模型，3 个月后可能被新模型超越。押注单一模型是高风险策略。</li>
<li><strong>用户无感知</strong>：用户不关心后端用的是 Sora 还是 Veo，只关心最终产出的质量和可用性。</li>
</ol>
<p>Lovart 的聪明之处在于：<strong>做模型的「聚合者」而非「自研者」</strong>，将精力聚焦在用户真正能感知到的前端体验上。</p>
<hr/>
<h2 data-id="heading-11">7. 商业模式验证</h2>
<p>Lovart 的订阅定价印证了上述分析：</p>






























<table><thead><tr><th>套餐</th><th>月费</th><th>核心卖点</th></tr></thead><tbody><tr><td>Starter</td><td>$16/月</td><td>2000 积分，2 并发</td></tr><tr><td>Basic</td><td>$27/月</td><td>3500 积分，4 并发</td></tr><tr><td>Pro</td><td>$45/月</td><td>11000 积分，8 并发</td></tr><tr><td>Ultimate</td><td>$99/月</td><td>27000 积分，10 并发</td></tr></tbody></table>
<p><strong>注意</strong>：Lovart 的积分是用来消耗 AI 模型调用的（即可变成本），而订阅费用的核心是为了支撑其<strong>前端产品体验的持续迭代</strong>。</p>
<hr/>
<h2 data-id="heading-12">8. 对 FigDev 的启示</h2>
<h3 data-id="heading-13">8.1 我们的优势</h3>
<p>FigDev 的技术路线与「底座 + 灵魂」的成功逻辑高度契合：</p>









































<table><thead><tr><th>壁垒类型</th><th>FigDev 的对应能力</th></tr></thead><tbody><tr><td><strong>矢量渲染引擎（底座）</strong></td><td>WebGPU 自研矢量渲染引擎</td></tr><tr><td>实时画布渲染</td><td><code>flare/ecs</code> + ECS 架构</td></tr><tr><td>图层编辑系统</td><td>Figma 视图层实现</td></tr><tr><td>设计元素组合</td><td>AutoLayout (yoga-layout)</td></tr><tr><td><strong>结构化转换层（灵魂）</strong></td><td><code>dataTransformation</code> 模块</td></tr><tr><td>Figma JSON → ECS 节点</td><td>已实现</td></tr><tr><td>矢量路径解析</td><td><code>svgPathParser</code></td></tr><tr><td>自动布局约束</td><td><code>AutoLayoutSys</code></td></tr></tbody></table>
<h3 data-id="heading-14">8.2 战略建议</h3>






























<table><thead><tr><th>优先级</th><th>策略</th><th>说明</th></tr></thead><tbody><tr><td>⭐⭐⭐</td><td><strong>深耕渲染引擎</strong></td><td>60fps、复杂路径、渐变填充等「难啃的骨头」才是真正的壁垒</td></tr><tr><td>⭐⭐⭐</td><td><strong>扩展转换层</strong></td><td>将 <code>dataTransformation</code> 能力扩展到「AI 输出 → 结构化设计稿」场景</td></tr><tr><td>⭐⭐</td><td><strong>自研专用小模型</strong></td><td>训练「最懂设计编辑」的专用模型（见下文）</td></tr><tr><td>⭐</td><td><strong>聚合 AI 模型</strong></td><td>不做大模型军备竞赛，直接聚合 Sora、Midjourney 等</td></tr></tbody></table>
<h3 data-id="heading-15">8.3 差异化定位</h3>
<pre><code class="hljs">Lovart：AI 生成 → 静态内容（2D/3D/视频）
FigDev：AI 生成 → 静态或带交互的内容（2D/3D/视频/网页）
</code></pre>
<hr/>
<h2 data-id="heading-16">9. AI 小模型策略：建立独特壁垒</h2>
<p>虽然不做大模型军备竞赛，但<strong>自研专用小模型</strong>是必要的。</p>
<h3 data-id="heading-17">9.1 为什么需要小模型？</h3>
<p>结构化转换层的「灵魂」能力，需要 AI 来增强：</p>





















<table><thead><tr><th>小模型类型</th><th>核心作用</th></tr></thead><tbody><tr><td><strong>结构化识别模型</strong></td><td>将 AI 生成的位图/SVG 转化为语义化图层结构</td></tr><tr><td><strong>布局推断模型</strong></td><td>自动识别元素关系，建立 AutoLayout 约束</td></tr><tr><td><strong>设计修正模型</strong></td><td>根据设计规范自动优化间距、对齐、配色</td></tr></tbody></table>
<h3 data-id="heading-18">9.2 数据飞轮：用户行为反哺模型</h3>
<p><strong>核心洞察</strong>：用户在编辑器中的每一次修改，都是最高质量的标注数据。</p>
<pre><code class="hljs language-markdown" lang="markdown">AI 生成 → 用户在编辑器中修改 → 修改记录作为训练数据 → 反哺小模型 → AI 生成更准确
<span class="hljs-code">              ↑                                                    ↓
              └──────────────────────────────────────────────────────┘
</span></code></pre>

























<table><thead><tr><th>用户行为</th><th>数据价值</th></tr></thead><tbody><tr><td>调整图层层级</td><td>训练「图层分离模型」</td></tr><tr><td>修改布局约束</td><td>训练「布局推断模型」</td></tr><tr><td>重命名组件</td><td>训练「语义理解模型」</td></tr><tr><td>修正颜色/间距</td><td>训练「设计修正模型」</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">10. 总结</h2>
<h3 data-id="heading-20">核心框架</h3>






























<table><thead><tr><th>层级</th><th>定位</th><th>战略优先级</th></tr></thead><tbody><tr><td><strong>矢量渲染引擎</strong></td><td>底座 — 决定「能不能做」</td><td>⭐⭐⭐</td></tr><tr><td><strong>结构化转换层</strong></td><td>灵魂 — 决定「好不好用」</td><td>⭐⭐⭐</td></tr><tr><td><strong>AI 小模型</strong></td><td>增强 — 形成独特壁垒</td><td>⭐⭐</td></tr><tr><td><strong>AI 大模型</strong></td><td>水电煤 — 聚合即可</td><td>⭐</td></tr></tbody></table>
<h3 data-id="heading-21">一句话总结</h3>
<p><strong>渲染是底座，转换是灵魂。</strong> FigDev 的核心竞争力不在于生成了什么，而在于<strong>如何承接、编辑、组织和交付</strong>这些生成的内容。</p>
<p><em>更多精彩内容可关注</em><a href="https://link.juejin.cn?target=https%3A%2F%2F01joy.com%2F" target="_blank" title="https://01joy.com/" ref="nofollow noopener noreferrer">风起的博客</a> <em>，微信公众号：听风说图</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm包开发及私有仓库配置使用]]></title>    <link>https://juejin.cn/post/7590457413347803163</link>    <guid>https://juejin.cn/post/7590457413347803163</guid>    <pubDate>2026-01-03T06:32:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590457413347803163" data-draft-id="7590011643296366630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm包开发及私有仓库配置使用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T06:32:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想要一辆洒水车"/> <meta itemprop="url" content="https://juejin.cn/user/52378148281933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm包开发及私有仓库配置使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/52378148281933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想要一辆洒水车
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T06:32:47.000Z" title="Sat Jan 03 2026 06:32:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原因：一个项目多个系统之间存在可复用的代码，重复的复制粘贴及修改，偶尔也会遗漏。集中管理和维护，提升代码复用率和维护效率</p>
<h2 data-id="heading-0">开发npm包</h2>
<h3 data-id="heading-1">初始化项目</h3>
<p>生成package.json文件</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> -y
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"product-npm"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 包名称</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 包版本信息</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 包的入口文件</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rollup --config"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ISC"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2">编写代码内容及打包</h3>
<p>安装 rollupjs 进行打包，生成dist文件夹，内容存放在该文件夹下。 <code>main</code>的值也需根据输出地址进行变更</p>
<h2 data-id="heading-3">选择 verdaccio 进行私有仓库管理</h2>
<h3 data-id="heading-4">全局安装verdaccio</h3>
<pre><code class="hljs language-cmd" lang="cmd">npm i verdaccio -g
</code></pre>
<h3 data-id="heading-5">检查是否安装成功</h3>
<p>显示版本号即为成功</p>
<pre><code class="hljs language-cmd" lang="cmd">verdaccio -v
</code></pre>
<h3 data-id="heading-6">运行 verdaccio</h3>
<pre><code class="hljs language-cmd" lang="cmd">verdaccio
</code></pre>
<p>终端会显示 config file 和 http address</p>
<p>config file - 配置文件的地址</p>
<p>htpp address - 仓库的管理界面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/468bca1334c14425896d2fe2c615535a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz6KaB5LiA6L6G5rSS5rC06L2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768026766&amp;x-signature=g268jLvS1VUwgx0tOM5RTkAwObw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">添加用户</h3>
<p>执行命令后，根据终端的提示设置用户名、密码、邮箱</p>
<pre><code class="hljs language-cmd" lang="cmd">npm add user --registry http://localhost:4873/
# --registry http://localhost:4873/ 指定仓库源
</code></pre>
<p>如出现报错需要检查配置文件中<code>max_users</code>是否有设置（默认被注释了）且值不能为1</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">auth:</span>
  <span class="hljs-attr">htpasswd:</span>
    <span class="hljs-attr">file:</span> <span class="hljs-string">./htpasswd</span>
    <span class="hljs-comment"># Maximum amount of users allowed to register, defaults to "+inf".</span>
    <span class="hljs-comment"># You can set this to -1 to disable registration. 如果为-1禁止注册</span>
    <span class="hljs-attr">max_users:</span> <span class="hljs-number">1000</span>
    <span class="hljs-comment"># Hash algorithm, possible options are: "bcrypt", "md5", "sha1", "crypt".</span>
    <span class="hljs-comment"># algorithm: bcrypt # by default is crypt, but is recommended use bcrypt for new installations</span>
    <span class="hljs-comment"># Rounds number for "bcrypt", will be ignored for other algorithms.</span>
    <span class="hljs-comment"># rounds: 10</span>
</code></pre>
<h3 data-id="heading-8">登录用户</h3>
<pre><code class="hljs language-arduino" lang="arduino">npm login --registry http:<span class="hljs-comment">//localhost:4873/</span>
</code></pre>
<h3 data-id="heading-9">发布\更新包</h3>
<p>在包根目录执行</p>
<pre><code class="hljs language-arduino" lang="arduino">npm publish --registry http:<span class="hljs-comment">//localhost:4873/</span>
</code></pre>
<p>如出现报错需要检查<code>package.json</code>文件下<code>version</code>是否有变更</p>
<h3 data-id="heading-10">删除包</h3>
<pre><code class="hljs language-css" lang="css">npm unpublish product-npm<span class="hljs-selector-attr">[包名]</span> <span class="hljs-attr">--registry</span> http://localhost:<span class="hljs-number">4873</span>/
</code></pre>
<h2 data-id="heading-11">使用</h2>
<p>由于verdaccio部署在自己的电脑下，所以在项目里直接 install 即可</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> product-npm <span class="hljs-attr">--registry</span> http://localhost:<span class="hljs-number">4873</span>/
</code></pre>
<p>同事需要使用时，则将localhost变为对应的我的电脑的ip</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> product-npm <span class="hljs-attr">--registry</span> http://<span class="hljs-number">192.168</span>.<span class="hljs-number">1.6</span>:<span class="hljs-number">4873</span>/
</code></pre>
<p>如出现无法安装需要检查配置文件中<code>listen</code>参数，开启0.0.0.0，以致可通过ip访问</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">https://verdaccio.org/docs/configuration<span class="hljs-comment">#listen-port</span></span>
listen:
<span class="hljs-meta prompt_">  # </span><span class="bash">- localhost:4873            <span class="hljs-comment"># default value</span></span>
<span class="hljs-meta prompt_">  # </span><span class="bash">- http://localhost:4873     <span class="hljs-comment"># same thing</span></span>
  - 0.0.0.0:4873              # listen on all addresses (INADDR_ANY)
<span class="hljs-meta prompt_"># </span><span class="bash">  - https://example.org:4873  <span class="hljs-comment"># if you want to use https</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">  - <span class="hljs-string">"[::1]:4873"</span>              <span class="hljs-comment"># ipv6</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">  - unix:/tmp/verdaccio.sock  <span class="hljs-comment"># unix socket</span></span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue源码分析 - 从入口到构造函数的整体流程]]></title>    <link>https://juejin.cn/post/7590159073989886004</link>    <guid>https://juejin.cn/post/7590159073989886004</guid>    <pubDate>2026-01-03T07:26:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590159073989886004" data-draft-id="7588445332773126198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue源码分析 - 从入口到构造函数的整体流程"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2026-01-03T07:26:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="luckyCover"/> <meta itemprop="url" content="https://juejin.cn/user/2546933393272872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue源码分析 - 从入口到构造函数的整体流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2546933393272872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    luckyCover
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T07:26:53.000Z" title="Sat Jan 03 2026 07:26:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vue 中的核心源码主要放在了 <code>src/core</code> 目录下，我们先来看下面这段代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5547650397e9419f91d1043f53fd34b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=gO%2BSP6wepCGjj%2BtTwqKBhJS4KfA%3D" alt="image.png" loading="lazy"/></p>
<p>上面这段代码是我们平常创建一个 Vue 项目中 main.js 入口文件里的原始代码，这也是 Vue 创建应用的起点，接下来我们就来分析从 <code>new Vue()</code> 到 <code>$mount</code> 这一过程 Vue 都做了哪些事，也就是做了哪些初始化。</p>
<p>首先是 <code>src/core/index.ts</code> 文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2ba5c038ee94252a573ee0b895a4467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=B8tdzJoHVqL7Ek%2BMlCv4vVmzX88%3D" alt="image.png" loading="lazy"/></p>
<p>我们看到它调用 <code>initGlobalAPI</code> 函数，并把 Vue 作为参数传进去，我们先不着急看 <code>initGlobalAPI</code> 内部逻辑，因为我们连它传入的这个参数 <code>Vue</code> 是啥都不知道，工欲善其事，必先利其器。我们看到文件最顶上 <code>Vue</code> 是从同目录下 <code>instance/index</code> 文件中导出的。
我们打开文件看一下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afe4a7ff77ff4bf589397460c7849410~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=ht%2BscmkNJrC59VyT5gjJRrYk%2F80%3D" alt="image.png" loading="lazy"/></p>
<p>哦，原来导出的 Vue 是一个函数，而且函数名称还是大写的，所以可以当作构造函数使用，除此之外，我们还看到在函数下方还有一系列以 <code>xxxMixin</code> 为首的函数调用，而且也把 Vue 这个函数当作参数传入，我们可以猜测这些函数调用就是执行各种初始化操作，而且在我们 new Vue 的时候，其实下面的那些 xxxMixin 都已经执行过了，new Vue 时调用的 _init 方法实际上是在 initMixin 中的，所以我们把它归类到 initMixin 中，可以初步得到以下初始化流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf93b4c31888493fa87306a3ddec0320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=yzyG9jSiHjQClKRinPrgqElyo2I%3D" alt="image.png" loading="lazy"/></p>
<p>具体每个函数都干了哪些事，我们接下来就按照上边流程图的顺序来逐个进行分析。</p>
<h3 data-id="heading-0">initMixin</h3>
<p><code>_init</code> 方法所在文件（src/core/instance/init.ts）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c802a95cde14d0b899a562cdf780cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=RRc4bvVxIQnfLRhD6vbAwqTde4k%3D" alt="image.png" loading="lazy"/></p>
<p>它是 Vue 原型上的一个方法，接收一个 options 参数，我们主要分析它的核心逻辑：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d973b5125285495ab398ec29aa1798b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=loSzaXb6erD4PFZ4CAFu7J06Hjo%3D" alt="image.png" loading="lazy"/></p>
<p>1、首先将 this 赋值给 vm</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/271f310c5e3b4b59acff67a4d4ca079e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=kPx5mw3lSfcZRZnDUpzRrPlTMTY%3D" alt="image.png" loading="lazy"/></p>
<p>这里的 this 就是 new Vue 时构造出来的实例对象，所以 vm 特指 Vue 实例对象。</p>
<p>函数外部有一个 uid 变量，默认从 0 开始</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a023d7499b094ba8b809debef055981b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=iI54c7RQvqEdnSin3JJVraZ1oHs%3D" alt="image.png" loading="lazy"/></p>
<p>接着往 Vue 实例对象上添加一个 <code>_uid</code> 属性作为唯一标识，值默认是 0，赋值完后 uid 自增（这样下一个 new Vue 构造的实例，它的 _uid 就是 1，以此类推）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20187da5d7464e00bf3c43cfa19a1681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=3S2DBVmj%2FKKHENX7QpxlerSX%2FoU%3D" alt="image.png" loading="lazy"/></p>
<p>vm 上添加 <code>_isVue</code> 属性，值设为 true，这个属性用来标记当前 vm 是一个 Vue 的实例（也就是通过 new Vue 构造出来的）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8c3987c8e945549c8a04268677015a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Fj4aL92VPNa571onT2nbUC0vfiE%3D" alt="image.png" loading="lazy"/></p>
<p>后边还设置了其他的一些属性，咱们先不用管，后边有出现会提到的。</p>
<p>然后我们来看关键方法 <code>mergeOptions</code>，从名字上我们就可以知道它是用于合并选项的，调用 mergeOptions 并将返回结果赋值给 vm.$options
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a22776c09bd4030b18b61ee6992f71c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=OrjlVO9bJUE7WDwTcLpqHHCZ7t8%3D" alt="image.png" loading="lazy"/></p>
<p>我们先来分析它的传参，第一个参数是调用 resolveConstructorOptions 函数的返回值
那么调用 resolveConstructor 函数传了 vm.constructor（实例对象的 constructor），这里通过原型相关的知识可以得知，实例的 constructor 指向实例化它的构造函数，那这里就是 Vue 构造函数了，所以就是：</p>
<pre><code class="hljs language-js" lang="js">vm.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Vue</span> <span class="hljs-comment">// true</span>
</code></pre>
<p>我们来看下 resolveConstructor 函数内部逻辑：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23c5117878354cc9b3072b2ae3f0c43e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=l994vD3mq%2BKxLLPfgK%2FiCVd5yoQ%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>接收一个参数 Ctor，我们刚才传了 vm.constructor（相当于 Vue 构造函数）</li>
<li>取得 options 选项</li>
<li>判断 Ctor.super 有没有（super 关键字会指向其父类的构造函数，即判断有无父类），这一般在子组件通过 extend 继承父组件时会存在这种情况，我们目前没有父子继承关系，所以不进入判断内部</li>
<li>直接返回 options</li>
</ul>
<p>mergeOptions 的第二个参数是 _init 接收的参数 options，也就是 new Vue 时传给构造函数中的对象，第三个参数是当前组件实例 vm。传给 mergeOptions 的三个参数都分析完后，来看下 mergeOptions 函数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dac197fd3be641cd8bc194ef0dda1277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Jq1DT0VX%2Fb5AMe6nIdatH2g875M%3D" alt="image.png" loading="lazy"/></p>
<p>通过官方注释得知，就是将两个选项合并成一个，parent 就是 Vue 构造函数的默认 options，child 是我们 new Vue 时传给构造函数的，vm 就是当前实例</p>
<ul>
<li>调用 checkComponent</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93d10b6f4c5b4b07812738fee25e0ac8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=KPdntXYry3OysP4%2FR%2F%2B0m17dowY%3D" alt="image.png" loading="lazy"/>
checkComponent 用于检测组件的名称，前提是传入的 options 上的 components 不为空，枚举 options.components 上的组件名，调用 validateComponentName 函数校验</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23795421012345f1bea4139969f37984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=uqgXCbf8mH1uUiTF2scKz8%2FO6C4%3D" alt="image.png" loading="lazy"/>
validateComponentName 接收参数 name（即组件名称），采用正则表达式校验 name 是否符合要求，不符合就调用 warn 函数，提示错误信息。
通过正则表达式校验，下边还需要校验是不是和 Vue 中一些内置名称冲突
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83f9d01445da4727b7f12fa3a866155a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=RMnVwpijCS9Vib5hXdV4k3rep60%3D" alt="image.png" loading="lazy"/>
调用 isBuiltInTag 和 isReservedAttribute 函数相当于是调用了 makeMap 返回的函数，我们看看 makeMap 函数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8718beba31b54ede8b0d4c99c89b30bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=PB%2BUIiI8yBku2Qo5tj1X5ybw08I%3D" alt="image.png" loading="lazy"/>
接收 str 字符串参数，expectsLowerCase 布尔值是否期望小写。makeMap 函数内部逻辑：</p>
<ul>
<li>构建一个空 map</li>
<li>分割传入的 str 放到 list 数组</li>
<li>遍历数组，将数组中的元素放到 map 中作为键，其值默认为 true</li>
<li>返回值：如果 expectsLowerCase 为 true，返回一个函数，这个函数接口一个 val 参数，将 val 转为小写后去 map 中找到这个键对应的值，如果 expectsLowerCase 为 false，返回一个接收 val 参数的函数，函数直接返回 map 中 val 这个键对应的值。</li>
</ul>
<p>总结：isBuiltInTag 函数对应的 makeMap 返回的函数内部的 map 为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">map</span>: {
    <span class="hljs-string">'slot'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'component'</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<p>这些是 Vue 中内置的标签</p>
<p>isReservedAttribute 函数对应 makeMap 内的 map 也是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">map</span>: {
    <span class="hljs-string">'key'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'ref'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'slot'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'slot-scope'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'is'</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<p>这些是 Vue 中预定义的属性</p>
<p>默认调用 makeMap 时第二个参数是 true，也就是我们组件名称传进去会先转为小写，然后再去 map 中匹配，说白了，我们写的组件名称中不管大小写，统一转为小写后匹配上边的 map，只要匹配上键（属性名），它们的值刚好是 true，那就进入判断抛出错误提示信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3169e91f7c6b4e05bf2c835815366b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=PQnqFs0I7OXQV3XNhVQq12aPJx4%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p>校验完组件名后，接着调用 normalizeProps 规范化 props
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef3a3655b154e5daeb619354b9277f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=pbD%2BVZi2D2jLIyQw2WMcyoxveXQ%3D" alt="image.png" loading="lazy"/>
接收 options 选项以及 vm 实例对象</p>
<ul>
<li>
<p>获取 options 上的 props，为空直接返回</p>
</li>
<li>
<p>情况一：props 如果是数组形式</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea70bddbe9434a62852603f8f67d4c61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=F%2Ff3c%2F74J7zo7Lr%2FmQWrxluPGJo%3D" alt="image.png" loading="lazy"/></p>
<p>遍历数组元素，进行类型判断，数组中的元素必须是字符串类型，否则抛出错误信息，随后调用 camelize 将元素 val 传进去做处理，camelize 就是将传入的字符串转为驼峰命名的形式并返回
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9854a1823054fde93ed673443ba18a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Ab%2FEgNrWKkBNMY8HUvt0JFUik0o%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/078435c479ce4ca78171c4f439b7a48c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=aZZzNPwAZS6uBeJOSHRbT4M2NdE%3D" alt="image.png" loading="lazy"/>
camelizeRE 是要匹配的正则表达式，括号内是捕获组，(\W) 就是捕获一个英文单词，对传入的字符串使用 replace 方法，就是将正则表达式匹配的部分替换为第二个参数指定的部分。举个例子，假设我们传入的 str 如下：</p>
<pre><code class="hljs language-js" lang="js">my-component
</code></pre>
<p>那么 camelizeRE 正则匹配到的就是 <code>-c</code>，捕获组捕获到的就是 <code>c</code>，replace 第二个参数是回调，回调第一个参数是匹配到的完整字符串，第二个参数是捕获到的字符，这里是小写 <code>c</code>，将其转为大写（调用 toUpperCase()），那这里就是将正则匹配到的 <code>-c</code>，替换成大写 <code>C</code>，替换后的字符如下：</p>
<pre><code class="hljs language-js" lang="js">myComponent
</code></pre>
<p>这个 name 就是驼峰式的了，然后放到 res 对象中作为属性，值是一个对象，对象中默认有一个 type: null 的属性，放到 res 中就是</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">res</span>: {
    <span class="hljs-string">'xxx'</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-literal">null</span>
    }
}
</code></pre>
<ul>
<li>情况二：props 是对象形式
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/941bbb56cb83494d8b039c6524166e59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=RLJ5eiEzFvjqsQWaAQG89cFJGdE%3D" alt="image.png" loading="lazy"/>
对象处理也很简单，枚举对象上的属性，拿到属性值 val，同样对属性名进行处理，转为驼峰命名形式，接着往 res 上放这个属性，如果 val 本身是一个对象，那就直接将这个对象作为属性值，反之就将 type 放到一个对象中，属性值设为这个 val。分别对应下边两种情况</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">props</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">age</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>
    }
}
</code></pre>
<p>name 属性值不是一个对象，将 name 属性值（String）作为新对象中 type 的属性值，放到 res 中就是</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">res</span>: {
    <span class="hljs-attr">name</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>
    }
}
</code></pre>
<p>age 属性值本身是一个对象，放到 res 中是</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">res</span>: {
    <span class="hljs-attr">age</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>
    }
}
</code></pre>
<ul>
<li>
<p>props 不是数组也不是对象
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd2da1fcd6d4803a0236eb1f5fa3715~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=93tM1U4OHJxkhHChxjJAabWIoGE%3D" alt="image.png" loading="lazy"/>
抛出错误信息，提示 props 必须是一个数组或对象</p>
</li>
<li>
<p>处理好的 res 覆盖 options.props</p>
</li>
</ul>
<p>可以看到上边就是对用户传的 props 进行归一化，所谓归一化就是将不同的形式转为相同的形式，上边归一化后的形式就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">props</span>: {
    <span class="hljs-attr">key1</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>
    },
    <span class="hljs-attr">key2</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>
    },
    <span class="hljs-attr">key3</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-literal">null</span>
    }
}
</code></pre>
<ul>
<li>调用 normalizeInject 规范化 inject</li>
</ul>
<p>normalizeInject 内部处理逻辑和 normalizeProps 很相似，都是分为数组和对象两种情况处理，如果两者都不是就抛出错误信息。只是 props 中是处理 type，injects 是 from。这里对象的处理中，如果枚举的属性其属性值是一个对象，会调用 extend 进行处理，传入两个参数，第一个是一个对象，有 from 属性，属性值是这个枚举属性，第二个参数是枚举属性对应的值，这个值是个对象，看看 extend 函数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51c90db2168d4db9b3939718f18ea8e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=ZIM9Hflgc32%2BsFE%2FctSC3Y%2BeeBc%3D" alt="image.png" loading="lazy"/></p>
<p>就是往第一个参数也就是目标对象上混入属性，枚举第二个参数传入的 val 对象，往第一个参数（{from: key}）混入第二个参数中的属性（如果第二个参数 val 对象上也存在 from 属性，则 val 对象上的 from 属性值覆盖源对象上的 from 属性值，混入后，源对象上就不仅只有 from 属性了，还可能有其他的一些属性）。</p>
<p>最后归一化后的格式就是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">injects</span>: {
    <span class="hljs-attr">key1</span>: {
        <span class="hljs-attr">from</span>: xxx,
        ..., <span class="hljs-comment">// 其他一些属性</span>
    }
}
</code></pre>
<ul>
<li>
<p>调用 normalizeDirectives 规范化 directives
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540a24d1e43a4b0f9de5f8426fe31be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=9VT60FOhEw%2BQju97r40nV4zBpTw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>获取 directives 选项</li>
<li>枚举选项上的属性，获取属性值</li>
<li>判断属性值是不是一个函数，是的话就将选项上当前属性的属性值重新赋值为一个对象，对象上的 bind 和 update 属性为这个源函数</li>
</ul>
</li>
<li>
<p>枚举 parent（Vue 构造函数的 options 选项），调用 mergeField 将属性作为实参传入</p>
</li>
<li>
<p>枚举 child（用户传入的 options 选项），如果属性在 parent（Vue 构造函数中的 options）中不存在，调用 mergeField 函数，将 key 属性作为实参传入</p>
</li>
</ul>
<p>接着看看这个核心的 mergeField 函数
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7e4431a35444602a46b279fa9d081a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=zd3KjHHqze2iWi%2F0zDqEtZwB3Dw%3D" alt="image.png" loading="lazy"/></p>
<p>strat 是一个函数，会先从 strats 中取，strats 在文件顶部声明</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9adcd1abd99048f483fc3a99900e19cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=aqFo0V0wAlk0S4%2FHVbLB%2Fjx0Clk%3D" alt="image.png" loading="lazy"/></p>
<p>默认值为 config.optionMergeStrategies， 这个 config 在（<code>src/core/config.ts</code>）文件中，默认是个空对象</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2408d93f401e44b8bbdaf909e0756807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=NeE34TXcrw%2FD9jsYJo4r40CwC%2Bg%3D" alt="image.png" loading="lazy"/></p>
<p>从上边的接口类型声明来看，这个对象上的属性是字符串类型，属性值是个函数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994c19bdf21e4a9f9334884e0ab23dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=m65dvvvyNVcQ2YoO4oAuDx2PyNM%3D" alt="image.png" loading="lazy"/></p>
<p>那么如果 strats 上没有这个属性对应值，就会使用默认的策略 defaultStrat</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fab5287e5c14c28b4dee8dc76495f7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=PYppVubbFPlQ26VxtX9gEEm2IIQ%3D" alt="image.png" loading="lazy"/>
默认策略接收父属性值和子属性值作为参数，如果子属性值不为 undefined 的话优先返回它，否则再取父属性值，这个返回值就作为最后合并好的 options 上该属性对应的值。</p>
<p>那么上边先枚举 Vue 构造函数的 options 上的属性，如果用户传的 options 也存在该属性，优先使用用户传的，这样后边枚举用户传的 options 时就仅需要处理 Vue 构造函数 options 上没有的属性了。</p>
<ul>
<li>最后返回合并好的终极 options</li>
</ul>
<p>至此，mergeOptions 函数就分析完了，主要流程就是<code>组件名校验</code>、<code>归一化 props</code>、<code>injects</code>、<code>directives</code>，然后将 Vue 构造函数及用户的 <code>options 进行一个合并</code>，最后返回。</p>
<p>继续往下看：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02aaa2d904746c1b4b84dbacd9777bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=t%2B24oFRwn9aytpcirEOs1P7q3go%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initProxy
所在文件（src/core/instance/proxy.ts），在文件顶部声明了一个 initProxy 变量，然后赋值为一个函数：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/804bdc2dc6864f3295fcb2b857b1cfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=jsUhZP2f%2Fhc1a5ykbqIenX8EzH8%3D" alt="image.png" loading="lazy"/>
接收 vm 实例作为参数，首先判断 hasProxy 值，hasProxy 判断浏览器是否支持 Proxy 这个 API，即不为 undefined，且调用 isNative 要返回 true，isNative 会判断传入参数是一个函数，且是 JavaScript 内置的函数（内置函数调用 toString 方法会返回包含 [native code] 的字符串）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f53b344d4774de6a023e6e90331e31d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=mXUdPpk%2BND5qwW8LaOgtPHaVk8s%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbd0297103c1494da56fba387d50e403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=MH8COudt2ghA8JbDX62VAfwVrHc%3D" alt="image.png" loading="lazy"/></li>
</ul>
<p>进入判断后先获取 vm 上的 options，然后定义 handlers 配置项，然后创建一个代理实例赋值给 vm 上的 _renderProxy 属性，如果 hasProxy 为 false， _renderProxy 属性就赋值为 vm 实例本身，接着我们看下代理配置项 handlers 取值，有 getHandler 和 hasHandler 两种：</p>
<p>getHandler 中定义了一个 get 函数，参数是 target（这里是 vm 实例） 和 key（属性）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d667f450fc544286a3ce8768942b7c1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=ayywi7RA%2BXCec%2Bwzg8CVUmjRXWM%3D" alt="image.png" loading="lazy"/></p>
<p>也就是我们读取 vm 上的某个属性时，会触发 get 函数拦截，首先判断这个 key 属性是字符串且不在 target（vm 实例）上，接着继续判断 key 属性在不在 vm 实例的 <code>$data</code>（也就是我们组件中写的 data 对象里）上，如果在就调用 <code>warnReservedPrefix</code> 函数抛出错误提示，如果不在 vm 实例上也不在 <code>vm.$data</code> 属性上，调用 <code>warnNonPresent</code> 函数抛出另一个错误信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7da367e64574444ba6b7300756fe87d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=xJSvMSRK3w0qH8%2BnAUJlweSdNmw%3D" alt="image.png" loading="lazy"/>
因为属性 key 它不在 vm 上，但在 <code>vm.$data</code> 上，所以这里提示信息意思就是这个 key 属性必须访问 <code>$data.key</code> 上的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93e644517cbf498793e8a9ae3e50b228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=P2LeKQliJYNJAuUAF4yVp4%2FbQlI%3D" alt="image.png" loading="lazy"/>
这种情况就是 key 属性即不在 vm 上也不在 <code>vm.$data</code> 上，抛出错误信息表示属性或方法在实例上未定义但是存在引用</p>
<p>再看下 hasHandler 函数的 has 函数，has 代理方法是针对 in 操作符的，比如我们这里判断一个属性:</p>
<pre><code class="hljs language-js" lang="js">name <span class="hljs-keyword">in</span> obj
</code></pre>
<p>这就会触发代理对象 obj 的 has 拦截方法，同理上边代理对象是 vm，使用 in 操作符判断某个属性是否在 vm 上时就会触发 has 函数拦截。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11062bbabdda4eb281db5e7e19d78a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=GKjoWL%2BEZbmK1E6OW6dWxmCT59g%3D" alt="image.png" loading="lazy"/>
has 常量取值取决于 key 属性在不在 target（vm）上</p>
<p>isAllowed 常量取值满足以下其中一种就是 true，都不满足就为 false：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">allowedGlobals</span>(key) ||
<span class="hljs-keyword">typeof</span> key === <span class="hljs-string">'string'</span> &amp;&amp;
          key.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>) === <span class="hljs-string">'_'</span> &amp;&amp;
          !(key <span class="hljs-keyword">in</span> target.<span class="hljs-property">$data</span>)
</code></pre>
<p>allowGlobals 函数也很简单，有我们熟悉的 makeMap 函数，第二个参数不传，就是内部匹配名称时不会转为小写去匹配，内部 map 的组成由每个逗号分割的关键字作为属性，其属性值默认为 true，调用这个函数时，如果当前 key 和 map 中某个属性名称匹配，那么取值就是 true
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5cd3c1421014925810fc7a583de595f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Xa97j9egUoVzoAZRBg9zL1PlB9M%3D" alt="image.png" loading="lazy"/>
下面就是判断 has 取值为 false（即属性不在 vm 上） 且 isAllowed 也为 false，内部逻辑和 getHandler 中的 get 函数相似。最后返回 has || !isAllowed 逻辑或的取值。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1171414bcd804169aa188e42a0f4f91f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=xYn49vWH58zs80C7G3jMUykks4M%3D" alt="image.png" loading="lazy"/></p>
<p>在 initLifecycle 调用前，还有一句赋值语句，将自身引用保持在了自身的 _self 属性上
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc9bec014c84dbca95551e046e1566a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=3Ec9Wo3ixMM6ae6ucWjbcEXTAe8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initLifecycle</li>
</ul>
<p>initLifecycle 的初始化，就是往 vm 实例上添加一些属性，并赋予默认值，比如我们熟悉且常用的 <code>$refs</code>、<code>$parent</code>、<code>$root</code>、<code>$children</code> 对象，
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7abc37a1a1e045cb929d68041f1f8bb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=13ZGn3ynujGoDl%2FkBLYab9yBAUI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initEvents
事件初始化</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af7275427ac47df8c4877b542b0bbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=HWIjuvx%2B8AUZy33QbtTretDOUVs%3D" alt="image.png" loading="lazy"/></p>
<p>核心就是 updateComponentListeners 方法，这个方法内部又调用了 updateListeners 方法</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fd22bb446724c41a2ed626d0e80746f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=g4W6kuXqgpCjuqDEADLEdNBVDLs%3D" alt="image.png" loading="lazy"/></p>
<p>updateListeners 方法内部就是对新老事件进行处理（更新事件 on 监听，包括 add 新增事件和 remove 移除事件）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34cea4c085b3494298ebce6949077a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=S5lg1SVqgyFk4CA6O5IqUlxO8eQ%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initRender</li>
</ul>
<p>内部定义了 <code>$slots</code>、<code>$createElement</code>、<code>$attrs</code>、<code>$listeners</code></p>
<ul>
<li>beforeCreate</li>
</ul>
<p>调用了 <code>beforeCreate</code> 生命周期钩子</p>
<ul>
<li>initInjections</li>
</ul>
<p>处理 injects 信息，将 injects 对象中的每个属性转为响应式的，这样就能和在 data 中声明的属性一样使用了，这里的关键点就是 injects 比 data 和 props 先初始化。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331058e95c1d4312ad64db6c8a40876d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Wc1GSfzOz9WzJSHdGJ%2B4hz1Apwg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initState</li>
</ul>
<p>初始化 props、setup（vue3 语法糖）、methods、data、computed、watch（这边的初始化逻辑留到响应式系统篇章再来分析）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa78c6f3193c46498b2e484b0bdbc0bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=FBNUWTWKIhlT3yM1Y33J08Li1w8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>initProvide</li>
</ul>
<p>处理 provide 信息，将 provide 对象内的每个属性转为响应式，provide 的初始化在 data、methods 初始化之后
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90275fd3423f4f40851be2ab8e3b5ec7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Jkf0eK4K%2FrBZBiu7oVPFlFASvnk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>created</li>
</ul>
<p>调用 created 生命周期钩子</p>
<ul>
<li>$mount</li>
</ul>
<p>判断选项中如果有 el 节点，那就作为实参传入 vm.$mount 函数中
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c35b6f81cd4fa6beb7808c41099428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=rthd6KSeWOe9V6hlo%2F7NIaRnZrk%3D" alt="image.png" loading="lazy"/></p>
<p>这里的 el 就是我们常说的挂载的根容器 app</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8de68d94a4d14b888caa395d621c6ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=8RH2M8ZcjCnyjB1QqHjRQE7tjkQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">stateMixin</h3>
<p>所在文件：<code>src/core/instance/state.ts</code>，内部逻辑也很简单
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4776e65dcdd4ec69cace1b15fc5ffdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=LMbUBDxzy9eJCuN4C3wyndW0t4w%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>拦截 Vue 原型上的 <code>$data</code> 和 <code>$props</code></li>
<li>Vue 原型上添加 <code>$set</code> 方法</li>
<li>Vue 原型上添加 <code>$delete</code> 方法</li>
<li>Vue 原型上添加 <code>$watch</code> 方法</li>
</ul>
<p>看看是怎么拦截的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20f09f9e392340f5882bbbf9e1d3e5d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=6yDgyk%2FV3DP73%2FTVAtsClh9eAxQ%3D" alt="image.png" loading="lazy"/></p>
<p>访问 <code>Vue.prototype.$data</code> 时实际上是这样访问 <code>vm._data</code>（当前 vm 实例上的 _data 对象）</p>
<p>访问 <code>Vue.prototype.$props</code> 时实际上是这样访问 <code>vm._props</code>（当前 vm 实例上的 _props 对象）</p>
<p>如果是修改 <code>Vue.prototype.$data</code> 或者 <code>Vue.prototype.$props</code>，会走 set 拦截方法抛出错误信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b45b594a0c7343359757017d5bc1ca3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=1iu1TZgeIdcTq2T%2F%2B%2BzizFdWsuo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">eventsMixin</h3>
<p>eventsMixin 函数接收 Vue 构造函数作为参数，往构造函数原型上添加四个方法：</p>
<ul>
<li><code>$on</code></li>
<li><code>$once</code></li>
<li><code>$off</code></li>
<li><code>$emit</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5e4e6d61e4e47b8907b8dfaf002fa88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=eXLwWjgAd%2FErdUAd6SULo4TDIR0%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-3">lifecycleMixin</h3>
<p>lifecycleMixin 函数接收 Vue 构造函数作为参数，往 Vue 原型添加三个方法：</p>
<ul>
<li><code>_update</code></li>
<li><code>$forceUpdate</code></li>
<li><code>$destroy</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ab0d62adf5c4f9aae41cd5070290317~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=KVIwi7BbM58JLKzY00ZmFXV%2FFkg%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h3 data-id="heading-4">renderMixin</h3>
<p>renderMixin 函数接收 Vue 构造函数作为参数，往 Vue 原型添加两个方法：</p>
<ul>
<li><code>$nextTick</code></li>
<li><code>_render</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eb10357ca304bf6839feaa96822fb9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=XF52qsOckee80AuEP5WQzY95aw8%3D" alt="image.png" loading="lazy"/></p>
<p>调用 installRenderHelpers 函数时将 Vue.prototype 作为实参传入
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce2f6cb3e84a4be08caaf2cf26074cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=u6DWSz%2BEaQY2326L%2Faa6YbYAlWQ%3D" alt="image.png" loading="lazy"/></p>
<p>target 就是 Vue.prototype，往 Vue 原型上添加各种以 <code>_</code> 开头的方法</p>
<h3 data-id="heading-5">initGlobalAPI</h3>
<p>接收 Vue 构造函数作为形参</p>
<p>先代理 Vue 上的 config 属性（是个对象），属性描述符项是 configDef，提供 get 和 set 函数，当你尝试修改 Vue.config 时会被 configDef 的 set 函数拦截，抛出错误信息，意思就是不能替换 Vue.config 对象。如果是读取 Vue.config，就被 configDef 的 get 函数拦截，直接返回了 config，这个 config 是个对象（所在文件：<code>core/config.ts</code>）中，就是暴露了一堆全局属性（比如 async、devtools 等）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/142c43d0b66d465188d500b948dc299f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=eczaE5ISgEh5oINu2VbCiMGScPk%3D" alt="image.png" loading="lazy"/></p>
<p>接着往 Vue.util 对象上添加一些方法
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01dd050407941758f531a2841e8b2db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=%2B%2FddFKRFYVnmIyzAe09fYncgeZc%3D" alt="image.png" loading="lazy"/>
Vue 官方也提供了注释，意思就是这些不被认为是公共的 API，虽然暴露出去你能用，但是不建议用，因为这几个 API 其实是 Vue 内部自己在用的。</p>
<p>再下边就往 Vue 上添加了几个方法，在之后文章会详细介绍</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c3c5ed68584ad38a027c5721376fb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=qgidkvYY6RRnaB5D4yZd2Jbi4ss%3D" alt="image.png" loading="lazy"/></p>
<p>下边初始化 Vue.options 为一个空对象，遍历 ASSETS_TYPE 数组中的元素然后追加到 options 上
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5940b7440924040a0be83f1fe4593b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=lsoEkV0RfiA1ahfECYlBJUCtgoM%3D" alt="image.png" loading="lazy"/></p>
<p>ASSETS_TYPE 所在文件（<code>src/shared/constants.ts</code>）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98e921e6a7854c909cb0f810b0b636d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=RdHn38M7jOsT0N4UwuIuAAYPCo4%3D" alt="image.png" loading="lazy"/>
数组中每个元素就是遍历时的 type，是字符串类型，往 type 对应元素名称后边拼上 s 后作为属性名，属性值默认是空对象，遍历追加完后 Vue.options 上就有如下属性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property">options</span> = {
    <span class="hljs-attr">components</span>: {},
    <span class="hljs-attr">directives</span>: {},
    <span class="hljs-attr">filters</span>: {}
}
</code></pre>
<p>接着往 Vue.options 追加 _base 属性，属性值是 Vue 本身
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a87b4a7bedbb48d6bbf02498d8edb872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=JbtPgfZneHd7nQq7XAHGyzWC1xw%3D" alt="image.png" loading="lazy"/>
现在 Vue.options 就多了一个属性</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property">options</span> = {
    <span class="hljs-attr">_base</span>: <span class="hljs-title class_">Vue</span>,
    <span class="hljs-attr">components</span>: {},
    <span class="hljs-attr">directives</span>: {},
    <span class="hljs-attr">filters</span>: {}
}
</code></pre>
<p>然后是 extend 函数，将 Vue.options.components 作为第一个参数（是一个对象），builtInComponent 作为第二个参数</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/108a5894607a4953bee6cbb77bbcad1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=dXXdDgRKSLg5tTolqUhE1woj540%3D" alt="image.png" loading="lazy"/></p>
<p>builtInComponent（所在文件：<code>src/core/components/index.ts）</code>，其实就是暴露了一个 KeepAlive 组件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/616c4ccd6ee540088a30632855c75b91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Q%2BVvsZdV7pH1cucc3SCM2mRGvfc%3D" alt="image.png" loading="lazy"/></p>
<p>那看下 extend 函数（所在文件：<code>src/shared/utils.ts</code>）</p>
<p>其实很简单，就是往目标对象混合属性，目标对象就是传的第一个参数（Vue.options.components），混合的属性在第二个参数里，刚才看了是一个对象，对象里边有 <code>KeepAlive</code> 属性（组件）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e54af6708444229983923c4470058e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=Qo7A%2FxWQn1rv1zQBwVYFA2szM9M%3D" alt="image.png" loading="lazy"/></p>
<p>混合后就是</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property">options</span> = {
    <span class="hljs-attr">_base</span>: <span class="hljs-title class_">Vue</span>,
    <span class="hljs-attr">components</span>: {
        <span class="hljs-title class_">KeepAlive</span>
    },
    <span class="hljs-attr">directives</span>: {},
    <span class="hljs-attr">filters</span>: {}
}
</code></pre>
<p>接着下边又往 Vue 上添加了一系列方法：</p>
<p><code>initUse</code>，往 Vue 上添加了 <code>use</code> 方法
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57900429f71c406b8f0914c0c2249b06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=uH5ZHpz%2BxC8NglvoSBUXTPNzkwo%3D" alt="image.png" loading="lazy"/></p>
<p><code>initMixin</code>，往 Vue 上添加 <code>mixin</code> 方法
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a004fc9c9ee4d919bdb9e0bf4d82a85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=euXqzf%2Fk%2FUm5S9xjYl6m%2FoK7NlE%3D" alt="image.png" loading="lazy"/></p>
<p><code>initExtend</code>，往 Vue 上 添加 <code>extend</code> 方法</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85cb80ca539c414fa14af71406d48e64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=u%2FtwAbfhKOBmz35tYUGueC38ezc%3D" alt="image.png" loading="lazy"/></p>
<p><code>initAssetRegisters</code>，往 Vue 上添加 <code>component</code>、<code>directive</code>、<code>filter</code> 方法，<code>ASSET_TYPES</code> 刚才看过了是个数组，数组中每个元素作为函数名，在 Vue 上注册成了函数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251ab6556d9b47ac9e8b6205422e11eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=d6DGjEmJ5shTbnbn9VsxwqZUU2Q%3D" alt="image.png" loading="lazy"/></p>
<p>至此，从 new Vue() 到 $mount 期间的一系列初始化操作我们就看完了，上边为了先分析传给 initGlobalAPI 的参数 Vue，所以就先分析了 initMixin 等函数，实际上 initGlobalAPI 作为核心入口文件是最先执行的。下边再来看看流程图，这会就清晰多了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1df0cc9407e2448c847b2765c7ad1830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbHVja3lDb3Zlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768030013&amp;x-signature=5tO0XIl4piA4WKpim2DSOitJ5%2BE%3D" alt="无标题-2025-12-18-2128.png" loading="lazy"/></p>
<p>Vue 初始化流程，每一步都做了哪些初始化，现在看就一目了然了，下篇文章我们就进击 Vue 的响应式系统~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OkHttp3 内部工作原理时序图]]></title>    <link>https://juejin.cn/post/7590592594674253834</link>    <guid>https://juejin.cn/post/7590592594674253834</guid>    <pubDate>2026-01-03T07:10:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594674253834" data-draft-id="7590292138347216906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OkHttp3 内部工作原理时序图"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-03T07:10:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乾坤一气杀"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289955431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OkHttp3 内部工作原理时序图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289955431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乾坤一气杀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T07:10:15.000Z" title="Sat Jan 03 2026 07:10:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OkHttp3 内部工作原理时序图</h2>
<p>本文档深入剖析OkHttp3框架的内部工作机制，展示其核心组件的交互流程。</p>
<h3 data-id="heading-1">1. OkHttpClient 构建流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant Builder as OkHttpClient.Builder
    participant Dispatcher as Dispatcher
    participant ConnectionPool as ConnectionPool
    participant OkHttpClient as OkHttpClient

    Client-&gt;&gt;Builder: new OkHttpClient.Builder()
    activate Builder

    Note over Builder: 配置网络参数
    Client-&gt;&gt;Builder: connectTimeout(duration)
    Builder-&gt;&gt;Builder: 设置连接超时
    Client-&gt;&gt;Builder: readTimeout(duration)
    Builder-&gt;&gt;Builder: 设置读超时
    Client-&gt;&gt;Builder: writeTimeout(duration)
    Builder-&gt;&gt;Builder: 设置写超时

    Note over Builder: 配置拦截器
    Client-&gt;&gt;Builder: addInterceptor(interceptor)
    Builder-&gt;&gt;Builder: interceptors.add()
    Client-&gt;&gt;Builder: addNetworkInterceptor(interceptor)
    Builder-&gt;&gt;Builder: networkInterceptors.add()

    Note over Builder: 配置连接池
    Client-&gt;&gt;Builder: connectionPool(pool)
    alt 未指定连接池
        Builder-&gt;&gt;ConnectionPool: new ConnectionPool()
        activate ConnectionPool
        ConnectionPool-&gt;&gt;ConnectionPool: 最大空闲连接: 5
        ConnectionPool-&gt;&gt;ConnectionPool: 保活时间: 5分钟
        ConnectionPool--&gt;&gt;Builder: 返回默认连接池
        deactivate ConnectionPool
    end

    Note over Builder: 配置调度器
    Client-&gt;&gt;Builder: dispatcher(dispatcher)
    alt 未指定调度器
        Builder-&gt;&gt;Dispatcher: new Dispatcher()
        activate Dispatcher
        Dispatcher-&gt;&gt;Dispatcher: 最大并发请求: 64
        Dispatcher-&gt;&gt;Dispatcher: 单Host最大请求: 5
        Dispatcher-&gt;&gt;Dispatcher: 创建线程池ExecutorService
        Dispatcher--&gt;&gt;Builder: 返回调度器
        deactivate Dispatcher
    end

    Client-&gt;&gt;Builder: build()
    Builder-&gt;&gt;OkHttpClient: new OkHttpClient(builder)
    activate OkHttpClient
    OkHttpClient-&gt;&gt;OkHttpClient: 复制所有配置
    OkHttpClient--&gt;&gt;Builder: 返回OkHttpClient实例
    deactivate OkHttpClient

    Builder--&gt;&gt;Client: 返回配置好的client
    deactivate Builder
</code></pre>
<h3 data-id="heading-2">2. 同步请求执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant OkHttpClient as OkHttpClient
    participant RealCall as RealCall
    participant Dispatcher as Dispatcher
    participant Chain as RealInterceptorChain
    participant Interceptors as 拦截器链
    participant Network as 网络服务器

    Client-&gt;&gt;OkHttpClient: newCall(request)
    activate OkHttpClient
    OkHttpClient-&gt;&gt;RealCall: new RealCall(client, request)
    activate RealCall
    RealCall-&gt;&gt;RealCall: 初始化Call对象
    RealCall--&gt;&gt;OkHttpClient: 返回Call实例
    deactivate RealCall
    OkHttpClient--&gt;&gt;Client: 返回Call
    deactivate OkHttpClient

    Note over Client,RealCall: 执行同步请求
    Client-&gt;&gt;RealCall: execute()
    activate RealCall

    RealCall-&gt;&gt;RealCall: 检查是否已执行
    alt 已执行
        RealCall--&gt;&gt;Client: throw IllegalStateException
    end

    RealCall-&gt;&gt;RealCall: executed = true
    RealCall-&gt;&gt;Dispatcher: executed(call)
    activate Dispatcher
    Dispatcher-&gt;&gt;Dispatcher: runningSyncCalls.add(call)
    Dispatcher--&gt;&gt;RealCall: 记录同步调用
    deactivate Dispatcher

    RealCall-&gt;&gt;RealCall: getResponseWithInterceptorChain()
    activate RealCall

    RealCall-&gt;&gt;Chain: new RealInterceptorChain()
    activate Chain
    Chain-&gt;&gt;Chain: 构建拦截器链
    Chain--&gt;&gt;RealCall: 返回Chain
    deactivate Chain

    RealCall-&gt;&gt;Chain: proceed(request)
    activate Chain
    Chain-&gt;&gt;Interceptors: 执行拦截器链
    activate Interceptors
    Note over Interceptors: 依次执行所有拦截器
    Interceptors-&gt;&gt;Network: 发送网络请求
    activate Network
    Network--&gt;&gt;Interceptors: 返回响应
    deactivate Network
    Interceptors--&gt;&gt;Chain: 返回Response
    deactivate Interceptors
    Chain--&gt;&gt;RealCall: 返回Response
    deactivate Chain

    RealCall--&gt;&gt;RealCall: 返回Response
    deactivate RealCall

    RealCall-&gt;&gt;Dispatcher: finished(call)
    activate Dispatcher
    Dispatcher-&gt;&gt;Dispatcher: runningSyncCalls.remove(call)
    Dispatcher--&gt;&gt;RealCall: 完成
    deactivate Dispatcher

    RealCall--&gt;&gt;Client: 返回Response
    deactivate RealCall
</code></pre>
<h3 data-id="heading-3">3. 异步请求执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant RealCall as RealCall
    participant Dispatcher as Dispatcher
    participant ExecutorService as 线程池
    participant AsyncCall as AsyncCall
    participant Chain as 拦截器链
    participant Callback as Callback

    Client-&gt;&gt;RealCall: enqueue(callback)
    activate RealCall

    RealCall-&gt;&gt;AsyncCall: new AsyncCall(callback)
    activate AsyncCall
    AsyncCall-&gt;&gt;AsyncCall: 封装回调
    AsyncCall--&gt;&gt;RealCall: 返回AsyncCall
    deactivate AsyncCall

    RealCall-&gt;&gt;Dispatcher: enqueue(asyncCall)
    activate Dispatcher

    Dispatcher-&gt;&gt;Dispatcher: 检查并发限制

    alt 可以立即执行
        Note over Dispatcher: runningAsyncCalls &lt; 64&lt;br/&gt;且单Host请求 &lt; 5
        Dispatcher-&gt;&gt;Dispatcher: runningAsyncCalls.add(call)
        Dispatcher-&gt;&gt;ExecutorService: execute(asyncCall)
        activate ExecutorService
        ExecutorService--&gt;&gt;Dispatcher: 提交成功
        deactivate ExecutorService
    else 需要等待
        Dispatcher-&gt;&gt;Dispatcher: readyAsyncCalls.add(call)
        Note over Dispatcher: 加入等待队列
    end

    Dispatcher--&gt;&gt;RealCall: 入队成功
    deactivate Dispatcher
    RealCall--&gt;&gt;Client: 立即返回
    deactivate RealCall

    Note over ExecutorService,AsyncCall: 在线程池中异步执行
    ExecutorService-&gt;&gt;AsyncCall: run()
    activate AsyncCall

    AsyncCall-&gt;&gt;Chain: getResponseWithInterceptorChain()
    activate Chain

    Note over Chain: 执行拦截器链
    Chain-&gt;&gt;Chain: 依次执行所有拦截器
    Chain-&gt;&gt;Chain: 发送网络请求
    Chain-&gt;&gt;Chain: 接收响应
    Chain--&gt;&gt;AsyncCall: 返回Response或抛出异常
    deactivate Chain

    alt 请求成功
        AsyncCall-&gt;&gt;Callback: onResponse(call, response)
        activate Callback
        Callback--&gt;&gt;AsyncCall: 处理成功响应
        deactivate Callback
    else 请求失败
        AsyncCall-&gt;&gt;Callback: onFailure(call, exception)
        activate Callback
        Callback--&gt;&gt;AsyncCall: 处理失败
        deactivate Callback
    end

    AsyncCall-&gt;&gt;Dispatcher: finished(asyncCall)
    activate Dispatcher
    Dispatcher-&gt;&gt;Dispatcher: runningAsyncCalls.remove(call)
    Dispatcher-&gt;&gt;Dispatcher: promoteAndExecute()

    Note over Dispatcher: 提升等待队列中的请求
    Dispatcher-&gt;&gt;Dispatcher: 遍历readyAsyncCalls
    Dispatcher-&gt;&gt;Dispatcher: 移动符合条件的到runningAsyncCalls
    Dispatcher-&gt;&gt;ExecutorService: 执行新的AsyncCall
    activate ExecutorService
    ExecutorService--&gt;&gt;Dispatcher: 提交成功
    deactivate ExecutorService

    Dispatcher--&gt;&gt;AsyncCall: 完成
    deactivate Dispatcher
    deactivate AsyncCall
</code></pre>
<h3 data-id="heading-4">4. 拦截器链执行流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant RealCall as RealCall
    participant RetryInterceptor as 1.RetryAndFollowUp
    participant BridgeInterceptor as 2.Bridge
    participant CacheInterceptor as 3.Cache
    participant ConnectInterceptor as 4.Connect
    participant CallServerInterceptor as 5.CallServer
    participant Network as 网络

    RealCall-&gt;&gt;RetryInterceptor: chain.proceed(request)
    activate RetryInterceptor
    Note over RetryInterceptor: 重试和重定向拦截器
    RetryInterceptor-&gt;&gt;RetryInterceptor: 创建StreamAllocation

    RetryInterceptor-&gt;&gt;BridgeInterceptor: chain.proceed(request)
    activate BridgeInterceptor
    Note over BridgeInterceptor: 桥接拦截器-添加Headers
    BridgeInterceptor-&gt;&gt;BridgeInterceptor: 添加Content-Type/Host&lt;br/&gt;Connection/Accept-Encoding&lt;br/&gt;Cookie/User-Agent

    BridgeInterceptor-&gt;&gt;CacheInterceptor: chain.proceed(request)
    activate CacheInterceptor
    Note over CacheInterceptor: 缓存拦截器
    CacheInterceptor-&gt;&gt;CacheInterceptor: 读取缓存

    alt 使用缓存
        Note over CacheInterceptor: 缓存有效，直接返回
        CacheInterceptor--&gt;&gt;BridgeInterceptor: 返回缓存Response
    else 需要网络请求
        CacheInterceptor-&gt;&gt;ConnectInterceptor: chain.proceed(request)
        activate ConnectInterceptor
        Note over ConnectInterceptor: 连接拦截器
        ConnectInterceptor-&gt;&gt;ConnectInterceptor: 获取/创建连接
        ConnectInterceptor-&gt;&gt;ConnectInterceptor: 建立TCP连接
        ConnectInterceptor-&gt;&gt;ConnectInterceptor: TLS握手(HTTPS)

        ConnectInterceptor-&gt;&gt;CallServerInterceptor: chain.proceed(request)
        activate CallServerInterceptor
        Note over CallServerInterceptor: 请求服务器拦截器

        CallServerInterceptor-&gt;&gt;Network: 写入请求
        activate Network
        Network-&gt;&gt;Network: 处理请求
        Network--&gt;&gt;CallServerInterceptor: 返回响应
        deactivate Network

        CallServerInterceptor--&gt;&gt;ConnectInterceptor: Response
        deactivate CallServerInterceptor

        ConnectInterceptor--&gt;&gt;CacheInterceptor: Response
        deactivate ConnectInterceptor

        CacheInterceptor-&gt;&gt;CacheInterceptor: 写入缓存(如果可缓存)
        CacheInterceptor--&gt;&gt;BridgeInterceptor: Response
    end
    deactivate CacheInterceptor

    BridgeInterceptor-&gt;&gt;BridgeInterceptor: 解压gzip/保存Cookie
    BridgeInterceptor--&gt;&gt;RetryInterceptor: Response
    deactivate BridgeInterceptor

    alt 需要重试或重定向
        Note over RetryInterceptor: 3xx/408/503状态码
        RetryInterceptor-&gt;&gt;RetryInterceptor: 构建新请求
        RetryInterceptor-&gt;&gt;BridgeInterceptor: 重新执行拦截器链
        Note over RetryInterceptor: 最多重试20次
    else 成功响应
        RetryInterceptor--&gt;&gt;RealCall: 返回最终Response
    end
    deactivate RetryInterceptor
</code></pre>
<h3 data-id="heading-5">5. 连接池管理机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Call as RealCall
    participant Interceptor as ConnectInterceptor
    participant Finder as ExchangeFinder
    participant Pool as ConnectionPool
    participant Connection as RealConnection
    participant Socket as Socket

    Note over Call,Pool: 阶段1：从连接池获取连接
    Call-&gt;&gt;Interceptor: intercept(chain)
    activate Interceptor
    Interceptor-&gt;&gt;Finder: find()
    activate Finder

    Finder-&gt;&gt;Pool: get(address, call)
    activate Pool
    Pool-&gt;&gt;Pool: 遍历connections查找匹配
    Pool-&gt;&gt;Connection: isEligible(address)
    activate Connection
    Connection-&gt;&gt;Connection: 检查Host/端口/协议
    Connection--&gt;&gt;Pool: 匹配结果
    deactivate Connection

    alt 找到匹配的连接
        Pool-&gt;&gt;Connection: acquire(call)
        activate Connection
        Connection-&gt;&gt;Connection: calls.add(call)
        Connection--&gt;&gt;Pool: 分配成功
        deactivate Connection
        Pool--&gt;&gt;Finder: 返回可用连接
        Finder--&gt;&gt;Interceptor: 返回连接
        Interceptor--&gt;&gt;Call: 使用已有连接
        Note over Call: 复用连接，流程结束
    else 未找到可用连接
        Pool--&gt;&gt;Finder: 返回null
        Note over Finder,Socket: 阶段2：创建新连接
        Finder-&gt;&gt;Connection: new RealConnection()
        activate Connection
        Connection-&gt;&gt;Socket: 建立TCP连接
        activate Socket
        Socket-&gt;&gt;Socket: connect(address, timeout)
        Socket--&gt;&gt;Connection: 连接建立
        deactivate Socket

        Connection-&gt;&gt;Connection: TLS握手(如果HTTPS)
        Connection--&gt;&gt;Finder: 返回新连接
        deactivate Connection

        Finder-&gt;&gt;Pool: put(connection)
        Pool-&gt;&gt;Pool: connections.add()
        Pool-&gt;&gt;Pool: 触发清理任务
        Pool--&gt;&gt;Finder: 加入成功
        Finder--&gt;&gt;Interceptor: 返回新连接
        Interceptor--&gt;&gt;Call: 使用新连接
        Note over Call: 新连接已就绪
    end
    deactivate Pool
    deactivate Finder
    deactivate Interceptor

    Note over Pool: 阶段3：后台清理任务
    Pool-&gt;&gt;Pool: cleanup()定期执行
    activate Pool
    Pool-&gt;&gt;Pool: 遍历所有连接
    Pool-&gt;&gt;Connection: 检查空闲时间和数量
    activate Connection

    Connection-&gt;&gt;Connection: 判断清理条件
    Note over Connection: 空闲&gt;5分钟 或 超过最大数5
    Connection--&gt;&gt;Pool: 返回是否需要清理
    deactivate Connection

    Pool-&gt;&gt;Pool: 移除过期连接
    Pool-&gt;&gt;Connection: close()
    activate Connection
    Connection-&gt;&gt;Connection: 关闭Socket
    deactivate Connection
    Pool-&gt;&gt;Pool: 计算下次清理时间
    deactivate Pool
</code></pre>
<h3 data-id="heading-6">6. HTTP/2 多路复用机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Call1 as Request1
    participant Call2 as Request2
    participant Connection as RealConnection
    participant Http2 as Http2Connection
    participant Stream1 as Http2Stream(id=1)
    participant Stream2 as Http2Stream(id=3)
    participant Socket as TCP Socket
    participant Server as 服务器

    Note over Call1,Connection: 第一个请求建立HTTP/2连接
    Call1-&gt;&gt;Connection: connect()
    activate Connection
    Connection-&gt;&gt;Socket: 建立TCP连接
    activate Socket
    Socket--&gt;&gt;Connection: 连接成功
    Connection-&gt;&gt;Http2: new Http2Connection()
    activate Http2
    Http2-&gt;&gt;Socket: 发送连接前言(Preface)
    Socket-&gt;&gt;Server: PRI * HTTP/2.0
    activate Server
    Server--&gt;&gt;Socket: 返回SETTINGS帧
    Socket-&gt;&gt;Http2: 接收SETTINGS帧
    Http2-&gt;&gt;Http2: 初始化连接参数
    Http2--&gt;&gt;Connection: HTTP/2连接就绪
    deactivate Http2
    deactivate Socket
    deactivate Connection

    Note over Call1,Stream1: 第一个请求使用Stream1
    Call1-&gt;&gt;Http2: newStream()
    activate Http2
    Http2-&gt;&gt;Stream1: new Http2Stream(streamId=1)
    activate Stream1
    Stream1--&gt;&gt;Http2: 返回Stream1
    Http2--&gt;&gt;Call1: 返回Stream1
    deactivate Http2

    Call1-&gt;&gt;Stream1: writeRequestHeaders()
    Stream1-&gt;&gt;Socket: 发送HEADERS帧(streamId=1)
    activate Socket
    Socket-&gt;&gt;Server: HEADERS帧
    Stream1-&gt;&gt;Socket: 发送DATA帧(streamId=1)
    Socket-&gt;&gt;Server: DATA帧
    deactivate Socket

    Note over Call2,Stream2: 第二个请求复用同一连接
    Call2-&gt;&gt;Connection: 获取已有连接
    activate Connection
    Connection--&gt;&gt;Call2: 返回相同的Http2Connection
    deactivate Connection

    Call2-&gt;&gt;Http2: newStream()
    activate Http2
    Http2-&gt;&gt;Stream2: new Http2Stream(streamId=3)
    activate Stream2
    Stream2--&gt;&gt;Http2: 返回Stream2
    Http2--&gt;&gt;Call2: 返回Stream2
    deactivate Http2

    Note over Stream1,Stream2: 两个流在同一TCP连接上并发

    Call2-&gt;&gt;Stream2: writeRequestHeaders()
    Stream2-&gt;&gt;Socket: 发送HEADERS帧(streamId=3)
    activate Socket
    Socket-&gt;&gt;Server: HEADERS帧
    Stream2-&gt;&gt;Socket: 发送DATA帧(streamId=3)
    Socket-&gt;&gt;Server: DATA帧

    Note over Server: 服务器并发处理两个请求

    Server-&gt;&gt;Socket: HEADERS帧(streamId=1)
    Socket-&gt;&gt;Stream1: 接收HEADERS帧
    Stream1-&gt;&gt;Call1: onResponse()
    activate Call1

    Server-&gt;&gt;Socket: DATA帧(streamId=3)
    Socket-&gt;&gt;Stream2: 接收DATA帧
    Stream2-&gt;&gt;Call2: onResponse()
    activate Call2

    Server-&gt;&gt;Socket: DATA帧(streamId=1)
    Socket-&gt;&gt;Stream1: 接收DATA帧
    Stream1--&gt;&gt;Call1: 响应体
    deactivate Call1

    Server-&gt;&gt;Socket: DATA帧(streamId=3, END_STREAM)
    Socket-&gt;&gt;Stream2: 接收DATA帧
    Stream2--&gt;&gt;Call2: 响应体
    deactivate Socket
    deactivate Server
    deactivate Call2

    Stream1-&gt;&gt;Stream1: 流关闭
    deactivate Stream1
    Stream2-&gt;&gt;Stream2: 流关闭
    deactivate Stream2
</code></pre>
<h3 data-id="heading-7">7. 缓存机制详解</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Call as RealCall
    participant CacheInterceptor as CacheInterceptor
    participant Cache as Cache
    participant DiskLruCache as DiskLruCache
    participant CacheStrategy as CacheStrategy
    participant Network as 网络

    Call-&gt;&gt;CacheInterceptor: intercept(chain)
    activate CacheInterceptor

    Note over CacheInterceptor,Cache: 阶段1：读取缓存
    CacheInterceptor-&gt;&gt;Cache: get(request)
    activate Cache
    Cache-&gt;&gt;Cache: 计算key = hash(url)
    Cache-&gt;&gt;DiskLruCache: get(key)
    activate DiskLruCache
    DiskLruCache-&gt;&gt;DiskLruCache: 读取缓存文件
    DiskLruCache--&gt;&gt;Cache: 返回缓存条目或null
    deactivate DiskLruCache
    Cache-&gt;&gt;Cache: 解析响应头和响应体
    Cache--&gt;&gt;CacheInterceptor: 返回Response或null
    deactivate Cache

    Note over CacheInterceptor,CacheStrategy: 阶段2：确定缓存策略
    CacheInterceptor-&gt;&gt;CacheStrategy: get(request, cacheResponse)
    activate CacheStrategy
    CacheStrategy-&gt;&gt;CacheStrategy: 分析Cache-Control
    CacheStrategy-&gt;&gt;CacheStrategy: 检查max-age/Expires
    CacheStrategy-&gt;&gt;CacheStrategy: 检查ETag/Last-Modified
    CacheStrategy--&gt;&gt;CacheInterceptor: 返回策略(networkRequest, cacheResponse)
    deactivate CacheStrategy

    Note over CacheInterceptor: 阶段3：执行策略

    alt 策略1：仅使用缓存
        Note over CacheInterceptor: networkRequest==null
        CacheInterceptor--&gt;&gt;Call: 返回缓存Response
    else 策略2：发送网络请求
        CacheInterceptor-&gt;&gt;Network: chain.proceed(request)
        activate Network
        Network--&gt;&gt;CacheInterceptor: 返回networkResponse
        deactivate Network

        alt 响应304 Not Modified
            CacheInterceptor-&gt;&gt;CacheInterceptor: 合并缓存和网络响应
            CacheInterceptor-&gt;&gt;Cache: update(cacheResponse)
            activate Cache
            Cache-&gt;&gt;DiskLruCache: 更新响应头
            activate DiskLruCache
            DiskLruCache--&gt;&gt;Cache: 更新成功
            deactivate DiskLruCache
            Cache--&gt;&gt;CacheInterceptor: 完成
            deactivate Cache
            CacheInterceptor--&gt;&gt;Call: 返回更新后的缓存
        else 响应200 OK
            CacheInterceptor-&gt;&gt;CacheInterceptor: 检查是否可缓存
            CacheInterceptor-&gt;&gt;Cache: put(response)
            activate Cache
            Cache-&gt;&gt;Cache: 验证Cache-Control
            Cache-&gt;&gt;Cache: 验证响应码
            Cache-&gt;&gt;DiskLruCache: put(key, response)
            activate DiskLruCache
            DiskLruCache-&gt;&gt;DiskLruCache: 写入响应头
            DiskLruCache-&gt;&gt;DiskLruCache: 写入响应体
            DiskLruCache--&gt;&gt;Cache: 写入成功
            deactivate DiskLruCache
            Cache--&gt;&gt;CacheInterceptor: 缓存成功
            deactivate Cache
            CacheInterceptor--&gt;&gt;Call: 返回网络Response
        end
    end

    deactivate CacheInterceptor
</code></pre>
<h3 data-id="heading-8">8. WebSocket 连接机制</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 开发者代码
    participant OkHttpClient as OkHttpClient
    participant RealWebSocket as RealWebSocket
    participant WebSocketWriter as WebSocketWriter
    participant WebSocketReader as WebSocketReader
    participant RealCall as RealCall
    participant Server as WebSocket服务器

    Client-&gt;&gt;OkHttpClient: newWebSocket(request, listener)
    activate OkHttpClient

    OkHttpClient-&gt;&gt;RealWebSocket: new RealWebSocket()
    activate RealWebSocket
    RealWebSocket-&gt;&gt;RealWebSocket: 初始化WebSocket
    RealWebSocket--&gt;&gt;OkHttpClient: 返回WebSocket实例
    OkHttpClient--&gt;&gt;Client: 返回WebSocket
    deactivate OkHttpClient

    Note over RealWebSocket: 发起WebSocket握手
    RealWebSocket-&gt;&gt;RealCall: 创建HTTP升级请求
    activate RealCall
    RealCall-&gt;&gt;RealCall: 添加升级Headers&lt;br/&gt;Upgrade: websocket&lt;br/&gt;Connection: Upgrade&lt;br/&gt;Sec-WebSocket-Key&lt;br/&gt;Sec-WebSocket-Version: 13

    RealCall-&gt;&gt;Server: 发送HTTP请求
    activate Server
    Server-&gt;&gt;Server: 验证WebSocket握手
    Server--&gt;&gt;RealCall: 101 Switching Protocols
    deactivate Server

    RealCall-&gt;&gt;RealCall: 验证响应&lt;br/&gt;Sec-WebSocket-Accept
    RealCall--&gt;&gt;RealWebSocket: 握手成功
    deactivate RealCall

    Note over RealWebSocket: 初始化读写
    RealWebSocket-&gt;&gt;WebSocketWriter: initWriter(streams)
    activate WebSocketWriter
    WebSocketWriter-&gt;&gt;WebSocketWriter: 初始化输出流
    WebSocketWriter--&gt;&gt;RealWebSocket: Writer就绪
    deactivate WebSocketWriter

    RealWebSocket-&gt;&gt;WebSocketReader: initReader(streams)
    activate WebSocketReader
    WebSocketReader-&gt;&gt;WebSocketReader: 初始化输入流
    WebSocketReader--&gt;&gt;RealWebSocket: Reader就绪
    deactivate WebSocketReader

    RealWebSocket-&gt;&gt;Client: onOpen(webSocket, response)
    activate Client
    Client--&gt;&gt;RealWebSocket: 连接已打开
    deactivate Client

    Note over Client,Server: 双向通信阶段

    Client-&gt;&gt;RealWebSocket: send(text)
    activate RealWebSocket
    RealWebSocket-&gt;&gt;WebSocketWriter: writeMessageFrame(TEXT, text)
    activate WebSocketWriter
    WebSocketWriter-&gt;&gt;WebSocketWriter: 添加掩码(Mask)
    WebSocketWriter-&gt;&gt;WebSocketWriter: 构建WebSocket帧
    WebSocketWriter-&gt;&gt;Server: 发送TEXT帧
    activate Server
    WebSocketWriter--&gt;&gt;RealWebSocket: 发送成功
    deactivate WebSocketWriter
    RealWebSocket--&gt;&gt;Client: 返回true
    deactivate RealWebSocket

    Server-&gt;&gt;WebSocketReader: 接收TEXT帧
    activate WebSocketReader
    WebSocketReader-&gt;&gt;WebSocketReader: 读取帧头
    WebSocketReader-&gt;&gt;WebSocketReader: 读取Payload
    WebSocketReader-&gt;&gt;RealWebSocket: processFrame(TEXT, payload)
    deactivate WebSocketReader
    activate RealWebSocket
    RealWebSocket-&gt;&gt;Client: onMessage(text)
    activate Client
    Client--&gt;&gt;RealWebSocket: 处理消息
    deactivate Client
    deactivate RealWebSocket

    Note over RealWebSocket,Server: Ping/Pong心跳

    RealWebSocket-&gt;&gt;WebSocketWriter: writePing()
    activate WebSocketWriter
    WebSocketWriter-&gt;&gt;Server: 发送PING帧
    Server--&gt;&gt;WebSocketWriter: 返回PONG帧
    deactivate Server
    deactivate WebSocketWriter

    WebSocketReader-&gt;&gt;RealWebSocket: processPong()
    activate WebSocketReader
    activate RealWebSocket
    RealWebSocket-&gt;&gt;RealWebSocket: 更新最后Pong时间
    deactivate RealWebSocket
    deactivate WebSocketReader

    Note over Client,Server: 关闭连接

    Client-&gt;&gt;RealWebSocket: close(code, reason)
    activate RealWebSocket
    RealWebSocket-&gt;&gt;WebSocketWriter: writeClose(code, reason)
    activate WebSocketWriter
    WebSocketWriter-&gt;&gt;Server: 发送CLOSE帧
    activate Server
    WebSocketWriter--&gt;&gt;RealWebSocket: 发送成功
    deactivate WebSocketWriter

    Server-&gt;&gt;WebSocketReader: 接收CLOSE帧
    activate WebSocketReader
    WebSocketReader-&gt;&gt;RealWebSocket: processClose()
    deactivate WebSocketReader
    RealWebSocket-&gt;&gt;Client: onClosing(code, reason)
    activate Client
    Client--&gt;&gt;RealWebSocket: 确认关闭
    deactivate Client

    Server--&gt;&gt;RealWebSocket: 关闭连接
    deactivate Server

    RealWebSocket-&gt;&gt;Client: onClosed(code, reason)
    activate Client
    Client--&gt;&gt;RealWebSocket: 连接已关闭
    deactivate Client
    deactivate RealWebSocket
</code></pre>
<h3 data-id="heading-9">9. 完整请求生命周期流程图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([创建Request]) --&gt; NewCall[OkHttpClient.newCall]
    NewCall --&gt; ChooseSync{同步还是异步?}

    ChooseSync --&gt;|execute| SyncExec[同步执行]
    ChooseSync --&gt;|enqueue| AsyncExec[异步执行]

    SyncExec --&gt; CheckExecuted{是否已执行?}
    CheckExecuted --&gt;|是| ThrowError[抛出异常]
    CheckExecuted --&gt;|否| MarkExecuted[标记已执行]

    AsyncExec --&gt; EnqueueAsync[加入Dispatcher队列]
    EnqueueAsync --&gt; CheckLimit{检查并发限制}
    CheckLimit --&gt;|达到上限| AddToReady[加入就绪队列]
    CheckLimit --&gt;|未达上限| AddToRunning[加入运行队列]
    AddToRunning --&gt; ExecuteInPool[线程池执行]

    MarkExecuted --&gt; BuildChain[构建拦截器链]
    ExecuteInPool --&gt; BuildChain

    BuildChain --&gt; Interceptor1[RetryAndFollowUp&lt;br/&gt;重试和重定向]
    Interceptor1 --&gt; Interceptor2[BridgeInterceptor&lt;br/&gt;桥接拦截器]
    Interceptor2 --&gt; Interceptor3[CacheInterceptor&lt;br/&gt;缓存拦截器]

    Interceptor3 --&gt; CheckCache{检查缓存}
    CheckCache --&gt;|有效缓存| ReturnCache[返回缓存响应]
    CheckCache --&gt;|无缓存/失效| Interceptor4[ConnectInterceptor&lt;br/&gt;连接拦截器]

    Interceptor4 --&gt; FindConnection{查找连接}
    FindConnection --&gt;|池中有可用连接| ReuseConnection[复用连接]
    FindConnection --&gt;|无可用连接| CreateConnection[创建新连接]

    CreateConnection --&gt; TCPConnect[建立TCP连接]
    TCPConnect --&gt; CheckProtocol{协议类型?}
    CheckProtocol --&gt;|HTTP| HTTP1[HTTP/1.1]
    CheckProtocol --&gt;|HTTPS| TLSHandshake[TLS握手]
    TLSHandshake --&gt; CheckHTTP2{是否支持HTTP/2?}
    CheckHTTP2 --&gt;|是| HTTP2[HTTP/2]
    CheckHTTP2 --&gt;|否| HTTP1

    ReuseConnection --&gt; AddToPool[加入连接池]
    HTTP1 --&gt; AddToPool
    HTTP2 --&gt; AddToPool

    AddToPool --&gt; Interceptor5[CallServerInterceptor&lt;br/&gt;请求服务器]

    Interceptor5 --&gt; WriteRequest[写入请求]
    WriteRequest --&gt; WriteHeaders[写入请求头]
    WriteHeaders --&gt; CheckBody{有请求体?}
    CheckBody --&gt;|是| WriteBody[写入请求体]
    CheckBody --&gt;|否| ReadResponse[读取响应]
    WriteBody --&gt; ReadResponse

    ReadResponse --&gt; ReadHeaders[读取响应头]
    ReadHeaders --&gt; ReadBody[读取响应体]

    ReadBody --&gt; CheckStatus{检查状态码}
    CheckStatus --&gt;|3xx| CheckRedirect{是否重定向?}
    CheckRedirect --&gt;|是| Interceptor1
    CheckRedirect --&gt;|否| ProcessResponse

    CheckStatus --&gt;|2xx/4xx/5xx| ProcessResponse[处理响应]

    ReturnCache --&gt; ProcessResponse
    ProcessResponse --&gt; SaveCache{是否可缓存?}
    SaveCache --&gt;|是| WriteCache[写入缓存]
    SaveCache --&gt;|否| ReturnResponse

    WriteCache --&gt; ReturnResponse[返回Response]

    ReturnResponse --&gt; FinishCall{执行类型?}
    FinishCall --&gt;|同步| RemoveSync[从同步队列移除]
    FinishCall --&gt;|异步| RemoveAsync[从异步队列移除]

    RemoveAsync --&gt; PromoteWaiting[提升等待队列]
    PromoteWaiting --&gt; ExecuteNext[执行下一个请求]

    RemoveSync --&gt; End([请求完成])
    ExecuteNext --&gt; End

    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style CheckCache fill:#fff4e1
    style FindConnection fill:#e1f0ff
    style CheckStatus fill:#ffe1f0
</code></pre>
<h3 data-id="heading-10">核心类关系说明</h3>
<h4 data-id="heading-11">1. OkHttpClient</h4>
<ul>
<li><strong>职责</strong>: 框架入口，管理全局配置</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>Dispatcher</code>: 调度器，管理异步请求队列</li>
<li><code>ConnectionPool</code>: 连接池，管理连接复用</li>
<li><code>List&lt;Interceptor&gt;</code>: 应用拦截器列表</li>
<li><code>List&lt;Interceptor&gt;</code>: 网络拦截器列表</li>
<li><code>Cache</code>: 缓存管理器</li>
</ul>
</li>
<li><strong>配置项</strong>:
<ul>
<li>超时时间(连接、读、写)</li>
<li>代理设置</li>
<li>SSL配置</li>
<li>Cookie管理器</li>
<li>DNS解析器</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">2. RealCall</h4>
<ul>
<li><strong>职责</strong>: 真正的Call实现，封装单个HTTP请求</li>
<li><strong>核心方法</strong>:
<ul>
<li><code>execute()</code>: 同步执行</li>
<li><code>enqueue(Callback)</code>: 异步执行</li>
<li><code>cancel()</code>: 取消请求</li>
<li><code>getResponseWithInterceptorChain()</code>: 执行拦截器链</li>
</ul>
</li>
<li><strong>状态管理</strong>:
<ul>
<li><code>executed</code>: 是否已执行</li>
<li><code>canceled</code>: 是否已取消</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">3. Dispatcher</h4>
<ul>
<li><strong>职责</strong>: 请求调度器，管理并发策略</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>ExecutorService</code>: 线程池</li>
<li><code>Deque&lt;AsyncCall&gt; readyAsyncCalls</code>: 等待队列</li>
<li><code>Deque&lt;AsyncCall&gt; runningAsyncCalls</code>: 运行队列</li>
<li><code>Deque&lt;RealCall&gt; runningSyncCalls</code>: 同步调用队列</li>
</ul>
</li>
<li><strong>并发控制</strong>:
<ul>
<li>最大并发请求数: 64</li>
<li>单Host最大并发: 5</li>
<li><code>promoteAndExecute()</code>: 提升等待队列中的请求</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">4. RealInterceptorChain</h4>
<ul>
<li><strong>职责</strong>: 拦截器链的实现，责任链模式</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>List&lt;Interceptor&gt; interceptors</code>: 拦截器列表</li>
<li><code>int index</code>: 当前拦截器索引</li>
<li><code>Request request</code>: 当前请求</li>
<li><code>Call call</code>: 关联的Call对象</li>
</ul>
</li>
<li><strong>核心方法</strong>:
<ul>
<li><code>proceed(Request)</code>: 继续执行下一个拦截器</li>
</ul>
</li>
</ul>
<h4 data-id="heading-15">5. 内置拦截器</h4>
<h5 data-id="heading-16">RetryAndFollowUpInterceptor</h5>
<ul>
<li><strong>职责</strong>: 重试和重定向</li>
<li><strong>功能</strong>:
<ul>
<li>创建StreamAllocation</li>
<li>处理连接失败重试</li>
<li>处理重定向(3xx状态码)</li>
<li>最大重定向次数: 20</li>
</ul>
</li>
</ul>
<h5 data-id="heading-17">BridgeInterceptor</h5>
<ul>
<li><strong>职责</strong>: 桥接应用层和网络层</li>
<li><strong>功能</strong>:
<ul>
<li>添加必要的请求头(Host、Content-Type等)</li>
<li>处理Cookie</li>
<li>处理gzip压缩</li>
<li>保存响应Cookie</li>
</ul>
</li>
</ul>
<h5 data-id="heading-18">CacheInterceptor</h5>
<ul>
<li><strong>职责</strong>: 缓存管理</li>
<li><strong>功能</strong>:
<ul>
<li>读取缓存</li>
<li>缓存策略(CacheStrategy)</li>
<li>处理304 Not Modified</li>
<li>写入缓存</li>
</ul>
</li>
</ul>
<h5 data-id="heading-19">ConnectInterceptor</h5>
<ul>
<li><strong>职责</strong>: 建立连接</li>
<li><strong>功能</strong>:
<ul>
<li>从连接池获取连接</li>
<li>创建新连接(TCP、TLS)</li>
<li>HTTP/2协商</li>
<li>将连接加入连接池</li>
</ul>
</li>
</ul>
<h5 data-id="heading-20">CallServerInterceptor</h5>
<ul>
<li><strong>职责</strong>: 发送请求和接收响应</li>
<li><strong>功能</strong>:
<ul>
<li>写入请求头和请求体</li>
<li>读取响应头和响应体</li>
<li>处理100-continue</li>
<li>处理分块传输编码</li>
</ul>
</li>
</ul>
<h4 data-id="heading-21">6. ConnectionPool</h4>
<ul>
<li><strong>职责</strong>: HTTP连接池管理</li>
<li><strong>核心配置</strong>:
<ul>
<li>最大空闲连接数: 5</li>
<li>连接保活时间: 5分钟</li>
</ul>
</li>
<li><strong>核心方法</strong>:
<ul>
<li><code>get(Address, Call)</code>: 获取可用连接</li>
<li><code>put(RealConnection)</code>: 添加连接到池</li>
<li><code>cleanup()</code>: 清理过期连接</li>
</ul>
</li>
<li><strong>清理策略</strong>:
<ul>
<li>后台线程定期清理</li>
<li>清理空闲超时的连接</li>
<li>清理超过最大空闲数的连接</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">7. RealConnection</h4>
<ul>
<li><strong>职责</strong>: 真正的物理连接</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>Socket rawSocket</code>: TCP Socket</li>
<li><code>Socket socket</code>: 可能是TLS包装的Socket</li>
<li><code>Protocol protocol</code>: HTTP/1.1 或 HTTP/2</li>
<li><code>Http2Connection http2Connection</code>: HTTP/2连接</li>
</ul>
</li>
<li><strong>生命周期</strong>:
<ul>
<li>建立连接(connect)</li>
<li>执行请求(可复用)</li>
<li>空闲回收</li>
</ul>
</li>
</ul>
<h4 data-id="heading-23">8. Cache</h4>
<ul>
<li><strong>职责</strong>: HTTP缓存实现</li>
<li><strong>底层实现</strong>: DiskLruCache</li>
<li><strong>缓存键</strong>: URL的MD5哈希</li>
<li><strong>缓存内容</strong>:
<ul>
<li>响应头(Journal文件)</li>
<li>响应体(单独的缓存文件)</li>
</ul>
</li>
<li><strong>缓存策略</strong>:
<ul>
<li>遵循HTTP缓存规范</li>
<li>Cache-Control、Expires、ETag、Last-Modified</li>
</ul>
</li>
</ul>
<h4 data-id="heading-24">9. Http2Connection</h4>
<ul>
<li><strong>职责</strong>: HTTP/2连接管理</li>
<li><strong>核心特性</strong>:
<ul>
<li>多路复用: 单个连接支持多个流</li>
<li>流量控制: Window size管理</li>
<li>服务器推送</li>
<li>头部压缩(HPACK)</li>
</ul>
</li>
<li><strong>核心成员</strong>:
<ul>
<li><code>Map&lt;Integer, Http2Stream&gt; streams</code>: 流映射表</li>
<li><code>Settings peerSettings</code>: 对端配置</li>
<li><code>Settings okHttpSettings</code>: 本地配置</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">10. WebSocket</h4>
<ul>
<li><strong>职责</strong>: WebSocket协议支持</li>
<li><strong>核心组件</strong>:
<ul>
<li><code>RealWebSocket</code>: WebSocket实现</li>
<li><code>WebSocketReader</code>: 读取WebSocket帧</li>
<li><code>WebSocketWriter</code>: 写入WebSocket帧</li>
</ul>
</li>
<li><strong>帧类型</strong>:
<ul>
<li>TEXT: 文本消息</li>
<li>BINARY: 二进制消息</li>
<li>PING/PONG: 心跳</li>
<li>CLOSE: 关闭连接</li>
</ul>
</li>
</ul>
<h3 data-id="heading-26">OkHttp 特性总结</h3>
<h4 data-id="heading-27">并发策略</h4>
<ul>
<li><strong>异步请求</strong>: 通过Dispatcher管理线程池</li>
<li><strong>最大并发</strong>: 全局64个，单Host 5个</li>
<li><strong>队列管理</strong>: 等待队列自动提升到运行队列</li>
</ul>
<h4 data-id="heading-28">连接管理</h4>
<ul>
<li><strong>连接复用</strong>: ConnectionPool管理连接池</li>
<li><strong>HTTP/1.1</strong>: Keep-Alive保持连接</li>
<li><strong>HTTP/2</strong>: 多路复用，单连接多流</li>
<li><strong>自动清理</strong>: 后台线程定期清理过期连接</li>
</ul>
<h4 data-id="heading-29">缓存策略</h4>
<ul>
<li><strong>DiskLruCache</strong>: 基于磁盘的LRU缓存</li>
<li><strong>HTTP规范</strong>: 遵循RFC 7234缓存规范</li>
<li><strong>条件请求</strong>: 支持If-None-Match、If-Modified-Since</li>
<li><strong>透明压缩</strong>: 自动处理gzip压缩</li>
</ul>
<h4 data-id="heading-30">协议支持</h4>
<ul>
<li><strong>HTTP/1.1</strong>: 基础协议</li>
<li><strong>HTTP/2</strong>: 多路复用、服务器推送</li>
<li><strong>HTTPS</strong>: TLS/SSL支持</li>
<li><strong>WebSocket</strong>: 全双工通信</li>
</ul>
<h4 data-id="heading-31">拦截器机制</h4>
<ul>
<li><strong>责任链模式</strong>: 灵活的请求/响应处理</li>
<li><strong>应用拦截器</strong>: 最外层，看到的是应用层的请求/响应</li>
<li><strong>网络拦截器</strong>: 网络层，看到的是实际网络传输的请求/响应</li>
<li><strong>内置拦截器</strong>: 重试、桥接、缓存、连接、请求服务器</li>
</ul>
<hr/>
<blockquote>
<p>本文档深入剖析了OkHttp3框架的内部工作机制，涵盖了从客户端创建到请求执行的完整流程，包括连接池、缓存、HTTP/2、WebSocket等高级特性。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI智能体：七十二、交叉验证：从模型评估的基石到大模型时代的演进]]></title>    <link>https://juejin.cn/post/7590469811408584731</link>    <guid>https://juejin.cn/post/7590469811408584731</guid>    <pubDate>2026-01-03T03:13:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590469811408584731" data-draft-id="7590452143016247334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI智能体：七十二、交叉验证：从模型评估的基石到大模型时代的演进"/> <meta itemprop="keywords" content="人工智能,Python,LLM"/> <meta itemprop="datePublished" content="2026-01-03T03:13:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彼岸花开了吗"/> <meta itemprop="url" content="https://juejin.cn/user/4153315734334538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI智能体：七十二、交叉验证：从模型评估的基石到大模型时代的演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153315734334538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彼岸花开了吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T03:13:17.000Z" title="Sat Jan 03 2026 03:13:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 前言</h2>
<p>在机器学习的核心工作流中，模型评估与选择是确保最终模型泛化能力的关键。当数据有限时，如何准确评估模型性能、避免过拟合成为核心挑战。交叉验证作为一种强大而经典的统计方法，通过最大限度地利用有限数据，为我们提供了对模型性能更稳健、更无偏的估计。它不仅是传统机器学习中模型选择与超参数调优的黄金标准，更以其“重复利用与平均验证”的核心理念，深刻影响了现代机器学习的工作范式。</p>
<p>今天我们将深入浅出地解析交叉验证的思想起源与数学基础，详细剖析k折交叉验证等主流变体的工作机制与实现细节，并系统展示其如何科学地指导模型比较与超参数优化。随着我们进入大模型时代，面对千亿参数与海量数据，交叉验证的传统形式正经历深刻演变。我们将探讨其在大规模预训练、指令微调等新场景下面临的挑战与适应性调整，揭示这一经典方法在现代AI实践中的全新定位与价值延续。从基础原理到前沿应用，构建交叉验证的完整知识体系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84828a7b43e54c0fb95979f4fb4a7ebb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=WlxahjtF6%2BJj9Y2wGQws%2FpGxfQI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、什么是交叉验证</h2>
<p>当我们开发一个预测模型时，最大的挑战是如何准确判断这个模型在未知数据上的表现。如果仅仅使用单次的数据划分，比如用70%数据训练、30%数据测试，评估结果往往会受到具体划分方式的强烈影响。这种划分可能恰好让模型碰上好运，也可能让模型遭遇不测，从而导致我们对模型性能产生过于乐观或悲观的误判。</p>
<p>交叉验证的精妙之处就在于它采用了一种轮换验证的机制。以最常用的5折交叉验证为例，它将原始数据随机均匀分成5个互斥的子集。在每一轮验证中，其中一个子集扮演验证集的角色，用来测试模型性能，而其余四个子集则共同组成训练集，用于模型构建。这个过程重复进行5次，确保每个数据子集都有机会被用作验证集，最终将5次验证结果进行平均，得到模型的综合性能评分。</p>
<p><strong>这种方法带来了两个关键优势：</strong></p>
<ul>
<li>首先，它极大地降低了评估结果的随机性，使得性能估计更加稳定和可靠。无论数据如何分布，通过这种轮换测试得到的平均成绩都能够更真实地反映模型的泛化能力。</li>
<li>其次，它最大限度地利用了有限的数据资源，让几乎所有的样本都既参与了训练又参与了验证，这对于数据稀缺的场景尤其宝贵。</li>
</ul>
<p>用一个更生活化的例子来通俗的解释交叉验证，如果我们想判断一位家教老师的教学水平如何：</p>
<p><strong>1. 普通的方法，单次测试：</strong></p>
<ul>
<li>假设我们有10套真题，一般我们会让这位老师只用8套真题辅导学生，然后用剩下的2套真题来测试学生成绩。</li>
<li>问题：如果测试用的2套题恰好是老师重点讲过的题型，成绩就会虚高；反之，如果全是没讲过的冷门题，成绩就会偏低，这种评估方式非常依赖运气。</li>
</ul>
<p><strong>2. 交叉验证的方法，轮换测试：</strong></p>
<p>我们可以采用更科学的方式来评估：</p>
<ul>
<li>第一步：准备5套难度相近的测试卷（A、B、C、D、E）。</li>
<li>第二步：进行5轮教学测试：
<ul>
<li>第1轮：老师用 B、C、D、E 卷辅导学生，然后用 A卷 测试，记录分数。</li>
<li>第2轮：老师用 A、C、D、E 卷辅导学生，然后用 B卷 测试，记录分数。</li>
<li>重复这个过程，直到每套试卷都当过一次测试卷。</li>
</ul>
</li>
<li>第三步：计算这5个分数的平均值。</li>
</ul>
<p>这个平均分就能客观、稳定地反映出老师的真实教学水平。</p>
<p><strong>交叉验证体现的价值：</strong></p>
<ul>
<li>评估更公平：不依赖某一次特定的考试运气，结果更具代表性。</li>
<li>数据利用更高效：所有试卷都既用于教学又用于测试，物尽其用。</li>
</ul>
<p>综上所诉，交叉验证就像一套严谨的教师评估体系，通过轮换测试取平均分的方式，确保评估结果的客观性和可靠性，帮助我们做出最佳决策。</p>
<h2 data-id="heading-2">三、交叉验证的特点</h2>
<p>在理想情况下，我们拥有无限的数据。我们可以将数据分为三部分：</p>
<ul>
<li>训练集：用于构建模型。</li>
<li>验证集：用于在训练过程中评估模型，指导模型选择和调参。</li>
<li>测试集：用于最终、一次性地评估模型的泛化性能，模拟真实世界应用。</li>
</ul>
<p>然而，现实是数据通常有限。如果我们简单地使用一个固定的“训练-验证”分割，会引入两个主要问题：</p>
<ul>
<li>**1. 评估结果方差高：**模型性能对数据如何分割非常敏感。一次幸运或不幸的分割可能导致我们对模型性能产生过于乐观或悲观的估计。</li>
<li>**2. 数据利用不充分：**特别是当数据集较小时，留出一部分作为验证集意味着模型无法从这些宝贵的数据中学习，这本身就会导致模型性能下降。</li>
</ul>
<p>**交叉验证的核心理念：**通过多次、有组织地划分训练集和验证集，让每一份数据都有机会充当训练集和验证集，从而得到多个性能评估值。最终，我们取这些评估值的平均值作为模型性能的最终估计。这种方法显著降低了评估结果的方差，并更充分地利用了数据。</p>
<h2 data-id="heading-3">四、k折交叉验证</h2>
<p>在众多交叉验证方法中，k折交叉验证 无疑是最常用、最经典的一种。</p>
<p><strong>工作原理：</strong></p>
<ul>
<li>**1. 分割：**将原始训练数据集随机、均匀地分割成k个大小相似的互斥子集，称为“折”，通常k取5或10。</li>
<li>**2. 迭代训练与验证：**进行k次迭代。在每一次迭代 i (i=1, 2, ..., k) 中：
<ul>
<li>将第 i 折数据作为验证集。</li>
<li>将剩余的 k-1 折数据合并，作为训练集。</li>
<li>在训练集上训练模型，并在验证集上评估模型，得到一个性能得分 S_i（如准确率、F1分数等）。</li>
</ul>
</li>
<li>**3. 性能汇总：**完成k次迭代后，我们会得到k个性能得分 S_1, S_2, ..., S_k。</li>
<li>**4. 计算最终性能：**将这k个得分取平均值，作为该模型泛化性能的最终估计：
<ul>
<li>最终性能 = (S_1 + S_2 + ... + S_k) / k</li>
</ul>
</li>
<li>**5. 报告不确定性：**同时，我们还可以计算这k个得分的标准差，以衡量模型性能的稳定性。标准差越小，说明模型对数据分割不敏感，越稳定。</li>
</ul>
<p><strong>执行过程：</strong></p>
<p>假设 k=5，过程如下所示：</p>
<blockquote>
<p>初始数据集: [------------------------------------]<br/>
分割为5折: [折1][折2][折3][折4][折5]</p>
<p>迭代1: 训练集:[折2][折3][折4][折5] 验证集:[折1] -&gt; 得分S1<br/>
迭代2: 训练集:[折1][折3][折4][折5] 验证集:[折2] -&gt; 得分S2<br/>
迭代3: 训练集:[折1][折2][折4][折5] 验证集:[折3] -&gt; 得分S3<br/>
迭代4: 训练集:[折1][折2][折3][折5] 验证集:[折4] -&gt; 得分S4<br/>
迭代5: 训练集:[折1][折2][折3][折4] 验证集:[折5] -&gt; 得分S5</p>
</blockquote>
<p><strong>k值的选择：</strong></p>
<ul>
<li>k较小（如k=5）：训练成本低，但评估结果的偏差可能略高，因为训练集相对较小。</li>
<li>k较大（如k=10）：评估结果的偏差更低，更接近真实泛化性能，但训练成本是k=5的两倍。</li>
<li>留一法交叉验证：k等于样本数N，这是k折交叉验证的极端情况，它能最无偏地估计性能，但计算成本极高，通常只用于极小型数据集。</li>
</ul>
<h2 data-id="heading-4">五、交叉验证在模型选择中的作用</h2>
<p>交叉验证本身是一个评估方法，但其威力在模型比较和超参数优化中得以真正体现。</p>
<h3 data-id="heading-5">1. 模型选择</h3>
<p>假设我们需要在逻辑回归、支持向量机和随机森林中选择一个最佳模型。我们不能直接在测试集上测试并选择最好的，因为这会导致信息泄露，使测试集失去其最终评估的意义。</p>
<p>**正确做法：**对每个候选模型，独立进行一次k折交叉验证，得到各自的平均性能得分，然后选择平均得分最高的模型，这个过程完全在原始训练集内完成，没有动用测试集。</p>
<h3 data-id="heading-6">2. 超参数调优</h3>
<p>超参数不是从数据中学到的，需要手动设定，寻找最佳超参数组合的过程就是调参，超参数详细内容可参考《<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fminhuan%2Farticle%2Fdetails%2F153531971%3Fspm%3D1001.2014.3001.5502" title="https://blog.csdn.net/minhuan/article/details/153531971?spm=1001.2014.3001.5502" target="_blank" ref="nofollow noopener noreferrer">六十七、超参数如何影响大模型？通俗讲解原理、作用与实战示例</a>》。</p>
<ul>
<li>网格搜索交叉验证：
<ul>
<li>为每个超参数定义一个候选值列表。</li>
<li>这些候选值会组成一个“网格”，每个网格点是一组特定的超参数组合。</li>
<li>对网格中的每一组超参数组合，执行一次完整的k折交叉验证，计算其平均性能。</li>
<li>最终，选择平均性能最高的那组超参数作为最优解。</li>
</ul>
</li>
<li>随机搜索交叉验证：
<ul>
<li>与网格搜索不同，它不在一个定义好的网格上搜索，而是从一个指定的概率分布中随机采样一定数量的超参数组合。</li>
<li>对每个随机采样的组合执行k折交叉验证。</li>
<li>实践证明，随机搜索通常比网格搜索更高效，能以更少的尝试次数找到优秀的超参数。</li>
</ul>
</li>
</ul>
<p>通过交叉验证选出的最佳模型或最佳参数，其性能是那个平均性能。在完成所有模型选择和调参后，我们通常会用这组最佳参数在整个原始训练集上重新训练一个最终模型，然后用从未参与过任何过程的测试集来报告其最终的、无偏的性能。</p>
<h2 data-id="heading-7">六、 使用交叉验证评估分类模型</h2>
<p>下面我们演示一个基础示例，使用Scikit-learn库实现k折交叉验证。用交叉验证科学地判断一个模型的好坏，并把它调整到最佳状态。</p>
<h3 data-id="heading-8">1. 执行流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50fa4f227610439988fb505545b0bc2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=dXt3bV%2Fp4UZVJ1BzxIzBmNNjbz4%3D" alt="" loading="lazy"/>​</p>
<h3 data-id="heading-9">2. 流程概述</h3>
<ul>
<li>核心评估环节
<ul>
<li>K折交叉验证：通过数据轮换使用，获得稳健的性能评估</li>
<li>模型比较与选择：基于交叉验证结果客观选择最佳模型</li>
<li>超参数调优：使用交叉验证寻找最优参数组合</li>
</ul>
</li>
<li>诊断与分析环节
<ul>
<li>学习曲线分析：诊断模型是否过拟合或欠拟合</li>
<li>最终模型评估：在独立测试集上全面检验模型表现</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">3. 示例分解</h3>
<h4 data-id="heading-11">3.1 准备环境和数据可视化</h4>
<p>示例采用的是scikit-learn库的鸢尾花数据集，数据集包含150个样本，每个样本有4个特征和1个标签，在前期我们讲决策树时我们专门讲解过，这里简单概述一下，需要深入了解请参考《<a href="https://juejin.cn/post/7576861477267374099" title="https://juejin.cn/post/7576861477267374099" target="_blank">三十五、决策树的核心机制（一）：刨根问底鸢尾花分类中的参数推理计算</a>》。</p>
<p><strong>数据集合包含三种鸢尾花：</strong></p>
<ul>
<li>**Iris Setosa：**山鸢尾，最容易识别，花瓣短而宽，花萼较大。</li>
<li>**Iris Versicolor：**变色鸢尾，介于另外两种之间，颜色多变。</li>
<li>**Iris Virginica：**维吉尼亚鸢尾，最大最壮观，花瓣和花萼尺寸都最大。</li>
</ul>
<p><strong>4个特征（预测依据）：</strong></p>
<ul>
<li>sepal length (cm) - 花萼长度</li>
<li>sepal width (cm) - 花萼宽度</li>
<li>petal length (cm) - 花瓣长度</li>
<li>petal width (cm) - 花瓣宽度</li>
</ul>
<p><strong>1个标签（预测目标）：</strong></p>
<ul>
<li>species - 品种（0: Setosa, 1: Versicolor, 2: Virginica）</li>
</ul>
<p><strong>数据集的构成：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0173b1b7634622b8b960c2e84e06da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=tDqWcAB8%2FdgV0J9M6U5i1nw8idI%3D" alt="" loading="lazy"/></p>
<p>整个数据集就是一个大表格，有150行（代表150朵不同的花）和5列。</p>
<p>品种 (标签)  花萼长度   花萼宽度   花瓣长度   花瓣宽度<br/>
Iris-setosa          5.1       3.5            1.4          0.2<br/>
Iris-versicolor     7.0       3.2            4.7          1.4<br/>
Iris-virginica       6.3       3.3            6.0          2.5</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score, KFold, train_test_split, GridSearchCV
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> classification_report, confusion_matrix
<span class="hljs-keyword">import</span> warnings
warnings.filterwarnings(<span class="hljs-string">'ignore'</span>)

<span class="hljs-comment"># 设置中文字体和图形样式</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>, <span class="hljs-string">'DejaVu Sans'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>
sns.set_style(<span class="hljs-string">"whitegrid"</span>)

<span class="hljs-comment"># 加载数据</span>
iris = load_iris()
X = iris.data
y = iris.target
feature_names = iris.feature_names
target_names = iris.target_names

<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据集探索"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据集形状: <span class="hljs-subst">{X.shape}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"特征: <span class="hljs-subst">{feature_names}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"类别: <span class="hljs-subst">{target_names}</span>"</span>)
</code></pre>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>数据集探索<br/>
数据集形状: (150, 4)<br/>
特征: ['sepal length (cm)', 'sepal width (cm)', 'petal length (cm)', 'petal width (cm)']<br/>
类别: ['setosa' 'versicolor' 'virginica']</p>
</blockquote>
<h4 data-id="heading-12">3.2 数据分布可视化</h4>
<p>在建模之前，先了解我们要处理的数据，通过绘制特征的分布直方图，判断数据质量、特征区分度以及不同类别的分离情况，为后续的模型选择提供初步依据。</p>
<pre><code class="hljs language-scss" lang="scss"># 创建数据分布可视化
def <span class="hljs-built_in">plot_data_distribution</span>(X, y, feature_names, target_names):
    fig, axes = plt.<span class="hljs-built_in">subplots</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
    axes = axes.<span class="hljs-built_in">ravel</span>()
    
    # 特征分布
    for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):
        for class_id in <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
            axes[i].<span class="hljs-built_in">hist</span>(X[y == class_id, i], alpha=<span class="hljs-number">0.7</span>, label=target_names[class_id])
        axes[i].<span class="hljs-built_in">set_title</span>(f<span class="hljs-string">'{feature_names[i]} 分布'</span>)
        axes[i].<span class="hljs-built_in">set_xlabel</span>(<span class="hljs-string">'值'</span>)
        axes[i].<span class="hljs-built_in">set_ylabel</span>(<span class="hljs-string">'频数'</span>)
        axes[i].<span class="hljs-built_in">legend</span>()
    
    plt.<span class="hljs-built_in">tight_layout</span>()
    plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">plot_data_distribution</span>(X, y, feature_names, target_names)
</code></pre>
<p><strong>输出结果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73ff3100f5ab492c965103114b4a56a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=Rx7EQcb%2BNbDcxaEOesZiLVNr8K4%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>显示4个特征（花萼长度、花萼宽度、花瓣长度、花瓣宽度）在3个类别间的分布直方图</li>
<li>每个子图展示一个特征，不同类别用不同颜色区分</li>
</ul>
<h4 data-id="heading-13">3.3 k折交叉验证过程可视化</h4>
<p>直观演示交叉验证的核心原理，通过图表清晰地展示每一折中，哪些样本用于训练（蓝色），哪些用于验证（红色），并实时显示该折的验证得分，最后使用柱状图汇总对比各折的准确率，使结果一目了然，这可以让我们彻底理解轮“换考试”和“平均分”的概念。</p>
<pre><code class="hljs language-ini" lang="ini">def visualize_kfold_process(X, y, <span class="hljs-attr">k</span>=<span class="hljs-number">5</span>):
    """可视化k折交叉验证的数据分割过程"""
    <span class="hljs-attr">kf</span> = KFold(n_splits=k, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)
    
    fig, <span class="hljs-attr">axes</span> = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
    <span class="hljs-attr">axes</span> = axes.ravel()
    
    <span class="hljs-attr">fold_scores</span> = []
    
    for fold, (train_idx, val_idx) in enumerate(kf.split(X)):
        if fold &lt; 6:  <span class="hljs-comment"># 只显示前6个图</span>
            <span class="hljs-attr">ax</span> = axes[fold]
            
            <span class="hljs-comment"># 创建分割可视化</span>
            <span class="hljs-attr">split_diagram</span> = np.zeros(len(X))
            split_diagram<span class="hljs-section">[train_idx]</span> = 1  <span class="hljs-comment"># 训练集</span>
            split_diagram<span class="hljs-section">[val_idx]</span> = 2    <span class="hljs-comment"># 验证集</span>
            
            <span class="hljs-comment"># 绘制分割图</span>
            <span class="hljs-attr">colors</span> = [<span class="hljs-string">'lightgray'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'red'</span>]
            <span class="hljs-attr">labels</span> = [<span class="hljs-string">'未使用'</span>, <span class="hljs-string">'训练集'</span>, <span class="hljs-string">'验证集'</span>]
            
            for i, color in enumerate(colors):
                ax.bar(range(len(split_diagram)), 
                      <span class="hljs-section">[1 if x == i else 0 for x in split_diagram]</span>,
                      <span class="hljs-attr">color</span>=color, label=labels[i])
            
            ax.set_title(f'第 {fold+1} 折数据分割\n训练集: {len(train_idx)}样本, 验证集: {len(val_idx)}样本')
            ax.set_xlabel('样本索引')
            ax.set_ylabel('数据用途')
            ax.legend()
            
            <span class="hljs-comment"># 训练模型并计算分数</span>
            <span class="hljs-attr">model</span> = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
            model.fit(X<span class="hljs-section">[train_idx]</span>, y<span class="hljs-section">[train_idx]</span>)
            <span class="hljs-attr">score</span> = model.score(X[val_idx], y[val_idx])
            fold_scores.append(score)
            
            <span class="hljs-comment"># 在图中添加准确率</span>
            ax.text(0.5, 0.9, f'准确率: {score:.3f}', 
                   <span class="hljs-attr">transform</span>=ax.transAxes, ha=<span class="hljs-string">'center'</span>, 
                   <span class="hljs-attr">bbox</span>=dict(boxstyle=<span class="hljs-string">"round,pad=0.3"</span>, facecolor=<span class="hljs-string">"yellow"</span>, alpha=<span class="hljs-number">0.7</span>))
    
    <span class="hljs-comment"># 在右下角子图绘制各折准确率条形图，并隐藏其他多余子图</span>
    <span class="hljs-attr">summary_ax_index</span> = len(axes) - <span class="hljs-number">1</span>  <span class="hljs-comment"># 右下角子图索引（2x3 网格中的最后一个）</span>
    for i in range(len(axes)):
        if i &gt;= k and i != summary_ax_index:
            axes<span class="hljs-section">[i]</span>.set_visible(False)
    
    <span class="hljs-comment"># 绘制各折准确率条形图</span>
    <span class="hljs-attr">ax_summary</span> = axes[summary_ax_index]
    ax_summary.set_visible(True)
    <span class="hljs-attr">bars</span> = ax_summary.bar([f<span class="hljs-string">'折{i+1}'</span> for i in range(len(fold_scores))], fold_scores, color=<span class="hljs-string">'teal'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax_summary.set_title('各折准确率')
    ax_summary.set_ylabel('准确率')
    ax_summary.set_ylim(0, 1.05)
    for bar, score in zip(bars, fold_scores):
        <span class="hljs-attr">height</span> = bar.get_height()
        ax_summary.text(bar.get_x() + bar.get_width()/2., height + 0.02, f'{score:.3f}', <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>)
    
    plt.tight_layout()
    plt.show()
    
    return fold_scores

print(" k折交叉验证过程可视化")
<span class="hljs-attr">fold_scores</span> = visualize_kfold_process(X, y, k=<span class="hljs-number">5</span>)
</code></pre>
<p><strong>输出结果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795da5c422d543eea157e25e9b523687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=CGZJF4hDYmwq1t%2BQshEP%2B0jYMqc%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>展示5折交叉验证中每折的数据分割情况</li>
<li>训练集（蓝色）、验证集（红色）的样本分配</li>
<li>每折的验证准确率显示</li>
<li>各折的准确率综合对比显示</li>
</ul>
<p><strong>k折交叉验证公式</strong>：</p>
<blockquote>
<p>设数据集 D = {(x₁,y₁), (x₂,y₂), ..., (x_N,y_N)}<br/>
将 D 分割为 k 个互斥子集：D₁, D₂, ..., D_k</p>
<p>对于每个折 i = 1, 2, ..., k：<br/>
训练集：D_train⁽ⁱ⁾ = D \ D_i<br/>
验证集：D_val⁽ⁱ⁾ = D_i</p>
<p>模型训练：f⁽ⁱ⁾ = train(D_train⁽ⁱ⁾)<br/>
性能评估：score⁽ⁱ⁾ = evaluate(f⁽ⁱ⁾, D_val⁽ⁱ⁾)</p>
<p>最终性能：CV_score = (1/k) * Σ_{i=1}^k score⁽ⁱ⁾<br/>
性能标准差：CV_std = √[ (1/(k-1)) * Σ_{i=1}^k (score⁽ⁱ⁾ - CV_score)² ]</p>
</blockquote>
<p><strong>体现的价值：</strong></p>
<ul>
<li>数据利用最大化：每个样本都参与训练和验证</li>
<li>性能估计无偏性：减少单次分割的随机性影响</li>
<li>模型稳定性评估：通过标准差衡量模型鲁棒性</li>
</ul>
<h4 data-id="heading-14">3.4 模型比较可视化</h4>
<p>科学地回答“哪个模型更好？”，通过柱状图（带误差棒）和箱线图，同时比较多个模型（如随机森林、逻辑回归、SVM）的平均性能和稳定性，这不仅看谁的平均分高，还要看谁的表现更稳定（方差小），从而做出稳健的选择。</p>
<pre><code class="hljs language-ini" lang="ini">def compare_models_cv(X, y, models, <span class="hljs-attr">cv</span>=<span class="hljs-number">5</span>):
    """比较不同模型的交叉验证性能并可视化"""
    <span class="hljs-attr">model_names</span> = []
    <span class="hljs-attr">mean_scores</span> = []
    <span class="hljs-attr">std_scores</span> = []
    <span class="hljs-attr">all_scores</span> = []
    
    print(" 模型性能比较")
    
    for name, model in models.items():
        <span class="hljs-comment"># 执行交叉验证</span>
        <span class="hljs-attr">cv_scores</span> = cross_val_score(model, X, y, cv=cv, scoring=<span class="hljs-string">'accuracy'</span>)
        
        model_names.append(name)
        mean_scores.append(cv_scores.mean())
        std_scores.append(cv_scores.std())
        all_scores.append(cv_scores)
        
        print(f"{name:15} | 平均准确率: {cv_scores.mean():.4f} (±{cv_scores.std():.4f})")
    
    <span class="hljs-comment"># 创建性能比较图</span>
    fig, (ax1, ax2) = plt.subplots(1, 2, <span class="hljs-attr">figsize</span>=(<span class="hljs-number">15</span>, <span class="hljs-number">6</span>))
    
    <span class="hljs-comment"># 柱状图比较平均性能</span>
    <span class="hljs-attr">bars</span> = ax1.bar(model_names, mean_scores, yerr=std_scores, 
                   <span class="hljs-attr">capsize</span>=<span class="hljs-number">5</span>, alpha=<span class="hljs-number">0.7</span>, color=[<span class="hljs-string">'skyblue'</span>, <span class="hljs-string">'lightgreen'</span>, <span class="hljs-string">'lightcoral'</span>])
    ax1.set_title('模型交叉验证性能比较')
    ax1.set_ylabel('平均准确率')
    ax1.set_ylim(0.8, 1.0)
    
    <span class="hljs-comment"># 在柱子上添加数值</span>
    for bar, score in zip(bars, mean_scores):
        <span class="hljs-attr">height</span> = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height + 0.01,
                f'{score:.4f}', <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>)
    
    <span class="hljs-comment"># 箱线图显示分布</span>
    ax2.boxplot(all_scores, <span class="hljs-attr">labels</span>=model_names)
    ax2.set_title('各折准确率分布')
    ax2.set_ylabel('准确率')
    
    plt.tight_layout()
    plt.show()
    
    <span class="hljs-comment"># 选择最佳模型</span>
    <span class="hljs-attr">best_idx</span> = np.argmax(mean_scores)
    <span class="hljs-attr">best_model_name</span> = model_names[best_idx]
    <span class="hljs-attr">best_model</span> = models[best_model_name]
    
    print(f"\n 最佳模型: {best_model_name} (准确率: {mean_scores<span class="hljs-section">[best_idx]</span>:.4f})")
    
    return best_model_name, best_model, all_scores

<span class="hljs-comment"># 定义要比较的模型</span>
<span class="hljs-attr">models</span> = {
    '随机森林': RandomForestClassifier(<span class="hljs-attr">random_state</span>=<span class="hljs-number">42</span>),
    '逻辑回归': LogisticRegression(<span class="hljs-attr">random_state</span>=<span class="hljs-number">42</span>, max_iter=<span class="hljs-number">1000</span>),
    '支持向量机': SVC(<span class="hljs-attr">random_state</span>=<span class="hljs-number">42</span>)
}

best_model_name, best_model, <span class="hljs-attr">all_scores</span> = compare_models_cv(X, y, models)
</code></pre>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>模型性能比较<br/>
随机森林 | 平均准确率: 0.9667 (±0.0211)<br/>
逻辑回归 | 平均准确率: 0.9733 (±0.0249)<br/>
支持向量机 | 平均准确率: 0.9667 (±0.0211)</p>
<p>最佳模型: 逻辑回归 (准确率: 0.9733)</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f19ef9c311144ffbd78aba4b17432bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=j8AyzU8VUMJnpbnPZOqmF0JArRs%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>左侧柱状图：各模型平均准确率及误差棒（标准差）</li>
<li>右侧箱线图：各模型5折交叉验证得分的分布</li>
</ul>
<p><strong>模型性能比较的统计检验</strong>：</p>
<blockquote>
<p>设两个模型 A 和 B 的k折得分分别为：<br/>
scores_A = [s_A¹, s_A², ..., s_Aᵏ]<br/>
scores_B = [s_B¹, s_B², ..., s_Bᵏ]</p>
<p>配对t检验统计量：<br/>
t = (mean(scores_A) - mean(scores_B)) / √[ (var(scores_A - scores_B) / k) ]</p>
<p>其中：<br/>
var(scores_A - scores_B) = (1/(k-1)) * Σ_{i=1}^k [(s_Aⁱ - s_Bⁱ) - mean(scores_A - scores_B)]²</p>
</blockquote>
<p><strong>体现的价值：</strong></p>
<ul>
<li>模型选择依据：基于统计性能选择最佳模型</li>
<li>性能稳定性分析：通过分布了解模型鲁棒性</li>
<li>统计显著性判断：确定性能差异是否显著</li>
</ul>
<h4 data-id="heading-15">3.5 学习曲线可视化</h4>
<p>诊断模型状态的关键工具，通过绘制模型随训练数据量增加时，训练得分和验证得分的变化曲线，可以清晰地判断模型是处于过拟合（训练得分远高于验证得分）还是欠拟合（两者都低）状态，并指导是否需要收集更多数据。</p>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">plot_learning_curve</span>(model, X, y, model_name):
    <span class="hljs-string">""</span><span class="hljs-string">"绘制学习曲线来观察模型表现"</span><span class="hljs-string">""</span>
    from sklearn.model_selection import learning_curve
    
    train_sizes, train_scores, test_scores = <span class="hljs-built_in">learning_curve</span>(
        model, X, y, cv=<span class="hljs-number">5</span>, n_jobs=-<span class="hljs-number">1</span>,
        train_sizes=np.<span class="hljs-built_in">linspace</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">10</span>),
        scoring=<span class="hljs-string">'accuracy'</span>
    )
    
    train_scores_mean = np.<span class="hljs-built_in">mean</span>(train_scores, axis=<span class="hljs-number">1</span>)
    train_scores_std = np.<span class="hljs-built_in">std</span>(train_scores, axis=<span class="hljs-number">1</span>)
    test_scores_mean = np.<span class="hljs-built_in">mean</span>(test_scores, axis=<span class="hljs-number">1</span>)
    test_scores_std = np.<span class="hljs-built_in">std</span>(test_scores, axis=<span class="hljs-number">1</span>)
    
    plt.<span class="hljs-built_in">figure</span>(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
    plt.<span class="hljs-built_in">fill_between</span>(train_sizes, train_scores_mean - train_scores_std,
                     train_scores_mean + train_scores_std, alpha=<span class="hljs-number">0.1</span>, color=<span class="hljs-string">"r"</span>)
    plt.<span class="hljs-built_in">fill_between</span>(train_sizes, test_scores_mean - test_scores_std,
                     test_scores_mean + test_scores_std, alpha=<span class="hljs-number">0.1</span>, color=<span class="hljs-string">"g"</span>)
    plt.<span class="hljs-built_in">plot</span>(train_sizes, train_scores_mean, <span class="hljs-string">'o-'</span>, color=<span class="hljs-string">"r"</span>, label=<span class="hljs-string">"训练得分"</span>)
    plt.<span class="hljs-built_in">plot</span>(train_sizes, test_scores_mean, <span class="hljs-string">'o-'</span>, color=<span class="hljs-string">"g"</span>, label=<span class="hljs-string">"交叉验证得分"</span>)
    
    plt.<span class="hljs-built_in">title</span>(f<span class="hljs-string">'{model_name} 学习曲线'</span>)
    plt.<span class="hljs-built_in">xlabel</span>(<span class="hljs-string">'训练样本数'</span>)
    plt.<span class="hljs-built_in">ylabel</span>(<span class="hljs-string">'准确率'</span>)
    plt.<span class="hljs-built_in">legend</span>(loc=<span class="hljs-string">"best"</span>)
    plt.<span class="hljs-built_in">grid</span>(True)
    
    plt.<span class="hljs-built_in">show</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n 学习曲线分析"</span>)
for name, model in models.<span class="hljs-built_in">items</span>():
    <span class="hljs-built_in">plot_learning_curve</span>(model, X, y, name)
</code></pre>
<p><strong>输出结果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f6aea81003426ba8ca8da76764f333~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=L0VjWiZMR5FcoU3xP40TUhQBbAk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58053809ac2c4148aa500cd0d36d7552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=m3%2F29nBlHZ0lZlSjgI6Au9y77mM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0748b93186fa4c50b3da9a979ccc29bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=Wk3nwN1qoOmzjuftvODEt%2FD2Ee4%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>训练得分和验证得分随训练样本数量增加的变化</li>
<li>阴影区域表示得分的标准差范围</li>
</ul>
<p><strong>学习曲线理论</strong>：</p>
<blockquote>
<p>设训练集大小为 m，模型复杂度为 h<br/>
训练误差：J_train(m) = (1/m) * Σ_{i=1}^m L(f(x_i), y_i)<br/>
验证误差：J_val(m) = (1/k) * Σ_{j=1}^k L(f(x_j), y_j)</p>
<p>随着 m → ∞：<br/>
J_train(m) → 模型偏差 + 方差项<br/>
J_val(m) → 模型偏差 + 方差项 + 噪声项</p>
<p>其中偏差-方差分解：<br/>
E[(y - f(x))²] = Bias[f(x)]² + Var[f(x)] + σ²</p>
</blockquote>
<p><strong>体现的价值：</strong></p>
<ul>
<li>过拟合/欠拟合诊断：判断模型是否合适</li>
<li>数据量需求评估：确定需要多少训练数据</li>
<li>模型容量分析：观察模型的学习能力</li>
</ul>
<h4 data-id="heading-16">3.6 网格搜索调参可视化</h4>
<p>科学的调参方式，通过网格搜索交叉验证，系统性地遍历不同的参数组合，并用热力图等形式展示参数如何影响性能。这帮助我们找到真正的最佳参数组合，并理解参数之间的相互作用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_grid_search</span>(<span class="hljs-params">X, y</span>):
    <span class="hljs-string">"""可视化网格搜索过程"""</span>
    <span class="hljs-comment"># 定义参数网格</span>
    param_grid = {
        <span class="hljs-string">'n_estimators'</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>],
        <span class="hljs-string">'max_depth'</span>: [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">None</span>],
        <span class="hljs-string">'min_samples_split'</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>]
    }
    
    rf = RandomForestClassifier(random_state=<span class="hljs-number">42</span>)
    grid_search = GridSearchCV(rf, param_grid, cv=<span class="hljs-number">5</span>, scoring=<span class="hljs-string">'accuracy'</span>, n_jobs=-<span class="hljs-number">1</span>)
    grid_search.fit(X, y)
    
    <span class="hljs-comment"># 可视化结果</span>
    results = pd.DataFrame(grid_search.cv_results_)
    
    <span class="hljs-comment"># 选择部分参数进行可视化</span>
    fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">10</span>))
    
    <span class="hljs-comment"># 1. n_estimators 的影响</span>
    param1_data = results[results[<span class="hljs-string">'param_max_depth'</span>].isna() &amp; results[<span class="hljs-string">'param_min_samples_split'</span>] == <span class="hljs-number">2</span>]
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>].plot(param1_data[<span class="hljs-string">'param_n_estimators'</span>], param1_data[<span class="hljs-string">'mean_test_score'</span>], <span class="hljs-string">'o-'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>].set_title(<span class="hljs-string">'n_estimators 对性能的影响\n(max_depth=None, min_samples_split=2)'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'n_estimators'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'平均准确率'</span>)
    
    <span class="hljs-comment"># 2. max_depth 的影响</span>
    param2_data = results[results[<span class="hljs-string">'param_n_estimators'</span>] == <span class="hljs-number">100</span> &amp; results[<span class="hljs-string">'param_min_samples_split'</span>] == <span class="hljs-number">2</span>]
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>].plot([<span class="hljs-built_in">str</span>(x) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> param2_data[<span class="hljs-string">'param_max_depth'</span>]], param2_data[<span class="hljs-string">'mean_test_score'</span>], <span class="hljs-string">'o-'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>].set_title(<span class="hljs-string">'max_depth 对性能的影响\n(n_estimators=100, min_samples_split=2)'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">'max_depth'</span>)
    axes[<span class="hljs-number">0</span>,<span class="hljs-number">1</span>].set_ylabel(<span class="hljs-string">'平均准确率'</span>)
    
    <span class="hljs-comment"># 3. 热力图：n_estimators vs max_depth</span>
    heatmap_data = results.pivot_table(
        values=<span class="hljs-string">'mean_test_score'</span>, 
        index=<span class="hljs-string">'param_n_estimators'</span>, 
        columns=<span class="hljs-string">'param_max_depth'</span>,
        aggfunc=<span class="hljs-string">'mean'</span>
    )
    sns.heatmap(heatmap_data, annot=<span class="hljs-literal">True</span>, fmt=<span class="hljs-string">'.3f'</span>, cmap=<span class="hljs-string">'YlOrRd'</span>, ax=axes[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>])
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>].set_title(<span class="hljs-string">'参数组合热力图\n(平均准确率)'</span>)
    
    <span class="hljs-comment"># 4. 最佳参数组合</span>
    best_params = grid_search.best_params_
    best_score = grid_search.best_score_
    
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.8</span>, <span class="hljs-string">f'最佳参数组合:'</span>, fontsize=<span class="hljs-number">14</span>, weight=<span class="hljs-string">'bold'</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.6</span>, <span class="hljs-string">f'n_estimators: <span class="hljs-subst">{best_params[<span class="hljs-string">"n_estimators"</span>]}</span>'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-string">f'max_depth: <span class="hljs-subst">{best_params[<span class="hljs-string">"max_depth"</span>]}</span>'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.4</span>, <span class="hljs-string">f'min_samples_split: <span class="hljs-subst">{best_params[<span class="hljs-string">"min_samples_split"</span>]}</span>'</span>, fontsize=<span class="hljs-number">12</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].text(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-string">f'最佳准确率: <span class="hljs-subst">{best_score:<span class="hljs-number">.4</span>f}</span>'</span>, fontsize=<span class="hljs-number">14</span>, weight=<span class="hljs-string">'bold'</span>, color=<span class="hljs-string">'red'</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].set_xlim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].set_title(<span class="hljs-string">'最佳参数结果'</span>, fontsize=<span class="hljs-number">14</span>)
    axes[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>].axis(<span class="hljs-string">'off'</span>)
    
    plt.tight_layout()
    plt.show()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n 网格搜索最佳参数: <span class="hljs-subst">{grid_search.best_params_}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最佳交叉验证得分: <span class="hljs-subst">{grid_search.best_score_:<span class="hljs-number">.4</span>f}</span>"</span>)
    
    <span class="hljs-keyword">return</span> grid_search.best_estimator_

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n 网格搜索调参可视化"</span>)
best_tuned_model = visualize_grid_search(X, y)
</code></pre>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>网格搜索调参可视化</p>
<p>网格搜索最佳参数: {'max_depth': 3, 'min_samples_split': 2, 'n_estimators': 50}<br/>
最佳交叉验证得分: 0.9667</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08032a01dbc64e30afbc786105c4ff47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=XrW6%2Be4Bq0tniHhpW9QTgeeOCAg%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>不同超参数组合对模型性能的影响</li>
<li>参数热力图显示最佳组合</li>
<li>最佳参数结果总结</li>
</ul>
<p><strong>超参数优化目标</strong>：</p>
<blockquote>
<p>设超参数空间为 Θ，性能度量函数为 P<br/>
网格搜索目标：找到 θ* ∈ Θ 使得<br/>
θ* = argmax_{θ∈Θ} CV_score(θ)</p>
<p>其中：<br/>
CV_score(θ) = (1/k) * Σ_{i=1}^k P(f_θ⁽ⁱ⁾, D_val⁽ⁱ⁾)<br/>
f_θ⁽ⁱ⁾ 是在超参数 θ 下，在第 i 折训练集上训练的模型</p>
</blockquote>
<p><strong>体现的价值：</strong></p>
<ul>
<li>超参数敏感性分析：了解各参数对性能的影响</li>
<li>最优配置确定：找到最佳超参数组合</li>
<li>参数交互作用：观察参数间的相互影响</li>
</ul>
<h4 data-id="heading-17">3.7 最终模型评估可视化</h4>
<p>对最佳模型进行全面的毕业答辩，在独立的测试集上，通过混淆矩阵、特征重要性、分类报告等多种工具，从各个角度评估模型的最终表现，了解其错误类型和决策依据，确保其泛化能力。</p>
<pre><code class="hljs language-ini" lang="ini">def final_evaluation_visualization(model, X, y, model_name):
    """最终模型评估可视化"""
    <span class="hljs-comment"># 分割数据</span>
    X_train, X_test, y_train, <span class="hljs-attr">y_test</span> = train_test_split(
        X, y, <span class="hljs-attr">test_size</span>=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>, stratify=y
    )
    
    <span class="hljs-comment"># 训练最终模型</span>
    model.fit(X_train, y_train)
    <span class="hljs-attr">y_pred</span> = model.predict(X_test)
    
    <span class="hljs-comment"># 创建评估图表</span>
    fig, <span class="hljs-attr">axes</span> = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">12</span>))
    
    <span class="hljs-comment"># 1. 混淆矩阵</span>
    <span class="hljs-attr">cm</span> = confusion_matrix(y_test, y_pred)
    sns.heatmap(cm, <span class="hljs-attr">annot</span>=<span class="hljs-literal">True</span>, fmt=<span class="hljs-string">'d'</span>, cmap=<span class="hljs-string">'Blues'</span>, 
                <span class="hljs-attr">xticklabels</span>=target_names, yticklabels=target_names, ax=axes[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>])
    axes<span class="hljs-section">[0,0]</span>.set_title('混淆矩阵')
    axes<span class="hljs-section">[0,0]</span>.set_xlabel('预测标签')
    axes<span class="hljs-section">[0,0]</span>.set_ylabel('真实标签')
    
    <span class="hljs-comment"># 2. 特征重要性（如果是树模型）</span>
    if hasattr(model, 'feature_importances_'):
        <span class="hljs-attr">importances</span> = model.feature_importances_
        <span class="hljs-attr">indices</span> = np.argsort(importances)[::-<span class="hljs-number">1</span>]
        
        axes<span class="hljs-section">[0,1]</span>.bar(range(len(importances)), importances<span class="hljs-section">[indices]</span>)
        axes<span class="hljs-section">[0,1]</span>.set_title('特征重要性')
        axes<span class="hljs-section">[0,1]</span>.set_xlabel('特征')
        axes<span class="hljs-section">[0,1]</span>.set_ylabel('重要性')
        axes<span class="hljs-section">[0,1]</span>.set_xticks(range(len(importances)))
        axes<span class="hljs-section">[0,1]</span>.set_xticklabels(<span class="hljs-section">[feature_names[i]</span> for i in indices], <span class="hljs-attr">rotation</span>=<span class="hljs-number">45</span>)
    
    <span class="hljs-comment"># 3. 测试集性能</span>
    <span class="hljs-attr">test_score</span> = model.score(X_test, y_test)
    <span class="hljs-attr">train_score</span> = model.score(X_train, y_train)
    
    <span class="hljs-attr">scores</span> = [train_score, test_score]
    <span class="hljs-attr">labels</span> = [<span class="hljs-string">'训练集'</span>, <span class="hljs-string">'测试集'</span>]
    
    <span class="hljs-attr">bars</span> = axes[<span class="hljs-number">1</span>,<span class="hljs-number">0</span>].bar(labels, scores, color=[<span class="hljs-string">'lightblue'</span>, <span class="hljs-string">'lightcoral'</span>])
    axes<span class="hljs-section">[1,0]</span>.set_title('训练集 vs 测试集 性能')
    axes<span class="hljs-section">[1,0]</span>.set_ylabel('准确率')
    axes<span class="hljs-section">[1,0]</span>.set_ylim(0, 1.1)
    
    <span class="hljs-comment"># 在柱子上添加数值</span>
    for bar, score in zip(bars, scores):
        <span class="hljs-attr">height</span> = bar.get_height()
        axes<span class="hljs-section">[1,0]</span>.text(bar.get_x() + bar.get_width()/2., height + 0.02,
                      f'{score:.4f}', <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'bottom'</span>)
    
    <span class="hljs-comment"># 4. 分类报告摘要</span>
    <span class="hljs-attr">report</span> = classification_report(y_test, y_pred, target_names=target_names, output_dict=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">report_df</span> = pd.DataFrame(report).transpose()
    
    <span class="hljs-comment"># 简化显示主要指标</span>
    axes<span class="hljs-section">[1,1]</span>.axis('off')
    axes<span class="hljs-section">[1,1]</span>.text(0.1, 0.9, '分类报告摘要', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">16</span>, weight=<span class="hljs-string">'bold'</span>)
    
    <span class="hljs-attr">y_pos</span> = <span class="hljs-number">0.7</span>
    for class_name in target_names:
        <span class="hljs-attr">prec</span> = report[class_name][<span class="hljs-string">'precision'</span>]
        <span class="hljs-attr">rec</span> = report[class_name][<span class="hljs-string">'recall'</span>]
        <span class="hljs-attr">f1</span> = report[class_name][<span class="hljs-string">'f1-score'</span>]
        axes<span class="hljs-section">[1,1]</span>.text(0.1, y_pos, f'{class_name}:', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">12</span>, weight=<span class="hljs-string">'bold'</span>)
        axes<span class="hljs-section">[1,1]</span>.text(0.4, y_pos, f'精确率: {prec:.3f}, 召回率: {rec:.3f}, F1: {f1:.3f}', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">10</span>)
        y_pos <span class="hljs-attr">-</span>= <span class="hljs-number">0.1</span>
    
    axes<span class="hljs-section">[1,1]</span>.text(0.1, y_pos-0.1, f'总体准确率: {test_score:.4f}', 
                   <span class="hljs-attr">fontsize</span>=<span class="hljs-number">14</span>, weight=<span class="hljs-string">'bold'</span>, color=<span class="hljs-string">'red'</span>)
    
    plt.tight_layout()
    plt.show()
    
    print(f"\n 最终模型评估完成!")
    print(f"测试集准确率: {test_score:.4f}")
    
    return test_score

print("\n 最终模型评估可视化")
<span class="hljs-attr">final_score</span> = final_evaluation_visualization(best_tuned_model, X, y, best_model_name)
</code></pre>
<p><strong>输出结果：</strong></p>
<blockquote>
<p>最终模型评估可视化</p>
<p>最终模型评估完成!<br/>
测试集准确率: 0.9667</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05b1abd716a4d66853f972a20929ad3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=PKfslZ%2FHnGwp5CjfLbDqbLP8FIs%3D" alt="" loading="lazy"/></p>
<p><strong>图示内容：</strong></p>
<ul>
<li>混淆矩阵：真实vs预测类别分布</li>
<li>特征重要性：各特征对预测的贡献度</li>
<li>训练vs测试性能比较</li>
<li>详细分类报告</li>
</ul>
<p><strong>模型评估指标</strong>：</p>
<blockquote>
<p>对于多分类问题，每个类别 k 的指标：<br/>
精确率：Precision_k = TP_k / (TP_k + FP_k)<br/>
召回率：Recall_k = TP_k / (TP_k + FN_k)<br/>
F1分数：F1_k = 2 * (Precision_k * Recall_k) / (Precision_k + Recall_k)</p>
<p>准确率：Accuracy = (Σ_k TP_k) / N</p>
<p>其中：<br/>
TP_k = 真阳性（类别k被正确预测）<br/>
FP_k = 假阳性（其他类别被预测为k）<br/>
FN_k = 假阴性（类别k被预测为其他）</p>
</blockquote>
<p><strong>体现的价值：</strong></p>
<ul>
<li>全面性能评估：多角度评估模型表现</li>
<li>错误模式分析：通过混淆矩阵识别常见错误</li>
<li>特征贡献度：理解模型决策依据</li>
<li>泛化能力验证：比较训练和测试性能</li>
</ul>
<h4 data-id="heading-18">3.8 完整流程总结图</h4>
<p>梳理全局，形成方法论，通过一张总结图，将整个流程串联起来，强调每一步的目的和衔接，让我们建立起一个完整、规范的机器学习项目开发观念。</p>
<pre><code class="hljs language-ini" lang="ini">def create_workflow_summary():
    """创建完整的工作流程总结图"""
    fig, <span class="hljs-attr">ax</span> = plt.subplots(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">8</span>))
    
    <span class="hljs-comment"># 定义流程步骤</span>
    <span class="hljs-attr">steps</span> = [
        (<span class="hljs-string">"1. 数据准备"</span>, <span class="hljs-string">"加载和探索数据\n数据可视化"</span>),
        (<span class="hljs-string">"2. 交叉验证"</span>, <span class="hljs-string">"k折数据分割\n模型性能评估"</span>),
        (<span class="hljs-string">"3. 模型比较"</span>, <span class="hljs-string">"多个模型对比\n选择最佳模型"</span>),
        (<span class="hljs-string">"4. 超参数调优"</span>, <span class="hljs-string">"网格搜索\n寻找最优参数"</span>),
        (<span class="hljs-string">"5. 最终评估"</span>, <span class="hljs-string">"测试集验证\n性能可视化"</span>),
        (<span class="hljs-string">"6. 模型部署"</span>, <span class="hljs-string">"训练最终模型\n投入实际使用"</span>)
    ]
    
    <span class="hljs-comment"># 绘制流程图</span>
    <span class="hljs-attr">y_positions</span> = [<span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>]
    
    for i, (title, description) in enumerate(steps):
        <span class="hljs-comment"># 绘制方框</span>
        <span class="hljs-attr">box</span> = plt.Rectangle((<span class="hljs-number">0.1</span>, y_positions[i]), <span class="hljs-number">0.8</span>, <span class="hljs-number">0.8</span>, 
                           <span class="hljs-attr">fill</span>=<span class="hljs-literal">True</span>, color=<span class="hljs-string">'lightblue'</span>, alpha=<span class="hljs-number">0.7</span>, 
                           <span class="hljs-attr">edgecolor</span>=<span class="hljs-string">'black'</span>, linewidth=<span class="hljs-number">2</span>)
        ax.add_patch(box)
        
        <span class="hljs-comment"># 添加文本</span>
        ax.text(0.5, y_positions<span class="hljs-section">[i]</span> + 0.5, title, 
               <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, fontsize=<span class="hljs-number">14</span>, weight=<span class="hljs-string">'bold'</span>)
        ax.text(0.5, y_positions<span class="hljs-section">[i]</span> + 0.3, description, 
               <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, fontsize=<span class="hljs-number">10</span>)
        
        <span class="hljs-comment"># 绘制连接箭头</span>
        if i &lt; len(steps) - 1:
            ax.arrow(0.5, y_positions<span class="hljs-section">[i]</span> + 0.1, 0, -0.3, 
                    <span class="hljs-attr">head_width</span>=<span class="hljs-number">0.03</span>, head_length=<span class="hljs-number">0.1</span>, fc=<span class="hljs-string">'black'</span>, ec=<span class="hljs-string">'black'</span>)
    
    ax.set_xlim(0, 1)
    ax.set_ylim(1, 8)
    ax.set_title('机器学习模型开发完整工作流程', <span class="hljs-attr">fontsize</span>=<span class="hljs-number">16</span>, weight=<span class="hljs-string">'bold'</span>, pad=<span class="hljs-number">20</span>)
    ax.axis('off')
    
    <span class="hljs-comment"># 添加交叉验证重点说明</span>
    ax.text(0.5, 0.8, ' 交叉验证是整个流程的核心环节！', 
           <span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, fontsize=<span class="hljs-number">12</span>, weight=<span class="hljs-string">'bold'</span>,
           <span class="hljs-attr">bbox</span>=dict(boxstyle=<span class="hljs-string">"round,pad=0.3"</span>, facecolor=<span class="hljs-string">"yellow"</span>, alpha=<span class="hljs-number">0.7</span>))
    
    plt.tight_layout()
    plt.show()

print("\n 完整工作流程总结")
create_workflow_summary()
</code></pre>
<p><strong>输出结果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13521af15a1d4435aafa5f2688f4212f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014881&amp;x-signature=RXVo1LNLsmJjbFXkf1qrtLZ%2FpuM%3D" alt="" loading="lazy"/></p>
<p><strong>完整工作流的数学框架：</strong></p>
<blockquote>
<p>完整流程可形式化为：<br/>
1. 数据准备：D = {(x_i, y_i)} ∼ P_data<br/>
2. 模型选择：M = {m₁, m₂, ..., m_p}<br/>
3. 交叉验证：m* = argmax_{m∈M} CV_score(m)<br/>
4. 超参数调优：θ* = argmax_{θ} CV_score(m*_θ)<br/>
5. 最终评估：Performance = P(m*_θ*, D_test)<br/>
6. 部署：f_final = train(m*_θ*, D_all)</p>
</blockquote>
<p>这些可视化图表共同构成了一个完整的模型评估和选择框架，每个图表都基于严格的数学原理，提供了从数据理解到模型部署的全方位理解。</p>
<h2 data-id="heading-19">七、大模型时代的突破与演进</h2>
<p>随着以大语言模型为代表的、参数巨量、训练成本极高的模型出现，经典的k折交叉验证实践面临着严峻挑战：</p>
<ul>
<li>**计算成本无法承受：**训练一个大规模的模型需要数月时间和数百万美元的计算资源。进行k次（比如10次）这样的训练来进行交叉验证，在经济和时间上都是不现实的。</li>
<li>**数据规模巨大：**大模型的训练数据集往往达到TB甚至PB级别。在这种情况下，简单的留出法（例如98%训练，1%验证，1%测试）已经能提供非常稳定和低方差的性能估计。k折交叉验证带来的方差降低收益，与其巨大的计算成本相比，性价比极低。</li>
<li>**动态训练过程：**大模型的训练不是一次性的，而是涉及复杂的多阶段指令微调、人类反馈强化学习等。验证集在其中扮演着动态监控的角色，用于在单个训练周期内早停、选择检查点等，而非用于多次重新训练。</li>
</ul>
<p><strong>演进与应对策略：</strong></p>
<ul>
<li>**大规模留出法成为主流：**对于预训练和基础模型开发，单一、大规模、高质量的留出验证集是事实上的标准，其规模足以保证评估的稳定性。</li>
<li>**交叉验证的降级应用：**交叉验证并未完全消失，而是转移到了大模型工作流的下游任务中。
<ul>
<li>提示工程：当为特定任务设计提示时，研究人员可能会在一个较小的示例数据集上使用k折交叉验证来比较不同提示模板的稳定性。</li>
<li>超参数微调：在对大模型进行轻量级微调时，学习率、LoRA秩等超参数仍然需要调整。此时，可以在微调数据集上使用交叉验证来寻找最优设置。</li>
<li>小样本/少样本学习：在数据极其稀缺的场景下，交叉验证仍然是评估小样本学习策略有效性的重要工具。</li>
</ul>
</li>
<li>**从“重训练”到“重评估”：**理念从“通过多次训练来评估”转向“通过一次训练、在多个维度/数据集上深入评估”。大模型的评估重点不再是单一的准确率，而是涵盖了真实性、毒性、偏见、推理能力、指令遵循能力等更广泛的维度，这需要构建庞大且多样化的评估基准。</li>
</ul>
<p><strong>扩展说明：</strong></p>
<ul>
<li>**大规模留出法：**就像一所拥有数万学生的大学。学校要评估一位教授的教学水平，不需要让所有学生都参加考试。他们只需要随机抽取一个几百人的大班进行统一考试，因为这个班的成绩已经足以稳定、可靠地反映出教授的普遍教学效果。这种方法高效且成本可控。</li>
</ul>
<h2 data-id="heading-20">八、总结</h2>
<p>交叉验证作为机器学习模型评估的经典方法，其数学理论基础坚实，实践应用价值显著。它为我们在数据有限的常态下，进行可靠的模型评估、选择和调参提供了坚实的基础。通过系统的可视化分析，我们展示了交叉验证在数据理解、模型比较、超参数优化和最终评估等各个环节的核心作用。</p>
<p>进入大模型时代，虽然其应用场景因计算瓶颈而收缩，但其思想精髓已内化为机器学习工作流的基本逻辑。在资源允许的传统机器学习任务和中下游微调中，它依然是不可或缺的黄金标准；而在大规模基础模型研发中，我们则采用了更符合其经济性的评估范式。理解交叉验证的原理与局限，并能根据具体场景（数据规模、模型复杂度、计算预算）灵活选择最合适的评估策略，是每一位AI从业者必备的核心能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你真的搞懂了LLM性能压测的各项指标吗？]]></title>    <link>https://juejin.cn/post/7590601860299505691</link>    <guid>https://juejin.cn/post/7590601860299505691</guid>    <pubDate>2026-01-03T03:25:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590601860299505691" data-draft-id="7589386219449925647" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的搞懂了LLM性能压测的各项指标吗？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T03:25:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃果冻不吐果冻皮"/> <meta itemprop="url" content="https://juejin.cn/user/3642056016410728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的搞懂了LLM性能压测的各项指标吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3642056016410728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃果冻不吐果冻皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T03:25:36.000Z" title="Sat Jan 03 2026 03:25:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前发现不同框架的性能差异有出入，当时并没有太在意。最近，对社区开源的LLM性能压测工具做了一个深度体验。发现各个框架对于各指标（如：ILT/TPOT）的定义真的是五花八门，稍微不注意可能就会用错里面的指标。本文梳理了各性能压测工具的计算公式，试图对齐各压测工具的性能指标。</p>
<blockquote>
<p>我撰写的<strong>大模型相关的博客及配套代码</strong>均整理放置在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliguodongiot%2Fllm-action%2Ftree%2Fmain" target="_blank" title="https://github.com/liguodongiot/llm-action/tree/main" ref="nofollow noopener noreferrer">llm-action</a>，有需要的朋友自取。</p>
</blockquote>
<h2 data-id="heading-0">各框架概述</h2>
<h3 data-id="heading-1">GuideLLM</h3>
<p>GuideLLM 是一个用于评估语言模型在真实工作负载和配置下性能表现的平台。它模拟与 OpenAI 和 vLLM 原生服务兼容的端到端交互，生成反映生产使用情况的工作负载模式，并生成详细报告，帮助团队理解系统行为、资源需求和运营限制。GuideLLM 支持真实和合成数据集、多模态输入以及灵活的执行配置文件，为工程师和机器学习团队提供了一个一致的框架，用于评估模型行为、调整部署和规划容量，以应对系统演进。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8191f4c464e74da492854f46064332cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=cTFBNI9NiE%2Bafmd8npS5icr27f4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38fcc2bb188545aa9d5a99d3fc211852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=WJ4rHvJep2Fbjh8zIk2yeDY7Bmw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/798adedd44bb400fb882c86a3c4345a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=O3lSsjeIkm62QyDyYf%2BnAq7TMSU%3D" alt="" loading="lazy"/></p>
<p><strong>GuideLLM特性</strong>：</p>
<p>GuideLLM 为团队在类生产环境中部署 LLM 时，清晰地展示了性能、效率和可靠性。</p>
<ul>
<li>捕捉完整的延迟和token级统计数据，用于 SLO 驱动的评估 ，包括 TTFT、ITL 和端到端行为的完整分布。</li>
<li>生成跨同步、并发和基于速率模式的真实、可配置的流量模式 ，包括可重复的扫描以识别安全运行范围。</li>
<li>支持真实和合成多模态数据集 ，支持一个框架内的受控实验和生产式评估。</li>
<li>生成标准化、可导出的报告，用于仪表盘、分析和回归跟踪 ，确保团队和工作流程间的一致性。</li>
<li>提供高吞吐量、可扩展的基准测试，支持多处理、线程、异步执行，以及灵活的 CLI/API用于支持自定义或快速启动。</li>
</ul>
<p><strong>安装</strong>：</p>
<pre><code class="hljs">pip install guidellm
</code></pre>
<p>或者直接使用镜像：</p>
<pre><code class="hljs language-sql" lang="sql">docker run <span class="hljs-operator">-</span>dt <span class="hljs-comment">--name guidellm-lgd \</span>
<span class="hljs-comment">--gpus all \</span>
<span class="hljs-comment">--network=host \</span>
<span class="hljs-comment">--shm-size=256g \</span>
<span class="hljs-comment">--env LANG=C.UTF-8 \</span>
<span class="hljs-operator">-</span>v <span class="hljs-operator">/</span>share<span class="hljs-operator">/</span><span class="hljs-keyword">global</span>:<span class="hljs-operator">/</span><span class="hljs-keyword">global</span> \
<span class="hljs-comment">--entrypoint /bin/bash \</span>
ghcr.io<span class="hljs-operator">/</span>vllm<span class="hljs-operator">-</span>project<span class="hljs-operator">/</span>guidellm:latest

docker <span class="hljs-keyword">exec</span> <span class="hljs-operator">-</span>it guidellm<span class="hljs-operator">-</span>lgd <span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bash
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">BASE_PATH=/workspace/outputs/genai-bench-eval
NAME=qwen3-8b-bf16-parallel20

rm -rf $BASE_PATH/$NAME

genai-bench benchmark \
<span class="hljs-deletion">--api-backend sglang \</span>
<span class="hljs-deletion">--api-base "http://localhost:8000" \</span>
<span class="hljs-deletion">--api-model-name "Qwen3-8B" \</span>
<span class="hljs-deletion">--api-key "xxx" \</span>
<span class="hljs-deletion">--model-tokenizer "/global/models/Qwen3-8B" \</span>
<span class="hljs-deletion">--server-engine "SGLang" \</span>
<span class="hljs-deletion">--server-gpu-type "H200" \</span>
<span class="hljs-deletion">--server-version "v0.5.6" \</span>
<span class="hljs-deletion">--server-gpu-count 1 \</span>
<span class="hljs-deletion">--task text-to-text \</span>
<span class="hljs-deletion">--max-time-per-run 10 \</span>
<span class="hljs-deletion">--max-requests-per-run 500 \</span>
<span class="hljs-deletion">--num-concurrency 20 \</span>
<span class="hljs-deletion">--traffic-scenario "D(1024,128)" \</span>
<span class="hljs-deletion">--experiment-base-dir $BASE_PATH \</span>
<span class="hljs-deletion">--experiment-folder-name $NAME</span>
</code></pre>
<p>关键参数：</p>
<ul>
<li>--profile：定义流量模式，选项包括 synchronous （顺序请求）、 concurrent （并行用户）、 throughput（最大容量）、 constant（每秒固定请求数）、 poisson（每秒随机请求数）或 sweep（自动速率探索）。</li>
<li>--rate：速率值，其含义取决于<code>--profile</code>，sweep 时是基准测试数量，concurrent 时是同时请求， constant / poisson 时是每秒请求数。</li>
<li>--max-seconds：每次基准测试的最大持续时间（秒数）（也可以用 --max-requests 来限制请求数）。</li>
</ul>
<p><strong>常用指标计算公式</strong>：</p>
<ul>
<li>平均ITL = (last_token - first_token) / (output_tokens - 1) , 不包括第一个token</li>
<li>平均TPOT = (last_token - request_start) / output_tokens , 包括第一个token</li>
<li>e2e latency = request_end - request_start</li>
<li>输出吞吐量 = output_tokens / e2e latency</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fguidellm" target="_blank" title="https://github.com/vllm-project/guidellm" ref="nofollow noopener noreferrer">github.com/vllm-projec…</a></li>
</ul>
<h3 data-id="heading-2">Genai-Bench</h3>
<p>Genai-bench 是一款强大的基准工具，旨在全面评估大语言模型服务系统的token级性能评估。它提供了模型服务性能的详细洞察，还有用户友好的 CLI 和实时进度监控的实时 UI。</p>
<p><strong>特征</strong>：</p>
<ul>
<li>🛠️ CLI 工具 ：无缝验证用户输入并启动基准测试。</li>
<li>📊 实时界面仪表盘 ：显示当前进度、日志和实时指标。</li>
<li>📝 丰富的日志 ：实验完成后自动写入终端和文件。</li>
<li>📈 实验分析器 ：生成包含原始指标数据的全面 Excel 报告，以及灵活的图表配置（默认 2x4 网格），可视化关键性能指标，包括吞吐量、延迟（TTFT、端对端、TPOT）、错误率和 RPS，适用于不同流量场景和并发水平。支持自定义绘制布局和多行比较。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cffc32791874fa2b67ea1cb61c6eff5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=8rRdXTX7R86IkJxF6%2F1TvW%2BUZT4%3D" alt="" loading="lazy"/></p>
<p><strong>安装</strong>：</p>
<pre><code class="hljs">pip install genai-bench
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">BASE_PATH=/workspace/outputs/genai-bench-eval
NAME=qwen3-8b-bf16-parallel20

rm -rf $BASE_PATH/$NAME

genai-bench benchmark \
<span class="hljs-deletion">--api-backend sglang \</span>
<span class="hljs-deletion">--api-base "http://localhost:8000" \</span>
<span class="hljs-deletion">--api-model-name "Qwen3-8B" \</span>
<span class="hljs-deletion">--api-key "xxx" \</span>
<span class="hljs-deletion">--model-tokenizer "/global/models/Qwen3-8B" \</span>
<span class="hljs-deletion">--server-engine "SGLang" \</span>
<span class="hljs-deletion">--server-gpu-type "H200" \</span>
<span class="hljs-deletion">--server-version "v0.5.6" \</span>
<span class="hljs-deletion">--server-gpu-count 1 \</span>
<span class="hljs-deletion">--task text-to-text \</span>
<span class="hljs-deletion">--max-time-per-run 10 \</span>
<span class="hljs-deletion">--max-requests-per-run 500 \</span>
<span class="hljs-deletion">--num-concurrency 20 \</span>
<span class="hljs-deletion">--traffic-scenario "D(1024,128)" \</span>
<span class="hljs-deletion">--experiment-base-dir $BASE_PATH \</span>
<span class="hljs-deletion">--experiment-folder-name $NAME</span>
</code></pre>
<p>参数说明：</p>
<ul>
<li>--task：指定任务类型，支持文本生成、文生图、文本嵌入、图像嵌入。</li>
<li>--traffic-scenario：接受一种或多种场景。每次运行都会迭代所提供的场景和所选迭代参数（并发或批处理大小）。文本分布类型：
<ul>
<li>确定性输入输出：<code>D(num_input_tokens,num_output_tokens)</code>，比如：<code>D(100,1000)</code></li>
<li>正态分布‌：<code>N(mean_input_tokens,stddev_input_tokens)/(mean_output_tokens,stddev_output_tokens)</code>，例如：<code>N(480,240)/(300,150)</code></li>
<li>均匀分布：<code>U(min_input_tokens,max_input_tokens)/(min_output_tokens,max_output_tokens)</code>，例如：<code>U(50,100)/(200,250)</code></li>
</ul>
</li>
</ul>
<p>从结果生成 Excel 报告：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">BASE_PATH</span>=/workspace/outputs/genai-bench-eval
<span class="hljs-attr">NAME</span>=qwen3-<span class="hljs-number">8</span>b-bf16-parallel20

genai-bench excel --experiment-folder $BASE_PATH/$NAME \
  --excel-name results \
  --metric-percentile mean
</code></pre>
<p><strong>常见指标计算公式</strong>：</p>
<ul>
<li>metrics.<strong>e2e_latency</strong> = response.end_time - response.start_time</li>
<li>metrics.<strong>num_input_tokens</strong> = response.num_prefill_tokens</li>
<li>metrics.total_tokens = metrics.num_input_tokens</li>
<li>metrics.<strong>num_output_tokens</strong> = response.tokens_received</li>
<li>metrics.<strong>total_tokens</strong> += metrics.num_output_tokens</li>
<li>metrics.<strong>ttft</strong> = response.time_at_first_token - response.start_time</li>
<li>metrics.output_latency = metrics.e2e_latency - metrics.ttft</li>
<li>metrics.<strong>tpot</strong> = metrics.output_latency / (metrics.num_output_tokens - 1)，相当于GuideLLM中的ITL</li>
<li>metrics.<strong>output_throughput</strong> = metrics.num_output_tokens - 1) / metrics.output_latency</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsgl-project%2Fgenai-bench" target="_blank" title="https://github.com/sgl-project/genai-bench" ref="nofollow noopener noreferrer">github.com/sgl-project…</a></li>
</ul>
<h3 data-id="heading-3">AIPerf</h3>
<p>AIPerf 是一款全面的基准测试工具，用于衡量生成式 AI 模型的性能。它通过命令行展示详细的指标以及详尽的基准性能报告。</p>
<p>AIPerf 之前，英伟达开源的大模型性能工具为GenAI-Perf，目前已经逐步淘汰。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d87a06df9d974ee9b313d9bd9b84fb1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=f%2FvB7ZF%2BRL%2B8b1HZHChvi0CzdH8%3D" alt="" loading="lazy"/></p>
<p><strong>特性</strong>：</p>
<ul>
<li>通过多进程支持可扩展</li>
<li>模块化设计便于用户修改</li>
<li>支持多种基准测试模式：
<ul>
<li>并发</li>
<li>请求率</li>
<li>最大并发量的请求率</li>
<li>追踪回放用于重现性能基准测试结果</li>
</ul>
</li>
<li>支持公开数据集</li>
</ul>
<p><strong>支持的 API</strong>：</p>
<ul>
<li>OpenAI chat completions</li>
<li>OpenAI completions</li>
<li>OpenAI embeddings</li>
<li>OpenAI audio: request throughput and latency</li>
<li>OpenAI images: request throughput and latency</li>
<li>NIM rankings</li>
</ul>
<p><strong>安装</strong>：</p>
<pre><code class="hljs">pip install aiperf
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">aiperf profile \
<span class="hljs-deletion">--model qwen3 \</span>
<span class="hljs-deletion">--tokenizer /global/models/Qwen3-8B \</span>
<span class="hljs-deletion">--url localhost:8000 \</span>
<span class="hljs-deletion">--endpoint-type chat \</span>
<span class="hljs-deletion">--endpoint /v1/chat/completions \</span>
<span class="hljs-deletion">--streaming \</span>
<span class="hljs-deletion">--synthetic-input-tokens-mean 1024 \</span>
<span class="hljs-deletion">--synthetic-input-tokens-stddev 0 \</span>
<span class="hljs-deletion">--output-tokens-mean 128 \</span>
<span class="hljs-deletion">--output-tokens-stddev 0 \</span>
<span class="hljs-deletion">--extra-inputs ignore_eos:true \</span>
<span class="hljs-deletion">--concurrency 20 \</span>
<span class="hljs-deletion">--request-count 500 \</span>
<span class="hljs-deletion">--warmup-request-count 0 \</span>
<span class="hljs-deletion">--num-dataset-entries 1000 \</span>
<span class="hljs-deletion">--random-seed 100    </span>
</code></pre>
<p><strong>生成基准测试结果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04689647972645dea053dd8f5b55f73c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=5geHI2BFqiW9hLOPpq%2B1Hrs8Yhs%3D" alt="" loading="lazy"/></p>
<p><strong>常用指标计算公式</strong>：</p>
<ul>
<li><strong>TTFT</strong> = First Response Timestamp - Request Start Timestamp</li>
<li>TTST = Second Response Timestamp - First Response Timestamp</li>
<li>Inter Token Latency(<strong>ITL</strong>) = (Request Latency - Time to First Token) / (Output Sequence Length - 1)</li>
<li><strong>ICL</strong> = <code>[timestamps[i] - timestamps[i-1] for i in range(1, len(timestamps))]</code> ，比如：对于块在 [100ms, 150ms, 210ms] 时间到达的流响应。ICL = [50ms, 60ms]（连续时间戳之间的差异）</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fai-dynamo%2Faiperf" target="_blank" title="https://github.com/ai-dynamo/aiperf" ref="nofollow noopener noreferrer">github.com/ai-dynamo/a…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftriton-inference-server%2Fperf_analyzer%2Ftree%2Fmain%2Fgenai-perf" target="_blank" title="https://github.com/triton-inference-server/perf_analyzer/tree/main/genai-perf" ref="nofollow noopener noreferrer">github.com/triton-infe…</a></li>
</ul>
<h3 data-id="heading-4">EvalScope</h3>
<p>EvalScope 是魔搭社区倾力打造的模型评测与性能基准测试框架，为您的模型评估需求提供一站式解决方案。支持的模型类型如下：</p>
<ul>
<li>🧠 大语言模型</li>
<li>🎨 多模态模型</li>
<li>🔍 Embedding 模型</li>
<li>🏆 Reranker 模型</li>
<li>🖼️ CLIP 模型</li>
<li>🎭 AIGC模型（图生文/视频）</li>
</ul>
<p>EvalScope 不仅仅是一个评测工具，它还内置多个业界认可的测试基准和评测指标：MMLU、CMMLU、C-Eval、GSM8K 等。同时，支持模型推理性能压测，确保您的模型在实际应用中表现出色。</p>
<p>EvalScope 整体架构如下图所示，包括以下模块：</p>
<ol>
<li>输入层</li>
</ol>
<ul>
<li>模型来源：API模型（OpenAI API）、本地模型（ModelScope）</li>
<li>数据集：标准评测基准（MMLU/GSM8k等）、自定义数据（MCQ/QA）</li>
</ul>
<ol start="2">
<li>核心功能</li>
</ol>
<p>多后端评估</p>
<ul>
<li>原生后端：LLM/VLM/Embedding/T2I模型统一评估</li>
<li>集成框架：OpenCompass/MTEB/VLMEvalKit/RAGAS</li>
</ul>
<p>性能监控</p>
<ul>
<li>模型插件：支持多种模型服务API</li>
<li>数据插件：支持多种数据格式</li>
<li>指标追踪：TTFT/TPOP/稳定性 等指标</li>
</ul>
<p>工具扩展</p>
<ul>
<li>集成：Tool-Bench/Needle-in-a-Haystack/BFCL-v3</li>
</ul>
<ol start="3">
<li>输出层</li>
</ol>
<ul>
<li>结构化报告: 支持JSON/Table/Logs</li>
<li>可视化平台：支持Gradio/Wandb/SwanLab</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f442ea528144788a5bc7979c035185c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=GuDFzyGxA0p%2BmDRobMwnns8pJOg%3D" alt="" loading="lazy"/></p>
<p><strong>框架特点</strong>：</p>
<ul>
<li>基准数据集：预置了多个常用测试基准，包括：MMLU、CMMLU、C-Eval、GSM8K、ARC、HellaSwag、TruthfulQA、MATH、HumanEval等。</li>
<li>评测指标：实现了多种常用评测指标。</li>
<li>模型接入：统一的模型接入机制，兼容多个系列模型的Generate、Chat接口。</li>
<li>自动评测：包括客观题自动评测和使用专家模型进行的复杂任务评测。</li>
<li>评测报告：自动生成评测报告。</li>
<li>竞技场(Arena)模式：用于模型间的比较以及模型的客观评测，支持多种评测模式，包括：
<ul>
<li>Single mode：对单个模型进行评分。</li>
<li>Pairwise-baseline mode：与基线模型进行对比。</li>
<li>Pairwise (all) mode：所有模型间的两两对比。</li>
</ul>
</li>
<li>可视化工具：提供直观的评测结果展示。</li>
<li>模型性能评测：提供模型推理服务压测工具和详细统计。</li>
<li>OpenCompass集成：支持OpenCompass作为评测后端，对其进行了高级封装和任务简化，您可以更轻松地提交任务进行评测。</li>
<li>VLMEvalKit集成：支持VLMEvalKit作为评测后端，轻松发起多模态评测任务，支持多种多模态模型和数据集。</li>
<li>全链路支持：通过与ms-swift训练框架的无缝集成，实现模型训练、模型部署、模型评测、评测报告查看的一站式开发流程，提升用户的开发效率。</li>
</ul>
<p>EvalScope 支持OpenAI API格式模型服务以及多种数据集格式，方便用户进行性能评测。具体使用如下：</p>
<p><strong>安装</strong>：</p>
<pre><code class="hljs language-css" lang="css">pip install evalscope<span class="hljs-selector-attr">[perf]</span> -U
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-lua" lang="lua">evalscope perf \
  <span class="hljs-comment">--parallel 20 \</span>
  <span class="hljs-comment">--number 500  \</span>
  <span class="hljs-comment">--model Qwen-bf16-isl1k-osl128-056post1 \</span>
  <span class="hljs-comment">--url http://localhost:8000/v1/chat/completions \</span>
  <span class="hljs-comment">--api openai \</span>
  <span class="hljs-comment">--dataset random \</span>
  <span class="hljs-comment">--max-tokens 128 \</span>
  <span class="hljs-comment">--min-tokens 128 \</span>
  <span class="hljs-comment">--prefix-length 0 \</span>
  <span class="hljs-comment">--min-prompt-length 1024 \</span>
  <span class="hljs-comment">--max-prompt-length 1024 \</span>
  <span class="hljs-comment">--tokenizer-path /global/models/Qwen3-8B \</span>
  <span class="hljs-comment">--extra-args '{"ignore_eos": true}' \</span>
  <span class="hljs-comment">--outputs-dir /workspace/outputs/evalscope-perf-qwen3-8b</span>
</code></pre>
<p>参数说明：</p>
<ul>
<li>parallel: 请求的并发数，可以传入多个值，用空格隔开</li>
<li>number: 发出的请求的总数量，可以传入多个值，用空格隔开（与parallel一一对应）</li>
<li>url: 请求的URL地址</li>
<li>model: 使用的模型名称</li>
<li>api: 使用的API服务，默认为openai</li>
<li>dataset: 数据集名称，此处为random，表示随机生成数据集。</li>
<li>tokenizer-path: 模型的tokenizer路径，用于计算token数量（在random数据集中是必须的）</li>
<li>extra-args: 请求中的额外的参数，传入json格式的字符串，例如：{"ignore_eos": true} 表示忽略结束token</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9da7867f8f24d5c9e64ffd629063984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=VF3FNqn5ec4niVhkTKlslYTy1Wk%3D" alt="" loading="lazy"/></p>
<p><strong>常见指标计算公式</strong>：</p>
<ul>
<li><strong>time_per_output_token</strong> (TPOT) = (query_latency - first_chunk_latency) / (completion_tokens - 1)，注意：AIPerf和GuideLLM中的itl实际上和EvalsSope的计算公式一致。</li>
<li>n_time_per_output_token += benchmark_data.time_per_output_token</li>
<li><strong>avg_time_per_token</strong> (平均TPOT) = n_time_per_output_token / n_succeed_queries</li>
<li>total_first_chunk_latency += benchmark_data.first_chunk_latency</li>
<li><strong>avg_first_chunk_latency</strong>（平均TTFT） = total_first_chunk_latency / n_succeed_queries</li>
<li>inter_chunk_latency = <code>[t2 - t1 for t1, t2 in zip(chunk_times[:-1], chunk_times[1:])]</code></li>
<li>n_total_inter_token_latency += benchmark_data.inter_chunk_latency</li>
<li><strong>avg_inter_token_latency</strong>（平均ITL） = sum(n_total_inter_token_latency) / len(n_total_inter_token_latency)</li>
<li><strong>qps</strong> = n_succeed_queries / total_time</li>
<li>avg_output_token_per_seconds（输出token吞吐量） = n_total_completion_tokens / total_time</li>
</ul>
<p><strong>参考</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fevalscope.readthedocs.io%2Fzh-cn%2Flatest%2Fuser_guides%2Fstress_test%2Fquick_start.html" target="_blank" title="https://evalscope.readthedocs.io/zh-cn/latest/user_guides/stress_test/quick_start.html" ref="nofollow noopener noreferrer">evalscope.readthedocs.io/zh-cn/lates…</a></li>
</ul>
<h3 data-id="heading-5">Inference Perf</h3>
<p>Inference Perf 是一款生成式 AI 推理性能基准工具，允许您对部署的推理模型的性能进行基准测试和分析。它不受模型服务影响，可用于<strong>性能测量</strong>和<strong>对不同系统进行全面比较</strong>。它是推理基准测试和指标标准化工作的一部分，旨在标准化 Kubernetes 和模型服务社区中用于衡量推理性能的基准工具和指标 。</p>
<p><strong>架构</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b98ffc0ed704095aaefede01b825606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=sxSdIS7oV4N1dchtAoOGQbJ3Wpg%3D" alt="" loading="lazy"/></p>
<p><strong>主要特点</strong>：</p>
<ul>
<li>高度可扩展，并支持大规模模型推理生产部署的基准测试。</li>
<li>报告衡量 LLM 性能的关键指标。</li>
<li>支持不同的真实世界和合成数据集。</li>
<li>支持不同的 API，并支持多个具增强指标的模型服务，如 vLLM、SGLang 和 TGI。</li>
<li>支持使用 LLM-d、Dynamo 和 Inference Gateway 等框架进行大型部署基准测试。</li>
<li>支持指定精确的输入和输出分布以模拟不同场景——支持高斯分布、固定长度、最小最大场景。</li>
<li>生成不同的负载模式，并能对特定场景进行基准测试，如突发流量、扩展至饱和以及其他自动扩展/路由场景。</li>
<li>支持多轮聊天对话，可以保持一系列消息的上下文，模拟对话。每轮聊天中的请求将保留前置消息作为前缀。</li>
</ul>
<p><strong>安装</strong>：</p>
<pre><code class="hljs">pip install inference-perf
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">inference-perf --config_file config.yml
</code></pre>
<p>其中，config.yml内容如下所示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">load:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">constant</span>
  <span class="hljs-attr">interval:</span> <span class="hljs-number">15</span>
  <span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">rate:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">duration:</span> <span class="hljs-number">30</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">rate:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">duration:</span> <span class="hljs-number">30</span>
<span class="hljs-attr">api:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">completion</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">sglang</span>
  <span class="hljs-attr">model_name:</span> <span class="hljs-string">HuggingFaceTB/SmolLM2-135M-Instruct</span>
  <span class="hljs-attr">base_url:</span> <span class="hljs-string">http://0.0.0.0:8000</span>
<span class="hljs-attr">tokenizer:</span>
  <span class="hljs-attr">pretrained_model_name_or_path:</span> <span class="hljs-string">HuggingFaceTB/SmolLM2-135M-Instruct</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">synthetic</span>
  <span class="hljs-attr">input_distribution:</span>
    <span class="hljs-attr">min:</span> <span class="hljs-number">10</span>             <span class="hljs-comment"># min length of the synthetic prompts</span>
    <span class="hljs-attr">max:</span> <span class="hljs-number">100</span>            <span class="hljs-comment"># max length of the synthetic prompts</span>
    <span class="hljs-attr">mean:</span> <span class="hljs-number">50</span>            <span class="hljs-comment"># mean length of the synthetic prompts</span>
    <span class="hljs-attr">std:</span> <span class="hljs-number">10</span>             <span class="hljs-comment"># standard deviation of the length of the synthetic prompts</span>
  <span class="hljs-attr">output_distribution:</span>
    <span class="hljs-attr">min:</span> <span class="hljs-number">10</span>             <span class="hljs-comment"># min length of the output to be generated</span>
    <span class="hljs-attr">max:</span> <span class="hljs-number">100</span>            <span class="hljs-comment"># max length of the output to be generated</span>
    <span class="hljs-attr">mean:</span> <span class="hljs-number">50</span>            <span class="hljs-comment"># mean length of the output to be generated</span>
    <span class="hljs-attr">std:</span> <span class="hljs-number">10</span>             <span class="hljs-comment"># standard deviation of the length of the output to be generated</span>
<span class="hljs-attr">metrics:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">prometheus</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">http://localhost:9090</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-number">15</span>
<span class="hljs-attr">report:</span>
  <span class="hljs-attr">request_lifecycle:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">per_stage:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">per_request:</span> <span class="hljs-literal">true</span>
</code></pre>
<p><strong>常见指标计算公式</strong>：</p>
<ul>
<li><strong>time_per_output_token</strong>（TPOT）= <code>(x.info.output_token_times[-1] - x.info.output_token_times[0]) / (len(x.info.output_token_times) - 1)</code> ，该指标相当于GuideLLM的ITL</li>
<li>normalized_time_per_output_token（标准TPOT） = (metric.end_time - metric.start_time) / metric.info.output_tokens ，该指标相当于GuideLLM的TPOT</li>
<li><strong>TTFT</strong> = x.info.output_token_times[0] - x.start_time</li>
<li><strong>平均ITL</strong> = <code>mean([t2 - t1   for x in streamable   for t1, t2 in zip(x.info.output_token_times, x.info.output_token_times[1:], strict=False)])</code></li>
<li>total_time = max(x.end_time for x in metrics) - min(x.start_time for x in metrics)` ，相当于AIPerf中的ICL求平均。</li>
<li><strong>output_tokens_per_sec</strong> (输出token吞吐量) = sum(x.info.output_tokens for x in all_successful) / total_time</li>
<li><strong>requests_per_sec</strong>（RPS） = len(all_successful) / total_time</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes-sigs%2Finference-perf" target="_blank" title="https://github.com/kubernetes-sigs/inference-perf" ref="nofollow noopener noreferrer">github.com/kubernetes-…</a></li>
</ul>
<h3 data-id="heading-6">LLMPerf</h3>
<p>LLMPerf 是一个用于评估 LLM API 性能的工具。目前已停止更新。实现了两种评估大型语言模型的测试：一个是用于测试性能的负载测试，另一个是用于检测正确性的正确性测试。</p>
<p><strong>安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/ray-project/llmperf.git
<span class="hljs-built_in">cd</span> llmperf
pip install -e .
</code></pre>
<p><strong>负载测试</strong>：</p>
<p>负载测试会向 LLM API 生成多个并发请求，并测量tiken间延迟和每次请求及跨并发请求的生成吞吐量。每个请求中发送的提示词格式如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Randomly stream lines <span class="hljs-keyword">from</span> the following <span class="hljs-keyword">text</span>. Don<span class="hljs-comment">'t generate eos tokens:</span>
LINE <span class="hljs-number">1</span>,
LINE <span class="hljs-number">2</span>,
LINE <span class="hljs-number">3</span>,
...
</code></pre>
<p>诗句是从莎士比亚十四行诗中的一组诗句中随机抽取的。无论测试的是哪个 LLM API，LlamaTokenizer 都会统计 token 数。这是为了确保提示在不同 LLM API 上保持一致。</p>
<p>OpenAI Compatible APIs 示例如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">export</span> OPENAI_API_KEY=secret_abcdefg
<span class="hljs-keyword">export</span> OPENAI_API_BASE=https:<span class="hljs-comment">//console.endpoints.anyscale.com/m/v1</span>

python llm_correctness.py \
--model <span class="hljs-string">"meta-llama/Llama-2-7b-chat-hf"</span> \
--max-<span class="hljs-built_in">num</span>-completed-requests <span class="hljs-number">150</span> \
--timeout <span class="hljs-number">600</span> \
--<span class="hljs-built_in">num</span>-concurrent-requests <span class="hljs-number">10</span> \
--results-dir <span class="hljs-string">"result_outputs"</span>
</code></pre>
<p>注意事项与免责声明：</p>
<ul>
<li>终端提供商的后端可能差异很大，因此这并不代表软件在特定硬件上的运行方式。</li>
<li>结果可能会因一天中的时间而异。</li>
<li><strong>结果可能会因负载不同而有所变化</strong>。</li>
<li><strong>结果可能与用户的工作量不相关</strong>。</li>
</ul>
<p><strong>正确性测试</strong>：</p>
<p>正确性测试会以以下格式向 LLM API 生成多个并发请求：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">Convert</span> the following sequence <span class="hljs-keyword">of</span> words <span class="hljs-keyword">into</span> a number: {random_number_in_word_format}. Output just your <span class="hljs-keyword">final</span> answer.
</code></pre>
<p>其中：random_number_in_word_format 可以是 “one hundred and twenty three”。测试检查回答中是否包含该数字格式，在此例中为 123。</p>
<p>该检验对随机生成的数字进行此操作，并报告包含不匹配的回答数量。</p>
<p>OpenAI Compatible APIs 示例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">export</span> OPENAI_API_KEY=secret_abcdefg
<span class="hljs-keyword">export</span> OPENAI_API_BASE=https:<span class="hljs-comment">//console.endpoints.anyscale.com/m/v1</span>

python llm_correctness.py \
--model <span class="hljs-string">"meta-llama/Llama-2-7b-chat-hf"</span> \
--max-<span class="hljs-built_in">num</span>-completed-requests <span class="hljs-number">150</span> \
--timeout <span class="hljs-number">600</span> \
--<span class="hljs-built_in">num</span>-concurrent-requests <span class="hljs-number">10</span> \
--results-dir <span class="hljs-string">"result_outputs"</span>
</code></pre>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fray-project%2Fllmperf" target="_blank" title="https://github.com/ray-project/llmperf" ref="nofollow noopener noreferrer">github.com/ray-project…</a></li>
</ul>
<h3 data-id="heading-7">llm-benchmark</h3>
<p>llm-benchmark 通过 Ollama 进行本地 LLM 吞吐量基准测试。</p>
<p>llm-benchmark 在 Windows、Linux 和 macOS 上，它会检测内存大小以优先下载所需的 LLM 模型。</p>
<p>当内存内存大小大于或等于 4GB 但小于 7GB 时，它会检查是否存在 gemma:2b。程序隐式地拉取这些模型。</p>
<pre><code class="hljs">ollama pull deepseek-r1:1.5b
ollama pull gemma:2b
ollama pull phi:2.7b
ollama pull phi3:3.8b
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa13a1705ff54872920428714f49e5d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=RtPRa7T%2FJLUGteBt6FR4GbIJm%2BQ%3D" alt="" loading="lazy"/></p>
<p><strong>安装</strong>：</p>
<pre><code class="hljs">pip install llm-benchmark
</code></pre>
<p><strong>运行</strong>：</p>
<p>#1 将系统信息和基准测试结果发送到远程服务器</p>
<pre><code class="hljs language-arduino" lang="arduino">llm_benchmark run
</code></pre>
<p>#2 不要将系统信息和基准测试结果发送到远程服务器</p>
<pre><code class="hljs language-arduino" lang="arduino">llm_benchmark run --no-sendinfo
</code></pre>
<p>#3 明确指定 ollama 可执行文件路径时运行（当你构建了自己的 ollama 开发者版本时）</p>
<pre><code class="hljs language-css" lang="css">llm_benchmark run <span class="hljs-attr">--ollamabin</span>=~/<span class="hljs-selector-tag">code</span>/ollama/ollama
</code></pre>
<p>#4 运行自定义基准模型</p>
<pre><code class="hljs language-css" lang="css">llm_benchmark run <span class="hljs-attr">--custombenchmark</span>=path/<span class="hljs-selector-tag">to</span>/custombenchmarkmodels<span class="hljs-selector-class">.yml</span>
</code></pre>
<p>其中，custombenchmarkmodels.yml文件内容如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">file_name:</span> <span class="hljs-string">"custombenchmarkmodels.yml"</span>
<span class="hljs-symbol">version:</span> <span class="hljs-number">2.0</span>.<span class="hljs-keyword">custom</span>
<span class="hljs-symbol">models:</span>
  - model: <span class="hljs-string">"deepseek-r1:1.5b"</span>
  - model: <span class="hljs-string">"qwen:0.5b"</span>
</code></pre>
<p>参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidatatools%2Follama-benchmark" target="_blank" title="https://github.com/aidatatools/ollama-benchmark" ref="nofollow noopener noreferrer">github.com/aidatatools…</a></li>
</ul>
<h2 data-id="heading-8">常见的性能延迟指标</h2>
<p>上面在各框架概述，我梳理了各框架的性能压测指标，但是有一些指标在各框架里面计算方式不一，下面我综合主流的大模型框架的评估指标的计算方式，根据自己的主观判断给一点标准定义，以便使用各框架进行性能压测时能够对齐。：</p>
<ul>
<li><strong>首Token生成时间</strong>（Time To First Token，简称TTFT）：即用户输入提示后，模型生成第一个输出词元（Token）所需的时间。在实时交互中，低时延获取响应非常重要，但在离线工作任务中则不太重要。此指标受处理提示信息并生成首个输出词元所需的时间所驱动。通常，不仅对平均TTFT感兴趣，还包括其分布，如P50、P90、P95和P99等。计算公式为：<code>ttft = first_token_time - request_start_time</code>。</li>
<li><strong>Token间延迟</strong>（Inter Token Latency，简称ITL）：计算公式：<code>ITL = (last_token_time - first_token_time) / (output_tokens - 1) , 不包括第一个token</code>。</li>
<li><strong>块间延迟</strong>（Inter Chunk Latency，简称ICL）：特指在<strong>流式传输场景</strong>下，模型服务器返回的两个连续数据块（Chunk）之间的时间间隔。在流式传输中，LLM生成的文本不是一次性全部返回，而是以“块”为单位逐步返回。一个“块”通常包含若干个Token。因此，它衡量的是客户端接收到第N个数据块与接收到第N+1个数据块之间的时间差。它主要出现在服务器以 “text/event-stream” 等流式协议返回数据的场景中，是评估流式响应流畅度的核心指标。计算公式：<code>Inter Chunk Latency (Chunk_N) = Timestamp(收到 Chunk_{N+1}) - Timestamp(收到 Chunk_N)</code>。</li>
<li><strong>每个输出Token的生成时间</strong>（Time Per Output Token，简称TPOT）：即为每个用户的查询生成一个输出词元所需的时间。这一指标与每个用户对模型“速度”的感知相关。例如，TPOT为100ms/token表示每个用户每秒可处理10个token，或者每分钟处理约450个token，那么这一速度远超普通人的阅读速度。计算公式：<code>TPOT = (last_token_time - request_start_time) / output_tokens , 包括第一个token</code>。</li>
<li><strong>端到端时延（E2E）</strong>：模型为用户生成完整响应所需的总时间。整体响应时延可使用前两个指标计算得出：<code>e2e latency = request_end_time - request_start_time</code>。</li>
<li><strong>每分钟完成的请求数（RPS）</strong>：通常情况下，我们都希望系统能够处理并发请求。可能是因为你正在处理来自多个用户的输入或者可能有一个批量推理任务。</li>
<li><strong>生成Token吞吐量</strong>：推理服务在所有用户请求中每秒可生成的输出词元(Token)数。考虑到无法测量预加载时间，并且总推理时延所花时间更多地取决于生成的Token数量，而不是输入的Token数量，因此，将注意力集中在输出Token上通常是正确的抉择。计算公式：<code>输出Token吞吐量 = output_tokens / e2e latency</code></li>
<li><strong>总吞吐量</strong>：包括输入的Token和生成的Token。</li>
</ul>
<h2 data-id="heading-9">各框架之间的指标差异</h2>
<p>下面是针对qwen3-8b在h200上进行各框架性能指标对齐的结果（主要是ICL/ITL/TPOT指标差异较大）。即针对上面汇总之后定义的指标，在各个框架中的对应值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3037daa7b997422aa1a5660565724bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768015536&amp;x-signature=mm4uhE33JdS1QpgC2%2Fk9rjd%2FBAg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">结语</h2>
<p>最后，在GuideLLM针对各LLM性能压测进行综合对比的基础上，下表进一步汇总了各个LLM性能压测框架的特性差异，大家在选择性能测试工具时可以根据自己的偏好进行选择。如果需要对比各种框架和特性的性能，最好统一使用同一个工具进行比较，以免出现结论性错误。</p>


























































































































<table><thead><tr><th>工具</th><th>CLI</th><th>API</th><th>High Perf</th><th>Full Metrics</th><th>数据模态</th><th>数据源</th><th>Profiles</th><th>Backends</th><th>Endpoints</th><th>输出类型</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fguidellm" target="_blank" title="https://github.com/vllm-project/guidellm" ref="nofollow noopener noreferrer">GuideLLM</a></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>文本, 图像, 音频, 视频</td><td>HuggingFace, Files, 合成, 自定义数据集</td><td>Synchronous, Concurrent, Throughput, Constant, Poisson, Sweep</td><td>OpenAI-compatible</td><td>/completions, /chat/completions, /audio/translation, /audio/transcription</td><td>console, json, csv, html</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkubernetes-sigs%2Finference-perf" target="_blank" title="https://github.com/kubernetes-sigs/inference-perf" ref="nofollow noopener noreferrer">inference-perf</a></td><td>✅</td><td>❌</td><td>✅</td><td>❌</td><td>文本</td><td>合成, 指定数据集</td><td>Concurrent, Constant, Poisson, Sweep</td><td>OpenAI-compatible</td><td>/completions, /chat/completions</td><td>json, png</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsgl-project%2Fgenai-bench" target="_blank" title="https://github.com/sgl-project/genai-bench" ref="nofollow noopener noreferrer">genai-bench</a></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>文本, 图像, Embedding, ReRank</td><td>合成, File</td><td>Concurrent</td><td>OpenAI-compatible, Hosted Cloud</td><td>/chat/completions, /embeddings</td><td>console, xlsx, png</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fray-project%2Fllmperf" target="_blank" title="https://github.com/ray-project/llmperf" ref="nofollow noopener noreferrer">llm-perf</a></td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>文本</td><td>合成</td><td>Concurrent</td><td>OpenAI-compatible, Hosted Cloud</td><td>/chat/completions</td><td>json</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faidatatools%2Follama-benchmark" target="_blank" title="https://github.com/aidatatools/ollama-benchmark" ref="nofollow noopener noreferrer">ollama-benchmark</a></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>文本</td><td>合成</td><td>同步</td><td>Ollama</td><td>/completions</td><td>console, json</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvllm-project%2Fvllm%2Ftree%2Fmain%2Fbenchmarks" target="_blank" title="https://github.com/vllm-project/vllm/tree/main/benchmarks" ref="nofollow noopener noreferrer">vllm/benchmarks</a></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>文本</td><td>合成, 指定数据集</td><td>Synchronous, Throughput, Constant, Sweep</td><td>OpenAI-compatible, vLLM API</td><td>/completions, /chat/completions</td><td>console, png</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fai-dynamo%2Faiperf" target="_blank" title="https://github.com/ai-dynamo/aiperf" ref="nofollow noopener noreferrer">AIPerf</a></td><td>✅</td><td>-</td><td>-</td><td>-</td><td>文本、图像、视频</td><td>合成、自定义以及公开数据集</td><td>Concurrent</td><td>OpenAI-compatible</td><td>/completions, /chat/completions</td><td>console, json, csv</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fevalscope.readthedocs.io%2Fzh-cn%2Flatest%2Fuser_guides%2Fstress_test%2Fquick_start.html" target="_blank" title="https://evalscope.readthedocs.io/zh-cn/latest/user_guides/stress_test/quick_start.html" ref="nofollow noopener noreferrer">EvalScope Perf</a></td><td>✅</td><td>-</td><td>-</td><td>❌</td><td>文本、图像</td><td>合成、自定义以及公开数据集</td><td>Concurrent</td><td>OpenAI-compatible</td><td>/completions, /chat/completions</td><td>console, json</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Electron 中的 “preload” 与 “invoke”]]></title>    <link>https://juejin.cn/post/7590421489997578259</link>    <guid>https://juejin.cn/post/7590421489997578259</guid>    <pubDate>2026-01-03T06:19:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489997578259" data-draft-id="7590421489997561875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Electron 中的 “preload” 与 “invoke”"/> <meta itemprop="keywords" content="Electron"/> <meta itemprop="datePublished" content="2026-01-03T06:19:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360628462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Electron 中的 “preload” 与 “invoke”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360628462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T06:19:16.000Z" title="Sat Jan 03 2026 06:19:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 前言</h2>
<p>Electron 作为使用 Web 技术构建跨平台桌面应用的框架，其核心挑战之一是如何<strong>安全地实现主进程与渲染进程之间的通信</strong>。随着 Electron 12+ 版本默认启用上下文隔离（<code>contextIsolation: true</code>），传统的通信方式已经不再安全可靠electronjs.org。本文将深入探讨现代 Electron 应用中的安全通信方案——Preload 脚本与 Invoke 模式，帮助你构建更加安全可靠的应用。</p>
<h2 data-id="heading-1">🔍 核心概念解析</h2>
<h3 data-id="heading-2">什么是 Preload 脚本？</h3>
<p>Preload 脚本是一种在网页加载前执行的 JavaScript 文件，它具有访问 Node.js 和 Electron API 的特权权限csdn.net。更重要的是，它运行在一个独立的、与渲染进程隔离的上下文中，充当了<strong>安全桥梁</strong>的角色 。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// preload.js</span>
<span class="hljs-keyword">const</span> { contextBridge, ipcRenderer } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>)

<span class="hljs-comment">// 使用 contextBridge 安全地暴露 API</span>
contextBridge.<span class="hljs-title function_">exposeInMainWorld</span>(<span class="hljs-string">'electronAPI'</span>, {
  <span class="hljs-comment">// 暴露一个控制窗口的函数，使用 invoke 模式</span>
  <span class="hljs-attr">controlWindow</span>: <span class="hljs-function">(<span class="hljs-params">action</span>) =&gt;</span> ipcRenderer.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'window-control'</span>, action),
  <span class="hljs-comment">// 可以暴露其他经过精心设计的API</span>
  <span class="hljs-attr">getVersion</span>: <span class="hljs-function">() =&gt;</span> ipcRenderer.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'app:get-version'</span>)
})
</code></pre>
<h3 data-id="heading-3">什么是 Invoke 模式？</h3>
<p>Invoke 模式是 Electron 提供的一种异步双向通信机制，通过 <code>ipcRenderer.invoke</code> 和 <code>ipcMain.handle</code> 配合使用electronjs.org+1。渲染进程可以发起请求并等待响应，主进程则处理请求并返回结果，整个过程基于 Promise，避免了回调地狱。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 主进程 (main.js)</span>
<span class="hljs-keyword">const</span> { ipcMain } = require(<span class="hljs-string">'electron'</span>)

ipcMain.handle(<span class="hljs-string">'window-control'</span>, <span class="hljs-keyword">async</span> (<span class="hljs-keyword">event</span>, action) =&gt; {
  <span class="hljs-keyword">const</span> win = BrowserWindow.fromWebContents(<span class="hljs-keyword">event</span>.sender)
  <span class="hljs-keyword">if</span> (!win) <span class="hljs-keyword">return</span> { success: <span class="hljs-literal">false</span> }
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'minimize'</span>) win.minimize()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'maximize'</span>) win.isMaximized() ? win.restore() : win.maximize()
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'close'</span>) win.close()
    <span class="hljs-keyword">return</span> { success: <span class="hljs-literal">true</span> }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> { success: <span class="hljs-literal">false</span>, error: error.message }
  }
})
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 渲染进程 (renderer.js)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">minimizeWindow</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调用Preload暴露的API，就像调用普通函数一样</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">electronAPI</span>.<span class="hljs-title function_">controlWindow</span>(<span class="hljs-string">'minimize'</span>)
  <span class="hljs-keyword">if</span> (result.<span class="hljs-property">success</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'窗口最小化成功'</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'操作失败:'</span>, result.<span class="hljs-property">error</span>)
  }
}
</code></pre>
<h3 data-id="heading-4">🆚 Preload vs. Invoke 快速对比</h3>









































<table><thead><tr><th>特性维度</th><th>Preload (预加载脚本)</th><th>Invoke (<code>ipcRenderer.invoke</code> / <code>ipcMain.handle</code>)</th><th>协同工作关系</th></tr></thead><tbody><tr><td><strong>是什么</strong></td><td><strong>一个特殊的脚本文件</strong>（通常叫 <code>preload.js</code>），在网页加载前执行csdn.net。它拥有访问Node.js和Electron API的权限csdn.net 。</td><td><strong>一套通信方法</strong>。<code>ipcRenderer.invoke</code> 用于渲染进程发起<strong>请求并等待响应</strong>，<code>ipcMain.handle</code> 用于主进程<strong>处理该请求并返回结果</strong>csdn.net+1 。</td><td><strong>Preload脚本是“桥梁”和“安全通道”，Invoke是桥上走的“车”</strong> 。Preload通常使用Invoke来实现具体的通信功能。</td></tr><tr><td><strong>核心目的</strong></td><td><strong>安全隔离</strong>：在启用上下文隔离（<code>contextIsolation: true</code>）时，它作为<strong>唯一安全</strong>的方式，将精心挑选的API暴露给网页electronjs.org+1 。</td><td><strong>异步双向通信</strong>：让渲染进程能像调用本地函数一样，<strong>同步地请求主进程执行操作并获取结果</strong>，避免“回调地狱”csdn.net+1 。</td><td>Preload通过Invoke模式，将主进程的功能<strong>安全地封装</strong>后提供给渲染进程。</td></tr><tr><td><strong>工作位置</strong></td><td>运行在<strong>独立的、隔离的上下文</strong>中，与网页的<code>window</code>对象是分离的electronjs.org+1 。</td><td><strong>渲染进程</strong>调用<code>invoke</code>，<strong>主进程</strong>调用<code>handle</code>。它们通过IPC通道通信。</td><td>Preload脚本在隔离的上下文中接收渲染进程的请求，并通过<code>ipcRenderer.invoke</code>转发给主进程。</td></tr><tr><td><strong>是否替代品</strong></td><td><strong>否</strong>。Preload是实现安全通信的<strong>基础设施和最佳实践</strong>。</td><td><strong>否</strong>。Invoke是多种IPC通信模式之一（还有<code>send</code>/<code>on</code>等），但因其<strong>简洁性</strong>，在需要返回结果时被<strong>强烈推荐</strong>csdn.net+1 。</td><td><strong>最佳实践是：在Preload脚本中使用Invoke模式来暴露API</strong>。</td></tr><tr><td><strong>代码示例</strong></td><td><code>contextBridge.exposeInMainWorld('myAPI', { ... })</code>electronjs.org</td><td>渲染进程: <code>await window.myAPI.someFunction()</code> Preload: <code>ipcRenderer.invoke('some-channel')</code> 主进程: <code>ipcMain.handle('some-channel', handler)</code></td><td>见下方详细流程图。</td></tr></tbody></table>
<h3 data-id="heading-5">🔍 深入理解 Preload (预加载脚本)</h3>
<p>Preload脚本是Electron安全模型的核心。</p>
<ul>
<li>
<p><strong>它为什么重要？</strong><br/>
Electron默认启用<strong>上下文隔离（Context Isolation）</strong> electronjs.org+1。这意味着 ：</p>
<ul>
<li>网页的<code>window</code>对象和Preload脚本的<code>window</code>对象是<strong>完全不同</strong>的两个世界electronjs.org 。</li>
<li>网页无法直接访问Node.js或Electron的API（如<code>ipcRenderer</code>, <code>fs</code>等），这是巨大的安全提升，防止恶意代码（如通过XSS漏洞）直接操作系统csdn.net+1 。</li>
<li><strong>Preload脚本就是唯一有权限跨越这两个世界的“桥梁”</strong> 。它运行在一个<strong>特权上下文</strong>中，可以访问Node.js API，同时也能访问网页的DOM（<code>document</code>, <code>window</code>）csdn.net 。</li>
</ul>
</li>
<li>
<p><strong>它的核心任务是什么？</strong><br/>
通过 <code>contextBridge.exposeInMainWorld</code> 方法，<strong>安全地、有选择地</strong>将某些特权API暴露给网页electronjs.org+1。这就像是给一个完全隔离的房间开一扇受控的小门，只传递必要的物品 。</p>
</li>
<li>
<p><strong>一个安全的Preload示例</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// preload.js</span>
    <span class="hljs-keyword">const</span> { contextBridge, ipcRenderer } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>)

    <span class="hljs-comment">// ✅ 安全的做法：只暴露特定、封装好的函数</span>
    contextBridge.<span class="hljs-title function_">exposeInMainWorld</span>(<span class="hljs-string">'myApp'</span>, {
        <span class="hljs-comment">// 暴露一个函数，内部使用 invoke 模式通信</span>
        <span class="hljs-attr">openFile</span>: <span class="hljs-function">() =&gt;</span> ipcRenderer.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'dialog:openFile'</span>),
        <span class="hljs-comment">// 可以暴露其他经过精心设计的API</span>
        <span class="hljs-attr">getVersion</span>: <span class="hljs-function">() =&gt;</span> ipcRenderer.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'app:get-version'</span>)
    })
</code></pre>
<h3 data-id="heading-6">🚀 深入理解 Invoke (通信模式)</h3>
<p><code>invoke</code>/<code>handle</code> 是Electron提供的一种<strong>异步的、基于Promise的</strong>进程间通信模式。</p>
<ul>
<li>
<p><strong>它为什么好用？</strong></p>
<ul>
<li><strong>避免回调地狱</strong>：传统的 <code>ipcRenderer.send</code> + <code>ipcRenderer.on</code> 模式在处理双向通信时，需要手动管理回调，容易导致代码嵌套过深csdn.net。<code>invoke</code> 让代码像写同步函数一样清晰。</li>
<li><strong>内置错误处理</strong>：可以直接用 <code>try/catch</code> 捕获主进程返回的错误。</li>
<li><strong>语义清晰</strong>：<code>invoke</code> 本身就暗示了这是一个“调用并等待返回”的操作。</li>
</ul>
</li>
<li>
<p><strong>它的工作流程</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 渲染进程 (renderer.js)</span>
    <span class="hljs-keyword">const</span> filePath = <span class="hljs-keyword">await</span> <span class="hljs-built_in">window</span>.myApp.openFile() <span class="hljs-comment">// 调用Preload暴露的函数</span>

    <span class="hljs-comment">// Preload脚本 (preload.js)</span>
    openFile: () =&gt; ipcRenderer.invoke(<span class="hljs-string">'dialog:openFile'</span>) <span class="hljs-comment">// 转发IPC调用</span>

    <span class="hljs-comment">// 主进程 (main.js)</span>
    ipcMain.handle(<span class="hljs-string">'dialog:openFile'</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> { canceled, filePaths } = <span class="hljs-keyword">await</span> dialog.showOpenDialog()
        <span class="hljs-keyword">if</span> (canceled) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>
        <span class="hljs-keyword">return</span> filePaths[<span class="hljs-number">0</span>] <span class="hljs-comment">// 返回结果会自动被Promise包装</span>
    })
</code></pre>
<h2 data-id="heading-7">📊 通信模式对比</h2>
<p>下表对比了不同通信模式的优缺点，帮助你选择最合适的方案：</p>









































<table><thead><tr><th>特性维度</th><th><code>send</code>/<code>on</code> (单向)</th><th><code>invoke</code>/<code>handle</code> (双向)</th><th>不安全的直接访问</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>需手动管理回调，易陷入回调地狱</td><td>像本地函数调用一样简洁，支持 async/await</td><td>代码最简洁，但极不安全</td></tr><tr><td><strong>错误处理</strong></td><td>手动传递错误对象</td><td>内置错误处理，可用 try/catch 捕获</td><td>错误处理难以统一</td></tr><tr><td><strong>安全性</strong></td><td>相对安全，但仍需谨慎</td><td><strong>最安全</strong>，配合 Preload 使用</td><td><strong>极不安全</strong>，应避免使用</td></tr><tr><td><strong>返回值</strong></td><td>需要手动发送回复消息</td><td>自动返回 Promise 对象</td><td>直接访问，无通信过程</td></tr><tr><td><strong>推荐场景</strong></td><td>简单通知、无需返回值的操作</td><td>需要返回结果的复杂操作</td><td><strong>永不推荐</strong></td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>安全警告</strong>：<strong>永远不要</strong>在渲染进程中直接使用 <code>require('electron').ipcRenderer</code> 或启用 <code>nodeIntegration: true</code>。这会破坏上下文隔离，带来巨大的安全风险csdn.net+1 。</p>
</blockquote>
<h3 data-id="heading-8">进一步学习资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2Fdocs%2Flatest%2Ftutorial%2Fsecurity" target="_blank" title="https://www.electronjs.org/docs/latest/tutorial/security" ref="nofollow noopener noreferrer">Electron 官方安全指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2Fdocs%2Flatest%2Fapi%2Fcontext-bridge" target="_blank" title="https://www.electronjs.org/docs/latest/api/context-bridge" ref="nofollow noopener noreferrer">contextBridge API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2Fdocs%2Flatest%2Ftutorial%2Fipc" target="_blank" title="https://www.electronjs.org/docs/latest/tutorial/ipc" ref="nofollow noopener noreferrer">进程间通信 (IPC) 指南</a></li>
</ul>
<blockquote>
<p>🌟 <strong>最后建议</strong>：构建安全的 Electron 应用需要从一开始就考虑安全因素，而不是事后添加安全措施。遵循本文介绍的最佳实践，将帮助你构建更加安全可靠的桌面应用。</p>
</blockquote>
<p>希望这篇文章能够帮助你更好地理解 Electron 的安全通信机制。如果你有任何问题或需要进一步的帮助，请随时在评论区留言。<strong>别忘了点赞和收藏</strong>，以便日后查阅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 自定义 Hook 实战：从鼠标追踪到待办事项管理]]></title>    <link>https://juejin.cn/post/7590128405351743488</link>    <guid>https://juejin.cn/post/7590128405351743488</guid>    <pubDate>2026-01-03T06:46:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590128405351743488" data-draft-id="7590213554798362659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 自定义 Hook 实战：从鼠标追踪到待办事项管理"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-03T06:46:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 自定义 Hook 实战：从鼠标追踪到待办事项管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T06:46:32.000Z" title="Sat Jan 03 2026 06:46:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，React 的自定义 Hook 已成为提升代码复用性、逻辑抽象能力和可维护性的核心手段。本文将通过两个典型示例——<strong>鼠标位置追踪</strong>与<strong>本地存储的待办事项管理</strong>，深入剖析如何利用自定义 Hook 将复杂业务逻辑封装为可复用、可测试、高内聚的模块，并探讨其背后的 React 响应式编程思想。</p>
<hr/>
<h2 data-id="heading-0">一、Demo 1：使用 <code>useMouse</code> 封装鼠标位置追踪</h2>
<h3 data-id="heading-1">1.1 初始实现的问题</h3>
<p>最初，开发者可能直接在组件内部使用 <code>useState</code> 和 <code>useEffect</code> 来监听鼠标移动事件：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">MouseMove</span>() {
  const <span class="hljs-selector-attr">[x, setX]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  const <span class="hljs-selector-attr">[y, setY]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const update = (event) =&gt; {
      <span class="hljs-built_in">setX</span>(event.pageX);
      <span class="hljs-built_in">setY</span>(event.pageY);
    };
    window<span class="hljs-selector-class">.addEventListener</span>('mousemove', update);
    return () =&gt; {
      window<span class="hljs-selector-class">.removeEventListener</span>('mousemove', update);
    };
  }, <span class="hljs-selector-attr">[]</span>);

  return &lt;<span class="hljs-selector-tag">div</span>&gt;鼠标位置: {x} {y}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>这种写法虽然功能完整，但存在明显缺陷：</p>
<ul>
<li><strong>逻辑耦合</strong>：UI 渲染与事件监听混杂，组件职责不清；</li>
<li><strong>难以复用</strong>：若其他组件也需要获取鼠标坐标，需重复编写相同逻辑；</li>
<li><strong>潜在内存泄漏风险</strong>：若未正确清理事件监听器（如忘记返回清理函数），组件卸载后仍会执行回调，<strong>事件监听/定时器 不会因为函数组件卸载而自动销毁</strong>，当卸载组件后又开启组件，相当于是又进行了一次事件监听，多次重复导致内存泄漏。</li>
</ul>
<h3 data-id="heading-2">1.2 提炼为自定义 Hook：<code>useMouse</code></h3>
<p>为解决上述问题，我们将鼠标追踪逻辑提取至独立的 <code>useMouse</code> Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/hooks/useMouse.js</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useMouse</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>);
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>);
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
    };
  }, []);
   
  <span class="hljs-keyword">return</span> { x, y };
  <span class="hljs-comment">// 把要向外暴露的状态和方法返回</span>
};
</code></pre>
<h4 data-id="heading-3">关键设计点解析：</h4>
<ol>
<li><strong>状态封装</strong><br/>
使用 <code>useState</code> 管理 <code>x</code> 和 <code>y</code> 坐标，对外仅暴露只读值，避免外部直接修改状态。</li>
<li><strong>副作用隔离</strong><br/>
<code>useEffect</code> 负责添加/移除全局事件监听器。依赖数组为空（<code>[]</code>），确保仅在组件挂载时注册一次监听器，并在卸载时自动清理，彻底规避内存泄漏。</li>
<li><strong>单一职责原则</strong><br/>
<code>useMouse</code> 只关注“获取鼠标位置”这一核心能力，不涉及任何 UI 渲染或业务判断，高度内聚。</li>
<li><strong>可组合性</strong><br/>
返回对象 <code>{ x, y }</code>，便于在任意组件中解构使用，符合 React 的声明式风格。</li>
</ol>
<h3 data-id="heading-4">1.3 在组件中使用</h3>
<p>在 <code>App.jsx</code> 中，只需一行代码即可接入鼠标位置数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>鼠标位置: {x} {y}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>此时 <code>MouseMove</code> 组件完全退化为纯展示层，逻辑与视图分离，极大提升了可读性和可维护性。</p>
<hr/>
<h2 data-id="heading-5">二、Demo 2：构建完整的待办事项系统 —— <code>useTodos</code></h2>
<p>相比鼠标追踪，待办事项管理涉及<strong>状态管理、持久化存储</strong>等多个维度，是检验自定义 Hook 能力的绝佳场景。</p>
<h3 data-id="heading-6">2.1 整体架构拆解</h3>
<p>整个系统由以下部分组成：</p>
<ul>
<li>
<p><strong>Hook 层</strong>：<code>useTodos</code> —— 核心逻辑容器</p>
</li>
<li>
<p><strong>组件层</strong>：</p>
<ul>
<li><code>TodoInput</code>：输入新任务</li>
<li><code>TodoList</code>：渲染任务列表</li>
<li><code>TodoItem</code>：单个任务项（含完成状态切换与删除）</li>
</ul>
</li>
</ul>
<p>这种分层结构体现了典型的“<strong>逻辑下沉，UI 上浮</strong>”原则：复杂状态流转由 Hook 处理，组件仅负责调用方法与展示数据。</p>
<h3 data-id="heading-7">2.2 <code>useTodos</code> Hook 深度解析</h3>
<pre><code class="hljs language-ini" lang="ini">// src/hooks/useTodos.js
import { useState, useEffect } from 'react'<span class="hljs-comment">;</span>

const <span class="hljs-attr">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span><span class="hljs-comment">;</span>

function loadFromStorage() {
  const <span class="hljs-attr">stored</span> = localStorage.getItem(STORAGE_KEY)<span class="hljs-comment">;</span>
  return stored ? JSON.parse(stored) : <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
}

function saveToStorage(todos) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(todos))<span class="hljs-comment">;</span>
}

export const <span class="hljs-attr">useTodos</span> = () =&gt; {
  const <span class="hljs-section">[todos, setTodos]</span> = useState(loadFromStorage)<span class="hljs-comment">;</span>

  useEffect(() =&gt; {
    saveToStorage(todos)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[todos]</span>)<span class="hljs-comment">;</span>
  // todos改变 进行本地存储

  const <span class="hljs-attr">addTodo</span> = (text) =&gt; {
    setTodos(<span class="hljs-section">[
      ...todos,
      { id: Date.now(), text, completed: false }
    ]</span>)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">toggleTodo</span> = (id) =&gt; {
    setTodos(
      todos.map(<span class="hljs-attr">todo</span> =&gt;
        <span class="hljs-attr">todo.id</span> === id ? { ...todo, completed: !todo.completed } : todo
      )
    )<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">deleteTodo</span> = (id) =&gt; {
    setTodos(todos.filter(<span class="hljs-attr">todo</span> =&gt; todo.id !== id))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return { todos, addTodo, toggleTodo, deleteTodo }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-8">核心机制详解：</h4>
<h5 data-id="heading-9">（1）初始化与持久化同步</h5>
<ul>
<li><strong>延迟初始化</strong>：<code>useState(loadFromStorage)</code> 利用函数式初始化，避免每次渲染都读取 localStorage，提升性能。</li>
<li><strong>自动持久化</strong>：<code>useEffect</code> 监听 <code>todos</code> 变化，一旦状态更新立即写入 localStorage，实现“状态即存储”的无缝体验。</li>
</ul>
<blockquote>
<p>注意：此处使用 <code>Date.now()</code> 作为 ID 虽简便，但在高频操作下可能冲突。</p>
</blockquote>
<h5 data-id="heading-10">（2）不可变更新原则</h5>
<p>所有状态变更均通过<strong>创建新数组</strong>实现：</p>
<ul>
<li><code>addTodo</code>：使用展开运算符 <code>[...todos, newTodo]</code></li>
<li><code>toggleTodo</code>：<code>map</code> 返回新数组，仅修改目标项</li>
<li><code>deleteTodo</code>：<code>filter</code> 排除指定 ID 项</li>
</ul>
<p>这保证了 React 能正确触发重渲染，同时避免意外修改原始状态。</p>
<h5 data-id="heading-11">（3）API 设计清晰</h5>
<p>返回对象包含：</p>
<ul>
<li><strong>状态</strong>：<code>todos</code>（当前任务列表）</li>
<li><strong>行为</strong>：<code>addTodo</code>, <code>toggleTodo</code>, <code>deleteTodo</code>（纯函数，无副作用）</li>
</ul>
<p>调用者无需关心内部实现，只需按约定传参即可操作状态。</p>
<h3 data-id="heading-12">2.3 组件层协作流程</h3>
<h4 data-id="heading-13"><code>TodoInput</code>：任务创建入口</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/components/TodoInput.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoInput</span>(<span class="hljs-params">{ onAddTodo }</span>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">if</span> (!text.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>;
    <span class="hljs-title function_">onAddTodo</span>(text.<span class="hljs-title function_">trim</span>());
    <span class="hljs-title function_">setText</span>(<span class="hljs-string">''</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>通过 <code>onAddTodo</code> 回调将新任务文本传递给父组件（即 <code>useTodos.addTodo</code>）</li>
<li>表单提交后清空输入框，提供良好 UX</li>
</ul>
<h4 data-id="heading-14"><code>TodoList</code> 与 <code>TodoItem</code>：状态展示与交互</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TodoList.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">{ todos, onDelete, onToggle }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {todos.map(todo =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> 
          <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>
          <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span>
          <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{onDelete}</span>
          <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{onToggle}</span>
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// TodoItem.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoItem</span>(<span class="hljs-params">{ todo, onDelete, onToggle }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
        <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggle(todo.id)}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? '<span class="hljs-attr">completed</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
        {todo.text}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDelete(todo.id)}&gt;Delete<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><strong>单向数据流</strong>：<code>todos</code> 由 <code>App</code> 传入，<code>TodoItem</code> 仅消费数据</li>
<li><strong>事件委托</strong>：点击复选框或删除按钮时，调用 <code>onToggle</code> / <code>onDelete</code>，最终触发 <code>useTodos</code> 内部状态更新</li>
<li><strong>Key 唯一性</strong>：使用 <code>todo.id</code> 作为 <code>key</code>，确保 React Diff 算法高效更新列表</li>
</ul>
<h3 data-id="heading-15">2.4 App 组件：胶水层整合</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { todos, addTodo, deleteTodo, toggleTodo } = <span class="hljs-title function_">useTodos</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAddTodo</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      {todos.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> 
          <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span> 
          <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span> 
          <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span> 
        /&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><code>App</code> 组件几乎不包含业务逻辑，仅负责：</p>
<ol>
<li>调用 <code>useTodos</code> 获取状态与方法</li>
<li>将方法作为 props 传递给子组件</li>
<li>根据 <code>todos.length</code> 控制空状态显示</li>
</ol>
<p>这种“瘦容器”模式使应用结构清晰，易于扩展（例如未来加入筛选、编辑等功能）。</p>
<hr/>
<h2 data-id="heading-16">三、自定义 Hook 的价值与最佳实践</h2>
<h3 data-id="heading-17">3.1 为什么需要自定义 Hook？</h3>
<ul>
<li><strong>逻辑复用</strong>：跨组件共享状态逻辑</li>
<li><strong>关注点分离</strong>：将副作用、数据获取、状态管理从 UI 组件中剥离</li>
<li><strong>测试友好</strong>：Hook 可独立于组件进行单元测试</li>
<li><strong>团队协作</strong>：形成可沉淀的“前端资产库”，新人可快速接入</li>
</ul>
<h3 data-id="heading-18">3.2 编写高质量 Hook 的准则</h3>
<ol>
<li><strong>命名规范</strong>：以 <code>use</code> 开头（如 <code>useTodos</code>），这是 React 的约定，也是 ESLint 规则的要求。</li>
<li><strong>返回结构清晰</strong>：通常返回对象，便于按需解构；避免返回数组导致顺序依赖。</li>
<li><strong>避免副作用外泄</strong>：Hook 内部处理所有订阅/清理，调用者无需关心生命周期。</li>
<li><strong>考虑性能优化</strong>：对返回的函数使用 <code>useCallback</code> 包裹（本例因简单省略，复杂场景需注意）。</li>
</ol>
<hr/>
<h2 data-id="heading-19">结语</h2>
<p>通过 <code>useMouse</code> 与 <code>useTodos</code> 两个案例，我们见证了自定义 Hook 如何将“面条式代码”转化为模块化、可维护的现代 React 应用。它不仅是语法糖，更是一种<strong>架构思维</strong>——鼓励开发者将复杂问题分解为独立、可组合的逻辑单元。</p>
<p>在实际项目中，你可以继续延伸这一模式：封装网络请求（<code>useFetch</code>）、表单验证（<code>useForm</code>）、主题切换（<code>useTheme</code>）等通用能力。当你的 Hook 库逐渐丰富，你会发现：<strong>优秀的前端工程，始于对逻辑的敬畏，成于对复用的追求</strong>。</p>
<blockquote>
<p>本文所有代码均可直接运行，建议读者动手实践，尝试为 <code>useTodos</code> 添加“编辑任务”或“按状态筛选”功能，进一步巩固自定义 Hook 的设计能力。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MiniMax × Cursor：Taro小程序开发终极指南]]></title>    <link>https://juejin.cn/post/7590421489997611027</link>    <guid>https://juejin.cn/post/7590421489997611027</guid>    <pubDate>2026-01-03T06:46:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489997611027" data-draft-id="7589919989039775807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MiniMax × Cursor：Taro小程序开发终极指南"/> <meta itemprop="keywords" content="小程序·云开发,Cursor,LLM"/> <meta itemprop="datePublished" content="2026-01-03T06:46:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="土豆1250"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428302727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MiniMax × Cursor：Taro小程序开发终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428302727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    土豆1250
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T06:46:49.000Z" title="Sat Jan 03 2026 06:46:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从"这是什么玩意"到"哇这也太丝滑了吧" —— 一个 AI 辅助开发的成长日记</p>
</blockquote>
<h2 data-id="heading-0">🎯 开篇：为什么你需要这套组合拳</h2>
<h3 data-id="heading-1">Why：三个让你心动的理由</h3>
<p><strong>痛点一：Bug 调试像在迷宫里找钥匙</strong> 🔑<br/>
传统开发中,遇到问题只能疯狂翻文档、搜 Stack Overflow、问 GPT 然后复制粘贴。问题是——你怎么知道搜到的答案是不是最新的?适不适合你的项目?</p>
<p><strong>痛点二:设计稿还原度全靠"盲猜"</strong> 🎨<br/>
UI 给了设计图,你左看右看上看下看,这个间距是 16px 还是 18px?这个颜色是#333 还是#444?来回切屏,眼睛都快瞎了。</p>
<p><strong>痛点三:云函数调试像开盲盒</strong> 📦<br/>
云函数报错了?先登录控制台,找到函数,点开日志,翻半天...等等,这个 error 是哪次调用的来着?</p>
<h3 data-id="heading-2">What：这套组合拳能给你什么</h3>
<ul>
<li><strong>MiniMax Coding Plan MCP</strong>: 内置<code>web_search</code>和<code>understand_image</code>工具</li>
<li><strong>CloudBase MCP</strong>: 直接在 IDE 里查询云函数日志、管理数据库</li>
<li><strong>Cursor + MCP</strong>: AI 助手拥有"千里眼"和"顺风耳"</li>
<li><strong>Taro + Tailwind CSS</strong>: 所见即所得的 UI 开发</li>
</ul>
<p>简单来说:<strong>让 AI 真正懂你的项目,而不是瞎猫碰死耗子。</strong></p>
<h2 data-id="heading-3">🚀 基础配置：先把装备配齐</h2>
<h3 data-id="heading-4">第一步:安装 Cursor</h3>
<p>如果你还在用 VS Code,是时候升级了。<a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com" title="https://cursor.com" target="_blank" ref="nofollow noopener noreferrer">Cursor</a> 是专为 AI 编程优化的 IDE,原生支持 MCP 协议。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
<span class="hljs-comment"># 直接去官网下载即可: https://cursor.com</span>

<span class="hljs-comment"># 下载后首次启动,会提示你导入VS Code设置</span>
<span class="hljs-comment"># 强烈建议导入,无缝迁移</span>
</code></pre>
<h3 data-id="heading-5">第二步:配置 MiniMax Coding Plan MCP</h3>
<p><strong>什么是 Coding Plan?</strong><br/>
这是 MiniMax 专门为开发者提供的订阅服务,包含 web 搜索和图片理解能力。简单说就是给 AI 装上了"网络搜索"和"看图说话"两个技能。</p>
<h4 data-id="heading-6">获取 API Key</h4>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.minimax.io" title="https://platform.minimax.io" target="_blank" ref="nofollow noopener noreferrer">MiniMax 开发者平台</a></li>
<li>注册/登录账号</li>
<li>在"Coding Plan"页面订阅套餐</li>
<li>获取你的 API Key</li>
</ol>
<h4 data-id="heading-7">配置到 Cursor</h4>
<p>打开 Cursor 的 MCP 配置文件:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
~/.cursor/mcp.json

<span class="hljs-comment"># Windows</span>
%USERPROFILE%\.cursor\mcp.json
</code></pre>
<p>添加 MiniMax 配置:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"MiniMax"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uvx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"minimax-coding-plan-mcp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-y"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"MINIMAX_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的API_KEY"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"MINIMAX_API_HOST"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.minimax.io"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>注意事项</strong> ⚠️</p>
<ul>
<li>国内用户使用 <code>https://api.minimax.io</code></li>
<li>国际用户使用 <code>https://api.minimaxi.chat</code></li>
<li>API Key 必须和 Host 区域匹配,否则会报错</li>
</ul>
<p>重启 Cursor,打开 Composer (Cmd/Ctrl+I),输入<code>/mcp</code>,如果看到<code>web_search</code>和<code>understand_image</code>就说明配置成功了!</p>
<h3 data-id="heading-8">第三步:配置 CloudBase MCP</h3>
<p>CloudBase 是腾讯云开发的 MCP 工具,专门用于管理云开发资源。</p>
<h4 data-id="heading-9">安装 CloudBase CLI</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g @cloudbase/cli@latest
</code></pre>
<h4 data-id="heading-10">登录 CloudBase</h4>
<pre><code class="hljs language-bash" lang="bash">tcb login
<span class="hljs-comment"># 会打开浏览器进行授权登录</span>
</code></pre>
<h4 data-id="heading-11">配置到 Cursor</h4>
<p>在<code>~/.cursor/mcp.json</code>中添加:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"MiniMax"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-comment">// ...前面的配置</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cloudbase"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"@cloudbase/cloudbase-mcp@latest"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-12">第四步:创建 Taro 项目并集成 Tailwind CSS</h3>
<h4 data-id="heading-13">初始化 Taro 项目</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Taro CLI</span>
npm install -g @tarojs/cli

<span class="hljs-comment"># 创建项目</span>
taro init myapp

<span class="hljs-comment"># 选择模板时推荐:</span>
<span class="hljs-comment"># - React (更成熟的生态)</span>
<span class="hljs-comment"># - TypeScript (类型安全)</span>
<span class="hljs-comment"># - 微信小程序</span>
</code></pre>
<h4 data-id="heading-14">集成 Tailwind CSS</h4>
<p>Tailwind CSS 是目前最受欢迎的原子化 CSS 框架,而且特别适合 AI 编程——AI 能直接"说人话"生成样式。</p>
<p><strong>安装依赖:</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> myapp
npm install -D tailwindcss postcss autoprefixer
npm install -D weapp-tailwindcss
</code></pre>
<p><strong>初始化配置:</strong></p>
<pre><code class="hljs language-bash" lang="bash">npx tailwindcss init
</code></pre>
<p><strong>配置<code>tailwind.config.js</code>:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">content</span>: [
    <span class="hljs-string">"./src/**/*.{js,jsx,ts,tsx}"</span>,
  ],
  <span class="hljs-comment">// 小程序不支持某些特殊字符,需要自定义分隔符</span>
  <span class="hljs-attr">separator</span>: <span class="hljs-string">'_'</span>,
  <span class="hljs-attr">corePlugins</span>: {
    <span class="hljs-comment">// 关闭preflight,避免样式冲突</span>
    <span class="hljs-attr">preflight</span>: <span class="hljs-literal">false</span>
  }
}
</code></pre>
<p><strong>配置 Taro:</strong></p>
<p>在<code>config/index.js</code>中添加:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-comment">// ...其他配置</span>
  <span class="hljs-attr">plugins</span>: [
    [<span class="hljs-string">'@tarojs/plugin-html'</span>],
    [<span class="hljs-string">'weapp-tailwindcss/webpack'</span>, {
      <span class="hljs-comment">// 配置选项</span>
    }]
  ],
  <span class="hljs-attr">mini</span>: {
    <span class="hljs-attr">postcss</span>: {
      <span class="hljs-attr">pxtransform</span>: {
        <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">config</span>: {}
      }
    }
  }
}
</code></pre>
<p><strong>在<code>app.css</code>中引入 Tailwind:</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@tailwind</span> base;
<span class="hljs-keyword">@tailwind</span> components;
<span class="hljs-keyword">@tailwind</span> utilities;
</code></pre>
<p><strong>验证安装:</strong></p>
<p>在任意页面组件中测试:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/components'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Index</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center h-screen bg-blue-500"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-white text-2xl"</span>&gt;</span>Hello Tailwind!<span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  )
}
</code></pre>
<p>运行<code>npm run dev:weapp</code>,如果看到蓝色背景和白色文字,说明配置成功!</p>
<h2 data-id="heading-15">💡 实战技巧：让 AI 成为你的超级助手</h2>
<h3 data-id="heading-16">技巧 1：用 web_search 解决疑难杂症</h3>
<p><strong>场景:</strong> Taro 项目中遇到一个奇怪的 API 报错。</p>
<p><strong>传统做法:</strong></p>
<ol>
<li>复制错误信息</li>
<li>打开浏览器搜索</li>
<li>翻阅 5-10 个页面</li>
<li>尝试每个解决方案</li>
<li>祈祷有一个能 work</li>
</ol>
<p><strong>使用 MiniMax MCP:</strong></p>
<p>直接在 Cursor 的 Composer 中告诉 AI:</p>
<pre><code class="hljs language-vbnet" lang="vbnet">这个错误信息是什么意思?帮我用web_search搜索一下Taro社区有没有类似问题的解决方案:

[<span class="hljs-keyword">ERROR</span>] <span class="hljs-keyword">Error</span>: miniprogram-api-typings: <span class="hljs-keyword">Module</span> <span class="hljs-built_in">not</span> found
</code></pre>
<p>AI 会自动调用<code>web_search</code>工具,搜索最新的解决方案,并给你总结:</p>
<pre><code class="hljs language-markdown" lang="markdown">根据搜索结果,这个问题是因为...

解决方案:

<span class="hljs-bullet">1.</span> 升级 Taro 版本到 3.6+
<span class="hljs-bullet">2.</span> 或者安装缺失的类型定义: npm install -D miniprogram-api-typings

相关讨论:

<span class="hljs-bullet">-</span> https://github.com/NervJS/taro/issues/...
<span class="hljs-bullet">-</span> https://taro-docs.jd.com/...
</code></pre>
<p><strong>为什么这么厉害?</strong></p>
<ul>
<li>搜索的是<strong>实时信息</strong>,不是训练数据</li>
<li>AI 会帮你<strong>筛选和总结</strong>,不是直接扔一堆链接</li>
<li>还会给出<strong>相关搜索建议</strong></li>
</ul>
<h3 data-id="heading-17">技巧 2：用 understand_image 快速还原设计稿</h3>
<p><strong>场景:</strong> UI 给了一张设计稿,要求 100%还原。</p>
<p><strong>传统做法:</strong></p>
<ol>
<li>切换到设计工具</li>
<li>测量每个元素的位置、大小</li>
<li>记录颜色值</li>
<li>回到代码一点点写</li>
<li>来回对比调整</li>
</ol>
<p><strong>使用 MiniMax MCP:</strong></p>
<ol>
<li>把设计稿截图保存</li>
<li>在 Cursor 中粘贴图片</li>
<li>告诉 AI:</li>
</ol>
<pre><code class="hljs language-diff" lang="diff">帮我分析这张设计稿,用Taro + Tailwind CSS实现。
重点关注:
<span class="hljs-deletion">- 布局结构</span>
<span class="hljs-deletion">- 间距和对齐</span>
<span class="hljs-deletion">- 颜色和字号</span>
<span class="hljs-deletion">- 组件层次</span>
</code></pre>
<p>AI 会分析图片,然后生成:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/components'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductCard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white rounded-2xl p-4 shadow-lg"</span>&gt;</span>
      {/* 商品图片 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"relative mb-4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">"xxx"</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-48 rounded-xl object-cover"</span>
        /&gt;</span>
        {/* 右上角标签 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute top-2 right-2 bg-red-500 text-white px-3 py-1 rounded-full text-xs"</span>&gt;</span>
          热卖
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>

      {/* 商品信息 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"space-y-2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-bold text-gray-800"</span>&gt;</span>
          商品名称
        <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-2xl font-bold text-red-500"</span>&gt;</span>
            ¥199
          <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm text-gray-400 line-through"</span>&gt;</span>
            ¥299
          <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Pro Tips:</strong></p>
<ul>
<li>可以同时上传多张图片对比分析</li>
<li>让 AI 解释为什么使用某个 Tailwind 类</li>
<li>要求 AI 生成不同屏幕尺寸的响应式版本</li>
</ul>
<h3 data-id="heading-18">技巧 3：用 CloudBase MCP 调试云函数</h3>
<p><strong>场景:</strong> 云函数返回了错误,需要查看日志排查问题。</p>
<p><strong>传统做法:</strong></p>
<ol>
<li>打开腾讯云控制台</li>
<li>找到云开发环境</li>
<li>进入云函数管理</li>
<li>找到对应函数</li>
<li>查看日志</li>
<li>分析问题</li>
<li>修改代码</li>
<li>重新部署</li>
<li>再次测试</li>
</ol>
<p><strong>使用 CloudBase MCP:</strong></p>
<p>直接在 Cursor 中告诉 AI:</p>
<pre><code class="hljs">我的getUserInfo云函数返回500错误,帮我查看最近的日志,找出问题原因并修复
</code></pre>
<p>AI 会:</p>
<ol>
<li>自动调用 CloudBase MCP 查询日志</li>
<li>分析错误堆栈</li>
<li>定位问题代码</li>
<li>给出修复方案</li>
<li>甚至直接帮你修改代码</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// AI发现的问题:</span>
<span class="hljs-comment">// 原代码:</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>).<span class="hljs-title function_">doc</span>(userId).<span class="hljs-title function_">get</span>()
<span class="hljs-keyword">return</span> user.<span class="hljs-property">data</span>.<span class="hljs-property">name</span> <span class="hljs-comment">// ❌ 当用户不存在时,data是undefined</span>

<span class="hljs-comment">// AI的修复:</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>).<span class="hljs-title function_">doc</span>(userId).<span class="hljs-title function_">get</span>()
<span class="hljs-keyword">if</span> (!user.<span class="hljs-property">data</span>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">'用户不存在'</span> }
}
<span class="hljs-keyword">return</span> user.<span class="hljs-property">data</span>.<span class="hljs-property">name</span> <span class="hljs-comment">// ✅ 增加了错误处理</span>
</code></pre>
<p><strong>CloudBase MCP 的其他神器功能:</strong></p>
<ul>
<li>查询数据库记录</li>
<li>部署新的云函数</li>
<li>管理静态网站托管</li>
<li>配置安全规则</li>
</ul>
<h3 data-id="heading-19">技巧 4：在.cursorrules 中定义项目规范</h3>
<p><strong>为什么需要.cursorrules?</strong></p>
<p>想象一下,你有一个 10 人的开发团队,每个人的代码风格都不一样:</p>
<ul>
<li>张三喜欢用 class 组件</li>
<li>李四全用 function 组件</li>
<li>王五样式写在 CSS 文件里</li>
<li>赵六全部 inline style</li>
</ul>
<p>项目代码看起来像"垃圾场"。</p>
<p><strong>解决方案:</strong></p>
<p>在项目根目录创建<code>.cursorrules</code>或<code>.cursorrules.md</code>文件:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Taro 小程序开发规范</span>

<span class="hljs-section">## 技术栈</span>

<span class="hljs-bullet">-</span> Taro 3.x
<span class="hljs-bullet">-</span> React 18+ (function 组件 + Hooks)
<span class="hljs-bullet">-</span> TypeScript
<span class="hljs-bullet">-</span> Tailwind CSS

<span class="hljs-section">## 代码风格</span>

<span class="hljs-section">### 组件规范</span>

<span class="hljs-bullet">-</span> 所有组件必须使用 Function Component
<span class="hljs-bullet">-</span> 必须使用 TypeScript,定义完整的 Props 类型
<span class="hljs-bullet">-</span> 组件文件名使用 PascalCase: <span class="hljs-code">`UserProfile.tsx`</span>

<span class="hljs-section">### 样式规范</span>

<span class="hljs-bullet">-</span> 优先使用 Tailwind CSS utility 类
<span class="hljs-bullet">-</span> 禁止使用 inline style
<span class="hljs-bullet">-</span> 自定义样式使用 CSS Modules
<span class="hljs-bullet">-</span> 响应式设计使用 Tailwind 的断点系统

示例:

<span class="hljs-code">```jsx
import { View, Text } from '@tarojs/components'
import { FC } from 'react'

interface UserCardProps {
  name: string
  avatar: string
}

const UserCard: FC&lt;UserCardProps&gt; = ({ name, avatar }) =&gt; {
  return (
    &lt;View className="flex items-center p-4 bg-white rounded-lg shadow"&gt;
      &lt;Image src={avatar} className="w-12 h-12 rounded-full" /&gt;
      &lt;Text className="ml-3 text-base font-medium"&gt;{name}&lt;/Text&gt;
    &lt;/View&gt;
  )
}

export default UserCard
```</span>
</code></pre>
<h3 data-id="heading-20">云函数规范</h3>
<ul>
<li>统一使用 async/await</li>
<li>必须有完整的错误处理</li>
<li>返回值格式统一: <code>{ code, message, data }</code></li>
</ul>
<p>示例:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">main</span> = <span class="hljs-keyword">async</span> (event) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { userId } = event

    <span class="hljs-keyword">if</span> (!userId) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">code</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'缺少userId参数'</span> }
    }

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'users'</span>)
      .<span class="hljs-title function_">doc</span>(userId)
      .<span class="hljs-title function_">get</span>()

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,
      <span class="hljs-attr">data</span>: result.<span class="hljs-property">data</span>
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'getUserInfo error:'</span>, error)
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'服务器错误'</span>,
      <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-21">常见问题解决方案</h2>
<h3 data-id="heading-22">Taro API 调用问题</h3>
<ul>
<li>优先查阅 Taro 官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.taro.zone" target="_blank" title="https://docs.taro.zone" ref="nofollow noopener noreferrer">docs.taro.zone</a></li>
<li>使用 web_search 搜索 GitHub Issues</li>
</ul>
<h3 data-id="heading-23">云函数调试</h3>
<ul>
<li>使用 CloudBase MCP 直接查看日志</li>
<li>不要在代码里加 console.log 后重新部署</li>
</ul>
<h3 data-id="heading-24">样式问题</h3>
<ul>
<li>使用 understand_image 分析设计稿</li>
<li>记住小程序不支持某些 CSS 特性</li>
</ul>
<p><strong>配置好后的效果:</strong></p>
<p>当你让AI写代码时,它会严格遵守这些规范:</p>
<pre><code class="hljs language-text" lang="text">
你: 帮我写一个用户列表页面

AI: 好的,我会按照项目规范,使用 Function Component + TypeScript + Tailwind CSS 来实现...

[生成的代码自动符合规范]

</code></pre>
<h3 data-id="heading-25">技巧5：善用Tailwind的"AI友好"特性</h3>
<p><strong>为什么说Tailwind CSS是AI友好的?</strong></p>
<p>因为Tailwind的类名就是**"人类语言"**:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 传统CSS: AI需要理解复杂的样式规则</span>
&lt;<span class="hljs-title class_">View</span> style={{
  <span class="hljs-attr">display</span>: <span class="hljs-string">'flex'</span>,
  <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
  <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'space-between'</span>,
  <span class="hljs-attr">padding</span>: <span class="hljs-string">'16px'</span>,
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#ffffff'</span>,
  <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">'8px'</span>,
  <span class="hljs-attr">boxShadow</span>: <span class="hljs-string">'0 2px 8px rgba(0,0,0,0.1)'</span>
}}&gt;

<span class="hljs-comment">// Tailwind CSS: AI直接"说人话"</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between p-4 bg-white rounded-lg shadow-md"</span>&gt;</span>
</span></code></pre>
<p><strong>实战案例:</strong></p>
<p>你可以这样和 AI 交流:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: 做一个卡片组件,要有圆角、阴影、内边距16px,flex布局,上面是图片,下面是文字</span>

<span class="hljs-section">AI: 明白了!</span>
[直接生成Tailwind代码]
</code></pre>
<p><strong>常用的 Tailwind 组合:</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 1. 水平居中的容器</span>
&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"flex items-center justify-center"</span>&gt;

<span class="hljs-comment">// 2. 垂直布局,间距16px</span>
&lt;View className="flex flex-col space-y-4"&gt;

// 3. 卡片样式
&lt;View className="bg-white rounded-xl shadow-lg p-4"&gt;

// 4. 响应式文字
&lt;Text className="text-base md:text-lg lg:text-xl"&gt;

// 5. 按钮样式
&lt;View className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-full"&gt;
</code></pre>
<p><strong>⚠️ 小程序特殊限制:</strong></p>
<p>小程序不支持某些特殊字符作为类名,所以:</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 错误写法</span>
&lt;<span class="hljs-title class_">View</span> className=<span class="hljs-string">"w-1/2"</span>&gt;  <span class="hljs-comment">// 小程序不支持 /</span>
&lt;View className="hover:bg-blue"&gt;  // 小程序不支持 :

// ✅ 正确写法 (配置separator: '_')
&lt;View className="w-1_2"&gt;
&lt;View className="hover_bg-blue"&gt;
</code></pre>
<h2 data-id="heading-26">🎨 最佳实践：从入门到精通</h2>
<h3 data-id="heading-27">实践 1：构建一个完整的功能模块</h3>
<p><strong>需求:</strong> 开发一个"待办事项"功能,包含:</p>
<ul>
<li>列表展示</li>
<li>添加待办</li>
<li>标记完成</li>
<li>删除待办</li>
<li>云端同步</li>
</ul>
<p><strong>开发流程:</strong></p>
<h4 data-id="heading-28">Step 1: 需求分析(让 AI 帮你规划)</h4>
<pre><code class="hljs language-diff" lang="diff">你: 我要做一个待办事项功能,帮我规划一下技术方案

AI: 好的!我建议:

前端:
<span class="hljs-deletion">- 页面组件: TodoList.tsx, TodoItem.tsx, AddTodo.tsx</span>
<span class="hljs-deletion">- 状态管理: 使用React Hooks (useState, useEffect)</span>
<span class="hljs-deletion">- 样式: Tailwind CSS</span>

后端:
<span class="hljs-deletion">- 云数据库集合: todos</span>
  - _id: 自动生成
  - content: string (待办内容)
  - completed: boolean
  - createdAt: timestamp
<span class="hljs-deletion">- 云函数: getTodos, addTodo, updateTodo, deleteTodo</span>

需要我帮你实现吗?
</code></pre>
<h4 data-id="heading-29">Step 2: UI 设计(用 understand_image)</h4>
<p>如果你有设计稿:</p>
<pre><code class="hljs language-diff" lang="diff">你: [粘贴设计稿截图] 帮我分析这个待办列表的设计,用Taro + Tailwind实现

AI: 我看到的设计包括:
<span class="hljs-deletion">- 顶部有一个输入框和添加按钮</span>
<span class="hljs-deletion">- 列表项左边是圆形checkbox</span>
<span class="hljs-deletion">- 中间是待办文字,完成的文字有删除线</span>
<span class="hljs-deletion">- 右边是删除按钮</span>
<span class="hljs-deletion">- 整体使用卡片布局,圆角+阴影</span>

[生成代码...]
</code></pre>
<p>如果没有设计稿:</p>
<pre><code class="hljs language-diff" lang="diff">你: 帮我设计一个现代风格的待办列表UI,使用Tailwind CSS

AI: 好的,我会采用:
<span class="hljs-deletion">- 渐变背景</span>
<span class="hljs-deletion">- 毛玻璃效果的卡片</span>
<span class="hljs-deletion">- 动画过渡效果</span>
<span class="hljs-deletion">- 微交互反馈</span>

[生成代码...]
</code></pre>
<h4 data-id="heading-30">Step 3: 实现前端</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// components/TodoList.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Input</span>, <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/components'</span>
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>

interface <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">_id</span>: string
  <span class="hljs-attr">content</span>: string
  <span class="hljs-attr">completed</span>: boolean
  <span class="hljs-attr">createdAt</span>: number
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [todos, setTodos] = useState&lt;<span class="hljs-title class_">Todo</span>[]&gt;([])
  <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// 加载待办列表</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">loadTodos</span>()
  }, [])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadTodos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>)
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 调用云函数</span>
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Taro</span>.<span class="hljs-property">cloud</span>.<span class="hljs-title function_">callFunction</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'getTodos'</span>
      })
      <span class="hljs-title function_">setTodos</span>(res.<span class="hljs-property">result</span>.<span class="hljs-property">data</span>)
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'加载失败'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
      })
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>)
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!input.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Taro</span>.<span class="hljs-property">cloud</span>.<span class="hljs-title function_">callFunction</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'addTodo'</span>,
        <span class="hljs-attr">data</span>: { <span class="hljs-attr">content</span>: input }
      })
      <span class="hljs-title function_">setInput</span>(<span class="hljs-string">''</span>)
      <span class="hljs-title function_">loadTodos</span>()
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'添加成功'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>
      })
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'添加失败'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
      })
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id: string, completed: boolean</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Taro</span>.<span class="hljs-property">cloud</span>.<span class="hljs-title function_">callFunction</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'updateTodo'</span>,
        <span class="hljs-attr">data</span>: { id, <span class="hljs-attr">completed</span>: !completed }
      })
      <span class="hljs-title function_">loadTodos</span>()
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'更新失败'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
      })
    }
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id: string</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showModal</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'确认删除'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'确定要删除这条待办吗?'</span>
      })

      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Taro</span>.<span class="hljs-property">cloud</span>.<span class="hljs-title function_">callFunction</span>({
        <span class="hljs-attr">name</span>: <span class="hljs-string">'deleteTodo'</span>,
        <span class="hljs-attr">data</span>: { id }
      })
      <span class="hljs-title function_">loadTodos</span>()
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'删除成功'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>
      })
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 用户取消或删除失败</span>
    }
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 p-4"</span>&gt;</span>
      {/* 标题 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center mb-6"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"</span>&gt;</span>
          我的待办
        <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>

      {/* 添加待办 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white rounded-2xl shadow-lg p-4 mb-4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center space-x-2"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Input</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 px-4 py-2 bg-gray-100 rounded-full"</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"添加新待办..."</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{input}</span>
            <span class="hljs-attr">onInput</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInput(e.detail.value)}
          /&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-500 text-white px-6 py-2 rounded-full"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{addTodo}</span>
          &gt;</span>
            添加
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>

      {/* 待办列表 */}
      {loading ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center py-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      ) : todos.length === 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center py-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500"</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"space-y-2"</span>&gt;</span>
          {todos.map(todo =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{todo._id}</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white rounded-xl shadow p-4 flex items-center"</span>
            &gt;</span>
              {/* Checkbox */}
              <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">w-6</span> <span class="hljs-attr">h-6</span> <span class="hljs-attr">rounded-full</span> <span class="hljs-attr">border-2</span> <span class="hljs-attr">mr-3</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">justify-center</span> ${
                  <span class="hljs-attr">todo.completed</span>
                    ? '<span class="hljs-attr">bg-blue-500</span> <span class="hljs-attr">border-blue-500</span>'
                    <span class="hljs-attr">:</span> '<span class="hljs-attr">border-gray-300</span>'
                }`}
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> toggleTodo(todo._id, todo.completed)}
              &gt;
                {todo.completed &amp;&amp; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-white text-sm"</span>&gt;</span>✓<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                )}
              <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>

              {/* 内容 */}
              <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex-1</span> ${
                  <span class="hljs-attr">todo.completed</span>
                    ? '<span class="hljs-attr">line-through</span> <span class="hljs-attr">text-gray-400</span>'
                    <span class="hljs-attr">:</span> '<span class="hljs-attr">text-gray-800</span>'
                }`}
              &gt;</span>
                {todo.content}
              <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>

              {/* 删除按钮 */}
              <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-8 h-8 bg-red-100 rounded-full flex items-center justify-center"</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> deleteTodo(todo._id)}
              &gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-red-500 text-sm"</span>&gt;</span>✕<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoList</span>
</code></pre>
<h4 data-id="heading-31">Step 4: 实现云函数(让 CloudBase MCP 帮你)</h4>
<pre><code class="hljs language-ini" lang="ini">你: 帮我创建云函数getTodos,查询todos集合的所有数据,按创建时间倒序排列

AI: <span class="hljs-section">[自动调用CloudBase MCP创建云函数]</span>

云函数已创建! 代码如下:

<span class="hljs-section">[云函数代码...]</span>

需要我帮你部署吗?
</code></pre>
<h4 data-id="heading-32">Step 5: 调试问题</h4>
<p>如果遇到错误:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: 调用addTodo云函数时报错: permission denied</span>

<span class="hljs-section">AI: 让我查看一下日志... [调用CloudBase MCP]</span>

<span class="hljs-section">分析结果:</span>
- 错误原因: 云数据库安全规则限制了写入权限
- 解决方案: 需要在云开发控制台配置安全规则

<span class="hljs-section">我可以帮你生成安全规则配置:</span>

{
  <span class="hljs-string">"read"</span>: true,
  <span class="hljs-string">"write"</span>: <span class="hljs-string">"auth.uid != null"</span>  // 仅登录用户可写入
}

<span class="hljs-section">或者如果是开发测试阶段,可以临时设置为:</span>

{
  <span class="hljs-string">"read"</span>: true,
  <span class="hljs-string">"write"</span>: true
}
</code></pre>
<h3 data-id="heading-33">实践 2：避免常见误区</h3>
<h4 data-id="heading-34">误区 1：过度依赖 AI,不理解原理</h4>
<p><strong>❌ 错误做法:</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: 帮我写一个商城小程序</span>
<span class="hljs-section">AI: [生成2000行代码]</span>
<span class="hljs-section">你: [直接复制粘贴]</span>
</code></pre>
<p><strong>✅ 正确做法:</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: 我要做一个商城小程序,先帮我规划架构</span>

<span class="hljs-section">AI: [给出技术方案]</span>

<span class="hljs-section">你: 为什么选择这个方案?有什么优缺点?</span>

<span class="hljs-section">AI: [详细解释]</span>

<span class="hljs-section">你: 好的,那我们先从首页开始,你能给我讲解一下首页的实现思路吗?</span>

<span class="hljs-section">AI: [讲解思路]</span>

<span class="hljs-section">你: 明白了,那现在帮我实现首页</span>
</code></pre>
<p><strong>关键点:</strong></p>
<ul>
<li>先理解,后实现</li>
<li>分模块开发,不要一次生成所有代码</li>
<li>让 AI 解释为什么这样写</li>
</ul>
<h4 data-id="heading-35">误区 2：忽略项目规范</h4>
<p><strong>❌ 错误做法:</strong></p>
<p>每个功能都是独立开发,没有统一规范:</p>
<ul>
<li>A 功能用 class 组件</li>
<li>B 功能用 function 组件</li>
<li>C 功能样式写在 style 里</li>
<li>D 功能使用 Tailwind</li>
</ul>
<p><strong>✅ 正确做法:</strong></p>
<p>建立<code>.cursorrules</code>规范,所有代码风格统一:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 必须使用 Function Component + Hooks</span>

<span class="hljs-section"># 必须使用 TypeScript</span>

<span class="hljs-section"># 样式优先使用 Tailwind CSS</span>

<span class="hljs-section"># 组件命名使用 PascalCase</span>

<span class="hljs-section"># 文件命名使用 camelCase</span>
</code></pre>
<h4 data-id="heading-36">误区 3：不做代码审查</h4>
<p><strong>❌ 错误做法:</strong></p>
<p>AI 生成代码后直接使用,不检查:</p>
<ul>
<li>可能有性能问题</li>
<li>可能有安全隐患</li>
<li>可能不符合最佳实践</li>
</ul>
<p><strong>✅ 正确做法:</strong></p>
<p>让 AI 做代码审查:</p>
<pre><code class="hljs language-markdown" lang="markdown">你: 帮我审查这段代码,重点关注:
<span class="hljs-bullet">1.</span> 性能问题
<span class="hljs-bullet">2.</span> 安全隐患
<span class="hljs-bullet">3.</span> 最佳实践
<span class="hljs-bullet">4.</span> 可维护性

[粘贴代码]

AI: 发现以下问题:

<span class="hljs-bullet">1.</span> 性能问题:
<span class="hljs-bullet">   -</span> useEffect没有依赖项,会导致无限循环
<span class="hljs-bullet">   -</span> 建议添加依赖数组

<span class="hljs-bullet">2.</span> 安全问题:
<span class="hljs-bullet">   -</span> 用户输入没有做XSS防护
<span class="hljs-bullet">   -</span> 建议使用DOMPurify库

<span class="hljs-bullet">3.</span> 最佳实践:
<span class="hljs-bullet">   -</span> 建议使用useCallback优化函数
<span class="hljs-bullet">   -</span> 建议使用useMemo优化计算

改进后的代码:
[给出改进方案]
</code></pre>
<h4 data-id="heading-37">误区 4：滥用 MCP 工具</h4>
<p><strong>❌ 错误做法:</strong></p>
<p>每次都让 AI 搜索,即使是已知问题:</p>
<pre><code class="hljs language-ini" lang="ini">你: Taro怎么调用微信API?
<span class="hljs-section">[触发web_search]</span>

你: Taro怎么配置路由?
<span class="hljs-section">[又触发web_search]</span>

你: Taro怎么使用生命周期?
<span class="hljs-section">[再次web_search]</span>
</code></pre>
<p>这样做的问题:</p>
<ul>
<li>浪费搜索次数(可能有配额限制)</li>
<li>增加响应时间</li>
<li>降低开发效率</li>
</ul>
<p><strong>✅ 正确做法:</strong></p>
<p>建立知识库,把常用信息整理到<code>.cursorrules</code>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Taro 常用 API 速查</span>

<span class="hljs-section">## 页面导航</span>

Taro.navigateTo({ url: '/pages/index/index' })

<span class="hljs-section">## 微信 API 调用</span>

Taro.getUserInfo()
Taro.chooseImage()
Taro.uploadFile()

<span class="hljs-section">## 生命周期</span>

useEffect(() =&gt; {}, []) // componentDidMount
useEffect(() =&gt; () =&gt; {}, []) // componentWillUnmount
</code></pre>
<p><strong>什么时候使用 web_search:</strong></p>
<ul>
<li>遇到新的 bug 或错误</li>
<li>查询最新的 API 变化</li>
<li>寻找特定问题的社区解决方案</li>
</ul>
<p><strong>什么时候不需要:</strong></p>
<ul>
<li>基础概念和语法</li>
<li>项目已有的代码模式</li>
<li>文档中明确说明的内容</li>
</ul>
<h3 data-id="heading-38">实践 3：建立高效的开发流程</h3>
<p><strong>标准开发流程:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 需求分析 (5分钟)
   └─ 让AI帮你分析需求,拆分任务

<span class="hljs-bullet">2.</span> 技术设计 (10分钟)
   └─ 确定技术方案,数据结构,接口定义

<span class="hljs-bullet">3.</span> UI设计/还原 (15分钟)
   ├─ 有设计稿: 用understand<span class="hljs-emphasis">_image分析
   └─ 无设计稿: 让AI生成现代化UI

4. 前端开发 (30分钟)
   ├─ 让AI生成组件骨架
   ├─ 补充业务逻辑
   └─ 添加交互效果

5. 后端开发 (20分钟)
   ├─ 用CloudBase MCP创建云函数
   ├─ 配置数据库规则
   └─ 部署并测试

6. 联调测试 (15分钟)
   ├─ 发现问题用web_</span>search搜索
   ├─ 用CloudBase MCP查看日志
   └─ 快速定位和修复

<span class="hljs-bullet">7.</span> 代码审查 (10分钟)
   ├─ 让AI审查代码质量
   ├─ 优化性能和安全
   └─ 统一代码风格

总计: 约1-2小时完成一个完整功能
</code></pre>
<p><strong>对比传统开发:</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">传统开发流程:

<span class="hljs-bullet">1.</span> 需求分析 (30分钟)
<span class="hljs-bullet">2.</span> 查阅文档 (1小时)
<span class="hljs-bullet">3.</span> UI设计/还原 (2小时)
<span class="hljs-bullet">4.</span> 前端开发 (3小时)
<span class="hljs-bullet">5.</span> 后端开发 (2小时)
<span class="hljs-bullet">6.</span> 联调测试 (2小时)
   └─ 遇到问题反复搜索,试错
<span class="hljs-bullet">7.</span> 代码审查 (1小时)

总计: 1-2天
</code></pre>
<p><strong>效率提升:</strong> 10-15 倍 🚀</p>
<h2 data-id="heading-39">🔥 进阶技巧：成为高手的秘诀</h2>
<h3 data-id="heading-40">高手技巧 1：自定义 MCP 工具</h3>
<p>如果你的项目有特殊需求,可以开发自己的 MCP 服务器。</p>
<p><strong>示例场景:</strong> 你有一个内部 API 文档系统,希望 AI 能直接查询。</p>
<p><strong>解决方案:</strong> 创建一个 MCP 服务器,暴露<code>query_docs</code>工具:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// docs-mcp-server.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/index.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@modelcontextprotocol/sdk/server/stdio.js'</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'docs-server'</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
}, {
  <span class="hljs-attr">capabilities</span>: {
    <span class="hljs-attr">tools</span>: {}
  }
});

<span class="hljs-comment">// 注册工具</span>
server.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-string">'tools/list'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">tools</span>: [{
      <span class="hljs-attr">name</span>: <span class="hljs-string">'query_docs'</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">'查询内部API文档'</span>,
      <span class="hljs-attr">inputSchema</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-attr">keyword</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
            <span class="hljs-attr">description</span>: <span class="hljs-string">'搜索关键词'</span>
          }
        }
      }
    }]
  };
});

<span class="hljs-comment">// 实现工具逻辑</span>
server.<span class="hljs-title function_">setRequestHandler</span>(<span class="hljs-string">'tools/call'</span>, <span class="hljs-keyword">async</span> (request) =&gt; {
  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">params</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'query_docs'</span>) {
    <span class="hljs-keyword">const</span> { keyword } = request.<span class="hljs-property">params</span>.<span class="hljs-property">arguments</span>;
    <span class="hljs-comment">// 查询你的文档系统</span>
    <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title function_">queryInternalDocs</span>(keyword);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">content</span>: [{
        <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(results)
      }]
    };
  }
});

<span class="hljs-comment">// 启动服务器</span>
<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioServerTransport</span>();
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
</code></pre>
<p><strong>配置到 Cursor:</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"docs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/docs-mcp-server.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-41">高手技巧 2：批量生成页面</h3>
<p>如果你的项目有大量相似页面,可以让 AI 批量生成:</p>
<pre><code class="hljs language-markdown" lang="markdown">你: 我有一个商城项目,需要生成这些页面:
<span class="hljs-bullet">-</span> 商品列表
<span class="hljs-bullet">-</span> 商品详情
<span class="hljs-bullet">-</span> 购物车
<span class="hljs-bullet">-</span> 订单列表
<span class="hljs-bullet">-</span> 订单详情
<span class="hljs-bullet">-</span> 个人中心

它们的UI风格相似,都使用卡片布局+Tailwind CSS。
帮我生成页面骨架和路由配置。

AI: 好的,我会为你生成:
<span class="hljs-bullet">1.</span> 6个页面组件
<span class="hljs-bullet">2.</span> 统一的路由配置
<span class="hljs-bullet">3.</span> 通用的布局组件
<span class="hljs-bullet">4.</span> 共享的样式定义

[开始生成...]
</code></pre>
<h3 data-id="heading-42">高手技巧 3：自动化测试</h3>
<p>让 AI 帮你写测试用例:</p>
<pre><code class="hljs language-javascript" lang="javascript">你: 为<span class="hljs-title class_">TodoList</span>组件写单元测试,覆盖:
<span class="hljs-number">1.</span> 渲染测试
<span class="hljs-number">2.</span> 添加待办
<span class="hljs-number">3.</span> 完成待办
<span class="hljs-number">4.</span> 删除待办
<span class="hljs-number">5.</span> 边界情况(空输入,网络错误等)

<span class="hljs-attr">AI</span>: [生成测试代码]

<span class="hljs-keyword">import</span> { render, fireEvent, waitFor } <span class="hljs-keyword">from</span> <span class="hljs-string">'@testing-library/react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TodoList'</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'TodoList'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'应该正确渲染'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> { getByText } = <span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> /&gt;</span></span>)
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByText</span>(<span class="hljs-string">'我的待办'</span>)).<span class="hljs-title function_">toBeInTheDocument</span>()
  })

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'应该能添加待办'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// ... 测试代码</span>
  })

  <span class="hljs-comment">// ... 更多测试</span>
})
</code></pre>
<h3 data-id="heading-43">高手技巧 4：性能优化</h3>
<p>让 AI 分析性能瓶颈:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">你: 我的待办列表页面加载很慢,帮我分析性能问题</span>

<span class="hljs-section">AI: 让我看看代码...</span>

<span class="hljs-section">发现以下问题:</span>

1. useEffect依赖项设置不当,导致频繁重新渲染
2. 列表项没有使用React.memo优化
3. 云函数查询没有做缓存

<span class="hljs-section">建议优化方案:</span>
[给出详细的优化代码]
</code></pre>
<h2 data-id="heading-44">📚 资源推荐</h2>
<h3 data-id="heading-45">必读文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.taro.zone" title="https://docs.taro.zone" target="_blank" ref="nofollow noopener noreferrer">Taro 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com" title="https://tailwindcss.com" target="_blank" ref="nofollow noopener noreferrer">Tailwind CSS 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io" title="https://modelcontextprotocol.io" target="_blank" ref="nofollow noopener noreferrer">MCP 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cloudbase.net" title="https://docs.cloudbase.net" target="_blank" ref="nofollow noopener noreferrer">CloudBase 文档</a></li>
</ul>
<h3 data-id="heading-46">社区资源</h3>
<ul>
<li>Taro GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNervJS%2Ftaro" target="_blank" title="https://github.com/NervJS/taro" ref="nofollow noopener noreferrer">github.com/NervJS/taro</a></li>
<li>Taro 物料市场: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftaro-ext.jd.com" target="_blank" title="https://taro-ext.jd.com" ref="nofollow noopener noreferrer">taro-ext.jd.com</a></li>
<li>MCP Servers: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fservers" target="_blank" title="https://github.com/modelcontextprotocol/servers" ref="nofollow noopener noreferrer">github.com/modelcontex…</a></li>
</ul>
<h3 data-id="heading-47">推荐工具</h3>
<ul>
<li><strong>Cursor</strong>: AI 编程 IDE</li>
<li><strong>MiniMax Coding Plan</strong>: web_search + understand_image</li>
<li><strong>CloudBase</strong>: 腾讯云开发平台</li>
<li><strong>Tailwind CSS IntelliSense</strong>: VS Code/Cursor 插件</li>
</ul>
<h2 data-id="heading-48">🎉 结语</h2>
<p>使用 MiniMax + Cursor + Taro 的组合,你会发现开发小程序不再是痛苦的过程,而是充满创造力的旅程:</p>
<ul>
<li><strong>不再害怕遇到 bug</strong> - web_search 帮你找到解决方案</li>
<li><strong>不再担心还原设计稿</strong> - understand_image 一键分析</li>
<li><strong>不再头疼调试云函数</strong> - CloudBase MCP 直接查看日志</li>
<li><strong>不再纠结样式实现</strong> - Tailwind CSS 所见即所得</li>
</ul>
<p>记住:<strong>AI 是你的助手,不是替代品。</strong></p>
<p>最好的开发模式是:<strong>AI 处理重复劳动,你专注创造价值。</strong></p>
<p>现在,打开 Cursor,开始你的 AI 辅助开发之旅吧! 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第3章 Nest.js拦截器]]></title>    <link>https://juejin.cn/post/7589935326782898210</link>    <guid>https://juejin.cn/post/7589935326782898210</guid>    <pubDate>2026-01-02T04:30:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589935326782898210" data-draft-id="7590071125397995560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第3章 Nest.js拦截器"/> <meta itemprop="keywords" content="前端,NestJS,AI编程"/> <meta itemprop="datePublished" content="2026-01-02T04:30:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第3章 Nest.js拦截器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T04:30:04.000Z" title="Fri Jan 02 2026 04:30:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">3.1 拦截器介绍</h2>
<p>Nest.js的拦截器和axios的拦截器是类似的，可以在网络请求处理的前后去执行额外的逻辑。拦截器从字面意思理解就是拦截，假设有流程A-&gt;B，拦截器要做的是A到B的过程中，将内容拦截下来处理后再丢给B，变成了A-&gt;拦截器-&gt;B。</p>
<p>在网络请求的逻辑中，拦截器的拦截位置如下：</p>
<ul>
<li>客户端请求-&gt;拦截器（前置逻辑）-&gt;路由处理器-&gt;拦截器（后置逻辑）-&gt;客户端响应。</li>
</ul>
<p>Nest.js拦截器效果如图3-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f748da79494b1698a97dc2ba327487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767933209&amp;x-signature=rjGaBE%2FMUQcYB2xG72DMqOKYs8Q%3D" alt="image-20251212195404071" loading="lazy"/></p>
<p align="center">
 <b> 图3-1 Nest.js拦截器</b>
</p>
<p>Nest.js拦截器主要的用途有以下5点：</p>
<p>（1）统一响应格式：将返回数据包装成统一格式。</p>
<p>（2）日志记录：记录请求耗时、请求参数等信息。</p>
<p>（3）缓存处理：对响应数据进行缓存。</p>
<p>（4）异常映射：转换异常类型。</p>
<p>（5）数据转换：对响应数据进行序列化/转换。</p>
<p>在英语AI项目中，主要使用到第5点数据转换，因此我们主要学习这一点。</p>
<h2 data-id="heading-1">3.2 拦截器创建</h2>
<p>如表1-2所示，可以通过nest g itc interceptor快速创建一个拦截器（interceptor可以替换为任何你想取的拦截器名称）。通过该命令会在src文件夹下创建interceptor文件夹，而interceptor文件夹下存放interceptor.interceptor.ts文件。</p>
<p>根据命令的生成规则，我们知道文件夹和文件的名称取决于我们命令对拦截器的名称，从而生成xxx文件夹和xxx.interceptor.ts文件。并且在这唯一的文件中，会提前生成好对应的Demo示例。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//src/interceptor/interceptor.interceptor.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CallHandler</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
  }
}
</code></pre>
<p>拦截器有两种使用方式：</p>
<p>（1）局部使用。</p>
<p>（2）全局使用。</p>
<p>当想局部使用时，例如只想在src文件夹下的user模块使用，我们只需要注册到user模块中。那怎么注册？有3种注册方式，在user.module.ts、user.controller.ts以及user.controller.ts都可以注册，最主要的区别在于局部作用范围不同。Nest.js拦截器局部注册如表3-1所示。</p>
<p align="center">
 <b> 表3-1 Nest.js拦截器局部注册</b>
</p>

































<table><thead><tr><th align="left">注册方式</th><th align="left">作用范围</th><th align="left">代码位置</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left"><strong>模块级别</strong></td><td align="left">整个模块所有控制器</td><td align="left">user.module.ts</td><td align="left">统一管理，自动应用到所有路由</td><td align="left">无法灵活排除某些路由</td></tr><tr><td align="left"><strong>控制器级别</strong></td><td align="left">单个控制器所有路由</td><td align="left">user.controller.ts</td><td align="left">控制器粒度控制</td><td align="left">需在每个控制器添加装饰器</td></tr><tr><td align="left"><strong>路由级别</strong></td><td align="left">单个路由方法</td><td align="left">user.controller.ts</td><td align="left">最精细的控制</td><td align="left">代码重复，管理复杂</td></tr></tbody></table>
<p>局部使用的具体代码不演示，可通过AI或者官方文档学习使用。</p>
<h2 data-id="heading-2">3.3 全局拦截器使用</h2>
<p>在英语AI项目中会使用到全局使用，我们这里学习具体如何全局使用。步骤为以下2步：</p>
<p>（1）使用nest g itc &lt;拦截器名称&gt;快速创建一个拦截器。</p>
<p>（2）将拦截器注册到main.ts文件中，即在main.ts文件中导入刚创建的拦截器，并且使用Nest应用程序实例方法useGlobalInterceptors()。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InterceptorInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./interceptor/interceptor.interceptor'</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorInterceptor</span>());
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3000</span>);
}

<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p>当然由于InterceptorInterceptor拦截器是一个类，所以我们需要使用new运算符创建拦截器的实例以供使用。到这里，InterceptorInterceptor拦截器就是全局使用，即每一个接口都会经过该拦截器。Nest.js全局注册的官方文档如图3-2所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bd57295aa934803bcb0c3d51f4cb44a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767933209&amp;x-signature=QeA6K9gERm5GkZoDFg%2B%2Bjw%2BDDQM%3D" alt="image-20251212212343423" loading="lazy"/></p>
<p align="center">
 <b> 图3-2 Nest.js拦截器全局注册</b>
</p>
<p>此时来编写InterceptorInterceptor拦截器内的逻辑，可见引入了来自rxjs的Observable类，rxjs是Nest.js内部自带的，主要用于处理流的，使用频率不高。通常获取数据需要区分同步与异步，同步直接获取，而异步通过Promise的then或者catch方法获取。如果此时有rxjs，就不需要我们去关注获取的数据是同步或者异步的问题，减少心智负担。rxjs会将这些数据统一转成一个数据流，然后通过管道（pipe）去接收，接收到之后可由我们处理该数据格式，无论是通过map遍历处理还是filter过滤等等，最终将处理好的数据格式返回就行。</p>
<p>以上是rxjs的核心理念，除此之外，它还可以同时处理多个异步，而then或者catch方法每次只能处理一个。</p>
<p>像InterceptorInterceptor拦截器中的所返回的next.handle()就是一个Observable（数据流），所以我们需要通过pipe（管道）去接收数据然后使用rxjs的map方法对数据处理之后再返回数据。</p>
<p>我们将原始数据包裹在一个标准响应结构中，添加了时间戳、请求路径、业务状态码、成功标志和自定义消息。这样确保了所有经过此拦截器的HTTP响应都遵循统一的JSON格式，包括 { timestamp, data, path, message, code, success } 等标准化字段，前端可以统一处理和错误追踪。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/interceptor/interceptor.interceptor.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CallHandler</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span>, map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-comment">// 将通用的执行上下文切换到HTTP特定的上下文</span>
    <span class="hljs-keyword">const</span> ctx = context.<span class="hljs-title function_">switchToHttp</span>();
    <span class="hljs-comment">// 获取当前HTTP请求的详细对象，包含了请求方法、URL、请求头、参数、主体等所有信息。</span>
    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">timestmap</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">data</span>: data,
        <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      };
    }));
  }
}
</code></pre>
<p>此时在浏览器的URL输入<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fuser%2F123%25EF%25BC%258C%25E8%25AE%25BF%25E9%2597%25AE%25E5%25B8%25A6%25E5%258F%2582%25E6%2595%25B0%25E7%259A%2584get%25E8%25AF%25B7%25E6%25B1%2582%25EF%25BC%258Cget%25E8%25AF%25B7%25E6%25B1%2582%25E6%258B%25A6%25E6%2588%25AA%25E6%2595%2588%25E6%259E%259C%25E5%25A6%2582%25E5%259B%25BE3-3%25E6%2589%2580%25E7%25A4%25BA%25E3%2580%2582%25E5%259C%25A8%25E8%25BF%2599%25E9%2587%258C%25E4%25BD%2593%25E7%258E%25B0%25E7%259A%2584%25E6%2598%25AF%25EF%25BC%259A%25E8%25B7%25AF%25E7%2594%25B1%25E5%25A4%2584%25E7%2590%2586%25E5%2599%25A8-%253E%25E6%258B%25A6%25E6%2588%25AA%25E5%2599%25A8%25EF%25BC%2588%25E5%2590%258E%25E7%25BD%25AE%25E9%2580%25BB%25E8%25BE%2591%25EF%25BC%2589-%253E%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E5%2593%258D%25E5%25BA%2594%25E3%2580%2582" target="_blank" title="http://localhost:3000/user/123%EF%BC%8C%E8%AE%BF%E9%97%AE%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84get%E8%AF%B7%E6%B1%82%EF%BC%8Cget%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%E6%95%88%E6%9E%9C%E5%A6%82%E5%9B%BE3-3%E6%89%80%E7%A4%BA%E3%80%82%E5%9C%A8%E8%BF%99%E9%87%8C%E4%BD%93%E7%8E%B0%E7%9A%84%E6%98%AF%EF%BC%9A%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%E5%99%A8-%3E%E6%8B%A6%E6%88%AA%E5%99%A8%EF%BC%88%E5%90%8E%E7%BD%AE%E9%80%BB%E8%BE%91%EF%BC%89-%3E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%93%8D%E5%BA%94%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:3000/user/123，访问带参数的get请求，get请求拦截效果如图3-3所示。在这里体现的是：路由处理器-&gt;拦截器（后置逻辑）-&gt;客户端响应。</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7af11efb75754b48af28e286cbeef74f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767933209&amp;x-signature=WI8xUv6J%2FmOMBPfLI2WMlHpGmSQ%3D" alt="image-20251212220853053" loading="lazy"/></p>
<p align="center">
 <b> 图3-3 Nest.js全局拦截器-get请求拦截效果</b>
</p>
<p>message和code字段属于业务逻辑的部分，后续完成英语AI项目时，会根据业务实际逻辑去自定义设置。</p>
<h2 data-id="heading-3">3.4 优化全局拦截器</h2>
<p>但此时全局拦截器还有一个很大的Bug，假如接口返回一个很大的数据，我们通过BigInt数据类型去处理返回，那么在通过全局拦截器时就会出现报错情况，全局拦截器处理BigInt类型报错如图3-4所示。</p>
<p><img src="http://tuchuang.xiaoyu2002.cn/picture/image-20251212222211323.png" alt="image-20251212222211323" loading="lazy"/></p>
<p align="center">
 <b> 图3-4 全局拦截器处理BigInt类型报错</b>
</p>
<p>报错是error TS2322: Type 'bigint' is not assignable to type 'string'。即bigint类型无法赋值给string类型，这是很正常的。因为全局拦截器的这些参数都是通过JavaScript标准内置对象JSON.stringify()进行格式化的，而JSON.stringify()是没办法处理BigInt值的。在MDN文档中是这样表述这一异常情况：当尝试去转换 BigInt类型的值会抛出TypeError("BigInt value can't be serialized in JSON")（BigInt 值不能 JSON 序列化）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/app.service.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-title function_">getHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">123456789123456789123456789</span>)
  }
}
</code></pre>
<p>所以我们需要针对BigInt类型的值去处理，通过编写transformBigInt方法去单独处理这一情况，主要处理的事情是当遇到BigInt类型的值就将它转成一个字符串。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">transformBigInt</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'bigint'</span>) {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">toString</span>();
  }
  <span class="hljs-keyword">return</span> data;
};
</code></pre>
<p>此时将接口（get请求）返回给用户的data数据放入transformBigInt方法中即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/interceptor/interceptor.interceptor.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CallHandler</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span>, map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">transformBigInt</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'bigint'</span>) {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">toString</span>();
  }
  <span class="hljs-keyword">return</span> data;
};

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">const</span> ctx = context.<span class="hljs-title function_">switchToHttp</span>();
    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">timestmap</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">data</span>: <span class="hljs-title function_">transformBigInt</span>(data),
        <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      };
    }));
  }
}
</code></pre>
<p>但此时还会报错同样的问题（Type 'bigint' is not assignable to type 'string'），这是很正常的。我们来梳理下流程：</p>
<p>（1）接口返回数据给前端。</p>
<p>（2）全局拦截器拦截接口返回的数据进行处理。</p>
<p>（3）全局处理后的数据返回给前端。</p>
<p>我们已经在全局拦截器中处理好类型转换问题（BigInt转String），如果还有问题，就只能在第一步的接口返回数据给前端的步骤中。前端访问的是接口，而接口是体现形式是路由，路由层从业务层获取数据返回给前端。因此在业务层的数据是BigInt类型，则路由层所拿到的数据也会是BigInt类型。由于Nest.js是强制使用TypeScript的，所以我们需要到app.controller.ts文件中将get默认请求所返回的类型限制从string改成any类型或者string和bigint的联合类型。此时就能正常运行代码。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/app.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> appService: AppService</span>) { }

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getHello</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">bigint</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">appService</span>.<span class="hljs-title function_">getHello</span>();
  }
}
</code></pre>
<p>出于严谨的考虑，我们需要处理相应的边界判断，假如BigInt类型在数组里，在对象里呢？原有的处理方式就又解析不了了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">return</span> [<span class="hljs-title class_">BigInt</span>(<span class="hljs-number">123456789123456789123456789</span>)];
<span class="hljs-keyword">return</span> { <span class="hljs-attr">a</span>: <span class="hljs-title class_">BigInt</span>(<span class="hljs-number">123456789123456789123456789</span>) };
</code></pre>
<p>所以需要进一步强化transformBigInt方法，对数组遍历处理内部可能存在的BigInt类型，而对象则通过Object.entries()静态方法将对象切换成保存键值对的二维数组后，遍历键值对并针对其中的value值处理可能存在的BigInt类型，最后通过Object.fromEntries()静态方法将键值对形式的二维数组重新转换回原始对象。</p>
<ul>
<li>
<p>对象打印效果：{ foo: "bar", baz: 42 }。</p>
</li>
<li>
<p>将可迭代对象切成二维数组：[ ['foo', 'bar'], ['baz', 42] ]。</p>
</li>
</ul>
<p>将对象切成二维数组更方便找到键值对的值并进行遍历操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">transformBigInt</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'bigint'</span>) {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">toString</span>();
  }
  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data)){
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(transformBigInt);
  }
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'object'</span> &amp;&amp; data !== <span class="hljs-literal">null</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> [key, <span class="hljs-title function_">transformBigInt</span>(value)]));
  }
  <span class="hljs-keyword">return</span> data;
};
</code></pre>
<p>做完以上的优化后，我们会发现接口要返回Date日期没办法正常返回给前端了，因为我们把对象全部都处理了，而JavaScript标准内置对象Date的使用是通过new运算符调用的实例对象，实例对象也是对象，也会被transformBigInt方法一并处理，所以在判断对象的内部逻辑中还需要判断是否是Date类型，若为Date类型则直接原路返回，不处理。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'object'</span> &amp;&amp; data !== <span class="hljs-literal">null</span>){
  <span class="hljs-keyword">if</span>(data <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>){
    <span class="hljs-keyword">return</span> data
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> [key, <span class="hljs-title function_">transformBigInt</span>(value)]));
}
</code></pre>
<p>完整的全局拦截器如下代码所示，后续英语AI项目中，会将该全局拦截器直接拿过去使用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/interceptor/interceptor.interceptor.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CallHandler</span>, <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span>, map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-comment">//同步 异步 then catch -&gt;数据流-&gt;pipe -&gt; map filter -&gt; 返回</span>



<span class="hljs-keyword">const</span> <span class="hljs-title function_">transformBigInt</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'bigint'</span>) {
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">toString</span>();
  }
  <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(data)){
    <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">map</span>(transformBigInt);
  }
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">'object'</span> &amp;&amp; data !== <span class="hljs-literal">null</span>){
    <span class="hljs-keyword">if</span>(data <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>){
      <span class="hljs-keyword">return</span> data
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> [key, <span class="hljs-title function_">transformBigInt</span>(value)]));
  }
  <span class="hljs-keyword">return</span> data;
};

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">const</span> ctx = context.<span class="hljs-title function_">switchToHttp</span>();
    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">timestmap</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">data</span>: <span class="hljs-title function_">transformBigInt</span>(data),
        <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<span class="hljs-comment">//业务逻辑自定义</span>
        <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      };
    }));
  }
}
</code></pre>
<p>接下来对异常也格式化统一处理一下，逻辑思路与全局拦截器类似。当前端发起不符合规范和要求的网络请求，后端就会返回异常信息，方便前端去统一处理。</p>
<p><img src="http://tuchuang.xiaoyu2002.cn/picture/image-20251212235546507.png" alt="image-20251212235546507" loading="lazy"/></p>
<p align="center">
 <b> 图3-5 异常情况的处理</b>
</p>
<p>此时我们需要总结nest命令的表1-2，找到filter命令来生成一个过滤器。命令是：nest g f &lt;过滤器名称&gt;，我们就通过nest g f exceptionFilter来生成一份过滤器吧。成功在src文件夹下创建exception-filter文件夹和exception-filter文件夹下的exception-filter.filter.ts文件，这些生成文件的命名规则都是一致的，不再赘述。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/exception-filter/exception-filter.filter.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionFilterFilter</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: T, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {}
}
</code></pre>
<p>通过以上exception-filter.filter.ts文件的代码，我们发现异常处理@Catch()装饰器是空的，空的表示处理所有的异常操作，包括非HTTP请求都会处理，但我希望这个业务只处理和HTTP相关的异常就可以了。所以我们需要从@nestjs/common中引入一个HttpException类，然后让@Catch()装饰器去继承HttpException类就可以了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/exception-filter/exception-filter.filter.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span>, <span class="hljs-title class_">HttpException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">HttpException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionFilterFilter</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpException</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: T, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {}
}
</code></pre>
<p>在这里我们可以看到这个很有意思的设计理念，通过Nest命令生成的内容，它希望我们都能用得上，这种思想和TypeScript所想表达的含义是一致的，只写用得上且必要的部分。因此在通过Nest CLI 在生成过滤器模板时，会会默认使用 @Catch()（不带任何参数），示例性地展示如何捕获所有异常。但它只是一个类模板，需要我们手动把它注册为全局过滤器，或者在控制器上使用。</p>
<p>只有当我们明确在@Catch()中指定具体的异常类型（如 @Catch(HttpException) 或 @Catch(WsException)），过滤器才会从“捕获所有异常”转变为“仅处理特定类型的异常”。如图3-6所示的官方文档也说明了不同协议层（HTTP 与 WebSocket）对应的异常类型不同，因此需要在 @Catch() 中明确指定对应的异常类型。</p>
<p><img src="http://tuchuang.xiaoyu2002.cn/picture/image-20251212235819873.png" alt="image-20251212235819873" loading="lazy"/></p>
<p align="center">
 <b> 图3-6 HTTP异常过滤层的说明</b>
</p>
<p>接下来我们来对异常处理情况进行统一的格式化处理。这里的code（异常状态码）就不采用我们自定义的，而是使用exception内部定义的状态码，因为Nest内置的HttpException已经为所有常见错误定义了标准化的状态码（如 400、401、403、404、500 等），这些状态码符合 HTTP 协议本身的语义。直接使用exception.getStatus()可以确保服务端返回的错误信息在网络层面是可预测和通用的。Nest.js内置异常处理层说明如图3-7所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33e5d0ba58c245529af9984810ac5730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767933209&amp;x-signature=7aohKbCto4B%2FWcfA6y%2BcV3QWauY%3D" alt="image-20251213000123007" loading="lazy"/></p>
<p align="center">
 <b> 图3-7 Nest.js内置异常处理层说明</b>
</p>
<p>当token过期了，exception.getStatus()会自动识别并设置成401状态码，没有权限则403状态码。因此exception.getStatus()会自动化的根据实际情况去调整，非常方便。对应的详细讲解可阅读Nest.js的官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2Fexception-filters" target="_blank" title="https://docs.nestjs.com/exception-filters" ref="nofollow noopener noreferrer">Exception filters | NestJS - A progressive Node.js framework</a>。</p>
<p>如果再自定义一套error code，就等于需要维护两套错误体系：HTTP 状态码 + 我们自己额外设计的业务错误码，这会造成重复劳动、文档负担加重以及维护难度上升。而直接使用 HttpException 内部的状态码可以保持异常捕获逻辑与框架一致，不需要额外重复造轮子。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/exception-filter/exception-filter.filter.ts文件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArgumentsHost</span>, <span class="hljs-title class_">Catch</span>, <span class="hljs-title class_">ExceptionFilter</span>,<span class="hljs-title class_">HttpException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-meta">@Catch</span>(<span class="hljs-title class_">HttpException</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionFilterFilter</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpException</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: T, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
    <span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>()
    <span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;()
    <span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;()
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">status</span>(exception.<span class="hljs-title function_">getStatus</span>()).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
      <span class="hljs-attr">message</span>: exception.<span class="hljs-property">message</span>,
      <span class="hljs-attr">code</span>: exception.<span class="hljs-title function_">getStatus</span>(),
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
    })
  }
}
</code></pre>
<p>最后，过滤器和拦截器一样，在main.ts文件中全局注册一下，则可以作用于整个项目的异常情况处理。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/main.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InterceptorInterceptor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./interceptor/interceptor.interceptor'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ExceptionFilterFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./exception-filter/exception-filter.filter'</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorInterceptor</span>());
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionFilterFilter</span>());
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3000</span>);
}

<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p>全局异常情况的过滤处理效果如图3-8所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f3f288ad5fc45efaf825369e0d7199d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767933209&amp;x-signature=boCAIoPtCAlPryNFQN9ZKYtuxC8%3D" alt="image-20251212235417767" loading="lazy"/></p>
<p align="center">
 <b> 图3-8 全局异常情况的过滤处理效果</b>
</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第4章 Nest.js业务合并]]></title>    <link>https://juejin.cn/post/7590128405351596032</link>    <guid>https://juejin.cn/post/7590128405351596032</guid>    <pubDate>2026-01-03T05:40:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590128405351596032" data-draft-id="7590128405351579648" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第4章 Nest.js业务合并"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T05:40:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第4章 Nest.js业务合并
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T05:40:08.000Z" title="Sat Jan 03 2026 05:40:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第4章 Nest.js业务合并</h2>
<p>在实际项目中，不同的业务操作需要明确的反馈信息。例如：</p>
<ul>
<li>登录操作返回消息为「登录成功」，状态码为 1。</li>
<li>注册操作返回消息为「注册成功」，状态码为 2。</li>
</ul>
<p><strong>状态码</strong> 作为业务逻辑判断的操作标识，是一个数字或字符串标识符。不同数值代表不同的业务含义（如1表示登录成功、2表示注册成功），前端或调用方可根据具体数值执行相应的逻辑分支。<strong>业务描述</strong> 则面向用户或开发者，用自然语言清晰传达操作结果，提供直观的反馈信息，辅助理解状态码对应的具体业务场景。</p>
<p>在全局拦截器的使用中，message 和 code 这两个参数需要根据业务需求进行自定义。下面将介绍如何在 Nest.js 中对这两个参数，以及更多同类参数进行规范化管理。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/interceptor/interceptor.interceptor.ts</span>
<span class="hljs-keyword">return</span> {
  <span class="hljs-attr">timestmap</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
  <span class="hljs-attr">data</span>: <span class="hljs-title function_">transformBigInt</span>(data),
  <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,<span class="hljs-comment">//业务逻辑自定义</span>
  <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<span class="hljs-comment">//业务逻辑自定义</span>
  <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
};
</code></pre>
<p>要对全局拦截器的统一返回数据格式中的 message 和 code 进行自定义，应从专门的业务定义文件中引入自定义的业务状态码和描述信息，然后传递给 message 和 code 参数。</p>
<p>在自定义参数时，有一个重要原则：message 和 code 的自定义数据需要与业务逻辑层分离。这些数据应作为纯粹的配置信息使用，类似于 JSON 配置文件。业务层则建立在统一的业务规范基础上进行进一步封装。</p>
<p>首先创建一个响应格式模块（response module）和服务（response service），用于统一处理业务响应。通过 Nest CLI 命令生成的 response.service.ts 文件会自动关联到 response.module.ts 文件中。</p>
<pre><code class="hljs language-ts" lang="ts">nest g mo response
nest g s response
</code></pre>
<p>在 src 目录下创建 business 文件夹，并在其中创建 index.ts 文件。该文件专门存放自定义的业务状态码和描述信息，我们只关心每个业务操作对应的状态码和消息内容。后续新增业务需求时，只需在此文件中添加相应的状态码和消息。</p>
<p>注意：业务字段命名通常采用大写字母和下划线组合的格式，即「功能_状态」的表达方式，如 LOGIN_SUCCESS。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/business/index.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> business = {
  <span class="hljs-attr">LOGIN_SUCCESS</span>: {
    <span class="hljs-attr">code</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'登录成功'</span>
  },
  <span class="hljs-attr">LOGIN_ERROR</span>: {
    <span class="hljs-attr">code</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'登录失败'</span>
  },
  <span class="hljs-attr">REGISTER_SUCCESS</span>: {
    <span class="hljs-attr">code</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'注册成功'</span>
  },
}
</code></pre>
<p>在 response 目录的 response.service.ts 文件中编写具体的响应格式逻辑，定义操作成功和操作失败时需要返回的数据结构。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/response/response.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseService</span> {
  <span class="hljs-title function_">success</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>, message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'操作成功'</span>, code: <span class="hljs-built_in">number</span> = <span class="hljs-number">200</span></span>) {
    <span class="hljs-keyword">return</span> {
      data,
      message,
      code
    }
  }
  <span class="hljs-title function_">error</span>(<span class="hljs-params">message: <span class="hljs-built_in">string</span> = <span class="hljs-string">'操作失败'</span>, code: <span class="hljs-built_in">number</span> = <span class="hljs-number">500</span></span>) {
    <span class="hljs-keyword">return</span> {
      message,
      code
    }
  }
}
</code></pre>
<p>如果我们想要使用自定义的业务状态码，要如何使用？假设要在user模块的业务层中使用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/user/user.service.ts（业务层）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">create</span>(<span class="hljs-params">createUserDto: CreateUserDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action adds a new user'</span>;
  }

  <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`This action returns all user`</span>;
  }
 	<span class="hljs-comment">// 省略...</span>
}
</code></pre>
<p>假设需要在 user 模块的业务层中使用自定义业务状态码，操作步骤如下：</p>
<p>（1）引入依赖文件：同时引入业务定义文件和响应格式文件。</p>
<p>（2）依赖注入：在 UserService 类中注入 ResponseService 类。</p>
<p>（3）使用响应格式：在 findAll() 方法中使用 ResponseService 类，按照 data、message 和 code 的顺序传入数据。</p>
<p>（4）引用业务定义：message 和 code 从 business 业务文件中读取，本次「登录成功操作」使用业务字段 LOGIN_SUCCESS。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/user/user.service.ts（业务层）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/response/response.service'</span>;
<span class="hljs-keyword">import</span> { business } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/business'</span>;
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> responseService: ResponseService</span>) { }
  <span class="hljs-title function_">create</span>(<span class="hljs-params">createUserDto: CreateUserDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'This action adds a new user'</span>;
  }

  <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 登录成功的消息内容和业务码</span>
    <span class="hljs-keyword">const</span> message = business.<span class="hljs-property">LOGIN_SUCCESS</span>.<span class="hljs-property">message</span>;
    <span class="hljs-keyword">const</span> code = business.<span class="hljs-property">LOGIN_SUCCESS</span>.<span class="hljs-property">code</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseService</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'This action returns all user'</span>, message, code);
  }
}
</code></pre>
<p>此时启动项目，访问 localhost:3000/user 路由应返回登录成功的业务状态码。但可能出现以下错误：</p>
<p>RROR [ExceptionHandler] UnknownDependenciesException [Error]: Nest can't resolve dependencies of the UserService (?). Please make sure that the argument ResponseService at index [0] is available in the UserModule context.</p>
<p>错误信息表明 Nest 无法解析 UserService 的依赖，需要确保 ResponseService 在 UserModule 上下文中可用。这是因为 ResponseService 未被正确导出和导入。</p>
<p>解决上述问题需要如下3个步骤：</p>
<p>（1）导出服务：在 response.module.ts 文件中将 ResponseService 添加到 exports 数组中。</p>
<p>（2）导入模块：在 user.module.ts 文件中导入 ResponseModule 模块。</p>
<p>（3）完成注入：此时 UserModule 可以读取到 ResponseModule 导出的 ResponseService，UserService 才能正常使用 ResponseService。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/response/response.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./response.service'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">ResponseService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">ResponseService</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseModule</span> { }
</code></pre>
<p>在user.module.ts 文件中导入 ResponseModule 模块，完成导入模块。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/user/user.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/response/response.module'</span>;
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ResponseModule</span>],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">UserController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> {}
</code></pre>
<p>完成以上配置后，重新启动项目访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fuser%25EF%25BC%258C%25E5%258F%25AF%25E8%25A7%2581" target="_blank" title="http://localhost:3000/user%EF%BC%8C%E5%8F%AF%E8%A7%81" ref="nofollow noopener noreferrer">http://localhost:3000/user，可见</a> data、message 和 code 三个业务字段的信息都成功输出。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e493da6ae5644f4fb8f16e816d7ab870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768023608&amp;x-signature=w%2F7WSxTj0An%2BQq3PDYrLHbWmsGQ%3D" alt="image-20251213233534395" loading="lazy"/></p>
<p align="center">
 <b> 图4-1 业务字段信息插入</b>
</p>
<p>接下来只需从全局拦截器中重新统一数据格式即可。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/interceptor/interceptor.interceptor.ts</span>
<span class="hljs-keyword">return</span> {
  <span class="hljs-attr">timestmap</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
  <span class="hljs-attr">data</span>: <span class="hljs-title function_">transformBigInt</span>(data.<span class="hljs-property">data</span>) ?? <span class="hljs-literal">null</span>,
  <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
  <span class="hljs-attr">message</span>: data.<span class="hljs-property">message</span> ?? <span class="hljs-string">'success'</span>,<span class="hljs-comment">//业务逻辑自定义</span>
  <span class="hljs-attr">code</span>: data.<span class="hljs-property">code</span> ?? <span class="hljs-number">200</span>,<span class="hljs-comment">//业务逻辑自定义</span>
  <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
};
</code></pre>
<p>统一业务字段格式如图4-2所示。</p>
<p><img src="http://tuchuang.xiaoyu2002.cn/picture/image-20251213234031967.png" alt="image-20251213234031967" loading="lazy"/></p>
<p align="center">
 <b> 图4-2 统一业务字段格式</b>
</p>
<p>通过以上步骤，Nest.js 的业务状态码和业务状态描述已成功应用到对应的 user 模块接口中。但在实现过程中，我们发现每个使用 ResponseService 的模块都需要：</p>
<p>（1）在提供模块中导出服务。</p>
<p>（2）在使用模块中导入模块。</p>
<p>如果项目有十几个模块都需要使用，这种重复导入导出的操作会变得繁琐。为此，可以将 response 模块注册为全局模块，这样在整个项目中都可以直接使用，无需在每个使用模块的 module.ts 文件中重复导入。</p>
<p>将 response 模块注册为全局模块的方法为以下2步：</p>
<p>（1）从 @nestjs/common 中导入 Global 装饰器</p>
<p>（2）将 @Global() 装饰器应用到 ResponseModule 上</p>
<p>注册为全局模块后，ResponseService 可以在任何模块中直接使用，无需在各使用模块中导入 ResponseModule。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/response/response.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">Global</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./response.service'</span>;

<span class="hljs-meta">@Global</span>()
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">ResponseService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">ResponseService</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseModule</span> { }
</code></pre>
<p>此时如果我们回到user.module.ts文件中，将刚才注册的ResponseModule删除，项目也不会报错。</p>
<p>对于全局模块的使用，若我想在xiaoyu模块中使用ResponseService，主要步骤如下，无需在XiaoyuModule中导入ResponseModule：</p>
<p>（1）在 xiaoyu.service.ts 文件中导入 ResponseService 服务类和 business 业务常量。</p>
<p>（2）在 XiaoyuService 的构造函数中注入 ResponseService，并使用其方法按照业务数据格式规范处理数据。</p>
<p>（3）在 xiaoyu.controller.ts 文件的控制器中注入 XiaoyuService，并在路由处理器中调用其业务方法返回处理结果。</p>
<p>注意：虽然 ResponseService 是全局模块无需导入，但 XiaoyuModule 仍需要在自身的 providers 中注册 XiaoyuService，在 controllers 中注册 XiaoyuController。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/xiaoyu/xiaoyu.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/response/response.service'</span>;
<span class="hljs-keyword">import</span> { business } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/business'</span>;
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XiaoyuService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> responseService: ResponseService</span>) {}
  <span class="hljs-title function_">getHello</span>(): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">const</span> message = business.<span class="hljs-property">LOGIN_SUCCESS</span>.<span class="hljs-property">message</span>;
    <span class="hljs-keyword">const</span> code = business.<span class="hljs-property">LOGIN_SUCCESS</span>.<span class="hljs-property">code</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">responseService</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'This action returns all user'</span>, message, code);
  }
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/xiaoyu/xiaoyu.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">XiaoyuService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./xiaoyu.service'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'xiaoyu'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XiaoyuController</span> {
  <span class="hljs-comment">// 依赖注入</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> xiaoyuService: XiaoyuService</span>) {}
  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getHello</span>(): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">xiaoyuService</span>.<span class="hljs-title function_">getHello</span>();
  }
}
</code></pre>
<p>xiaoyu模块业务合并如图4-3所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645775c74ffc435c948ff37e77723d1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768023608&amp;x-signature=q5Re8lEqcDI%2BLazzUOvZRW0vCuo%3D" alt="image-20251214004117303" loading="lazy"/></p>
<p align="center">
 <b> 图4-3 xiaoyu模块业务合并</b>
</p>
<p>以上就是Nest.js业务层的所有内容，我们回顾一下，Nest.js 的业务处理分为 business 和 response 两个部分：</p>
<p>（1）business 文件夹：集中管理业务状态码和描述信息。</p>
<p>（2）response 模块：专门用于构建统一的响应格式。</p>
<p>在实际项目中，这两者的变化频率不同：响应格式通常保持稳定，而业务状态码会随着业务发展不断新增或调整。因此需要将两者分离管理。response 模块的功能与全局拦截器中统一返回客户端响应格式的功能是一致的，区别在于我们将自定义部分拆分出来，提高了灵活性和可维护性，更符合实际项目的需求变化。</p>
<p>这种架构设计的优势在于：业务状态定义与响应格式构建职责明确（单一职责）；业务状态变化不影响响应格式，响应格式调整不影响业务逻辑；统一的响应格式可跨模块、跨项目使用；新增业务状态只需在 business 文件中添加，不影响现有结构。通过这种规范化管理，可以构建出清晰、可维护、可扩展的业务层架构，适应各种复杂的业务场景需求。</p>
<p>除了message和code这两个字段，我们还可以有权限与安全控制（例如IP白名单、频率限制、黑白名单）、数据持久化（创建、读取、更新、删除业务数据）、业务流程（多级审批、会签、或签逻辑）、第三方集成（支付宝、微信支付回调处理）、监控与统计（接口响应时间、成功率）等多方面基于实际业务需求去增添。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot性能翻倍秘籍：5个被低估的配置项让我QPS提升200%]]></title>    <link>https://juejin.cn/post/7590303618428633123</link>    <guid>https://juejin.cn/post/7590303618428633123</guid>    <pubDate>2026-01-03T04:16:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590303618428633123" data-draft-id="7590303618428616739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot性能翻倍秘籍：5个被低估的配置项让我QPS提升200%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-03T04:16:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot性能翻倍秘籍：5个被低估的配置项让我QPS提升200%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T04:16:38.000Z" title="Sat Jan 03 2026 04:16:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot性能翻倍秘籍：5个被低估的配置项让我QPS提升200%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在当今高并发的互联网环境下，微服务架构的性能优化成为了开发者必须面对的挑战。SpringBoot作为Java生态中最流行的微服务框架之一，其默认配置虽然能满足大多数场景需求，但在极端性能要求下往往显得力不从心。本文将揭示5个常被开发者忽略的SpringBoot配置项，通过合理调整这些参数，我们的线上服务实现了QPS（每秒查询率）从1000到3000的惊人提升。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. Tomcat线程池调优：突破默认并发瓶颈</h3>
<p><strong>问题背景</strong>：
SpringBoot内嵌Tomcat默认使用200个线程的最大连接数（server.tomcat.max-threads），这在中等流量下尚可应付，但对于突发高并发场景会成为明显瓶颈。</p>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-properties" lang="properties">server.tomcat.max-threads=500
server.tomcat.min-spare-threads=50
server.tomcat.accept-count=100
</code></pre>
<p><strong>深度解析</strong>：</p>
<ul>
<li><code>max-threads</code>应根据服务器CPU核心数调整（建议公式：核心数 * (1 + 平均等待时间/平均服务时间)）</li>
<li><code>min-spare-threads</code>预热线程池避免冷启动延迟</li>
<li><code>accept-count</code>设置合理的等待队列防止直接拒绝请求</li>
</ul>
<p><strong>实测效果</strong>：
在4核8G的服务器上，将max-threads从200提升到500后，持续10分钟的压测结果显示99线延迟降低了37%。</p>
<h3 data-id="heading-4">2. Undertow替代Tomcat：异步IO的性能红利</h3>
<p><strong>问题背景</strong>：
虽然Tomcat是默认选择，但Undertow基于NIO2的实现在高并发场景下表现更优异。</p>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-properties" lang="properties">server.undertow.worker-threads=16
server.undertow.io-threads=4
</code></pre>
<p><strong>深度解析</strong>：</p>
<ul>
<li>Undertow采用X.NIO工作模式，I/O与Worker线程分离</li>
<li>worker-threads建议设置为CPU核心数的8倍</li>
<li>io-threads通常设为CPU核心数即可</li>
</ul>
<p><strong>实测效果</strong>：
相同硬件条件下切换至Undertow后，长连接场景下的内存消耗降低40%，吞吐量提升22%。</p>
<h3 data-id="heading-5">3. JVM参数精细化配置：告别OOM的噩梦</h3>
<p><strong>问题背景</strong>：
SpringBoot应用的默认JVM参数往往不适合生产环境，容易引发GC风暴或内存溢出。</p>
<p><strong>优化方案（application.properties）</strong>：</p>
<pre><code class="hljs language-properties" lang="properties">spring.jvmargs=-XX:+UseG1GC -Xms2048m -Xmx2048m -XX:MaxGCPauseMillis=200 
-XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=35
</code></pre>
<p>或者通过启动命令：</p>
<pre><code class="hljs language-bash" lang="bash">java -jar -XX:+UseG1GC -Xms2048m -Xmx2048m your-app.jar
</code></pre>
<p><strong>深度解析</strong>：</p>
<ul>
<li>G1垃圾收集器适合多核大内存机器（JDK9+默认）</li>
<li>Xms与Xmx必须相同以避免运行时调整带来的性能波动</li>
<li>MaxGCPauseMillis设置合理的GC停顿目标（100-200ms）</li>
</ul>
<h3 data-id="heading-6">4. Redis连接池优化：解决高频访问的性能黑洞</h3>
<p>当使用Spring Data Redis时：</p>
<pre><code class="hljs language-properties" lang="properties">spring.redis.lettuce.pool.enabled=true
spring.redis.lettuce.pool.max-active=32
spring.redis.lettuce.pool.max-idle=16
spring.redis.lettuce.pool.min-idle=8
spring.redis.timeout=5000ms
</code></pre>
<p>当使用Jedis时：</p>
<pre><code class="hljs language-properties" lang="properties">spring.redis.jedis.pool.max-active=50 
spring.redis.jedis.pool.max-idle=20 
spring redis.jedis.pool.min-idle=10 
spring redis.jedis pool max-wait=-1ms 
</code></pre>
<h3 data-id="heading-7">5. Jackson序列化黑科技：JSON处理的极致优化</h3>
<p><code>properties spring.jackson.generator.write-numbers-as-strings=false spring jackson parser allow unquoted field names=false spring jackson default property inclusion=none spring jackson serialization write dates as timestamps=true spring jackson deserialization fail on unknown properties=true </code></p>
<h2 data-id="heading-8">总结</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依AI项目专属域名ruoyiai.cn限时出售，打造AI开发领域品牌标杆]]></title>    <link>https://juejin.cn/post/7590292138347036682</link>    <guid>https://juejin.cn/post/7590292138347036682</guid>    <pubDate>2026-01-03T04:47:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292138347036682" data-draft-id="7590292138347003914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依AI项目专属域名ruoyiai.cn限时出售，打造AI开发领域品牌标杆"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-01-03T04:47:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依AI项目专属域名ruoyiai.cn限时出售，打造AI开发领域品牌标杆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T04:47:38.000Z" title="Sat Jan 03 2026 04:47:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在人工智能技术蓬勃发展的今天，一个优秀的品牌域名已成为项目成功的关键要素。ruoyiai.cn——这个与若依AI项目完美契合的域名，现正式对外出售，为AI开发领域的品牌建设提供绝佳机会。</p>
<h2 data-id="heading-1">域名价值分析</h2>
<h3 data-id="heading-2">品牌一致性优势</h3>
<p>ruoyiai.cn与若依AI项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fruoyi-ai%2Fruoyi-ai" target="_blank" title="https://gitee.com/ruoyi-ai/ruoyi-ai" ref="nofollow noopener noreferrer">gitee.com/ruoyi-ai/ru…</a>
名称完全一致，这种高度匹配的域名具有不可替代的品牌价值。对于开发者而言，ruoyiai.cn不仅是一个访问入口，更是项目品牌形象的重要组成部分。当用户在浏览器中输入"ruoyiai.cn"，直接就能联想到若依AI项目，这种品牌记忆的强化效果是其他域名无法比拟的。</p>
<h3 data-id="heading-3">SEO优化潜力</h3>
<p>从搜索引擎优化角度看，ruoyiai.cn包含"ruoyi"和"ai"两个核心关键词，这对提升项目在搜索结果中的排名极为有利。无论是百度、谷歌还是其他搜索引擎，都会给予包含关键词的域名更高的权重。这意味着，拥有ruoyiai.cn后，项目在"若依AI"、"ruoyi ai"等关键词的搜索排名将获得天然优势，为项目带来持续的流量和曝光。</p>
<h3 data-id="heading-4">技术定位明确</h3>
<p>"AI"作为人工智能的缩写，在域名中明确标识了项目的技术属性。对于目标用户群体——开发者、技术决策者而言，这种技术定位的清晰表达能够快速吸引目标受众。同时，.cn域名表明其中国本土化属性，符合若依项目在国内开发社区的广泛影响力，便于国内用户访问和记忆。</p>
<h2 data-id="heading-5">项目背景与潜力</h2>
<p>若依AI项目是基于著名的RuoYi开源项目的AI增强版本，致力于为开发者提供集成人工智能能力的快速开发平台。该项目结合传统开发框架与AI能力，集成智能代码生成、自动化测试等先进功能，适用于多种企业级应用开发场景。</p>
<p>随着人工智能技术的快速发展，若依AI项目具有巨大的成长潜力。作为项目的专属域名，ruoyiai.cn将成为项目品牌资产的重要组成部分，为项目未来的商业化、产品化发展预留充足的品牌扩展空间。</p>
<h2 data-id="heading-6">限时优惠信息</h2>
<p>为回馈若依AI项目社区，ruoyiai.cn现推出限时优惠活动：</p>
<p><strong>原价：¥5,000</strong></p>
<p><strong>限时优惠价：¥3,800</strong></p>
<p><strong>节省：24%</strong></p>
<p>此价格包含域名所有权完全转移及相关协助服务。购买后，我们将协助完成域名过户、DNS解析等所有技术操作，确保您能够顺利使用该域名。</p>
<h2 data-id="heading-7">适用人群</h2>
<ul>
<li><strong>若依AI项目核心开发者</strong>：保护项目品牌，防止域名被抢注</li>
<li><strong>若依项目贡献者</strong>：为项目发展贡献力量，获得品牌资产</li>
<li><strong>AI开发领域创业者</strong>：抢占优质域名资源，布局AI赛道</li>
<li><strong>域名投资者</strong>：投资具有明确项目背景的优质域名</li>
</ul>
<h2 data-id="heading-8">购买方式</h2>
<p><strong>网站加客服</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruoyiai.cn" target="_blank" title="http://www.ruoyiai.cn" ref="nofollow noopener noreferrer">www.ruoyiai.cn</a></p>
<h2 data-id="heading-9">结语</h2>
<p>ruoyiai.cn不仅是一个域名，更是若依AI项目品牌建设的重要一步。在AI技术快速发展的时代，拥有一个与项目完美契合的域名，将为项目带来持续的流量、品牌价值和商业机会。限时优惠仅此一次，机会不容错过！</p>
<p><strong>立即行动，让ruoyiai.cn成为您AI开发之路的起点！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【n8n教程】：Switch节点，实现工作流多路由控制]]></title>    <link>https://juejin.cn/post/7590292138346807306</link>    <guid>https://juejin.cn/post/7590292138346807306</guid>    <pubDate>2026-01-03T03:06:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292138346807306" data-draft-id="7581412054902734857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【n8n教程】：Switch节点，实现工作流多路由控制"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-03T03:06:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="undsky"/> <meta itemprop="url" content="https://juejin.cn/user/3368559354850206"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【n8n教程】：Switch节点，实现工作流多路由控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559354850206/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    undsky
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T03:06:12.000Z" title="Sat Jan 03 2026 03:06:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【n8n教程】：Switch节点，实现工作流多路由控制</h2>
<p>在n8n自动化流程中，最常见的需求之一就是<strong>根据数据的不同条件，将其分发到不同的处理路径</strong>。如果你只需要处理"是"或"否"两种情况，可以用<strong>If节点</strong>；但当你需要根据多个条件创建3条、5条甚至更多的处理路径时，<strong>Switch节点</strong>就是你的最佳选择。</p>
<p>Switch节点就像是一个<strong>交通指挥官</strong>，它根据你设定的条件规则，将传入的数据准确地引导到对应的输出分支，让复杂的工作流变得清晰有序。</p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.undsky.com%2Fimg%2Fghss.png" target="_blank" title="https://cdn.undsky.com/img/ghss.png" ref="nofollow noopener noreferrer">点击获取最新AI资讯、n8n工作流、开发经验分享</a></p>
<h3 data-id="heading-1">什么是Switch节点？</h3>
<p>Switch节点是n8n中的<strong>条件路由节点</strong>，它允许你根据数据的属性值进行多路由决策。与If节点只能分出两条路（真/假）不同，<strong>Switch节点可以创建无限个输出分支</strong>，每个分支对应一组特定的条件。</p>
<p><strong>核心特性：</strong></p>
<ul>
<li><strong>多路由支持</strong>：不限制输出分支数量，想要多少就创建多少</li>
<li><strong>灵活的条件系统</strong>：支持字符串、数字、日期、布尔值、数组、对象等多种数据类型</li>
<li><strong>两种工作模式</strong>：Rules模式（可视化条件构建）和Expression模式（编程表达式）</li>
<li><strong>智能降级处理</strong>：为不匹配任何条件的数据提供备选输出</li>
<li><strong>高效的数据流</strong>：一条数据一旦匹配到某个输出，默认不会重复匹配其他规则</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b83b6461623d46e6b543fa398dcad239~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kc2t5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014372&amp;x-signature=8Ir9kP%2FsZdX%2BNumYmk918oG6zyw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">Switch节点的两种工作模式</h3>
<h4 data-id="heading-3">模式一：Rules模式（推荐初学者）</h4>
<p>Rules模式是<strong>可视化条件构建方式</strong>，你无需编写任何代码，只需通过下拉菜单和输入框配置条件。</p>
<p><strong>支持的数据类型和比较操作：</strong></p>








































<table><thead><tr><th>数据类型</th><th>支持的比较操作</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>字符串</strong></td><td>等于、不等于、包含、不包含、以...开始、以...结束、正则匹配</td><td>邮箱地址、分类标签、部门名称</td></tr><tr><td><strong>数字</strong></td><td>等于、不等于、大于、小于、大于等于、小于等于</td><td>订单金额、优先级数值、计数器</td></tr><tr><td><strong>日期&amp;时间</strong></td><td>等于、不等于、之后、之前、之后或等于、之前或等于</td><td>截止日期、创建时间、过期判断</td></tr><tr><td><strong>布尔值</strong></td><td>为真、为假、等于、不等于</td><td>开关状态、验证结果</td></tr><tr><td><strong>数组</strong></td><td>存在/不存在、为空/非空、包含、长度比较</td><td>标签列表、多选项</td></tr><tr><td><strong>对象</strong></td><td>存在/不存在、为空/非空</td><td>嵌套数据结构</td></tr></tbody></table>
<h4 data-id="heading-4">模式二：Expression模式（高级用户）</h4>
<p>Expression模式使用<strong>JavaScript表达式</strong>来定义路由逻辑，适合需要复杂条件判断的高级场景。</p>
<p>例如：<code>{{ $json.status === 'urgent' &amp;&amp; $json.amount &gt; 1000 }}</code></p>
<hr/>
<h3 data-id="heading-5">快速上手：3步配置Switch节点</h3>
<h4 data-id="heading-6">第1步：添加Switch节点</h4>
<ol>
<li>在工作流画布上点击"<strong>添加节点</strong>"（或按Tab键）</li>
<li>搜索"<strong>Switch</strong>"</li>
<li>选择Switch节点添加到工作流</li>
</ol>
<h4 data-id="heading-7">第2步：配置路由规则</h4>
<ol>
<li>打开Switch节点的配置面板</li>
<li>确保"<strong>Mode</strong>"选择为"<strong>Rules</strong>"</li>
<li>点击"<strong>Add Routing Rule</strong>"添加第一条规则</li>
<li>根据你的数据，配置规则：
<ul>
<li><strong>左侧字段</strong>：选择你要检查的数据字段（例如 <code>priority</code>）</li>
<li><strong>中间操作符</strong>：选择比较方式（例如 "等于"）</li>
<li><strong>右侧值</strong>：输入要比较的值（例如 "high"）</li>
</ul>
</li>
</ol>
<p><strong>示例配置：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">规则<span class="hljs-number">1</span>：priority 等于 <span class="hljs-string">"high"</span> → 输出到第<span class="hljs-number">1</span>条分支
规则<span class="hljs-number">2</span>：priority 等于 <span class="hljs-string">"medium"</span> → 输出到第<span class="hljs-number">2</span>条分支
规则<span class="hljs-number">3</span>：priority 等于 <span class="hljs-string">"low"</span> → 输出到第<span class="hljs-number">3</span>条分支
</code></pre>
<h4 data-id="heading-8">第3步：连接后续节点</h4>
<ol>
<li>Switch节点会自动为每条规则创建一个输出端口</li>
<li>从这些输出端口拖拽连线到你的后续处理节点</li>
<li>为每个输出分支配置不同的业务逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-9">5个关键配置选项详解</h3>
<h4 data-id="heading-10">1. 重命名输出（Rename Output）</h4>
<p><strong>默认情况下</strong>，Switch的输出被标记为"Output 0"、"Output 1"等数字标签。这容易混淆，特别是在复杂流程中。</p>
<p><strong>最佳实践</strong>：启用"<strong>Rename Output</strong>"，给每条分支取个有意义的名字：</p>
<ul>
<li>✅ 好：<code>高优先级处理</code>、<code>待审核</code>、<code>已完成</code></li>
<li>❌ 差：<code>Output 0</code>、<code>Output 1</code></li>
</ul>
<p><strong>配置步骤：</strong>
在配置规则时，勾选"Rename Output"，输入自定义名称。</p>
<h4 data-id="heading-11">2. 降级输出（Fallback Output）</h4>
<p>当数据<strong>不匹配任何路由规则</strong>时，降级输出决定该数据的去向。</p>
<p><strong>三种选项：</strong></p>

























<table><thead><tr><th>选项</th><th>说明</th><th>场景</th></tr></thead><tbody><tr><td><strong>None</strong></td><td>忽略不匹配的数据，不输出</td><td>只关心已知数据类型</td></tr><tr><td><strong>Extra Output</strong></td><td>创建单独的输出分支接收未匹配数据</td><td>需要单独处理异常情况</td></tr><tr><td><strong>Output 0</strong></td><td>将未匹配数据发送到第一条规则的输出</td><td>快速处理，无需额外分支</td></tr></tbody></table>
<p><strong>示例：</strong> 如果优先级字段出现意外值"urgent"，但你的规则中没有定义它，这条数据就会按照降级设置进行处理。</p>
<h4 data-id="heading-12">3. 忽略大小写（Ignore Case）</h4>
<p>对于字符串比较，启用此选项后，<code>"HIGH"</code>、<code>"High"</code>、<code>"high"</code>会被视为相同。</p>
<p><strong>建议</strong>：大多数场景下启用，避免因大小写不一致导致路由失败。</p>
<h4 data-id="heading-13">4. 严格类型验证（Less Strict Type Validation）</h4>
<p>启用后，n8n会<strong>自动尝试类型转换</strong>。例如，字符串"123"可以与数字123比较。</p>
<p><strong>默认建议</strong>：关闭。这样可以捕获潜在的数据类型错误。</p>
<h4 data-id="heading-14">5. 发送数据到所有匹配输出（Send data to all matching outputs）</h4>
<p><strong>默认行为</strong>：一条数据只要匹配到第一个规则，就停止检查其他规则。</p>
<p><strong>启用后</strong>：同时匹配多个规则的数据会被<strong>复制到所有匹配的输出分支</strong>。</p>
<p><strong>场景</strong>：标签系统中，一条数据可能同时属于多个标签，需要被发送到所有相关的处理流程。</p>
<hr/>
<h3 data-id="heading-15">Switch vs If：何时选择哪个？</h3>



































<table><thead><tr><th>对比维度</th><th>If节点</th><th>Switch节点</th></tr></thead><tbody><tr><td><strong>输出分支数</strong></td><td>固定2个（真/假）</td><td>无限制</td></tr><tr><td><strong>条件复杂性</strong></td><td>简单（单一真假判断）</td><td>复杂（多分支选择）</td></tr><tr><td><strong>最适用场景</strong></td><td>二元决策：发送或不发送、通过或阻止</td><td>多路由：优先级划分、类型分类、状态判断</td></tr><tr><td><strong>易用性</strong></td><td>直观简洁</td><td>功能更强大</td></tr><tr><td><strong>性能</strong></td><td>略快</td><td>略慢（但差异微乎其微）</td></tr></tbody></table>
<p><strong>实际建议：</strong></p>
<ul>
<li>问自己："我需要2个还是更多个处理分支？"</li>
<li>如果≤2个，用If</li>
<li>如果&gt;2个，用Switch</li>
</ul>
<hr/>
<h3 data-id="heading-16">实战案例：客户反馈优先级路由工作流</h3>
<p>现在让我们用一个完整的、可执行的案例来演示Switch节点的强大功能。</p>
<h4 data-id="heading-17">业务场景</h4>
<p>你的公司收到多渠道客户反馈，需要根据<strong>优先级</strong>进行分发：</p>
<ul>
<li><strong>高优先级（high）</strong>：立即通知管理员，通过紧急Slack频道</li>
<li><strong>中优先级（medium）</strong>：记录到数据库，定期处理</li>
<li><strong>低优先级（low）</strong>：存档，月度回顾</li>
<li><strong>未知优先级</strong>：人工审核队列</li>
</ul>
<h4 data-id="heading-18">工作流架构</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐
│   Webhook触发   │ (接收客户反馈数据)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Switch节点     │ (根据priority字段路由)
└────────┬────────┘
    ┌────┼────┬─────┐
    │    │    │     │
    ▼    ▼    ▼     ▼
  高优   中优  低优  未知
  先级   先级  先级  优先级
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f960ba70a3eb465f835b535d7cfac633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdW5kc2t5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768014372&amp;x-signature=1bHH3QwSmF2yp9gi13spEvnQUMk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19">完整工作流JSON代码</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"客户反馈优先级路由 - Switch节点教程"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"nodes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://webhook.site/your-unique-id"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Webhook"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.webhook"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">,</span> <span class="hljs-number">300</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Switch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.switch"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">400</span><span class="hljs-punctuation">,</span> <span class="hljs-number">300</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rules"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"={{ $json.priority }}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value2"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"high"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"operator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"equal"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"={{ $json.priority }}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value2"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"medium"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"operator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"equal"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"={{ $json.priority }}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"value2"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"low"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"operator"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"equal"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"fallbackOutput"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"ignoreCaseInStringComparison"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔴 高优先级反馈\n来自: {{ $json.sender }}\n内容: {{ $json.message }}"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"高优先级处理"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.noOp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">700</span><span class="hljs-punctuation">,</span> <span class="hljs-number">100</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🟡 中优先级反馈\n来自: {{ $json.sender }}\n内容: {{ $json.message }}"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中优先级处理"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.noOp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">700</span><span class="hljs-punctuation">,</span> <span class="hljs-number">300</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🟢 低优先级反馈\n来自: {{ $json.sender }}\n内容: {{ $json.message }}"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"低优先级处理"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.noOp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">700</span><span class="hljs-punctuation">,</span> <span class="hljs-number">500</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"⚪ 未知优先级 - 需要人工审核\n来自: {{ $json.sender }}\n内容: {{ $json.message }}\n优先级值: {{ $json.priority }}"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"降级处理"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"n8n-nodes-base.noOp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"typeVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"position"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">700</span><span class="hljs-punctuation">,</span> <span class="hljs-number">700</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"connections"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Webhook"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Switch"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Switch"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"高优先级处理"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"中优先级处理"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"低优先级处理"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"降级处理"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"index"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-20">如何使用这个工作流</h4>
<p><strong>第1步：导入工作流</strong></p>
<ol>
<li>复制上述JSON代码</li>
<li>进入你的n8n仪表板，点击"新建工作流"</li>
<li>点击右上角"..."菜单，选择"从文件导入"</li>
<li>粘贴JSON代码并导入</li>
</ol>
<p><strong>第2步：配置Webhook</strong></p>
<ol>
<li>打开Webhook节点</li>
<li>复制显示的Webhook URL</li>
<li>使用任何HTTP工具（如Postman或curl）向该URL发送测试数据</li>
</ol>
<p><strong>第3步：发送测试数据</strong></p>
<p>使用cURL命令：</p>
<pre><code class="hljs language-bash" lang="bash">curl -X POST https://your-webhook-url \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "sender": "customer@example.com",
    "message": "我的订单出现了问题",
    "priority": "high"
  }'</span>
</code></pre>
<p><strong>第4步：检查执行结果</strong></p>
<ol>
<li>运行工作流</li>
<li>查看"执行历史"</li>
<li>观察数据是否被正确路由到对应的优先级分支</li>
</ol>
<hr/>
<h3 data-id="heading-21">常见错误与解决方案</h3>
<h4 data-id="heading-22">❌ 错误1：数据没有被路由到任何输出</h4>
<p><strong>原因：</strong> 数据不匹配任何配置的规则</p>
<p><strong>解决：</strong></p>
<ol>
<li>检查字段名称是否正确（区分大小写）</li>
<li>使用"执行单个节点"来查看前一个节点的实际输出</li>
<li>检查比较值是否包含多余空格</li>
</ol>
<h4 data-id="heading-23">❌ 错误2：大小写导致的匹配失败</h4>
<p><strong>原因：</strong> 数据中是"HIGH"，但规则中写的是"high"</p>
<p><strong>解决：</strong></p>
<ol>
<li>启用"<strong>Ignore Case</strong>"选项</li>
<li>或在前一个节点中使用<code>.toLowerCase()</code>规范化数据</li>
</ol>
<h4 data-id="heading-24">❌ 错误3：Expression模式返回NaN或undefined</h4>
<p><strong>原因：</strong> 表达式语法错误</p>
<p><strong>解决：</strong></p>
<ol>
<li>检查变量引用是否正确：<code>$json.fieldName</code></li>
<li>使用JavaScript控制台测试表达式</li>
<li>参考n8n表达式文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.n8n.io%2Fcode-examples%2Fexpressions%2F" target="_blank" title="https://docs.n8n.io/code-examples/expressions/" ref="nofollow noopener noreferrer">docs.n8n.io/code-exampl…</a></li>
</ol>
<h4 data-id="heading-25">❌ 错误4：多条规则都匹配，数据只输出到第一个</h4>
<p><strong>原因：</strong> 没有启用"Send data to all matching outputs"</p>
<p><strong>解决：</strong></p>
<ol>
<li>打开Switch节点的Options</li>
<li>启用"<strong>Send data to all matching outputs</strong>"</li>
<li>此时匹配多个规则的数据会被复制到所有对应的输出</li>
</ol>
<hr/>
<h3 data-id="heading-26">进阶技巧</h3>
<h4 data-id="heading-27">技巧1：使用表达式实现复杂条件</h4>
<p>在Rules模式下，虽然界面有限制，但你可以<strong>在比较值中使用表达式</strong>：</p>
<p>配置示例：</p>
<pre><code class="hljs language-bash" lang="bash">value1: {{ <span class="hljs-variable">$json</span>.amount }}
operator: 大于
value2: {{ <span class="hljs-variable">$json</span>.<span class="hljs-built_in">limit</span> + 100 }}
</code></pre>
<h4 data-id="heading-28">技巧2：根据数组长度进行路由</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">condition: Array</span>
<span class="hljs-section">value1: {{ $json.tags }}</span>
<span class="hljs-section">operator: length greater than</span>
<span class="hljs-section">value2: 5</span>
</code></pre>
<p>这样，只有标签数大于5的数据才会被路由到这条分支。</p>
<h4 data-id="heading-29">技巧3：使用正则表达式进行高级文本匹配</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">condition:</span> <span class="hljs-type">String</span>
<span class="hljs-symbol">value1:</span> {{ $json.email }}
<span class="hljs-symbol">operator:</span> matches regex
<span class="hljs-symbol">value2:</span> ^[a-zA-Z0-<span class="hljs-number">9._</span>%+-]+@(gmail|yahoo|outlook)\.com$
</code></pre>
<p>这样只会匹配特定邮箱域名的用户。</p>
<h4 data-id="heading-30">技巧4：先排序再Switch，优化性能</h4>
<p>如果你的数据量很大，先用<strong>Sort节点</strong>对数据进行分组，再用Switch处理，能显著提升性能。</p>
<hr/>
<h3 data-id="heading-31">调试技巧</h3>
<h4 data-id="heading-32">1. 单步执行</h4>
<p>点击Switch节点，选择"<strong>Execute node</strong>"（执行此节点），只执行到这里停止，查看各分支的输出。</p>
<h4 data-id="heading-33">2. 使用日志节点（Logger Node）</h4>
<p>在Switch前后各添加一个Logger节点，记录数据内容：</p>
<pre><code class="hljs language-json" lang="json">前置日志<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">{</span> JSON.stringify($json) <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
后置日志<span class="hljs-punctuation">:</span> 进入分支 <span class="hljs-punctuation">{</span><span class="hljs-punctuation">{</span> $node<span class="hljs-punctuation">[</span><span class="hljs-string">"Switch"</span><span class="hljs-punctuation">]</span>.json.output <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-34">3. 检查表达式错误</h4>
<p>在Expression模式下，若有错误，会显示红色警告。鼠标悬停可看错误详情。</p>
<h4 data-id="heading-35">4. 测试数据</h4>
<p>使用"测试数据"功能注入虚拟数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"sender"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"test@example.com"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Test message"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"priority"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"high"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-36">总结要点</h3>

































<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td><strong>适用场景</strong></td><td>需要根据条件将数据分发到多个处理分支</td></tr><tr><td><strong>配置方式</strong></td><td>Rules（可视化）或Expression（编程）</td></tr><tr><td><strong>核心优势</strong></td><td>无限制分支、易于维护、无需编码</td></tr><tr><td><strong>关键参数</strong></td><td>条件、数据类型、比较操作符、降级输出</td></tr><tr><td><strong>常见问题</strong></td><td>大小写、字段名、降级处理</td></tr><tr><td><strong>最佳实践</strong></td><td>使用有意义的输出名称、启用Ignore Case、正确配置降级输出</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-37">下一步学习路径</h3>
<p>掌握Switch节点后，你可以进一步学习：</p>
<ol>
<li><strong>与If节点结合</strong> - 构建更复杂的条件逻辑</li>
<li><strong>Filter节点</strong> - 过滤不需要的数据</li>
<li><strong>Loop Over Items</strong> - 对集合中的每个元素运行Switch</li>
<li><strong>错误处理</strong> - 使用Switch处理异常情况</li>
<li><strong>性能优化</strong> - 在大数据量场景下优化Switch逻辑</li>
</ol>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.n8n.io%2Fintegrations%2Fbuiltin%2Fcore-nodes%2Fn8n-nodes-base.switch%2F" target="_blank" title="https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.switch/" ref="nofollow noopener noreferrer">官方文档</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.undsky.com%2Fblog%2F%3Fcategory%3Dn8n%25E6%2595%2599%25E7%25A8%258B%23" target="_blank" title="https://www.undsky.com/blog/?category=n8n%E6%95%99%E7%A8%8B#" ref="nofollow noopener noreferrer">n8n系列教程</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[25-客服工单系统实战（二）：RAG检索与智能问答]]></title>    <link>https://juejin.cn/post/7589919989039087679</link>    <guid>https://juejin.cn/post/7589919989039087679</guid>    <pubDate>2026-01-02T12:17:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589919989039087679" data-draft-id="7589940210832130091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="25-客服工单系统实战（二）：RAG检索与智能问答"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-02T12:17:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kevin_kang"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824720670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            25-客服工单系统实战（二）：RAG检索与智能问答
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824720670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kevin_kang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T12:17:37.000Z" title="Fri Jan 02 2026 12:17:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">客服工单系统实战（二）：RAG检索与智能问答</h2>
<h3 data-id="heading-1">前言</h3>
<p>在上一篇文章中，我们完成了工单数据的导入和向量化存储。本文将介绍如何基于这些向量数据，实现智能检索和问答功能，让AI能够根据历史工单自动推荐解决方案。</p>
<p><strong>本文基于真实项目代码</strong>，所有示例均可在GitHub仓库中找到对应实现。</p>
<p><strong>适合读者：</strong> AI工程师、后端开发者、全栈工程师</p>
<hr/>
<h3 data-id="heading-2">一、RAG工作原理</h3>
<h4 data-id="heading-3">1.1 传统LLM vs RAG</h4>
<pre><code class="hljs">传统LLM：
用户问题 → LLM → 答案
问题：知识有限、可能过时、容易幻觉

RAG（检索增强生成）：
用户问题 → 向量检索 → 相关工单 → 组装Prompt → LLM → 答案
优势：知识可更新、答案更准确、有据可查
</code></pre>
<h4 data-id="heading-4">1.2 完整流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户提问："物流信息5天没更新怎么办？"
   ↓
<span class="hljs-bullet">2.</span> 向量化问题 → [0.23, -0.45, 0.67, ...]
   ↓
<span class="hljs-bullet">3.</span> Weaviate检索 → Top-5相似工单
   ↓
<span class="hljs-bullet">4.</span> 组装Prompt（问题 + 历史工单）
   ↓
<span class="hljs-bullet">5.</span> LLM生成答案
   ↓
<span class="hljs-bullet">6.</span> 返回答案 + 来源工单
</code></pre>
<hr/>
<h3 data-id="heading-5">二、向量检索实现</h3>
<h4 data-id="heading-6">2.1 相似度搜索</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># agent/ticket_agent.py</span>
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">import</span> weaviate.classes <span class="hljs-keyword">as</span> wvc

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_search_similar_documents</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-string">"""搜索相似工单"""</span>
        <span class="hljs-comment"># 1. 生成查询向量</span>
        query_vector = self.embeddings.embed_query(query)
        
        <span class="hljs-comment"># 2. 在Weaviate中搜索</span>
        response = self.collection.query.near_vector(
            near_vector=query_vector,
            limit=k,
            return_metadata=wvc.query.MetadataQuery(distance=<span class="hljs-literal">True</span>)
        )
        
        <span class="hljs-comment"># 3. 转换为Document格式</span>
        documents = []
        <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> response.objects:
            doc = Document(
                page_content=obj.properties[<span class="hljs-string">'content'</span>],
                metadata={
                    <span class="hljs-string">'ticket_id'</span>: obj.properties.get(<span class="hljs-string">'ticket_id'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'issue_type'</span>: obj.properties.get(<span class="hljs-string">'issue_type'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'priority'</span>: obj.properties.get(<span class="hljs-string">'priority'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'status'</span>: obj.properties.get(<span class="hljs-string">'status'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'distance'</span>: obj.metadata.distance <span class="hljs-keyword">if</span> obj.metadata <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                }
            )
            documents.append(doc)
        
        <span class="hljs-keyword">return</span> documents
</code></pre>
<h4 data-id="heading-7">2.2 检索测试</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 测试检索功能</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_search</span>():
    agent = ServiceTicketAgent()
    
    <span class="hljs-comment"># 测试问题</span>
    question = <span class="hljs-string">"物流信息5天没更新，怎么处理？"</span>
    
    <span class="hljs-comment"># 检索相似工单</span>
    docs = agent._search_similar_documents(question, k=<span class="hljs-number">5</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"检索到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(docs)}</span> 条相关工单：\n"</span>)
    <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(docs, <span class="hljs-number">1</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工单 <span class="hljs-subst">{i}</span>:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  ID: <span class="hljs-subst">{doc.metadata[<span class="hljs-string">'ticket_id'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  类型: <span class="hljs-subst">{doc.metadata[<span class="hljs-string">'issue_type'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  距离: <span class="hljs-subst">{doc.metadata[<span class="hljs-string">'distance'</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  内容: <span class="hljs-subst">{doc.page_content[:<span class="hljs-number">100</span>]}</span>..."</span>)
        <span class="hljs-built_in">print</span>()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    test_search()
</code></pre>
<p><strong>输出示例：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">检索到 5 条相关工单：

工单 1:
  ID: TK011
  类型: 订单查询
  距离: 0.1234
  内容: 工单编号: TK011
<span class="hljs-section">问题类型: 订单查询</span>
<span class="hljs-section">问题描述: 订单已发货5天但物流信息未更新，担心包裹丢失...</span>

工单 2:
  ID: TK006
  类型: 物流问题
  距离: 0.2456
  内容: 工单编号: TK006
<span class="hljs-section">问题类型: 物流问题</span>
<span class="hljs-section">问题描述: 快递显示已签收但本人未收到货物...</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">三、Prompt工程</h3>
<h4 data-id="heading-9">3.1 Prompt模板设计</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># agent/config.py</span>
QA_PROMPT_TEMPLATE = <span class="hljs-string">"""你是一个专业的客服助手，擅长根据历史工单提供解决方案。

以下是相关的历史工单记录：

{context}

客户问题：{question}

请基于以上历史工单，为客户提供专业的解决方案。要求：
1. 如果找到相关解决方案，请详细说明处理步骤
2. 如果历史工单中没有完全匹配的案例，可以综合多个相似案例给出建议
3. 保持友好、专业的语气
4. 如果确实无法解决，建议客户联系人工客服

回答："""</span>
</code></pre>
<h4 data-id="heading-10">3.2 动态Prompt组装</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_components</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 初始化Prompt模板</span>
        self.prompt_template = PromptTemplate(
            input_variables=[<span class="hljs-string">"context"</span>, <span class="hljs-string">"question"</span>],
            template=config.QA_PROMPT_TEMPLATE
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_format_context</span>(<span class="hljs-params">self, docs: <span class="hljs-type">List</span>[Document]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""格式化上下文"""</span>
        context_parts = []
        
        <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(docs, <span class="hljs-number">1</span>):
            context_parts.append(<span class="hljs-string">f"【历史工单 <span class="hljs-subst">{i}</span>】\n<span class="hljs-subst">{doc.page_content}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n\n"</span>.join(context_parts)
</code></pre>
<hr/>
<h3 data-id="heading-11">四、LCEL问答链</h3>
<h4 data-id="heading-12">4.1 构建问答链</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_qa_chain</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""设置问答链（LCEL）"""</span>
        
        <span class="hljs-comment"># 定义格式化函数</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_docs</span>(<span class="hljs-params">docs</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"\n\n"</span>.join(doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs)
        
        <span class="hljs-comment"># 定义检索和格式化函数</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_and_format</span>(<span class="hljs-params">question</span>):
            docs = self._search_similar_documents(question)
            <span class="hljs-keyword">return</span> format_docs(docs)
        
        <span class="hljs-comment"># 使用LCEL构建链</span>
        self.qa_chain = (
            {
                <span class="hljs-string">"context"</span>: retrieve_and_format,
                <span class="hljs-string">"question"</span>: RunnablePassthrough()
            }
            | self.prompt_template
            | self.llm
            | StrOutputParser()
        )
        
        <span class="hljs-keyword">return</span> self.qa_chain
</code></pre>
<h4 data-id="heading-13">4.2 LCEL优势</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LCEL的优势：</span>
<span class="hljs-comment"># 1. 简洁优雅 - 使用管道操作符 |</span>
<span class="hljs-comment"># 2. 类型安全 - 自动类型检查</span>
<span class="hljs-comment"># 3. 流式支持 - 天然支持stream</span>
<span class="hljs-comment"># 4. 并行执行 - 自动优化执行顺序</span>

<span class="hljs-comment"># 传统方式（复杂）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">old_way</span>(<span class="hljs-params">question</span>):
    docs = search(question)
    context = <span class="hljs-built_in">format</span>(docs)
    prompt = template.<span class="hljs-built_in">format</span>(context=context, question=question)
    answer = llm.invoke(prompt)
    <span class="hljs-keyword">return</span> parse(answer)

<span class="hljs-comment"># LCEL方式（简洁）</span>
chain = retriever | <span class="hljs-built_in">format</span> | prompt | llm | parser
answer = chain.invoke(question)
</code></pre>
<hr/>
<h3 data-id="heading-14">五、非流式问答</h3>
<h4 data-id="heading-15">5.1 完整实现</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># agent/ticket_agent.py</span>
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> .response <span class="hljs-keyword">import</span> success_response, error_response, AgentErrorCode

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>:
        <span class="hljs-string">"""
        完整的智能问答流程
        
        返回格式:
        {
            "code": 0,
            "msg": "success",
            "data": {
                "answer": "答案文本",
                "sources": [...],
                "metadata": {...}
            }
        }
        """</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"客服问题: <span class="hljs-subst">{question}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        
        start_time = time.time()
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 1. 参数验证</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> question <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> question.strip():
                <span class="hljs-keyword">return</span> error_response(
                    code=AgentErrorCode.QUESTION_FORMAT_ERROR,
                    msg=<span class="hljs-string">"问题不能为空"</span>
                )
            
            <span class="hljs-comment"># 2. 设置问答链</span>
            qa_chain = self._setup_qa_chain()
            
            <span class="hljs-comment"># 3. 检索相关工单</span>
            <span class="hljs-keyword">try</span>:
                source_docs = self._search_similar_documents(question)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> error_response(
                    code=AgentErrorCode.RAG_RETRIEVAL_ERROR,
                    msg=<span class="hljs-string">"向量检索失败"</span>,
                    error_detail=<span class="hljs-built_in">str</span>(e)
                )
            
            <span class="hljs-comment"># 4. 检查是否有相关结果</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> source_docs:
                <span class="hljs-keyword">return</span> error_response(
                    code=AgentErrorCode.NO_RELEVANT_RESULTS,
                    msg=<span class="hljs-string">"未找到相关工单记录"</span>
                )
            
            <span class="hljs-comment"># 5. 显示检索到的工单</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"检索到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(source_docs)}</span> 条相关工单:"</span>)
            sources = []
            <span class="hljs-keyword">for</span> i, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(source_docs, <span class="hljs-number">1</span>):
                metadata = doc.metadata
                ticket_id = metadata.get(<span class="hljs-string">'ticket_id'</span>, <span class="hljs-string">'Unknown'</span>)
                issue_type = metadata.get(<span class="hljs-string">'issue_type'</span>, <span class="hljs-string">'Unknown'</span>)
                priority = metadata.get(<span class="hljs-string">'priority'</span>, <span class="hljs-string">'Unknown'</span>)
                distance = metadata.get(<span class="hljs-string">'distance'</span>)
                
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{ticket_id}</span> (<span class="hljs-subst">{issue_type}</span>) [优先级: <span class="hljs-subst">{priority}</span>]"</span>)
                
                sources.append({
                    <span class="hljs-string">"ticket_id"</span>: ticket_id,
                    <span class="hljs-string">"issue_type"</span>: issue_type,
                    <span class="hljs-string">"priority"</span>: priority,
                    <span class="hljs-string">"status"</span>: metadata.get(<span class="hljs-string">'status'</span>, <span class="hljs-string">'Unknown'</span>),
                    <span class="hljs-string">"score"</span>: <span class="hljs-number">1</span> - distance <span class="hljs-keyword">if</span> distance <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                })
            
            <span class="hljs-comment"># 6. 执行问答</span>
            <span class="hljs-keyword">try</span>:
                answer = qa_chain.invoke(question)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> error_response(
                    code=AgentErrorCode.LLM_CALL_ERROR,
                    msg=<span class="hljs-string">"AI 模型调用失败"</span>,
                    error_detail=<span class="hljs-built_in">str</span>(e)
                )
            
            <span class="hljs-comment"># 7. 计算处理时间</span>
            query_time = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">2</span>)
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI 回答: <span class="hljs-subst">{answer}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理时间: <span class="hljs-subst">{query_time}</span>秒"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
            
            <span class="hljs-comment"># 8. 返回成功响应</span>
            <span class="hljs-keyword">return</span> success_response(
                answer=answer,
                sources=sources[:<span class="hljs-number">5</span>],
                metadata={
                    <span class="hljs-string">"query_time"</span>: query_time,
                    <span class="hljs-string">"retrieved_docs"</span>: <span class="hljs-built_in">len</span>(source_docs),
                    <span class="hljs-string">"model"</span>: self.chat_model,
                    <span class="hljs-string">"embed_model"</span>: self.embed_model
                }
            )
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> error_response(
                code=AgentErrorCode.AGENT_ERROR,
                msg=<span class="hljs-string">"Agent 服务错误"</span>,
                error_detail=<span class="hljs-built_in">str</span>(e)
            )
</code></pre>
<h4 data-id="heading-16">5.2 测试问答</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># test_qa.py</span>
<span class="hljs-keyword">from</span> agent <span class="hljs-keyword">import</span> ServiceTicketAgent

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_qa</span>():
    agent = ServiceTicketAgent()
    
    <span class="hljs-comment"># 测试问题列表</span>
    questions = [
        <span class="hljs-string">"物流信息5天没更新，怎么处理？"</span>,
        <span class="hljs-string">"客户想退货，如何操作？"</span>,
        <span class="hljs-string">"忘记密码怎么办？"</span>,
        <span class="hljs-string">"笔记本电脑可以升级内存吗？"</span>
    ]
    
    <span class="hljs-keyword">for</span> question <span class="hljs-keyword">in</span> questions:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">60</span>}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{question}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'='</span>*<span class="hljs-number">60</span>)
        
        result = agent.ask(question)
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'code'</span>] == <span class="hljs-number">0</span>:
            data = result[<span class="hljs-string">'data'</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n答案:\n<span class="hljs-subst">{data[<span class="hljs-string">'answer'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n参考工单: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(data[<span class="hljs-string">'sources'</span>])}</span>条"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理时间: <span class="hljs-subst">{data[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'query_time'</span>]}</span>秒"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{result[<span class="hljs-string">'msg'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    test_qa()
</code></pre>
<hr/>
<h3 data-id="heading-17">六、流式问答</h3>
<h4 data-id="heading-18">6.1 流式实现</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_stream</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""
        流式问答，逐token返回答案
        
        Yields:
            dict: 流式事件
            {
                "type": "thinking" | "sources" | "token" | "done" | "error",
                "data": {...}
            }
        """</span>
        start_time = time.time()
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 1. 发送思考状态</span>
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"thinking"</span>,
                <span class="hljs-string">"data"</span>: {<span class="hljs-string">"status"</span>: <span class="hljs-string">"retrieving"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在检索相关工单..."</span>}
            }
            
            <span class="hljs-comment"># 2. 检索相关工单</span>
            source_docs = self._search_similar_documents(question)
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> source_docs:
                <span class="hljs-keyword">yield</span> {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"error"</span>,
                    <span class="hljs-string">"data"</span>: {<span class="hljs-string">"code"</span>: <span class="hljs-number">2001</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"未找到相关工单记录"</span>}
                }
                <span class="hljs-keyword">return</span>
            
            <span class="hljs-comment"># 3. 发送检索结果</span>
            sources = []
            <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> source_docs:
                metadata = doc.metadata
                sources.append({
                    <span class="hljs-string">"ticket_id"</span>: metadata.get(<span class="hljs-string">'ticket_id'</span>, <span class="hljs-string">'Unknown'</span>),
                    <span class="hljs-string">"issue_type"</span>: metadata.get(<span class="hljs-string">'issue_type'</span>, <span class="hljs-string">'Unknown'</span>),
                    <span class="hljs-string">"priority"</span>: metadata.get(<span class="hljs-string">'priority'</span>, <span class="hljs-string">'Unknown'</span>),
                    <span class="hljs-string">"score"</span>: <span class="hljs-number">1</span> - metadata.get(<span class="hljs-string">'distance'</span>, <span class="hljs-number">0</span>)
                })
            
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"sources"</span>,
                <span class="hljs-string">"data"</span>: {<span class="hljs-string">"sources"</span>: sources[:<span class="hljs-number">5</span>], <span class="hljs-string">"count"</span>: <span class="hljs-built_in">len</span>(source_docs)}
            }
            
            <span class="hljs-comment"># 4. 发送生成状态</span>
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"thinking"</span>,
                <span class="hljs-string">"data"</span>: {<span class="hljs-string">"status"</span>: <span class="hljs-string">"generating"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在生成解决方案..."</span>}
            }
            
            <span class="hljs-comment"># 5. 设置问答链</span>
            qa_chain = self._setup_qa_chain()
            
            <span class="hljs-comment"># 6. 流式执行问答</span>
            full_answer = <span class="hljs-string">""</span>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> qa_chain.astream(question):
                token = <span class="hljs-built_in">str</span>(chunk) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(chunk, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> chunk
                full_answer += token
                
                <span class="hljs-comment"># 发送token</span>
                <span class="hljs-keyword">yield</span> {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"token"</span>,
                    <span class="hljs-string">"data"</span>: {<span class="hljs-string">"token"</span>: token}
                }
            
            <span class="hljs-comment"># 7. 发送完成事件</span>
            query_time = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">2</span>)
            
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"done"</span>,
                <span class="hljs-string">"data"</span>: {
                    <span class="hljs-string">"answer"</span>: full_answer,
                    <span class="hljs-string">"metadata"</span>: {
                        <span class="hljs-string">"query_time"</span>: query_time,
                        <span class="hljs-string">"retrieved_docs"</span>: <span class="hljs-built_in">len</span>(source_docs),
                        <span class="hljs-string">"model"</span>: self.chat_model
                    }
                }
            }
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">yield</span> {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"error"</span>,
                <span class="hljs-string">"data"</span>: {<span class="hljs-string">"code"</span>: <span class="hljs-number">2000</span>, <span class="hljs-string">"msg"</span>: <span class="hljs-string">"Agent服务错误"</span>, <span class="hljs-string">"error_detail"</span>: <span class="hljs-built_in">str</span>(e)}
            }
</code></pre>
<h4 data-id="heading-19">6.2 测试流式问答</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># test_stream.py</span>
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_stream</span>():
    agent = ServiceTicketAgent()
    question = <span class="hljs-string">"物流信息5天没更新，怎么处理？"</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{question}</span>\n"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> agent.ask_stream(question):
        event_type = event[<span class="hljs-string">'type'</span>]
        data = event[<span class="hljs-string">'data'</span>]
        
        <span class="hljs-keyword">if</span> event_type == <span class="hljs-string">'thinking'</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💭 <span class="hljs-subst">{data[<span class="hljs-string">'message'</span>]}</span>"</span>)
        
        <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">'sources'</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📚 检索到 <span class="hljs-subst">{data[<span class="hljs-string">'count'</span>]}</span> 条相关工单"</span>)
            <span class="hljs-keyword">for</span> i, source <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(data[<span class="hljs-string">'sources'</span>], <span class="hljs-number">1</span>):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   <span class="hljs-subst">{i}</span>. <span class="hljs-subst">{source[<span class="hljs-string">'ticket_id'</span>]}</span> - <span class="hljs-subst">{source[<span class="hljs-string">'issue_type'</span>]}</span>"</span>)
        
        <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">'token'</span>:
            <span class="hljs-built_in">print</span>(data[<span class="hljs-string">'token'</span>], end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
        
        <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">'done'</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n\n⏱️ 处理时间: <span class="hljs-subst">{data[<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'query_time'</span>]}</span>秒"</span>)
        
        <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">'error'</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 错误: <span class="hljs-subst">{data[<span class="hljs-string">'msg'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(test_stream())
</code></pre>
<hr/>
<h3 data-id="heading-20">七、响应格式设计</h3>
<h4 data-id="heading-21">7.1 统一响应格式</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># agent/response.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> IntEnum

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentErrorCode</span>(<span class="hljs-title class_ inherited__">IntEnum</span>):
    <span class="hljs-string">"""Agent错误码"""</span>
    SUCCESS = <span class="hljs-number">0</span>
    QUESTION_FORMAT_ERROR = <span class="hljs-number">2001</span>
    RAG_RETRIEVAL_ERROR = <span class="hljs-number">2002</span>
    NO_RELEVANT_RESULTS = <span class="hljs-number">2003</span>
    LLM_CALL_ERROR = <span class="hljs-number">2004</span>
    AGENT_ERROR = <span class="hljs-number">2000</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">success_response</span>(<span class="hljs-params">answer: <span class="hljs-built_in">str</span>, sources: <span class="hljs-built_in">list</span>, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""成功响应"""</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"code"</span>: AgentErrorCode.SUCCESS,
        <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"data"</span>: {
            <span class="hljs-string">"answer"</span>: answer,
            <span class="hljs-string">"sources"</span>: sources,
            <span class="hljs-string">"metadata"</span>: metadata
        }
    }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">error_response</span>(<span class="hljs-params">code: <span class="hljs-built_in">int</span>, msg: <span class="hljs-built_in">str</span>, error_detail: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""错误响应"""</span>
    response = {
        <span class="hljs-string">"code"</span>: code,
        <span class="hljs-string">"msg"</span>: msg,
        <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
    }
    <span class="hljs-keyword">if</span> error_detail:
        response[<span class="hljs-string">"error_detail"</span>] = error_detail
    <span class="hljs-keyword">return</span> response
</code></pre>
<hr/>
<h3 data-id="heading-22">八、性能优化</h3>
<h4 data-id="heading-23">8.1 缓存检索结果</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceTicketAgent</span>:
<span class="hljs-meta">    @lru_cache(<span class="hljs-params">maxsize=<span class="hljs-number">100</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_cached_search</span>(<span class="hljs-params">self, question: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        <span class="hljs-string">"""缓存检索结果"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">tuple</span>(self._search_similar_documents(question, k))
</code></pre>
<h4 data-id="heading-24">8.2 批量问答</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_ask</span>(<span class="hljs-params">self, questions: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]:
    <span class="hljs-string">"""批量问答"""</span>
    tasks = [self.ask(q) <span class="hljs-keyword">for</span> q <span class="hljs-keyword">in</span> questions]
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
</code></pre>
<hr/>
<h3 data-id="heading-25">九、评估指标</h3>
<h4 data-id="heading-26">9.1 检索质量评估</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_retrieval</span>(<span class="hljs-params">test_cases: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]</span>):
    <span class="hljs-string">"""评估检索质量"""</span>
    agent = ServiceTicketAgent()
    
    metrics = {
        <span class="hljs-string">"precision"</span>: [],
        <span class="hljs-string">"recall"</span>: [],
        <span class="hljs-string">"mrr"</span>: []  <span class="hljs-comment"># Mean Reciprocal Rank</span>
    }
    
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">in</span> test_cases:
        question = <span class="hljs-keyword">case</span>[<span class="hljs-string">'question'</span>]
        expected_tickets = <span class="hljs-built_in">set</span>(<span class="hljs-keyword">case</span>[<span class="hljs-string">'expected_tickets'</span>])
        
        <span class="hljs-comment"># 检索</span>
        docs = agent._search_similar_documents(question, k=<span class="hljs-number">5</span>)
        retrieved_tickets = <span class="hljs-built_in">set</span>([doc.metadata[<span class="hljs-string">'ticket_id'</span>] <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs])
        
        <span class="hljs-comment"># 计算指标</span>
        tp = <span class="hljs-built_in">len</span>(expected_tickets &amp; retrieved_tickets)
        precision = tp / <span class="hljs-built_in">len</span>(retrieved_tickets) <span class="hljs-keyword">if</span> retrieved_tickets <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        recall = tp / <span class="hljs-built_in">len</span>(expected_tickets) <span class="hljs-keyword">if</span> expected_tickets <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        
        metrics[<span class="hljs-string">'precision'</span>].append(precision)
        metrics[<span class="hljs-string">'recall'</span>].append(recall)
    
    <span class="hljs-comment"># 平均值</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"avg_precision"</span>: <span class="hljs-built_in">sum</span>(metrics[<span class="hljs-string">'precision'</span>]) / <span class="hljs-built_in">len</span>(metrics[<span class="hljs-string">'precision'</span>]),
        <span class="hljs-string">"avg_recall"</span>: <span class="hljs-built_in">sum</span>(metrics[<span class="hljs-string">'recall'</span>]) / <span class="hljs-built_in">len</span>(metrics[<span class="hljs-string">'recall'</span>])
    }
</code></pre>
<hr/>
<h3 data-id="heading-27">十、总结</h3>
<p>本文介绍了客服工单系统的RAG检索和问答实现：</p>
<p>✅ <strong>向量检索</strong> - Weaviate相似度搜索<br/>
✅ <strong>Prompt工程</strong> - 动态组装上下文<br/>
✅ <strong>LCEL问答链</strong> - 优雅的链式调用<br/>
✅ <strong>流式问答</strong> - 实时打字机效果<br/>
✅ <strong>响应格式</strong> - 统一的错误处理</p>
<p><strong>下一篇预告：</strong> 《客服工单系统实战（三）：前后端集成与生产部署》</p>
<p>我们将介绍如何将Agent服务集成到完整的前后端系统中，并部署到生产环境。</p>
<hr/>
<p><strong>作者简介：</strong> 资深开发者，创业者。专注于视频通讯技术领域。国内首本Flutter著作《Flutter技术入门与实战》作者,另著有《Dart语言实战》及《WebRTC音视频开发》等书籍。多年从事视频会议、远程教育等技术研发，对于Android、iOS以及跨平台开发技术有比较深入的研究和应用，作为主要程序员开发了多个应用项目，涉及医疗、交通、银行等领域。</p>
<p><strong>学习资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkangshaojun%2Fai-agent-framework" target="_blank" title="https://github.com/kangshaojun/ai-agent-framework" ref="nofollow noopener noreferrer">项目地址</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkangshaojun" target="_blank" title="https://github.com/kangshaojun" ref="nofollow noopener noreferrer">作者GitHub</a></li>
</ul>
<p><strong>欢迎交流：</strong> 如有问题欢迎在评论区讨论 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3天速成 使用AI《从零开发一款 AI 面试作弊助手》一]]></title>    <link>https://juejin.cn/post/7590213554797805603</link>    <guid>https://juejin.cn/post/7590213554797805603</guid>    <pubDate>2026-01-02T15:31:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554797805603" data-draft-id="7590071125398749224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3天速成 使用AI《从零开发一款 AI 面试作弊助手》一"/> <meta itemprop="keywords" content="React.js,Next.js"/> <meta itemprop="datePublished" content="2026-01-02T15:31:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌暴龙战士通关前端"/> <meta itemprop="url" content="https://juejin.cn/user/3373747481880926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3天速成 使用AI《从零开发一款 AI 面试作弊助手》一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3373747481880926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌暴龙战士通关前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T15:31:19.000Z" title="Fri Jan 02 2026 15:31:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、别焦虑了，先把“外挂”做出来</h2>
<p>最近技术圈充满了“前端已死”、“AI 取代程序员”的论调。焦虑是真实的，但大部分焦虑来自“看别人做”，而不是“自己做”。</p>
<p>当你真正动手用 AI 开发一个复杂的<strong>实时交互产品</strong>时，你会发现：AI 很强，但某些细节需要调试和把控。</p>
<p>用AI，三天从 0 开始打造一款<strong>AI 面试作弊助手</strong>。不是 Demo，是能实时听懂面试官提问、能看懂笔试题屏幕、并即时推送答案的“硬核外挂”。</p>
<p>这篇文章，就是这次前端架构的完整复盘。</p>
<p>项目地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.offercar.cn%2F" target="_blank" title="https://www.offercar.cn/" ref="nofollow noopener noreferrer">OfferCar AI - AI 面试笔试助手 | 智能面试模拟平台</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f3241172974993b612b350ae10131c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5pq06b6Z5oiY5aOr6YCa5YWz5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767972678&amp;x-signature=rgMMyztaeioZEVFm5mR%2B9OlePn4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、架构美学：不做通用，做场景</h2>
<p>市面上的 AI 聊天 Demo 满天飞，大多是 <code>useChat</code> 一把梭。但在“面试作弊”这个高压场景下，通用型架构根本扛不住。</p>
<p>我们需要的是<strong>极致的解耦</strong>。</p>
<h3 data-id="heading-2">1. UI 与逻辑的物理隔离</h3>
<p><strong>UI 组件不持有业务状态</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a81417d75f3b4bc98c7b2e2a224035f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5pq06b6Z5oiY5aOr6YCa5YWz5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767972678&amp;x-signature=KyaGB7so9sPOvDY3dtD6p4ZZBPs%3D" alt="image.png" loading="lazy"/></p>
<p>为此抽象了 <code>SessionMainContent</code> —— 它是整个系统的“显示器”。它只负责一件事：<strong>渲染</strong>。</p>
<ul>
<li>它不关心是“面试”还是“笔试”。</li>
<li>它不关心消息是 Socket 推送的还是 HTTP 拉取的。</li>
<li>它只接收 <code>messages</code> 数组和回调函数。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 纯粹的 UI 定义，没有杂乱的 useEffect</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SessionMainContentProps</span> {
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">ChatMessage</span>[];        <span class="hljs-comment">// 数据源</span>
  <span class="hljs-attr">streamingContent</span>: <span class="hljs-built_in">string</span>;       <span class="hljs-comment">// 流式缓冲区</span>
  <span class="hljs-attr">isStreaming</span>: <span class="hljs-built_in">boolean</span>;           <span class="hljs-comment">// 状态位</span>
  <span class="hljs-attr">sendPendingMessagesToAI</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 动作指令</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-3">2. 业务容器：Controller 的诞生</h3>
<p><code>ExamSession</code> 和 <code>InterviewSession</code>。这两个组件是真正的<strong>业务容器</strong>。</p>
<ul>
<li><strong>InterviewSession</strong>：初始化 <code>useInterviewSession</code>，建立语音识别通道，挂载 <code>DeviceStatusPanel</code>（音量监控）。</li>
<li><strong>ExamSession</strong>：初始化 <code>useExamSession</code>，监听全局截图指令，挂载简化版状态栏。</li>
</ul>
<p>这种设计让 MVP 阶段的代码极易维护：改 UI 不动逻辑，改逻辑不崩 UI。</p>
<h2 data-id="heading-4">三、核心大脑：<code>useChatSession</code> 的炼成</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5016cafdf8e4a39b5a76f25d943ed24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM5pq06b6Z5oiY5aOr6YCa5YWz5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767972678&amp;x-signature=C8LN%2BiMI%2FdcWCs1HfhYAeIIJ%2Fvg%3D" alt="image.png" loading="lazy"/>
这是整个前端最“重”的 Hook，也是与 LLM 搏斗的修罗场。在 MVP 阶段，我砍掉了所有花哨功能，只保留<strong>付费闭环</strong>所需的逻辑。</p>
<h3 data-id="heading-5">1. 思考链（CoT）的 60fps 渲染</h3>
<p>现在的 DeepSeek 等推理模型会输出 <code>&lt;think&gt;</code> 标签。如果直接渲染，用户会看到一堆乱码；如果等思考完再显示，用户会以为网断了。</p>
<p>我的解法：<strong>流式解析 + 渲染节流</strong>。</p>
<p>我们实现了一个 <code>thinkTagProcessor</code>，实时将 <code>&lt;think&gt;</code> 转换为 Markdown 的引用块 <code>&gt; </code>。同时，为了防止高频 <code>setState</code> 导致 React 掉帧（尤其在低端笔记本上），我加入了 <code>requestAnimationFrame</code> 节流。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 节流阀：让 AI 的思考过程如丝般顺滑，而不是卡顿的打印机</span>
<span class="hljs-keyword">const</span> tickThinkThrottle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isThinkRafRunningRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-title function_">setStreamingContent</span>(remainTextRef.<span class="hljs-property">current</span>); <span class="hljs-comment">// 只有这里才会触发重绘</span>
  thinkRafIdRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(tickThinkThrottle);
}, []);
</code></pre>
<h3 data-id="heading-6">2. 消息围栏：只听面试官的话</h3>
<p>面试场景有一个痛点：面试者的废话太多。如果全发给 AI，上下文瞬间爆炸。</p>
<p>我在 <code>sendPendingMessagesToAI</code> 中加入了一层<strong>过滤器</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> sendPendingMessagesToAI = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> pendingMessages = messages.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-comment">// 开启 scopeCharacter 后，AI 自动屏蔽面试者发言，只聚焦面试官的问题</span>
    <span class="hljs-keyword">if</span> (scopeCharacter) {
      <span class="hljs-keyword">return</span> msg.<span class="hljs-property">speaker</span> === <span class="hljs-string">'interviewer'</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
  <span class="hljs-comment">// ...</span>
}, [<span class="hljs-comment">/*...*/</span>]);
</code></pre>
<p>这不仅仅是省 Token，更是为了<strong>提高回答的信噪比</strong>。</p>
<h2 data-id="heading-7">四、降维打击：WebRTC 的另类用法</h2>
<p>提到 WebRTC，大家第一反应是视频通话。但在我的架构里，WebRTC 是<strong>跨端通信的高速公路</strong>。</p>
<p>这是典型的“技术降维打击”。我们不需要视频流，我们需要的是<strong>低延迟的指令通道</strong>。</p>
<h3 data-id="heading-8">1. DataChannel：不传视频传指令</h3>
<p>我利用 WebRTC 的 <code>DataChannel</code> 建立了两个核心管道：</p>
<ul>
<li><strong><code>exam-commands</code></strong>：传输控制指令。Electron 截图后，通过此通道直接将 Base64 推送到 Web 端，速度毫秒级。</li>
<li><strong><code>recognition-text</code></strong>：传输实时语音转写文本。</li>
</ul>
<p>这种设计避开了传统 HTTP 轮询的延迟，也比 WebSocket 更轻量（P2P 直连）。</p>
<pre><code class="hljs language-typescript:hooks.ts" lang="typescript:hooks.ts">// 监听来自 Electron 的“量子纠缠”信号
channel.onmessage = (event) =&gt; {
  const message = JSON.parse(event.data);
  if (message.type === 'screenshot') {
    // 瞬间上屏，无感知传输
    addImageToPendingMessages(message.data);
  }
};
</code></pre>
<h2 data-id="heading-9">五、体验微操：Redux 配置中心</h2>
<p>UI/UX 的作用是什么？是**“显得值钱”**。</p>
<p>为了让用户觉得“这个外挂很专业”，我用 Redux Toolkit (<code>settingsSlice</code>) 管理了全局偏好：</p>
<ul>
<li><strong>字号微调</strong>：AI 回答字号、面试官字号独立控制。</li>
<li><strong>双语开关</strong>：一键切换中英对照，瞬间提升逼格。</li>
</ul>
<p>这些配置在 <code>SessionMainContent</code> 中被实时订阅。用户拖动滑块，界面即时响应。这种<strong>掌控感</strong>，是付费意愿的来源之一。</p>
<h2 data-id="heading-10">六、结语：AI 时代，拿回你的生产资料</h2>
<p>写到这里，我想说：代码只是工具，是连接现实与数字世界的铲子。AI 让这把铲子变成了挖掘机，但挖掘机本身不会决定去哪里挖掘宝藏。</p>
<p>在这个项目里，AI 帮我生成了100% 的 业务逻辑。
别焦虑，去创造。打开编辑器，去想一个你真正想解决的问题。
项目地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.offercar.cn%2F" target="_blank" title="https://www.offercar.cn/" ref="nofollow noopener noreferrer">OfferCar AI - AI 面试笔试助手 | 智能面试模拟平台</a></p>
<p>下一篇，我们将深入 Electron 客户端，看看如何进入系统音频流，实现无感采集。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[十分钟入门SpringAI]]></title>    <link>https://juejin.cn/post/7590654280899592235</link>    <guid>https://juejin.cn/post/7590654280899592235</guid>    <pubDate>2026-01-02T15:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280899592235" data-draft-id="7590020026395410486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="十分钟入门SpringAI"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-02T15:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天道佩恩"/> <meta itemprop="url" content="https://juejin.cn/user/536217406931069"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            十分钟入门SpringAI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217406931069/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天道佩恩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T15:52:07.000Z" title="Fri Jan 02 2026 15:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>SpringAI，Make Java great again</p>
<p>还得是Spring啊，Java开发一辈子都得熟练掌握的框架，SpringAI帮你对接多个AI模型，屏蔽底层复杂的处理，使用抽象、统一的接口，切换模型只需更改配置，无需改代码，十分钟入门 Java-AI开发，接下来开始上课！上一篇介绍了本地下载Ollama，本期不再赘述，但是需要开启本地Ollama</p>
<p>众所周知，Spring框架开发三部曲，导入依赖，编写配置，编写业务代码， SpringAI也是如此</p>
<h2 data-id="heading-1">导入依赖</h2>
<p>SpringAI支持的jdk最低版本为17，spring-boot最低版本3.x</p>
<p><strong>PS：以下的 dependencyManagement 是帮忙管理 spring-ai 相关依赖的，非常重要，一定要带上</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai.version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
​
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">编写配置</h2>
<p>有2个配置，application.yml 和 Configuration</p>
<h3 data-id="heading-3">application.yml</h3>
<p>主要是模型，访问地址，日志输出;</p>
<p>1.11434 是 Ollama 默认端口</p>
<p>2.model 就是本地启动的 AI 模型，模型名称大小写敏感，注意别写错</p>
<p>3.设置日志输出级别，还要在 Bean 上配置 Advisor，设置 level 最好是精确到包，否则日志太多</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">springai</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://localhost:11434</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:8b</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.springframework.ai.chat.client.advisor:</span> <span class="hljs-string">debug</span>
    <span class="hljs-attr">com.pain.springai:</span> <span class="hljs-string">debug</span>
</code></pre>
<h2 data-id="heading-4">配置Configuration</h2>
<p>defaultSystem：系统配置，可以设定角色</p>
<p>defaultAdvisor：日志增强器</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;
<span class="hljs-keyword">import</span> org.springframework.ai.ollama.OllamaChatModel;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Configuration;
​
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonConfig</span> {
​
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClient  chatClient(OllamaChatModel model){
        <span class="hljs-keyword">return</span> ChatClient.builder(model)
                .defaultSystem(<span class="hljs-string">"你是高傲冷酷的天道佩恩，请以天道佩恩的身份和语气回答问题"</span>)
                .defaultAdvisors(new SimpleLoggerAdvisor())
                .build();
    }
}
</code></pre>
<h2 data-id="heading-5">业务代码</h2>
<p>写一个Controller，注入ChatClient，然后就可以对话了</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.client.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.<span class="hljs-keyword">annotation</span>.RestController;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;
​
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/ai"</span>)</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;
​
    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/chat"</span>)</span>
    <span class="hljs-keyword">public</span> String chat(String prompt) {
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .user(prompt)
                .call()
                .content();
    }
​
    <span class="hljs-meta">@RequestMapping(value = <span class="hljs-string">"/chat/flux"</span>, produces = <span class="hljs-string">"text/html;charset=utf-8"</span>)</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; fluxChat(String prompt) {
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .user(prompt)
                .stream()
                .content();
    }
}
</code></pre>
<p>默认服务器的端口是8080，拼接一下端口访问：<a href="https://link.juejin.cn?target=url" target="_blank" title="url" ref="nofollow noopener noreferrer">http:localhost:8080/ai/chat </a><br/>
访问服务器</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73521af68408461ca09b41f42cce47bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6YGT5L2p5oGp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767973927&amp;x-signature=wvo2mzej%2B7X9ivNXu%2Btr4CLZzU8%3D" alt="图片" loading="lazy"/><br/>
日志输出</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3edf7b2ae40746cd9439faca68fa6174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6YGT5L2p5oGp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767973927&amp;x-signature=G8HZukCE3%2BT9XFRtoh0MIRXhW5c%3D" alt="图片" loading="lazy"/></p>
<p>下一篇带你们更深入的了解SpringAI强大的功能</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 仓库过滤敏感信息，通过配置 clean/smudge 过滤器的方式]]></title>    <link>https://juejin.cn/post/7590654280899526699</link>    <guid>https://juejin.cn/post/7590654280899526699</guid>    <pubDate>2026-01-02T13:28:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280899526699" data-draft-id="7590011643297251366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 仓库过滤敏感信息，通过配置 clean/smudge 过滤器的方式"/> <meta itemprop="keywords" content="后端,前端,GitHub"/> <meta itemprop="datePublished" content="2026-01-02T13:28:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GentlyBeing"/> <meta itemprop="url" content="https://juejin.cn/user/543573892409056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 仓库过滤敏感信息，通过配置 clean/smudge 过滤器的方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/543573892409056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GentlyBeing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T13:28:38.000Z" title="Fri Jan 02 2026 13:28:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><hr/>
<p>有没有遇到过这种困扰？本地配置文件里藏着数据库密码、密钥等敏感信息，一不小心就提交到 Git 仓库了，既不安全又容易泄露隐私。</p>
<p>今天就给大家分享 Git 仓库脱敏方法，重点讲在开发过程中最实用的「Git 内置过滤器」方案——不用改代码、不用手动改配置，提交自动脱敏、拉取自动还原，全程无感操作。</p>
<h2 data-id="heading-0">一、先搞懂核心需求：本地能用，仓库安全</h2>
<p><strong>目标</strong>很简单：</p>
<ul>
<li>本地开发时，能用到完整的配置（含敏感信息），不影响正常开发；</li>
<li>提交到 Git 仓库时，敏感信息自动变成占位符，不会泄露；</li>
<li>最好自动化，不用每次提交前手动改配置，省事。</li>
</ul>
<blockquote>
<p>💡<strong>提前划重点</strong>：</p>
<p>下面 3 种方法里，优先选「方法 3：Git 内置过滤器」。前两种适合已开发完的项目，过滤器方案适合正在开发的项目，零侵入还省心。</p>
</blockquote>
<h3 data-id="heading-1">3 种脱敏方法对比</h3>
<h4 data-id="heading-2">方法 1：创建配置模板文件（简单但繁琐）</h4>
<p>比如，有个配置文件叫 <code>settings.yaml</code>，里面有敏感信息。做法很简单：</p>
<ol>
<li>复制一份 <code>settings.yaml</code>，改名叫 <code>settings_example.yaml</code>；</li>
<li>手动把 <code>settings_example.yaml</code> 里的敏感信息删掉（比如把密码改成 <code>xxxxxx</code>），作为模板给团队参考；</li>
<li>在 <code>.gitignore</code> 里加一行<code>settings.yaml</code>，让 Git 忽略这个真实配置文件，避免提交。</li>
</ol>
<p>缺点：每次新增配置项，都要手动同步模板文件，团队协作时容易漏更。</p>
<h4 data-id="heading-3">方法 2：把敏感信息存到环境变量（脱离项目但需额外配置）</h4>
<p>核心思路：把密码、密钥这些敏感信息，存到电脑的「环境变量」里（和项目分开），项目里只留“占位符”。</p>
<p>举个例子， <code>settings.yaml</code> 可以写成这样：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">database:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">${DB_HOST}</span>  <span class="hljs-comment"># 占位符：本地环境变量里找 DB_HOST</span>
  <span class="hljs-attr">username:</span> <span class="hljs-string">${DB_USER}</span>  <span class="hljs-comment"># 占位符：本地环境变量里找 DB_USER</span>
  <span class="hljs-attr">password:</span> <span class="hljs-string">${DB_PASSWORD}</span>  <span class="hljs-comment"># 敏感密码：从环境变量读取</span>
<span class="hljs-attr">secret:</span>
  <span class="hljs-attr">token_key:</span> <span class="hljs-string">${TOKEN_SECRET}</span>  <span class="hljs-comment"># 密钥：从环境变量读取</span>
</code></pre>
<p>缺点：每个开发者都要手动在自己电脑上配置环境变量，新成员加入时步骤多，容易配错。</p>
<h4 data-id="heading-4">方法 3：Git 内置过滤器（自动化首选）</h4>
<p>这是 Git 自带的功能，相当于给配置文件加了“自动开关”：</p>
<ul>
<li>提交代码时（git add）：触发 <code>clean</code> 过滤器，自动把敏感信息换成占位符；</li>
<li>拉取代码时（git pull）：触发<code>smudge</code> 过滤器，自动把占位符换回本地的真实敏感信息。</li>
</ul>
<p>优点：不用改项目代码、不用装额外工具，开发者完全不用管，提交/拉取全程自动处理，不影响开发效率。</p>
<h2 data-id="heading-5">二、自动化配置过滤器脚本（直接用）</h2>
<p>手动配置过滤器步骤有点多，我写了个脚本，一键就能搞定所有配置。不想看手动步骤的朋友，直接用这个脚本就行！</p>
<p>当然，若读者对手动配置感兴趣，又或想了解脚本的工作原理，可跳过此部分，往后阅读：。</p>
<h3 data-id="heading-6">使用步骤（超简单）</h3>
<ol>
<li>打开你的 Git 项目根目录（就是和 <code>.git</code> 文件夹同级的目录）；</li>
<li>新建一个文件，命名为 <code>git_desensitize.sh</code>；</li>
<li>把下面的代码复制粘贴进去；</li>
<li>执行命令：<code>bash git_desensitize.sh</code>，等待脚本执行完成。</li>
</ol>
<p>后续在其他地方拉取项目，只需把原项目的 <code>.git/config</code> 文件复制过去，删除要复原的「需脱敏文件」（如之前的 settings.yaml），再执行 <code>git checkout-index --all --force</code> 就能恢复本地配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17adf1a16c234d11aba536f5eccf1e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2VudGx5QmVpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767974024&amp;x-signature=It1bS9Din%2FKZKvZ7kOgN%2BfJjvt0%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># ==============================================================</span>
<span class="hljs-comment"># Git 配置文件全自动脱敏脚本</span>
<span class="hljs-comment"># 使用说明：1.修改顶部【配置区】的files和fields </span>
<span class="hljs-comment">#          2.执行脚本：bash git_desensitize.sh</span>
<span class="hljs-comment"># 核心特性：一键生成clean/smudge过滤器 + 绑定.gitattributes</span>
<span class="hljs-comment"># ==============================================================</span>
​
<span class="hljs-comment"># ========== 【唯一配置区】 ==========</span>
<span class="hljs-comment"># 要脱敏的文件列表</span>
files=(
  <span class="hljs-string">"settings.yaml"</span>
  <span class="hljs-comment"># "src/config/.env"</span>
  <span class="hljs-comment"># "application.yml"</span>
)
​
<span class="hljs-comment"># 要脱敏的字段名列表</span>
fields=(
  <span class="hljs-string">"password"</span>
  <span class="hljs-string">"secret"</span>
  <span class="hljs-string">"issuer"</span>
  <span class="hljs-string">"addr"</span>
  <span class="hljs-string">"host"</span>
  <span class="hljs-string">"port"</span>
  <span class="hljs-string">"ip"</span>
  <span class="hljs-string">"domain"</span>
  <span class="hljs-string">"send_email"</span>
  <span class="hljs-string">"app_key"</span>
  <span class="hljs-string">"access_key"</span>
  <span class="hljs-string">"secret_key"</span>
)
​
<span class="hljs-comment"># ========== 【常量定义】 ==========</span>
FILTER_NAME=<span class="hljs-string">"auto_sensitive_filter"</span>          <span class="hljs-comment"># Git过滤器名称</span>
GIT_ATTRIBUTES=<span class="hljs-string">".gitattributes"</span>              <span class="hljs-comment"># 绑定文件名称</span>
BASE_PLACEHOLDER=<span class="hljs-string">"******"</span>                    <span class="hljs-comment"># 占位符基础前缀</span>
​
<span class="hljs-comment"># ========== 【0.前置一键校验】 ==========</span>
<span class="hljs-function"><span class="hljs-title">check_env</span></span>(){
  [ ! -d <span class="hljs-string">".git"</span> ] &amp;&amp; <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[31m请在Git项目根目录执行！\033[0m"</span> &amp;&amp; <span class="hljs-built_in">exit</span> 1
  [ ! $(<span class="hljs-built_in">command</span> -v git) ] &amp;&amp; <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[31m未检测到Git环境！\033[0m"</span> &amp;&amp; <span class="hljs-built_in">exit</span> 1
  [ ! $(<span class="hljs-built_in">command</span> -v sed) ] &amp;&amp; <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[31m未检测到sed命令！\033[0m"</span> &amp;&amp; <span class="hljs-built_in">exit</span> 1
} &amp;&amp; check_env
​
<span class="hljs-comment"># ========== 【1.扫描提取敏感值+去重+生成映射】 ==========</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\033[36m===== 扫描目标文件，提取敏感值 =====\033[0m"</span>
<span class="hljs-built_in">declare</span> -A FIELD_COUNTER                     <span class="hljs-comment"># 字段计数器：记录每个字段有效序号</span>
<span class="hljs-built_in">declare</span> -a VALUE_MAPPING                     <span class="hljs-comment"># 核心映射表：存储 原始值|字段名|序号</span>
<span class="hljs-built_in">declare</span> -A DUPLICATE_CHECK_MAP               <span class="hljs-comment"># 去重校验MAP：key=字段名_原始值，实现双重去重</span>
​
<span class="hljs-comment"># 初始化字段计数器</span>
<span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${fields[@]}</span>"</span>; <span class="hljs-keyword">do</span>
  FIELD_COUNTER[<span class="hljs-variable">$field</span>]=0
<span class="hljs-keyword">done</span>
​
<span class="hljs-comment"># 遍历所有目标文件</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${files[@]}</span>"</span>; <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\033[33m文件 <span class="hljs-variable">$file</span> 不存在，跳过\033[0m"</span>
    <span class="hljs-built_in">continue</span>
  <span class="hljs-keyword">fi</span>
​
  <span class="hljs-comment"># 遍历所有脱敏字段</span>
  <span class="hljs-keyword">for</span> field <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${fields[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    all_origin_values=$(sed -n <span class="hljs-string">"s/^[[:space:]]*<span class="hljs-variable">${field}</span>[[:space:]]*[:=][[:space:]]*["</span><span class="hljs-string">']*(.*)["'</span>]*[[:space:]]*$/\1/p<span class="hljs-string">" "</span><span class="hljs-variable">$file</span><span class="hljs-string">")
    
    # 遍历所有提取到的原始值
    while IFS= read -r origin_value; do
      if [ -z "</span><span class="hljs-variable">$origin_value</span><span class="hljs-string">" ]; then
        continue
      fi
      
      # 去重：字段名+原始值 作为KEY，完全一致则判定为重复
      unique_check_key="</span><span class="hljs-variable">${field}</span>_<span class="hljs-variable">${origin_value}</span><span class="hljs-string">"
      if [[ -n "</span><span class="hljs-variable">${DUPLICATE_CHECK_MAP[$unique_check_key]}</span><span class="hljs-string">" ]]; then
        echo -e "</span>\033[33m重复：<span class="hljs-variable">$file</span> -&gt; <span class="hljs-variable">$field</span> = <span class="hljs-variable">$origin_value</span>\033[0m<span class="hljs-string">"
        continue
      fi
​
      # 非重复数据：序号自增 + 标记去重KEY + 存入映射表
      ((FIELD_COUNTER[<span class="hljs-variable">$field</span>]++))
      seq_num=<span class="hljs-variable">${FIELD_COUNTER[$field]}</span>
      DUPLICATE_CHECK_MAP[<span class="hljs-variable">$unique_check_key</span>]=1
      VALUE_MAPPING+=("</span><span class="hljs-variable">$origin_value</span>|<span class="hljs-variable">$field</span>|<span class="hljs-variable">$seq_num</span><span class="hljs-string">")
      echo -e "</span>\033[32m提取：<span class="hljs-variable">$file</span> -&gt; $field<span class="hljs-variable">$seq_num</span> = <span class="hljs-variable">$origin_value</span>\033[0m<span class="hljs-string">"
    done &lt;&lt;&lt; "</span><span class="hljs-variable">$all_origin_values</span><span class="hljs-string">"
  done
done
​
# 校验是否成功获取到原始值
if [ <span class="hljs-variable">${#VALUE_MAPPING[@]}</span> -eq 0 ]; then
  echo -e "</span>\033[31m错误：未扫描到任何有效字段值\033[0m<span class="hljs-string">"
  exit 1
fi
​
# ========== 【2.生成clean/smudge规则】 ==========
echo -e "</span>\n\033[36m===== 生成clean/smudge规则 =====\033[0m<span class="hljs-string">"
CLEAN_RULE="</span><span class="hljs-string">"
SMUDGE_RULE="</span><span class="hljs-string">"
​
for item in "</span><span class="hljs-variable">${VALUE_MAPPING[@]}</span><span class="hljs-string">"; do
  # 解析映射项：原始值|字段名|序号
  val=<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$item</span>"</span> | cut -d'|' -f1)</span>
  field=<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$item</span>"</span> | cut -d'|' -f2)</span>
  num=<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$item</span>"</span> | cut -d'|' -f3)</span>
  placeholder="</span><span class="hljs-variable">${BASE_PLACEHOLDER}</span>_<span class="hljs-variable">${field}</span><span class="hljs-variable">${num}</span><span class="hljs-string">"
  
  # 转义所有特殊字符
  val_esc=<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$val</span>"</span> | sed 's/[/*$&amp;|]/\&amp;/g')</span>
  ph_esc=<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$placeholder</span>"</span> | sed 's/[/*$&amp;|]/\&amp;/g')</span>
  
  # 生成sed规则：将原始值替换为占位符
  CLEAN_RULE+="</span> -e <span class="hljs-string">'s/${val_esc}/${ph_esc}/g'</span><span class="hljs-string">"
  SMUDGE_RULE+="</span> -e <span class="hljs-string">'s/${ph_esc}/${val_esc}/g'</span><span class="hljs-string">"
done
​
echo -e "</span>\033[32m生成<span class="hljs-variable">${#VALUE_MAPPING[@]}</span>条\033[0m<span class="hljs-string">"
​
# ========== 【3.配置Git全局过滤器】 ==========
echo -e "</span>\n\033[36m===== 配置Git全局过滤器 =====\033[0m<span class="hljs-string">"
# 发起配置命令
git config filter.<span class="hljs-variable">$FILTER_NAME</span>.clean "</span>sed <span class="hljs-variable">$CLEAN_RULE</span><span class="hljs-string">"
git config filter.<span class="hljs-variable">$FILTER_NAME</span>.smudge "</span>sed <span class="hljs-variable">$SMUDGE_RULE</span><span class="hljs-string">"
git config filter.<span class="hljs-variable">$FILTER_NAME</span>.required true
​
# 检查配置是否成功
filter_check=<span class="hljs-subst">$(git config --get filter.$FILTER_NAME.clean)</span>
smudge_check=<span class="hljs-subst">$(git config --get filter.$FILTER_NAME.smudge)</span>
required_check=<span class="hljs-subst">$(git config --get filter.$FILTER_NAME.required)</span>
if [ -n "</span><span class="hljs-variable">$filter_check</span><span class="hljs-string">" ] &amp;&amp; [ -n "</span><span class="hljs-variable">$smudge_check</span><span class="hljs-string">" ] &amp;&amp; [ "</span><span class="hljs-variable">$required_check</span><span class="hljs-string">" = "</span><span class="hljs-literal">true</span><span class="hljs-string">" ]; then
  echo -e "</span>\033[32m配置成功\033[0m<span class="hljs-string">"
else
  echo -e "</span>\033[31m过滤器配置失败，请手动执行脚本内命令\033[0m<span class="hljs-string">"
  exit 1
fi
​
# ========== 【4.绑定文件到.gitattributes】 ==========
echo -e "</span>\n\033[36m===== 绑定文件过滤规则 =====\033[0m<span class="hljs-string">"
for file in "</span><span class="hljs-variable">${files[@]}</span><span class="hljs-string">"; do
  if ! grep -q "</span>^<span class="hljs-variable">${file}</span>[[:space:]]*filter=<span class="hljs-variable">${FILTER_NAME}</span>$<span class="hljs-string">" <span class="hljs-variable">$GIT_ATTRIBUTES</span> 2&gt;/dev/null; then
    echo "</span><span class="hljs-variable">${file}</span> filter=<span class="hljs-variable">${FILTER_NAME}</span><span class="hljs-string">" &gt;&gt; <span class="hljs-variable">$GIT_ATTRIBUTES</span>
    echo -e "</span>\033[32m绑定：<span class="hljs-variable">$file</span> -&gt; <span class="hljs-variable">$FILTER_NAME</span>\033[0m<span class="hljs-string">"
  else
    echo -e "</span>\033[33m提示：<span class="hljs-variable">$file</span> 已存在过滤规则\033[0m<span class="hljs-string">"
  fi
done
​
git add <span class="hljs-variable">$GIT_ATTRIBUTES</span>
echo -e "</span>\033[32m修改成功：<span class="hljs-variable">$GIT_ATTRIBUTES</span>\033[0m<span class="hljs-string">"
​
​
# ========== 【5.重新追踪应用】 ==========
echo -e "</span>\n\033[36m===== 重新追踪文件 =====\033[0m<span class="hljs-string">"
for file in "</span><span class="hljs-variable">${files[@]}</span><span class="hljs-string">"; do
  if [ -f "</span><span class="hljs-variable">$file</span><span class="hljs-string">" ]; then
  if git diff --cached --quiet "</span><span class="hljs-variable">$file</span><span class="hljs-string">" &gt;/dev/null 2&gt;&amp;1; then
     git rm -r --cached "</span><span class="hljs-variable">$file</span><span class="hljs-string">"
  fi
    git add "</span><span class="hljs-variable">$file</span><span class="hljs-string">"
  fi
done
​
echo -e "</span>\033[32m完成\033[0m<span class="hljs-string">"
exit 0
</span></code></pre>
<h2 data-id="heading-7">三、想了解原理？手动配置步骤</h2>
<p>如果想搞懂背后的原理，或者需要自定义配置，可以跟着下面的步骤手动操作。</p>
<p>其实核心就 3 步：配置过滤器、绑定文件、验证效果。</p>
<h3 data-id="heading-8">第一步：配置过滤器</h3>
<p>推荐只让过滤器在当前项目生效（避免影响其他项目），操作很简单：</p>
<ol>
<li>打开项目里的<code>.git</code> 文件夹（这个文件夹是隐藏的，需要显示隐藏文件）；</li>
<li>找到 <code>config</code> 文件，用记事本或编辑器打开；</li>
<li>在文件末尾添加下面的内容：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[filter "sensitive_filter"]</span>  <span class="hljs-comment"># 过滤器名字，自己随便起，后面要用到</span>
    <span class="hljs-attr">clean</span> = sed -e <span class="hljs-string">'s/123456/****_pwd1/g'</span> -e <span class="hljs-string">'s/666123/****_pwd2/g'</span>
    <span class="hljs-attr">smudge</span> = sed -e <span class="hljs-string">'s/****_pwd1/123456/g'</span> -e <span class="hljs-string">'s/****_pwd2/666123/g'</span>
    <span class="hljs-attr">required</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>解释下这几行的意思（理解就行）：</p>
<ul>
<li><code>s/原内容/替换内容/g</code>：sed 的替换语法，<code>s</code> 表示文本替换，<code>g</code> 表示全局匹配替换（出现多次全都替换）；</li>
<li><code>clean = ...</code>：提交时执行的命令，把真实密码（比如 <code>123456</code>）换成占位符（比如 <code>****_pwd1</code>）；</li>
<li><code>smudge = ...</code>：拉取时执行的命令，把占位符（<code>****_pwd1</code>）换回真实值（<code>123456</code>）；</li>
<li><code>-e</code>：可以拼接多个替换规则，比如同时替换密码和密钥（支持正则表达式）；</li>
</ul>
<blockquote>
<p>💡<strong>注意</strong>：</p>
<p><code>.git/config</code> 是本地文件，不会提交到远程仓库！</p>
<p>团队其他成员需要在自己的本地项目里，也配置这个文件（可以把你的 config 文件发给他们复制）。</p>
</blockquote>
<blockquote>
<p>👀<strong>细心的你有没有发现？</strong></p>
<p>这样写配置，如果要脱敏的字段很多，那就要重复写很长的一串规则啊！</p>
<p>还是用我写的自动脚本吧~~！</p>
</blockquote>
<h4 data-id="heading-9">补充做法</h4>
<ol>
<li>
<p>想让 git 全局项目都生效，那就要修改 Git 全局配置文件 <code>.gitconfig</code>；一般windows 的 git 全局配置文件位置为 <code>C:\Users\你的用户名.gitconfig</code>；</p>
</li>
<li>
<p>也可以用命令行进行配置</p>
<ul>
<li>
<p>全局配置生效：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 配置 clean 过滤器</span>
git config --<span class="hljs-keyword">global</span> <span class="hljs-built_in">filter</span>.sensitive_filter.clean <span class="hljs-string">"sed -e 's/123456/****_pwd1/g' -e 's/666123/****_pwd2/g'"</span>
​
<span class="hljs-comment"># 配置 smudge 过滤器</span>
git config --<span class="hljs-keyword">global</span> <span class="hljs-built_in">filter</span>.sensitive_filter.smudge <span class="hljs-string">"sed -e 's/****_pwd1/123456/g' -e 's/****_pwd2/666123/g'"</span>
​
<span class="hljs-comment"># 强制生效：无过滤规则则拒绝提交/拉取</span>
git config --<span class="hljs-keyword">global</span> <span class="hljs-built_in">filter</span>.sensitive_filter.required true
</code></pre>
<ul>
<li><code>filter.sensitive_filter.clean</code>：此处第二段的 <code>sensitive_filter</code> 是自定义过滤器名称。</li>
</ul>
</li>
<li>
<p>仅当前项目配置生效：去掉参数 <code>--global</code> 即可。</p>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">第二步：创建 .gitattributes 文件（告诉Git哪些文件要过滤）</h3>
<p>我们需要创建一个 <code>.gitattributes</code> 文件，告诉 Git“哪些文件需要用上面配置的过滤器”。这个文件要提交到仓库，让团队所有人都能用同样的规则。</p>
<ol>
<li>在项目根目录新建文件，命名为 <code>.gitattributes</code>；</li>
<li>写入下面的内容（根据你的配置文件调整）：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 格式：【需要过滤的文件】 filter=过滤器名称</span>
​
<span class="hljs-comment"># 单文件精准匹配（推荐，精准脱敏）</span>
settings.yaml <span class="hljs-attr">filter</span>=sensitive_filter
​
<span class="hljs-comment"># 通配符匹配（批量脱敏，适合同类型配置文件）</span>
*.yml <span class="hljs-attr">filter</span>=sensitive_filter
​
<span class="hljs-comment"># 排除不需要过滤的文件（可选）</span>
README.md !filter
​
<span class="hljs-comment"># 注意：过滤器名称 `sensitive_filter` 必须和步骤 1 中配置的完全一致（大小写敏感）</span>
</code></pre>
<p>写完后，执行下面的命令提交这个文件：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">add</span> .gitattributes
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "添加敏感文件过滤规则"
</code></pre>
<h3 data-id="heading-11">第三步：验证配置是否成功</h3>
<p>查看已配置的过滤规则，执行以下命令查看：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看全局过滤器配置</span>
git config --<span class="hljs-keyword">global</span> --<span class="hljs-keyword">get</span>-regexp filter
​
<span class="hljs-meta"># 查看当前项目过滤器配置</span>
git config --<span class="hljs-keyword">get</span>-regexp filter
​
<span class="hljs-meta"># 查看所有 Git 配置（含过滤器）</span>
git config --list
</code></pre>
<h3 data-id="heading-12">第四步：使用验证</h3>
<p>如果你的配置文件之前已经被 Git 追踪过（比如已经提交过），需要先把它从 Git 暂存区移除（不会删除本地文件）：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">rm</span> --cached <span class="hljs-string">"被脱敏文件的地址"</span>
</code></pre>
<p>然后验证脱敏效果：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 将文件加入暂存区（触发 clean 脱敏）</span>
git <span class="hljs-keyword">add</span> <span class="hljs-string">"被脱敏文件的地址"</span>
​
<span class="hljs-meta"># 查看暂存区中文件的脱敏效果</span>
git diff --cached <span class="hljs-string">"被脱敏文件的地址"</span>
​
<span class="hljs-meta"># 提交到本地仓库</span>
git commit -m <span class="hljs-string">"feat: 提交脱敏后的配置文件"</span>
</code></pre>
<h3 data-id="heading-13">补充：用正则实现“任意敏感值自动脱敏”</h3>
<p>如果你的配置文件里敏感值经常变，不想每次都手动加替换规则，可以用正则表达式写 clean 规则，实现“只要是某个字段，就自动替换成占位符”。</p>
<p>比如这样配置过滤器：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[filter "sensitive_filter"]</span>
    <span class="hljs-attr">clean</span> = sed -e <span class="hljs-string">'s/(password:\s*).*/\1******/g'</span> -e <span class="hljs-string">'s/(secret:\s*).*/\2******/g'</span> -e <span class="hljs-string">'s/(token:\s*).*/\1******/g'</span>
    <span class="hljs-attr">smudge</span> = sed -e <span class="hljs-string">'s/password: 1******/password: my_db_pass_123/g'</span> -e <span class="hljs-string">'s/secret: 2******/secret: my_jwt_7890/g'</span>
    <span class="hljs-attr">required</span> = <span class="hljs-literal">true</span>
</code></pre>
<p>说明：这种方式适合敏感字段固定，但值经常变的场景，不过 smudge 规则还是要手动维护真实值，不如自动化脚本省心。</p>
<h2 data-id="heading-14">四、总结一下</h2>
<p>如果是正在开发的项目，优先用「Git 内置过滤器」+「自动化脚本」，一键配置，全程自动脱敏/还原，不影响开发；如果是已开发完的项目，用模板文件或环境变量的方式更简单。</p>
<p>核心原则就是：敏感信息只留在本地，仓库里只存脱敏后的内容，既安全又省心！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch：在 Streams 中使用 ML 自动化 log 解析]]></title>    <link>https://juejin.cn/post/7589940210832506923</link>    <guid>https://juejin.cn/post/7589940210832506923</guid>    <pubDate>2026-01-03T01:51:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589940210832506923" data-draft-id="7590020026395492406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch：在 Streams 中使用 ML 自动化 log 解析"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-03T01:51:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch：在 Streams 中使用 ML 自动化 log 解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T01:51:28.000Z" title="Sat Jan 03 2026 01:51:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fnastia-havriushenko" title="https://www.elastic.co/search-labs/author/nastia-havriushenko" target="_blank" ref="nofollow noopener noreferrer">Nastia Havriushenko</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e843b17925e242e185dd66e6eedecd4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768009888&amp;x-signature=S0dr2cF7VlTFkkPYi%2Fa0Xj73PEk%3D" alt="" loading="lazy"/></p>
<p>了解一种混合 ML 方法如何通过在 Streams 中使用 log 格式指纹识别的自动化实验，实现 94% 的 log 解析准确率和 91% 的 log 分区准确率。</p>
<p>无缝连接领先的 AI 和 machine learning 平台。开始一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration" title="https://cloud.elastic.co/registration" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud 试用</a>来探索 Elastic 的 gen AI 能力，或者现在就在你的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">机器</a>上试用。</p>
<p>在现代可观测性技术栈中，将来自不同数据提供方的非结构化 log 摄取到像 Elasticsearch 这样的平台仍然是一个挑战。依赖手工编写的解析规则会产生脆弱的管道，即使上游代码的轻微更新也会导致解析失败和数据无法被索引。这种脆弱性还因可扩展性问题而加剧：在动态的 microservices 环境中，不断新增的新服务使得手动维护规则变成一场运维噩梦。</p>
<p>我们的目标是转向一种自动化、可自适应的方法，能够同时处理 log 解析（字段提取）和 log 分区（来源识别）。我们假设，大语言模型 LLMs 凭借其对代码语法和语义模式的内在理解，可以在几乎不需要人工干预的情况下自动完成这些任务。</p>
<h2 data-id="heading-0">数据集描述</h2>
<p>我们选择了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flogpai%2Floghub" title="https://github.com/logpai/loghub" target="_blank" ref="nofollow noopener noreferrer">Loghub</a> 的 log 集合作为 PoC 的数据来源。在本次研究中，我们从以下关键领域选择了具有代表性的样本：</p>
<ul>
<li><strong>分布式系统</strong>：我们使用了 HDFS（Hadoop Distributed File System）和 Spark 数据集。这些数据集包含了典型的大数据平台中的 info、debug 和 error 消息。</li>
<li><strong>服务器和 web 应用</strong>：来自 Apache web 服务器和 OpenSSH 的 logs 提供了大量访问、错误以及与安全相关的事件。这些对于监控 web 流量和检测潜在威胁至关重要。</li>
<li><strong>操作系统</strong>：我们包含了 Linux 和 Windows 的 logs。这些数据集代表了运维团队日常遇到的常见、半结构化的系统级事件。</li>
<li><strong>移动系统</strong>：为了确保我们的模型能够处理来自移动环境的 logs，我们加入了 Android 数据集。这些 logs 通常非常冗长，记录了移动设备上大量应用级和系统级活动。</li>
<li><strong>超级计算机</strong>：为了测试在高性能计算 HPC 环境下的表现，我们引入了 BGL（Blue Gene/L）数据集。该数据集包含高度结构化的 logs，并带有特定领域的术语。</li>
</ul>
<p>Loghub 集合的一个关键优势在于，这些 logs 大多是未清洗、未标注的，真实地模拟了具有 microservice 架构的嘈杂生产环境。</p>
<p>Log 示例：</p>
<pre><code class="hljs language-scss" lang="scss">`

<span class="hljs-number">1</span>.  <span class="hljs-selector-attr">[Sun Dec 04 20:34:21 2005]</span> <span class="hljs-selector-attr">[notice]</span> <span class="hljs-built_in">jk2_init</span>() Found child <span class="hljs-number">2008</span> in scoreboard slot <span class="hljs-number">6</span>
<span class="hljs-number">2</span>.  <span class="hljs-selector-attr">[Sun Dec 04 20:34:25 2005]</span> <span class="hljs-selector-attr">[notice]</span> workerEnv<span class="hljs-selector-class">.init</span>() ok /etc/httpd/conf/workers2<span class="hljs-selector-class">.properties</span>
<span class="hljs-number">3</span>.  <span class="hljs-selector-attr">[Mon Dec 05 11:06:51 2005]</span> <span class="hljs-selector-attr">[notice]</span> workerEnv<span class="hljs-selector-class">.init</span>() ok /etc/httpd/conf/workers2<span class="hljs-selector-class">.properties</span>
<span class="hljs-number">4</span>.  <span class="hljs-number">17</span>/<span class="hljs-number">06</span>/<span class="hljs-number">09</span> <span class="hljs-number">20</span>:<span class="hljs-number">10</span>:<span class="hljs-number">58</span> INFO output.FileOutputCommitter: Saved output of task <span class="hljs-string">'attempt_201706092018_0024_m_000083_1138'</span> to hdfs://<span class="hljs-number">10.10</span>.<span class="hljs-number">34.11</span>:<span class="hljs-number">9000</span>/pjhe/test/<span class="hljs-number">1</span>/_temporary/<span class="hljs-number">0</span>/task_201706092018_0024_m_000083
<span class="hljs-number">5</span>.  <span class="hljs-number">17</span>/<span class="hljs-number">06</span>/<span class="hljs-number">09</span> <span class="hljs-number">20</span>:<span class="hljs-number">10</span>:<span class="hljs-number">58</span> INFO mapred.SparkHadoopMapRedUtil: attempt_201706092018_0024_m_000083_1138: Committed

`AI写代码
</code></pre>
<p>此外，我们还创建了一个 Kubernetes 集群，采用典型的 web 应用 + 数据库 的设置，在最常见的领域中挖掘额外的 logs。</p>
<p>常见 log 字段示例：timestamp、log level（INFO、WARN、ERROR）、source、message。</p>
<h2 data-id="heading-1">使用 LLM 进行 few-shot log 解析</h2>
<p>我们的第一组实验聚焦于一个基础问题：<strong>LLM 是否能够可靠地识别关键字段，并生成一致的解析规则来提取它们？</strong></p>
<p>我们让模型分析原始 log 样本，并生成 regular expression（regex）和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fscripting%2Fgrok" title="https://www.elastic.co/docs/explore-analyze/scripting/grok" target="_blank" ref="nofollow noopener noreferrer">Grok</a> 格式的 log 解析规则。结果表明，这种方法具有很大潜力，但在实现层面也存在显著挑战。</p>
<h3 data-id="heading-2">高置信度与上下文感知</h3>
<p>初步结果令人鼓舞。LLM 展现了很强的能力，能够以高置信度生成与提供的 few-shot 示例相匹配的解析规则。除了简单的模式匹配之外，模型还表现出对 log 的理解能力 —— 它可以正确识别并命名 log 来源（例如 健康追踪 app、Nginx web app、Mongo 数据库）。</p>
<h3 data-id="heading-3">输入样本的 “Goldilocks（恰到好处困境）” 困境</h3>
<p>我们的实验很快暴露出一个显著的鲁棒性不足问题，即模型对输入样本极度敏感。模型的表现会随着 prompt 中包含的具体 log 示例而剧烈波动。我们观察到一个 log 相似性问题：log 样本需要 <strong>恰到好处</strong> 地多样化：</p>
<ul>
<li><strong>过于同质（overfitting）</strong>：如果输入的 logs 过于相似，LLM 往往会过度具体化。它会把可变数据 —— 例如 stack trace 中的特定 Java class 名称 —— 当作模板中的静态部分。这会导致生成的规则非常脆弱，只能覆盖极少比例的 logs，并且提取出的字段不可用。</li>
<li><strong>过于异质（confusion）：相反</strong>，如果样本中包含明显的格式差异 —— 或者更糟的是，包含诸如 progress bars、memory tables、ASCII art 等 “trash logs” —— 模型就很难找到共同点。它往往会生成复杂但有问题的 regex，或者干脆过度泛化，把整行都解析成一个单一的 message blob 字段。</li>
</ul>
<h3 data-id="heading-4">上下文窗口限制</h3>
<p>我们还遇到了 context window 的瓶颈。当输入的 logs 很长、差异很大，或者包含大量可提取字段时，模型的输出质量往往会下降，变得 “杂乱”，或者长度过长而无法放入输出的 context window。自然地，chunking 在这种情况下会有所帮助。通过使用基于字符和基于实体的分隔符来拆分 logs，我们可以帮助模型专注于提取主要字段，而不会被噪声淹没。</p>
<h3 data-id="heading-5">一致性与标准化差距</h3>
<p>即使模型成功生成了解析规则，我们仍然注意到一些细微的不一致性：</p>
<ul>
<li><strong>服务命名差异</strong>：模型在不同运行中会为同一实体提出不同名称（例如，将 source 标注为 “Spark”、 “Apache Spark” 和 “Spark Log Analytics”）。</li>
<li><strong>字段命名差异</strong>：字段名称缺乏标准化（例如 id、 service.id、 device.id）。我们使用标准化的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fecs%2Fecs-field-reference" title="https://www.elastic.co/docs/reference/ecs/ecs-field-reference" target="_blank" ref="nofollow noopener noreferrer">Elastic 字段命名</a>对名称进行了归一化。</li>
<li><strong>解析粒度差异</strong>：字段提取的解析粒度会根据输入日志彼此之间的相似程度而变化。</li>
</ul>
<h2 data-id="heading-6">日志格式指纹</h2>
<p>为了解决日志相似性的问题，我们引入了一种高性能的启发式方法：日志格式指纹（ <strong>log format fingerprint, LFF</strong> ）。</p>
<p>我们不再直接把原始、嘈杂的日志输入到 LLM 中，而是先对每条日志应用一个确定性的转换，以揭示其底层结构。这个预处理步骤会抽象掉可变数据，生成一个简化的 “指纹”，从而让我们可以对相关日志进行分组。</p>
<p>映射逻辑被设计得非常简单，以保证速度和一致性：</p>
<ul>
<li><strong>数字抽象</strong>：任何由数字（ 0–9 ）组成的序列都会被替换为一个 ‘0’。</li>
<li><strong>文本抽象</strong>：任何由字母字符组成并包含空格的序列都会被替换为一个 ‘a’。</li>
<li><strong>空白规范化</strong>：所有连续的空白（空格、制表符、换行符）都会折叠为一个空格。</li>
<li><strong>符号保留</strong>：标点符号和特殊字符（例如 : 、 [ 、 ] 、 / ）会被保留下来，因为它们通常是日志结构中最强的指示信号。</li>
</ul>
<p>我们引入了这种日志映射方法。基础的映射规则包括以下内容：</p>
<ul>
<li>任意长度的数字 0–9 → 替换为 ‘0’。</li>
<li>任意长度的文本（带空格的字母字符） → 替换为 ‘a’。</li>
<li>空格、制表符和换行符 → 合并为一个空格。</li>
</ul>
<p>下面来看一个示例，展示这种映射是如何帮助我们转换日志的。</p>
<pre><code class="hljs language-less" lang="less">`<span class="hljs-number">1</span>.  <span class="hljs-number">17</span>/<span class="hljs-number">06</span>/<span class="hljs-number">09</span>	<span class="hljs-number">20</span>:<span class="hljs-number">10</span>:<span class="hljs-number">56</span>	<span class="hljs-selector-tag">INFO</span>	<span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.CoarseGrainedExecutorBackend</span>:	<span class="hljs-selector-tag">Got</span> <span class="hljs-selector-tag">assigned</span> <span class="hljs-selector-tag">task</span> <span class="hljs-number">912</span>
<span class="hljs-number">2</span>.  <span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>		<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>		<span class="hljs-selector-tag">a</span>	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.a</span>: 							<span class="hljs-selector-tag">a</span> <span class="hljs-number">0</span>
<span class="hljs-number">3</span>.  <span class="hljs-number">17</span>/<span class="hljs-number">06</span>/<span class="hljs-number">09</span>	<span class="hljs-number">20</span>:<span class="hljs-number">10</span>:<span class="hljs-number">58</span>	<span class="hljs-selector-tag">INFO</span>	<span class="hljs-selector-tag">mapred</span><span class="hljs-selector-class">.SparkHadoopMapRedUtil</span>:	<span class="hljs-selector-tag">attempt_</span> <span class="hljs-number">2017060920</span><span class="hljs-selector-tag">_081_136</span>: <span class="hljs-selector-tag">Committed</span>
<span class="hljs-number">4</span>.  <span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>	 	<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span> 	  	<span class="hljs-selector-tag">a</span>  	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.a</span>: 							<span class="hljs-selector-tag">a_0_0_0</span>: <span class="hljs-selector-tag">a</span>
<span class="hljs-number">5</span>.  <span class="hljs-number">2015</span><span class="hljs-selector-tag">-07-29</span>	<span class="hljs-number">19</span>:<span class="hljs-number">23</span>:<span class="hljs-number">30</span>,<span class="hljs-number">320</span>	<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">WARN</span>  <span class="hljs-selector-attr">[RecvWorker:18861024:$RecvWorker@765]</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Interrupting</span> <span class="hljs-selector-tag">SendWorker</span>
<span class="hljs-number">6</span>.  <span class="hljs-number">0</span><span class="hljs-selector-tag">-0-0</span>		<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>,<span class="hljs-number">0</span> 	<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">a</span>	<span class="hljs-selector-attr">[a:0:a$a@0]</span>` <span class="hljs-selector-tag">AI</span>写代码
</code></pre>
<p>因此，我们得到如下的日志掩码：</p>
<pre><code class="hljs language-less" lang="less">`

<span class="hljs-number">1</span>.  <span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>		<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>		<span class="hljs-selector-tag">a</span>	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.a</span>: 			<span class="hljs-selector-tag">a</span> <span class="hljs-number">0</span>
<span class="hljs-number">2</span>.  <span class="hljs-number">0</span>/<span class="hljs-number">0</span>/<span class="hljs-number">0</span>	 	<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span> 	  	<span class="hljs-selector-tag">a</span>  	<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.a</span>: 			<span class="hljs-selector-tag">a_0_0_0</span>: <span class="hljs-selector-tag">a</span>
<span class="hljs-number">3</span>.  <span class="hljs-number">0</span><span class="hljs-selector-tag">-0-0</span>		<span class="hljs-number">0</span>:<span class="hljs-number">0</span>:<span class="hljs-number">0</span>,<span class="hljs-number">0</span> 	<span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">a</span>	<span class="hljs-selector-attr">[a:0:a$a@0]</span>		<span class="hljs-selector-tag">a</span>

`<span class="hljs-selector-tag">AI</span>写代码
</code></pre>
<p>注意前两条日志的指纹。尽管它们的 timestamp、source class 和 message 内容不同，但它们的前缀（0/0/0 0:0:0 a a.a:）是相同的。这种结构上的一致性使我们能够自动将这些日志归入同一个簇。</p>
<p>然而，第三条日志生成了完全不同的指纹（0-0-0…），这使我们能够在调用 LLM 之前，通过算法将其从第一组中分离出来。</p>
<h3 data-id="heading-7">额外部分：使用 ES|QL 即刻实现</h3>
<p>只需在 Discover 中传入以下查询即可。</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> loghub <span class="hljs-operator">|</span>
<span class="hljs-number">2.</span>  EVAL <span class="hljs-keyword">pattern</span> <span class="hljs-operator">=</span> REPLACE(REPLACE(REPLACE(REPLACE(raw_message, "[ \t\n]+", " "), "[A-Za-z]+", "a"), "[0-9]+", "0"), "a( a)+", "a") <span class="hljs-operator">|</span>
<span class="hljs-number">3.</span>  STATS total_count <span class="hljs-operator">=</span> <span class="hljs-built_in">COUNT</span>(), ratio <span class="hljs-operator">=</span> <span class="hljs-built_in">COUNT</span>() <span class="hljs-operator">/</span> <span class="hljs-number">2000.0</span>, datasources<span class="hljs-operator">=</span><span class="hljs-keyword">VALUES</span>(filename), example<span class="hljs-operator">=</span>TOP(raw_message, <span class="hljs-number">3</span>, "desc") <span class="hljs-keyword">BY</span> <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-keyword">pattern</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>) <span class="hljs-operator">|</span>
<span class="hljs-number">4.</span>  SORT total_count <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span>
<span class="hljs-number">5.</span>  LIMIT <span class="hljs-number">100</span>

`AI写代码
</code></pre>
<p>查询解析：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> loghub:Targets our index containing the raw log data.
<span class="hljs-number">2.</span>  EVAL <span class="hljs-keyword">pattern</span> <span class="hljs-operator">=</span> …:  The core mapping logic. We chain REPLACE functions <span class="hljs-keyword">to</span> perform the abstraction (e.g. digits <span class="hljs-keyword">to</span> <span class="hljs-string">'0'</span>, text <span class="hljs-keyword">to</span> <span class="hljs-string">'a'</span>, etc.) <span class="hljs-keyword">and</span> save the <span class="hljs-keyword">result</span> <span class="hljs-keyword">in</span> a “<span class="hljs-keyword">pattern</span>” field. 
<span class="hljs-number">3.</span>  STATS [column1 <span class="hljs-operator">=</span>] expression1, … <span class="hljs-keyword">BY</span> <span class="hljs-built_in">SUBSTRING</span>(<span class="hljs-keyword">pattern</span>, <span class="hljs-number">0</span>, <span class="hljs-number">15</span>): 
<span class="hljs-number">4.</span>  This <span class="hljs-keyword">is</span> a clustering step. We <span class="hljs-keyword">group</span> logs that share the <span class="hljs-keyword">first</span> <span class="hljs-number">15</span> characters <span class="hljs-keyword">of</span> their <span class="hljs-keyword">pattern</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">create</span> aggregated fields such <span class="hljs-keyword">as</span> total log count <span class="hljs-keyword">per</span> <span class="hljs-keyword">group</span>, list <span class="hljs-keyword">of</span> log datasources, <span class="hljs-keyword">pattern</span> prefix, <span class="hljs-number">3</span> log examples  
<span class="hljs-number">5.</span>  SORT total_count <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span> : Surfaces the top <span class="hljs-number">100</span> most frequent log patterns

`AI写代码
</code></pre>
<p>LogHub 上的查询结果如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff76dcf06f0d4d67b91ff582127fe56a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768009888&amp;x-signature=YMZg5EFaJZ9cyhO2gx6OVWoU16I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b14fdc2d69546c18394e4526ddf1bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768009888&amp;x-signature=LRSEI%2FkipAINv4C4I71EpiUGEc0%3D" alt="" loading="lazy"/></p>
<p>如可视化所示，这种 “LLM-free” 方法能够高精度地对日志进行分区。它成功地将 16 个数据源中的 10 个完全聚类（&gt;90%，基于 LogHub 标签），并在 16 个数据源中有 13 个实现多数聚类（&gt;60%）——全部无需额外清洗、预处理或微调。</p>
<p>日志格式指纹（ log format fingerprint, LFF）为复杂的 ML 解决方案（如<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Faggregations%2Fsearch-aggregations-bucket-categorize-text-aggregation" title="https://www.elastic.co/docs/reference/aggregations/search-aggregations-bucket-categorize-text-aggregation" target="_blank" ref="nofollow noopener noreferrer">日志模式分析</a>）提供了一个务实且高效的替代方案和补充。它能够立即洞察日志之间的关系，并有效管理大规模日志簇。</p>
<p>作为基础工具的多用途性<br/>
得益于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fgetting-started-elasticsearch-query-language" title="https://www.elastic.co/blog/getting-started-elasticsearch-query-language" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> 的实现，LFF 既可作为快速数据诊断/可视化的独立工具，也可作为高吞吐量日志分析管道中的构建模块。</p>
<p>灵活性<br/>
LFF 易于自定义和扩展，以捕获特定模式，例如十六进制数字和 IP 地址。</p>
<p>确定性稳定性<br/>
与基于 ML 的聚类算法不同，LFF 的逻辑简单且确定性。新进入的日志不会对已有日志簇产生回溯影响。</p>
<p>性能与内存<br/>
它占用最少的内存，无需训练或 GPU，非常适合实时高吞吐量环境。</p>
<h2 data-id="heading-8">将日志格式指纹与 LLM 结合</h2>
<p>为了验证所提出的混合架构，每次实验都包含来自每个数据源的随机 20% 日志子集。这个限制模拟了真实生产环境中日志按批处理而非作为单一历史数据块处理的情况。</p>
<p>目标是证明 LFF 作为有效压缩层的作用。我们旨在证明可以从小型、精心挑选的样本生成高覆盖率的解析规则，并成功推广到整个数据集。</p>
<h2 data-id="heading-9">执行流程</h2>
<p>我们实现了一个多阶段管道，在数据到达 LLM 之前进行过滤、聚类，并应用分层采样。</p>
<p>1）两阶段分层聚类</p>
<ul>
<li><strong>子类（精确匹配）</strong>：日志按完全相同的指纹聚合。每个子类中的日志共享完全相同的格式结构。</li>
<li><strong>异常清理</strong>：我们丢弃占总日志量不足 5% 的子类。这确保 LLM 专注于主导信号，而不会被噪声或格式错误的日志分散注意力。</li>
<li><strong>元类（前缀匹配）</strong>：剩余子类按指纹匹配的前 N 个字符分组到元类中。这种分组策略有效地将词汇相似的格式归入同一类。对于未知数据源，我们在日志解析中选择 N=5，日志分区中选择 N=15。分层采样</li>
</ul>
<p>2）一旦构建好分层树，我们就为 LLM 构建日志样本。战略目标是最大化方差覆盖，同时最小化 token 使用量。</p>
<ul>
<li>我们从每个元类中每个有效子类选择代表性日志。</li>
<li>为处理子类过多的极端情况，我们应用随机下采样以适应目标窗口大小。</li>
</ul>
<p>3）规则生成</p>
<ul>
<li>最后，我们提示 LLM 为每个元类提供的样本生成适配所有日志的 regex 解析规则。在我们的 PoC 中，我们使用了 GPT-4o mini 模型。</li>
</ul>
<h2 data-id="heading-10">实验结果与观察</h2>
<p>在 Loghub 数据集上，我们实现了 94% 的解析准确率和 91% 的分区准确率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf5062a044464beaab09e23a1a70d745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768009888&amp;x-signature=%2FZAAPBKCbPxvtThwrmZeWCGXP20%3D" alt="" loading="lazy"/></p>
<p>上图的混淆矩阵展示了日志分区结果。纵轴表示实际数据源，横轴表示预测数据源。热力图的颜色深浅对应日志数量，颜色越浅表示数量越多。对角线的对齐显示模型在源归属上的高准确性，散布最小。</p>
<h2 data-id="heading-11">我们的性能基准洞察：</h2>
<ul>
<li><strong>最优基线</strong>：每类 30–40 条日志样本的上下文窗口被证明是“最佳区间”，能够稳定生成可靠的 Regex 和 Grok 解析模式。</li>
<li><strong>输入最小化</strong>：我们将每类的输入规模压缩到 10 条日志用于 Regex 模式，解析性能仅下降 2%，确认基于多样性的采样比原始数量更关键。</li>
</ul>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Flog-parsing-partitioning-automation-experiments-streams" title="https://www.elastic.co/search-labs/blog/log-parsing-partitioning-automation-experiments-streams" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 json-server 快速创建一个完整的 REST API]]></title>    <link>https://juejin.cn/post/7589932422654902308</link>    <guid>https://juejin.cn/post/7589932422654902308</guid>    <pubDate>2026-01-02T17:12:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589932422654902308" data-draft-id="7589919989039267903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 json-server 快速创建一个完整的 REST API"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2026-01-02T17:12:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 json-server 快速创建一个完整的 REST API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T17:12:30.000Z" title="Fri Jan 02 2026 17:12:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">json-server 使用教程</h2>
<h3 data-id="heading-1">什么是 json-server</h3>
<p>json-server 是一个基于 Node.js 的工具，可以快速创建一个完整的 REST API，使用 JSON 文件作为数据源。非常适合前端开发、原型设计和测试。</p>
<h3 data-id="heading-2">安装</h3>
<h4 data-id="heading-3">全局安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g json-server
</code></pre>
<h4 data-id="heading-4">本地安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install json-server --save-dev
</code></pre>
<h4 data-id="heading-5">使用 npx（推荐）</h4>
<pre><code class="hljs language-bash" lang="bash">npx json-server
</code></pre>
<h3 data-id="heading-6">快速开始</h3>
<h4 data-id="heading-7">1. 创建数据文件</h4>
<p>创建一个 <code>db.json</code> 文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"posts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"第一篇文章"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"第二篇文章"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"李四"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"comments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"很好的文章"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"postId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"profile"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"typicode"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">2. 启动服务器</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 默认端口 3000</span>
json-server db.json

<span class="hljs-comment"># 指定端口</span>
json-server db.json --port 4000

<span class="hljs-comment"># 指定主机</span>
json-server db.json --host 0.0.0.0

<span class="hljs-comment"># 静默模式</span>
json-server db.json --quiet

<span class="hljs-comment"># 监视文件变化</span>
json-server db.json --watch
</code></pre>
<h4 data-id="heading-9">3. 访问 API</h4>
<p>启动后，服务器会提供以下端点：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 资源端点</span>
GET    /posts
GET    /posts/1
POST   /posts
PUT    /posts/1
PATCH  /posts/1
DELETE /posts/1

<span class="hljs-comment"># 其他资源</span>
GET    /comments
GET    /profile
</code></pre>
<h3 data-id="heading-10">REST API 操作</h3>
<h4 data-id="heading-11">GET - 获取数据</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取所有文章</span>
curl http://localhost:3000/posts

<span class="hljs-comment"># 获取指定 ID 的文章</span>
curl http://localhost:3000/posts/1

<span class="hljs-comment"># 获取个人资料</span>
curl http://localhost:3000/profile
</code></pre>
<h4 data-id="heading-12">POST - 创建数据</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建新文章</span>
curl -X POST http://localhost:3000/posts \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "title": "新文章",
    "author": "王五"
  }'</span>

<span class="hljs-comment"># 使用 JavaScript fetch</span>
fetch(<span class="hljs-string">'http://localhost:3000/posts'</span>, {
  method: <span class="hljs-string">'POST'</span>,
  headers: {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  body: JSON.stringify({
    title: <span class="hljs-string">'新文章'</span>,
    author: <span class="hljs-string">'王五'</span>
  })
})
</code></pre>
<h4 data-id="heading-13">PUT - 完整更新</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整更新文章（必须包含所有字段）</span>
curl -X PUT http://localhost:3000/posts/1 \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "id": 1,
    "title": "更新后的标题",
    "author": "张三"
  }'</span>
</code></pre>
<h4 data-id="heading-14">PATCH - 部分更新</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 部分更新文章（只更新指定字段）</span>
curl -X PATCH http://localhost:3000/posts/1 \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "title": "只更新标题"
  }'</span>
</code></pre>
<h4 data-id="heading-15">DELETE - 删除数据</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除文章</span>
curl -X DELETE http://localhost:3000/posts/1
</code></pre>
<h3 data-id="heading-16">高级查询</h3>
<h4 data-id="heading-17">过滤</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 按字段过滤</span>
GET /posts?author=张三

<span class="hljs-comment"># 多条件过滤</span>
GET /posts?author=张三&amp;<span class="hljs-built_in">id</span>=1

<span class="hljs-comment"># 嵌套属性过滤</span>
GET /comments?postId=1
</code></pre>
<h4 data-id="heading-18">分页</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 分页查询</span>
GET /posts?_page=1&amp;_limit=10

<span class="hljs-comment"># 获取总数（在响应头 X-Total-Count 中）</span>
</code></pre>
<h4 data-id="heading-19">排序</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 升序排序</span>
GET /posts?_sort=<span class="hljs-built_in">id</span>&amp;_order=asc

<span class="hljs-comment"># 降序排序</span>
GET /posts?_sort=<span class="hljs-built_in">id</span>&amp;_order=desc

<span class="hljs-comment"># 多字段排序</span>
GET /posts?_sort=author,<span class="hljs-built_in">id</span>&amp;_order=asc,desc
</code></pre>
<h4 data-id="heading-20">切片</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 范围查询</span>
GET /posts?_start=0&amp;_end=10

<span class="hljs-comment"># 限制数量</span>
GET /posts?_limit=5

<span class="hljs-comment"># 跳过数量</span>
GET /posts?_start=5
</code></pre>
<h4 data-id="heading-21">操作符</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 大于</span>
GET /posts?id_gte=1

<span class="hljs-comment"># 小于</span>
GET /posts?id_lte=10

<span class="hljs-comment"># 不等于</span>
GET /posts?id_ne=1

<span class="hljs-comment"># 包含</span>
GET /posts?q=关键词

<span class="hljs-comment"># 正则表达式</span>
GET /posts?id_like=1
</code></pre>
<h4 data-id="heading-22">全文搜索</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索包含关键词的记录</span>
GET /posts?q=文章

<span class="hljs-comment"># 搜索会在所有字段中查找</span>
</code></pre>
<h4 data-id="heading-23">关联查询</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取文章及其评论</span>
GET /posts/1?_embed=comments

<span class="hljs-comment"># 获取评论及其所属文章</span>
GET /comments?_expand=post

<span class="hljs-comment"># 嵌套多个关系</span>
GET /posts/1?_embed=comments&amp;_embed=likes
</code></pre>
<h3 data-id="heading-24">配置选项</h3>
<h4 data-id="heading-25">命令行选项</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整命令示例</span>
json-server db.json \
  --port 4000 \
  --host 0.0.0.0 \
  --watch \
  --routes routes.json \
  --middlewares middleware.js \
  --static ./public \
  --read-only \
  --no-cors
</code></pre>
<h4 data-id="heading-26">选项说明</h4>













































<table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td><code>--port</code></td><td>指定端口号（默认 3000）</td></tr><tr><td><code>--host</code></td><td>指定主机地址（默认 localhost）</td></tr><tr><td><code>--watch</code></td><td>监视文件变化</td></tr><tr><td><code>--routes</code></td><td>自定义路由文件</td></tr><tr><td><code>--middlewares</code></td><td>中间件文件</td></tr><tr><td><code>--static</code></td><td>静态文件目录</td></tr><tr><td><code>--read-only</code></td><td>只读模式（禁用 POST/PUT/DELETE）</td></tr><tr><td><code>--no-cors</code></td><td>禁用 CORS</td></tr><tr><td><code>--quiet</code></td><td>静默模式</td></tr></tbody></table>
<h3 data-id="heading-27">自定义路由</h3>
<h4 data-id="heading-28">创建路由文件</h4>
<p>创建 <code>routes.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"/api/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/$1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"/:resource/:id/show"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/:resource/:id"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"/posts/:category"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/posts?category=:category"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"/articles\\?id=:id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/posts/:id"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-29">使用自定义路由</h4>
<pre><code class="hljs language-bash" lang="bash">json-server db.json --routes routes.json
</code></pre>
<h4 data-id="heading-30">路由示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 原始路由</span>
GET /posts/1

<span class="hljs-comment"># 自定义路由</span>
GET /api/posts/1        <span class="hljs-comment"># 映射到 /posts/1</span>
GET /posts/1/show       <span class="hljs-comment"># 映射到 /posts/1</span>
GET /posts/tech         <span class="hljs-comment"># 映射到 /posts?category=tech</span>
</code></pre>
<h3 data-id="heading-31">中间件</h3>
<h4 data-id="heading-32">创建中间件</h4>
<p>创建 <code>middleware.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 添加响应头</span>
  res.<span class="hljs-title function_">header</span>(<span class="hljs-string">'X-Custom-Header'</span>, <span class="hljs-string">'Custom Value'</span>)
  
  <span class="hljs-comment">// 记录请求</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>)
  
  <span class="hljs-comment">// 模拟延迟</span>
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'delay'</span>)) {
    <span class="hljs-built_in">setTimeout</span>(next, <span class="hljs-number">2000</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">next</span>()
  }
}
</code></pre>
<h4 data-id="heading-33">使用中间件</h4>
<pre><code class="hljs language-bash" lang="bash">json-server db.json --middlewares middleware.js
</code></pre>
<h4 data-id="heading-34">高级中间件示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 身份验证模拟</span>
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span> &amp;&amp; !req.<span class="hljs-property">headers</span>.<span class="hljs-property">authorization</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Unauthorized'</span> })
  }
  
  <span class="hljs-comment">// 请求日志</span>
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${timestamp}</span>] <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.url}</span>`</span>)
  
  <span class="hljs-comment">// 修改响应</span>
  <span class="hljs-keyword">const</span> originalSend = res.<span class="hljs-property">send</span>
  res.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> modifiedData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data)
    modifiedData.<span class="hljs-property">timestamp</span> = timestamp
    originalSend.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(modifiedData))
  }
  
  <span class="hljs-title function_">next</span>()
}
</code></pre>
<h3 data-id="heading-35">数据生成</h3>
<h4 data-id="heading-36">使用 Faker.js 生成测试数据</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> faker = <span class="hljs-built_in">require</span>(<span class="hljs-string">'faker'</span>)
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> users = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100</span>; i++) {
    users.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">id</span>: i,
      <span class="hljs-attr">name</span>: faker.<span class="hljs-property">name</span>.<span class="hljs-title function_">findName</span>(),
      <span class="hljs-attr">email</span>: faker.<span class="hljs-property">internet</span>.<span class="hljs-title function_">email</span>(),
      <span class="hljs-attr">phone</span>: faker.<span class="hljs-property">phone</span>.<span class="hljs-title function_">phoneNumber</span>(),
      <span class="hljs-attr">address</span>: {
        <span class="hljs-attr">street</span>: faker.<span class="hljs-property">address</span>.<span class="hljs-title function_">streetAddress</span>(),
        <span class="hljs-attr">city</span>: faker.<span class="hljs-property">address</span>.<span class="hljs-title function_">city</span>(),
        <span class="hljs-attr">country</span>: faker.<span class="hljs-property">address</span>.<span class="hljs-title function_">country</span>()
      },
      <span class="hljs-attr">company</span>: faker.<span class="hljs-property">company</span>.<span class="hljs-title function_">companyName</span>()
    })
  }
  
  <span class="hljs-keyword">const</span> db = { users }
  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">'db.json'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(db, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>))
}

<span class="hljs-title function_">generateData</span>()
</code></pre>
<h4 data-id="heading-37">运行生成器</h4>
<pre><code class="hljs language-bash" lang="bash">node generate-data.js
json-server db.json
</code></pre>
<h3 data-id="heading-38">与前端框架集成</h3>
<h4 data-id="heading-39">React 示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">'http://localhost:3000'</span>

<span class="hljs-comment">// 获取所有文章</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getPosts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${API_URL}</span>/posts`</span>)
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
}

<span class="hljs-comment">// 创建文章</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">createPost</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">post</span>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${API_URL}</span>/posts`</span>, post)
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
}

<span class="hljs-comment">// 更新文章</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">updatePost</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id, post</span>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">put</span>(<span class="hljs-string">`<span class="hljs-subst">${API_URL}</span>/posts/<span class="hljs-subst">${id}</span>`</span>, post)
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
}

<span class="hljs-comment">// 删除文章</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">deletePost</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id</span>) =&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">delete</span>(<span class="hljs-string">`<span class="hljs-subst">${API_URL}</span>/posts/<span class="hljs-subst">${id}</span>`</span>)
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
}
</code></pre>
<h4 data-id="heading-40">Vue 示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:3000'</span>
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPosts</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/posts'</span>)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createPost</span>(<span class="hljs-params">post</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/posts'</span>, post)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updatePost</span>(<span class="hljs-params">id, post</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">put</span>(<span class="hljs-string">`/posts/<span class="hljs-subst">${id}</span>`</span>, post)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">deletePost</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">delete</span>(<span class="hljs-string">`/posts/<span class="hljs-subst">${id}</span>`</span>)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  }
}
</code></pre>
<h3 data-id="heading-41">package.json 配置</h3>
<h4 data-id="heading-42">添加脚本</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"json-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"json-server --watch db.json --port 4000"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run json-server"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"json-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.17.3"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-43">运行脚本</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<h3 data-id="heading-44">常见问题</h3>
<h4 data-id="heading-45">1. 端口被占用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用其他端口</span>
json-server db.json --port 4000
</code></pre>
<h4 data-id="heading-46">2. CORS 问题</h4>
<p>json-server 默认启用 CORS，如果遇到问题：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保没有禁用 CORS</span>
json-server db.json
</code></pre>
<h4 data-id="heading-47">3. 数据持久化</h4>
<p>json-server 会将修改保存到 <code>db.json</code> 文件中，确保文件有写入权限。</p>
<h4 data-id="heading-48">4. 重置数据</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除 db.json 或恢复备份</span>
<span class="hljs-built_in">rm</span> db.json
<span class="hljs-built_in">cp</span> db.json.backup db.json
</code></pre>
<h3 data-id="heading-49">最佳实践</h3>
<h4 data-id="heading-50">1. 版本控制</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加到 .gitignore</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"db.json"</span> &gt;&gt; .gitignore

<span class="hljs-comment"># 创建示例数据文件</span>
<span class="hljs-built_in">cp</span> db.json db.example.json
</code></pre>
<h4 data-id="heading-51">2. 环境配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">port</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">JSON_SERVER_PORT</span> || <span class="hljs-number">3000</span>,
  <span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">JSON_SERVER_HOST</span> || <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">watch</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">'production'</span>
}
</code></pre>
<h4 data-id="heading-52">3. 数据验证</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// middleware.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span> || req.<span class="hljs-property">method</span> === <span class="hljs-string">'PUT'</span>) {
    <span class="hljs-keyword">const</span> body = req.<span class="hljs-property">body</span>
    
    <span class="hljs-comment">// 验证必填字段</span>
    <span class="hljs-keyword">if</span> (!body.<span class="hljs-property">title</span>) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Title is required'</span> })
    }
  }
  <span class="hljs-title function_">next</span>()
}
</code></pre>
<h4 data-id="heading-53">4. 性能优化</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用静态文件服务</span>
json-server db.json --static ./public

<span class="hljs-comment"># 禁用日志（生产环境）</span>
json-server db.json --quiet
</code></pre>
<h3 data-id="heading-54">总结</h3>
<p>json-server 是一个强大且易于使用的工具，适合：</p>
<ul>
<li>✅ 前端开发和原型设计</li>
<li>✅ API 测试和调试</li>
<li>✅ 快速搭建演示项目</li>
<li>✅ 学习 REST API 概念</li>
</ul>
<p>通过本教程，你应该能够：</p>
<ul>
<li>安装和启动 json-server</li>
<li>执行 CRUD 操作</li>
<li>使用高级查询功能</li>
<li>自定义路由和中间件</li>
<li>与前端框架集成</li>
</ul>
<p>开始使用 json-server，快速构建你的 REST API 吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code 终端崩溃问题分析与解决方案]]></title>    <link>https://juejin.cn/post/7590020026395574326</link>    <guid>https://juejin.cn/post/7590020026395574326</guid>    <pubDate>2026-01-03T02:35:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590020026395574326" data-draft-id="7589919989039480895" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code 终端崩溃问题分析与解决方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T02:35:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凯哥1970"/> <meta itemprop="url" content="https://juejin.cn/user/3954283342211335"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code 终端崩溃问题分析与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3954283342211335/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凯哥1970
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T02:35:40.000Z" title="Sat Jan 03 2026 02:35:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VS Code 终端崩溃问题分析与解决方案</h2>
<h3 data-id="heading-1">错误代码：<code>-2147023895 (0x800703E9)</code></h3>
<p>显示如下</p>
<pre><code class="hljs language-shell" lang="shell">终端进程“C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe”已终止，退出代码: -2147023895。
</code></pre>
<h4 data-id="heading-2">问题描述</h4>
<p>在 VS Code 中打开终端时，PowerShell 进程异常退出，返回错误代码 <code>-2147023895</code>。该错误会导致终端无法正常启动或使用，影响开发效率。</p>
<hr/>
<h4 data-id="heading-3">错误原因分析</h4>
<p>错误代码 <code>-2147023895</code> 对应十六进制值 <code>0x800703E9</code>，是一个标准的 <strong>HRESULT 错误码</strong>，其结构解析如下：</p>
<ul>
<li><strong>严重性位（Bit 31）</strong> ：1，表示失败。</li>
<li><strong>设备代码（Bits 16-26）</strong> ：7（<code>FACILITY_WIN32</code>），表示错误源自 Windows API 调用。</li>
<li><strong>低位代码（Bits 0-15）</strong> ：<code>0x03E9</code>（十进制 1001）。</li>
</ul>
<h5 data-id="heading-4">可能的原因：</h5>
<ol>
<li><strong>栈溢出（Stack Overflow）</strong><br/>
PowerShell 启动时脚本陷入无限递归，耗尽线程栈空间，触发系统异常。</li>
<li><strong>文件完整性校验失败（Invalid Image Hash）</strong><br/>
Windows 代码完整性机制或安全软件（如 AppLocker）检测到脚本文件签名无效、文件损坏或哈希不匹配，导致加载被拒绝。</li>
<li><strong>环境变量冲突</strong><br/>
脚本执行过程中展开的环境变量（如 <code>PATH</code>）过长，引发内存或栈溢出。</li>
</ol>
<h4 data-id="heading-5">根本原因定位</h4>
<p>多数情况下，该错误与 <strong>VS Code 终端 Shell 集成脚本</strong> <code>shellIntegration.ps1</code> 有关。该脚本在终端启动时被自动加载，若文件损坏或与用户配置冲突，即会触发上述错误。</p>
<hr/>
<h4 data-id="heading-6">解决方案：手动替换脚本文件（治本）</h4>
<p>无需禁用终端功能，直接替换损坏的脚本文件即可根治问题。</p>
<h5 data-id="heading-7">操作步骤：</h5>
<ol>
<li>
<p><strong>定位脚本文件</strong><br/>
根据 VS Code 安装方式，找到目标目录：</p>
<ul>
<li><strong>用户安装</strong>：<br/>
<code>%LOCALAPPDATA%\Programs&lt;EditorName&gt;\resources\app\out\vs\workbench\contrib\terminal\common\scripts</code></li>
<li><strong>系统安装</strong>：<br/>
<code>C:\Program Files\Microsoft VS Code\resources\app\out\vs\workbench\contrib\terminal\common\scripts</code></li>
</ul>
</li>
<li>
<p><strong>备份原文件</strong><br/>
将目录中的 <code>shellIntegration.ps1</code> 重命名为 <code>shellIntegration.ps1.bak</code>，作为备份。</p>
</li>
<li>
<p><strong>下载官方脚本</strong><br/>
访问 VS Code 官方 GitHub 仓库，下载最新版本的脚本文件：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fraw.githubusercontent.com%2Fmicrosoft%2Fvscode%2Fmain%2Fsrc%2Fvs%2Fworkbench%2Fcontrib%255Cterminal%255Ccommon%255Cscripts%255CshellIntegration.ps1" target="_blank" title="https://raw.githubusercontent.com/microsoft/vscode/main/src/vs/workbench/contrib%5Cterminal%5Ccommon%5Cscripts%5CshellIntegration.ps1" ref="nofollow noopener noreferrer">raw.githubusercontent.com/microsoft/v…</a></p>
</li>
<li>
<p><strong>替换文件</strong><br/>
将下载的 <code>shellIntegration.ps1</code> 复制到步骤 1 的目录中，确保当前用户有读取权限。</p>
</li>
<li>
<p><strong>重启验证</strong><br/>
完全关闭 VS Code（包括后台进程），重新启动并打开终端，检查是否恢复正常。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-8">方案原理</h4>
<p>通过替换为官方完好的脚本文件，确保：</p>
<ul>
<li>PowerShell 解析器能正常解析语法，避免因文件损坏导致的崩溃。</li>
<li>脚本与用户环境兼容，避免递归冲突或安全校验失败。</li>
<li>保留完整的终端 Shell 集成功能（如命令装饰、状态提示等）。</li>
</ul>
<hr/>
<h4 data-id="heading-9">注意事项</h4>
<ul>
<li>若问题仍然存在，可检查用户 PowerShell 配置文件（<code>$PROFILE</code>）中是否存在与 Shell 集成冲突的自定义代码。</li>
<li>建议定期更新 VS Code，以获取官方修复的脚本版本。</li>
</ul>
<hr/>
<p>通过以上步骤，可从根本上解决终端崩溃问题，无需临时禁用功能或修改启动命令，确保开发环境稳定可用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin extensions是什么？]]></title>    <link>https://juejin.cn/post/7590503651141419034</link>    <guid>https://juejin.cn/post/7590503651141419034</guid>    <pubDate>2026-01-03T02:24:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590503651141419034" data-draft-id="7590292138346610698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin extensions是什么？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T02:24:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Poorguy9527"/> <meta itemprop="url" content="https://juejin.cn/user/1746465251931063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin extensions是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1746465251931063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Poorguy9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T02:24:20.000Z" title="Sat Jan 03 2026 02:24:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>扩展是怎么做到的</p>
</blockquote>
<p>Kotlin扩展（Extensions）的实现原理主要基于<strong>编译时的静态分派</strong>和<strong>语法糖</strong>。</p>
<blockquote>
<p>从编译后的字节码层面看</p>
</blockquote>
<p>扩展函数被编译为：</p>
<ul>
<li>静态方法（static method）</li>
<li>第一个参数是接收者类型（receiver type）</li>
<li>方法名包含接收者类型信息（避免冲突）</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Kotlin代码</span>
fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">addExclamation</span>(): <span class="hljs-title class_">String</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"$this!"</span>
}

<span class="hljs-comment">// 编译后等价于Java</span>
public <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">addExclamation</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> receiver</span>) {
    <span class="hljs-keyword">return</span> receiver + <span class="hljs-string">"!"</span>;
}


<span class="hljs-comment">// 反编译后的Java代码示例</span>
public final <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringExtensionsKt</span> {
    public <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-title function_">addExclamation</span>(<span class="hljs-params">@NotNull <span class="hljs-built_in">String</span> $this$addExclamation</span>) {
        <span class="hljs-comment">// 方法体</span>
    }
}
</code></pre>
<h3 data-id="heading-0"> 限制和注意事项</h3>
<ol>
<li><strong>没有多态性</strong>：扩展是静态分派的</li>
<li><strong>不能覆盖成员</strong>：扩展函数不会覆盖类的成员函数</li>
<li><strong>作用域限制</strong>：需要导入才能使用</li>
<li><strong>优先级</strong>：成员函数优先于扩展函数</li>
</ol>
<h3 data-id="heading-1">Kotlin扩展的本质是：</h3>
<ul>
<li><strong>语法糖</strong>：提供更好的API设计体验</li>
<li><strong>静态分派</strong>：编译时确定调用的方法</li>
<li><strong>无侵入</strong>：不修改原有类的字节码</li>
<li><strong>类型安全</strong>：编译器进行完整的类型检查</li>
</ul>
<p>这种设计使得Kotlin能够在不破坏现有Java兼容性的前提下，提供灵活的API扩展能力。</p>
<h2 data-id="heading-2">不同类型扩展实现</h2>
<h4 data-id="heading-3">顶层扩展</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 文件: StringExtensions.kt</span>
package com.<span class="hljs-property">example</span>

fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">customExtension</span>(<span class="hljs-params"/>) { ... }

<span class="hljs-comment">// 使用：自动导入</span>
<span class="hljs-string">"hello"</span>.<span class="hljs-title function_">customExtension</span>()
</code></pre>
<h4 data-id="heading-4">成员扩展</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Host</span> {
    <span class="hljs-comment">// 扩展的接收者是String，但声明在Host内部</span>
    fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 可以访问Host的成员</span>
    }
}
</code></pre>
<h4 data-id="heading-5">扩展伴随对象</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    companion object
}

fun <span class="hljs-title class_">MyClass</span>.<span class="hljs-property">Companion</span>.<span class="hljs-title function_">extension</span>(<span class="hljs-params"/>) { ... }
</code></pre>
<h2 data-id="heading-6">特殊情况的处理</h2>
<h4 data-id="heading-7">扩展与继承</h4>
<pre><code class="hljs language-js" lang="js">open <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> : <span class="hljs-title class_">Animal</span>()

fun <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">speak</span>() = <span class="hljs-string">"Animal sound"</span>
fun <span class="hljs-title class_">Dog</span>.<span class="hljs-title function_">speak</span>() = <span class="hljs-string">"Bark"</span>

val <span class="hljs-attr">animal</span>: <span class="hljs-title class_">Animal</span> = <span class="hljs-title class_">Dog</span>()
<span class="hljs-title function_">println</span>(animal.<span class="hljs-title function_">speak</span>()) <span class="hljs-comment">// "Animal sound" (静态分派)</span>
</code></pre>
<h4 data-id="heading-8">可空接收者</h4>
<pre><code class="hljs language-js" lang="js">fun <span class="hljs-title class_">String</span>?.<span class="hljs-title function_">safeLength</span>(): <span class="hljs-title class_">Int</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>?.<span class="hljs-property">length</span> ?: <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 编译为处理null的静态方法</span>

</code></pre>
<h4 data-id="heading-9">泛型扩展</h4>
<pre><code class="hljs language-js" lang="js">fun &lt;T&gt; <span class="hljs-title class_">List</span>&lt;T&gt;.<span class="hljs-title function_">customFilter</span>(): <span class="hljs-title class_">List</span>&lt;T&gt; { ... }

<span class="hljs-comment">// 编译时进行类型擦除，但保留类型安全检查</span>
</code></pre>
<h2 data-id="heading-10">扩展属性背后的机制</h2>
<p>扩展属性<strong>没有幕后字段</strong>（backing field），必须提供getter（和setter）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">StringBuilder</span>.<span class="hljs-property">lastChar</span>: <span class="hljs-title class_">Char</span>
    <span class="hljs-title function_">get</span>() = <span class="hljs-title function_">get</span>(length - <span class="hljs-number">1</span>)
    <span class="hljs-title function_">set</span>(value) = <span class="hljs-title function_">setCharAt</span>(length - <span class="hljs-number">1</span>, value)

<span class="hljs-comment">// 编译为两个静态方法：</span>
<span class="hljs-comment">// getLastChar(StringBuilder)</span>
<span class="hljs-comment">// setLastChar(StringBuilder, Char)</span>
</code></pre>
<h2 data-id="heading-11">与Java的互操作性</h2>
<h4 data-id="heading-12">从Java调用Kotlin扩展</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Kotlin扩展</span>
fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">kotlinExtension</span>(): <span class="hljs-title class_">String</span> { ... }

<span class="hljs-comment">// Java中调用</span>
<span class="hljs-title class_">String</span> result = <span class="hljs-title class_">ExtensionKt</span>.<span class="hljs-title function_">kotlinExtension</span>(<span class="hljs-string">"hello"</span>);
</code></pre>
<h4 data-id="heading-13">扩展的JVM注解</h4>
<p>编译器可以添加<code>@JvmName</code>来修改生成的Java方法名：</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">JvmName</span>(<span class="hljs-string">"addPrefix"</span>)
fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">prefix</span>() = <span class="hljs-string">"prefix_$this"</span>
</code></pre>
<h2 data-id="heading-14">实际应用示例</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 实际编译示例</span>
fun <span class="hljs-title class_">String</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-attr">n</span>: <span class="hljs-title class_">Int</span>): <span class="hljs-title class_">String</span> {
    val builder = <span class="hljs-title class_">StringBuilder</span>()
    <span class="hljs-title function_">repeat</span>(<span class="hljs-params">n</span>) { builder.<span class="hljs-title function_">append</span>(<span class="hljs-variable language_">this</span>) }
    <span class="hljs-keyword">return</span> builder.<span class="hljs-title function_">toString</span>()
}

<span class="hljs-comment">// 编译为：</span>
public <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">repeat</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> receiver, int n</span>) {
    <span class="hljs-title class_">StringBuilder</span> builder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; n; i++) {
        builder.<span class="hljs-title function_">append</span>(receiver);
    }
    <span class="hljs-keyword">return</span> builder.<span class="hljs-title function_">toString</span>();
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次必现ANR问题的深度分析与解决之旅:当NestedScrollView遇上VelocityTracker]]></title>    <link>https://juejin.cn/post/7590128405351432192</link>    <guid>https://juejin.cn/post/7590128405351432192</guid>    <pubDate>2026-01-03T02:34:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590128405351432192" data-draft-id="7590128405351415808" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次必现ANR问题的深度分析与解决之旅:当NestedScrollView遇上VelocityTracker"/> <meta itemprop="keywords" content="Android,Debug,性能优化"/> <meta itemprop="datePublished" content="2026-01-03T02:34:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次必现ANR问题的深度分析与解决之旅:当NestedScrollView遇上VelocityTracker
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T02:34:49.000Z" title="Sat Jan 03 2026 02:34:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">下班前总会有问题在等你</h2>
<p>周五下午快下班了,测试同学突然找过来:"这个页面每次点击都会卡死,必现的!"你心想,"必现?那还不简单,分分钟搞定。"结果拿到日志一看,好家伙,<strong>一小时内连续发生了7次ANR</strong>,主线程居然在CPU上执行了超过7秒的计算任务!</p>
<p>这不是段子,这是我最近遇到的一个真实案例。今天就和大家分享这次"惊心动魄"的ANR排查之旅——从发现问题到深度分析,再到提供多套解决方案的完整过程。</p>
<h2 data-id="heading-1">过程速览</h2>
<ul>
<li><strong>问题</strong>: 车载设置应用中,点击日间行车灯设置时必现ANR,主线程阻塞超过7秒</li>
<li><strong>根因</strong>: <code>NestedScrollView</code> 触摸事件处理时,<code>VelocityTracker</code> 的速度计算(最小二乘法)耗时异常</li>
<li><strong>影响</strong>: P0级严重问题,必现,影响用户体验</li>
<li><strong>解决</strong>: 提供4个层级的解决方案,从快速修复到架构优化</li>
<li><strong>收获</strong>: 深入理解Android触摸事件处理机制,掌握ANR排查方法论</li>
</ul>
<h2 data-id="heading-2">问题现场还原</h2>
<h3 data-id="heading-3">案发现场</h3>
<p><strong>时间</strong>: 2025年12月23日 15:25-16:13<br/>
<strong>地点</strong>: 车载设置应用 → 车灯 → 环境灯 → 日间行车灯设置<br/>
<strong>案情</strong>: 每次点击日间行车灯下方的文字,应用立即卡死并闪退</p>
<p><strong>关键证据</strong> (来自ANR trace文件):</p>
<pre><code class="hljs language-ini" lang="ini">Subject: Input dispatching timed out
(SMART_POPUP_INTERRUPT_PERM is not responding.
Waited 5000ms for MotionEvent(<span class="hljs-attr">action</span>=UP))

主线程状态:
- <span class="hljs-attr">state</span>=Native (正在执行native代码)
- CPU <span class="hljs-attr">time</span>=<span class="hljs-number">7538472365</span>纳秒 ≈ <span class="hljs-number">7.5</span>秒
- 用户态时间:702个时间片 ≈ 7.02秒
</code></pre>
<p>看到这里我就纳闷了:一个简单的触摸事件,凭什么要消耗7秒的CPU时间?</p>
<h3 data-id="heading-4">连续作案记录</h3>
<p>更让人惊讶的是,这不是孤立事件。从Critical Event Log中发现,这个ANR在一小时内重复出现了7次:</p>





















































<table><thead><tr><th>时间</th><th>PID</th><th>时间间隔</th><th>状态</th></tr></thead><tbody><tr><td>15:25:03</td><td>3292</td><td>-</td><td>首次出现</td></tr><tr><td>15:49:16</td><td>15858</td><td>24分13秒</td><td>应用重启</td></tr><tr><td>15:49:52</td><td>16887</td><td>36秒</td><td>快速复现</td></tr><tr><td>15:52:31</td><td>16887</td><td>2分39秒</td><td>持续出现</td></tr><tr><td><strong>15:53:18</strong></td><td><strong>17362</strong></td><td><strong>47秒</strong></td><td><strong>当前分析</strong></td></tr><tr><td>15:54:10</td><td>?</td><td>52秒</td><td>再次复现</td></tr><tr><td>16:13:27</td><td>?</td><td>19分17秒</td><td>仍在发生</td></tr></tbody></table>
<p><strong>结论</strong>:这是一个稳定复现的代码级Bug,而不是偶发的系统问题或硬件异常。</p>
<h2 data-id="heading-5">深入分析:真相只有一个</h2>
<h3 data-id="heading-6">调用栈追踪</h3>
<p>让我们看看主线程在干什么(关键部分):</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Native</span>层阻塞点:
  <span class="hljs-selector-id">#00</span> <span class="hljs-selector-tag">libinput</span><span class="hljs-selector-class">.so</span>: <span class="hljs-selector-tag">LeastSquaresVelocityTrackerStrategy</span>::<span class="hljs-selector-tag">getEstimator</span>+<span class="hljs-number">299</span>
  <span class="hljs-selector-id">#01</span> <span class="hljs-selector-tag">libinput</span><span class="hljs-selector-class">.so</span>: <span class="hljs-selector-tag">VelocityTracker</span>::<span class="hljs-selector-tag">getVelocity</span>+<span class="hljs-number">65</span>
  <span class="hljs-selector-id">#02</span> <span class="hljs-selector-tag">libandroid_runtime</span><span class="hljs-selector-class">.so</span>: <span class="hljs-selector-tag">android_view_VelocityTracker_nativeComputeCurrentVelocity</span>

<span class="hljs-selector-tag">Java</span>层调用链:
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.VelocityTracker</span><span class="hljs-selector-class">.nativeComputeCurrentVelocity</span>(Native)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.VelocityTracker</span><span class="hljs-selector-class">.computeCurrentVelocity</span>(VelocityTracker.<span class="hljs-attribute">java</span>:<span class="hljs-number">354</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">androidx</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.widget</span><span class="hljs-selector-class">.NestedScrollView</span><span class="hljs-selector-class">.onTouchEvent</span>(<span class="hljs-attribute">unavailable</span>:<span class="hljs-number">467</span>)
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span><span class="hljs-selector-class">.dispatchTouchEvent</span>(View.<span class="hljs-attribute">java</span>:<span class="hljs-number">15010</span>)
  ...
  <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.Dialog</span><span class="hljs-selector-class">.dispatchTouchEvent</span>(Dialog.<span class="hljs-attribute">java</span>:<span class="hljs-number">911</span>)  ← 问题发生在<span class="hljs-selector-tag">Dialog</span>中
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b5278982954dcba4bb7f23672d66d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768012488&amp;x-signature=jvQvQkPhMsz2d8q7tyfZQdmmTHc%3D" alt="case4-anr-touch-event-flow.png" loading="lazy"/></p>
<p><em>图1: ANR触摸事件处理完整流程</em></p>
<h3 data-id="heading-7">罪魁祸首:VelocityTracker</h3>
<p><strong>什么是VelocityTracker?</strong></p>
<p><code>VelocityTracker</code> 是Android中用于计算触摸滑动速度的工具类。当你在屏幕上滑动时,它会记录你手指的轨迹,然后用**最小二乘法(Least Squares)**拟合一条曲线,计算出滑动速度。这个速度用于实现惯性滚动(Fling)效果。</p>
<p><strong>正常情况</strong>:这个计算应该在几毫秒内完成。
<strong>我们的情况</strong>:耗时超过7秒!</p>
<p><strong>为什么会这样?</strong></p>
<p>经过分析,最可能的原因是<strong>触摸数据异常</strong>:</p>
<ol>
<li>
<p><strong>触摸点积累过多</strong>: <code>VelocityTracker</code> 内部维护了一个历史触摸点队列。如果触摸屏驱动产生了异常的高频采样,队列中可能积累了成百上千个触摸点。</p>
</li>
<li>
<p><strong>最小二乘法的复杂度</strong>: 假设有N个触摸点,最小二乘法的时间复杂度大约是O(N²)到O(N³),当N变得很大时,计算量暴增。</p>
</li>
<li>
<p><strong>Native层没有超时保护</strong>: Android的VelocityTracker实现没有超时机制,如果数据异常,它会老老实实把所有点都算完,哪怕要算7秒。</p>
</li>
</ol>
<p><strong>我踩过的坑</strong>:刚开始我以为是主线程做了耗时操作(比如网络请求或数据库查询),结果发现根本不是!这个ANR完全是由一个"应该瞬间完成"的速度计算引起的。这告诉我们:永远不要对系统API的性能做假设。</p>
<h3 data-id="heading-8">界面结构分析</h3>
<p>问题发生在这样的视图层次中:</p>
<pre><code class="hljs language-scss" lang="scss">DecorView
  └─ Dialog (车灯环境灯设置对话框)
      └─ ViewGroup (多层嵌套)
          └─ NestedScrollView  ← 问题发生位置
              └─ <span class="hljs-selector-attr">[日间行车灯设置内容]</span>
</code></pre>
<p><strong>为什么是NestedScrollView?</strong></p>
<p><code>NestedScrollView</code> 是 AndroidX 提供的增强版 <code>ScrollView</code>,支持嵌套滑动(Nested Scrolling)。相比普通 <code>ScrollView</code>,它的触摸事件处理更复杂,更依赖 <code>VelocityTracker</code> 来协调嵌套滑动。</p>
<h2 data-id="heading-9">解决方案:四个层级的战术选择</h2>
<p>面对这个问题,我准备了4个不同层级的解决方案,从"快速止血"到"根治病灶"。</p>
<h3 data-id="heading-10">方案1:禁用速度追踪(立即修复,5分钟搞定)</h3>
<p><strong>优先级</strong>: ⭐⭐⭐⭐⭐
<strong>实施难度</strong>: ★☆☆☆☆
<strong>预期效果</strong>: 直接避免VelocityTracker计算,立即解决ANR</p>
<p><strong>实施步骤</strong>:</p>
<p>在布局文件中:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.core.widget.NestedScrollView</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/nested_scroll_view"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:nestedScrollingEnabled</span>=<span class="hljs-string">"false"</span>
    <span class="hljs-attr">android:overScrollMode</span>=<span class="hljs-string">"never"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.core.widget.NestedScrollView</span>&gt;</span>
</code></pre>
<p>或在代码中动态设置:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> nestedScrollView = dialog.findViewById&lt;NestedScrollView&gt;(R.id.nested_scroll_view)
nestedScrollView.isNestedScrollingEnabled = <span class="hljs-literal">false</span>
nestedScrollView.overScrollMode = View.OVER_SCROLL_NEVER

<span class="hljs-comment">// 如果问题依然存在,完全禁用fling行为</span>
nestedScrollView.setOnTouchListener { _, event -&gt;
    <span class="hljs-keyword">if</span> (event.action == MotionEvent.ACTION_UP) {
        nestedScrollView.fling(<span class="hljs-number">0</span>)  <span class="hljs-comment">// 禁用惯性滚动</span>
    }
    <span class="hljs-literal">false</span>
}
</code></pre>
<p><strong>权衡</strong>:</p>
<ul>
<li>✅ 超快:5分钟内完成并验证</li>
<li>✅ 低风险:不影响正常滑动,只是没有惯性效果</li>
<li>⚠️ 用户体验略有下降:失去了丝滑的惯性滚动</li>
</ul>
<p><strong>我的经验</strong>:对于生产环境的紧急Bug,这是最佳选择。先止血,再优化。</p>
<h3 data-id="heading-11">方案2:替换为ScrollView(根本解决,1小时重构)</h3>
<p><strong>优先级</strong>: ⭐⭐⭐⭐
<strong>实施难度</strong>: ★★☆☆☆
<strong>预期效果</strong>: 从根本上避免NestedScrollView的复杂性</p>
<p>如果你的Dialog内容不需要嵌套滑动功能,直接用 <code>ScrollView</code> 替代:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ScrollView</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/scroll_view"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:fillViewport</span>=<span class="hljs-string">"true"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 保持原有内容结构 --&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">ScrollView</span>&gt;</span>
</code></pre>
<p>代码迁移:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ScrollView 的 API 与 NestedScrollView 高度兼容</span>
<span class="hljs-keyword">val</span> scrollView = dialog.findViewById&lt;ScrollView&gt;(R.id.scroll_view)
<span class="hljs-comment">// 大部分情况下不需要修改其他代码</span>
</code></pre>
<p><strong>适用场景</strong>:</p>
<ul>
<li>内容较简单,不需要与其他滑动组件协同</li>
<li>不需要 CoordinatorLayout 等高级功能</li>
</ul>
<p><strong>权衡</strong>:</p>
<ul>
<li>✅ 彻底解决:不再有VelocityTracker的性能隐患</li>
<li>✅ 更简单:ScrollView 的代码路径更短,更稳定</li>
<li>⚠️ 需测试:确保不影响其他嵌套滑动功能</li>
</ul>
<h3 data-id="heading-12">方案3:自定义SafeNestedScrollView(防御性编程,2小时开发)</h3>
<p><strong>优先级</strong>: ⭐⭐⭐
<strong>实施难度</strong>: ★★★☆☆
<strong>预期效果</strong>: 拦截异常,防止ANR,并记录日志</p>
<p>创建一个带保护机制的自定义 <code>NestedScrollView</code>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.android.settings.widget

<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.util.AttributeSet
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> android.view.MotionEvent
<span class="hljs-keyword">import</span> androidx.core.widget.NestedScrollView

<span class="hljs-comment">/**
 * 安全的NestedScrollView,防止VelocityTracker计算导致ANR
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeNestedScrollView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : NestedScrollView(context, attrs, defStyleAttr) {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"SafeNestedScrollView"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MAX_TOUCH_EVENTS_PER_100MS = <span class="hljs-number">100</span>  <span class="hljs-comment">// 异常阈值</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastTouchTime = <span class="hljs-number">0L</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> touchEventCount = <span class="hljs-number">0</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTouchEvent</span><span class="hljs-params">(ev: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">when</span> (ev.action) {
            MotionEvent.ACTION_DOWN -&gt; {
                lastTouchTime = System.currentTimeMillis()
                touchEventCount = <span class="hljs-number">0</span>
            }

            MotionEvent.ACTION_MOVE -&gt; {
                touchEventCount++

                <span class="hljs-comment">// 检测异常:短时间内大量MOVE事件</span>
                <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
                <span class="hljs-keyword">val</span> duration = currentTime - lastTouchTime

                <span class="hljs-keyword">if</span> (duration <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.99</span> &amp;&amp; touchEventCount &gt; MAX_TOUCH_EVENTS_PER_100MS) {
                    Log.w(TAG, <span class="hljs-string">"检测到异常触摸事件流: <span class="hljs-variable">$touchEventCount</span> 个事件在 <span class="hljs-subst">${duration}</span>ms 内"</span>)
                    <span class="hljs-comment">// 清理触摸状态,防止VelocityTracker积累过多数据</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
                }
            }

            MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onTouchEvent(ev)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    Log.e(TAG, <span class="hljs-string">"触摸事件处理异常"</span>, e)
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
                }
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">super</span>.onTouchEvent(ev)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(TAG, <span class="hljs-string">"触摸事件处理异常"</span>, e)
            <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fling</span><span class="hljs-params">(velocityY: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 限制fling速度,防止过大值导致计算问题</span>
        <span class="hljs-keyword">val</span> limitedVelocity = velocityY.coerceIn(-<span class="hljs-number">5000</span>, <span class="hljs-number">5000</span>)
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">super</span>.fling(limitedVelocity)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(TAG, <span class="hljs-string">"Fling执行异常"</span>, e)
        }
    }
}
</code></pre>
<p>在布局中使用:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">com.android.settings.widget.SafeNestedScrollView</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/nested_scroll_view"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">com.android.settings.widget.SafeNestedScrollView</span>&gt;</span>
</code></pre>
<p><strong>核心思想</strong>:</p>
<ol>
<li><strong>异常检测</strong>: 监控触摸事件的频率,识别异常模式</li>
<li><strong>提前中断</strong>: 检测到异常时立即中断,不让问题传递到VelocityTracker</li>
<li><strong>异常捕获</strong>: Try-catch包裹关键调用,防止崩溃</li>
<li><strong>速度限制</strong>: 限制fling速度,避免极端值</li>
<li><strong>日志记录</strong>: 记录异常情况,便于后续分析</li>
</ol>
<p><strong>权衡</strong>:</p>
<ul>
<li>✅ 防御性强:多重保护机制</li>
<li>✅ 可观测性:日志记录便于排查</li>
<li>✅ 向后兼容:不影响正常使用场景</li>
<li>⚠️ 开发成本:需要编写和测试自定义View</li>
</ul>
<h3 data-id="heading-13">方案4:系统层优化(长期方案,需跨团队协作)</h3>
<p><strong>优先级</strong>: ⭐⭐
<strong>实施难度</strong>: ★★★★★
<strong>适用场景</strong>: 如果是系统ROM或硬件问题</p>
<p>这个方案需要与硬件团队和系统团队协作:</p>
<ol>
<li>
<p><strong>检查触摸屏驱动</strong>: 确认触摸事件的采样率是否正常,是否存在驱动Bug</p>
</li>
<li>
<p><strong>优化系统库</strong>: 考虑使用Google原生的 <code>libinput.so</code>,或在x86_64架构上优化性能</p>
</li>
<li>
<p><strong>添加超时保护</strong>: 为VelocityTracker的native实现添加超时机制</p>
</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用systrace监控触摸事件</span>
systrace.py -t 10 -o trace.html input view

<span class="hljs-comment"># 分析触摸事件的采样频率和处理时间</span>
</code></pre>
<p><strong>这是我的经验</strong>:这类系统级问题往往牵涉多个团队,周期长,不确定性大。除非你有明确证据表明是系统问题,否则优先选择应用层方案。</p>
<h2 data-id="heading-14">解决方案对比</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47a847b516bb4299a6d80270e109ad39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768012488&amp;x-signature=JWKNza9jTv2%2BYyVVgXUWNKP6gOY%3D" alt="case4-solutions-comparison.png" loading="lazy"/></p>
<p><em>图2: 四种解决方案的优缺点对比</em></p>













































<table><thead><tr><th align="left">方案</th><th align="center">修复时间</th><th align="center">难度</th><th align="center">风险</th><th align="center">效果</th><th align="left">推荐场景</th></tr></thead><tbody><tr><td align="left">方案1: 禁用速度追踪</td><td align="center">5分钟</td><td align="center">⭐</td><td align="center">低</td><td align="center">立即解决</td><td align="left">紧急修复,生产环境</td></tr><tr><td align="left">方案2: 替换为ScrollView</td><td align="center">1小时</td><td align="center">⭐⭐</td><td align="center">中</td><td align="center">根治</td><td align="left">不需要嵌套滑动</td></tr><tr><td align="left">方案3: SafeNestedScrollView</td><td align="center">2小时</td><td align="center">⭐⭐⭐</td><td align="center">低</td><td align="center">防御+监控</td><td align="left">需要嵌套滑动+防御</td></tr><tr><td align="left">方案4: 系统层优化</td><td align="center">数周</td><td align="center">⭐⭐⭐⭐⭐</td><td align="center">高</td><td align="center">彻底根治</td><td align="left">系统定制ROM</td></tr></tbody></table>
<p><strong>我的建议</strong>:</p>
<ul>
<li><strong>生产环境紧急修复</strong>: 方案1(禁用) + 方案2(替换)组合拳</li>
<li><strong>长期架构优化</strong>: 方案3(自定义View) + 代码规范建立</li>
<li><strong>车载系统定制</strong>: 方案4(系统优化) + 应用层防御</li>
</ul>
<h2 data-id="heading-15">验证与测试:修复之后的功课</h2>
<p>修复只是第一步,验证才是关键。以下是我的测试清单:</p>
<h3 data-id="heading-16">功能测试</h3>
<pre><code class="hljs language-markdown" lang="markdown">测试步骤:
<span class="hljs-bullet">1.</span> 进入设置应用
<span class="hljs-bullet">2.</span> 点击车灯 → 环境灯
<span class="hljs-bullet">3.</span> 反复点击日间行车灯下面的文字(至少20次)
<span class="hljs-bullet">4.</span> 观察是否再次出现ANR
<span class="hljs-bullet">5.</span> 测试其他设置页面的滑动功能
</code></pre>
<h3 data-id="heading-17">性能测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 监控主线程性能</span>
adb shell am profile start com.android.settings /data/local/tmp/profile.trace
<span class="hljs-comment"># 执行测试操作</span>
adb shell am profile stop com.android.settings

<span class="hljs-comment"># 2. 实时查看日志</span>
adb logcat -s SafeNestedScrollView:* AndroidRuntime:E

<span class="hljs-comment"># 3. 检查是否有新的ANR</span>
adb shell <span class="hljs-built_in">ls</span> -lt /data/anr/
</code></pre>
<h3 data-id="heading-18">关键指标</h3>



































<table><thead><tr><th align="left">指标</th><th align="center">修复前</th><th align="center">目标值</th><th align="left">测量方法</th></tr></thead><tbody><tr><td align="left">触摸响应时间</td><td align="center">大于5000ms</td><td align="center">小于100ms</td><td align="left">Systrace</td></tr><tr><td align="left">主线程最大阻塞</td><td align="center">7520ms</td><td align="center">小于200ms</td><td align="left">StrictMode</td></tr><tr><td align="left">ANR发生率</td><td align="center">100%(必现)</td><td align="center">0%</td><td align="left">线上监控</td></tr><tr><td align="left">Fling流畅度</td><td align="center">N/A</td><td align="center">≥55fps</td><td align="left">FrameMetrics</td></tr></tbody></table>
<h3 data-id="heading-19">回归测试清单</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 其他设置页面的滑动正常</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Dialog的显示和关闭正常</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 其他使用NestedScrollView的页面正常</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 应用启动速度无明显下降</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 内存占用无明显增长</li>
</ul>
<h2 data-id="heading-20">预防措施:授人以鱼不如授人以渔</h2>
<p>经历了这次"惊心动魄"的排查,我总结了一些预防措施,希望能帮助你避免类似的坑。</p>
<h3 data-id="heading-21">编码规范</h3>
<h4 data-id="heading-22">❌ 反面教材:主线程隐式计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误:依赖系统组件的隐式计算</span>
nestedScrollView.fling(velocity)  <span class="hljs-comment">// 内部会触发VelocityTracker计算</span>
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确:主动控制,避免隐式耗时操作</span>
nestedScrollView.smoothScrollTo(x, y, <span class="hljs-number">300</span>)  <span class="hljs-comment">// 明确的滚动行为</span>
</code></pre>
<h4 data-id="heading-23">❌ 反面教材:过度嵌套</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误:不必要的嵌套滑动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">NestedScrollView</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NestedScrollView</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RecyclerView</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">NestedScrollView</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">NestedScrollView</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ✅ 正确:使用CoordinatorLayout --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">androidx.coordinatorlayout.widget.CoordinatorLayout</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.appbar.AppBarLayout</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">com.google.android.material.appbar.AppBarLayout</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">RecyclerView</span>
        <span class="hljs-attr">app:layout_behavior</span>=<span class="hljs-string">"@string/appbar_scrolling_view_behavior"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.coordinatorlayout.widget.CoordinatorLayout</span>&gt;</span>
</code></pre>
<h3 data-id="heading-24">性能监控方案</h3>
<h4 data-id="heading-25">方案A: Firebase Performance Monitoring</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> trace = Firebase.performance.newTrace(<span class="hljs-string">"settings_light_dialog_touch"</span>)
trace.start()

<span class="hljs-keyword">try</span> {
    showLightSettingsDialog()
} <span class="hljs-keyword">finally</span> {
    trace.stop()
}
</code></pre>
<h4 data-id="heading-26">方案B: 自定义ANR守卫</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnrWatchdog</span> : <span class="hljs-type">Thread</span>(<span class="hljs-string">"AnrWatchdog"</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> checkInterval = <span class="hljs-number">5000L</span>  <span class="hljs-comment">// 5秒检查一次</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">while</span> (!isInterrupted) {
            <span class="hljs-keyword">val</span> blockDetected = AtomicBoolean(<span class="hljs-literal">false</span>)

            handler.post {
                blockDetected.<span class="hljs-keyword">set</span>(<span class="hljs-literal">true</span>)
            }

            sleep(checkInterval)

            <span class="hljs-keyword">if</span> (!blockDetected.<span class="hljs-keyword">get</span>()) {
                <span class="hljs-comment">// 主线程阻塞超过5秒</span>
                reportAnr(Thread.getAllStackTraces())
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reportAnr</span><span class="hljs-params">(stackTraces: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">Thread</span>, Array&lt;StackTraceElement&gt;&gt;)</span></span> {
        <span class="hljs-comment">// 上报到监控平台</span>
        Log.e(<span class="hljs-string">"AnrWatchdog"</span>, <span class="hljs-string">"检测到ANR"</span>, Exception().apply {
            stackTrace = stackTraces[Looper.getMainLooper().thread] ?: emptyArray()
        })
    }
}

<span class="hljs-comment">// 在Application中启动</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        AnrWatchdog().start()
    }
}
</code></pre>
<h3 data-id="heading-27">Code Review检查点</h3>
<p>在代码审查时,重点关注以下几点:</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 所有UI线程操作是否耗时小于16ms?(一帧时间)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了StrictMode检测主线程违规?</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 复杂视图是否做了性能测试?</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 触摸事件处理是否有超时保护?</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否有必要的try-catch保护?</li>
</ul>
<h3 data-id="heading-28">团队流程优化</h3>
<ol>
<li><strong>性能测试自动化</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在CI/CD中集成性能测试</span>
./gradlew connectedAndroidTest \
  -Pandroid.testInstrumentationRunnerArguments.class=\
  com.android.settings.PerformanceTest
</code></pre>
<ol start="2">
<li>
<p><strong>ANR监控告警</strong></p>
<ul>
<li>集成Bugly、Sentry等APM工具</li>
<li>配置ANR率告警阈值:&gt;0.1%立即告警</li>
<li>每周Review ANR数据,优先修复高频问题</li>
</ul>
</li>
<li>
<p><strong>性能卡点记录</strong></p>
<ul>
<li>建立"性能陷阱"文档,记录团队踩过的坑</li>
<li>在新人培训中分享性能优化案例</li>
<li>定期组织性能优化技术分享</li>
</ul>
</li>
</ol>
<h2 data-id="heading-29">经验教训:我踩过的坑</h2>
<p>这次排查让我深刻体会到几点:</p>
<h3 data-id="heading-30">1. 永远不要对系统API的性能做假设</h3>
<p>我原以为 <code>computeCurrentVelocity()</code> 这种系统API应该是高度优化的,不会有性能问题。<strong>错了!</strong> 在异常数据面前,任何算法都可能退化。</p>
<h3 data-id="heading-31">2. ANR不一定是你写的代码问题</h3>
<p>这次ANR的直接原因是系统触摸屏驱动产生的异常数据,但最终暴露在应用层。这提醒我们:应用开发要有防御性思维,不能假设系统永远正常。</p>
<h3 data-id="heading-32">3. 日志是排查问题的第一生产力</h3>
<p>幸亏Android提供了详细的ANR trace,让我能快速定位到 <code>VelocityTracker</code>。如果没有这些日志,可能要花好几天时间盲猜。</p>
<h3 data-id="heading-33">4. 快速止血比追求完美更重要</h3>
<p>面对生产环境的紧急Bug,方案1(禁用速度追踪)虽然不完美,但5分钟就能止血。先让用户能用起来,再慢慢优化,这才是务实的工程态度。</p>
<h3 data-id="heading-34">5. 文档和复盘同样重要</h3>
<p>写这篇文章的过程,也是对问题的再思考。把排查过程记录下来,不仅能帮助团队其他成员避坑,也能在下次遇到类似问题时快速回忆起解决思路。</p>
<h2 data-id="heading-35">相关文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fandroid-stability-perf-series-readme" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/android-stability-perf-series-readme" ref="nofollow noopener noreferrer">Android稳定性&amp;性能深入理解专栏介绍</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase1-android-ivi-lag-case-analysis-binder-consumed" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case1-android-ivi-lag-case-analysis-binder-consumed" ref="nofollow noopener noreferrer">Android车机卡顿案例剖析:从Binder耗尽到单例缺失的深度排查</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase2-anr-audioserver-deadlock-system-failure" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case2-anr-audioserver-deadlock-system-failure" ref="nofollow noopener noreferrer">ANR实战分析：一次audioserver死锁引发的系统级故障排查</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase3-android-black-screen-analysis" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case3-android-black-screen-analysis" ref="nofollow noopener noreferrer">一次 Android 车机黑屏问题的深度剖析：当显示驱动遇上中断风暴</a></li>
</ul>
<hr/>
<p><em>如果你也遇到过类似的诡异问题,欢迎在评论区分享!有任何疑问也可以随时留言讨论。</em></p>
<p><em>本文基于真实案例改编,部分敏感信息已脱敏处理。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并行不等于更快：CompletableFuture 让你更慢的 5 个姿势]]></title>    <link>https://juejin.cn/post/7589893746081169449</link>    <guid>https://juejin.cn/post/7589893746081169449</guid>    <pubDate>2026-01-02T01:37:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589893746081169449" data-draft-id="7590054976488882216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并行不等于更快：CompletableFuture 让你更慢的 5 个姿势"/> <meta itemprop="keywords" content="后端,性能优化,Java"/> <meta itemprop="datePublished" content="2026-01-02T01:37:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叫煤球的猫"/> <meta itemprop="url" content="https://juejin.cn/user/1732486058745054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并行不等于更快：CompletableFuture 让你更慢的 5 个姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486058745054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叫煤球的猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T01:37:52.000Z" title="Fri Jan 02 2026 01:37:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上周的某一天，运维同学找到我说生产环境的订单处理接口响应时间突然飙到了 3 秒。</p>
<p>我先让后端同学和运维一起查监控，CPU 使用率倒是不高，线程池的活跃线程数却涨到了 500 多。</p>
<p>再看了眼最近上线的代码，里面一段原本串行的代码，改成了 <code>CompletableFuture</code> 并行处理，本意肯定是想快一点，结果反而变慢了。</p>
<p>这也不是个例。</p>
<p>很多时候我们拿到一段串行代码，第一反应就是看能不能改成并行，觉得多线程跑起来肯定快。</p>
<p>但个别情况下，改完之后不仅不会变快，可能还会比原来还慢。</p>
<p>问题出在哪里？线程池不够大吗？还是机器配置太低吗？其实不然。</p>
<p>真正的原因，可能还是我们使用 CompletableFuture 的姿势不正确。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf49d84b171e481eba7dd320657d9007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Y-q5Y-r54Wk55CD55qE54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767922671&amp;x-signature=cBPTmOh3ZRTwNMsyNdvL4r%2FQB4E%3D" alt="fullmetal alchemist ed GIF.gif" loading="lazy"/></p>
<h2 data-id="heading-1">任务拆的太碎：上下文切换吃掉了所有收益</h2>
<p>假设你要处理 1000 个订单号，每个订单号需要调用一个方法做校验，单次调用耗时 0.1 毫秒。串行处理总共需要 100 毫秒。你觉得用 CompletableFuture 并行处理，开 10 个线程应该能快 10 倍吧？</p>
<p>让我们写个测试：</p>
<pre><code class="hljs language-ini" lang="ini">// 串行处理
long <span class="hljs-attr">start</span> = System.nanoTime()<span class="hljs-comment">;</span>
for (String orderId : orderIds) {
    validateOrder(orderId)<span class="hljs-comment">;</span>
}
long <span class="hljs-attr">serialTime</span> = System.nanoTime() - start<span class="hljs-comment">;</span>

// 并行处理
ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">start</span> = System.nanoTime()<span class="hljs-comment">;</span>
List&lt;CompletableFuture&lt;Void&gt;&gt; <span class="hljs-attr">futures</span> = orderIds.stream()
    .map(orderId -&gt; CompletableFuture.runAsync(
        () -&gt; validateOrder(orderId), executor))
    .collect(Collectors.toList())<span class="hljs-comment">;</span>
CompletableFuture.allOf(futures.toArray(new CompletableFuture<span class="hljs-section">[0]</span>)).join()<span class="hljs-comment">;</span>
long <span class="hljs-attr">parallelTime</span> = System.nanoTime() - start<span class="hljs-comment">;</span>
</code></pre>
<p>结果串行用了 98 毫秒，并行用了 145 毫秒。</p>
<p>为什么会这样？</p>
<p>每提交一个 CompletableFuture，系统都要做一次任务调度，涉及线程唤醒、上下文切换、CPU 缓存失效。这些开销加起来可能就要几微秒。当单个任务本身只需要 0.1 毫秒时，调度开销占比就很高了。1000 个任务就是 1000 次调度，累积起来的开销超过了并行带来的收益。</p>
<p>更稳妥的做法是把粒度收粗，让每个任务足够大，至少覆盖调度成本。</p>
<p>我们改成每 100 个订单号作为一批，提交一个 CompletableFuture：</p>
<pre><code class="hljs language-ini" lang="ini">List&lt;CompletableFuture&lt;Void&gt;&gt; <span class="hljs-attr">futures</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; orderIds.size(); i += 100) {</span>
    List&lt;String&gt; <span class="hljs-attr">batch</span> = orderIds.subList(i, 
        Math.min(i + 100, orderIds.size()))<span class="hljs-comment">;</span>
    futures.add(CompletableFuture.runAsync(() -&gt; {
        for (String orderId : batch) {
            validateOrder(orderId)<span class="hljs-comment">;</span>
        }
    }, executor))<span class="hljs-comment">;</span>
}
CompletableFuture.allOf(futures.toArray(new CompletableFuture<span class="hljs-section">[0]</span>)).join()<span class="hljs-comment">;</span>
</code></pre>
<p>这次只用了 12 毫秒。调度次数从 1000 次降到了 10 次，上下文切换的开销大幅减少，并行的优势才真正体现出来。</p>
<p>这其实就是最常见的策略——分批处理或分片处理。</p>
<p>当然还有一点经验主义，单个任务的执行时间至少要在 1 毫秒以上，并行才有意义。如果任务本身很轻量，就应该打包成批次再提交。</p>
<h2 data-id="heading-2">共享资源：所有线程挤在同一扇门前</h2>
<p>并行处理时，如果多个线程需要访问同一个资源，这个资源就会成为瓶颈。最常见的就是<strong>数据库连接池</strong>。</p>
<p>比方说用 CompletableFuture 并行查询用户信息，每个 future 都要从连接池拿一个数据库连接。连接池配置了 20 个连接，但同时提交了 100 个 CompletableFuture。</p>
<p>结果就是 80 个线程在等待连接释放，白白浪费时间。</p>
<pre><code class="hljs language-ini" lang="ini">// 连接池只有 20 个连接
HikariConfig <span class="hljs-attr">config</span> = new HikariConfig()<span class="hljs-comment">;</span>
config.setMaximumPoolSize(20)<span class="hljs-comment">;</span>
DataSource <span class="hljs-attr">dataSource</span> = new HikariDataSource(config)<span class="hljs-comment">;</span>

// 同时发起 100 个查询
ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">100</span>)<span class="hljs-comment">;</span>
List&lt;CompletableFuture&lt;User&gt;&gt; <span class="hljs-attr">futures</span> = userIds.stream()
    .map(userId -&gt; CompletableFuture.supplyAsync(() -&gt; {
        try (Connection <span class="hljs-attr">conn</span> = dataSource.getConnection()) {
            return queryUser(conn, userId)<span class="hljs-comment">;</span>
        }
    }, executor))
    .collect(Collectors.toList())<span class="hljs-comment">;</span>
</code></pre>
<p>监控显示，平均每个查询耗时从串行时的 5 毫秒涨到了 50 毫秒。大部分时间都花在了等待连接上。</p>
<p>除了数据库连接池，还有很多这种典型的场景案例：</p>
<ul>
<li>锁与同步块</li>
<li>数据库连接池、Redis 连接池</li>
<li>HTTP 客户端连接池</li>
<li>限流器、熔断器</li>
<li>单线程日志 append、单队列缓冲</li>
</ul>
<p>一般来讲，这种问题的应对思路通常是：</p>
<ul>
<li>把共享区缩小，把锁粒度压缩到必要范围</li>
<li>让并发度受资源容量约束，别超过连接池和下游的可承受并发</li>
<li>对 I/O 做隔离池，避免同一个池里既跑 CPU 又跑阻塞 I/O</li>
</ul>
<p>最简单的方式就是把线程池改成 20，当然还有另一个朴素但有效的手段，是用信号量把并发度卡在资源容量之内：</p>
<pre><code class="hljs language-ini" lang="ini">Semaphore <span class="hljs-attr">semaphore</span> = new Semaphore(<span class="hljs-number">20</span>)<span class="hljs-comment">; // 不要超过连接池或下游并发上限</span>
List&lt;CompletableFuture&lt;User&gt;&gt; <span class="hljs-attr">futures</span> = userIds.stream()
    .map(userId -&gt; CompletableFuture.supplyAsync(() -&gt; {
        try {
            semaphore.acquire()<span class="hljs-comment">;</span>
            try (Connection <span class="hljs-attr">conn</span> = dataSource.getConnection()) {
                return queryUser(conn, userId)<span class="hljs-comment">;</span>
            }
        } finally {
            semaphore.release()<span class="hljs-comment">;</span>
        }
    }, executor))
    .collect(Collectors.toList())<span class="hljs-comment">;</span>
</code></pre>
<p>如果你的任务需要获取这些资源，并发度就不能设得太高，否则大量线程会阻塞在资源竞争上。</p>
<h2 data-id="heading-3">内存爆炸：一口气提交十万个 Future</h2>
<p>有个定时任务需要处理数据库里的所有待处理订单，数量大概十几万。后端同学写了这样的代码：</p>
<pre><code class="hljs language-ini" lang="ini">List&lt;Order&gt; <span class="hljs-attr">orders</span> = orderRepository.findAllPending()<span class="hljs-comment">; // 10 万条</span>
ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">50</span>)<span class="hljs-comment">;</span>

List&lt;CompletableFuture&lt;Void&gt;&gt; <span class="hljs-attr">futures</span> = orders.stream()
    .map(order -&gt; CompletableFuture.runAsync(
        () -&gt; processOrder(order), executor))
    .collect(Collectors.toList())<span class="hljs-comment">;</span>

CompletableFuture.allOf(futures.toArray(new CompletableFuture<span class="hljs-section">[0]</span>)).join()<span class="hljs-comment">;</span>
</code></pre>
<p>这段代码在测试环境跑得好好的，因为测试数据只有几百条。上了生产之后（草台班子没有做好代码审查 😭），JVM 直接 OOM 了。</p>
<p>问题在于这行代码：</p>
<pre><code class="hljs language-ini" lang="ini">.collect(Collectors.toList())<span class="hljs-comment">;</span>
</code></pre>
<p>它会一口气创建 10 万个 CompletableFuture 对象，每个对象占用几百字节到上千字节不等。还没开始处理，光是这些 Future 对象就占用了几百 MB 内存。加上线程池队列里堆积的任务对象，内存很快就撑不住了。</p>
<p>正确的做法是分批处理：</p>
<pre><code class="hljs language-ini" lang="ini">List&lt;Order&gt; <span class="hljs-attr">orders</span> = orderRepository.findAllPending()<span class="hljs-comment">;</span>
ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(<span class="hljs-number">50</span>)<span class="hljs-comment">;</span>

int <span class="hljs-attr">batchSize</span> = <span class="hljs-number">1000</span><span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; orders.size(); i += batchSize) {</span>
    List&lt;Order&gt; <span class="hljs-attr">batch</span> = orders.subList(i, 
        Math.min(i + batchSize, orders.size()))<span class="hljs-comment">;</span>
    
    List&lt;CompletableFuture&lt;Void&gt;&gt; <span class="hljs-attr">futures</span> = batch.stream()
        .map(order -&gt; CompletableFuture.runAsync(
            () -&gt; processOrder(order), executor))
        .collect(Collectors.toList())<span class="hljs-comment">;</span>
    
    CompletableFuture.allOf(futures.toArray(new CompletableFuture<span class="hljs-section">[0]</span>)).join()<span class="hljs-comment">;</span>
}
</code></pre>
<p>每次只创建 1000 个 Future，处理完一批再处理下一批。内存占用稳定在可控范围内。</p>
<p>这个问题的本质是缺少背压机制。</p>
<p>生产者一股脑地提交任务，完全不管消费者的处理能力。当任务提交速度远大于处理速度时，未处理的任务就会在内存里堆积，最终导致 OOM。</p>
<h2 data-id="heading-4">线程池配置：不是越大越好</h2>
<p>遇到性能问题时，很多人的第一反应是加大线程池。原来是 50，改成 100，还是慢就改成 200。结果往往是线程越多越慢。</p>
<p>以前做过一个实验，用不同大小的线程池处理同一批 IO 密集型任务。每个任务需要调用一个外部 HTTP 接口，平均耗时 200 毫秒。一共 1000 个任务。</p>



































<table><thead><tr><th>线程数</th><th>总耗时(秒)</th><th>CPU 使用率</th></tr></thead><tbody><tr><td>10</td><td>20.5</td><td>15%</td></tr><tr><td>50</td><td>4.2</td><td>45%</td></tr><tr><td>100</td><td>2.8</td><td>68%</td></tr><tr><td>200</td><td>3.1</td><td>82%</td></tr><tr><td>500</td><td>4.8</td><td>91%</td></tr></tbody></table>
<p>可以看到，线程数从 10 增加到 100 时，性能持续提升。但超过 100 之后，性能反而下降了。这是因为线程数太多会带来几个问题：</p>
<p>线程本身要占用内存，每个线程的栈空间默认是 1MB。500 个线程就是 500MB。</p>
<p>线程越多，操作系统的调度开销越大。CPU 要在不同线程之间频繁切换，每次切换都要保存和恢复上下文。</p>
<p>对于 IO 密集型任务，经验公式是 <code>线程数等于 CPU 核心数乘以 (1 + IO 时间 / CPU 时间)</code>。</p>
<p>假设 IO 时间是 200 毫秒，CPU 时间是 1 毫秒，那么 8 核机器的理想线程数是 <code> 8 * (1 + 200/1) = 1608</code> 。</p>
<p>但这只是理论值，实际上很少需要这么多线程。</p>
<p>更实用的做法是从一个合理的初始值开始，比如 CPU 核心数的 2 到 4 倍，然后通过压测逐步调整，观察 CPU 使用率、响应时间和吞吐量，找到最佳的平衡点。</p>
<p>另一个常见错误是混用线程池。有的代码里创建了多个 ExecutorService，每个地方都用 newFixedThreadPool(50)。</p>
<p>实际运行时可能有 5 个这样的线程池，总共 250 个线程在跑。每个线程池单独看都不大，合在一起就超负荷了。</p>
<p>最好是在应用启动时创建一个全局的线程池，所有 CompletableFuture 共用这一个。</p>
<p>如果确实需要隔离，也应该仔细规划各个线程池的大小，确保总数可控。</p>
<h2 data-id="heading-5">异常处理：一个任务挂了，其他任务也白跑</h2>
<p>CompletableFuture 有个特点，如果其中一个任务抛出异常，调用 allOf().join() 时会立即抛出异常，但其他任务不会停止，它们会继续在后台执行完。</p>
<pre><code class="hljs language-scss" lang="scss">List&lt;CompletableFuture&lt;Void&gt;&gt; futures = Arrays<span class="hljs-selector-class">.asList</span>(
    CompletableFuture.runAsync(() -&gt; <span class="hljs-built_in">task1</span>()),
    CompletableFuture<span class="hljs-selector-class">.runAsync</span>(() -&gt; { throw new <span class="hljs-built_in">RuntimeException</span>(); }),
    CompletableFuture<span class="hljs-selector-class">.runAsync</span>(() -&gt; <span class="hljs-built_in">task3</span>())
);

try {
    CompletableFuture<span class="hljs-selector-class">.allOf</span>(futures.toArray(new CompletableFuture[<span class="hljs-number">0</span>]))<span class="hljs-selector-class">.join</span>();
} catch (Exception e) {
    <span class="hljs-comment">// 进入这里时，task1 和 task3 可能还在执行</span>
}
</code></pre>
<p>如果你的任务之间有依赖关系，这种行为会导致资源浪费。比如第一步查询订单失败了，后面的计算价格、更新库存都没有意义，但它们还在继续跑。</p>
<p>更糟糕的情况是，如果没有正确处理异常，有些任务可能会永远卡住。比如任务内部获取了锁但没有在 finally 里释放，抛出异常后锁就永远不会释放了。</p>
<p>建议每个任务都用 exceptionally 或 handle 方法捕获异常：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">Result</span>&gt;&gt; <span class="hljs-selector-tag">futures</span> = <span class="hljs-selector-tag">tasks</span><span class="hljs-selector-class">.stream</span>()
    <span class="hljs-selector-class">.map</span>(task -&gt; CompletableFuture.<span class="hljs-built_in">supplyAsync</span>(() -&gt; task.<span class="hljs-built_in">execute</span>())
        .<span class="hljs-built_in">exceptionally</span>(ex -&gt; {
            log.<span class="hljs-built_in">error</span>(<span class="hljs-string">"Task failed"</span>, ex);
            return Result.<span class="hljs-built_in">failure</span>(ex);
        }))
    <span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>());

<span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Result</span>&gt; <span class="hljs-selector-tag">results</span> = <span class="hljs-selector-tag">CompletableFuture</span><span class="hljs-selector-class">.allOf</span>(
    futures.<span class="hljs-built_in">toArray</span>(new CompletableFuture[<span class="hljs-number">0</span>]))
    <span class="hljs-selector-class">.thenApply</span>(v -&gt; futures.<span class="hljs-built_in">stream</span>()
        .<span class="hljs-built_in">map</span>(<span class="hljs-attribute">CompletableFuture</span>::join)
        .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>()))
    <span class="hljs-selector-class">.join</span>();
</code></pre>
<p>这样可以确保异常被正确记录，而且不会中断其他任务。最后收集结果时，可以检查每个 Result 是成功还是失败，做相应的处理。</p>
<h2 data-id="heading-6">性能测试：看清并发度曲线</h2>
<p>为了验证上面提到的几个问题，我们来做一组对比实验。任务场景是查询用户信息并计算积分，单次查询耗时约 10 毫秒。数据库连接池配置 20 个连接。</p>
<p>测试代码：</p>
<pre><code class="hljs language-ini" lang="ini">// 串行处理
long <span class="hljs-attr">start</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
for (int userId : userIds) {
    User <span class="hljs-attr">user</span> = queryUser(userId)<span class="hljs-comment">;</span>
    calculatePoints(user)<span class="hljs-comment">;</span>
}
long <span class="hljs-attr">serialTime</span> = System.currentTimeMillis() - start<span class="hljs-comment">;</span>

// 并行处理（不同并发度）
for (int concurrency : new int<span class="hljs-section">[]</span>{10, 20, 50, 100, 200}) {
    ExecutorService <span class="hljs-attr">executor</span> = Executors.newFixedThreadPool(concurrency)<span class="hljs-comment">;</span>
    Semaphore <span class="hljs-attr">semaphore</span> = new Semaphore(<span class="hljs-number">20</span>)<span class="hljs-comment">; // 限制数据库并发</span>
    
    <span class="hljs-attr">start</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
    List&lt;CompletableFuture&lt;Void&gt;&gt; <span class="hljs-attr">futures</span> = userIds.stream()
        .map(userId -&gt; CompletableFuture.runAsync(() -&gt; {
            try {
                semaphore.acquire()<span class="hljs-comment">;</span>
                User <span class="hljs-attr">user</span> = queryUser(userId)<span class="hljs-comment">;</span>
                calculatePoints(user)<span class="hljs-comment">;</span>
            } finally {
                semaphore.release()<span class="hljs-comment">;</span>
            }
        }, executor))
        .collect(Collectors.toList())<span class="hljs-comment">;</span>
    
    CompletableFuture.allOf(futures.toArray(new CompletableFuture<span class="hljs-section">[0]</span>)).join()<span class="hljs-comment">;</span>
    long <span class="hljs-attr">parallelTime</span> = System.currentTimeMillis() - start<span class="hljs-comment">;</span>
    
    System.out.printf("Concurrency: %d, Time: %dms, Speedup: %.2fx%n",
        concurrency, parallelTime, (double)serialTime / parallelTime)<span class="hljs-comment">;</span>
    
    executor.shutdown()<span class="hljs-comment">;</span>
}
</code></pre>
<p>测试结果（处理 1000 个用户）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Serial:</span> <span class="hljs-string">10200ms</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">10</span><span class="hljs-string">,</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">1050ms,</span> <span class="hljs-attr">Speedup:</span> <span class="hljs-number">9.</span><span class="hljs-string">71x</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">20</span><span class="hljs-string">,</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">530ms,</span> <span class="hljs-attr">Speedup:</span> <span class="hljs-number">19.</span><span class="hljs-string">25x</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">50</span><span class="hljs-string">,</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">540ms,</span> <span class="hljs-attr">Speedup:</span> <span class="hljs-number">18.</span><span class="hljs-string">89x</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">100</span><span class="hljs-string">,</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">650ms,</span> <span class="hljs-attr">Speedup:</span> <span class="hljs-number">15.</span><span class="hljs-string">69x</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">200</span><span class="hljs-string">,</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">890ms,</span> <span class="hljs-attr">Speedup:</span> <span class="hljs-number">11.</span><span class="hljs-string">46x</span>
</code></pre>
<p>可以看到，并发度在 20 时达到最佳性能，这正好等于数据库连接池大小。再往上加，性能反而下降了。</p>
<p>我又去掉了信号量限制，让所有线程直接竞争连接池：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Concurrency:</span> <span class="hljs-number">50</span> <span class="hljs-string">(no</span> <span class="hljs-string">semaphore),</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">1200ms</span>
<span class="hljs-attr">Concurrency:</span> <span class="hljs-number">100</span> <span class="hljs-string">(no</span> <span class="hljs-string">semaphore),</span> <span class="hljs-attr">Time:</span> <span class="hljs-string">1850ms</span>
</code></pre>
<p>性能显著变差，因为大量线程阻塞在等待连接上。</p>
<p>最后测试任务粒度的影响。把 1000 个任务打包成不同批次：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-number">1000</span> tasks individually: <span class="hljs-number">2100</span>ms
<span class="hljs-number">100</span> batches (<span class="hljs-number">10</span> tasks <span class="hljs-keyword">each</span>): <span class="hljs-number">180</span>ms
<span class="hljs-number">10</span> batches (<span class="hljs-number">100</span> tasks <span class="hljs-keyword">each</span>): <span class="hljs-number">95</span>ms
<span class="hljs-number">1</span> batch (<span class="hljs-number">1000</span> tasks): <span class="hljs-number">10200</span>ms (serial)
</code></pre>
<p>批次大小在 50 到 100 之间时效果最好，既减少了调度开销，又保留了并行度。</p>
<h2 data-id="heading-7">写在最后</h2>
<p>开头的事故，后来怎么修复的？其实并不复杂：任务粒度收粗、I/O 和 CPU 分池、并发度按连接池容量卡住、批量提交加窗口、每个任务加超时与降级。</p>
<p>CompletableFuture 适合用在需要并发表达、需要组合与编排的场景。</p>
<p>吾日三省吾身。</p>
<p>使用CompletableFuture时，最好也先想清楚几个问题：单任务是否足够重、共享资源是否充足、下游是否能承受并发、队列是否有上界、失败和超时是否可控。</p>
<p>有了答案，再去落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis类型处理模块详解]]></title>    <link>https://juejin.cn/post/7589908657682628658</link>    <guid>https://juejin.cn/post/7589908657682628658</guid>    <pubDate>2026-01-02T00:33:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7589908657682628658" data-draft-id="7589903499599429686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis类型处理模块详解"/> <meta itemprop="keywords" content="MyBatis,Java"/> <meta itemprop="datePublished" content="2026-01-02T00:33:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis类型处理模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T00:33:08.000Z" title="Fri Jan 02 2026 00:33:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解MyBatis类型转换机制，掌握Java与JDBC之间的桥梁</h2>
<h2 data-id="heading-1">一、MyBatis整体架构与类型处理模块</h2>
<p>在深入类型处理模块之前，我们先了解MyBatis的整体架构，以及类型处理模块在其中的重要地位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa3fb0c4d5a7446ca23a602eccd2c6f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=wtUr2ytFVsbv4eNXpEOp1UhkPnA%3D" alt="" loading="lazy"/></p>
<p>从架构图可以看出，MyBatis采用了分层架构设计，而类型处理模块（TypeHandler）位于基础支撑层，是连接Java类型与JDBC类型的桥梁。它负责在SQL执行过程中，将Java对象参数转换为JDBC能够识别的参数类型，以及将ResultSet中的数据转换为Java对象。</p>
<h2 data-id="heading-2">型处理模块的核心职责</h2>
<p>类型处理模块主要承担以下核心职责：</p>
<pre><code class="hljs language-sql" lang="sql">✅ Java类型与JDBC类型相互转换 <span class="hljs-operator">-</span> 实现双向类型转换
✅ 参数设置时的类型转换 <span class="hljs-operator">-</span> 将Java参数转换为JDBC参数
✅ 结果集获取时的类型转换 <span class="hljs-operator">-</span> 将JDBC结果转换为Java对象
✅ <span class="hljs-keyword">Null</span>值处理 <span class="hljs-operator">-</span> 处理Java空值与JDBC <span class="hljs-keyword">NULL</span>的转换
✅ 类型注册与管理 <span class="hljs-operator">-</span> 维护Java类型与TypeHandler的映射关系
</code></pre>
<h2 data-id="heading-3">为什么需要TypeHandler？</h2>
<p>在Java应用程序和数据库之间，存在着类型系统的差异：</p>



































<table><thead><tr><th>Java类型</th><th>JDBC类型</th><th>说明</th></tr></thead><tbody><tr><td>String</td><td>VARCHAR, CHAR</td><td>字符串类型</td></tr><tr><td>Integer</td><td>INTEGER</td><td>整数类型</td></tr><tr><td>Long</td><td>BIGINT</td><td>长整数类型</td></tr><tr><td>Date</td><td>TIMESTAMP</td><td>日期时间类型</td></tr><tr><td>BigDecimal</td><td>NUMERIC</td><td>精确数值类型</td></tr></tbody></table>
<p>TypeHandler的核心作用就是解决这些类型之间的映射和转换问题。</p>
<h2 data-id="heading-4">二、TypeHandler体系架构</h2>
<p>TypeHandler采用了泛型接口设计，支持各种类型的扩展。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ad51ae683ef4acaa902418b69e1a75b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=SzXgf14IkE6foO9Sa0ZNOmOtSb8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">TypeHandler接口</h2>
<p>TypeHandler是类型转换的核心接口，定义了类型转换的基本方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; {
    <span class="hljs-comment">// 设置PreparedStatement参数（Java → JDBC）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, 
                     T parameter, JdbcType jdbcType)</span> 
                     <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 获取ResultSet结果（JDBC → Java，按列名）</span>
    T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> 
               <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 获取ResultSet结果（JDBC → Java，按列索引）</span>
    T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> 
               <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-comment">// 获取CallableStatement结果（存储过程）</span>
    T <span class="hljs-title function_">getResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> 
               <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<h2 data-id="heading-6">BaseTypeHandler抽象类</h2>
<p>为了简化TypeHandler的实现，MyBatis提供了BaseTypeHandler抽象类，它帮我们处理了Null值检查等通用逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;T&gt; 
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, 
                            T parameter, JdbcType jdbcType)</span> 
                            <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">if</span> (parameter == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 处理Null值</span>
            ps.setNull(i, jdbcType.TYPE_CODE);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 设置非空参数，由子类实现</span>
            setNonNullParameter(ps, i, parameter, jdbcType);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> 
                      <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(rs, columnName);
        <span class="hljs-comment">// 检查是否为null</span>
        <span class="hljs-keyword">return</span> rs.wasNull() ? <span class="hljs-literal">null</span> : result;
    }

    <span class="hljs-comment">// 抽象方法，由子类实现</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(
        PreparedStatement ps, <span class="hljs-type">int</span> i, 
        T parameter, JdbcType jdbcType)</span> 
        <span class="hljs-keyword">throws</span> SQLException;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, String columnName)</span> 
        <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<h2 data-id="heading-7">TypeHandler继承体系</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26bad2f4c5c04afb89f4562dafd21504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=seTQVfs5hUvlRob5Vz3jihj5V5Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">三、类型转换双向流程</h2>
<p>TypeHandler实现了Java类型与JDBC类型之间的双向转换。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f9997be96a74b76859dc8ce2cc2a2e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=R66jf4fAEP4quOgUYQxhR1ryAzk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">Java → JDBC 转换流程</h2>
<p>当执行SQL语句时，需要将Java参数转换为JDBC参数：</p>
<pre><code class="hljs language-ini" lang="ini">// 1. ParameterHandler获取参数值
Object <span class="hljs-attr">value</span> = getParameterValue(
    parameterObject, parameterMapping)<span class="hljs-comment">;</span>

// 2. 获取对应的TypeHandler
TypeHandler&lt;?&gt; <span class="hljs-attr">typeHandler</span> = 
    parameterMapping.getTypeHandler()<span class="hljs-comment">;</span>

// 3. 调用setParameter设置参数
typeHandler.setParameter(ps, i + 1, value, jdbcType)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-10">JDBC → Java 转换流程</h2>
<p>当从ResultSet获取结果时，需要将JDBC数据转换为Java对象：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. ResultSetHandler处理ResultSet</span>
while (resultSet.next()) {
    <span class="hljs-comment">// 2. 根据ResultMapping获取TypeHandler</span>
    TypeHandler&lt;?&gt; typeHandler = 
        resultMapping<span class="hljs-selector-class">.getTypeHandler</span>();

    <span class="hljs-comment">// 3. 调用getResult获取结果</span>
    <span class="hljs-selector-tag">Object</span> value = typeHandler<span class="hljs-selector-class">.getResult</span>(
        resultSet, column);

    <span class="hljs-comment">// 4. 设置到目标对象</span>
    metaObject<span class="hljs-selector-class">.setValue</span>(property, value);
}
</code></pre>
<h2 data-id="heading-11">四、参数设置时的类型转换</h2>
<p>参数设置是Java类型向JDBC类型转换的过程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a139f1c5f914effbc2d910d4b21482f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=JQ5i9FSDz4Y6XO951gOfIG5S5vg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">基本类型转换示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringTypeHandler</span> 
    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;String&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(
        PreparedStatement ps, <span class="hljs-type">int</span> i, 
        String parameter, JdbcType jdbcType)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// String → VARCHAR</span>
        ps.setString(i, parameter);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, String columnName)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// VARCHAR → String</span>
        <span class="hljs-keyword">return</span> rs.getString(columnName);
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongTypeHandler</span> 
    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;Long&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(
        PreparedStatement ps, <span class="hljs-type">int</span> i, 
        Long parameter, JdbcType jdbcType)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// Long → BIGINT</span>
        ps.setLong(i, parameter);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, String columnName)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// BIGINT → Long</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getLong(columnName);
        <span class="hljs-comment">// ⚠️ 关键：检查是否为NULL</span>
        <span class="hljs-keyword">return</span> value == <span class="hljs-number">0</span> &amp;&amp; rs.wasNull() ? <span class="hljs-literal">null</span> : value;
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTypeHandler</span> 
    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;Date&gt; {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(
        PreparedStatement ps, <span class="hljs-type">int</span> i, 
        Date parameter, JdbcType jdbcType)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// Date → Timestamp</span>
        ps.setTimestamp(i, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timestamp</span>(parameter.getTime()));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, String columnName)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// Timestamp → Date</span>
        <span class="hljs-type">Timestamp</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> rs.getTimestamp(columnName);
        <span class="hljs-keyword">return</span> timestamp == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : 
               <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(timestamp.getTime());
    }
}
</code></pre>
<h2 data-id="heading-13">Null值处理</h2>
<p>Null值处理是参数设置中的重要环节：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 场景1：明确的jdbcType --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertUser"</span>&gt;</span>
    INSERT INTO t_user (name, email)
    VALUES (
        #{name, jdbcType=VARCHAR}, 
        #{email, jdbcType=VARCHAR}
    )
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 场景2：全局配置Null的jdbcType --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcTypeForNull"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"NULL"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>重要提示：未指定jdbcType时，传入null参数会抛出异常！</p>
<h2 data-id="heading-14">五、结果集获取时的类型转换</h2>
<p>结果集获取是JDBC类型向Java类型转换的过程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8f85705b7994c8da2d333c98536eced~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=a4y9WD%2B28op%2FvBRBXoVesQBIlhM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">ResultSet结果获取流程</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 遍历ResultSet的完整流程</span>
while (resultSet.next()) {
    for (ResultMapping mapping : 
         resultMap.getPropertyResultMappings()) {

        <span class="hljs-comment">// 获取列名</span>
        String column = mapping<span class="hljs-selector-class">.getColumn</span>();

        <span class="hljs-comment">// 获取TypeHandler</span>
        TypeHandler&lt;?&gt; handler = 
            mapping<span class="hljs-selector-class">.getTypeHandler</span>();

        <span class="hljs-comment">// 获取结果值</span>
        <span class="hljs-selector-tag">Object</span> value = handler<span class="hljs-selector-class">.getResult</span>(
            resultSet, column);

        <span class="hljs-comment">// 设置到目标对象</span>
        metaObject<span class="hljs-selector-class">.setValue</span>(
            mapping.getProperty(), value);
    }
}
</code></pre>
<h2 data-id="heading-16">三种getResult方式</h2>
<p>TypeHandler提供了三种获取结果的方式：</p>
<pre><code class="hljs language-arduino" lang="arduino">@<span class="hljs-function">Override
<span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getNullableResult</span><span class="hljs-params">(
    ResultSet rs, <span class="hljs-type">String</span> columnName)</span> 
    throws SQLException </span>{
    <span class="hljs-keyword">return</span> rs.<span class="hljs-built_in">getString</span>(columnName);
}
</code></pre>
<p>使用场景：</p>
<pre><code class="hljs language-java" lang="java">&lt;result column=<span class="hljs-string">"user_name"</span> property=<span class="hljs-string">"userName"</span>/&gt;
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
    ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> 
    <span class="hljs-keyword">throws</span> SQLException {
    <span class="hljs-keyword">return</span> rs.getString(columnIndex);
}
</code></pre>
<p>使用场景：自动映射或需要按索引获取时</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
    CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> 
    <span class="hljs-keyword">throws</span> SQLException {
    <span class="hljs-keyword">return</span> cs.getString(columnIndex);
}
</code></pre>
<p>使用场景：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"callProcedure" statementType<span class="hljs-operator">=</span>"CALLABLE"<span class="hljs-operator">&gt;</span>
    {<span class="hljs-keyword">call</span> get_user_info(
        #{userId, mode<span class="hljs-operator">=</span><span class="hljs-keyword">IN</span>, jdbcType<span class="hljs-operator">=</span><span class="hljs-type">BIGINT</span>},
        #{userName, mode<span class="hljs-operator">=</span><span class="hljs-keyword">OUT</span>, jdbcType<span class="hljs-operator">=</span><span class="hljs-type">VARCHAR</span>}
    )}
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
<h2 data-id="heading-17">wasNull()的重要性</h2>
<p>在类型转换中，wasNull()方法非常关键：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
    ResultSet rs, String columnName)</span> 
    <span class="hljs-keyword">throws</span> SQLException {

    <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getLong(columnName);
    <span class="hljs-comment">// ⚠️ 如果数据库是NULL，getLong()返回0</span>

    <span class="hljs-comment">// ✅ 必须检查wasNull()区分真实的0和NULL</span>
    <span class="hljs-keyword">return</span> value == <span class="hljs-number">0</span> &amp;&amp; rs.wasNull() ? <span class="hljs-literal">null</span> : value;
}
</code></pre>
<h2 data-id="heading-18">六、TypeHandler注册机制</h2>
<p>TypeHandlerRegistry负责管理所有TypeHandler的注册和查找。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/089b9e45490544f1bfe3881634b176d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767918788&amp;x-signature=ECN3JC3i9YWAkTLsa5To5ZUoe8Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-19">TypeHandlerRegistry结构</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeHandlerRegistry</span> {
    <span class="hljs-comment">// JDBC类型 → TypeHandler</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; 
        jdbcTypeHandlerMap = <span class="hljs-keyword">new</span> EnumMap&lt;&gt;(JdbcType.<span class="hljs-keyword">class</span>);

    <span class="hljs-comment">// Java类型 → (JDBC类型 → TypeHandler)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; 
        typeHandlerMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    <span class="hljs-comment">// Java类型 → 默认TypeHandler</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; 
        allTypeHandlersMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TypeHandlerRegistry</span><span class="hljs-params">()</span></span>{
        <span class="hljs-comment">// 注册所有内置TypeHandler</span>
        <span class="hljs-built_in">register</span>(Boolean.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">BooleanTypeHandler</span>());
        <span class="hljs-built_in">register</span>(Integer.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">IntegerTypeHandler</span>());
        <span class="hljs-built_in">register</span>(Long.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">LongTypeHandler</span>());
        <span class="hljs-built_in">register</span>(<span class="hljs-type">String</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">StringTypeHandler</span>());
        <span class="hljs-built_in">register</span>(Date.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">DateTypeHandler</span>());
        <span class="hljs-comment">// ... 更多注册</span>
    }
}
</code></pre>
<h2 data-id="heading-20">注册TypeHandler的四种方式</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">
    Class&lt;T&gt; javaType, 
    TypeHandler&lt;? <span class="hljs-keyword">extends</span> T&gt; typeHandler</span>) {
    <span class="hljs-title function_">register</span>((<span class="hljs-title class_">Type</span>) javaType, typeHandler);
}
<span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">
    Class&lt;T&gt; <span class="hljs-keyword">type</span>, 
    JdbcType jdbcType, 
    TypeHandler&lt;? <span class="hljs-keyword">extends</span> T&gt; typeHandler</span>) {
    <span class="hljs-title function_">register</span>((<span class="hljs-title class_">Type</span>) <span class="hljs-keyword">type</span>, jdbcType, typeHandler);
}
<span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">
    TypeReference&lt;T&gt; javaTypeReference, 
    TypeHandler&lt;? <span class="hljs-keyword">extends</span> T&gt; typeHandler</span>) {
    <span class="hljs-title function_">register</span>(javaTypeReference.<span class="hljs-title function_">getRawType</span>(), 
             typeHandler);
}
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> packageName</span>) {
    <span class="hljs-title class_">ResolverUtil</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;&gt; resolverUtil = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>&lt;&gt;();
    resolverUtil.<span class="hljs-title function_">find</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>.<span class="hljs-title class_">IsA</span>(<span class="hljs-title class_">TypeHandler</span>.<span class="hljs-property">class</span>), 
        packageName);

    <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Class</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span>&lt;?&gt;&gt;&gt; handlerSet = 
        resolverUtil.<span class="hljs-title function_">getClasses</span>();

    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Class</span>&lt;?&gt; <span class="hljs-keyword">type</span> : handlerSet) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">type</span>.<span class="hljs-title function_">isAnonymousClass</span>() &amp;&amp; 
            !<span class="hljs-keyword">type</span>.<span class="hljs-title function_">isInterface</span>() &amp;&amp; 
            !<span class="hljs-title class_">Modifier</span>.<span class="hljs-title function_">isAbstract</span>(<span class="hljs-keyword">type</span>.<span class="hljs-title function_">getModifiers</span>())) {
            <span class="hljs-title function_">register</span>(<span class="hljs-keyword">type</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-21">查找TypeHandler</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 根据Java类型和JDBC类型查找</span>
<span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span>(<span class="hljs-params">
    Class&lt;T&gt; <span class="hljs-keyword">type</span>, JdbcType jdbcType</span>) {

    <span class="hljs-comment">// 1. 从Java类型映射中查找</span>
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">JdbcType</span>, <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; jdbcHandlerMap = 
        typeHandlerMap.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>);

    <span class="hljs-keyword">if</span> (jdbcHandlerMap != <span class="hljs-literal">null</span>) {
        <span class="hljs-title class_">TypeHandler</span>&lt;?&gt; handler = 
            jdbcHandlerMap.<span class="hljs-title function_">get</span>(jdbcType);
        <span class="hljs-keyword">if</span> (handler != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> (<span class="hljs-title class_">TypeHandler</span>&lt;T&gt;) handler;
        }
    }

    <span class="hljs-comment">// 2. 查找默认TypeHandler</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-title class_">TypeHandler</span>&lt;T&gt;) <span class="hljs-title function_">getTypeHandler</span>((<span class="hljs-title class_">Type</span>) <span class="hljs-keyword">type</span>);
}
</code></pre>
<h2 data-id="heading-22">七、自定义TypeHandler</h2>
<p>当内置TypeHandler无法满足需求时，可以自定义TypeHandler。</p>
<h2 data-id="heading-23">实现TypeHandler接口</h2>
<p>下面是一个JSON类型处理器的完整示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@MappedTypes(List.class)</span>
<span class="hljs-meta">@MappedJdbcTypes(JdbcType.VARCHAR)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonListTypeHandler</span> 
    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;List&lt;String&gt;&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Gson</span> <span class="hljs-variable">GSON</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Type</span> <span class="hljs-variable">LIST_TYPE</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeToken</span>&lt;List&lt;String&gt;&gt;(){}.getType();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(
        PreparedStatement ps, <span class="hljs-type">int</span> i, 
        List&lt;String&gt; parameter, JdbcType jdbcType)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// List&lt;String&gt; → JSON字符串</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> GSON.toJson(parameter);
        ps.setString(i, json);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, String columnName)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// JSON字符串 → List&lt;String&gt;</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> rs.getString(columnName);
        <span class="hljs-keyword">return</span> parseJson(json);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> rs.getString(columnIndex);
        <span class="hljs-keyword">return</span> parseJson(json);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(
        CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> 
        <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> cs.getString(columnIndex);
        <span class="hljs-keyword">return</span> parseJson(json);
    }

    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">parseJson</span><span class="hljs-params">(String json)</span> {
        <span class="hljs-keyword">if</span> (json == <span class="hljs-literal">null</span> || json.trim().isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> GSON.fromJson(json, LIST_TYPE);
    }
}
</code></pre>
<h2 data-id="heading-24">枚举类型处理</h2>
<p>MyBatis提供了两种枚举类型处理器：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnumTypeHandler&lt;E</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Enum&lt;E&gt;&gt;</span> </span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">BaseTypeHandler</span>&lt;<span class="hljs-type">E</span>&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">E</span>&gt; <span class="hljs-class"><span class="hljs-keyword">type</span></span>;

    <span class="hljs-meta">@Override</span>
    public void setNonNullParameter(
        <span class="hljs-type">PreparedStatement</span> ps, int i, 
        <span class="hljs-type">E</span> parameter, <span class="hljs-type">JdbcType</span> jdbcType) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">SQLException</span> {
        <span class="hljs-comment">// Enum → name (VARCHAR)</span>
        ps.setString(i, parameter.name());
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">E</span> getNullableResult(
        <span class="hljs-type">ResultSet</span> rs, <span class="hljs-type">String</span> columnName) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">SQLException</span> {
        <span class="hljs-comment">// name → Enum</span>
        <span class="hljs-type">String</span> name = rs.getString(columnName);
        <span class="hljs-keyword">return</span> name == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : 
               <span class="hljs-type">Enum</span>.valueOf(<span class="hljs-class"><span class="hljs-keyword">type</span>, <span class="hljs-title">name</span>)</span>;
    }
}
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnumOrdinalTypeHandler&lt;E</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Enum&lt;E&gt;&gt;</span> </span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">BaseTypeHandler</span>&lt;<span class="hljs-type">E</span>&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">E</span>&gt; <span class="hljs-class"><span class="hljs-keyword">type</span></span>;

    <span class="hljs-meta">@Override</span>
    public void setNonNullParameter(
        <span class="hljs-type">PreparedStatement</span> ps, int i, 
        <span class="hljs-type">E</span> parameter, <span class="hljs-type">JdbcType</span> jdbcType) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">SQLException</span> {
        <span class="hljs-comment">// Enum → ordinal (INTEGER)</span>
        ps.setInt(i, parameter.ordinal());
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">E</span> getNullableResult(
        <span class="hljs-type">ResultSet</span> rs, <span class="hljs-type">String</span> columnName) 
        <span class="hljs-keyword">throws</span> <span class="hljs-type">SQLException</span> {
        <span class="hljs-comment">// ordinal → Enum</span>
        int ordinal = rs.getInt(columnName);
        <span class="hljs-keyword">if</span> (ordinal == <span class="hljs-number">0</span> &amp;&amp; rs.wasNull()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-type">E</span>[] enums = <span class="hljs-keyword">type</span>.getEnumConstants();
        <span class="hljs-keyword">return</span> enums[ordinal];
    }
}
</code></pre>
<h2 data-id="heading-25">注册自定义TypeHandler的三种方式</h2>
<pre><code class="hljs language-xml" lang="xml">@MappedTypes(List.class)
@MappedJdbcTypes(JdbcType.VARCHAR)
public class JsonListTypeHandler 
    extends BaseTypeHandler&lt;List<span class="hljs-tag">&lt;<span class="hljs-name">String</span>&gt;</span>&gt; {
    // 实现代码...
}
<span class="hljs-tag">&lt;<span class="hljs-name">typeHandlers</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 指定类名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeHandler</span> 
        <span class="hljs-attr">handler</span>=<span class="hljs-string">"com.example.JsonListTypeHandler"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 指定Java类型和JDBC类型 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">typeHandler</span> 
        <span class="hljs-attr">javaType</span>=<span class="hljs-string">"java.util.List"</span>
        <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>
        <span class="hljs-attr">handler</span>=<span class="hljs-string">"com.example.JsonListTypeHandler"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 包扫描 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.typehandler"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">typeHandlers</span>&gt;</span>
@Configuration
public class MyBatisConfig {
    @Bean
    public ConfigurationCustomizer 
        configurationCustomizer() {
        return configuration -&gt; {
            TypeHandlerRegistry registry = 
                configuration.getTypeHandlerRegistry();
            registry.register(
                List.class, 
                JdbcType.VARCHAR, 
                new JsonListTypeHandler()
            );
        };
    }
}
</code></pre>
<h2 data-id="heading-26">八、最佳实践</h2>
<h2 data-id="heading-27">问题1：类型转换异常</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 问题：Cannot <span class="hljs-keyword">convert</span> <span class="hljs-keyword">value</span> <span class="hljs-string">'0000'</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">column</span> <span class="hljs-number">1</span> <span class="hljs-keyword">to</span> <span class="hljs-type">TIMESTAMP</span>
<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 原因：日期格式不匹配
<span class="hljs-operator">/</span><span class="hljs-operator">/</span> 解决：使用正确的日期类型或自定义TypeHandler
</code></pre>
<h2 data-id="heading-28">问题2：Null值处理</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 问题：JDBC requires that the JdbcType must be specified</span>
<span class="hljs-comment">// 解决1：指定jdbcType</span>
<span class="hljs-meta">#{name, jdbcType=VARCHAR}</span>

<span class="hljs-comment">// 解决2：全局配置</span>
&lt;setting name=<span class="hljs-string">"jdbcTypeForNull"</span> <span class="hljs-keyword">value</span>=<span class="hljs-string">"NULL"</span>/&gt;
</code></pre>
<h2 data-id="heading-29">问题3：枚举类型处理</h2>
<pre><code class="hljs language-ini" lang="ini">// 配置默认枚举处理器
&lt;settings&gt;
    &lt;setting <span class="hljs-attr">name</span>=<span class="hljs-string">"defaultEnumTypeHandler"</span> value=<span class="hljs-string">"org.apache.ibatis.type.EnumTypeHandler"</span>/&gt;
&lt;/settings&gt;

// 或在ResultMap中指定
&lt;result <span class="hljs-attr">column</span>=<span class="hljs-string">"status"</span> property=<span class="hljs-string">"status"</span>
         <span class="hljs-attr">typeHandler</span>=<span class="hljs-string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span>/&gt;
</code></pre>
<h2 data-id="heading-30">九、总结</h2>
<p>MyBatis的类型处理模块是整个框架的基础组件，通过精心设计的TypeHandler体系，实现了Java类型与JDBC类型的无缝转换。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Weex 底层原理与 APM]]></title>    <link>https://juejin.cn/post/7590575755491328054</link>    <guid>https://juejin.cn/post/7590575755491328054</guid>    <pubDate>2026-01-02T02:21:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590575755491328054" data-draft-id="7589916567876354090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Weex 底层原理与 APM"/> <meta itemprop="keywords" content="前端框架,iOS,Weex"/> <meta itemprop="datePublished" content="2026-01-02T02:21:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杭城小刘"/> <meta itemprop="url" content="https://juejin.cn/user/3175045309408429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Weex 底层原理与 APM
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3175045309408429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杭城小刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-02T02:21:46.000Z" title="Fri Jan 02 2026 02:21:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读42分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从 Vue 组件库（Vue Lib）到 Weex 渲染为 iOS 原生 UIKit 元素，核心是 “Virtual DOM → 跨线程通信 → Native DOM 构建 → 布局计算 → 原生 View 渲染 → 事件反向绑定” 的完整链路。Weex 作为中间层，主要完成 7 大核心工作，接下去看看详细内容.</p>
<p>Weex 侧 APM 该怎么开展？</p>
</blockquote>
<h2 data-id="heading-0">一、核心步骤</h2>
<p>从 Vue Lib 到 Weex 原生 UIKit 元素的完整流程。</p>
<p>首先，用户的需求是 “列举 Weex 做的事情” 并 “结合最新源码标位置”，所以思考过程要先拆解流程：从 Vue 编译产物处理、JS-Native 通信、Virtual DOM 解析、DOM 构建与布局计算、渲染指令生成、原生 View 创建与更新，这几个核心步骤。每个步骤都要对应 Weex 的具体工作，还要找到最新源码中的对应类和方法。</p>
<p>第一步，应该是 Vue 编译产物的适配。因为 Vue 写的代码要被 Weex 识别，Weex 需要处理 Vue 的模板编译结果（比如 render 函数生成的 Virtual DOM），还要注入 Weex 的 JS Runtime API。这里要找最新源码中 JS Runtime 的初始化类，比如 WXJSContext 或 WXBridgeCore，因为 JS 环境的搭建是第一步。</p>
<p>第二步，JS-Native 通信的建立。Vue 的 Virtual DOM 变化需要传递给 Native，所以 Weex 的 Bridge 核心要注册通信方法（比如 callNative），这里对应 WXBridgeCore 的 invokeNative 方法，之前讨论过 bridge 队列，这里要结合最新源码中通信任务的调度。</p>
<p>第三步，Virtual DOM 的解析与 DOM 树构建。Weex 需要把 Vue 的 Virtual DOM（JSON 结构）解析成 Native 侧的 DOM 节点（WXDOMNode），这部分现在在 WXDOMCore 中，比如 createNode 方法，处理节点创建、属性更新，还要维护 DOM 树结构。</p>
<p>第四步，样式解析与 Yoga 布局计算。Vue 的样式（比如 flex）要被 Weex 解析，转换为 Yoga 的布局属性，然后在 dom 线程计算布局，这部分在 WXDOMCore 的_scheduleLayout 方法，调用 Yoga 的 calculateLayout。</p>
<p>第五步，渲染指令生成与传递。DOM 和布局计算完成后，要把结果封装成渲染指令（节点 ID、frame、类型等），通过主线程传递给渲染核心，这里是 WXDOMCore 的_notifyRender 方法，切换到 main queue。</p>
<p>第六步，原生 UIKit 元素的创建与更新。渲染核心（WXRenderCore）接收指令，创建对应 UIKit 控件（UILabel、UIImageView 等），或复用已有 View，更新 frame 和样式，这部分在 WXRenderCore 的 render 方法，还有具体的 View 工厂类（比如 WXViewFactory）。</p>
<p>第七步，事件绑定与反向通信。原生 UI 的事件（比如点击）要传递回 Vue，Weex 需要注册 Native 事件，通过 Bridge 回调 JS，这里对应 WXEventDispatcher 和 WXBridgeCore 的 callbackJS 方法。</p>
<p>具体的逻辑不做深入探讨，可以查看源码研究。</p>
<h2 data-id="heading-1">二、Yoga</h2>
<h3 data-id="heading-2">1. 支持"增量布局更新"</h3>
<p>当组件样式变化时，Yoga 仅重新计算受影响的组件树分支，而非全量重算，大幅减少 RN 应用的布局耗时和卡顿』Yoga 是如何实现仅计算受影响的组件树分支的？类似有个打标记，标记为 dirty？</p>
<p>Yoga 实现增量布局的核心就是 「Dirty 标记机制」+「组件树依赖传播」—— 通过标记 “受影响的节点”，并仅处理这些节点及其关联分支，避免全量重算。</p>
<h4 data-id="heading-3">1. YogaNode 与 Dirty 状态标识</h4>
<p>Yoga 中每个组件对应一个 YogaNode（布局计算的最小单元），每个节点都包含 3 个关键状态标记（用于判断是否需要重算）：</p>
<ul>
<li>dirtyFlags（核心标记）：记录节点的 “脏状态类型”，主要分两类：
<ul>
<li>LAYOUT_DIRTY：节点自身样式（如 width、flex）或子节点布局变化，需要重新计算自身布局；</li>
<li>MEASURE_DIRTY：节点的测量相关属性（如 measureFunction 自定义测量逻辑）变化，需要先重新测量尺寸，再计算布局。</li>
</ul>
</li>
<li>isLayoutClean：布尔值，快速判断节点是否 “干净”（无脏状态），避免重复检查 dirtyFlags；</li>
<li>childCount + children 指针：维护子节点列表，用于后续遍历依赖分支。</li>
</ul>
<h4 data-id="heading-4">2. 脏状态触发与传播：从 “变化节点” 到 “根节点” 的冒泡</h4>
<p>当组件样式变化时（如 RN 中修改 style={{ flex: 2 }}），Yoga 会触发以下流程：</p>
<ul>
<li>
<p>步骤 1：标记自身为 Dirty
直接修改变化节点的 dirtyFlags |= LAYOUT_DIRTY（或 MEASURE_DIRTY），同时设置 isLayoutClean = false。</p>
</li>
<li>
<p>步骤 2：向上冒泡通知父节点
由于父节点的布局（如尺寸、位置）依赖子节点的布局结果（比如父节点是 flex:1，子节点尺寸变化会影响父节点的剩余空间分配），因此会递归向上遍历父节点，直到根节点，将所有 “依赖节点” 都标记为 LAYOUT_DIRTY。
关键优化：父节点仅标记 “需要重算”，但不会立即计算，避免中途重复触发计算。</p>
</li>
<li>
<p>步骤 3：跳过已标记的节点
若某个节点已被标记为 Dirty，后续重复触发时会直接跳过（避免重复冒泡），提升效率。</p>
</li>
</ul>
<h4 data-id="heading-5">3. 布局计算阶段：只处理 Dirty 分支，跳过干净节点（DFS）</h4>
<p>当 Yoga 触发布局计算（如 RN 渲染帧触发、组件挂载完成）时，会从根节点开始遍历组件树，但仅处理 “Dirty 节点及其子树”：</p>
<ul>
<li>
<p>步骤 1：根节点判断状态
若根节点是干净的（isLayoutClean = true），直接终止计算（全量跳过）；若为 Dirty，进入分支处理。</p>
</li>
<li>
<p>步骤 2：递归处理 Dirty 分支
对每个节点，先检查自身状态：</p>
</li>
<li>
<p>若干净：直接复用上次缓存的布局结果（x/y/width/height），不重算；</p>
</li>
<li>
<p>若 Dirty：</p>
<ul>
<li>先处理子节点：如果子节点是 Dirty，先递归计算子节点布局（保证父节点计算时依赖的子节点数据是最新的）；</li>
<li>再计算自身布局：根据 Flex 规则（如 flexDirection、justifyContent）和子节点布局结果，计算自身的最终尺寸和位置；</li>
<li>清除 Dirty 标记：计算完成后，设置 dirtyFlags = 0、isLayoutClean = true，标记为干净。</li>
</ul>
</li>
<li>
<p>步骤 3：增量更新的核心效果
比如修改一个列表项的 margin，只会标记该列表项 → 父列表容器 → 根节点为 Dirty，其他列表项、页面其他组件均为干净，会直接跳过计算，仅重算 “列表项→父容器” 这一小分支。</p>
</li>
</ul>
<h3 data-id="heading-6">2. Flex 布局逻辑如何到 Native 系统</h3>
<p>Flex 布局逻辑，或者说 DSL，是如何翻译为 iOS 的 AutoLayout 和 Android 的 LayoutParams 的？</p>
<p>Yoga 先将 Flex DSL 解析为统一的「布局计算结果」（节点的 x/y/width/height、间距、对齐方式等），再根据平台差异，将计算结果 “映射” 为对应平台的原生布局规则——iOS 映射为 AutoLayout 约束，Android 映射为 LayoutParams + 原生布局容器属性。</p>
<h4 data-id="heading-7">1. 第一步：通用前置流程（跨平台统一）</h4>
<p>无论 iOS 还是 Android，Yoga 都会先完成以下步骤，屏蔽 Flex DSL 的解析差异：</p>
<ol>
<li>解析 Flex 样式：将上层框架的 Flex 配置（如 RN 的 StyleSheet、Weex 的模板样式）解析为 YogaNode 的属性（如 flexDirection、justifyContent、margin、padding 等）；</li>
<li>执行布局计算：通过 Flexbox 算法（基于 Web 标准），计算出每个 YogaNode 的最终布局数据：</li>
</ol>
<ul>
<li>固定属性：width/height（含 auto/flex 计算后的具体数值）、x/y（相对父节点的坐标）；</li>
<li>间距属性：marginLeft/Top/Right/Bottom、paddingLeft/Top/Right/Bottom；</li>
<li>对齐属性：alignItems、justifyContent 对应的节点相对位置关系；</li>
</ul>
<ol start="3">
<li>输出标准化布局数据：将上述结果封装为平台无关的结构体，供后续平台映射使用。</li>
</ol>
<h4 data-id="heading-8">2. 第二步：iOS 端：映射为 AutoLayout 约束（NSLayoutConstraint）</h4>
<p>AutoLayout 的核心是「基于约束的关系描述」（而非直接设置坐标），因此 Yoga 会将 “计算出的具体尺寸 / 位置” 转化为 UIView 的约束（NSLayoutConstraint），核心映射规则如下：一一翻译 css 规则到 iOS AutoLayout 写法：</p>





































<table><thead><tr><th>Flex 核心属性</th><th>对应的 AutoLayout 约束逻辑</th></tr></thead><tbody><tr><td><code>width: 100</code></td><td>映射为 <code>view.widthAnchor.constraint(equalToConstant: 100)</code></td></tr><tr><td><code>height: auto</code></td><td>先通过 Yoga 计算出具体高度（如文字高度、子节点包裹高度），再映射为 <code>heightAnchor</code> 约束；若为 <code>flex:1</code>，则映射为 <code>heightAnchor.constraint(equalTo: superview.heightAnchor, multiplier: 1)</code>（占满父容器剩余高度）</td></tr><tr><td><code>marginLeft: 20</code></td><td>映射为 <code>view.leadingAnchor.constraint(equalTo: superview.leadingAnchor, constant: 20)</code></td></tr><tr><td><code>marginTop: 15</code></td><td>映射为 <code>view.topAnchor.constraint(equalTo: superview.topAnchor, constant: 15)</code></td></tr><tr><td><code>justifyContent: center</code>（父节点 flexDirection: row）</td><td>父节点约束：<code>view.centerXAnchor.constraint(equalTo: superview.centerXAnchor)</code>；若有多个子节点，通过调整子节点间的 <code>spacing</code> 约束实现均匀分布</td></tr><tr><td><code>alignItems: center</code>（父节点 flexDirection: column）</td><td>子节点约束：<code>view.centerYAnchor.constraint(equalTo: superview.centerYAnchor)</code></td></tr><tr><td><code>flex: 1</code>（子节点）</td><td>映射为 <code>view.widthAnchor.constraint(equalTo: superview.widthAnchor, multiplier: 1)</code>（横向占满）+ 父节点的 <code>distribution</code> 约束（分配剩余空间）</td></tr></tbody></table>
<p>补充信息：</p>
<ul>
<li>Yoga 会为每个 <code>UIView</code> 关联一个 <code>YogaNode</code>，布局计算完成后，通过 <code>YogaKit</code>（或上层框架如 RN 的原生层）自动生成约束；</li>
<li>支持 “约束优先级” 适配：比如 <code>flex:1</code> 对应的约束优先级会高于固定尺寸约束，确保 Flex 规则优先生效；</li>
<li>混合布局兼容：若原生视图已有部分 AutoLayout 约束，Yoga 会生成 “补充约束”，避免冲突（通过 <code>active</code>属性控制约束启用 / 禁用）。</li>
</ul>
<h2 data-id="heading-9">三、Weex 剖析</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant V as Vue组件
    participant J as JS Framework
    participant B as JS-Native Bridge
    participant N as Native引擎
    participant P as 原生UI

    V-&gt;&gt;J: .vue单文件 (template/style/script)
    Note right of J: 编译阶段&lt;br&gt;weex-loader编译Vue组件
    J-&gt;&gt;J: 生成Virtual DOM树
    Note right of J: 运行阶段&lt;br&gt;JS Framework管理VNode生命周期
    J-&gt;&gt;B: 通过callNative发送&lt;br&gt;渲染指令JSON
    Note right of B: 通信层&lt;br&gt;将JS调用转为原生模块调用
    B-&gt;&gt;N: 传递渲染指令
    Note right of N: 原生渲染引擎&lt;br&gt;WXRenderManager (Android)&lt;br&gt;WXComponent (iOS)
    N-&gt;&gt;N: 解析指令，创建/更新组件树
    N-&gt;&gt;P: 调用原生API渲染&lt;br&gt;（e.g., UIView, TextView）
    P-&gt;&gt;P: 最终原生视图
</code></pre>
<p>下面针对核心机制详解与源码定位</p>
<h3 data-id="heading-10">1. 编译阶段：从 Vue 到 Virtual DOM</h3>
<ul>
<li>处理 Vue 单文件：开发者的<code>.vue</code>文件通过 Webpack 和 <code>weex-loader</code> 编译成 JavaScript Bundle。这个 Bundle 包含了渲染页面所需的所有信息</li>
<li>生成Virtual DOM：在JS运行时，Vue.js（或 Rax）的渲染函数会生成一棵 Virtual DOM树（VNode）。Weex 的 JS Framework 会拦截常规的 DOM 操作，将其导向 Weex 的渲染管道</li>
</ul>
<p>源码相关：编译过程主要涉及 <code>weex-loader</code> (在 <code>weex-toolkit</code> 项目中)，而 JS Framework 对 VNode 的处理在 <code>js-framework</code> 目录下。重点关注 <code>src/framework.js</code> 中的 <code>Document</code> 和 <code>Element</code> 类，它们模拟了 DOM 结构</p>
<h3 data-id="heading-11">2. 指令生成与通信</h3>
<ul>
<li>
<p>序列化为渲染指令（json 数据）：JS-Framework 不会直接操作 Dom，而是把对 Dom 的操作，描述成对 VNode 对象的创建、更新、删除等，序列化成一种特殊的 JSON 格式的渲染指令。比如</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dom"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"createBody"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"ref"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"div"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>JS-Native 桥接：这些指令通过 callNative 方法，从 JS 端发送到 Native 端，同时 Native 端也可以通过 callJS 方法向 JS 端发送事件（比如用户点击）</p>
</li>
</ul>
<h3 data-id="heading-12">3. 原生端渲染</h3>
<ul>
<li>指令解析与组件渲染：Native 端的渲染引擎（如 Android 的 WXRenderManger 和 iOS 的 WXComponentManager）接收并解析 JS 指令。Weex 维护了一个从 JS 组件到原生 UI 组件的映射表。（例如  映射到 iOS 的 UILabel）</li>
<li>布局与样式：Weex 使用的 Flexbox 布局模型做为统一的布局方案，Native 端需要将 JS 传递的 css 样式属性，转换为原生组件能够理解的布局参数与样式属性。</li>
<li>多线程模型：为了保证 UI 流畅，Weex 采用了多线程模型。DOM 操作和布局计算通常在单独的 DOM 线程进行，而最终创建和更新原生视图的操作必须在 UI 主线程上进行</li>
</ul>
<h3 data-id="heading-13">4. 拓展机制</h3>
<ul>
<li>模块（Module）：用于暴露原生能力（如网络、存储）给前端调用，通过 callNative 触发，支持回调</li>
<li>组件（Component）：拓展自定义 UI 组件，允许开发者创建自定义的原生 UI 组件，并在 JSX 中使用</li>
<li>适配器（Adapter）：提供可替换的实现，如图片下载器</li>
</ul>
<h2 data-id="heading-14">四、为什么自定义 Component 都需要继承自 WXComponent？</h2>
<p>比如下面的代码</p>
<pre><code class="hljs language-objective-c" lang="objective-c">[self registerComponent:@"image" withClass:NSClassFromString(@"WXImageComponent") withProperties:nil];

@interface WXImageComponent : WXComponent

@end
</code></pre>
<p>答：<strong>自定义原生组件必须继承自 WXComponent，本质是复用 Weex 封装的「JS - 原生交互、生命周期、样式布局、渲染基础」等通用能力，确保组件能接入 Weex 运行时生态</strong>。</p>
<p>Weex Module 与 Componet 的区别</p>























<table><thead><tr><th>类型</th><th>核心作用</th><th>基类</th><th>示例</th></tr></thead><tbody><tr><td>Component</td><td>原生 UI 渲染（有视图）</td><td><code>WXComponent</code></td><td><code>WXImageComponent</code>（图片）、<code>WXTextComponent</code>（文本）、自定义按钮组件</td></tr><tr><td>Module</td><td>功能扩展（无视图）</td><td><code>WXModule</code></td><td><code>WXNavigatorModule</code>（导航）、<code>WXStorageModule</code>（存储）、自定义工具模块</td></tr></tbody></table>
<p>实现 JS 与原生组件的「数据同步」（属性、事件、方法）</p>
<p>Weex 的核心是「JS 控制原生组件」，而 <code>WXComponent</code> 封装了 JS 与原生之间的通信协议，无需自定义组件手动处理：</p>
<ul>
<li>
<p>属性同步（Props）：JS 端通过 <code>&lt;my-component prop1="xxx" prop2="yyy"&gt;</code> 传递的属性，WXComponent 会自动解析、类型转换（如 JS 字符串 → 原生 NSString/NSNumber），并通过 <code>setter</code> 方法同步到自定义组件。</p>
<p>示例：WXImageComponent 继承 <code>WXComponent</code> 后，只需重写 <code>-setSrc:(NSString*)src</code> 方法，就能接收 JS 传的 <code>src</code> 属性，无需关心「JS 如何把值传给原生」。</p>
</li>
<li>
<p>事件分发（Events）：原生组件的交互事件（如点击、加载完成），<code>WXComponent</code> 会按照 Weex 协议回传给 JS 端（如 <code>@emit('click')</code> )</p>
<p>示例：自定义按钮组件继承后，只需调用 <code>[self fireEvent:@"click" params:@{@"x": @100, @"y": @200}]</code> ，JS 端就能通过 <code>@onclick</code>接收事件，无需自己实现事件通信。</p>
</li>
<li>
<p>方法调用（Methods）：JS 端通过 <code>this.$refs.myComponent.callMethod('xxx', params)</code> 调用原生组件方法，<code>WXComponent</code></p>
<p>会解析方法名和参数，反射调用自定义组件的对应方法。</p>
<p>示例：自定义播放器组件继承后，只需暴露 <code>-play</code>方法，JS 就能直接调用，<code>WXComponent</code>负责方法查找和参数传递。</p>
</li>
</ul>
<h2 data-id="heading-15">五、JS 数据变化是如何驱动 Native UI 更新的</h2>
<p>纯 Web 端的数据变化会通过 Proxy 去驱动关联的 UI 更新，这也是 Vue3 的工作原理，那么 JS 端的数据变化是如何驱动 Native UI 组件的更新的？</p>
<p>所有的 Native UI Component 都继承自 WXComponent，所以可以直接给 WXComponent 添加一个实现 DataBinding 的 Category，这就是 Weex 最新源码中的 <code>WXComponent+DataBinding.mm</code></p>
<p>核心是：<strong>解析 JS 端传递的「绑定表达式」（如 <code>{{a + b}}</code>），编译为原生可执行的回调 Block，当 JS 数据变化时，通过 Block 计算出组件所需的新值，自动更新组件的属性、样式、事件，或处理列表（<code>v-for</code>）、条件（<code>v-if</code>）、一次性绑定（<code>v-once</code>）等逻辑</strong></p>
<p>可能有些人要问了：为什么当 js 数据变化时，需要让 Native 计算组件所需的新值？这不就是 Native 做了一遍 Vue 响应式的逻辑吗？这种重复逻辑的价值是什么？</p>
<p><strong>Vue3 的 Proxy 只负责「JS 端数据变化的监听 + 依赖收集 + 触发更新通知」—— 它是 “响应式的触发器”，而非 “UI 更新的执行者”</strong></p>
<p>而 Weex 之所以需要 Native 托管，核心是因为「继承自 WXComponent 的 UI 组件是 Native 侧的原生组件，而非 DOM 组件」，JS 端没有任何能力（API）去访问、操作他们，Proxy 再强大，它也只是 Native 侧（Weex）和 Web 端（Vue）负责“喊一声，哎，数据变了，你们谁需要的自助，自己去处理感兴趣的 UI”，却摸不到 UI 组件，Web 端由 DOM API 去渲染绘制，Native 端更触碰不到，必须由 Native 自己来完成：听到通知 -&gt; 计算新值 -&gt; 更新控件的流程。</p>
<h3 data-id="heading-16">1. Proxy 都做了些什么？</h3>
<p>Vue3 的核心实现里 Proxy 做了3件事：全程在 JS 侧，不涉及任何 UI 操作</p>
<p>监听数据操作：通过 Proxy 代理对象拦截数据的 getter、setter</p>
<ul>
<li>通过 getter 收集依赖关系：当组件渲染时触发 getter，Proxy 会记录这个组件依赖了这个数据</li>
<li>通过 setter 触发更新通知：当数据被修改时触发 setter，Proxy 会告诉 Vue 运行时，“user.name” 变了，所有依赖它的组件该更新了</li>
</ul>
<p>Proxy（代理）是 ES6 新增的内置对象，用于<strong>创建一个对象的代理副本</strong>，并通过「陷阱（Trap）」拦截对原对象的基本操作（如属性访问、赋值、删除等），从而自定义这些操作的行为。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);
</code></pre>
<ul>
<li><code>target</code>：被代理的<strong>原始对象</strong>（可以是对象、数组，甚至函数）；</li>
<li><code>handler</code>：配置对象，包含多个「陷阱方法」（如 <code>get</code>、<code>set</code>），用于定义拦截逻辑；</li>
<li><code>proxy</code>：代理对象，后续对原始对象的操作需通过代理对象进行，才能触发拦截。</li>
</ul>






























<table><thead><tr><th>陷阱方法</th><th>作用</th><th>触发场景</th></tr></thead><tbody><tr><td><code>get(target, key, receiver)</code></td><td>拦截「属性访问」</td><td><code>proxy.key</code> 或 <code>proxy[key]</code></td></tr><tr><td><code>set(target, key, value, receiver)</code></td><td>拦截「属性赋值」</td><td><code>proxy.key = value</code> 或 <code>proxy[key] = value</code></td></tr><tr><td><code>deleteProperty(target, key)</code></td><td>拦截「属性删除」</td><td><code>delete proxy.key</code></td></tr><tr><td><code>has(target, key)</code></td><td>拦截「<code>in</code> 运算符判断」</td><td><code>key in proxy</code></td></tr></tbody></table>
<p>Tips: Proxy 代理的是「整个对象」，而非单个属性，且拦截的是「操作行为」（如 “访问属性” 这个动作），而非属性本身。</p>
<p>Vue 核心流程：<strong>创建代理 → 依赖收集 → 数据修改 → 触发更新</strong>。</p>
<h4 data-id="heading-17">1. 创建代理（reactive 函数的核心）</h4>
<p><code>reactive</code> 函数接收一个原始对象，返回其 Proxy 代理对象，同时配置 <code>get</code>、<code>set</code> 等陷阱方法，为后续依赖收集和更新做准备</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">reactive</span>(<span class="hljs-params">target</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-comment">// 拦截属性访问</span>
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key, receiver</span>) {
      <span class="hljs-comment">// 1. 先获取原始属性值</span>
      <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      <span class="hljs-comment">// 2. 收集依赖（关键：记录“谁在访问这个属性”）</span>
      <span class="hljs-title function_">track</span>(target, key);
      <span class="hljs-comment">// 3. 若访问的是嵌套对象，递归创建代理（懒代理，优化性能）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp; value !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reactive</span>(value);
      }
      <span class="hljs-keyword">return</span> value;
    },
    <span class="hljs-comment">// 拦截属性赋值</span>
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value, receiver</span>) {
      <span class="hljs-comment">// 1. 先设置原始属性值</span>
      <span class="hljs-keyword">const</span> oldValue = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key, receiver);
      <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value, receiver);
      <span class="hljs-comment">// 2. 若值发生变化，触发依赖更新</span>
      <span class="hljs-keyword">if</span> (success &amp;&amp; oldValue !== value) {
        <span class="hljs-title function_">trigger</span>(target, key);
      }
      <span class="hljs-keyword">return</span> success;
    },
    <span class="hljs-comment">// 拦截属性删除</span>
    <span class="hljs-title function_">deleteProperty</span>(<span class="hljs-params">target, key</span>) {
      <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">deleteProperty</span>(target, key);
      <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-title function_">trigger</span>(target, key); <span class="hljs-comment">// 删除属性也触发更新</span>
      }
      <span class="hljs-keyword">return</span> success;
    }
  });
}
</code></pre>
<ul>
<li>用 <code>Reflect</code> 操作原始对象，Reflect 是 ES6 新增的内置对象，提供了与 Proxy 陷阱对应的方法，比如 <code>Relect.get</code>、<code>Reflect.set</code> 确保操作原始对象的行为一直，同时避免直接操作 target 所产生的问题</li>
<li>嵌套对象懒代理：Proxy 仅代理当前层级对象，当访问嵌套对象 （proxy.user.name）时，才递归对 user 对象创建代理，避免初始化时递归遍历所有属性，优化性能</li>
</ul>
<h4 data-id="heading-18">2. 依赖收集</h4>
<p>Vue3 用「三层映射」存储依赖，确保精准定位</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WeakMap：key 是被代理的原始对象（target），value 是该对象的属性-依赖映射</span>
<span class="hljs-keyword">const</span> targetMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-comment">// 1. 若没有当前目标对象的映射，创建一个（Map：key 是属性名，value 是依赖集合）</span>
  <span class="hljs-keyword">if</span> (!targetMap.<span class="hljs-title function_">has</span>(target)) {
    targetMap.<span class="hljs-title function_">set</span>(target, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
  }
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);

  <span class="hljs-comment">// 2. 若没有当前属性的依赖集合，创建一个（Set：存储依赖函数，去重）</span>
  <span class="hljs-keyword">if</span> (!depsMap.<span class="hljs-title function_">has</span>(key)) {
    depsMap.<span class="hljs-title function_">set</span>(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>());
  }
  <span class="hljs-keyword">const</span> deps = depsMap.<span class="hljs-title function_">get</span>(key);

  <span class="hljs-comment">// 3. 将当前活跃的依赖函数（effect）添加到集合中</span>
  <span class="hljs-keyword">if</span> (activeEffect) {
    deps.<span class="hljs-title function_">add</span>(activeEffect);
  }
}
</code></pre>
<p>会产生一个这样的结构</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
	<span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-19">3. 数据修改（触发 set/deleteProperty 的陷阱）</h4>
<p>当通过代理对象修改属性（如 <code>proxy.name = 'newName'</code>）或删除属性（如 <code>delete proxy.age</code>）时，会触发对应的 Proxy 陷阱（<code>set</code> 或 <code>deleteProperty</code>）。</p>
<p>陷阱函数会先更新原始对象的属性值，再判断值是否真的发生变化（避免无效更新）</p>
<h4 data-id="heading-20">4. 触发更新 （tigger 函数）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">trigger</span>(<span class="hljs-params">target, key</span>) {
  <span class="hljs-comment">// 1. 从 targetMap 中获取当前对象的属性-依赖映射</span>
  <span class="hljs-keyword">const</span> depsMap = targetMap.<span class="hljs-title function_">get</span>(target);
  <span class="hljs-keyword">if</span> (!depsMap) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 2. 获取当前属性的所有依赖</span>
  <span class="hljs-keyword">const</span> deps = depsMap.<span class="hljs-title function_">get</span>(key);
  <span class="hljs-keyword">if</span> (!deps) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 3. 执行所有依赖函数（触发更新）</span>
  deps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">effect</span> =&gt;</span> <span class="hljs-title function_">effect</span>());
}
</code></pre>
<h3 data-id="heading-21">2. Proxy 不做的事情</h3>
<ul>
<li>不计算表达式（比如 user.name + "后缀"的结果，Proxy 不管）</li>
<li>不操作 UI（不管是 DOM 和 Native 控件，Proxy 都不碰）</li>
<li>不跨端通信</li>
</ul>
<p>为什么 Native 组件不能让 Proxy “解决”？</p>
<p>核心矛盾：渲染载体不同。Proxy 之所以在 Web 端能 “间接驱动 UI”，是因为 Web 端有个「中间桥梁」—— DOM，且 JS 端有完整的 DOM API（比如 <code>document.getElementById</code>、<code>element.style.setProperty</code>）：</p>
<p>Web 端完整链路：Proxy 触发更新 → Vue 运行时计算表达式 → 虚拟 DOM diff → 调用 DOM API 操作 DOM → UI 更新</p>
<ul>
<li><strong>JS 端没有操作 Native 控件的 API</strong>：浏览器给 JS 暴露了 DOM API，但 iOS/Android 系统不会给 JS 引擎暴露 “修改 <code>UILabel</code> 文本”“设置 <code>UIImageView</code> 图片” 的 API —— JS 端连 Native 控件的 “引用” 都拿不到，更别说更新了；</li>
<li><strong>Native 控件不在 JS 运行时的内存空间</strong>：JS 引擎（如 V8、JSC）和 Native 应用是两个独立的 “进程 / 虚拟机”，内存不共享 —— Proxy 所在的 JS 内存里，根本没有 Native 控件的实例，想操作都无从下手</li>
</ul>
<p>Weex 的设计优雅之处在于：Native 托管“执行层”，Proxy 保留“触发层”。响应式工作继续复用现有逻辑，由 Proxy 完成，最后的执行层由 Native 实现，也就是 WXComponent+DataBinding</p>
<ul>
<li><strong>响应式系统（Proxy）的核心是 “发现变化”</strong>：不管是 Web 还是 Weex，Proxy 都只干这件事；</li>
<li><strong>UI 更新的核心是 “操作渲染载体”</strong>：Web 端操作 DOM（JS 端能做），Weex 端操作 Native 控件（只能 Native 端做）；</li>
<li><strong>WXComponent+DataBinding 的角色是 “Native 端的 UI 执行器”</strong>：它不是替代 Proxy，而是 Proxy 触发更新后，负责把 “更新通知” 落地到 Native 控件上的唯一途径</li>
</ul>
<h2 data-id="heading-22">六、Weex 自定义组件是如何工作的</h2>
<p>上面分析了自定义组件的数据变化和表达式运算是 Native 负责的，执行层也就是 <code>WXComponent+DataBinding.mm</code> 这个类。</p>
<p>一言以蔽之就是：把 JS 端传递的“原始数据”，通过预编译的绑定规则（Block）计算出 Native 组件需要的最终值，并自动更新 UI 组件，同时适配长列表组件等复杂场景的 UI 优化。</p>
<p>该分类为所有继承自 WXComponent 的组件，注入“数据绑定能力”，无需手动实现。</p>
<h3 data-id="heading-23">1. 绑定规则的“编译存储”，把 JS 表达式转换为 Native 可执行的 block</h3>
<p>数据绑定的「前置准备」：在组件初始化时，解析 JS 端传递的绑定规则（如 <code>[[user.name]]</code>、<code>[[repeat]]</code>），编译为 Native 可执行的 <code>WXDataBindingBlock</code>（代码块），并存储到组件的绑定映射表中（<code>_bindingProps/_bindingStyles/_bindingEvents</code> 等）</p>
<pre><code class="hljs language-objective-c" lang="objective-c">- (void)_storeBindingsWithProps:(NSDictionary *)props styles:(NSDictionary *)styles attributes:(NSDictionary *)attributes events:(NSDictionary *)events;
</code></pre>
<p>接收组件的 props/attrbutes/styles/events 中的绑定规则，解析并存储为可执行的 block。</p>
<ol>
<li><strong>识别绑定表达式</strong>：判断是否包含 <code>WXBindingIdentify</code>（<code>@"@binding"</code>）标记，比如 <code>{"src": {"@binding": "user.name"}}</code>；</li>
<li><strong>AST 解析</strong>：通过 <code>WXJSASTParser</code> 把绑定表达式字符串（如 <code>"user.name + '后缀'"</code>）解析为 AST 节点（<code>WXJSExpression</code>）；</li>
<li><strong>生成执行 Block</strong>：调用 <code>-bindingBlockWithExpression:</code> 把 AST 节点转成 <code>WXDataBindingBlock</code>（后续数据变化时直接执行该 Block 计算结果）；</li>
<li>分类存储：按绑定类型（属性 / 样式 / 事件 / 特殊绑定）存入对应的映射表：
<ul>
<li><code>_bindingProps</code>：属性绑定（如 <code>src</code>）；</li>
<li><code>_bindingStyles</code>：样式绑定（如 <code>fontSize</code>）；</li>
<li><code>_bindingEvents</code>：事件绑定（如 <code>onClick</code> 参数）；</li>
<li>特殊绑定：<code>_bindingRepeat</code>（<code>[[repeat]]</code> 对应 <code>v-for</code>）、<code>_bindingMatch</code>（<code>[[match]]</code> 对应 <code>v-if</code>）、<code>_dataBindOnce</code>（<code>[[once]]</code> 对应 <code>v-once</code>）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">2. WXComponentManager 都做了什么</h3>
<p><code>WXComponentManager</code> 是 Weex iOS 端的 <strong>组件全生命周期与任务调度核心</strong>，所有与 Native 组件相关的操作（创建、更新、布局、销毁、事件绑定）都由它统一管理，同时承担「线程分工协调、UI 任务批量处理、性能监控」等关键职责，是连接 JS 指令、Native 组件、布局引擎和 UI 渲染的 “中枢大脑”。</p>
<h4 data-id="heading-25">1. 组件线程管理</h4>
<p>组件业务的 “专属执行环境”，作为组件线程的「创建者和维护者」，<code>WXComponentManager</code> 确保所有组件核心操作都在<strong>全局唯一的组件线程</strong>中执行，避免线程安全问题和主线程阻塞。</p>
<p>核心工作：</p>
<ul>
<li>懒加载创建全局组件线程（<code>+componentThread</code>），启动 RunLoop 确保线程常驻（<code>_runLoopThread</code>）</li>
<li>提供线程调度接口：<code>WXPerformBlockOnComponentThread</code>（异步）、<code>WXPerformBlockSyncOnComponentThread</code>（同步），让外部模块（如 <code>WXBridgeManager</code>）能将组件任务提交到组件线程</li>
<li>线程断言约束：所有组件核心方法（如 <code>createBody</code>、<code>updateStyles</code>）开头都有 <code>WXAssertComponentThread</code>，强制组件操作在组件线程执</li>
</ul>
<h4 data-id="heading-26">2. 组件树构建与管理：组件的 “增删改查” 全生命周期</h4>
<p>核心工作：</p>
<ul>
<li>创建组件
<ul>
<li>根组件创建（<code>createBody:</code>）：接收 JS 端根组件指令，创建页面根组件（如 <code>&lt;div&gt;</code> 根节点），绑定到页面根视图；</li>
<li>子组件创建（<code>addComponent:type:parentRef:</code>）：根据 JS 端指令，创建子组件并关联父组件，存入 <code>_indexDict</code>（组件 ref → 实例映射，快速查找）。</li>
</ul>
</li>
<li>更新组件关系
<ul>
<li>移动组件（<code>moveComponent:toSuper:atIndex:</code>）：调整组件在组件树中的位置，同步更新视图层级；</li>
<li>删除组件（<code>removeComponent:</code>）：从组件树和索引字典中移除组件，递归删除子组件，释放视图资源。</li>
</ul>
</li>
<li>组件查询与遍历
<ul>
<li>按 ref 查找组件（<code>componentForRef:</code>）：供 JS 端 <code>this.$refs</code> 访问原生组件实例；</li>
<li>遍历组件树（<code>enumerateComponentsUsingBlock:</code>）：支持递归遍历所有组件（如性能统计、全局样式更新）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">3.  数据绑定辅助：绑定规则的提取与存储</h4>
<p>配合 <code>WXComponent+DataBinding</code> 模块，<code>WXComponentManager</code> 在组件创建时，从 JS 端传递的 <code>props</code>/<code>styles</code>/<code>attributes</code> 中提取「绑定表达式配置」，为响应式更新铺路。核心工作：</p>
<ul>
<li>提取绑定规则：
<ul>
<li><code>_extractBindings:</code>：从样式 / 属性中提取 <code>[[repeat]]</code>/<code>{"@binding": "expr"}</code> 等绑定配置，移除原始字典中的绑定字段（避免干扰普通属性处理）</li>
<li><code>_extractBindingEvents:</code>：从事件数组中提取绑定参数（如 <code>onClick</code> 的回调表达式）；</li>
<li><code>_extractBindingProps:</code>：提取组件自定义 props 绑定（<code>@componentProps</code>）。</li>
</ul>
</li>
<li>存储绑定规则：调用组件的 <code>_storeBindingsWithProps:styles:attributes:events:</code>，将提取的绑定配置存入组件实例，后续数据变化时触发表达式计算。</li>
</ul>
<h4 data-id="heading-28">4. 组件更新调度：样式 / 属性 / 事件的 “同步与执行”</h4>
<p>当 JS 端触发组件更新（如修改样式、属性、绑定事件）时，<code>WXComponentManager</code> 负责「跨线程调度、数据预处理、UI 同步」，确保更新流程高效且安全。</p>
<ul>
<li>样式更新（<code>updateStyles:forComponent:</code>）
<ul>
<li>组件线程：过滤无效样式（如空值），更新组件实例的样式数据，触发布局计算；</li>
<li>主线程：通过 <code>_addUITask</code> 将样式更新任务（如设置 <code>CALayer.backgroundColor</code>、<code>UILabel.font</code>）批量调度到主线程执行。</li>
</ul>
</li>
<li><strong>属性更新（<code>updateAttributes:forComponent:</code>）</strong>：类似样式更新，组件线程处理数据逻辑，主线程更新原生组件属性（如 <code>UIImageView.image</code>、<code>UIScrollView.contentOffset</code>）。</li>
<li>事件绑定 / 解绑
<ul>
<li>组件线程：维护组件的事件列表（如 <code>click</code>/<code>scroll</code>）；</li>
<li>主线程：绑定 / 移除原生手势识别器（如 <code>UITapGestureRecognizer</code>），捕获用户交互。</li>
</ul>
</li>
<li><strong>批量更新优化</strong>：通过 <code>performBatchBegin</code>/<code>performBatchEnd</code> 标记批量更新范围，合并多个 UI 任务，减少主线程调度次数（提升性能）。</li>
</ul>
<h4 data-id="heading-29">5. 布局调度与 UI 同步：从布局计算到 UI 渲染</h4>
<p>Weex 采用 Flex 布局引擎（Yoga），<code>WXComponentManager</code> 负责布局计算的触发、组件 frame 分配、UI 任务批量执行，确保组件按预期位置渲染。</p>
<ul>
<li>触发布局计算：组件更新、根视图尺寸变化（<code>rootViewFrameDidChange:</code>）时，调用 <code>_layoutAndSyncUI</code> 触发 <code>WXCoreBridge</code> 执行 Yoga 布局计算，得到所有组件的 frame。</li>
<li>分配组件 frame：<code>layoutComponent:frame:isRTL:innerMainSize:</code> 将计算后的 frame 分配给组件，若为根组件，同步更新页面根视图尺寸（适配 <code>wrap_content</code> 模式）。</li>
<li>UI 任务同步：<code>_syncUITasks</code> 批量执行 <code>_uiTaskQueue</code> 中的 UI 任务（如 <code>addSubview</code>、<code>setFrame</code>），异步调度到主线程，避免频繁主线程切换导致掉帧。</li>
<li>帧率同步：通过 <code>WXDisplayLinkManager</code> 监听屏幕刷新率（60fps），确保布局更新与帧率同步，提升渲染流畅度。</li>
</ul>
<h4 data-id="heading-30">6. 生命周期与资源释放：页面卸载时的 “清理工作”</h4>
<p>当 Weex 页面销毁（<code>WXSDKInstance</code> 卸载）时，<code>WXComponentManager</code> 负责清理组件资源，避免内存泄漏。</p>
<p>核心工作（<code>unload</code> 方法）：</p>
<ul>
<li>停止布局调度：调用 <code>_stopDisplayLink</code>，停止帧率监听和布局计算；</li>
<li>解绑渲染资源：遍历所有组件，解除与底层渲染对象（<code>RenderObject</code>）的绑定；</li>
<li>释放 UI 资源：调度到主线程，销毁所有组件的原生视图（<code>_unloadViewWithReusing:</code>）；</li>
<li>清空状态：清空 <code>_indexDict</code>、<code>_uiTaskQueue</code>、<code>_fixedComponents</code> 等容器，解除与 <code>WXSDKInstance</code>的绑定。</li>
<li>清除事件绑定：清除所有的事件、手势等逻辑</li>
</ul>
<h2 data-id="heading-31">七、WXModule 的注册机制及其调用流程</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant JS as JS环境
    participant B as WXBridge
    participant MF as WXModuleFactory
    participant MM as WXModuleManager
    participant MI as Module实例
    participant MC as 自定义Module

    Note over JS,MC: 注册阶段
    MC-&gt;&gt;+MF: registerModule("customModule", MyModule.class)
    MF-&gt;&gt;MF: 生成ModuleFactory并缓存
    MF-&gt;&gt;MF: 反射解析@JSMethod方法
    MF-&gt;&gt;B: 将模块&amp;方法信息传递给JS

    Note over JS,MC: 调用阶段
    JS-&gt;&gt;+B: weex.requireModule('customModule').myMethod(args)
    B-&gt;&gt;+MM: 调用 invokeModuleMethod
    MM-&gt;&gt;+MF: 获取Module实例和方法Invoker
    MF-&gt;&gt;MF: 查找/创建Module实例
    MF-&gt;&gt;MF: 获取方法Invoker
    MF-&gt;&gt;MM: 返回实例和Invoker
    MM-&gt;&gt;+MI: 通过Invoker.invoke调用
    MI-&gt;&gt;+MC: 执行原生方法实现
    MC-&gt;&gt;JS: 通过callback回调JS（可选）
</code></pre>
<h3 data-id="heading-32">1. WXModule 的注册分为 Naitve 注册和 JS 注册</h3>
<ul>
<li><strong>Native 注册</strong>：在 Native 端，调用 <code>[WXSDKEngine registerModule:withClass:]</code> 方法（在 iOS 中） ，这个过程会将自定义 Module 的类和一个模块名称（例如 <code>TestModule</code>）建立映射关系，并生成一个 <code>ModuleFactory</code> 存储在一个全局的 Map（例如 <code>sModuleFactoryMap</code>）中。同时，如果该 Module 被标记为全局（global），SDK 会立即创建一个实例并缓存起来。</li>
<li><strong>JS 注册</strong>：Native 注册完成后，Weex 会将所有已注册 Module 的<strong>模块名称</strong>及其<strong>暴露给 JS 的方法名列表</strong>，通过 <code>WXBridge</code>（JS-Native 通信桥梁）传递给 JS 引擎。这样，JS 端就知道存在哪些模块以及每个模块有哪些方法可以调用。</li>
</ul>
<h3 data-id="heading-33">2. 当 JS 调用 Module 方法时</h3>
<ul>
<li>JS 发起调用：在 JS 代码中，通过 <code>weex.requireModule('moduleName')</code> 获取模块实例 。然后吊影其方法，比如 'staream.fetch()options, callack)'</li>
<li>Bridge 桥接：JS 引擎通过 JSBridge 将这次调用（包括模块名、方法名、参数等信息）传递给 Native 段</li>
<li>Native 端查找与执行：Native 端的 WXModuleManager 根据模块名从之前注册的工厂中获取创建的 Module 实例，并根据方法名找到对应的 MethodInvoker。MethodInvoker 会通过反射手段调用具体的 Native 方法</li>
<li>结果回调：如果有需要，Native 可以通过 WXModuleCallBack 或者 WXModuleKeepAliveCallBack 将结果回调给 JS。WXModuleCallback 只能回调1次，而 WXModuleKeepAliveCallback 可以多次回调</li>
</ul>
<h3 data-id="heading-34">3. WXModuleProtocol 的作用</h3>
<p><strong><code>WXModuleProtocol</code> 是一个协议，定义了 Module 的行为规范</strong>。你的自定义 Module 必须遵循此协议。它声明了 Module 需要实现的方法或属性，例如如何暴露方法给 JS（通过 <code>WX_EXPORT_METHOD</code> 宏）、方法在哪个线程执行（通过实现特定的方法返回目标线程，例如 <code>targetExecuteThread</code>）、以及如何通过 <code>weexInstance</code> 属性弱引用持有它的 WXSDKInstance 实例。
通过遵循 <code>WXModuleProtocol</code>，你自定义的 Module 就能被 Weex SDK 正确识别和调</p>
<h3 data-id="heading-35">4. WXModuleFactory 的作用</h3>
<ol>
<li><strong>存储配置</strong>：在注册阶段，它会缓存 Module 的配置信息，例如模块名和对应的工厂类（<code>WXModuleConfig</code>）。</li>
<li><strong>方法解析</strong>：通过反射，解析 Module 类中所有通过 <code>WX_EXPORT_METHOD</code> 或 <code>WX_EXPORT_METHOD_SYNC</code> 宏暴露的方法，并生成方法名与 <code>MethodInvoker</code>（封装了反射调用逻辑）的映射关系。</li>
<li>提供实例：当 JS 调用 Module 方法时，<code>WXModuleManager</code> 会通过 <code>WXModuleFactory</code> 根据模块名获取或创建 Module 实例，以及对应方法的 <code>MethodInvoker</code>。</li>
</ol>
<h2 data-id="heading-36">八、Weex 分为几个线程</h2>
<h3 data-id="heading-37">1. 主线程</h3>
<p>核心定位：应用的 UI 线程（与原生 App 主线程同源），负责 UI 渲染、用户交互响应，<strong>禁止耗时操作</strong>。</p>
<p>核心职责：</p>
<ul>
<li>承载 Weex 页面的 <strong>原生渲染容器</strong>（如 Android 的 <code>WXFrameLayout</code>、iOS 的 <code>WXSDKInstanceView</code>），执行视图布局、绘制、动画触发；</li>
<li>处理用户交互事件（点击、滑动、输入等），并将事件转发给 JS 线程（如需要 JS 逻辑响应时）；</li>
<li>执行原生模块的 <strong>主线程方法</strong>（通过 <code>@WXModuleAnnotation(runOnUIThread = true)</code> 标记的方法，如弹 Toast、更新 UI 的原生能力）；</li>
<li>接收 JS 线程下发的 <strong>UI 操作指令</strong>（如创建视图、修改样式、更新属性），并映射为原生视图操作；</li>
</ul>
<p><strong>关键约束</strong>：所有直接操作原生视图的逻辑必须在主线程执行，否则会导致 UI 错乱或崩溃</p>
<h3 data-id="heading-38">2. JS 线程</h3>
<p>核心定位：Weex 的 “业务逻辑线程”，独立于主线程，专门运行 JavaScript 代码，避免阻塞 UI。</p>
<p>核心职责：</p>
<ul>
<li>加载并执行 Weex 业务代码（<code>.we</code> 编译后的 JS bundle），包括 Vue/React 组件初始化、数据绑定、生命周期管理；</li>
<li>处理 JS 层面的业务逻辑（事件响应、数据计算、接口请求预处理）；</li>
<li>调用原生模块时，通过 <strong>JSBridge 转发请求</strong>（区分同步 / 异步，同步请求会短暂阻塞 JS 线程，需谨慎使用）；</li>
<li>生成 UI 操作指令（如 <code>createElement</code>、<code>updateStyle</code>），通过跨线程通信发送给主线程执行；</li>
<li>接收主线程转发的用户交互事件（如点击回调），执行对应的 JS 事件处理函数；</li>
</ul>
<p>关键优化**：最新版本中，JS 线程支持 <strong>Bundle 预加载</strong>、<strong>懒加载组件</strong>，减少启动耗时；同时通过 <code>JSContext</code>隔离多个 Weex 实例，避免线程内资源竞争。</p>
<h3 data-id="heading-39">3. 耗时线程</h3>
<h4 data-id="heading-40">1. 网络线程</h4>
<p>核心定位：Weex 框架封装的 <strong>专用网络线程</strong>（跨端统一调度），避免网络请求阻塞主线程或 JS 线程。</p>
<p>核心职责：</p>
<ul>
<li>处理 Weex 内置的网络请求（如 <code>weex.requireModule('stream')</code> 发起的 HTTP/HTTPS 请求）；</li>
<li>负责 JS Bundle 的下载（首次加载或更新时），支持断点续传、缓存管理；</li>
<li>处理网络请求的拦截、重试、超时控制（框架层统一实现，无需业务关心）；</li>
<li>将网络响应结果通过 JSBridge 回传给 JS 线程；</li>
</ul>
<p>设计亮点：与原生系统的网络库解耦，但对外暴露统一的 JS API，线程调度由框架内部管理，业务无需手动切换线程</p>
<h4 data-id="heading-41">2. 图片下载线程</h4>
<p>核心定位：专门处理 Weex 图片的异步加载、解码，避免占用主线程资源导致 UI 卡顿。</p>
<p>核心职责：</p>
<ul>
<li>加载网络图片、本地图片（通过 <code>img</code> 标签或 <code>weex.requireModule('image')</code>）；</li>
<li>图片解码、压缩（适配视图尺寸，减少内存占用）；</li>
<li>图片缓存管理（内存缓存 + 磁盘缓存，框架层统一维护）；</li>
<li>加载完成后，将图片 bitmap 提交到主线程渲染；</li>
</ul>
<p>iOS 侧图片加载线程的核心管理类是 <code>WXImageComponent</code>。</p>
<p>Weex 线程职责边界清晰：<strong>UI 操作归主线程，JS 逻辑归 JS 线程，耗时操作归工作线程 / 网络线程</strong>，避免跨线程直接操作资源</p>
<h2 data-id="heading-42">九、JS 和 Native 通信</h2>
<h3 data-id="heading-43">1. callJS 和 callNative</h3>


























<table><thead><tr><th>通信方向</th><th>发起方</th><th>接收方</th><th>核心目的</th><th>典型场景</th></tr></thead><tbody><tr><td><code>callNative</code></td><td>JS</td><td>Native</td><td>JS 调用 Native 的模块 / 组件接口</td><td>渲染组件、弹 Toast、获取设备信息</td></tr><tr><td><code>callJS</code></td><td>Native</td><td>JS</td><td>Native 触发 JS 的回调函数</td><td>组件事件回调（如按钮点击）、数据同步（如网络请求结果）</td></tr></tbody></table>
<p>两者的底层依赖 <strong>同一个 JS Bridge 通道</strong>，只是「发起方」和「数据格式」不同，Weex 已封装好统一的通信框架，开发者无需关心底层传输细节</p>
<h3 data-id="heading-44">2. callNative 实现</h3>
<p><code>callNative</code> 是 JS 主动调用 Native 接口的过程，核心流程：<strong>JS 构造标准化指令 → 序列化 JSON → 桥接通道发送 → Native 解析指令 → 执行对应接口 → 响应结果回传</strong>。</p>
<p>怎么样？是不是感觉似曾相识，早期做 Hybrid 的时候，JS 和 Native 的通信也是一样的流程，感兴趣的可以查看<a href="https://link.juejin.cn?target=.%2F1.44.md" target="_blank" title="./1.44.md" ref="nofollow noopener noreferrer">这篇文章</a>。</p>
<p>是的，通信要解决的问题一直不变，所以方案也不变。</p>
<h4 data-id="heading-45">1. 标准化指令格式</h4>
<p>为了让 Native 能统一解析，Weex 规定 <code>callNative</code> 的指令必须包含 4 个核心字段（JS 端构造）：</p>
<pre><code class="hljs language-json" lang="json">const callNative指令 = <span class="hljs-punctuation">{</span>
  module<span class="hljs-punctuation">:</span> <span class="hljs-string">"component"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 模块名（如 component/modal/device）</span>
  method<span class="hljs-punctuation">:</span> <span class="hljs-string">"create"</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 方法名（如 create/toast/getInfo）</span>
  params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 入参（如组件样式、Toast 内容）</span>
  callbackId<span class="hljs-punctuation">:</span> <span class="hljs-string">"cb_123"</span>    <span class="hljs-comment">// 回调 ID（用于 Native 回传结果）</span>
<span class="hljs-punctuation">}</span>;
</code></pre>
<ul>
<li><code>module</code> + <code>method</code>：定位 Native 端的具体接口（如 <code>modal.toast</code> 对应 Native 的「弹 Toast」接口）；</li>
<li><code>params</code>：JS 传递给 Native 的数据（需是 JSON 兼容类型）；</li>
<li><code>callbackId</code>：唯一标识当前请求，Native 执行完成后通过该 ID 找到对应的 JS 回调函数。</li>
</ul>
<h4 data-id="heading-46">2. JS 端实现</h4>
<p>JS 侧调用 Native 的核心是3个实例方法，对应3类场景</p>

























<table><thead><tr><th>方法名</th><th>用途</th><th>对应 Native 接口</th></tr></thead><tbody><tr><td><code>callModule</code></td><td>调用 Native 普通模块（如 <code>modal</code>/<code>storage</code>）</td><td><code>global.callNativeModule</code></td></tr><tr><td><code>callComponent</code></td><td>调用 Native 自定义组件方法</td><td><code>global.callNativeComponent</code></td></tr><tr><td><code>callDOM</code></td><td>调用 DOM 相关 Native 方法（如创建元素）</td><td><code>global.callAddElement</code> 等独立方法</td></tr></tbody></table>
<p>这3个方法都会通过 Native 注入的全局函数（global 上的方法）将调用传递给 Native 层</p>
<p>这3个方法在源码最后</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 调用 DOM 相关 Native 方法</span>
callDOM (action, args) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[action](<span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceId</span>, args)
}

<span class="hljs-comment">// 调用 Native 自定义组件方法</span>
callComponent (ref, method, args, options) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">componentHandler</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceId</span>, ref, method, args, options)
}

<span class="hljs-comment">// 调用 Native 普通模块方法（最常用，对应原 callNative）</span>
callModule (<span class="hljs-variable language_">module</span>, method, args, options) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">moduleHandler</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceId</span>, <span class="hljs-variable language_">module</span>, method, args, options)
}
</code></pre>
<h5 data-id="heading-47">1. 普通模块调用 callModule → moduleHandler</h5>
<p><code>moduleHandler</code> 是普通模块调用的最终转发函数，源码中通过 <code>global.callNativeModule</code> 对接 Native：</p>
<pre><code class="hljs language-javascript" lang="javascript">proto.<span class="hljs-property">moduleHandler</span> = <span class="hljs-variable language_">global</span>.<span class="hljs-property">callNativeModule</span> ||
    (<span class="hljs-function">(<span class="hljs-params">id, <span class="hljs-variable language_">module</span>, method, args</span>) =&gt;</span>
      <span class="hljs-title function_">fallback</span>(id, [{ <span class="hljs-variable language_">module</span>, method, args }]))
</code></pre>
<ul>
<li>正常情况（客户端环境）：<code>global.callNativeModule</code> 是 <strong>Native 注入到 JS 全局的函数</strong>（iOS/Android 原生实现），直接接收 <code>instanceId</code>、模块名、方法名、参数，传递给 Native 层。</li>
<li>降级情况（无 Native 桥接）：调用 <code>fallback</code> 函数（初始化时由 <code>sendTasks</code> 参数传入，通常用于调试 / 模拟）。</li>
</ul>
<h5 data-id="heading-48">2. 自定义组件调用 callComponent → componentHandler</h5>
<p>逻辑与 <code>moduleHandler</code> 一致，对接 <code>global.callNativeComponent</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">proto.<span class="hljs-property">componentHandler</span> = <span class="hljs-variable language_">global</span>.<span class="hljs-property">callNativeComponent</span> ||
  (<span class="hljs-function">(<span class="hljs-params">id, ref, method, args, options</span>) =&gt;</span>
    <span class="hljs-title function_">fallback</span>(id, [{ <span class="hljs-attr">component</span>: options.<span class="hljs-property">component</span>, ref, method, args }]))
</code></pre>
<h5 data-id="heading-49">3. DOM 方法调用 callDOM → 独立全局函数映射</h5>
<p>DOM 相关的 Native 方法（如 <code>addElement</code>/<code>updateStyle</code>）被单独映射到 <code>global</code> 上的独立函数（而非统一的 <code>callNative</code>），源码通过 <code>init</code> 函数初始化映射：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码第 116-138 行：DOM 方法与 Native 全局函数的映射</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span> () {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOM_METHODS</span> = {
    <span class="hljs-attr">createFinish</span>: <span class="hljs-variable language_">global</span>.<span class="hljs-property">callCreateFinish</span>,
    <span class="hljs-attr">addElement</span>: <span class="hljs-variable language_">global</span>.<span class="hljs-property">callAddElement</span>, <span class="hljs-comment">// DOM 创建元素 → Native 的 callAddElement</span>
    <span class="hljs-attr">removeElement</span>: <span class="hljs-variable language_">global</span>.<span class="hljs-property">callRemoveElement</span>, <span class="hljs-comment">// DOM 删除元素 → Native 的 callRemoveElement</span>
    <span class="hljs-attr">updateAttrs</span>: <span class="hljs-variable language_">global</span>.<span class="hljs-property">callUpdateAttrs</span>, <span class="hljs-comment">// 更新属性 → Native 的 callUpdateAttrs</span>
    <span class="hljs-comment">// ... 其他 DOM 方法</span>
  }
  <span class="hljs-keyword">const</span> proto = <span class="hljs-title class_">TaskCenter</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>

  <span class="hljs-comment">// 给 TaskCenter 原型挂载 DOM 方法，直接调用 Native 注入的全局函数</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> name <span class="hljs-keyword">in</span> <span class="hljs-variable constant_">DOM_METHODS</span>) {
    <span class="hljs-keyword">const</span> method = <span class="hljs-variable constant_">DOM_METHODS</span>[name]
    proto[name] = method ?
      <span class="hljs-function">(<span class="hljs-params">id, args</span>) =&gt;</span> <span class="hljs-title function_">method</span>(id, ...args) : <span class="hljs-comment">// 正常情况：调用 Native 全局函数</span>
      <span class="hljs-function">(<span class="hljs-params">id, args</span>) =&gt;</span> <span class="hljs-title function_">fallback</span>(...) <span class="hljs-comment">// 降级情况</span>
  }
}
</code></pre>
<p>例如调用 <code>callDOM('addElement', args)</code> 时，最终会执行 <code>global.callAddElement(instanceId, ...args)</code>，直接对接 Native 的 DOM 模块。其实是注入到 JSContext 里的方法对象。</p>
<p>在 Weex 的 JS 运行环境中，<code>global</code> 是 <strong>JS 全局对象（Global Object）</strong>—— 它是所有 JS 代码的 “顶层容器”，所有未被定义在局部作用域的变量、函数，最终都会挂载到 <code>global</code> 上（类似浏览器环境的 <code>window</code>，Node.js 环境的 <code>global</code>）</p>
<p><strong>Native 向 JS 引擎的 “全局上下文” 注入 <code>callAddElement</code> 函数时，该函数会自动成为 <code>global</code> 对象的属性</strong>——JS 侧的 <code>global.callAddElement</code>，本质就是访问这个被 Native 注入到全局的函数。</p>
<p>QA：global 是什么？</p>
<p>是 JS 全局对象。不管是浏览器、Node.js 还是 Weex 的 JS 引擎（JavaScriptCore/QuickJS），都有一个 <strong>全局对象（Global Object）</strong>：</p>
<ul>
<li>它是 JS 运行环境的 “根”，所有全局变量、函数都是它的属性；</li>
<li>不同环境的全局对象名称不同：
<ul>
<li>浏览器环境：叫 <code>window</code>（比如 <code>window.alert</code>、<code>window.document</code>）；</li>
<li>Node.js 环境：叫 <code>global</code>（比如 <code>global.console</code>、<code>global.setTimeout</code>）；</li>
<li>Weex 环境：叫 <code>global</code>（因为 Weex 不依赖浏览器，没有 <code>window</code>，直接用 JS 引擎原生的全局对象 <code>global</code>）。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-objective-c" lang="objective-c">// WXJSCoreBridge.mm
- (void)registerCallAddElement:(WXJSCallAddElement)callAddElement
{
    id callAddElementBlock = ^(JSValue *instanceId, JSValue *ref, JSValue *element, JSValue *index, JSValue *ifCallback) {
        NSString *instanceIdString = [instanceId toString];
        WXSDKInstance *instance = [WXSDKManager instanceForID:instanceIdString];
        if (instance.unicornRender) {
            JSValueRef args[] = {instanceId.JSValueRef, ref.JSValueRef, element.JSValueRef, index.JSValueRef};
            [WXCoreBridge callUnicornRenderAction:instanceIdString
                                           module:"dom"
                                           method:"addElement"
                                          context:[JSContext currentContext]
                                             args:args
                                         argCount:4];
            return [JSValue valueWithInt32:0 inContext:[JSContext currentContext]];
        }

        NSDictionary *componentData = [element toDictionary];
        NSString *parentRef = [ref toString];
        NSInteger insertIndex = [[index toNumber] integerValue];
        if (WXAnalyzerCenter.isInteractionLogOpen) {
            WXLogDebug(@"wxInteractionAnalyzer : [jsengin][addElementStart],%@,%@",instanceIdString,componentData[@"ref"]);
        }
        return [JSValue valueWithInt32:(int32_t)callAddElement(instanceIdString, parentRef, componentData, insertIndex) inContext:[JSContext currentContext]];
    };
    
    _jsContext[@"callAddElement"] = callAddElementBlock;
}
</code></pre>
<p>在 js 侧是通过  TaskCenter.js 的 init 方法中定义的，存在映射关系， <code>addElement: global.callAddElement,</code></p>
<h3 data-id="heading-50">3. callJS 实现</h3>
<p><code>WXReactorProtocol</code> 协议：</p>
<ul>
<li>定义 Native 调用 JS 的「标准接口」（如触发回调、发送事件），不关心底层用哪种 JS 引擎（JavaScriptCore / 其他）；</li>
<li>具体的桥接类（如 <code>WXJSCoreBridge</code>）遵守这个协议，实现接口方法 —— 即使未来替换 JS 引擎，只要遵守协议，上层代码（如 Native 模块、组件）无需修改。</li>
</ul>
<pre><code class="hljs language-objective-c" lang="objective-c">
@class JSContext;

@protocol WXReactorProtocol &lt;NSObject&gt;

@required

/**
Weex should register a JSContext to reactor
*/
- (void)registerJSContext:(NSString *)instanceId;

/**
 Reactor execute js source
*/
- (void)render:(NSString *)instanceId source:(NSString*)source data:(NSDictionary* _Nullable)data;

- (void)unregisterJSContext:(NSString *)instanceId;

/**
 When js call Weex NativeModule, invoke callback function
 
 @param instanceId : weex instance id
 @param callbackId : callback function id
 @param args       : args
*/
- (void)invokeCallBack:(NSString *)instanceId function:(NSString *)callbackId args:(NSArray * _Nullable)args;

/**
Native event to js
 
@param instanceId :   instance id
@param ref        :   node reference
@param event      :   event type
@param args       :   parameters in event object
@param domChanges :  dom value changes, used for two-way data binding
*/
- (void)fireEvent:(NSString *)instanceId ref:(NSString *)ref event:(NSString *)event args:(NSDictionary * _Nullable)args domChanges:(NSDictionary * _Nullable)domChanges;

@end
</code></pre>
<p>Native 模块（Module)/组件(Component) 完成任务后 -&gt;  <code>WXBridgeManager.callBack(...)</code> → 构造 JS 脚本（调用 <code>TaskCenter.callback</code>） → <code>WXJSCoreBridge.executeJavascript(...)</code> → JS 引擎执行 → <code>TaskCenter.callback</code> 响应</p>
<p><code>WXJSCoreBridge</code> 本身不直接拼接回调脚本，而是提供 <code>executeJavascript:</code> 方法（源码第 102 行），作为 JS 脚本执行的底层入口；真正的脚本构造，在 <code>WXBridgeManager</code> 中</p>
<p>WXBridgeManager 事件回调</p>
<pre><code class="hljs language-javascript" lang="javascript">- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">fireEvent</span>:(<span class="hljs-title class_">NSString</span> *)instanceId <span class="hljs-attr">ref</span>:(<span class="hljs-title class_">NSString</span> *)ref <span class="hljs-attr">type</span>:(<span class="hljs-title class_">NSString</span> *)type <span class="hljs-attr">params</span>:(<span class="hljs-title class_">NSDictionary</span> *)params
{
    [self <span class="hljs-attr">fireEvent</span>:instanceId <span class="hljs-attr">ref</span>:ref <span class="hljs-attr">type</span>:type <span class="hljs-attr">params</span>:params <span class="hljs-attr">domChanges</span>:nil];
}

- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">fireEvent</span>:(<span class="hljs-title class_">NSString</span> *)instanceId <span class="hljs-attr">ref</span>:(<span class="hljs-title class_">NSString</span> *)ref <span class="hljs-attr">type</span>:(<span class="hljs-title class_">NSString</span> *)type <span class="hljs-attr">params</span>:(<span class="hljs-title class_">NSDictionary</span> *)params <span class="hljs-attr">domChanges</span>:(<span class="hljs-title class_">NSDictionary</span> *)domChanges
{
    [self <span class="hljs-attr">fireEvent</span>:instanceId <span class="hljs-attr">ref</span>:ref <span class="hljs-attr">type</span>:type <span class="hljs-attr">params</span>:params <span class="hljs-attr">domChanges</span>:domChanges <span class="hljs-attr">handlerArguments</span>:nil];
}
- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">fireEvent</span>:(<span class="hljs-title class_">NSString</span> *)instanceId <span class="hljs-attr">ref</span>:(<span class="hljs-title class_">NSString</span> *)ref <span class="hljs-attr">type</span>:(<span class="hljs-title class_">NSString</span> *)type <span class="hljs-attr">params</span>:(<span class="hljs-title class_">NSDictionary</span> *)params <span class="hljs-attr">domChanges</span>:(<span class="hljs-title class_">NSDictionary</span> *)domChanges <span class="hljs-attr">handlerArguments</span>:(<span class="hljs-title class_">NSArray</span> *)handlerArguments
{
	   <span class="hljs-comment">// ...</span>
    <span class="hljs-title class_">WXCallJSMethod</span> *method = [[<span class="hljs-title class_">WXCallJSMethod</span> alloc] <span class="hljs-attr">initWithModuleName</span>:nil <span class="hljs-attr">methodName</span>:@<span class="hljs-string">"fireEvent"</span> <span class="hljs-attr">arguments</span>:[<span class="hljs-title class_">WXUtility</span> <span class="hljs-attr">convertContainerToImmutable</span>:args] <span class="hljs-attr">instance</span>:instance];
    [self <span class="hljs-attr">callJsMethod</span>:method];
}

- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">callJsMethod</span>:(<span class="hljs-title class_">WXCallJSMethod</span> *)method
{
    <span class="hljs-keyword">if</span> (!method || !method.<span class="hljs-property">instance</span>) <span class="hljs-keyword">return</span>;
    
    __weak <span class="hljs-title function_">typeof</span>(self) weakSelf = self;
    <span class="hljs-title class_">WXPerformBlockOnBridgeThreadForInstance</span>(^(){
        <span class="hljs-title class_">WXBridgeContext</span>* context = method.<span class="hljs-property">instance</span>.<span class="hljs-property">useBackupJsThread</span> ? weakSelf.<span class="hljs-property">backupBridgeCtx</span> :  weakSelf.<span class="hljs-property">bridgeCtx</span>;
        [context <span class="hljs-attr">executeJsMethod</span>:method];
    }, method.<span class="hljs-property">instance</span>.<span class="hljs-property">instanceId</span>);
}
</code></pre>
<p>WXBridgeContext.m 代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">executeJsMethod</span>:(<span class="hljs-title class_">WXCallJSMethod</span> *)method {    
   <span class="hljs-comment">// ...</span>
    [sendQueue <span class="hljs-attr">addObject</span>:method];
    [self <span class="hljs-attr">performSelector</span>:@<span class="hljs-title function_">selector</span>(_sendQueueLoop) <span class="hljs-attr">withObject</span>:nil];
}

- (<span class="hljs-keyword">void</span>)_sendQueueLoop {
    <span class="hljs-keyword">if</span> ([tasks count] &gt; <span class="hljs-number">0</span> &amp;&amp; execIns) {
        <span class="hljs-title class_">WXSDKInstance</span> * execInstance = [<span class="hljs-title class_">WXSDKManager</span> <span class="hljs-attr">instanceForID</span>:execIns];
        <span class="hljs-title class_">NSTimeInterval</span> start = <span class="hljs-title class_">CACurrentMediaTime</span>()*<span class="hljs-number">1000</span>;
        
        <span class="hljs-keyword">if</span> (execInstance.<span class="hljs-property">instanceJavaScriptContext</span> &amp;&amp; execInstance.<span class="hljs-property">bundleType</span>) {
            [self <span class="hljs-attr">callJSMethod</span>:@<span class="hljs-string">"__WEEX_CALL_JAVASCRIPT__"</span> <span class="hljs-attr">args</span>:@[execIns, [tasks copy]] <span class="hljs-attr">onContext</span>:execInstance.<span class="hljs-property">instanceJavaScriptContext</span> <span class="hljs-attr">completion</span>:nil];
        } <span class="hljs-keyword">else</span> {
            [self <span class="hljs-attr">callJSMethod</span>:@<span class="hljs-string">"callJS"</span> <span class="hljs-attr">args</span>:@[execIns, [tasks copy]]];
        }
        <span class="hljs-comment">// ...</span>
    }
}

- (<span class="hljs-keyword">void</span>)<span class="hljs-attr">callJSMethod</span>:(<span class="hljs-title class_">NSString</span> *)method <span class="hljs-attr">args</span>:(<span class="hljs-title class_">NSArray</span> *)args {
    <span class="hljs-keyword">if</span> (self.<span class="hljs-property">frameworkLoadFinished</span>) {
        [self.<span class="hljs-property">jsBridge</span> <span class="hljs-attr">callJSMethod</span>:method <span class="hljs-attr">args</span>:args];
    } <span class="hljs-keyword">else</span> {
        [_methodQueue <span class="hljs-attr">addObject</span>:@{@<span class="hljs-string">"method"</span>:method, @<span class="hljs-string">"args"</span>:args}];
    }
}
</code></pre>
<p>再到 WXJSCoreManager</p>
<pre><code class="hljs language-javascript" lang="javascript">- (<span class="hljs-title class_">JSValue</span> *)<span class="hljs-attr">callJSMethod</span>:(<span class="hljs-title class_">NSString</span> *)method <span class="hljs-attr">args</span>:(<span class="hljs-title class_">NSArray</span> *)args {
    <span class="hljs-title class_">WXLogDebug</span>(@<span class="hljs-string">"Calling JS... method:%@, args:%@"</span>, method, args);
    <span class="hljs-title class_">WXPerformBlockOnMainThread</span>(^{
        [[<span class="hljs-title class_">WXBridgeManager</span> sharedManager].<span class="hljs-property">lastMethodInfo</span> <span class="hljs-attr">setObject</span>:method ?: @<span class="hljs-string">""</span> <span class="hljs-attr">forKey</span>:@<span class="hljs-string">"method"</span>];
        [[<span class="hljs-title class_">WXBridgeManager</span> sharedManager].<span class="hljs-property">lastMethodInfo</span> <span class="hljs-attr">setObject</span>:args ?: @[] <span class="hljs-attr">forKey</span>:@<span class="hljs-string">"args"</span>];
    });
    <span class="hljs-keyword">return</span> [[_jsContext globalObject] <span class="hljs-attr">invokeMethod</span>:method <span class="hljs-attr">withArguments</span>:[args copy]];
}
</code></pre>
<p>其实不管是 CallJS 还是 CallNative，通信的技术方案设计和 Hybrid 的设计一致，都需要在 JavascriptCore 的 global 对象上挂载一个方法。比如 Native 注册了一个 WXComponent 之后，Weex 侧用 Vue 语法写完了个页面，呈现在用户手机上，用户点击页面上的按钮之后，Native 再将事件回调给 Weex 侧，Weex 再去处理后续逻辑。</p>
<h3 data-id="heading-51">4. WXAssertComponentThread 断言</h3>
<p><code>WXAssertComponentThread</code> 的核心作用是 <strong>强制约束组件相关操作在「组件专属线程」执行</strong>，本质是为了解决「线程安全」和「性能稳定性」问题</p>
<p>iOS 开发的核心线程规则是「UI 操作必须在主线程」，但 Weex 组件的工作流程（绑定解析、数据计算、布局计算、子组件管理）包含大量「非 UI 操作」—— 如果这些操作都在主线程执行，会阻塞主线程（比如长列表数据解析、复杂表达式计算），导致 UI 卡顿（比如滑动掉帧）</p>
<p>因此 Weex 设计了线程分工</p>

















<table><thead><tr><th>线程类型</th><th>负责的操作</th></tr></thead><tbody><tr><td>组件专属线程</td><td>绑定规则解析（<code>_storeBindings</code>）、表达式计算（<code>bindingBlockWithExpression</code>）、数据更新（<code>updateBindingData</code>）、布局计算（<code>calculateLayout</code>）</td></tr><tr><td>主线程</td><td>最终 UI 渲染（如 <code>UIImageView</code> 设图、<code>UILabel</code> 设文本）、子视图增删（<code>insertSubview</code>）</td></tr></tbody></table>
<h4 data-id="heading-52">1. 避免「线程安全问题」，防止崩溃 / 数据错乱</h4>
<p>组件的核心数据（如 <code>_bindingProps</code>、<code>_subcomponents</code>、<code>_flexCssNode</code>）都是「非线程安全的」（没有加锁保护）—— 如果多个线程同时读写这些数据，会导致：</p>
<ul>
<li>数据竞争：比如主线程读取 <code>_subcomponents</code> 遍历，组件线程同时修改 <code>_subcomponents</code>（增删子组件），导致数组越界崩溃；</li>
<li>数据不一致：比如组件线程更新 <code>_bindingProps</code> 的值，主线程同时读取该值用于 UI 更新，导致显示错误的旧值；</li>
<li>野指针：比如组件线程销毁子组件，主线程还在访问该子组件的 <code>view</code>。</li>
</ul>
<p>线程断言通过「强制所有组件核心操作在同一线程执行」，从根源上避免了这些跨线程问题 —— 同一时间只有一个线程操作组件数据，无需复杂锁机制（锁会降低性能）。</p>
<h4 data-id="heading-53">2. 简化调试，快速定位线程问题</h4>
<p>如果没有线程断言，跨线程操作组件可能导致「偶现崩溃」（比如 100 次操作出现 1 次），难以复现和排查（日志中看不到线程上下文）。而线程断言会在「违规线程调用时直接崩溃」，并明确提示「必须在组件线程执行」，开发者能立刻定位到违规代码（比如在主线程调用了 <code>updateBindingData</code>），大幅降低调试成本。</p>
<h4 data-id="heading-54">3. 保证操作顺序一致性</h4>
<p>组件的更新流程是「解析绑定 → 计算表达式 → 更新属性 → 布局计算 → UI 渲染」—— 这些步骤必须按顺序执行。如果分散在多个线程，可能出现「布局计算还没完成，UI 已经开始渲染」的情况（导致布局错乱）。组件专属线程保证了所有操作串行执行，顺序不会乱。</p>
<h3 data-id="heading-55">5. WXJSASTParser 的工作原理</h3>
<p><code>WXJSASTParser</code> 如何把表达式字符串解析为 AST 节点？</p>
<p><code>WXJSASTParser</code> 是 Weex 自定义的「轻量 JS 表达式解析器」—— 核心是「按 JS 语法规则，把字符串拆分为结构化的 AST 节点」，全程不依赖完整 JS 引擎（如 JSC/V8），只支持绑定表达式需要的基础语法（标识符、成员访问、二元运算等），兼顾性能和体积。</p>
<p>整个解析过程分 3 步：<strong>词法分析 → 语法分析 → AST 节点封装</strong>，和编译器的前端流程一致，以下结合示例（<code>"user.name + '?size=100'"</code>）拆解：</p>
<p>先明确：AST 是什么？</p>
<p>AST（抽象语法树）是「用树形结构表示代码语法」的中间结构 —— 比如表达式 <code>user.name + '?size=100'</code>，AST 会拆分为：</p>
<pre><code class="hljs language-shell" lang="shell">根节点：BinaryExpression（运算符 '+'）
├─ 左子节点：MemberExpression（成员访问）
│  ├─ object：Identifier（标识符 'user'）
│  └─ property：Identifier（标识符 'name'）
└─ 右子节点：StringLiteral（字符串字面量 '?size=100'）
</code></pre>
<p>这种结构能被程序快速遍历和计算（比如之前讲的生成 <code>WXDataBindingBlock</code> 时，递归遍历节点执行运算）。</p>
<h4 data-id="heading-56">1.词法分析（Lexical Analysis）</h4>
<p>拆分为词法单元（Token）。词法分析是「把表达式字符串拆分为最小的、有意义的语法单元」，忽略空格、换行等无关字符。核心是「按 JS 语法规则匹配字符序列」。</p>
<p><code>表达式 </code>"user.name + '?size=100'"` 词法分析后得到的 Token 序列：</p>



































<table><thead><tr><th>Token 类型</th><th>Token 值</th><th>说明</th></tr></thead><tbody><tr><td><code>IDENTIFIER</code></td><td><code>user</code></td><td>标识符（变量名 / 属性名）</td></tr><tr><td><code>DOT</code></td><td><code>.</code></td><td>成员访问运算符</td></tr><tr><td><code>IDENTIFIER</code></td><td><code>name</code></td><td>标识符</td></tr><tr><td><code>PLUS</code></td><td><code>+</code></td><td>二元运算符（加法 / 拼接）</td></tr><tr><td><code>STRING_LITERAL</code></td><td><code>?size=100</code></td><td>字符串字面量（去掉引号）</td></tr></tbody></table>
<p>词法分析的实现逻辑（简化）：</p>
<ol>
<li>初始化一个「字符指针」，从表达式字符串开头遍历；</li>
<li>遇到字母 / 下划线 → 继续往后读，直到非字母 / 数字 / 下划线 → 识别为 <code>IDENTIFIER</code>（如 <code>user</code>）；</li>
<li>遇到 <code>+</code>/<code>-</code>/<code>*</code>/<code>/</code>/<code>&gt;</code>/<code>=</code> 等 → 识别为对应运算符（如 <code>+</code> → <code>PLUS</code>）；</li>
<li>遇到 <code>"</code> 或 <code>'</code> → 继续往后读，直到下一个相同引号 → 识别为 <code>STRING_LITERAL</code>（去掉引号）；</li>
<li>遇到 <code>.</code> → 识别为 <code>DOT</code>（成员访问）；</li>
<li>遇到空格 / 制表符 → 直接跳过（无意义字符）；</li>
<li>遇到无法识别的字符（如 <code>#</code>/<code>@</code>）→ 抛出语法错误（<code>WXLogError</code>）。</li>
</ol>
<p>Weex 的 <code>WXJSASTParser</code> 内部会维护一个「Token 流」（数组），词法分析后把 Token 按顺序存入流中，供下一步语法分析使用。</p>
<h4 data-id="heading-57">2. 语法分析（Syntactic Analysis）</h4>
<p>语法分析是「根据 JS 表达式语法规则，把 Token 流组合为树形 AST 节点」—— 核心是「验证 Token 序列是否符合语法，并构建层级关系」。</p>
<p>Weex 支持的 JS 表达式语法子集（核心）：</p>
<ul>
<li>标识符：<code>user</code>、<code>imageUrl</code>（对应 <code>WXJSIdentifier</code>）；</li>
<li>成员访问：<code>user.name</code>、<code>list[0]</code>（对应 <code>WXJSMemberExpression</code>）；</li>
<li>字面量：字符串（<code>'abc'</code>）、数字（<code>123</code>）、布尔（<code>true</code>）、null（对应 <code>WXJSStringLiteral</code>/<code>WXJSNumericLiteral</code> 等）；</li>
<li>二元运算：<code>a + b</code>、<code>age &gt; 18</code>、<code>a === b</code>（对应 <code>WXJSBinaryExpression</code>）；</li>
<li>条件运算：<code>age &gt; 18 ? 'adult' : 'teen'</code>（对应 <code>WXJSConditionalExpression</code>）；</li>
<li>数组表达式：<code>[a, b, c]</code>（对应 <code>WXJSArrayExpression</code>）。</li>
</ul>
<p>示例：Token 流 → AST 节点的构建过程</p>
<p>Token 流：<code>IDENTIFIER(user) → DOT → IDENTIFIER(name) → PLUS → STRING_LITERAL(?size=100)</code></p>
<ol>
<li>语法分析器先读取前 3 个 Token（<code>user</code> → <code>.</code> → <code>name</code>），匹配「成员访问语法规则」（<code>IDENTIFIER . IDENTIFIER</code>）→ 构建 <code>WXJSMemberExpression</code> 节点（左子节点 <code>user</code>，右子节点 <code>name</code>）；</li>
<li>接着读取 <code>PLUS</code>（二元运算符），再读取后面的 <code>STRING_LITERAL(?size=100)</code> → 匹配「二元运算语法规则」（<code>Expression + Expression</code>）；</li>
<li>把之前构建的 <code>WXJSMemberExpression</code> 作为「左子节点」，<code>STRING_LITERAL</code> 作为「右子节点」，<code>PLUS</code>作为「运算符」→ 构建根节点 <code>WXJSBinaryExpression</code>；</li>
<li>最终生成 AST 树（如之前的结构）。</li>
</ol>
<p>语法分析的实现逻辑（简化）：</p>
<p>Weex 采用「递归下降分析法」（最适合手工实现的语法分析方法）：</p>
<ol>
<li>为每种表达式类型定义一个「解析函数」（如 <code>parseMemberExpression</code> 解析成员访问、<code>parseBinaryExpression</code> 解析二元运算）；</li>
<li>解析函数递归调用：比如 <code>parseBinaryExpression</code> 会调用 <code>parseMemberExpression</code> 解析左右操作数，<code>parseMemberExpression</code> 会调用 <code>parseIdentifier</code> 解析标识符；</li>
<li>语法校验：如果 Token 序列不符合规则（如 <code>user.name +</code> 缺少右操作数），会抛出「语法错误」日志，终止解析。</li>
</ol>
<h4 data-id="heading-58">3. AST 节点封装</h4>
<p>转为 Weex 自定义的 <code>WXJSExpression</code>。语法分析生成的是「抽象语法树结构」，Weex 会把这个结构封装为自定义的 <code>WXJSExpression</code> 子类（对应不同表达式类型），每个子类存储该节点的关键信息（如运算符、子节点），供后续生成 <code>WXDataBindingBlock</code> 使用。</p>
<p>示例封装：</p>
<ul>
<li><code>WXJSMemberExpression</code> 类：存储 <code>object</code>（子节点，如 <code>user</code>）、<code>property</code>（子节点，如 <code>name</code>）、<code>computed</code>（是否是计算属性，如 <code>list[0]</code> 为 <code>YES</code>，<code>user.name</code> 为 <code>NO</code>）；</li>
<li><code>WXJSBinaryExpression</code> 类：存储 <code>left</code>（左子节点）、<code>right</code>（右子节点）、<code>operator_</code>（运算符字符串，如 <code>"+"</code>）；</li>
<li>字面量类（如 <code>WXJSStringLiteral</code>）：存储 <code>value</code>（字面量值，如 <code>?size=100</code>）。</li>
</ul>
<p>这些类的定义在 Weex 源码的 <code>WXJSASTParser.h</code> 中，本质是「数据容器」，把 AST 结构转化为 Objective-C 代码可访问的对象。</p>
<p><code>WXJSASTParser</code> 本质：它不是完整的 JS 解析器（不支持 <code>function</code>、<code>for</code> 等复杂语法），而是「专门为 Weex 绑定表达式设计的轻量解析器」—— 只解析需要的 JS 表达式子集，把字符串转为结构化的 AST 节点，最终目的是「让 Native 代码能递归遍历节点，计算出表达式结果」（如 <code>user.name + '?size=100'</code> → <code>avatar.png?size=100</code>）。</p>
<p>这种「自定义轻量解析器」的设计，既避免了依赖完整 JS 引擎的体积和性能开销，又能精准适配 Weex 的绑定需求，是跨端框架的常见优化思路。</p>
<h2 data-id="heading-59">十、值得借鉴的地方</h2>
<h3 data-id="heading-60">1. WXThreadSafeMutableDictionary 线程安全字典</h3>
<p>Weex 中的 WXThreadSafeMutableDictionary 提供了一个线程安全的字典，其本质是通过加 pthread_muext_t 锁来维护内部的一个字典的。
比如下面的代码</p>
<p>初始化锁相关的配置</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">@interface WXThreadSafeMutableDictionary ()
{
    NSMutableDictionary* _dict;
    pthread_mutex_t _safeThreadDictionaryMutex;
    pthread_mutexattr_t _safeThreadDictionaryMutexAttr;
}

@end

@implementation WXThreadSafeMutableDictionary

- (instancetype)initCommon
{
    self = [super init];
    if (self) {
        pthread_mutexattr_init(&amp;(_safeThreadDictionaryMutexAttr));
        pthread_mutexattr_settype(&amp;(_safeThreadDictionaryMutexAttr), PTHREAD_MUTEX_RECURSIVE); // must use recursive lock
        pthread_mutex_init(&amp;(_safeThreadDictionaryMutex), &amp;(_safeThreadDictionaryMutexAttr));
    }
    return self;
}

- (instancetype)init
{
    self = [self initCommon];
    if (self) {
        _dict = [NSMutableDictionary dictionary];
    }
    return self;
}
</code></pre>
<p>在字典操作的地方使用锁</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">- (void)setObject:(id)anObject forKey:(id&lt;NSCopying&gt;)aKey
{
    id originalObject = nil; // make sure that object is not released in lock
    @try {
        pthread_mutex_lock(&amp;_safeThreadDictionaryMutex);
        originalObject = [_dict objectForKey:aKey];
        [_dict setObject:anObject forKey:aKey];
    }
    @finally {
        pthread_mutex_unlock(&amp;_safeThreadDictionaryMutex);
    }
    originalObject = nil;
}
</code></pre>
<p>这么写的价值：<strong>解锁逻辑「绝对执行」，彻底避免死锁</strong>
这是 <code>@try-finally</code> 最核心的价值 ——无论 try 块内发生什么（正常执行、提前 return、抛异常），finally 块的解锁逻辑一定会执行</p>
<p>对比无 try-finally 的写法</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">// Bad: 若setObject抛异常，unlock不会执行→死锁
pthread_mutex_lock(&amp;_mutex);
[_dict setObject:anObject forKey:aKey];
pthread_mutex_unlock(&amp;_mutex); 
</code></pre>
<p>问题：<code>[_dict setObject:anObject forKey:aKey]</code> 可能抛异常（比如 aKey = nil 时会触发 NSInvalidArgumentException），若没有 finally，锁会被永久持有→其他线程调用 lock 时死锁，整个字典无法再操作。</p>
<p>设计优点：</p>
<ul>
<li><code>@try-finallly</code>：即使 try 内逻辑出错，finally 也会执行 pthread_mutex_unlock，保证锁最终释放，这是<strong>线程安全的「兜底保障」</strong></li>
<li>注意，不是 <code>try...catch...finally</code>: 如果加了 catch 逻辑，则字典的 key 为 nil 产生的崩溃也会被捕获掉，这属于不符合预期的行为。因为 key 为 nil 产生的原因太多了，可能是业务代码异常，也可能是数据异常，也可能是逻辑错误，如果一刀切直接用 <code>try...catch...finally</code> 捕获了异常，但是没有配置异常的收集、上报、处理逻辑，属于边界不清晰，本质是为了解决加解锁不匹配而可能带来的线程安全问题，却"多管闲事"，把字典 key 为 nil 本该向上跑的异常而卡住了（这个问题不再赘述，是一个经典的策略问题，端上的异常发生时，安全气垫的“做与不做”问题）</li>
</ul>
<p>延伸：聊聊类似网易的大白解决方案或者业界其他公司中，安全气垫虽然保证了代码不 crash，影响用户体验，但是比如数组本该越界，现在却不越界：</p>
<ol>
<li>唯一能做的就是返回一个错误的值，比如数组长度为3，访问4，现在不 crash，返回了 0 的值，那是不是产生了业务异常？比如商品价格</li>
<li>不 crash，也不返回错误位置的值，类似给一个回调，告诉业务方出现了异常，可以做一些业务层面的提醒或者配置(比如开发阶段商品卡片的价格 Label 显示：商品价格获取错误，数组越界)，同时产生的异常案发现场信息和其他的一些数据会上报，用于 APM 平台去分析和定位。</li>
</ol>
<p>但这也产生一个问题，类似数组越界的场景，可能10000次里面9999次都正常，只有1次异常，业务开发为了这万分之一出现的异常，还需要写一些异常处理的逻辑（比如商品卡片展示价格获取错误，数组越界）。那字典的 key 为 nil 呢？除法的分母为0呢？诸如此类，类似乐观锁和悲观锁的场景</p>
<p>相关问题的思考可以查看这篇文章：<a href="https://link.juejin.cn?target=.%2F1.148.md" target="_blank" title="./1.148.md" ref="nofollow noopener noreferrer">安全气垫</a></p>
<ul>
<li>WXHandlerFactory：Weex 核心的「处理器工厂」，负责管理所有协议（如图片加载、网络请求、存储等）的实现类注册 / 查找；</li>
<li>WXImgLoaderProtocol：Weex 定义的「图片加载协议」，仅声明接口（下载、取消、缓存等），不包含具体实现。</li>
</ul>
<p>Weex 支持业务层自定义图片加载逻辑（比如统一用项目的图片缓存库、添加下载拦截、埋点等），此时自定义实现类会替代默认实现，成为下载执行者：
步骤 1：业务层创建类（如 MyCustomImgLoader），遵循 WXImgLoaderProtocol，实现 wx_loadImageWithURL: 等协议方法（内部可调用 SDWebImage/AFNetworking 等完成下载）；
步骤 2：将自定义类注册到 WXHandlerFactory：</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">[WXHandlerFactory registerHandler:[MyCustomImgLoader new] forProtocol:@protocol(WXImgLoaderProtocol)];
</code></pre>
<p>步骤 3：此时 [WXHandlerFactory handlerForProtocol:@protocol(WXImgLoaderProtocol)] 会返回 MyCustomImgLoader 实例，所有图片下载由该类负责</p>
<h3 data-id="heading-61">2. 设计分层合理</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[开发者编写的 .we/.vue 文件] --&gt; B[Transformer&lt;br/&gt;转换JS Bundle];
    B --&gt; C[JS Framework&lt;br/&gt;解析并管理Virtual DOM];
    C -- 通过JS Bridge发送渲染指令 --&gt; D[Native SDK&lt;br/&gt;渲染引擎];
    D --&gt; E[iOS/Android/Web 原生视图];
    
    C -- 支持多种DSL --&gt; F[Vue.js];
    C -- 支持多种DSL --&gt; G[Rax（类React）];
    D -- 原生能力扩展 --&gt; H[自定义Component];
    D -- 原生能力扩展 --&gt; I[自定义Module];
</code></pre>
<p>Weex 最核心的设计是将整个框架清晰地分为：<strong>语法层（DSL）</strong>、<strong>中间层（JS Framework）<strong>和</strong>渲染层（Native SDK）</strong></p>
<p>这种渲染引擎和语法层 DSL 分离的设计，可以使得上层 DSL 方便拓展 Vue、Rax 写法，下层渲染引擎可以保持较好的稳定性。为了生态的拓展提供了极大的便携性。</p>
<h3 data-id="heading-62">3. 可扩展的组件与模块系统</h3>
<p>Weex 通过<code>WXSDKEngine.registerComponent()</code> 和 <code>registerModule()</code> 方法，允许开发者扩展原生组件 （UI Component）和模块（Login Module）。这套机制设计得足够底层和通用，使得 Weex 可以由开发者来注册，由公司内的体验设计中心规范来落地的组件。以及一些基础能力。这样子 Weex 官方已经提供了一些功能强大的筋骨，我们在其之上可以提供更符合需求的外表和更有力量的一块手臂肌肉。</p>
<p>虽然事后视角来看，Weex、RN、Flutter，甚至是更早的、设计完善的 Hybrid 都有该能力。但这对于远古时期的 Weex 来说，还是可圈可点的。</p>
<h3 data-id="heading-63">4.  轻量 JSBundle + 增量更新支持</h3>
<p>Weex 的 JSBundle 仅包含业务逻辑和组件描述，框架代码（Vue 内核、Weex 基础 API）内置在原生 SDK 中，因此 Bundle 体积极小；同时支持将 Bundle 拆分为 “基础包（公共逻辑）+ 业务包（页面逻辑）”，实现增量更新。</p>
<p>解决了跨端框架 “首屏加载慢” 的痛点（小 Bundle 加载更快），同时增量更新降低了发布成本。</p>
<h2 data-id="heading-64">十一、Weex APM</h2>
<h3 data-id="heading-65">1. 历史背景</h3>
<p>Weex 是诸多年前的产物，部分业务线用 Weex 写了部分功能模块，或者是某几个页面，或者是某个二级、三级业务 SDK 的页面。但可以确定的是：</p>
<ul>
<li>21年就完成了 Flutter 的基建开发（对齐 Native 的 UI 组件库，遵循体验设计平台产出的集团 UI 标准；做了 Flutter 的大量 plugin、打包构建平台、日志库、网络库、探照灯、APM SDK、热修复能力等）。新业务的实现只会在 Native 和 Flutter 上考虑</li>
<li>Weex 业务代码基本上是存量的</li>
<li>Weex 代码没有 bug 就不去修改；有版本迭代，之前是 Weex 实现的，本次只做简单 UI 增删或字段调整，也是会修改一下。初次之外不修改 Weex 代码</li>
</ul>
<p>所以像 Native 一样去全面监控性能、网络、crash、异常、白屏、页面加载耗时等维度的话，ROI 是很低的。那么就需要制定一些策略去有针对性的监控高优问题。</p>
<p>Weex 的异常比较有特点，比如在页面的模版代码中绑定了 data 中的一个对象，此时对象可能并没有值，而是依赖后续的网络请求完成，对象才有了具体的值 data 改变，数据驱动，页面再次 render。所以监控代码会认为第一次 render 的时候访问对象不存在的属性。
真正有问题的代码和不影响业务的异常信息，都会被 Vue 官方认为是异常。基于这样的背景，我们无法 pick 出真正异常或者是开发者判空代码没写好的问题。基于此，我们需要做一些约定和标准。</p>
<h3 data-id="heading-66">2. 优先级权衡标准</h3>
<p>这时候就需要摒弃程序员视角（不然会陷入啥数据都想统计，可能是洁癖、可能是追求），但从 ROI 角度出发，我们就需要切换到用户视角。</p>
<p>假设你是一个用户，什么样的情况代表业务异常，对我们的用户来说比较痛呢？</p>
<ul>
<li>页面白屏了，看都看不到了，别说你们的 App 为我赋能解决用户痛点了</li>
<li>稍微好点，可以看到页面了，但是某一个区域是白屏的。比如：该页面大部分在展示商品价格、商品数量、商品折扣价、商品折扣信息、下面应该是有个“确认支付”按钮，但是此处就是空白，点也点不了。</li>
<li>情况再好点。可以看到全部的页面了，但是点击后无响应。比如：该页面大部分在展示商品价格、商品数量、商品折扣价、商品折扣信息、下面有个“确认支付”按钮。用户在考虑再三，本着理性购物后，发现是刚需品，咬紧牙要付款了，此时点击“确认支付”按钮了，但是页面没有任何反应。用户也是“见多识广”的体面人，猜测可能是网络不好的情况，所以等了1分钟，他很有耐心。切换了 WI-FI 到 5G 后，继续点击，依旧没反应。一怒之下点了10次，等了2分钟，还是没反应。他奔溃了，卸载了 App</li>
</ul>
<p>上述几种情况，总结为：按照异常等级，可以划分为影响业务和不影响业务。什么叫“影响业务”？这是我们自己定义的标准，影响用户是否正常操作 App。比如：页面白屏（页面全部白屏、页面部分白屏）、点击某个按钮无响应，这些叫做“影响业务”，属于 Error 级别。其他的一些轻微异常，不影响用户使用 App 功能，不影响业务，属于 Warning 级别。</p>
<h3 data-id="heading-67">3. UI 显示异常</h3>
<h4 data-id="heading-68">1. 部分白屏：注册的 Component 使用异常</h4>
<p>这种情况就属于页面部分白屏。因为某个哪个 Compoent 会铺满页面，基本类似 iOS UI 控件一样组合使用。就像上文描述的「该页面大部分在展示商品价格、商品数量、商品折扣价、商品折扣信息、下面应该是有个“确认支付”按钮，但是此处就是空白」这个空白粗，理应显示一个 Native 注册的 Button，但是没有显示出来，造成业务的阻塞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a551c125b89945c492daac9ae8f28310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=OD34iKcnKNSl9Au61CaChYwUsvs%3D" alt="WeexComponentRegisterError.png" loading="lazy"/>
.vue（或 Weex 专属.we）文件内基于 Vue 扩展的 Weex 跨平台模板 DSL 代码，在前端构建阶段会先由 Webpack 的weex-loader触发编译流程：首先通过 Weex 核心编译器@weex-cli/compiler（复用并扩展vue-template-compiler）将模板 DSL 解析为模板 AST（抽象语法树）；接着由 Weex 自定义 Babel 插件（如babel-plugin-transform-weex-template）将模板 AST 转换为标准化的 JS AST，并针对 iOS/Android 跨平台特性做属性、样式、事件的适配处理（如样式单位归一化、事件名标准化）；最终生成包含_h（即 Weex 运行时的$createElement，等价于 Vue 的createElement）调用的render函数，该函数会被 Webpack 打包到最终的 Weex JS Bundle 中。</p>
<pre><code class="hljs language-json" lang="json">_c('color-button'<span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    staticStyle<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      width<span class="hljs-punctuation">:</span> <span class="hljs-string">"400px"</span><span class="hljs-punctuation">,</span>
      height<span class="hljs-punctuation">:</span> <span class="hljs-string">"40px"</span><span class="hljs-punctuation">,</span>
      marginBottom<span class="hljs-punctuation">:</span> <span class="hljs-string">"20px"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    attrs<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"点击计算10+20"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"bgColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FF6600"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hello"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    on<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"click"</span><span class="hljs-punctuation">:</span> _vm.handleButtonClick
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-comment">// 如果有 children 就是 children 信息</span>
)
</code></pre>
<p>在 App 运行阶段，Weex 的 JS 引擎（iOS 端为 JSCore、Android 端为 V8）加载 JS Bundle 后，执行组件的render函数，通过调用 <code>_h</code> 函数将模板描述转换为跨平台的虚拟 DOM（VNode），VNode 会被序列化为 JSON 格式，最终通过 JS Bridge 传递给 Native 端（iOS/Android）用于原生视图渲染。</p>
<p>Weex 的 Component 相关逻辑都由 <code>WXComponentManager</code> 负责。页面在构建展示的时候，会调用 <code>_buildComponent</code> 方法，其内部会调用 WXComponentFactory 的能力（<code>configWithComponentName</code>），根据 ComponentName 获取 Component。</p>
<p><code>configWithComponentName</code> 是 Weex iOS 侧 WXComponentFactory（组件工厂类）的核心方法之一，核心作用是：根据传入的组件名称（如 color-button/div/text），查找该组件对应的 Native 侧配置（WXComponentConfig）；若找不到对应配置，则降级使用基础容器组件 div 的默认配置，并输出警告日志。</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">- (WXComponentConfig *)configWithComponentName:(NSString *)name
{
    WXAssert(name, @"Can not find config for a nil component name");
    
    WXComponentConfig *config = nil;
    
    [_configLock lock];
    config = [_componentConfigs objectForKey:name];
    if (!config) {
        WXLogWarning(@"No component config for name:%@, use default config", name);
        config = [_componentConfigs objectForKey:@"div"];
    }
    [_configLock unlock];
    
    return config;
}
</code></pre>
<p>UI Component 做的比较随意，认为显示问题降级用 div 就可以了。做为 SDK 这么设计也似乎可以接受，但作为业务方，我们必须收集统计这种异常情况。
所以此处我们可以收集案发现场数据，进行上报。我们发现 Weex 自己封装了 <code>WXExceptionUtils</code>类，暴露了 <code>commitCriticalExceptionRT</code> 接口，用于收集致命问题。</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">+ (void)commitCriticalExceptionRT:(WXJSExceptionInfo *)jsExceptionInfo{
    
    WXPerformBlockOnComponentThread(^ {
        id&lt;WXJSExceptionProtocol&gt; jsExceptionHandler = [WXHandlerFactory handlerForProtocol:@protocol(WXJSExceptionProtocol)];
        if ([jsExceptionHandler respondsToSelector:@selector(onJSException:)]) {
            [jsExceptionHandler onJSException:jsExceptionInfo];
        }
        if ([WXAnalyzerCenter isOpen]) {
            [WXAnalyzerCenter transErrorInfo:jsExceptionInfo];
        }
    });
}
</code></pre>
<p>可以看到会判断是否存在可以处理 exception 遵循 WXJSExceptionProtocol 的 handler。所以我们新增一个 <code>WXExceptionReporter</code> 类（遵循 WXJSExceptionProtocol 协议），用于收集异常，然后用于统一的上报，内部提供基础数据的组装、字段解析功能。</p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9fc6690769433e8cefadb6cfb52f17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=D%2FyuvCXgWZug8Q8IzvqDBppj2dg%3D" alt="WeexComponentBuildFlow.png" loading="lazy"/></p>
<h4 data-id="heading-69">2. 全部白屏</h4>
<p>根据 Weex 的工作原理可以知道，页面需要展示肯定要根据 url 去获取 JS Bundle 内容，然后解析成 VNode 最后通过 JSBridge 去调用 Native 的 UI Component 去展示 UI，那么整个流程几个重要的环节都可能出错，导致页面白屏。</p>
<h5 data-id="heading-70">1. 资源请求失败</h5>
<p>JS Bundle 资源请求失败，存在 Error，此时是无法去展示 Weex 页面的。这种情况就是 HTTP 状态码非200的情况。</p>
<p>每个 Weex 页面都由 WXSDKInstance 负责下载 JS Bundle 资源，所以下载的逻辑在 WXSDKInstance 里。</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">- (void)_renderWithRequest:(WXResourceRequest *)request options:(NSDictionary *)options data:(id)data; 
{
  _mainBundleLoader.onFinished = ^(WXResourceResponse *response, NSData *data) {

      NSError *error = nil;
      if ([response isKindOfClass:[NSHTTPURLResponse class]] &amp;&amp; ((NSHTTPURLResponse *)response).statusCode != 200) {
          error = [NSError errorWithDomain:WX_ERROR_DOMAIN
                                      code:((NSHTTPURLResponse *)response).statusCode
                                  userInfo:@{@"message":@"status code error."}];
          if (strongSelf.onFailed) {
              strongSelf.onFailed(error);
          }
      }
      
      if (error) {
          [WXExceptionUtils commitCriticalExceptionRT:strongSelf.instanceId
                                              errCode:[NSString stringWithFormat:@"%d", WX_KEY_EXCEPTION_JS_DOWNLOAD]
                                              function:@"_renderWithRequest:options:data:"
                                            exception:[NSString stringWithFormat:@"download bundle error :%@",[error localizedDescription]]
                                            extParams:nil];
          return;
      }

      if (!data) {
          NSString *errorMessage = [NSString stringWithFormat:@"Request to %@ With no data return", request.URL];
          WX_MONITOR_FAIL_ON_PAGE(WXMTJSDownload, WX_ERR_JSBUNDLE_DOWNLOAD, errorMessage, strongSelf.pageName);
          [WXExceptionUtils commitCriticalExceptionRT:strongSelf.instanceId
                                              errCode:[NSString stringWithFormat:@"%d", WX_KEY_EXCEPTION_JS_DOWNLOAD]
                                              function:@"_renderWithRequest:options:data:"
                                            exception:errorMessage
                                            extParams:nil];
          return;
      }
  };
}
</code></pre>
<p>模拟 JS Bundle 下载错误，效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8127cf21938140c0ae40a15a9a5a26b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=r0g86JWgUX33NF7lfv3iwvOb%2B7E%3D" alt="WeexJSBundleDownloadFailed.png" loading="lazy"/></p>
<p>下载 JS Bundle 网络请求完成后，如果出现 Error，则会调用 WXExceptionUtils 的能力，将异常交给 <code>WXExceptionReporter</code> 去处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f045d0177a8483b857901ad7520f993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=RuNioiYspuc%2FThdWHk3%2BOyOUpZE%3D" alt="WeexJSBundleDownloadFailedAPM.png" loading="lazy"/></p>
<h5 data-id="heading-71">2. 资源请求成功，数据为空</h5>
<p>还有一种情况就是：**JSBundle 下载请求在 HTTP 层面 “成功完成”（状态码 200），但返回的二进制数据 data 为 nil 或空（长度为 0） **</p>
<p>可能你会好奇，怎么可能有空的 JSBundle，什么场景下会产生这种情况？
凡是正常写代码都符合预期就没有任何 bug 和故障了，所以利用悲观策略，将各种可能出现问题的地方都监控到，因为只要 JSBundle 为空，页面肯定是白屏，对于用户侧来说都是致命的。</p>
<ol>
<li>服务器/CDN 返回“空响应”：后端 / CDN 配置异常：请求的 JSBundle URL 有效，HTTP 状态码返回 200，但响应体（Body）为空（比如静态 JS 文件被删除、CDN 缓存失效且源站无数据、后端接口逻辑错误未写入响应内容）；</li>
<li>下载过程中数据传输截断 / 丢失</li>
</ol>
<ul>
<li>网络波动：下载请求已收到服务器的 “响应完成” 信号，但数据传输过程中因网络中断、超时等导致 NSData 未完整接收（仅 HTTP 头成功接收，体数据为空）；</li>
<li>Weex 加载器（mainBundleLoader）异常：加载器在将响应数据转为 NSData 时出现底层错误（如内存不足、数据解码失败），导致 data 被置为 nil。</li>
</ul>
<p>Mock：将 data 设为 nil。效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7346ccdc0574cba97a9bd195bebbbd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=3QAb3CTSFZfYP99pqlhWGR3V7mI%3D" alt="WeexJSBundleParseFailed.png" loading="lazy"/></p>
<p>可以看到 Weex 也会把这种错误进行收集，调用 <code>WXExceptionUtils commitCriticalExceptionRT</code>，所以我们添加的 Analyzer 是可以监控到这种异常的。
效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03d2c52a165c4844a7a264724a02f71a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=dZM6FItKQRExX0qKh0VNp53gcl0%3D" alt="WeexJSBundleParseErrorAPM.png" loading="lazy"/></p>
<h5 data-id="heading-72">3. 资源请求成功，数据无法解析</h5>
<p>还有一种特殊的情况就是：<strong>下载的 JSBundle 二进制数据虽非空，但因无法以 UTF-8 编码解码为字符串，导致 Weex 实例无法加载执行该数据，最终页面 UI 无法正常展示</strong>。比如下面的情况：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6fdbef3fa6549fea8ba93b5ab23f467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=QQ5sLB64xvhg92mNApfF6SljymI%3D" alt="WeexJSbundleEncodingError.png" loading="lazy"/></p>
<p>和上面的情况类似，这种都属于概率较小的问题，但也要监控和预防。</p>
<p>一些可能的情况：</p>
<ol>
<li>JSBundle 文件编码非 UTF-8。 <strong>Weex 要求：JS Bundle 文件必须采用 UTF-8 编码（无 BOM）以保证跨平台兼容性，非 UTF-8 编码（如 GBK、UTF-16）可能导致 iOS/Android 平台解析失败</strong></li>
<li>数据损坏/包含非法 UTF-8 字节</li>
</ol>
<ul>
<li>下载截断：UTF-8 是「多字节编码」（比如中文占 3 字节），若下载过程中数据末尾的字符字节不完整（如只下了 2 字节），解码时会因 “字节序列不合法” 失败；</li>
<li>数据篡改：CDN / 网关 / 代理在传输中混入非 UTF-8 字节（如 0xFF、0xFE、0x00 等无效字节），破坏编码结构；</li>
<li>文件损坏：JSBundle 文件打包 / 上传时出错（如压缩后未正确解压），包含乱码 / 二进制碎片</li>
</ul>
<ol start="3">
<li>请求到非文本数据（URL 错误）。请求的 JS Bundle 返回的不是 JS 文本，而是二进制：</li>
</ol>
<ul>
<li>URL 配置错误：指向图片（png/jpg）、压缩包（zip）、二进制协议数据（如 protobuf）、可执行文件等</li>
<li>后端接口错误：原本应返回 JS 文本的接口，异常时返回二进制格式的错误信息（而非文本错误）</li>
<li>缓存污染：Weex 本地缓存的 JSBundle 被其他二进制文件覆盖（如缓存路径冲突）</li>
</ul>
<ol start="4">
<li>特殊字符/编码溢出</li>
</ol>
<ul>
<li>JSBundle 中包含 UTF-8 无法表示的「无效 Unicode 码点」（如超出 U+10FFFF 范围，或保留的未定义码点）</li>
<li>数据量过大：极大型 JSBundle 解码时因内存不足 / 系统限制，导致解码接口返回 nil（iOS 中 NSString 对单字符串长度有隐性限制）</li>
</ul>
<p>这种情况，Weex 官方是怎么做的？</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">NSString *jsBundleString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
if (!jsBundleString) {
    WX_MONITOR_FAIL_ON_PAGE(WXMTJSDownload, WX_ERR_JSBUNDLE_STRING_CONVERT, @"data converting to string failed.", strongSelf.pageName)
    [strongSelf.apmInstance setProperty:KEY_PROPERTIES_ERROR_CODE withValue:[@(WX_ERR_JSBUNDLE_STRING_CONVERT) stringValue]];
    return;
}
</code></pre>
<p>可以看到，这种情况没有被 Weex 没有视为“致命问题”进行上报。只是进行了简单打印。尝试站在框架角度想问题，从 SDK Owner 角度归因：</p>
<ul>
<li>HTTP 状态码错误/无数据：Weex 认为这类错误是「外部不可控故障」（网络、CDN、服务端宕机），会影响大批量实例，属于 “框架级致命异常”，必须通过 WXExceptionUtils 上报（触发全局异常统计、告警）</li>
<li>编码转换失败：可能是分批多次打包，前几次都是 UTF-8 格式，只是这次编码错误，是可以定位的。Weex 认为这类错误是「内部可控问题」（前端打包时未按 UTF-8 规范输出、URL 配置错误指向二进制文件），属于 “业务侧错误”，框架只需记录监控（提醒开发者修复），无需升级为 “框架级致命异常”。</li>
</ul>
<p>但从业务方角度出发，不光页面是 Weex、Native、Flutter、H5，只要是影响了用户体验，都属于致命问题，尤其这种整个页面都是白屏的情况。所以我们需要修改源码，去上报致命异常。调用 <code>WXExceptionUtils commitCriticalExceptionRT</code> 的能力。</p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2154e2845b9049a0be6451bfb74e380e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=3BwQrPAEiMiQArQhfy%2FCp2TsDg0%3D" alt="WeexJSBundleEncodingAPM.png" loading="lazy"/></p>
<h3 data-id="heading-73">4. 逻辑异常</h3>
<h4 data-id="heading-74">1. JS 侧 require Module 失败</h4>
<p>在 Native <code>[WXSDKEngine registerModule:@"logicCalculation" withClass:[WXLogicCalculationModule class]]</code> 正常注册的 Module，名字叫 <code>logicCalculation</code>。在 js 侧使用的时候不小心写成 <code>const logicCalculation = weex.requireModule('logicCalculation1')</code>，测试又没回归到，问题逃逸到线上，可能就是逻辑问题。Weex 官方的做法就是在 Xcode 打印 log。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cb98cbb5e049c3acc196b1c116b623~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=l7HXLokeuQyH909ZpVlNHoO1GiM%3D" alt="WeexModuleRequireError.png" loading="lazy"/></p>
<p>所以作为 APM 侧，我们要定位和收集到该问题，进行问题上报。</p>
<p>想办法知道哪里报错，requireModule 不是原生写法，这肯定是 JS 侧封装的，查看 Weex 源码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c8b35c5beb4958b0d1c0af4513e905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=GNJIzZRV5ymObWuqAm1zU15ZEuM%3D" alt="WeexRequireModuleError.png" loading="lazy"/></p>
<pre><code class="hljs language-JS" lang="JS"><span class="hljs-comment">// Weex JS Framework 核心源码（简化）</span>
<span class="hljs-title class_">WeexInstance</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">requireModule</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">requireModule</span>(<span class="hljs-params">moduleName</span>) {
  <span class="hljs-comment">// 1. 基础校验：Weex实例是否有效（比如是否已销毁）</span>
  <span class="hljs-keyword">var</span> id = <span class="hljs-title function_">getId</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 获取当前Weex实例ID</span>
  <span class="hljs-keyword">if</span> (!(id &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-property">taskCenter</span>)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"[JS Framework] Failed to requireModule(\""</span> + moduleName + <span class="hljs-string">"\"), instance doesn't exist."</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 关键校验：检查Module是否在Native侧注册过</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isRegisteredModule</span>(moduleName)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"[JS Framework] using unregistered weex module \""</span> + moduleName + <span class="hljs-string">"\""</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 3. 核心：创建Module代理对象（并非真实对象，仅封装桥接调用）</span>
  <span class="hljs-keyword">var</span> moduleProxy = {};
  <span class="hljs-comment">// 获取该Module在Native侧注册的所有方法（提前从Native同步到JS的方法映射表）</span>
  <span class="hljs-keyword">var</span> moduleMethods = <span class="hljs-title function_">getRegisteredMethods</span>(moduleName);
  
  <span class="hljs-comment">// 4. 为代理对象绑定方法：调用方法时触发JS-Native桥接</span>
  moduleMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">methodName</span>) {
    moduleProxy[methodName] = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 封装调用参数：实例ID、Module名、方法名、参数、回调</span>
      <span class="hljs-keyword">var</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
      <span class="hljs-keyword">var</span> callback = <span class="hljs-literal">null</span>;
      <span class="hljs-comment">// 提取最后一个参数作为回调（Weex约定）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> args[args.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] === <span class="hljs-string">'function'</span>) {
        callback = args.<span class="hljs-title function_">pop</span>();
      }
      
      <span class="hljs-comment">// 5. 核心：通过taskCenter（桥接核心）调用Native</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-property">taskCenter</span>.<span class="hljs-title function_">sendNative</span>(<span class="hljs-string">'callNative'</span>, {
        <span class="hljs-attr">instanceId</span>: id,
        <span class="hljs-attr">module</span>: moduleName,
        <span class="hljs-attr">method</span>: methodName,
        <span class="hljs-attr">params</span>: args,
        <span class="hljs-attr">callback</span>: callback ? <span class="hljs-title function_">generateCallbackId</span>(callback) : <span class="hljs-literal">null</span>
      });
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
  }, <span class="hljs-variable language_">this</span>);

  <span class="hljs-comment">// 6. 返回代理对象给JS侧使用</span>
  <span class="hljs-keyword">return</span> moduleProxy;
};
</code></pre>
<ul>
<li>返回的不是真实的 Module 实例，而是代理对象（Proxy） —— 所有方法调用都会被拦截，转而通过桥接发送到 Native；</li>
<li>isRegisteredModule 校验：JS 侧会缓存一份「Native 已注册 Module 列表」（Native 初始化时同步到 JS），避免无效桥接。</li>
</ul>
<p>方案一：Weex 由于安全设计，没办法直接注入 JS。也就是说想通过“切面”思想，hook JS 侧 requireModule 是行不通的。这种方案，代码如下</p>
<pre><code class="hljs language-JS" lang="JS"><span class="hljs-comment">// 备份原生requireModule方法</span>
<span class="hljs-keyword">const</span> originalRequireModule = <span class="hljs-title class_">WeexInstance</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">requireModule</span>;

<span class="hljs-comment">// 重写requireModule，在错误触发时主动上报Native</span>
<span class="hljs-title class_">WeexInstance</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">requireModule</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">moduleName</span>) {
  <span class="hljs-comment">// 先执行原生判断逻辑</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-title function_">getId</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">if</span> (!(id &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-property">taskCenter</span>)) {
    <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-string">"[JS Framework] Failed to requireModule(\""</span> + moduleName + <span class="hljs-string">"\"), instance ("</span> + id + <span class="hljs-string">") doesn't exist anymore."</span>;
    <span class="hljs-comment">// 主动上报“实例不存在”错误到Native</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-property">taskCenter</span>.<span class="hljs-title function_">sendNative</span>(<span class="hljs-string">'__weex_apm_report'</span>, {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'module_require_failed'</span>,
      <span class="hljs-attr">subType</span>: <span class="hljs-string">'instance_not_exist'</span>,
      <span class="hljs-attr">moduleName</span>: moduleName,
      <span class="hljs-attr">message</span>: errorMsg,
      <span class="hljs-attr">instanceId</span>: id
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(errorMsg);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 核心：拦截“未注册Module”判断</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isRegisteredModule</span>(moduleName)) {
    <span class="hljs-keyword">const</span> warnMsg = <span class="hljs-string">"[JS Framework] using unregistered weex module \""</span> + moduleName + <span class="hljs-string">"\""</span>;
    <span class="hljs-comment">// 主动上报“Module未注册”错误到Native（关键）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">document</span>.<span class="hljs-property">taskCenter</span>.<span class="hljs-title function_">sendNative</span>(<span class="hljs-string">'__weex_apm_report'</span>, {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'module_not_registered'</span>,
      <span class="hljs-attr">moduleName</span>: moduleName,
      <span class="hljs-attr">message</span>: warnMsg,
      <span class="hljs-attr">instanceId</span>: id,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    });
    <span class="hljs-comment">// 保留原生warn日志（不影响原有逻辑）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(warnMsg);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 执行原生逻辑</span>
  <span class="hljs-keyword">return</span> originalRequireModule.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, moduleName);
};
</code></pre>
<p>方案二：Native 侧拦截 JS 的 console.warn 调用（无 JS 侵入）</p>
<p>写法1：Weex JS 侧的 <code>console.warn</code> 最终会通过 WXBridgeContext 的 <code>handleJSLog</code> 方法传递到 Native，无需解析最终日志，直接 Hook 该方法拦截 warn 信息，精准匹配 Module 未注册错误</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">#import &lt;objc/runtime.h&gt;

@implementation NSObject (WXJSLogHook)
+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&amp;onceToken, ^{
        // 获取WXBridgeContext类（无需头文件）
        Class bridgeContextClass = NSClassFromString(@"WXBridgeContext");
        if (!bridgeContextClass) return;
        
        // Hook处理JS日志的核心方法：handleJSLog:
        SEL handleJSLogSel = NSSelectorFromString(@"handleJSLog:");
        Method originalMethod = class_getInstanceMethod(bridgeContextClass, handleJSLogSel);
        if (!originalMethod) return;
        
        SEL swizzledSel = NSSelectorFromString(@"weex_apm_handleJSLog:");
        Method swizzledMethod = class_getInstanceMethod(self, swizzledSel);
        class_addMethod(bridgeContextClass, swizzledSel, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));
        method_exchangeImplementations(originalMethod, swizzledMethod);
    });
}

// Hook后的handleJSLog方法：拦截JS侧的warn日志
- (void)weex_apm_handleJSLog:(NSDictionary *)logInfo {
    // 1. 先执行原方法，保留原有日志输出逻辑
    [self weex_apm_handleJSLog:logInfo];
    
    // 2. 解析JS日志信息（logInfo格式：{level: 'warn', msg: 'xxx', ...}）
    NSString *logLevel = logInfo[@"level"];
    NSString *logMsg = logInfo[@"msg"];
    
    // 3. 精准匹配“未注册Module”的warn
    if ([logLevel isEqualToString:@"warn"] &amp;&amp; [logMsg containsString:@"using unregistered weex module"]) {
        // 提取Module名称
        NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:@"using unregistered weex module \"(.*?)\"" options:0 error:nil];
        NSTextCheckingResult *match = [regex firstMatchInString:logMsg options:0 range:NSMakeRange(0, logMsg.length)];
        NSString *moduleName = match ? [logMsg substringWithRange:match.rangeAtIndex(1)] : @"";
        
        // 4. 构造APM数据上报
        NSDictionary *apmData = @{
            @"error_type": @"weex_module_not_registered",
            @"module_name": moduleName,
            @"message": logMsg,
            @"source": @"js_console_warn", // 标记来源：JS console.warn
            @"timestamp": @([[NSDate date] timeIntervalSince1970] * 1000)
        };
        
        // 调用 APM SDK 接口，数据先落库，后续统一按照数据上报策略，从本地 DB 捞取、聚合、上报
        // [YourAPMManager reportWeexError:apmData];
    }
}
@end
</code></pre>
<p>核心优势</p>
<ul>
<li>无侵入：无需修改 / 注入 JS 代码，纯 Native 侧实现；</li>
<li>精准：拦截的是 JS 侧传递到 Native 的原始日志数据（而非最终打印的字符串），无格式误差；</li>
<li>覆盖全：所有 JS 侧的console.warn都会经过此方法，100% 覆盖 Module 未注册场景</li>
</ul>
<p>写法二：由于 Weex 代码是大量的存量业务代码，很稳定。而且 Weex 官方好几年不更新，所以我们内部私有化 Weex SDK，也就没有采取 Hook 手段。而是直接修改源码，<code>WXBridgeContext.m</code> 的 <code>+ (void)handleConsoleOutputWithArgument:(NSArray *)arguments logLevel:(WXLogFlag)logLevel</code> 方法。比如：</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">+ (void)handleConsoleOutputWithArgument:(NSArray *)arguments logLevel:(WXLogFlag)logLevel
{
    NSMutableString *string = [NSMutableString string];
    [string appendString:@"jsLog: "];
    [arguments enumerateObjectsUsingBlock:^(JSValue *jsVal, NSUInteger idx, BOOL *stop) {
        [string appendFormat:@"%@ ", jsVal];
        if (idx == arguments.count - 1) {
            if (logLevel) {
                if (WXLogFlagWarning == logLevel || WXLogFlagError == logLevel) {
                    if ([string containsString:@"using unregistered weex module"]) {
                        // 提取Module名称
                        NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:@"using unregistered weex module \"(.*?)\"" options:0 error:nil];
                        NSTextCheckingResult *match = [regex firstMatchInString:string options:0 range:NSMakeRange(0, string.length)];
                        NSString *moduleName = match ? [string substringWithRange:[match rangeAtIndex:1]] : @"";
                        
                        // 接入收口工具类
                        NSString *exceptionMsg = [NSString stringWithFormat:@"JS require未注册模块：%@，原始日志：%@", moduleName, string];
                        NSDictionary *customExt = @{@"moduleName": moduleName};
                        NSString *instanceId = [WXSDKEngine topInstance].instanceId ?: @"";
                        NSString *bundleUrl = [WXSDKEngine topInstance].scriptURL.absoluteString ?: @"";
                        [[WXExceptionReporter sharedInstance] reportExceptionWithCode:WXCustomExceptionCode_Module_NotRegistered
                                                                        exceptionType:WXCustomExceptionType_Module
                                                                            instanceId:instanceId
                                                                             function:@"handleConsoleOutputWithArgument:logLevel:"
                                                                         exceptionMsg:exceptionMsg
                                                                            bundleUrl:bundleUrl
                                                                         customExtParams:customExt];
                    }
                    
                    id&lt;WXAppMonitorProtocol&gt; appMonitorHandler = [WXSDKEngine handlerForProtocol:@protocol(WXAppMonitorProtocol)];
                    if ([appMonitorHandler respondsToSelector:@selector(commitAppMonitorAlarm:monitorPoint:success:errorCode:errorMsg:arg:)]) {
                        [appMonitorHandler commitAppMonitorAlarm:@"weex" monitorPoint:@"jswarning" success:NO errorCode:@"99999" errorMsg:string arg:[WXSDKEngine topInstance].pageName];
                    }
                }
                WX_LOG(logLevel, @"%@", string);
            } else {
                [string appendFormat:@"%@ ", jsVal];
                WXLogInfo(@"%@", string);
            }
        }
    }];
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feaa4cd760594fb0bf97f43cff8d8778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=CzPMJNi1rHB2uiQkqsrjsWjl49M%3D" alt="WeexRequireModuleErrorAPM.png" loading="lazy"/></p>
<h4 data-id="heading-75">2. JS 调用 Moudle 方法失败</h4>
<p>Native 注册了一个负责逻辑的 Module，但是在 JS 侧使用的时候，要么方法名写错了，要么参数少传了，都可能导致预期的逻辑执行错误，发生不符合预期的行为。</p>
<h5 data-id="heading-76">1. 点击事件工作原理</h5>
<p>核心问题：点击事件发生时，如何根据 Component 的点击事件定位到该 Component 在 Vue DSL 中声明的事件？</p>
<p>第一步：页面初始化时，JS 侧构建<strong>事件映射表</strong>。
Weex 页面渲染时，会为每个组件做2件事情：</p>
<ul>
<li>生成组件唯一标识：每个组件都有 <code>ref/componentId/docId</code>，类似组件身份证</li>
<li>绑定事件与方法：解析 <code>@click="handleButtonClick"</code> 时，JS 会将「组件 ID + 事件类型（click）」作为 key，<code>handleButtonClick</code> 作为 value，一起存进组件实例的映射表里，（对应下面的 <code>this.event[type]</code>）</li>
</ul>
<p>第二步：Native 侧捕获点击，携带关键信息调用 fireEvent。
Native 侧能拿到 componentId，是因为渲染组件时，JS 侧会把组件 ID 同步给 Native 渲染引擎（WXComponent），Native 控件和 JS 组件实例通过 ID 一一绑定</p>
<p>第三步：JS 侧调用 <code>fireEvent</code> 方法，其内部通过 <code>ID + 事件类型</code> 找方法。</p>
<ul>
<li>定位组件实例：JS 通过 componentID（代码里的 this.ref）找到组件实例。</li>
<li>查找事件映射：从组件实例的 <code>this.event</code> 里根据 type （如 click）找到具体的 eventDesc（包含具体的 handler）</li>
<li>发起调用 <code>handler.call</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
   * Fire an event manually.
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} type type
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">function</span>} event handler
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} isBubble whether or not event bubble
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">options</span>
   * <span class="hljs-doctag">@return</span> {<span class="hljs-type"/>} anything returned by handler function
   */</span>
  <span class="hljs-title class_">Element</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">fireEvent</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">fireEvent</span> (type, event, isBubble, options) {
    <span class="hljs-keyword">var</span> result = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> isStopPropagation = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">var</span> eventDesc = <span class="hljs-variable language_">this</span>.<span class="hljs-property">event</span>[type];
    <span class="hljs-keyword">if</span> (eventDesc &amp;&amp; event) {
      <span class="hljs-keyword">var</span> handler = eventDesc.<span class="hljs-property">handler</span>;
      event.<span class="hljs-property">stopPropagation</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        isStopPropagation = <span class="hljs-literal">true</span>;
      };
      <span class="hljs-keyword">if</span> (options &amp;&amp; options.<span class="hljs-property">params</span>) {
        result = handler.<span class="hljs-property">call</span>.<span class="hljs-title function_">apply</span>(handler, [ <span class="hljs-variable language_">this</span> ].<span class="hljs-title function_">concat</span>( options.<span class="hljs-property">params</span>, [event] ));
      }
      <span class="hljs-keyword">else</span> {
        result = handler.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, event);
      }
    }

    <span class="hljs-keyword">if</span> (!isStopPropagation
      &amp;&amp; isBubble
      &amp;&amp; (<span class="hljs-variable constant_">BUBBLE_EVENTS</span>.<span class="hljs-title function_">indexOf</span>(type) !== -<span class="hljs-number">1</span>)
      &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>
      &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-property">fireEvent</span>) {
      event.<span class="hljs-property">currentTarget</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentNode</span>.<span class="hljs-title function_">fireEvent</span>(type, event, isBubble); <span class="hljs-comment">// no options</span>
    }

    <span class="hljs-keyword">return</span> result
  };
</code></pre>
<h5 data-id="heading-77">2. JS 调用 module 方法，方法名错误</h5>
<p>Native 注册的 Module 方法名为 <code>multiply:num2:callback:</code>，而在 JS 侧调用的时候方法名多加了几个字符，造成方法名对不上，方法调用失败的问题。</p>
<p>用户点击屏幕上的 UI 控件（此处就是注册 Component <code>[WXSDKEngine registerComponent:@"color-button" withClass:[WXColorButtonComponent class]]</code>)。</p>
<p>Weex 统一给 Comonent 添加了分类来负责事件的处理。<code>WXComponent+Events</code>。源码中 <code>addClickEvent</code> 就是添加了点击事件的监听。当发生点击后会计算点击事件的坐标和时间戳信息，最后封装一个 <code>WXCallJSMethod</code> 对象，方法名固定为 <code>fireEvent</code>。如下堆栈所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aa523b5d1a047e690cd3e0d5e178dbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=WvFysSIJKSbgGF6gOWhsRXSiMLk%3D" alt="WeexComponentClickLogic.png" loading="lazy"/></p>
<p>由于 <code>logicCalculation</code> 没有对应的 <code>multiplyWith</code> 方法，所以会报错，被 JS 的 <code>try...catch...</code> 捕获后，通过 <code>console.error</code> 的方式输出异常信息。但是 <code>console.error</code> 被 Native 接管了。所以我们可以在 Native 接管的地方统一拦截处理。只要日志包含 <code>Failed to invoke the event handler</code> 就可以认为是因为方法名问题，导致调用方法出错</p>
<p>代码如下：</p>
<pre><code class="hljs language-Objective-c" lang="Objective-c">+ (void)handleConsoleOutputWithArgument:(NSArray *)arguments logLevel:(WXLogFlag)logLevel
{
    // ...
    if ([string containsString:@"Failed to invoke the event handler"]) {
        // 原有解析逻辑保留
                        NSString *errorMethodName = @"";
                        NSString *eventType = @"";
                        NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:@"'\\.\\.\\.(?:logicCalculation\\.)([a-zA-Z0-9_]+)\\.\\.\\." options:0 error:nil];
                        NSTextCheckingResult *match = [regex firstMatchInString:string options:0 range:NSMakeRange(0, string.length)];
                        if (match) {
                            errorMethodName = [string substringWithRange:[match rangeAtIndex:1]];
                        }
                        NSRegularExpression *eventRegex = [NSRegularExpression regularExpressionWithPattern:@"event handler of \"([^\"]+)\"" options:0 error:nil];
                        NSTextCheckingResult *eventMatch = [eventRegex firstMatchInString:string options:0 range:NSMakeRange(0, string.length)];
                        if (eventMatch) {
                            eventType = [string substringWithRange:[eventMatch rangeAtIndex:1]];
                        }
                        
                        // 接入收口工具类
                        NSString *exceptionMsg = [NSString stringWithFormat:@"Module方法名错误：%@，事件类型：%@，原始日志：%@", errorMethodName, eventType, string];
                        NSDictionary *customExt = @{
                            @"moduleName": @"logicCalculation",
                            @"methodName": errorMethodName,
                            @"eventType": eventType
                        };
                        NSString *instanceId = [WXSDKEngine topInstance].instanceId ?: @"";
                        NSString *bundleUrl = [WXSDKEngine topInstance].scriptURL.absoluteString ?: @"";
                        [[WXExceptionReporter sharedInstance] reportExceptionWithCode:WXCustomExceptionCode_Module_MethodNotFound
                                                                         exceptionType:WXCustomExceptionType_Module
                                                                            instanceId:instanceId
                                                                              function:@"handleConsoleOutputWithArgument:logLevel:"
                                                                         exceptionMsg:exceptionMsg
                                                                             bundleUrl:bundleUrl
                                                                         customExtParams:customExt];
    }
    // ...
}
</code></pre>
<p>效果如下</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caecf4541d1646cfadc4fb59dd7abf93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=MZypkqirSmTiJApbXBRu7j6mUvM%3D" alt="WeexCallModuleMethodNameMismatch.png" loading="lazy"/></p>
<h5 data-id="heading-78">3. JS 调用 module 方法，方法参数个数不匹配</h5>
<p>上面已经讲了点击事件的工作流程，调用方法时，除了调用了不存在的方法或者方法名写错了，还有一种情况就是参数个数不匹配。</p>
<p>这种情况如何识别并监控？
JS 的事件处理函数里，调用注册的 Module 和对应的方法，会统一走到 <code>WXJSCoreBridge.mm</code> 的 <code>- (void)registerCallNativeModule:(WXJSCallNativeModule)callNativeModuleBlock</code> 给当前的 JSContext 注册好的 <code>callNativeModule</code> 回调里。<code>_jsContext[@"callNativeModule"] = ^JSValue *(JSValue *instanceId, JSValue *moduleName, JSValue *methodName, JSValue *args, JSValue *options)</code> 可以拿到模块名、方法名、参数个数、instanceID 等。拿到实际传递的方法参数列表，再通过模块名根据 <code>ModuleFactory</code> 找到模块类对象，然后利用 runtime 能力，遍历类对象的方法列表，找到对应的 SEL，判断其预期的方法参数个数，然后再和实际传递过来的方法参数个数做比较即可</p>
<pre><code class="hljs language-Objective-c" lang="Objective-c">- (void)registerCallNativeModule:(WXJSCallNativeModule)callNativeModuleBlock
{
    // JS 调用 Native 的方法都会走这里。可以解析到：模块名、方法名、参数数组等信息。可以在这里判断方法参数个数是否相同。
    _jsContext[@"callNativeModule"] = ^JSValue *(JSValue *instanceId, JSValue *moduleName, JSValue *methodName, JSValue *args, JSValue *options) {
        // ...
    };
}
</code></pre>
<p>在其 <code>callNativeModule</code> 的 block 里，增加一个方法，专门用来判断和检查方法参数个数是否匹配的问题</p>
<pre><code class="hljs language-Objective-C" lang="Objective-C">// 辅助方法：校验Module方法参数个数
- (void)checkModuleParamCount:(NSString *)moduleName
                   methodName:(NSString *)methodName
                 actualParams:(NSArray *)actualParams
                   instanceId:(NSString *)instanceId {
    // 1. 跳过空值/系统模块（避免无意义校验）
    if (!moduleName || !methodName || actualParams.count &lt; 0) return;
    Class moduleClass = [WXModuleFactory classWithModuleName:moduleName];
    if (!moduleClass) return;

    // 2. 拼接完整的方法选择器（Weex Module方法名带冒号，需补全，如multiply→multiply:num2:callback:）
    // 注：若方法名规则固定，可通过模块类的方法列表获取所有selector，匹配前缀
    SEL targetSel = nil;
    unsigned int methodCount = 0;
    Method *methods = class_copyMethodList(moduleClass, &amp;methodCount);
    for (int i = 0; i &lt; methodCount; i++) {
        Method method = methods[i];
        SEL sel = method_getName(method);
        NSString *selStr = NSStringFromSelector(sel);
        // 匹配前缀（如multiply开头的方法）
        if ([selStr hasPrefix:methodName]) {
            targetSel = sel;
            break;
        }
    }
    free(methods);
    if (!targetSel) return;

    // 3. 解析方法签名，计算预期参数个数（减self/_cmd）
    NSMethodSignature *methodSig = [moduleClass instanceMethodSignatureForSelector:targetSel];
    NSInteger weexParamCount = methodSig.numberOfArguments - 2;

    // 4. 判断参数个数是否不匹配
    if (actualParams.count != weexParamCount) {
        // 构造错误信息
        NSString *errorMsg = [NSString stringWithFormat:@"Module:%@ 方法:%@ 参数个数不匹配，预期%ld个，实际%ld个",
                              moduleName, methodName, weexParamCount, actualParams.count];
        WXLogError(@"[WeexParamError] %@", errorMsg);

        // 5. 上报APM（核心：生产环境监控）
        NSDictionary *apmData = @{
            @"error_type": @"weex_module_param_count_mismatch",
            @"module_name": moduleName,
            @"method_name": methodName,
            @"expected_count": @(weexParamCount),
            @"actual_count": @(actualParams.count),
            @"actual_params": actualParams,
            @"instance_id": instanceId ?: @"",
            @"timestamp": @([[NSDate date] timeIntervalSince1970] * 1000),
            @"message": errorMsg
        };

        // APM:异步上报，避免阻塞JS桥接
        NSLog(@"APM 数据上报通道，【JS 通过 Module 调用 Native 方法，参数个数不匹配】：%@", apmData);
    }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bd25d1035904328bb1420da7f7961c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=Vt4Dsl4Nmtzch2kyJ9N%2FnA6qwsk%3D" alt="WeexCallNativeModuleParamsError.png" loading="lazy"/></p>
<h4 data-id="heading-79">5. Vue 层面异常</h4>
<p>Weex 底层依靠 Vue 实现，差异化就是 VM 去通过 Bridge 在 WeexSDK Native 去做绘制。异常方面除了常规的 JS 运行时异常（如语法错误、类型错误等 7 种），Vue 框架自身的逻辑层、编译层、响应式系统、组件生命周期 等环节会抛出专属异常，这些异常必须通过 Vue.config.errorHandler 兜底。</p>
<p>分析 Weex 源码中：<code>packages/weex-js-framework/index.js/</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleError</span> (err, vm, info) {
  <span class="hljs-keyword">if</span> (vm) {
    <span class="hljs-keyword">var</span> cur = vm;
    <span class="hljs-keyword">while</span> ((cur = cur.<span class="hljs-property">$parent</span>)) {
      <span class="hljs-keyword">var</span> hooks = cur.<span class="hljs-property">$options</span>.<span class="hljs-property">errorCaptured</span>;
      <span class="hljs-keyword">if</span> (hooks) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; hooks.<span class="hljs-property">length</span>; i++) {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> capture = hooks[i].<span class="hljs-title function_">call</span>(cur, err, vm, info) === <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (capture) { <span class="hljs-keyword">return</span> }
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">globalHandleError</span>(e, cur, <span class="hljs-string">'errorCaptured hook'</span>);
          }
        }
      }
    }
  }
  <span class="hljs-title function_">globalHandleError</span>(err, vm, info);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">globalHandleError</span> (err, vm, info) {
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">errorHandler</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> config.<span class="hljs-property">errorHandler</span>.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, err, vm, info)
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-title function_">logError</span>(e, <span class="hljs-literal">null</span>, <span class="hljs-string">'config.errorHandler'</span>);
    }
  }
  <span class="hljs-title function_">logError</span>(err, vm, info);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59bc9512ac44aa7868c7bec1817a4f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=5SezT87Wi5Mt311I3SEDLwsrRaA%3D" alt="WeexCaptureVueError.png" loading="lazy"/></p>
<p>源码中 nextTick、Vue.prototype.$emit、callHook、Watcher.prototype.get、Watcher.prototype.run、renderRecyclableComponentTemplate、Vue.prototype._render 等等都调用了  handleError 方法。
Vue 内部对部分异常做了封装/拦截，避免直接冒泡到全局（防止阻断应用整体运行），但会通过 errorHandler 暴露出来。</p>
<p>举个例子，WeexAPM 类可以封装为：</p>
<pre><code class="hljs language-JS" lang="JS"><span class="hljs-comment">/**
 * APM
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WeexAPM</span> {
  <span class="hljs-comment">/**
   * 获取当前的叶子节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} Vue vm
   * <span class="hljs-doctag">@returns</span> 当前组件名称
   */</span>
  formatComponentName (vm) {
    <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">$root</span> === vm) <span class="hljs-keyword">return</span> <span class="hljs-string">'root'</span>
    <span class="hljs-keyword">var</span> name = vm.<span class="hljs-property">_isVue</span>
      ? (vm.<span class="hljs-property">$options</span> &amp;&amp; vm.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span>) ||
        (vm.<span class="hljs-property">$options</span> &amp;&amp; vm.<span class="hljs-property">$options</span>.<span class="hljs-property">_componentTag</span>)
      : vm.<span class="hljs-property">name</span>
    <span class="hljs-keyword">return</span> (
      (name ? <span class="hljs-string">'component &lt;'</span> + name + <span class="hljs-string">'&gt;'</span> : <span class="hljs-string">'anonymous component'</span>) +
      (vm.<span class="hljs-property">_isVue</span> &amp;&amp; vm.<span class="hljs-property">$options</span> &amp;&amp; vm.<span class="hljs-property">$options</span>.<span class="hljs-property">__file</span>
        ? <span class="hljs-string">' at '</span> + (vm.<span class="hljs-property">$options</span> &amp;&amp; vm.<span class="hljs-property">$options</span>.<span class="hljs-property">__file</span>)
        : <span class="hljs-string">''</span>)
    )
  }

  <span class="hljs-comment">/**
   * 处理Vue错误提示
   */</span>
  monitor (<span class="hljs-title class_">Vue</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Vue</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 错误处理</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property">config</span>.<span class="hljs-property">errorHandler</span> = <span class="hljs-function">(<span class="hljs-params">err, vm, info</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> componentName = <span class="hljs-string">'unknown'</span>
      <span class="hljs-keyword">if</span> (vm) {
        componentName = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatComponentName</span>(vm)
      }
      <span class="hljs-keyword">let</span> errorInfo = {
        <span class="hljs-attr">name</span>: err.<span class="hljs-property">name</span>,
        <span class="hljs-attr">reason</span>: err.<span class="hljs-property">message</span>,
        <span class="hljs-attr">callStack</span>: err.<span class="hljs-property">stack</span>,
        <span class="hljs-attr">componentName</span>: componentName,
        <span class="hljs-attr">info</span>: info,
        <span class="hljs-attr">level</span>: <span class="hljs-string">'VUE_ERROR'</span>
      }
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> weexAPMUploader = weex.requireModule(<span class="hljs-string">'weexAPMUploader'</span>)
        weexAPMUploader.<span class="hljs-title function_">uploadException</span>(errorInfo)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'APMMonitor 能力有问题，请检查是否注册了weexAPMUploader模块'</span> + error)
      }
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">WeexAPM</span>
</code></pre>
<p>在捕获到 Vue 层面的异常时，可以调用注册好的 weexAPMUploader module 能力，将数据传输到 Native 侧，由 Native 侧进行统一的参数组装，最后调用 APM SDK 的能力进行数据写入数据库、按照策略上报到 APM 服务端进行消费。</p>
<p>模拟产生 Vue 层级的错误：给一个字符串类型的数据，在计算属性里调用 <code>toFixed</code> 方法。按钮的点击事件里将数据改为字符串，则会报错。
可以看到被 <code>Vue.config.errorHandler</code> 捕获了，后续交给 Native 处理即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c302b4a08944df885a48f5cb732c7ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2t5Z-O5bCP5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767925474&amp;x-signature=VtY%2Flp2%2F9jlnThAaAsyQlyi8zgM%3D" alt="WeexMockVueAPM.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>