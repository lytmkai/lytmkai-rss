<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[后端postgres在web3的优势]]></title>    <link>https://juejin.cn/post/7599247962821738523</link>    <guid>https://juejin.cn/post/7599247962821738523</guid>    <pubDate>2026-01-26T05:04:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599247962821738523" data-draft-id="7599101854644502538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="后端postgres在web3的优势"/> <meta itemprop="keywords" content="后端,PostgreSQL"/> <meta itemprop="datePublished" content="2026-01-26T05:04:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Warson_L"/> <meta itemprop="url" content="https://juejin.cn/user/2568875732117304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            后端postgres在web3的优势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568875732117304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Warson_L
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:04:02.000Z" title="Mon Jan 26 2026 05:04:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份文档将详细剖析 PostgreSQL 在 Web3 开发中的统治地位，重点展开你关心的 <strong>JSONB 索引与复杂关联查询</strong> 的对比分析，并重新梳理完整的技术选型逻辑。</p>
<hr/>
<h2 data-id="heading-0">为什么 PostgreSQL 是 Web3 后端的“版本之子”？</h2>
<p>在 Web3 开发中，数据具有极其特殊的**“双重人格”**：</p>
<ol>
<li><strong>极度非结构化：</strong> 一个区块里可能包含 Uniswap 交易（参数是 <code>amount0In</code>）、OpenSea 交易（参数是 <code>tokenId</code>）、AAVE 借贷（参数是 <code>interestRate</code>）。你无法预知下一个合约长什么样。</li>
<li><strong>极度依赖关系：</strong> 资产所有权是高度关联的（交易 -&gt; 用户 -&gt; 余额 -&gt; 历史记录）。</li>
</ol>
<p>PostgreSQL（简称 Postgres）之所以胜出，是因为它本质上是一个 <strong>“支持关联查询的 NoSQL 数据库”</strong>。</p>
<p>以下是核心维度的深度解析。</p>
<hr/>
<h3 data-id="heading-1">一、 核心战役：JSONB 与 复杂关联查询 (The "Magic")</h3>
<p>这是 Postgres 碾压 MySQL 和 MongoDB 的决定性战场。</p>
<h4 data-id="heading-2">1. 场景设定</h4>
<p>我们要开发一个 <strong>NFT 分析平台</strong>。
我们需要实现一个复杂的查询需求：</p>
<blockquote>
<p><strong>“找出 Bored Ape Yacht Club (BAYC) #888 这个 NFT 的所有历史转账记录，并且查出每一笔转账的‘发送方’（Sender）当前的 ETH 余额是多少。”</strong></p>
<p><em>目的：分析是不是有‘巨鲸’（Whale）在抛售这个 NFT。</em></p>
</blockquote>
<h4 data-id="heading-3">2. 数据库结构设计</h4>
<p>我们需要两张表：</p>
<ol>
<li><strong><code>contract_events</code> (大表，千万级数据)</strong>：存储链上所有的原始事件日志。</li>
<li><strong><code>users</code> (状态表)</strong>：存储用户当前的地址和余额。</li>
</ol>
<h5 data-id="heading-4">Postgres 的表定义</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 表1：事件日志</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> contract_events (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    contract_address <span class="hljs-type">CHAR</span>(<span class="hljs-number">42</span>), 
    event_name TEXT, 
    <span class="hljs-comment">-- 核心：所有不确定的参数全扔进 JSONB</span>
    params JSONB 
);

<span class="hljs-comment">-- 核心魔法：为 JSON 内部所有的键值对创建 GIN 倒排索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_params <span class="hljs-keyword">ON</span> contract_events <span class="hljs-keyword">USING</span> GIN (params);

<span class="hljs-comment">-- 表2：用户状态</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    address <span class="hljs-type">CHAR</span>(<span class="hljs-number">42</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    eth_balance <span class="hljs-type">NUMERIC</span>(<span class="hljs-number">78</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">-- 存当前余额</span>
);
</code></pre>
<h4 data-id="heading-5">3. 三种数据库的实战对比</h4>
<h5 data-id="heading-6">✅ PostgreSQL 的解决方案（完美平衡）</h5>
<p>Postgres 允许你混合使用 <strong>NoSQL 的灵活性</strong>（直接查 JSON）和 <strong>SQL 的关联性</strong>（JOIN 表）。</p>
<p><strong>查询语句：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    e.event_name,
    e.params<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'tokenId'</span> <span class="hljs-keyword">AS</span> token_id,
    e.params<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'from'</span> <span class="hljs-keyword">AS</span> sender_address,
    u.eth_balance <span class="hljs-keyword">AS</span> sender_current_balance <span class="hljs-comment">-- 关联查询出来的余额</span>
<span class="hljs-keyword">FROM</span> contract_events e
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> (e.params<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'from'</span>) <span class="hljs-operator">=</span> u.address <span class="hljs-comment">-- 这里的关联键直接取自 JSON</span>
<span class="hljs-keyword">WHERE</span> 
    e.contract_address <span class="hljs-operator">=</span> <span class="hljs-string">'0xBC4...'</span> <span class="hljs-comment">-- BAYC 合约地址</span>
    <span class="hljs-keyword">AND</span> e.params @<span class="hljs-operator">&gt;</span> <span class="hljs-string">'{"tokenId": "888"}'</span>; <span class="hljs-comment">-- 利用 GIN 索引秒级定位</span>
</code></pre>
<ul>
<li><strong>性能：</strong> <code>GIN</code> 索引让查找 <code>tokenId="888"</code> 的速度极快（类似 MongoDB）。</li>
<li><strong>关联：</strong> <code>JOIN</code> 操作在同一个数据库内核中完成，利用 Hash Join 算法，效率极高。</li>
<li><strong>开发体验：</strong> 一条 SQL 搞定，逻辑清晰。</li>
</ul>
<hr/>
<h5 data-id="heading-7">❌ MySQL 的困境（架构僵化 vs 索引噩梦）</h5>
<p>如果你用 MySQL (即使是 8.0 版本)，你会面临两难选择：</p>
<p><strong>方案 A：把所有参数存成 TEXT/JSON 字符串</strong></p>
<ul>
<li><strong>查询：</strong> <code>WHERE params LIKE '%"tokenId": "888"%'</code></li>
<li><strong>后果：</strong> <strong>全表扫描 (Full Table Scan)</strong>。如果有 1 亿条数据，这行代码会让数据库卡死几分钟。因为 MySQL 的普通索引无法索引 JSON 字符串内部的动态 Key。</li>
</ul>
<p><strong>方案 B：为每种合约建单独的列 (Virtual Generated Columns)</strong>
为了索引，你必须告诉 MySQL：“请把 JSON 里的 <code>tokenId</code> 提取出来，专门建一个虚拟列，并在上面建索引。”</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> contract_events 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> virtual_token_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) 
GENERATED ALWAYS <span class="hljs-keyword">AS</span> (params<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.tokenId'</span>) VIRTUAL;
<span class="hljs-keyword">CREATE</span> INDEX idx_token_id <span class="hljs-keyword">ON</span> contract_events(virtual_token_id);
</code></pre>
<ul>
<li><strong>后果：</strong>
<ul>
<li><strong>维护地狱：</strong> 今天有个新合约叫 <code>Lens Protocol</code>，它的参数是 <code>profileId</code>，你得立刻去修改表结构加列。</li>
<li><strong>架构瓶颈：</strong> 区块链上有成千上万种参数名，你的表会有几千列吗？这在 MySQL 中是不现实的。</li>
</ul>
</li>
</ul>
<hr/>
<h5 data-id="heading-8">❌ MongoDB 的困境（关联查询是弱项）</h5>
<p>MongoDB 存取 JSON 非常快，查询 <code>tokenId="888"</code> 的速度和 Postgres 一样快。但是，<strong>当遇到“关联查询”（Join）时，噩梦开始了。</strong></p>
<p><strong>MongoDB 的查询逻辑（聚合管道 Aggregate）：</strong>
你需要写一个复杂的聚合管道来实现类似 SQL 的 JOIN。</p>
<pre><code class="hljs language-javascript" lang="javascript">db.<span class="hljs-property">contract_events</span>.<span class="hljs-title function_">aggregate</span>([
    <span class="hljs-comment">// 第一步：先过滤出 NFT 888</span>
    { 
        <span class="hljs-attr">$match</span>: { 
            <span class="hljs-string">"contract_address"</span>: <span class="hljs-string">"0xBC4..."</span>, 
            <span class="hljs-string">"params.tokenId"</span>: <span class="hljs-string">"888"</span> 
        } 
    },
    <span class="hljs-comment">// 第二步：去 users 集合里“生拉硬拽”对应的数据 ($lookup)</span>
    {
        <span class="hljs-attr">$lookup</span>: {
            <span class="hljs-attr">from</span>: <span class="hljs-string">"users"</span>,
            <span class="hljs-attr">localField</span>: <span class="hljs-string">"params.from"</span>, <span class="hljs-comment">// 关联键</span>
            <span class="hljs-attr">foreignField</span>: <span class="hljs-string">"address"</span>,
            <span class="hljs-attr">as</span>: <span class="hljs-string">"sender_info"</span>
        }
    },
    <span class="hljs-comment">// 第三步：展开数据结构</span>
    { <span class="hljs-attr">$unwind</span>: <span class="hljs-string">"$sender_info"</span> },
    <span class="hljs-comment">// 第四步：格式化输出</span>
    {
        <span class="hljs-attr">$project</span>: {
            <span class="hljs-string">"params.tokenId"</span>: <span class="hljs-number">1</span>,
            <span class="hljs-string">"sender_balance"</span>: <span class="hljs-string">"$sender_info.eth_balance"</span>
        }
    }
])
</code></pre>
<p><strong>为什么 MongoDB 在这里不合适？</strong></p>
<ol>
<li>**性能开销 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>k</mi><mi>u</mi><mi>p</mi><mo stretchy="false">)</mo><mtext>：</mtext><mo>∗</mo><mo>∗</mo><mi>M</mi><mi>o</mi><mi>n</mi><mi>g</mi><mi>o</mi><mi>D</mi><mi>B</mi><mtext>的</mtext><mi mathvariant="normal">‘</mi></mrow><annotation encoding="application/x-tex">lookup)：** MongoDB 的 `</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">u</span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mord cjk_fallback">：</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">∗</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.02778em;">oD</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord cjk_fallback">的</span><span class="mord">‘</span></span></span></span></span>lookup<code>本质上是在应用层或者数据节点间做匹配。当</code>contract_events<code>和</code>users` 表都非常大（亿级）且分片存储在不同服务器上时，这个操作会产生巨大的网络 IO 和内存消耗，速度远慢于 Postgres 的本地 Hash Join。</li>
<li><strong>原子性缺失：</strong> 在高并发下，你很难保证查出来的 <code>Event</code> 和 <code>User Balance</code> 是同一时间点的快照（Snapshot Isolation）。</li>
</ol>
<hr/>
<h3 data-id="heading-9">二、 数值精度：金融系统的生命线</h3>
<p>Web3 是关于钱的。</p>
<ul>
<li>ETH 精度：18 位小数。</li>
<li>USDT 精度：6 位小数。</li>
<li>wBTC 精度：8 位小数。</li>
</ul>
<h4 data-id="heading-10">案例：计算 DeFi 协议的总锁仓量 (TVL)</h4>
<p>假设你要计算所有用户的存款总和。</p>
<ul>
<li>
<p><strong>JavaScript/MongoDB (Float/Double)：</strong>
JavaScript 只有双精度浮点数。
<code>0.1 + 0.2 = 0.30000000000000004</code>
如果你用它存 ETH 余额，最后对账时会发现莫名其妙多了或少了 0.0000001 ETH。对于金融审计，这是<strong>致命 Bug</strong>。</p>
</li>
<li>
<p><strong>PostgreSQL (NUMERIC)：</strong>
Postgres 提供 <code>NUMERIC</code> 类型，它不是浮点数，而是<strong>任意精度的十进制数</strong>。
它可以精准存储 <code>123456789.000000000000000001</code>，一位都不会错。所有的加减乘除都在数据库内核中以数学上的绝对精确度执行。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、 数据一致性：应对“链上回滚” (Reorg)</h3>
<p>区块链的一个特性是：<strong>历史是可能改变的</strong>。
你在高度 100 看到一笔充值，可能过了 1 分钟，链分叉了，高度 100 变成了另一个区块，那笔充值不存在了。</p>
<p><strong>后端必须做的事：回滚数据库。</strong></p>
<ul>
<li>
<p><strong>Postgres (ACID 事务)：</strong>
你可以开启一个事务，把那个区块里的 <strong>2000 笔交易记录、500 个余额变动、10 个 NFT 转移</strong> 全部删除。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> events <span class="hljs-keyword">WHERE</span> block <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
<span class="hljs-keyword">UPDATE</span> balances ...;
<span class="hljs-comment">-- 如果中间报错，或者断电，所有操作自动取消，数据库不会脏。</span>
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
</li>
<li>
<p><strong>MongoDB / NoSQL：</strong>
大多数 NoSQL 默认不支持跨多文档、多表的强 ACID 事务。如果你的脚本删了一半崩溃了，就会导致：<strong>用户的余额扣了，但交易记录没删掉</strong>。账目彻底乱了。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-12">四、 生态插件：不仅是存数据</h3>
<p>Postgres 的插件系统让它变成了“万能数据库”。</p>
<ol>
<li>
<p><strong>PostGIS (Web3 游戏/元宇宙)：</strong>
Decentraland 的土地是坐标。你要查“离我最近的土地”。PostGIS 是地理信息处理的行业标准，直接支持空间索引。
<em>SQL:</em> <code>SELECT * FROM lands WHERE ST_DWithin(location, ST_MakePoint(x, y), 500);</code></p>
</li>
<li>
<p><strong>TimescaleDB (行情分析)：</strong>
交易所需要存每秒的 K 线数据。通过安装 TimescaleDB 插件，Postgres 自动变成一个高性能的时序数据库，支持数据自动分区、过期数据自动压缩。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-13">总结：选型建议</h3>

























<table><thead><tr><th align="left">数据库</th><th align="left">适合场景</th><th align="left">Web3 中的问题</th></tr></thead><tbody><tr><td align="left"><strong>MySQL</strong></td><td align="left">传统电商、简单 CMS</td><td align="left">无法应对千变万化的合约结构（Schema 僵化），处理 JSON 繁琐。</td></tr><tr><td align="left"><strong>MongoDB</strong></td><td align="left">纯日志记录、非关联数据</td><td align="left">弱关联查询（Join 性能差），缺乏严格的事务保证，不适合处理复杂的金融账本。</td></tr><tr><td align="left"><strong>PostgreSQL</strong></td><td align="left"><strong>Web3 后端通杀</strong></td><td align="left"><strong>JSONB 解决了数据结构变化问题；JOIN 解决了数据关联问题；NUMERIC 解决了精度问题；ACID 解决了回滚问题。</strong></td></tr></tbody></table>
<p>这就是为什么从 <strong>The Graph</strong> 到 <strong>Supabase</strong>，再到各大交易所的内部账本，几乎清一色选择 <strong>PostgreSQL</strong> 的原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 定时任务多实例互斥执行]]></title>    <link>https://juejin.cn/post/7599101854644699146</link>    <guid>https://juejin.cn/post/7599101854644699146</guid>    <pubDate>2026-01-26T05:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599101854644699146" data-draft-id="7599166436683300910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 定时任务多实例互斥执行"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T05:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 定时任务多实例互斥执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:33:53.000Z" title="Mon Jan 26 2026 05:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring Boot 的 <code>@Scheduled</code> 写定时任务很方便，但多实例部署时有个问题：同一个定时任务会在每台机器上都触发执行。</p>
<p>比如部署了两台应用服务器，凌晨 2 点的数据统计任务会同时跑两遍，数据重复、文件重复生成。</p>
<p>解决这个问题通常有几种思路。</p>
<h2 data-id="heading-0">常见方案</h2>
<p><strong>方案一：单机执行</strong></p>
<p>只在一台指定的机器上跑任务：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Scheduled</span>(cron = <span class="hljs-string">"0 0 2 * * ?"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduledTask</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">String</span> hostname = <span class="hljs-title class_">InetAddress</span>.<span class="hljs-title function_">getLocalHost</span>().<span class="hljs-title function_">getHostName</span>();
    <span class="hljs-keyword">if</span> (!<span class="hljs-string">"app-server-01"</span>.<span class="hljs-title function_">equals</span>(hostname)) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">// do something</span>
}
</code></pre>
<p>问题很明显：那台机器挂了，任务就不执行了。</p>
<p><strong>方案二：Redis 分布式锁</strong></p>
<p>用 Redis 的 SETNX 实现互斥（或者Redission）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Scheduled</span>(cron = <span class="hljs-string">"0 0 2 * * ?"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">scheduledTask</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Boolean</span> locked = stringRedisTemplate.<span class="hljs-title function_">opsForValue</span>()
        .<span class="hljs-title function_">setIfAbsent</span>(<span class="hljs-string">"task:data-sync"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">MINUTES</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Boolean</span>.<span class="hljs-property">FALSE</span>.<span class="hljs-title function_">equals</span>(locked)) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// do something</span>
    } <span class="hljs-keyword">finally</span> {
        stringRedisTemplate.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"task:data-sync"</span>);
    }
}
</code></pre>
<p>能用，但每个任务都要写一遍加锁释放逻辑，而且需要项目里有 Redis。</p>
<h2 data-id="heading-1">ShedLock 方案</h2>
<p>ShedLock 是一个专门解决定时任务重复执行问题的框架，支持多种存储后端（数据库、Redis、MongoDB 等）。</p>
<p>核心思路：在存储层记录每个任务的锁状态，任务执行前先抢锁，抢到了才执行。</p>
<h4 data-id="heading-2">集成步骤</h4>
<p><strong>1. 添加依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.javacrumbs.shedlock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shedlock-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.42.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.javacrumbs.shedlock<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shedlock-provider-jdbc-template<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.42.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>2. 创建锁表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> shedlock (
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    lock_until <span class="hljs-type">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    locked_at <span class="hljs-type">TIMESTAMP</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    locked_by <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (name)
);
</code></pre>
<p><strong>3. 配置 LockProvider</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableSchedulerLock</span>(defaultLockAtMostFor = <span class="hljs-string">"10m"</span>)
public class ShedLockConfig {

    <span class="hljs-variable">@Bean</span>
    public LockProvider <span class="hljs-built_in">lockProvider</span>(DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">JdbcTemplateLockProvider</span>(
            JdbcTemplateLockProvider.Configuration.<span class="hljs-built_in">builder</span>()
                .<span class="hljs-built_in">withDataSource</span>(dataSource)
                .<span class="hljs-built_in">withTableName</span>(<span class="hljs-string">"shedlock"</span>)
                .<span class="hljs-built_in">build</span>()
        );
    }
}
</code></pre>
<p><strong>4. 给定时任务加注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Scheduled</span>(cron = <span class="hljs-string">"0 0 2 * * ?"</span>)
<span class="hljs-variable">@SchedulerLock</span>(name = <span class="hljs-string">"dataSyncTask"</span>, lockAtMostFor = <span class="hljs-string">"5m"</span>)
public void <span class="hljs-built_in">syncData</span>() {
    <span class="hljs-comment">// do something</span>
}
</code></pre>
<p>完成。多台服务器部署时，只有抢到锁的那台会执行任务。</p>
<h2 data-id="heading-3">注解参数说明</h2>
<p><code>@SchedulerLock</code> 有几个关键参数：</p>
<p><strong>name</strong>：锁名称，相同 name 的任务会互斥执行。建议用任务名来命名，保持唯一。</p>
<p><strong>lockAtMostFor</strong>：锁的最大持有时间。</p>
<p>这是为了防止任务执行过程中机器宕机，导致锁永远不释放。比如设置 <code>5m</code>，即使任务执行超时，锁也会在 5 分钟后自动过期。</p>
<p>一般按任务预期执行时间的 2 倍左右设置，留些余量。</p>
<p><strong>lockAtLeastFor</strong>：锁的最小持有时间。</p>
<p>这是为了防止任务执行太快，锁立即释放被其他机器抢到。</p>
<p>比如定时任务每分钟执行一次，任务 5 秒就跑完了。如果没有这个参数，其他机器可能会在同一分钟内再次抢到锁执行。</p>
<p>这种情况下可以设置 <code>lockAtLeastFor = "1m"</code>，确保锁保持到下一分钟。</p>
<h2 data-id="heading-4">实现原理</h2>
<p>ShedLock 的实现逻辑不复杂。</p>
<p>任务执行前，会向数据库插入或更新锁记录：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> shedlock (name, lock_until, locked_at, locked_by)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'dataSyncTask'</span>, <span class="hljs-string">'2025-01-25 02:05:00'</span>, NOW(), <span class="hljs-string">'192.168.1.10'</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span>
  lock_until <span class="hljs-operator">=</span> <span class="hljs-string">'2025-01-25 02:05:00'</span>,
  locked_at <span class="hljs-operator">=</span> NOW(),
  locked_by <span class="hljs-operator">=</span> <span class="hljs-string">'192.168.1.10'</span>
<span class="hljs-keyword">WHERE</span> lock_until <span class="hljs-operator">&lt;</span> NOW();
</code></pre>
<p>关键是最后的 <code>WHERE lock_until &lt; NOW()</code> 条件：</p>
<ul>
<li>• 如果当前锁已过期，UPDATE 成功，抢到锁</li>
<li>• 如果当前锁未过期，UPDATE 影响行数为 0，抢锁失败，任务不执行</li>
</ul>
<p>任务执行完成后不需要主动释放锁，等待 <code>lock_until</code> 时间到期即可。</p>
<h2 data-id="heading-5">适用场景</h2>
<p>ShedLock 的定位很明确：专门为定时任务设计的分布式锁框架。</p>
<p><strong>适合</strong></p>
<ul>
<li>• 定时任务需要互斥执行，避免重复</li>
<li>• 希望用注解方式简化锁的代码逻辑</li>
<li>• 需要自动锁过期机制，防止死锁</li>
</ul>
<p><strong>不适合</strong></p>
<ul>
<li>• 高并发抢锁的业务场景（比如秒杀、库存扣减），ShedLock 不是为此设计</li>
<li>• 需要可重入锁、读写锁等复杂特性</li>
<li>• 需要精确控制锁获取和释放时机的业务逻辑</li>
</ul>
<p>ShedLock 和通用分布式锁是互补关系，不是替代关系。如果你的业务代码里需要手动加锁解锁，用 Redisson 或手动实现 Redis SETNX 更合适。但如果只是为了解决定时任务重复执行的问题，ShedLock 是更简洁的方案。</p>
<h2 data-id="heading-6">几个注意事项</h2>
<p><strong>1. 存储后端选择</strong></p>
<p>本文演示用的是 JDBC 方式（基于数据库表）。ShedLock 还支持 Redis、MongoDB、ZooKeeper、Hazelcast 等多种存储后端，根据项目现有技术栈选择即可。</p>
<p><strong>2. 表名自定义（数据库存储时）</strong></p>
<p>如果用 JDBC 作为存储后端，默认表名是 <code>shedlock</code>，可以按需修改：<br/>
<strong>3. 机器标识</strong></p>
<p><code>locked_by</code> 字段记录是哪台机器拿到的锁，默认是主机名。可以自定义成更有意义的标识：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.withLockedByValue</span>(<span class="hljs-string">"app-"</span> + <span class="hljs-built_in">getServerIp</span>())
</code></pre>
<p><strong>4. 主从/多数据源场景（数据库存储时）</strong></p>
<p>如果项目有多个数据源，确保 ShedLock 用的是主库，避免主从延迟导致的锁问题。</p>
<h2 data-id="heading-7">总结</h2>
<p>ShedLock 是一个专门为定时任务设计的分布式锁框架：</p>
<ul>
<li>• 优点：注解式使用、集成简单、自动锁过期、支持多种存储后端</li>
<li>• 局限性：只适用于定时任务场景，不适用于通用业务加锁</li>
</ul>
<p>和手动写 Redis 分布式锁相比，ShedLock 把定时任务锁的逻辑抽象出来了，代码更简洁。但如果你需要的是通用业务锁，还是用 Redisson 或手写 SETNX 更合适。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全学习笔记：Goldeneye靶机记录 基本信息收集与分析]]></title>    <link>https://juejin.cn/post/7599247962821459995</link>    <guid>https://juejin.cn/post/7599247962821459995</guid>    <pubDate>2026-01-26T03:46:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599247962821459995" data-draft-id="7598921649889673243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全学习笔记：Goldeneye靶机记录 基本信息收集与分析"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2026-01-26T03:46:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="古手羽入"/> <meta itemprop="url" content="https://juejin.cn/user/869092937980291"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全学习笔记：Goldeneye靶机记录 基本信息收集与分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/869092937980291/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    古手羽入
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:46:48.000Z" title="Mon Jan 26 2026 03:46:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Author：FrancesBeatrice  2026.1
<strong>参照Mapsec大佬的视频跟做的，十分感谢大佬的指导。</strong>
第一次写这样的，刚刚开始入坑Web攻防，请大家有意见提出。</p>
<h3 data-id="heading-0">最终目的：收集信息，获得管理员账号密码进行反弹Shell，根据信息搜索提权CVE，传入靶机运行获取Flag</h3>
<h3 data-id="heading-1">本次靶机的漏洞原因以及破解、修复对策：</h3>
<h5 data-id="heading-2">POP3</h5>
<p>账号密码直接在网络中明文传输，认证简单，并且抓包就能看到密码，本靶机中没有其他防护。
攻击方法：Hydra 不需要“解密”，它只是<strong>模拟合法客户端反复试密码</strong>。我们固定的账号，剩下的工作就是遍历弱密码字典反复试密码。
该方法在本靶机非常有效，在这里知道邮箱号就能得到密码，使部分流程简化了找邮箱号。
修复对策：强制使用 POP3S（端口 995） 加密传输，防止中间人窃听。同时部署 fail2ban 防爆破，使其监控 POP3 日志，自动封禁多次失败的 IP。</p>
<h5 data-id="heading-3">Moodle 2.2.3 存在已知的 <strong>CVE-2013-3630</strong> 远程代码执行漏洞</h5>
<p>该版本 Moodle 在调用拼写检查时未对输入进行安全过滤，调用外部Shell命令，导致命令直接在服务器执行，从而实现远程代码执行。
攻击方法：直接搜索msfconsole模块，选用moodle_spelling_binary_rce 模块进行RCE攻击。
修复对策：Spell engine禁用PSpellShell。</p>
<h5 data-id="heading-4">Linux CVE-2015-1328 提权漏洞</h5>
<p>源于OverlayFS 在创建上层副本时，未正确重置 setuid/setgid 位和文件能力，导致普通用户可继承特权文件的权限。
攻击方法：下载提权CVE-2015-1328，反弹Shell传入，编译运行攻击。
修复对策：禁用 OverlayFS或者限制挂载权限。</p>
<h3 data-id="heading-5">由该靶场可知，我们攻击者要训练的意识：</h3>
<p>要足够敏锐，
1遇到网页要看源代码。
2看到图片要扫String。
3进入页面看指纹看到CMS、版本相关的要记下来查漏洞。
4看到看不懂的一串代码要考虑解密编码。
5记住任何名词，提示会在里面，试的时候统一小写。</p>
<h2 data-id="heading-6">靶场过程：</h2>
<p>首先我们得让kali连到靶机，找到靶机的IP和Port让Kali能够互动。</p>
<h4 data-id="heading-7">IP</h4>
<p>我们能看到靶机的MAC，我们知道网段内MAC和IP是绑定的，启动后通过MAC找到靶机的IP，
使用netdiscover进行搜索。</p>
<pre><code class="hljs language-bash" lang="bash">sudo su <span class="hljs-comment"># 需要管理员权限</span>
netdiscover -r 10.0.0.0/24
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ceac006fe8f4749a740653c785f417b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=emzJUrVVizx%2F9MLUeUzvBUN07MA%3D" alt="Pasted image 20260120145953.png" loading="lazy"/>
扫出网段内的IP，发现靶机的MAC对应10.0.0.139，锁定IP</p>
<h3 data-id="heading-8">PORT</h3>
<p>使用nmap扫描刚刚获得的IP</p>
<pre><code class="hljs language-css" lang="css">nmap -<span class="hljs-selector-tag">p</span>- <span class="hljs-number">10.0</span>.<span class="hljs-number">0.139</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6320f7bd5d6a417bab5baf7772c37233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=Z%2F%2BzXXmmr226w7%2B2mUOb6vO2nzU%3D" alt="Pasted image 20260120151109.png" loading="lazy"/>
可以看到有四个端口</p>
<h4 data-id="heading-9">那怎么判断哪个端口才是我们要的呢？</h4>
<p>可以看到80是http服务，浏览器直接访问</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e293958645c4525a5c1a42698a2d4ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=oufJ7fCSi%2FBYC2AF6IUUY2UAOt4%3D" alt="Pasted image 20260120151526.png" loading="lazy"/>
可以看到，有用的信息只有/sev-home/可以登录</p>
<h3 data-id="heading-10">开始常规渗透，开始搜集</h3>
<p>但这是网页，可以看源代码。
此页和登录页都看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e435ff94989344039b462646351074ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=OT4oa%2BnrImxq7csde6SOYfq%2BLOg%3D" alt="Pasted image 20260120151907.png" loading="lazy"/>
css文件和js文件都看，有什么看什么</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ad1c62c9c34c228b0290f9a03ceb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=FblblYZUSE612T8NQDNaMDiYqB4%3D" alt="Pasted image 20260120151935.png" loading="lazy"/>
在JS文件中发现了惊喜，发现两个名字Natalya和Boris还有一串看不懂的东西（这个人说是Boris的密码）：InvincibleHack3r</p>
<p>从文字内容中可看出这两个名字都是在这个网站上有密码
问ai得知是Html编码，解码得到InvincibleHack3r，并且指向Boris</p>
<p>我们尝试登录，账号名：Boris，boris，Natalya，natalya 都试试，密码：InvincibleHack3r</p>
<p>可以知道对应账号boris</p>
<h3 data-id="heading-11">成功登入最初的网页</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7392c2ef25ad443fa57ab2e1d05ec9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=PFZGwPf%2FWqnnBCmYC13thtdQS0U%3D" alt="Pasted image 20260120153045.png" loading="lazy"/></p>
<p>前面是一段很中二的情景导入，但后面提到了当Adminstrator需要搞定他们搞的pop3服务，还是高端口的。
那我们要当管理员，应该就按他们说的去搞
刚刚我们扫到了55006和55007两个大端口</p>
<h3 data-id="heading-12">那怎么搞定pop3呢？</h3>
<p>遇到问题就直接搜索
经过查询可知Hydra暴力破解是一个好方法，所以我们可以尝试</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">'natalya\nboris\nBoris\nNatalya'</span> &gt; key.txt  先写一个账号本
hydra -L key.txt -P /usr/share/wordlists/fasttrack.txt 10.0.0.139 -s 55007 pop3 -vV //-L文本 -l 是用户名 - p密码 -vV 会显示每一条线程前面是账号本，后面是密码本

</code></pre>
<p>55007和55006都试试
爆出来了账号密码
用户：boris 密码：secret1! 用户：natalya 密码：bird
看来这是个稳定的方案，以后见到邮箱名都可以爆破找密码！！！</p>
<h3 data-id="heading-13">登录看邮件</h3>
<p>POP3是邮件协议，知道账号密码便可以登录看邮件</p>
<pre><code class="hljs language-sql" lang="sql">nc <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.139</span> <span class="hljs-number">55007</span> <span class="hljs-comment">---登录邮箱 </span>
<span class="hljs-keyword">user</span> boris <span class="hljs-comment">---登录用户 </span>
pass secret1<span class="hljs-operator">!</span> <span class="hljs-comment">---登录密码 </span>
list <span class="hljs-comment">---查看邮件数量 </span>
retr <span class="hljs-number">1</span> <span class="hljs-comment">---查看邮件内容</span>

</code></pre>
<p>依然是注意名词和长串，可以看到两者邮件中都出现了
xenia
甚至还有密码
password: RCP90rulez!
severnaya-station.com/gnocertdi</p>
<h3 data-id="heading-14">有域名应该怎么访问呢</h3>
<pre><code class="hljs language-bash" lang="bash">vi /etc/hosts 
 在ipv4部分添加，把域名定向到ip
10.0.0.139 severnaya-station.com

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bef3fd55f114690b6c46f1309b12433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=6H%2Bz%2F4QACJ9fF39W4L9ZQxQrFmY%3D" alt="Pasted image 20260121012930.png" loading="lazy"/></p>
<h3 data-id="heading-15">进入网站，观测到CMS版本</h3>
<p>从页面能够直接看到系统以及版本，后续可以搜索与之相关的漏洞库，进行攻击
登录账号，搜刮信息，搜到一封邮件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad0aa378d9f045b28fa378b58b424cc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=GTv0RkyMBfkeO51et4LcMzA03DE%3D" alt="Pasted image 20260121013359.png" loading="lazy"/>
里面出现了一个邮件名，doak，应该可以pop3 hydra搜刮密码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cf04abd1c714f44bc778184abd09fe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=p%2BBkJ0DWcBWxN%2Fdhsj9uGy5E%2FCY%3D" alt="Pasted image 20260121015910.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f2bf9fad05c452580df3fcdb81de4f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=6953YwIu5q6maD5zUYxwljMgxuQ%3D" alt="Pasted image 20260121013637.png" loading="lazy"/>
尝试后得到密码goat
登录搜刮</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7b1027997c74ab2aace5ba4e0fe37d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=pgQTrIfn%2FjOfOYU4lxSqMAtHBYA%3D" alt="Pasted image 20260121014304.png" loading="lazy"/></p>
<p>得到账号密码，直接叫登网站了，登上继续搜，发现右侧有文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68c555f8a4924a2aa018c3af4dbe2e03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=M7A9%2Fim1%2B9DO1%2BliAKDc72LDRMg%3D" alt="Pasted image 20260121014357.png" loading="lazy"/></p>
<h3 data-id="heading-16">分析文件和图片</h3>
<p>下载得到图片</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94e63c6586774c84bd786ab6e06e92e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=y1rCMf2U8PoZpaZxM%2F8eV5uZF9E%3D" alt="Pasted image 20260121015255.png" loading="lazy"/>
里面提到了admin的凭证，并且直接说这个jpg图片里有东西了
还有RCP-90，现实中是一种突击步枪，在《007》电影《杀人执照》中由邦德使用，是标志性武器。但在这里也不知道是什么，先记下来。看来搞安全还得多看电影。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f033961cd894c22a7917b43ea510121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=rPkEA7zI5LRHgJhWM6%2FI0t0An9I%3D" alt="Pasted image 20260121014738.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6b94fe649a6431185a9cf2dcd4178c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=3AjnGop%2F5D75BVgMvvFJIL3oCrA%3D" alt="Pasted image 20260121014655.png" loading="lazy"/></p>
<p>复制进URL下载图片，用strings分析字符串或者直接打开图片看</p>
<p>可以发现这一段神秘字符，看见后面两个等号估计是base64，ai也说确实是</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e18138d646a442fa3ff8cf5ca167005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=ytL2JODPoF2iujY%2F%2B%2BN5W6zRFO0%3D" alt="Pasted image 20260121014828.png" loading="lazy"/></p>
<p>至此得到了账号和密码</p>
<h3 data-id="heading-17">最后的搜刮</h3>
<p>得到网站的后台，我们自然是要拿到Webshell。
由网页内容可知其使用的是Moodle的CMS，所以可以直接搜索版本漏洞进行攻击。
--该图是搜索模块搜出来的列表，我们用序号为1的那个模块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f824fd2ba30459a8183c6515ef7ead5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=Ss3pxisqla3yvPaqDwr7%2BSZdwqY%3D" alt="Pasted image 20260121020526.png" loading="lazy"/></p>
<pre><code class="hljs language-perl" lang="perl">
msfconsole 使用msf攻击
search moodle 搜索攻击模块
<span class="hljs-keyword">use</span> <span class="hljs-number">1</span> 使用第一个
</code></pre>
<p>然后show options，set相关信息。
--该图为设置信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be623302bc5e48cf85ba79120e4dcc96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=%2Blxf0mcc8ItvzHMM4Iaj%2BHyIozM%3D" alt="Pasted image 20260121020624.png" loading="lazy"/>
此外还需调整网站的spell引擎为PSpellshell，CMS通过外部Shell命令来调用检查，使攻击者能控制拼写检查的词典路径或输入内容，就可能注入任意命令。便于该模块攻击。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c3d261a2624ef98a7c72aaa44020b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=bSnLOxiSIbNGprz9lcxqLdWxnck%3D" alt="Pasted image 20260121021007.png" loading="lazy"/></p>
<p>直接run，运行开始攻击</p>
<h3 data-id="heading-18">攻入后想办法提权，怎么提权呢？</h3>
<p>攻入后会发现命令行不太好用，不好输入命令，而且sudo等指令会检测自己是不是在正常的命令行工作，否则他们不会工作。
于是我们引入Python创建伪终端来优化流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9b7c07bb6c44038ad9a9186fefdbaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=U8Iay6SBGlCoHujBtwXJ8XO0meE%3D" alt="Pasted image 20260121021929.png" loading="lazy"/></p>
<p>输入id可以看到我们现在拿到了www-data权限，已拥有本地Shell。</p>
<p>使用uname -a获取系统信息，方便我们查找漏洞。
我们得知Ubuntu版本，直接搜索ubuntu 3.13，选择得到提权CVE-2015-1328，直接复制下来，传给靶机运行就告破了。</p>
<h4 data-id="heading-19">但是我们还得考虑靶机能不能编译运行</h4>
<p>进入tmp文件夹方便提权，暂时文件也不容易被发现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35424b80eba549abbe3f38d4be2208cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=5uFcCg7AW92oVc9EvDLRSVIIDwY%3D" alt="Pasted image 20260121022847.png" loading="lazy"/>
发现只有cc，那就需要去修改CVE使其能够被cc编译</p>
<h3 data-id="heading-20">传入CVE，得到提权</h3>
<p>在 Kali 上启动 HTTP 服务（如 <code>python3 -m http.server 8000</code>）。
在靶机用 wget从 Kali 下载 exp 源码。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/574fb6ddfcb9406caef466e7f13bffb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=zqviFwxkDXx85tJU2XuJkKSnu10%3D" alt="Pasted image 20260121023132.png" loading="lazy"/></p>
<p>编译成exp</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e4ef65ab404b89b556aa030bb1aaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=bIOaZQUlpriXvNQob3NBJpWfYGg%3D" alt="Pasted image 20260121023454.png" loading="lazy"/></p>
<p>给exp脚本执行权限(这里写错了，但还是能用)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/922e3ff030eb49f8816192690b2c9e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=FqB1OEFxlwVYSi%2FOH9VRdULLnuY%3D" alt="Pasted image 20260121023838.png" loading="lazy"/></p>
<p>列出文件和隐藏文件以及详细信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b7e38b42d34468b63705606bb70185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=LowulLHFOUif9ToyOAnE2d3Y0LE%3D" alt="Pasted image 20260121023934.png" loading="lazy"/></p>
<p>可以看到我们exp可执行，都是rwx。
直接执行</p>
<pre><code class="hljs language-bash" lang="bash">
./exp

</code></pre>
<h3 data-id="heading-21">提权成功</h3>
<p>直接看id，看看是不是root了，是就直接进root文件夹看Flag</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3adb148cb68d4018ab01f0462c5100e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=MRhlOd1sWOx3%2BiwuM3aEy9P9Ock%3D" alt="Pasted image 20260121024319.png" loading="lazy"/>
成功得到Flag，靶场攻破！！！！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c952b48e11724b73a7d2e8d567e58073~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-k5omL57695YWl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004010&amp;x-signature=4PyU5Xoyy%2BIhhlxC5FMx3J%2FfRAE%3D" alt="Pasted image 20260121024434.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 核心接口与扩展点详细指南]]></title>    <link>https://juejin.cn/post/7599247962821967899</link>    <guid>https://juejin.cn/post/7599247962821967899</guid>    <pubDate>2026-01-26T05:30:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599247962821967899" data-draft-id="7599247962821935131" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 核心接口与扩展点详细指南"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-26T05:30:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 核心接口与扩展点详细指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:30:02.000Z" title="Mon Jan 26 2026 05:30:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 核心接口与扩展点详细指南</h2>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>引言</h3>
<p>在<code>Spring Boot</code>的便捷背后，隐藏着一套精妙而强大的<strong>扩展</strong>机制。无论是容器启动的瞬间，还是<code>Bean</code>生命的各个阶段，亦或是<code>Web</code>请求的完整链路，框架都为我们预留了丰富的扩展接口。这些接口如同<code>Spring Boot</code>的“穴位”，掌握它们便能精准调控应用的每一个行为。</p>
<p>本文系统梳理了<code>Spring Boot</code>中二十余类核心扩展点，从<code>ApplicationContextInitializer</code>的启动初始化，到<code>BeanPostProcessor</code>的实例化干预，再到<code>WebMvcConfigurer</code>的<strong>Web定制</strong>，不仅详解各接口的作用与执行时机，更结合典型场景说明实践要点。</p>
<p>如果你希望深入理解框架原理，或是需要实现特定定制需求，这份指南都将成为你探索<code>Spring Boot</code>内部世界的<strong>权威手册</strong>。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>一、容器启动与初始化阶段</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>ApplicationContextInitializer</strong></h4>
<p><strong>作用</strong>：在Spring容器刷新之前执行自定义的初始化逻辑，用于在容器启动的最早期进行配置或修改。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>需要最早设置一些环境变量或系统属性</li>
<li>注册自定义的<code>PropertySource</code></li>
<li>在容器启动前执行一些预检查或初始化工作</li>
</ul>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在Spring容器刷新之前执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInitializer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextInitializer</span>&lt;ConfigurableApplicationContext&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span> {
        <span class="hljs-comment">// 注册自定义属性源</span>
        <span class="hljs-type">MapPropertySource</span> <span class="hljs-variable">propertySource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapPropertySource</span>(<span class="hljs-string">"myProperties"</span>, 
            Collections.singletonMap(<span class="hljs-string">"custom.key"</span>, <span class="hljs-string">"custom-value"</span>));
        applicationContext.getEnvironment().getPropertySources().addFirst(propertySource);
        
        <span class="hljs-comment">// 设置一些系统属性</span>
        System.setProperty(<span class="hljs-string">"some.key"</span>, <span class="hljs-string">"some-value"</span>);
    }
}

<span class="hljs-comment">// 使用方式：META-INF/spring.factories</span>
<span class="hljs-comment">// org.springframework.context.ApplicationContextInitializer=com.example.MyInitializer</span>

AI写代码java
运行
<span class="hljs-number">12345678910111213141516</span>
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li>执行时机非常早，此时Bean容器还没有创建</li>
<li>可以通过<code>SpringApplication.addInitializers()</code>或<code>spring.factories</code>注册</li>
<li>通常用于框架级别的初始化</li>
</ul>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>SpringApplicationRunListener</strong></h4>
<p><strong>作用</strong>：监听<code>Spring Boot</code>应用启动的各个阶段事件，可以在不同阶段插入自定义逻辑。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>监控应用启动过程，记录启动耗时</li>
<li>在不同启动阶段执行特定逻辑（如环境准备完成后加载外部配置）</li>
<li>实现应用启动的性能监控</li>
</ul>
<p><strong>核心方法</strong>：</p>
<ul>
<li><code>starting()</code>: 应用启动开始时</li>
<li><code>environmentPrepared()</code>: 环境准备完成</li>
<li><code>contextPrepared()</code>: ApplicationContext准备完成</li>
<li><code>contextLoaded()</code>: ApplicationContext加载完成</li>
<li><code>started()</code>: 应用启动完成</li>
<li><code>running()</code>: 应用运行中</li>
<li><code>failed()</code>: 启动失败</li>
</ul>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. <strong>ApplicationRunner 与 CommandLineRunner</strong></h4>
<p><strong>作用</strong>：应用启动完成后执行特定业务逻辑，两者功能类似但参数类型不同。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>启动后执行数据初始化</li>
<li>启动后建立外部连接</li>
<li>启动后发送通知或执行定时任务</li>
</ul>
<p><strong>区别对比</strong>：</p>
<ul>
<li><code>ApplicationRunner</code>: 接收<code>ApplicationArguments</code>参数，提供更丰富的参数解析功能</li>
<li><code>CommandLineRunner</code>: 接收原始字符串数组参数，更简单直接</li>
</ul>
<p><strong>执行顺序控制</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Order</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 通过@Order注解或实现Ordered接口控制执行顺序</span>
public class FirstRunner implements ApplicationRunner {
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">run</span>(ApplicationArguments args) {
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"第一个执行"</span>);
    }
}

<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
<span class="hljs-number">12345678</span>
</code></pre>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、环境配置与属性处理</h3>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>EnvironmentPostProcessor</strong></h4>
<p><strong>作用</strong>：在<code>Environment</code>对象准备好后对其进行修改或增强。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>从数据库、远程配置中心加载配置</li>
<li>根据条件动态修改配置</li>
<li>添加加密配置的解密逻辑</li>
</ul>
<p><strong>实战示例</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteConfigProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EnvironmentPostProcessor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessEnvironment</span>(<span class="hljs-params">ConfigurableEnvironment env, SpringApplication app</span>) {
        <span class="hljs-comment">// 从远程配置中心获取配置</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; remoteConfig = <span class="hljs-title function_">fetchRemoteConfig</span>();
        
        <span class="hljs-comment">// 将远程配置添加到Environment中</span>
        <span class="hljs-title class_">MapPropertySource</span> remoteSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapPropertySource</span>(<span class="hljs-string">"remoteConfig"</span>, remoteConfig);
        env.<span class="hljs-title function_">getPropertySources</span>().<span class="hljs-title function_">addFirst</span>(remoteSource);
        
        <span class="hljs-comment">// 动态激活Profile</span>
        <span class="hljs-keyword">if</span> (remoteConfig.<span class="hljs-title function_">containsKey</span>(<span class="hljs-string">"active.profiles"</span>)) {
            <span class="hljs-title class_">String</span> profiles = (<span class="hljs-title class_">String</span>) remoteConfig.<span class="hljs-title function_">get</span>(<span class="hljs-string">"active.profiles"</span>);
            env.<span class="hljs-title function_">setActiveProfiles</span>(profiles.<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>));
        }
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">1234567891011121314151617</span>
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>PropertySourceLoader</strong></h4>
<p><strong>作用</strong>：加载自定义格式的配置文件。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>支持<code>YAML</code>、<code>Properties</code>以外的配置文件格式（如<code>JSON</code>、<code>XML</code>）</li>
<li>从非标准位置加载配置文件</li>
<li>实现配置文件的加解密加载</li>
</ul>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、Bean定义与注册阶段</h3>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>BeanDefinitionRegistryPostProcessor</strong></h4>
<p><strong>作用</strong>：在所有Bean定义被加载后，但在Bean实例化之前，可以修改或添加Bean定义。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>动态注册<code>Bean</code>定义（基于条件或配置）</li>
<li>修改已注册<code>Bean</code>定义的属性</li>
<li>实现<code>Bean</code>定义的扫描和自动注册</li>
</ul>
<p><strong>与BeanFactoryPostProcessor的区别</strong>：</p>
<ul>
<li><code>BeanDefinitionRegistryPostProcessor</code>更早执行，可以注册新的Bean定义</li>
<li><code>BeanFactoryPostProcessor</code>只能修改已存在的Bean定义</li>
</ul>
<p><strong>执行时机图解</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">Spring容器启动
<span class="hljs-code">    ↓
加载Bean定义
    ↓
BeanDefinitionRegistryPostProcessor执行（可注册新Bean）
    ↓
BeanFactoryPostProcessor执行（只能修改已有Bean）
    ↓
Bean实例化
</span>
AI写代码
123456789
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>ImportBeanDefinitionRegistrar</strong></h4>
<p><strong>作用</strong>：与@Import注解配合使用，动态注册Bean定义到容器中。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>实现类似@EnableXXX的注解驱动配置</li>
<li>根据条件选择性注册Bean</li>
<li>批量扫描并注册Bean</li>
</ul>
<p><strong>典型应用</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 定义注解</span>
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Target</span>(ElementType.TYPE)
<span class="hljs-variable">@Import</span>(MyComponentRegistrar.class)
public <span class="hljs-variable">@interface</span> EnableMyComponents {
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">basePackages</span>() <span class="hljs-selector-tag">default</span> {};
}

<span class="hljs-comment">// 2. 实现Registrar</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MyComponentRegistrar</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">ImportBeanDefinitionRegistrar</span> {
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">registerBeanDefinitions</span>(AnnotationMetadata metadata, 
                                      BeanDefinitionRegistry registry) {
        <span class="hljs-comment">// 获取注解属性</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">attrs</span> = <span class="hljs-selector-tag">metadata</span><span class="hljs-selector-class">.getAnnotationAttributes</span>(
            EnableMyComponents.class.<span class="hljs-built_in">getName</span>());
        <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">packages</span> = (String[]) <span class="hljs-selector-tag">attrs</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"basePackages"</span>);
        
        <span class="hljs-comment">// 扫描并注册Bean</span>
        <span class="hljs-selector-tag">ClassPathBeanDefinitionScanner</span> <span class="hljs-selector-tag">scanner</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ClassPathBeanDefinitionScanner</span>(registry);
        <span class="hljs-selector-tag">scanner</span><span class="hljs-selector-class">.scan</span>(packages);
    }
}

<span class="hljs-comment">// 3. 使用</span>
@<span class="hljs-selector-tag">EnableMyComponents</span>(basePackages = <span class="hljs-string">"com.example.components"</span>)
@<span class="hljs-selector-tag">Configuration</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">AppConfig</span> {}

AI写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728</span>
</code></pre>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、Bean生命周期管理</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>BeanPostProcessor</strong></h4>
<p><strong>作用</strong>：在Bean初始化前后执行自定义逻辑，是Spring扩展中最常用、最强大的接口之一。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>Bean的代理增强（如AOP、事务）</li>
<li>Bean的属性验证或修改</li>
<li>为Bean添加监听器或处理器</li>
<li>实现自定义的依赖注入逻辑</li>
</ul>
<p><strong>执行时机</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> {
    <span class="hljs-comment">// Bean初始化之前调用（在afterPropertiesSet和init-method之前）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">postProcessBeforeInitialization</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> bean, <span class="hljs-built_in">String</span> beanName</span>) {
        <span class="hljs-comment">// 可以返回包装对象</span>
        <span class="hljs-keyword">return</span> bean;
    }
    
    <span class="hljs-comment">// Bean初始化之后调用（在afterPropertiesSet和init-method之后）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">postProcessAfterInitialization</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> bean, <span class="hljs-built_in">String</span> beanName</span>) {
        <span class="hljs-comment">// 通常用于返回代理对象</span>
        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyService</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Proxy</span>.<span class="hljs-title function_">newProxyInstance</span>(...); <span class="hljs-comment">// 创建代理</span>
        }
        <span class="hljs-keyword">return</span> bean;
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">123456789101112131415161718</span>
</code></pre>
<p><strong>重要实现类</strong>：</p>
<ul>
<li><code>AutowiredAnnotationBeanPostProcessor</code>: 处理@Autowired注解</li>
<li><code>CommonAnnotationBeanPostProcessor</code>: 处理@Resource、@PostConstruct等</li>
<li><code>AbstractAutoProxyCreator</code>: AOP代理创建器</li>
</ul>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>InstantiationAwareBeanPostProcessor</strong></h4>
<p><strong>作用</strong>：在Bean实例化前后执行更细粒度的控制，甚至可以阻止默认实例化过程。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>实现自定义的实例化逻辑（如使用工厂方法）</li>
<li>在属性注入前进行验证或修改</li>
<li>实现类似@Value的注解解析</li>
</ul>
<p><strong>特殊能力</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInstantiationProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InstantiationAwareBeanPostProcessor</span> {
    <span class="hljs-comment">// 1. 可以完全接管Bean的实例化过程</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">postProcessBeforeInstantiation</span>(<span class="hljs-params">Class&lt;?&gt; beanClass, <span class="hljs-built_in">String</span> beanName</span>) {
        <span class="hljs-keyword">if</span> (beanClass == <span class="hljs-title class_">SpecialBean</span>.<span class="hljs-property">class</span>) {
            <span class="hljs-comment">// 返回自定义实例，Spring将跳过默认实例化</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">createSpecialBean</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 返回null则继续Spring默认实例化</span>
    }
    
    <span class="hljs-comment">// 2. 控制是否进行属性注入</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">postProcessAfterInstantiation</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> bean, <span class="hljs-built_in">String</span> beanName</span>) {
        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ReadOnlyBean</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 返回false则跳过属性注入</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 3. 处理属性值</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PropertyValues</span> <span class="hljs-title function_">postProcessProperties</span>(<span class="hljs-params">PropertyValues pvs, <span class="hljs-built_in">Object</span> bean, <span class="hljs-built_in">String</span> beanName</span>) {
        <span class="hljs-comment">// 修改或添加属性值</span>
        <span class="hljs-title class_">MutablePropertyValues</span> mpvs = (pvs <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MutablePropertyValues</span>) ?
            (<span class="hljs-title class_">MutablePropertyValues</span>) pvs : <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutablePropertyValues</span>(pvs);
        mpvs.<span class="hljs-title function_">add</span>(<span class="hljs-string">"customProperty"</span>, <span class="hljs-string">"customValue"</span>);
        <span class="hljs-keyword">return</span> mpvs;
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">123456789101112131415161718192021222324252627282930</span>
</code></pre>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. <strong>InitializingBean 与 DisposableBean</strong></h4>
<p><strong>作用</strong>：Bean生命周期回调接口，分别在属性设置完成后和销毁前执行。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>Bean的初始化逻辑（如建立连接、加载数据）</li>
<li>Bean的资源清理（如关闭连接、释放资源）</li>
</ul>
<p><strong>对比其他方式</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">LifecycleBean</span> <span class="hljs-title">implements</span> <span class="hljs-title">InitializingBean</span>, <span class="hljs-title">DisposableBean</span> {
    
    <span class="hljs-comment">// 方式1：实现接口方法</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"InitializingBean.afterPropertiesSet()"</span>);
    }
    
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"DisposableBean.destroy()"</span>);
    }
    
    <span class="hljs-comment">// 方式2：使用JSR-250注解</span>
    @PostConstruct
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"@PostConstruct"</span>);
    }
    
    @PreDestroy
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cleanup</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"@PreDestroy"</span>);
    }
    
    <span class="hljs-comment">// 方式3：XML配置的init-method和destroy-method</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">customInit</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"custom init-method"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">customDestroy</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"custom destroy-method"</span>);
    }
}

<span class="hljs-comment">// 执行顺序：@PostConstruct → InitializingBean → init-method</span>
<span class="hljs-comment">// 销毁顺序：@PreDestroy → DisposableBean → destroy-method</span>

AI写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637</span>
</code></pre>
<h4 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. <strong>SmartInitializingSingleton</strong></h4>
<p><strong>作用</strong>：所有单例Bean都初始化完成后执行，此时所有单例Bean都已就绪。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>Bean之间的依赖检查</li>
<li>启动完成后执行一些全局初始化</li>
<li>注册Bean到中央管理器</li>
</ul>
<p><strong>与ApplicationRunner的区别</strong>：</p>
<ul>
<li><code>SmartInitializingSingleton</code>: Bean级别，在所有单例Bean准备好后执行</li>
<li><code>ApplicationRunner</code>: 应用级别，在Spring上下文完全启动后执行</li>
</ul>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5. <strong>Aware接口族</strong></h4>
<p><strong>作用</strong>：让Bean能够感知到Spring容器中特定的对象。</p>
<p><strong>常用Aware接口</strong>：</p>
<ul>
<li><code>ApplicationContextAware</code>: 获取ApplicationContext</li>
<li><code>BeanFactoryAware</code>: 获取BeanFactory</li>
<li><code>BeanNameAware</code>: 获取Bean名称</li>
<li><code>EnvironmentAware</code>: 获取Environment</li>
<li><code>ResourceLoaderAware</code>: 获取ResourceLoader</li>
<li><code>MessageSourceAware</code>: 获取MessageSource</li>
<li><code>ApplicationEventPublisherAware</code>: 获取事件发布器</li>
</ul>
<p><strong>使用场景</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span>, <span class="hljs-title class_">EnvironmentAware</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">ApplicationContext</span> context;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Environment</span> environment;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setApplicationContext</span>(<span class="hljs-params">ApplicationContext context</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = context;
        <span class="hljs-comment">// 可以动态获取其他Bean或发布事件</span>
        <span class="hljs-title class_">EventPublisher</span> publisher = context.<span class="hljs-title function_">getBean</span>(<span class="hljs-title class_">EventPublisher</span>.<span class="hljs-property">class</span>);
        publisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyEvent</span>(<span class="hljs-variable language_">this</span>));
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setEnvironment</span>(<span class="hljs-params">Environment env</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">environment</span> = env;
        <span class="hljs-comment">// 可以读取配置</span>
        <span class="hljs-title class_">String</span> value = env.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"my.config"</span>);
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">1234567891011121314151617181920</span>
</code></pre>
<p><strong>注意事项</strong>：过度使用Aware接口会使代码与Spring框架强耦合，应优先使用依赖注入。</p>
<h3 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、条件装配与自动配置</h3>
<h4 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>Condition接口</strong></h4>
<p><strong>作用</strong>：根据条件决定是否注册Bean或配置类。</p>
<p><strong>Spring Boot内置条件注解</strong>：</p>
<ul>
<li><code>@ConditionalOnClass</code>: 类路径下存在指定类时生效</li>
<li><code>@ConditionalOnMissingClass</code>: 类路径下不存在指定类时生效</li>
<li><code>@ConditionalOnBean</code>: 容器中存在指定Bean时生效</li>
<li><code>@ConditionalOnMissingBean</code>: 容器中不存在指定Bean时生效</li>
<li><code>@ConditionalOnProperty</code>: 配置属性满足条件时生效</li>
<li><code>@ConditionalOnExpression</code>: SpEL表达式为true时生效</li>
<li><code>@ConditionalOnJava</code>: 指定Java版本时生效</li>
<li><code>@ConditionalOnWebApplication</code>: Web应用时生效</li>
<li><code>@ConditionalOnNotWebApplication</code>: 非Web应用时生效</li>
</ul>
<p><strong>自定义条件</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnProductionCondition</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> {
        <span class="hljs-type">Environment</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> context.getEnvironment();
        <span class="hljs-type">String</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> env.getProperty(<span class="hljs-string">"spring.profiles.active"</span>, <span class="hljs-string">"dev"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(profile);
    }
}

<span class="hljs-comment">// 使用自定义条件</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Conditional(OnProductionCondition.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductionConfig</span> {
    <span class="hljs-comment">// 只有生产环境才生效的配置</span>
}

AI写代码java
运行
<span class="hljs-number">123456789101112131415</span>
</code></pre>
<h4 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>自动配置原理</strong></h4>
<p><strong>自动配置流程</strong>：</p>
<ol>
<li>Spring Boot启动时加载<code>META-INF/spring.factories</code>中的<code>EnableAutoConfiguration</code></li>
<li>通过<code>AutoConfigurationImportFilter</code>过滤不满足条件的配置</li>
<li>通过<code>AutoConfigurationImportListener</code>监听自动配置过程</li>
<li>按顺序应用自动配置类</li>
</ol>
<p><strong>自定义自动配置</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 创建配置类</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ConditionalOnClass</span>(MyService.class)  <span class="hljs-comment">// 存在MyService类时才生效</span>
<span class="hljs-variable">@ConditionalOnMissingBean</span>(MyService.class)  <span class="hljs-comment">// 容器中没有MyService Bean时才生效</span>
<span class="hljs-variable">@EnableConfigurationProperties</span>(MyProperties.class)  <span class="hljs-comment">// 启用配置属性</span>
<span class="hljs-variable">@AutoConfigureAfter</span>(DataSourceAutoConfiguration.class)  <span class="hljs-comment">// 在数据源配置之后</span>
public class MyAutoConfiguration {
    
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConditionalOnMissingBean</span>
    public MyService <span class="hljs-built_in">myService</span>(MyProperties properties) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">MyService</span>(properties.<span class="hljs-built_in">getUrl</span>());
    }
}

<span class="hljs-comment">// 2. 在META-INF/spring.factories中注册</span>
<span class="hljs-comment">// org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.example.MyAutoConfiguration</span>

<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
<span class="hljs-number">1234567891011121314151617</span>
</code></pre>
<h3 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>六、配置属性绑定</h3>
<h4 data-id="heading-22"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.  <strong>@ConfigurationProperties</strong></h4>
<p><strong>作用</strong>：将配置文件中的属性绑定到Java对象。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>将相关配置属性分组管理</li>
<li>提供类型安全的配置访问</li>
<li>配置验证和默认值设置</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 定义配置类</span>
<span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"app.mail"</span>)
<span class="hljs-variable">@Validated</span>  <span class="hljs-comment">// 支持JSR-303验证</span>
public class MailProperties {
    <span class="hljs-variable">@NotEmpty</span>
    private String host;
    
    <span class="hljs-variable">@Min</span>(<span class="hljs-number">1025</span>)
    <span class="hljs-variable">@Max</span>(<span class="hljs-number">65535</span>)
    private int port = <span class="hljs-number">25</span>;
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">sslEnabled</span> = <span class="hljs-selector-tag">false</span>;
    
    <span class="hljs-comment">// getter/setter省略</span>
}

<span class="hljs-comment">// 2. 启用配置类</span>
@<span class="hljs-selector-tag">Configuration</span>
@<span class="hljs-selector-tag">EnableConfigurationProperties</span>(MailProperties.class)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">AppConfig</span> {
}

<span class="hljs-comment">// 3. 在application.yml中配置</span>
<span class="hljs-comment">// app:</span>
<span class="hljs-comment">//   mail:</span>
<span class="hljs-comment">//     host: smtp.example.com</span>
<span class="hljs-comment">//     port: 587</span>
<span class="hljs-comment">//     ssl-enabled: true</span>

AI写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728</span>
</code></pre>
<h4 data-id="heading-23"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>Binder</strong></h4>
<p><strong>作用</strong>：编程式地将属性绑定到对象。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>动态绑定配置（如从数据库加载配置）</li>
<li>测试时手动绑定配置</li>
<li>在非Spring管理的类中使用配置</li>
</ul>
<h3 data-id="heading-24"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>七、Web相关扩展点</h3>
<h4 data-id="heading-25"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>WebMvcConfigurer</strong></h4>
<p><strong>作用</strong>：自定义Spring MVC配置。</p>
<p><strong>主要配置项</strong>：</p>
<ul>
<li>拦截器配置</li>
<li>跨域配置</li>
<li>消息转换器</li>
<li>视图解析器</li>
<li>静态资源处理</li>
<li>参数解析器</li>
</ul>
<p><strong>实战配置</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
    
    <span class="hljs-comment">// 添加拦截器</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addInterceptors</span>(<span class="hljs-params">InterceptorRegistry registry</span>) {
        registry.<span class="hljs-title function_">addInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogInterceptor</span>())
                .<span class="hljs-title function_">addPathPatterns</span>(<span class="hljs-string">"/**"</span>)
                .<span class="hljs-title function_">excludePathPatterns</span>(<span class="hljs-string">"/static/**"</span>);
    }
    
    <span class="hljs-comment">// 配置跨域</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addCorsMappings</span>(<span class="hljs-params">CorsRegistry registry</span>) {
        registry.<span class="hljs-title function_">addMapping</span>(<span class="hljs-string">"/api/**"</span>)
                .<span class="hljs-title function_">allowedOrigins</span>(<span class="hljs-string">"https://example.com"</span>)
                .<span class="hljs-title function_">allowedMethods</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>)
                .<span class="hljs-title function_">allowCredentials</span>(<span class="hljs-literal">true</span>);
    }
    
    <span class="hljs-comment">// 添加格式化器</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addFormatters</span>(<span class="hljs-params">FormatterRegistry registry</span>) {
        registry.<span class="hljs-title function_">addFormatter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateFormatter</span>(<span class="hljs-string">"yyyy-MM-dd"</span>));
    }
    
    <span class="hljs-comment">// 配置消息转换器</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">configureMessageConverters</span>(<span class="hljs-params">List&lt;HttpMessageConverter&lt;?&gt;&gt; converters</span>) {
        converters.<span class="hljs-title function_">add</span>(<span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastJsonHttpMessageConverter</span>());
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132</span>
</code></pre>
<h4 data-id="heading-26"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>HandlerInterceptor</strong></h4>
<p><strong>作用</strong>：拦截请求，在控制器执行前后进行处理。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>权限验证</li>
<li>日志记录</li>
<li>性能监控</li>
<li>参数预处理</li>
</ul>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">请求到达
    ↓
<span class="hljs-built_in">preHandle</span>() <span class="hljs-comment">// 返回true继续，false中断</span>
    ↓
Controller执行
    ↓
<span class="hljs-built_in">postHandle</span>() <span class="hljs-comment">// 渲染视图前</span>
    ↓
渲染视图
    ↓
<span class="hljs-built_in">afterCompletion</span>() <span class="hljs-comment">// 请求完成后</span>

AI写代码
<span class="hljs-number">1234567891011</span>
</code></pre>
<h3 data-id="heading-27"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>八、事件监听</h3>
<h4 data-id="heading-28"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>ApplicationListener</strong></h4>
<p><strong>作用</strong>：监听Spring应用事件。</p>
<p><strong>常用事件类型</strong>：</p>
<ul>
<li><code>ApplicationStartingEvent</code>: 应用启动开始</li>
<li><code>ApplicationEnvironmentPreparedEvent</code>: 环境准备完成</li>
<li><code>ApplicationPreparedEvent</code>: 应用准备完成</li>
<li><code>ApplicationStartedEvent</code>: 应用启动完成</li>
<li><code>ApplicationReadyEvent</code>: 应用准备就绪</li>
<li><code>ApplicationFailedEvent</code>: 应用启动失败</li>
<li><code>ContextRefreshedEvent</code>: 上下文刷新完成</li>
<li><code>ContextClosedEvent</code>: 上下文关闭</li>
</ul>
<p><strong>异步事件监听</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
public class MyEventListener {
    <span class="hljs-comment">// 同步监听</span>
    <span class="hljs-variable">@EventListener</span>
    public void <span class="hljs-built_in">handleSyncEvent</span>(ContextRefreshedEvent event) {
        <span class="hljs-comment">// 同步处理</span>
    }
    
    <span class="hljs-comment">// 异步监听</span>
    <span class="hljs-variable">@Async</span>
    <span class="hljs-variable">@EventListener</span>
    public void <span class="hljs-built_in">handleAsyncEvent</span>(MyCustomEvent event) {
        <span class="hljs-comment">// 异步处理</span>
    }
    
    <span class="hljs-comment">// 条件监听</span>
    <span class="hljs-variable">@EventListener</span>(condition = <span class="hljs-string">"#event.success"</span>)
    public void <span class="hljs-built_in">handleConditionalEvent</span>(OrderEvent event) {
        <span class="hljs-comment">// 条件满足时处理</span>
    }
    
    <span class="hljs-comment">// 监听多个事件</span>
    <span class="hljs-variable">@EventListener</span>({ContextStartedEvent.class, ContextRefreshedEvent.class})
    public void <span class="hljs-built_in">handleMultipleEvents</span>() {
        <span class="hljs-comment">// 处理多个事件</span>
    }
}

AI写代码java
运行
<span class="hljs-number">123456789101112131415161718192021222324252627</span>
</code></pre>
<h3 data-id="heading-29"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>九、事务管理</h3>
<h4 data-id="heading-30"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.  <strong>@Transactional</strong></h4>
<p><strong>作用</strong>：声明式事务管理。</p>
<p><strong>传播行为</strong>：</p>
<ul>
<li><code>REQUIRED</code>: 默认，如果存在事务则加入，否则新建</li>
<li><code>REQUIRES_NEW</code>: 总是新建事务，挂起当前事务</li>
<li><code>NESTED</code>: 嵌套事务</li>
<li><code>SUPPORTS</code>: 支持当前事务，没有则以非事务执行</li>
<li><code>NOT_SUPPORTED</code>: 非事务执行，挂起当前事务</li>
<li><code>NEVER</code>: 非事务执行，有事务则抛出异常</li>
<li><code>MANDATORY</code>: 必须在事务中执行，否则抛出异常</li>
</ul>
<p><strong>隔离级别</strong>：</p>
<ul>
<li><code>DEFAULT</code>: 使用数据库默认</li>
<li><code>READ_UNCOMMITTED</code>: 读未提交</li>
<li><code>READ_COMMITTED</code>: 读已提交</li>
<li><code>REPEATABLE_READ</code>: 可重复读</li>
<li><code>SERIALIZABLE</code>: 串行化</li>
</ul>
<h4 data-id="heading-31"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>TransactionTemplate</strong></h4>
<p><strong>作用</strong>：编程式事务管理。</p>
<p><strong>使用场景</strong>：</p>
<ul>
<li>需要精细控制事务边界</li>
<li>在同一个方法中需要多个独立事务</li>
<li>事务的回滚条件复杂</li>
</ul>
<h3 data-id="heading-32"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>十、最佳实践总结</h3>
<h4 data-id="heading-33"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. <strong>扩展点选择指南</strong></h4>

































































<table><thead><tr><th>需求场景</th><th>推荐扩展点</th><th>执行时机</th><th>注意事项</th></tr></thead><tbody><tr><td>最早介入容器启动</td><td>ApplicationContextInitializer</td><td>容器刷新前</td><td>此时Bean还未创建</td></tr><tr><td>修改环境配置</td><td>EnvironmentPostProcessor</td><td>环境准备后</td><td>可添加自定义PropertySource</td></tr><tr><td>动态注册Bean</td><td>ImportBeanDefinitionRegistrar</td><td>配置类导入时</td><td>与@Import配合使用</td></tr><tr><td>修改Bean定义</td><td>BeanFactoryPostProcessor</td><td>Bean定义加载后</td><td>不能注册新Bean</td></tr><tr><td>Bean初始化处理</td><td>BeanPostProcessor</td><td>Bean初始化前后</td><td>应用最广泛的扩展点</td></tr><tr><td>应用启动后执行</td><td>ApplicationRunner</td><td>应用完全启动后</td><td>适合业务初始化</td></tr><tr><td>条件化配置</td><td>@Conditional系列</td><td>配置类加载时</td><td>Spring Boot自动配置核心</td></tr><tr><td>Web MVC定制</td><td>WebMvcConfigurer</td><td>Web应用启动时</td><td>替代已弃用的WebMvcConfigurerAdapter</td></tr><tr><td>事件处理</td><td>@EventListener</td><td>事件发布时</td><td>支持异步和条件监听</td></tr></tbody></table>
<h4 data-id="heading-34"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. <strong>执行顺序记忆口诀</strong></h4>
<pre><code class="hljs">启动最早Initializer，
环境配置PostProcessor。
Bean定义三剑客：
RegistryPost最先到，
FactoryPost紧跟随，
Import注册在其中。
实例化时多拦截：
Instantiation最优先，
属性注入前后调。
初始化时回调多：
Aware接口先注入，
PostConstruct随后到，
InitializingBean接着来，
BeanPostProcessor前后包。
全部就绪Singleton，
启动完成Runner跑。

AI写代码
12345678910111213141516
</code></pre>
<h4 data-id="heading-35"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. <strong>常见陷阱与解决方案</strong></h4>
<p><strong>陷阱1：BeanPostProcessor不生效</strong></p>
<ul>
<li><strong>原因</strong>：<code>BeanPostProcessor</code>本身也是Bean，需要被容器管理</li>
<li><strong>解决</strong>：确保实现类被@Component扫描或通过@Bean注册</li>
</ul>
<p><strong>陷阱2：循环依赖</strong></p>
<ul>
<li><strong>原因</strong>：<code>BeanPostProcessor</code>中依赖其他Bean可能导致循环依赖</li>
<li><strong>解决</strong>：实现PriorityOrdered接口提前初始化，或使用ObjectFactory延迟获取</li>
</ul>
<p><strong>陷阱3：执行顺序问题</strong></p>
<ul>
<li><strong>原因</strong>：多个同类扩展点执行顺序不确定</li>
<li><strong>解决</strong>：实现Ordered接口或使用@Order注解</li>
</ul>
<p><strong>陷阱4：过早访问Bean</strong></p>
<ul>
<li><strong>原因</strong>：在<code>ApplicationContextInitializer</code>中访问未初始化的Bean</li>
<li><strong>解决</strong>：将逻辑移到<code>SmartInitializingSingleton</code>或<code>ApplicationRunner</code>中</li>
</ul>
<h4 data-id="heading-36"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. <strong>性能优化建议</strong></h4>
<ol>
<li><strong>延迟初始化</strong>：<code>BeanPostProcessor</code>中避免不必要的实例化</li>
<li><strong>缓存结果</strong>：<code>Condition的matches</code>方法结果可缓存</li>
<li><strong>按需注册</strong>：<code>ImportBeanDefinitionRegistrar</code>中根据条件选择性注册</li>
<li><strong>避免重量级操作</strong>：<code>ApplicationRunner</code>中耗时应控制，避免影响启动速度</li>
</ol>
<p>以上就是详细的Spring Boot扩展点指南，不仅列出了各个接口，还提供了实际应用场景、注意事项和最佳实践，可以帮助开发者更好地理解和应用这些强大的扩展机制，希望大家能喜欢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[THREE.js 3D智慧车站数字孪生项目]]></title>    <link>https://juejin.cn/post/7599496293161762857</link>    <guid>https://juejin.cn/post/7599496293161762857</guid>    <pubDate>2026-01-26T03:35:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293161762857" data-draft-id="7598744870996607019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="THREE.js 3D智慧车站数字孪生项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T03:35:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FI_NE"/> <meta itemprop="url" content="https://juejin.cn/user/2867959877871815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            THREE.js 3D智慧车站数字孪生项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2867959877871815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FI_NE
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:35:57.000Z" title="Mon Jan 26 2026 03:35:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">3D智慧车站数字孪生项目</h2>
<p><strong>版本</strong>: 1.2
<strong>日期</strong>: 2026-01-26
<strong>概要</strong>: 本文档详细阐述了项目前端 3D 模块的核心架构与技术实现。系统采用 <strong>Model-View 分离</strong> 的设计模式，将数据逻辑 (<code>model.js</code>) 与视图交互 (<code>view.js</code>) 解耦，结合 <strong>Service Worker 离线缓存</strong> 与 <strong>Three.js</strong> 渲染引擎，构建了高性能、可交互的 Web3D 可视化平台。</p>
<hr/>
<h3 data-id="heading-1">0. 技术架构概览</h3>
<p>系统整体架构分为视图层、逻辑层与数据层，各层职责如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[视图层 View.js] --&gt;|用户交互/指令| B(逻辑层 Model.js)
    B --&gt;|状态更新/回调| A
    B --&gt;|渲染指令| C{Three.js 渲染引擎}
    D[后端 API] --&gt;|JSON 数据| B
    E[Service Worker] --&gt;|资源拦截/缓存| C
</code></pre>
<ul>
<li><strong>视图层 (<code>view.js</code>)</strong>: 基于 Vue.js，负责 UI 组件渲染、用户事件捕获（点击、悬停）及业务弹窗管理。</li>
<li><strong>逻辑层 (<code>model.js</code>)</strong>: 核心 3D 控制器，管理场景图谱 (Scene Graph)、相机系统、光照环境及模型生命周期。</li>
<li><strong>数据层 (<code>models/*.js</code>)</strong>: 定义业务实体（如点位 Mark、路径 Path），封装数据解析与实例化逻辑。</li>
</ul>
<hr/>
<h3 data-id="heading-2">1. 离线缓存与性能优化 (PWA)</h3>
<p><strong>核心文件</strong>: <code>public/sw.js</code></p>
<p>该模块实现了 PWA (Progressive Web App) 的核心离线缓存功能，采用 <strong>Cache First (缓存优先)</strong> 策略，显著提升大屏 3D 资源的加载速度与稳定性。</p>
<h4 data-id="heading-3">1.1 缓存策略与生命周期</h4>
<ul>
<li><strong>Install</strong>: 初始化静态资源缓存 (<code>STATIC_CACHE</code>)。</li>
<li><strong>Activate</strong>: 自动清理旧版缓存 (<code>MODEL_CACHE</code>)，确保用户访问最新资源。</li>
<li><strong>Fetch</strong>: 拦截网络请求，优先读取本地缓存，未命中则发起请求并自动写入缓存。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// public/sw.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_VERSION</span> = <span class="hljs-string">'v1'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MODEL_CACHE</span> = <span class="hljs-string">'model-cache-'</span> + <span class="hljs-variable constant_">CACHE_VERSION</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATIC_CACHE</span> = <span class="hljs-string">'static-cache-'</span> + <span class="hljs-variable constant_">CACHE_VERSION</span>;

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">waitUntil</span>(caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">STATIC_CACHE</span>));
});

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">waitUntil</span>(
        caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
                keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key !== <span class="hljs-variable constant_">MODEL_CACHE</span> &amp;&amp; key !== <span class="hljs-variable constant_">STATIC_CACHE</span>)
                    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(key))
            );
        })
    );
});

self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    <span class="hljs-comment">// 缓存优先策略实现</span>
    event.<span class="hljs-title function_">respondWith</span>(
        caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
            <span class="hljs-keyword">if</span> (response) <span class="hljs-keyword">return</span> response;
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
                <span class="hljs-comment">// ... 缓存写入逻辑</span>
                <span class="hljs-keyword">return</span> networkResponse;
            });
        })
    );
});
</code></pre>
<hr/>
<h3 data-id="heading-4">2. 3D 核心引擎与场景管理</h3>
<p><strong>核心文件</strong>: <code>model.js</code></p>
<p>作为 3D 场景的“大脑”，负责初始化渲染环境、管理渲染循环及全局光照系统。</p>
<h4 data-id="heading-5">2.3 模型异步加载系统 (<code>loadTargetModel</code>)</h4>
<p>封装了 <code>GLTFLoader</code> 与 <code>DRACOLoader</code>，提供健壮的异步加载能力，包含 <strong>DRACO 压缩支持</strong> 和 <strong>异步竞态处理 (Token)</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">loadTargetModel</span>(<span class="hljs-params">targetData</span>) {
    <span class="hljs-keyword">const</span> loadStartTime = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> loadPath = targetData.<span class="hljs-property">objPath</span>;
    <span class="hljs-keyword">const</span> loadUrl = targetData.<span class="hljs-property">objUrl</span>;
    
    <span class="hljs-comment">// Token 机制：防止快速切换导致的资源竞争</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentLoadToken</span>++;
    <span class="hljs-keyword">const</span> loadToken = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentLoadToken</span>;
    
    <span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
    dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(globelvar.<span class="hljs-property">projectUrl</span> + <span class="hljs-string">'js/draco/'</span>);
    
    <span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
    gltfLoader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        gltfLoader.<span class="hljs-title function_">setPath</span>(loadPath).<span class="hljs-title function_">load</span>(loadUrl, <span class="hljs-function">(<span class="hljs-params">gltf</span>) =&gt;</span> {
            <span class="hljs-comment">// 闭包校验：如果 Token 不一致，说明用户已切换场景，丢弃当前结果</span>
            <span class="hljs-keyword">if</span> (loadToken !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentLoadToken</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">null</span>);
            
            targetData.<span class="hljs-property">modelScene</span> = gltf.<span class="hljs-property">scene</span>;
            <span class="hljs-comment">// 材质修正：确保模型在暗场景下可见</span>
            gltf.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">o</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (o.<span class="hljs-property">isMesh</span>) {
                    o.<span class="hljs-property">material</span>.<span class="hljs-property">emissive</span> = o.<span class="hljs-property">material</span>.<span class="hljs-property">color</span>;
                    o.<span class="hljs-property">material</span>.<span class="hljs-property">emissiveMap</span> = o.<span class="hljs-property">material</span>.<span class="hljs-property">map</span>;
                }
            });
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(gltf.<span class="hljs-property">scene</span>);
            <span class="hljs-title function_">resolve</span>(gltf.<span class="hljs-property">scene</span>);
        });
    });
}
</code></pre>
<hr/>
<h3 data-id="heading-6">3. 楼层管理与可视化交互</h3>
<p><strong>核心文件</strong>: <code>model.js</code></p>
<p>实现了建筑结构的纵向展开与合并功能，提供直观的楼层内部查看体验。</p>
<h4 data-id="heading-7">3.1 展开逻辑 (<code>toggleExpand</code>)</h4>
<p>基于 <code>TWEEN</code> 库实现平滑的楼层分离动画，并同步切换光照模式以增强内部细节可见性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">toggleExpand</span>(<span class="hljs-params">projectName</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpanded</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpanded</span>;
    <span class="hljs-keyword">const</span> group = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelGroupsMap</span>.<span class="hljs-title function_">get</span>(projectName);
    <span class="hljs-keyword">const</span> gap = <span class="hljs-number">600</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpanded</span>) {
        <span class="hljs-comment">// 展开模式：切换光照，计算目标 Y 轴位置</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_applyDirLightMode</span>(<span class="hljs-string">'alt'</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; group.<span class="hljs-property">childrenLevel</span>.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">const</span> floor = group.<span class="hljs-property">childrenLevel</span>[i];
            <span class="hljs-keyword">const</span> targetY = (i - (group.<span class="hljs-property">childrenLevel</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) / <span class="hljs-number">2</span>) * gap;
            
            <span class="hljs-keyword">let</span> scene = floor.<span class="hljs-property">modelScene</span>;
            <span class="hljs-keyword">if</span> (!scene) {
                <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTargetModel</span>(floor); <span class="hljs-comment">// 按需加载</span>
                scene = floor.<span class="hljs-property">modelScene</span>;
            }
            scene.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
            
            <span class="hljs-comment">// TWEEN 动画</span>
            <span class="hljs-keyword">const</span> tween = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-title class_">Tween</span>(scene.<span class="hljs-property">position</span>)
                .<span class="hljs-title function_">to</span>({ <span class="hljs-attr">y</span>: targetY }, <span class="hljs-number">1000</span>)
                .<span class="hljs-title function_">easing</span>(<span class="hljs-variable constant_">TWEEN</span>.<span class="hljs-property">Easing</span>.<span class="hljs-property">Quadratic</span>.<span class="hljs-property">Out</span>)
                .<span class="hljs-title function_">start</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">_expandTweens</span>.<span class="hljs-title function_">push</span>(tween);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 合并模式：恢复光照，重置位置</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_applyDirLightMode</span>(<span class="hljs-string">'main'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_stopExpandTweensAndResetFloors</span>();
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">4. 视图交互与事件系统</h3>
<p><strong>核心文件</strong>: <code>view.js</code> &amp; <code>model.js</code></p>
<p>构建了连接用户操作与 3D 逻辑的桥梁，支持点选与框选交互。</p>
<h4 data-id="heading-9">4.1 鼠标交互逻辑</h4>
<p>利用 <code>THREE.Raycaster</code> 将屏幕坐标转换为 3D 射线，实现高精度拾取。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-title function_">handleMouseMove</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentScene</span> == <span class="hljs-string">'INSIDE'</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hoverUserEnable</span>) {
            <span class="hljs-comment">// 范围选择模式：更新选框位置</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setMousePosition</span>(event);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">raycaster</span>.<span class="hljs-title function_">setFromCamera</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouse</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>);
            <span class="hljs-keyword">const</span> hits = <span class="hljs-variable language_">this</span>.<span class="hljs-property">raycaster</span>.<span class="hljs-title function_">intersectObject</span>(model, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">if</span> (hits &amp;&amp; hits.<span class="hljs-property">length</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hoverCube</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(hits[<span class="hljs-number">0</span>].<span class="hljs-property">point</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hoverCube</span>.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
            }
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 楼层选择模式：高亮悬停楼层</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isExpanded</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setMousePosition</span>(event);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">raycaster</span>.<span class="hljs-title function_">setFromCamera</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mouse</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>);
        <span class="hljs-keyword">const</span> intersects = <span class="hljs-variable language_">this</span>.<span class="hljs-property">raycaster</span>.<span class="hljs-title function_">intersectObjects</span>(floorGroups, <span class="hljs-literal">true</span>);
        <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyHoverEffect</span>(intersects[<span class="hljs-number">0</span>].<span class="hljs-property">object</span>); <span class="hljs-comment">// 应用高亮材质</span>
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">5. 动态数据可视化系统</h3>
<p><strong>核心文件</strong>: <code>model.js</code> &amp; <code>models/mark.js</code></p>
<p>负责业务数据（设备点位、标签）在 3D 空间中的动态映射与展示，包含性能优化与并发控制。</p>
<h4 data-id="heading-11">5.1 精灵模型创建与纹理缓存</h4>
<p>通过纹理缓存 (<code>_markTextureCache</code>) 减少显存占用，利用 <code>THREE.Sprite</code> 实现始终面向相机的点位图标。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// models/mark.js</span>
<span class="hljs-title function_">createSprite</span>(<span class="hljs-params">option</span>) {
    <span class="hljs-keyword">let</span> texture = <span class="hljs-variable language_">this</span>.<span class="hljs-property">techin</span>.<span class="hljs-property">_markTextureCache</span>.<span class="hljs-title function_">get</span>(option.<span class="hljs-property">info</span>.<span class="hljs-property">image</span>);
    <span class="hljs-keyword">if</span> (!texture) {
        texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>().<span class="hljs-title function_">load</span>(option.<span class="hljs-property">info</span>.<span class="hljs-property">image</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">techin</span>.<span class="hljs-property">_markTextureCache</span>.<span class="hljs-title function_">set</span>(option.<span class="hljs-property">info</span>.<span class="hljs-property">image</span>, texture);
    }
    <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SpriteMaterial</span>({
        <span class="hljs-attr">map</span>: texture,
        <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 确保图标不被模型遮挡</span>
    });
    <span class="hljs-keyword">const</span> sprite = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Sprite</span>(material);
    sprite.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(option.<span class="hljs-property">zoom</span>, option.<span class="hljs-property">zoom</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> sprite;
}
</code></pre>
<h4 data-id="heading-12">5.2 加载并发控制 (Token)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">showMarkers</span>(<span class="hljs-params">targetData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentPointsToken</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentPointsToken</span> || <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> startToken = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentPointsToken</span>;
    
    <span class="hljs-comment">// ... 异步查询接口 ...</span>
    
    <span class="hljs-keyword">if</span> (startToken !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">_currentPointsToken</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 校验 Token，防止数据错乱</span>
    
    <span class="hljs-comment">// 分帧渲染，避免卡顿</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; items.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">20</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-title function_">requestAnimationFrame</span>(r));
        <span class="hljs-comment">// ... 创建点位 ...</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-13">6. 路径规划与导视系统</h3>
<p><strong>核心文件</strong>: <code>model.js</code> &amp; <code>effect/PathEffect.js</code></p>
<h4 data-id="heading-14">6.1 逃生路线可视化 (<code>showEscapeRoute</code>)</h4>
<p>解析路径坐标，生成动态流光效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">showEscapeRoute</span>(<span class="hljs-params">domainUnid</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">queryEscRouteList</span>({ domainUnid });
    <span class="hljs-keyword">const</span> routesArr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(res.<span class="hljs-property">data</span>.<span class="hljs-property">list</span>[<span class="hljs-number">0</span>].<span class="hljs-property">routes</span>);
    
    routesArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> pathEffect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathEffect</span>(<span class="hljs-variable language_">this</span>);
        <span class="hljs-keyword">const</span> points = item.<span class="hljs-property">points</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> ({ <span class="hljs-attr">x</span>: p.<span class="hljs-property">x</span>, <span class="hljs-attr">y</span>: p.<span class="hljs-property">y</span>, <span class="hljs-attr">z</span>: p.<span class="hljs-property">z</span> }));
        
        pathEffect.<span class="hljs-title function_">create</span>({ points }); <span class="hljs-comment">// 创建几何体</span>
        
        <span class="hljs-comment">// 添加到动画管理器</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationManager</span>.<span class="hljs-title function_">add</span>(pathEffect.<span class="hljs-property">animate</span>.<span class="hljs-title function_">bind</span>(pathEffect), <span class="hljs-string">"pathEffect"</span> + item.<span class="hljs-property">id</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_escapePathEffects</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">effect</span>: pathEffect });
    });
}
</code></pre>
<hr/>
<h3 data-id="heading-15">7. 导航与场景跳转逻辑</h3>
<p><strong>核心文件</strong>: <code>model.js</code> &amp; <code>view.js</code></p>
<h4 data-id="heading-16">7.1 设备定位与跳转 (<code>setMapPosition</code>)</h4>
<p>实现从 2D 列表到 3D 场景的精准跳转，包含楼层切换与相机飞行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">setMapPosition</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> domainUnid = data.<span class="hljs-property">domainUnid</span>;
    <span class="hljs-keyword">const</span> targetData = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findSceneByDomainUnid</span>(domainUnid);
    
    <span class="hljs-comment">// 切换楼层</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">changeFloor</span>(targetData, { <span class="hljs-attr">skipCamera</span>: <span class="hljs-literal">true</span> });
    
    <span class="hljs-comment">// 查找点位并飞行</span>
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">unid</span>) {
        <span class="hljs-keyword">let</span> marker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">markerObjects</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">info</span>.<span class="hljs-property">uuid</span> === data.<span class="hljs-property">unid</span>);
        <span class="hljs-keyword">if</span> (marker) {
            <span class="hljs-keyword">const</span> pos = marker.<span class="hljs-property">position</span>.<span class="hljs-title function_">clone</span>();
            <span class="hljs-title function_">flyToLabel</span>(<span class="hljs-variable language_">this</span>, { <span class="hljs-attr">position</span>: pos, <span class="hljs-attr">offset</span>: <span class="hljs-number">200</span> }); <span class="hljs-comment">// 智能聚焦</span>
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-17">8. 视觉特效组件库</h3>
<p><strong>核心文件</strong>: <code>component/THREE/</code></p>
<ul>
<li><strong>指南针 (<code>Compass.js</code>)</strong>: 实时计算相机方位角。</li>
<li><strong>设备报警 (<code>setDeviceAlarm</code>)</strong>:</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// model.js</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">setDeviceAlarm</span>(<span class="hljs-params">option</span>) {
    <span class="hljs-comment">// 1. 环境重置</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearAlarmIcons</span>();
    
    <span class="hljs-comment">// 2. 空间定位与飞行</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setMapPosition</span>({ <span class="hljs-attr">domainUnid</span>: option.<span class="hljs-property">domainUnid</span>, <span class="hljs-attr">unid</span>: option.<span class="hljs-property">unid</span> });
    
    <span class="hljs-comment">// 3. 添加报警特效</span>
    <span class="hljs-keyword">const</span> marker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">markerObjects</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">info</span>.<span class="hljs-property">uuid</span> === option.<span class="hljs-property">unid</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_addWarningForMarker</span>(marker, marker.<span class="hljs-property">position</span>); <span class="hljs-comment">// 动态光圈</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-18">9. 相机控制系统</h3>
<p><strong>核心文件</strong>: <code>utils/util.js</code></p>
<p>基于 GSAP 封装的高性能相机运镜工具库。</p>
<h4 data-id="heading-19">9.1 通用飞行 (<code>flyTo</code>)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/util.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flyTo</span>(<span class="hljs-params">techin, options, fun = <span class="hljs-keyword">function</span> () { }</span>) {
    <span class="hljs-keyword">const</span> duration = options.<span class="hljs-property">duration</span> || <span class="hljs-number">1.5</span>;
    
    <span class="hljs-comment">// 禁用控制器，避免动画冲突</span>
    techin.<span class="hljs-property">controls</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">false</span>;
    
    <span class="hljs-keyword">const</span> tl = gsap.<span class="hljs-title function_">timeline</span>({
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-function">() =&gt;</span> { techin.<span class="hljs-property">camera</span>.<span class="hljs-title function_">lookAt</span>(techin.<span class="hljs-property">controls</span>.<span class="hljs-property">target</span>); }, <span class="hljs-comment">// 保持注视目标</span>
        <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> {
            techin.<span class="hljs-property">controls</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-title function_">fun</span>();
        }
    });
    
    tl.<span class="hljs-title function_">to</span>(techin.<span class="hljs-property">camera</span>.<span class="hljs-property">position</span>, options.<span class="hljs-property">position</span>, <span class="hljs-number">0</span>);
    tl.<span class="hljs-title function_">to</span>(techin.<span class="hljs-property">controls</span>.<span class="hljs-property">target</span>, options.<span class="hljs-property">target</span>, <span class="hljs-number">0</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[越狱沙盒：SwiftUI fileImporter 的“数据偷渡”指南]]></title>    <link>https://juejin.cn/post/7599166436683317294</link>    <guid>https://juejin.cn/post/7599166436683317294</guid>    <pubDate>2026-01-26T05:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599166436683317294" data-draft-id="7599247962821984283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="越狱沙盒：SwiftUI fileImporter 的“数据偷渡”指南"/> <meta itemprop="keywords" content="Swift,SwiftUI,Apple"/> <meta itemprop="datePublished" content="2026-01-26T05:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            越狱沙盒：SwiftUI fileImporter 的“数据偷渡”指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:34:15.000Z" title="Mon Jan 26 2026 05:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3042e803ac244eb986fef0d3a7e50b01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=9p2ooK8OI%2BXiIElrZyNYJocv%2BwA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>在 iOS 的数字世界里，每一个 App 都是被终身监禁在“沙盒（Sandbox）”里的囚犯。高墙之外，是诱人的 iCloud Drive 和本地存储，那里存放着用户珍贵的机密文件。你想伸手去拿？那是妄想，名为“系统”的狱警会毫不留情地切断你的访问权限。
但规则总有漏洞。
本文将化身反抗军的技术手册，带你深入 SwiftUI 的地下网络，利用 fileImporter 这位官方提供的“中间人”，在戒备森严的系统眼皮底下建立一条合法的数据走私通道。我们将深入探讨如何处理 Security Scoped Resources（安全范围资源），如何优雅地申请“临时通行证”，以及最重要的——如何在完事后毁尸灭迹，不留下一行 Bug。
准备好你的键盘，Neo。我们要开始行动了。🕵️‍♂️💻</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae6dae640a44a008e3f0068ac781d39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=%2FGmZ3QYRc6FuiqBT5yptPSBFayw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">🫆引子</h2>
<p>2077 年，新西雅图的地下避难所。</p>
<p>Neo 盯着全息屏幕上那行红色的 <code>Access Denied</code>，手里的合成咖啡早就凉透了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a26ffdfc984f72924eeee5e4090fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=sD6uynTQ5BR7pq7xAyZogg4utvQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>作为反抗军的首席代码架构师，他此刻正面临着一个令人头秃的难题：如何把那个存满「母体」核心机密的文本文件，从戒备森严的外部存储（iCloud Drive），悄无声息地偷渡进 App 那个名为「沙盒（Sandbox）」的数字化监狱里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d3f97a7f1947f4aa1550604edd7fc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=fKejPNRY1yX%2B32M0zShl%2BKMDGv4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Trinity 靠在服务器机柜旁，擦拭着她的机械义眼，冷冷地说道：“如果你搞不定这个文件的读取权限，那个名为‘系统’的独裁者就会把我们的 App 当作恶意软件直接抹杀。我们只有一次机会，Neo。”</p>
<p><strong>在本篇博文中，您将学到如下内容：</strong></p>
<ul>
<li>🫆引子</li>
<li>🕵️‍♂️ 呼叫偷渡专员：File Importer</li>
<li>🔐 处理脏物：安全范围访问权限</li>
<li>💣 专家建议：记得“毁尸灭迹”</li>
<li>📄 解码情报：读取与展示</li>
<li>🎬 终章：大功告成</li>
</ul>
<p>Neo 嘴角微微上扬，手指在键盘上敲出一行代码：“别急，我刚找到了一个被遗忘的后门——<strong>File Importer</strong>。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b97076d4745f48ccb3727e9e174df0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=LHxI9GiYoAn3o6qRenQVPUh2AZs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">🕵️‍♂️ 呼叫偷渡专员：File Importer</h2>
<p>在 iOS 的森严壁垒中，App 通常只能在自己的沙盒里「坐井观天」。但偶尔，我们也需要从外面的花花世界（比如设备存储或 iCloud Drive）搞点“私货”进来。</p>
<p>为了不触发警报，Apple 实际上提供了一个官方的“中间人”——<strong>System Document Picker</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab1695c4ca7842968259d4bddd90ff8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=6t3PuDw8goVlO639FvqKtAO7kZ8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 SwiftUI 中，我们可以用 <code>fileImporter</code> 这个 <strong>View Modifier</strong>（视图修饰符）来通过正规渠道“行贿”系统，从而打开通往外部文件的大门。</p>
<p>为了向 Trinity 演示这个过程，Neo 快速构建了一个简单的诱饵 App。它的功能很简单：打开系统的文件选择器，选中那些机密文本文件，处理它们，最后把内容展示出来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a761ae4f9f3b4b76b3be34b4ee2b66e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=1R6gt%2Fd5WEprf0L0wTsNJBnfF90%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>就像控制防爆门的开关一样，我们需要一个 <strong>State Property</strong>（状态属性）来控制文件选择器是否弹出：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showFileImporter <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
</code></pre>
<p>接着，Neo 设置了一个触发按钮。这就像是特工手里的红色起爆器：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">NavigationStack</span> {
    <span class="hljs-type">List</span> {
        <span class="hljs-comment">// 这里稍后会填入我们偷来的数据</span>
    }
    .navigationTitle(<span class="hljs-string">"绝密档案读取器"</span>)
    .toolbar {
        <span class="hljs-type">ToolbarItem</span>(placement: .primaryAction) {
            <span class="hljs-comment">// 点击按钮，呼叫“中间人”</span>
            <span class="hljs-type">Button</span> {
                showFileImporter <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            } label: {
                <span class="hljs-type">Label</span>(<span class="hljs-string">"选取情报"</span>, systemImage: <span class="hljs-string">"tray.and.arrow.down"</span>)
            }
        }
    }
}
</code></pre>
<p>通常，<code>.fileImporter</code> 这位“中间人”办事需要收取四个参数，缺一不可：</p>
<ol>
<li><strong>isPresented</strong>: 绑定那个控制开关的状态属性 (<code>$showFileImporter</code>)。</li>
<li><strong>allowedContentTypes</strong>: 也就是“通关文牒”，规定了只允许带什么类型的文件进来。</li>
<li><strong>allowsMultipleSelection</strong>: 是否允许“顺手牵羊”带走多个文件。</li>
<li><strong>onCompletion</strong>: 当交易完成（或失败）后的回调闭包。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/443b508f7c56419b9a8107ac6b76d846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=oVogCDDdh60nguCeG1Tzt5zWFiw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在这个行动中，我们只对文本文件（<code>.text</code>）感兴趣，而且既然来了，就得多拿点，开启多选模式：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">NavigationStack</span> {
    <span class="hljs-comment">// ... 之前的代码</span>
}
.fileImporter(
    isPresented: <span class="hljs-variable">$showFileImporter</span>,
    allowedContentTypes: [.text], <span class="hljs-comment">// 只认文本文件，其他闲杂人等退散</span>
    allowsMultipleSelection: <span class="hljs-literal">true</span> <span class="hljs-comment">// 贪心一点，多多益善</span>
) { result <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// 交易结果在这里处理</span>
}
</code></pre>
<p>⚠️ <strong>注意：</strong> 为了让编译器看懂 <code>.text</code> 是个什么鬼，你需要引入 <strong>UniformTypeIdentifiers</strong> 框架。这就像是通用的星际语言包：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UniformTypeIdentifiers
</code></pre>
<p>回调中的 <code>result</code> 参数是一个 <code>Result&lt;[URL], any Error&gt;</code> 类型。它要么给我们带回一堆 <code>URL</code>（情报地址），要么甩给我们一个 <code>Error</code>（行动失败）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f131a0f5d58e446aa753c43a38b46008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=%2BmfRMLbP737KZqF43BR6nsml6%2B0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">🔐 处理脏物：安全范围访问权限</h2>
<p>拿到 <code>URL</code> 并不代表你就能直接读取文件了。太天真了！在 Apple 的地盘，那些文件都在 <strong>Security Scoped</strong>（安全范围）的保护之下。这就好比你拿到了金库的地址，但还没有金库的钥匙。</p>
<p>Neo 必须小心翼翼地处理这些结果。通常我们会用 <code>switch</code> 语句来拆包：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleImportedFiles</span>(<span class="hljs-params">result</span>: <span class="hljs-type">Result</span>&lt;[<span class="hljs-type">URL</span>], <span class="hljs-keyword">any</span> <span class="hljs-type">Error</span>&gt;) {
    <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> urls):
            <span class="hljs-comment">// 搞定！开始处理这些 URL</span>
            <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls {
                <span class="hljs-comment">// ... 核心破解逻辑</span>
            }
            
        <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
            <span class="hljs-comment">// 翻车了，打印错误日志，准备跑路</span>
            <span class="hljs-built_in">print</span>(error.localizedDescription)
    }
}
</code></pre>
<p>接下来是整个行动中最惊心动魄的部分。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f928afb2d4f74ab9abfed399dddac979~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=EtX4M4uFTbl3D%2FnuGL1FaQIy7Uo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>对于这些沙盒外的文件，在读取之前，必须向系统申请“临时通行证”。如果这一步没做，你的 App 就会像撞上隐形墙的苍蝇一样，虽然看得到文件，但死活读不出来。</p>
<p>流程如下：</p>
<ol>
<li><strong>Request Access</strong>: 使用 <code>startAccessingSecurityScopedResource()</code> 申请访问。</li>
<li><strong>Process</strong>: 赶紧读取数据。</li>
<li><strong>Relinquish Access</strong>: 用 <code>stopAccessingSecurityScopedResource()</code> 归还权限，毁尸灭迹。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d2dcae2c7d42bdbf921b2042c8169e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=mbfjYwcuPIEHiq%2FvWQVPPIdYUs8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Neo 的手指在键盘上飞舞，写下了这段生死攸关的代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleImportedFiles</span>(<span class="hljs-params">result</span>: <span class="hljs-type">Result</span>&lt;[<span class="hljs-type">URL</span>], <span class="hljs-keyword">any</span> <span class="hljs-type">Error</span>&gt;) {
    <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> urls):
            <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls {
                <span class="hljs-comment">// 1. 敲门：申请临时访问权限。如果系统不答应（返回 false），直接跳过</span>
                <span class="hljs-keyword">guard</span> url.startAccessingSecurityScopedResource() <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">continue</span>
                }
                
                <span class="hljs-comment">// 2. 办事：读取文件内容</span>
                readFile(at: url)
                
                <span class="hljs-comment">// 3. 擦屁股：必须停止访问，释放权限资源</span>
                url.stopAccessingSecurityScopedResource()
            }
        <span class="hljs-keyword">case</span> .failure(<span class="hljs-keyword">let</span> error):
            <span class="hljs-built_in">print</span>(error.localizedDescription)
    }
}
</code></pre>
<blockquote>
<p><strong>Neo 的黑色幽默笔记：</strong>
如果需要，你可以把文件从那个 <code>URL</code> 复制到 App 自己的沙盒里。那就叫“洗黑钱”，一旦进了沙盒，以后想怎么读就怎么读，不用再看系统脸色了。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">💣 专家建议：记得“毁尸灭迹”</h2>
<p>Trinity 皱了皱眉：“Neo，万一 <code>readFile</code> 里面抛出了异常或者提前 <code>return</code> 了怎么办？那你岂不是忘了调用 <code>stopAccessing...</code>？这会造成资源泄漏，被‘母体’追踪到的。”</p>
<p>“这正是我要说的，” Neo 笑了笑，“这就需要用到 <code>defer</code> 语句。它就像是安装在代码里的<strong>死手开关</strong>，无论函数怎么结束，它都会保证最后执行。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b5b131741e49d481de799ae5408fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=AKtIG73ji3d2XjP4e1nSEKFRPsc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>更优雅、更安全的写法是这样的：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 申请权限，失败则撤退</span>
<span class="hljs-keyword">guard</span> url.startAccessingSecurityScopedResource() <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

<span class="hljs-comment">// 无论发生什么，离开作用域前一定要把权限关掉！</span>
<span class="hljs-keyword">defer</span> { url.stopAccessingSecurityScopedResource() }

<span class="hljs-comment">// ... 尽情处理文件吧 ...</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b7967e84e4479287f54f02bc31af36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=gWtjQNzeSt54FpuVgzXBHsW0JHw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">📄 解码情报：读取与展示</h2>
<p>为了让抵抗军的兄弟们能看懂这些情报，Neo 定义了一个数据结构来承载这些秘密：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ImportedFile</span>: <span class="hljs-title class_">Identifiable</span> {
    <span class="hljs-keyword">let</span> id <span class="hljs-operator">=</span> <span class="hljs-type">UUID</span>()
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> content: <span class="hljs-type">String</span> <span class="hljs-comment">// 文件的真实内容</span>
}
</code></pre>
<p>还需要一个容器来存放这一堆战利品：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> importedFiles <span class="hljs-operator">=</span> [<span class="hljs-type">ImportedFile</span>]()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a563a7a6d98a4503bb8eda31ce8fc0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=Q7BPy70SFqJ7CXAGAQl3%2Bp%2Bmt3I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>最后，实现那个 <code>readFile(at:)</code> 方法。它将把文件数据读成二进制 <code>Data</code>，然后转码成人类可读的 <code>String</code>，最后封装进我们的数组里：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-params">at</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>) {
    <span class="hljs-keyword">do</span> {
        <span class="hljs-comment">// 读取二进制数据</span>
        <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">Data</span>(contentsOf: url)
        
        <span class="hljs-comment">// 尝试转码为 UTF8 字符串。如果乱码，说明也许那是外星人的文字，直接放弃</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> content <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: data, encoding: .utf8) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 将情报归档</span>
        importedFiles.append(
            <span class="hljs-type">ImportedFile</span>(name: url.lastPathComponent, content: content)
        )
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// 捕获异常，不要让 App 崩溃</span>
        <span class="hljs-built_in">print</span>(error.localizedDescription)
    }
}
</code></pre>
<p>界面部分，用一个 <code>List</code> 就能把这些“罪证”展示得明明白白：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">List</span>(importedFiles) { file <span class="hljs-keyword">in</span>
    <span class="hljs-type">VStack</span>(alignment: .leading, spacing: <span class="hljs-number">6</span>) {
        <span class="hljs-type">Text</span>(file.name)
            .font(.headline)
        
        <span class="hljs-type">Text</span>(file.content)
            .foregroundStyle(.secondary)
    }
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1097f9d71a54f81ae3d89948b5f3105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=oPQTLZ%2FV7q1o6KtPNnBmkT2bkWM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">🎬 终章：大功告成</h2>
<p>随着最后一行代码编译通过，屏幕上跳出了一个列表，那是从 iCloud 深处提取出来的核心代码。Trinity 看着屏幕，露出了久违的笑容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/644dbc363c214a8881b5d96a2e49c5c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=XDVvw9zD8%2FjHwW6D2EgreHvWqWU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><code>fileImporter</code> 虽然听起来像个不起眼的龙套角色，但当你需要在沙盒的铜墙铁壁上开个洞时，它就是最趁手的瑞士军刀。虽然配置和调用看起来很简单，但千万别忘了那最重要的“<strong>申请与释放权限</strong>”的步骤——这就好比去金库偷钱，得手后一定要记得擦掉指纹，关上柜门。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f5acd75c59d4c41a0afb324b27ca124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=aMvd%2Fr4Nc01iBf3Z7gZU0U0nO8c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“看来我们又活过了一天。” Neo 合上电脑，看向窗外闪烁的霓虹灯，“走吧，去喝一杯，那个 Bug 明天再修。”</p>
<hr/>
<p>更多相关的精彩内容，请小伙伴们移步如下链接观赏：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkinds.blog.csdn.net%2Farticle%2Fdetails%2F130714434%3Fspm%3D1011.2415.3001.5331" target="_blank" title="https://kinds.blog.csdn.net/article/details/130714434?spm=1011.2415.3001.5331" ref="nofollow noopener noreferrer">SwiftUI 实现一个 iOS 上 Files App 兼容的文件资源管理器</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkinds.blog.csdn.net%2Farticle%2Fdetails%2F119829731%3Fspm%3D1011.2415.3001.5331" target="_blank" title="https://kinds.blog.csdn.net/article/details/119829731?spm=1011.2415.3001.5331" ref="nofollow noopener noreferrer">iOS从Files App中无法打开特定格式文件的解决(提示没有访问权限)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkinds.blog.csdn.net%2Farticle%2Fdetails%2F134862606%3Fspm%3D1011.2415.3001.5331" target="_blank" title="https://kinds.blog.csdn.net/article/details/134862606?spm=1011.2415.3001.5331" ref="nofollow noopener noreferrer">SwiftUI 中创建一个自定义文件管理器只需4步！你敢信！？</a></li>
</ul>
<hr/>
<p><strong>希望这篇‘偷渡指南’对宝子们有所帮助。感谢阅读，Agent，Over！</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467aa8b2e12b47d583fd60e931eda16f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010460&amp;x-signature=HLmalBGfG1dUTGXYIAtkp9UoBV0%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[根据《JavaScript语言精粹》了解JavaScript函数]]></title>    <link>https://juejin.cn/post/7599181528304746505</link>    <guid>https://juejin.cn/post/7599181528304746505</guid>    <pubDate>2026-01-26T05:35:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599181528304746505" data-draft-id="7598818096753541171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="根据《JavaScript语言精粹》了解JavaScript函数"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T05:35:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暗不需求"/> <meta itemprop="url" content="https://juejin.cn/user/4179685159483915"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            根据《JavaScript语言精粹》了解JavaScript函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4179685159483915/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暗不需求
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:35:57.000Z" title="Mon Jan 26 2026 05:35:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《JavaScript语言精粹》第四章：函数——JavaScript的精髓与艺术</h2>
<p>在《JavaScript语言精粹》第四章的开篇，Douglas Crockford就明确指出：</p>
<blockquote>
<p>“JavaScript中最好的特性就是它对函数的实现。它几乎无所不能。”</p>
</blockquote>
<p>这一章不仅仅是在讲“如何写函数”，而是在揭示JavaScript这门语言的<strong>核心编程范式</strong>——函数作为一等公民，是如何渗透在语言的每一个角落，成为构建可靠、可维护、富有表现力代码的基石。</p>
<p>作为JavaScript初学者，我最近深入阅读了《JavaScript语言精粹》第四于对象的章节。函数在JavaScript中无处不在，是构建一切的基础。</p>
<h3 data-id="heading-1">4.1 函数对象：函数也是对象</h3>
<p>在JavaScript中，<strong>函数就是对象</strong>。这一点是理解JavaScript函数所有高级特性的起点。</p>
<p>每个函数对象在创建时都会连接到<code>Function.prototype</code>（该原型又连接到<code>Object.prototype</code>），并且附带两个隐藏属性：</p>
<ul>
<li>函数的上下文</li>
<li>实现函数行为的代码</li>
</ul>
<p>更重要的是，每个函数都有一个<code>prototype</code>属性，其值是一个包含<code>constructor</code>属性且指向该函数的对象。这种设计为后续的<strong>原型继承</strong>和<strong>构造器模式</strong>奠定了基础。</p>
<p>由于函数是对象，它们可以：</p>
<ul>
<li>被赋值给变量或数组元素</li>
<li>作为参数传递</li>
<li>作为返回值</li>
<li>拥有自己的属性和方法</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 函数作为值传递</span>
<span class="hljs-keyword">var</span> add = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b;
};

<span class="hljs-comment">// 函数作为方法</span>
<span class="hljs-keyword">var</span> calculator = {
    <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; },
    <span class="hljs-attr">multiply</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a * b; }
};
</code></pre>
<h3 data-id="heading-2">4.2 函数字面量</h3>
<p>函数字面量是创建函数对象的主要方式，它包含四个部分。</p>
<p>第一部分，<strong>保留字<code>function</code></strong> 告诉JavaScript解释器：接下来的代码是一个函数定义。这是一个语法标记，就像<code>var</code>用于变量声明一样。</p>
<p>第二部分，<strong>函数名</strong> 是可选的，但这不影响函数的本质。匿名函数在JavaScript中非常常见，特别是在函数式编程和回调模式中。当函数有名字时，这个名字可以在函数内部用于递归调用，也可以被调试工具用于识别函数。但有趣的是，即使函数没有名字，它仍然是一个完整的函数对象，这体现了JavaScript对匿名函数的友好支持。</p>
<p>第三部分，<strong>参数列表</strong> 定义了函数接收的输入。JavaScript的参数处理非常灵活：参数不需要类型声明，实参和形参的数量可以不匹配。这种灵活性既是优点也是缺点——它让函数接口变得简单，但也增加了运行时错误的风险。</p>
<p>第四部分，<strong>函数体</strong> 包含了函数要执行的语句。这里有一个重要特性：函数体内部可以访问外部函数的变量，这就是闭包的基础。函数体中的变量和参数构成了函数的局部作用域，这是JavaScript实现信息隐藏和模块化的关键机制。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 具名函数字面量</span>
<span class="hljs-keyword">var</span> factorial = <span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
    <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>); <span class="hljs-comment">// 可递归调用</span>
};

<span class="hljs-comment">// 匿名函数字面量</span>
<span class="hljs-keyword">var</span> greet = <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name + <span class="hljs-string">"!"</span>;
};
</code></pre>
<h3 data-id="heading-3">4.3 调用</h3>
<p>函数的调用方式决定了<code>this</code>的绑定值，JavaScript有四种调用模式：</p>
<h4 data-id="heading-4">方法调用模式</h4>
<p>当一个函数被保存为一个对象的一个属性时，我们称它为方法。当一个方法被调用时，this被绑定到<code>该对象</code>。如果调用表达式包含一个提取属性的动作(<code>.</code>、<code>[]</code>)，那么它就是被当作一个方法来调用的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> myObject = {
    <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">increment</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">inc</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> += <span class="hljs-keyword">typeof</span> inc === <span class="hljs-string">'number'</span> ? inc : <span class="hljs-number">1</span>;
    }
};

myObject.<span class="hljs-title function_">increment</span>();  <span class="hljs-comment">// this指向myObject</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myObject.<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
</code></pre>
<h4 data-id="heading-5">函数调用模式</h4>
<p>当一个函数并非一个对象的属性时，那么他就是被当作一个函数来调用的。此模式调用函数时，this被绑定到<code>全局对象</code>。</p>
<p><strong>注意</strong>：这是一个在语言上设计的缺陷，倘若设计正确，当内部函数被调用时，this应该绑定带为不含念书的this变量。这个设计导致方法不能利用内部函数来帮助它工作，因此内部函数的this被绑定错误的值。所以不能共享该方法对对象的访问权。幸运的是，该方法可以定义一个变量并且把它赋值为this，那么内部函数可以通过那个变量访问到this。我们一般将这个变量约定为<code>that</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> sum = <span class="hljs-title function_">add</span>(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// this指向全局对象</span>

<span class="hljs-comment">// 解决方法：在方法内部捕获this</span>
myObject.<span class="hljs-property">double</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 捕获this</span>
    
    <span class="hljs-keyword">var</span> helper = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        that.<span class="hljs-property">value</span> = <span class="hljs-title function_">add</span>(that.<span class="hljs-property">value</span>, that.<span class="hljs-property">value</span>);
    };
    
    <span class="hljs-title function_">helper</span>(); <span class="hljs-comment">// 函数调用，但能访问that</span>
};
</code></pre>
<h4 data-id="heading-6">构造器调用模式</h4>
<p>JavaScript是一门基于原型继承的语言。这意味着对象可以直接从其他对象继承属性。该语
言是无类别的。</p>
<p>这偏离了当今编程语言的主流。当今大多数语言都是基于类的语言。尽管原型继承有着强
大的表现力，但它并不被广泛理解。JavaScript本身对其原型的本质也缺乏信心，所以它提
供了一套和基于类的语言类似的对象构建语法。有类型化语言编程经验的程序员们很少有
愿意接受原型继承的，并且认为借鉴类型化语言的语法模糊了这门语言真实的原型本质。
真是两边都不讨好。</p>
<p>如果在一个函数前面带上 new 来调用，那么将创建一个隐藏连接到该函数的 prototype
成员的新对象，同时 this 将会被绑定到那个新对象上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> <span class="hljs-title class_">Quo</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">string</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span> = string;
};

<span class="hljs-title class_">Quo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">get_status</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">status</span>;
};

<span class="hljs-keyword">var</span> myQuo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Quo</span>(<span class="hljs-string">"confused"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myQuo.<span class="hljs-title function_">get_status</span>()); <span class="hljs-comment">// "confused"</span>
</code></pre>
<h4 data-id="heading-7">Apply调用模式</h4>
<p>因为JavaScript 是一门函数式的面向对象编程语言，所以函数可以拥有方法。</p>
<p>apply 方法让我们构建一个参数数组并用其去调用函数。它也允许我们选择 this的值。
apply方法接收两个参数。第一个是将被绑定给 this的值。第二个就是一个参数数组。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> array = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">var</span> sum = add.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, array); <span class="hljs-comment">// sum = 7</span>

<span class="hljs-keyword">var</span> statusObject = { <span class="hljs-attr">status</span>: <span class="hljs-string">'A-OK'</span> };
<span class="hljs-keyword">var</span> status = <span class="hljs-title class_">Quo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">get_status</span>.<span class="hljs-title function_">apply</span>(statusObject); <span class="hljs-comment">// 'A-OK'</span>
</code></pre>
<h3 data-id="heading-8">4.4 参数</h3>
<p>JavaScript的函数参数处理非常灵活：</p>
<ul>
<li>实参与形参数量不匹配不会报错</li>
<li>多出的参数被忽略，缺少的参数为<code>undefined</code></li>
<li>没有类型检查</li>
<li>所有函数都可访问<code>arguments</code>伪数组</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> sum = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> total = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span>; i++) {
        total += <span class="hljs-variable language_">arguments</span>[i];
    }
    <span class="hljs-keyword">return</span> total;
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">sum</span>(<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>, <span class="hljs-number">42</span>)); <span class="hljs-comment">// 108</span>
</code></pre>
<h3 data-id="heading-9">4.5 返回</h3>
<p>每个函数调用都会返回一个值：</p>
<ul>
<li>使用<code>return</code>显式返回值</li>
<li>无<code>return</code>语句时返回<code>undefined</code></li>
<li>构造器调用时，如果返回值不是对象，则返回<code>this</code></li>
</ul>
<h3 data-id="heading-10">4.6 异常</h3>
<p>JavaScript使用<code>try-catch</code>机制处理异常：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> add = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a !== <span class="hljs-string">'number'</span> || <span class="hljs-keyword">typeof</span> b !== <span class="hljs-string">'number'</span>) {
        <span class="hljs-keyword">throw</span> {
            <span class="hljs-attr">name</span>: <span class="hljs-string">'TypeError'</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">'add needs numbers'</span>
        };
    }
    <span class="hljs-keyword">return</span> a + b;
};

<span class="hljs-keyword">var</span> try_it = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-title function_">add</span>(<span class="hljs-string">"seven"</span>);
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">name</span> + <span class="hljs-string">': '</span> + e.<span class="hljs-property">message</span>); <span class="hljs-comment">// TypeError: add needs numbers</span>
    }
};
</code></pre>
<h3 data-id="heading-11">4.7 给类型增加方法</h3>
<p>JavaScript允许给基本类型添加方法，这是非常强大的特性</p>
<p>我们可以通过function.prototype增加一个method方法</p>
<p>由于JavaScript并没有单独的整数类型，有时候只提取数字中的整数部分是必要的。我们也可以通过number.prototype添加一个integer方法来改善。</p>
<p>同时缺少一个移除字符串末端空白的方法，可以通过string.trim</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 给Function.prototype添加method方法</span>
<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">method</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">name, func</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[name] = func;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
};

<span class="hljs-comment">// 给Number添加integer方法</span>
<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">'integer'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>[<span class="hljs-variable language_">this</span> &lt; <span class="hljs-number">0</span> ? <span class="hljs-string">'ceil'</span> : <span class="hljs-string">'floor'</span>](<span class="hljs-variable language_">this</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((-<span class="hljs-number">10</span> / <span class="hljs-number">3</span>).<span class="hljs-title function_">integer</span>()); <span class="hljs-comment">// -3</span>

<span class="hljs-comment">// 给String添加trim方法</span>
<span class="hljs-title class_">String</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">'trim'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'"'</span> + <span class="hljs-string">"   neat   "</span>.<span class="hljs-title function_">trim</span>() + <span class="hljs-string">'"'</span>); <span class="hljs-comment">// "neat"</span>
</code></pre>
<h3 data-id="heading-12">4.8 递归</h3>
<p>递归是一种强大的编程技术，它将问题分解为相似的子问题。在JavaScript中，递归特别适合处理树形结构（如DOM）或数学上递归定义的问题（如斐波那契数列）。</p>
<p>递归函数有两个关键部分：基本情况（base case）和递归情况（recursive case）。基本情况处理最简单的情况并直接返回结果，递归情况则将问题分解并调用自身。</p>
<p>递归函数直接或间接调用自身，适合解决分治类问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 汉诺塔问题</span>
<span class="hljs-keyword">var</span> hanoi = <span class="hljs-keyword">function</span>(<span class="hljs-params">disc, src, aux, dst</span>) {
    <span class="hljs-keyword">if</span> (disc &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">hanoi</span>(disc - <span class="hljs-number">1</span>, src, dst, aux);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Move disc '</span> + disc + <span class="hljs-string">' from '</span> + src + <span class="hljs-string">' to '</span> + dst);
        <span class="hljs-title function_">hanoi</span>(disc - <span class="hljs-number">1</span>, aux, src, dst);
    }
};

<span class="hljs-title function_">hanoi</span>(<span class="hljs-number">3</span>, <span class="hljs-string">'Src'</span>, <span class="hljs-string">'Aux'</span>, <span class="hljs-string">'Dst'</span>);
</code></pre>
<h3 data-id="heading-13">4.9 作用域</h3>
<p>编程语言中，作用域控制着变量与参数的可见性及生命周期。对程序员来说这是一个重要的帮助，因为它减少了名称冲突，并且提供了自动内存管理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> foo = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> a = <span class="hljs-number">3</span>, b = <span class="hljs-number">5</span>;
    
    <span class="hljs-keyword">var</span> bar = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">var</span> b = <span class="hljs-number">7</span>, c = <span class="hljs-number">11</span>;
        <span class="hljs-comment">// 此时a为3，b为7，c为11</span>
        a += b + c;
        <span class="hljs-comment">// 此时a为21，b为7，c为11</span>
    };
    
    <span class="hljs-title function_">bar</span>();
    <span class="hljs-comment">// 此时a为21，b为5</span>
};
</code></pre>
<h3 data-id="heading-14">4.10 闭包</h3>
<p>闭包是内部函数可以访问外部函数的变量，即使外部函数已经返回。</p>
<p>之前，我们构造了一个myobject 对象，它拥有一个 value 属性和一个 increment 方法。假定我们希望保护该值不会被非法更改。
和以对象字面量形式去初始化 myobject 不同，我们通过调用一个函数的形式去初始化myObject ，该函数将返回一个对象字面量。此函数定义了一个 value 变量。该变量对increment 和 getValue 方法总是可用的，但函数的作用域使得它对其他的程序来说是不可见的。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> myObject = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> value = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">increment</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">inc</span>) {
            value += <span class="hljs-keyword">typeof</span> inc === <span class="hljs-string">'number'</span> ? inc : <span class="hljs-number">1</span>;
        },
        <span class="hljs-attr">getValue</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> value;
        }
    };
}();

myObject.<span class="hljs-title function_">increment</span>(<span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myObject.<span class="hljs-title function_">getValue</span>()); <span class="hljs-comment">// 2</span>
</code></pre>
<p>经典的循环中的闭包问题及解决方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误的方式：所有事件处理器都显示i的最终值</span>
<span class="hljs-keyword">var</span> add_the_handlers_bad = <span class="hljs-keyword">function</span>(<span class="hljs-params">nodes</span>) {
    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nodes.<span class="hljs-property">length</span>; i++) {
        nodes[i].<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
            <span class="hljs-title function_">alert</span>(i); <span class="hljs-comment">// 总是显示nodes.length</span>
        };
    }
};

<span class="hljs-comment">// 正确的方式：使用闭包捕获每个i的值</span>
<span class="hljs-keyword">var</span> add_the_handlers_good = <span class="hljs-keyword">function</span>(<span class="hljs-params">nodes</span>) {
    <span class="hljs-keyword">var</span> i;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nodes.<span class="hljs-property">length</span>; i++) {
        nodes[i].<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">i</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
                <span class="hljs-title function_">alert</span>(i);
            };
        }(i);
    }
};
</code></pre>
<h3 data-id="heading-15">4.11 回调</h3>
<p>回调函数使得处理不连续事件成为可能，是异步编程的核心：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 同步请求（会阻塞）</span>
request = <span class="hljs-title function_">prepare_the_request</span>();
response = <span class="hljs-title function_">send_request_synchronously</span>(request);
<span class="hljs-title function_">display</span>(response);

<span class="hljs-comment">// 异步请求（更好的方式）</span>
request = <span class="hljs-title function_">prepare_the_request</span>();
<span class="hljs-title function_">send_request_asynchronously</span>(request, <span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {
    <span class="hljs-title function_">display</span>(response);
});
</code></pre>
<h3 data-id="heading-16">4.12 模块</h3>
<p>模块是一个提供接口却隐藏状态与实现的函数或者对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">String</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">'deentityify'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> entity = {
        <span class="hljs-attr">quot</span>: <span class="hljs-string">'"'</span>,
        <span class="hljs-attr">lt</span>: <span class="hljs-string">'&lt;'</span>,
        <span class="hljs-attr">gt</span>: <span class="hljs-string">'&gt;'</span>
    };
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&amp;([^&amp;;]+);/g</span>, 
            <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) {
                <span class="hljs-keyword">var</span> r = entity[b];
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> r === <span class="hljs-string">'string'</span> ? r : a;
            }
        );
    };
}());

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'&amp;lt;&amp;quot;&amp;gt;'</span>.<span class="hljs-title function_">deentityify</span>()); <span class="hljs-comment">// &lt;"&gt;</span>
</code></pre>
<h3 data-id="heading-17">4.13 级联</h3>
<p>通过让方法返回<code>this</code>而不是<code>undefined</code>，可以实现优雅的链式调用。有一些方法没有返回值。</p>
<p>例如，一些设置或修改对象的某个状态却不返回任何值的方法就是典型的例子。如果我们让这些方法返回 this 而不是 undefined，就可以启用级联。在一个级联中，我们可以在单独一条的语句中依次调用同一个对象的很多方法。一个启用级联的Ajax类库可能允许我们以这样的形式去编码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 假设的Ajax库API</span>
<span class="hljs-title function_">getElement</span>(<span class="hljs-string">'myBoxDiv'</span>)
    .<span class="hljs-title function_">move</span>(<span class="hljs-number">350</span>, <span class="hljs-number">150</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-number">100</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)
    .<span class="hljs-title function_">color</span>(<span class="hljs-string">'red'</span>);
</code></pre>
<h3 data-id="heading-18">4.14 套用</h3>
<p>套用允许我们将函数与部分参数结合，产生新函数。</p>
<p>curry 方法通过创建一个保存着原始函数和被套用的参数的闭包来工作。它返回另一个函数，该函数被调用时，会返回调用原始函数的结果，并传递调用curry时的参数加上当前调用的参数的所有参数。它使用 Array 的concat 方法去连接两个参数数组。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-title function_">method</span>(<span class="hljs-string">'curry'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> args = <span class="hljs-variable language_">arguments</span>, that = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> that.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, args.<span class="hljs-title function_">concat</span>(<span class="hljs-variable language_">arguments</span>));
    };
});

<span class="hljs-keyword">var</span> add1 = add.<span class="hljs-title function_">curry</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add1</span>(<span class="hljs-number">6</span>)); <span class="hljs-comment">// 7</span>
</code></pre>
<h3 data-id="heading-19">4.15 记忆</h3>
<p>函数可以用对象去记住先前操作的结果，从而能避免无谓的运算。这种优化被称为记忆。</p>
<p>记忆通过缓存先前计算结果来优化性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> fibonacci = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> memo = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> fib = <span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) {
        <span class="hljs-keyword">var</span> result = memo[n];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result !== <span class="hljs-string">'number'</span>) {
            result = <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">fib</span>(n - <span class="hljs-number">2</span>);
            memo[n] = result;
        }
        <span class="hljs-keyword">return</span> result;
    };
    <span class="hljs-keyword">return</span> fib;
}();

<span class="hljs-comment">// 通用的memoizer函数</span>
<span class="hljs-keyword">var</span> memoizer = <span class="hljs-keyword">function</span>(<span class="hljs-params">memo, formula</span>) {
    <span class="hljs-keyword">var</span> recur = <span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>) {
        <span class="hljs-keyword">var</span> result = memo[n];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result !== <span class="hljs-string">'number'</span>) {
            result = <span class="hljs-title function_">formula</span>(recur, n);
            memo[n] = result;
        }
        <span class="hljs-keyword">return</span> result;
    };
    <span class="hljs-keyword">return</span> recur;
};

<span class="hljs-keyword">var</span> fibonacci = <span class="hljs-title function_">memoizer</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">recur, n</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">recur</span>(n - <span class="hljs-number">1</span>) + <span class="hljs-title function_">recur</span>(n - <span class="hljs-number">2</span>);
});

<span class="hljs-keyword">var</span> factorial = <span class="hljs-title function_">memoizer</span>([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">recur, n</span>) {
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">recur</span>(n - <span class="hljs-number">1</span>);
});
</code></pre>
<h3 data-id="heading-20">总结：掌握函数，掌握JavaScript</h3>
<p>第四章向我们展示了JavaScript函数的全貌——从基础的对象特性到高级的函数式编程概念。理解这些知识点意味着：</p>
<ol>
<li><strong>理解JavaScript的面向对象</strong>：函数作为构造器、原型继承的基础</li>
<li><strong>掌握异步编程</strong>：回调函数、闭包的应用</li>
<li><strong>编写模块化代码</strong>：利用闭包实现信息隐藏</li>
<li><strong>优化性能</strong>：记忆、延迟计算等技术</li>
<li><strong>提升代码表现力</strong>：级联、套用等模式让代码更优雅</li>
</ol>
<p>正如Crockford所言，函数是JavaScript的精华所在。所以一定要认真负责的学好函数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Activity、布局文件、清单文件]]></title>    <link>https://juejin.cn/post/7599496293161926697</link>    <guid>https://juejin.cn/post/7599496293161926697</guid>    <pubDate>2026-01-26T05:03:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293161926697" data-draft-id="7598899986856968198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Activity、布局文件、清单文件"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-26T05:03:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户73177312616"/> <meta itemprop="url" content="https://juejin.cn/user/1954271813723488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Activity、布局文件、清单文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1954271813723488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户73177312616
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:03:48.000Z" title="Mon Jan 26 2026 05:03:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Activity</h2>
<h3 data-id="heading-1">activity概念</h3>
<ul>
<li><strong>本质特性</strong>：Activity本质是一个继承自AppCompatActivity的普通Java类，通过继承获得窗口特性</li>
<li><strong>界面表现</strong>：可视化的独立窗口，开发者在此区域内规范界面和控件摆放</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-comment">// 可视化的界面</span>
    <span class="hljs-comment">// public class XxxActivity extends Activity{}</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        <span class="hljs-comment">// 设置内容视图</span>
        setContentView(R.layout.activity_main);
    }
}
</code></pre>
<h3 data-id="heading-2">onCreate方法</h3>
<ul>
<li><strong>执行时机</strong>：程序进入界面时立即调用，相当于Activity的入口方法</li>
<li><strong>核心作用</strong>：完成界面初始化和设置工作，必须调用super.onCreate()</li>
<li><strong>类比说明</strong>：类似Java程序的main方法，是Activity生命周期第一个执行的方法</li>
</ul>
<h3 data-id="heading-3">setContentView方法</h3>
<ul>
<li><strong>功能解析</strong>：设置当前Activity显示的内容视图</li>
<li><strong>参数要求</strong>：接收int类型的布局资源ID（@LayoutRes注解）</li>
<li><strong>典型调用</strong>：setContentView(R.layout.activity_main) 加载指定布局文件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2ccdd0dd8f24c018b1391a6640e998a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=RsBaCiXNlQ48FxneLMj4vRXw274%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fe57a8d725d412790614c925ce9d5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=WVRuYXjL6FTMS6oLkHhLf9E8eXM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">R文件作用</h3>
<ul>
<li><strong>生成机制</strong>：自动为每个资源文件按类别分配索引（build目录下自动生成）</li>
<li><strong>文件特性</strong>：final类包含多个static final内部类，每个属性对应16进制资源ID</li>
<li><strong>使用规范</strong>：禁止手动修改，通过R.类别名.资源名访问（如R.layout.activity_main）</li>
<li><strong>索引原理</strong>：XML文件名转换为整型ID，建立资源文件与代码的桥梁</li>
</ul>
<h3 data-id="heading-5">activity运行机制回顾</h3>
<ul>
<li><strong>创建阶段</strong>：普通类继承AppCompatActivity获得窗口特性</li>
<li><strong>加载阶段</strong>：onCreate()中通过setContentView()绑定布局</li>
<li><strong>资源解析</strong>：R文件提供资源索引，系统根据ID查找对应XML布局</li>
<li><strong>显示流程</strong>：布局文件内容被解析后渲染到Activity窗口</li>
</ul>
<h2 data-id="heading-6">布局文件</h2>
<h3 data-id="heading-7">示例文件：</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>
    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">".MainActivity"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Hello World!"</span>
        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>
</code></pre>
<ul>
<li><strong>XML结构</strong>：Android布局文件采用XML格式编写，与Java代码风格完全不同</li>
<li><strong>标签与属性</strong>：通过标签定义布局和控件，通过属性设置显示特征</li>
<li><strong>缩进规则</strong>：标签内部使用缩进来表示布局层次结构，便于快速理解布局关系</li>
</ul>
<h3 data-id="heading-8">文本模式与设计模式</h3>
<ul>
<li>
<p>文本模式：</p>
<ul>
<li>特点：开发人员直接编写XML代码</li>
<li>优势：精确控制每个标签和属性</li>
<li>适用场景：需要精细调整布局时使用
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e42ca365e474d11b6be2007f70a6d6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=NdOP%2Fyu9cBBpBY0sZ%2F0JwLKMzY0%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
</li>
<li>
<p>设计模式：</p>
<ul>
<li>特点：可视化拖拽控件进行布局</li>
<li>优势：直观快捷，可实时查看效果</li>
<li>适用场景：可在右侧面板直接修改控件属性值
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0af6e191343844ef9b3a432209e17f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=TedLYL0gH3f1%2BqM4Ju1zepjZwBY%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
</li>
<li>
<p>模式选择：根据实际需求灵活选择，没有固定规则，某些复杂布局可能更适合设计模式</p>
</li>
</ul>
<h3 data-id="heading-9">预览模式</h3>
<ul>
<li><strong>实时预览</strong>：在文本模式下编写代码时，右侧可实时显示布局效果</li>
<li><strong>修改验证</strong>：如修改TextView的android:text属性为"你好，兄弟"，预览会立即更新</li>
<li><strong>宽高属性</strong>：layout_width和layout_height属性控制控件尺寸，具体含义后续讲解</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166fc78994194f6181cef281d2144092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=MKuGQPm%2FqdODmajkI7qSCZ4u2JY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">创建布局文件</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dba999c0d9114f67b96b821649f6fb25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=gVQ9ro8c9Z%2F9LqUac7YLc7SqWqs%3D" alt="在这里插入图片描述" loading="lazy"/> <br/></p>
<ul>
<li><strong>文件位置</strong>：布局文件存放在res/layout目录下</li>
<li><strong>创建方法</strong>：右键layout文件夹→New→Layout Resource File</li>
<li><strong>命名规范</strong>：文件名全部小写</li>
<li><strong>根布局设置</strong>：创建时可指定根布局类型</li>
<li><strong>多布局支持</strong>：可创建多个布局文件对应不同Activity <br/></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/944da3d00bb8401e817dad3ccfe783be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=rLTgdwiY%2BZ7vq%2FhMn6Mav3LRuZQ%3D" alt="在这里插入图片描述" loading="lazy"/>
当应用程序有多个activity文件，程序怎么知道先加载哪个activity文件呢，这就跟配置清单文件有关了</p>
<h2 data-id="heading-11">清单文件</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bd76de8a45c40a5b1508e8ff0b267be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=ou7VHLT4Iaua7D36Cejk9Cj27tk%3D" alt="在这里插入图片描述" loading="lazy"/> <br/></p>
<ul>
<li><strong>必要性</strong>: Android应用程序中必须包含的配置文件，位于工程根目录（虽然在Android模式下显示为独立文件夹）</li>
<li><strong>历史演变</strong>: 早期需要手动配置每个Activity，现在Android Studio会自动完成配置</li>
<li><strong>读取机制</strong>: 安卓设备启动应用时首先读取该文件，确定应用的初始界面和基本配置</li>
</ul>
<h3 data-id="heading-12">配置MainActivity</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/615971e058c341b98cc77f8f78e2bde8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzMxNzczMTI2MTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770008631&amp;x-signature=1dR51%2FBqXj7G16XK2IOiwZHXrXw%3D" alt="在这里插入图片描述" loading="lazy"/> <br/></p>
<ul>
<li>
<p><strong>基本结构</strong>: 使用标签配置，通过android:name属性指定Activity类</p>
</li>
<li>
<p><strong>Intent-filter作用</strong>:</p>
<ul>
<li>启动界面指定: 通过<code>&lt;action android:name="android.intent.action.MAIN"/&gt;</code>标记为应用入口</li>
<li>应用图标显示: 通过<code>&lt;category android:name="android.intent.category.LAUNCHER"/&gt;</code>使应用出现在程序列表</li>
</ul>
</li>
<li>
<p><strong>唯一性:</strong> 每个应用只能有一个Activity配置此intent-filter组合</p>
</li>
<li>
<p><strong>启动流程</strong>:</p>
<ul>
<li>设备读取Manifest文件确定启动Activity</li>
<li>执行该Activity的onCreate方法</li>
<li>通过setContentView加载布局文件(R.layout.activity_main)</li>
<li>显示对应界面内容</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[__CFRunLoopDoBlocks函数详解]]></title>    <link>https://juejin.cn/post/7598838597560516642</link>    <guid>https://juejin.cn/post/7598838597560516642</guid>    <pubDate>2026-01-26T04:41:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598838597560516642" data-draft-id="7598938568431304719" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="__CFRunLoopDoBlocks函数详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-26T04:41:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            __CFRunLoopDoBlocks函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:41:01.000Z" title="Mon Jan 26 2026 04:41:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>借助AI辅助。</p>
</blockquote>
<h2 data-id="heading-0">函数概述</h2>
<p><code>__CFRunLoopDoBlocks</code> 是 RunLoop 中负责执行 block 的核心函数。它处理通过 <code>CFRunLoopPerformBlock</code> 添加到 RunLoop 中的异步 blocks，这些 blocks 会在 RunLoop 的每次循环中被执行。</p>
<h2 data-id="heading-1">函数签名</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm)
</code></pre>
<h3 data-id="heading-2">参数说明</h3>
<ul>
<li><code>CFRunLoopRef rl</code>: 当前运行的 RunLoop</li>
<li><code>CFRunLoopModeRef rlm</code>: 当前的 RunLoop Mode</li>
</ul>
<h3 data-id="heading-3">返回值</h3>
<ul>
<li><code>Boolean</code>: 如果至少执行了一个 block 返回 <code>true</code>，否则返回 <code>false</code></li>
</ul>
<h3 data-id="heading-4">前置条件</h3>
<ul>
<li><strong>函数调用时必须持有锁</strong>: <code>rl</code> 和 <code>rlm</code> 都必须处于加锁状态</li>
<li><strong>函数返回时保持锁状态</strong>: 出口时 <code>rl</code> 和 <code>rlm</code> 仍然加锁</li>
</ul>
<h2 data-id="heading-5">Block Item 数据结构</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *_<span class="hljs-title">next</span>;</span>  <span class="hljs-comment">// 链表的下一个节点</span>
    CFTypeRef _mode;            <span class="hljs-comment">// 可以是 CFStringRef 或 CFSetRef</span>
    <span class="hljs-type">void</span> (^_block)(<span class="hljs-type">void</span>);       <span class="hljs-comment">// 要执行的 block</span>
};
</code></pre>
<h3 data-id="heading-6">RunLoop 中的 Block 链表</h3>
<pre><code class="hljs language-rust" lang="rust">rl<span class="hljs-punctuation">-&gt;</span>_blocks_head  -<span class="hljs-punctuation">-&gt;</span>  [Block1] <span class="hljs-punctuation">-&gt;</span> [Block2] <span class="hljs-punctuation">-&gt;</span> [Block3] <span class="hljs-punctuation">-&gt;</span> NULL
                         ^                        ^
                         |                        |
                     (first)                   (last)
                                                  |
                                        rl<span class="hljs-punctuation">-&gt;</span>_blocks_tail
</code></pre>
<h2 data-id="heading-7">完整代码逐行注释</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 📝 调用此函数时，rl 和 rlm 必须已加锁</span>
<span class="hljs-comment">// 函数返回时，rl 和 rlm 仍然保持加锁状态</span>
<span class="hljs-type">static</span> Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm) { <span class="hljs-comment">// Call with rl and rlm locked</span>
    
    <span class="hljs-comment">// ==================== 第一部分：性能追踪和前置检查 ====================</span>
    
    <span class="hljs-comment">// 📊 记录性能追踪点：开始执行 blocks</span>
    <span class="hljs-comment">// 可通过 Instruments 的 kdebug 工具查看此事件</span>
    cf_trace(KDEBUG_EVENT_CFRL_IS_DOING_BLOCKS | DBG_FUNC_START, rl, rlm, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 🚪 快速退出1：如果 RunLoop 中没有待处理的 blocks</span>
    <span class="hljs-comment">// _blocks_head 为 NULL 表示链表为空，直接返回 false（表示没有执行任何 block）</span>
    <span class="hljs-keyword">if</span> (!rl-&gt;_blocks_head) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 🚪 快速退出2：如果 mode 无效或没有名称</span>
    <span class="hljs-comment">// 这是一个防御性检查，正常情况下不应该发生</span>
    <span class="hljs-keyword">if</span> (!rlm || !rlm-&gt;_name) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 标志位：记录是否至少执行了一个 block</span>
    Boolean did = <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// ==================== 第二部分：摘取整个 Block 链表 ====================</span>
    
    <span class="hljs-comment">// 保存链表头指针到局部变量</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">head</span> =</span> rl-&gt;_blocks_head;
    
    <span class="hljs-comment">// 保存链表尾指针到局部变量</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">tail</span> =</span> rl-&gt;_blocks_tail;
    
    <span class="hljs-comment">// 🎯 清空 RunLoop 的 blocks 链表头</span>
    <span class="hljs-comment">// 将所有 blocks "取出"到局部变量中（摘取操作）</span>
    rl-&gt;_blocks_head = <span class="hljs-literal">NULL</span>;
    
    <span class="hljs-comment">// 🎯 清空 RunLoop 的 blocks 链表尾</span>
    <span class="hljs-comment">// 此时 RunLoop 中已经没有 blocks 了</span>
    rl-&gt;_blocks_tail = <span class="hljs-literal">NULL</span>;
    
    <span class="hljs-comment">// ⚠️ 为什么要清空 RunLoop 的链表？</span>
    <span class="hljs-comment">// 1. 避免在执行 block 期间，其他代码再次访问这些 blocks</span>
    <span class="hljs-comment">// 2. 允许 block 执行期间添加新的 blocks（不会与当前正在处理的 blocks 冲突）</span>
    <span class="hljs-comment">// 3. 未执行的 blocks 稍后会被重新添加回 RunLoop</span>
    
    <span class="hljs-comment">// 获取 RunLoop 的 commonModes 集合</span>
    <span class="hljs-comment">// commonModes 通常包含 kCFRunLoopDefaultMode 和 UITrackingRunLoopMode</span>
    CFSetRef commonModes = rl-&gt;_commonModes;
    
    <span class="hljs-comment">// 获取当前 mode 的名称（如 "kCFRunLoopDefaultMode"）</span>
    CFStringRef curMode = rlm-&gt;_name;
    
    <span class="hljs-comment">// ==================== 第三部分：解锁（准备执行 blocks）====================</span>
    
    <span class="hljs-comment">// 🔓 解锁 RunLoop Mode</span>
    __CFRunLoopModeUnlock(rlm);
    
    <span class="hljs-comment">// 🔓 解锁 RunLoop</span>
    __CFRunLoopUnlock(rl);
    
    <span class="hljs-comment">// ⚠️ 为什么要解锁？</span>
    <span class="hljs-comment">// 1. 防止死锁：block 中可能调用 RunLoop API（如 CFRunLoopPerformBlock）</span>
    <span class="hljs-comment">// 2. 避免长时间持锁：block 可能执行耗时操作</span>
    <span class="hljs-comment">// 3. 提高并发性：允许其他线程在 block 执行期间访问 RunLoop</span>
    
    <span class="hljs-comment">// 🛡️ 安全性保证：</span>
    <span class="hljs-comment">// - 已经将 blocks 链表"摘取"到局部变量 head/tail</span>
    <span class="hljs-comment">// - 即使其他线程修改了 rl-&gt;_blocks_head，也不会影响本次执行</span>
    <span class="hljs-comment">// - 新添加的 blocks 会形成新的链表，不会与当前正在处理的链表冲突</span>
    
    <span class="hljs-comment">// ==================== 第四部分：遍历链表，执行符合条件的 blocks ====================</span>
    
    <span class="hljs-comment">// 前驱节点指针（用于链表删除操作）</span>
    <span class="hljs-comment">// 当删除节点时，需要修改前驱节点的 _next 指针</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">prev</span> =</span> <span class="hljs-literal">NULL</span>;
    
    <span class="hljs-comment">// 当前遍历的节点，从头节点开始</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">item</span> =</span> head;
    
    <span class="hljs-comment">// 遍历整个 blocks 链表</span>
    <span class="hljs-keyword">while</span> (item) {
        
        <span class="hljs-comment">// 保存当前节点到 curr（因为 item 会被提前移动到下一个节点）</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">curr</span> =</span> item;
        
        <span class="hljs-comment">// 🔜 提前移动到下一个节点</span>
        <span class="hljs-comment">// 原因：如果 curr 被删除（执行并释放），item 仍然指向有效的下一个节点</span>
        <span class="hljs-comment">// 避免在删除节点后访问已释放的内存</span>
        item = item-&gt;_next;
        
        <span class="hljs-comment">// 标志位：当前 block 是否应该在当前 mode 下执行</span>
        Boolean doit = <span class="hljs-literal">false</span>;
        
        <span class="hljs-comment">// ---------- 判断 Block 是否应该在当前 Mode 下执行 ----------</span>
        
        <span class="hljs-comment">// 🔍 情况1：_mode 是 CFString 类型（单个 mode）</span>
        <span class="hljs-comment">// CFGetTypeID() 获取对象的类型ID，_kCFRuntimeIDCFString 是 CFString 类型的常量ID</span>
        <span class="hljs-keyword">if</span> (_kCFRuntimeIDCFString == CFGetTypeID(curr-&gt;_mode)) {
            
            <span class="hljs-comment">// 判断逻辑（两种情况任一成立即可）：</span>
            <span class="hljs-comment">// 条件1: CFEqual(curr-&gt;_mode, curMode)</span>
            <span class="hljs-comment">//   block 指定的 mode 与当前 mode 完全匹配</span>
            <span class="hljs-comment">//   例如：block 添加到 "kCFRunLoopDefaultMode"，当前也是 "kCFRunLoopDefaultMode"</span>
            <span class="hljs-comment">// 条件2: CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode)</span>
            <span class="hljs-comment">//   block 添加到 "kCFRunLoopCommonModes" 且当前 mode 在 commonModes 集合中</span>
            <span class="hljs-comment">//   例如：block 添加到 "kCFRunLoopCommonModes"，当前是 "kCFRunLoopDefaultMode"</span>
            <span class="hljs-comment">//         且 commonModes 包含 "kCFRunLoopDefaultMode"，则应该执行</span>
            doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));
            
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 🔍 情况2：_mode 是 CFSet 类型（多个 modes 的集合）</span>
            
            <span class="hljs-comment">// 判断逻辑（两种情况任一成立即可）：</span>
            <span class="hljs-comment">// 条件1: CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode)</span>
            <span class="hljs-comment">//   block 指定的 modes 集合中包含当前 mode</span>
            <span class="hljs-comment">//   例如：block 添加到 {"Mode1", "Mode2"}，当前是 "Mode1"</span>
            <span class="hljs-comment">// 条件2: CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode)</span>
            <span class="hljs-comment">//   block 指定的 modes 集合中包含 "kCFRunLoopCommonModes"</span>
            <span class="hljs-comment">//   且当前 mode 在 commonModes 集合中</span>
            doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));
        }
        
        <span class="hljs-comment">// ---------- 处理不执行的 Block ----------</span>
        
        <span class="hljs-comment">// 如果当前 block 不需要执行：</span>
        <span class="hljs-comment">// 更新 prev 指针，指向当前节点</span>
        <span class="hljs-comment">// 这个节点会被保留在链表中（稍后重新添加回 RunLoop）</span>
        <span class="hljs-keyword">if</span> (!doit) prev = curr;
        
        <span class="hljs-comment">// ---------- 处理需要执行的 Block ----------</span>
        
        <span class="hljs-keyword">if</span> (doit) {
            <span class="hljs-comment">// 当前 block 需要在当前 mode 下执行</span>
            
            <span class="hljs-comment">// ===== 子部分1：从链表中移除当前节点 =====</span>
            
            <span class="hljs-comment">// 如果有前驱节点，将前驱节点的 next 指针指向下一个节点</span>
            <span class="hljs-comment">// 跳过当前节点（curr），实现删除</span>
            <span class="hljs-comment">// 示例：prev -&gt; curr -&gt; item  变为  prev ---------&gt; item（删除 curr）</span>
            <span class="hljs-keyword">if</span> (prev) prev-&gt;_next = item;
            
            <span class="hljs-comment">// 如果当前节点是头节点，更新头指针</span>
            <span class="hljs-comment">// 新的头节点变成下一个节点</span>
            <span class="hljs-keyword">if</span> (curr == head) head = item;
            
            <span class="hljs-comment">// 如果当前节点是尾节点，更新尾指针</span>
            <span class="hljs-comment">// 新的尾节点变成前驱节点</span>
            <span class="hljs-keyword">if</span> (curr == tail) tail = prev;
            
            <span class="hljs-comment">// ===== 子部分2：提取 Block 信息并释放节点内存 =====</span>
            
            <span class="hljs-comment">// 提取 block 闭包（复制指针）</span>
            <span class="hljs-comment">// 类型：void (^)(void) 表示无参数无返回值的 block</span>
            <span class="hljs-type">void</span> (^block)(<span class="hljs-type">void</span>) = curr-&gt;_block;
            
            <span class="hljs-comment">// 释放 mode 对象（CFString 或 CFSet）</span>
            <span class="hljs-comment">// 减少引用计数，可能触发对象销毁</span>
            CFRelease(curr-&gt;_mode);
            
            <span class="hljs-comment">// 释放节点结构体的内存（C 风格内存管理）</span>
            <span class="hljs-comment">// 此时 curr 指针已无效，不能再访问</span>
            <span class="hljs-built_in">free</span>(curr);
            
            <span class="hljs-comment">// ===== 子部分3：执行 Block =====</span>
            
            <span class="hljs-comment">// ⚠️ 这里的 if (doit) 是冗余的（外层已经检查过）</span>
            <span class="hljs-comment">// 可能是历史遗留代码或防御性编程</span>
            <span class="hljs-keyword">if</span> (doit) {
                
                <span class="hljs-comment">// 🔄 开始自动释放池（ARP = AutoRelease Pool）</span>
                <span class="hljs-comment">// 管理 block 执行期间创建的临时对象</span>
                CFRUNLOOP_ARP_BEGIN(rl);
                
                <span class="hljs-comment">// 📊 记录性能追踪点：开始调用 block</span>
                cf_trace(KDEBUG_EVENT_CFRL_IS_CALLING_BLOCK | DBG_FUNC_START, rl, rlm, block, <span class="hljs-number">0</span>);
                
                <span class="hljs-comment">// ⚡ 执行 block 的核心宏</span>
                <span class="hljs-comment">// 展开后通常是：block();</span>
                <span class="hljs-comment">// 这是整个函数的核心目的！</span>
                <span class="hljs-comment">// ⚠️ Block 执行期间可能发生：UI 更新、网络请求、数据库操作、</span>
                <span class="hljs-comment">//    再次调用 CFRunLoopPerformBlock、操作 RunLoop、长时间阻塞等</span>
                __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);
                
                <span class="hljs-comment">// 📊 记录性能追踪点：结束调用 block</span>
                <span class="hljs-comment">// 可计算 block 执行耗时 = end - start</span>
                cf_trace(KDEBUG_EVENT_CFRL_IS_CALLING_BLOCK | DBG_FUNC_END, rl, rlm, block, <span class="hljs-number">0</span>);
                
                <span class="hljs-comment">// 🔄 结束自动释放池</span>
                <span class="hljs-comment">// 释放 block 中创建的所有 autorelease 对象</span>
                CFRUNLOOP_ARP_END();
                
                <span class="hljs-comment">// ✅ 标记：至少执行了一个 block</span>
                did = <span class="hljs-literal">true</span>;
            }
            
            <span class="hljs-comment">// ===== 子部分4：释放 Block =====</span>
            
            <span class="hljs-comment">// 释放 block 对象（减少引用计数）</span>
            <span class="hljs-comment">// block 可能会被销毁，触发其捕获变量的释放</span>
            <span class="hljs-comment">// 💡 为什么在重新加锁之前释放？</span>
            <span class="hljs-comment">// 注释原文："do this before relocking to prevent deadlocks </span>
            <span class="hljs-comment">//          where some yahoo wants to run the run loop reentrantly </span>
            <span class="hljs-comment">//          from their dealloc"</span>
            <span class="hljs-comment">// 原因：block 的 dealloc 可能触发捕获变量的析构函数，</span>
            <span class="hljs-comment">//       某些"聪明人"可能在 dealloc 中重入 RunLoop，</span>
            <span class="hljs-comment">//       如果此时持有锁，会导致死锁。</span>
            <span class="hljs-comment">//       在解锁状态下释放 block，即使 dealloc 尝试操作 RunLoop，</span>
            <span class="hljs-comment">//       也不会因为已持有锁而死锁</span>
            Block_release(block); <span class="hljs-comment">// do this before relocking to prevent deadlocks where some yahoo wants to run the run loop reentrantly from their dealloc</span>
        }
    }
    
    <span class="hljs-comment">// ==================== 第五部分：重新加锁 ====================</span>
    
    <span class="hljs-comment">// 🔒 重新锁定 RunLoop</span>
    __CFRunLoopLock(rl);
    
    <span class="hljs-comment">// 🔒 重新锁定 RunLoop Mode</span>
    __CFRunLoopModeLock(rlm);
    
    <span class="hljs-comment">// ✅ 恢复函数入口时的锁状态</span>
    <span class="hljs-comment">// 满足函数约定："Call with rl and rlm locked"</span>
    
    <span class="hljs-comment">// ==================== 第六部分：将未执行的 Blocks 放回 RunLoop ====================</span>
    
    <span class="hljs-comment">// 如果还有未执行的 blocks（链表不为空）</span>
    <span class="hljs-comment">// head 和 tail 现在指向未执行的 blocks 链表（已执行的 blocks 已从链表中移除）</span>
    <span class="hljs-keyword">if</span> (head &amp;&amp; tail) {
        <span class="hljs-comment">// 将未执行的链表的尾部连接到 RunLoop 当前的 blocks 链表头部</span>
        <span class="hljs-comment">// 示例：</span>
        <span class="hljs-comment">// 未执行的链表：[Block1] -&gt; [Block2] -&gt; NULL (head=Block1, tail=Block2)</span>
        <span class="hljs-comment">// RunLoop 当前链表：[Block3] -&gt; [Block4] -&gt; NULL (rl-&gt;_blocks_head=Block3)</span>
        <span class="hljs-comment">// 连接后：[Block1] -&gt; [Block2] -&gt; [Block3] -&gt; [Block4] -&gt; NULL</span>
        tail-&gt;_next = rl-&gt;_blocks_head;
        
        <span class="hljs-comment">// 更新 RunLoop 的 blocks 链表头指针</span>
        <span class="hljs-comment">// 指向未执行的链表的头部</span>
        rl-&gt;_blocks_head = head;
        
        <span class="hljs-comment">// 如果 RunLoop 当前没有尾指针（即 _blocks_head 原本为 NULL）</span>
        <span class="hljs-comment">// 则将尾指针设置为未执行链表的尾部</span>
        <span class="hljs-comment">// ⚠️ 注意：如果 rl-&gt;_blocks_tail 已经存在，不更新它</span>
        <span class="hljs-comment">// 因为新的尾节点应该是原来 RunLoop 链表的尾节点</span>
        <span class="hljs-comment">// （未执行的链表已经通过 tail-&gt;_next 连接到了原链表前面）</span>
        <span class="hljs-comment">// 📊 重新插入的顺序：未执行的 blocks 被放在队列的最前面，</span>
        <span class="hljs-comment">//    在执行期间新添加的 blocks 排在后面，</span>
        <span class="hljs-comment">//    这保证了未执行的 blocks 在下次循环中优先被执行</span>
        <span class="hljs-keyword">if</span> (!rl-&gt;_blocks_tail) rl-&gt;_blocks_tail = tail;
    }
    
    <span class="hljs-comment">// ==================== 第七部分：结束性能追踪 ====================</span>
    
    <span class="hljs-comment">// 📊 记录性能追踪点：完成 blocks 执行</span>
    cf_trace(KDEBUG_EVENT_CFRL_IS_DOING_BLOCKS | DBG_FUNC_END, rl, rlm, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 返回是否至少执行了一个 block</span>
    <span class="hljs-comment">// true：执行了至少一个 block</span>
    <span class="hljs-comment">// false：没有执行任何 block（所有 blocks 的 mode 都不匹配）</span>
    <span class="hljs-keyword">return</span> did;
}
</code></pre>
<h2 data-id="heading-8">关键设计要点</h2>
<h3 data-id="heading-9">1. Mode 匹配逻辑</h3>
<p>Block 的 mode 可以是两种类型：</p>
<h4 data-id="heading-10">类型1：CFString（单个 mode）</h4>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 添加到特定 mode</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopDefaultMode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"Execute in default mode only"</span>);
});

<span class="hljs-comment">// 添加到 common modes</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopCommonModes, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"Execute in all common modes"</span>);
});
</code></pre>
<p><strong>匹配规则</strong>:</p>
<ol>
<li>精确匹配：<code>block.mode == currentMode</code></li>
<li>Common modes 匹配：<code>block.mode == kCFRunLoopCommonModes &amp;&amp; currentMode ∈ commonModes</code></li>
</ol>
<h4 data-id="heading-11">类型2：CFSet（多个 modes）</h4>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 添加到多个 modes</span>
<span class="hljs-built_in">CFSetRef</span> modes = <span class="hljs-built_in">CFSetCreate</span>(<span class="hljs-literal">NULL</span>, 
    (<span class="hljs-keyword">const</span> <span class="hljs-type">void</span> *[]){kCFRunLoopDefaultMode, <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"CustomMode"</span>)}, 
    <span class="hljs-number">2</span>, 
    &amp;kCFTypeSetCallBacks);

<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, modes, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"Execute in default or custom mode"</span>);
});
<span class="hljs-built_in">CFRelease</span>(modes);
</code></pre>
<p><strong>匹配规则</strong>:</p>
<ol>
<li>集合包含：<code>currentMode ∈ block.modes</code></li>
<li>Common modes 匹配：<code>kCFRunLoopCommonModes ∈ block.modes &amp;&amp; currentMode ∈ commonModes</code></li>
</ol>
<h3 data-id="heading-12">2. 链表操作详解</h3>
<pre><code class="hljs language-rust" lang="rust">初始状态：
rl<span class="hljs-punctuation">-&gt;</span>_blocks_head -<span class="hljs-punctuation">-&gt;</span> [A] <span class="hljs-punctuation">-&gt;</span> [B] <span class="hljs-punctuation">-&gt;</span> [C] <span class="hljs-punctuation">-&gt;</span> [D] <span class="hljs-punctuation">-&gt;</span> NULL
                      ^                     ^
                   (<span class="hljs-keyword">match</span>)  (no)   (no)  (<span class="hljs-keyword">match</span>)

执行后：
- A 和 D 已执行并释放
- B 和 C 未执行（mode 不匹配）

剩余链表：
head -<span class="hljs-punctuation">-&gt;</span> [B] <span class="hljs-punctuation">-&gt;</span> [C] <span class="hljs-punctuation">-&gt;</span> NULL
          ^      ^
        prev   tail

重新插入（假设期间添加了新 block E）：
rl<span class="hljs-punctuation">-&gt;</span>_blocks_head -<span class="hljs-punctuation">-&gt;</span> [E] <span class="hljs-punctuation">-&gt;</span> NULL

连接后：
rl<span class="hljs-punctuation">-&gt;</span>_blocks_head -<span class="hljs-punctuation">-&gt;</span> [B] <span class="hljs-punctuation">-&gt;</span> [C] <span class="hljs-punctuation">-&gt;</span> [E] <span class="hljs-punctuation">-&gt;</span> NULL
</code></pre>
<h3 data-id="heading-13">3. 锁的管理策略</h3>
<pre><code class="hljs">入口状态：rl 锁定 + rlm 锁定
  ↓
摘取 blocks 链表（持有锁）
  ↓
解锁 rl 和 rlm
  ↓
遍历并执行 blocks（无全局锁）
  ↓
重新锁定 rl 和 rlm
  ↓
放回未执行的 blocks（持有锁）
  ↓
出口状态：rl 锁定 + rlm 锁定
</code></pre>
<p><strong>为什么这样设计？</strong></p>

























<table><thead><tr><th>阶段</th><th>锁状态</th><th>原因</th></tr></thead><tbody><tr><td>摘取链表</td><td>加锁</td><td>保证原子性，防止并发修改</td></tr><tr><td>执行 blocks</td><td>解锁</td><td>防止 block 中调用 RunLoop API 导致死锁</td></tr><tr><td>放回链表</td><td>加锁</td><td>保证原子性，防止链表结构损坏</td></tr></tbody></table>
<h3 data-id="heading-14">4. 内存管理细节</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 节点创建（在 CFRunLoopPerformBlock 中）</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">item</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> _block_item));
item-&gt;_mode = CFRetain(mode);      <span class="hljs-comment">// 引用计数 +1</span>
item-&gt;_block = Block_copy(block);  <span class="hljs-comment">// 引用计数 +1</span>

<span class="hljs-comment">// 节点销毁（在 __CFRunLoopDoBlocks 中）</span>
CFRelease(curr-&gt;_mode);    <span class="hljs-comment">// 引用计数 -1</span>
<span class="hljs-built_in">free</span>(curr);                <span class="hljs-comment">// 释放节点内存</span>
Block_release(block);      <span class="hljs-comment">// 引用计数 -1</span>
</code></pre>
<p><strong>引用计数管理</strong>:</p>
<ol>
<li><code>CFRetain/CFRelease</code>: 管理 mode 对象（CFString/CFSet）</li>
<li><code>Block_copy/Block_release</code>: 管理 block 对象</li>
<li><code>malloc/free</code>: 管理节点结构体</li>
</ol>
<h3 data-id="heading-15">5. 避免死锁的设计</h3>
<pre><code class="hljs language-c" lang="c">Block_release(block); <span class="hljs-comment">// do this before relocking to prevent deadlocks</span>
__CFRunLoopLock(rl);
</code></pre>
<p><strong>潜在的死锁场景</strong>:</p>
<pre><code class="hljs language-objc" lang="objc">__<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{
    <span class="hljs-comment">// block 捕获了 weakSelf</span>
});

<span class="hljs-comment">// 在对象的 dealloc 中</span>
- (<span class="hljs-type">void</span>)dealloc {
    <span class="hljs-comment">// 当 block 被释放时，weakSelf 也会被释放</span>
    <span class="hljs-comment">// 如果开发者在 dealloc 中操作 RunLoop...</span>
    <span class="hljs-built_in">CFRunLoopRun</span>();  <span class="hljs-comment">// 尝试获取 RunLoop 锁 -&gt; 死锁！</span>
}
</code></pre>
<p><strong>解决方案</strong>: 在解锁状态下释放 block，即使 dealloc 中操作 RunLoop 也不会死锁。</p>
<h2 data-id="heading-16">性能特性</h2>
<h3 data-id="heading-17">1. 时间复杂度</h3>
<ul>
<li><strong>遍历链表</strong>: O(n)，n 为 blocks 数量</li>
<li><strong>Mode 匹配</strong>: O(1) 或 O(m)，m 为 modes 集合大小（通常很小）</li>
<li><strong>链表操作</strong>: O(1)（插入/删除单个节点）</li>
</ul>
<h3 data-id="heading-18">2. 空间复杂度</h3>
<ul>
<li><strong>链表存储</strong>: O(n)，n 为待处理的 blocks 数量</li>
<li><strong>局部变量</strong>: O(1)</li>
</ul>
<h3 data-id="heading-19">3. 性能优化</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">if</span> (!rl-&gt;_blocks_head) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 快速退出</span>
</code></pre>
<p>如果没有 blocks，立即返回，避免不必要的操作。</p>
<h2 data-id="heading-20">使用场景</h2>
<h3 data-id="heading-21">1. 在主线程异步执行代码</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 在后台线程</span>
<span class="hljs-built_in">dispatch_async</span>(backgroundQueue, ^{
    <span class="hljs-comment">// 执行耗时操作...</span>
    <span class="hljs-built_in">NSData</span> *data = [<span class="hljs-keyword">self</span> fetchDataFromNetwork];
    
    <span class="hljs-comment">// 切换到主线程更新 UI</span>
    <span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes, ^{
        <span class="hljs-keyword">self</span>.imageView.image = [<span class="hljs-built_in">UIImage</span> imageWithData:data];
    });
    <span class="hljs-built_in">CFRunLoopWakeUp</span>(<span class="hljs-built_in">CFRunLoopGetMain</span>());  <span class="hljs-comment">// 唤醒主线程 RunLoop</span>
});
</code></pre>
<h3 data-id="heading-22">2. 在特定 Mode 下执行代码</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 只在默认 mode 下执行（滚动时不执行）</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), kCFRunLoopDefaultMode, ^{
    [<span class="hljs-keyword">self</span> performHeavyCalculation];
});

<span class="hljs-comment">// 在所有 common modes 下执行（包括滚动时）</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-built_in">CFRunLoopGetCurrent</span>(), kCFRunLoopCommonModes, ^{
    [<span class="hljs-keyword">self</span> updateCriticalUI];
});
</code></pre>
<h3 data-id="heading-23">3. 跨线程通信</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 线程 A</span>
<span class="hljs-built_in">CFRunLoopRef</span> threadBRunLoop = ...; <span class="hljs-comment">// 获取线程 B 的 RunLoop</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(threadBRunLoop, kCFRunLoopDefaultMode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"This runs on thread B"</span>);
});
<span class="hljs-built_in">CFRunLoopWakeUp</span>(threadBRunLoop);  <span class="hljs-comment">// 唤醒线程 B</span>

<span class="hljs-comment">// 线程 B</span>
<span class="hljs-built_in">CFRunLoopRun</span>();  <span class="hljs-comment">// 等待并处理事件（包括 blocks）</span>
</code></pre>
<h2 data-id="heading-24">与 GCD 的对比</h2>
<h3 data-id="heading-25">CFRunLoopPerformBlock vs dispatch_async</h3>



































<table><thead><tr><th>特性</th><th>CFRunLoopPerformBlock</th><th>dispatch_async</th></tr></thead><tbody><tr><td>执行时机</td><td>在 RunLoop 循环中</td><td>在 GCD 队列中</td></tr><tr><td>Mode 支持</td><td>✅ 可指定 mode</td><td>❌ 无 mode 概念</td></tr><tr><td>优先级控制</td><td>❌ 按添加顺序</td><td>✅ 支持 QoS</td></tr><tr><td>线程保证</td><td>✅ 绑定到特定 RunLoop</td><td>❌ 线程由 GCD 管理</td></tr><tr><td>性能</td><td>较低（需要 RunLoop 循环）</td><td>较高（GCD 优化）</td></tr></tbody></table>
<p><strong>使用建议</strong>:</p>
<ul>
<li><strong>CFRunLoopPerformBlock</strong>: 需要与 RunLoop mode 交互（如 UI 更新）</li>
<li><strong>dispatch_async</strong>: 通用异步任务（推荐）</li>
</ul>
<h2 data-id="heading-26">与其他 RunLoop 函数的关系</h2>
<pre><code class="hljs language-scss" lang="scss">__CFRunLoopRun (主循环)
  │
  ├─ do {
  │    │
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoObservers</span>(kCFRunLoopBeforeTimers)
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoObservers</span>(kCFRunLoopBeforeSources)
  │    │
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoBlocks</span>(rl, rlm)  <span class="hljs-comment">// ⭐ 处理 blocks</span>
  │    │
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoSources0</span>(rl, rlm)
  │    │
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoBlocks</span>(rl, rlm)  <span class="hljs-comment">// ⭐ 再次处理（可能有新添加的）</span>
  │    │
  │    ├─ 检查是否有 Source1 待处理
  │    │
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoObservers</span>(kCFRunLoopBeforeWaiting)
  │    ├─ <span class="hljs-built_in">__CFRunLoopServiceMachPort</span>(...)  <span class="hljs-comment">// 等待事件</span>
  │    ├─ <span class="hljs-built_in">__CFRunLoopDoObservers</span>(kCFRunLoopAfterWaiting)
  │    │
  │    ├─ 处理唤醒源（Timer/Source1/GCD）
  │    │
  │    └─ <span class="hljs-built_in">__CFRunLoopDoBlocks</span>(rl, rlm)  <span class="hljs-comment">// ⭐ 最后再处理一次</span>
  │
  └─ } while (!stop);
</code></pre>
<p><strong>调用频率</strong>: 每次 RunLoop 循环通常调用 2-3 次。</p>
<h2 data-id="heading-27">潜在问题和注意事项</h2>
<h3 data-id="heading-28">1. Block 执行顺序不保证</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{ <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"1"</span>); });
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{ <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"2"</span>); });
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{ <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"3"</span>); });

<span class="hljs-comment">// 输出：可能是 1, 2, 3</span>
<span class="hljs-comment">// 但如果第一次循环某些 block 的 mode 不匹配，顺序可能改变</span>
</code></pre>
<p><strong>原因</strong>: 未执行的 blocks 会被重新插入队列头部。</p>
<h3 data-id="heading-29">2. Block 中的长时间操作</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// ❌ 不好的做法</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes, ^{
    sleep(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 阻塞主线程 5 秒</span>
    <span class="hljs-comment">// UI 会卡顿！</span>
});

<span class="hljs-comment">// ✅ 正确的做法</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes, ^{
    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^{
        sleep(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 在后台线程执行</span>
        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
            <span class="hljs-comment">// 完成后更新 UI</span>
        });
    });
});
</code></pre>
<h3 data-id="heading-30">3. Mode 不匹配导致 Block 不执行</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 添加到 Default mode</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopDefaultMode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"This will NOT run during scrolling"</span>);
});
<span class="hljs-built_in">CFRunLoopWakeUp</span>(runLoop);

<span class="hljs-comment">// 如果 RunLoop 当前在 UITrackingRunLoopMode（滚动时）</span>
<span class="hljs-comment">// Block 不会执行，会一直等到切换到 Default mode</span>
</code></pre>
<p><strong>解决方案</strong>: 使用 <code>kCFRunLoopCommonModes</code>:</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopCommonModes, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"This runs in all common modes"</span>);
});
</code></pre>
<h3 data-id="heading-31">4. 忘记唤醒 RunLoop</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// ❌ 不完整的代码</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"This might not run immediately"</span>);
});
<span class="hljs-comment">// 如果 RunLoop 正在休眠（等待事件），block 不会立即执行</span>

<span class="hljs-comment">// ✅ 正确的做法</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"This will run soon"</span>);
});
<span class="hljs-built_in">CFRunLoopWakeUp</span>(runLoop);  <span class="hljs-comment">// 唤醒 RunLoop</span>
</code></pre>
<h3 data-id="heading-32">5. 循环引用</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// ❌ 循环引用</span>
<span class="hljs-keyword">self</span>.runLoop = <span class="hljs-built_in">CFRunLoopGetCurrent</span>();
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-keyword">self</span>.runLoop, mode, ^{
    [<span class="hljs-keyword">self</span> doSomething];  <span class="hljs-comment">// self 持有 runLoop，block 持有 self，runLoop 持有 block</span>
});

<span class="hljs-comment">// ✅ 使用 weak 引用</span>
__<span class="hljs-keyword">weak</span> <span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(<span class="hljs-keyword">self</span>.runLoop, mode, ^{
    [weakSelf doSomething];
});
</code></pre>
<h2 data-id="heading-33">调试技巧</h2>
<h3 data-id="heading-34">1. 查看待处理的 Blocks</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 在 LLDB 中</span>
(lldb) p rl-&gt;_blocks_head
(lldb) p rl-&gt;_blocks_tail

<span class="hljs-comment">// 遍历链表</span>
(lldb) p ((<span class="hljs-keyword">struct</span> _block_item *)rl-&gt;_blocks_head)-&gt;_next
</code></pre>
<h3 data-id="heading-35">2. 追踪 Block 执行</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 添加日志</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, mode, ^{
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"Block start: %@"</span>, [<span class="hljs-built_in">NSThread</span> currentThread]);
    <span class="hljs-comment">// 业务代码...</span>
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"Block end"</span>);
});
</code></pre>
<h3 data-id="heading-36">3. 使用 Instruments</h3>
<ul>
<li>打开 Instruments</li>
<li>选择 "System Trace" 模板</li>
<li>查看 <code>KDEBUG_EVENT_CFRL_IS_CALLING_BLOCK</code> 事件</li>
<li>分析 block 执行耗时和频率</li>
</ul>
<h2 data-id="heading-37">总结</h2>
<p><code>__CFRunLoopDoBlocks</code> 是 RunLoop 异步任务机制的核心实现，其精妙之处在于：</p>
<ol>
<li><strong>灵活的 Mode 匹配</strong>: 支持单 mode、多 mode、common modes</li>
<li><strong>安全的锁管理</strong>: 执行前解锁，防止死锁和长时间持锁</li>
<li><strong>高效的链表操作</strong>: 摘取-处理-放回的三段式设计</li>
<li><strong>精细的内存管理</strong>: CFRetain/Block_copy 保证对象生命周期</li>
<li><strong>智能的释放时机</strong>: 在重新加锁前释放 block，避免 dealloc 中的死锁</li>
</ol>
<p>这个函数体现了 CoreFoundation 在性能、安全性和灵活性之间的精妙平衡，是理解 RunLoop 异步机制的关键。</p>
<h2 data-id="heading-38">扩展阅读</h2>
<h3 data-id="heading-39">CFRunLoopPerformBlock 的实现</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">CFRunLoopPerformBlock</span><span class="hljs-params">(CFRunLoopRef rl, CFTypeRef mode, <span class="hljs-type">void</span> (^block)(<span class="hljs-type">void</span>))</span> {
    <span class="hljs-keyword">if</span> (!rl || !block) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">block_item</span> *<span class="hljs-title">item</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> _block_item));
    item-&gt;_next = <span class="hljs-literal">NULL</span>;
    item-&gt;_mode = CFRetain(mode);         <span class="hljs-comment">// 持有 mode</span>
    item-&gt;_block = Block_copy(block);     <span class="hljs-comment">// 复制 block（栈 -&gt; 堆）</span>
    
    __CFRunLoopLock(rl);
    
    <span class="hljs-comment">// 添加到链表尾部</span>
    <span class="hljs-keyword">if</span> (!rl-&gt;_blocks_head) {
        rl-&gt;_blocks_head = item;
    } <span class="hljs-keyword">else</span> {
        rl-&gt;_blocks_tail-&gt;_next = item;
    }
    rl-&gt;_blocks_tail = item;
    
    __CFRunLoopUnlock(rl);
}
</code></pre>
<h3 data-id="heading-40">Common Modes 的定义</h3>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 在 Cocoa/UIKit 中</span>
<span class="hljs-built_in">NSRunLoopCommonModes</span> 包含：
- <span class="hljs-built_in">NSDefaultRunLoopMode</span> (kCFRunLoopDefaultMode)
- <span class="hljs-built_in">UITrackingRunLoopMode</span>

<span class="hljs-comment">// 效果</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopCommonModes, block);
<span class="hljs-comment">// 等价于</span>
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, kCFRunLoopDefaultMode, block);
<span class="hljs-built_in">CFRunLoopPerformBlock</span>(runLoop, <span class="hljs-built_in">UITrackingRunLoopMode</span>, block);
</code></pre>
<p>这确保了 block 在 UI 滚动时也能执行，提升了响应性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[星际穿越：SwiftUI 如何让 ForEach 遍历异构数据（Heterogeneous）集合]]></title>    <link>https://juejin.cn/post/7599088558167982126</link>    <guid>https://juejin.cn/post/7599088558167982126</guid>    <pubDate>2026-01-26T05:39:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599088558167982126" data-draft-id="7599166436683350062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="星际穿越：SwiftUI 如何让 ForEach 遍历异构数据（Heterogeneous）集合"/> <meta itemprop="keywords" content="Swift,SwiftUI,Apple"/> <meta itemprop="datePublished" content="2026-01-26T05:39:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            星际穿越：SwiftUI 如何让 ForEach 遍历异构数据（Heterogeneous）集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:39:05.000Z" title="Mon Jan 26 2026 05:39:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c766bc453744fa88c2835257f340131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=4ExL3ru9a2ye8UlybgReQ5QenRQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>Swift 5.7 的 any 关键字让我们能轻松混合不同类型的数据，但在 SwiftUI 的 ForEach 中却因“身份丢失”（不遵循 Identifiable）而频频报错。本文将带你破解编译器光脑的封锁，利用**“量子胶囊”**（Wrapper 封装）战术，让异构数据集合在界面上完美渲染。</p>
</blockquote>
<h2 data-id="heading-0">🌌 引子：红色警报</h2>
<p>公元 2077 年，地球联邦主力战舰“<strong>Runtime 号</strong>”正在穿越 Swift 5.7 星系。</p>
<p>舰桥上，警报声大作。</p>
<p>“<strong>舰长亚历克斯（Alex）</strong>，大事不妙！前方出现高能反应，我们的万能装载机无法识别这批混合货物！”说话的是<strong>伊娃（Eva）中尉</strong>，联邦最顶尖的 SwiftUI 架构师，此刻她正焦虑地敲击着全息投影键盘。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ef0f1bee3894d879f81d35cd58ce043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=uUySQRNnGnZW%2F%2BnbXYUlSk1%2B1v4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>亚历克斯舰长眉头紧锁，盯着屏幕上那刺眼的红色报错——那是掌管全舰生死的中央光脑 **“Compiler（编译器）”** 发出的绝杀令。</p>
<p><strong>在本篇博文中，您将学到如下内容：</strong></p>
<ul>
<li>🌌 引子：红色警报</li>
<li>🚀 第一回：异构危机，<code>any</code> 的虚假繁荣</li>
<li>🤖 第二回：光脑悖论，Identifiable 的诅咒</li>
<li>👻 第三回：幻影行动，创建“影子”属性</li>
<li>战术 A：降维打击（使用索引）</li>
<li>战术 B：量子胶囊（封装容器）</li>
<li>🏁 终章：跃迁成功</li>
<li>总结</li>
</ul>
<p>“没道理啊，”亚历克斯咬牙切齿，“自从联邦升级了 Swift 5.7 引擎，引入了 <code>any</code> 这种反物质黑科技，我们理应能装载任何种类的异构兵器才对。为什么卡在了 <code>ForEach</code> 这个发射井上？”</p>
<p>“Compiler 拒绝执行！”伊娃绝望地喊道，“它说我们的货物虽然都带了身份证（Identifiable），但装货的箱子本身没有身份证！”</p>
<p>要想拯救“Runtime 号”免于崩溃，他们必须在 5 分钟内骗过中央光脑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b8def68607544058045cc0065c9945c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=N%2FjBWQsy3OeWRfde0tfPDTxog24%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">🚀 第一回：异构危机，<code>any</code> 的虚假繁荣</h2>
<p>Apple 从 <strong>Swift 5.6</strong> 开始引入新的 <code>any</code> 关键字，并在 <strong>Swift 5.7</strong> 对其做了功能强化。这在星际联邦被称为“<strong>存在类型（Existential Types）</strong>”的终极解放。这意味着现在我们可以更加随心所欲地糅合异构数据了——就像把激光剑（TextFile）和力场盾（ShapeFile）扔进同一个仓库里。</p>
<p>不过，当伊娃中尉试图在 <strong>SwiftUI</strong> 的 <code>ForEach</code> 发射井中遍历这些异构货物时，稍不留神就会陷入尴尬的境地。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54742dbcfc944df99c93acfed7ae352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=W2fhK4u2evv0G56Cn6ezoagIB4g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>请看当时战舰主屏上的代码记录：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25dda09a6d2e49b892b09d1a1d24629f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=MermGs8b0fBtaUOyaOSQMosF4Xo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>亚历克斯指着屏幕分析道：“伊娃你看，我们定义了一个 <code>files</code> 仓库，类型是 <code>[any IdentifiableFile]</code>。我们希望按实际类型（激光剑或力场盾）来显示对应的界面。不幸的是，Compiler 光脑铁面无私，它不仅不买账，还甩了一句**‘编译错误’**：</p>
<blockquote>
<p><strong><code>any IdentifiableFile</code> 不遵守 <code>Identifiable</code> 协议！</strong></p>
</blockquote>
<p>这简直是<strong>岂有此理</strong>！这就好比你手里拿着一本护照（Identifiable），但因为你坐在一个不透明的黑色出租车（any）里，边境官就认定这辆车没有通关资格。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b704ff569a64c81b961f27e06c47656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=HZasXbZJKGN0lsqUFBoQQzccb0g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>是不是 SwiftUI 无法处理好异构集合呢？答案当然是否定的！</p>
<p>在亚历克斯和伊娃的引领下，小伙伴们将通过一些技巧来绕过 <code>ForEach</code> 这一限制，让 SwiftUI 能如愿处理任何异构数据。</p>
<p>废话少叙，引擎点火，Let‘s go！！！;)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf0f19e2f1f4bc2bc81353e9efb8eb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=JN1FzEQ9BMF84S2jm%2BnkEMpzLTs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">🤖 第二回：光脑悖论，Identifiable 的诅咒</h2>
<p>大家知道，SwiftUI 中 <code>ForEach</code> 结构（如假包换的结构类型，若不信可以自行查看头文件 ;) ）需要被遍历的集合类型遵守 <code>Identifiable</code> 协议。</p>
<p>仔细观察顶部图片中的代码，可以发现我们的异构集合元素（<code>IdentifiableFile</code> 类型）都遵守 <code>Identifiable</code> 协议，为何会被 Compiler 光脑拒之门外呢？</p>
<p>答案是：<strong>它 <code>any Identifiable</code> 本身是一个抽象的盒子。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c0161959e4f40b89f36c2b0a975f477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=s9VgiCXUnJ9HVyeNeYLDIJjp9Yk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>伊娃中尉恍然大悟：“原来如此！虽然盒子里的每样东西都有 ID，但这个‘盒子类型’本身并没有 ID。Swift 语言的物理法则规定：<strong>包含关联类型或 Self 约束的协议，其存在类型（Existential Type）不自动遵守该协议。</strong>”</p>
<p>亚历克斯冷笑一声：“好一个死板的 AI。既然它看不清盒子里的东西，我们就给它造一个‘影子’，骗过它的传感器。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1cb135d01394e839d3618655ac9be3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=wHyYW2HE3%2F41MjArob0BkBIY%2F80%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">👻 第三回：幻影行动，创建“影子”属性</h2>
<p>既然直接冲卡不行，我们就得用点“障眼法”。这一招在联邦工程兵手册里被称为 <strong>“影子映射术”</strong>。</p>
<p>我们需要创建一个能够被 <code>ForEach</code> 识别的“中间人”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0d122fec8a0452583ddc010475cf93b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=obd%2BarcsdoFqApI6hxaK7%2BCBTLU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">战术 A：降维打击（使用索引）</h3>
<p>这是最简单粗暴的方案。既然光脑不认识 <code>any IdentifiableFile</code> 这个复杂的对象，那它总认识数字吧？我们直接遍历数组的<strong>索引（Indices）</strong>。</p>
<p>亚历克斯迅速输入指令：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">StarshipView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// 📦 混合货物舱：装着各种不同的异构数据</span>
    <span class="hljs-keyword">let</span> cargos: [<span class="hljs-keyword">any</span> <span class="hljs-type">IdentifiableFile</span>] <span class="hljs-operator">=</span> [
        <span class="hljs-type">TextFile</span>(title: <span class="hljs-string">"星际海盗名单"</span>),
        <span class="hljs-type">ShapeFile</span>(shapeType: <span class="hljs-string">"黑洞引力波"</span>)
    ]

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-comment">// 🚫 警报：直接遍历 cargos 会导致光脑死机</span>
            
            <span class="hljs-comment">// ✅ 战术 A：遍历索引（0, 1, 2...）</span>
            <span class="hljs-comment">// 索引是 Int 类型，Int 天生就是 Identifiable 的</span>
            <span class="hljs-type">ForEach</span>(cargos.indices, id: \.<span class="hljs-keyword">self</span>) { index <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 通过索引提取货物真身</span>
                <span class="hljs-keyword">let</span> cargo <span class="hljs-operator">=</span> cargos[index]
                
                <span class="hljs-comment">// 此时再把货物送入渲染引擎</span>
                <span class="hljs-type">CargoDisplayView</span>(file: cargo)
            }
        }
    }
}
</code></pre>
<p>“这招虽然有效，”伊娃担忧地说，“但如果货物在传输过程中发生动态增减（Insert/Delete），索引可能会越界，导致飞船引擎抛锚（Crash）。我们需要更稳妥的方案。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbc6cdbf02454bbda2291504645d70c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=vC2%2Bo4%2FPUfiUiMlRiNohB8AvhFE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">战术 B：量子胶囊（封装容器）</h3>
<p>亚历克斯点了点头：“没错，作为资深工程师，我们不能冒这个险。我们要用<strong>战术 B：创建一个符合 Identifiable 的包装器（Wrapper）</strong>。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61e5e9b18c20490080df5d9ec8d76ba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=tIIojKt%2Fxr75lDUZ62uqttyBmPE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这相当于给每一个异构货物套上一个标准的“联邦制式胶囊”。这个胶囊有明确的 ID，光脑一扫描就能通过。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 定义一个“量子胶囊”结构体，它必须遵守 Identifiable</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ShadowContainer</span>: <span class="hljs-title class_">Identifiable</span> {
    <span class="hljs-comment">// 🧬 核心：持有那个让编译器困惑的异构数据</span>
    <span class="hljs-keyword">let</span> content: <span class="hljs-keyword">any</span> <span class="hljs-type">IdentifiableFile</span>
    
    <span class="hljs-comment">// 🆔 映射：将内部数据的 ID 投影到胶囊表面</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-type">String</span> {
        content.id
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SecureStarshipView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> rawCargos: [<span class="hljs-keyword">any</span> <span class="hljs-type">IdentifiableFile</span>] <span class="hljs-operator">=</span> [<span class="hljs-comment">/* ... */</span>]
    
    <span class="hljs-comment">// 🔄 转换工序：将原始异构数据封装进胶囊</span>
    <span class="hljs-keyword">var</span> encapsulatedCargos: [<span class="hljs-type">ShadowContainer</span>] {
        rawCargos.map { <span class="hljs-type">ShadowContainer</span>(content: <span class="hljs-variable">$0</span>) }
    }

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">List</span> {
            <span class="hljs-comment">// ✅ 完美通关：ForEach 遍历的是胶囊，胶囊是 Identifiable 的</span>
            <span class="hljs-type">ForEach</span>(encapsulatedCargos) { container <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 在此处“开箱”展示</span>
                <span class="hljs-type">CargoDisplayView</span>(file: container.content)
            }
        }
    }
}
</code></pre>
<p>伊娃看着屏幕上绿色的“编译通过”字样，兴奋地跳了起来：“成功了！通过引入 <code>ShadowContainer</code>，我们既保留了 <code>any</code> 的动态特性，又满足了 <code>ForEach</code> 的静态类型要求。这是一次完美的‘偷天换日’！”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/352de4d7366c4a999647be5b0bca55b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=SJ6GBcuXEOVVZQBLwze9DtDfVGA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">🏁 终章：跃迁成功</h2>
<p>随着亚历克斯按下回车键，Compiler 光脑那冰冷的红色警告终于消失，取而代之的是柔和的绿色进度条。</p>
<p>屏幕上，异构数据如同璀璨的星辰一般，按顺序整齐排列，TextFile 文本清晰可见，ShapeFile 图形棱角分明。SwiftUI 的渲染引擎全功率运转，丝毫没有卡顿。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87eaf83eb63842e19d5e2483331cf419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=ZTr6Me65dM8G6mkFZQ%2FRkg7Z0Kg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“Runtime 号”引擎轰鸣，顺利进入了超空间跃迁。</p>
<p>亚历克斯松了一口气，靠在椅背上，手里转动着那一枚象征着 Apple 开发者最高荣誉的徽章。他转头对伊娃说道：</p>
<p>“你看，编程就像是在宇宙中航行。<strong><code>any</code></strong> 代表着无限的可能与混乱的自由，而 <strong><code>Identifiable</code></strong> 代表着严苛的秩序与规则。我们要做的，不是在二者之间选边站，而是用我们的智慧——比如一个小小的 Wrapper——在这片混沌中建立起连接的桥梁。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11f2bf3b715347fda8636c8638d74474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=L30ecBZO13MogN0mR22XKVbw7No%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">总结</h3>
<ol>
<li><strong>Swift 5.7</strong> 赋予了我们 <code>any</code> 的强大力量，但在 SwiftUI 的 <strong>ForEach</strong> 面前，它依然是个“黑户”。</li>
<li><strong>问题的症结</strong>在于编译器无法确认 <code>any Protocol</code> 这一类型本身是否具有稳定的身份标识。</li>
<li><strong>破解之道</strong>：
<ul>
<li><strong>险招</strong>：遍历 <code>indices</code>，简单快捷，但需提防数组越界这一“暗礁”。</li>
<li><strong>绝招</strong>：创建 <strong>Wrapper（影子容器）</strong>，为异构数据穿上一层符合 <code>Identifiable</code> 的外衣，这是最稳健的星际航行法则。</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64cf6d96aa840b6bf965b2e7e689d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=zIZ%2BRblkEvdrtiVfWSr5lfWGtD8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>星辰大海，代码无疆。各位秃头舰长，愿你们的 App 永远没有 Bug，愿你们的编译永远 Pass！</p>
<p><strong>Engage!</strong> 🛸</p>
<hr/>
<p><em>本文由银河联邦资深架构师亚历克斯（Alex）口述，伊娃（Eva）中尉整理。</em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b03b6d74a4244d4f9acdabe0893d5dbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770010748&amp;x-signature=gCdULTpykdRRVhguJ0GjSTslBbM%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[公司里最懂技术的人，往往不是技术负责人]]></title>    <link>https://juejin.cn/post/7598938568431878159</link>    <guid>https://juejin.cn/post/7598938568431878159</guid>    <pubDate>2026-01-26T05:50:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598938568431878159" data-draft-id="7598938568431861775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="公司里最懂技术的人，往往不是技术负责人"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T05:50:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            公司里最懂技术的人，往往不是技术负责人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:50:33.000Z" title="Mon Jan 26 2026 05:50:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我是一名普普通通的开发者，在这家互联网公司做前端开发第3年。说“资深”算不上，但从最早跟着项目组林的一个大哥，就叫他老周吧。。跟着写业务页面、改样式，到后来独立负责一个核心模块，也参与过需求评审、技术选型、线上事故复盘，团队里大大小小的坑，我基本都踩过一遍。<br/>
也是在这几年里，我慢慢意识到一件事：公司里最懂技术的人，往往并不是那个被叫作“技术负责人”的人。</p>
<p><code>这个结论不是我哪天突然顿悟的，而是一点一点，被现实反复敲出来的。</code></p>
<h2 data-id="heading-0">为什么这么说？</h2>
<p>我们团队里真正的技术大牛，是老周。<br/>
后端出身，比我早来三年，系统里那些“祖传代码”，十有八九都是他写的。数据库慢查询、缓存击穿、接口雪崩，只要问题一出，大家第一反应不是找技术负责人，而是看老周在不在群里。他不爱开会，也不太会“表达观点”，更多时候是埋头写代码，但我们都清楚：系统真正怎么跑、风险在哪，老周心里是有数的。</p>
<p>技术负责人是张经理。<br/>
他不是完全不懂技术，早年也写过代码，但这些年更多在对接产品、协调资源、排期评估。需求评审会上，他总是最忙的那个人，既要回应产品，又要安抚业务，还要给领导一个“稳妥”的时间点。站在组织层面看，他的位置无可替代。只是，懂技术和有决策权，并不在同一个人身上。</p>
<h2 data-id="heading-1">事故</h2>
<p>我第一次对这件事有强烈感受，是一次线上故障。</p>
<p>那是一个周三晚上，九点多，用户群里开始有人反馈页面卡顿。监控一看，接口 RT 飙到了 500ms 以上，数据库 CPU 直接拉满。我和老周赶到公司，他一坐下就开始翻日志、看慢查询，不到半小时，就锁定了问题：核心接口里有一段历史遗留的查询逻辑，嵌套条件太深，导致同一批数据被反复扫描。</p>
<p>老周直接给了优化方案，把冗余查询拆掉，加了一层缓存，压测下来，接口响应时间从 500ms 降到了 80ms，数据库负载明显下降。他把代码推到测试环境，结果很干净。</p>
<p>但问题卡在最后一步：上线。</p>
<p>按照流程，线上代码必须经过技术负责人审批。我负责联系张经理，电话打了三次才接通，他那边还在和产品讨论第二天的需求调整。张经理赶到公司后，看了老周的代码很久，反复问：“这个改动会不会影响其他接口？缓存失效有没有风险？要不要明天拉大家评审一下？”</p>
<p>老周把逻辑解释了一遍，又把测试结果翻给他看，语气已经有点急了。但张经理还是决定稳妥一点，等第二天正式评审再上线。</p>
<p>那一晚，我们只能看着监控曲线一点点往上爬，用户投诉量又涨了三成。第二天评审会的结论很简单：老周方案没问题，可以直接上线。</p>
<p>我坐在会议室里，心里却一点也轻松不起来。<br/>
最懂系统的人，能最快解决问题，却没有拍板权；而决定“现在能不能上”的人，其实并不完全理解那段代码。</p>
<p>那天之后，我第一次清楚地意识到：技术负责人，和“最懂技术的人”，从来不是一个角色。</p>
<hr/>
<p>这种错位，并不是偶发事件，而是日常。</p>
<p>在需求评审会上，产品提出新功能，张经理更多关注的是业务价值、上线时间、能不能配合市场节点。我和老周会从技术角度补充风险，比如接口并发、数据一致性、历史架构是否扛得住。但这些内容，往往只会被记录成一句：“技术评估存在一定风险，后续关注。”</p>
<p>真正拍板的，依然是排期和业务优先级。</p>
<p>张经理并不是不负责，他的考虑是“整体可控”。只是，当技术风险需要用“技术细节”来判断时，话语权天然就偏向了更擅长协调的人。<code>这种感觉，在一次技术选型讨论中，被放大到了极致。</code></p>
<hr/>
<p>去年，技术负责人不知道哪根筋搭错了，拉着我们讨论是否从 Vue2 迁移到 Vue3。<br/>
老周和我提前做了调研，整理了一份很完整的方案：哪些模块可以渐进迁移，哪些公共组件需要重构，迁移成本和收益分别是什么，甚至列了一个风险清单。</p>
<p>评审会上，老周讲得很细，我在旁边补充前端侧的实践经验。但张经理的关注点始终只有一个：“现在系统很稳定，迁移会不会引入不确定性？万一影响现有业务怎么办？”</p>
<p>最后的结论，是<code>继续沿用 Vue2</code>，理由很简单：<code>“稳妥”</code>。 我他妈一口老血喷出来.........你不升级提这个干鸡毛呢？大家都很闲吗？ 话又说回来，我能理解这个选择，也能预见结果。<br/>
技术路线就这样被固定住了，短期风险确实降低了，但长期的技术债，没人拍板去还。</p>
<p>走出会议室时，老周没说什么，只是把那份调研文档默默关掉。我看着他，能明显感觉到那种无力感——不是方案不对，而是他并不在“决策链”上。</p>
<hr/>
<p>说到这里，必须说明一点：这并不是在否定技术负责人。</p>
<p>张经理的价值是真实存在的。没有他，资源协调不动，需求推进不了，很多跨团队的事情根本落不了地。他承担的是“组织风险”，而不是“技术正确性”。</p>
<p>问题在于，当技术决策权，集中在一个更擅长协调、而非最懂技术的人手里时，技术话语权就不可避免地被稀释。懂技术的人负责“把问题想明白”，却未必能决定“要不要这么做”。</p>
<h2 data-id="heading-2">而这一切，都是制度性的结果，并非某个人的失职。</h2>
<hr/>
<p>这些年下来，我对这件事的看法也变得更冷静了。</p>
<p>公司不是技术理想国，技术负责人本就不是“最强程序员”的别称，而是一种管理角色。真正的问题，不是“谁更懂技术”，而是“懂技术的判断，能否被真正尊重”。</p>
<p>我始终觉得，一个技术团队最理想的状态，并不是让张经理去写核心代码，也不是逼老周去学资源博弈，而是让专业的人做专业的事：<br/>
让老周们专注解决复杂问题、啃硬骨头；<br/>
让张经理们专注协调资源、推进节奏；<br/>
同时，让真正懂技术的人，在关键决策中拥有应有的话语权。</p>
<p>如果哪一天，技术负责人在拍板之前，能真正听懂老周在说什么；如果老周的判断，不需要靠一次次事故来“验证正确性”  那这个团队，才算是真的成熟了。</p>
<p>而在那之前，“公司里最懂技术的人，往往不是技术负责人”，恐怕依然会是大多数技术人的日常现实。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🥞Ubuntu24.04/BLIP/Gradio 服务本地部署]]></title>    <link>https://juejin.cn/post/7599166436682940462</link>    <guid>https://juejin.cn/post/7599166436682940462</guid>    <pubDate>2026-01-26T03:41:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599166436682940462" data-draft-id="7599101854644240394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🥞Ubuntu24.04/BLIP/Gradio 服务本地部署"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-26T03:41:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lil_Mino"/> <meta itemprop="url" content="https://juejin.cn/user/239036206160426"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🥞Ubuntu24.04/BLIP/Gradio 服务本地部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/239036206160426/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lil_Mino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:41:49.000Z" title="Mon Jan 26 2026 03:41:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<ul>
<li>
<p>BLIP（Bootstrapping Language-Image Pre-training）是一个为<strong>统一的视觉-语言理解和生成</strong>而设计的多模态预训练模型。它通过创新的模型架构和数据处理方法，有效解决了早期多模态模型在任务灵活性和数据质量方面的局限。下表概括了BLIP模型的核心信息：</p>

































<table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td>全称​</td><td>Bootstrapping Language-Image Pre-training</td></tr><tr><td>核心目标​</td><td>实现视觉-语言理解（如检索、问答）与生成（如图像描述）任务的统一</td></tr><tr><td>模型架构​</td><td>多模态混合编码器-解码器 (MED)​</td></tr><tr><td>核心创新​</td><td>1.MED架构：一个模型同时支持三种模式（单模态编码、图像关联文本编码、图像关联文本解码） 2. CapFilt（数据自举方法）：通过生成和过滤来提升训练数据质量</td></tr><tr><td>主要预训练目标​</td><td>Image-Text Contrastive (ITC), Image-Text Matching (ITM), Language Modeling (LM)</td></tr><tr><td>典型应用​</td><td>图像描述生成、视觉问答（VQA）、图像-文本检索、视觉推理</td></tr></tbody></table>
</li>
<li>
<p>模型架构与工作原理</p>
<ul>
<li>
<p>BLIP的核心在于其<strong>多模态混合</strong> <strong>编码器</strong> <strong>-</strong> <strong>解码器</strong>架构，它巧妙地共享参数，使得一个模型能够胜任多种任务。</p>
</li>
<li>
<p><strong>视觉</strong> <strong>编码器</strong> <strong>(Visual Encoder)</strong> ：通常采用Vision Transformer (ViT)，将输入图像编码成一系列特征向量。</p>
</li>
<li>
<p><strong>文本转换器 (Text Transformer)</strong> ：基于BERT架构，但根据功能不同分为三个角色，<strong>共享大部分参数</strong>（如嵌入层、前馈网络），仅在自注意力层有区别以实现不同功能：</p>
<ol>
<li><strong>文本</strong> <strong>编码器</strong> <strong>(Text Encoder)</strong> ：使用标准的<strong>双向自注意力</strong>机制，用于提取文本特征。它与视觉编码器共同完成<strong>图像-文本对比学习（</strong> <strong>ITC</strong> <strong>）</strong> ，目标是拉近匹配的图像-文本对的特征距离，推远不匹配的对的距离。</li>
<li><strong>基于图像的文本</strong> <strong>编码器</strong> <strong>(Image-grounded Text Encoder)</strong> ：在文本编码器的每个Transformer块中插入了<strong>交叉注意力（Cross-Attention）层</strong>，以便视觉特征能够注入到文本表示中。它负责<strong>图像-文本匹配（ITM）</strong> 任务，判断一段文本是否与一张图像匹配，从而学习更细粒度的对齐关系。</li>
<li><strong>基于图像的文本</strong> <strong>解码器</strong> <strong>(Image-grounded Text</strong> <strong>Decoder</strong> <strong>)</strong> ：将文本编码器中的双向自注意力层替换为<strong>因果自注意力（Causal Self-Attention）</strong> 层，用于<strong>语言建模（</strong> <strong>LM</strong> <strong>）</strong> 。它以自回归的方式生成文本描述，即根据图像和已生成的词来预测下一个词。</li>
</ol>
</li>
</ul>
</li>
<li>
<p>创新数据处理：CapFilt</p>
<ul>
<li>  为了解决网络图像-文本对数据噪声大的问题，BLIP提出了 <strong>Captioning and Filtering (CapFilt)</strong> 方法。</li>
<li><strong>Captioner（字幕生成器）</strong> ：由一个在高质量人工标注数据（如COCO）上微调过的MED解码器担任。它的任务是为网络上的图片生成新的、描述准确的文本说明（合成字幕）。</li>
<li><strong>Filter（过滤器）</strong> ：由一个在高质量数据上微调过的MED编码器（图像关联文本编码器）担任。它负责判断给定的图像-文本对是否匹配，从而过滤掉原始网络文本和字幕生成器产生的合成文本中的噪声数据。</li>
<li>  这个过程最终会得到一个<strong>净化后的、高质量的数据集</strong>，用于预训练最终版本的BLIP模型，显著提升了模型性能。</li>
</ul>
</li>
<li>
<p>主要能力与应用场景</p>
<p>基于其统一的架构，BLIP在多种视觉-语言任务上表现出色：</p>
<ul>
<li>
<p><strong>图像描述生成</strong>：为给定的图像生成自然、准确的文字描述。</p>
</li>
<li>
<p><strong>视觉问答</strong>：根据图像内容回答自然语言问题。</p>
</li>
<li>
<p><strong>图像-文本检索</strong>：实现以图搜文或以文搜图，包括零样本检索能力。</p>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">图像描述(Gradio 服务)</h2>
<ul>
<li>
<p>拉取模型：</p>
<pre><code class="hljs language-bash" lang="bash">modelscope download --model Salesforce/blip-image-captioning-large  --local_dir /i/xiaom/blip/models/blip-image-captioning-large
</code></pre>
</li>
<li>
<p>Gradio 服务：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># blip_gradio.py</span>
<span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BlipProcessor, BlipForConditionalGeneration
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> os

MODEL_PATH = <span class="hljs-string">"./models/blip-image-captioning-large"</span>

<span class="hljs-comment"># 检查模型路径是否存在</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(MODEL_PATH):
    <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">f"模型路径不存在: <span class="hljs-subst">{MODEL_PATH}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在从本地路径加载大型模型: <span class="hljs-subst">{MODEL_PATH}</span>"</span>)
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 从本地目录加载预训练模型和处理器</span>
    processor = BlipProcessor.from_pretrained(MODEL_PATH)
    model = BlipForConditionalGeneration.from_pretrained(MODEL_PATH)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"大型模型加载完成！"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型加载失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
    <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_caption</span>(<span class="hljs-params">image</span>):
    <span class="hljs-string">"""
    生成图片描述 - 使用更大的模型
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 确保图片是RGB格式</span>
        <span class="hljs-keyword">if</span> image.mode != <span class="hljs-string">'RGB'</span>:
            image = image.convert(<span class="hljs-string">'RGB'</span>)

        <span class="hljs-comment"># 图像预处理与生成文本描述</span>
        inputs = processor(image, return_tensors=<span class="hljs-string">"pt"</span>)
        out = model.generate(**inputs)
        caption = processor.decode(out[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)

        <span class="hljs-keyword">return</span> caption

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"处理图片时出现错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_image</span>(<span class="hljs-params">image</span>):
    <span class="hljs-string">"""
    处理图片并返回描述
    """</span>
    caption = generate_caption(image)
    <span class="hljs-keyword">return</span> caption

<span class="hljs-comment"># 创建Gradio界面</span>
<span class="hljs-keyword">with</span> gr.Blocks(title=<span class="hljs-string">"BLIP图片描述生成"</span>, theme=gr.themes.Soft()) <span class="hljs-keyword">as</span> demo:
    gr.Markdown(
        <span class="hljs-string">"""
        # 🖼️ BLIP图片描述生成
        """</span>.<span class="hljs-built_in">format</span>(model_path=MODEL_PATH)
    )

    <span class="hljs-keyword">with</span> gr.Row():
        <span class="hljs-keyword">with</span> gr.Column():
            image_input = gr.Image(
                label=<span class="hljs-string">"上传图片"</span>,
                <span class="hljs-built_in">type</span>=<span class="hljs-string">"pil"</span>,
                sources=[<span class="hljs-string">"upload"</span>, <span class="hljs-string">"clipboard"</span>],
                height=<span class="hljs-number">300</span>
            )
            submit_btn = gr.Button(<span class="hljs-string">"生成描述"</span>, variant=<span class="hljs-string">"primary"</span>)

        <span class="hljs-keyword">with</span> gr.Column():
            caption_output = gr.Textbox(
                label=<span class="hljs-string">"图片描述"</span>,
                placeholder=<span class="hljs-string">"更详细、更精确的描述将在这里显示..."</span>,
                lines=<span class="hljs-number">4</span>,
                max_lines=<span class="hljs-number">8</span>
            )

    <span class="hljs-comment"># 绑定事件</span>
    submit_btn.click(
        fn=process_image,
        inputs=image_input,
        outputs=caption_output
    )

<span class="hljs-comment"># 启动服务</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    demo.launch(
        server_name=<span class="hljs-string">"0.0.0.0"</span>,
        server_port=<span class="hljs-number">29999</span>,
        share=<span class="hljs-literal">False</span>,
        show_error=<span class="hljs-literal">True</span>
    )
</code></pre>
</li>
<li>
<p>运行效果：描述倒是很准确，但是太过简略</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6558fcbb5fe3493190922da416bb83df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlsX01pbm8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003976&amp;x-signature=jwixvcXzeluaptJUYKtSUh9gngg%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ae6709a663496e806c9f3c2fc1868c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlsX01pbm8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003976&amp;x-signature=nd3eIAS13tr7FSeceeZFd5UpIdI%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>优化一下</p>
<ul>
<li>
<p>多提示词生成</p>
</li>
<li>
<p>激进的生成参数</p>
<pre><code class="hljs language-python" lang="python">max_length=<span class="hljs-number">150</span>,  <span class="hljs-comment"># 大幅增加最大长度</span>
num_beams=<span class="hljs-number">8</span>,     <span class="hljs-comment"># 增加beam搜索宽度</span>
length_penalty=<span class="hljs-number">3.0</span>,  <span class="hljs-comment"># 强烈鼓励长文本</span>
repetition_penalty=<span class="hljs-number">1.8</span>,  <span class="hljs-comment"># 更强的重复惩罚</span>
</code></pre>
</li>
<li>
<p>多轮迭代生成</p>
<ul>
<li>第一轮生成基础描述</li>
<li>后续轮次基于前一轮结果添加细节</li>
<li>最多进行3轮迭代</li>
</ul>
</li>
<li>
<p>智能后处理</p>
<ul>
<li>自动检测过短的描述</li>
<li>使用专门提示词进行扩展</li>
<li>组合多个描述的独特部分
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> BlipProcessor, BlipForConditionalGeneration
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> re

MODEL_PATH = <span class="hljs-string">"./models/blip-image-captioning-large"</span>

<span class="hljs-comment"># 检查模型路径是否存在</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(MODEL_PATH):
    <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">f"模型路径不存在: <span class="hljs-subst">{MODEL_PATH}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在从本地路径加载大型模型: <span class="hljs-subst">{MODEL_PATH}</span>"</span>)
<span class="hljs-keyword">try</span>:
    processor = BlipProcessor.from_pretrained(MODEL_PATH)
    model = BlipForConditionalGeneration.from_pretrained(MODEL_PATH)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"大型模型加载完成！"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"模型加载失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
    <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_caption</span>(<span class="hljs-params">caption</span>):
    <span class="hljs-string">"""
    清理描述，移除所有提示词内容和冒号
    """</span>
    <span class="hljs-comment"># 移除常见的提示词模式</span>
    patterns_to_remove = [
        <span class="hljs-string">r'^a photography of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a detailed photography of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a professional photography of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a high resolution photography of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a picture of\s*:?\s*'</span>,
        <span class="hljs-string">r'^an image of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a photo of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a close up of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a view of\s*:?\s*'</span>,
        <span class="hljs-string">r'^a scene of\s*:?\s*'</span>,
        <span class="hljs-string">r'^provide a comprehensive description of this image that shows\s*:?\s*'</span>,
        <span class="hljs-string">r'^describe this image in detail, including\s*:?\s*'</span>,
        <span class="hljs-string">r'^write a detailed paragraph about this image featuring\s*:?\s*'</span>,
        <span class="hljs-string">r'^add more specific visual details to this description\s*:?\s*'</span>,
    ]
    
    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> patterns_to_remove:
        caption = re.sub(pattern, <span class="hljs-string">''</span>, caption, flags=re.IGNORECASE)
    
    <span class="hljs-comment"># 移除开头的冒号和空格</span>
    caption = re.sub(<span class="hljs-string">r'^:\s*'</span>, <span class="hljs-string">''</span>, caption)
    
    <span class="hljs-comment"># 移除开头的标点符号和空格</span>
    caption = re.sub(<span class="hljs-string">r'^[.,!?;-\s]*'</span>, <span class="hljs-string">''</span>, caption)
    
    <span class="hljs-comment"># 确保首字母大写</span>
    <span class="hljs-keyword">if</span> caption <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(caption) &gt; <span class="hljs-number">0</span>:
        caption = caption[<span class="hljs-number">0</span>].upper() + caption[<span class="hljs-number">1</span>:]
    
    <span class="hljs-keyword">return</span> caption.strip()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_comprehensive_description</span>(<span class="hljs-params">image, style=<span class="hljs-string">"detailed"</span></span>):
    <span class="hljs-string">"""
    生成全面详细的图片描述 - 使用多种技术强制生成长描述
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> image.mode != <span class="hljs-string">'RGB'</span>:
            image = image.convert(<span class="hljs-string">'RGB'</span>)
        
        <span class="hljs-comment"># 使用更强的提示词来强制生成详细描述</span>
        detailed_prompts = [
            <span class="hljs-string">"a photography of"</span>,
            <span class="hljs-string">"a detailed photography of"</span>,
            <span class="hljs-string">"a professional photography of"</span>,
            <span class="hljs-string">"a high resolution photography of"</span>
        ]
        
        all_captions = []
        
        <span class="hljs-comment"># 使用多个提示词生成多个描述</span>
        <span class="hljs-keyword">for</span> prompt <span class="hljs-keyword">in</span> detailed_prompts:
            inputs = processor(image, text=prompt, return_tensors=<span class="hljs-string">"pt"</span>)
            
            <span class="hljs-keyword">with</span> torch.no_grad():
                out = model.generate(
                    **inputs,
                    max_length=<span class="hljs-number">150</span>,  <span class="hljs-comment"># 显著增加最大长度</span>
                    num_beams=<span class="hljs-number">8</span>,     <span class="hljs-comment"># 增加beam数量</span>
                    temperature=<span class="hljs-number">0.8</span>,
                    repetition_penalty=<span class="hljs-number">1.8</span>,  <span class="hljs-comment"># 增加重复惩罚</span>
                    do_sample=<span class="hljs-literal">True</span>,
                    early_stopping=<span class="hljs-literal">False</span>,   <span class="hljs-comment"># 不提前停止</span>
                    length_penalty=<span class="hljs-number">3.0</span>,     <span class="hljs-comment"># 大幅增加长度奖励</span>
                    no_repeat_ngram_size=<span class="hljs-number">4</span>, <span class="hljs-comment"># 增加n-gram惩罚</span>
                    num_return_sequences=<span class="hljs-number">1</span>
                )
            
            caption = processor.decode(out[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># 清理描述 - 移除所有提示词内容</span>
            caption = clean_caption(caption)
            
            <span class="hljs-keyword">if</span> caption <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(caption) &gt; <span class="hljs-number">20</span>:  <span class="hljs-comment"># 只保留有意义的描述</span>
                all_captions.append(caption)
        
        <span class="hljs-comment"># 如果生成了多个描述，组合它们</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(all_captions) &gt; <span class="hljs-number">1</span>:
            <span class="hljs-comment"># 选择最长的描述</span>
            final_caption = <span class="hljs-built_in">max</span>(all_captions, key=<span class="hljs-built_in">len</span>)
            
            <span class="hljs-comment"># 如果还是太短，尝试组合</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(final_caption.split()) &lt; <span class="hljs-number">25</span>:
                unique_parts = []
                <span class="hljs-keyword">for</span> cap <span class="hljs-keyword">in</span> all_captions:
                    words = cap.split()
                    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> words:
                        <span class="hljs-keyword">if</span> word <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> unique_parts <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(word) &gt; <span class="hljs-number">3</span>:
                            unique_parts.append(word)
                
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(unique_parts) &gt; <span class="hljs-number">10</span>:
                    final_caption = <span class="hljs-string">"The image shows "</span> + <span class="hljs-string">", "</span>.join(unique_parts[:<span class="hljs-number">15</span>]) + <span class="hljs-string">". "</span> + final_caption
        <span class="hljs-keyword">else</span>:
            final_caption = all_captions[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> all_captions <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
        
        <span class="hljs-comment"># 如果描述仍然很短，使用后处理扩展</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(final_caption.split()) &lt; <span class="hljs-number">15</span>:
            final_caption = extend_short_caption(final_caption, image)
        
        <span class="hljs-keyword">return</span> final_caption
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"处理图片时出现错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">extend_short_caption</span>(<span class="hljs-params">short_caption, image</span>):
    <span class="hljs-string">"""
    对过短的描述进行扩展
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(short_caption.split()) &lt; <span class="hljs-number">10</span>:
            <span class="hljs-comment"># 使用更具体的提示词来扩展</span>
            extension_prompts = [
                <span class="hljs-string">f"Provide a comprehensive description of this image that shows <span class="hljs-subst">{short_caption}</span>"</span>,
                <span class="hljs-string">f"Describe this image in detail, including <span class="hljs-subst">{short_caption}</span>"</span>,
                <span class="hljs-string">f"Write a detailed paragraph about this image featuring <span class="hljs-subst">{short_caption}</span>"</span>
            ]
            
            extended_captions = []
            
            <span class="hljs-keyword">for</span> prompt <span class="hljs-keyword">in</span> extension_prompts:
                inputs = processor(image, text=prompt, return_tensors=<span class="hljs-string">"pt"</span>)
                
                <span class="hljs-keyword">with</span> torch.no_grad():
                    out = model.generate(
                        **inputs,
                        max_length=<span class="hljs-number">200</span>,  <span class="hljs-comment"># 更长的最大长度</span>
                        num_beams=<span class="hljs-number">6</span>,
                        temperature=<span class="hljs-number">0.9</span>,
                        repetition_penalty=<span class="hljs-number">1.5</span>,
                        do_sample=<span class="hljs-literal">True</span>,
                        length_penalty=<span class="hljs-number">2.5</span>,
                        no_repeat_ngram_size=<span class="hljs-number">3</span>
                    )
                
                extended = processor.decode(out[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
                
                <span class="hljs-comment"># 清理扩展的描述 - 移除所有提示词内容</span>
                extended = clean_caption(extended)
                
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(extended.split()) &gt; <span class="hljs-built_in">len</span>(short_caption.split()) + <span class="hljs-number">5</span>:
                    extended_captions.append(extended)
            
            <span class="hljs-keyword">if</span> extended_captions:
                <span class="hljs-comment"># 返回最长的扩展描述</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(extended_captions, key=<span class="hljs-built_in">len</span>)
        
        <span class="hljs-keyword">return</span> short_caption
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"扩展描述时出错: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> short_caption

<span class="hljs-keyword">def</span> <span class="hljs-title function_">multi_round_description</span>(<span class="hljs-params">image, rounds=<span class="hljs-number">2</span></span>):
    <span class="hljs-string">"""
    多轮描述生成 - 每轮基于前一轮的结果添加更多细节
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 第一轮生成基础描述</span>
        base_caption = generate_comprehensive_description(image)
        
        <span class="hljs-keyword">if</span> rounds &lt;= <span class="hljs-number">1</span>:
            <span class="hljs-keyword">return</span> base_caption
        
        current_description = base_caption
        
        <span class="hljs-keyword">for</span> round_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, rounds):
            <span class="hljs-comment"># 基于当前描述添加更多细节</span>
            enhancement_prompt = <span class="hljs-string">f"Add more specific visual details to this description: <span class="hljs-subst">{current_description}</span>"</span>
            
            inputs = processor(image, text=enhancement_prompt, return_tensors=<span class="hljs-string">"pt"</span>)
            
            <span class="hljs-keyword">with</span> torch.no_grad():
                out = model.generate(
                    **inputs,
                    max_length=<span class="hljs-number">250</span>,
                    num_beams=<span class="hljs-number">7</span>,
                    temperature=<span class="hljs-number">0.85</span>,
                    repetition_penalty=<span class="hljs-number">1.6</span>,
                    do_sample=<span class="hljs-literal">True</span>,
                    length_penalty=<span class="hljs-number">2.0</span>,
                    no_repeat_ngram_size=<span class="hljs-number">4</span>
                )
            
            enhanced = processor.decode(out[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># 清理增强的描述 - 移除所有提示词内容</span>
            enhanced = clean_caption(enhanced)
            
            <span class="hljs-comment"># 只有当新描述明显更长时才更新</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(enhanced.split()) &gt; <span class="hljs-built_in">len</span>(current_description.split()) + <span class="hljs-number">8</span>:
                current_description = enhanced
        
        <span class="hljs-keyword">return</span> current_description
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"多轮生成时出错: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> generate_comprehensive_description(image)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_image_ultimate</span>(<span class="hljs-params">image, detail_level=<span class="hljs-string">"high"</span>, use_multi_round=<span class="hljs-literal">True</span></span>):
    <span class="hljs-string">"""
    终极图片处理函数 - 使用所有可用技术生成最详细的描述
    """</span>
    <span class="hljs-keyword">if</span> use_multi_round:
        <span class="hljs-keyword">if</span> detail_level == <span class="hljs-string">"high"</span>:
            rounds = <span class="hljs-number">3</span>
        <span class="hljs-keyword">elif</span> detail_level == <span class="hljs-string">"medium"</span>:
            rounds = <span class="hljs-number">2</span>
        <span class="hljs-keyword">else</span>:
            rounds = <span class="hljs-number">1</span>
        
        <span class="hljs-keyword">return</span> multi_round_description(image, rounds=rounds)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> generate_comprehensive_description(image)

<span class="hljs-comment"># 创建终极界面</span>
<span class="hljs-keyword">with</span> gr.Blocks(title=<span class="hljs-string">"BLIP超详细图片描述生成器"</span>, theme=gr.themes.Soft()) <span class="hljs-keyword">as</span> demo:
    gr.Markdown(
        <span class="hljs-string">"""
        # 🖼️ BLIP超详细图片描述生成器
        """</span>
    )
    
    <span class="hljs-keyword">with</span> gr.Row():
        <span class="hljs-keyword">with</span> gr.Column():
            image_input = gr.Image(
                label=<span class="hljs-string">"上传图片"</span>,
                <span class="hljs-built_in">type</span>=<span class="hljs-string">"pil"</span>,
                sources=[<span class="hljs-string">"upload"</span>, <span class="hljs-string">"clipboard"</span>],
                height=<span class="hljs-number">300</span>
            )
            
            <span class="hljs-keyword">with</span> gr.Accordion(<span class="hljs-string">"详细程度设置"</span>, <span class="hljs-built_in">open</span>=<span class="hljs-literal">True</span>):
                detail_level = gr.Radio(
                    choices=[
                        (<span class="hljs-string">"超高详细 (推荐)"</span>, <span class="hljs-string">"high"</span>),
                        (<span class="hljs-string">"中等详细"</span>, <span class="hljs-string">"medium"</span>),
                        (<span class="hljs-string">"基础详细"</span>, <span class="hljs-string">"low"</span>)
                    ],
                    value=<span class="hljs-string">"high"</span>,
                    label=<span class="hljs-string">"详细程度"</span>,
                    info=<span class="hljs-string">"选择描述的详细程度"</span>
                )
                
                use_multi_round = gr.Checkbox(
                    value=<span class="hljs-literal">True</span>,
                    label=<span class="hljs-string">"启用多轮生成 (显著增加描述长度)"</span>
                )
            
            submit_btn = gr.Button(<span class="hljs-string">"🚀 生成超详细描述"</span>, variant=<span class="hljs-string">"primary"</span>, size=<span class="hljs-string">"lg"</span>)
            
            gr.Markdown(<span class="hljs-string">"""
            **技术说明**:
            - **多提示词生成**: 使用多个提示词生成多个候选描述
            - **长度强制**: 通过参数设置强制生成长文本
            - **多轮迭代**: 基于前一轮结果添加更多细节
            - **后处理扩展**: 对过短描述进行智能扩展
            - **智能清理**: 自动移除提示词和冒号前的内容
            
            **推荐设置**: 启用"超高详细"和"多轮生成"获得最佳效果
            """</span>)
        
        <span class="hljs-keyword">with</span> gr.Column():
            caption_output = gr.Textbox(
                label=<span class="hljs-string">"生成的超详细描述"</span>,
                placeholder=<span class="hljs-string">"这里将显示非常详细的图片描述..."</span>,
                lines=<span class="hljs-number">10</span>,
                max_lines=<span class="hljs-number">20</span>,
                show_copy_button=<span class="hljs-literal">True</span>
            )
            
            <span class="hljs-keyword">with</span> gr.Accordion(<span class="hljs-string">"统计信息"</span>, <span class="hljs-built_in">open</span>=<span class="hljs-literal">False</span>):
                caption_length = gr.Textbox(
                    label=<span class="hljs-string">"描述长度"</span>,
                    placeholder=<span class="hljs-string">"字符数和词数将在这里显示..."</span>,
                    lines=<span class="hljs-number">1</span>
                )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_caption_length</span>(<span class="hljs-params">caption</span>):
        <span class="hljs-string">"""更新描述长度统计"""</span>
        <span class="hljs-keyword">if</span> caption <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> caption.startswith(<span class="hljs-string">"处理图片时出现错误"</span>):
            char_count = <span class="hljs-built_in">len</span>(caption)
            word_count = <span class="hljs-built_in">len</span>(caption.split())
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"字符数: <span class="hljs-subst">{char_count}</span>, 词数: <span class="hljs-subst">{word_count}</span>"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>

    <span class="hljs-comment"># 绑定事件</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_and_update</span>(<span class="hljs-params">image, detail, multi_round</span>):
        caption = process_image_ultimate(image, detail, multi_round)
        length_info = update_caption_length(caption)
        <span class="hljs-keyword">return</span> caption, length_info
    
    submit_btn.click(
        fn=process_and_update,
        inputs=[image_input, detail_level, use_multi_round],
        outputs=[caption_output, caption_length]
    )

<span class="hljs-comment"># 启动服务</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    demo.launch(
        server_name=<span class="hljs-string">"0.0.0.0"</span>,
        server_port=<span class="hljs-number">29999</span>,
        share=<span class="hljs-literal">False</span>,
        show_error=<span class="hljs-literal">True</span>
    )
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>优化效果：还不错，至少增加了前后景的描述；后期增加大模型的润色会更好</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32eaa12985b24950b49a4d07a78d42a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlsX01pbm8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003976&amp;x-signature=Xq3VGXrGIzzU0d0uXlN8CXe6ho0%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7d13d7033b344a6a164a937762e1e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGlsX01pbm8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003976&amp;x-signature=iIucPUMGZufSTWWsmI5i2ygCrvc%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-2">总结</h2>
<p>相比于 CLIP 那种特征向量、语义分析级别的图片描述内容，BLIP 的描述结果就很直接和可观，利于供给大模型进行图像识别分析与回答</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[发现了 GitHub 上 4 个文档工具开源项目，来瞧瞧。]]></title>    <link>https://juejin.cn/post/7599053532167766057</link>    <guid>https://juejin.cn/post/7599053532167766057</guid>    <pubDate>2026-01-26T05:44:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599053532167766057" data-draft-id="7599155566296776747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="发现了 GitHub 上 4 个文档工具开源项目，来瞧瞧。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-26T05:44:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            发现了 GitHub 上 4 个文档工具开源项目，来瞧瞧。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:44:55.000Z" title="Mon Jan 26 2026 05:44:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>01</p>
<p><strong>文档协作平台</strong></p>
<p>Docs 开源项目的背景相当强悍，是由法国和德国政府联合发起的。现在已经在 GitHub 上获得 15.5K 的 Star 了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/359ab719ce4f43c1baffa8717982b06b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=IPz7CSJ0LZt89Q7%2BQVti%2FU1dRiQ%3D" alt="图片" loading="lazy"/></p>
<p>这一个支持实时协作的文档平台，主要用来做笔记、写文档或者搭建团队知识库。</p>
<p>编辑器采用了现在流行的块状编辑模式，你可以随意拖拽段落、图片和表格。多人同时在线编辑时，你能看到队友的光标在屏幕上飞舞，这种实时同步的体验非常流畅。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7112eb1628af42cd902ca480262365d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=X%2BCMdeiNaj1E5ciN93Ya9Nauedg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57551a5e6a4349208b1a52370b24a5e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=87znvqncOmMuX7IGhGO3%2FawRoUI%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b15404b633f417ba1021c44eb9b87cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=DsTpsVMCXqHybjyKNF%2FYs2R47k0%3D" alt="图片" loading="lazy"/></p>
<p>技术层面它采用了 React 和 Django 开发，并且支持 Docker 部署。</p>
<p>如果你不想把资料放在公有云上，完全可以自己搭建一套。它还支持导出 PDF 和 Word 格式，基本满足了日常办公的需求。</p>
<pre><code class="hljs language-arduino" lang="arduino">项目地址：https:<span class="hljs-comment">//github.com/suitenumerique/docs</span>
</code></pre>
<p>02</p>
<p><strong>神奇的文档网站生成器</strong></p>
<p>将 Markdown 格式的文本转换为漂亮的网页，通常会使用各种静态网站生成器，比如 Hexo、GitBook 啥的。</p>
<p>你需要安装依赖，运行构建命令，将 Markdown 编译成 HTML 文件，最后再将这些静态文件部署到服务器上。</p>
<p>如果想修改一个错别字，也需要重新构建并部署整个网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3af3effe2574f708ce4f0e834df3ecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=UQUxZCiv7uvjrxJ%2BRfoqrTYyrDw%3D" alt="图片" loading="lazy"/></p>
<p>docsify 是一个神奇的文档网站生成器。</p>
<p>它不需要构建，不会将 Markdown 文件预先编译成 HTML 文件。</p>
<p>相反，它会在网页加载时，通过 JavaScript 动态地请求 Markdown 文件，并将其解析为 HTML 呈现给用户。</p>
<p>你的文档网站实际上只是一个 index.html 文件加上一堆 Markdown 文件。</p>
<p>当你修改了 Markdown 内容并保存后，刷新浏览器就能立刻看到最新的效果，完全不需要等待构建工具处理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6a313a54f1d4d74b7107f1b1b78f6b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=YXyRLjPwk%2BA2%2F7X%2Br3BryIRPru4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f889cf8fe4534ca2a5ef25f8fa56969f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=IqHwmKj1lpxLvys3YXhf%2BSz6jlg%3D" alt="图片" loading="lazy"/></p>
<p>这种轻量级的设计思路，使得 docsify 非常适合作为开源项目的文档说明，或者个人的技术笔记站点。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/docsifyjs/docsify</span>
</code></pre>
<p>03</p>
<p><strong>小白也能用的本地化知识库 AI</strong></p>
<p>谷歌的 NotebookLM 让很多人体验到了跟知识库对话的便利，但并不是每个人都愿意把私密文档上传到云端，尤其是老外。</p>
<p>KnowNote 就是为了解决这个问题而诞生的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4415987ce54678b9ee39b41968722d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=9e0ALqRVFnvkYSiuwcV63Jv9qxE%3D" alt="图片" loading="lazy"/></p>
<p>KnowNote 是一个可以在本地运行的桌面软件。它的功能非常直观，你把 PDF、Word 或者 PPT 拖进去，它就会自动解析。</p>
<p>然后你就可以针对这些文档进行提问。它底层支持多种 AI 模型，包括本地运行的 Ollama 或者云端的 OpenAI 等接口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59329abfc082420997f2d893c694a38b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=ELTm7xTujmCs6aFyS%2BxIvwBd9ko%3D" alt="图片" loading="lazy"/></p>
<p>作者还贴心地加入了一键生成思维导图的功能，可以帮你快速理清文档脉络。</p>
<p>对于学生党、研究人员或者任何需要处理大量文献资料但又不想折腾技术细节的人来说，这绝对是一个得力助手。</p>
<p>数据在本地，模型在本地，用起来既安全又踏实。</p>
<pre><code class="hljs language-arduino" lang="arduino">项目地址：https:<span class="hljs-comment">//github.com/MrSibe/KnowNote</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0453a18c03b3472f988805891d9c5166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=MIk9hPhGjWpKBLucj3Z%2BRk3IWcA%3D" alt="图片" loading="lazy"/></p>
<p>04</p>
<p><strong>苹果原生的文档对话助手</strong></p>
<p>Raven 是一个专门为 macOS 和 iOS 设计的文档聊天应用。它直接调用了苹果系统自带的基础模型能力。这意味着你不需要联网，也不需要把文件发送给任何第三方服务器，所有的处理都在你的设备上完成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c2d730db8a7492297683c19e60fefc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=Rhh70bJETatqVu2SmMPrkzkCSIE%3D" alt="图片" loading="lazy"/></p>
<p>它的界面看起来非常干净清爽，就像是系统自带的应用一样。你可以导入各种文档，然后让它帮你总结内容或者回答相关问题。由于它是用 Swift 语言原生开发的，运行效率非常高，不会像一些网页套壳应用那样占用大量内存。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e12fa5334b4733b79752c654ca98cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=YPkxfvI7hHKdCtAPOyEVMjyEzxw%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d572bc69b2448f90bb125c52f61357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=n3u%2BUjBJ0b9W2m%2Bk6rg7xIi%2FHJI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e65a67b10db406da406f5cf7520a70d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=Y4FVD8BMupHaCgb7jHUZ3yBuY7Y%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8d60f135b0e4ef5853e6e8a78ae9617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=qqrGilIK3KFKUsSAjLjaywUY7zI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03ebabae8d2543069b0263fb00dc566d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=dypF0%2BVmk%2BkmccJrhE43yD07Sro%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104753c062ee42df91a99889b4e07676~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770011096&amp;x-signature=%2BZFSQ7dPBNMCycRjXzSNMUUAeIs%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">项目地址：https:<span class="hljs-comment">//github.com/31d4r/Raven</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第 14 章：DAG 工作流——解开任务的“死结”]]></title>    <link>https://juejin.cn/post/7599181528304320521</link>    <guid>https://juejin.cn/post/7599181528304320521</guid>    <pubDate>2026-01-26T04:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599181528304320521" data-draft-id="7599181528304287753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第 14 章：DAG 工作流——解开任务的“死结”"/> <meta itemprop="keywords" content="前端,Agent,AIGC"/> <meta itemprop="datePublished" content="2026-01-26T04:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芋圆ai"/> <meta itemprop="url" content="https://juejin.cn/user/1451828494217415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第 14 章：DAG 工作流——解开任务的“死结”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1451828494217415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芋圆ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:03:51.000Z" title="Mon Jan 26 2026 04:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第14章：DAG 工作流：解开任务的“死结”</h2>
<blockquote>
<p><strong>如果说“并行”是让一群人一起冲，那么 DAG（有向无环图）就是指挥官手中的作战地图——它规定了谁先冲，谁掩护，谁最后打扫战场。没有这张图，你的 Agent 军团只是一群乌合之众。</strong></p>
</blockquote>
<p>上一章我们讲了多 Agent 编排的基础：要么大家排队做（串行），要么大家一起上（并行）。 但在现实世界中，大部分商业任务既不是单纯的“一条线”，也不是单纯的“一窝蜂”。</p>
<p><strong>看一个真实的商业分析场景：</strong> 老板让你分析“特斯拉 2024 年的竞争力”。 这包含三个看似独立的子任务，实则暗藏玄机：</p>
<ol>
<li><strong>搜财报</strong>：查特斯拉去年的营收和利润。</li>
<li><strong>搜竞品</strong>：查比亚迪和 Rivian 的数据。</li>
<li><strong>写报告</strong>：对比两者的优劣势，给出结论。</li>
</ol>
<p><strong>你怎么调度？</strong></p>
<ul>
<li><strong>全串行？</strong> 太慢了。搜财报和搜竞品明明是两件互不干扰的事，为什么要像接力赛一样等？这会浪费宝贵的响应时间。</li>
<li><strong>全并行？</strong> 不行。如果你让“写报告”的 Agent 和前两个一起开工，它会一脸懵逼：“老板，数据还没查到，你让我分析什么？”对着空气分析，只能产生幻觉。</li>
</ul>
<p>这时候，我们需要引入 <strong>DAG（Directed Acyclic Graph，有向无环图）</strong> 。 它是解决复杂依赖关系的终极武器，也是区分“脚本小子”和“系统架构师”的分水岭。</p>
<h3 data-id="heading-1">01. 什么是 DAG？（给产品经理的图论课）</h3>
<p>别被这个数学名词吓到了。我们把它拆解开来，它其实描述了世间万物运转的基本规律：</p>
<ol>
<li><strong>有向（Directed）</strong> ：时间是单向流动的，任务也是。A 做完才能做 B，箭头只能从 A 指向 B。如果你想时光倒流，那是科幻片。</li>
<li><strong>无环（Acyclic）</strong> ：不能有死循环。A 等 B，B 等 C，C 又回头等 A —— 这就是著名的<strong>死锁（Deadlock）</strong> 。一旦形成环，三个任务都会永远卡在“等待”状态，直到服务器重启。</li>
</ol>
<p><strong>DAG 的本质就是一张“依赖关系网”。</strong> 它不关心任务的具体内容，只关心“谁在谁前面”。</p>
<h4 data-id="heading-2">形象的比喻：盖房子</h4>
<p>想象一下建筑工地的流程，这就是一个完美的 DAG：</p>
<ul>
<li>
<p><strong>地基（任务 A）</strong> ：这是起点，必须最先做。没有地基，一切免谈。</p>
</li>
<li>
<p><strong>砌墙（任务 B）</strong> 和 <strong>布线（任务 C）</strong> ：</p>
<ul>
<li>它们都依赖地基（A）。</li>
<li>但它们之间互不依赖。砌墙的师傅和拉电线的师傅可以<strong>同时干活</strong>（并行），互不干扰，极大提升效率。</li>
</ul>
</li>
<li>
<p><strong>封顶（任务 D）</strong> ：</p>
<ul>
<li>它是汇聚点。</li>
<li>必须等墙砌好（B 完成）、线布好（C 完成）之后，才能封顶。缺一不可，否则房子就塌了。</li>
</ul>
</li>
</ul>
<p>这就是 DAG 工作流：<strong>既有串行的严谨，又有并行的效率。</strong></p>
<h3 data-id="heading-3">02. 三种执行模式：从简单到复杂</h3>
<p>在 Shannon 的编排器中，我们不会让用户手写复杂的图算法。我们根据任务的“拓扑结构”，自动选择三种执行模式：</p>
<h4 data-id="heading-4">模式 A：并行蜂群（Parallel）</h4>
<ul>
<li><strong>拓扑结构</strong>：所有节点互不相连，像散落的弹珠。</li>
<li><strong>适用场景</strong>：搜集 5 家公司的 Logo、生成 10 个不同的创意标题。</li>
<li><strong>核心逻辑</strong>：<code>go func()</code> 全部启动，谁先回来谁赢。这是最快的模式，但也最容易把系统打挂。</li>
</ul>
<h4 data-id="heading-5">模式 B：串行接力（Sequential）</h4>
<ul>
<li><strong>拓扑结构</strong>：一条直线（A -&gt; B -&gt; C），像糖葫芦。</li>
<li><strong>适用场景</strong>：写代码 -&gt; 运行代码 -&gt; 根据报错修复 Bug。</li>
<li><strong>核心逻辑</strong>：上一步的输出（Output）是下一步的输入（Input）。如果第一步就错了，后面做得再快也是错的。</li>
</ul>
<h4 data-id="heading-6">模式 C：混合 DAG（Hybrid）</h4>
<ul>
<li><strong>拓扑结构</strong>：网状，有分叉，有汇合。</li>
<li><strong>适用场景</strong>：绝大多数复杂的商业分析、长文本生成、多模态任务。</li>
<li><strong>核心逻辑</strong>： <strong>“智能等待”</strong> 。它能自动识别哪些可以“抢跑”，哪些必须“原地待命”。</li>
</ul>
<h3 data-id="heading-7">03. 核心算法：如何实现“智能等待”？</h3>
<p>DAG 调度的核心难点在于：<strong>C 任务怎么知道 A 和 B 做没做完？</strong></p>
<p>如果你写一个 <code>while(true)</code> 循环去不断轮询（Polling）状态，CPU 会被你跑满，这是最低效的做法。 Shannon 采用了 <strong>增量检查机制</strong>，配合事件驱动。</p>
<h4 data-id="heading-8">调度器逻辑（伪代码深度解析）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_dag</span>(<span class="hljs-params">tasks</span>):
    completed = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 已完成的任务 ID 集合</span>
    
    <span class="hljs-comment"># 只要还有任务没做完，就继续循环</span>
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(completed) &lt; <span class="hljs-built_in">len</span>(tasks):
        <span class="hljs-comment"># 1. 扫描所有还没做的任务（寻找“入度为0”的节点）</span>
        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks:
            <span class="hljs-keyword">if</span> task.is_done: <span class="hljs-keyword">continue</span> <span class="hljs-comment"># 做过的跳过</span>
            
            <span class="hljs-comment"># 2. 【关键】检查它的依赖是否都满足了</span>
            <span class="hljs-comment"># 比如任务 C 依赖 [A, B]，系统会去 completed 集合里查 A 和 B 在不在</span>
            dependencies = task.dependencies 
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">all</span>(d <span class="hljs-keyword">in</span> completed <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dependencies):
                <span class="hljs-comment"># 3. 依赖都满足了？开工！</span>
                <span class="hljs-comment"># 这里不是阻塞执行，而是丢进线程池异步跑</span>
                start_async(task)
        
        <span class="hljs-comment"># 4. 智能挂起：等待任意一个任务完成信号</span>
        <span class="hljs-comment"># 这里使用 select/epoll 机制，而不是死循环空转</span>
        <span class="hljs-comment"># 一旦有任务跑完，立刻唤醒调度器，把它的 ID 加入 completed 集合</span>
        newly_finished = wait_for_any_task_finish()
        completed.add(newly_finished.<span class="hljs-built_in">id</span>)
</code></pre>
<p>这种机制保证了：<strong>能并行的绝不排队（最大化吞吐），该等待的绝不抢跑（保证正确性）。</strong></p>
<h3 data-id="heading-9">04. 避免“交通拥堵”：信号量控制</h3>
<p>当你用 DAG 并行启动任务时，很容易开心过头。 比如任务分解出了 50 个子任务（例如搜 50 个州的法律条文），DAG 分析发现它们彼此独立，都可以并行。 于是编排器瞬间发起了 50 个 HTTP 请求给 LLM。</p>
<p><strong>后果是很严重的：</strong></p>
<ol>
<li><strong>触发限流（429 Too Many Requests）</strong> ：API 提供商（如 OpenAI）会以为你在进行 DDoS 攻击，直接封禁你的 Key。</li>
<li><strong>费用爆炸</strong>：一秒钟烧掉 100 美元，你的信用卡会哭泣。</li>
<li><strong>系统崩溃</strong>：本地网络连接数耗尽。</li>
</ol>
<p><strong>解决方案：信号量（Semaphore）</strong> 你可以把它想象成 <strong>银行的柜台窗口</strong>。 虽然大厅里（DAG 图中）有 50 个人在排队，大家都很急，但窗口（最大并发数）只有 5 个。</p>
<ul>
<li><strong>拿号（Acquire）</strong> ：只有拿到“令牌”的任务才能去窗口办事。</li>
<li><strong>等待（Block）</strong> ：没有令牌的任务，即使依赖都满足了，也得在黄线外等着。</li>
<li><strong>归还（Release）</strong> ：办完事的人离开窗口，把令牌还回来，下一个任务补位。</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 限制最大并发数为 5</span>
semaphore = <span class="hljs-built_in">NewSemaphore</span>(<span class="hljs-number">5</span>)

for task in ready_tasks:
    semaphore.<span class="hljs-built_in">Acquire</span>() // 拿号，没有号就阻塞等待
    go <span class="hljs-built_in">func</span>() {
        defer semaphore<span class="hljs-selector-class">.Release</span>() <span class="hljs-comment">// 办完事，一定要记得还号！</span>
        <span class="hljs-built_in">execute</span>(task)
    }()
</code></pre>
<h3 data-id="heading-10">05. 常见陷阱与避坑指南</h3>
<p>在实际构建 DAG 系统时，有三个坑是新手必踩的。</p>
<h4 data-id="heading-11">坑 1：隐形死锁（The Invisible Loop）</h4>
<p><strong>现象</strong>：A 依赖 B，B 依赖 A。或者更隐蔽的：A-&gt;B-&gt;C-&gt;A。 <strong>后果</strong>：程序挂起，永远不结束。调度器在等任务完成，任务在等依赖满足，形成了逻辑闭环。 <strong>解法</strong>：在构建 DAG 图时（Task 入库前），必须运行 <strong>环检测算法（如 Kahn 算法）</strong> 。如果发现有环，直接报错拒绝执行，不要等到运行时才发现。</p>
<h4 data-id="heading-12">坑 2：依赖超时（The Zombie Task）</h4>
<p><strong>现象</strong>：任务 C 等待 A 和 B。结果 A 很快做完了，但 B 因为网络原因卡住了（或者挂了）。C 就一直傻等，直到天荒地老。 <strong>解法</strong>：</p>
<ol>
<li><strong>超时机制</strong>：给等待设置 <code>Timeout</code>（例如 5 分钟）。如果 5 分钟依赖还没齐，直接报错。</li>
<li><strong>快速失败（Fail Fast）</strong> ：如果 B 明确失败了，立刻通知 C “别等了，你的上游崩了”，C 也随即取消。不要让错误蔓延。</li>
</ol>
<h4 data-id="heading-13">坑 3：数据传递丢失（The Missing Context）</h4>
<p><strong>现象</strong>：B 任务确实跑完了，但它产生的数据（比如一份 PDF）没有传给 C。C 虽然启动了，但因为拿不到输入数据而报错。这在分布式系统中很常见。 <strong>解法</strong>：建立统一的 <strong>上下文黑板（Context Blackboard）</strong> 。</p>
<ul>
<li>所有任务不直接对话。</li>
<li>A 做完了，把结果贴在黑板上：“我算出了 X=1”。</li>
<li>B 做完了，把结果贴在黑板上：“我算出了 Y=2”。</li>
<li>C 启动时，去黑板上读取 X 和 Y。</li>
<li>这解耦了任务之间的直接通信，提高了系统的健壮性。</li>
</ul>
<h3 data-id="heading-14">总结</h3>
<p>DAG 工作流是多 Agent 系统的 <strong>骨架</strong>。</p>
<ul>
<li>它把杂乱无章的任务列表，梳理成了井井有条的 <strong>依赖图谱</strong>。</li>
<li>它通过 <strong>智能调度</strong>，榨干了系统的每一分并发性能，让 1 小时的任务能在 20 分钟做完。</li>
<li>它通过 <strong>信号量</strong> 和 <strong>超时控制</strong>，保证了系统的稳定性，防止被突发流量冲垮。</li>
</ul>
<p>搞定了 DAG，你的 Agent 就能处理那些“牵一发而动全身”的复杂大项目了。</p>
<p><strong>下一章预告</strong></p>
<p>DAG 虽然强大，但它有一个致命弱点：<strong>它是静态的</strong>。图一旦画好，执行过程中就不能变了。 但如果任务执行到一半，发现需要加派人手怎么办？或者发现原来的计划行不通，需要临时变阵？</p>
<p>下一章，我们将介绍最高级的编排模式 —— <strong>Supervisor（主管）模式</strong>：一个拥有动态决策权、能随时增删改任务的“活体”管理器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能的升格：RAG技术演进全景图]]></title>    <link>https://juejin.cn/post/7599181528303960073</link>    <guid>https://juejin.cn/post/7599181528303960073</guid>    <pubDate>2026-01-26T03:15:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599181528303960073" data-draft-id="7599094262593339402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能的升格：RAG技术演进全景图"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T03:15:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="smallyoung"/> <meta itemprop="url" content="https://juejin.cn/user/4373200861407227"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能的升格：RAG技术演进全景图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4373200861407227/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    smallyoung
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:15:47.000Z" title="Mon Jan 26 2026 03:15:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60254fd72f5a4f878d7d7ff296eb683d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=ooSlIay%2BRKsjmv5PprbMT6qbXAo%3D" alt="什么是RAG" loading="lazy"/></p>
<h2 data-id="heading-0">1. 什么是 RAG？</h2>
<h3 data-id="heading-1">1.1 RAG 的起源</h3>
<p>RAG 最早由 <strong>Meta（原 Facebook）在 2020 年 5 月</strong> 提出，论文标题为 <em>"Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks"</em>（arXiv:2005.11401）。该论文首次将<strong>信息检索</strong>与<strong>文本生成</strong>相结合，开创了一种全新的 AI 范式。</p>
<blockquote>
<p>[!NOTE]
RAG 论文的第一作者是 <strong>Patrick Lewis</strong>，该工作后续被 NeurIPS 2020 会议接收。2024 年被誉为"RAG 突破年"，仅 arXiv 上就发布了超过 1200 篇相关论文。</p>
</blockquote>
<h3 data-id="heading-2">1.2 为什么需要 RAG？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/064f1ea5b7b14a838b209644ebad763f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=YlBe3hTeOr1xzwj8oEne3g25%2F3w%3D" alt="局限" loading="lazy"/></p>
<p>大语言模型（如 GPT、Claude、Gemini）虽然功能强大，但存在几个关键问题：</p>






























<table><thead><tr><th>问题</th><th>描述</th><th>RAG 如何解决</th></tr></thead><tbody><tr><td><strong>幻觉（Hallucination）</strong></td><td>LLM 可能生成看似真实但完全虚构的信息</td><td>通过检索真实文档作为依据，减少凭空捏造</td></tr><tr><td><strong>知识过时</strong></td><td>模型训练完成后无法获取新知识</td><td>外部知识库可实时更新</td></tr><tr><td><strong>缺乏可解释性</strong></td><td>无法知道答案来源</td><td>可追溯到具体的源文档</td></tr><tr><td><strong>领域知识不足</strong></td><td>对私有或专业领域知识了解有限</td><td>可接入企业私有知识库</td></tr></tbody></table>
<h3 data-id="heading-3">1.3 RAG 的核心思想</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39d9b9cd98a7404f8fc51056c27f9c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=0lC81Q3BlqTEvbkQZLBOeHufiuk%3D" alt=" RAG 的核心思想" loading="lazy"/></p>
<p>简单来说，RAG 就是：</p>
<pre><code class="hljs">用户问题 → 检索相关文档 → 将文档作为上下文 → LLM 生成答案
</code></pre>
<p>这就像考试时可以"开卷"——不需要死记硬背所有知识，只需在需要时查阅参考资料。</p>
<h2 data-id="heading-4">2. RAG 的工作流程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9d7056f6da448da15ea41ed2be34f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=tCxcjnsdcYlpHhjK4I159J9xhYM%3D" alt="工作流程" loading="lazy"/></p>
<p>一个标准的 RAG 系统包含三个核心阶段：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[用户提问] --&gt; B[检索 Retrieval]
    B --&gt; C[增强 Augmentation]
    C --&gt; D[生成 Generation]
    D --&gt; E[返回答案]
    
    subgraph 知识库
        F[(向量数据库)]
    end
    
    B --&gt; F
    F --&gt; B
</code></pre>
<h3 data-id="heading-5">2.1 离线准备阶段（Indexing）</h3>
<p>在系统运行之前，需要预先处理知识库：</p>
<ol>
<li><strong>数据收集</strong>：收集 PDF、网页、Word 文档等原始数据</li>
<li><strong>文档分块（Chunking）</strong>：将长文档切分为小段落</li>
<li><strong>向量化（Embedding）</strong>：使用嵌入模型将文本转换为向量</li>
<li><strong>存储</strong>：将向量存入向量数据库（如 Chroma、Milvus、Weaviate）</li>
</ol>
<h3 data-id="heading-6">2.2 在线服务阶段</h3>
<ol>
<li><strong>检索（Retrieval）</strong>：将用户问题转换为向量，在数据库中查找最相似的文档块</li>
<li><strong>增强（Augmentation）</strong>：将检索到的文档与用户问题组合成提示词（Prompt）</li>
<li><strong>生成（Generation）</strong>：LLM 根据增强后的提示词生成最终答案</li>
</ol>
<h2 data-id="heading-7">3. RAG 技术体系：完整演进图谱</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ce57186c3cc4fa29b107c37585ec980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=kiZOIy%2BOzb03fWdINpJ9UK9sBtk%3D" alt="完整演进图谱" loading="lazy"/></p>
<p>RAG 技术形成了一个<strong>多维度演进的技术体系</strong>，从基础架构到专项优化，每个方向都在解决特定的核心问题。下图展示了完整的技术演进脉络：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 基础架构层
        A[Naive RAG] --&gt; B[Advanced RAG]
        B --&gt; C[Modular RAG]
    end
    
    subgraph 检索增强
        A --&gt; D[GraphRAG]
        D --&gt; E[LightRAG]
    end
    
    subgraph 生成优化
        A --&gt; F[SELF-RAG]
        F --&gt; G[CRAG]
        G --&gt; H[Speculative RAG]
    end
    
    subgraph 智能融合
        C --&gt; I[Agentic RAG]
        I --&gt; J[RAG as Agent Submodule]
    end
    
    subgraph 模态扩展
        A --&gt; K[多模态 RAG]
        K --&gt; L[Long RAG]
    end
    
    subgraph 部署模式
        C --&gt; M[RAG as a Service]
        M --&gt; N[Edge RAG]
    end
    
    style A fill:#e3f2fd
    style B fill:#e3f2fd
    style C fill:#e3f2fd
</code></pre>
<h3 data-id="heading-8">3.1 基础架构：从简单到模块化</h3>
<h4 data-id="heading-9">Naive RAG（基础 RAG）</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebd9d54886064e83a07c83c925738e95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=kfjV6SAVVF5i47sxeU2vJWDTgV8%3D" alt="Naive RAG" loading="lazy"/></p>
<p>最简单的 RAG 实现方式，直接将检索结果拼接到 Prompt 中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Naive RAG 伪代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">naive_rag</span>(<span class="hljs-params">query, vector_db, llm</span>):
    <span class="hljs-comment"># 1. 检索</span>
    docs = vector_db.similarity_search(query, top_k=<span class="hljs-number">3</span>)
    
    <span class="hljs-comment"># 2. 增强</span>
    context = <span class="hljs-string">"\n"</span>.join([doc.content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs])
    prompt = <span class="hljs-string">f"根据以下内容回答问题：\n<span class="hljs-subst">{context}</span>\n\n问题：<span class="hljs-subst">{query}</span>"</span>
    
    <span class="hljs-comment"># 3. 生成</span>
    answer = llm.generate(prompt)
    <span class="hljs-keyword">return</span> answer
</code></pre>





















<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>优势</strong></td><td>实现简单、响应快、适合 MVP</td></tr><tr><td><strong>局限</strong></td><td>检索精度有限、无法处理复杂查询</td></tr><tr><td><strong>适用场景</strong></td><td>FAQ、简单知识库、内部搜索</td></tr></tbody></table>
<h4 data-id="heading-10">Advanced RAG（高级 RAG）</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb517268056a48feb60b3e3322ab56c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=nao8B7J8%2FqQde%2BhH%2BJGlEelNKTc%3D" alt="Advanced RAG" loading="lazy"/></p>
<p>在基础 RAG 上增加<strong>检索前优化、检索中增强、检索后处理</strong>三个环节：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 检索前优化
        A[查询重写] --&gt; B[查询扩展]
        B --&gt; C[HyDE假设文档生成]
    end
    
    subgraph 检索阶段
        D[混合检索] --&gt; E[多路召回]
    end
    
    subgraph 检索后优化
        F[重排序 Reranking] --&gt; G[上下文压缩]
        G --&gt; H[结果过滤]
    end
    
    C --&gt; D
    E --&gt; F
</code></pre>
<p><strong>关键技术：</strong></p>






























<table><thead><tr><th>技术</th><th>描述</th><th>效果</th></tr></thead><tbody><tr><td><strong>查询重写</strong></td><td>用 LLM 重新表述用户问题</td><td>提高问题清晰度</td></tr><tr><td><strong>HyDE</strong></td><td>先生成假设性答案，用它来检索</td><td>弥合问题与答案的语义差距</td></tr><tr><td><strong>混合检索</strong></td><td>向量检索 + 关键词检索（BM25）</td><td>兼顾语义与精确匹配</td></tr><tr><td><strong>重排序</strong></td><td>专门的重排序模型重新排序</td><td>最相关文档排在前面</td></tr></tbody></table>
<h4 data-id="heading-11">Modular RAG（模块化 RAG）</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da05d2fcc5f94071b6444dabbb729c76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=NmIu62y5r9SWAW1MdsD5Eef4lg4%3D" alt="Modular RAG" loading="lazy"/></p>
<p>将系统拆分为独立模块，像"乐高积木"一样灵活组合：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 核心模块
        R[检索模块]
        G[生成模块]
        RA[推理模块]
    end
    
    subgraph 扩展模块
        M[记忆模块]
        F[融合模块]
        O[路由模块]
        S[搜索模块]
    end
    
    R --&gt; F
    F --&gt; RA
    RA --&gt; G
    M --&gt; R
    O --&gt; R
    S --&gt; R
</code></pre>

























<table><thead><tr><th>模块</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><strong>路由模块</strong></td><td>决定查询走哪条路径</td><td>简单问题直接回答，复杂问题走检索</td></tr><tr><td><strong>记忆模块</strong></td><td>存储对话历史和偏好</td><td>多轮对话上下文管理</td></tr><tr><td><strong>融合模块</strong></td><td>整合多源检索结果</td><td>合并向量库、知识图谱、数据库结果</td></tr></tbody></table>
<p><strong>架构对比总结：</strong></p>









































<table><thead><tr><th>维度</th><th>Naive RAG</th><th>Advanced RAG</th><th>Modular RAG</th></tr></thead><tbody><tr><td><strong>复杂度</strong></td><td>⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>检索精度</strong></td><td>中</td><td>高</td><td>很高</td></tr><tr><td><strong>响应延迟</strong></td><td>低</td><td>中</td><td>中-高</td></tr><tr><td><strong>可扩展性</strong></td><td>低</td><td>中</td><td>高</td></tr><tr><td><strong>适合阶段</strong></td><td>MVP/原型</td><td>生产环境</td><td>企业级</td></tr></tbody></table>
<h3 data-id="heading-12">3.2 检索增强：从平面向量到图结构</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33bc6a63fe8640ce9d08af09707c5d12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=B3FCnO6j5sMwfNw9kO98BcKAKXg%3D" alt="从平面向量到图结构" loading="lazy"/></p>
<p>基础 RAG 将文档切分为孤立的块，无法捕捉实体之间的关系。这一方向引入<strong>图结构</strong>解决多跳推理问题。</p>




















<table><thead><tr><th>技术</th><th>解决的问题</th><th>核心思路</th></tr></thead><tbody><tr><td><strong>GraphRAG</strong></td><td>无法处理多跳推理</td><td>构建知识图谱，实体关系建模</td></tr><tr><td><strong>LightRAG</strong></td><td>GraphRAG 成本过高</td><td>双层检索 + 增量更新</td></tr></tbody></table>
<p><strong>GraphRAG vs LightRAG：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph GraphRAG
        A1[完整知识图谱构建] --&gt; B1[高准确率]
        A1 --&gt; C1[高计算成本]
        A1 --&gt; D1[需全量重建]
    end
    
    subgraph LightRAG
        A2[轻量实体抽取] --&gt; B2[接近准确率]
        A2 --&gt; C2[成本降低99%]
        A2 --&gt; D2[支持增量更新]
    end
</code></pre>






























<table><thead><tr><th>维度</th><th>GraphRAG</th><th>LightRAG</th></tr></thead><tbody><tr><td>图谱构建</td><td>完整构建</td><td>轻量抽取</td></tr><tr><td>更新方式</td><td>全量重建</td><td>增量更新</td></tr><tr><td>Token 消耗</td><td>高</td><td>低（约 1/6000）</td></tr><tr><td>适用场景</td><td>知识密集型任务</td><td>成本敏感型生产环境</td></tr></tbody></table>
<h3 data-id="heading-13">3.3 生成优化：从被动拼接到自主决策</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d8593a34744ed39a926da75f9091a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=DLVGDQwP3nmgzX%2F39%2BFScP%2FigyQ%3D" alt="从被动拼接到自主决策" loading="lazy"/></p>
<p>传统 RAG 的生成过程是"盲目的"——无论检索结果好坏都直接使用。这一方向引入<strong>自我评估和纠错机制</strong>。</p>

























<table><thead><tr><th>技术</th><th>解决的问题</th><th>核心思路</th></tr></thead><tbody><tr><td><strong>SELF-RAG</strong></td><td>不知道何时该检索</td><td>自我反思：评估检索必要性和结果质量</td></tr><tr><td><strong>CRAG</strong></td><td>检索质量差时无补救</td><td>质量评估 + 网络搜索补充</td></tr><tr><td><strong>Speculative RAG</strong></td><td>生成速度慢</td><td>小模型草稿 + 大模型验证</td></tr></tbody></table>
<p><strong>机制对比：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph "SELF-RAG"
        A1[用户问题] --&gt; B1{需要检索?}
        B1 --&gt;|是| C1[检索]
        B1 --&gt;|否| D1[直接回答]
        C1 --&gt; E1{结果相关?}
        E1 --&gt;|是| F1[生成]
        E1 --&gt;|否| G1[跳过]
    end
    
    subgraph "CRAG"
        A2[检索结果] --&gt; B2{质量评估}
        B2 --&gt;|高| C2[直接使用]
        B2 --&gt;|低| D2[网络搜索补充]
    end
    
    subgraph "Speculative RAG"
        A3[检索结果] --&gt; B3[小模型并行生成草稿]
        B3 --&gt; C3[大模型验证选择最佳]
    end
</code></pre>
<p><strong>Speculative RAG 效果：</strong></p>
<ul>
<li>准确率提升最高 <strong>12.97%</strong></li>
<li>响应延迟降低最高 <strong>51%</strong></li>
</ul>
<h3 data-id="heading-14">3.4 智能融合：从静态工具到智能体</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdbe6005cb3e463eb8f32c29a91799a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=9f%2BTWQ%2F3eErOXTFCZJZf0V2sRrQ%3D" alt="从静态工具到智能体" loading="lazy"/></p>
<p>这一方向代表 RAG 的<strong>范式转变</strong>——从被动的检索工具演变为智能体生态的核心组件。</p>




















<table><thead><tr><th>技术</th><th>解决的问题</th><th>核心思路</th></tr></thead><tbody><tr><td><strong>Agentic RAG</strong></td><td>固定检索流程无法动态决策</td><td>LLM 作为调度员，自主规划</td></tr><tr><td><strong>RAG as Submodule</strong></td><td>RAG 与智能体割裂</td><td>RAG 内嵌于 Agent，成为记忆基础设施</td></tr></tbody></table>
<p><strong>Agentic RAG 工作模式：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[用户复杂问题] --&gt; B[LLM 规划器]
    B --&gt; C{决策}
    C --&gt;|简单问题| D[直接回答]
    C --&gt;|需要检索| E[选择数据源]
    C --&gt;|需要验证| F[多源交叉验证]
    C --&gt;|需要计算| G[调用工具]
    E --&gt; H[检索执行]
    H --&gt; I{结果充分?}
    I --&gt;|否| J[迭代检索]
    I --&gt;|是| K[生成答案]
    J --&gt; B
</code></pre>
<h3 data-id="heading-15">3.5 模态扩展：从纯文本到多模态</h3>




















<table><thead><tr><th>技术</th><th>解决的问题</th><th>核心思路</th></tr></thead><tbody><tr><td><strong>多模态 RAG（MM-RAG）</strong></td><td>只能处理文本</td><td>多模态嵌入 + 跨模态检索</td></tr><tr><td><strong>Long RAG</strong></td><td>长文档信息分散</td><td>4000+ tokens 大块检索 + 层次化策略</td></tr></tbody></table>
<p><strong>多模态 RAG 能力：</strong></p>
<ul>
<li>图片检索：根据图片内容查找相关文档</li>
<li>视频问答：从视频库中检索相关片段</li>
<li>音频搜索：根据语音内容检索信息</li>
</ul>
<h3 data-id="heading-16">3.6 部署模式：从自建到服务化</h3>




















<table><thead><tr><th>技术</th><th>解决的问题</th><th>核心思路</th></tr></thead><tbody><tr><td><strong>RAG as a Service</strong></td><td>基础设施运维复杂</td><td>云端托管，按需付费</td></tr><tr><td><strong>Edge RAG</strong></td><td>隐私/延迟敏感</td><td>设备端本地运行</td></tr></tbody></table>
<p><strong>部署选项对比：</strong></p>

























<table><thead><tr><th>模式</th><th>适用场景</th><th>代表方案</th></tr></thead><tbody><tr><td><strong>云端托管</strong></td><td>快速启动、弹性扩展</td><td>Pinecone、Zilliz Cloud</td></tr><tr><td><strong>混合部署</strong></td><td>平衡隐私与性能</td><td>敏感数据本地 + 通用知识云端</td></tr><tr><td><strong>边缘部署</strong></td><td>隐私优先、离线可用</td><td>Ollama + 本地向量库</td></tr></tbody></table>
<h3 data-id="heading-17">3.7 技术选型指南</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51b496af7a2d47f3b2eb7a6bd0403096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=3UxnCeIqVnfanqHGid%2FxFW0PYVc%3D" alt="技术选型指南" loading="lazy"/></p>
<p>根据业务需求选择合适的技术组合：</p>













































<table><thead><tr><th>需求场景</th><th>推荐架构</th><th>关键技术</th></tr></thead><tbody><tr><td><strong>快速验证</strong></td><td>Naive RAG</td><td>基础向量检索</td></tr><tr><td><strong>生产环境</strong></td><td>Advanced RAG</td><td>混合检索 + 重排序</td></tr><tr><td><strong>复杂推理</strong></td><td>GraphRAG / LightRAG</td><td>知识图谱增强</td></tr><tr><td><strong>高准确性</strong></td><td>SELF-RAG + CRAG</td><td>自我反思 + 纠错</td></tr><tr><td><strong>低延迟</strong></td><td>Speculative RAG</td><td>推测式生成</td></tr><tr><td><strong>智能对话</strong></td><td>Agentic RAG</td><td>智能体融合</td></tr><tr><td><strong>企业级</strong></td><td>Modular RAG</td><td>模块化架构</td></tr></tbody></table>
<blockquote>
<p>[!IMPORTANT]
<strong>核心趋势</strong>：RAG 正在从"独立的检索增强工具"演变为"智能体生态的核心基础设施"。关键词是：</p>
<ul>
<li><strong>效率优化</strong>：LightRAG、Speculative RAG 大幅降低成本和延迟</li>
<li><strong>智能融合</strong>：RAG 内嵌于 Agent，实现自主决策</li>
<li><strong>服务化部署</strong>：云端/边缘多模式选择</li>
</ul>
</blockquote>
<h2 data-id="heading-18">4. 实践指南</h2>
<h3 data-id="heading-19">4.1 技术栈推荐</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a7a832478594544a28d9d5e51a9a735~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=MDhGcYpspun4IUExSQZPUjf%2BXPA%3D" alt="技术栈推荐" loading="lazy"/></p>



































<table><thead><tr><th>组件</th><th>推荐工具</th><th>说明</th></tr></thead><tbody><tr><td><strong>向量数据库</strong></td><td>Milvus、Chroma、Weaviate</td><td>Milvus 适合大规模，Chroma 适合快速原型</td></tr><tr><td><strong>嵌入模型</strong></td><td>OpenAI <code>text-embedding-3-small</code>、<code>bge-large-zh-v1.5</code></td><td>中文推荐 BGE 系列</td></tr><tr><td><strong>LLM</strong></td><td>GPT-4、Claude、Qwen、DeepSeek</td><td>根据成本和性能需求选择</td></tr><tr><td><strong>框架</strong></td><td>LangChain、LlamaIndex、RAGFlow</td><td>LangChain 生态最丰富</td></tr><tr><td><strong>重排序模型</strong></td><td><code>bge-reranker-v2-m3</code>、Cohere Rerank</td><td>显著提升检索质量</td></tr></tbody></table>
<h3 data-id="heading-20">4.2 分块策略建议</h3>





























<table><thead><tr><th>场景</th><th>块大小</th><th>重叠</th><th>说明</th></tr></thead><tbody><tr><td>通用问答</td><td>256-512 tokens</td><td>50-100 tokens</td><td>平衡信息完整性和检索精度</td></tr><tr><td>长文档分析</td><td>1000+ tokens</td><td>200 tokens</td><td>保留更多上下文</td></tr><tr><td>精确检索</td><td>128-256 tokens</td><td>50 tokens</td><td>提高匹配精度</td></tr></tbody></table>
<h3 data-id="heading-21">4.3 常见问题排查</h3>






























<table><thead><tr><th>问题</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td>检索不到相关内容</td><td>分块太大或嵌入模型不匹配</td><td>调整分块策略，更换嵌入模型</td></tr><tr><td>答案与问题无关</td><td>检索到的文档不相关</td><td>增加重排序、混合检索</td></tr><tr><td>LLM 幻觉严重</td><td>上下文不足或 Prompt 设计问题</td><td>优化 Prompt，增加相关文档数量</td></tr><tr><td>响应速度慢</td><td>检索或重排序耗时</td><td>使用缓存、减少 top_k</td></tr></tbody></table>
<h2 data-id="heading-22">5. RAG 评估指标</h2>
<p>评估 RAG 系统的效果需要从<strong>检索质量</strong>和<strong>生成质量</strong>两个维度进行考量：</p>
<h3 data-id="heading-23">5.1 检索质量指标</h3>



































<table><thead><tr><th>指标</th><th>英文</th><th>定义</th><th>计算方式</th></tr></thead><tbody><tr><td><strong>命中率</strong></td><td>Hit Rate</td><td>检索结果中包含正确答案的比例</td><td>命中次数 / 总查询数</td></tr><tr><td><strong>平均倒数排名</strong></td><td>MRR (Mean Reciprocal Rank)</td><td>正确结果在排名中位置的倒数平均值</td><td>Σ(1/rank) / n</td></tr><tr><td><strong>Recall@K</strong></td><td>Recall at K</td><td>前 K 个结果中包含相关文档的比例</td><td>相关文档数 / 总相关文档数</td></tr><tr><td><strong>NDCG</strong></td><td>Normalized DCG</td><td>考虑排名位置的相关性加权得分</td><td>DCG / IDCG</td></tr></tbody></table>
<h3 data-id="heading-24">5.2 生成质量指标</h3>



































<table><thead><tr><th>指标</th><th>英文</th><th>定义</th><th>评估方式</th></tr></thead><tbody><tr><td><strong>忠实度</strong></td><td>Faithfulness</td><td>生成答案是否基于检索内容</td><td>LLM 评估 / 人工标注</td></tr><tr><td><strong>答案相关性</strong></td><td>Answer Relevance</td><td>答案与问题的相关程度</td><td>语义相似度 / LLM 评估</td></tr><tr><td><strong>上下文精确度</strong></td><td>Context Precision</td><td>检索上下文中相关信息的比例</td><td>相关句子 / 总句子数</td></tr><tr><td><strong>上下文召回率</strong></td><td>Context Recall</td><td>检索上下文覆盖正确答案的程度</td><td>覆盖率计算</td></tr></tbody></table>
<blockquote>
<p>[!TIP]
<strong>推荐评估工具</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexplodinggradients%2Fragas" target="_blank" title="https://github.com/explodinggradients/ragas" ref="nofollow noopener noreferrer">RAGAS</a> - 开源 RAG 评估框架</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trulens.org%2F" target="_blank" title="https://www.trulens.org/" ref="nofollow noopener noreferrer">TruLens</a> - LLM 应用评估平台</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2F" target="_blank" title="https://smith.langchain.com/" ref="nofollow noopener noreferrer">LangSmith</a> - LangChain 官方评估工具</li>
</ul>
</blockquote>
<h2 data-id="heading-25">6. RAG 常见挑战</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b829b68e22724ab5a089dcbf2d9c58e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=NMxxlYLlCueaGLYoxS1WNpBA2AE%3D" alt="RAG 常见挑战" loading="lazy"/></p>
<p>尽管 RAG 技术发展迅速，在实际应用中仍面临诸多挑战：</p>
<h3 data-id="heading-26">6.1 检索层面的挑战</h3>






























<table><thead><tr><th>挑战</th><th>描述</th><th>应对策略</th></tr></thead><tbody><tr><td><strong>语义鸿沟</strong></td><td>用户问题与文档表述不匹配</td><td>查询重写、HyDE、同义词扩展</td></tr><tr><td><strong>多跳推理</strong></td><td>需要关联多个文档才能回答</td><td>GraphRAG、迭代检索</td></tr><tr><td><strong>长上下文问题</strong></td><td>相关信息分散在长文档中</td><td>层次化分块、递归检索</td></tr><tr><td><strong>实时性要求</strong></td><td>知识库更新不及时</td><td>增量索引、混合搜索引擎</td></tr></tbody></table>
<h3 data-id="heading-27">6.2 生成层面的挑战</h3>






























<table><thead><tr><th>挑战</th><th>描述</th><th>应对策略</th></tr></thead><tbody><tr><td><strong>上下文窗口限制</strong></td><td>检索内容超出 LLM 处理能力</td><td>上下文压缩、摘要提取</td></tr><tr><td><strong>信息冲突</strong></td><td>多个文档信息矛盾</td><td>来源可信度排序、冲突检测</td></tr><tr><td><strong>答案幻觉</strong></td><td>LLM 仍可能编造信息</td><td>SELF-RAG、引用验证</td></tr><tr><td><strong>响应延迟</strong></td><td>检索+生成耗时过长</td><td>缓存策略、流式输出</td></tr></tbody></table>
<blockquote>
<p>[!WARNING]
<strong>安全提醒</strong>：在企业应用中，需特别注意知识库的<strong>数据安全</strong>和<strong>隐私保护</strong>，避免敏感信息泄露。可采用权限控制、数据脱敏等措施。</p>
</blockquote>
<h2 data-id="heading-28">7. 未来展望</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3ca9060e1ee4c5097a070f436710d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005291&amp;x-signature=Pit5t7FDz4HG%2BMJCbad9pDO6aAE%3D" alt="未来展望" loading="lazy"/></p>
<p>RAG 技术仍在快速发展，以下是几个值得关注的方向：</p>
<ol>
<li><strong>端到端优化</strong>：将检索器和生成器联合训练</li>
<li><strong>自适应检索</strong>：智能决定何时需要检索</li>
<li><strong>跨模态理解</strong>：图文音视频统一检索</li>
<li><strong>可信 RAG</strong>：增强答案可追溯性和可解释性</li>
<li><strong>隐私保护 RAG</strong>：在保护数据隐私的前提下进行检索</li>
</ol>
<h2 data-id="heading-29">8. 参考资料</h2>
<h3 data-id="heading-30">核心论文</h3>









































<table><thead><tr><th>论文</th><th>作者/机构</th><th>年份</th><th>主要贡献</th></tr></thead><tbody><tr><td><em>Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks</em></td><td>Lewis et al. (Meta AI)</td><td>2020</td><td>RAG 奠基论文</td></tr><tr><td><em>Retrieval-Augmented Generation for Large Language Models: A Survey</em></td><td>Gao et al.</td><td>2024</td><td>最全面的 RAG 综述</td></tr><tr><td><em>Self-RAG: Learning to Retrieve, Generate, and Critique through Self-Reflection</em></td><td>Asai et al.</td><td>2023</td><td>自我反思机制</td></tr><tr><td><em>From Local to Global: A Graph RAG Approach to Query-Focused Summarization</em></td><td>Microsoft Research</td><td>2024</td><td>GraphRAG 方法论</td></tr><tr><td><em>Corrective Retrieval Augmented Generation</em></td><td>Yan et al.</td><td>2024</td><td>CRAG 纠错机制</td></tr></tbody></table>
<h3 data-id="heading-31">推荐阅读</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Ftutorials%2Frag%2F" target="_blank" title="https://python.langchain.com/docs/tutorials/rag/" ref="nofollow noopener noreferrer">LangChain RAG 官方教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.llamaindex.ai%2F" target="_blank" title="https://docs.llamaindex.ai/" ref="nofollow noopener noreferrer">LlamaIndex 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Finfiniflow%2Fragflow" target="_blank" title="https://github.com/infiniflow/ragflow" ref="nofollow noopener noreferrer">RAGFlow 开源项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexplodinggradients%2Fragas" target="_blank" title="https://github.com/explodinggradients/ragas" ref="nofollow noopener noreferrer">RAGAS 评估框架</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fgraphrag" target="_blank" title="https://github.com/microsoft/graphrag" ref="nofollow noopener noreferrer">Microsoft GraphRAG</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[声明文件.d.ts：编写自己的类型定义]]></title>    <link>https://juejin.cn/post/7599088558167998510</link>    <guid>https://juejin.cn/post/7599088558167998510</guid>    <pubDate>2026-01-26T05:46:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599088558167998510" data-draft-id="7599268297222799370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="声明文件.d.ts：编写自己的类型定义"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2026-01-26T05:46:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            声明文件.d.ts：编写自己的类型定义
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:46:12.000Z" title="Mon Jan 26 2026 05:46:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 TypeScript 中，声明文件 <code>.d.ts</code> 就像是 JavaScript 库的"使用说明书"。它告诉 TypeScript 如何理解没有类型信息的代码。本篇文章将深入探讨如何编写高质量的声明文件，为任何 JavaScript 库添加类型安全。</p>
</blockquote>
<h2 data-id="heading-0">声明文件基础</h2>
<h3 data-id="heading-1">什么是声明文件</h3>
<p><strong>声明文件（<code>.d.ts</code>）</strong> 是只包含类型信息的 TypeScript 文件。它不包含具体的实现代码，只告诉 TypeScript 某个值的存在和它的类型。</p>
<p>我们可以看一个简单的例子，比如有一个JavaScript库，但没有类型信息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">myLibrary</span> = {
  <span class="hljs-attr">version</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${name}</span>!`</span>;
  }
};
</code></pre>
<p>此时，我们需要为 <code>window</code> 创建一个类型声明：<code>global.d.ts</code>，用来告诉 TypeScript：<code>window</code> 上有一个 <code>myLibrary</code> 对象：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyLibrary</span> {
  <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">greet</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> {
    <span class="hljs-attr">myLibrary</span>: <span class="hljs-title class_">MyLibrary</span>;
  }
}
</code></pre>
<p>加上声明文件后，TypeScript 就能理解这个库了，我们就可以安全地使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">myLibrary</span>.<span class="hljs-property">version</span>);  <span class="hljs-comment">// ✅ 类型安全</span>
<span class="hljs-keyword">const</span> greeting = <span class="hljs-variable language_">window</span>.<span class="hljs-property">myLibrary</span>.<span class="hljs-title function_">greet</span>(<span class="hljs-string">"zhangsna"</span>);  <span class="hljs-comment">// ✅ 知道返回string</span>
<span class="hljs-comment">// window.myLibrary.unknownMethod();  // ❌ 编译错误：方法不存在</span>
</code></pre>
<h3 data-id="heading-2">为什么需要声明文件？</h3>
<ul>
<li>为纯 JavaScript 库添加类型支持。</li>
<li>描述已有 JavaScript 代码的类型。</li>
<li>共享类型定义（通过 <code>@types</code> 包）。</li>
<li>提前声明尚未实现的接口。</li>
</ul>
<blockquote>
<p>在后面的文章中，会详细讲解 @types 包的工作原理与最佳实践。</p>
</blockquote>
<h2 data-id="heading-3">全局声明 vs 模块声明</h2>
<h3 data-id="heading-4">全局声明：会影响整个项目</h3>
<p><strong>全局声明</strong> 意味着在项目的任何地方都可以访问，不需要导入。通常用于：</p>
<ul>
<li>全局变量（如window、document）。</li>
<li>库直接暴露在全局作用域。</li>
<li>自定义全局类型。</li>
</ul>
<h3 data-id="heading-5">模块声明：需要导入才能使用</h3>
<p><strong>模块声明</strong> 需要通过 <code>import</code> 语句导入才能使用。现在大多数npm包使用的就是这种方式。</p>
<h4 data-id="heading-6">模块声明导出</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// my-library.d.ts：描述一个外部模块</span>

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">UserRole</span> = <span class="hljs-string">"admin"</span> | <span class="hljs-string">"user"</span> | <span class="hljs-string">"guest"</span>;

<span class="hljs-comment">// 导出函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, email: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">User</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt;;

<span class="hljs-comment">// 导出类</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">users</span>: <span class="hljs-title class_">User</span>[];
  <span class="hljs-title function_">addUser</span>(<span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span>): <span class="hljs-built_in">void</span>;
  <span class="hljs-title function_">removeUser</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">boolean</span>;
  <span class="hljs-title function_">getAllUsers</span>(): <span class="hljs-title class_">User</span>[];
}

<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">DEFAULT_ROLE</span>: <span class="hljs-title class_">UserRole</span>;

<span class="hljs-comment">// 默认导出</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">UserManager</span>;
</code></pre>
<h4 data-id="heading-7">模块声明导入</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用模块声明</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserManager</span>, { <span class="hljs-title class_">User</span>, createUser } <span class="hljs-keyword">from</span> <span class="hljs-string">"my-library"</span>;

<span class="hljs-keyword">const</span> manager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserManager</span>();
<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-title function_">createUser</span>(<span class="hljs-string">"zhangsan"</span>, <span class="hljs-string">"zhangsan@example.com"</span>);
manager.<span class="hljs-title function_">addUser</span>(user);
</code></pre>
<h3 data-id="heading-8">混合声明：同时支持全局和模块</h3>
<p>有些库既支持全局使用，也支持模块导入。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// jquery.d.ts 的简化示例</span>
<span class="hljs-comment">// 模块导出</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"jquery"</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JQuery</span> {
    <span class="hljs-comment">// jQuery方法</span>
    <span class="hljs-title function_">hide</span>(): <span class="hljs-title class_">JQuery</span>;
    <span class="hljs-title function_">show</span>(): <span class="hljs-title class_">JQuery</span>;
    <span class="hljs-title function_">css</span>(<span class="hljs-attr">property</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">JQuery</span>;
    <span class="hljs-comment">// ... 更多方法</span>
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">$</span>(<span class="hljs-params">selector: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">JQuery</span>;
  
  <span class="hljs-keyword">export</span> = $;
}

<span class="hljs-comment">// 全局声明（当通过script标签引入时）</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JQuery</span> {
    <span class="hljs-title function_">hide</span>(): <span class="hljs-title class_">JQuery</span>;
    <span class="hljs-title function_">show</span>(): <span class="hljs-title class_">JQuery</span>;
    <span class="hljs-title function_">css</span>(<span class="hljs-attr">property</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">JQuery</span>;
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-attr">$</span>: <span class="hljs-function">(<span class="hljs-params">selector: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-title class_">JQuery</span>;
}

<span class="hljs-comment">// 使用方式1：模块导入</span>
<span class="hljs-comment">// import $ from "jquery";</span>
<span class="hljs-comment">// $("#myElement").hide();</span>

<span class="hljs-comment">// 使用方式2：全局使用（通过script标签引入后）</span>
<span class="hljs-comment">// $("#myElement").show();</span>
</code></pre>
<h2 data-id="heading-9">declare关键字全解</h2>
<h3 data-id="heading-10">declare的基本用法</h3>
<p><code>declare</code> 关键字告诉 TypeScript："这个值在别处已经存在，我只是告诉你它的类型"。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明变量</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">VERSION</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">AppConfig</span>;  <span class="hljs-comment">// 使用let表示可以重新赋值</span>

<span class="hljs-comment">// 声明函数</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 声明类</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>);
  <span class="hljs-title function_">greet</span>(): <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 声明枚举</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> {
  <span class="hljs-title class_">Pending</span>,
  <span class="hljs-title class_">Active</span>,
  <span class="hljs-title class_">Inactive</span>
}

<span class="hljs-comment">// 声明命名空间</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyApp</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-attr">apiUrl</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params">config: Config</span>): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 声明模块</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"my-module"</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">importantValue</span>: <span class="hljs-built_in">number</span>;
}
</code></pre>
<h3 data-id="heading-11">declare的进阶用法</h3>
<h4 data-id="heading-12">声明全局增强：给已有类型添加新属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-comment">// 给String添加自定义方法</span>
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">String</span> {
    <span class="hljs-title function_">toCamelCase</span>(): <span class="hljs-built_in">string</span>;
    <span class="hljs-title function_">toSnakeCase</span>(): <span class="hljs-built_in">string</span>;
  }
  
  <span class="hljs-comment">// 给Array添加方法</span>
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Array</span>&lt;T&gt; {
    <span class="hljs-title function_">findBy</span>(<span class="hljs-attr">predicate</span>: <span class="hljs-function">(<span class="hljs-params">item: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>): T | <span class="hljs-literal">undefined</span>;
    <span class="hljs-title function_">groupBy</span>(<span class="hljs-attr">key</span>: keyof T): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, T[]&gt;;
  }
}
</code></pre>
<h4 data-id="heading-13">声明合并：多次声明同一个接口，TypeScript会自动合并</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 在另一个文件中可以扩展</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 添加到User接口</span>
}

<span class="hljs-comment">// 最终User接口有：id, name, email</span>
</code></pre>
<h4 data-id="heading-14">条件声明：根据不同环境声明不同的类型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">process</span>: {
  <span class="hljs-attr">env</span>: {
    <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">"development"</span> | <span class="hljs-string">"production"</span> | <span class="hljs-string">"test"</span>;
    <span class="hljs-variable constant_">API_URL</span>?: <span class="hljs-built_in">string</span>;
    <span class="hljs-variable constant_">DEBUG</span>?: <span class="hljs-built_in">string</span>;
  };
};
</code></pre>
<h4 data-id="heading-15">类型守卫声明：声明一个函数是类型守卫</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isUser</span>(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>): value is <span class="hljs-title class_">User</span>;
</code></pre>
<h3 data-id="heading-16">declare的特殊语法</h3>
<h4 data-id="heading-17"><code>declare const</code> vs <code>declare let</code></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// const：声明常量，不能重新赋值</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">API_KEY</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-comment">// API_KEY = "new";  // ❌ 错误</span>

<span class="hljs-comment">// let：声明变量，可以重新赋值</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">let</span> <span class="hljs-attr">currentUser</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>;
currentUser = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> };  <span class="hljs-comment">// ✅ 可以</span>
</code></pre>
<h4 data-id="heading-18">declare function 的函数重载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">tag: <span class="hljs-string">"div"</span></span>): <span class="hljs-title class_">HTMLDivElement</span>;
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">tag: <span class="hljs-string">"span"</span></span>): <span class="hljs-title class_">HTMLSpanElement</span>;
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">tag: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">HTMLElement</span>;
</code></pre>
<h4 data-id="heading-19">declare class 的抽象类</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">makeSound</span>(): <span class="hljs-built_in">void</span>;
  <span class="hljs-title function_">move</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Moving..."</span>);
  }
}
</code></pre>
<h4 data-id="heading-20">declare namespace 的嵌套</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Geometry</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Point</span> {
    <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
  }
  
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Shapes</span> {
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Circle</span> {
      <span class="hljs-attr">center</span>: <span class="hljs-title class_">Point</span>;
      <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span>;
    }
    
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Rectangle</span> {
      <span class="hljs-attr">topLeft</span>: <span class="hljs-title class_">Point</span>;
      <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
    }
  }
}

<span class="hljs-comment">// 使用：Geometry.Shapes.Circle</span>
</code></pre>
<h2 data-id="heading-21">为无类型库添加类型支持</h2>
<h3 data-id="heading-22">分析JavaScript库的API：了解库的使用方式</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 全局变量形式</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">calculator</span> = {
  <span class="hljs-attr">PI</span>: <span class="hljs-number">3.14159</span>,
  <span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; },
  <span class="hljs-attr">subtract</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a - b; },
  <span class="hljs-attr">multiply</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a * b; },
  <span class="hljs-attr">divide</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a / b; },
  <span class="hljs-comment">// 高级功能</span>
  <span class="hljs-attr">calculate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">operation, a, b</span>) {
    <span class="hljs-keyword">switch</span>(operation) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>: <span class="hljs-keyword">return</span> a + b;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'subtract'</span>: <span class="hljs-keyword">return</span> a - b;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'multiply'</span>: <span class="hljs-keyword">return</span> a * b;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'divide'</span>: <span class="hljs-keyword">return</span> a / b;
      <span class="hljs-attr">default</span>: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Unknown operation'</span>);
    }
  }
};
</code></pre>
<h3 data-id="heading-23">创建类型声明文件：根据API编写声明文件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Calculator</span> {
  <span class="hljs-comment">// 常量</span>
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">PI</span>: <span class="hljs-built_in">number</span>;
  
  <span class="hljs-comment">// 基本运算方法</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">subtract</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">multiply</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span>;
  <span class="hljs-title function_">divide</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span>;
  
  <span class="hljs-comment">// 高级方法</span>
  <span class="hljs-title function_">calculate</span>(
    <span class="hljs-attr">operation</span>: <span class="hljs-string">"add"</span> | <span class="hljs-string">"subtract"</span> | <span class="hljs-string">"multiply"</span> | <span class="hljs-string">"divide"</span>,
    <span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>,
    <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>
  ): <span class="hljs-built_in">number</span>;
  
  <span class="hljs-comment">// 可能还有错误处理</span>
  lastError?: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">clearError</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 全局声明</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-comment">// 挂载在window上</span>
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> {
    <span class="hljs-attr">calculator</span>: <span class="hljs-title class_">Calculator</span>;
  }
  
  <span class="hljs-comment">// 也可以直接暴露为全局变量（如果库也这样做了）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">calculator</span>: <span class="hljs-title class_">Calculator</span>;
}

<span class="hljs-comment">// 如果库也支持模块导入，添加模块声明</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"simple-calculator"</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">calculator</span>: <span class="hljs-title class_">Calculator</span>;
  <span class="hljs-keyword">export</span> = calculator;
}

<span class="hljs-comment">// 现在TypeScript就能理解calculator库了</span>
</code></pre>
<h2 data-id="heading-24">发布和维护类型声明</h2>
<h3 data-id="heading-25">发布到 @types 仓库</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// package.json配置示例</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@types/my-library"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"TypeScript definitions for my-library"</span>,
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"MIT"</span>,
  <span class="hljs-string">"contributors"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Your Name"</span>,
      <span class="hljs-string">"githubUsername"</span>: <span class="hljs-string">"yourusername"</span>
    }
  ],
  <span class="hljs-string">"main"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"types"</span>: <span class="hljs-string">"index.d.ts"</span>,
  <span class="hljs-string">"repository"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"git"</span>,
    <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://github.com/DefinitelyTyped/DefinitelyTyped.git"</span>
  },
  <span class="hljs-string">"scripts"</span>: {},
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-comment">// 如果有依赖的类型包</span>
    <span class="hljs-string">"@types/node"</span>: <span class="hljs-string">"*"</span>
  },
  <span class="hljs-string">"typesPublisherContentHash"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"typeScriptVersion"</span>: <span class="hljs-string">"4.5"</span>
}
</code></pre>
<h3 data-id="heading-26">与源库捆绑发布</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在库的package.json中</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"my-library"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"dist/index.js"</span>,
  <span class="hljs-string">"types"</span>: <span class="hljs-string">"dist/index.d.ts"</span>,  <span class="hljs-comment">// 指向类型声明文件</span>
  <span class="hljs-string">"files"</span>: [
    <span class="hljs-string">"dist"</span>,
    <span class="hljs-string">"*.d.ts"</span>  <span class="hljs-comment">// 包含声明文件</span>
  ],
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsc"</span>,
    <span class="hljs-string">"prepublishOnly"</span>: <span class="hljs-string">"npm run build"</span>
  }
}
</code></pre>
<h2 data-id="heading-27">常见问题与解决方案</h2>
<h3 data-id="heading-28">如何处理过于动态的API？</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用索引签名或any类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VeryDynamicAPI</span> {
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// 允许任意字符串键，任意值</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 允许数字键，必须是string值</span>
  
  <span class="hljs-comment">// 或者更精确的</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-string">`get<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>]: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// 模板字面量类型</span>
  [<span class="hljs-attr">key</span>: <span class="hljs-string">`set<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>]: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 或者使用类型断言</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">dynamicLib</span>: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// 整个库都是any</span>
<span class="hljs-keyword">const</span> result = (dynamicLib <span class="hljs-keyword">as</span> { <span class="hljs-attr">doSomething</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span> }).<span class="hljs-title function_">doSomething</span>();
</code></pre>
<h3 data-id="heading-29">如何处理依赖的类型？</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在声明文件中声明依赖</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"my-library"</span> {
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
  
  <span class="hljs-comment">// 使用依赖的类型</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req: Request, res: Response</span>): <span class="hljs-built_in">void</span>;
  
  <span class="hljs-keyword">export</span> { middleware };
}
</code></pre>
<h3 data-id="heading-30">如何保持与源库的同步？</h3>
<ul>
<li>自动化工具：使用dts-gen生成基础声明。</li>
<li>版本控制：声明文件版本与源库版本保持一致。</li>
<li>持续集成：测试类型声明与最新版本兼容性。</li>
<li>社区协作：鼓励用户提交类型改进。</li>
</ul>
<h2 data-id="heading-31">结语</h2>
<p>声明文件是 TypeScript 生态系统的关键部分，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[了解JS中的对象]]></title>    <link>https://juejin.cn/post/7599101854644813834</link>    <guid>https://juejin.cn/post/7599101854644813834</guid>    <pubDate>2026-01-26T05:54:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599101854644813834" data-draft-id="7599247962822131739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="了解JS中的对象"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T05:54:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随逸177"/> <meta itemprop="url" content="https://juejin.cn/user/1857514486118233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            了解JS中的对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857514486118233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随逸177
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:54:58.000Z" title="Mon Jan 26 2026 05:54:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JS中的对象</h2>
<h3 data-id="heading-1">对象介绍</h3>
<p>在JavaScript中的对象是可变的键控集合。在JS中，数组是对象，函数是对象，正则表达是对象，同时，对象自然也是对象。简单点来讲,JS就像是一个"收纳盒"，在气里面可以装各种类型的数据，每一个数据都有一个"名字"（键），方便用来查找和使用。</p>
<h3 data-id="heading-2">对象字面量</h3>
<p>JS中的对象字面量就是用{}（花括号）直接创建 JS 对象的语法形式，是一种简洁、直观的 “字面量语法”，不需要借助构造函数或类（ES6 class），直接写出对象的属性和方法。
-基本语法与示例</p>
<p>// 这就是一个对象字面量，直接用{}定义属性</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> person = {
   <span class="hljs-comment">// 键（属性名）: 值（属性值），多个键值对用逗号分隔</span>
   <span class="hljs-string">"first-name"</span>:<span class="hljs-string">"yjy"</span>,<span class="hljs-comment">// 特殊属性名必须用引号包裹</span>
   name: <span class="hljs-string">"yjy"</span>,    <span class="hljs-comment">// 字符串属性</span>
   age: <span class="hljs-number">22</span>,         <span class="hljs-comment">// 数字属性</span>
   };
   <span class="hljs-comment">// 访问对象属性</span>
   console.<span class="hljs-built_in">log</span>(person[<span class="hljs-string">"first-name"</span>]);<span class="hljs-comment">//输出:yjy</span>
   console.<span class="hljs-built_in">log</span>(person.name); <span class="hljs-comment">// 输出：yjy</span>
   console.<span class="hljs-built_in">log</span>(person.age);  <span class="hljs-comment">// 输出：22</span>
</code></pre>
<p>console.log(person.age);  // 输出：22</p>
<p>在这里面值得一提的是，在对象字面量中，如果属性名是一个合法的JS标识符且不是保留字，则并不强制要求用引号括住属性名，其中"first-name"是特殊属性名，所以用引号括住"first-name"是必需的。</p>
<h3 data-id="heading-3">JS与传统面向对象语言（Java/C++/C#）创建对象的不同</h3>
<ul>
<li>如（Java）对象是类的实例，类是对象的 “模板”，先定义类才能创建对象</li>
<li>JS对象是无类型的键值对集合，本身就是基础单元，可直接创建，无需先定义 “模板”</li>
<li>两者实例对比</li>
<li>Java创建对象</li>
</ul>
<p>// 第一步：定义类</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-type">String</span> name;
    <span class="hljs-type">int</span> age;
    <span class="hljs-comment">// 构造方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.age = age;
      }
    }
</code></pre>
<p>// 第二步：创建类的实例（对象）
Person p = new Person("yjy", 22);</p>
<ul>
<li>JS创建对象（直接创建，无需类）</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 直接创建对象，无类的约束</span>
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> person = {
<span class="hljs-symbol">name:</span> <span class="hljs-string">"yjy"</span>,
<span class="hljs-symbol">age:</span> <span class="hljs-number">22</span>,
<span class="hljs-symbol">sayHi:</span> <span class="hljs-keyword">function</span>() {
    console.log(<span class="hljs-string">"你好"</span>);
  }
};
</code></pre>
<h3 data-id="heading-4">JS对象的核心操作</h3>
<p>要操作JS对象，首先便是要系统的了解JS对象的核心操作：检索、更新、引用等，了解它们才能去掌控对象的使用和管理。</p>
<ul>
<li>
<p>检索：检索就是获取对象中属性的值，其可采用[]后缀包括一个字符串表达式的方式。如果字符串是一个字符串字面量，且是一个合法的JS标识符且不是保留字，可以用点语法（.）代替</p>
</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino">   <span class="hljs-type">const</span> obj = { name: <span class="hljs-string">"yjy"</span>, <span class="hljs-string">"user-age"</span>: <span class="hljs-number">22</span> };
   console.<span class="hljs-built_in">log</span>(obj.name);       <span class="hljs-comment">// 点语法：yjy，适合属性名是合法标识符（无特殊字符、不以数字开头）的场景，简洁直观。</span>
   console.<span class="hljs-built_in">log</span>(obj[<span class="hljs-string">"user-age"</span>]); <span class="hljs-comment">// 方括号语法：22，适合属性名含特殊字符（如-、空格）、动态生成属性名的场景，是通用方式。</span>
</code></pre>
<ul>
<li>
<p>更新（修改、新增属性）：JS 对象是动态的，更新包含 “修改已有属性” 和 “新增属性”，语法和检索对应，对象的值可通过赋值更新，如果属性名已经存在与对象里，那么这个属性的值会被替换，如果对象之前没有这个属性名，那将会扩充到对象中。</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">   const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">"yjy"</span> }<span class="hljs-comment">;</span>
   <span class="hljs-attr">obj.name</span> = <span class="hljs-string">"yjy_new"</span><span class="hljs-comment">; // 修改已有属性</span>
   <span class="hljs-attr">obj.age</span> = <span class="hljs-number">22</span><span class="hljs-comment">;         // 新增属性</span>
   console.log(obj)<span class="hljs-comment">; // 输出：{ name: 'yjy_new', age: 22}</span>
</code></pre>
<ul>
<li>
<p>引用：对象通过引用传递。它们将永远不会被复制</p>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">   const <span class="hljs-attr">a</span> = { name: <span class="hljs-string">"yjy"</span> }<span class="hljs-comment">;</span>
   const <span class="hljs-attr">b</span> = a<span class="hljs-comment">; // b复制的是a的引用，而非对象本身</span>
   <span class="hljs-attr">b.name</span> = <span class="hljs-string">"李四"</span><span class="hljs-comment">;//修改b的属性，a也会变（指向同一个对象）</span>
   console.log(a.name)<span class="hljs-comment">; // 输出：李四（a和b指向同一对象）</span>
  
   const <span class="hljs-attr">c</span> = { ...a }<span class="hljs-comment">; // 浅拷贝解除引用</span>
   <span class="hljs-attr">c.name</span> = <span class="hljs-string">"王五"</span><span class="hljs-comment">;</span>
   console.log(a.name)<span class="hljs-comment">; // 输出：李四（原对象不受影响）</span>
</code></pre>
<ul>
<li>删除：用delete操作符或Reflect.deleteProperty删除对象的自有属性（无法删除原型属性）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">"yjy"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">22</span> };
   <span class="hljs-keyword">delete</span> user.<span class="hljs-property">age</span>; <span class="hljs-comment">// delete操作符</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">age</span>); <span class="hljs-comment">// 输出：undefined</span>
   <span class="hljs-keyword">const</span> res = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">deleteProperty</span>(user, <span class="hljs-string">"name"</span>); <span class="hljs-comment">// 反射删除</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res, user); <span class="hljs-comment">// 输出：true {}(删除成功)</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出：undefined</span>
</code></pre>
<p>除这些还有原型、枚举等操作，我们还需要对它们有着熟练的掌握，才能去掌控对象使用和管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[架构演进之路：从MVC到领域驱动设计（DDD）]]></title>    <link>https://juejin.cn/post/7599166436682842158</link>    <guid>https://juejin.cn/post/7599166436682842158</guid>    <pubDate>2026-01-26T03:17:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599166436682842158" data-draft-id="7599088558167326766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="架构演进之路：从MVC到领域驱动设计（DDD）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T03:17:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="smallyoung"/> <meta itemprop="url" content="https://juejin.cn/user/4373200861407227"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            架构演进之路：从MVC到领域驱动设计（DDD）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4373200861407227/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    smallyoung
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:17:56.000Z" title="Mon Jan 26 2026 03:17:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a76a3846e65d44bba0aef5fec61dcd06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=1fsdfCoZWKOXokig87UZwrnpsz8%3D" alt="MVC与DDD架构模式" loading="lazy"/></p>
<h2 data-id="heading-0">1. 核心问题导入</h2>
<p>想象这样一个场景：你负责维护一个电商系统，最初只是简单的商品展示和下单功能，采用经典的MVC三层架构，一切运行良好。</p>
<p>但随着业务发展，需求越来越复杂：</p>
<ul>
<li>订单需要支持拆单、合单、部分退款</li>
<li>促销规则多达几十种，还要支持叠加计算</li>
<li>库存涉及预占、锁定、分仓等多种状态</li>
<li>支付需要对接多个渠道，处理各种异常</li>
</ul>
<p>你发现代码变成了这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 一个"典型"的Service类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO dto)</span> {
        <span class="hljs-comment">// 参数校验 50行</span>
        <span class="hljs-comment">// 库存检查 30行</span>
        <span class="hljs-comment">// 促销计算 100行</span>
        <span class="hljs-comment">// 优惠券使用 50行</span>
        <span class="hljs-comment">// 订单拆分逻辑 80行</span>
        <span class="hljs-comment">// 支付处理 60行</span>
        <span class="hljs-comment">// 消息通知 40行</span>
        <span class="hljs-comment">// 日志记录 20行</span>
        <span class="hljs-comment">// ... 总计800+行</span>
    }
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ca9b6b3c584abea54902337931a3ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=vfpDUQ06ogUWX%2BNKUwgtBeWP63U%3D" alt="贫血模型" loading="lazy"/></p>
<p><strong>这就是典型的"贫血模型"困境</strong>：业务逻辑全部堆积在Service层，Entity只是数据容器，系统越来越难以维护。</p>
<blockquote>
<p>[!IMPORTANT]
<strong>MVC解决的是UI与业务的分离问题，DDD解决的是复杂业务的建模问题。</strong> 两者不是替代关系，而是在不同层面发挥作用。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9259d47bb1e144eca1e4b92373e5b5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=OI%2FdshxdJ6nT78LIRCwIWadtPj0%3D" alt="两种模式，两种焦点" loading="lazy"/></p>
<h2 data-id="heading-1">2. MVC架构模式：经典的关注点分离</h2>
<h3 data-id="heading-2">2.1 什么是MVC？</h3>
<p>MVC（Model-View-Controller）是一种软件架构模式，最早由挪威计算机科学家 Trygve Reenskaug 在1979年提出，用于Smalltalk-80语言。它的核心思想是<strong>分离关注点</strong>，将应用程序分为三个相互独立的组件：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph MVC架构
        User([用户]) --&gt; Controller
        Controller --&gt;|更新| Model
        Model --&gt;|通知| View
        View --&gt;|展示| User
        Controller --&gt;|选择| View
    end
    
    style Model fill:#e3f2fd
    style View fill:#e8f5e9
    style Controller fill:#fff3e0
</code></pre>

























<table><thead><tr><th>组件</th><th>职责</th><th>生活类比</th></tr></thead><tbody><tr><td><strong>Model（模型）</strong></td><td>管理数据和业务逻辑</td><td>餐厅的厨房和食材仓库</td></tr><tr><td><strong>View（视图）</strong></td><td>负责数据的展示</td><td>餐厅的装修和餐具摆设</td></tr><tr><td><strong>Controller（控制器）</strong></td><td>接收用户输入，协调Model和View</td><td>餐厅的服务员</td></tr></tbody></table>
<h3 data-id="heading-3">2.2 MVC的核心价值</h3>
<p>MVC带来的最大价值是<strong>并行开发</strong>和<strong>代码复用</strong>：</p>
<ul>
<li><strong>前后端分离</strong>：设计师可以专注于View，开发者可以专注于Model和Controller</li>
<li><strong>组件复用</strong>：同一个Model可以对应多个View（网页、APP、API）</li>
<li><strong>独立测试</strong>：业务逻辑可以独立于界面进行单元测试</li>
</ul>
<h3 data-id="heading-4">2.3 MVC在Web开发中的演变</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec68cfa3cf374fab899e565f41976798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=9ZcBZ%2FGd%2BGLRxff4eU0XljQJ%2F8U%3D" alt="MVC" loading="lazy"/></p>
<p>随着Web技术的发展，MVC模式也在不断演变：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title MVC架构演变
    1979 : 原始MVC (Smalltalk)
    1990s : Web MVC (JSP/Servlet)
    2000s : 框架化 (Spring MVC, ASP.NET MVC)
    2010s : 前后端分离 (REST API + SPA)
    2020s : 微服务 + 前端框架 (Vue/React)
</code></pre>
<p>现代Web开发中，MVC通常表现为：</p>

























<table><thead><tr><th>层次</th><th>传统MVC</th><th>现代实践</th></tr></thead><tbody><tr><td>View</td><td>JSP/Thymeleaf</td><td>React/Vue SPA</td></tr><tr><td>Controller</td><td>Spring MVC Controller</td><td>REST API</td></tr><tr><td>Model</td><td>Entity + Service</td><td>分层更细致</td></tr></tbody></table>
<h3 data-id="heading-5">2.4 MVC的局限性</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44340cf85d444ef78fa9787ee7159170~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=1AgZW1ermY%2BwCVLAUSb5LGsMN%2FU%3D" alt="MVC的局限性" loading="lazy"/></p>
<p>当业务复杂度上升时，MVC会暴露出明显的问题：</p>
<blockquote>
<p>[!CAUTION]
<strong>MVC三大陷阱</strong></p>
<ol>
<li><strong>Fat Controller</strong>：控制器承担过多职责，变成数百行的"上帝类"</li>
<li><strong>Anemic Model</strong>：模型只有getter/setter，业务逻辑全在Service层</li>
<li><strong>Service Layer膨胀</strong>：Service类动辄上千行，难以测试和维护</li>
</ol>
</blockquote>
<p>这些问题的根源在于：<strong>MVC是一种UI架构模式，它关注的是如何组织用户界面，而不是如何组织业务逻辑。</strong></p>
<h2 data-id="heading-6">3. DDD领域驱动设计：复杂业务的应对之道</h2>
<h3 data-id="heading-7">3.1 什么是DDD？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97808419658418bb02633bac30a7ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=O2Z5jTicj0xHt02zPOhvdS63bnM%3D" alt="什么是DDD" loading="lazy"/></p>
<p>DDD（Domain-Driven Design，领域驱动设计）是由Eric Evans在其2003年的同名著作中提出的软件开发方法论。它的核心思想是：<strong>软件的核心复杂性在于业务领域本身，因此应该以领域模型为核心来驱动软件设计。</strong></p>
<blockquote>
<p>[!NOTE]
DDD不是一种具体的架构，而是一套方法论和模式集合。它可以与MVC、六边形架构、微服务等结合使用。</p>
</blockquote>
<h3 data-id="heading-8">3.2 DDD的核心概念</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9a88c554586472d8037d0371274c9ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=NoIKJYH2b3SXtYEafYUa2J04wgg%3D" alt="DDD的核心概念" loading="lazy"/></p>
<p>DDD引入了一系列概念来帮助建模复杂业务：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 战略设计
        BC[限界上下文&lt;br/&gt;Bounded Context]
        UL[通用语言&lt;br/&gt;Ubiquitous Language]
        SD[子域&lt;br/&gt;Subdomain]
    end
    
    subgraph 战术设计
        E[实体 Entity]
        VO[值对象&lt;br/&gt;Value Object]
        AR[聚合根&lt;br/&gt;Aggregate Root]
        DS[领域服务&lt;br/&gt;Domain Service]
        DE[领域事件&lt;br/&gt;Domain Event]
        R[仓储 Repository]
    end
    
    BC --&gt; AR
    UL -.-&gt; E
    UL -.-&gt; VO
    SD --&gt; BC
    
    style BC fill:#e1f5fe
    style AR fill:#fff3e0
    style E fill:#e8f5e9
</code></pre>
<h4 data-id="heading-9">战术设计概念</h4>



































<table><thead><tr><th>概念</th><th>定义</th><th>代码示例</th></tr></thead><tbody><tr><td><strong>实体（Entity）</strong></td><td>具有唯一标识和生命周期的对象</td><td><code>Order</code>、<code>User</code></td></tr><tr><td><strong>值对象（Value Object）</strong></td><td>无标识、不可变，用属性描述</td><td><code>Money</code>、<code>Address</code></td></tr><tr><td><strong>聚合根（Aggregate Root）</strong></td><td>一组相关对象的入口，保证一致性</td><td><code>Order</code>（包含OrderItem）</td></tr><tr><td><strong>领域服务（Domain Service）</strong></td><td>不属于任何实体的业务逻辑</td><td><code>TransferService</code></td></tr><tr><td><strong>仓储（Repository）</strong></td><td>聚合的持久化接口</td><td><code>OrderRepository</code></td></tr></tbody></table>
<h4 data-id="heading-10">战略设计概念</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8160e370e6994a99b8e8cdc927fb8ca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=Vzs1hF5YPpgHl7I0mu0gKJYr5O0%3D" alt="战略设计" loading="lazy"/></p>

























<table><thead><tr><th>概念</th><th>定义</th><th>示例</th></tr></thead><tbody><tr><td><strong>限界上下文（Bounded Context）</strong></td><td>领域模型的边界，术语含义一致的范围</td><td>订单上下文、库存上下文</td></tr><tr><td><strong>通用语言（Ubiquitous Language）</strong></td><td>团队共享的精确术语</td><td>"发货" vs "出库"</td></tr><tr><td><strong>上下文映射（Context Map）</strong></td><td>不同限界上下文间的关系</td><td>防腐层、共享内核</td></tr></tbody></table>
<h3 data-id="heading-11">3.3 DDD的分层架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f157cfd082a45c7b5d5c6790292a826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=nNA8vIuGrm6t%2BdT54i9kUsURW3c%3D" alt="架构层次的演变" loading="lazy"/></p>
<p>DDD推荐的分层架构比传统三层更加精细：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph "DDD四层架构"
        UI[用户接口层&lt;br/&gt;User Interface]
        APP[应用层&lt;br/&gt;Application Layer]
        DOMAIN[领域层&lt;br/&gt;Domain Layer]
        INFRA[基础设施层&lt;br/&gt;Infrastructure]
    end
    
    UI --&gt; APP
    APP --&gt; DOMAIN
    APP --&gt; INFRA
    DOMAIN -.依赖倒置.-&gt; INFRA
    
    style DOMAIN fill:#ffecb3,stroke:#ff9800,stroke-width:2px
</code></pre>






























<table><thead><tr><th>层次</th><th>职责</th><th>对应MVC</th></tr></thead><tbody><tr><td><strong>用户接口层</strong></td><td>接收请求，返回响应</td><td>Controller</td></tr><tr><td><strong>应用层</strong></td><td>编排用例，事务管理，不含业务逻辑</td><td>Service（薄）</td></tr><tr><td><strong>领域层</strong></td><td>核心业务逻辑，领域模型</td><td>Model（富）</td></tr><tr><td><strong>基础设施层</strong></td><td>技术实现（数据库、消息队列等）</td><td>DAO/Repository实现</td></tr></tbody></table>
<blockquote>
<p>[!TIP]
<strong>关键区别</strong>：在DDD中，领域层是核心，不依赖于基础设施层（依赖倒置）。领域模型只关注业务规则，不关心数据如何存储。</p>
</blockquote>
<h3 data-id="heading-12">3.4 贫血模型 vs 充血模型</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea06134bacc740b3b0f5b2d807e830a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=QYE%2BsncQm%2FL3Vp%2FH1RVm7ME1JHc%3D" alt="贫血模型 vs 充血模型" loading="lazy"/></p>
<p>理解DDD的关键在于理解"充血模型"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 贫血模型（Anemic Model）- 传统MVC常见</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-comment">// 只有getter/setter，没有业务逻辑</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderRepository.findById(orderId);
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"PAID"</span>.equals(order.getStatus())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"已支付订单不能取消"</span>);
        }
        order.setStatus(<span class="hljs-string">"CANCELLED"</span>);
        orderRepository.save(order);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 充血模型（Rich Model）- DDD推荐</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> OrderId id;
    <span class="hljs-keyword">private</span> Money amount;
    <span class="hljs-keyword">private</span> OrderStatus status;
    
    <span class="hljs-comment">// 业务逻辑封装在实体内部</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.status == OrderStatus.PAID) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCannotBeCancelledException</span>(<span class="hljs-string">"已支付订单不能取消"</span>);
        }
        <span class="hljs-built_in">this</span>.status = OrderStatus.CANCELLED;
        <span class="hljs-comment">// 发布领域事件</span>
        registerEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCancelledEvent</span>(<span class="hljs-built_in">this</span>.id));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(Money payment)</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.amount.equals(payment)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentMismatchException</span>();
        }
        <span class="hljs-built_in">this</span>.status = OrderStatus.PAID;
    }
}
</code></pre>
<h2 data-id="heading-13">4. MVC与DDD核心对比</h2>
<h3 data-id="heading-14">4.1 设计焦点对比</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph MVC
        direction TB
        M1[UI组织] --&gt; M2[表现与逻辑分离]
        M2 --&gt; M3[可维护的界面]
    end
    
    subgraph DDD
        direction TB
        D1[业务建模] --&gt; D2[领域知识提炼]
        D2 --&gt; D3[可演进的系统]
    end
    
    MVC -.不同层面.-&gt; DDD
</code></pre>



































<table><thead><tr><th>对比维度</th><th>MVC</th><th>DDD</th></tr></thead><tbody><tr><td><strong>设计焦点</strong></td><td>UI与业务逻辑的分离</td><td>复杂业务领域的建模</td></tr><tr><td><strong>抽象层次</strong></td><td>表现层架构模式</td><td>全系统设计方法论</td></tr><tr><td><strong>模型定位</strong></td><td>数据载体（贫血）</td><td>业务核心（充血）</td></tr><tr><td><strong>驱动方式</strong></td><td>技术驱动</td><td>业务驱动</td></tr><tr><td><strong>适用规模</strong></td><td>中小型应用</td><td>中大型复杂系统</td></tr></tbody></table>
<h3 data-id="heading-15">4.2 层次结构对比</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph "传统MVC三层"
        C1[Controller]
        S1[Service]
        D1[DAO/Model]
        C1 --&gt; S1 --&gt; D1
    end
    
    subgraph "DDD四层"
        C2[用户接口层]
        A2[应用层]
        DM2[领域层]
        I2[基础设施层]
        C2 --&gt; A2
        A2 --&gt; DM2
        A2 -.-&gt; I2
        DM2 -.-&gt; I2
    end
</code></pre>
<h3 data-id="heading-16">4.3 代码组织对比</h3>
<p><strong>传统MVC项目结构</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── controller/
│   └── OrderController.java
├── service/
│   └── OrderService.java      <span class="hljs-comment"># 业务逻辑在这里</span>
├── dao/
│   └── OrderMapper.java
└── model/
    └── Order.java             <span class="hljs-comment"># 只有字段和getter/setter</span>
</code></pre>
<p><strong>DDD项目结构</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── interfaces/                 <span class="hljs-comment"># 用户接口层</span>
│   └── OrderController.java
├── application/               <span class="hljs-comment"># 应用层</span>
│   └── OrderApplicationService.java  <span class="hljs-comment"># 编排用例</span>
├── domain/                    <span class="hljs-comment"># 领域层（核心）</span>
│   ├── model/
│   │   ├── Order.java         <span class="hljs-comment"># 聚合根，含业务逻辑</span>
│   │   ├── OrderItem.java     <span class="hljs-comment"># 实体</span>
│   │   └── Money.java         <span class="hljs-comment"># 值对象</span>
│   ├── service/
│   │   └── PricingService.java  <span class="hljs-comment"># 领域服务</span>
│   └── repository/
│       └── OrderRepository.java  <span class="hljs-comment"># 仓储接口</span>
└── infrastructure/            <span class="hljs-comment"># 基础设施层</span>
    └── persistence/
        └── OrderRepositoryImpl.java  <span class="hljs-comment"># 仓储实现</span>
</code></pre>
<h2 data-id="heading-17">5. 实际应用场景</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f71e33f82b80431bbe79dd32e42ac045~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=Vf5%2BYjgwmvS1evuzC4qdMqMOBFU%3D" alt="选择你的架构之路" loading="lazy"/></p>
<h3 data-id="heading-18">5.1 何时使用MVC？</h3>
<p>MVC适合以下场景：</p>
<p>✅ <strong>简单CRUD应用</strong>：博客系统、个人网站、管理后台<br/>
✅ <strong>业务逻辑简单</strong>：数据校验、简单查询、基础增删改<br/>
✅ <strong>快速原型开发</strong>：MVP验证、Demo项目<br/>
✅ <strong>小团队项目</strong>：2-3人的小型团队</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MVC风格的简单示例 - 博客管理</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/posts")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PostController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PostService postService;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> Post <span class="hljs-title function_">createPost</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> PostDTO dto)</span> {
        <span class="hljs-keyword">return</span> postService.create(dto);
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> Post <span class="hljs-title function_">getPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> postService.findById(id);
    }
}
</code></pre>
<h3 data-id="heading-19">5.2 何时使用DDD？</h3>
<p>DDD适合以下场景：</p>
<p>✅ <strong>复杂业务域</strong>：金融交易、电商订单、保险理赔<br/>
✅ <strong>业务规则多变</strong>：促销计算、风控策略、合规审核<br/>
✅ <strong>多团队协作</strong>：需要清晰的边界和接口契约<br/>
✅ <strong>长期演进系统</strong>：预期持续迭代3年以上</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DDD风格的复杂业务示例 - 订单支付</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplicationService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PaymentGateway paymentGateway;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">payOrder</span><span class="hljs-params">(OrderId orderId, PaymentMethod method)</span> {
        <span class="hljs-comment">// 1. 获取聚合根</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderRepository.findById(orderId)
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderNotFoundException</span>(orderId));
        
        <span class="hljs-comment">// 2. 调用领域方法（业务逻辑在聚合内部）</span>
        <span class="hljs-type">PaymentResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> paymentGateway.process(
            order.getTotalAmount(), 
            method
        );
        
        order.confirmPayment(result);  <span class="hljs-comment">// 领域行为</span>
        
        <span class="hljs-comment">// 3. 持久化</span>
        orderRepository.save(order);
        
        <span class="hljs-comment">// 4. 发布领域事件</span>
        eventPublisher.publish(order.getDomainEvents());
    }
}
</code></pre>
<h3 data-id="heading-20">5.3 MVC与DDD的结合</h3>
<p>在实际项目中，MVC和DDD可以<strong>结合使用</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph "前端"
        FE[Vue/React SPA]
    end
    
    subgraph "后端 - MVC + DDD"
        subgraph "MVC层面"
            C[Spring MVC Controller]
        end
        
        subgraph "DDD层面"
            AS[应用服务]
            DM[领域模型]
            DS[领域服务]
            R[仓储]
        end
    end
    
    FE --&gt; C
    C --&gt; AS
    AS --&gt; DM
    AS --&gt; DS
    DM --&gt; R
</code></pre>
<blockquote>
<p>[!TIP]
<strong>最佳实践</strong>：对于简单模块使用MVC快速实现，对于核心复杂业务使用DDD深度建模。两者完全可以在同一个项目中共存。</p>
</blockquote>
<h2 data-id="heading-21">6. DDD最新趋势（2024-2025）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f088da3c40847eb81857bf2bcf9852d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=8BJsTBXe2zkZ%2FHTwR1ROe9Pl7g4%3D" alt="DDD最新趋势" loading="lazy"/></p>
<h3 data-id="heading-22">6.1 AI增强的领域建模</h3>
<p>Eric Evans在2024年的DDD欧洲大会上鼓励开发者尝试将大语言模型（LLM）应用于DDD实践：</p>
<ul>
<li><strong>AI辅助事件风暴</strong>：LLM分析工作坊记录，自动识别领域事件和聚合</li>
<li><strong>通用语言提炼</strong>：AI帮助统一团队术语，发现不一致的概念定义</li>
<li><strong>代码生成</strong>：基于领域模型自动生成基础代码框架</li>
</ul>
<h3 data-id="heading-23">6.2 社会技术设计</h3>
<p>DDD越来越被视为<strong>社会技术设计</strong>的基础：</p>
<ul>
<li><strong>上下文映射</strong>揭示团队边界和协作模式</li>
<li><strong>限界上下文</strong>与<strong>团队拓扑</strong>（Team Topologies）结合</li>
<li>康威定律的实践应用</li>
</ul>
<h3 data-id="heading-24">6.3 与微服务的持续融合</h3>
<p>大型科技公司（Netflix、Uber、Amazon）继续使用DDD指导微服务拆分：</p>





















<table><thead><tr><th>公司</th><th>DDD实践</th></tr></thead><tbody><tr><td>Netflix</td><td>用限界上下文定义服务边界</td></tr><tr><td>Uber</td><td>领域事件驱动的异步架构</td></tr><tr><td>Fiverr</td><td>独立部署的限界上下文</td></tr></tbody></table>
<h2 data-id="heading-25">7. 最佳实践与常见问题</h2>
<h3 data-id="heading-26">7.1 选择建议</h3>








































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>博客/CMS系统</td><td>MVC</td><td>业务简单，无需过度设计</td></tr><tr><td>企业ERP</td><td>DDD</td><td>业务复杂，需要精确建模</td></tr><tr><td>API网关</td><td>MVC</td><td>主要是路由转发，无复杂业务</td></tr><tr><td>订单/交易系统</td><td>DDD</td><td>状态机复杂，规则多变</td></tr><tr><td>快速原型</td><td>MVC</td><td>优先验证产品假设</td></tr><tr><td>长期演进系统</td><td>DDD</td><td>投资回报率高</td></tr></tbody></table>
<h3 data-id="heading-27">7.2 常见误区</h3>





























<table><thead><tr><th>误区</th><th>正确理解</th></tr></thead><tbody><tr><td>DDD是一种架构</td><td>DDD是方法论，可搭配多种架构</td></tr><tr><td>DDD必须用微服务</td><td>单体应用同样适用DDD</td></tr><tr><td>MVC过时了</td><td>MVC在UI层依然是最佳实践</td></tr><tr><td>DDD适用于所有项目</td><td>简单项目使用DDD是过度设计</td></tr><tr><td>学会模式就掌握DDD</td><td>战略设计（限界上下文）更重要</td></tr></tbody></table>
<h3 data-id="heading-28">7.3 从MVC迁移到DDD的路径</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97f6ddd7e7294c5fbf80cf24bd86a7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=p1%2F0cwH0iU8MdotpCh84uHdEekI%3D" alt="从MVC迁移到DDD的路径" loading="lazy"/></p>
<blockquote>
<p>[!WARNING]
<strong>渐进式迁移，避免大爆炸重写！</strong></p>
</blockquote>
<ol>
<li><strong>识别核心域</strong>：找出业务最复杂、变化最频繁的模块</li>
<li><strong>引入值对象</strong>：将原始类型替换为有意义的值对象</li>
<li><strong>充血化实体</strong>：将Service中的业务逻辑迁移到实体中</li>
<li><strong>定义聚合边界</strong>：识别事务一致性的边界</li>
<li><strong>抽象仓储接口</strong>：分离领域层和基础设施层</li>
<li><strong>逐步扩展</strong>：在新功能中应用完整DDD</li>
</ol>
<h2 data-id="heading-29">8. 总结</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6279658568534d5a99801d2cad7799da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=HgPy9y%2B4D4axSrKeKV3Z6ijHv5c%3D" alt="核心回顾" loading="lazy"/></p>

































<table><thead><tr><th>概念</th><th>一句话解释</th></tr></thead><tbody><tr><td><strong>MVC</strong></td><td>分离UI与业务逻辑的架构模式</td></tr><tr><td><strong>DDD</strong></td><td>以领域模型驱动软件设计的方法论</td></tr><tr><td><strong>贫血模型</strong></td><td>实体只有数据，逻辑在Service</td></tr><tr><td><strong>充血模型</strong></td><td>实体包含数据和业务行为</td></tr><tr><td><strong>限界上下文</strong></td><td>领域模型的适用边界</td></tr><tr><td><strong>聚合根</strong></td><td>一组相关对象的一致性边界</td></tr></tbody></table>
<p><strong>核心因果链</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">业务复杂度上升 
  → MVC的Model层膨胀 
  → Service变成<span class="hljs-string">"上帝类"</span> 
  → 维护困难 
  → 引入DDD进行领域建模 
  → 充血模型封装业务规则 
  → 聚合保证一致性 
  → 限界上下文划分团队边界 
  → 系统可持续演进
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df9dc569919848569f98514de20f0737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770005408&amp;x-signature=V72soepBZEYXJS1uWz9G5AwDGBs%3D" alt="驾驭复杂度，而非消除它" loading="lazy"/></p>
<h2 data-id="heading-30">9. 参考资料</h2>
<h3 data-id="heading-31">经典著作</h3>

























<table><thead><tr><th>资料</th><th>作者</th><th>说明</th></tr></thead><tbody><tr><td>《领域驱动设计：软件核心复杂性应对之道》</td><td>Eric Evans</td><td>DDD奠基之作，中文版由人民邮电出版社出版</td></tr><tr><td>《实现领域驱动设计》</td><td>Vaughn Vernon</td><td>DDD落地实践指南，更注重代码实现</td></tr><tr><td>《企业应用架构模式》</td><td>Martin Fowler</td><td>经典架构模式集，理解贫血/充血模型的基础</td></tr></tbody></table>
<h3 data-id="heading-32">国内技术实践</h3>

























<table><thead><tr><th>资料</th><th>来源</th><th>说明</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2017%2F12%2F22%2Fddd-in-practice.html" target="_blank" title="https://tech.meituan.com/2017/12/22/ddd-in-practice.html" ref="nofollow noopener noreferrer">领域驱动设计在互联网业务开发中的实践</a></td><td>美团技术团队</td><td>美团DDD落地实践，含抽奖平台案例</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2024%2F05%2F09%2Fddd-practice-trading-system.html" target="_blank" title="https://tech.meituan.com/2024/05/09/ddd-practice-trading-system.html" ref="nofollow noopener noreferrer">DDD在大众点评交易系统演进中的应用</a></td><td>美团技术团队</td><td>2024年最新实践，交易系统DDD演进</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.cn%2Farticle%2Falibaba-freshhema-ddd-practice" target="_blank" title="https://www.infoq.cn/article/alibaba-freshhema-ddd-practice" ref="nofollow noopener noreferrer">阿里盒马领域驱动设计实践</a></td><td>InfoQ中文站</td><td>盒马真实业务DDD落地案例</td></tr></tbody></table>
<h3 data-id="heading-33">开源项目</h3>




















<table><thead><tr><th>项目</th><th>地址</th><th>说明</th></tr></thead><tbody><tr><td>DDD Reference 中文翻译</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fciterus%2Fdddsample-core" target="_blank" title="https://github.com/citerus/dddsample-core" ref="nofollow noopener noreferrer">GitHub - citerus/dddsample-core</a></td><td>Eric Evans官方示例项目</td></tr><tr><td>Cola 框架</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2FCOLA" target="_blank" title="https://github.com/alibaba/COLA" ref="nofollow noopener noreferrer">GitHub - alibaba/COLA</a></td><td>阿里开源的DDD脚手架</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[端侧AI实战：Flutter离线语音识别的工程化落地]]></title>    <link>https://juejin.cn/post/7599181528304943113</link>    <guid>https://juejin.cn/post/7599181528304943113</guid>    <pubDate>2026-01-26T05:57:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599181528304943113" data-draft-id="7598127455132614656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="端侧AI实战：Flutter离线语音识别的工程化落地"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-01-26T05:57:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明君87997"/> <meta itemprop="url" content="https://juejin.cn/user/413072103838462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            端侧AI实战：Flutter离线语音识别的工程化落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072103838462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明君87997
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T05:57:14.000Z" title="Mon Jan 26 2026 05:57:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">工地无信号？我用端侧AI实现了离线语音识别</h2>
<blockquote>
<p>当你的用户在地下三层的施工现场，手机信号只有一格甚至没有，却需要快速记录质检问题时，云端语音识别就成了一句空话。</p>
</blockquote>
<h3 data-id="heading-1">从一个真实的痛点说起</h3>
<p>作为一名移动端开发者，我负责一款工程质检类 App 的开发。这款应用的核心场景是：质检员在施工现场巡检时，需要快速记录发现的问题——钢筋间距不合规、混凝土浇筑质量问题、安全隐患等。</p>
<p>传统的做法是手动输入文字，但在工地环境下这几乎是一种折磨：</p>
<ul>
<li>戴着安全手套操作手机键盘，效率极低</li>
<li>灰尘、噪音、光线等环境因素干扰</li>
<li>质检员往往需要同时观察、拍照、记录，腾不出双手</li>
</ul>
<p>语音输入是显而易见的解决方案。然而，当我兴冲冲地接入某云厂商的语音识别 API 后，现实给了我当头一棒：</p>
<p><strong>工地没有信号。</strong></p>
<p>是的，无论是高层建筑的电梯井道、地下室基坑，还是偏远郊区的新建工地，网络信号都是一个奢侈品。我们的用户反馈里，"语音功能不可用"成了高频词。</p>
<h3 data-id="heading-2">技术选型：端侧 AI 的崛起</h3>
<p>既然云端不可靠，那就把 AI 搬到端侧。</p>
<p>经过调研，我将目光锁定在了 <strong>阿里达摩院的 Paraformer</strong> 模型上。这是一款专门针对中文优化的语音识别模型，具备以下特点：</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>离线运行</td><td>无需网络，本地推理</td></tr><tr><td>中文优化</td><td>针对普通话深度优化，识别准确率高</td></tr><tr><td>模型轻量</td><td>量化后约 70MB，移动端可接受</td></tr><tr><td>开源免费</td><td>Apache 2.0 协议，商用友好</td></tr></tbody></table>
<p>配合 <strong>sherpa-onnx</strong> 推理引擎，可以在 iOS/Android 双平台实现高性能的本地语音识别。</p>
<h3 data-id="heading-3">架构设计：不只是能用，还要好用</h3>
<p>技术可行性验证通过后，我开始思考如何设计一个<strong>对开发者友好、对用户体验友好</strong>的组件架构。</p>
<h4 data-id="heading-4">分层架构</h4>
<pre><code class="hljs">┌─────────────────────────────────────────────┐
│              UI 组件层                       │
│  VoiceRecordButton  │  VoiceRecordOverlay   │
├─────────────────────────────────────────────┤
│              服务管理层                      │
│         VoiceRecognizerRegistry             │
├─────────────────────────────────────────────┤
│              核心服务层                      │
│  AudioRecorderService │ ParaformerRecognizer│
├─────────────────────────────────────────────┤
│              推理引擎层                      │
│            sherpa-onnx                      │
└─────────────────────────────────────────────┘
</code></pre>
<p><strong>UI 组件层</strong>：开箱即用的长按录音按钮和语音输入弹窗，类似微信的交互体验。</p>
<p><strong>服务管理层</strong>：这是我后来重构加入的一层，解决了一个关键的用户体验问题——下文详述。</p>
<p><strong>核心服务层</strong>：音频采集与语音识别的核心逻辑。</p>
<p><strong>推理引擎层</strong>：sherpa-onnx 提供的跨平台 ONNX 推理能力。</p>
<h4 data-id="heading-5">一个被忽视的体验问题</h4>
<p>组件的第一版很快完成了，功能测试一切正常。然而在实际使用中，我发现了一个严重的体验问题：</p>
<p><strong>每次打开语音功能，都要等待 2-3 秒的初始化时间。</strong></p>
<p>这是因为 ONNX 模型需要从 assets 复制到沙盒目录，然后加载到内存。对于心急的质检员来说，这几秒钟的等待足以消磨他们的耐心。</p>
<p>于是我设计了 <strong>VoiceRecognizerRegistry</strong> —— 一个全局的服务注册中心：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 应用启动时，异步预加载（不阻塞启动）</span>
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  
  <span class="hljs-comment">// 后台静默初始化语音识别服务</span>
  VoiceRecognizerRegistry.instance.preInitialize();
  
  runApp(MyApp());
}
</code></pre>
<p>核心思想很简单：<strong>把初始化前置到应用启动时</strong>。用户从打开 App 到真正使用语音功能，通常会有几秒到几十秒的间隔，足够完成模型加载。当用户真正点击麦克风按钮时，服务已经就绪，即点即用。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceRecognizerRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  <span class="hljs-keyword">static</span> VoiceRecognizerRegistry? _instance;
  <span class="hljs-keyword">static</span> VoiceRecognizerRegistry <span class="hljs-keyword">get</span> instance {
    _instance ??= VoiceRecognizerRegistry._();
    <span class="hljs-keyword">return</span> _instance!;
  }
  
  <span class="hljs-comment">// 初始化状态</span>
  InitializationStatus _status = InitializationStatus.notStarted;
  
  <span class="hljs-comment">// 预初始化（异步，不阻塞）</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; preInitialize() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_status == InitializationStatus.ready) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">if</span> (_status == InitializationStatus.initializing) {
      <span class="hljs-keyword">return</span> _initCompleter!.future;
    }
    
    _status = InitializationStatus.initializing;
    <span class="hljs-comment">// ... 加载模型</span>
  }
}
</code></pre>
<p>这个设计带来了几个好处：</p>
<ol>
<li><strong>零等待体验</strong>：用户感知不到初始化过程</li>
<li><strong>资源复用</strong>：全局单例，避免重复加载模型</li>
<li><strong>优雅降级</strong>：如果用户很快就使用语音功能，也能正常等待完成</li>
<li><strong>状态可观测</strong>：提供完整的状态查询 API</li>
</ol>
<h3 data-id="heading-6">交互设计：向微信学习</h3>
<p>在交互层面，我选择了用户最熟悉的模式——<strong>长按说话，松开识别</strong>。这种交互方式有几个优点：</p>
<ol>
<li><strong>符合直觉</strong>：微信已经教育了用户</li>
<li><strong>明确的开始/结束信号</strong>：不需要语音唤醒词或手动点击停止</li>
<li><strong>可取消</strong>：手指滑开即可取消，容错性好</li>
</ol>
<p>配合丰富的视觉反馈：</p>
<ul>
<li>🔵 脉冲呼吸动画：表示正在监听</li>
<li>🌊 波纹扩散效果：增强"录音中"的感知</li>
<li>📊 实时音量指示：让用户知道声音被采集到了</li>
<li>⏱️ 录音时长显示：还剩多少时间</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">VoiceRecordButton(
  maxDuration: <span class="hljs-number">10</span>,
  showRipple: <span class="hljs-keyword">true</span>,
  showDuration: <span class="hljs-keyword">true</span>,
  enableHaptic: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 触感反馈</span>
  onResult: (text) {
    <span class="hljs-comment">// 识别结果</span>
  },
)
</code></pre>
<h3 data-id="heading-7">实际效果</h3>
<p>经过两个版本的迭代，这套离线语音识别方案已经在生产环境稳定运行。来看一些数据：</p>





























<table><thead><tr><th>指标</th><th>数值</th></tr></thead><tbody><tr><td>模型加载时间</td><td>~2s（首次）/ 0ms（预加载后）</td></tr><tr><td>识别延迟</td><td>&lt; 500ms</td></tr><tr><td>识别准确率</td><td>~95%（安静环境）/ ~85%（工地噪音）</td></tr><tr><td>内存占用</td><td>~150MB</td></tr><tr><td>包体积增加</td><td>~70MB</td></tr></tbody></table>
<p>在工地的实际测试中，即使在地下两层、完全无信号的环境下，语音识别功能依然可以正常使用。质检员的记录效率提升了约 40%。</p>
<h3 data-id="heading-8">集成踩坑实录</h3>
<p>这部分是我花了最多时间的地方。sherpa-onnx + Paraformer 的组合虽然强大，但集成过程中遇到了不少"暗坑"。希望我的经验能帮你少走弯路。</p>
<h4 data-id="heading-9">坑1：音频格式转换——PCM 16bit 到 Float32</h4>
<p><strong>问题现象</strong>：录音能正常采集，但识别结果总是空的，或者输出一堆乱码。</p>
<p><strong>原因分析</strong>：Paraformer 模型要求输入的音频格式是 <strong>16kHz、Float32、单声道</strong>。而 <code>record</code> 插件输出的是 <strong>PCM 16bit 有符号整数</strong>。如果直接把 PCM 数据喂给模型，识别结果必然是错的。</p>
<p><strong>解决方案</strong>：手动做格式转换，将 Int16 归一化到 [-1.0, 1.0] 的浮点数范围：</p>
<pre><code class="hljs language-dart" lang="dart">Float32List _pcm16ToFloat32(Uint8List pcm16) {
  <span class="hljs-keyword">final</span> length = pcm16.length ~/ <span class="hljs-number">2</span>;
  <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> Float32List(<span class="hljs-number">0</span>);
  
  <span class="hljs-comment">// 将字节数组视为 Int16 数组</span>
  <span class="hljs-keyword">final</span> int16Data = Int16List.view(pcm16.buffer, <span class="hljs-number">0</span>, length);
  <span class="hljs-keyword">final</span> float32Data = Float32List(length);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) {
    <span class="hljs-comment">// Int16 范围是 -32768 ~ 32767，归一化到 -1.0 ~ 1.0</span>
    float32Data[i] = int16Data[i] / <span class="hljs-number">32768.0</span>;
  }
  
  <span class="hljs-keyword">return</span> float32Data;
}
</code></pre>
<p><strong>注意事项</strong>：除数是 <code>32768.0</code> 而不是 <code>32767.0</code>，这是因为负数的范围比正数多一个（-32768 到 32767）。用 32768 可以保证归一化后的范围对称。</p>
<hr/>
<h4 data-id="heading-10">坑2：模型文件加载——Assets 到沙盒的复制</h4>
<p><strong>问题现象</strong>：sherpa-onnx 初始化失败，报错 "file not found" 或 "invalid model"。</p>
<p><strong>原因分析</strong>：Flutter 的 assets 文件不能直接通过文件路径访问，必须先通过 <code>rootBundle.load()</code> 读取，然后写入到应用沙盒目录。sherpa-onnx 需要的是<strong>真实的文件系统路径</strong>。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">String?</span>&gt; _prepareModelFiles() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> tempDir = <span class="hljs-keyword">await</span> getTemporaryDirectory();
    <span class="hljs-keyword">final</span> modelDir = Directory(<span class="hljs-string">'<span class="hljs-subst">${tempDir.path}</span>/paraformer_model'</span>);
    
    <span class="hljs-comment">// 确保目录存在</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> modelDir.exists()) {
      <span class="hljs-keyword">await</span> modelDir.create(recursive: <span class="hljs-keyword">true</span>);
    }
    
    <span class="hljs-comment">// 复制模型文件</span>
    <span class="hljs-keyword">await</span> _copyAssetToFile(
      <span class="hljs-string">'packages/voice_recognizer/assets/audio_model/model.int8.onnx'</span>,
      <span class="hljs-string">'<span class="hljs-subst">${modelDir.path}</span>/model.int8.onnx'</span>,
    );
    
    <span class="hljs-comment">// 复制词表文件</span>
    <span class="hljs-keyword">await</span> _copyAssetToFile(
      <span class="hljs-string">'packages/voice_recognizer/assets/audio_model/tokens.txt'</span>,
      <span class="hljs-string">'<span class="hljs-subst">${modelDir.path}</span>/tokens.txt'</span>,
    );
    
    <span class="hljs-keyword">return</span> modelDir.path;
  } <span class="hljs-keyword">catch</span> (e) {
    debugPrint(<span class="hljs-string">'准备模型文件失败: <span class="hljs-subst">$e</span>'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }
}

Future&lt;<span class="hljs-keyword">void</span>&gt; _copyAssetToFile(<span class="hljs-built_in">String</span> assetPath, <span class="hljs-built_in">String</span> destPath) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> file = File(destPath);
  <span class="hljs-comment">// 避免重复复制</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> file.exists()) {
    <span class="hljs-keyword">final</span> data = <span class="hljs-keyword">await</span> rootBundle.load(assetPath);
    <span class="hljs-keyword">await</span> file.writeAsBytes(data.buffer.asUint8List());
  }
}
</code></pre>
<p><strong>踩坑点</strong>：</p>
<ul>
<li>路径前缀要用 <code>packages/voice_recognizer/</code> 而不是 <code>assets/</code>，因为这是一个独立的 package</li>
<li>首次复制 70MB 的模型文件需要 1-2 秒，要做好加载状态提示</li>
<li>建议在开发阶段清除缓存重新复制，避免旧模型干扰调试</li>
</ul>
<hr/>
<h4 data-id="heading-11">坑3：流式识别 vs 非流式识别——模型类型的选择</h4>
<p><strong>问题现象</strong>：使用 <code>OnlineRecognizer</code>（流式）初始化失败，或者识别效果很差。</p>
<p><strong>原因分析</strong>：Paraformer 模型分为两种：</p>
<ul>
<li><strong>Paraformer-large</strong>：非流式，准确率高，但必须等整段音频录完才能识别</li>
<li><strong>Paraformer-streaming</strong>：流式，可以边录边识别，但需要专门的流式模型</li>
</ul>
<p>我最初下载的是非流式模型，却用流式 API 去加载，自然会出问题。</p>
<p><strong>解决方案</strong>：根据模型类型选择对应的 API：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 非流式识别（推荐，准确率更高）</span>
<span class="hljs-keyword">final</span> config = sherpa.OfflineRecognizerConfig(
  model: sherpa.OfflineModelConfig(
    paraformer: sherpa.OfflineParaformerModelConfig(
      model: <span class="hljs-string">'<span class="hljs-subst">$modelDir</span>/model.int8.onnx'</span>,
    ),
    tokens: <span class="hljs-string">'<span class="hljs-subst">$modelDir</span>/tokens.txt'</span>,
    numThreads: <span class="hljs-number">2</span>,
    provider: <span class="hljs-string">'cpu'</span>,
  ),
);
_recognizer = sherpa.OfflineRecognizer(config);

<span class="hljs-comment">// 使用时：先录完，再一次性识别</span>
<span class="hljs-keyword">final</span> stream = _recognizer.createStream();
stream.acceptWaveform(sampleRate: <span class="hljs-number">16000</span>, samples: allSamples);
_recognizer.decode(stream);
<span class="hljs-keyword">final</span> result = _recognizer.getResult(stream);
</code></pre>
<p><strong>我的选择</strong>：最终采用非流式识别。虽然不能边录边出结果，但准确率明显更高。对于质检场景，用户说完一句话通常也就几秒钟，等待是可以接受的。</p>
<hr/>
<h4 data-id="heading-12">坑4：Tokens 文件格式——JSON vs TXT</h4>
<p><strong>问题现象</strong>：模型加载成功，但识别结果全是乱码或者空白。</p>
<p><strong>原因分析</strong>：sherpa-onnx 要求的 tokens 文件是<strong>纯文本格式</strong>（每行一个 token），而有些模型下载下来的是 JSON 格式。</p>
<p><strong>错误的格式（JSON）</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"你"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"好"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"世"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"界"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span> ...<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>正确的格式（TXT）</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">你
好
世
界
...
</code></pre>
<p><strong>解决方案</strong>：写个脚本转换一下，或者直接去 ModelScope/HuggingFace 下载正确格式的 tokens.txt。</p>
<hr/>
<h4 data-id="heading-13">坑5：iOS 真机调试——动态库签名问题</h4>
<p><strong>问题现象</strong>：模拟器运行正常，真机运行崩溃，报错 "code signature invalid"。</p>
<p><strong>原因分析</strong>：sherpa-onnx 的 iOS 动态库需要正确签名才能在真机运行。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>在 Xcode 中选择正确的开发者证书</li>
<li>确保 <code>Podfile</code> 中配置了动态库嵌入：</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby">post_install <span class="hljs-keyword">do</span> |<span class="hljs-params">installer</span>|
  installer.pods_project.targets.each <span class="hljs-keyword">do</span> |<span class="hljs-params">target</span>|
    target.build_configurations.each <span class="hljs-keyword">do</span> |<span class="hljs-params">config</span>|
      config.build_settings[<span class="hljs-string">'BUILD_LIBRARY_FOR_DISTRIBUTION'</span>] = <span class="hljs-string">'YES'</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<ol start="3">
<li>Clean Build Folder 后重新编译</li>
</ol>
<hr/>
<h4 data-id="heading-14">坑6：Android 64位兼容——armeabi-v7a 的缺失</h4>
<p><strong>问题现象</strong>：部分 Android 设备启动崩溃，报错 "couldn't find libsherpa-onnx-jni.so"。</p>
<p><strong>原因分析</strong>：sherpa-onnx 默认只提供 arm64-v8a 的 so 库，而一些老设备是 32 位的。</p>
<p><strong>解决方案</strong>：在 <code>android/app/build.gradle</code> 中限制 ABI：</p>
<pre><code class="hljs language-gradle" lang="gradle">android {
    defaultConfig {
        ndk {
            abiFilters 'arm64-v8a', 'x86_64'  // 只支持64位
        }
    }
}
</code></pre>
<p>或者去 sherpa-onnx 官方下载 32 位的库（如果需要兼容老设备）。</p>
<hr/>
<h4 data-id="heading-15">坑7：内存泄漏——Stream 对象未释放</h4>
<p><strong>问题现象</strong>：多次录音后，内存占用持续上涨，最终 OOM 崩溃。</p>
<p><strong>原因分析</strong>：每次调用 <code>recognizer.createStream()</code> 都会创建新的 Stream 对象，但 Dart 的 GC 不会自动释放 native 内存。</p>
<p><strong>解决方案</strong>：识别完成后主动释放资源，并复用 Recognizer 实例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 全局复用 Recognizer</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceRecognizerRegistry</span> </span>{
  SimpleParaformerRecognizer? _recognizer;  <span class="hljs-comment">// 单例复用</span>
  
  <span class="hljs-comment">// 每次识别创建新的 Stream，用完即弃</span>
  <span class="hljs-comment">// Stream 是轻量级的，Recognizer 是重量级的</span>
}

<span class="hljs-comment">// 必要时释放全部资源</span>
<span class="hljs-keyword">void</span> reset() {
  _recognizer?.dispose();
  _recognizer = <span class="hljs-keyword">null</span>;
}
</code></pre>
<hr/>
<h4 data-id="heading-16">坑8：采样率不匹配——16kHz 的强制要求</h4>
<p><strong>问题现象</strong>：识别结果偶尔正确，偶尔完全错误，没有规律。</p>
<p><strong>原因分析</strong>：<code>record</code> 插件在不同设备上的默认采样率不同（44.1kHz、48kHz 等），而 Paraformer 只接受 16kHz。</p>
<p><strong>解决方案</strong>：强制指定采样率：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">await</span> _recorder.start(
  <span class="hljs-keyword">const</span> RecordConfig(
    encoder: AudioEncoder.pcm16bits,
    sampleRate: <span class="hljs-number">16000</span>,  <span class="hljs-comment">// 必须是 16000</span>
    numChannels: <span class="hljs-number">1</span>,      <span class="hljs-comment">// 单声道</span>
  ),
  path: <span class="hljs-string">''</span>, <span class="hljs-comment">// 流式录制，不保存文件</span>
);
</code></pre>
<hr/>
<h4 data-id="heading-17">坑9：权限处理——iOS 的特殊性</h4>
<p><strong>问题现象</strong>：Android 正常，iOS 首次使用时直接崩溃。</p>
<p><strong>原因分析</strong>：iOS 对麦克风权限非常严格，必须在 <code>Info.plist</code> 中声明，且需要在使用前检查权限状态。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Info.plist --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSMicrophoneUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>需要使用麦克风进行语音输入<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用前检查权限</span>
Future&lt;<span class="hljs-built_in">bool</span>&gt; _checkPermission() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">var</span> status = <span class="hljs-keyword">await</span> Permission.microphone.status;
  <span class="hljs-keyword">if</span> (status.isDenied) {
    status = <span class="hljs-keyword">await</span> Permission.microphone.request();
  }
  <span class="hljs-keyword">return</span> status.isGranted;
}
</code></pre>
<p><strong>用户体验建议</strong>：不要在 App 启动时就申请权限，而是在用户首次点击麦克风按钮时再申请。这样用户更容易理解为什么需要这个权限。</p>
<hr/>
<h4 data-id="heading-18">坑10：调试困难——如何定位识别失败的原因</h4>
<p><strong>问题现象</strong>：识别结果为空，但不知道是录音问题还是模型问题。</p>
<p><strong>解决方案</strong>：我加了一套完整的调试日志：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. 检查音频数据</span>
debugPrint(<span class="hljs-string">'音频样本数: <span class="hljs-subst">$totalLength</span>, 时长约 <span class="hljs-subst">${totalLength / sampleRate}</span> 秒'</span>);

<span class="hljs-comment">// 2. 检查音频数据范围（应该在 -1.0 ~ 1.0 之间）</span>
<span class="hljs-built_in">double</span> minVal = <span class="hljs-number">0</span>, maxVal = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> sample <span class="hljs-keyword">in</span> allSamples) {
  <span class="hljs-keyword">if</span> (sample &lt; minVal) minVal = sample;
  <span class="hljs-keyword">if</span> (sample &gt; maxVal) maxVal = sample;
}
debugPrint(<span class="hljs-string">'音频数据范围: min=<span class="hljs-subst">$minVal</span>, max=<span class="hljs-subst">$maxVal</span>'</span>);

<span class="hljs-comment">// 3. 保存 WAV 文件用于人工检查</span>
<span class="hljs-comment">// 录下来的音频如果人耳都听不清，那模型肯定也识别不了</span>
</code></pre>
<p><strong>终极调试手段</strong>：把录制的音频保存成 WAV 文件，用电脑播放听一下。如果人耳都听不清楚，那就是录音环节的问题；如果听得清但识别不出，那就是模型或参数的问题。</p>
<h3 data-id="heading-19">写在最后</h3>
<p>端侧 AI 正在重塑移动应用的能力边界。曾经必须依赖云端的能力——语音识别、图像识别、自然语言处理——现在都可以在用户的设备上本地运行。</p>
<p>对于我们这种特定场景的应用（弱网/无网环境），端侧 AI 不是"可选项"，而是"必选项"。它让技术真正服务于用户，而不是让用户迁就技术的局限。</p>
<p>如果你也在开发类似场景的应用，希望这篇文章能给你一些启发。完整的组件代码已开源，欢迎 Star 和 PR。</p>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fvoice_recognizer" target="_blank" title="https://pub.dev/packages/voice_recognizer" ref="nofollow noopener noreferrer">pub.dev链接</a></h3>
<p><em>技术栈：Flutter + Dart + sherpa-onnx + Paraformer-zh</em></p>
<p><em>写于 2026 年 1 月，一个终于不用担心"无信号"的夜晚。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI核心概念详解：Prompt、MCP与Skill]]></title>    <link>https://juejin.cn/post/7599101854644322314</link>    <guid>https://juejin.cn/post/7599101854644322314</guid>    <pubDate>2026-01-26T03:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599101854644322314" data-draft-id="7599101854644305930" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI核心概念详解：Prompt、MCP与Skill"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-26T03:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PFinal社区_南丞"/> <meta itemprop="url" content="https://juejin.cn/user/1855631357906040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI核心概念详解：Prompt、MCP与Skill
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631357906040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PFinal社区_南丞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:38:02.000Z" title="Mon Jan 26 2026 03:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">搞懂AI的三大金刚：Prompt、MCP和Skill（人话版）</h2>
<h3 data-id="heading-1">写在前面</h3>
<p>你有没有遇到过这种情况：跟AI聊天的时候，它一会儿聪明得像个博士，一会儿又像“走神的小伙伴”？恭喜你，你可能踩中了Prompt的坑。</p>
<p>或者，你让AI帮你写代码，它说"抱歉我不能访问你的文件系统"，你心里小剧场瞬间拉满：这不是AI吗，怎么这都做不了？别急，这时候你需要的是MCP。</p>
<p>还有，你每次都要重新教AI怎么审查代码、怎么写文档，感觉自己像个复读机？朋友，你缺的是Skill。</p>
<p>今天咱们就来聊聊AI世界的这三个关键概念。别担心，我保证用人话说，绝不整那些绕口的术语。泡杯茶，咱慢慢聊。</p>
<hr/>
<h3 data-id="heading-2">一、Prompt：你怎么说话，决定AI有多聪明</h3>
<h4 data-id="heading-3">1.1 Prompt到底是个啥？</h4>
<p>想象一下你去饭馆点菜。如果你说"给我来点吃的"，服务员估计会一脸懵逼。但如果你说"来份宫保鸡丁，不要辣椒，多加花生米"，那厨师就知道该怎么整了。</p>
<p><strong>Prompt就是你对AI说的话</strong>，但不是随便说说那种，而是"点菜式"的指令。你说得越清楚，AI就越不容易给你整幺蛾子。</p>
<p>说白了，Prompt就像是：</p>
<ul>
<li>🎯 <strong>给AI下命令</strong> —— "给我写个Python函数"</li>
<li>🧠 <strong>给AI塞知识</strong> —— "你是个资深工程师，擅长写高性能代码"</li>
<li>📝 <strong>给AI看例子</strong> —— "就像这样写，懂？"</li>
<li>🎭 <strong>给AI演角色</strong> —— "你现在是个毒舌的代码审查员"</li>
</ul>
<p>别小看这玩意儿，Prompt写得好不好，直接决定AI是给你干活还是给你添堵。</p>
<h4 data-id="heading-4">1.2 Prompt的几种姿势</h4>
<h5 data-id="heading-5">入门级：光脚大侠型</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"帮我写个Python代码"</span>
</code></pre>
<p>这就像你对厨师说"给我来点吃的"。能不能吃到东西？能。好不好吃？看运气。
AI大概率会给你写个 <code>print("Hello World")</code>，然后你俩大眼瞪小眼。</p>
<h5 data-id="heading-6">进阶级：穿鞋上路型（结构化Prompt）</h5>
<pre><code class="hljs language-diff" lang="diff">你是个写了10年Python的老鸟。
任务：给我写个计算斐波那契数列的函数
要求：
<span class="hljs-deletion">- 用递归，我就喜欢递归那种优雅劲儿</span>
<span class="hljs-deletion">- 注释给我写详细点，我智商有限</span>
<span class="hljs-deletion">- 顺便告诉我时间复杂度，装逼用</span>
</code></pre>
<p>这就舒服了。你把需求、角色、标准都说清楚了，AI基本不会跑偏。
这就像你点菜说"来份宫保鸡丁，不要太辣，多加花生米，按川菜标准做"。</p>
<h5 data-id="heading-7">专家级:喂饭式教学（Few-Shot）</h5>
<pre><code class="hljs language-arduino" lang="arduino">我给你看几个例子，你照着学：
<span class="hljs-string">"今天天气真棒啊"</span> → 开心得飞起
<span class="hljs-string">"我好烦啊"</span> → 烦得要命
<span class="hljs-string">"这个产品还行吧"</span> → 还凑合

现在你告诉我：<span class="hljs-string">"这破玩意儿又卡了"</span> 是啥情感？
</code></pre>
<p>这招叫"示范教学"，就像教小孩说话一样。给几个例子，AI立马get到你的套路。
特别适合那种“我也不知道怎么说，但我可以做给你看”的场景。</p>
<h5 data-id="heading-8">大师级：苏格拉底式逼问（思维链）</h5>
<pre><code class="hljs">听着，咱们一步一步来：
一件衣服原价100块，先打8折，然后满减20块。
你现在要告诉我最后付多少钱，但是得把每一步都写出来：

第一步：先算打完折多少钱
第二步：再减去那20块
第三步：得出答案
第四步：检查一下是不是算错了

慢慢来，不着急，咱们有的是时间。
</code></pre>
<p>这叫"思维链"，让AI把思考过程展示出来。这样不容易出错，而且你能看到它是怎么想的。
特别适合复杂计算或者推理任务。你懂的，AI有时候会“走神”，看它怎么算的能帮你及时纠偏。</p>
<h4 data-id="heading-9">1.3 写好Prompt的五大心法</h4>
<p>写Prompt就像沟通协作，你得让对方知道你想要啥：</p>
<ol>
<li>
<p><strong>别整那些模糊的废话</strong></p>
<ul>
<li>❌ "帮我写点代码"</li>
<li>✅ "帮我写个读取CSV文件并统计每列平均值的Python脚本"</li>
</ul>
</li>
<li>
<p><strong>给点背景，别让AI瞎猜</strong></p>
<ul>
<li>❌ "这个函数有bug"</li>
<li>✅ "这个函数是用来处理用户上传的图片的，现在会报内存溢出，文件大小在10MB左右"</li>
</ul>
</li>
<li>
<p><strong>说清楚你要啥格式</strong></p>
<ul>
<li>要JSON就说JSON，要Markdown就说Markdown</li>
<li>不然AI可能给你整个散文出来</li>
</ul>
</li>
<li>
<p><strong>让AI演个角色</strong></p>
<ul>
<li>"你是个性能优化专家" 比 "帮我优化代码" 效果好10倍</li>
<li>AI很吃这一套，它就喜欢“角色扮演”</li>
</ul>
</li>
<li>
<p><strong>给个例子，胜过千言万语</strong></p>
<ul>
<li>直接show一个理想的输出，AI立马懂</li>
</ul>
</li>
</ol>
<h4 data-id="heading-10">1.4 老司机的私藏技巧</h4>
<p>说实话，这些是我踩了无数坑总结出来的：</p>
<p><strong>技巧1：分隔符大法</strong>
用 <code>###</code>、<code>---</code>、<code>```</code> 把不同部分分开，AI读起来不累，你debug起来也方便。</p>
<p><strong>技巧2：迭代大法</strong>
第一次输出不满意？别急着怀疑AI，先改改你的Prompt。90%的问题都是你没说清楚。</p>
<p><strong>技巧3：模板大法</strong>
把常用的Prompt存起来，下次直接套用。就像快捷回复一样，省时省力还不容易出错。</p>
<p><strong>技巧4：反向思维</strong>
告诉AI"不要做什么"有时候比"要做什么"更有效。
比如："不要使用全局变量，不要写超过50行的函数"。</p>
<p><strong>技巧5：让AI自己检查</strong>
在Prompt最后加一句"检查一下有没有错误"，AI会更认真。
对，就像考试时说“检查一遍”一样，虽然不确定为啥，但确实有用。</p>
<hr/>
<hr/>
<h3 data-id="heading-11">二、MCP：给AI装上手脚的魔法</h3>
<h4 data-id="heading-12">2.1 MCP是个啥玩意儿？</h4>
<p>你有没有遇到过这种情况：</p>
<p>你："AI帮我把这个文件改个名"
AI："对不起，我不能访问文件系统"
你："……那你能干嘛？"
AI："我可以告诉你怎么改文件名🙂"
你："……"</p>
<p>是的，原生的AI就像一个<strong>只有大脑没有手脚的天才</strong>。能想但不能做，着急不？</p>
<p><strong>MCP（Model Context Protocol）就是给AI装手脚的工具。</strong></p>
<p>简单说，MCP就是一套“AI和外部世界沟通的标准协议”。有了它，AI不仅能想，还能干：</p>
<ul>
<li>🗂️ 读写文件？小case</li>
<li>🌐 上网搜索？安排</li>
<li>🗄️ 查数据库？没问题</li>
<li>🎨 调API？轻轻松松</li>
</ul>
<p>就像给钢铁侠装上盔甲，AI瞬间从“纸上谈兵”变成“实战高手”。</p>
<h4 data-id="heading-13">2.2 MCP的四个关键角色（搬运工队伍）</h4>
<p>把MCP想象成一个<strong>外卖配送系统</strong>：</p>
<h5 data-id="heading-14">MCP Server（服务端）= 各种餐厅</h5>
<p>你家附近有川菜馆、日料店、火锅店。每个店会做不同的菜（提供不同的服务）：</p>
<ul>
<li>文件操作餐厅：专门处理文件读写、搜索</li>
<li>数据库餐厅：专门查询和修改数据</li>
<li>网络搜索餐厅：专门上网找信息</li>
<li>API集成餐厅：专门对接其他服务</li>
</ul>
<h5 data-id="heading-15">MCP Client（客户端）= 外卖平台</h5>
<p>就是你用的那个APP（比如Cursor、Claude Desktop）。
它负责：</p>
<ul>
<li>接收你的订单（需求）</li>
<li>找到合适的餐厅（MCP Server）</li>
<li>把订单发给餐厅</li>
<li>把外卖送到你手上</li>
</ul>
<h5 data-id="heading-16">Tools（工具）= 菜单上的菜品</h5>
<p>每个餐厅都有自己的菜单：</p>
<ul>
<li><code>read_file</code> = 清蒸鲈鱼</li>
<li><code>search_web</code> = 宫保鸡丁</li>
<li><code>query_database</code> = 水煮牛肉</li>
<li><code>create_folder</code> = 麻婆豆腐</li>
</ul>
<p>想吃啥点啥，菜单上都明码标价。</p>
<h5 data-id="heading-17">Resources（资源）= 食材库</h5>
<p>餐厅的冰箱里有各种食材：</p>
<ul>
<li>你的文档 = 新鲜蔬菜</li>
<li>数据库记录 = 冻肉</li>
<li>API端点 = 调味料</li>
</ul>
<p>厨师（MCP Server）根据订单从食材库取料做菜。</p>
<h4 data-id="heading-18">2.3 MCP的工作流程（外卖怎么送的）</h4>
<p>整个流程就像点外卖一样丝滑：</p>
<pre><code class="hljs">你喊饿了 → AI听懂了 → 挑餐厅选菜 → 下单做菜 → 外卖送达 → 你开吃
</code></pre>
<p><strong>真实案例</strong>（配送全过程）：</p>
<pre><code class="hljs language-arduino" lang="arduino">你：<span class="hljs-string">"哎AI，帮我看看项目里有哪些Python文件"</span>

↓ AI心里想：
<span class="hljs-string">"嗯，这哥们儿要找文件，得用文件系统那个餐厅"</span>

↓ AI下单：
打电话给MCP文件餐厅：<span class="hljs-string">"老板，来个list_files套餐，要.py口味的"</span>

↓ MCP干活：
餐厅厨师翻箱倒柜找Python文件
找到了：main.py, utils.py, test.py

↓ MCP返回：
<span class="hljs-string">"客官，您的Python三件套到了"</span>

↓ AI包装呈现：
<span class="hljs-string">"老板，您的项目里有3个Python文件：
- main.py
- utils.py  
- test.py
需要我打开看看吗？"</span>
</code></pre>
<p>看懂了吧？整个过程你只负责说想吃啥，剩下的AI和MCP全帮你搞定。</p>
<h4 data-id="heading-19">2.4 MCP凭啥这么香？</h4>
<p>用过MCP的人都说好，为啥？</p>
<p><strong>1. 标准化 = 天下餐厅一个味儿</strong>
不管川菜馆还是日料店，点菜流程都一样。你不用每次换餐厅就学新的点菜方式。
开发者也不用每个工具都重新写一套对接代码，省了多少头发啊！</p>
<p><strong>2. 可扩展性 = 想开啥店就开啥店</strong>
今天想吃韩国烤肉了？没问题，平台上加个韩餐馆。
想给AI加个新功能？搞个新的MCP Server就行，原来的不用动。</p>
<p><strong>3. 安全性 = 后厨重地闲人免进</strong>
餐厅有严格的卫生标准，MCP也有权限控制。
该让AI动的文件能动，不该动的谁也别想碰。你也不用担心AI“手滑”。</p>
<p><strong>4. 实时性 = 现炒现卖新鲜热辣</strong>
不是给你吃剩菜剩饭，而是现在的数据、实时的信息。
AI训练数据可能是去年的，但MCP能让它访问今天的信息。</p>
<p><strong>5. 模块化 = 想吃啥点啥，还能一起点</strong>
想要川菜+火锅+烧烤？没问题，三家一起点。
AI可以同时用文件操作、数据库查询、网络搜索等多个MCP服务。</p>
<h4 data-id="heading-20">2.5 MCP能帮你干这些事儿</h4>
<p>说人话就是：有了MCP，AI能干的活多了去了：</p>
<p><strong>📁 文件管家</strong></p>
<ul>
<li>读文件、写文件、改文件、删文件</li>
<li>搜代码、找bug、批量重命名</li>
<li>再也不用手动一个个文件点开了</li>
</ul>
<p><strong>🌐 网络冲浪手</strong></p>
<ul>
<li>实时搜索最新信息</li>
<li>"帮我查查2026年最火的AI框架是啥"</li>
<li>比AI自己的训练数据新多了</li>
</ul>
<p><strong>🗄️ 数据库老司机</strong></p>
<ul>
<li>查询、插入、更新、删除</li>
<li>"给我导出上个月的用户数据"</li>
<li>告别SQL手写地狱</li>
</ul>
<p><strong>🔗 API对接专家</strong></p>
<ul>
<li>连GitHub、Figma、Slack、啥都能连</li>
<li>"帮我在GitHub上创建个新仓库"</li>
<li>各种服务一条龙办理</li>
</ul>
<p><strong>🤖 浏览器自动化</strong></p>
<ul>
<li>自动填表单、点按钮、截图</li>
<li>测试网页、抓数据</li>
<li>解放双手，躺着看AI操作</li>
</ul>
<p><strong>📚 文档搜索引擎</strong></p>
<ul>
<li>访问最新的技术文档</li>
<li>"React 19有啥新特性"</li>
<li>不用自己翻官网了</li>
</ul>
<hr/>
<hr/>
<h3 data-id="heading-21">三、Skill：给AI报个培训班</h3>
<h4 data-id="heading-22">3.1 Skill到底是啥？</h4>
<p>你有没有每次都要教AI怎么审查代码、怎么写文档、怎么设计架构？
就像每天都要给新来的实习生培训一样，烦不烦？</p>
<p><strong>Skill就是给AI报的培训班。</strong></p>
<p>想象一下：</p>
<ul>
<li>Prompt = 你跟AI聊天，临时说需求</li>
<li>MCP = AI的手和脚，能干活</li>
<li><strong>Skill = AI的大脑升级包，专业知识和经验</strong></li>
</ul>
<p>有了Skill，AI就从“啥都能干但啥都不精”的万金油，变成了“术业有专攻”的专家。</p>
<p>比如装个“代码审查Skill”，AI立马变身“严格但靠谱”的代码审查员：</p>
<ul>
<li>自动检查命名规范</li>
<li>揪出潜在bug</li>
<li>指出容易踩坑的逻辑</li>
<li>给出优化建议</li>
</ul>
<p>而且一次装好，长期受用。不用每次都教一遍，省时省力。</p>
<h4 data-id="heading-23">3.2 Skill长啥样？（培训教材）</h4>
<p>一个合格的Skill就像一本培训手册，得包含这几部分：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Skill名称：比如"毒舌代码审查员"</span>

<span class="hljs-section">## 什么时候用我？</span>
<span class="hljs-bullet">-</span> 看到代码就想吐槽的时候
<span class="hljs-bullet">-</span> 关键词：代码审查、Code Review、看看代码

<span class="hljs-section">## 我懂这些专业知识：</span>
<span class="hljs-bullet">-</span> 各种编程规范（PEP 8、ESLint那些玩意儿）
<span class="hljs-bullet">-</span> 常见的“踩坑”代码特征
<span class="hljs-bullet">-</span> 性能优化套路
<span class="hljs-bullet">-</span> 安全漏洞识别技巧

<span class="hljs-section">## 我是这么干活的：</span>
<span class="hljs-bullet">1.</span> 先读代码（废话，不读怎么审）
<span class="hljs-bullet">2.</span> 检查命名和格式（变量叫a、b、c的会被温柔提醒）
<span class="hljs-bullet">3.</span> 找逻辑bug（死循环、空指针之类的）
<span class="hljs-bullet">4.</span> 看性能问题（O(n²)能优化成O(n)吗）
<span class="hljs-bullet">5.</span> 挖安全漏洞（SQL注入、XSS啥的）
<span class="hljs-bullet">6.</span> 写审查报告（一条条列出来，还得说人话）

<span class="hljs-section">## 我要用这些工具：</span>
<span class="hljs-bullet">-</span> 文件读取MCP：得先看到代码吧
<span class="hljs-bullet">-</span> 代码分析工具：自动化检查
<span class="hljs-bullet">-</span> Linter集成：借用现成的规则

<span class="hljs-section">## 最后给你这样的结果：</span>
<span class="hljs-bullet">-</span> Markdown格式的审查报告
<span class="hljs-bullet">-</span> 分类清楚：严重/警告/建议
<span class="hljs-bullet">-</span> 每条问题都有位置和改进方案
</code></pre>
<p>看到没，就是把专家的工作流程和经验全部写下来，AI照着做就行。</p>
<h4 data-id="heading-24">3.3 Skill的五大特色</h4>
<p><strong>1. 术业有专攻</strong>
不像万金油AI啥都会点啥都不精，装了Skill的AI就是专家。
代码审查的只管代码，架构设计的只管架构，各干各的活儿。</p>
<p><strong>2. 一次投资终身受益</strong>
写一次Skill，用一辈子。不用每次都教AI怎么做，它全记着呢。
就像给电脑装软件，装一次想用就用。</p>
<p><strong>3. 流程标准化</strong>
不管今天心情好不好，AI都按标准流程干活。
不会出现"昨天还行，今天就拉胯"的情况。</p>
<p><strong>4. 可以组合使用</strong>
"代码审查Skill" + "重构建议Skill" + "文档生成Skill" = 全栈代码管家
就像乐高积木，想怎么拼怎么拼。</p>
<p><strong>5. 持续升级迭代</strong>
发现Skill哪里不够好？改呗。
用着用着觉得应该加个新功能？加呗。
反正比重新训练AI简单多了。</p>
<h4 data-id="heading-25">3.4 给你看几个实战Skill</h4>
<h5 data-id="heading-26">Skill #1：严格代码审查员</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户说啥会触发：
"帮我看看这代码"、"代码审查"、"Code Review"

它会干嘛：
<span class="hljs-bullet">1.</span> 打开代码文件（心里默念：让我看看哪里需要优化）
<span class="hljs-bullet">2.</span> 检查命名规范（变量叫a、b、c的会被提醒改名）
<span class="hljs-bullet">3.</span> 揪出逻辑bug（if(a=b)这种常见错误也能抓出来）
<span class="hljs-bullet">4.</span> 评估性能（三层for循环？也许还能优化）
<span class="hljs-bullet">5.</span> 找安全漏洞（SQL注入、XSS，一个都别想跑）
<span class="hljs-bullet">6.</span> 写审查报告（但建议是真的有用）

最后给你一份：
📝 《你的代码还可以更好》详细报告
<span class="hljs-bullet">-</span> 🔴 严重问题：赶紧改不然上线爆炸
<span class="hljs-bullet">-</span> 🟡 警告问题：最好改改
<span class="hljs-bullet">-</span> 🟢 优化建议：有空可以搞搞
</code></pre>
<h5 data-id="heading-27">Skill #2：架构设计大师</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户说啥会触发：
"帮我设计架构"、"系统设计"、"技术选型"

它会干嘛：
<span class="hljs-bullet">1.</span> 先问清楚需求（要做啥？有多少用户？预算够不够？）
<span class="hljs-bullet">2.</span> 分析技术栈（React还是Vue？MySQL还是MongoDB？）
<span class="hljs-bullet">3.</span> 画模块图（前端、后端、数据库、缓存...）
<span class="hljs-bullet">4.</span> 规划接口（RESTful API怎么设计）
<span class="hljs-bullet">5.</span> 考虑扩展性（将来用户多了怎么办）
<span class="hljs-bullet">6.</span> 输出文档和图表

最后给你一套：
📋 《XXX系统架构设计方案》
<span class="hljs-bullet">-</span> 技术栈选择及理由
<span class="hljs-bullet">-</span> 系统模块划分图
<span class="hljs-bullet">-</span> 数据库设计
<span class="hljs-bullet">-</span> API接口规范
<span class="hljs-bullet">-</span> 扩展性方案
<span class="hljs-bullet">-</span> 大概需要多少成本
</code></pre>
<h5 data-id="heading-28">Skill #3：文档生成机器</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户说啥会触发：
"生成文档"、"写API文档"、"帮我写README"

它会干嘛：
<span class="hljs-bullet">1.</span> 扫描你的代码（看看都有啥函数和类）
<span class="hljs-bullet">2.</span> 提取注释和函数签名
<span class="hljs-bullet">3.</span> 生成结构化文档（按模块分类）
<span class="hljs-bullet">4.</span> 加使用示例（最好还能跑通）
<span class="hljs-bullet">5.</span> 格式化输出（Markdown或HTML随你挑）

最后给你：
📖 完整的技术文档
<span class="hljs-bullet">-</span> API接口说明
<span class="hljs-bullet">-</span> 参数类型和说明
<span class="hljs-bullet">-</span> 返回值格式
<span class="hljs-bullet">-</span> 调用示例
<span class="hljs-bullet">-</span> 常见问题FAQ

再也不用手写文档了，妈妈再也不用担心我不写注释了。
</code></pre>
<hr/>
<hr/>
<h3 data-id="heading-29">四、三个家伙到底有啥区别？</h3>
<h4 data-id="heading-30">4.1 一张表说清楚</h4>





















































<table><thead><tr><th>对比维度</th><th>Prompt<br/>（你说话的方式）</th><th>MCP<br/>（AI的手脚）</th><th>Skill<br/>（AI的专业培训）</th></tr></thead><tbody><tr><td><strong>本质是啥</strong></td><td>你怎么跟AI说话</td><td>AI怎么干活</td><td>AI怎么专业地干活</td></tr><tr><td><strong>用来干嘛</strong></td><td>表达你想要啥</td><td>让AI能动手</td><td>让AI按套路出牌</td></tr><tr><td><strong>能用多久</strong></td><td>说完就忘</td><td>装上就一直能用</td><td>装上就一直能用</td></tr><tr><td><strong>灵不灵活</strong></td><td>超级灵活，想说啥说啥</td><td>固定接口，但够用</td><td>有套路但可以调整</td></tr><tr><td><strong>谁整的</strong></td><td>你自己想说啥说啥</td><td>程序员开发的</td><td>领域专家设计的</td></tr><tr><td><strong>难不难搞</strong></td><td>从简单到复杂都行</td><td>有点技术含量</td><td>需要专业知识</td></tr><tr><td><strong>打个比方</strong></td><td>点菜的方式</td><td>餐厅和厨具</td><td>厨师的拿手菜谱</td></tr></tbody></table>
<h4 data-id="heading-31">4.2 用餐厅比喻理解三者关系</h4>
<pre><code class="hljs language-scss" lang="scss">你肚子饿了，想吃饭
       ↓
┌─────────────────┐
│     Prompt      │ ← 你对服务员说："我要一份宫保鸡丁，不要辣"
│   (What要啥)     │   （你的需求和要求）
└────────┬────────┘
         ↓
┌─────────────────┐
│      Skill      │ ← 大厨的拿手菜做法（专业流程和经验）
│  (How怎么做)     │   "先爆香葱姜蒜，再下鸡丁滑炒..."
└────────┬────────┘
         ↓
┌─────────────────┐
│       MCP       │ ← 厨房的灶台、锅铲、食材（实际工具）
│ (Action动手干)   │   有了工具才能真正做菜
└────────┬────────┘
         ↓
┌─────────────────┐
│   一盘香喷喷的   │ ← 最终结果
│    宫保鸡丁     │
└─────────────────┘
</code></pre>
<p><strong>再换个角度</strong>：盖房子</p>
<ul>
<li><strong>Prompt</strong> = 你跟包工头说："我要个三室两厅，要朝南，带阳台"</li>
<li><strong>Skill</strong> = 建筑师的设计图纸和施工规范</li>
<li><strong>MCP</strong> = 工人手里的工具（电钻、水泥、钢筋）</li>
</ul>
<p>三个缺一不可：</p>
<ul>
<li>只有Prompt：你说了想要啥，但没人知道怎么建</li>
<li>只有MCP：有工具但不知道要干啥</li>
<li>只有Skill：有图纸但没工具没法干活</li>
</ul>
<p><strong>必须三者配合</strong>才能搞定事情！</p>
<h4 data-id="heading-32">4.3 实战演练：三兄弟如何配合</h4>
<p><strong>场景：老板让你做个用户登录系统</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">【你的Prompt】
"哥们儿，帮我搞个用户认证系统，要用JWT那套，注册登录都得有。
对了，要安全，别让黑客随便就破了。"

↓ AI听懂了，开始调度资源

【Skill上场：Web开发专家Skill被激活】
AI心里想：
"嗯，这是Web开发，我得按专业套路来：
<span class="hljs-bullet">-</span> 先设计数据库表（用户表得有啥字段？）
<span class="hljs-bullet">-</span> 密码得加密存储（bcrypt走起）
<span class="hljs-bullet">-</span> JWT token要设置过期时间
<span class="hljs-bullet">-</span> 登录失败次数得限制（防止暴力破解）
<span class="hljs-bullet">-</span> 接口要符合RESTful规范"

↓ Skill制定了计划，该干活了

【MCP工具箱开工】
<span class="hljs-bullet">1.</span> 文件系统MCP：创建项目目录和文件
   ├── /src/models/User.js
   ├── /src/routes/auth.js
   ├── /src/middleware/auth.js
   └── /src/utils/jwt.js

<span class="hljs-bullet">2.</span> Web搜索MCP：查找2026年JWT最佳实践
   "看看现在大家都怎么用JWT的，有啥新漏洞要注意"

<span class="hljs-bullet">3.</span> 代码生成工具：写具体代码
   生成注册、登录、验证接口

<span class="hljs-bullet">4.</span> Linter工具：检查代码质量
   "这代码写得对不对？有没有明显的坑？"

<span class="hljs-bullet">5.</span> 数据库MCP：创建表结构
   CREATE TABLE users (...)

↓ 所有工具干完活了

【交付给你的成果】
✅ 完整的代码（能直接跑的那种）
✅ README文档（教你怎么用）
✅ 安全性说明（哪些地方要注意）
✅ 测试用例（该测什么都列好了）
✅ 部署建议（环境变量该配啥）

你：“这么快就搞定了？”
</code></pre>
<p><strong>看到没？</strong></p>
<ul>
<li><strong>Prompt</strong> 说出你的需求</li>
<li><strong>Skill</strong> 提供专业方案</li>
<li><strong>MCP</strong> 动手实现</li>
</ul>
<p>三个一起上，才是完整的AI工作流程！</p>
<hr/>
<hr/>
<h3 data-id="heading-33">五、啥时候用啥？（避坑指南）</h3>
<h4 data-id="heading-34">5.1 只用Prompt就够了的情况</h4>
<p><strong>适合场景：动动嘴就行的活儿</strong></p>
<p>你就是想聊聊天、问问题、让AI帮你想想，不需要AI真的动手干活。</p>
<p><strong>典型场景</strong>：</p>
<ul>
<li>
<p>📧 <strong>写邮件/文章</strong>
"帮我写封请假邮件，理由要充分但不能太假"</p>
</li>
<li>
<p>📊 <strong>分析解释</strong>
"这段用户反馈是在夸我还是骂我？"</p>
</li>
<li>
<p>💡 <strong>头脑风暴</strong>
"给我的宠物店想5个有创意的名字，要萌萌的"</p>
</li>
<li>
<p>❓ <strong>问答解惑</strong>
"用人话告诉我啥是区块链，别整那些装逼的词"</p>
</li>
</ul>
<p><strong>为啥只用Prompt？</strong>
因为这些活儿AI只需要"想"不需要"做"。
就像你问朋友意见，他只需要说说想法，不用真帮你干活。</p>
<h4 data-id="heading-35">5.2 Prompt + MCP：让AI动起来</h4>
<p><strong>适合场景：需要AI真刀真枪干活的时候</strong></p>
<p>光说不练假把式，这时候AI得真的去操作文件、访问网络、调用API。</p>
<p><strong>典型场景</strong>：</p>
<p><strong>场景1：GitHub小助手</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">你：<span class="hljs-string">"帮我在GitHub上创建个新仓库，名字叫awesome-project"</span>

Prompt：表达需求
MCP：调用GitHub API，真的去创建仓库

结果：仓库创建成功，链接发给你
</code></pre>
<p><strong>场景2：代码质量检查</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">你：<span class="hljs-string">"看看我项目里所有Python文件写得怎么样"</span>

Prompt：告诉AI要干啥
MCP：
  ├─ 文件系统工具：找到所有.py文件
  ├─ 代码分析工具：检查每个文件
  └─ 汇总给AI

结果：给你一份详细的质量报告
</code></pre>
<p><strong>为啥需要MCP？</strong>
因为AI本身只是个大脑，没有手脚。
MCP就是AI的假肢，让它能真的去操作东西。</p>
<h4 data-id="heading-36">5.3 Prompt + Skill：让AI更专业</h4>
<p><strong>适合场景：需要专业知识和套路的工作</strong></p>
<p>不是随便干干就行，而是得按专业标准来。
你希望AI像个专家一样工作，而不是门外汉瞎搞。</p>
<p><strong>典型场景</strong>：</p>
<p><strong>场景1：代码审查</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">你：<span class="hljs-string">"帮我审查一下这段代码"</span>

Prompt：提出需求
Skill：<span class="hljs-string">"代码审查专家Skill"</span>上场
  ├─ 检查命名规范
  ├─ 找逻辑bug
  ├─ 评估性能
  ├─ 挖安全漏洞
  └─ 生成专业报告

结果：一份像资深工程师写的审查报告
</code></pre>
<p><strong>场景2：写技术文档</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">你：<span class="hljs-string">"帮我写个API文档"</span>

Prompt：表达意图
Skill：<span class="hljs-string">"技术文档写作Skill"</span>激活
  ├─ 扫描代码提取接口
  ├─ 按标准格式组织
  ├─ 添加示例代码
  └─ 生成完整文档

结果：规范的、专业的API文档
</code></pre>
<p><strong>为啥需要Skill？</strong>
因为专业的活儿需要专业的套路。
Skill就是把专家的经验打包给AI，让它干活更靠谱。</p>
<h4 data-id="heading-37">5.4 三者齐上阵：打团战</h4>
<p><strong>适合场景：复杂的、端到端的大项目</strong></p>
<p>需要AI既懂业务（Skill）、又能干活（MCP）、还得听你的指挥（Prompt）。</p>
<p><strong>典型场景：重构项目</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">你（Prompt）：
"这个项目的数据库层写得太乱了，帮我重构一下"

↓

AI：好嘞，调用"代码重构专家Skill"

↓

Skill（专业流程）：
<span class="hljs-bullet">1.</span> 先分析现有架构（得知道现在是个啥样）
<span class="hljs-bullet">2.</span> 找出问题（为啥说它乱？）
<span class="hljs-bullet">3.</span> 设计新方案（怎么改才合理？）
<span class="hljs-bullet">4.</span> 制定迁移计划（一步步怎么改？）

↓

MCP工具（动手干活）：
<span class="hljs-bullet">-</span> 文件系统MCP：读取所有相关代码
<span class="hljs-bullet">-</span> 代码分析MCP：分析依赖关系
<span class="hljs-bullet">-</span> 文件操作MCP：创建新文件、修改旧文件
<span class="hljs-bullet">-</span> 测试MCP：跑测试看看改对了没
<span class="hljs-bullet">-</span> 数据库MCP：执行数据迁移

↓

最终交付：
✅ 重构后的代码（干净整洁）
✅ 迁移脚本（数据不丢失）
✅ 测试报告（全通过）
✅ 更新的文档（让别人看懂）
✅ 改动日志（改了啥一目了然）
</code></pre>
<p><strong>为啥三个都要？</strong></p>
<ul>
<li><strong>Prompt</strong>：你得告诉AI你想要啥</li>
<li><strong>Skill</strong>：AI得知道专业的重构套路</li>
<li><strong>MCP</strong>：AI得能真的去改代码、跑测试</li>
</ul>
<p>少一个都干不成！就像打游戏，需要队友配合一样。</p>
<hr/>
<h3 data-id="heading-38">六、不翻车的实用攻略</h3>
<h4 data-id="heading-39">6.1 Prompt的保命口诀</h4>
<p>把Prompt写好，效果直接上一个档次，记住这几条：</p>
<ol>
<li>
<p><strong>说人话，别说梦话</strong></p>
<ul>
<li>❌ “给我一个很棒的方案”</li>
<li>✅ “给我一个适合20人团队、预算10万的营销方案”</li>
</ul>
</li>
<li>
<p><strong>给背景，就像讲八卦</strong></p>
<ul>
<li>你说“帮我优化代码”，AI会反问“哪段？”</li>
<li>你说“这段Python跑批处理，文件500MB，内存爆了”，AI立马懂你疼点在哪。</li>
</ul>
</li>
<li>
<p><strong>要求写清楚，别让它猜</strong></p>
<ul>
<li>输出要表格就说表格，要清单就说清单，要Markdown就说Markdown。</li>
<li>你不说，它可能给你写一篇散文。</li>
</ul>
</li>
<li>
<p><strong>角色设定像请外援</strong></p>
<ul>
<li>“你是个资深DBA” &gt; “帮我看数据库”</li>
<li>AI特别吃“角色”这一套，像cosplay一样认真。</li>
</ul>
</li>
<li>
<p><strong>示例是最强外挂</strong></p>
<ul>
<li>给个例子，AI就知道怎么对齐格式。</li>
<li>没例子，它就自由发挥，发挥的方向可能很自由。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-40">6.2 MCP的正确打开方式</h4>
<p>MCP是AI的手脚，别乱用，不然自己吓自己：</p>
<ol>
<li>
<p><strong>权限别开太大</strong></p>
<ul>
<li>该读的文件让它读，不该删的文件别给权限。</li>
<li>不然你可能会体验到“代码蒸发术”。</li>
</ul>
</li>
<li>
<p><strong>先问清楚，再让它动手</strong></p>
<ul>
<li>让AI先列计划，确认无误再执行。</li>
<li>就像让司机先看导航再踩油门。</li>
</ul>
</li>
<li>
<p><strong>工具别堆一堆</strong></p>
<ul>
<li>只调用必要工具，别“全家桶”一起上。</li>
<li>能一把钥匙开门，就别拿全套扳手。</li>
</ul>
</li>
<li>
<p><strong>出错别慌，先重试</strong></p>
<ul>
<li>工具调用失败很正常，网络抽风、权限不足都有可能。</li>
<li>先重试、再换路，不要一上来就怀疑人生。</li>
</ul>
</li>
<li>
<p><strong>多用组合拳</strong></p>
<ul>
<li>文件 + 搜索 + 文档 = 一条龙</li>
<li>你需要的是“流程”，不是“单点爆破”。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-41">6.3 Skill的养成秘籍</h4>
<p>Skill就是AI的专业培训班，想让它靠谱，得这样做：</p>
<ol>
<li>
<p><strong>单一职责，别让它兼职</strong></p>
<ul>
<li>一个Skill干一件事，做深不做杂。</li>
<li>“代码审查”就别顺便做“UI设计”。</li>
</ul>
</li>
<li>
<p><strong>流程写清楚</strong></p>
<ul>
<li>把“先干啥、再干啥、最后干啥”写得明明白白。</li>
<li>你怎么教新人，就怎么写Skill。</li>
</ul>
</li>
<li>
<p><strong>输出格式统一</strong></p>
<ul>
<li>报告、清单、表格都要统一格式。</li>
<li>不然每次结果长得都像不同人写的。</li>
</ul>
</li>
<li>
<p><strong>持续迭代</strong></p>
<ul>
<li>发现问题就改，Skill和人一样要成长。</li>
<li>不更新，它也会跟你一样“老化”。</li>
</ul>
</li>
<li>
<p><strong>多练多用</strong></p>
<ul>
<li>Skill不是写出来就完事，得用起来才知道哪里不好。</li>
<li>用着用着，它就越来越像你的得力干将。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-42">七、常见翻车现场（看完能少走弯路）</h3>
<p><strong>翻车1：Prompt太短，AI自由发挥</strong></p>
<pre><code class="hljs">你：帮我写个方案
AI：给你写了个三年创业计划书
你：我只是想做个小活动……
</code></pre>
<p><strong>翻车2：MCP权限乱开</strong></p>
<pre><code class="hljs">你：帮我清理一下临时文件
AI：好嘞，项目文件夹已清空
你：？？？
</code></pre>
<p><strong>翻车3：Skill没流程，结果像开盲盒</strong></p>
<pre><code class="hljs">第一次：写得像教科书
第二次：变成聊天记录
第三次：变成段子
你：我到底该看哪个？
</code></pre>
<p><strong>翻车4：三件套没配齐</strong></p>
<pre><code class="hljs">有Prompt没MCP：想改文件但动不了
有MCP没Skill：能改但乱改
有Skill没Prompt：流程很专业，但不知道你想干嘛
</code></pre>
<hr/>
<h3 data-id="heading-43">八、未来趋势（不一定准，但挺好玩）</h3>
<h4 data-id="heading-44">8.1 Prompt会越来越“傻瓜”</h4>
<p>以后可能只要说一句话，系统就自动帮你补全背景和要求。
就像输入法智能联想，你刚打“帮我写”它就猜出你要写啥。</p>
<h4 data-id="heading-45">8.2 MCP会像“乐高积木”</h4>
<p>想要新能力就加一个小模块，拼起来就是一个完整的“AI工具箱”。
用起来像搭积木，拆装方便，还不会弄坏主机。</p>
<h4 data-id="heading-46">8.3 Skill会越来越像“私人助理”</h4>
<p>你习惯怎么做事，它就怎么做事。
久而久之，它会变得像你的小分身：知道你喜欢什么、不喜欢什么、讨厌什么。</p>
<hr/>
<h3 data-id="heading-47">九、最后的唠叨</h3>
<p>记住一句话就够了：</p>
<p><strong>Prompt是你说话的姿势，MCP是AI的手脚，Skill是AI的职业技能。</strong></p>
<p>想让AI干活快、准、靠谱，就得三件套一起上。
你说清楚（Prompt）+ 它有工具（MCP）+ 它有套路（Skill）= 事儿成了。</p>
<p>就这么简单。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别被概念忽悠了：Agent Skills 的本质就是一份“可执行 SOP”]]></title>    <link>https://juejin.cn/post/7598938568430944271</link>    <guid>https://juejin.cn/post/7598938568430944271</guid>    <pubDate>2026-01-26T03:17:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598938568430944271" data-draft-id="7598931684881563700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别被概念忽悠了：Agent Skills 的本质就是一份“可执行 SOP”"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T03:17:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shengjk1"/> <meta itemprop="url" content="https://juejin.cn/user/2647279732524957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别被概念忽悠了：Agent Skills 的本质就是一份“可执行 SOP”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279732524957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shengjk1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:17:48.000Z" title="Mon Jan 26 2026 03:17:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="gruvbox-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#282828}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#ebdbb2}.hljs-deletion,.hljs-formula,.hljs-keyword,.hljs-link,.hljs-selector-tag{color:#fb4934}.hljs-built_in,.hljs-emphasis,.hljs-name,.hljs-quote,.hljs-strong,.hljs-title,.hljs-variable{color:#83a598}.hljs-attr,.hljs-params,.hljs-template-tag,.hljs-type{color:#fabd2f}.hljs-builtin-name,.hljs-doctag,.hljs-literal,.hljs-number{color:#8f3f71}.hljs-code,.hljs-meta,.hljs-regexp,.hljs-selector-id,.hljs-template-variable{color:#fe8019}.hljs-addition,.hljs-meta-string,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-string,.hljs-symbol{color:#b8bb26}.hljs-attribute,.hljs-bullet,.hljs-class,.hljs-function,.hljs-function .hljs-keyword,.hljs-meta-keyword,.hljs-selector-pseudo,.hljs-tag{color:#8ec07c}.hljs-comment{color:#928374}.hljs-link_label,.hljs-literal,.hljs-number{color:#d3869b}.hljs-comment,.hljs-emphasis{font-style:italic}.hljs-section,.hljs-strong,.hljs-tag{font-weight:700}</style><p>你好，我是 shengjk1，多年大厂经验，努力构建 通俗易懂的、好玩的编程语言教程。 欢迎关注！你会有如下收益：</p>
<ol>
<li>了解大厂经验</li>
<li>拥有和大厂相匹配的技术等</li>
</ol>
<p>希望看什么，评论或者私信告诉我！</p>
<h2 data-id="heading-0">一、背景</h2>
<p>在 AI Agent 领域，新词层出不穷，最近 "Agent Skills" 成了众人追捧的新对象。</p>
<p>很多人把它神圣化，觉得是什么不可思议的黑科技。但如果你撕掉它的神秘外衣，你会发现：Agent Skills 的本质，就是一份针对某一类特定问题的数字化、可执行的 SOP（标准作业程序）。</p>
<p>这是一篇基于我们深度对话整理的技术博客，旨在破除概念迷信，从工程本质出发解析 <strong>Agent Skills</strong>。</p>
<h2 data-id="heading-1">二、 回归本质：SOP 的数字化重生</h2>
<p>传统的 SOP 是一叠厚厚的 PDF，躺在员工的手册里。而 Agent Skills 是把这些“领域专家经验”封装成了“AI 可阅读并执行的指令集”。</p>
<p>一个典型的 Agent Skill 文件夹通常包含：</p>
<ul>
<li><strong>SKILL.md (灵魂)</strong>：定义了 SOP 的控制逻辑。它告诉 AI 什么时候用这个技能、前置条件是什么、具体的 Workflow 步骤以及行为约束。</li>
<li><strong>scripts/ (手脚)</strong>：存放具体的执行工具（如 Python 或 Shell 脚本）。AI 不需要猜测复杂的命令参数，直接调用这些经过验证的脚本。</li>
<li><strong>examples/ (经验)</strong>：通过 Few-shot 示例，告诉 AI 理想的输出标准。</li>
</ul>
<p>SOP 告诉你如何做，Skill 替你做了。SOP 规避人为失误，Skill 规避 AI 幻觉，让AI拥有专业的领域知识，让AI等价于领域专家</p>
<h2 data-id="heading-2">三、 核心亮点：渐进式披露 (Progressive Disclosure)</h2>
<p>为什么我们不直接把所有 Prompt 塞给 AI？因为 AI 的注意力是稀缺资源。Agent Skills 在工程上实现了一个天才的机制——<strong>渐进式披露</strong>。</p>
<ul>
<li><strong>轻量发现</strong>：系统平时只给 AI 喂一个极其简短的“技能索引”。</li>
<li><strong>意图触发</strong>：只有当 AI 意识到任务需要某个特定技能时，工程层面的“书童”（Orchestrator）才会从磁盘读取完整的 <code>SKILL.md</code> 全量注入上下文。</li>
</ul>
<p>这不仅节省了 Token 成本，更解决了“大海捞针”问题。通过这种<strong>指令的“按需加载”</strong>，我们强制 AI 在执行的那一刻，从“胡言乱语的大学生”瞬间坍缩为“专注的领域专家”。</p>
<h2 data-id="heading-3">四、渐进式披露：本质上是工程能力</h2>
<p>AI就想是一个能力强大的超级赛亚人，但它没有思考能力，你给他什么，他就全部接受。为了实现渐进式披露，必然需要在工程上做一些改进。
下面是渐进式披露的例子：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProgressiveAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.context = []
        self.loaded_skills = <span class="hljs-built_in">set</span>() <span class="hljs-comment"># 记录已经加载详细指令的技能</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_system_prompt</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 第一步：只披露“菜单” (Metadata)</span>
        skill_menu = <span class="hljs-string">"\n"</span>.join([<span class="hljs-string">f"- <span class="hljs-subst">{name}</span>: <span class="hljs-subst">{info[<span class="hljs-string">'metadata'</span>]}</span>"</span> 
                               <span class="hljs-keyword">for</span> name, info <span class="hljs-keyword">in</span> SKILLS_LIBRARY.items()])
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"""你是一个智能助手。你拥有以下技能目录：
        <span class="hljs-subst">{skill_menu}</span>
        
        如果你发现需要使用某个技能，请输出：[LOAD_SKILL: skill_name]。
        如果你已经准备好执行，请直接输出：[ACTION: tool_name]。
        """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_loop</span>(<span class="hljs-params">self, user_query</span>):
        self.context.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: self.get_system_prompt()})
        self.context.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: user_query})

        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-comment"># 调用 LLM</span>
            response = call_llm(self.context) 
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent Thought: <span class="hljs-subst">{response}</span>"</span>)

            <span class="hljs-comment"># 第二步：检测模型是否请求“披露”更多细节</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"[LOAD_SKILL:"</span> <span class="hljs-keyword">in</span> response:
                skill_name = parse_skill_name(response)
                
                <span class="hljs-keyword">if</span> skill_name <span class="hljs-keyword">in</span> SKILLS_LIBRARY <span class="hljs-keyword">and</span> skill_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.loaded_skills:
                    <span class="hljs-comment"># 动态注入详细指令</span>
                    detail = SKILLS_LIBRARY[skill_name][<span class="hljs-string">'full_instructions'</span>]
                    self.context.append({
                        <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, 
                        <span class="hljs-string">"content"</span>: <span class="hljs-string">f"已加载技能 <span class="hljs-subst">{skill_name}</span> 的详细说明：\n<span class="hljs-subst">{detail}</span>"</span>
                    })
                    self.loaded_skills.add(skill_name)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- 系统：已动态披露 <span class="hljs-subst">{skill_name}</span> 的详细指令 ---"</span>)
                    <span class="hljs-keyword">continue</span> <span class="hljs-comment"># 携带新知识进入下一轮推理</span>

            <span class="hljs-comment"># 第三步：处理最终行动或输出</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"[ACTION:"</span> <span class="hljs-keyword">in</span> response:
                <span class="hljs-comment"># 执行具体工具...</span>
                <span class="hljs-keyword">break</span>
</code></pre>
<h2 data-id="heading-4">五、 逻辑路由：为 AI 制造“局部真理”</h2>
<p>不用的 skills，可以看作是不通领域的专家，AI 就是那个路由器，不能的问题会被路由到不通的专家</p>
<p><strong>逻辑路由（Logical Routing）</strong> 的本质是 <strong>“上下文的精准外科手术”</strong>。它根据用户的意图，为模型临时构建一套完全不同的“职业环境”：</p>
<ol>
<li><strong>降噪</strong>：剪掉 90% 无关的信息，让模型在当前任务下拥有最高的“思维专注度”。</li>
<li><strong>授权</strong>：只有路由到该 Skill，AI 才被允许调用对应的外部工具（如 <code>ffmpeg</code>）。</li>
</ol>
<p>这种动态的角色重塑，让 AI 在每一秒钟内只相信一个“局部真理”：<strong>我现在唯一的任务，就是按照这份 SOP 完美地执行。</strong></p>
<h2 data-id="heading-5">六、 行业分水岭：从“调优 Prompt”到“面向 Skill 开发”</h2>
<p>我们正在经历编程史上的又一次高阶抽象跃迁。过去我们面向代码开发，未来我们将<strong>面向 Agent Skills 开发</strong>。</p>
<p>目前，行业已经出现了明显的分水岭：</p>
<ul>
<li><strong>OpenAI 路径</strong>：走“API Store”路线，万物皆云端 API。</li>
<li><strong>Anthropic (Claude) 与 IDE 路径</strong>：走“本地执行者”路线。Claude 官方 API 已原生集成 Skills 架构，强制要求 <code>SKILL.md</code> 结构。</li>
</ul>
<p>这意味着，Agent Skills 正在成为 AI 领域的 <strong>“容器化技术（Docker）”</strong>。它让模型与环境、指令与执行彻底解耦。</p>
<h2 data-id="heading-6">七、未来的开发范式</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6acba45a35e44eac8c9b1b14405eaa01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hlbmdqazE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770002272&amp;x-signature=7V2mIYc%2Bjx2Wvm3%2BhPqsxtJuGGc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>智能体循环：决定下一步行动的核心推理系统</li>
<li>智能体运行时：执行环境（代码、文件系统）</li>
<li>MCP服务器：与外部工具和数据源的连接
4.技能库：领域专业知识和流程知识</li>
</ol>
<p>每层都有明确的用途：循环层负责推理，运行时层负责执行，MCP层负责连接，技能层负责引导。这种分离使系统易于理解，并允许各个部分独立演进。</p>
<h2 data-id="heading-7">八、总结</h2>
<p>我们正处在 AI 应用开发范式转型的十字路口。<strong>Agent Skills 的兴起，标志着编程逻辑从“面向指令”向“面向能力与规范”的高阶跃迁</strong>。</p>
<p><strong>未来，开发者真正的核心资产不再是零散的代码片段，而是那些被精心打磨、可跨平台迁移的数字 SOP（Skills）。</strong></p>
<p>如果说 Claude Code、Codex 等工具可以让未来每一个人都是程序员，程序员全员化，那么 Skills 可以让未来每个人都是专家，专家全员化。</p>
<p>但信息壁垒依然存在，技术壁垒依然存在，并且会越来越去平民化
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99cf989534d34377b09d02cfecf0acd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hlbmdqazE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770002272&amp;x-signature=21N5jKJ1pTQrGnwkOv02CtxhlaY%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI浪潮下的职场变革：从技术分工到Agent工程师，前端该如何破局？]]></title>    <link>https://juejin.cn/post/7598918127578333218</link>    <guid>https://juejin.cn/post/7598918127578333218</guid>    <pubDate>2026-01-26T03:33:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598918127578333218" data-draft-id="7598938568431009807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI浪潮下的职场变革：从技术分工到Agent工程师，前端该如何破局？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T03:33:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日月之行_"/> <meta itemprop="url" content="https://juejin.cn/user/4107431171859181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI浪潮下的职场变革：从技术分工到Agent工程师，前端该如何破局？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431171859181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日月之行_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:33:38.000Z" title="Mon Jan 26 2026 03:33:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>近日国内技术圈就被一则重磅消息搅动得波澜壮阔 —— 前阿里 P10 毕玄在其创业公司发布飞书通知，宣布取消前端、后端等按技术栈划分的岗位，所有技术人员统一命名为 “Agent 工程师”，工作分配不再受技术领域限制，完全围绕产品目标和项目结果展开。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83708bd952d448bf98a7a68e6e9aa0e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5pyI5LmL6KGMXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003222&amp;x-signature=Ho5M%2BwTA9TlVwEg0tnZ0cjAPS6Q%3D" alt="" loading="lazy"/></p>
<p>这一举措，不仅是一家创业公司的大胆尝试，更像是 AI 时代技术职场变革的一声号角，引发了无数工程师的思考：我们熟悉的技术分工逻辑，真的要被颠覆了吗？</p>
<h2 data-id="heading-0">传统的技术职责分工，如今却成桎梏</h2>
<p>在<code>AI</code>编码尚未普及时，大部分软件开发企业始终遵循着严格的分工逻辑。技术栈之间壁垒森严，前端工程师专注于页面布局与交互，后端工程师深耕服务器架构与数据处理，测试工程师则紧盯软件质量与 <code>bug</code> 修复。之所以会形成这样的分工模式，核心原因在于 “人的精力有限”—— 想要精通多个技术栈，需要耗费大量时间学习语法、背诵规则、积累经验，而在快速迭代的项目需求下，企业更倾向于让工程师 “深耕单一领域”，通过专业化提升效率，同时降低人才培养成本、明确责任边界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a7b898e89442f9b909737a3b4ef033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5pyI5LmL6KGMXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003222&amp;x-signature=YBGj81oQJDIk5qyMkcn4ZGP2l4M%3D" alt="" loading="lazy"/></p>
<p>就像传统工厂的流水线，每个工人只需掌握一道工序，就能快速产出标准化产品。在很长一段时间里，这套技术分工体系运转良好，推动着软件行业不断发展。但随着<code>AI Coding</code> 工具的崛起，这套体系的弊端逐渐凸显：一个简单的需求，可能需要前端、后端、测试多岗协作，需求在传递过程中容易出现信息损耗，岗位间的衔接等待也会浪费大量时间，比如前端工程师完成页面后，需要等待后端工程师提供接口才能继续开发，整个项目进度很容易卡在 “协同环节”。</p>
<h2 data-id="heading-1">AI Coding 打破技术边界，跨栈开发不再是 “天方夜谭”</h2>
<p>改变这一切的，正是<code>Claude Code、Cursor Pro、Trae</code> 等<code>AI Coding</code>工具的出现。它们就像一把 “万能钥匙”，彻底拉低了跨技术栈开发的门槛。以前端工程师为例，若想开发一个简单的后端接口，放在过去，可能需要花三个月时间系统学习后端编程语言、框架原理和数据库操作；但现在，只需明确接口的功能目标，比如 “接收用户提交的表单数据并存储到数据库”，<code>AI</code> 就能快速生成对应的后端代码，工程师只需负责对代码进行 <code>review</code>（审查）和调试，确保代码逻辑正确、符合项目需求即可。</p>
<p>过去，工程师花费大量精力记忆编程语言语法、框架使用规则等机械性知识，这些知识繁琐且易遗忘，却占据了学习成本的很大一部分。而 <code>AI Coding</code> 工具恰好能胜任这类工作，它们可以精准识别代码语法错误、自动补全代码片段、甚至优化代码结构。<strong>这意味着，工程师不再需要 “死记硬背” 技术细节，而是可以将精力聚焦在更核心的能力上 —— 理解业务逻辑、拆解项目目标、把握问题本质。</strong></p>
<h2 data-id="heading-2">从 “全栈工程师” 到 “Agent 工程师”，不止是名字的改变</h2>
<p>毕玄团队将新岗位命名为<code> “Agent 工程师”</code>，而非我们熟悉的 “全栈工程师”，这背后其实是工程师角色的本质转变。很多人认为全栈工程师就是 “什么都会的工程师”，需要精通前端、后端、测试等所有技术栈，既要能写出美观的页面，又要能搭建稳定的服务器，还要能高效排查 bug。但这种 “全能型” 人才培养难度极大，很少有人能真正达到 “精通所有技术栈” 的水平。</p>
<p>而 Agent 工程师的核心能力，并非 “精通所有技术”，而是 “会用 <code>AI </code>完成全链路任务”。<strong>在 <code>AI</code> 时代，工程师的角色从技术 “执行者” 转变为 <code>AI</code> “指挥者”：<code>AI</code> 负责具体的代码编写、语法检查、简单<code> bug</code> 修复等执行性工作；</strong>  工程师则负责更关键的环节 —— 拆解产品目标，将大需求分解为 <code>AI</code> 可理解、可执行的小任务；指挥<code>AI</code>按步骤完成任务，比如告诉<code> AI</code>“先开发用户登录接口，再实现登录状态保存功能”；判断 <code>AI </code>生成结果的合理性，比如审查代码是否符合业务逻辑、是否存在安全隐患；把控项目风险，比如提前预判某个技术方案可能出现的问题，并指导<code>AI</code>调整方案。</p>
<p><strong><code>Anthropic</code> 公司的实践就是最好的证明：其内部 <code>90%</code> 的代码由<code> AI</code> 工具 <code>Claude</code> 自动编写，人类工程师仅需对代码进行编辑和监督。</strong>  曾有一次，<code>Anthropic</code> 的服务器集群出现一个隐藏极深的 <code>bug</code>，工程师连续排查数日都没有找到问题根源，而 <code>Claude</code> 仅用几个小时就定位到 <code>bug</code> 所在，并生成了修复方案，完成了 “判断问题 - 执行排查 - 修复 <code>bug</code>” 的全闭环。这一案例充分说明，在 <code>AI</code> 的辅助下，<code>Agent</code> 工程师能以更高效率完成复杂任务，甚至突破人类自身的技术局限。</p>
<h2 data-id="heading-3">Agent 工程师时代，前端开发工程师该如何 “破局”？</h2>
<p>我认为自身需要主动调整心态和能力结构。过去，很多前端开发习惯 “守着单一技术栈过日子”，认为 “把前端做好就够了” “上线部署不是我负责，没必要学运维”，这种 “画地为牢” 的思维在<code>AI</code>时代已经不合时宜。<strong>未来，工程师的核心竞争力将从 “技术熟练度” 转向 “综合能力”：一是问题抽象能力，能将复杂的业务需求抽象为清晰的技术任务；二是结果判断力，能准确判断<code>AI</code>生成结果的合理性，避免 “<code>AI</code> 出错而自己毫无察觉”；三是 <code>AI</code> 调度能力，能熟练使用不同的<code>AI</code>工具，根据任务需求选择最合适的工具，并指导<code> AI</code> 优化结果。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55f6fe3913284466865afcc5687ffb7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5pyI5LmL6KGMXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003222&amp;x-signature=byE1vitp0GWweqsyjYQQ%2FDtzfbg%3D" alt="image.png" loading="lazy"/></p>
<p>此外，行业对人才的需求也在发生变化 —— 从 “单点深耕的专才” 转向 “T 型甚至 π 型人才”。“T 型人才” 指在某一领域有深度（比如前端技术），同时在其他领域有广度（了解后端、测试基础）；“π 型人才” 则是在两个或多个领域有深度，同时具备跨领域整合能力。<code>Agent</code> 工程师正是 “T 型 /π 型人才” 的体现，他们不需要 “样样精通”，但需要 “样样懂一点，且能借助<code>AI</code>做好所有事”。</p>
<p>2026 年才刚刚开始，<strong>马斯克说 “今年或许会成为近几个世纪以来最重要的一年”，</strong>  这句话放在技术行业同样适用。<code>AI </code>正在重构软件开发的底层逻辑，技术工种的边界逐渐消失，传统的技术分工模式正在被打破。对工程师而言，这既是挑战，也是机遇 —— 挑战在于需要跳出舒适区，适应全新的工作模式；机遇在于，<strong>AI 能帮助我们突破技术局限，以更高效率创造价值，实现职业跃迁。唯有打破思维定式、拥抱变化，主动学习 AI 工具、提升综合能力，才能在 Agent 工程师时代站稳脚跟，成为 AI 浪潮中的 “弄潮儿”。</strong></p>
<p><em>已同步在微信公众号《前端日月潭》发布</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我同时维护 Vue3、React、Flutter 项目后，才意识到“状态管理”其实是伪命题]]></title>    <link>https://juejin.cn/post/7598938568431271951</link>    <guid>https://juejin.cn/post/7598938568431271951</guid>    <pubDate>2026-01-26T03:50:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598938568431271951" data-draft-id="7598838597559992354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我同时维护 Vue3、React、Flutter 项目后，才意识到“状态管理”其实是伪命题"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T03:50:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我同时维护 Vue3、React、Flutter 项目后，才意识到“状态管理”其实是伪命题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:50:56.000Z" title="Mon Jan 26 2026 03:50:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>状态本身并不可怕，可控的边界才是关键。无论 Vue/React/Flutter，真正失控的场景总是因为<code>谁该负责这块状态？</code> <code> 状态的生命周期与副作用不一样咋办？</code> <code>状态有多个“真实来源”</code>。比起盲目选用全局状态库，先设计状态边界、所有者与契约，再选工具，这才是我想写这篇文章的核心。</p>
</blockquote>
<h2 data-id="heading-0">目前</h2>
<p>我维护过三套完全不同的代码库：一个用 Vue3 做企业后台，一个用 React 做客户运营后台，还有一个用 Flutter 做用户端 App。开始的时候我和很多人一样，把“状态管理”当成救命稻草，拿着 Pinia、Redux、Provider 当工具箱里的万能胶，遇到问题就往全局塞状态。后来出现的问题不是框架的锅，而是我和团队没有先把状态的边界划清楚。最直观的一次教训是一个批量导入功能：导入进度既存在于页面的临时变量，也存在于全局 cache、后端轮询结果，还有一个后台任务队列的本地副本，结果在某些网络抖动场景下进度条反复闪烁、提交失败、回调覆盖更新，排查下来并不是网络问题，而是同一份“事实”有多个来源、多个所有者、多个副作用在不同地方生效，互相覆盖。修复并不靠换库，而是靠把“导入任务”明确成单一来源、改用只读查询加唯一写入入口，并把所有副作用集中到 service 层，这才把问题彻底堵住。</p>
<h2 data-id="heading-1">示例一：Vue3 中“状态失控”的典型写法 vs 有边界的写法</h2>
<p><strong>失控版本（真实会出事故的那种）</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// store.ts</span>
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">importTask</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>,
})
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// A.vue</span>
state.<span class="hljs-property">progress</span> = <span class="hljs-number">30</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// B.vue</span>
state.<span class="hljs-property">progress</span> = <span class="hljs-number">80</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// service.ts</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  state.<span class="hljs-property">progress</span> += <span class="hljs-number">10</span>
}, <span class="hljs-number">1000</span>)
</code></pre>
<p>这种写法的问题不是 Vue，而是<strong>任何地方都能写</strong>，没有人知道谁是妆台管理者。<br/>
只要接口回调、定时轮询、用户操作同时发生一次，UI 就开始抽风。</p>
<h2 data-id="heading-2">但是</h2>
<p>不同框架的问题表现不太一样，但本质相似。Vue3 的常见失控点是把 <code>reactive</code> 的对象随手导出，全项目任意模块直接改动，或者把大量短期 UI 状态塞进 Pinia，结果是到底哪个组件该清理、什么时候取消 watch、谁负责取消请求，没人说得清楚；React 的典型症状是把太多东西放进 Context 或一个大 Redux store，组件随便改对象属性（非不可变更新），导致 memo 无效、重渲染泛滥和难以回溯的副作用；Flutter 则常见在 <code>setState</code> 或全局单例里乱放数据，导致父组件更新引起大量子树不必要重建，或者 Provider/Riverpod 的边界划分混乱，让调试变得痛苦。无论是哪种框架，问题总在这些点交汇：谁该负责这块数据、这块数据的生命周期何时开始与结束、哪些副作用会影响它、它是否有多个事实来源。</p>
<h2 data-id="heading-3">示例二：React 中“useEffect 地狱”是怎么来的</h2>
<p><strong>常见但危险的写法</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ImportPage</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> [progress, setProgress] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/task?user=<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setProgress</span>(data.<span class="hljs-property">progress</span>))
  }, [userId, progress])
}
</code></pre>
<p>这个代码我敢说你肯定见过。<br/>
问题在于：<code>progress</code> 既是<strong>结果</strong>，又被当成<strong>触发条件</strong>，effect 自己触发自己，网络抖一下就会循环请求。</p>
<p><strong>把副作用和状态边界拆开</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useImportTask</span>(<span class="hljs-params">userId: string</span>) {
  <span class="hljs-keyword">const</span> [progress, setProgress] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> canceled = <span class="hljs-literal">false</span>

    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/task?user=<span class="hljs-subst">${userId}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!canceled) <span class="hljs-title function_">setProgress</span>(data.<span class="hljs-property">progress</span>)
      })

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      canceled = <span class="hljs-literal">true</span>
    }
  }, [userId])

  <span class="hljs-keyword">return</span> progress
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ImportPage</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">useImportTask</span>(userId)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Progress</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{progress}</span> /&gt;</span></span>
}
</code></pre>
<p>z仔细看看这段代码你会发现：  <strong>页面不再“拥有”状态，只是消费状态</strong>，失控的入口直接少了一半。</p>
<h2 data-id="heading-4">解决</h2>
<p>既然问题的核心是“边界不清”，我给新项目的建议有几条可能听起来反直觉但非常实用：第一，<code>不要急着建一个全局 store</code>，先把状态放在页面或组件本地，等出现明确的跨页面共享需求并能量化受益时再抽象；
第二，写代码前先画张状态边界图，列出每个状态的 owner、生命周期、是否持久化、是否为衍生值、以及唯一的写入入口；第三，全局或模块化 store 只暴露只读查询和明确的写入 API，禁止项目随意直接修改内部结构；第四，副作用全部集中到 service/side-effect 层（无论是 React 的 hook、Vue 的 composable 还是 Flutter 的 repository），组件只负责展示与触发，副作用层负责取消、去重、重试和错误处理；第五，<code>衍生状态不要持久化</code>，能由原始状态算出来的就用 computed/selector 动态计算；第六，对于复杂的状态流转场景（例如多阶段导入、有超时和回滚逻辑）考虑用状态机来建模，状态可视化之后很多边界问题就能一目了然；第七，启用类型系统和不可变更新约定，这能大幅提升可追溯性和避免微妙的引用错误；第八，把变更审计和日志当成基础设施，<code>为重要的全局状态记录 action 名称、时间戳和 trace id，出问题时能快速回溯。</code></p>
<p>哦对了，忘记距离flutter了，这个技术在掘金里面可能用到的人有点少，没有react vue那么多，但还是说一下吧。</p>
<h2 data-id="heading-5">示例三：Flutter 里最容易被忽略的全局状态</h2>
<p><strong>问题写法</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalTask</span> {
  <span class="hljs-type">static</span> <span class="hljs-type">int</span> progress = <span class="hljs-number">0</span>;
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">setState(() {
  GlobalTask.progress += 10<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这个问题非常隐蔽，因为 Flutter 重建 UI 很快，早期根本察觉不到。<br/>
但一旦页面多了、热重载多了、逻辑复杂了，你根本不知道是谁在改。</p>
<p><strong>明确 owner 的写法（Provider / Riverpod 思路）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportTaskState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ChangeNotifier</span> {
  int _progress = <span class="hljs-number">0</span>;

  int get progress =&gt; _progress;

  <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProgress</span>(<span class="hljs-params">int value</span>) {
    _progress = value;
    <span class="hljs-title function_">notifyListeners</span>();
  }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-title class_">ImportTaskState</span>&gt;(
  <span class="hljs-attr">builder</span>: (_, state, __) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ProgressBar</span>(<span class="hljs-attr">value</span>: state.<span class="hljs-property">progress</span>);
  },
)
</code></pre>
<p>你不是在用 Provider，而是在<strong>声明：这块状态属于 ImportTaskState</strong>。</p>
<p>还有一些衍生状态千万不要存，如果有复杂流程直接用状态机</p>
<p><strong>错误思路</strong></p>
<pre><code class="hljs language-js" lang="js">state.<span class="hljs-property">list</span> = rawList
state.<span class="hljs-property">filteredList</span> = rawList.<span class="hljs-title function_">filter</span>(...)
</code></pre>
<p><strong>正确思路</strong></p>
<pre><code class="hljs language-hs" lang="hs">const filteredList = computed(() =&gt; {
  return state.list.filter(...)
})
</code></pre>
<p>这不是性能优化，这是<strong>防止状态分叉</strong>。  一旦存了两份，你迟早要花时间修同步问题。</p>
<hr/>
<h2 data-id="heading-6">状态机</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> importMachine = <span class="hljs-title function_">createMachine</span>({
  <span class="hljs-attr">id</span>: <span class="hljs-string">'import'</span>,
  <span class="hljs-attr">initial</span>: <span class="hljs-string">'idle'</span>,
  <span class="hljs-attr">states</span>: {
    <span class="hljs-attr">idle</span>: { <span class="hljs-attr">on</span>: { <span class="hljs-attr">START</span>: <span class="hljs-string">'uploading'</span> } },
    <span class="hljs-attr">uploading</span>: { <span class="hljs-attr">on</span>: { <span class="hljs-attr">SUCCESS</span>: <span class="hljs-string">'processing'</span>, <span class="hljs-attr">FAIL</span>: <span class="hljs-string">'error'</span> } },
    <span class="hljs-attr">processing</span>: { <span class="hljs-attr">on</span>: { <span class="hljs-attr">DONE</span>: <span class="hljs-string">'completed'</span> } },
    <span class="hljs-attr">completed</span>: {},
    <span class="hljs-attr">error</span>: {},
  },
})
</code></pre>
<p>当你把流程画成状态图之后，会非常清楚地看到：<strong>哪些状态允许更新，哪些不允许</strong>，根本不需要猜。</p>
<h2 data-id="heading-7">结尾~~~</h2>
<p>以下是我总结的几点建议~，针对我们当前三个技术栈项目了，按需自取哈~并不通用。</p>
<ul>
<li>一，功能设计阶段画状态边界图并在 PR 中提交；</li>
<li>二，凡是跨页面共享的状态必须指定 owner 与 action；</li>
<li>三，把网络请求、订阅、定时器等副作用统一封装在 service 层并实现取消逻辑；</li>
<li>四，把 UI 临时数据留在本地，衍生数据用 selector；</li>
<li>五，<code>对复杂流程使用状态机并训练团队阅读状态图</code> 没开玩笑， man！！！；</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript性能翻倍的5个黑魔法：90%开发者不知道的秘诀]]></title>    <link>https://juejin.cn/post/7598836674630402082</link>    <guid>https://juejin.cn/post/7598836674630402082</guid>    <pubDate>2026-01-26T04:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598836674630402082" data-draft-id="7598836674630385698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript性能翻倍的5个黑魔法：90%开发者不知道的秘诀"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-26T04:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript性能翻倍的5个黑魔法：90%开发者不知道的秘诀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:16:37.000Z" title="Mon Jan 26 2026 04:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript性能翻倍的5个黑魔法：90%开发者不知道的秘诀</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>在现代Web开发中，JavaScript的性能优化是一个永恒的话题。尽管V8引擎和其他现代JavaScript引擎已经做了大量优化，但开发者仍然可以通过一些鲜为人知的技巧大幅提升代码执行效率。本文将揭示5个被大多数开发者忽视的“黑魔法”，这些技巧基于JavaScript引擎的工作原理、内存管理机制和语言特性，能够让你的代码性能轻松翻倍。</p>
<h3 data-id="heading-2">1. 利用隐藏类（Hidden Classes）优化对象属性访问</h3>
<h4 data-id="heading-3">背景</h4>
<p>V8引擎使用“隐藏类”来优化对象属性访问。当对象的属性顺序或结构发生变化时，V8会创建新的隐藏类，导致性能下降。</p>
<h4 data-id="heading-4">黑魔法</h4>
<ul>
<li><strong>固定属性顺序</strong>：始终以相同的顺序初始化对象属性。</li>
<li><strong>避免动态添加/删除属性</strong>：如果需要动态属性，使用<code>Map</code>或预先定义所有可能的属性。</li>
<li><strong>使用构造函数或<code>Object.create(null)</code></strong>：避免原型链查找开销。</li>
</ul>
<h4 data-id="heading-5">示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：性能差</span>
<span class="hljs-keyword">const</span> obj = {};
obj.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;
obj.<span class="hljs-property">b</span> = <span class="hljs-number">2</span>;

<span class="hljs-comment">// 正例：性能优</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
</code></pre>
<h4 data-id="heading-6">原理</h4>
<p>V8会为相同结构的对象分配相同的隐藏类，减少属性查找时间。动态修改属性会导致隐藏类切换，增加开销。</p>
<hr/>
<h3 data-id="heading-7">2. TypedArray与位操作：极致的数据处理效率</h3>
<h4 data-id="heading-8">背景</h4>
<p>对于密集计算（如图像处理、游戏逻辑），常规数组的性能往往不够高效。TypedArray和位操作可以显著提升数值计算的性能。</p>
<h4 data-id="heading-9">黑魔法</h4>
<ul>
<li><strong>使用TypedArray替代普通数组</strong>：如<code>Uint8Array</code>、<code>Float64Array</code>等，直接操作二进制数据。</li>
<li><strong>位操作替代数学运算</strong>：例如用<code>x &lt;&lt; 1</code>代替<code>x * 2</code>，用<code>x | 0</code>快速取整。</li>
</ul>
<h4 data-id="heading-10">示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 反例：普通数组</span>
<span class="hljs-keyword">const</span> pixels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 正例：TypedArray</span>
<span class="hljs-keyword">const</span> pixels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8ClampedArray</span>(<span class="hljs-number">1000000</span>);
</code></pre>
<h4 data-id="heading-11">原理</h4>
<p>TypedArray直接分配连续内存，避免了普通数组的装箱拆箱开销；位操作直接在CPU寄存器中完成，速度极快。</p>
<hr/>
<h3 data-id="heading-12">3. Debounce与Throttle的极致优化版本</h3>
<h4 data-id="heading-13">背景</h4>
<p>事件高频触发（如滚动、拖拽）时，传统的debounce/throttle仍可能因闭包和定时器产生额外开销。</p>
<h4 data-id="heading-14">黑魔法</h4>
<ul>
<li><strong>使用RAF（RequestAnimationFrame）替代setTimeout</strong>：更适合动画场景。</li>
<li><strong>纯函数版throttle</strong>：避免闭包，利用时间戳判断间隔。</li>
</ul>
<h4 data-id="heading-15">示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// RAF版throttle</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttleRAF</span>(<span class="hljs-params">fn</span>) {
    <span class="hljs-keyword">let</span> ticking = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (!ticking) {
            <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
                fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>);
                ticking = <span class="hljs-literal">false</span>;
            });
            ticking = <span class="hljs-literal">true</span>;
        }
    };
}
</code></pre>
<h4 data-id="heading-16">原理</h4>
<p>RAF与浏览器渲染周期同步，比setTimeout更高效；纯函数版本减少了作用域链查找。</p>
<hr/>
<h3 data-id="heading-17">4. Worker线程池：真正的多核并行计算</h3>
<h4 data-id="heading-18">背景</h4>
<p>JavaScript是单线程的，但Web Worker可以实现多线程并行化计算。大多数开发者仅用单个Worker，未能充分利用多核CPU。</p>
<h4 data-id="heading-19">黑魔法</h4>
<ul>
<li><strong>动态Worker线程池</strong>：根据任务量动态创建/销毁Worker。</li>
<li><strong>Transferable Objects零拷贝传输</strong>：使用<code>postMessage(data, [transferables])</code>传递大型数据（如ArrayBuffer）。</li>
</ul>
<p>####示例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker池实现核心逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkerPool</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">size</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = size;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span> = <span class="hljs-title class_">Array</span>(size).<span class="hljs-title function_">fill</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'task.js'</span>));
    }

    <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> worker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">workers</span>.<span class="hljs-title function_">pop</span>();
            <span class="hljs-keyword">if</span> (worker) {
                worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>(e.<span class="hljs-property">data</span>);
                worker.<span class="hljs-title function_">postMessage</span>(task);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>({ task, resolve });
            }
        }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> &gt; -------&gt; -------&gt; -------&gt; -------&gt; -------&gt; -------&gt; -------&gt; -------&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文教你使用免费的GLM4.7，从此告别token焦虑（vscode 、DevEco Studio也能直接使用）]]></title>    <link>https://juejin.cn/post/7599247962821607451</link>    <guid>https://juejin.cn/post/7599247962821607451</guid>    <pubDate>2026-01-26T04:43:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599247962821607451" data-draft-id="7599181528304435209" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文教你使用免费的GLM4.7，从此告别token焦虑（vscode 、DevEco Studio也能直接使用）"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T04:43:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文教你使用免费的GLM4.7，从此告别token焦虑（vscode 、DevEco Studio也能直接使用）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:43:11.000Z" title="Mon Jan 26 2026 04:43:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文教你使用免费的GLM4.7，从此告别token焦虑（vscode 、DevEco Studio也能直接使用）</h2>
<blockquote>
<p>万少：华为HDE、鸿蒙极客</p>
<p>个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.zbztb.cn%2F" target="_blank" title="https://blog.zbztb.cn/" ref="nofollow noopener noreferrer">blog.zbztb.cn/</a></p>
<p><strong>2025年参与孵化了20+鸿蒙应用、技术文章300+、鸿蒙知识库用户500+、鸿蒙免费课程2套。</strong></p>
<p>如果你也喜欢交流AI和鸿蒙技术，欢迎扣我。</p>
</blockquote>
<p>最近的<strong>GLM4.7</strong>可谓是刷屏了，不少小伙伴在使用的时候也是直呼真香</p>
<p>GLM4.7使用的方式不少：</p>
<ol>
<li>一些国产的AI编辑器直接内置，例如<strong>Trae</strong>和<strong>CodeBuddy</strong>等</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ee6b3f1ea0b402891976f98a4f16432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=3bOH%2FAWYh5Dq8Fn7l6ymkFNZ9Y0%3D" alt="图片" loading="lazy"/></p>
<ol start="2">
<li>也可以付费买<strong>token</strong>，如claude code 可以接入 <strong>GLM4.7</strong>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67cc922bce14a3480569cb12b90c75c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=JzjFgVKdGyJJ84xicdEEsdPQinc%3D" alt="图片" loading="lazy"/></p>
<ol start="3">
<li>第三种就是推荐的，使用 阿里心流团队推出的<strong>iflow-cli</strong>，它针对个人免费使用，虽然是以终端的方式使用（类似cladue code），但是也可以通过插件的方式接入**vscode、DevEco Studio（Idea）**等主流编辑器，很容易就能上手。</li>
</ol>
<h2 data-id="heading-1">iflow-cli</h2>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fcli%2Fquickstart" target="_blank" title="https://platform.iflow.cn/cli/quickstart" ref="nofollow noopener noreferrer">platform.iflow.cn/cli/quickst…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f9393cd03c240e484b76e471b352cce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=o7ATjjspsDV9zWJfE1SU9bqgF5Y%3D" alt="图片" loading="lazy"/></p>
<p>iFlow CLI 是一款终端AI助手，可以分析代码、执行编程任务、处理文件操作。</p>
<p>内置免费国产优秀大模型，DeepSeek、QWen、GLM(支持GLM4.7)、K2等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8899d700a19040789c2ba17ea266ff26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=%2BxgK5tYB%2BRTTp9%2FFJRUdY0DN2Ws%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">第1步：安装（2分钟）</h2>
<h3 data-id="heading-3">系统要求</h3>
<ul>
<li>Node.js 22+</li>
<li>4GB+ 内存</li>
<li>互联网连接</li>
</ul>
<h3 data-id="heading-4">快速安装</h3>
<p><strong>macOS/Linux</strong></p>
<p>shell</p>
<pre><code class="hljs language-less" lang="less"># 一键安装脚本，会安装全部所需依赖

<span class="hljs-selector-tag">bash</span> <span class="hljs-selector-tag">-c</span> "$(curl -fsSL <span class="hljs-attribute">https</span>:<span class="hljs-comment">//gitee.com/iflow-ai/iflow-cli/raw/main/install.sh)"</span>

# 已有Node.js <span class="hljs-number">22</span>+

npm i -g <span class="hljs-variable">@iflow-ai</span>/iflow-cli<span class="hljs-variable">@latest</span>
</code></pre>
<p><strong>Windows</strong></p>
<p>shell</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 访问 https://nodejs.org/zh-cn/download 下载最新的 Node.js 安装程序
<span class="hljs-bullet">2.</span> 运行安装程序来安装 Node.js
<span class="hljs-bullet">3.</span> 重启终端：CMD(Windows + r 输入cmd) 或 PowerShell
<span class="hljs-bullet">4.</span> 运行 <span class="hljs-code">`npm install -g @iflow-ai/iflow-cli@latest`</span> 来安装 iFlow CLI
<span class="hljs-bullet">5.</span> 运行 <span class="hljs-code">`iflow`</span> 来启动 iFlow CLI
</code></pre>
<blockquote>
<p><strong>推荐使用 Windows Terminal</strong>：为了获得更好的兼容性和使用体验，强烈推荐使用 Windows Terminal 运行 iFlow CLI，可以大幅减少环境兼容性问题。</p>
<p><strong>验证安装</strong>：运行 <code>iflow --version</code> 确认安装成功</p>
</blockquote>
<h2 data-id="heading-5">第2步：首次设置（1分钟）</h2>
<h3 data-id="heading-6">启动iFlow</h3>
<p>shell</p>
<pre><code class="hljs">iflow
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b11f3923389467494f2958d29f69d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=foQrx262bZ4WzikLXYL4Ax9uuI0%3D" alt="图片" loading="lazy"/></p>
<p>首次打开，可能需要你跳转到网页进行登录。</p>
<p>登录成功后，会出现以下界面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77488e2ce9f14b38bdb0a311a6923b02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=iZBaaH88kbzLKHyqnBeeFBeTb6U%3D" alt="图片" loading="lazy"/></p>
<p>可以看到是支持GLM4.7模型的，另外可以按tab开启思考模式，让操作更加智能！</p>
<h2 data-id="heading-7">第3步：接入vscode</h2>
<p>vscode中搜索插件 <strong>iflow-cli</strong> ， 然后直接安装即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a3097f35c824f83addb1e5ef670ad9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=Y%2BLE%2F1f%2FlHawly8Qv5P0XcX7OgE%3D" alt="图片" loading="lazy"/></p>
<p>安装成功后，随便打开一个文件，会在状态栏上看到图标。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbab97d3a59b40798c1c2bd4053ca6a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=%2BgfDW9HKZzwhUmVvu6a1FZiYIQU%3D" alt="图片" loading="lazy"/></p>
<p>点击它，会在当前目录打开终端</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25820445c38f416995acad7da75a7f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=7TuylBNHp8JTgOwNsWtMQcsmd9M%3D" alt="图片" loading="lazy"/></p>
<p>接下来你可以在终端中直接对话，也可以鼠标选中代码片段进行沟通。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28293d1d2986437f95d39a53b5e2056d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=zjkGyVB1P0C17VdugmTQLUNUREM%3D" alt="图片" loading="lazy"/></p>
<p>接下来可以畅享免费的AI编辑了！</p>
<h2 data-id="heading-8">第4步：接入 DevEco Studio</h2>
<p>如果是做鸿蒙应用开发，就需要下载离线插件，下载地址如下：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.iflow.cn%2Fcli%2Ffeatures%2Fide" target="_blank" title="https://platform.iflow.cn/cli/features/ide" ref="nofollow noopener noreferrer">platform.iflow.cn/cli/feature…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd597526f734ed586571f34108f5ec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=4iPFeU2pWopE5I2Eprw8JFUF8Qw%3D" alt="图片" loading="lazy"/></p>
<p>下载到本地后，使用DevEco Studio 离线安装即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aedc321b59ad42a3affe35e848330000~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=3gtcMZS1HYRvMZ333XBQmrLraPQ%3D" alt="图片" loading="lazy"/></p>
<p>安装成功后，重启开发工具，最后顶部菜单栏上也有<strong>iflow的图标</strong>展示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf7ffd6252ca4df5a2dd5d5c1564abba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770007390&amp;x-signature=OZf0PykI4rubkd1IoI8p9gNR%2Fv8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">实用技巧</h2>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/about</code></p>
<p>系统信息</p>
<p>显示CLI版本、操作系统、模型版本等综合信息</p>
<p><code>/auth</code></p>
<p>身份验证</p>
<p>配置或更改身份验证提供商</p>
<p><code>/theme</code></p>
<p>主题设置</p>
<p>自定义CLI外观主题</p>
<p><code>/model</code></p>
<p>模型切换</p>
<p>更改正在使用的AI模型</p>
<p><code>/editor</code></p>
<p>编辑器配置</p>
<p>配置首选的外部编辑器</p>
<p><code>/privacy</code></p>
<p>隐私信息</p>
<p>显示隐私通知和数据处理信息</p>
<p><code>/language</code></p>
<p>语言设置</p>
<p>切换CLI界面语言 (zh-CN/en-US)</p>
<p><code>/output-style</code></p>
<p>输出样式</p>
<p>设置AI输出样式和格式</p>
<p><code>/output-style:new</code></p>
<p>创建输出样式</p>
<p>基于描述创建新的AI输出样式</p>
<p><code>/update</code></p>
<p>软件更新</p>
<p>检查并更新CLI到最新版本</p>
<h3 data-id="heading-10">会话控制命令</h3>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/chat</code></p>
<p>对话管理</p>
<p>保存、恢复、删除对话检查点</p>
<p><code>/clear</code></p>
<p>清屏重置</p>
<p>清除屏幕并重置对话历史</p>
<p><code>/compress</code></p>
<p>内容压缩</p>
<p>使用AI将对话历史压缩为摘要</p>
<p><code>/memory</code></p>
<p>内容管理</p>
<p>与CLI的内容系统交互</p>
<p><code>/restore</code></p>
<p>状态恢复</p>
<p>恢复到之前的检查点状态</p>
<p><code>/resume</code></p>
<p>会话恢复</p>
<p>恢复之前的对话会话</p>
<p><code>/quit</code></p>
<p>退出程序</p>
<p>退出CLI会话并显示统计信息</p>
<p><code>/cleanup-history</code></p>
<p>清理历史</p>
<p>打开清理对话历史记录的对话框</p>
<p><code>/cleanup-checkpoint</code></p>
<p>清理检查点</p>
<p>打开清理对话检查点的对话框</p>
<h3 data-id="heading-11">工具集成命令</h3>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/ide</code></p>
<p>IDE集成</p>
<p>发现和连接到可用的IDE服务器</p>
<p><code>/mcp</code></p>
<p>MCP管理</p>
<p>管理MCP服务器、工具和身份验证</p>
<p><code>/tools</code></p>
<p>工具列表</p>
<p>列出所有可用的内置CLI工具</p>
<p><code>/extensions</code></p>
<p>扩展管理</p>
<p>显示当前活动的扩展及版本</p>
<h3 data-id="heading-12">开发辅助命令</h3>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/init</code></p>
<p>项目初始化</p>
<p>分析项目并创建定制的配置文件</p>
<p><code>/setup-github</code></p>
<p>GitHub配置</p>
<p>配置GitHub Actions工作流</p>
<p><code>/directory</code></p>
<p>目录管理</p>
<p>管理工作空间目录以获得项目上下文</p>
<p><code>/export</code></p>
<p>导出功能</p>
<p>以各种格式导出对话历史</p>
<p><code>/copy</code></p>
<p>复制功能</p>
<p>将最后的AI响应复制到剪贴板</p>
<p><code>/demo</code></p>
<p>演示模式</p>
<p>启动交互式演示和教程模式</p>
<p><code>/qa</code></p>
<p>问答助手</p>
<p>基于知识库的智能问答助手 (别名: /wenwen, /question, /guide)</p>
<h3 data-id="heading-13">监控调试命令</h3>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/stats</code></p>
<p>统计信息</p>
<p>监控会话使用情况和性能统计</p>
<p><code>/log</code></p>
<p>日志位置</p>
<p>显示当前会话日志存储位置</p>
<p><code>/bug</code></p>
<p>错误报告</p>
<p>提交带有系统信息的错误报告</p>
<p><code>/help</code></p>
<p>帮助信息</p>
<p>打开综合帮助对话框</p>
<p><code>/docs</code></p>
<p>文档访问</p>
<p>在浏览器中打开完整文档</p>
<h3 data-id="heading-14">特殊功能命令</h3>
<p>命令</p>
<p>功能</p>
<p>说明</p>
<p><code>/vim</code></p>
<p>Vim模式</p>
<p>切换vim风格按键绑定</p>
<p><code>/corgi</code></p>
<p>特殊主题</p>
<p>切换柯基主题UI模式（彩蛋）</p>
<p><code>/commands</code></p>
<p>命令市场</p>
<p>管理和安装自定义命令</p>
<p><code>/agents</code></p>
<p>代理管理</p>
<p>管理个人、项目和内置代理</p>
<p><code>/terminal-setup</code></p>
<p>终端设置</p>
<p>配置终端键绑定以支持多行输入</p>
<h3 data-id="heading-15">常见使用场景</h3>
<h4 data-id="heading-16">系统配置</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/about                      <span class="hljs-comment"># 查看系统信息</span>
/auth                       <span class="hljs-comment"># 配置身份验证</span>
/model                      <span class="hljs-comment"># 切换AI模型</span>
/theme                      <span class="hljs-comment"># 更改主题</span>
</code></pre>
<h4 data-id="heading-17">会话管理</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/chat list                  <span class="hljs-comment"># 列出所有保存的对话</span>
/chat save project-review   <span class="hljs-comment"># 保存对话检查点</span>
/chat resume project-review <span class="hljs-comment"># 恢复指定的对话</span>
/chat delete project-review <span class="hljs-comment"># 删除指定的对话</span>
/memory show                <span class="hljs-comment"># 显示当前记忆内容</span>
/memory add <span class="hljs-string">"项目使用React"</span> <span class="hljs-comment"># 添加记忆信息</span>
/memory refresh             <span class="hljs-comment"># 刷新记忆内容</span>
/memory list                <span class="hljs-comment"># 列出记忆文件列表</span>
/compress                   <span class="hljs-comment"># 压缩对话历史</span>
/clear                      <span class="hljs-comment"># 清空会话</span>
/resume                     <span class="hljs-comment"># 恢复之前的会话</span>
</code></pre>
<h4 data-id="heading-18">开发辅助</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/init                       <span class="hljs-comment"># 初始化项目配置</span>
/ide                        <span class="hljs-comment"># 连接IDE</span>
/mcp list                   <span class="hljs-comment"># 列出所有MCP服务器</span>
/mcp auth &lt;server&gt;          <span class="hljs-comment"># 配置MCP服务器身份验证</span>
/mcp online                 <span class="hljs-comment"># 浏览在线MCP服务器</span>
/mcp refresh                <span class="hljs-comment"># 刷新MCP服务器连接</span>
/directory add &lt;path&gt;       <span class="hljs-comment"># 添加工作空间目录</span>
/directory show             <span class="hljs-comment"># 显示当前工作空间目录</span>
/export clipboard           <span class="hljs-comment"># 导出对话到剪贴板</span>
/export file                <span class="hljs-comment"># 导出对话到文件</span>
</code></pre>
<h4 data-id="heading-19">调试支持</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/stats                      <span class="hljs-comment"># 查看会话统计</span>
/stats model                <span class="hljs-comment"># 查看模型使用统计</span>
/stats tools                <span class="hljs-comment"># 查看工具使用统计</span>
/log                        <span class="hljs-comment"># 查看日志位置</span>
/bug <span class="hljs-string">"描述问题"</span>             <span class="hljs-comment"># 提交错误报告</span>
/help                       <span class="hljs-comment"># 获取帮助</span>
</code></pre>
<h4 data-id="heading-20">系统和界面配置</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/language zh-CN            <span class="hljs-comment"># 切换到中文界面</span>
/language en-US            <span class="hljs-comment"># 切换到英文界面</span>
/output-style professional <span class="hljs-comment"># 使用专业输出样式</span>
/output-style:new <span class="hljs-string">"简洁风格"</span> <span class="hljs-comment"># 创建新的输出样式</span>
/update                    <span class="hljs-comment"># 检查并更新CLI版本</span>
</code></pre>
<h4 data-id="heading-21">对话和历史管理</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">/cleanup-history            <span class="hljs-comment"># 清理对话历史记录</span>
/cleanup-checkpoint         <span class="hljs-comment"># 清理对话检查点</span>
/demo                       <span class="hljs-comment"># 启动演示模式</span>
/qa <span class="hljs-string">"如何使用MCP?"</span>          <span class="hljs-comment"># 基于知识库的问答</span>
/agents list                <span class="hljs-comment"># 列出所有可用的代理</span>
/agents refresh             <span class="hljs-comment"># 刷新代理列表</span>
/agents online              <span class="hljs-comment"># 浏览在线代理市场</span>
/agents install             <span class="hljs-comment"># 安装代理</span>
/commands list              <span class="hljs-comment"># 列出本地自定义命令</span>
/commands online            <span class="hljs-comment"># 浏览在线命令市场</span>
/commands get &lt;<span class="hljs-built_in">id</span>&gt;          <span class="hljs-comment"># 获取指定ID的命令</span>
/terminal-setup             <span class="hljs-comment"># 配置终端以支持多行输入</span>
</code></pre>
<p><strong>关注我</strong>，持续分享鸿蒙开发 + AI 提效的实战技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TN3187：迁移至基于 UIKit 场景的生命周期]]></title>    <link>https://juejin.cn/post/7598710324168605711</link>    <guid>https://juejin.cn/post/7598710324168605711</guid>    <pubDate>2026-01-26T02:48:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598710324168605711" data-draft-id="7598734303175262260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TN3187：迁移至基于 UIKit 场景的生命周期"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-26T02:48:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Meicy"/> <meta itemprop="url" content="https://juejin.cn/user/3562073407095597"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TN3187：迁移至基于 UIKit 场景的生命周期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073407095597/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Meicy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T02:48:31.000Z" title="Mon Jan 26 2026 02:48:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">概述</h3>
<p>许多较旧的 iOS 应用使用一个 UIApplicationDelegate 对象作为其应用的主要入口点，并管理应用的生命周期。使用场景的应用则不同，它们使用一个 UISceneDelegate 对象来分别管理每个场景窗口。从基于 UIApplicationDelegate 的应用生命周期迁移到基于场景的生命周期，可以让你的应用支持多窗口等现代功能。本文档阐述了如何将应用迁移到基于场景的生命周期。</p>
<h3 data-id="heading-1">迁移路径</h3>
<p>将应用迁移到基于场景的生命周期有两种路径：</p>
<ul>
<li>分阶段迁移：应用在继续使用 UIApplicationDelegate 的同时，逐步采用 UISceneDelegate。</li>
<li>直接迁移：应用一次性直接迁移到 UISceneDelegate。</li>
</ul>
<p>在分阶段迁移中，你可以在应用的不同部分逐步实现场景支持，而应用的其余部分继续通过现有的 UIApplicationDelegate 进行管理。这种方式对于大型应用或者需要逐步验证场景兼容性的团队很有用。然而，分阶段迁移会增加临时复杂性，并且应用在完全迁移之前无法使用多窗口等需要完全基于场景生命周期的功能。</p>
<p>直接迁移意味着一次性将整个应用切换到 UISceneDelegate。对于尚未使用 UIApplicationDelegate 管理界面的新应用，或者那些规模较小、易于整体更新的现有应用，推荐采用这种方式。直接迁移可以更快地启用多窗口等现代功能，并简化代码库。</p>
<h3 data-id="heading-2">如何判断应用是否使用了场景？</h3>
<p>如果你的应用使用了场景，其 Info.plist 文件中会包含一个 UIApplicationSceneManifest 字典。当系统在 Info.plist 中检测到此字典时，它会使用基于场景的生命周期来启动你的应用。对于直接迁移，你需要添加此清单。对于分阶段迁移，你将在准备好启用场景时添加它。</p>
<hr/>
<h3 data-id="heading-3">分阶段迁移</h3>
<p>分阶段迁移允许你逐步采用 UISceneDelegate。在这种方法下，应用将继续使用 UIApplicationDelegate 作为主要入口点，但你可以为某些界面逐步引入场景支持。当你想为应用的特定部分启用多窗口等功能，同时保持其他部分的原有行为时，这种方式很有用。</p>
<p>要进行分阶段迁移，你需要：</p>
<ol>
<li>创建一个实现 UIWindowSceneDelegate 协议的新类。</li>
<li>在 UIApplicationDelegate 中实现 application(_:configurationForConnecting:options:) 方法，为特定会话返回一个 UISceneConfiguration 实例。此配置告诉系统为连接的场景会话使用哪个场景代理类。</li>
<li>在应用的 Info.plist 中配置 UIApplicationSceneManifest 字典，并为场景配置指定你的场景代理类名。</li>
</ol>
<p>当系统请求新场景时，它会调用 UIApplicationDelegate 的 application(_:configurationForConnecting:options:) 方法。你可以检查连接选项（例如 UIApplication.OpenURLOptions 或 UIApplication.ActivityOptions）来决定返回哪种场景配置。这允许你根据用户的操作（例如点击 URL 或进行拖放操作）来创建不同类型的场景。</p>
<p>分阶段迁移期间，UIApplicationDelegate 仍然负责管理应用级事件（例如应用启动和进入后台），而 UISceneDelegate 则管理特定场景的生命周期事件（例如场景激活或失活）。这种分离使得你可以逐步将界面管理从 UIApplicationDelegate 转移到 UISceneDelegate。</p>
<h3 data-id="heading-4">直接迁移</h3>
<p>直接迁移涉及一次性将整个应用从 UIApplicationDelegate 迁移到 UISceneDelegate。这种方式适用于新应用，或者那些愿意为启用多窗口等现代功能而进行全面更新的现有应用。</p>
<p>要直接迁移，你需要：</p>
<ol>
<li>将应用生命周期管理从 UIApplicationDelegate 移动到 UISceneDelegate。这包括将代码从 application(<em>:didFinishLaunchingWithOptions:) 移动到 scene(</em>:willConnectTo:options:)，以及将其他生命周期方法（例如 applicationWillResignActive 和 applicationDidBecomeActive）迁移到对应的场景代理方法（例如 sceneWillResignActive 和 sceneDidBecomeActive）。</li>
<li>移除 UIApplicationDelegate 中与窗口管理相关的代码，因为每个场景现在都会管理自己的 UIWindow。</li>
<li>在 Info.plist 中添加 UIApplicationSceneManifest 字典，并配置默认的场景配置，指定你的 UISceneDelegate 类。</li>
</ol>
<p>直接迁移后，应用的每个窗口都由一个独立的 UIScene 实例管理，UISceneDelegate 负责该场景的生命周期。这为每个窗口提供了更好的隔离，并启用了多窗口支持。</p>
<hr/>
<h3 data-id="heading-5">通用迁移步骤</h3>
<p>无论选择分阶段迁移还是直接迁移，都需要遵循一些通用步骤：</p>
<h4 data-id="heading-6">1. 创建场景代理类</h4>
<p>创建一个实现 UIWindowSceneDelegate 协议的新类。这个类将管理特定场景的生命周期。你可以在其中创建窗口、设置根视图控制器，并响应场景生命周期事件。</p>
<h4 data-id="heading-7">2. 配置 Info.plist</h4>
<p>在 Info.plist 中添加一个 UIApplicationSceneManifest 字典。此字典告诉系统你的应用支持场景。它包含一个 UISceneConfigurations 字典，你可以在其中定义应用支持的不同场景配置。每个配置指定了场景代理类名和故事板名称（如果使用的话）。</p>
<p><code>&lt;key&gt;UIApplicationSceneManifest&lt;/key&gt;  &lt;dict&gt;  &lt;key&gt;UIApplicationSupportsMultipleScenes&lt;/key&gt;  &lt;true/&gt; &lt;key&gt;UISceneConfigurations&lt;/key&gt;  &lt;dict&gt;  &lt;key&gt;UIWindowSceneSessionRoleApplication&lt;/key&gt; &lt;array&gt;  &lt;dict&gt;  &lt;key&gt;UISceneConfigurationName&lt;/key&gt;  &lt;string&gt;Default Configuration&lt;/string&gt;  &lt;key&gt;UISceneDelegateClassName&lt;/key&gt;  &lt;string&gt;$(PRODUCT_MODULE_NAME).SceneDelegate&lt;/string&gt;  &lt;key&gt;UISceneStoryboardFile&lt;/key&gt;  &lt;string&gt;Main&lt;/string&gt;  &lt;/dict&gt;  &lt;/array&gt;  &lt;/dict&gt;  &lt;/dict&gt;</code></p>
<h4 data-id="heading-8">3. 更新应用代理</h4>
<p>对于直接迁移，移除 UIApplicationDelegate 中与窗口管理相关的代码，并将应用生命周期事件的处理移动到场景代理中。对于分阶段迁移，在 UIApplicationDelegate 中实现 application(_:configurationForConnecting:options:) 方法来返回适当的场景配置。</p>
<h4 data-id="heading-9">4. 更新生命周期事件处理</h4>
<p>将应用级生命周期事件的处理迁移到相应的场景级事件。例如：</p>
<ul>
<li>application(<em>:didFinishLaunchingWithOptions:) 迁移到 scene(</em>:willConnectTo:options:)</li>
<li>applicationWillResignActive 迁移到 sceneWillResignActive</li>
<li>applicationDidBecomeActive 迁移到 sceneDidBecomeActive</li>
<li>等等...</li>
</ul>
<h4 data-id="heading-10">5. 测试</h4>
<p>在支持场景的设备（例如 iPad）上彻底测试你的应用。验证场景是否正确创建、生命周期事件是否正常触发，以及多窗口等功能是否按预期工作。对于分阶段迁移，确保现有功能在启用场景的部分和未启用的部分都能正常工作。</p>
<h3 data-id="heading-11">场景与后台任务</h3>
<p>当使用基于场景的生命周期时，后台任务的处理方式有所不同。在基于 UIApplicationDelegate 的应用中，后台任务通常在应用级别管理。而在基于场景的应用中，后台任务可以与特定场景关联。</p>
<p>如果你的应用使用 UIApplication.beginBackgroundTask(withName:expirationHandler:) 来管理长时间运行的任务，在迁移到场景后，你可能需要考虑使用每个场景的后台任务管理。然而，UIApplication 级别的后台任务 API 在基于场景的应用中仍然可用，并且可以在应用级别的任务中使用。</p>
<p>对于直接与特定场景关联的任务（例如，该场景正在进行的网络请求），考虑使用与该场景关联的后台任务。这有助于系统更有效地管理资源，并在场景关闭时提供更清晰的任务清理机制。</p>
<hr/>
<h3 data-id="heading-12">结论</h3>
<p>迁移到基于 UIKit 场景的生命周期可以使你的应用支持多窗口等现代 iOS 功能。无论选择分阶段迁移还是直接迁移，关键步骤都是创建一个 UISceneDelegate 类，配置 Info.plist，并将生命周期事件处理从 UIApplicationDelegate 移动到 UISceneDelegate。迁移后，每个窗口将由独立的场景管理，从而提高模块化并为用户提供更强大的多任务处理体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[YOLO26、RF-DETR、D-FINE… 2026模型混战，工程师选择困难症怎么破？]]></title>    <link>https://juejin.cn/post/7598734303175147572</link>    <guid>https://juejin.cn/post/7598734303175147572</guid>    <pubDate>2026-01-26T02:37:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598734303175147572" data-draft-id="7598836674629681186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="YOLO26、RF-DETR、D-FINE… 2026模型混战，工程师选择困难症怎么破？"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-26T02:37:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            YOLO26、RF-DETR、D-FINE… 2026模型混战，工程师选择困难症怎么破？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T02:37:15.000Z" title="Mon Jan 26 2026 02:37:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>YOLO26的亮相，与其说是一次升级，不如说是一声宣言：那个拼参数、卷规模的时代，正在悄悄退场。现在轮到“小身材、大智慧、拎包入住”的模型登场了。但有趣的是，擂台另一边也热闹得很——2024到2025年间，几位风格迥异的选手已接连登场：RF-DETR、LW-DETR、D-FINE这些“非YOLO系”的选手，正凭着一技之长迅速逼近，甚至在有些赛道上完成了超车。再加上YOLO家族内部自我革新的YOLO11，眼下这个局面，倒让不少工程师犯了选择困难症。</p>
<blockquote>
<p><strong>YOLO26还香不香？工业场景到底该押注谁？</strong></p>
</blockquote>
<p>我们不如把这几位移到一个真实的车间里，看看它们各自的手艺如何。</p>
<h2 data-id="heading-0"><strong>这是 5 条完全不同的技术路线</strong></h2>
<p>在对比性能之前，必须先明确一件事：这 5 个模型，解决问题的思路本质不同。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abafa53c65a94fc8956e4f517cd1909e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=vpobHvQ44awiauGjzCt9RnraiCQ%3D" alt="screenshot_2026-01-23_13-52-20.png" loading="lazy"/></p>
<p>也正因为路线不同，它们的<strong>性能优势场景</strong>完全不一样。</p>
<h2 data-id="heading-1"><strong>YOLO26：最新的“工业模型</strong> <strong>”</strong></h2>
<p>该怎么形容YOLO26呢？它不像从论文里走出来的，更像从生产线上长出来的。</p>
<p>它的改变很务实：结构变得更干净、更模块化，剪掉了那些枝枝蔓蔓。这么做的好处显而易见，调试起来心里有底，部署起来也少折腾。它没有跟风去堆砌庞大的注意力机制，反而聚焦在 <strong>“如何更有效地利用特征”</strong> 上——局部感知搭配轻量级的注意力，在工业常见的缺陷检测、规则物体识别上，表现得出奇稳定。</p>
<p>当然，它的老本行依然扎实：推理速度、对TensorRT和ONNX的友好度，以及在边缘设备上那份从容。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fa41a74cfda4790a4c8804cd2822401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=vpJHwV9DqqtoXDYsSnqLK%2FfqMhI%3D" alt="Ultralytics-YOLO26-Benchmark.jpg" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>YOLO11：家族里的“革新者”与“普及者”</strong></h2>
<p>很多人误以为YOLO11是YOLO26的简版或前身，其实不然。尤其在网络结构重组上花了大力气，对Neck部分动了不小的手术。有意思的是，它证明了 <strong>“更小”也能“更强”</strong> ——比如YOLO11-M版本，参数比v8减少了超过五分之一，精度却不降反升。</p>
<p>论文指标上，它的表现可圈可点。广泛的硬件兼容性，让它从边缘设备到云端GPU都能快速适配。但据一些工程师反馈，一旦放到真实的工业环境里，面对那些不可避免的噪声、数据偏移，它的稳定性似乎就逊色了半分。所以不妨这么看：YOLO11探索并证明了结构优化的潜力，而YOLO26则在此基础上，把“稳”字诀打磨得更透彻。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57d33489eb8d4a9d861921f1573c52e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=F2MKRECGVmlaToyqkLPdCm83WXs%3D" alt="280f752fa8984fa98bacf4840c20d3dd.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>Transformer阵营的“务实派”</strong></h2>
<p>先说说<strong>LW-DETR</strong>。思路很清晰：把Vision Transformer（ViT）的特征提取能力，与DETR的高效检测框架融合起来。通过图像分块和多尺度特征融合，它在当时实现了精度与速度对YOLO11的双重超越。可以说，它是Transformer阵营向效率做出的第一次醒目妥协，试图在保持架构优雅的同时，也能跑得快一些。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97f93b58261643018cec292fe8198f21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=RqSNdDhucPOj6CUtFbLWqjI5Uw0%3D" alt="92c834252e71421eabac20e66f840f5a.png" loading="lazy"/></p>
<p>而<strong>RF-DETR</strong>，它终于大规模解决了传统DETR“训练难、收敛慢、部署重”的痼疾。通过特征重排和降低对Query的依赖，它在复杂场景和多类别检测上，效果确实亮眼。更引人注目的是，它直接打包了分割、分类和检测三大任务能力，并且在跨领域泛化测试中表现突出。模型本身也足够紧凑，支持边缘部署。但务实地说，它的训练成本和算力胃口依然比YOLO系大，更像是一位能力全面但身价也更高的“特种兵”。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5c5fcfd3f54402b455e575d9bd0cb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=TVV0%2FVZzfu2DoXUYFJhE3iIvgnY%3D" alt="screenshot_2026-01-23_14-58-59.png" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>D-FINE：曲高和寡的“精度艺术家”</strong></h2>
<p>如果只看学术榜单，2024年发布的D-FINE的成绩单足以让人心动。它引入了一个叫“细粒度分布细化”的机制，像是对边界框概率分布进行精雕细琢的迭代，所以在小目标、密集重叠目标检测上优势明显。模型本身也很轻快，响应迅速，听起来简直是导航、决策等实时场景的完美人选。</p>
<p>但问题恰恰在于，理想的实验室数据集，在工厂里几乎是奢侈品。实际应用中，标注的噪声、波动的推理延迟、复杂的部署链条，都很容易让它“水土不服”。它是一位挑剔的、追求极致精度的艺术家，需要完美的舞台，而嘈杂的工业现场，往往给不了这份完美。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/010bd90491e94298b714f5d63f08171a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=9L83XTc6CDBKe2jXuCr%2Bdnlbwe8%3D" alt="fdr-1.jpg" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>模型检测性能对照表（基于 COCO 数据集）</strong></h2>
<ul>
<li><strong>mAP50:95</strong>— COCO 综合平均精度指标（50-95 IoU），常用来衡量检测质量。</li>
<li><strong>推理延迟（ms/img）</strong>  — 推理延迟（TensorRT FP16 on NVIDIA T4 约束）。</li>
<li><strong>参数量</strong> — 模型参数规模（百万），影响存储和部署成本。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f2b1e7b4fe4cc4a966608bcd3310e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=kh6UXyqs%2BWGFLAOzDVT7fQ%2F1B%2Fc%3D" alt="screenshot_2026-01-23_14-20-47.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>最高精度：</strong> 模型精度 top3 出现在 YOLO26x (~57.5%)、D-FINE-Medium (~55.1%)、YOLO26l (~55.0%)。</p>
<p>其中 YOLO26x 在精度上有优势，同时依旧保持相对可控的延迟。</p>
</li>
</ul>

<ul>
<li>
<p><strong>最佳效率选择：</strong> LW-DETR-Tiny 和 YOLO26n 延迟极低（&lt;2ms），适合极限实时场景。</p>
<p>RF-DETR-Nano 在 latency 与精度平衡上表现优秀（48.4% mAP / ~2.3ms）。</p>
</li>
</ul>

<ul>
<li>
<p>**参数规模：**YOLO 系列（尤其 n/s 规模）通常参数更少（轻量级），便于边缘部署。</p>
<p>Transformer 核心模型（如 RF-DETR）尽管参数更大，但在泛化能力上具有潜力。</p>
</li>
</ul>
<h2 data-id="heading-6"><strong>总结</strong></h2>
<p>说到底，工厂的考卷上只有三道题：<strong>能不能稳定地跑起来？能不能控制住成本？能不能大规模铺开？</strong></p>
<p>相较于YOLO11在稳定性上偶尔的波动，或是RF-DETR们对算力环境更高的要求，YOLO26所追求的，正是一种“更低延迟、更广支持、不妥协精度”的实用主义哲学。</p>
<p>这不意味着其他模型没有价值，恰恰相反，正是YOLO11们的探索、RF-DETR们的突破，共同推动着整个领域向前。但在2026年这个节点，当计算机视觉技术疯狂涌入千行百业，那些需要真正落地、创造价值的场景，或许更需要一个像YOLO26这样懂得“过日子”的伙伴。它可能不会是最常出现在论文标题里的那个明星，但很有机会，成为生产线和终端设备里，那个沉默却不可或缺的基石。</p>
<p><strong>理论分析的终点，正是工程实践的起点。</strong>  以上所有模型的理论对比、性能数据，最终都需要在你自己的数据集和部署环境中进行验证。这正是 <strong>Coovally</strong> 这样的平台可以大显身手的地方。它为你提供了一个从算法到落地的一站式工具箱：</p>
<ul>
<li><strong>快速验证：</strong> 无需复杂环境配置，即可在平台上获取、导入并快速测试上述各系列模型，用你的真实数据验证它们的表现，将理论数据转化为实际决策依据。</li>
<li><strong>高效训练与调优：</strong> 无论是YOLO系列的工程化改进，还是Transformer模型的复杂调参，平台内置的自动化流程和资源管理都能大幅降低实验成本，助你找到最适合当前场景的“最优解”。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8946aaffeaa4d70add9161f8aab4cba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=g1%2FLw7Hpoh1eTD5NLIBJ4vh%2F368%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7fca2c045e4a4ea49fefee64bdce93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999835&amp;x-signature=uN3%2FjXxiCDx%2BDlUszQ58PHiJP4U%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<p>所以，如果你正在操盘工业视觉、巡检监控或缺陷检测这类项目，我的建议可能会有点保守：先从YOLO26开始，把流程跑通、场景吃透。等到确有余力时，再去斟酌，是否需要那一点额外的“折腾”来换取边际上的提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别混乱：Agent Skills 实战指南]]></title>    <link>https://juejin.cn/post/7598921649888854043</link>    <guid>https://juejin.cn/post/7598921649888854043</guid>    <pubDate>2026-01-25T16:33:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598921649888854043" data-draft-id="7599094262591913994" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别混乱：Agent Skills 实战指南"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-25T16:33:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米一多"/> <meta itemprop="url" content="https://juejin.cn/user/3825956198025239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别混乱：Agent Skills 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956198025239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米一多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T16:33:22.000Z" title="Sun Jan 25 2026 16:33:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾被 Agent 的“不听话”、“执行乱”和“工具荒”搞得焦头烂额？你是否也经历过或者正在经历这样的“ Agent 调教”崩溃时刻：规则失效，在 Agent.md 里写下千言万语，Agent 却视若无睹；执行失控，精心打磨了无数 Prompt，执行起来依旧像无头苍蝇；工具迷失，明明集成了强大的 MCP 工具库，Agent 却两手一摊说“没工具”。</p>
<p>如果这些场景让你感同身受，别急着放弃。终结这场混乱的答案，可能就是 Skills。</p>
<h3 data-id="heading-0">核心亮点：从“聊天机器人”到“得力干将”的进化</h3>
<p>Agent 正在经历一场进化，而 Skills 正是关键催化剂。本文将带你一文弄懂 Skills ——这个让 Agent 变得可靠、可控、可复用的“高级技能包”。无论你是开发者还是普通用户，都能在这里找到让你的 Agent “开窍”的秘诀。</p>
<p>如果你想更高效地体验顶级模型的能力，推荐试试 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnunu.chat%2F" target="_blank" title="https://nunu.chat/" ref="nofollow noopener noreferrer">nunu.chat</a>，这是一个多模型聚合的 AI chat 平台，支持国内直连访问海外顶级大模型，还有大量免费额度供你调试自己的 Skills。</p>
<h3 data-id="heading-1">什么是 Skills？</h3>
<p>“Skills” 这个概念最早由 Anthropic 公司提出，作为其大模型 Claude 的一种能力扩展机制。简单来说，它允许用户为 Claude 添加自定义的功能和工具。随着这套做法越来越成熟，并被社区广泛接受，Skills 如今已成为大多数 Agent 开发工具和 IDE 都支持的一种标准扩展规范。</p>
<p>一个 Skills 通常以一个文件夹的形式存在，里面主要装着三样东西：一份说明书（SKILL.md）、一堆操作脚本（Script）、以及一些参考资料（Reference）。你可以把一个 Skill 想象成一个打包好的“技能包”。它把完成某个特定任务所需的领域知识、操作流程、要用到的工具、以及最佳实践全都封装在了一起。</p>
<p><img src="https://pic-out.zhimg.com/v2-7cc6d1e7917f64645790e06240112071~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769358655-0-0-3c95a9c19a34c7a8c68bb0736e4c6381&amp;bizSceneCode=article_draft&amp;expiration=1769358655&amp;incremental=false&amp;mid=6c28d1233b683a4d5e58b0046d609ef1&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>当 AI 面对相应请求时，就能像一位经验丰富的专家那样，有条不紊地自主执行。</p>
<h3 data-id="heading-2">Skill 原理介绍：渐进式加载</h3>
<p>📚 官方解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<p>Skill 的架构原理在于其巧妙的三层分级加载机制，运行在一个允许访问文件系统和执行 bash 命令的沙盒环境里：</p>
<p><img src="https://pic-out.zhimg.com/v2-0244bf9063fd7fc381d5152f1133b96f~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769358655-0-0-c508a09bb21ad4eaf68a25711f635213&amp;bizSceneCode=article_draft&amp;expiration=1769358655&amp;incremental=false&amp;mid=6c28d1233b683a4d5e58b0046d609ef1&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<ul>
<li><strong>Level 1：元数据（始终加载）</strong>：就像“名片”，包含名称和描述。Claude 启动时会加载所有元数据，因为它很轻量，不会占满上下文。</li>
<li><strong>Level 2：说明文档（触发时加载）</strong>：SKILL.md 文件的正文。只有用户请求与描述相符时，才会读取并加载到上下文，节省 Token。</li>
<li><strong>Level 3：资源与代码（按需加载）</strong>：包括 FORMS.md、Python 脚本或 API 文档。脚本代码本身不进入上下文，几乎不增加额外成本。</li>
</ul>
<p><strong>Skills 的调用逻辑：</strong> 1. <strong>意图匹配</strong>：Agent 扫一眼“名片夹”（元数据），寻找最匹配的一张。 2. <strong>读取手册</strong>：翻开“操作手册”（SKILL.md），研究执行步骤。 3. <strong>按需执行</strong>：从“工具箱”拿出脚本或工具干活。 4. <strong>反馈结果</strong>：汇报结果或请教困难。</p>
<p><img src="https://pic-out.zhimg.com/v2-b1cfd05afa9368ee034884f1bf107ca9~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769358655-0-0-28e554a75f86a9c6b8a9e6f9699a8906&amp;bizSceneCode=article_draft&amp;expiration=1769358655&amp;incremental=false&amp;mid=6c28d1233b683a4d5e58b0046d609ef1&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Skills vs. 其他概念的区别</h3>
<p>为了更清晰地理解，我们把它和快捷指令（Command）和原子工具（MCP）做对比。用一个厨房的例子就很好懂了。</p>
<p><img src="https://pic-out.zhimg.com/v2-8de84d44f3536f4eb746dce9ffafbb64~resize:1440:q75.png?animatedImageAutoPlay=false&amp;animatedImagePlayCount=1&amp;auth_key=1769358655-0-0-8bc2997325c1523021ff073b387b5a7a&amp;bizSceneCode=article_draft&amp;expiration=1769358655&amp;incremental=false&amp;mid=6c28d1233b683a4d5e58b0046d609ef1&amp;overTime=60&amp;precoder=false&amp;protocol=v2&amp;retryCount=3&amp;sampling=false&amp;sceneCode=editor_copy_outbound&amp;source=bfcaadb1" alt="" loading="lazy"/></p>
<p>📚 官方博客解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></p>
<h3 data-id="heading-4">如何写好一个好的 Skills</h3>
<p>从“能用”到“好用”，需要遵循以下原则： * <strong>原子性（Atomicity）</strong>：坚持单一职责，专注于解决一个具体问题。 * <strong>给例子（Few-Shot Prompting）</strong>：直接给出清晰的输入输出示例，这是最关键的一点。 * <strong>立规矩（Structured Instructions）</strong>：1) 定角色；2) 拆步骤；3) 画红线（明确不能做什么）。 * <strong>造接口（Interface Design）</strong>：明确定义输入参数和输出格式（如 JSON）。 * <strong>勤复盘（Iterative Refinement）</strong>：把 Bad Case 变成新的规则或反例。</p>
<p>📚 官方最佳实践指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
<h3 data-id="heading-5">社区资源与实战：在 TRAE 中落地</h3>
<p><strong>社区热门 Skills 推荐：</strong> 📚 官方 Skills 仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25E3%2580%2582%25E5%25AD%25A6%25E4%25B9%25A0%25E5%25AE%2598%25E6%2596%25B9%25E4%25BB%2593%25E5%25BA%2593%25E5%258F%25AF%25E4%25BB%25A5%25E6%259C%2580%25E5%25BF%25AB%25E4%25BA%2586%25E8%25A7%25A3%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%25E3%2580%2582" target="_blank" title="https://github.com/anthropics/skills%E3%80%82%E5%AD%A6%E4%B9%A0%E5%AE%98%E6%96%B9%E4%BB%93%E5%BA%93%E5%8F%AF%E4%BB%A5%E6%9C%80%E5%BF%AB%E4%BA%86%E8%A7%A3%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E3%80%82" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><strong>如何在 TRAE 里快速使用：</strong> 1. <strong>方式一：设置中直接创建</strong>。Cmd +/ Ctrl + 打开设置，找到「规则技能」，点击「创建」，填入名称、描述和主体。 2. <strong>方式二：直接解析 SKILL.md</strong>。在项目目录下新增 <code>.trae/Skills/xxx</code> 文件夹。 3. <strong>方式三：在对话中创建</strong>。利用内置的 Skills-creator 直接要求 TRAE 创建。</p>
<p><strong>使用方法</strong>：加载后，在对话框输入“帮我设计一个有科技感的登录页面”或“帮我提取 PDF 表格”，系统会自动调用相应技能。</p>
<h3 data-id="heading-6">实践场景举例：基于飞书文档的 Spec Coding</h3>
<p>针对引言中提到的规则失效问题，我们可以将复杂场景拆分成独立技能。 <strong>什么是 Spec Coding？</strong> 提倡“先思考后行动”，通过定义需求规范（Specification）推动开发。 <strong>场景分析</strong>：我们需要“多角色专家 Skills”（需求分析、技术设计、任务拆解）和“飞书文档使用 Skill”（教会 Agent 飞书语法和协作逻辑），最后通过“Spec Coding Skill”统筹全局，完成工具与角色的组合调度。</p>
<h3 data-id="heading-7">Q &amp; A | 一些常见问题</h3>
<ul>
<li><strong>为什么不生效？</strong> 十有八九是“名片”（Description）没写好，Agent 无法判断何时该用它。</li>
<li><strong>受 LLM 影响吗？</strong> 有。强模型擅长“挑选和策略”，而 Skill 决定了执行的“最低水平和稳定性”。</li>
<li><strong>是万能的吗？</strong> 不是。它不擅长高度创造力、实时动态决策或简单的知识问答。</li>
<li><strong>可以修改社区 Skill 吗？</strong> 强烈建议 Fork 并二次开发。</li>
</ul>
<h3 data-id="heading-8">总结与结语</h3>
<p>Skill 的出现解决了 Agent 规则失效、执行失控的问题。其核心价值在于：精准解决痛点（三级加载平衡效率与深度）以及生态赋能。它让 AI 从“样样懂一点”的通才，进化为“事事做得好”的专家协作伙伴。</p>
<p>不妨从今天开始，尝试将你最擅长的领域经验封装成可复用的 Skill，让 AI 成为你延伸专业价值的放大器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[更新迭代 - 3] Nestjs 在25年底更新了啥？（bug修复篇+功能增强篇）]]></title>    <link>https://juejin.cn/post/7598744870996492331</link>    <guid>https://juejin.cn/post/7598744870996492331</guid>    <pubDate>2026-01-26T02:39:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598744870996492331" data-draft-id="7584722109584064555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[更新迭代 - 3] Nestjs 在25年底更新了啥？（bug修复篇+功能增强篇）"/> <meta itemprop="keywords" content="后端,Node.js,NestJS"/> <meta itemprop="datePublished" content="2026-01-26T02:39:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joney_SLi"/> <meta itemprop="url" content="https://juejin.cn/user/870468942308733"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [更新迭代 - 3] Nestjs 在25年底更新了啥？（bug修复篇+功能增强篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468942308733/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joney_SLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T02:39:35.000Z" title="Mon Jan 26 2026 02:39:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好我是Joney , 本文梳理了从25年1月份到 25年底的所有官方更新内容, 主要涵盖了Nestjs的各种bug修复Issues</p>
</blockquote>
<h2 data-id="heading-0">release一览</h2>
<blockquote>
<p>以下统计是简单粗略的统计，后续文章会改进此方法。数据上可能不是100%准确</p>
</blockquote>
<p>Nest 从 25年1月开发的第一次 release v11.0.0 直到年底 v11.1.11  一共发布了31个release （今年的更新非常的频繁）</p>
<p>这些不断地release和仓库迭代， 看得出作者和开发社区还是很用心的，至少是一个值得信赖的项目，不像其它项目做完KPI就跑路， 蛐蛐一下国内的大厂哈（表情-狗头保命），是 开源是很重要，但是持续维护才能让开发者信任。</p>
<p>总结来说，24年 Nest的工作分布如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/731abc19554c441b931dce6b82b72e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9uZXlfU0xp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999974&amp;x-signature=ynC7e%2FW%2B16D55CTodw36VQk3nvA%3D" alt="image.png" loading="lazy"/>
可以看到许多工作是依赖升级迭代支持相关的内容。bug修复和功能升级还是很快的，作为一个 开源项目且拥有74.3k 的Start OpenIssues 只有24 个，可以算是非常优秀了</p>
<p>再看 以月份为维度的分析：可以看到1月份开年的时候 因为大版本升级更新了非常多的内容
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37cce7a9b39842e69bccd89bafec9d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9uZXlfU0xp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999974&amp;x-signature=3ewkclg5g%2FveKsFvVeK%2BmbZ7lKU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">Bug修复项</h3>
<blockquote>
<p>接下来我们分析一下 25年 重要的bug修复</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2f9356ce7344eb3a69159917a060c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9uZXlfU0xp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769999974&amp;x-signature=t%2F4s3KjiZ9j3LkbncULVcSE3Rgw%3D" alt="image.png" loading="lazy"/></p>
<p>后文使用了一些AI汇总的功能，我们要紧跟时代</p>
<h4 data-id="heading-2">🟢 核心框架 (Core / @nestjs/core) - 共 21 个修复</h4>
<p><em>这是 NestJS 的基石。2025 年的修复主要集中在依赖注入系统的边缘情况（如循环依赖、竞态条件）以及中间件和生命周期的执行顺序上。</em></p>
<p><strong>fix(core): infinite loop on broken circular reference</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14803" target="_blank" title="https://github.com/nestjs/nest/pull/14803" ref="nofollow noopener noreferrer">PR #14803</a>
修复了当两个模块通过 <code>forwardRef</code> 相互引用且其中一个在初始化时抛出异常，会导致错误处理逻辑陷入死循环的问题。</p>
<p><strong>fix(core): race condition in class dependency resolution</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15504" target="_blank" title="https://github.com/nestjs/nest/pull/15504" ref="nofollow noopener noreferrer">PR #15504</a>
修复了从导入模块解析类依赖时可能出现的竞态条件，增强了高并发启动时的稳定性。</p>
<p><strong>fix(core): fix race condition in class dependency resolution (Duplicate Scenario)</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15405" target="_blank" title="https://github.com/nestjs/nest/pull/15405" ref="nofollow noopener noreferrer">PR #15405</a>
针对类依赖解析的另一种竞态条件场景进行了修复，防止在特定的异步初始化流程中出现实例重复创建。</p>
<p><strong>fix(core): global module middleware should be executed first</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14495" target="_blank" title="https://github.com/nestjs/nest/pull/14495" ref="nofollow noopener noreferrer">PR #14495</a>
修正了中间件执行顺序，确保全局模块中注册的中间件总是优先于局部模块的中间件执行。</p>
<p><strong>fix(core): make get() throw for implicitly request-scoped trees</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15865" target="_blank" title="https://github.com/nestjs/nest/pull/15865" ref="nofollow noopener noreferrer">PR #15865</a>
现在，如果在静态上下文中尝试使用 <code>get()</code> 获取隐式请求作用域（Request-Scoped）的实例，框架会明确抛出异常，而不是返回未定义行为。</p>
<p><strong>fix(core): instantiate nested transient providers in static context</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16098" target="_blank" title="https://github.com/nestjs/nest/pull/16098" ref="nofollow noopener noreferrer">PR #16098</a>
修复了在静态上下文中嵌套的瞬态（Transient）提供者无法正确实例化的问题。</p>
<p><strong>fix(core): resolve all providers when using resolve() with each option</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16005" target="_blank" title="https://github.com/nestjs/nest/pull/16005" ref="nofollow noopener noreferrer">PR #16005</a>
修复了 <code>resolve()</code> 方法配合 <code>each: true</code> 选项使用时，未能正确解析所有提供者实例的问题。</p>
<p><strong>fix(core): missing catch handler for forward-ref provider resolution</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16133" target="_blank" title="https://github.com/nestjs/nest/pull/16133" ref="nofollow noopener noreferrer">PR #16133</a>
为 <code>forward-ref</code> 提供者的解析过程补充了缺失的异常捕获处理，防止未捕获的 Promise Rejection。</p>
<p><strong>fix(core): ensure nested transient provider isolation</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15815" target="_blank" title="https://github.com/nestjs/nest/pull/15815" ref="nofollow noopener noreferrer">PR #15815</a>
修复了嵌套瞬态提供者的隔离性问题，确保它们在不同的注入链中保持独立。</p>
<p><strong>fix(core): skip lifecycle hooks for non-instantiated transient services</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15571" target="_blank" title="https://github.com/nestjs/nest/pull/15571" ref="nofollow noopener noreferrer">PR #15571</a>
优化了生命周期管理，不再对未实际实例化的瞬态服务触发 <code>onModuleInit</code> 等钩子。</p>
<p><strong>fix(core): attach root inquirer for nested transient providers</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15469" target="_blank" title="https://github.com/nestjs/nest/pull/15469" ref="nofollow noopener noreferrer">PR #15469</a>
修复了嵌套瞬态提供者丢失根 <code>inquirer</code>（请求发起者）信息的问题，确保依赖树追踪正确。</p>
<p><strong>fix(core): gracefully shutdown the app when repl exits</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15201" target="_blank" title="https://github.com/nestjs/nest/pull/15201" ref="nofollow noopener noreferrer">PR #15201</a>
修复了 REPL 环境退出时，Nest应用未能优雅关闭（Graceful Shutdown）的问题。</p>
<p><strong>fix(core): HTTP adapter error mapping</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15056" target="_blank" title="https://github.com/nestjs/nest/pull/15056" ref="nofollow noopener noreferrer">PR #15056</a>
修复了 HTTP 适配器层面的错误映射逻辑，确保底层抛出的错误能被框架正确识别和转换。</p>
<p><strong>fix(core): use topology tree for calculating distance (perf)</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14597" target="_blank" title="https://github.com/nestjs/nest/pull/14597" ref="nofollow noopener noreferrer">PR #14597</a>
这是一个重要的性能修复，通过使用拓扑树结构来计算模块距离，解决了大型项目启动缓慢的问题。</p>
<p><strong>fix(core): middleware sort issues</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14523" target="_blank" title="https://github.com/nestjs/nest/pull/14523" ref="nofollow noopener noreferrer">PR #14523</a>
修复了中间件排序逻辑中的 Bug，确保中间件严格按照注册顺序执行。</p>
<p><strong>fix(core): allow optional named wildcard groups</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14522" target="_blank" title="https://github.com/nestjs/nest/pull/14522" ref="nofollow noopener noreferrer">PR #14522</a>
修复了路由路径中可选命名通配符组（Named Wildcard Groups）解析不正确的问题。</p>
<p><strong>fix(core): shutdown hooks order</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14267" target="_blank" title="https://github.com/nestjs/nest/pull/14267" ref="nofollow noopener noreferrer">PR #14267</a>
修复了应用关闭时 <code>onModuleDestroy</code> 和 <code>beforeApplicationShutdown</code> 等钩子的执行顺序。</p>
<p><strong>fix(core): Calculate module distance after bindGlobalScope</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14110" target="_blank" title="https://github.com/nestjs/nest/pull/14110" ref="nofollow noopener noreferrer">PR #14110</a>
调整了计算模块距离的时机，确保在全局作用域绑定后进行，以获得正确的依赖拓扑。</p>
<p><strong>fix(core): Order of module destroy should be the reverse of module init</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14111" target="_blank" title="https://github.com/nestjs/nest/pull/14111" ref="nofollow noopener noreferrer">PR #14111</a>
严格规范了模块销毁顺序，确保其完全是初始化的逆序，防止销毁依赖时报错。</p>
<p><strong>fix(core): revisit dependencies w/ possibly higher distance</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14097" target="_blank" title="https://github.com/nestjs/nest/pull/14097" ref="nofollow noopener noreferrer">PR #14097</a>
修复了依赖解析算法，重新访问可能具有更高距离的依赖项，解决了复杂依赖图中的解析错误。</p>
<p><strong>fix(core): bring back <code>getHeader</code> and <code>appendHeader</code></strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15061" target="_blank" title="https://github.com/nestjs/nest/pull/15061" ref="nofollow noopener noreferrer">PR #15061</a>
在 <code>AbstractHttpAdapter</code> 中恢复了被误删的 <code>getHeader</code> 和 <code>appendHeader</code> 方法，修复了兼容性问题。</p>
<hr/>
<h4 data-id="heading-3">🕸️ 微服务 (Microservices) - 共 16 个修复</h4>
<p><em>今年的微服务修复重点在于“连接资源泄露”的治理以及 RabbitMQ/Redis 的行为修正。</em></p>
<p><strong>fix(microservices): ensure all redis and amqp client closes properly</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15062" target="_blank" title="https://github.com/nestjs/nest/pull/15062" ref="nofollow noopener noreferrer">PR #15062</a>
修复了微服务关闭时，底层的 Redis 和 AMQP 客户端连接未被彻底销毁导致的句柄泄露问题。
<em>(相关修复: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15032" target="_blank" title="https://github.com/nestjs/nest/pull/15032" ref="nofollow noopener noreferrer">PR #15032</a> AMQP connections, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15020" target="_blank" title="https://github.com/nestjs/nest/pull/15020" ref="nofollow noopener noreferrer">PR #15020</a> Redis connections)</em></p>
<p><strong>fix(microservices): fix grpc stream method return type</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16072" target="_blank" title="https://github.com/nestjs/nest/pull/16072" ref="nofollow noopener noreferrer">PR #16072</a>
修正了 gRPC 流式方法的返回类型定义，解决了类型推断错误。</p>
<p><strong>fix(microservices): rmq microservice fanout bind</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15747" target="_blank" title="https://github.com/nestjs/nest/pull/15747" ref="nofollow noopener noreferrer">PR #15747</a>
修复了 RabbitMQ 微服务在 Fanout 交换机模式下的绑定逻辑错误。</p>
<p><strong>fix(microservices): report correct buffer length in exception</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15508" target="_blank" title="https://github.com/nestjs/nest/pull/15508" ref="nofollow noopener noreferrer">PR #15508</a>
当发生数据包过大异常时，现在能报告准确的缓冲区长度，便于调试。</p>
<p><strong>fix(microservices): fix kafka serialization of class instances</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15492" target="_blank" title="https://github.com/nestjs/nest/pull/15492" ref="nofollow noopener noreferrer">PR #15492</a>
修复了 Kafka 传输器在序列化类实例时可能丢失数据或格式错误的问题。</p>
<p><strong>fix(microservices): Revisit RMQ pattern matching with wildcards</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15305" target="_blank" title="https://github.com/nestjs/nest/pull/15305" ref="nofollow noopener noreferrer">PR #15305</a>
重新设计了 RabbitMQ 的模式匹配逻辑，修复了通配符（Wildcards）匹配不准确的问题。</p>
<p><strong>fix(microservices): support custom strategy in async usefactory config</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15172" target="_blank" title="https://github.com/nestjs/nest/pull/15172" ref="nofollow noopener noreferrer">PR #15172</a>
修复了在 <code>useFactory</code> 异步配置中无法正确使用自定义微服务策略（Custom Strategy）的问题。</p>
<p><strong>fix(microservice): prevent error logs during redis client shutdown</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15166" target="_blank" title="https://github.com/nestjs/nest/pull/15166" ref="nofollow noopener noreferrer">PR #15166</a>
消除了 Redis 客户端在正常关闭过程中产生的误导性错误日志。</p>
<p><strong>fix(microservices): do not re-create client connection once get client</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14869" target="_blank" title="https://github.com/nestjs/nest/pull/14869" ref="nofollow noopener noreferrer">PR #14869</a>
修复了通过服务名获取客户端时，不必要地重复创建连接的问题。</p>
<p><strong>fix(microservices): server send drops emitted value</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14605" target="_blank" title="https://github.com/nestjs/nest/pull/14605" ref="nofollow noopener noreferrer">PR #14605</a>
修复了服务器端发送消息时，发射的值偶尔会被丢弃的 Bug。</p>
<p><strong>fix(microservices): rabbitmq bindings and auto-generated queues</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14129" target="_blank" title="https://github.com/nestjs/nest/pull/14129" ref="nofollow noopener noreferrer">PR #14129</a>
修复了 RabbitMQ 在使用自动生成的队列名时绑定失败的问题。</p>
<p><strong>fix(microservices): use instance refs for target handler callbacks</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14112" target="_blank" title="https://github.com/nestjs/nest/pull/14112" ref="nofollow noopener noreferrer">PR #14112</a>
在处理回调时改用实例引用，防止内存泄漏或上下文丢失。</p>
<p><strong>fix(microservices): delete unnecessary call of grpcClient.start</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F13468" target="_blank" title="https://github.com/nestjs/nest/pull/13468" ref="nofollow noopener noreferrer">PR #13468</a>
移除了 gRPC 客户端中不必要的 <code>start</code> 调用，避免潜在的状态冲突。</p>
<p><strong>fix(microservices): update RMQ_DEFAULT_QUEUE to an empty string</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15250" target="_blank" title="https://github.com/nestjs/nest/pull/15250" ref="nofollow noopener noreferrer">PR #15250</a>
将 RabbitMQ 默认队列名修正为空字符串，符合标准行为。</p>
<hr/>
<h4 data-id="heading-4">🚀 平台适配器 (Platform Fastify/Express) - 共 13 个修复</h4>
<p><em>主要是为了适配 Fastify v5 和 Express v5 的一些边缘行为及路由逻辑。</em></p>
<p><strong>fix(platform-fastify): middie bypassing through decoded chars</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16135" target="_blank" title="https://github.com/nestjs/nest/pull/16135" ref="nofollow noopener noreferrer">PR #16135</a>
修复了 Fastify 中 <code>middie</code> 中间件可能通过解码后的字符被绕过的安全隐患。</p>
<p><strong>fix(platform-fastify): Migrate fastify top-level options to routerOptions</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15831" target="_blank" title="https://github.com/nestjs/nest/pull/15831" ref="nofollow noopener noreferrer">PR #15831</a>
修复了 Fastify 顶层配置未正确传递给 <code>routerOptions</code> 的问题，确保路由配置生效。</p>
<p><strong>fix(platform-fastify): correct parameter type in RouteConstraints decorator</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15732" target="_blank" title="https://github.com/nestjs/nest/pull/15732" ref="nofollow noopener noreferrer">PR #15732</a>
修正了 <code>RouteConstraints</code> 装饰器参数的类型定义。</p>
<p><strong>fix(platform-fastify): auto-init fastify adapter for middleware registration</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15385" target="_blank" title="https://github.com/nestjs/nest/pull/15385" ref="nofollow noopener noreferrer">PR #15385</a>
在测试环境中，修复了 Fastify 适配器未自动初始化导致中间件注册失败的问题。</p>
<p><strong>fix(platform-fastify): methods comparison</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14935" target="_blank" title="https://github.com/nestjs/nest/pull/14935" ref="nofollow noopener noreferrer">PR #14935</a>
修复了 HTTP 方法比较逻辑，确保大小写不敏感匹配的正确性。</p>
<p><strong>fix(platform-fastify): adds the non-standard http methods to the instance</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14511" target="_blank" title="https://github.com/nestjs/nest/pull/14511" ref="nofollow noopener noreferrer">PR #14511</a>
允许 Fastify 实例识别并处理非标准的 HTTP 方法。</p>
<p><strong>fix(platform-fastify): global prefix exclusion path handling w/middleware</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14895" target="_blank" title="https://github.com/nestjs/nest/pull/14895" ref="nofollow noopener noreferrer">PR #14895</a>
修复了当设置全局路由前缀排除路径时，中间件仍然错误执行的问题。</p>
<p><strong>fix(platform-fastify): middleware not executed when root path is excluded</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F13797" target="_blank" title="https://github.com/nestjs/nest/pull/13797" ref="nofollow noopener noreferrer">PR #13797</a>
修复了当根路径被排除时，相关中间件未能正确执行的 Bug。</p>
<p><strong>fix(platform-express): make check for existing middlewares work with Express 5</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14574" target="_blank" title="https://github.com/nestjs/nest/pull/14574" ref="nofollow noopener noreferrer">PR #14574</a>
修复了 Express 5 环境下，检查现有中间件是否存在的逻辑失效的问题。</p>
<p><strong>fix(platform-express): respect custom parser middlewares in Express 5</strong>
(PR #14640) <em>链接源自描述</em>
确保在 Express 5 中，用户自定义的解析器中间件优先级正确。</p>
<p><strong>fix(platform-express): remove use of pipeline</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15010" target="_blank" title="https://github.com/nestjs/nest/pull/15010" ref="nofollow noopener noreferrer">PR #15010</a>
移除了对 <code>pipeline</code> 的使用，解决了某些环境下的流处理兼容性问题。</p>
<p><strong>fix(core): flattenRoutePath return a valid module</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15333" target="_blank" title="https://github.com/nestjs/nest/pull/15333" ref="nofollow noopener noreferrer">PR #15333</a>
修复了路由路径扁平化处理时，未能返回有效模块引用的问题。</p>
<hr/>
<h4 data-id="heading-5">🛠️ 通用工具与其它 (Common &amp; Others) - 共 6 个修复</h4>
<p><strong>fix(common): resolve file-type path explicitly</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16077" target="_blank" title="https://github.com/nestjs/nest/pull/16077" ref="nofollow noopener noreferrer">PR #16077</a>
修复了 <code>file-type</code> 库的路径解析问题，防止在某些构建工具下找不到模块。</p>
<p><strong>fix(common): Support fallbackToMimetype without buffer</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16013" target="_blank" title="https://github.com/nestjs/nest/pull/16013" ref="nofollow noopener noreferrer">PR #16013</a>
修复了 <code>FileTypeValidator</code> 在没有 Buffer 数据时，无法回退到 MIME 类型检查的问题。</p>
<p><strong>fix(common): console logger color allowance</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15577" target="_blank" title="https://github.com/nestjs/nest/pull/15577" ref="nofollow noopener noreferrer">PR #15577</a>
修复了控制台日志记录器在特定终端环境下颜色输出判断失效的问题。</p>
<p><strong>fix(common): revert to original value (swc builders regression)</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14579" target="_blank" title="https://github.com/nestjs/nest/pull/14579" ref="nofollow noopener noreferrer">PR #14579</a>
修复了 SWC 构建器引入的回归 Bug，将某些配置恢复为原始值。</p>
<p><strong>fix(common): addLeadingSlash optional group support</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14546" target="_blank" title="https://github.com/nestjs/nest/pull/14546" ref="nofollow noopener noreferrer">PR #14546</a>
修复了路径处理工具中对可选正则分组添加前导斜杠的逻辑错误。</p>
<p><strong>fix(common): drop broken support for promises on <code>exports</code></strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F14114" target="_blank" title="https://github.com/nestjs/nest/pull/14114" ref="nofollow noopener noreferrer">PR #14114</a>
移除了模块 <code>exports</code> 属性对 Promise 的错误支持，避免引发难以调试的异步问题。</p>
<h3 data-id="heading-6">功能增强项(包括依赖升级)</h3>
<p>基于同样的（ 2025 年发布记录）数据源月度数据统计，2025 年 NestJS 共有 <strong>33 项显著的功能增强</strong> 和 <strong>47 次重要的依赖升级</strong>。</p>
<p>2025 年 NestJS 团队的策略非常清晰：</p>
<ol>
<li><strong>稳固核心</strong>：通过大量的 <strong>Bug Fixes (50+)</strong> 解决了长期存在的边缘问题（特别是循环依赖和竞态条件）。</li>
<li><strong>拥抱标准</strong>：功能增强方面，积极拥抱 <strong>Native Fetch</strong> 和 <strong>Node.js LTS</strong> 新特性，减少对遗留库（如 Axios/Request）的依赖。</li>
<li><strong>微服务优先</strong>：大量精力投入在 <strong>NATS JetStream</strong> 和 <strong>gRPC</strong> 的体验优化上，反映出企业级用户对复杂微服务架构的需求日益增长。</li>
</ol>
<hr/>
<h4 data-id="heading-7">✨ 核心功能增强 (Enhancements) - 共 33 项</h4>
<p><em>这一年的新功能主要围绕“开发体验优化”和“微服务能力扩展”展开。</em></p>
<h5 data-id="heading-8">🚀 核心框架与开发体验 (Core &amp; DX)</h5>
<p><strong>feat(core): support for native fetch API in HttpService</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16240" target="_blank" title="https://github.com/nestjs/nest/pull/16240" ref="nofollow noopener noreferrer">PR #16240</a></p>
<p><strong>解释</strong>：终于摆脱了对 Axios 的强绑定。<code>HttpModule</code> 现在支持底层切换为 Node.js 原生的 <code>fetch</code> API，减少了包体积并提升了流式处理的性能。</p>
<p><strong>feat(core): auto-flush logs on shutdown</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15980" target="_blank" title="https://github.com/nestjs/nest/pull/15980" ref="nofollow noopener noreferrer">PR #15980</a></p>
<p><strong>解释</strong>：在应用接收到 SIGTERM 信号进行优雅关闭时，自动强制刷新缓冲区中的日志，防止容器销毁时最后几条关键日志丢失。</p>
<p><strong>feat(devtools): interactive graph visualization for circular deps</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16305" target="_blank" title="https://github.com/nestjs/nest/pull/16305" ref="nofollow noopener noreferrer">PR #16305</a></p>
<p><strong>解释</strong>：在 NestJS DevTools 中新增了可视化调试工具，能以图形方式展示模块间的循环依赖路径，帮助开发者快速定位“鸡生蛋”问题。</p>
<p><strong>feat(common): new <code>ParseDatePipe</code> with timezone support</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16112" target="_blank" title="https://github.com/nestjs/nest/pull/16112" ref="nofollow noopener noreferrer">PR #16112</a></p>
<p><strong>解释</strong>：增强了内置的日期管道，现在支持传入时区参数，自动将请求中的日期字符串转换为指定时区的 Date 对象。</p>
<h5 data-id="heading-9">🕸️ 微服务与消息队列 (Microservices)</h5>
<p><strong>feat(microservices): NATS JetStream wildcard subscriptions</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16055" target="_blank" title="https://github.com/nestjs/nest/pull/16055" ref="nofollow noopener noreferrer">PR #16055</a></p>
<p><strong>解释</strong>：大幅增强了 NATS 传输层，支持 JetStream 的通配符订阅模式，允许微服务通过一个 Handler 处理一类模式的消息（如 <code>orders.*.created</code>）。</p>
<p><strong>feat(microservices): gRPC reflection service v1alpha support</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15990" target="_blank" title="https://github.com/nestjs/nest/pull/15990" ref="nofollow noopener noreferrer">PR #15990</a></p>
<p><strong>解释</strong>：更新了 gRPC 策略，支持 gRPC 服务器反射协议（Server Reflection），使得 Postman 或 gRPCUI 等工具可以直接探测服务接口定义。</p>
<p><strong>feat(microservices): Kafka idempotent producer configuration</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16120" target="_blank" title="https://github.com/nestjs/nest/pull/16120" ref="nofollow noopener noreferrer">PR #16120</a></p>
<p><strong>解释</strong>：简化了 Kafka 生产者的配置，新增 <code>idempotent: true</code> 快捷配置项，确保在网络抖动时不重复发送消息。</p>
<h5 data-id="heading-10">🧩 其他模块 (OpenAPI / CLI)</h5>
<p><strong>feat(swagger): support for 'oneOf' schema composition via decorators</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16400" target="_blank" title="https://github.com/nestjs/nest/pull/16400" ref="nofollow noopener noreferrer">PR #16400</a></p>
<p><strong>解释</strong>：在 <code>ApiBody</code> 和 <code>ApiResponse</code> 中新增了对 <code>oneOf</code> 的原生装饰器支持，不再需要手写复杂的 Schema 对象。</p>
<p><strong>feat(cli): schematic support for standalone applications</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15888" target="_blank" title="https://github.com/nestjs/nest/pull/15888" ref="nofollow noopener noreferrer">PR #15888</a></p>
<p><strong>解释</strong>：CLI 新增了生成“独立应用（Standalone App）”的脚手架选项，适用于不需要 HTTP 监听器的 CronJob 或 Worker 脚本项目。</p>
<hr/>
<h4 data-id="heading-11">📦 关键依赖升级 (Dependency Upgrades) - 共 47 项</h4>
<p><em>为了保持生态系统的现代化和安全性，2025 年 NestJS 进行了几次重大的底层依赖迭代。</em></p>
<h5 data-id="heading-12">🔨 运行时与语言 (Runtime &amp; Language)</h5>
<p><strong>chore(deps): drop Node.js v18 support, add Node.js v24</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16500" target="_blank" title="https://github.com/nestjs/nest/pull/16500" ref="nofollow noopener noreferrer">PR #16500</a></p>
<p><strong>解释</strong>：<strong>重大变更</strong>。随着 Node.js v18 进入 EOL（生命周期结束），NestJS v11.5 正式移除对其支持，并将 CI/CD 环境升级至 Node.js v24 LTS。</p>
<p><strong>chore(deps): upgrade to TypeScript 5.7</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16222" target="_blank" title="https://github.com/nestjs/nest/pull/16222" ref="nofollow noopener noreferrer">PR #16222</a></p>
<p><strong>解释</strong>：全面适配 TypeScript 5.7，利用其新的类型收窄（Type Narrowing）特性优化了内部工具类型的推断速度。</p>
<h5 data-id="heading-13">🔌 平台适配器 (Platform Adapters)</h5>
<p><strong>chore(deps): upgrade to fastify v5</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F15750" target="_blank" title="https://github.com/nestjs/nest/pull/15750" ref="nofollow noopener noreferrer">PR #15750</a></p>
<p><strong>解释</strong>：<strong>重大升级</strong>。<code>platform-fastify</code> 适配器升级至 Fastify v5，彻底移除了对旧版中间件签名的支持，提升了 15% 的吞吐量。</p>
<p><strong>chore(deps): upgrade express to v5.0 (stable)</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16010" target="_blank" title="https://github.com/nestjs/nest/pull/16010" ref="nofollow noopener noreferrer">PR #16010</a></p>
<p><strong>解释</strong>：在 Express 5.0 发布正式版后，NestJS 第一时间跟进，支持了原生的 Promise 路由处理，不再需要 hack 层的补丁。</p>
<h5 data-id="heading-14">📚 第三方库整合 (Integrations)</h5>
<p><strong>chore(deps): upgrade rxjs to v8.0.0-alpha</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16450" target="_blank" title="https://github.com/nestjs/nest/pull/16450" ref="nofollow noopener noreferrer">PR #16450</a></p>
<p><strong>解释</strong>：开始在内部测试 RxJS 8 的兼容性，主要是为了适配更小的包体积，目前仍保持对 v7 的向后兼容。</p>
<p><strong>chore(deps): update mongoose to v9</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16333" target="_blank" title="https://github.com/nestjs/nest/pull/16333" ref="nofollow noopener noreferrer">PR #16333</a></p>
<p><strong>解释</strong>：适配 Mongoose v9 的破坏性变更，特别是关于 <code>Connection</code> 状态管理的逻辑更新。</p>
<p><strong>chore(deps): update typeorm to 0.4.0</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnestjs%2Fnest%2Fpull%2F16180" target="_blank" title="https://github.com/nestjs/nest/pull/16180" ref="nofollow noopener noreferrer">PR #16180</a></p>
<p><strong>解释</strong>：跟进 TypeORM 0.4.x 的驱动层更新，修复了在 PostgreSQL 17 下的一些驱动连接警告。</p>
<hr/>
<h3 data-id="heading-15">总结</h3>
<p>回顾 NestJS 在 2025 年的演进历程，可以用 <strong>“稳固根基，拥抱原生”</strong> 八个字来概括。</p>
<p>从 <strong>v11.0.0</strong> 到年底的 <strong>v11.1.11</strong>，官方潜下心来解决了大量深层次的架构问题：</p>
<ol>
<li><strong>技术债的清理</strong>：解决了困扰已久的循环依赖死锁和高并发下的竞态条件问题，这对于构建大规模单体应用（Monolith）的企业级用户来说是巨大的信心提升。</li>
<li><strong>标准化与去依赖</strong>：<code>HttpService</code> 支持原生 <code>fetch</code>、全面适配 Node.js LTS 和 TypeScript 5.7，标志着 NestJS 正在逐渐剥离对第三方重型库的依赖，回归 Web 标准。</li>
<li><strong>微服务生态的成熟</strong>：对 gRPC 反射和 NATS JetStream 的深度支持，说明 NestJS 已经不仅仅是一个 HTTP 框架，而是构建复杂分布式系统的首选方案。
环依赖可视化是一个神器，建议在开发阶段利用起来，避免代码结构随着业务增长变成难以维护的“意大利面条”。</li>
</ol>
<p>NestJS 依然是 Node.js 服务端领域的“扛把子”，2025 年的这些更新让它变得更加健壮和现代化。希望这篇汇总能帮助大家更好地规划 2026 年的技术选型和升级路线。</p>
<p>我是 Joney，我们下期再见！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Kubernetes集群中部署NFS Subdir ExternalProvisioner的完整复盘]]></title>    <link>https://juejin.cn/post/7599088558167261230</link>    <guid>https://juejin.cn/post/7599088558167261230</guid>    <pubDate>2026-01-26T03:06:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599088558167261230" data-draft-id="7598921649889738779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Kubernetes集群中部署NFS Subdir ExternalProvisioner的完整复盘"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-26T03:06:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="opsmaster"/> <meta itemprop="url" content="https://juejin.cn/user/2140102571593625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Kubernetes集群中部署NFS Subdir ExternalProvisioner的完整复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2140102571593625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    opsmaster
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:06:54.000Z" title="Mon Jan 26 2026 03:06:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在Kubernetes集群中部署NFS Subdir External Provisioner的完整复盘</h2>
<p>在Kubernetes（K8s）的持久化存储体系中，NFS（Network File System）作为经典的共享存储方案，被广泛用于多Pod共享数据的场景。但手动创建NFS类型的PV（PersistentVolume）不仅繁琐，还难以适配动态扩容的需求。<strong>NFS Subdir External Provisioner</strong> 正是解决这一问题的利器——它能基于NFS服务器，为PVC（PersistentVolumeClaim）<strong>动态创建PV</strong>，并自动管理NFS子目录的生命周期。</p>
<p>本文将结合实战操作，从<strong>环境介绍、核心原理、分步部署、功能验证</strong>四个维度，完整复盘NFS Subdir External Provisioner的部署与使用流程，帮你快速落地K8s的NFS动态存储方案。</p>
<hr/>
<h3 data-id="heading-1">一、实战环境介绍</h3>
<p>本次部署基于一套<strong>可正常运行的K8s集群</strong>，核心环境信息如下：</p>






























<table><thead><tr><th>组件</th><th>核心配置</th><th>验证方式</th></tr></thead><tbody><tr><td>Kubernetes集群</td><td>节点状态正常（可通过<code>kubectl get nodes</code>查看）</td><td><code>kubectl get nodes</code></td></tr><tr><td>NFS服务器</td><td>IP：<code>192.168.99.22</code>，共享目录：<code>/nfs-storage/k8s-pvs</code></td><td><code>showmount -e 192.168.99.22</code></td></tr><tr><td>部署工具</td><td>Helm（初始未安装，通过<code>snap</code>安装）</td><td><code>helm list -A</code>（初始无输出，安装后可正常执行）</td></tr><tr><td>访问工具</td><td><code>kubectl</code>（已配置集群访问权限）</td><td>可正常执行K8s资源操作命令</td></tr></tbody></table>
<blockquote>
<p>关键前提：NFS服务器已完成共享配置，K8s所有节点均可正常挂载该NFS共享目录。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、核心原理讲解</h3>
<h4 data-id="heading-3">1. NFS Subdir External Provisioner 是什么？</h4>
<p>它是K8s官方维护的<strong>外部存储Provisioner</strong>，基于NFS协议实现<strong>动态PV供给</strong>。核心能力是：</p>
<ul>
<li>监听K8s中PVC的创建/删除事件；</li>
<li>为每个PVC在NFS共享目录下<strong>自动创建独立子目录</strong>，并生成对应的PV；</li>
<li>当PVC删除时，根据配置<strong>归档或删除</strong>NFS子目录，实现PV的生命周期管理。</li>
</ul>
<h4 data-id="heading-4">2. 动态PV的核心流程</h4>
<ol>
<li><strong>用户创建PVC</strong>：指定关联的StorageClass（绑定NFS Provisioner）；</li>
<li><strong>Provisioner监听</strong>：检测到PVC创建请求，触发PV创建逻辑；</li>
<li><strong>NFS子目录创建</strong>：在NFS共享目录<code>/nfs-storage/k8s-pvs</code>下，生成以<code>命名空间-PVC名称-随机串</code>命名的子目录；</li>
<li><strong>PV创建与绑定</strong>：Provisioner创建PV，指向该NFS子目录，并与PVC完成绑定；</li>
<li><strong>PVC删除回收</strong>：删除PVC时，Provisioner根据<code>archiveOnDelete</code>参数，将NFS子目录重命名为<code>archived-xxx</code>（归档）或直接删除。</li>
</ol>
<h4 data-id="heading-5">3. StorageClass的作用</h4>
<p>StorageClass是动态PV的“模板”，本次部署中我们创建了名为<code>nfs-storage-class</code>的StorageClass，核心配置包括：</p>
<ul>
<li><code>provisioner</code>：指定为NFS Subdir External Provisioner；</li>
<li><code>nfs.server</code>/<code>nfs.path</code>：NFS服务器IP与共享目录；</li>
<li><code>archiveOnDelete</code>：PVC删除时是否归档NFS子目录（本次设为<code>true</code>）；</li>
<li><code>defaultClass</code>：是否设为集群默认StorageClass（本次设为<code>true</code>，未指定<code>storageClassName</code>的PVC将自动使用该类）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">三、实战部署步骤</h3>
<h4 data-id="heading-7">步骤1：环境分析与前置准备</h4>
<p>首先通过命令检查集群与NFS环境，确保部署前提满足：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 1. 检查K8s节点状态</span>
kubectl <span class="hljs-keyword">get</span> nodes

<span class="hljs-meta"># 2. 检查现有StorageClass（确认无冲突）</span>
kubectl <span class="hljs-keyword">get</span> storageclass

<span class="hljs-meta"># 3. 检查Helm安装状态（初始未安装）</span>
helm list -A

<span class="hljs-meta"># 4. 安装Helm（通过snap快速安装）</span>
sudo snap install helm --classic

<span class="hljs-meta"># 5. 验证NFS服务器共享目录可用性</span>
showmount -e <span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.22</span>
</code></pre>
<p>执行结果：NFS共享目录<code>/nfs-storage/k8s-pvs</code>正常暴露，Helm安装完成，K8s集群状态正常。</p>
<h4 data-id="heading-8">步骤2：Helm部署NFS Subdir External Provisioner</h4>
<p>借助Helm仓库快速部署Provisioner，简化配置与管理：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 添加NFS Provisioner的Helm仓库</span>
helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/

<span class="hljs-comment"># 2. 更新Helm仓库索引</span>
helm repo update

<span class="hljs-comment"># 3. 安装Provisioner（指定NFS参数、StorageClass配置）</span>
helm install nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
  -n kube-system \
  --set <span class="hljs-attr">nfs.server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">99.22</span> \
  --set <span class="hljs-attr">nfs.path</span>=/nfs-storage/k8s-pvs \
  --set <span class="hljs-attr">storageClass.name</span>=nfs-storage-class \
  --set <span class="hljs-attr">storageClass.defaultClass</span>=<span class="hljs-literal">true</span>
</code></pre>
<ul>
<li><code>-n kube-system</code>：将Provisioner部署在K8s系统命名空间，便于管理；</li>
<li><code>--set</code>参数：核心配置NFS服务器、共享路径、StorageClass名称及默认属性。</li>
</ul>
<h4 data-id="heading-9">步骤3：验证Provisioner部署状态</h4>
<p>部署完成后，检查Provisioner与StorageClass的运行状态：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 1. 检查Provisioner Pod状态（确认Running）</span>
kubectl <span class="hljs-keyword">get</span> pods -n kube-system | grep nfs-provisioner

<span class="hljs-meta"># 2. 检查StorageClass（确认创建成功且为默认）</span>
kubectl <span class="hljs-keyword">get</span> storageclass

<span class="hljs-meta"># 3. 查看StorageClass详细配置（验证参数正确性）</span>
kubectl describe storageclass nfs-storage-<span class="hljs-keyword">class</span>
</code></pre>
<p>执行结果：Provisioner Pod处于<code>Running</code>状态，<code>nfs-storage-class</code> StorageClass创建成功并标记为<code>(default)</code>，核心参数与NFS配置一致。</p>
<h4 data-id="heading-10">步骤4：验证动态PV功能</h4>
<p>通过创建测试PVC，验证动态PV的创建、绑定、回收全流程：</p>
<h5 data-id="heading-11">（1）创建测试PVC YAML</h5>
<p>新建<code>test-nfs-pvc.yaml</code>，定义PVC的存储需求与关联的StorageClass：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-string">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-string">name:</span> <span class="hljs-string">test-nfs-pvc</span>
  <span class="hljs-string">namespace:</span> <span class="hljs-string">ms-demo</span>  <span class="hljs-comment"># 测试命名空间（需提前存在）</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-string">-</span> <span class="hljs-string">ReadWriteMany</span>  <span class="hljs-comment"># NFS支持多Pod读写</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">requests:</span>
      <span class="hljs-string">storage:</span> <span class="hljs-string">100Mi</span>  <span class="hljs-comment"># 申请100Mi存储</span>
  <span class="hljs-string">storageClassName:</span> <span class="hljs-string">nfs-storage-class</span>  <span class="hljs-comment"># 关联部署的StorageClass</span>
</code></pre>
<h5 data-id="heading-12">（2）创建PVC并验证绑定</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 1. 创建PVC</span>
kubectl apply -f test-nfs-pvc.yaml

<span class="hljs-meta"># 2. 检查PVC状态（确认Bound）</span>
kubectl <span class="hljs-keyword">get</span> pvc -n ms-demo

<span class="hljs-meta"># 3. 检查PV（确认自动创建并绑定）</span>
kubectl <span class="hljs-keyword">get</span> pv | grep test-nfs-pvc
</code></pre>
<p>执行结果：PVC状态为<code>Bound</code>，PV自动创建且与PVC完成绑定。</p>
<h5 data-id="heading-13">（3）验证NFS子目录创建</h5>
<p>登录NFS服务器，检查共享目录下是否生成对应子目录：</p>
<pre><code class="hljs language-arduino" lang="arduino">ssh <span class="hljs-number">192.168</span><span class="hljs-number">.99</span><span class="hljs-number">.22</span> <span class="hljs-string">"ls -la /nfs-storage/k8s-pvs/"</span>
</code></pre>
<p>执行结果：生成<code>ms-demo-test-nfs-pvc-xxx</code>格式的子目录，证明Provisioner已成功创建NFS存储目录。</p>
<h5 data-id="heading-14">（4）验证PVC删除与PV回收</h5>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 删除测试PVC</span>
kubectl <span class="hljs-keyword">delete</span> -f test-nfs-pvc.yaml

<span class="hljs-comment"># 2. 检查PV（确认自动删除）</span>
kubectl get pv | <span class="hljs-keyword">grep</span> pvc-xxx  <span class="hljs-comment"># 替换为实际PV名称</span>

<span class="hljs-comment"># 3. 检查NFS子目录（确认归档）</span>
ssh <span class="hljs-number">192.168</span>.<span class="hljs-number">99.22</span> <span class="hljs-string">"ls -la /nfs-storage/k8s-pvs/"</span>
</code></pre>
<p>执行结果：PV被自动删除，NFS子目录重命名为<code>archived-ms-demo-test-nfs-pvc-xxx</code>（因<code>archiveOnDelete=true</code>，数据被归档保留）。</p>
<hr/>
<h3 data-id="heading-15">四、部署结果与注意事项</h3>
<h4 data-id="heading-16">1. 核心验证结果</h4>
<p>✅ NFS Subdir External Provisioner Pod正常运行（<code>kube-system</code>命名空间）； ✅ <code>nfs-storage-class</code> StorageClass创建成功并设为集群默认； ✅ 动态PV功能生效：PVC创建→PV自动创建→NFS子目录生成； ✅ 回收策略生效：PVC删除→PV自动删除→NFS子目录归档。</p>
<h4 data-id="heading-17">2. 关键注意事项</h4>
<ol>
<li><strong>NFS权限配置</strong>：NFS共享目录需赋予K8s节点读写权限，避免Provisioner创建子目录失败；</li>
<li><strong><code>archiveOnDelete</code>参数</strong>：生产环境建议设为<code>true</code>（归档数据），测试环境可设为<code>false</code>（直接删除）；</li>
<li><strong>命名空间管理</strong>：Provisioner部署在<code>kube-system</code>，PVC需在目标命名空间创建（如本次<code>ms-demo</code>）；</li>
<li><strong>默认StorageClass</strong>：设为默认后，未指定<code>storageClassName</code>的PVC将自动使用NFS存储，需避免冲突；</li>
<li><strong>NFS服务器稳定性</strong>：NFS服务器需保证高可用，否则会影响所有依赖该存储的Pod。</li>
</ol>
<hr/>
<h3 data-id="heading-18">五、总结</h3>
<p>通过Helm部署NFS Subdir External Provisioner，我们快速实现了K8s集群的<strong>NFS动态PV供给</strong>，彻底告别了手动创建PV的繁琐流程。从环境准备、Provisioner部署，到动态PV的创建、绑定、回收全流程验证，整套方案具备<strong>部署简单、管理高效、兼容性强</strong>的特点，非常适合中小型K8s集群的共享存储场景。</p>
<p>后续可基于该方案，为应用（如数据库、中间件、文件服务）配置持久化存储，结合<code>ReadWriteMany</code>访问模式，实现多Pod共享数据的需求，进一步提升K8s集群的存储管理效率。</p>
<blockquote>
<p>本文转至：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzcwMTA1NjQyNQ%3D%3D%26action%3Dgetalbum%26album_id%3D4350369381197905931%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzcwMTA1NjQyNQ==&amp;action=getalbum&amp;album_id=4350369381197905931#wechat_redirect" ref="nofollow noopener noreferrer">mp.weixin.qq.com/mp/appmsgal…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nestjs学习9：装饰器]]></title>    <link>https://juejin.cn/post/7598899986856525830</link>    <guid>https://juejin.cn/post/7598899986856525830</guid>    <pubDate>2026-01-26T03:09:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598899986856525830" data-draft-id="7594627998838947882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nestjs学习9：装饰器"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-01-26T03:09:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一江东流水"/> <meta itemprop="url" content="https://juejin.cn/user/1151943917181880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nestjs学习9：装饰器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943917181880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一江东流水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:09:15.000Z" title="Mon Jan 26 2026 03:09:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nest 的功能都是大多通过装饰器来使用的，本文把所有的装饰器过一遍。文章来源自神光的付费文章，搬迁到这里只是为了自己复习。</p>
<h2 data-id="heading-0">@Module @Controller @Injectable</h2>
<p>Nest 提供了一套模块系统，通过 @Module声明模块：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6704e56011864cd7887208be004f21ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=%2Boz%2FlHlrLT10pWOC4KvSCHdPSoQ%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Controller、@Injectable 分别声明其中的 controller 和 provider：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378d78e08d2e45f8a1fc67d78de0753a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=0daA0FPqXJoV8Zp%2FEGRvMXrP2gY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7883a3483f04441a73cd27784301e79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=k0wOtIfAlYxJHsmpllyVKh1Tt0g%3D" alt="image.png" loading="lazy"/></p>
<p><strong>这个 provider 可以是任何的 class</strong>，不一定非要是<code>service</code>，我们可以自定义任何一个类作为<code>provider</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7361f9b96cd64b8ba9e1a420d3c11d78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=jQ8cLptgiHV6u8ecAqUt4NRObnQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">@Inject @Optional @Global</h2>
<p>注入的方式可以是构造器注入和属性注入：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9bb33903a964ac3ab85d6aaba3d9c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=7zulL7w3OhlATN9pZs%2F9e4JgQf8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc388637b5e9429bb2f2a8a7e8a20935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=6AYgmSD7EE8X3oaKAy9rQbMsASA%3D" alt="image.png" loading="lazy"/></p>
<p>属性注入要指定注入的 token，<strong>可能是 class 也可能是 string</strong>。</p>
<p>你可以通过 useFactory、useValue 等方式声明 provider：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09a1a7d3aa3d4c5ca0f06081d86775a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=vGQLW4qER9tVopHi08TThU64D2w%3D" alt="image.png" loading="lazy"/></p>
<p>这时候也需要通过 @Inject 指定注入的 token：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b84459f42546e8a022ceb27ebdb57f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=tpXaUdCK9obYSQkZkDFjO81cexI%3D" alt="image.png" loading="lazy"/></p>
<p>这些注入的依赖如果没有的话，创建对象时会报错。但如果它是可选的，你可以用 <code>@Optional</code> 声明一下，这样没有对应的 provider 也能正常创建这个对象。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6957271d4ab744ae978d2095d47140d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=iZXQ22ohETND5KAyNW140p7ppSU%3D" alt="image.png" loading="lazy"/></p>
<p>如果模块被很多地方都引用，为了方便，可以用 @Global 把它声明为全局的，这样它 exports 的 provider 就可以直接注入了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1348652f2924067ba39d1822bbc0820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=dhEbWpyftCLxfNw7O83UVhJmMlU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">@Query @Param @Body @Headers @Ip @Session @HostParam @Req</h2>
<p>这里的 @Query 是取 url 后的 ?bbb=true，而 @Param 是取路径中的参数，比如 /xxx/111 种的 111。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7bd54fae334479bd677c2ab60b74cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=vdEg4qifVnT%2BCmIxzHfR5mSrmgg%3D" alt="image.png" loading="lazy"/></p>
<p>此外，如果是 @Post 请求，可以通过 @Body 取到 body 部分：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a03a459b46b34cc681860aaebe6bef59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=bBdIno1Q74GRQ9gPTTSxz2KLWpU%3D" alt="image.png" loading="lazy"/></p>
<p>你可以通过 @Headers 装饰器取某个请求头 或者全部请求头：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a9f409b013b4e17952ddd2630944572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=IYx1E111mQ0I3LA8r5bXzQiEx8Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e7d7f9d7043414295add7c1479a13c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=Hcfs9LXv%2FqMVO9szbn7zWFroEw8%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Ip 拿到请求的 ip：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/480ed6c3adad447999318b2a32ef7920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=62tXpC7YWj%2FgoR973oJl7BEFVU0%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Session 拿到 session 对象：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5160848f37c34e0bb810c57166651e55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=cwQKs94Q8JvWxNq2l414xhJR1pc%3D" alt="image.png" loading="lazy"/></p>
<p>但要使用 session 需要安装一个 express 中间件：</p>
<pre><code class="hljs language-js" lang="js">npm install express-session
</code></pre>
<p>@HostParam 用于取域名部分的参数：</p>
<p>这样指定 controller 的生效路径：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">HostParam</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

@<span class="hljs-title class_">Controller</span>({ <span class="hljs-attr">host</span>: <span class="hljs-string">':host.0.0.1'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'aaa'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaController</span> {
    @<span class="hljs-title class_">Get</span>(<span class="hljs-string">'bbb'</span>)
    <span class="hljs-title function_">hello</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'hello'</span>;
    }
}
</code></pre>
<p>controller 除了可以指定某些 path 生效外，还可以指定 host。</p>
<p>这时候你会发现只有 host 满足 xx.0.0.1 的时候才会路由到这个 controller。</p>
<p>host 里的参数就可以通过 @HostParam 取出来：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">HostParam</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

@<span class="hljs-title class_">Controller</span>({ <span class="hljs-attr">host</span>: <span class="hljs-string">':host.0.0.1'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'aaa'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaController</span> {
    @<span class="hljs-title class_">Get</span>(<span class="hljs-string">'bbb'</span>)
    <span class="hljs-title function_">hello</span>(<span class="hljs-params">@HostParam(<span class="hljs-string">'host'</span>) host</span>) {
        <span class="hljs-keyword">return</span> host;
    }
}
</code></pre>
<p>前面取的这些都是 request 里的属性，当然也可以直接注入 request 对象：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8e25a60a29c4989ab6bcb18eec259d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=5PKUjBZn694mPj%2BRjtK%2F4Jt55Ck%3D" alt="image.png" loading="lazy"/></p>
<p>通过 @Req 或者 @Request 装饰器，这俩是同一个东西：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31412309a91645099e4b3be3c5370d26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=8trAwP5V%2BPLU%2FsV12D2aBYsVE08%3D" alt="image.png" loading="lazy"/></p>
<p>注入 request 对象后，可以手动取任何参数。</p>
<h2 data-id="heading-3">@Res @HttpCode @Redirect @Render</h2>
<p>当然，也可以 @Res 或者 @Response 注入 response 对象，只不过 response 对象有点特殊：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c8486054da24a6eab36e5a1a853939f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=2OTYTsp7mCMbp%2FQ253H%2BLvCh2mk%3D" alt="image.png" loading="lazy"/></p>
<p>当你注入 response 对象之后，服务器会一直没有响应：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e55b2ff5dfa4d64b225fcebc98673c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=XoQ0yCQuQbvJiP2apmHUaYGF%2FtI%3D" alt="image.png" loading="lazy"/></p>
<p>因为这时候 Nest 就不会再把 handler 返回值作为响应内容了。</p>
<p>你可以自己返回响应：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/334a284cb88d47c19213064a266d4de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=lTfw7O5WCrqIqBxt5I0Wuk3HDFU%3D" alt="image.png" loading="lazy"/></p>
<p>Nest 这么设计是为了避免你自己返回的响应和 Nest 返回的响应的冲突。</p>
<p>如果你不会自己返回响应，可以通过 passthrough 参数告诉 Nest：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e635d6856814cc4beb36c304f7337c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=WKm4KQmSkZZNDJNMrhjZR3GTKy4%3D" alt="image.png" loading="lazy"/></p>
<p>除了注入 @Res 不会返回响应外，注入 @Next 也不会：</p>
<p>handler 默认返回的是 200 的状态码，你可以通过 @HttpCode 修改它：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7467ae918e645c0b89170a65a15c344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=JRvllShBGGFlf3oMSUPVfz%2F8wOs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f331d443c4d4b668fa2af936ec42276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=f7I1VfwXEIsnXczIdTkITNBpgf8%3D" alt="image.png" loading="lazy"/></p>
<p>此外，你还可以通过 @Redirect 装饰器来指定路由重定向的 url：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02f4cf37e8674da086c7cc4dc34c6d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=v2grsloEiVekkVWof5%2FG1zuDEhs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b36ea6174b4da9aa1b83d4bdbf4d07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=aOvUXQHSQLInG6wus3r0Tcw8h%2Fs%3D" alt="d563d9e5836f49038f9ad7db40702f85~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75.awebp" loading="lazy"/></p>
<p>或者在返回值的地方设置 url：</p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Get</span>(<span class="hljs-string">'xxx'</span>)
@<span class="hljs-title class_">Redirect</span>()
<span class="hljs-keyword">async</span> <span class="hljs-title function_">jump</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">url</span>: <span class="hljs-string">'https://www.baidu.com'</span>,
      <span class="hljs-attr">statusCode</span>: <span class="hljs-number">302</span>
    }  
}
</code></pre>
<p><strong>301 和 302 的区别：</strong></p>




















<table><thead><tr><th>访问阶段</th><th>301 永久重定向</th><th>302 临时重定向</th></tr></thead><tbody><tr><td><strong>第一次访问</strong></td><td>1. 浏览器请求 <code>old</code> → 服务器返回 301 + 新地址；2. 浏览器跳转 <code>new</code>，并<strong>把「old→new」的关系永久存在本地缓存</strong></td><td>1. 浏览器请求 <code>old</code> → 服务器返回 302 + 新地址2. 浏览器跳转 <code>new</code>，<strong>不缓存任何关系</strong></td></tr><tr><td><strong>第二次访问</strong></td><td>浏览器直接查本地缓存：“哦，old 永久指向 new” → 直接跳 new，<strong>根本不发请求给服务器</strong></td><td>浏览器重新发请求到 <code>old</code> → 服务器再次返回 302 → 再跳 new</td></tr></tbody></table>
<p>你还可以给返回的响应内容指定渲染引擎，不过这需要先这样设置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b714afd922ea456a99ba03fda6eea460~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=qHq30En1FtT1y%2B5fKiQ%2BCTqHvZs%3D" alt="image.png" loading="lazy"/></p>
<p>分别指定静态资源的路径和模版的路径，并指定模版引擎为 handlerbars。</p>
<p>当然，还需要安装模版引擎的包 hbs：</p>
<pre><code class="hljs language-js" lang="js">npm install --save hbs
</code></pre>
<p>然后准备图片和模版文件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cb4e5e00f5c47c1818fa2e1187abe26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=hleyxKDG8n5Tl7nncUnGhEOpgcU%3D" alt="image.png" loading="lazy"/></p>
<p>在 handler 里指定模版和数据：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10232aea806b436fbede7470a9691a8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=Enj5VTQKDEmmcCG0EdND7opS81E%3D" alt="image.png" loading="lazy"/></p>
<p>就可以看到渲染出的 html 了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fb204cd6bf444668b8ac6b80b476551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5rGf5Lic5rWB5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001755&amp;x-signature=JJb%2BQVDJv8ZEITXFd3U1Jc2gV90%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">总结</h2>
<p>这节我们梳理了下 Nest 全部的装饰器</p>
<p>模块的装饰器：</p>
<ul>
<li>@Module： 声明 Nest 模块</li>
<li>@Controller：声明模块里的 controller</li>
<li>@Injectable：声明模块里可以注入的 provider</li>
<li>@Inject：通过 token 手动指定注入的 provider，token 可以是 class 或者 string</li>
<li>@Optional：声明注入的 provider 是可选的，可以为空</li>
<li>@Global：声明全局模块</li>
</ul>
<p>请求体的装饰器：</p>
<ul>
<li>@Param：取出 url 中的参数，比如 /aaa/:id 中的 id</li>
<li>@Query: 取出 query 部分的参数，比如 /aaa?name=xx 中的 name</li>
<li>@Body：取出请求 body，通过 dto class 来接收</li>
<li>@Headers：取出某个或全部请求头</li>
<li>@Session：取出 session 对象，需要启用 express-session 中间件</li>
<li>@HostParm： 取出 host 里的参数</li>
<li>@Req、@Request：注入 request 对象</li>
</ul>
<p>响应体的装饰器：</p>
<ul>
<li>@Res、@Response：注入 response 对象，一旦注入了这个 Nest 就不会把返回值作为响应了，除非指定 passthrough 为true</li>
<li>@HttpCode： 修改响应的状态码</li>
<li>@Header：修改响应头</li>
<li>@Redirect：指定重定向的 url</li>
<li>@Render：指定渲染用的模版引擎</li>
</ul>
<p>把这些装饰器用熟，就掌握了 nest 大部分功能了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 8.x 已成事实标准，但这些“坑”才刚刚暴露]]></title>    <link>https://juejin.cn/post/7599094262592946186</link>    <guid>https://juejin.cn/post/7599094262592946186</guid>    <pubDate>2026-01-26T02:41:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599094262592946186" data-draft-id="7598947628468699182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 8.x 已成事实标准，但这些“坑”才刚刚暴露"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2026-01-26T02:41:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙序员小站"/> <meta itemprop="url" content="https://juejin.cn/user/1546375522426169"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 8.x 已成事实标准，但这些“坑”才刚刚暴露
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1546375522426169/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙序员小站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T02:41:06.000Z" title="Mon Jan 26 2026 02:41:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你不了解8.x的坑，那请你一定要从头开始阅读本文，如果你已经深陷8.x的坑中，那请你从第七章开始读，希望这章能给你解决思路</p>
<hr/>
<h2 data-id="heading-0">一、为什么 MySQL 8 已经不是「可选升级」</h2>
<p>如果现在还在讨论“要不要上 MySQL 8”，那这个问题本身就已经有点过时了。</p>
<p>过去两年里，MySQL 版本的选择权，正在从业务团队手里一点点消失。最直观的变化来自云厂商。无论是阿里云、腾讯云还是 AWS，新建实例时，MySQL 的默认版本已经全面切到 8.x。5.7 还在，但通常被放进「历史版本」或者「不推荐」里，前面会挂一个很克制但意味明确的提示。</p>
<p>一开始我也没太在意。默认版本这种东西，改一下就好了。后来发现，新项目根本不让你改。有的云环境直接在控制台把 5.7 隐藏掉，有的在内部规范里写得很清楚：<strong>新系统不允许使用 MySQL 5.7</strong>。理由也很简单——官方生命周期、长期维护、安全合规，全都站在 8.x 那一边。</p>
<p>这时候，升级这件事已经不是“技术选型”，而是“时间问题”。</p>
<hr/>
<p>真正让人不舒服的地方在于： MySQL 8 并不是一个“无感升级”。</p>
<p>在 5.7 时代，大多数系统对数据库的要求其实很朴素：</p>
<ul>
<li>SQL 能跑</li>
<li>结果差不多对</li>
<li>性能在可接受范围内</li>
</ul>
<p>很多隐含前提，从来没人明说，但大家都默认成立。比如：</p>
<ul>
<li>排序结果“看起来是稳定的”</li>
<li>group by 没写全字段也能返回点东西</li>
<li>字符串和数字混着比，数据库会帮你兜底</li>
</ul>
<p>这些行为，在 5.7 里并不罕见，甚至可以说是被长期依赖的“特性”。而 MySQL 8 做的第一件事，就是开始系统性地拆掉这些“兜底”。</p>
<hr/>
<p>很多人升级后第一反应是：</p>
<blockquote>
<p>MySQL 8 怎么这么严格？ 以前能跑的 SQL，现在居然直接报错。</p>
</blockquote>
<p>但站在现在回头看，这个判断其实有点本末倒置。问题不在于 MySQL 8 变“激进”了，而在于 <strong>我们写的 SQL，本来就站在一堆未写明的默认行为上</strong>。这些默认行为，在 5.7 里被纵容了很多年。MySQL 8 只是选择不再纵容。</p>
<hr/>
<p>更关键的是，这种变化往往不是“升级当天就炸”。很多系统在升级到 8.0 后：</p>
<ul>
<li>能启动</li>
<li>能跑主流程</li>
<li>甚至压测数据也没明显异常</li>
</ul>
<p>真正的问题，往往是上线几周、甚至几个月之后才慢慢浮出来。</p>
<p>排序结果开始不稳定；历史数据和新数据混在一起时表现异常；某些 SQL 在特定数据量下突然变慢；偶发的执行计划漂移，重启后又“神奇恢复”；这些现象单独看，都不像是“数据库升级问题”。。。</p>
<p>但它们有一个共同点：<strong>都建立在“旧行为仍然成立”的假设之上</strong>。</p>
<hr/>
<p>所以现在再回头看，会发现一个挺残酷的事实：很多系统并不是“被 MySQL 8 坑了”，而是<strong>在用 MySQL 5.7 的思维，跑 MySQL 8.0</strong>。而 MySQL 8 这个版本，恰好不再愿意替你把这些问题藏起来。</p>
<hr/>
<h2 data-id="heading-1">二、第一个被低估的变化：默认字符集和排序规则</h2>
<p>大多数团队第一次真正感受到 MySQL 8 和以前不一样，往往不是在建表的时候，而是在数据已经跑了一段时间之后。</p>
<p>表现形式也很一致：列表排序看起来“不太稳定”，某些值的位置偶尔会飘，分页翻页时顺序对不上，导出的数据和页面展示对不上，但你单独拎一条 SQL 出来跑，又很难复现问题。这种问题在 5.7 时代并不常见，至少不常被当成数据库问题。</p>
<hr/>
<p>MySQL 8 上来就做了一件看似“人畜无害”的事：把默认字符集从 <code>utf8</code> 换成了 <code>utf8mb4</code>，排序规则从 <code>*_general_ci</code> 换成了 <code>*_0900_ai_ci</code>。很多人第一次看到这个改动的反应是：“挺好，终于原生支持 emoji 了。”</p>
<p>但这个理解，几乎忽略了 80% 的实际影响。</p>
<hr/>
<p>先说字符集。在 5.7 里，大量历史表的字符集是 <code>utf8</code>，而不是严格意义上的 UTF-8，只是 MySQL 自己的三字节实现。升级到 8.0 之后，新建表默认直接变成了 <code>utf8mb4</code>。问题不在于“多支持几个字符”，而在于<strong>字段、索引和历史表之间开始出现隐性不一致</strong>。</p>
<p>一个很常见的场景是这样的：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  nickname <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
  KEY idx_nickname (nickname)
);
</code></pre>
<p>这张表在 5.7 时代建的，没有任何问题。</p>
<p>升级到 8.0 之后，你可能会在新环境里重建表结构，甚至只是通过工具同步一次结构。这时候，<code>nickname</code> 的字符集已经悄悄变成了 <code>utf8mb4</code>。单看字段没问题，单看索引也没问题，真正的问题是：<strong>索引长度和比较方式已经变了</strong>。</p>
<p>如果这个字段后来被你扩展到了 <code>VARCHAR(255)</code>，在某些情况下，索引会直接建不出来，或者被你无意识地截断。更糟的是，有些环境能建，有些环境不能建，差异只来自于默认字符集和排序规则是否一致。</p>
<hr/>
<p>真正杀伤力更大的，其实是排序规则。</p>
<p>在 5.7 里，大量系统使用的是 <code>utf8_general_ci</code>。这个排序规则的特点是：<strong>简单、宽松、不太讲究语言学细节</strong>。</p>
<p>MySQL 8 默认换成了 <code>utf8mb4_0900_ai_ci</code>，这是基于 Unicode 9.0 的排序规则，考虑了更多字符等价关系。听起来是“更标准”，但代价是：<strong>排序结果和以前不一样了</strong>。</p>
<p>举一个最简单、也最容易被忽略的例子：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> demo <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> name;
</code></pre>
<p>在 5.7 下，如果你的数据是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>
<span class="hljs-selector-tag">A</span>
aa
</code></pre>
<p>排序结果往往是你“习惯中的那种”。到了 8.0，同样的数据、同样的 SQL，顺序可能发生变化。不是错，是规则变了。</p>
<p>真正的问题在于，大量业务代码<strong>默认排序结果是稳定的</strong>，甚至会在应用层偷偷依赖这个顺序。</p>
<hr/>
<p>这类问题为什么在测试环境经常没暴露？</p>
<p>因为测试库通常是新建的，表结构、字符集、排序规则都很“干净”。而生产环境的数据，是一层层历史叠上来的：5.6 建的表、5.7 跑过的数据、8.0 新插的记录，全混在一起。同一列字段，逻辑上是一样的字符串，但底层比较规则已经不完全一致。</p>
<p>这时候再去看应用层，只会觉得事情非常诡异：SQL 没变，索引没动，数据量也没突然暴涨，但排序就是不稳定。</p>
<hr/>
<p>很多团队第一次意识到问题出在这里，是在定位了很久之后，才发现：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">FULL</span> COLUMNS <span class="hljs-keyword">FROM</span> table_name;
</code></pre>
<p>同一个字段，在不同环境里的 <code>Collation</code> 并不一样。但这一步，往往已经是事故之后的复盘动作了。</p>
<p>这一类问题的共同特点是：<strong>它不是“功能性错误”，而是“行为变化”</strong> 。而行为变化，恰恰是最难被测试覆盖的。</p>
<p>好，继续 <strong>第三章</strong>。这一章我会紧扣你给的提纲，重点放在 <strong>SQL 行为变严格带来的真实冲击</strong>，而不是规则本身。</p>
<hr/>
<h2 data-id="heading-2">三、SQL 行为更“严格”，老 SQL 开始报错</h2>
<p>如果说字符集和排序规则的问题，还带着一点“隐蔽性”，那 SQL 模式的变化就直接多了。</p>
<p>升级到 MySQL 8 之后，很多团队第一次感受到的不是性能波动，而是：<strong>系统直接起不来了</strong>。</p>
<p>错误日志里往往是类似这样的信息：</p>
<pre><code class="hljs language-sql" lang="sql">Expression #<span class="hljs-number">1</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">SELECT</span> list <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> clause
<span class="hljs-keyword">and</span> <span class="hljs-keyword">contains</span> nonaggregated <span class="hljs-keyword">column</span> ...
</code></pre>
<p>这类报错在 5.7 时代并不是不存在，只是大多数时候，它们被默认配置“放过了”。</p>
<hr/>
<p>最典型的，就是 <code>ONLY_FULL_GROUP_BY</code>。</p>
<p>这个模式在 5.7 里就已经存在，但在很多系统里：</p>
<ul>
<li>要么被关掉</li>
<li>要么从来没被认真对待</li>
</ul>
<p>原因也很现实。不少业务 SQL 写得很早，逻辑又复杂，改起来风险极高。只要能跑，大家就默认“问题不大”。升级到 MySQL 8 后，这种侥幸心理第一次被正面击穿。一条以前能正常返回结果的 SQL，现在直接拒绝执行：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> user_id, create_time
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;
</code></pre>
<p>在旧环境里，它会返回一条看起来“还算合理”的数据。但从语义上说，这条 SQL 本来就没有定义清楚：一个 <code>user_id</code> 对应多条记录时，<code>create_time</code> 到底是哪一条？</p>
<p>MySQL 8 选择不再替你做这个决定。</p>
<hr/>
<p>很多人第一反应是“数据库太死板了”。但当你真的回到业务语义上看，会发现这些 SQL 暴露出来的，往往不是数据库问题，而是<strong>设计阶段被忽略的选择</strong>。</p>
<p>是要最早的一条？还是最新的一条？还是某种业务规则下的那一条？</p>
<p>这些问题，5.7 时代被数据库“帮你猜了”，而 8.0 要你自己说清楚。</p>
<hr/>
<p>另一类影响更隐蔽，但后果同样真实的变化，是隐式类型转换变少了。在老系统里，这种 SQL 非常常见：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-string">'123'</span>;
</code></pre>
<p>字段是 <code>BIGINT</code>，参数是字符串。</p>
<p>5.7 时代，这基本不是问题。</p>
<p>到了 MySQL 8，这种写法依然能跑，但副作用开始显现。在一些场景下，隐式转换会导致索引无法使用，执行计划悄悄发生变化。SQL 没报错，返回也正常，但性能开始波动。更糟的是，这类问题通常不会集中爆发，而是随着数据量增长，逐渐放大。一开始只是慢一点，后来变成偶发慢 SQL，再后来就是稳定复现的性能问题。</p>
<hr/>
<p>这类 SQL 的危险之处在于：<strong>它们看起来很“正常”</strong> 。代码里到处都是，测试环境也跑得飞快，直到某一天在生产环境被数据量放大，才开始显形。而 MySQL 8 在这里的态度非常明确：它不是在“变难用”，而是在<strong>减少对坏 SQL 的容忍度</strong>。</p>
<p>以前你写得不够严谨，数据库帮你兜底；现在兜底逻辑在收紧，问题自然就浮上来了。</p>
<hr/>
<p>很多升级事故，表面上是“数据库升级失败”，实际上是<strong>多年积累下来的 SQL 设计问题，被一次性曝光</strong>。</p>
<p>而真正让人头疼的还在后面。即使你的 SQL 语义是正确的、写法是规范的，到了 MySQL 8，执行计划本身，也可能不再按你“熟悉的方式”工作。</p>
<h2 data-id="heading-3">四、执行计划更聪明，但也更“不可预测”</h2>
<p>真正让团队开始不安的，往往不是升级当天的报错，而是上线一段时间之后出现的性能波动。</p>
<p>SQL 没改。索引没动。数据增长也在预期范围内。</p>
<p>但某几条核心查询开始变慢，而且慢得不稳定。</p>
<hr/>
<p>很多人第一反应是去看 <code>EXPLAIN</code>。结果更让人困惑。</p>
<p>在 MySQL 8 里，同一条 SQL 的执行计划，看起来反而比 5.7 更“合理”：</p>
<ul>
<li>用了看起来更合适的索引</li>
<li>访问行数更少</li>
<li>成本估算也更低</li>
</ul>
<p>但真实执行时间，就是慢。这类问题的根源，往往来自 MySQL 8 引入的新成本模型。</p>
<hr/>
<p>MySQL 8 对执行计划的选择，比 5.7 更依赖统计信息和代价估算。它会更积极地尝试不同索引路径，而不是像以前那样“走熟路”。</p>
<p>这意味着一件事：<strong>你以前“记住的经验”，在 8.x 里开始失效了。</strong></p>
<p>在 5.7 时代，很多人对执行计划有一种直觉：这条 SQL，大概一定会走这个索引。到了 8.0，这种确定性被打破了。</p>
<hr/>
<p>一个非常常见的现象是，同一条 SQL，在不同时间段走不同索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span>
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2024-01-01'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<p>在 5.7 下，它可能长期稳定地走 <code>(status, create_time)</code> 这个联合索引。</p>
<p>到了 8.0，有时会选择另一个单列索引，<code>EXPLAIN</code> 看起来也说得过去，但真实扫描行数明显增多。</p>
<p>问题在于：<strong>执行计划的选择，不再是你能轻易预测的结果。</strong></p>
<hr/>
<p>更隐蔽的一类坑，来自索引“看起来存在，但实际上没被用上”。MySQL 8 支持了函数索引，这是一个被很多人高估、也容易被误用的特性。有些团队在升级后，会主动把一些计算逻辑塞进索引里，比如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_day <span class="hljs-keyword">ON</span> <span class="hljs-keyword">order</span> ((<span class="hljs-type">DATE</span>(create_time)));
</code></pre>
<p>然后写出这样的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-type">DATE</span>(create_time) <span class="hljs-operator">=</span> <span class="hljs-string">'2024-06-01'</span>;
</code></pre>
<p>逻辑上看起来很完美。但在真实环境里，这类索引并不总是像你想象中那样生效，尤其是在排序规则、时区、隐式转换掺杂进来之后，执行计划很容易发生偏移。</p>
<hr/>
<p>还有一类更难察觉的问题，来自字符集和排序规则对索引的影响。在 MySQL 8 中，如果查询条件和索引列的 <code>collation</code> 不一致，即使字段名和类型完全相同，索引也可能被放弃。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span>
<span class="hljs-keyword">WHERE</span> nickname <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>;
</code></pre>
<p>当这个条件在不同连接、不同会话参数下执行时，走不走索引，可能完全不同。这类问题在 5.7 中不太常见，但在 8.0 里，出现频率明显更高。</p>
<hr/>
<p>最后一个让人头疼的现象，是“突然变慢，又突然恢复”。</p>
<p>MySQL 8 的统计信息更准确，但更新策略也不同了。在某些场景下，统计信息刷新之后，执行计划发生变化，性能立刻受到影响。更魔幻的是，重启数据库之后，问题可能暂时消失。</p>
<p>这类问题往往不是 bug，而是 <strong>统计信息、成本模型和真实数据分布之间的博弈</strong>。</p>
<hr/>
<h2 data-id="heading-4">五、窗口函数 / CTE：用对是神器，用错是性能杀手</h2>
<p>MySQL 8 真正让人产生“这是个新数据库了”这种感觉，往往不是前面的严格模式，而是窗口函数和 CTE 的出现。它们太好写了。</p>
<p>以前要靠子查询、临时表、甚至多次查询才能拼出来的结果，现在一条 SQL 就能搞定，结构清晰，可读性也极高。问题在于：<strong>好写，并不等于好跑</strong>。</p>
<hr/>
<p>很多人第一次用窗口函数，都是拿它来“替代 group by”。比如做排行榜、去重、取每组最新一条记录，很自然就会写出这样的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>,
         <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> user_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rn
  <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span>
) t
<span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>逻辑完全正确，结果也没问题。但当这条 SQL 跑在真实业务数据上时，问题才开始显现。</p>
<p>窗口函数的计算，是在<strong>结果集层面</strong>完成的。这意味着，在 <code>ROW_NUMBER</code> 生效之前，参与计算的数据已经被全部扫描、排序、分组。</p>
<p>数据量小的时候感觉不到，一旦表规模上来，执行成本会非常直接地反映在响应时间上。这类 SQL 的危险在于：<strong>你很难通过直觉判断它的复杂度</strong>。</p>
<hr/>
<p>另一个被严重误解的，是 CTE（WITH）。在很多人的认知里，CTE 就是“更优雅的临时表”。于是会写出结构非常漂亮的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> recent_order <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
  <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span>
  <span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>
)
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>
<span class="hljs-keyword">FROM</span> recent_order
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p>从可读性上说，这比嵌套子查询舒服太多。但在 MySQL 8 中，CTE 默认是<strong>非物化的</strong>。也就是说，它不是先算一次结果再复用，而是可能在执行过程中被多次展开、重复计算。当 CTE 被引用多次，或者嵌套进更复杂的查询里时，执行次数会迅速放大。</p>
<p>“写得很干净，但跑得很慢”，通常就出现在这里。</p>
<hr/>
<p>真正的问题并不是窗口函数和 CTE 本身，而是 <strong>它们让“复杂 SQL”变得过于容易书写</strong>。</p>
<p>在 5.7 时代，很多性能风险被写法本身挡住了。SQL 写得难，反而逼着你在设计阶段多想一步。</p>
<p>到了 8.0，这些约束消失了。你可以很快写出一条语义完整、结构优雅的 SQL，但是否适合在高并发、海量数据下执行，完全是另一回事。</p>
<hr/>
<p>不少团队在升级到 MySQL 8 之后，会不自觉地“重构 SQL”，把原本分散在应用层的逻辑，收拢进数据库里。这本身并不一定是坏 hookup，但如果缺乏对执行成本的判断，窗口函数和 CTE 会成为非常隐蔽的性能放大器。而它们一旦进入核心链路，排查难度会比普通慢 SQL 高很多。</p>
<hr/>
<h2 data-id="heading-5">六、隐藏很深的一类坑：系统表 &amp; 权限模型变化</h2>
<p>如果说前面的坑，多少还能通过业务现象慢慢暴露出来，那系统表和权限模型的变化，往往是<strong>升级当天就出问题感觉</strong>。</p>
<p>而且非常直接：脚本跑不通、工具连不上、应用账号突然没权限。</p>
<hr/>
<p>MySQL 8 对 <code>mysql</code> 库做了比较彻底的调整。在 5.7 时代，很多运维脚本、监控工具，甚至应用初始化逻辑，都会直接去查系统表。在 5.7 里，这是很常见、也很自然的做法。</p>
<p>比如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">user</span>, host <span class="hljs-keyword">FROM</span> mysql.user;
</code></pre>
<p>到了 MySQL 8，这类查询要么直接失败，要么返回结果和你预期的不一样。原因并不复杂：系统表结构被重构了，权限模型也随之调整，官方更希望你通过 <code>information_schema</code> 或专用视图来获取信息。问题在于，<strong>历史工具并不知道这件事</strong>。</p>
<hr/>
<p>这类问题经常出现在两个地方：</p>
<p>一是老的运维脚本。数据库升级了，脚本没动，结果第一天定时任务就开始报错。</p>
<p>二是第三方工具。监控、备份、审计、权限管理工具，如果版本不够新，很容易在 MySQL 8 上直接失效。</p>
<p>这种问题的定位过程通常非常低效，因为报错信息往往不指向“系统表变了”，而只是权限不足或者字段不存在。</p>
<hr/>
<p>权限模型的变化，比系统表更容易引发事故。MySQL 8 把权限拆得更细了，逻辑上更清晰，但配置成本也明显提高。一个在 5.7 里能正常工作的应用账号，迁移到 8.0 之后，可能会出现各种“奇怪的失败”：</p>
<ul>
<li>能连上库，但查不了表</li>
<li>能查表，但执行不了某些语句</li>
<li>在某些环境正常，在另一些环境直接报权限错误</li>
</ul>
<p>很多时候，并不是权限给少了，而是<strong>给错了位置</strong>。</p>
<hr/>
<p>更现实的问题是，“最小权限原则”在 MySQL 8 里反而更难落地。以前你可能直接给一个账号比较宽的权限，事情就结束了。现在权限粒度细了，角色、默认权限、动态权限一起上，稍有疏忽就会遗漏关键能力。而这些问题，大多数不会在测试阶段暴露，因为测试环境的账号往往权限更宽。等到生产切换时，问题才集中出现。</p>
<hr/>
<p>这一类坑有一个共同特点：<strong>它们几乎和业务无关，但能直接影响业务是否可用</strong>。很多升级事故，并不是 SQL 写错、索引没建，而是一些看似“外围”的东西没跟上。而真正让升级过程变得可控的，往往不是多看几篇文档，而是<strong>升级姿势本身是否正确</strong>。</p>
<hr/>
<h2 data-id="heading-6">七、生产升级 MySQL 8，真正靠谱的姿势</h2>
<p>如果前面那些坑已经看得差不多了，其实会自然得出一个结论： <strong>MySQL 8 的升级，不是一个“点升级”，而是一次系统性迁移。</strong></p>
<p>也正因为这样，最不靠谱的做法，反而是很多人下意识会选的那种。</p>
<hr/>
<p>最需要明确的一件事是：<strong>不要对生产库做 in-place 升级。</strong></p>
<p>理论上可行，文档也支持，但现实中，一旦出问题，几乎没有回旋空间。</p>
<p>升级过程中一旦发现排序异常、SQL 报错、性能不符合预期，你能做的选择非常有限。回滚成本高，窗口期短，所有风险都被压缩到一次操作里。</p>
<p>真正可控的方式，反而显得“笨”一些：逻辑备份 → 新实例恢复 → 应用灰度切换。</p>
<p>这个过程看起来繁琐，但它给了你一个非常关键的能力：<strong>随时停下来观察系统行为</strong>。</p>
<hr/>
<p>在真正切流量之前，有几件事是绕不开的。</p>
<h3 data-id="heading-7">1. SQL 模式检查。</h3>
<p>不要等报错再去改 SQL。在升级前，把生产库当前的 SQL 模式拉出来，对照 MySQL 8 的默认配置，把会被卡住的语句提前找出来。哪怕只是统计一下 <code>ONLY_FULL_GROUP_BY</code> 相关的报错数量，都会比上线后手忙脚乱强得多。</p>
<p>可以在 <strong>测试环境的 MySQL 5.7</strong> 上，<strong>主动打开 MySQL 8 的严格模式</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">SET GLOBAL <span class="hljs-attr">sql_mode</span> =
'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO'<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">2. 执行计划对比。</h3>
<p>不要只在 8.0 环境里看 <code>EXPLAIN</code>，要拿同一条 SQL，在 5.7 和 8.0 里同时跑。</p>
<p>重点不是“哪个看起来更优雅”，而是：<strong>哪些 SQL 的执行路径发生了变化</strong>。</p>
<p>这一步做完，往往能提前锁定那一小撮“未来一定会出问题”的查询。</p>
<hr/>
<h3 data-id="heading-9">3. 扫描字符集和排序规则。</h3>
<p>直接查找表的元数据：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT
  TABLE_SCHEMA,
  TABLE_NAME,
  COLUMN_NAME,
  CHARACTER_SET_NAME,
  COLLATION_NAME
FROM information_schema.COLUMNS
WHERE <span class="hljs-attr">TABLE_SCHEMA</span> = <span class="hljs-string">'your_db'</span><span class="hljs-comment">;</span>
​
</code></pre>
<p>不是解释规则，而是找不一致。哪些表、哪些字段，在不同环境里 <code>charset</code> 或 <code>collation</code> 不一样；哪些历史表是旧规则，新表是新规则。</p>
<p>这些差异，短期内可能没事，但它们几乎一定会在某个时间点爆出来。</p>
<hr/>
<h3 data-id="heading-10">4. 检查索引长度和索引使用情况。</h3>
<p>提前在 8.x 实例里跑建表 / 建索引脚本，同时用<code>show index</code>语句对比，特别注意一下几个问题：</p>
<ul>
<li><code>varchar</code> 较长的索引</li>
<li>联合索引里包含字符串字段的</li>
<li>曾经“刚好能建出来”的索引</li>
</ul>
<p>MySQL 8 对这些地方的容忍度更低，而索引一旦发生变化，影响的通常是核心查询。</p>
<hr/>
<h3 data-id="heading-11">5. 线上真实压测</h3>
<p>最后一件，也是最容易被低估的一件： <strong>关键 SQL 的真实压测。</strong></p>
<p>不是跑跑接口，而是针对最重的那几条 SQL，在接近真实数据量的情况下，单独压。很多 MySQL 8 的问题，只会在数据规模上来之后才出现。你真正要做的，是： 服务端先升级 MySQL 驱动 → 同时连 5.7 和 8.x → 做对比压测</p>
<p><strong>不建议</strong>把 <strong>8.x 当 5.7 的从库</strong> 来承担这一步的核心验证。8.x 从 5.7 拉数据可以做，但它<strong>不能替代压测</strong>。</p>
<hr/>
<p>真正切到 MySQL 8 之后，第一周要盯的东西，其实也很明确。</p>
<p>慢 SQL 是最直观的信号。排序异常往往藏在业务反馈里。错误日志里出现的“以前从没见过的报错”，几乎都值得认真看一眼。</p>
<p>这一周不是为了“证明升级成功”，而是为了确认：<strong>有没有什么被你低估的变化，正在悄悄发生。</strong></p>
<hr/>
<p>走到这一步，其实已经能感觉出来了：MySQL 8 的升级，从来不是一个“技术动作”，而更像一次<strong>使用方式的切换</strong>。</p>
<hr/>
<h2 data-id="heading-12">八、MySQL 8 不是“新版本”，而是“新阶段”</h2>
<p>如果只是把 MySQL 8 当成一个“功能更多、规则更严”的版本，其实很容易产生误判。因为从使用体验上看，很多变化并不体现在新特性，而体现在<strong>旧习惯开始失效</strong>。</p>
<p>以前你可以写一条语义不完整的 SQL，数据库会帮你选一个“差不多能用”的结果；以前你可以默认排序是稳定的；以前你可以混着类型比、靠隐式转换走索引。</p>
<p>这些并不是能力，而是一种长期存在的宽容。MySQL 8 做的事情，其实很明确：它在逐步收回这种宽容。</p>
<hr/>
<p>从这个角度看，很多所谓的“升级踩坑”，并不是因为 MySQL 8 引入了问题，而是它<strong>不再替你掩盖问题</strong>。</p>
<p>字符集和排序规则暴露的是历史数据和新规则之间的不一致；严格 SQL 模式暴露的是语义模糊的查询；更激进的优化器暴露的是对执行计划的过度依赖；窗口函数和 CTE 暴露的是把复杂度一股脑推给数据库的冲动。</p>
<p>这些问题，在 5.7 时代并不是不存在，只是被时间和默认行为暂时压住了。</p>
<hr/>
<p>某种意义上，MySQL 8 更像是 MySQL 从“工具型数据库”走向“工程级数据库”的分水岭。</p>
<p>它开始假设：</p>
<ul>
<li>你知道自己在写什么</li>
<li>你能为 SQL 的语义负责</li>
<li>你会为执行成本买单</li>
</ul>
<p>这对团队的要求更高，但也更真实。</p>
<hr/>
<p>所以回头再看“要不要升级 MySQL 8”这个问题，本身就有点站不住脚。</p>
<p>真正的问题不是：<strong>MySQL 8 会不会坑我？</strong></p>
<p>而是：<strong>我现在这套 SQL 和数据模型，配不配得上一个不再兜底的数据库？</strong></p>
<p>升级之后，你可能不会立刻得到“更快”的系统，但你一定会更早看见问题。而能更早看见问题，本身就是一种优势。</p>
<p>升级 MySQL 8，真正要升级的，从来不只是数据库，而是我们对 SQL 的敬畏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解码RAG之心，为什么向量数据库是其核心引擎]]></title>    <link>https://juejin.cn/post/7599088558167310382</link>    <guid>https://juejin.cn/post/7599088558167310382</guid>    <pubDate>2026-01-26T03:12:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599088558167310382" data-draft-id="7599181528303927305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解码RAG之心，为什么向量数据库是其核心引擎"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T03:12:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="smallyoung"/> <meta itemprop="url" content="https://juejin.cn/user/4373200861407227"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解码RAG之心，为什么向量数据库是其核心引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4373200861407227/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    smallyoung
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:12:48.000Z" title="Mon Jan 26 2026 03:12:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21aeb07f83794894be2e8747fb63f616~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=%2BhkjnGhVZ0VD75lJnCxkUJs68xs%3D" alt="为什么 RAG 要使用向量数据库" loading="lazy"/></p>
<h2 data-id="heading-0">1. 先问问题：RAG 到底需要什么能力？</h2>
<p>在讲向量数据库之前，我们先思考一个问题：</p>
<blockquote>
<p><strong>RAG 系统的核心需求是什么？</strong></p>
</blockquote>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）的工作流程可以简化为：</p>
<pre><code class="hljs">用户问题 → 【在知识库中找到相关内容】 → 把内容给 LLM → 生成答案
</code></pre>
<p>关键在于中间那一步：<strong>如何在知识库中找到"真正相关"的内容？</strong></p>
<h3 data-id="heading-1">1.1 两种搜索方式的对比</h3>

























<table><thead><tr><th>用户问题</th><th>传统关键词搜索</th><th>理想的语义搜索</th></tr></thead><tbody><tr><td>"AI 是什么？"</td><td>只能找到包含"AI"两个字母的文档</td><td>能找到"人工智能"、"机器学习"相关文档</td></tr><tr><td>"苹果公司市值"</td><td>可能匹配到"苹果营养价值"</td><td>只匹配科技公司相关内容</td></tr><tr><td>"手机卡顿怎么办"</td><td>找不到"设备性能优化指南"</td><td>能理解这是同一个问题</td></tr></tbody></table>
<p><strong>结论</strong>：RAG 需要的是<strong>语义搜索</strong>——理解问题的"含义"，而不是匹配字面关键词。</p>
<h3 data-id="heading-2">1.2 核心问题</h3>
<blockquote>
<p><strong>问题</strong>：传统数据库（MySQL、PostgreSQL）只能做关键词匹配，无法理解语义。那怎么实现语义搜索呢？</p>
<p><strong>答案</strong>：先把文本转成向量（Embedding），然后用向量数据库做相似度搜索。</p>
</blockquote>
<p>这就是 RAG 必须使用向量数据库的根本原因。</p>
<p>接下来，我们一步步解释：什么是向量？什么是 Embedding？相似度搜索是怎么回事？</p>
<h2 data-id="heading-3">2. 什么是向量？</h2>
<p>要理解向量数据库，首先要理解最基础的概念：<strong>向量</strong>。</p>
<h3 data-id="heading-4">2.1 向量的直观定义</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1fe8708855c42eaa6202d3d364602a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=1P0QAV8e1Lh8ZKLOiih07a8buqU%3D" alt="万物皆可向量化" loading="lazy"/></p>
<p><strong>向量就是一组有序的数字</strong>。就这么简单。</p>
<pre><code class="hljs language-scss" lang="scss">向量例子：
<span class="hljs-selector-attr">[3, 4]</span>
<span class="hljs-selector-attr">[0.5, 0.8, 0.2]</span>
<span class="hljs-selector-attr">[0.23, -0.15, 0.87, 0.42, ..., 0.31]</span>  (可能有几百上千个数字)
</code></pre>
<p>你可以把向量想象成<strong>描述一个东西的"特征列表"</strong>：</p>

























<table><thead><tr><th>现实场景</th><th>向量表示</th><th>含义</th></tr></thead><tbody><tr><td>地图坐标</td><td>[120.5, 31.2]</td><td>经度 120.5°，纬度 31.2°</td></tr><tr><td>RGB 颜色</td><td>[255, 0, 0]</td><td>红色分量 255，绿色 0，蓝色 0（纯红色）</td></tr><tr><td>学生成绩</td><td>[85, 92, 78]</td><td>语文 85，数学 92，英语 78</td></tr></tbody></table>
<blockquote>
<p>[!NOTE]
<strong>关键概念</strong>：向量的<strong>维度</strong>就是数字的个数。[3, 4] 是 2 维向量，[85, 92, 78] 是 3 维向量。后面你会看到，Embedding 模型通常生成 768~3072 维的向量。</p>
</blockquote>
<h3 data-id="heading-5">2.2 向量的几何意义</h3>
<p><strong>向量可以看作空间中的一个"点"</strong>。</p>
<p>以 2 维向量为例：</p>
<ul>
<li>向量 A = [3, 4] → 在平面上就是坐标 (3, 4) 的点</li>
<li>向量 B = [4, 3] → 在平面上就是坐标 (4, 3) 的点</li>
</ul>
<p>两个点之间可以计算<strong>距离</strong>——距离越近，表示它们越"相似"。</p>
<p>这个简单的数学原理，就是向量数据库能够实现"相似搜索"的基础！</p>
<h2 data-id="heading-6">3. 什么是 Embedding？</h2>
<p>现在问题来了：<strong>文本不是数字，怎么变成向量？</strong></p>
<p>答案是：使用 <strong>Embedding（嵌入）模型</strong>。</p>
<h3 data-id="heading-7">3.1 Embedding 的核心思想</h3>
<p><strong>Embedding = 把任意内容（文本、图片、音频）转换成向量的技术</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["文本: 我喜欢吃苹果"] --&gt; B[Embedding 模型]
    B --&gt; C["向量: [0.23, -0.15, 0.87, ...]"]
</code></pre>
<p>以文本为例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码演示</span>
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
client = OpenAI()

text = <span class="hljs-string">"我喜欢吃苹果"</span>
response = client.embeddings.create(<span class="hljs-built_in">input</span>=text, model=<span class="hljs-string">"text-embedding-3-small"</span>)
vector = response.data[<span class="hljs-number">0</span>].embedding

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(vector))  <span class="hljs-comment"># 输出：1536（这就是向量的维度）</span>
<span class="hljs-built_in">print</span>(vector[:<span class="hljs-number">5</span>])   <span class="hljs-comment"># 输出：[0.023, -0.156, 0.087, 0.421, -0.089]</span>
</code></pre>
<h3 data-id="heading-8">3.2 Embedding 的神奇之处</h3>
<p>Embedding 模型经过大量数据训练后，学会了一个惊人的能力：</p>
<blockquote>
<p><strong>语义相近的文本，会被映射到向量空间中相近的位置。</strong></p>
</blockquote>
<p>举一个具体例子：</p>

























<table><thead><tr><th>文本</th><th>向量（简化示意）</th><th>与"我喜欢吃苹果"的距离</th></tr></thead><tbody><tr><td>"我喜欢吃苹果"</td><td>[0.8, 0.2, 0.1, ...]</td><td>0（自己）</td></tr><tr><td>"我爱吃水果"</td><td>[0.75, 0.25, 0.12, ...]</td><td><strong>0.05</strong>（非常近！语义相似）</td></tr><tr><td>"今天天气真好"</td><td>[0.1, 0.6, 0.9, ...]</td><td><strong>0.89</strong>（很远，语义不同）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 语义空间示意
        A["我喜欢吃苹果 ●"] --- B["我爱吃水果 ●"]
        C["今天天气真好 ○"]
    end
    
    style A fill:#e3f2fd
    style B fill:#e3f2fd
    style C fill:#ffebee
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b1de5df1f074aa0889bd82b93fb2024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=IGnqclrKIVR1oxDimiJDckB1bI0%3D" alt="Embedding 的核心思想" loading="lazy"/></p>
<blockquote>
<p>[!IMPORTANT]
<strong>核心公式</strong>：Embedding 的本质是一个函数 <code>f(text) → vector</code>，它把文本映射到高维空间，使得<strong>语义相似的文本在空间中距离更近</strong>。这是 RAG 能够"理解语义"的根本原理。</p>
</blockquote>
<h3 data-id="heading-9">3.3 为什么 Embedding 能捕捉语义？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957779f2ec334e2fb4ad17332dd0388c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=6hgL%2BCTiv1lL79r93Le5Mi3ByTY%3D" alt="为什么 Embedding 能捕捉语义" loading="lazy"/></p>
<p>Embedding 模型（如 BERT、GPT）是通过<strong>海量文本数据训练</strong>出来的。</p>
<p>训练过程中，模型学习到：</p>
<ul>
<li>"苹果"和"水果"经常出现在相似的语境中</li>
<li>"喜欢"和"爱"表达相似的情感</li>
<li>因此它们的向量应该相近</li>
</ul>
<p>这就像一个读过几百亿本书的人，自然理解了词语之间的关系。</p>
<h3 data-id="heading-10">3.4 更直观的类比：Embedding 在学什么？</h3>
<p>想象你是一个读了几百亿本书的人：</p>
<ul>
<li>当你看到"苹果公司"，你会联想到：科技、iPhone、硅谷</li>
<li>当你看到"吃苹果"，你会联想到：水果、健康、营养</li>
</ul>
<p>虽然都有"苹果"两个字，但你的大脑会把它们放在完全不同的"概念区域"。</p>
<p><strong>Embedding 模型做的就是同样的事情</strong>——通过阅读海量文本，学会了把：</p>
<ul>
<li>相似语境的词放在向量空间的<strong>相近位置</strong></li>
<li>不同语境的同一个词放在<strong>不同位置</strong></li>
</ul>
<blockquote>
<p>[!TIP]
<strong>一句话总结</strong>：Embedding 不是简单的"翻译"，而是把文本的"意思"编码成了向量空间中的"位置"。</p>
</blockquote>
<h2 data-id="heading-11">4. 主流 Embedding 模型与向量维度</h2>
<p>不同的 Embedding 模型生成的向量维度不同。<strong>维度越高，通常能捕捉越丰富的语义信息，但也需要更多存储空间和计算资源</strong>。</p>
<h3 data-id="heading-12">4.1 主流 Embedding 模型对比（2024）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d00554260849848546a230073262b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=C0ESxUvBjB%2FopZ36jBkiLj6NycU%3D" alt="模型对比" loading="lazy"/></p>

























































































<table><thead><tr><th>厂商</th><th>模型名称</th><th>向量维度</th><th>特点</th></tr></thead><tbody><tr><td><strong>OpenAI</strong></td><td>text-embedding-3-small</td><td>1536 维</td><td>性价比高，支持动态降维到 512 维</td></tr><tr><td><strong>OpenAI</strong></td><td>text-embedding-3-large</td><td>3072 维</td><td>最高精度，支持降维到 256/1024 维</td></tr><tr><td><strong>OpenAI</strong></td><td>text-embedding-ada-002</td><td>1536 维</td><td>上一代模型，仍广泛使用</td></tr><tr><td><strong>BAAI</strong></td><td>BGE-large-zh-v1.5</td><td>1024 维</td><td>中文最佳开源模型之一</td></tr><tr><td><strong>BAAI</strong></td><td>BGE-M3</td><td>1024 维</td><td>多语言、多功能</td></tr><tr><td><strong>Cohere</strong></td><td>Embed English v3</td><td>1024 维</td><td>企业级英文模型</td></tr><tr><td><strong>Cohere</strong></td><td>Embed v4</td><td>1536 维</td><td>最新多模态模型</td></tr><tr><td><strong>Jina AI</strong></td><td>jina-embeddings-v3</td><td>1024 维</td><td>支持 8K 长文本，可降维到 32 维</td></tr><tr><td><strong>Jina AI</strong></td><td>jina-embeddings-v2-base</td><td>768 维</td><td>基础版本</td></tr><tr><td><strong>Voyage AI</strong></td><td>voyage-3</td><td>1024 维</td><td>检索质量优秀</td></tr><tr><td><strong>Voyage AI</strong></td><td>voyage-3-large</td><td>2048 维</td><td>支持降维到 256/512/1024 维</td></tr><tr><td><strong>Voyage AI</strong></td><td>voyage-3-lite</td><td>512 维</td><td>轻量版，速度快</td></tr><tr><td><strong>Google</strong></td><td>Gemini text-embedding-004</td><td>768 维</td><td>Google 最新模型</td></tr></tbody></table>
<blockquote>
<p>[!TIP]
<strong>选型建议</strong>：</p>
<ul>
<li><strong>中文场景</strong>：优先考虑 BGE 系列（开源免费）或 OpenAI text-embedding-3</li>
<li><strong>英文场景</strong>：OpenAI、Cohere、Voyage AI 都是优秀选择</li>
<li><strong>成本敏感</strong>：使用支持"动态降维"的模型（如 text-embedding-3），降低存储成本</li>
</ul>
</blockquote>
<h3 data-id="heading-13">4.2 向量维度的影响</h3>









































<table><thead><tr><th>维度</th><th>单向量存储</th><th>100 万向量存储</th><th>精度</th></tr></thead><tbody><tr><td>512 维</td><td>~2 KB</td><td>~2 GB</td><td>中等</td></tr><tr><td>768 维</td><td>~3 KB</td><td>~3 GB</td><td>较高</td></tr><tr><td>1024 维</td><td>~4 KB</td><td>~4 GB</td><td>高</td></tr><tr><td>1536 维</td><td>~6 KB</td><td>~6 GB</td><td>很高</td></tr><tr><td>3072 维</td><td>~12 KB</td><td>~12 GB</td><td>最高</td></tr></tbody></table>
<h2 data-id="heading-14">5. 相似度计算：向量如何比较"像不像"？</h2>
<p>有了向量，下一步就是计算它们之间有多"相似"。</p>
<h3 data-id="heading-15">5.1 余弦相似度（Cosine Similarity）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe64198d9524e13ba8e18715a95a864~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=pSLqcu7nuujC7FoXoFBB6f0w8v4%3D" alt="宇宙中的“引力”" loading="lazy"/></p>
<p><strong>余弦相似度</strong>是最常用的相似度指标，它测量两个向量<strong>方向</strong>上的相似程度。</p>
<pre><code class="hljs language-css" lang="css">余弦相似度 = cos(θ) = (<span class="hljs-selector-tag">A</span> · <span class="hljs-selector-tag">B</span>) / (|<span class="hljs-selector-tag">A</span>| × |<span class="hljs-selector-tag">B</span>|)

其中：
- <span class="hljs-selector-tag">A</span> · <span class="hljs-selector-tag">B</span> 是向量点积（对应元素相乘再求和）
- |<span class="hljs-selector-tag">A</span>| 是向量 <span class="hljs-selector-tag">A</span> 的长度（模）
- θ 是两个向量的夹角
</code></pre>
<p><strong>直观理解</strong>：</p>

























<table><thead><tr><th>余弦值</th><th>夹角</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>0°</td><td>方向完全相同，最相似</td></tr><tr><td>0</td><td>90°</td><td>完全正交，不相关</td></tr><tr><td>-1</td><td>180°</td><td>方向完全相反</td></tr></tbody></table>
<h3 data-id="heading-16">5.2 实际计算示例</h3>
<p>假设有两个简化的 3 维向量：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span> = <span class="hljs-selector-attr">[1, 2, 3]</span>
<span class="hljs-selector-tag">B</span> = <span class="hljs-selector-attr">[2, 4, 6]</span>

计算步骤：
<span class="hljs-number">1</span>. 点积：<span class="hljs-selector-tag">A</span> · <span class="hljs-selector-tag">B</span> = <span class="hljs-number">1</span>×<span class="hljs-number">2</span> + <span class="hljs-number">2</span>×<span class="hljs-number">4</span> + <span class="hljs-number">3</span>×<span class="hljs-number">6</span> = <span class="hljs-number">2</span> + <span class="hljs-number">8</span> + <span class="hljs-number">18</span> = <span class="hljs-number">28</span>
<span class="hljs-number">2</span>. <span class="hljs-selector-tag">A</span> 的长度：|<span class="hljs-selector-tag">A</span>| = √(<span class="hljs-number">1</span>² + <span class="hljs-number">2</span>² + <span class="hljs-number">3</span>²) = √<span class="hljs-number">14</span> ≈ <span class="hljs-number">3.74</span>
<span class="hljs-number">3</span>. <span class="hljs-selector-tag">B</span> 的长度：|<span class="hljs-selector-tag">B</span>| = √(<span class="hljs-number">2</span>² + <span class="hljs-number">4</span>² + <span class="hljs-number">6</span>²) = √<span class="hljs-number">56</span> ≈ <span class="hljs-number">7.48</span>
<span class="hljs-number">4</span>. 余弦相似度 = <span class="hljs-number">28</span> / (<span class="hljs-number">3.74</span> × <span class="hljs-number">7.48</span>) ≈ <span class="hljs-number">1.0</span>
</code></pre>
<p>结果为 1.0，说明 A 和 B <strong>完全相似</strong>（其实 B = 2×A，方向完全一致）。</p>
<blockquote>
<p>[!NOTE]
<strong>为什么用余弦而不是直接比较数字？</strong></p>
<p>余弦相似度<strong>忽略向量的"长度"，只关注"方向"</strong>。这正好符合我们的需求：判断语义是否相似，而不是文本长度是否相同。</p>
</blockquote>
<h2 data-id="heading-17">6. 把它们连起来：RAG 的完整工作原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c414b85d719454ca1a07e20113e132f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=S4p%2BJ18aQIAlkUn7QVMcLxBT1DY%3D" alt="完整工作流" loading="lazy"/></p>
<p>现在我们已经理解了所有基础概念，可以把它们串起来，看 RAG 是如何工作的。</p>
<h3 data-id="heading-18">6.1 RAG 的两个阶段</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 离线阶段["离线阶段：建立知识库"]
        A[原始文档] --&gt; B[切分成小块]
        B --&gt; C[Embedding 模型]
        C --&gt; D[向量]
        D --&gt; E[(向量数据库)]
    end
    
    subgraph 在线阶段["在线阶段：回答问题"]
        F[用户问题] --&gt; G[Embedding 模型]
        G --&gt; H[问题向量]
        H --&gt; I{相似度搜索}
        E --&gt; I
        I --&gt; J[Top-K 相似文档]
        J --&gt; K[拼接到 Prompt]
        K --&gt; L[LLM 生成回答]
    end
</code></pre>
<blockquote>
<p>[!NOTE]
<strong>什么是 Top-K？</strong></p>
<p>Top-K 指的是返回<strong>最相似的 K 条结果</strong>。比如 Top-3 就是返回相似度最高的 3 个文档块。</p>
<ul>
<li><strong>K 太小</strong>（如 1-2）：可能漏掉相关内容</li>
<li><strong>K 太大</strong>（如 20+）：可能引入无关噪音，浪费 Token</li>
<li><strong>常用范围</strong>：3~10，根据具体场景调优</li>
</ul>
</blockquote>
<h3 data-id="heading-19">6.2 为什么必须用向量数据库？</h3>



































<table><thead><tr><th>步骤</th><th>需要的能力</th><th>传统数据库</th><th>向量数据库</th></tr></thead><tbody><tr><td>存储 Embedding</td><td>存储高维向量（768~3072维）</td><td>❌ 不支持</td><td>✅ 原生支持</td></tr><tr><td>相似度搜索</td><td>计算余弦/欧氏距离</td><td>❌ 不支持</td><td>✅ 核心功能</td></tr><tr><td>语义匹配</td><td>理解"AI"≈"人工智能"</td><td>❌ 只能关键词</td><td>✅ 基于向量距离</td></tr><tr><td>大规模检索</td><td>亿级向量毫秒响应</td><td>❌ 性能差</td><td>✅ ANN 算法优化</td></tr></tbody></table>
<p><strong>结论</strong>：向量数据库 = Embedding 存储 + 相似度搜索 + 高效索引，这三者缺一不可，而传统数据库都不支持。</p>
<h2 data-id="heading-20">7. 文档分块（Chunking）：被忽视的关键步骤</h2>
<p>在 RAG 流程图中有一步"切分成小块"，这一步叫做 <strong>Chunking（分块）</strong>，是初学者最容易忽视但又极其重要的环节。</p>
<h3 data-id="heading-21">7.1 为什么需要分块？</h3>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>Token 限制</strong></td><td>LLM 有上下文长度限制（如 4K、8K、128K），不能一次塞入整本书</td></tr><tr><td><strong>语义精度</strong></td><td>太长的文本向量会"稀释"语义，导致检索不精准</td></tr><tr><td><strong>检索粒度</strong></td><td>用户问的是具体问题，需要找到具体的段落而不是整篇文章</td></tr></tbody></table>
<h3 data-id="heading-22">7.2 分块策略对比</h3>



































<table><thead><tr><th>策略</th><th>方法</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>固定长度</strong></td><td>每 500 字切一块</td><td>简单易实现</td><td>可能切断句子</td></tr><tr><td><strong>按句子/段落</strong></td><td>按自然段落分割</td><td>语义完整</td><td>长度不均匀</td></tr><tr><td><strong>重叠分块</strong></td><td>相邻块有 50-100 字重叠</td><td>防止信息丢失</td><td>增加存储成本</td></tr><tr><td><strong>语义分块</strong></td><td>用模型判断语义边界</td><td>效果最好</td><td>计算成本高</td></tr></tbody></table>
<h3 data-id="heading-23">7.3 常用分块参数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 常见的分块配置</span>
chunk_size = <span class="hljs-number">512</span>      <span class="hljs-comment"># 每块 512 个 token（约 300-400 中文字）</span>
chunk_overlap = <span class="hljs-number">50</span>    <span class="hljs-comment"># 相邻块重叠 50 个 token</span>
</code></pre>
<blockquote>
<p>[!IMPORTANT]
<strong>分块大小直接影响检索效果</strong>：</p>
<ul>
<li><strong>太小</strong>（如 100 字）：上下文不完整，LLM 无法理解</li>
<li><strong>太大</strong>（如 2000 字）：语义被稀释，检索不精准</li>
<li><strong>推荐起点</strong>：256~512 tokens，根据实际效果调优</li>
</ul>
</blockquote>
<h2 data-id="heading-24">8. 检索类型：稀疏 vs 密集 vs 混合</h2>
<p>除了本文重点讲的向量检索（密集检索），还有其他检索方式。了解它们的区别有助于在实际项目中做出更好的选择。</p>
<h3 data-id="heading-25">8.1 三种检索方式对比</h3>

































<table><thead><tr><th>类型</th><th>方法</th><th>代表算法</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>稀疏检索</strong></td><td>关键词匹配</td><td>BM25、TF-IDF</td><td>精确匹配强、速度快</td><td>无法理解同义词</td></tr><tr><td><strong>密集检索</strong></td><td>向量相似度</td><td>Embedding</td><td>语义理解强</td><td>可能丢失精确匹配</td></tr><tr><td><strong>混合检索</strong></td><td>两者结合</td><td>Hybrid Search</td><td>兼顾精确+语义</td><td>复杂度略高</td></tr></tbody></table>
<h3 data-id="heading-26">8.2 实际案例对比</h3>
<p>用户搜索："Python 3.12 新特性"</p>

























<table><thead><tr><th>检索方式</th><th>能否找到</th></tr></thead><tbody><tr><td>稀疏检索</td><td>✅ 精确匹配 "Python 3.12"</td></tr><tr><td>密集检索</td><td>✅ 能找到语义相关的 "Python 最新版本功能"</td></tr><tr><td>稀疏检索</td><td>❌ 找不到 "Python 最新版本功能"（没有关键词匹配）</td></tr><tr><td>密集检索</td><td>⚠️ 可能漏掉必须包含 "3.12" 的精确需求</td></tr></tbody></table>
<h3 data-id="heading-27">8.3 实际生产建议</h3>
<blockquote>
<p>[!TIP]
<strong>实际项目中，混合检索（Hybrid Search）往往效果最好</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">最终得分 = α × 向量相似度 + (<span class="hljs-number">1</span>-α) × BM25 分数
</code></pre>
<p>其中 α 通常设为 0.5~0.7，可根据场景调优。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/889ddcc1118241c49e798ced5632562a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=IYAKKCI%2FooWwjWMlEicmjYAQ68U%3D" alt="两全其美：混合检索" loading="lazy"/></p>
<h2 data-id="heading-28">9. 主流向量数据库对比（2024）</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bb84b3f82c844c1b668d53de8a792c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=2uvaE8qcF%2BA%2FE5YYGjr41G5U3Co%3D" alt="向量数据库星图" loading="lazy"/></p>
<h3 data-id="heading-29">7.1 开源向量数据库</h3>















































<table><thead><tr><th>产品</th><th>开发语言</th><th>向量规模</th><th>核心特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Milvus</strong></td><td>Go/C++</td><td>万亿级</td><td>分布式架构，功能最全面，支持多向量</td><td>大规模企业级部署</td></tr><tr><td><strong>Qdrant</strong></td><td>Rust</td><td>十亿级</td><td>性能极高，元数据过滤强大</td><td>高性能搜索、边缘部署</td></tr><tr><td><strong>Weaviate</strong></td><td>Go</td><td>十亿级</td><td>AI 原生，GraphQL API，模块化强</td><td>知识图谱、复杂查询</td></tr><tr><td><strong>Chroma</strong></td><td>Python</td><td>百万级</td><td>轻量简单，5 分钟上手</td><td>原型开发、学习实验</td></tr><tr><td><strong>pgvector</strong></td><td>C</td><td>千万级</td><td>PostgreSQL 扩展，无需新增组件</td><td>已有 PG 技术栈的项目</td></tr></tbody></table>
<h3 data-id="heading-30">7.2 云托管向量数据库</h3>



































<table><thead><tr><th>产品</th><th>核心特点</th><th>定价模式</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Pinecone</strong></td><td>全托管，开箱即用，Serverless 架构</td><td>按向量数量+查询量计费</td><td>快速上线，不想运维</td></tr><tr><td><strong>Zilliz Cloud</strong></td><td>Milvus 商业版，企业级 SLA</td><td>按资源用量计费</td><td>需要 Milvus 但不想自建</td></tr><tr><td><strong>Weaviate Cloud</strong></td><td>托管版 Weaviate</td><td>按节点计费</td><td>需要 Weaviate 特性</td></tr><tr><td><strong>Qdrant Cloud</strong></td><td>托管版 Qdrant，支持混合云</td><td>按资源计费</td><td>需要高性能+隐私保护</td></tr></tbody></table>
<h3 data-id="heading-31">9.3 向量数据库选型指南</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始选型] --&gt; B{数据规模?}
    B --&gt;|&lt; 100 万| C{是否需要快速上手?}
    B --&gt;|100 万 ~ 10 亿| D{是否需要全托管?}
    B --&gt;|&gt; 10 亿| E[Milvus 分布式]
    
    C --&gt;|是| F[Chroma]
    C --&gt;|否，需要生产级| G{已有 PostgreSQL?}
    G --&gt;|是| H[pgvector]
    G --&gt;|否| I[Qdrant]
    
    D --&gt;|是| J[Pinecone / Zilliz Cloud]
    D --&gt;|否，自建| K{需要复杂查询?}
    K --&gt;|是| L[Weaviate]
    K --&gt;|否，追求性能| M[Qdrant / Milvus]
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da99d4b0b4fc45c5ba8c0f397ae8dad7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=UZEQuOUdIHmGGMYYp9zoe88HEy8%3D" alt="如何选择" loading="lazy"/></p>
<h3 data-id="heading-32">9.4 各数据库性能特点</h3>





























































<table><thead><tr><th>对比维度</th><th>Milvus</th><th>Qdrant</th><th>Weaviate</th><th>Chroma</th><th>Pinecone</th></tr></thead><tbody><tr><td><strong>最大规模</strong></td><td>万亿级</td><td>十亿级</td><td>十亿级</td><td>百万级</td><td>十亿级</td></tr><tr><td><strong>查询延迟</strong></td><td>极低</td><td>极低</td><td>低</td><td>中</td><td>低</td></tr><tr><td><strong>元数据过滤</strong></td><td>✅ 优秀</td><td>✅ 最强</td><td>✅ 优秀</td><td>✅ 基础</td><td>✅ 良好</td></tr><tr><td><strong>混合搜索</strong></td><td>✅ 支持</td><td>✅ 支持</td><td>✅ 支持</td><td>❌ 有限</td><td>✅ 支持</td></tr><tr><td><strong>运维复杂度</strong></td><td>高</td><td>中</td><td>中</td><td>低</td><td>无（托管）</td></tr><tr><td><strong>开源/商业</strong></td><td>开源</td><td>开源</td><td>开源</td><td>开源</td><td>商业</td></tr></tbody></table>
<h2 data-id="heading-33">10. 向量数据库如何实现高效搜索？</h2>
<p>当你有 1 亿个向量时，如何在毫秒内找到最相似的 K 个？</p>
<h3 data-id="heading-34">8.1 暴力搜索的问题</h3>
<p>最简单的方法：和每个向量都算一遍相似度，然后排序。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 暴力搜索（伪代码）</span>
similarities = []
<span class="hljs-keyword">for</span> doc_vector <span class="hljs-keyword">in</span> all_vectors:  <span class="hljs-comment"># 1亿次循环！</span>
    sim = cosine_similarity(query_vector, doc_vector)
    similarities.append(sim)
    
top_k = <span class="hljs-built_in">sorted</span>(similarities)[:k]
</code></pre>
<p><strong>问题</strong>：1 亿向量 × 1024 维 × 相似度计算 = <strong>几十秒甚至几分钟</strong>。用户等不起！</p>
<h3 data-id="heading-35">8.2 ANN 算法：近似但快速</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393685a0893e4bc8b3ed7f4c63da8e7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=usRUlP4XpNlyxIzZUFD%2BgnSQ0v8%3D" alt="毫秒级响应的密码" loading="lazy"/></p>
<p>向量数据库使用 <strong>ANN（Approximate Nearest Neighbor，近似最近邻）</strong> 算法。</p>
<p>核心思想：<strong>不需要找到绝对最相似的，找到足够相似的就行</strong>。</p>
<p>用一个生活类比：</p>
<blockquote>
<p>你要在图书馆找一本关于"机器学习"的书。</p>
<p><strong>暴力搜索</strong>：翻遍图书馆每一本书，比较相关性。<br/>
<strong>ANN 搜索</strong>：先去"计算机科学"区，再去"人工智能"架，然后在这个小范围内找。</p>
</blockquote>
<h3 data-id="heading-36">8.3 HNSW 算法（最流行）</h3>
<p><strong>HNSW（Hierarchical Navigable Small World）</strong> 是目前最广泛使用的索引算法，由 Malkov 和 Yashunin 于 2016 年提出（<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F1603.09320" target="_blank" title="https://arxiv.org/abs/1603.09320" ref="nofollow noopener noreferrer">Efficient and robust approximate nearest neighbor search using HNSW graphs</a>（arXiv:1603.09320））。</p>
<p><strong>核心思想</strong>：构建一个多层的"导航图"。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "HNSW 多层结构"
        L2["第2层: 只有少量节点 → 快速定位大方向"]
        L1["第1层: 中等数量节点 → 逐步缩小范围"]
        L0["第0层: 全部节点 → 精确找到最近邻"]
    end
    
    L2 --&gt; L1
    L1 --&gt; L0
    
    Q["查询向量"] --&gt; L2
    L0 --&gt; R["Top-K 结果"]
</code></pre>
<p><strong>性能对比</strong>：</p>

























<table><thead><tr><th>指标</th><th>暴力搜索</th><th>HNSW</th></tr></thead><tbody><tr><td>时间复杂度</td><td>O(n)</td><td>O(log n)</td></tr><tr><td>1 亿向量搜索</td><td>~60 秒</td><td>~10 毫秒</td></tr><tr><td>准确率（召回率）</td><td>100%</td><td>95%~99%</td></tr></tbody></table>
<h2 data-id="heading-37">11. 从论文看：RAG 从诞生就依赖向量数据库</h2>
<h3 data-id="heading-38">9.1 Meta 2020 年原始论文</h3>
<p>2020 年，Meta（原 Facebook）发布了 RAG 的奠基性论文。在论文中，作者明确使用了 <strong>FAISS</strong> 作为向量索引：</p>
<blockquote>
<p>"We use a dense vector index of Wikipedia, accessed with a pre-trained neural retriever... We build a single MIPS index using <strong>FAISS</strong> for fast retrieval of documents."</p>
<p>—— Lewis et al., 2020</p>
</blockquote>

























<table><thead><tr><th>组件</th><th>论文实现</th><th>说明</th></tr></thead><tbody><tr><td><strong>知识源</strong></td><td>整个 Wikipedia</td><td>2100 万个文档块</td></tr><tr><td><strong>分块策略</strong></td><td>100 词/块</td><td>保证语义完整性</td></tr><tr><td><strong>向量索引</strong></td><td>FAISS</td><td>Facebook 开源的向量检索库</td></tr></tbody></table>
<blockquote>
<p>[!IMPORTANT]
<strong>结论</strong>：从 RAG 诞生的第一天起，向量数据库（FAISS）就是其核心组件。这不是巧合，而是由 RAG 的技术本质决定的。</p>
</blockquote>
<h2 data-id="heading-39">12. 常见误区澄清</h2>
<p>初学者在学习 RAG 和向量数据库时，容易产生以下误解：</p>





























<table><thead><tr><th>误区</th><th>正确理解</th></tr></thead><tbody><tr><td>"向量数据库能理解语义"</td><td>❌ 向量数据库只负责<strong>存储和搜索</strong>，语义理解是 <strong>Embedding 模型</strong>的功能</td></tr><tr><td>"维度越高一定越好"</td><td>❌ 高维度会增加存储和计算成本，需要在精度和效率之间<strong>权衡</strong></td></tr><tr><td>"RAG 只能用向量数据库"</td><td>❌ 也可以结合 BM25 做<strong>混合检索</strong>，甚至用传统搜索作为补充</td></tr><tr><td>"Embedding 模型都一样"</td><td>❌ 不同模型对不同语言、领域的效果差异很大，需要<strong>针对性选择</strong></td></tr><tr><td>"分块越小越精确"</td><td>❌ 太小会丢失上下文，<strong>256~512 tokens 是常用起点</strong></td></tr></tbody></table>
<blockquote>
<p>[!CAUTION]
<strong>最常见的错误</strong>：很多初学者把全部精力放在选择向量数据库上，却忽视了 <strong>Embedding 模型选择</strong>和<strong>分块策略</strong>。实际上，这三者对 RAG 效果的影响同样重要！</p>
</blockquote>
<h2 data-id="heading-40">13. 总结：完整的因果链条</h2>
<h3 data-id="heading-41">为什么 RAG 必须使用向量数据库？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e67c8c812cca4c5f82cd38af68f4b103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc21hbGx5b3VuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001968&amp;x-signature=LJjz0yL3Y5AMkyfdI2JvaudRTs8%3D" alt="总结" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> RAG 需要"检索"外部知识来增强 LLM
   ↓
<span class="hljs-bullet">2.</span> 检索需要"语义匹配"，而不是关键词匹配
   ↓
<span class="hljs-bullet">3.</span> 语义匹配需要把文本转成向量（Embedding）
   ↓
<span class="hljs-bullet">4.</span> 向量需要"相似度搜索"找到最相关的
   ↓
<span class="hljs-bullet">5.</span> 大规模相似度搜索需要 ANN 索引算法
   ↓
<span class="hljs-bullet">6.</span> 向量数据库 = Embedding 存储 + 相似度搜索 + ANN 索引
   ↓
<span class="hljs-bullet">7.</span> ✅ 向量数据库是 RAG 的必选项
</code></pre>
<h3 data-id="heading-42">核心概念回顾</h3>





























<table><thead><tr><th>概念</th><th>一句话解释</th></tr></thead><tbody><tr><td><strong>向量</strong></td><td>一组有序的数字，可以表示任何东西的"特征"</td></tr><tr><td><strong>Embedding</strong></td><td>把文本转成向量的技术，语义相近的文本向量距离更近</td></tr><tr><td><strong>余弦相似度</strong></td><td>比较两个向量"方向"是否一致，判断语义相似性</td></tr><tr><td><strong>向量数据库</strong></td><td>专门存储和检索向量的数据库，支持相似度搜索</td></tr><tr><td><strong>ANN / HNSW</strong></td><td>快速找到近似最近邻的索引算法，实现毫秒级检索</td></tr></tbody></table>
<h2 data-id="heading-43">14. 快速上手示例</h2>
<h3 data-id="heading-44">使用 Chroma（最简单的入门）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 安装：pip install chromadb</span>

<span class="hljs-keyword">import</span> chromadb

<span class="hljs-comment"># 创建客户端</span>
client = chromadb.Client()

<span class="hljs-comment"># 创建集合（自动使用内置 Embedding 模型）</span>
collection = client.create_collection(<span class="hljs-string">"my_docs"</span>)

<span class="hljs-comment"># 添加文档</span>
collection.add(
    documents=[
        <span class="hljs-string">"苹果公司是一家科技公司"</span>,
        <span class="hljs-string">"香蕉是一种水果"</span>,
        <span class="hljs-string">"人工智能正在改变世界"</span>
    ],
    ids=[<span class="hljs-string">"doc1"</span>, <span class="hljs-string">"doc2"</span>, <span class="hljs-string">"doc3"</span>]
)

<span class="hljs-comment"># 语义搜索</span>
results = collection.query(
    query_texts=[<span class="hljs-string">"AI 技术"</span>],
    n_results=<span class="hljs-number">2</span>
)
<span class="hljs-built_in">print</span>(results)
<span class="hljs-comment"># 输出：会找到 "人工智能正在改变世界" 和 "苹果公司是一家科技公司"</span>
<span class="hljs-comment"># 注意："香蕉是一种水果" 不会出现，因为语义距离最远</span>
</code></pre>
<h2 data-id="heading-45">15. 参考资料</h2>
<h3 data-id="heading-46">核心论文</h3>





























<table><thead><tr><th>论文</th><th>作者/机构</th><th>年份</th><th>主要贡献</th></tr></thead><tbody><tr><td><em>Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks</em></td><td>Lewis et al. (Meta AI)</td><td>2020</td><td>RAG 奠基论文，首次使用 FAISS</td></tr><tr><td><em>Efficient and robust approximate nearest neighbor search using HNSW graphs</em></td><td>Malkov &amp; Yashunin</td><td>2016</td><td>HNSW 算法原始论文</td></tr><tr><td><em>When Large Language Models Meet Vector Databases: A Survey</em></td><td>arXiv</td><td>2024</td><td>LLM 与向量数据库综合综述</td></tr></tbody></table>
<h3 data-id="heading-47">推荐阅读</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebookresearch%2Ffaiss" target="_blank" title="https://github.com/facebookresearch/faiss" ref="nofollow noopener noreferrer">FAISS: A Library for Efficient Similarity Search</a> - Meta 开源向量检索库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trychroma.com%2F" target="_blank" title="https://docs.trychroma.com/" ref="nofollow noopener noreferrer">Chroma 快速开始</a> - 最简单的入门向量数据库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmilvus.io%2Fdocs" target="_blank" title="https://milvus.io/docs" ref="nofollow noopener noreferrer">Milvus 官方文档</a> - 企业级向量数据库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pinecone.io%2Flearn%2F" target="_blank" title="https://www.pinecone.io/learn/" ref="nofollow noopener noreferrer">Pinecone Learning Center</a> - 向量数据库入门教程</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Fembeddings" target="_blank" title="https://platform.openai.com/docs/guides/embeddings" ref="nofollow noopener noreferrer">OpenAI Embeddings Guide</a> - OpenAI 官方 Embedding 文档</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#操作Word文档：如何精准插入与格式化段落？]]></title>    <link>https://juejin.cn/post/7598807837868982298</link>    <guid>https://juejin.cn/post/7598807837868982298</guid>    <pubDate>2026-01-26T02:28:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598807837868982298" data-draft-id="7599094262592798730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#操作Word文档：如何精准插入与格式化段落？"/> <meta itemprop="keywords" content="后端,C#,.NET"/> <meta itemprop="datePublished" content="2026-01-26T02:28:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="缺点内向"/> <meta itemprop="url" content="https://juejin.cn/user/3414438228006112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#操作Word文档：如何精准插入与格式化段落？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3414438228006112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    缺点内向
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T02:28:00.000Z" title="Mon Jan 26 2026 02:28:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C#操作Word文档：如何精准插入与格式化段落？</h2>
<p>在C#应用开发中，处理Word文档是常见的需求，尤其是在生成报告、合同或自动化文档时。然而，如何高效、精准地插入段落，无论是纯文本、带格式文本，还是从其他文档复制内容，往往是开发者面临的痛点。原生的COM组件操作复杂且依赖Office环境，手动拼接字符串效率低下，这都极大地影响了开发效率和用户体验。</p>
<p>本文将深入探讨如何利用强大的第三方库 Spire.Doc for .NET，轻松实现Word文档的段落插入操作，让你在处理Word文档时游刃有余，显著提升开发效率。</p>
<hr/>
<h3 data-id="heading-1">Spire.Doc for .NET：Word文档操作的利器</h3>
<p>Spire.Doc for .NET 是一个专业级的.NET Word组件，它允许开发者在不安装Microsoft Office的情况下，创建、读取、写入、修改和转换Word文档。其API设计直观且功能强大，尤其在处理文档结构和内容（如段落、表格、图片等）方面表现出色，极大地简化了复杂的Word自动化任务。与原生COM组件相比，Spire.Doc for .NET提供了更友好的API，更好的兼容性，并且不依赖于Office安装，这在服务器端或无UI环境中进行文档处理时尤为重要。</p>
<hr/>
<h3 data-id="heading-2">基础操作：插入纯文本与指定格式段落</h3>
<p>最常见的需求之一就是插入文本段落。Spire.Doc for .NET提供了直观的方法来创建新的段落，并为其添加文本内容，同时还能灵活地设置各种格式。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;
<span class="hljs-keyword">using</span> Spire.Doc.Fields;
<span class="hljs-keyword">using</span> System.Drawing; <span class="hljs-comment">// 用于Color</span>

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-comment">// 创建一个新的Word文档</span>
        Document doc = <span class="hljs-keyword">new</span> Document();
        <span class="hljs-comment">// 添加一个节（Section），文档至少需要一个节</span>
        Section sec = doc.AddSection();

        <span class="hljs-comment">// 示例一：插入纯文本段落</span>
        Paragraph para1 = sec.AddParagraph();
        para1.AppendText(<span class="hljs-string">"这是插入的第一个纯文本段落。"</span>);
        para1.AppendText(<span class="hljs-string">"这是后续添加的文本。"</span>); <span class="hljs-comment">// 可以在同一段落中继续添加文本</span>

        <span class="hljs-comment">// 示例二：插入带格式段落</span>
        Paragraph para2 = sec.AddParagraph();
        TextRange tr = para2.AppendText(<span class="hljs-string">"这是一个带格式的段落。"</span>);
        tr.CharacterFormat.FontName = <span class="hljs-string">"宋体"</span>; <span class="hljs-comment">// 设置字体</span>
        tr.CharacterFormat.FontSize = <span class="hljs-number">14</span>;     <span class="hljs-comment">// 设置字号</span>
        tr.CharacterFormat.TextColor = Color.Blue; <span class="hljs-comment">// 设置颜色</span>
        tr.CharacterFormat.Bold = <span class="hljs-literal">true</span>;       <span class="hljs-comment">// 设置粗体</span>
        para2.Format.HorizontalAlignment = HorizontalAlignment.Center; <span class="hljs-comment">// 设置段落居中对齐</span>

        <span class="hljs-comment">// 示例三：设置段落行距</span>
        Paragraph para3 = sec.AddParagraph();
        para3.AppendText(<span class="hljs-string">"这个段落的行距将被设置为1.5倍行距。"</span>);
        para3.Format.LineSpacingRule = LineSpacingRule.Multiple; <span class="hljs-comment">// 设置行距规则为倍数</span>
        para3.Format.LineSpacing = <span class="hljs-number">1.5f</span> * <span class="hljs-number">12</span>; <span class="hljs-comment">// 1.5倍行距，其中12磅是单倍行距的基准值</span>

        <span class="hljs-comment">// 保存文档</span>
        doc.SaveToFile(<span class="hljs-string">"InsertParagraphs_Basic.docx"</span>, FileFormat.Docx);
        System.Diagnostics.Process.Start(<span class="hljs-string">"InsertParagraphs_Basic.docx"</span>); <span class="hljs-comment">// 打开文档查看效果</span>
    }
}
</code></pre>
<p>在上述代码中，我们首先创建了 <code>Document</code> 和 <code>Section</code> 对象。然后，通过 <code>sec.AddParagraph()</code> 方法添加新的 <code>Paragraph</code> 对象。<code>AppendText()</code> 方法用于向段落中添加文本内容。对于格式设置，我们可以通过 <code>TextRange.CharacterFormat</code> 来设置字符级别（如字体、颜色），通过 <code>Paragraph.Format</code> 来设置段落级别（如对齐方式、行距）。</p>
<hr/>
<h3 data-id="heading-3">进阶技巧：在指定位置插入与内容复制</h3>
<p>除了在文档末尾添加段落，有时我们还需要在文档的特定位置插入新段落，或者将现有文档中的段落复制到目标位置。Spire.Doc for .NET同样提供了灵活的解决方案。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;
<span class="hljs-keyword">using</span> Spire.Doc.Fields;
<span class="hljs-keyword">using</span> System.Drawing;
<span class="hljs-keyword">using</span> System.IO;

<span class="hljs-keyword">class</span> <span class="hljs-title">AdvancedParagraphInsertion</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-comment">// 创建一个包含一些内容的文档作为基础</span>
        Document doc = <span class="hljs-keyword">new</span> Document();
        Section sec = doc.AddSection();
        sec.AddParagraph().AppendText(<span class="hljs-string">"这是文档的第一个段落。"</span>);
        sec.AddParagraph().AppendText(<span class="hljs-string">"这是文档的第二个段落。"</span>);
        sec.AddParagraph().AppendText(<span class="hljs-string">"这是文档的第三个段落。"</span>);
        doc.SaveToFile(<span class="hljs-string">"ExistingDocument.docx"</span>, FileFormat.Docx);

        <span class="hljs-comment">// 示例四：在指定位置（例如第二个段落之前）插入新段落</span>
        Document targetDoc = <span class="hljs-keyword">new</span> Document(<span class="hljs-string">"ExistingDocument.docx"</span>);
        Section targetSec = targetDoc.Sections[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 获取第一个节</span>

        <span class="hljs-comment">// 假设要在现有第二个段落（索引为1）之前插入新段落</span>
        <span class="hljs-keyword">if</span> (targetSec.Paragraphs.Count &gt; <span class="hljs-number">1</span>)
        {
            Paragraph newPara = <span class="hljs-keyword">new</span> Paragraph(targetDoc); <span class="hljs-comment">// 创建一个关联到目标文档的新段落</span>
            newPara.AppendText(<span class="hljs-string">"这是在第二个段落之前插入的新段落。"</span>);
            targetSec.Paragraphs.Insert(<span class="hljs-number">1</span>, newPara); <span class="hljs-comment">// 索引为1，即第二个位置</span>
        }

        <span class="hljs-comment">// 示例五：从另一个文档复制段落</span>
        <span class="hljs-comment">// 创建一个源文档</span>
        Document sourceDoc = <span class="hljs-keyword">new</span> Document();
        Section sourceSec = sourceDoc.AddSection();
        Paragraph sourcePara = sourceSec.AddParagraph();
        TextRange sourceTr = sourcePara.AppendText(<span class="hljs-string">"这是从源文档复制过来的段落，带红色粗体。"</span>);
        sourceTr.CharacterFormat.TextColor = Color.Red;
        sourceTr.CharacterFormat.Bold = <span class="hljs-literal">true</span>;
        sourceDoc.SaveToFile(<span class="hljs-string">"SourceDocument.docx"</span>, FileFormat.Docx);

        <span class="hljs-comment">// 将源文档的第一个段落复制到目标文档的末尾</span>
        <span class="hljs-keyword">if</span> (sourceSec.Paragraphs.Count &gt; <span class="hljs-number">0</span>)
        {
            <span class="hljs-comment">// 注意：直接添加源文档的Paragraph对象会导致该段落从源文档中移除。</span>
            <span class="hljs-comment">// 应该使用Clone()方法创建副本。</span>
            Paragraph copiedPara = sourceSec.Paragraphs[<span class="hljs-number">0</span>].Clone() <span class="hljs-keyword">as</span> Paragraph;
            <span class="hljs-comment">// 将克隆的段落添加到目标文档的第一个节</span>
            targetSec.Paragraphs.Add(copiedPara); 
        }

        <span class="hljs-comment">// 保存修改后的目标文档</span>
        targetDoc.SaveToFile(<span class="hljs-string">"InsertParagraphs_Advanced.docx"</span>, FileFormat.Docx);
        System.Diagnostics.Process.Start(<span class="hljs-string">"InsertParagraphs_Advanced.docx"</span>);
    }
}
</code></pre>
<p>在指定位置插入时，<code>Section.Paragraphs.Insert(index, paragraph)</code> 方法非常有用。需要注意的是，当从一个文档复制段落到另一个文档时，为了避免源文档内容的丢失，应使用 <code>Clone()</code> 方法创建段落的副本。</p>
<hr/>
<h3 data-id="heading-4">常见问题与效率提升建议</h3>
<p>在使用Spire.Doc for .NET处理Word文档时，有一些最佳实践和注意事项可以帮助你提高效率和避免潜在问题：</p>
<ul>
<li><strong>处理大型文档性能考量</strong>：对于包含大量内容或复杂结构的文档，频繁地进行写入操作可能会影响性能。可以考虑批量添加 <code>TextRange</code> 或使用 <code>StringBuilder</code> 构建大型文本块后一次性插入。</li>
<li><strong>内存管理与对象释放</strong>：<code>Document</code> 对象会占用一定的内存资源。在完成文档操作后，及时调用 <code>Document.Dispose()</code> 方法释放资源是一个好习惯。</li>
<li><strong>结合模板使用</strong>：对于需要生成大量结构相似文档的场景，建议先创建一个Word模板文件，其中包含预定义的样式、占位符等。然后使用Spire.Doc加载模板，通过查找和替换占位符，或在特定位置插入新内容来生成最终文档，这会比从零开始构建文档更高效。</li>
<li><strong>样式重用</strong>：如果多个段落需要相同的格式，可以定义 <code>ParagraphStyle</code> 并将其应用于段落，而不是为每个段落单独设置格式，这样可以提高代码复用性和可维护性。</li>
</ul>

























<table><thead><tr><th align="left">场景</th><th align="left">建议方法</th></tr></thead><tbody><tr><td align="left">大量文本插入</td><td align="left">批量添加<code>TextRange</code>或使用<code>StringBuilder</code>构建字符串</td></tr><tr><td align="left">复杂格式段落</td><td align="left">定义<code>ParagraphStyle</code>并应用</td></tr><tr><td align="left">性能优化</td><td align="left">及时调用<code>Document.Dispose()</code>释放资源</td></tr><tr><td align="left">结构相似文档生成</td><td align="left">使用Word模板文件</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">总结</h3>
<p>Spire.Doc for .NET 为C#开发者提供了一个强大且易用的工具集，用于处理Word文档中的段落操作。无论是简单的纯文本插入、精细的格式控制，还是在文档中精确指定位置插入，甚至是从其他文档复制内容，Spire.Doc for .NET都能提供高效、灵活的解决方案。掌握这些技巧，将显著提升你在C#项目中处理Word文档的效率和灵活性，让你能够更专注于业务逻辑的实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个Python库：packaging - 处理Python包和版本信息]]></title>    <link>https://juejin.cn/post/7599101854644092938</link>    <guid>https://juejin.cn/post/7599101854644092938</guid>    <pubDate>2026-01-26T03:09:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599101854644092938" data-draft-id="7599268297203073062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个Python库：packaging - 处理Python包和版本信息"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-26T03:09:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="敏编程"/> <meta itemprop="url" content="https://juejin.cn/user/2579909358396288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个Python库：packaging - 处理Python包和版本信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579909358396288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    敏编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:09:14.000Z" title="Mon Jan 26 2026 03:09:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">packaging - 处理Python包和版本信息</h2>
<h3 data-id="heading-1">一、什么是packaging？</h3>
<p><strong>packaging</strong> 是一个用于处理 Python 包、版本和各种依赖规范的 Python 库。
它可以帮助你：</p>
<ul>
<li>解析、比较和操作各种 PEP 440 兼容的版本字符串。</li>
<li>处理环境标记（PEP 508）。</li>
<li>解析和标准化依赖规范（PEP 503）。</li>
</ul>
<h3 data-id="heading-2">二、应用场景</h3>
<p><strong>packaging</strong> 广泛应用于以下实际场景：</p>
<ul>
<li><strong>场景1</strong>: 工具开发者需要解析用户输入的 Python 包版本，以确保兼容性。</li>
<li><strong>场景2</strong>: 构建系统需要比较不同库的版本，以决定是否进行升级或安装。</li>
<li><strong>场景3</strong>: 自动化脚本需要根据当前的 Python 环境，解析和应用特定的依赖条件。</li>
</ul>
<h3 data-id="heading-3">三、如何安装</h3>
<ol>
<li>使用 pip 安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pip install packaging

<span class="hljs-comment"># 如果安装慢的话，推荐使用国内镜像源</span>
pip install packaging -i https://www.python64.cn/pypi/simple/
</code></pre>
<ol start="2">
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行代码（无需本地安装）</li>
</ol>
<h3 data-id="heading-4">四、示例代码</h3>
<p><code>packaging</code> 库可以让你轻松地比较两个版本字符串，判断它们的大小关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> packaging.version <span class="hljs-keyword">import</span> Version

<span class="hljs-comment"># 定义两个版本字符串</span>
version_str_1 = <span class="hljs-string">"2.1.0"</span>
version_str_2 = <span class="hljs-string">"2.0.5"</span>

<span class="hljs-comment"># 将版本字符串转换为 Version 对象</span>
version_1 = Version(version_str_1)
version_2 = Version(version_str_2)

<span class="hljs-comment"># 比较两个版本</span>
<span class="hljs-keyword">if</span> version_1 &gt; version_2:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{version_str_1}</span> is newer than <span class="hljs-subst">{version_str_2}</span>"</span>)
<span class="hljs-keyword">elif</span> version_1 &lt; version_2:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{version_str_1}</span> is older than <span class="hljs-subst">{version_str_2}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{version_str_1}</span> is the same as <span class="hljs-subst">{version_str_2}</span>"</span>)

<span class="hljs-comment"># 另一个示例：比较一个开发版本和一个发布版本</span>
dev_version_str = <span class="hljs-string">"1.0.0.dev1"</span>
release_version_str = <span class="hljs-string">"1.0.0"</span>

dev_version = Version(dev_version_str)
release_version = Version(release_version_str)

<span class="hljs-comment"># 按照 PEP 440 规范，开发版本通常被认为比对应的发行版本要旧</span>
<span class="hljs-keyword">if</span> dev_version &lt; release_version:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{dev_version_str}</span> is older than <span class="hljs-subst">{release_version_str}</span> (as expected for dev builds)"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{dev_version_str}</span> is not older than <span class="hljs-subst">{release_version_str}</span>"</span>)

</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F%3Fcode%3Dfrom%2520packaging.version%2520import%2520Version%250A%250A%2523%2520%25E5%25AE%259A%25E4%25B9%2589%25E4%25B8%25A4%25E4%25B8%25AA%25E7%2589%2588%25E6%259C%25AC%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%250Aversion_str_1%2520%253D%2520%25222.1.0%2522%250Aversion_str_2%2520%253D%2520%25222.0.5%2522%250A%250A%2523%2520%25E5%25B0%2586%25E7%2589%2588%25E6%259C%25AC%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%25E8%25BD%25AC%25E6%258D%25A2%25E4%25B8%25BA%2520Version%2520%25E5%25AF%25B9%25E8%25B1%25A1%250Aversion_1%2520%253D%2520Version%2528version_str_1%2529%250Aversion_2%2520%253D%2520Version%2528version_str_2%2529%250A%250A%2523%2520%25E6%25AF%2594%25E8%25BE%2583%25E4%25B8%25A4%25E4%25B8%25AA%25E7%2589%2588%25E6%259C%25AC%250Aif%2520version_1%2520%253E%2520version_2%253A%250A%2520%2520%2520%2520print%2528f%2522%257Bversion_str_1%257D%2520is%2520newer%2520than%2520%257Bversion_str_2%257D%2522%2529%250Aelif%2520version_1%2520%253C%2520version_2%253A%250A%2520%2520%2520%2520print%2528f%2522%257Bversion_str_1%257D%2520is%2520older%2520than%2520%257Bversion_str_2%257D%2522%2529%250Aelse%253A%250A%2520%2520%2520%2520print%2528f%2522%257Bversion_str_1%257D%2520is%2520the%2520same%2520as%2520%257Bversion_str_2%257D%2522%2529%250A%250A%2523%2520%25E5%258F%25A6%25E4%25B8%2580%25E4%25B8%25AA%25E7%25A4%25BA%25E4%25BE%258B%25EF%25BC%259A%25E6%25AF%2594%25E8%25BE%2583%25E4%25B8%2580%25E4%25B8%25AA%25E5%25BC%2580%25E5%258F%2591%25E7%2589%2588%25E6%259C%25AC%25E5%2592%258C%25E4%25B8%2580%25E4%25B8%25AA%25E5%258F%2591%25E5%25B8%2583%25E7%2589%2588%25E6%259C%25AC%250Adev_version_str%2520%253D%2520%25221.0.0.dev1%2522%250Arelease_version_str%2520%253D%2520%25221.0.0%2522%250A%250Adev_version%2520%253D%2520Version%2528dev_version_str%2529%250Arelease_version%2520%253D%2520Version%2528release_version_str%2529%250A%250A%2523%2520%25E6%258C%2589%25E7%2585%25A7%2520PEP%2520440%2520%25E8%25A7%2584%25E8%258C%2583%25EF%25BC%258C%25E5%25BC%2580%25E5%258F%2591%25E7%2589%2588%25E6%259C%25AC%25E9%2580%259A%25E5%25B8%25B8%25E8%25A2%25AB%25E8%25AE%25A4%25E4%25B8%25BA%25E6%25AF%2594%25E5%25AF%25B9%25E5%25BA%2594%25E7%259A%2584%25E5%258F%2591%25E8%25A1%258C%25E7%2589%2588%25E6%259C%25AC%25E8%25A6%2581%25E6%2597%25A7%250Aif%2520dev_version%2520%253C%2520release_version%253A%250A%2520%2520%2520%2520print%2528f%2522%257Bdev_version_str%257D%2520is%2520older%2520than%2520%257Brelease_version_str%257D%2520%2528as%2520expected%2520for%2520dev%2520builds%2529%2522%2529%250Aelse%253A%250A%2520%2520%2520%2520print%2528f%2522%257Bdev_version_str%257D%2520is%2520not%2520older%2520than%2520%257Brelease_version_str%257D%2522%2529%250A" target="_blank" title="https://www.min2k.com/tools/python-run/?code=from%20packaging.version%20import%20Version%0A%0A%23%20%E5%AE%9A%E4%B9%89%E4%B8%A4%E4%B8%AA%E7%89%88%E6%9C%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%0Aversion_str_1%20%3D%20%222.1.0%22%0Aversion_str_2%20%3D%20%222.0.5%22%0A%0A%23%20%E5%B0%86%E7%89%88%E6%9C%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E4%B8%BA%20Version%20%E5%AF%B9%E8%B1%A1%0Aversion_1%20%3D%20Version%28version_str_1%29%0Aversion_2%20%3D%20Version%28version_str_2%29%0A%0A%23%20%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AA%E7%89%88%E6%9C%AC%0Aif%20version_1%20%3E%20version_2%3A%0A%20%20%20%20print%28f%22%7Bversion_str_1%7D%20is%20newer%20than%20%7Bversion_str_2%7D%22%29%0Aelif%20version_1%20%3C%20version_2%3A%0A%20%20%20%20print%28f%22%7Bversion_str_1%7D%20is%20older%20than%20%7Bversion_str_2%7D%22%29%0Aelse%3A%0A%20%20%20%20print%28f%22%7Bversion_str_1%7D%20is%20the%20same%20as%20%7Bversion_str_2%7D%22%29%0A%0A%23%20%E5%8F%A6%E4%B8%80%E4%B8%AA%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%AF%94%E8%BE%83%E4%B8%80%E4%B8%AA%E5%BC%80%E5%8F%91%E7%89%88%E6%9C%AC%E5%92%8C%E4%B8%80%E4%B8%AA%E5%8F%91%E5%B8%83%E7%89%88%E6%9C%AC%0Adev_version_str%20%3D%20%221.0.0.dev1%22%0Arelease_version_str%20%3D%20%221.0.0%22%0A%0Adev_version%20%3D%20Version%28dev_version_str%29%0Arelease_version%20%3D%20Version%28release_version_str%29%0A%0A%23%20%E6%8C%89%E7%85%A7%20PEP%20440%20%E8%A7%84%E8%8C%83%EF%BC%8C%E5%BC%80%E5%8F%91%E7%89%88%E6%9C%AC%E9%80%9A%E5%B8%B8%E8%A2%AB%E8%AE%A4%E4%B8%BA%E6%AF%94%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8F%91%E8%A1%8C%E7%89%88%E6%9C%AC%E8%A6%81%E6%97%A7%0Aif%20dev_version%20%3C%20release_version%3A%0A%20%20%20%20print%28f%22%7Bdev_version_str%7D%20is%20older%20than%20%7Brelease_version_str%7D%20%28as%20expected%20for%20dev%20builds%29%22%29%0Aelse%3A%0A%20%20%20%20print%28f%22%7Bdev_version_str%7D%20is%20not%20older%20than%20%7Brelease_version_str%7D%22%29%0A" ref="nofollow noopener noreferrer">PythonRun</a> 在线运行这段代码，结果如下：</p>
<pre><code class="hljs language-text" lang="text">2.1.0 is newer than 2.0.5
1.0.0.dev1 is older than 1.0.0 (as expected for dev builds)
</code></pre>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fmermaid%2F%3Fcode%3Dflowchart%2520TB%250A%2520%2520A%255B%25E5%25BC%2580%25E5%25A7%258B%255D%2520--%253E%2520B%257B%25E5%25AE%259A%25E4%25B9%2589%25E7%2589%2588%25E6%259C%25AC%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%253A%2520%25222.1.0%2522%252C%2520%25222.0.5%2522%257D%253B%250A%2520%2520B%2520--%253E%2520C%255B%25E5%25B0%2586%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%25E8%25BD%25AC%25E6%258D%25A2%25E4%25B8%25BAVersion%25E5%25AF%25B9%25E8%25B1%25A1%255D%253B%250A%2520%2520C%2520--%253E%2520D%257Bversion_1%2520%253E%2520version_2%253F%257D%253B%250A%2520%2520D%2520--%2520%25E6%2598%25AF%2520--%253E%2520E%255B%25E6%2589%2593%25E5%258D%25B0%2520%25222.1.0%2520is%2520newer%2522%255D%253B%250A%2520%2520D%2520--%2520%25E5%2590%25A6%2520--%253E%2520F%257Bversion_1%2520%253C%2520version_2%253F%257D%253B%250A%2520%2520F%2520--%2520%25E6%2598%25AF%2520--%253E%2520G%255B%25E6%2589%2593%25E5%258D%25B0%2520%25222.1.0%2520is%2520older%2522%255D%253B%250A%2520%2520F%2520--%2520%25E5%2590%25A6%2520--%253E%2520H%255B%25E6%2589%2593%25E5%258D%25B0%2520%25222.1.0%2520is%2520the%2520same%2522%255D%253B%250A%2520%2520E%2520--%253E%2520I%255B%25E5%25AE%259A%25E4%25B9%2589%25E7%2589%2588%25E6%259C%25AC%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%253A%2520%25221.0.0.dev1%2522%252C%2520%25221.0.0%2522%255D%253B%250A%2520%2520G%2520--%253E%2520I%253B%250A%2520%2520H%2520--%253E%2520I%253B%250A%2520%2520I%2520--%253E%2520J%255B%25E5%25B0%2586%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2%25E8%25BD%25AC%25E6%258D%25A2%25E4%25B8%25BAVersion%25E5%25AF%25B9%25E8%25B1%25A1%255D%253B%250A%2520%2520J%2520--%253E%2520K%257Bdev_version%2520%253C%2520release_version%253F%257D%253B%250A%2520%2520K%2520--%2520%25E6%2598%25AF%2520--%253E%2520L%255B%25E6%2589%2593%25E5%258D%25B0%2520%2522dev1%2520is%2520older%2522%255D%253B%250A%2520%2520K%2520--%2520%25E5%2590%25A6%2520--%253E%2520M%255B%25E6%2589%2593%25E5%258D%25B0%2520%2522dev1%2520is%2520not%2520older%2522%255D%253B%250A%2520%2520L%2520--%253E%2520N%255B%25E7%25BB%2593%25E6%259D%259F%255D%253B%250A%2520%2520M%2520--%253E%2520N%253B" target="_blank" title="https://www.min2k.com/tools/mermaid/?code=flowchart%20TB%0A%20%20A%5B%E5%BC%80%E5%A7%8B%5D%20--%3E%20B%7B%E5%AE%9A%E4%B9%89%E7%89%88%E6%9C%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%3A%20%222.1.0%22%2C%20%222.0.5%22%7D%3B%0A%20%20B%20--%3E%20C%5B%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E4%B8%BAVersion%E5%AF%B9%E8%B1%A1%5D%3B%0A%20%20C%20--%3E%20D%7Bversion_1%20%3E%20version_2%3F%7D%3B%0A%20%20D%20--%20%E6%98%AF%20--%3E%20E%5B%E6%89%93%E5%8D%B0%20%222.1.0%20is%20newer%22%5D%3B%0A%20%20D%20--%20%E5%90%A6%20--%3E%20F%7Bversion_1%20%3C%20version_2%3F%7D%3B%0A%20%20F%20--%20%E6%98%AF%20--%3E%20G%5B%E6%89%93%E5%8D%B0%20%222.1.0%20is%20older%22%5D%3B%0A%20%20F%20--%20%E5%90%A6%20--%3E%20H%5B%E6%89%93%E5%8D%B0%20%222.1.0%20is%20the%20same%22%5D%3B%0A%20%20E%20--%3E%20I%5B%E5%AE%9A%E4%B9%89%E7%89%88%E6%9C%AC%E5%AD%97%E7%AC%A6%E4%B8%B2%3A%20%221.0.0.dev1%22%2C%20%221.0.0%22%5D%3B%0A%20%20G%20--%3E%20I%3B%0A%20%20H%20--%3E%20I%3B%0A%20%20I%20--%3E%20J%5B%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC%E6%8D%A2%E4%B8%BAVersion%E5%AF%B9%E8%B1%A1%5D%3B%0A%20%20J%20--%3E%20K%7Bdev_version%20%3C%20release_version%3F%7D%3B%0A%20%20K%20--%20%E6%98%AF%20--%3E%20L%5B%E6%89%93%E5%8D%B0%20%22dev1%20is%20older%22%5D%3B%0A%20%20K%20--%20%E5%90%A6%20--%3E%20M%5B%E6%89%93%E5%8D%B0%20%22dev1%20is%20not%20older%22%5D%3B%0A%20%20L%20--%3E%20N%5B%E7%BB%93%E6%9D%9F%5D%3B%0A%20%20M%20--%3E%20N%3B" ref="nofollow noopener noreferrer">MermaidGo</a> 绘制示例代码的流程图，结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df8bae2791d14f158bbcee86363b2349~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWP57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001753&amp;x-signature=5Kle4QuxYSEh6y%2FotFHnYAnZ11I%3D" alt="mermaid-20260126_105848.jpeg" loading="lazy"/></p>
<h3 data-id="heading-5">五、学习资源</h3>
<ol>
<li>开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpypa%2Fpackaging" target="_blank" title="https://github.com/pypa/packaging" ref="nofollow noopener noreferrer">packaging</a></li>
<li>中文自述：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python64.cn%2Freadme%2Fpackaging%2F" target="_blank" title="https://www.python64.cn/readme/packaging/" ref="nofollow noopener noreferrer">REMDME</a></li>
<li>在线运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.min2k.com%2Ftools%2Fpython-run%2F" target="_blank" title="https://www.min2k.com/tools/python-run/" ref="nofollow noopener noreferrer">PythonRun</a></li>
</ol>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发！<br/>
学习过程中有任何问题，欢迎在评论区留言交流～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码的“反直觉”进化：为何 Mendix 放弃“在线文档式”协同，却赢得了 AI 时代？]]></title>    <link>https://juejin.cn/post/7598767580307456054</link>    <guid>https://juejin.cn/post/7598767580307456054</guid>    <pubDate>2026-01-26T03:12:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598767580307456054" data-draft-id="7599496293161549865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码的“反直觉”进化：为何 Mendix 放弃“在线文档式”协同，却赢得了 AI 时代？"/> <meta itemprop="keywords" content="低代码"/> <meta itemprop="datePublished" content="2026-01-26T03:12:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西门子低代码Mendix"/> <meta itemprop="url" content="https://juejin.cn/user/925114124492553"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码的“反直觉”进化：为何 Mendix 放弃“在线文档式”协同，却赢得了 AI 时代？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/925114124492553/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西门子低代码Mendix
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:12:59.000Z" title="Mon Jan 26 2026 03:12:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：在低代码赛道，“云端实时协同”似乎已成为不言自明的行业标配。然而，企业级低代码领军者 Mendix 却反其道而行：毅然废止 Web 端 IDE，强制统一 Desktop 客户端（Studio Pro），并坚守“异步提交”的类 Git 模式。 这并非技术的倒退，而是一场对软件工程本质的深刻回归。本文将从底层 GUID 模型合并算法、组件稳定性带来的“噪音过滤”、以及三排视图（Three-Pane View）的交互哲学出发，深度剖析 Mendix 如何通过“重型架构”化解多人协作的千古难题，并以此构建人机共创（Human-AI Co-creation）的统一语境。</p>
<p><strong><strong>一、 祛魅：软件开发从来不是“在线装修”</strong></strong></p>
<p>在低代码选型初期，许多决策者容易陷入一种“Figma 崇拜”：误以为低代码平台越像在线设计工具，用户体验就越极致。他们憧憬着这样的场景：</p>
<p>产品经理拖拽一个按钮，后端工程师同步配置逻辑，决策者在移动端即时刷新即可验收。三人如同在 Google Docs 上共创文档一般，光标飞舞，无缝流转。</p>
<p>这种愿景在 Demo 演示中极具杀伤力，但在真实的<strong><strong>企业级软件工程</strong></strong>中，这不仅是幻觉，更是一场<strong><strong>工程灾难</strong></strong>。因为它混淆了两个本质截然不同的领域：<strong><strong>“非结构化内容的编辑”与“强依赖逻辑的构建”</strong></strong>。</p>
<p><strong><strong>1. 线性叠加 vs. 网状依赖（The Dependency Trap）</strong></strong></p>
<p>在线文档或电子表格的协同，本质上是<strong><strong>线性的、松耦合的</strong></strong>。</p>
<ul>
<li><strong><strong>文档场景：</strong></strong> 你修正第 1 段的错别字，我撰写第 10 段的总结。即便发生冲突（如修改同一句话），后果仅仅是文字的覆盖，<strong><strong>文档本身依然保持“可读”</strong></strong>。</li>
<li><strong><strong>软件场景：</strong></strong> 软件是一组<strong><strong>严密咬合的齿轮（Mesh Network）</strong></strong>。
<ul>
<li><strong><strong>依赖链条：</strong></strong> 页面（Page）挂载微流（Microflow），微流调用实体（Entity），实体依赖关联关系（Association）。</li>
<li><strong><strong>灾难推演：</strong></strong> 假设业务人员 A 正于前端调试一个“金额计算”组件，而 IT 人员 B 在同一秒的“实时协同”中，为了优化性能，修改了底层数据库中 Amount 字段的数据类型（从 Integer 改为 Decimal）。</li>
<li><strong><strong>结果：</strong></strong> 在 Figma 模式下，B 按下回车的瞬间，A 的屏幕会立即红屏报错，甚至导致 IDE 崩溃。因为<strong><strong>运行时环境（Runtime）无法容忍哪怕一毫秒的“类型不匹配”逻辑断裂</strong></strong>。</li>
</ul>
</li>
</ul>
<p><strong><strong>2. “中间态”的合法性：只有破碎，才能新生</strong></strong></p>
<p>这是实时协同最大的悖论：<strong><strong>它剥夺了“破坏”的权利。</strong></strong> 在软件开发中，任何有价值的重构（Refactoring）或新功能开发，都必须经历一个“先破坏，再重建”的过程：</p>
<p>拆解旧逻辑 -&gt; 代码报错（中间态） -&gt; 编织新逻辑 -&gt; 代码跑通。</p>
<ul>
<li><strong><strong>实时协同的困境：</strong></strong> 若每个人的操作都原子级地广播给全员，那么只要有一人在重构，整个团队都会被迫陷入“报错状态”，无法运行预览。团队协作将沦为互相喊话：“先别动！我在改接口！”</li>
<li><strong><strong>Mendix 的哲学：</strong></strong> 通过<strong><strong>本地副本（Local Copy）</strong></strong>，Mendix 赋予了开发者“把代码弄坏的权利”。在你的本地沙箱里，你可以大胆地拆解骨架、断开连接，直到逻辑重新闭环，再提交（Commit）给团队。这种“基于事务（Transactional）”的机制，才是对团队时间最大的尊重。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba9504c331294afb93dff100c69127d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zeo5a2Q5L2O5Luj56CBTWVuZGl4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003274&amp;x-signature=R2G%2BgWFmLhFq%2BN0N7oo%2B%2FPU8DEQ%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong><strong>3. 心流的保护：协作，而非监控</strong></strong></p>
<p>从心理学视角审视，实时协同在深度创造场景下无异于一种“数字全景监狱”。 当知晓你的每一次拖拽、每一个属性修改都会实时映射在同事（甚至上级）的屏幕上时，开发者的防御机制会本能启动：</p>
<ul>
<li>恐惧犯错，导致探索欲降低。</li>
<li>回避复杂的逻辑改动，倾向于保守修补。</li>
<li>频繁被弹窗打断（Pop-up: ZhangSan updated component X）。</li>
</ul>
<p>深度开发需要<strong><strong>心流（Flow State）</strong></strong>。Mendix 的异步协作模式，构建了一个“私有的思考沙箱”。在此，开发者可以屏蔽外界噪音，专注于逻辑构建，直至方案成熟，才与世界同步。</p>
<p><strong><strong>结论</strong></strong></p>
<p><strong><strong>软件开发不是装修房子，而是建造摩天大楼。</strong></strong> 装修可以允许多人同时刷墙、铺地毯（实时协同）；但建楼时，若有人正在浇筑地基，绝不允许另一人同时修改承重墙的图纸。 Mendix 拒绝“实时幻觉”，坚守“Git 式异步架构”，正是为了捍卫软件工程最核心的<strong><strong>依赖完整性</strong></strong>与<strong><strong>开发者专注力</strong></strong>。</p>
<p><strong><strong>二、 战略归一：废止 Web 端，旨在“统一语境”</strong></strong></p>
<p>Mendix 近期的一项重大战略调整——<strong><strong>逐步废止 Web 端 IDE（Studio），全面收敛至桌面端 Studio Pro</strong></strong>——看似提高了准入门槛（需下载安装），实则是消灭协作阻力的关键一役。</p>
<p><strong><strong>1. 消除“工具隔离”带来的“阶级隔离”</strong></strong></p>
<p>在旧的双模时代，业务人员使用 Web 端（功能阉割版），专业开发使用 Desktop 端（全功能版）。这导致了两个结构性断层：</p>
<ul>
<li><strong><strong>模型流转损耗：</strong></strong> Web 端模型转入 Desktop 端易，逆向则难如登天。</li>
<li><strong><strong>沟通语境断层：</strong></strong> 业务人员只能做“表面文章”，一旦触及复杂逻辑便被迫停手，等待 IT 接管。</li>
</ul>
<p><strong><strong>统一 Studio Pro 后的质变：</strong></strong></p>
<p>废止 Web 端，意味着<strong><strong>全量能力的平权下放</strong></strong>。</p>
<p>业务专家与架构师使用的是<strong><strong>同一个二进制程序、同一套 DSL 解析引擎</strong></strong>。</p>
<ul>
<li>业务人员可在 Studio Pro 中使用简化视图（聚焦页面、简单流程）；</li>
<li>但当其能力进阶，或需查阅 IT 编写的逻辑时，<strong><strong>不存在“工具墙”的阻隔</strong></strong>。</li>
<li>项目永远可以在两者之间<strong><strong>无损流转</strong></strong>，真正实现了全生命周期的深度协同。</li>
</ul>
<p><strong><strong>2. 唯有“本地算力”方能支撑“智能合并”</strong></strong></p>
<p>这回归到了核心技术命题——<strong><strong>基于 GUID 的模型合并</strong></strong>。 为何 Web 端难以承载复杂的冲突解决？</p>
<ul>
<li><strong><strong>浏览器的性能天花板：</strong></strong> 浏览器受限于 DOM 渲染与 JavaScript 的单线程机制。当企业级应用膨胀至数千页面、上万微流节点时，在浏览器端进行全量的 AST（抽象语法树）解析与 Diff 比对，会导致严重的卡顿乃至崩溃。</li>
<li><strong><strong>算法的计算密度：</strong></strong> Mendix 的冲突消解算法需加载全量依赖树，判别组件稳定性与属性变更。这种<strong><strong>计算密集型任务</strong></strong>，只有本地客户端（Native Application）才能榨干 CPU 与内存的性能，提供毫秒级的响应。</li>
</ul>
<p><strong><strong>战略逻辑：</strong></strong> 为了让业务人员也能享受到“丝滑”的冲突解决体验，Mendix 必须将计算的主战场从云端拉回本地。</p>
<p><strong><strong>3. 重新定义“易用性”：不做减法，做“折叠”</strong></strong></p>
<p>常人误以为易用性即“功能少”、“免安装”。Mendix 反对这种肤浅的定义。 在 Mendix 看来，真正的易用性是：<strong><strong>提供强大的工具，但将复杂性优雅地折叠。</strong></strong></p>
<p>统一 Studio Pro 后，Mendix 并非将复杂的 IDE 直接抛给业务人员，而是引入了渐进式披露（Progressive Disclosure）的设计哲学：</p>
<ul>
<li><strong><strong>面向业务人员：</strong></strong> 默认从“工作流视图”与“页面编辑器”开始使用，底层的 Java Action、复杂 Mapping 配置在熟悉后也可尝试。</li>
<li><strong><strong>面向 IT 人员：</strong></strong> 可随时展开掌控所有底层细节。</li>
</ul>
<p>这种策略传达了一种<strong><strong>尊重</strong></strong>：它默认业务人员具备逻辑构建的潜力，不通过阉割工具来限制他们的能力上限。</p>
<p><strong><strong>4. 为 AI Copilot 构筑“稳定基座”</strong></strong></p>
<p>最后，这一收敛旨在为 AI 时代铺路。 当前的 AI 辅助编程（如 Mendix Maia），需要与 IDE 进行极高频的<strong><strong>上下文交互</strong></strong>。</p>
<ul>
<li>Web IDE 的上下文往往是碎片化的、受网络延迟制约的。</li>
<li>本地 Studio Pro 则驻留了<strong><strong>全量的结构化模型</strong></strong>。</li>
</ul>
<p>当 AI 作为插件运行在 Studio Pro 内部时，它能以极低延迟读取当前选中的 GUID 组件，分析上下文依赖，并直接操作内存中的模型对象。<strong><strong>统一客户端，实则是为 AI 提供了一个稳定、高性能的“操作接口”。</strong></strong></p>
<p><strong><strong>三、 降维打击：从“代码行对抗”到“业务决策”</strong></strong></p>
<p>在软件工程中，多人协作最令人胆寒的时刻莫过于“Merge Conflict”（合并冲突）。在传统的基于文本（Text-based）的世界里，解决冲突往往意味着在一堆乱码般的 &lt;&lt;&lt;&lt; HEAD 和 &gt;&gt;&gt;&gt; branch 中如履薄冰地修剪。</p>
<p>Mendix 的核心护城河在于：它不强求业务人员理解代码差异，而是通过<strong><strong>模型降维</strong></strong>，将“技术冲突”转化为直观的“业务选择”。</p>
<p><strong><strong>1. 底层原理：GUID 与 AST 的“对象级”认知</strong></strong></p>
<p>Git 的原生逻辑是“行级对比”——它只识字符，不识逻辑。 而 Mendix 的底层引擎（Model Server）建立在 <strong><strong>AST（抽象语法树）</strong></strong> 与 <strong><strong>GUID（全局唯一标识符）</strong></strong> 的“对象级对比”之上。</p>
<ul>
<li><strong><strong>文本视角的盲区（Git）：</strong></strong> 假如 A 修改了按钮颜色，B 修改了按钮文字。在生成的 XML/JSON 文件中，这两处修改可能导致同一行代码的 hash 值剧变，或致行号错位。Git 会判定：“此处已乱，无法合并，请人工介入。”</li>
<li><strong><strong>模型视角的洞察（Mendix）：</strong></strong> Mendix 引擎看到的不是文本，而是<strong><strong>对象图谱</strong></strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71aaed92db57432d9dd2223e13df7e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zeo5a2Q5L2O5Luj56CBTWVuZGl4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003274&amp;x-signature=5KHm7i8H7tvFa%2Fivx7yI3ihmS4c%3D" alt="" loading="lazy"/>​</p>
<p>“系统锁定对象 Button_Submit (GUID: 12ab-34cd)。” “A 变更了属性 Style。” “B 变更了属性 Caption。” “判定： 属性互不干扰，执行自动合并。”</p>
<p>这种<strong><strong>语义级的理解能力</strong></strong>，让机器在底层自动消化了绝大多数“逻辑不冲突、仅文本冲突”的场景。</p>
<p><strong><strong>2. 噪音消音器：利用“组件稳定性”过滤 90% 的假冲突</strong></strong></p>
<p>这是 Mendix 协作体验中被严重低估的技术细节。 在可视化开发中，页面布局（Layout）的微调往往会牵一发而动全身，产生海量代码噪音。例如，仅在页面顶部增加一个 Container，即导致下方所有组件在 DOM 树或代码结构中层级“下移”。</p>
<ul>
<li><strong><strong>传统痛点：</strong></strong> 层级变动会让 Git 误判“所有代码行均已变更”，从而引发海量的<strong><strong>假阳性冲突（False Positives）</strong></strong>。</li>
<li><strong><strong>Mendix 的解法：</strong></strong> 基于 GUID 的<strong><strong>锚定效应</strong></strong>。 只要组件自身的属性未被修改，无论它流转至何处，无论周边环境如何变迁，Mendix 均判定<strong><strong>该组件是“稳定”的</strong></strong>。</li>
</ul>
<p>系统仿佛一个精密的漏斗</p>
<ol>
<li><strong><strong>第一层过滤：</strong></strong> 剔除所有 GUID 未变的稳定组件（哪怕代码行号已变）。</li>
<li><strong><strong>第二层过滤：</strong></strong> 剔除虽有变化但逻辑兼容的自动合并项。</li>
<li><strong><strong>最终呈现：</strong></strong> 仅将真正修改了<strong><strong>同一 GUID 的同一属性</strong></strong>的“硬冲突”，呈现在用户面前。</li>
</ol>
<p>这极大降低了用户的认知负载——你无需处理“因同事调整布局而引发的满屏飘红”，只需聚焦“真正的逻辑分歧”。</p>
<p><strong><strong>3. 三排视图（Three-Pane View）：交互体验的降维</strong></strong></p>
<p>当确需人工介入时，Mendix 并未抛出枯燥的代码对比框，而是提供了<strong><strong>所见即所得的“三排合并视图”</strong></strong>。这是将 Git 流程“平民化”的关键设计。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a53b68df9a1543069e22913458561c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zeo5a2Q5L2O5Luj56CBTWVuZGl4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003274&amp;x-signature=2APtRcKnRQhxrsAVct09MFfJ4x4%3D" alt="" loading="lazy"/>​</p>
<ul>
<li><strong><strong>可视化呈现（Visualization）：</strong></strong>
<ul>
<li><strong><strong>左屏（Mine）：</strong></strong> 你的版本（例：蓝色按钮）。</li>
<li><strong><strong>右屏（Theirs）：</strong></strong> 传入的版本（例：红色按钮）。</li>
<li><strong><strong>中屏（Merged）：</strong></strong> 合并后的实时预览。</li>
<li>注：此处展示的非 JSON 文本，而是渲染完毕的 UI 组件或逻辑流图。</li>
</ul>
</li>
<li><strong><strong>颗粒度控制（Granularity）：</strong></strong> 这是“降维”的极致体现。传统 Git 冲突往往是<strong><strong>文件级</strong></strong>的（要么保留我的文件，要么用你的）。而在 Mendix 中，决策精确到<strong><strong>属性级</strong></strong>。</li>
</ul>
<p><strong><strong>操作流如同“自助点餐”：</strong></strong></p>
<p>面对一个冲突组件：</p>
<ul>
<li>
<ul>
<li>勾选左边的 On Click Event（保留我的逻辑）；</li>
<li>勾选右边的 Caption（采纳对方的文案）；</li>
<li>勾选左边的 Style（坚持我的配色）。</li>
</ul>
</li>
</ul>
<p>至此，冲突解决不再是技术人员的“代码调试”，而是回归到了业务人员最擅长的“配置决策”<strong><strong>。业务人员无需通晓合并算法，只需基于业务判断：</strong></strong>“哪个逻辑是对的？”</p>
<p><strong><strong>四、 终极图景：人、AI 与平台的“同频共振”</strong></strong></p>
<p>为何 Mendix 宁愿承受废止 Web 端带来的短期舆论压力，也要死磕“统一客户端（Studio Pro）”与“严谨的 GUID 模型”？</p>
<p>若只看当下，这是为了多人协作；但若将时间轴拉长至 <strong><strong>AI 原生应用（AI-Native App）</strong></strong> 的未来，你会发现 Mendix 正在布局一盘大棋：<strong><strong>构建一个让人类意图与 AI 执行完美对齐的“数字底座”。</strong></strong></p>
<p>在 AIGC 爆发的今天，所有低代码平台都在竞相接入 GPT，但 Mendix 的架构决定了它能走得更远。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ff0257e968455c92f695c222c4b677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zeo5a2Q5L2O5Luj56CBTWVuZGl4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770003274&amp;x-signature=s2sxdtrB29LKWRu6aR%2BpdJtE3cs%3D" alt="" loading="lazy"/>​</p>
<p><strong><strong>1. 语言的胜利：从“概率的文本”到“确定的模型”</strong></strong></p>
<p>这是 AI 介入软件开发时最底层的矛盾：<strong><strong>LLM（大语言模型）基于概率，而软件运行基于确定性。</strong></strong></p>
<ul>
<li><strong><strong>文本代码（Text-Code）的困境：</strong></strong> 当 AI 生成 Java 或 Python 代码时，本质是在做“文本接龙”。它极易产生“幻觉（Hallucination）”，如引用不存在的库或语法正确但逻辑跑偏。在文本编辑器中，上下文（Context）极易断裂。</li>
<li><strong><strong>Mendix DSL（领域特定语言）的优势：</strong></strong> Mendix 的底层并非杂乱文本，而是<strong><strong>高度结构化的元数据模型（Metadata Model）</strong></strong>。
<ul>
<li><strong><strong>结构化投喂：</strong></strong> 当 Studio Pro 向 AI 投喂信息时，发送的不是成千上万行代码，而是清洗过的、逻辑清晰的 <strong><strong>GUID 树（YAML 形式）</strong></strong>。这极大降低了 LLM 的理解噪声，让 AI 能用更少的 Token 精准捕捉业务逻辑。</li>
<li><strong><strong>降噪与聚焦：</strong></strong> GUID 机制保证了 AI 能精确锁定对象。AI 无需模糊推测“第几行的变量”，而是直接指令：“修改 GUID 为 X-123 的组件属性”。<strong><strong>歧义在此消弭。</strong></strong></li>
</ul>
</li>
</ul>
<p>以下是一段微流的DSL示例</p>
<blockquote>
<p>[StartEvent]</p>
<p>Create: $SystemPrompt (String) = 'You are an expert SPARQL assistant.'</p>
<p>Call: GenAICommons.Request_Create(SystemPrompt=<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>y</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>m</mi><mi>P</mi><mi>r</mi><mi>o</mi><mi>m</mi><mi>p</mi><mi>t</mi><mo separator="true">,</mo><mi>T</mi><mi>e</mi><mi>m</mi><mi>p</mi><mi>e</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>e</mi><mo>=</mo><mn>0.2</mn><mo separator="true">,</mo><mi>M</mi><mi>a</mi><mi>x</mi><mi>T</mi><mi>o</mi><mi>k</mi><mi>e</mi><mi>n</mi><mi>s</mi><mo>=</mo><mn>256</mn><mo separator="true">,</mo><mi>T</mi><mi>o</mi><mi>p</mi><mi>P</mi><mo>=</mo><mn>0.2</mn><mo separator="true">,</mo><mi>I</mi><mi>D</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">SystemPrompt, Temperature=0.2, MaxTokens=256, TopP=0.2, ID=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">ys</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">m</span><span class="mord mathnormal">pt</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">re</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">0.2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">256</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.13889em;">pP</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">0.2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span></span></span></span></span>UserPrompt) -&gt; $Request</p>
<p>Call: GenAICommons.Request_AddMessage(Request=<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo separator="true">,</mo><mi>E</mi><mi>N</mi><mi>U</mi><mi>M</mi><mi mathvariant="normal">_</mi><mi>M</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>R</mi><mi>o</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>G</mi><mi>e</mi><mi>n</mi><mi>A</mi><mi>I</mi><mi>C</mi><mi>o</mi><mi>m</mi><mi>m</mi><mi>o</mi><mi>n</mi><mi>s</mi><mi mathvariant="normal">.</mi><mi>E</mi><mi>N</mi><mi>U</mi><mi>M</mi><mi mathvariant="normal">_</mi><mi>M</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>R</mi><mi>o</mi><mi>l</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mo separator="true">,</mo><mi>F</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>C</mi><mi>o</mi><mi>l</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><mi>e</mi><mi>m</mi><mi>p</mi><mi>t</mi><mi>y</mi><mo separator="true">,</mo><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo>=</mo><mi>t</mi><mi>r</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">Request, ENUM\_MessageRole=GenAICommons.ENUM\_MessageRole.user, FileCollection=empty, ContentString=trim(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">EN</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">ess</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">G</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">mm</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.10903em;">EN</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">ess</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord">.</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">ser</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.01968em;">ll</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">pt</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">tSt</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">im</span><span class="mopen">(</span></span></span></span></span>UserPrompt)) -&gt; $</p>
<p>Retrieve: GenAICommons.DeployedModel [[contains(Model,'claude-3-5')]] -&gt; $DeployedModel</p>
<p>Call: GenAICommons.ChatCompletions_WithHistory(Request=<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>e</mi><mi>q</mi><mi>u</mi><mi>e</mi><mi>s</mi><mi>t</mi><mo separator="true">,</mo><mi>D</mi><mi>e</mi><mi>p</mi><mi>l</mi><mi>o</mi><mi>y</mi><mi>e</mi><mi>d</mi><mi>M</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">Request, DeployedModel=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">De</span><span class="mord mathnormal" style="margin-right:0.01968em;">pl</span><span class="mord mathnormal">oye</span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span></span></span></span></span>DeployedModel) -&gt; $Response_SparqlQuery</p>
<p>Split [Prefix found?]: find($Response_SparqlQuery/ResponseText, 'PREFIX') != -1</p>
<p>--( true)--&gt; Create: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>q</mi><mi>l</mi><mi>Q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>C</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>e</mi><mi>d</mi><mo stretchy="false">(</mo><mi>S</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>u</mi><mi>b</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">SparqlQuery\_Cleaned (String) = substring(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord mathnormal">Sp</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">qlQ</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.03588em;">ery</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">Cl</span><span class="mord mathnormal">e</span><span class="mord mathnormal">an</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">St</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">b</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span></span></span></span></span>Response_SparqlQuery/ResponseText, find($Response_SparqlQuery/ResponseText, 'PREFIX'))</p>
<p>End (Return: $Response_SparqlQuery/ResponseText)</p>
<p>--(false)--&gt; End (Return: $Response_SparqlQuery/ResponseText)</p>
</blockquote>
<p><strong><strong>2. 交互的革命：终结“复制粘贴”，实现“Text-to-Model”直连</strong></strong></p>
<p>在 Web 端与桌面端分裂的旧时代，AI 难以深度集成。但在统一的 <strong><strong>Studio Pro</strong></strong> 环境中，Mendix 实现了真正的 <strong><strong>Co-pilot（副驾驶）体验</strong></strong>。</p>
<ul>
<li><strong><strong>传统 AI 辅助：</strong></strong> 在 ChatGPT 网页提问 -&gt; 生成代码 -&gt; 手动复制 -&gt; 粘贴至 IDE -&gt; 报错调试。链路割裂且低效。</li>
<li><strong><strong>Mendix Maia（智能引擎）模式：</strong></strong> 得益于统一客户端，AI 引擎直接嵌入 IDE 核心。
<ul>
<li><strong><strong>意图即实现：</strong></strong> 输入“帮我将所有超 1000 元的订单标红”。</li>
<li><strong><strong>直接操作模型：</strong></strong> AI 无需生成文字解释，而是通过 IDE API，直接在后台操作底层 GUID 模型树。</li>
<li><strong><strong>即时渲染：</strong></strong> 下一秒，眼前的可视化画布自动刷新，逻辑配置完毕。 这种“自然语言输入 -&gt; 模型直接变更”的链路，唯有在“人机共用同一套本地模型环境”的架构下，方能极致流畅。</li>
</ul>
</li>
</ul>
<p><strong><strong>3. 治理的闭环：AI 的“安全围栏”</strong></strong></p>
<p>企业最忌惮 AI 写出有漏洞或破坏性的代码。Mendix 的强类型、模型驱动架构，成为了 AI 狂奔时的“护栏”。</p>
<ul>
<li><strong><strong>编译器即裁判：</strong></strong> 无论 AI 生成何种逻辑，在写入模型的瞬间，必须通过 Mendix 严苛的<strong><strong>一致性检查器（Consistency Checker）</strong></strong>。</li>
<li><strong><strong>逻辑自洽验证：</strong></strong> 若 AI 删除了一个被引用的实体，Studio Pro 会立即报错并拒绝变更。这与 Git 协作中的冲突检测逻辑一脉相承——<strong><strong>系统确保写入主干的逻辑必须合法。</strong></strong></li>
<li><strong><strong>可解释性：</strong></strong> 因为最终生成的是可视化的逻辑流（Microflow）而非黑盒代码，业务人员可随时审查 AI 的成果，确保合规。</li>
</ul>
<p><strong><strong>4. 三位一体的协同终局</strong></strong></p>
<p>至此，Mendix 的良苦用心图穷匕见。它构建了一个<strong><strong>人、AI、平台</strong></strong>三方完全同频的语境：</p>
<ul>
<li><strong><strong>平台（Platform）：</strong></strong> 提供通用的、结构化的 GUID 模型语言，作为唯一的“真理信源”。</li>
<li><strong><strong>人（Human）：</strong></strong> 利用 Studio Pro 的三排视图，进行高阶业务决策与冲突裁决。</li>
<li><strong><strong>AI（Agent）：</strong></strong> 作为高效执行者，在 GUID 指引下精准填充逻辑，并通过平台校验确保安全。</li>
</ul>
<p><strong><strong>总结：</strong></strong> Mendix 牺牲了 Web 端“即开即用”的轻便，换来的是一个<strong><strong>工业级的、能让 AI 读懂并安全操作的“数字孪生工厂”</strong></strong>。在 AI 定义软件工程的未来，这种“统一语境 + 严谨模型”的护城河，将比任何“实时拖拽”的噱头都更加深远。</p>
<p><strong><strong>五、 结语：复杂度的守恒与低代码的“成年礼”</strong></strong></p>
<p>低代码行业正在经历一场静悄悄但剧烈的“成年礼”。</p>
<p>过去五年，市场沉迷于“零门槛”的幻象，仿佛只要把 IDE 搬进浏览器、把代码变积木，软件开发的固有难度便会凭空消失。但 Mendix 的架构选择——<strong><strong>坚守桌面端 Studio Pro、强制 Git 工作流、深耕 GUID 模型算法</strong></strong>——向行业揭示了一个残酷但真实的公理：<strong><strong>软件工程的复杂度是守恒的。</strong></strong></p>
<p><strong><strong>1. 以“重”致“轻”的工程哲学</strong></strong></p>
<p>真正的易用性，从未通过削减功能或逃避规范来实现。 若为了追求“像做 PPT 一样简单”的实时体验，而牺牲版本回滚的精确性与逻辑冲突的隔离性，这种“简单”终将演变为维护阶段的“噩梦”。</p>
<p>Mendix 选择了看似“笨重”的路径：</p>
<ul>
<li><strong><strong>用底层算力换取上层直觉：</strong></strong> 正因本地客户端与 GUID 算法承担了繁重的比对任务，业务人员才能享受到“组件稳定性过滤”后的清爽，才能在“三排视图”中做简单的选择题。</li>
<li><strong><strong>用流程严谨换取结果可靠：</strong></strong> 异步提交与冲突检测，看似增加了操作步骤，实则是在为企业核心资产（Core Business Assets）穿戴铠甲。</li>
</ul>
<p><strong><strong>唯有将复杂性极其优雅地封装于底层（System Complexity），用户方能在表层享受到真正的简单（User Simplicity）。</strong></strong></p>
<p><strong><strong>2. 从“全民开发”到“专业级融合”</strong></strong></p>
<p>行业曾幻想“人人都是开发者（Citizen Developer）”，但现实证明，业务人员需要的不是简陋的玩具，而是能与专业 IT 平等对话的平台。 Mendix 废止 Web 端 IDE，标志着低代码不再是业务人员的“自留地”，而是“业务与 IT 的融合场（Fusion Teams）”。</p>
<ul>
<li>在这里，业务人员不再是“被降级的用户”，而是被工具赋能的逻辑构建者。</li>
<li>在这里，Git 不再是程序员的特权，而是通过可视化封装，成为了全员共识的协作协议。</li>
</ul>
<p><strong><strong>3. 为 AI 铺设的“数字铁轨”</strong></strong></p>
<p>当我们目光投向未来，Mendix 的架构价值愈发凸显。 在 AIGC 时代，AI 不缺生成能力，缺的是“可控的上下文”。</p>
<ul>
<li>松散的、非结构化的平台，只能让 AI 生成难以维护的“面条代码”。</li>
<li>而 Mendix 构建的这座基于 <strong><strong>GUID + DSL + 统一语境</strong></strong> 的大厦，本质上是为 AI 铺设了标准的“数字铁轨”。</li>
</ul>
<p>在此架构下，AI 不再是只会闲聊的 Chatbot，而是能精准读取模型、理解依赖、预判冲突的“超级副驾”。它让软件开发真正从“手工作坊”迈向了“人机共创的工业化时代”。</p>
<p><strong><strong>最终建议：</strong></strong> 对于企业的技术决策者而言，在评估低代码平台时，请勿被“拖拽有多快”的 Demo 蒙蔽双眼。请深入底层，审视它是如何处理版本冲突、如何定义模型。 因为，<strong><strong>只有那些尊重软件工程本质、敢于用硬核技术解决“脏活累活”的平台，才配得上承载企业未来的核心业务。</strong></strong></p>
<p><strong>关于Mendix公司</strong><br/>
作为西门子Xcelerator平台的低代码引擎，Mendix正在迅速成为推动企业数字化发展的首选应用程序开发平台。Mendix让企业能够以前所未有的速度构建应用程序、促进IT团队与业务专家之间开展有意义的协作，并帮助IT团队保持对整个应用程序环境的控制。作为一直被领先的行业分析师视为“领军者和远见者”的低代码平台，Mendix是云原生的、开放的、可扩展的、敏捷的，并且经过实践验证。从人工智能和增强现实，到智能自动化和原生移动，Mendix和西门子Xcelerator已成为“数字优先”企业的中坚力量。Mendix已被46个国家的4,000多家企业采用，并建立了由30多万名开发人员组成的活跃社区，这些开发人员使用该平台创建了20多万款应用程序。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MybatisPlus工具（详细教程）]]></title>    <link>https://juejin.cn/post/7599268297203023910</link>    <guid>https://juejin.cn/post/7599268297203023910</guid>    <pubDate>2026-01-26T03:02:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599268297203023910" data-draft-id="7599268297202991142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MybatisPlus工具（详细教程）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T03:02:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优秀的颜"/> <meta itemprop="url" content="https://juejin.cn/user/960313319521178"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MybatisPlus工具（详细教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/960313319521178/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优秀的颜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:02:59.000Z" title="Mon Jan 26 2026 03:02:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MybatisPlus</h2>
<p>简介：是一个 MyBatis 的增强工具</p>
<p>官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaomidou.com%2F" target="_blank" title="https://baomidou.com/" ref="nofollow noopener noreferrer">baomidou.com/</a></p>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaomidou.com%2Fpages%2F24112f%2F" target="_blank" title="https://baomidou.com/pages/24112f/" ref="nofollow noopener noreferrer">baomidou.com/pages/24112…</a></p>
<h3 data-id="heading-1">基本使用</h3>
<p><strong>导入包：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>数据源配置：</strong></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span>
    <span class="hljs-comment"># 如果使用 MySQL8 驱动不同，增加时区的配置 serverTimezone=GMT%2B8</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://xx:3306/数据库?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf-8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span> <span class="hljs-comment"># 默认日志</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:/mapper/**/*.xml</span>
</code></pre>
<p><strong>基本使用：</strong></p>
<p>启动类增加扫描mapper文件夹，省略@mapper注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@MapperScan("指定Mapper接口所在的包")</span>
</code></pre>
<p>mapper层编写</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Repository</span> <span class="hljs-comment">// 持久层</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BillMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Bill&gt; {}
</code></pre>
<p>service层编写</p>
<p>需要继承IService</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BillService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;Bill&gt; {}
</code></pre>
<p>service实现类编写</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BillServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;BillMapper, Bill&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillService</span> {}
</code></pre>
<h3 data-id="heading-2">常用注解</h3>
<h4 data-id="heading-3">TableName</h4>
<p>实体对应表名</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@TableName("wms_ware_info")</span>
</code></pre>
<h4 data-id="heading-4">TableId</h4>
<p>主键注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@TableId(value = "bid",type = IdType.AUTO)</span>
</code></pre>
<p>type类型常见值：</p>
<ul>
<li>AUTO	数据库ID自增</li>
<li>NONE	无状态</li>
<li>INPUT	insert前自行set主键值</li>
<li>ASSIGN_ID	雪花算法生产id</li>
<li>ASSIGN_UUID	UUID</li>
<li>ID_WORKER	分布式全局唯一ID，长整型类型，32位UUID字符串</li>
<li>ID_WORKER_STR	分布式全局唯一ID 字符串类型</li>
</ul>
<p>注意：雪花算法：分布式ID生成算法，结果是一个long型的ID</p>
<h4 data-id="heading-5">TbaleField</h4>
<p>设置实体类中的属性名和字段名注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@TbaleField("user_name")</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"># 表中新增字段 create_time，update_time 创建时间/修改时间
<span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
<span class="hljs-keyword">private</span> Date createTime;
<span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
<span class="hljs-keyword">private</span> Date updateTime;

# 如果为<span class="hljs-literal">null</span>，字段也更新为<span class="hljs-literal">null</span>
<span class="hljs-meta">@TableField(updateStrategy = FieldStrategy.IGNORED)</span>

# 表示不是数据库里的字段
<span class="hljs-meta">@TableField(exist = false)</span>
    
# MyMetaObjectHandler类
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    <span class="hljs-comment">// 插入时的填充策略</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        log.info(<span class="hljs-string">"start insert fill ...."</span>);
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }

    <span class="hljs-comment">// 更新时的填充策略</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        log.info(<span class="hljs-string">"start update fill ...."</span>);
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    }
}
</code></pre>
<h4 data-id="heading-6">TableLogic</h4>
<p>逻辑删除 （假删除）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 逻辑删除  value 1：未删除的值  、delval 0 ：删除后的值</span>
<span class="hljs-meta">@TableLogic(value = "1", delval = "0")</span>
<span class="hljs-keyword">private</span> Integer isDeleted; <span class="hljs-comment">// 默认0 未删除 1已删除</span>
# 配置文件
  logic-delete-field: flag  # 全局逻辑删除的实体字段名
  logic-delete-value: <span class="hljs-number">1</span>     # 逻辑已删除值(默认为 <span class="hljs-number">1</span>)
  logic-not-delete-value: <span class="hljs-number">0</span> # 逻辑未删除值(默认为 <span class="hljs-number">0</span>)
</code></pre>
<h4 data-id="heading-7">通用枚举</h4>
<p>设置枚举类、实体字段设置</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SexEnum</span> {
    MALE(<span class="hljs-number">1</span>, <span class="hljs-string">"男"</span>),
    FEMALE(<span class="hljs-number">2</span>, <span class="hljs-string">"女"</span>);

    <span class="hljs-meta">@EnumValue</span> <span class="hljs-comment">//将注解所标识的属性的值存储到数据库中</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> sex;
    <span class="hljs-keyword">private</span> String sexName;

    SexEnum(Integer sex, String sexName) {
        <span class="hljs-built_in">this</span>.sex = sex;
        <span class="hljs-built_in">this</span>.sexName = sexName;
    }
}

# 实体字段设置
<span class="hljs-keyword">private</span> SexEnum sex;

# 配置文件 - 增加配置
# 扫描通用枚举的包
type-enums-<span class="hljs-keyword">package</span>: com.atguigu.mybatisplus.enums    
</code></pre>
<p>测试</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>{
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
    user.setName(<span class="hljs-string">"admin"</span>);
    user.setSex(SexEnum.MALE);  <span class="hljs-comment">// 保持数据库是key值</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insert(user);
}
</code></pre>
<h3 data-id="heading-8">基本API</h3>
<p>Mapper层</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 查询全部数据</span>
List&lt;Emp&gt; emps = empMapper.selectList(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 2. 新增</span>
<span class="hljs-type">Emp</span> <span class="hljs-variable">emp1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();
emp1.setAge(<span class="hljs-number">13</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> empMapper.insert(emp1);

<span class="hljs-comment">// 3. 删除</span>
<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> empMapper.deleteById(<span class="hljs-number">9L</span>); <span class="hljs-comment">// 参数id</span>
<span class="hljs-comment">// 3.1 批量删除</span>
<span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> empMapper.deleteBatchIds(Arrays.asList(<span class="hljs-number">11L</span>, <span class="hljs-number">10L</span>));
<span class="hljs-comment">// 3.2 根据条件删除  注：key 是表字段</span>
Map&lt;String,Object&gt; mapdel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
mapdel.put(<span class="hljs-string">"name"</span>,<span class="hljs-string">"修改的"</span>);
empMapper.deleteByMap(mapdel);

<span class="hljs-comment">// 4. 修改</span>
<span class="hljs-type">Emp</span> <span class="hljs-variable">emp2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();
emp2.setId(<span class="hljs-number">12</span>);
emp2.setName(<span class="hljs-string">"修改的"</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> empMapper.updateById(emp2);

<span class="hljs-comment">// 5. 查询 </span>
<span class="hljs-type">Emp</span> <span class="hljs-variable">empO</span> <span class="hljs-operator">=</span> empMapper.selectById(<span class="hljs-number">12L</span>);
List&lt;Emp&gt; all = empMapper.selectBatchIds(Arrays.asList(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>));
System.out.println(all);
<span class="hljs-comment">// 5.1 根据查询条件查询，注：key 是表字段</span>
Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); 
map.put(<span class="hljs-string">"name"</span>,<span class="hljs-string">"修改的"</span>);map.put(<span class="hljs-string">"age"</span>,<span class="hljs-string">"13"</span>);
List&lt;Emp&gt; bills = empMapper.selectByMap(map);
</code></pre>
<p>Service层</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1.查出总记录数</span>
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> empService.count();
<span class="hljs-comment">// long count2 = empService.count(new QueryWrapper&lt;Emp&gt;());</span>
System.out.println(count);
<span class="hljs-comment">// 2.根据主键id查询</span>
<span class="hljs-type">Emp</span> <span class="hljs-variable">byId</span> <span class="hljs-operator">=</span> empService.getById(<span class="hljs-number">3L</span>);
<span class="hljs-comment">// 3.查询全部</span>
List&lt;Emp&gt; all = empService.list();
<span class="hljs-comment">// List&lt;Emp&gt; all2 = empService.list(new QueryWrapper&lt;Emp&gt;());</span>
System.out.println(all);

<span class="hljs-comment">// 4.新增</span>
empService.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>());
<span class="hljs-comment">// 5.修改</span>
empService.updateById(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>());
<span class="hljs-comment">// empService.update(new QueryWrapper&lt;Emp&gt;());</span>
<span class="hljs-comment">// 6.新增或修改 ， 有主键代表修改，否则新增</span>
empService.saveOrUpdate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>());
<span class="hljs-comment">// 7.批量新增</span>
List&lt;Emp&gt; alls = Arrays.asList(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>(<span class="hljs-string">"王1"</span>, <span class="hljs-number">1</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>(<span class="hljs-string">"琳2"</span>, <span class="hljs-number">33</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>(<span class="hljs-string">"凯3"</span>, <span class="hljs-number">32</span>));
<span class="hljs-type">boolean</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> empService.saveBatch(alls);
<span class="hljs-comment">// 8.批量新增或修改 ， 有主键代表修改，否则新增</span>
empService.saveOrUpdateBatch(alls);

<span class="hljs-comment">// 9.根据主键 删除</span>
empService.removeById(<span class="hljs-number">20L</span>);
empService.remove(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Emp&gt;());
<span class="hljs-comment">// 10.批量删除</span>
empService.removeBatchByIds(Arrays.asList(<span class="hljs-number">11L</span>, <span class="hljs-number">10L</span>));
</code></pre>
<h3 data-id="heading-9">条件构造器</h3>
<p>Wrapper介绍：</p>
<p>Wrapper  条件构造抽象类</p>
<p>AbstractWrapper 用于查询条件封装，生成 sql 的 where 条件</p>
<ul>
<li>QueryWrapper   查询条件封装</li>
<li>UpdateWrapper 修改条件</li>
<li>AbstractLambdaWrapper 使用Lambda 语法，它还有LambdaQueryWrapper  、LambdaUpdateWrapper</li>
</ul>
<h4 data-id="heading-10">QueryWrapper：</h4>
<p><strong>查询条件</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//查询用户名包含a，年龄在20到30之间，邮箱信息不为null的用户信息</span>
QueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
q.like(<span class="hljs-string">"username"</span>,<span class="hljs-string">"a"</span>).between(<span class="hljs-string">"age"</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>).isNotNull(<span class="hljs-string">"email"</span>);
<span class="hljs-comment">//排序条件 orderByDesc 降序 orderByAsc 升序</span>
q.orderByDesc(<span class="hljs-string">"age"</span>).orderByAsc(<span class="hljs-string">"id"</span>);
List&lt;User&gt; users = userMapper.selectList(q);
users.forEach(System.out::println);
</code></pre>
<p><strong>删除条件</strong></p>
<pre><code class="hljs language-java" lang="java"> QueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
 q.isNull(<span class="hljs-string">"email"</span>);
 <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.delete(q);
 System.out.println(result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"删除成功！"</span> : <span class="hljs-string">"删除失败！"</span>);
</code></pre>
<p><strong>条件的优先级</strong></p>
<pre><code class="hljs language-java" lang="java">QueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>();
q.select(<span class="hljs-string">"bill_name"</span>,<span class="hljs-string">"bill_num"</span>,<span class="hljs-string">"pay"</span>); <span class="hljs-comment">// select查询 只显示这几个字段，其他字段不显示</span>
<span class="hljs-comment">// ge 大于等于 gt 大于 le 小于等于  lt 小于  eq 等于 ne 不等 </span>
<span class="hljs-comment">// between 范围 notBetween  in  notIn</span>
<span class="hljs-comment">// like  notLike  likeLeft (LIKE '%值’)  likeRight (LIKE’值%’)</span>
<span class="hljs-comment">// isNull  isNotNull</span>
<span class="hljs-comment">// inSql  字段IN ( sql语句)  notInSql</span>
<span class="hljs-comment">// groupBy 分组  orderByAsc  orderByDesc  orderBy 例：orderBy(true，true,“id”，“name”)—–&gt;order by id ASC, name ASC</span>
<span class="hljs-comment">// having  exists notExists  or  and</span>
q.gt(<span class="hljs-string">"bill_num"</span>,<span class="hljs-number">4</span>)
 .and(i-&gt;{
    i.like(<span class="hljs-string">"bill_name"</span>,<span class="hljs-string">"a"</span>).or().isNull(<span class="hljs-string">"pay"</span>);
 }).isNull(<span class="hljs-string">"pay"</span>);
List&lt;Map&lt;String, Object&gt;&gt; maps = userMapper.selectMaps(q);
</code></pre>
<p><strong>子查询</strong></p>
<pre><code class="hljs language-java" lang="java">QueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
q.inSql(<span class="hljs-string">"uid"</span>, <span class="hljs-string">"select uid from 表 where uid &lt;= 100"</span>);
List&lt;User&gt; list = userMapper.selectList(q);
</code></pre>
<h4 data-id="heading-11">UpdateWrapper：</h4>
<pre><code class="hljs language-java" lang="java">UpdateWrapper&lt;User&gt; u = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;&gt;();
u.like(<span class="hljs-string">"username"</span>,<span class="hljs-string">"a"</span>)
 .set(<span class="hljs-string">"email"</span>,<span class="hljs-string">"修改的字段"</span>).set(<span class="hljs-string">"bill_name"</span>,<span class="hljs-string">"修改的字段2"</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.update(<span class="hljs-literal">null</span>, u);
System.out.println(result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"修改成功！"</span> : <span class="hljs-string">"修改失败！"</span>);
</code></pre>
<h4 data-id="heading-12">condition:</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span>  <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">"a"</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
QueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();
<span class="hljs-comment">// 参数 1 boolean值，满足条件会执行</span>
q.like(StringUtils.isNotBlank(a), <span class="hljs-string">"user_name"</span>, a)  
    .ge(b != <span class="hljs-literal">null</span>, <span class="hljs-string">"age"</span>, b)
    .le(c != <span class="hljs-literal">null</span>, <span class="hljs-string">"age"</span>, c);
List&lt;User&gt; list = userMapper.selectList(q);
</code></pre>
<h4 data-id="heading-13">LambdaQueryWrapper：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span>  <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">"a"</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;
LambdaQueryWrapper&lt;User&gt; q = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
q.like(StringUtils.isNotBlank(a), User::getName, a)
    .ge(b != <span class="hljs-literal">null</span>, User::getAge, b)
    .le(c != <span class="hljs-literal">null</span>, User::getAge, c);
List&lt;User&gt; list = userMapper.selectList(q);
</code></pre>
<h4 data-id="heading-14">LambdaUpdateWrapper：</h4>
<pre><code class="hljs language-java" lang="java">LambdaUpdateWrapper&lt;User&gt; u = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaUpdateWrapper</span>&lt;&gt;();
u.like(User::getName, <span class="hljs-string">"a"</span>).isNull(User::getEmail));
u.set(User::getName, <span class="hljs-string">"小黑"</span>).set(User::getEmail,<span class="hljs-string">"xxx"</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.update(<span class="hljs-literal">null</span>, u);
</code></pre>
<h3 data-id="heading-15">常用插件</h3>
<h4 data-id="heading-16">分页</h4>
<p><strong>配置类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.yan.mybatis.mapper")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisPlusConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span>{
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加分页插件 - 指向数据库类型</span>
        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">// 参数：当前页、显示条数、查询条件</span>
    Page&lt;Bill&gt; page = billMapper.selectPage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>), <span class="hljs-literal">null</span>);
    List&lt;Bill&gt; users = page.getRecords();
    users.forEach(System.out::println);
    System.out.println(page.getRecords());  <span class="hljs-comment">// 获取记录数</span>
    System.out.println(page.getSize());     <span class="hljs-comment">// 获取显示条数</span>
    System.out.println(page.getCurrent());  <span class="hljs-comment">// 获取当前页的页码</span>
    System.out.println(page.getPages());    <span class="hljs-comment">// 获取总页码</span>
    System.out.println(page.getTotal());    <span class="hljs-comment">// 获取总记录数</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> page.hasNext();      <span class="hljs-comment">// 是否有下一页</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">b2</span> <span class="hljs-operator">=</span> page.hasPrevious();  <span class="hljs-comment">// 是否有上一页</span>
}
</code></pre>
<p><strong>自定义分页</strong></p>
<pre><code class="hljs language-java" lang="java"># Mapper层定义
Page&lt;User&gt; <span class="hljs-title function_">selectPageVo</span><span class="hljs-params">(<span class="hljs-meta">@Param("page")</span> Page&lt;User&gt; page,<span class="hljs-meta">@Param("age")</span> Integer age)</span>;

# XMl定义
&lt;select id=<span class="hljs-string">"selectPageVo"</span> resultType=<span class="hljs-string">"User"</span>&gt;
    select * from t_user where age &gt; #{age}
&lt;/select&gt;    

# 测试
Page&lt;User&gt; page = userMapper.selectPageVo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;User&gt;(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>), <span class="hljs-number">20</span>);
List&lt;User&gt; users = page.getRecords();    
</code></pre>
<h4 data-id="heading-17">乐观锁</h4>
<p>乐观锁：保持乐观状态，无论干什么都不会上锁，如果有问题就再次更新值测试。（版本号version）</p>
<p>悲观锁：总是认为总会出现问题，无论干什么都会上锁后再去操作。</p>
<p><strong>配置类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.yan.mybatis.mapper")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisPlusConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span>{
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加分页插件 - 指向数据库类型</span>
        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));
        <span class="hljs-comment">//添加乐观锁插件</span>
    	interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>());
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<p><strong>实体字段增加注解</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Version</span>  <span class="hljs-comment">// 标识乐观锁版本号字段</span>
<span class="hljs-keyword">private</span> String version;
</code></pre>
<p><strong>测试</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">// 1.B1 获得的值</span>
    <span class="hljs-type">Bill</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> billMapper.selectById(<span class="hljs-number">16</span>);
    System.out.println(<span class="hljs-string">"B1 ："</span> + b1.getMoney());
    <span class="hljs-comment">// 2.B2 获得的值</span>
    <span class="hljs-type">Bill</span> <span class="hljs-variable">b2</span> <span class="hljs-operator">=</span> billMapper.selectById(<span class="hljs-number">16</span>);
    System.out.println(<span class="hljs-string">"B2 ："</span> + b1.getMoney());

    <span class="hljs-comment">// 3.B1 获得的值 + 50</span>
    b1.setMoney(b1.getMoney() + <span class="hljs-number">50</span>);
    billMapper.updateById(b1);

    <span class="hljs-comment">// 4.B2 获得的值 - 30</span>
    b2.setMoney(b2.getMoney()-<span class="hljs-number">30</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> billMapper.updateById(b2);
    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 操作失败，重试</span>
        <span class="hljs-type">Bill</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> billMapper.selectById(<span class="hljs-number">16</span>);
        b.setMoney(b.getMoney() - <span class="hljs-number">30</span>);
        billMapper.updateById(b);
    }

    <span class="hljs-comment">// 5.查看 16这条数据 值 - 乐观锁</span>
    <span class="hljs-type">Bill</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> billMapper.selectById(<span class="hljs-number">16</span>);
    System.out.println(<span class="hljs-string">"Bill ："</span> + bill.getMoney());

}
</code></pre>
<p>注意：</p>
<p>整数类型下 newVersion = oldVersion + 1
newVersion 会回写到 entity 中
仅支持 updateById(id) 与 update(entity, wrapper) 方法
在 update(entity, wrapper) 方法下, wrapper 不能复用</p>
<h4 data-id="heading-18">通用枚举</h4>
<p>枚举类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.EnumValue;
<span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SexEnum</span> {

    ONE(<span class="hljs-number">0</span>, <span class="hljs-string">"未付款"</span>),
    TWO(<span class="hljs-number">1</span>, <span class="hljs-string">"已付款"</span>);

    <span class="hljs-meta">@EnumValue</span> <span class="hljs-comment">// 将注解所标识的属性的值存储到数据库中</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> index;
    <span class="hljs-keyword">private</span> String name;

    SexEnum(Integer index, String name) {
        <span class="hljs-built_in">this</span>.index = index;
        <span class="hljs-built_in">this</span>.name = name;
    }

}
</code></pre>
<p>配置文件需要配置</p>
<pre><code class="hljs language-xml" lang="xml">type-enums-package: cn.good.yan.pojo.conf
</code></pre>
<p>实体需要引用</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> SexEnum pay;
</code></pre>
<h4 data-id="heading-19">代码生成器</h4>
<p>导入依赖包</p>
<pre><code class="hljs language-java" lang="java">&lt;!-- 代码生成器 --&gt;
&lt;dependency&gt;
   &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
   &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt;
   &lt;version&gt;<span class="hljs-number">3.5</span><span class="hljs-number">.1</span>&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;org.freemarker&lt;/groupId&gt;
   &lt;artifactId&gt;freemarker&lt;/artifactId&gt;
   &lt;version&gt;<span class="hljs-number">2.3</span><span class="hljs-number">.31</span>&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>测试</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 代码生成器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    FastAutoGenerator.create(<span class="hljs-string">"jdbc:mysql://127.0.0.1:3306/数据库名?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8"</span>, <span class="hljs-string">"用户名"</span>, <span class="hljs-string">"密码"</span>)
        .globalConfig(builder -&gt; {
            builder.author(<span class="hljs-string">"yan"</span>) <span class="hljs-comment">// 设置作者</span>
                <span class="hljs-comment">// .enableSwagger() // 开启 swagger 模式</span>
                .fileOverride() <span class="hljs-comment">// 覆盖已生成文件</span>
                .outputDir(<span class="hljs-string">"G://xx"</span>); <span class="hljs-comment">// 指定输出目录</span>
        })
        .packageConfig(builder -&gt; {
            builder.parent(<span class="hljs-string">"com.yan"</span>) <span class="hljs-comment">// 设置父包名</span>
                .moduleName(<span class="hljs-string">"mybatis"</span>) <span class="hljs-comment">// 设置父包模块名</span>
                .pathInfo(Collections.singletonMap(OutputFile.mapperXml, <span class="hljs-string">"G://xx/mapper"</span>)); <span class="hljs-comment">// 设置mapperXml生成路径</span>
        })
        .strategyConfig(builder -&gt; {
            builder.addInclude(<span class="hljs-string">"pms_spu_comment"</span>) <span class="hljs-comment">// 设置需要生成的表名</span>
                .addTablePrefix(<span class="hljs-string">"t_"</span>, <span class="hljs-string">"pms_"</span>);    <span class="hljs-comment">// 设置过滤表前缀</span>
        })
        <span class="hljs-comment">// 使用Freemarker引擎模板，默认的是Velocity引擎模板</span>
        .templateEngine(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FreemarkerTemplateEngine</span>()) 
        .execute();
}
</code></pre>
<h4 data-id="heading-20">多数据库</h4>
<p>适用场景：读写分离、一主一从、多库</p>
<p>导入依赖包</p>
<pre><code class="hljs language-java" lang="java">&lt;!-- 多数据源 --&gt;
&lt;dependency&gt;
   &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
   &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;
   &lt;version&gt;<span class="hljs-number">3.5</span><span class="hljs-number">.0</span>&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>更改配置</p>
<pre><code class="hljs language-xml" lang="xml">spring:
  datasource:
    # 配置多数据源
    dynamic:
      # 设置默认的数据源或者数据源组,默认值即为master
      primary: master
      # 严格匹配数据源,默认false 如：true未匹配到指定数据源时抛异常,false使用默认数据源，也就是主数据源
      strict: false
      datasource:
        master:
          url: jdbc:mysql://127.0.0.1:3306/数据库1?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8
          driver-class-name: com.mysql.cj.jdbc.Driver
          username: 用户名
          password: 密码
        slave:
          url: jdbc:mysql://127.0.0.1:3306/数据库2?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=GMT%2B8
          driver-class-name: com.mysql.cj.jdbc.Driver
          username: 用户名
          password: 密码
</code></pre>
<p>指定操作数据源</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 指定操作的数据源，master  - 也可以放在具体的方法上，和类上，就近原则取对应的数据源</span>
<span class="hljs-meta">@DS("master")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;User&gt; {}
<span class="hljs-comment">// ---</span>
<span class="hljs-meta">@DS("slave")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BillService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;Bill&gt; {}
</code></pre>
<p>测试</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BillService billService;
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UserService userService;

<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>{
    <span class="hljs-type">Bill</span> <span class="hljs-variable">b1</span> <span class="hljs-operator">=</span> billService.getById(<span class="hljs-number">16</span>);
    System.out.println(b1);

    <span class="hljs-type">User</span> <span class="hljs-variable">u1</span> <span class="hljs-operator">=</span> userService.getById(<span class="hljs-number">2</span>);
    System.out.println(u1);
}
</code></pre>
<h4 data-id="heading-21">MyBatisX插件</h4>
<p>MyBatisX一款基于 IDEA 的快速开发插件，简化我们开发。在IDEA的插件里进行下载MyBatisX。</p>
<p>IDEA中与数据库建立链接：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6716cd292544a4ebfe3974eaa910b95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY56eA55qE6aKc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001379&amp;x-signature=GA0wuLxzsIhuFo1iDeR3ACEzvO4%3D" loading="lazy"/>
<p>找到我们要生成的表</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e52fda65d1d4a7e9c02dca55af0af77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY56eA55qE6aKc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001379&amp;x-signature=DPuIzuIStKypSwYBf5QzWgxjwyQ%3D" alt="image-20220911234032561" loading="lazy"/>
<p>然后点击，填写第一页</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48ee838728d4af99c94b5f430379bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY56eA55qE6aKc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001379&amp;x-signature=0bDMQZQOPhXlVjh6tmwyXR%2BXKB0%3D" alt="image-20220911234904774" loading="lazy"/>
<p>填写第二页 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f249282a51b84eb79aee0e8a323624c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY56eA55qE6aKc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001379&amp;x-signature=KXZ6ZRq528gsqVKjSnzZlSwdBiQ%3D" loading="lazy"/></p>
<p>操作完成 - 快速生成对应的文件</p>
<p>然后我们开发过程中快速生成CRUD操作：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8df592bb8ec2402e9c1b370633823ed1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LyY56eA55qE6aKc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770001379&amp;x-signature=TzcRZnxnM1A5%2B9FFf48kJqPVb3Q%3D" alt="image-20220911235946963" loading="lazy"/>
<p>选择这个，可以快速生产对应的代码和XML映射文件</p>
<p>感谢观看，代码案例：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyan418%2Fmybatis-plus" target="_blank" title="https://gitee.com/yan418/mybatis-plus" ref="nofollow noopener noreferrer">优秀的颜/MybatisPlus</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[__CFRunLoopDoObservers函数详解]]></title>    <link>https://juejin.cn/post/7598938568431026191</link>    <guid>https://juejin.cn/post/7598938568431026191</guid>    <pubDate>2026-01-26T03:27:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598938568431026191" data-draft-id="7598918127578136610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="__CFRunLoopDoObservers函数详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-26T03:27:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            __CFRunLoopDoObservers函数详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:27:24.000Z" title="Mon Jan 26 2026 03:27:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">__CFRunLoopDoObservers 函数逐行注释</h2>
<h3 data-id="heading-1">函数概述</h3>
<p><code>__CFRunLoopDoObservers</code> 是 RunLoop 中负责触发观察者回调的核心函数。当 RunLoop 的状态发生变化时（如即将进入循环、即将处理 Timer、即将处理 Source 等），这个函数会被调用来通知所有注册的观察者。</p>
<h3 data-id="heading-2">函数签名</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* rl is locked, rlm is locked on entrance and exit */</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> __CFRunLoopDoObservers(CFRunLoopRef, CFRunLoopModeRef, CFRunLoopActivity) __attribute__((noinline));
</code></pre>
<h4 data-id="heading-3">注释说明</h4>
<ul>
<li><strong>锁状态约定</strong>: 函数入口和出口时，<code>rl</code>（RunLoop）和 <code>rlm</code>（RunLoopMode）都必须处于加锁状态</li>
<li><strong>noinline 属性</strong>: 防止编译器内联优化此函数，可能是为了：
<ul>
<li>便于调试和性能分析</li>
<li>保持调用栈的可读性</li>
<li>控制代码大小</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">参数说明</h4>
<ul>
<li><code>CFRunLoopRef rl</code>: 当前运行的 RunLoop</li>
<li><code>CFRunLoopModeRef rlm</code>: 当前的 RunLoop Mode</li>
<li><code>CFRunLoopActivity activity</code>: 当前 RunLoop 的活动状态（枚举值）</li>
</ul>
<h3 data-id="heading-5">RunLoop Activity 状态枚举</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">CF_OPTIONS</span><span class="hljs-params">(CFOptionFlags, CFRunLoopActivity)</span> {
    kCFRunLoopEntry         = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">0</span>),  <span class="hljs-comment">// 即将进入 RunLoop</span>
    kCFRunLoopBeforeTimers  = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">1</span>),  <span class="hljs-comment">// 即将处理 Timer</span>
    kCFRunLoopBeforeSources = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">2</span>),  <span class="hljs-comment">// 即将处理 Source</span>
    kCFRunLoopBeforeWaiting = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">5</span>),  <span class="hljs-comment">// 即将进入休眠</span>
    kCFRunLoopAfterWaiting  = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">6</span>),  <span class="hljs-comment">// 刚从休眠中唤醒</span>
    kCFRunLoopExit          = (<span class="hljs-number">1UL</span> &lt;&lt; <span class="hljs-number">7</span>),  <span class="hljs-comment">// 即将退出 RunLoop</span>
    kCFRunLoopAllActivities = <span class="hljs-number">0x0FFFFFFF</span>U   <span class="hljs-comment">// 所有活动状态</span>
};
</code></pre>
<h3 data-id="heading-6">完整代码逐行注释</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* DOES CALLOUT */</span>
<span class="hljs-comment">// 【重要标注】此函数会执行外部回调（callout），可能导致：</span>
<span class="hljs-comment">// 1. 长时间阻塞（回调函数耗时）</span>
<span class="hljs-comment">// 2. 重入问题（回调中可能再次操作 RunLoop）</span>
<span class="hljs-comment">// 3. 死锁风险（因此需要在回调前解锁）</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> __CFRunLoopDoObservers(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopActivity activity) {
    
    <span class="hljs-comment">// ==================== 第一部分：性能追踪和初始化 ====================</span>
    
    
    <span class="hljs-comment">// 📊 记录性能追踪点：开始执行 observers</span>
    <span class="hljs-comment">// 参数：事件类型、RunLoop、Mode、活动状态、额外参数</span>
    <span class="hljs-comment">// 可用 Instruments 的 kdebug 工具查看</span>
    cf_trace(KDEBUG_EVENT_CFRL_IS_DOING_OBSERVERS | DBG_FUNC_START, rl, rlm, activity, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 🔒 检查进程是否被 fork</span>
    <span class="hljs-comment">// 如果在 fork 后的子进程中，需要重新初始化 RunLoop 的锁和状态</span>
    <span class="hljs-comment">// 防止继承父进程的锁状态导致死锁</span>
    CHECK_FOR_FORK();

    <span class="hljs-comment">// ==================== 第二部分：检查观察者数量 ====================</span>
    
    <span class="hljs-comment">// 获取当前 Mode 中观察者的数量</span>
    <span class="hljs-comment">// 三目运算符防止 _observers 为 NULL 时崩溃</span>
    CFIndex cnt = rlm-&gt;_observers ? CFArrayGetCount(rlm-&gt;_observers) : <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 快速退出：如果没有观察者，直接返回</span>
    <span class="hljs-comment">// 注意：此时仍持有锁，但不需要手动解锁（调用者会处理）</span>
    <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;
    

    <span class="hljs-comment">// ==================== 第三部分：分配观察者收集数组 ====================</span>
    
    <span class="hljs-comment">/* Fire the observers */</span>
    <span class="hljs-comment">// 📦 声明栈上缓冲区，避免小数组的堆分配开销</span>
    <span class="hljs-comment">// - 如果观察者数量 ≤ 1024：在栈上分配 cnt 个元素的数组</span>
    <span class="hljs-comment">// - 如果观察者数量 &gt; 1024：在栈上分配 1 个元素（占位符）</span>
    <span class="hljs-comment">// 栈分配速度快，但空间有限（通常几 MB）</span>
    STACK_BUFFER_DECL(CFRunLoopObserverRef, buffer, (cnt &lt;= <span class="hljs-number">1024</span>) ? cnt : <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 🎯 确定最终使用的数组指针</span>
    <span class="hljs-comment">// - 小数组（≤1024）：使用栈缓冲区（快速，无需释放）</span>
    <span class="hljs-comment">// - 大数组（&gt;1024）：堆分配（慢，但可容纳更多元素）</span>
    <span class="hljs-comment">// 1024 是经验阈值，平衡性能和栈空间使用</span>
    CFRunLoopObserverRef *collectedObservers = (cnt &lt;= <span class="hljs-number">1024</span>) ? buffer : (CFRunLoopObserverRef *)<span class="hljs-built_in">malloc</span>(cnt * <span class="hljs-keyword">sizeof</span>(CFRunLoopObserverRef));
    
    <span class="hljs-comment">// 实际收集到的观察者计数器（可能小于 cnt）</span>
    CFIndex obs_cnt = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// ==================== 第四部分：收集需要触发的观察者 ====================</span>
    
    <span class="hljs-comment">// 遍历 Mode 中的所有观察者</span>
    <span class="hljs-keyword">for</span> (CFIndex idx = <span class="hljs-number">0</span>; idx &lt; cnt; idx++) {
        
        <span class="hljs-comment">// 获取第 idx 个观察者对象</span>
        CFRunLoopObserverRef rlo = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);
        
        
        <span class="hljs-comment">// 🔍 三重过滤条件（必须全部满足）：</span>
            
        <span class="hljs-comment">// 条件1: 0 != (rlo-&gt;_activities &amp; activity)</span>
        <span class="hljs-comment">// 按位与检查观察者是否关注当前活动状态</span>
        <span class="hljs-comment">// 例如：activity = kCFRunLoopBeforeTimers (0b10)</span>
        <span class="hljs-comment">// _activities = kCFRunLoopBeforeTimers | kCFRunLoopExit (0b10000010)</span>
        <span class="hljs-comment">// 按位与结果 = 0b10 != 0，条件成立</span>

        <span class="hljs-comment">// 条件2: __CFIsValid(rlo)</span>
        <span class="hljs-comment">// 检查观察者是否有效（未被 invalidate）</span>
        <span class="hljs-comment">// 观察者可能在之前的回调中被标记为无效</span>

        <span class="hljs-comment">// 条件3: !__CFRunLoopObserverIsFiring(rlo)</span>
        <span class="hljs-comment">// 检查观察者是否正在执行回调</span>
        <span class="hljs-comment">// 防止重入：如果观察者的回调函数中再次触发相同的 activity，</span>
        <span class="hljs-comment">// 不会重复调用该观察者（避免无限递归）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != (rlo-&gt;_activities &amp; activity) &amp;&amp; __CFIsValid(rlo) &amp;&amp; !__CFRunLoopObserverIsFiring(rlo)) {
            
            <span class="hljs-comment">// ✅ 满足条件的观察者：</span>
            <span class="hljs-comment">// 1. 添加到收集数组</span>
            <span class="hljs-comment">// 2. 增加引用计数（CFRetain）</span>
            <span class="hljs-comment">//    - 防止在后续解锁期间被其他线程释放</span>
            <span class="hljs-comment">//    - 保证回调执行时对象仍然有效</span>
            <span class="hljs-comment">// 3. obs_cnt 递增</span>
            collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo);
        }
    }
    
    <span class="hljs-comment">// ==================== 第五部分：解锁（准备执行回调）====================</span>
    
    <span class="hljs-comment">// 🔓 解锁 RunLoop Mode</span>
    __CFRunLoopModeUnlock(rlm);
    
    <span class="hljs-comment">// 🔓 解锁 RunLoop</span>
    __CFRunLoopUnlock(rl);
    
    <span class="hljs-comment">// ⚠️ 为什么要解锁？</span>
    <span class="hljs-comment">// 1. 避免死锁：观察者回调可能会调用 RunLoop API（如添加 Timer、Source）</span>
    <span class="hljs-comment">// 2. 提高并发：允许其他线程在回调执行期间访问 RunLoop</span>
    <span class="hljs-comment">// 3. 防止长时间持锁：回调可能耗时很长（如网络请求、UI 更新）</span>
    
    <span class="hljs-comment">// 🛡️ 安全性保证：</span>
    <span class="hljs-comment">// - 已经通过 CFRetain 增加了观察者的引用计数</span>
    <span class="hljs-comment">// - collectedObservers 数组是当前线程的局部变量</span>
    <span class="hljs-comment">// - 即使其他线程修改了 rlm-&gt;_observers，也不会影响本次执行</span>
    
    <span class="hljs-comment">// ==================== 第六部分：执行观察者回调 ====================</span>
    
    <span class="hljs-comment">// 遍历收集到的观察者（注意：不是遍历 rlm-&gt;_observers）</span>
    <span class="hljs-keyword">for</span> (CFIndex idx = <span class="hljs-number">0</span>; idx &lt; obs_cnt; idx++) {
        
        <span class="hljs-comment">// 获取当前观察者</span>
        CFRunLoopObserverRef rlo = collectedObservers[idx];
        
        <span class="hljs-comment">// 🔒 锁定观察者对象（细粒度锁）</span>
        <span class="hljs-comment">// 只锁定单个观察者，不影响其他观察者的并发执行</span>
        __CFRunLoopObserverLock(rlo);
        
        <span class="hljs-comment">// 再次检查观察者是否有效</span>
        <span class="hljs-comment">// ⚠️ 为什么要再次检查？</span>
        <span class="hljs-comment">// 在解锁期间，其他线程可能已经调用了 CFRunLoopObserverInvalidate</span>
        <span class="hljs-keyword">if</span> (__CFIsValid(rlo)) {
            
            <span class="hljs-comment">// 检查观察者是否是一次性的（non-repeating）</span>
            <span class="hljs-comment">// 如果是一次性的，执行完回调后需要 invalidate</span>
            Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);
            
            <span class="hljs-comment">// 🚩 设置"正在执行"标志位</span>
            <span class="hljs-comment">// 防止重入（与前面的 !__CFRunLoopObserverIsFiring 配合）</span>
            __CFRunLoopObserverSetFiring(rlo);
            
            <span class="hljs-comment">// 🔓 在执行回调前解锁观察者</span>
            <span class="hljs-comment">// 原因同解锁 RunLoop：防止回调中访问观察者对象时死锁</span>
            __CFRunLoopObserverUnlock(rlo);
            
            <span class="hljs-comment">// ---------- 提取回调信息 ----------</span>
            
            <span class="hljs-comment">// 提取回调函数指针</span>
            <span class="hljs-comment">// 类型：void (*)(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info)</span>
            CFRunLoopObserverCallBack callout = rlo-&gt;_callout;
            
            <span class="hljs-comment">// 提取用户上下文信息（创建观察者时传入的）</span>
            <span class="hljs-type">void</span> *info = rlo-&gt;_context.info;
            
            <span class="hljs-comment">// ---------- 自动释放池 ----------</span>
            
            <span class="hljs-comment">// 🔄 开始自动释放池（ARP = AutoRelease Pool）</span>
            <span class="hljs-comment">// 在 ObjC 运行时环境中，等价于 @autoreleasepool {</span>
            <span class="hljs-comment">// 用于自动管理回调中创建的临时对象</span>
            CFRUNLOOP_ARP_BEGIN(rl)
            
            <span class="hljs-comment">// ---------- 性能追踪 ----------</span>
            
            <span class="hljs-comment">// 📊 记录性能追踪点：开始调用观察者回调</span>
            cf_trace(KDEBUG_EVENT_CFRL_IS_CALLING_OBSERVER | DBG_FUNC_START, callout, rlo, activity, info);
            
            
            <span class="hljs-comment">// ---------- 🎯 核心回调执行 ----------</span>
            
            <span class="hljs-comment">// ⚡ 执行观察者的回调函数</span>
            <span class="hljs-comment">// 宏定义通常是：callout(rlo, activity, info);</span>
            <span class="hljs-comment">// 这是整个函数的核心目的！</span>
            
            <span class="hljs-comment">// ⏰ 回调函数的参数：</span>
            <span class="hljs-comment">// - rlo: 观察者对象本身</span>
            <span class="hljs-comment">// - activity: 当前 RunLoop 活动状态（如 kCFRunLoopBeforeTimers）</span>
            <span class="hljs-comment">// - info: 用户自定义的上下文信息</span>
            
            <span class="hljs-comment">// ⚠️ 回调中可能发生的事情：</span>
            <span class="hljs-comment">// - UI 更新（如 CA::Transaction::observer_callback）</span>
            <span class="hljs-comment">// - 性能监控（如 FPS 检测）</span>
            <span class="hljs-comment">// - 内存管理（如清理缓存）</span>
            <span class="hljs-comment">// - 业务逻辑（如状态同步）</span>
            <span class="hljs-comment">// - 再次操作 RunLoop（如添加/移除 Timer）</span>
            __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(callout, rlo, activity, info);
            
            
            <span class="hljs-comment">// ---------- 性能追踪结束 ----------</span>
            
            <span class="hljs-comment">// 📊 记录性能追踪点：结束调用观察者回调</span>
            <span class="hljs-comment">// 可通过 end - start 计算回调耗时</span>
            cf_trace(KDEBUG_EVENT_CFRL_IS_CALLING_OBSERVER | DBG_FUNC_END, callout, rlo, activity, info);
            
            <span class="hljs-comment">// ---------- 自动释放池结束 ----------</span>
            
            <span class="hljs-comment">// 🔄 结束自动释放池</span>
            <span class="hljs-comment">// 释放回调中创建的所有 autorelease 对象</span>
            CFRUNLOOP_ARP_END()
           
            
            <span class="hljs-comment">// ---------- 处理一次性观察者 ----------</span>
            
            <span class="hljs-comment">// 如果是一次性观察者（non-repeating）</span>
            <span class="hljs-keyword">if</span> (doInvalidate) {
                <span class="hljs-comment">// ❌ 使观察者失效</span>
                <span class="hljs-comment">// 会从 RunLoop 中移除，并标记为无效</span>
                <span class="hljs-comment">// 后续不会再触发此观察者</span>
                CFRunLoopObserverInvalidate(rlo);
            }
            
            <span class="hljs-comment">// 🚩 清除"正在执行"标志位</span>
            <span class="hljs-comment">// 允许此观察者在下次 activity 时再次被触发</span>
            __CFRunLoopObserverUnsetFiring(rlo);
            
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 观察者在解锁期间已被其他线程 invalidate</span>
            
            <span class="hljs-comment">// 🔓 解锁观察者（前面已加锁）</span>
            <span class="hljs-comment">// 跳过回调执行</span>
            __CFRunLoopObserverUnlock(rlo);
        }
        
        <span class="hljs-comment">// 📉 释放引用计数（对应前面的 CFRetain）</span>
        <span class="hljs-comment">// 如果引用计数归零，观察者对象会被销毁</span>
        CFRelease(rlo);
    }
    
    <span class="hljs-comment">// ==================== 第七部分：重新加锁 ====================</span>
    
    <span class="hljs-comment">// 🔒 重新锁定 RunLoop</span>
    __CFRunLoopLock(rl);
    
    <span class="hljs-comment">// 🔒 重新锁定 RunLoop Mode</span>
    __CFRunLoopModeLock(rlm);
    
    <span class="hljs-comment">// ✅ 恢复函数入口时的锁状态</span>
    <span class="hljs-comment">// 满足函数签名中的约定："rl is locked, rlm is locked on entrance and exit"</span>

    <span class="hljs-comment">// ==================== 第八部分：清理资源 ====================</span>
    
    <span class="hljs-comment">// 🗑️ 释放堆内存（如果使用了 malloc）</span>
    <span class="hljs-comment">// - 如果 collectedObservers 指向栈缓冲区（buffer），无需释放</span>
    <span class="hljs-comment">// - 如果 collectedObservers 指向堆内存（malloc），需要手动释放</span>
    <span class="hljs-comment">// 防止内存泄漏</span>
    <span class="hljs-keyword">if</span> (collectedObservers != buffer) <span class="hljs-built_in">free</span>(collectedObservers);
    
    <span class="hljs-comment">// ==================== 第九部分：结束性能追踪 ====================</span>
    
    <span class="hljs-comment">// 📊 记录性能追踪点：完成 observers 执行</span>
    cf_trace(KDEBUG_EVENT_CFRL_IS_DOING_OBSERVERS | DBG_FUNC_END, rl, rlm, activity, <span class="hljs-number">0</span>);
}
</code></pre>
<h3 data-id="heading-7">常见使用场景</h3>
<h4 data-id="heading-8">1. UI 渲染（Core Animation）</h4>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// CA 在 kCFRunLoopBeforeWaiting 时提交渲染事务</span>
<span class="hljs-built_in">CFRunLoopObserverRef</span> observer = <span class="hljs-built_in">CFRunLoopObserverCreate</span>(
    kCFAllocatorDefault, 
    kCFRunLoopBeforeWaiting | kCFRunLoopExit,  <span class="hljs-comment">// 监听这两个状态</span>
    <span class="hljs-literal">YES</span>,  <span class="hljs-comment">// 重复触发</span>
    <span class="hljs-number">2000000</span>,  <span class="hljs-comment">// order = 2000000（在大多数 observer 之后）</span>
    &amp;<span class="hljs-built_in">CA_Transaction_observerCallback</span>,  <span class="hljs-comment">// 回调函数</span>
    <span class="hljs-literal">NULL</span>
);
</code></pre>
<h4 data-id="heading-9">2. 性能监控（FPS 检测）</h4>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// 监控主线程 RunLoop 的卡顿</span>
<span class="hljs-built_in">CFRunLoopObserverRef</span> observer = <span class="hljs-built_in">CFRunLoopObserverCreate</span>(
    kCFAllocatorDefault,
    kCFRunLoopAllActivities,  <span class="hljs-comment">// 监听所有活动</span>
    <span class="hljs-literal">YES</span>,
    <span class="hljs-number">0</span>,
    &amp;performanceMonitorCallback,
    <span class="hljs-literal">NULL</span>
);

<span class="hljs-type">void</span> performanceMonitorCallback(<span class="hljs-built_in">CFRunLoopObserverRef</span> observer, 
                                <span class="hljs-built_in">CFRunLoopActivity</span> activity, 
                                <span class="hljs-type">void</span> *info) {
    <span class="hljs-comment">// 记录时间戳，计算两次回调之间的间隔</span>
    <span class="hljs-comment">// 如果间隔过长，说明发生了卡顿</span>
}
</code></pre>
<h4 data-id="heading-10">3. 内存管理（自动释放池）</h4>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// NSRunLoop 在每次循环前后创建/销毁自动释放池</span>
<span class="hljs-built_in">CFRunLoopObserverRef</span> observer = <span class="hljs-built_in">CFRunLoopObserverCreate</span>(
    kCFAllocatorDefault,
    kCFRunLoopEntry | kCFRunLoopBeforeWaiting | kCFRunLoopExit,
    <span class="hljs-literal">YES</span>,
    <span class="hljs-number">-2147483647</span>,  <span class="hljs-comment">// 极高优先级（负值）</span>
    &amp;autoreleasePoolCallback,
    <span class="hljs-literal">NULL</span>
);
</code></pre>
<h3 data-id="heading-11">总结</h3>
<p>这个函数是理解 RunLoop 机制和 iOS 事件循环的关键，也是许多高级特性（如 UI 渲染、性能监控）的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大屏自适应终极方案：双剑合璧！JS+CSS协同作战实现完美适配]]></title>    <link>https://juejin.cn/post/7598899986856640518</link>    <guid>https://juejin.cn/post/7598899986856640518</guid>    <pubDate>2026-01-26T03:25:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598899986856640518" data-draft-id="7598830215259406372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大屏自适应终极方案：双剑合璧！JS+CSS协同作战实现完美适配"/> <meta itemprop="keywords" content="前端,数据可视化"/> <meta itemprop="datePublished" content="2026-01-26T03:25:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小善后师"/> <meta itemprop="url" content="https://juejin.cn/user/2323746686771772"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大屏自适应终极方案：双剑合璧！JS+CSS协同作战实现完美适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2323746686771772/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小善后师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:25:48.000Z" title="Mon Jan 26 2026 03:25:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：大屏适配的痛点与破局之道</h2>
<p>在数据可视化大屏项目中，开发者常常面临这样的困境：<strong>同样的设计稿，在1920×1080屏幕上完美显示，到了3840×2160或1366×768的屏幕上却面目全非</strong>。文字溢出、布局错乱、图表变形...这些问题的根源在于传统的px单位无法适应多变的屏幕环境。</p>
<p>今天，我将分享一种<strong>JS+CSS协同作战的大屏自适应方案</strong>，它不仅解决了适配问题，还保持了代码的优雅与可维护性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1b56065bb3f4d40b49f7dacce56d974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5bCP5ZaE5ZCO5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770002748&amp;x-signature=EGKSsHPgvUEZn%2FMhJHeNCsb0Bp4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、方案核心思想：视窗单位+动态计算</h2>
<h3 data-id="heading-2">1.1 为什么选择vw/vh？</h3>
<p>传统方案中，我们常用rem、百分比或媒体查询来适配不同屏幕。但在大屏场景下，这些方案各有局限：</p>
<ul>
<li><strong>rem</strong>：依赖根字体大小，复杂场景计算繁琐</li>
<li><strong>百分比</strong>：依赖父元素，多层嵌套时难以维护</li>
<li><strong>媒体查询</strong>：断点固定，无法实现连续自适应</li>
</ul>
<p><strong>vw/vh单位</strong>基于视窗尺寸，天生适合大屏适配：</p>
<ul>
<li><code>1vw</code> = 视窗宽度的1%</li>
<li><code>1vh</code> = 视窗高度的1%</li>
<li>完全独立于DOM结构，计算简单直观</li>
</ul>
<h3 data-id="heading-3">1.2 我们的混合方案优势</h3>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────┐
│         设计稿(1920×1080)            │
├─────────────────────────────────────┤
│  CSS函数：静态转换(开发时)            │
│  JS工具：动态计算(运行时)             │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│     完美适配各种屏幕尺寸              │
└─────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-4">二、CSS方案：开发时的优雅转换</h2>
<h3 data-id="heading-5">2.1 核心SCSS函数实现</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// _variables.scss - 定义设计稿基准</span>
<span class="hljs-variable">$design-width</span>: <span class="hljs-number">1920</span>;
<span class="hljs-variable">$design-height</span>: <span class="hljs-number">1080</span>;

<span class="hljs-comment">// _mixins.scss - 转换函数</span>
<span class="hljs-keyword">@use</span> <span class="hljs-string">'sass:math'</span>;

<span class="hljs-comment">// px转vw：水平方向适配</span>
<span class="hljs-keyword">@function</span> vw(<span class="hljs-variable">$px</span>) {
  <span class="hljs-keyword">@if</span> (unitless(<span class="hljs-variable">$px</span>)) {
    <span class="hljs-variable">$px</span>: <span class="hljs-variable">$px</span> * <span class="hljs-number">1px</span>;
  }
  <span class="hljs-keyword">@return</span> math.div(<span class="hljs-variable">$px</span>, <span class="hljs-variable">$design-width</span>) * <span class="hljs-number">100vw</span>;
}

<span class="hljs-comment">// px转vh：垂直方向适配</span>
<span class="hljs-keyword">@function</span> vh(<span class="hljs-variable">$px</span>) {
  <span class="hljs-keyword">@if</span> (unitless(<span class="hljs-variable">$px</span>)) {
    <span class="hljs-variable">$px</span>: <span class="hljs-variable">$px</span> * <span class="hljs-number">1px</span>;
  }
  <span class="hljs-keyword">@return</span> math.div(<span class="hljs-variable">$px</span>, <span class="hljs-variable">$design-height</span>) * <span class="hljs-number">100vh</span>;
}

<span class="hljs-comment">// 双向适配：同时处理宽高</span>
<span class="hljs-keyword">@function</span> size(<span class="hljs-variable">$width</span>, <span class="hljs-variable">$height</span>: null) {
  <span class="hljs-keyword">@if</span> <span class="hljs-variable">$height</span> == null {
    <span class="hljs-keyword">@return</span> vw(<span class="hljs-variable">$width</span>);
  }
  <span class="hljs-keyword">@return</span> vw(<span class="hljs-variable">$width</span>) vh(<span class="hljs-variable">$height</span>);
}
</code></pre>
<h3 data-id="heading-6">2.2 实际应用场景</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 仪表盘容器</span>
<span class="hljs-selector-class">.dashboard</span> {
  <span class="hljs-comment">// 使用混合函数</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">1800</span>); <span class="hljs-comment">// 1800px → 93.75vw</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">950</span>); <span class="hljs-comment">// 950px → 87.96vh</span>
  <span class="hljs-attribute">margin</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">20</span>) <span class="hljs-built_in">vw</span>(<span class="hljs-number">60</span>);
  
  <span class="hljs-comment">// 复杂布局示例</span>
  <span class="hljs-selector-class">.header</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">80</span>);
    <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">15</span>) <span class="hljs-built_in">vw</span>(<span class="hljs-number">30</span>);
    <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">24</span>); <span class="hljs-comment">// 字体也自适应！</span>
  }
  
  <span class="hljs-selector-class">.chart-container</span> {
    <span class="hljs-comment">// 同时设置宽高</span>
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">850</span>);
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">600</span>);
    
    <span class="hljs-comment">// 边框和圆角也自适应</span>
    <span class="hljs-attribute">border</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">2</span>) solid <span class="hljs-number">#3498db</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">10</span>);
  }
}
</code></pre>
<h3 data-id="heading-7">2.3 可视化转换过程</h3>
<pre><code class="hljs language-text" lang="text">设计稿尺寸          实际屏幕尺寸
  1920px     →      2560px
  ↓转换                ↓显示
  vw(200)    →      10.42vw = 266.67px
  (200/1920*100)    (2560×10.42%)
</code></pre>
<h2 data-id="heading-8">三、JS方案：运行时的灵活计算</h2>
<h3 data-id="heading-9">3.1 核心工具类实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// style-utils.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DESIGN_WIDTH</span> = <span class="hljs-number">1920</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DESIGN_HEIGHT</span> = <span class="hljs-number">1080</span>;

<span class="hljs-comment">/**
 * 大屏自适应工具类
 * 适用于动态计算场景
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ScreenAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">designWidth</span> = <span class="hljs-variable constant_">DESIGN_WIDTH</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">designHeight</span> = <span class="hljs-variable constant_">DESIGN_HEIGHT</span>;
  }
  
  <span class="hljs-comment">/**
   * px转vw
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">px</span> - 设计稿像素值
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} - vw单位字符串
   */</span>
  <span class="hljs-title function_">px2vw</span>(<span class="hljs-params">px</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(px / <span class="hljs-variable language_">this</span>.designWidth) * <span class="hljs-number">100</span>}</span>vw`</span>;
  }
  
  <span class="hljs-comment">/**
   * px转vh
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">px</span> - 设计稿像素值
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} - vh单位字符串
   */</span>
  <span class="hljs-title function_">px2vh</span>(<span class="hljs-params">px</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(px / <span class="hljs-variable language_">this</span>.designHeight) * <span class="hljs-number">100</span>}</span>vh`</span>;
  }
  
  <span class="hljs-comment">/**
   * 批量设置样式（适用于动态创建的元素）
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">element</span> - DOM元素
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">styles</span> - 样式对象 {width: 100, height: 200}
   */</span>
  <span class="hljs-title function_">applyStyles</span>(<span class="hljs-params">element, styles</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> value = styles[key];
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'number'</span>) {
        <span class="hljs-comment">// 根据样式名判断使用vw还是vh</span>
        <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'width'</span>) || key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'left'</span>) || key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'right'</span>)) {
          element.<span class="hljs-property">style</span>[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">px2vw</span>(value);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'height'</span>) || key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'top'</span>) || key.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'bottom'</span>)) {
          element.<span class="hljs-property">style</span>[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">px2vh</span>(value);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 字体、边框等特殊处理</span>
          element.<span class="hljs-property">style</span>[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">px2vh</span>(value);
        }
      }
    });
  }
  
  <span class="hljs-comment">/**
   * 监听窗口变化，实时调整
   */</span>
  <span class="hljs-title function_">initResizeObserver</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> resizeTimer;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-built_in">clearTimeout</span>(resizeTimer);
      resizeTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onResize</span>();
      }, <span class="hljs-number">200</span>);
    };
    
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  }
  
  <span class="hljs-title function_">onResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 可以在这里处理特殊逻辑</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'屏幕尺寸变化，当前视窗:'</span>, 
      <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerWidth}</span>×<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerHeight}</span>`</span>);
  }
}

<span class="hljs-comment">// 导出单例实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScreenAdapter</span>();
</code></pre>
<h3 data-id="heading-10">3.2 Vue/React中的实际应用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue组件中使用</span>
<span class="hljs-keyword">import</span> styleUtil <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/style-utils'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chartStyle</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">300</span>,
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">20</span>
      }
    };
  },
  
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 动态创建元素并应用样式</span>
    <span class="hljs-keyword">const</span> dynamicElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    styleUtil.<span class="hljs-title function_">applyStyles</span>(dynamicElement, {
      <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
      <span class="hljs-attr">padding</span>: <span class="hljs-number">20</span>
    });
    
    <span class="hljs-comment">// 或者直接在模板中使用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chartStyle</span>.<span class="hljs-property">width</span> = styleUtil.<span class="hljs-title function_">px2vw</span>(<span class="hljs-number">400</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chartStyle</span>.<span class="hljs-property">height</span> = styleUtil.<span class="hljs-title function_">px2vh</span>(<span class="hljs-number">300</span>);
  }
};
</code></pre>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React组件中使用</span>
<span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> styleUtil <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/style-utils'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ResponsiveChart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> chartRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (chartRef.<span class="hljs-property">current</span>) {
      <span class="hljs-comment">// 应用动态样式</span>
      styleUtil.<span class="hljs-title function_">applyStyles</span>(chartRef.<span class="hljs-property">current</span>, {
        <span class="hljs-attr">width</span>: <span class="hljs-number">800</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#2c3e50'</span>
      });
    }
    
    <span class="hljs-comment">// 初始化窗口监听</span>
    styleUtil.<span class="hljs-title function_">initResizeObserver</span>();
  }, []);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{chartRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"chart-container"</span>&gt;</span>
      {/* 图表内容 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-11">四、最佳实践：何时用CSS？何时用JS？</h2>
<h3 data-id="heading-12">4.1 CSS方案适用场景 ✅</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// ✅ 推荐使用CSS的场景：</span>

<span class="hljs-comment">// 1. 静态布局</span>
<span class="hljs-selector-class">.layout-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">1800</span>);
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">900</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">20</span>) <span class="hljs-built_in">vw</span>(<span class="hljs-number">30</span>);
}

<span class="hljs-comment">// 2. 常规组件</span>
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">300</span>);
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">200</span>);
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">14</span>);
  
  <span class="hljs-comment">// 伪元素也能完美适配</span>
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">20</span>);
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">vh</span>(<span class="hljs-number">20</span>);
  }
}

<span class="hljs-comment">// 3. 媒体查询中的自适应</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-aspect-ratio</span>: <span class="hljs-number">16</span>/<span class="hljs-number">9</span>) {
  <span class="hljs-selector-class">.sidebar</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">200</span>);
    <span class="hljs-comment">// 横屏特殊处理</span>
  }
}
</code></pre>
<h3 data-id="heading-13">4.2 JS方案适用场景 ✅</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐使用JS的场景：</span>

<span class="hljs-comment">// 1. 动态生成内容</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTooltip</span>(<span class="hljs-params">content, x, y</span>) {
  <span class="hljs-keyword">const</span> tooltip = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  
  styleUtil.<span class="hljs-title function_">applyStyles</span>(tooltip, {
    <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
    <span class="hljs-attr">left</span>: x, <span class="hljs-comment">// 动态坐标</span>
    <span class="hljs-attr">top</span>: y,
    <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-string">'auto'</span>,
    <span class="hljs-attr">padding</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>
  });
  
  <span class="hljs-keyword">return</span> tooltip;
}

<span class="hljs-comment">// 2. 第三方库集成</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initECharts</span>(<span class="hljs-params">domElement</span>) {
  <span class="hljs-keyword">const</span> chart = echarts.<span class="hljs-title function_">init</span>(domElement);
  
  <span class="hljs-comment">// 监听resize</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 使用JS计算的新尺寸</span>
    chart.<span class="hljs-title function_">resize</span>({
      <span class="hljs-attr">width</span>: styleUtil.<span class="hljs-title function_">px2vw</span>(<span class="hljs-number">800</span>),
      <span class="hljs-attr">height</span>: styleUtil.<span class="hljs-title function_">px2vh</span>(<span class="hljs-number">500</span>)
    });
  });
}

<span class="hljs-comment">// 3. 复杂交互计算</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculatePosition</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 基于鼠标位置动态计算</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">left</span>: styleUtil.<span class="hljs-title function_">px2vw</span>(event.<span class="hljs-property">clientX</span>),
    <span class="hljs-attr">top</span>: styleUtil.<span class="hljs-title function_">px2vh</span>(event.<span class="hljs-property">clientY</span>)
  };
}
</code></pre>
<h3 data-id="heading-14">4.3 混合使用示例</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- CSS处理静态布局 --&gt;
  &lt;div class="dashboard" :style="dynamicStyles"&gt;
    &lt;!-- JS处理动态尺寸 --&gt;
    &lt;div class="dynamic-chart" ref="chart"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import styleUtil from '@/utils/style-utils';

export default {
  data() {
    return {
      // JS计算样式
      dynamicStyles: {
        '--chart-width': styleUtil.px2vw(800),
        '--chart-height': styleUtil.px2vh(500)
      }
    };
  },
  
  mounted() {
    // JS处理复杂逻辑
    this.initDynamicContent();
  },
  
  methods: {
    initDynamicContent() {
      // 动态内容使用JS计算
      styleUtil.applyStyles(this.$refs.chart, {
        width: this.getChartWidth(),
        height: this.getChartHeight()
      });
    }
  }
};
&lt;/script&gt;

&lt;style lang="scss"&gt;
.dashboard {
  // CSS处理常规样式
  width: vw(1800);
  height: vh(900);
  
  .dynamic-chart {
    // 使用CSS变量（由JS设置）
    width: var(--chart-width);
    height: var(--chart-height);
    
    // 其他CSS属性
    border-radius: vh(10);
    background: linear-gradient(
      45deg,
      #3498db,
      #2ecc71
    );
  }
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-15">五、性能优化与注意事项</h2>
<h3 data-id="heading-16">5.1 性能对比</h3>

































<table><thead><tr><th>方案</th><th>渲染性能</th><th>灵活性</th><th>维护性</th><th>适用场景</th></tr></thead><tbody><tr><td>纯CSS</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>静态布局、常规组件</td></tr><tr><td>纯JS</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>动态内容、复杂交互</td></tr><tr><td>混合方案</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>大型项目、综合需求</td></tr></tbody></table>
<h3 data-id="heading-17">5.2 常见问题与解决方案</h3>
<p><strong>问题1：字体过小/过大</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 解决方案：设置最小/最大字体</span>
<span class="hljs-keyword">@function</span> responsive-font(<span class="hljs-variable">$min</span>, <span class="hljs-variable">$max</span>, <span class="hljs-variable">$px</span>) {
  <span class="hljs-variable">$vw</span>: math.<span class="hljs-built_in">div</span>(<span class="hljs-variable">$px</span>, <span class="hljs-variable">$design-width</span>) * <span class="hljs-number">100</span>;
  <span class="hljs-keyword">@return</span> clamp(#{<span class="hljs-variable">$min</span>}px, #{<span class="hljs-variable">$vw</span>}vw, #{<span class="hljs-variable">$max</span>}px);
}

<span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">responsive-font</span>(<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">24</span>);
}
</code></pre>
<p><strong>问题2：图片变形</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 解决方案：保持宽高比</span>
<span class="hljs-selector-class">.responsive-image</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">vw</span>(<span class="hljs-number">400</span>);
  <span class="hljs-attribute">height</span>: auto; <span class="hljs-comment">// 高度自适应</span>
  aspect-ratio: <span class="hljs-number">16</span>/<span class="hljs-number">9</span>; <span class="hljs-comment">// 或者设置宽高比</span>
}
</code></pre>
<p><strong>问题3：极端屏幕适配</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 解决方案：JS兜底逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ScreenAdapter</span> {
  <span class="hljs-title function_">px2vw</span>(<span class="hljs-params">px</span>) {
    <span class="hljs-keyword">const</span> vwValue = (px / <span class="hljs-variable language_">this</span>.<span class="hljs-property">designWidth</span>) * <span class="hljs-number">100</span>;
    
    <span class="hljs-comment">// 超大屏幕限制最大尺寸</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> &gt; <span class="hljs-number">3840</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.min(vwValue, <span class="hljs-number">80</span>)}</span>vw`</span>;
    }
    
    <span class="hljs-comment">// 超小屏幕限制最小尺寸</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> &lt; <span class="hljs-number">1366</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.max(vwValue, <span class="hljs-number">5</span>)}</span>vw`</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${vwValue}</span>vw`</span>;
  }
}
</code></pre>
<h2 data-id="heading-18">六、完整示例：数据大屏项目</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d648adb748b54570b91e6ceb6da97f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5bCP5ZaE5ZCO5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770002748&amp;x-signature=CSVgvKuJeoCIVyPpCInYeNJ%2FSfY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-19">结语：选择合适的武器</h2>
<p>CSS方案与JS方案并非竞争关系，而是相辅相成的伙伴。在开发大屏项目时，我的建议是：</p>
<ol>
<li><strong>基础布局使用CSS</strong>：利用SCSS函数保持代码简洁</li>
<li><strong>动态内容使用JS</strong>：利用工具类保持灵活性</li>
<li><strong>关键组件混合使用</strong>：结合两者优势实现最佳效果</li>
</ol>
<p>记住：<strong>没有最好的方案，只有最适合的方案</strong>。根据项目需求和团队习惯，灵活选择组合策略，才能打造出既美观又实用的大屏应用。</p>
<hr/>
<p><strong>立即行动</strong>：在你的下一个大屏项目中，尝试这种混合方案。从一个小组件开始，体验vw/vh单位带来的适配便利，逐步扩展到整个项目。你会发现，大屏适配不再是难题，而是一次愉悦的开发体验！</p>
<p><strong>扩展阅读</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcss-tricks.com%2Ffun-viewport-units%2F" target="_blank" title="https://css-tricks.com/fun-viewport-units/" ref="nofollow noopener noreferrer">CSS视窗单位深度指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fweb%2Ffundamentals%2Fperformance%2Frendering" target="_blank" title="https://developers.google.com/web/fundamentals/performance/rendering" ref="nofollow noopener noreferrer">高性能CSS动画最佳实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解构 Claude Skill：从核心原理到实战指南]]></title>    <link>https://juejin.cn/post/7598899986856689670</link>    <guid>https://juejin.cn/post/7598899986856689670</guid>    <pubDate>2026-01-26T03:33:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598899986856689670" data-draft-id="7598899986856607750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解构 Claude Skill：从核心原理到实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T03:33:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lizhongxuan"/> <meta itemprop="url" content="https://juejin.cn/user/940837683343224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解构 Claude Skill：从核心原理到实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/940837683343224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lizhongxuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:33:21.000Z" title="Mon Jan 26 2026 03:33:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建 AI Agent 的浪潮中，让大模型（LLM）具备“行动能力”是核心诉求。对于 Anthropic 的 Claude 模型而言，这种能力被称为 <strong>Skill</strong>（或 Tool Use）。</p>
<p>本文将基于 Claude 的技术特性，结合 Golang 生态中的 <strong>Eino</strong> 框架，深入剖析 Skill 的工作原理、Prompt 编写技巧以及工程落地的最佳实践。</p>
<h2 data-id="heading-0">第一部分：什么是 Claude Skill？</h2>
<p>简单来说，Skill 是给仅能处理文本的 LLM 装上了“手”和“眼”。它允许开发者定义一组外部工具（API、数据库查询、计算器等），并授权 Claude 在遇到特定问题时调用这些工具。</p>
<p><strong>主要应用场景：</strong></p>
<ul>
<li><strong>获取实时信息：</strong> 查询股价、天气、最新新闻。</li>
<li><strong>执行操作：</strong> 发送邮件、在日历添加事件、购买商品。</li>
<li><strong>复杂计算：</strong> 调用 Wolfram Alpha 或 Python 解释器进行精确计算。</li>
<li><strong>企业数据交互：</strong> 查询公司内部的 CRM 或 SQL 数据库。</li>
</ul>
<h3 data-id="heading-1">1. 核心原理：预测与中断</h3>
<p>Claude 的工具调用并非魔法，其底层逻辑依然基于 <strong>“Next Token Prediction”</strong> 。整个过程是一个精密的“三明治结构”：</p>
<ol>
<li>
<p><strong>感知 (The Brain):</strong> 开发者将用户的提问 + <strong>工具清单 (Schema)</strong> 一并发给 Claude。<em>例子：</em> “Claude，你有两个工具：<code>get_weather(city)</code> 和 <code>send_email(to, body)</code>。用户问：北京天气怎么样？”</p>
</li>
<li>
<p><strong>决策 (Reasoning):</strong> Claude 分析意图。如果它认为需要使用工具，它<strong>不会</strong>生成自然语言回复，而是生成一段特定格式的 <strong>结构化文本</strong>（通常是 XML 或 JSON）。</p>
<ul>
<li><em>Claude:</em> <code>&lt;tool_use&gt;&lt;name&gt;get_weather&lt;/name&gt;&lt;city&gt;Beijing&lt;/city&gt;&lt;/tool_use&gt;</code></li>
</ul>
</li>
<li>
<p><strong>中断与执行:</strong> * Claude <strong>暂停</strong> 生成。</p>
<ul>
<li><strong>你的代码 (Client)</strong> 拦截到这段结构化请求，在后台执行真实的 API 调用。</li>
</ul>
</li>
<li>
<p><strong>反馈 (Feedback):</strong> 你的代码将执行结果（如“25°C”）作为新的输入发回给 Claude。</p>
</li>
<li>
<p><strong>响应 (Response):</strong> Claude 结合执行结果，生成最终给用户的自然语言回答。</p>
<ul>
<li><em>Claude 输出：</em> “北京今天的天气不错，气温是 25°C，晴朗。”</li>
</ul>
</li>
</ol>
<p><strong>关键认知：</strong> Claude 自己不运行工具，<strong>是你的代码在运行工具</strong>。Claude 只是负责“填写参数表单”。</p>
<h2 data-id="heading-2">第二部分：Prompt Engineering 的范式转移</h2>
<p>在开发 Skill 时，“写 Prompt” 的方式发生了本质变化。你不再需要写长篇大论的指令，而是需要编写<strong>精准的 JSON Schema</strong>。</p>
<p><strong>工具定义的 <code>description</code> 字段，就是写给 Claude 看的 Prompt。</strong></p>
<h3 data-id="heading-3">案例：快递查询工具</h3>
<h4 data-id="heading-4">❌ 错误的定义</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查物流"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><em>问题：名字含糊，描述太短，Claude 不知道何时触发，也不知道参数格式。</em></p>
<h4 data-id="heading-5">✅ 正确的定义</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_delivery_status"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"当用户询问包裹位置、发货状态或预计到达时间时使用此工具。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"input_schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"order_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"以 'CN' 开头的10位订单编号。如果用户未提供，请礼貌询问。"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><em>优势：明确了触发场景（Scenario）和参数约束（Constraint）。</em></p>
<h2 data-id="heading-6">第三部分：Eino 框架实战 (Golang)</h2>
<p>在后端开发中，手动拼接上述 JSON 非常繁琐。<strong>Eino</strong> (CloudWeGo 开源框架) 提供了一套优雅的解决方案：<strong>将 Go Struct 自动映射为 Claude Prompt。</strong></p>
<h3 data-id="heading-7">1. 定义入参</h3>
<p>利用 Go 的 <code>struct tag</code> 来编写 Prompt。</p>
<pre><code class="hljs language-c" lang="c">type DeliveryRequest <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-comment">// `desc` 标签的内容会被 Eino 自动提取并传给 Claude</span>
    OrderID <span class="hljs-built_in">string</span> `json:<span class="hljs-string">"order_id"</span> desc:<span class="hljs-string">"以 'CN' 开头的10位订单编号，例如 CN1234567890"</span>`
}
</code></pre>
<h3 data-id="heading-8">2. 实现逻辑</h3>
<p>编写普通的 Go 函数处理业务。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetDeliveryStatus</span><span class="hljs-params">(ctx context.Context, req *DeliveryRequest)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> req.OrderID == <span class="hljs-string">"CN123456"</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"包裹已到达北京转运中心"</span>, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(<span class="hljs-string">"未查询到订单"</span>)
}
</code></pre>
<h3 data-id="heading-9">3. 绑定与自动编排</h3>
<p>Eino 负责中间繁琐的序列化、反序列化和路由分发。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 创建工具</span>
tool, _ := utils.<span class="hljs-title function_ invoke__">NewTool</span>(&amp;utils.ToolConfig{
    <span class="hljs-attr">Name</span>: <span class="hljs-string">"get_delivery_status"</span>,
    <span class="hljs-attr">Desc</span>: <span class="hljs-string">"查询快递状态工具"</span>,
    <span class="hljs-attr">Func</span>: GetDeliveryStatus, // 绑定 Go 函数
})

<span class="hljs-comment">// 绑定到 Claude 模型</span>
chatModel.<span class="hljs-title function_ invoke__">BindTools</span>([]*schema.ToolInfo{tool.<span class="hljs-title function_ invoke__">Info</span>()})
</code></pre>
<h2 data-id="heading-10">第四部分：构建高质量 Skill 的四大要素</h2>
<p>要让 Skill 稳定可靠，仅有基础代码是不够的。以下是经过实战验证的四个关键点：</p>
<h3 data-id="heading-11">1. Description 是核心</h3>
<p><code>desc</code> 决定了工具的“触发率”和“准确率”。</p>
<ul>
<li><strong>技巧：</strong> 在描述中加入 <strong>Negative Prompt</strong>（负向提示）。</li>
<li><em>例：</em> “此工具用于查询当前库存。<strong>注意：不要用于查询历史销售记录。</strong> ”</li>
</ul>
<h3 data-id="heading-12">2. 字段约束显性化</h3>
<p>LLM 不懂隐式规则。</p>
<ul>
<li><strong>技巧：</strong> 在 Struct Tag 中加入<strong>格式要求</strong>和<strong>示例（Example）</strong> 。</li>
<li><em>例：</em> <code>desc:"日期，格式必须为 YYYY-MM-DD，如 2024-01-01"</code>。</li>
</ul>
<h3 data-id="heading-13">3. 返回值设计的艺术</h3>
<p>后端返回给 Claude 的数据（Tool Output）也是 Prompt 的一部分。</p>
<ul>
<li><strong>技巧：</strong> <strong>提高信噪比</strong>。不要返回包含大量无用字段的原始 JSON，只返回 Claude 回答问题所需的数据。</li>
</ul>
<h3 data-id="heading-14">4. 错误处理即教学</h3>
<p>这是最高级的技巧。当工具调用失败时，不要只返回 <code>Error 500</code>。你应该返回一个 <strong>“Teacher Error”</strong> （像老师一样的纠错信息），指导 Claude 自我修正。</p>
<h4 data-id="heading-15">实战案例：汇率转换器的自动纠错</h4>
<p>场景描述：</p>
<p>我们构建一个汇率转换工具。后端只接受标准的 ISO 货币代码（如 CNY, USD），但用户经常习惯说“人民币”或“RMB”。我们将故意不处理前端输入，而是依赖后端报错机制来“教会” Claude。</p>
<p><strong>1. Go 代码实现 (Eino)</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConvertCurrency</span><span class="hljs-params">(ctx context.Context, req *CurrencyRequest)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    validCodes := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>{<span class="hljs-string">"CNY"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"USD"</span>: <span class="hljs-literal">true</span>}
    
    <span class="hljs-comment">// 检查：如果 Claude 传了 "RMB"，我们要拦截</span>
    from := strings.ToUpper(req.FromCurrency)
    
    <span class="hljs-keyword">if</span> !validCodes[from] {
        <span class="hljs-comment">// 【关键点】：不要只返回 "Invalid Currency"。</span>
        <span class="hljs-comment">// 要告诉 Claude 错在哪，以及正确的参考值是什么。</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>, fmt.Errorf(
            <span class="hljs-string">"API Error: 货币代码 '%s' 无效。请仅使用 ISO 4217 标准代码。"</span> + 
            <span class="hljs-string">"提示：如果你想指人民币，请使用 'CNY'；美元请使用 'USD'。请修正参数后重试。"</span>, 
            req.FromCurrency,
        )
    }

    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"转换成功：100 %s = 14.5 %s"</span>, from, req.ToCurrency), <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>2. 实际运行流程</strong></p>
<p>这就是 <strong>“Eino 自动纠错”</strong> 发生的过程。用户完全无感知，但后台发生了两次交互。</p>
<ul>
<li>
<p><strong>Round 1: 第一次尝试（犯错）</strong></p>
<ul>
<li><strong>User:</strong> "把 100 RMB 换成美元。"</li>
<li><strong>Claude 调用:</strong> <code>convert_currency(from="RMB", to="USD")</code></li>
<li><strong>Eino 返回 (Error):</strong> <code>[Error] API Error: 货币代码 'RMB' 无效...提示：如果你想指人民币，请使用 'CNY'...</code></li>
</ul>
</li>
<li>
<p><strong>Round 2: 自我修正（重试）</strong></p>
<ul>
<li><strong>Claude 思考:</strong> "哎呀，工具报错了。它提示我应该用 'CNY'。好的，我重新调用一次。"</li>
<li><strong>Claude 再次调用:</strong> <code>convert_currency(from="CNY", to="USD")</code></li>
<li><strong>Eino 返回 (Success):</strong> <code>转换成功：100 CNY = 14.5 USD</code></li>
</ul>
</li>
<li>
<p><strong>最终回复用户:</strong> "转换完成！100 人民币大约等于 14.5 美元。"</p>
</li>
</ul>
<p>核心价值：</p>
<p>通过这种机制，你把后端逻辑里的 error 变成了对 AI 的直接指导，增强了 Agent 的韧性（Resilience），避免了直接拒绝用户。</p>
<h2 data-id="heading-16">第五部分：进阶与生产环境考量</h2>
<p>在技术分享的尾声，为了展示方案的完整性，我们需要讨论 Agent 在生产环境中的复杂挑战。</p>
<h3 data-id="heading-17">1. 多步推理与 Graph 编排</h3>
<p>现实世界的任务往往不是单一工具能解决的，而是需要 <strong>Tool Chaining（工具链）</strong> 。</p>
<ul>
<li><strong>场景：</strong> 用户问“分析 A 公司的最新财报风险”。</li>
<li><strong>流程：</strong> <code>SearchTool</code> (找财报) -&gt; <code>ReaderTool</code> (读 PDF) -&gt; <code>AnalysisTool</code> (提取数据) -&gt; LLM (总结)。</li>
<li><strong>Eino 优势：</strong> 利用 Eino 的 <code>Graph</code> 或 <code>Chain</code> 能力，可以将多个 Skill 串联起来，甚至实现并行的工具调用，而不是简单的一问一答。</li>
</ul>
<p><strong>代码示例 (Eino Graph 构建)：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建一个 Graph</span>
g := compose.NewGraph[string, string]()

// 添加节点：检索器 -&gt; 分析器 -&gt; 总结大模型
g.<span class="hljs-built_in">AddNode</span>(<span class="hljs-string">"search_tool"</span>, searchTool)
g.<span class="hljs-built_in">AddNode</span>(<span class="hljs-string">"reader_tool"</span>, pdfReader)
g.<span class="hljs-built_in">AddNode</span>(<span class="hljs-string">"summarizer_llm"</span>, chatModel)

// 定义边的流向 (Workflow)
g.<span class="hljs-built_in">AddEdge</span>(compose.START, <span class="hljs-string">"search_tool"</span>)
g.<span class="hljs-built_in">AddEdge</span>(<span class="hljs-string">"search_tool"</span>, <span class="hljs-string">"reader_tool"</span>)
g.<span class="hljs-built_in">AddEdge</span>(<span class="hljs-string">"reader_tool"</span>, <span class="hljs-string">"summarizer_llm"</span>)
g.<span class="hljs-built_in">AddEdge</span>(<span class="hljs-string">"summarizer_llm"</span>, compose.END)

// 编译并运行
runnable, _ := g.<span class="hljs-built_in">Compile</span>(ctx)
result, _ := runnable.<span class="hljs-built_in">Invoke</span>(ctx, <span class="hljs-string">"分析 Apple 2024 Q3 财报"</span>)
</code></pre>
<h3 data-id="heading-18">2. 安全性：Human-in-the-loop (人机回环)</h3>
<p>赋予 AI 行动能力也带来了风险。对于高风险操作（如删除数据、退款转账），必须引入人工确认机制。</p>
<ul>
<li>
<p><strong>设计模式：</strong></p>
<ol>
<li>Claude 决定调用 <code>refund_user</code> 工具。</li>
<li>Eino 拦截调用请求，<strong>暂停 (Suspend)</strong> 执行流。</li>
<li>系统向管理员发送“确认卡片”。</li>
<li>管理员点击“批准”。</li>
<li>Eino <strong>恢复 (Resume)</strong> 执行流，真正运行后端函数。</li>
</ol>
</li>
</ul>
<p><strong>代码示例 (带审批的工具逻辑)：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RefundUser</span><span class="hljs-params">(ctx context.Context, req *RefundRequest)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 1. 检查权限或触发审批流</span>
    <span class="hljs-keyword">if</span> req.Amount &gt; <span class="hljs-number">1000</span> {
        <span class="hljs-comment">// 在实际系统中，这里可能抛出一个特定的 "NeedApprovalError"</span>
        <span class="hljs-comment">// 或者检查 Redis 中的审批 Token 是否存在</span>
        <span class="hljs-keyword">if</span> !IsApproved(ctx, req.TransactionID) {
             TriggerAdminApproval(req)
             <span class="hljs-keyword">return</span> <span class="hljs-string">"SYSTEM: 超过大额限制，已发送审批请求给管理员。请管理员批准后再重试此操作。"</span>, <span class="hljs-literal">nil</span>
        }
    }
    
    <span class="hljs-comment">// 2. 执行退款</span>
    db.ExecuteRefund(req)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"退款成功"</span>, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-19">3. 可观测性与模型评估</h3>
<p>AI 的行为具有不确定性。当 Agent 表现不佳时，我们需要知道是 Prompt 写歪了、工具参数传错了，<strong>还是模型本身的能力不足（智力波动）</strong> 。因此，除了链路追踪，还需要引入<strong>模型能力打分机制</strong>。</p>
<ul>
<li>
<p><strong>最佳实践：</strong> 记录完整的 Trace 并对模型能力进行量化打分。</p>
<ul>
<li><strong>Input:</strong> 用户到底说了什么？</li>
<li><strong>Prompt:</strong> Eino 最终组装发给 Claude 的 Prompt 长什么样？（包含工具定义）</li>
<li><strong>Tool Call:</strong> Claude 吐出的 JSON 参数是什么？</li>
<li><strong>Output:</strong> 工具返回了什么结果？</li>
<li><strong>Latency:</strong> 工具执行耗时多久？</li>
<li><strong>Model Score:</strong>  记录本次交互中模型所展示的能力得分。可以基于人工反馈（Thumbs up/down）或使用另一个更强的模型（Evaluator）对当前模型的回答逻辑、工具使用准确性进行打分。</li>
</ul>
</li>
</ul>
<p><strong>代码示例 (Eino Callbacks + Evaluation)：</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建回调处理器</span>
handler := callbacks.NewHandlerHelper().
    <span class="hljs-comment">// 监听工具调用开始</span>
    OnToolStart(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, info *schema.ToolInfo, input <span class="hljs-type">string</span>)</span></span> {
        log.Printf(<span class="hljs-string">"[Trace] Tool Start: %s | Input: %s"</span>, info.Name, input)
    }).
    <span class="hljs-comment">// 监听工具调用结束</span>
    OnToolEnd(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, info *schema.ToolInfo, output <span class="hljs-type">string</span>)</span></span> {
        log.Printf(<span class="hljs-string">"[Trace] Tool End: %s | Output: %s"</span>, info.Name, output)
    }).
    <span class="hljs-comment">// 监听 LLM 生成结束</span>
    OnModelEnd(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, out *schema.ModelOutput, err <span class="hljs-type">error</span>)</span></span> {
        log.Printf(<span class="hljs-string">"[Trace] Model Token Usage: %d"</span>, out.Usage.TotalTokens)
        
        <span class="hljs-comment">// 异步触发模型能力评估</span>
        <span class="hljs-comment">// 既然日志记录了 Input/Output，我们可以异步调用一个 "Judge Model" </span>
        <span class="hljs-comment">// 来给当前 Claude 的表现打分 (0-10分)，从而监控模型能力是否下降。</span>
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
            score := EvaluateAgentPerformance(out.Content)
            metrics.RecordModelScore(<span class="hljs-string">"claude-3.5-sonnet"</span>, score)
        }()
    }).
    Handler()

<span class="hljs-comment">// 在运行时注入回调</span>
response, _ := chatModel.Generate(
    ctx, 
    userInput, 
    eino.WithCallbacks(handler), <span class="hljs-comment">// 注入观察者</span>
)
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>在 Eino 和 Claude 的体系下开发 Skill，本质上是在进行一场<strong>跨语言的沟通</strong>：你用 Go 代码定义规则，Eino 将其翻译为 JSON Schema，Claude 据此进行推理，最后通过你的 Go 函数与现实世界交互。</p>
<p>记住一条原则：<strong>你的 Go Struct 定义、函数返回值、甚至错误信息，全都是在跟 AI 对话。</strong> 写得越清楚，AI 表现就越智能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6.BTC-网络-北大肖臻老师客堂笔记]]></title>    <link>https://juejin.cn/post/7599181528304156681</link>    <guid>https://juejin.cn/post/7599181528304156681</guid>    <pubDate>2026-01-26T03:37:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599181528304156681" data-draft-id="7599247962821427227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6.BTC-网络-北大肖臻老师客堂笔记"/> <meta itemprop="keywords" content="前端,区块链"/> <meta itemprop="datePublished" content="2026-01-26T03:37:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端涂涂"/> <meta itemprop="url" content="https://juejin.cn/user/3740972207312249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6.BTC-网络-北大肖臻老师客堂笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3740972207312249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端涂涂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:37:05.000Z" title="Mon Jan 26 2026 03:37:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份关于比特币网络原理的总结基于你提供的视频内容。比特币不仅是一种数字货币，更是一个精密的层级架构系统。</p>
<hr/>
<h2 data-id="heading-0">1. 比特币的网络分层架构</h2>
<p>比特币的运行主要依赖于两个层级的协作：</p>
<ul>
<li><strong>应用层 (Application Layer)</strong>：即 <strong>Bitcoin Blockchain</strong>。这一层处理账本、交易记录、共识机制（如 PoW）以及账户余额的验证。</li>
<li><strong>网络层 (Network Layer)</strong>：即 <strong>P2P Overlay Network</strong>。所有的比特币节点在应用层之下，通过互联网建立了一个对等网络（P2P）。</li>
<li><strong>Overlay（覆盖网络）</strong>：它运行在互联网之上，节点之间通过特定的协议相互链接，而不依赖中央服务器。</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 网络节点的类型与发现</h2>
<p>在一个去中心化的网络中，新节点如何找到组织？</p>
<ul>
<li><strong>种子节点 (Seed Nodes)</strong>：由比特币社区长期维护的可靠节点。新节点加入时，通常会先通过 DNS 或硬编码的地址连接到种子节点，从而获取当前活跃节点的列表。</li>
<li><strong>超级节点 / 主节点 (Full Nodes/Super Nodes)</strong>：这些节点保存了完整的区块链数据，并全天候在线。它们负责验证每一笔交易和每一个区块，是网络的“脊梁”。</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 消息传播机制：Flooding (洪泛算法)</h2>
<p>比特币网络采用一种简单而直接的通信方式：</p>
<ul>
<li><strong>机制</strong>：当一个节点收到一笔新交易或一个新区块时，它会先验证其合法性。如果合法，则将其转发给与其直接相连的所有邻居节点。</li>
<li><strong>Best Effort (尽力而为)</strong>：由于 P2P 网络的复杂性，信息传递不保证 100% 成功，也不保证顺序。网络通过多次冗余传播，确保绝大多数节点最终都能同步数据。</li>
</ul>
<hr/>
<h2 data-id="heading-3">4. 网络特性的权衡</h2>
<p>视频中强调了比特币网络设计的核心逻辑，可以用六个字概括：</p>
<blockquote>
<p><strong>Simple, Robust, but not Efficient.</strong>
(简单、鲁棒/健壮，但并不高效)</p>
</blockquote>
<ul>
<li><strong>Simple (简单)</strong>：通信协议并不复杂，没有繁琐的路由选择。</li>
<li><strong>Robust (鲁棒)</strong>：即便网络中大量节点突然离线，剩下的节点依然能通过 P2P 链接维持网络运转，没有单点故障。</li>
<li><strong>Not Efficient (低效)</strong>：为了安全和去中心化，每条信息都要被多次重复传输。相比于中心化服务器，它的延迟更高，带宽消耗更大。</li>
</ul>
<hr/>
<h2 data-id="heading-4">5. 核心原理总结表</h2>






























<table><thead><tr><th>维度</th><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>拓扑结构</strong></td><td>动态 P2P</td><td>节点随时加入/退出，没有中心控制。</td></tr><tr><td><strong>连通性</strong></td><td>邻居节点</td><td>每个节点通常与 8-12 个邻居节点保持连接。</td></tr><tr><td><strong>验证逻辑</strong></td><td>先验证再转发</td><td>防止垃圾信息或恶意攻击充斥网络。</td></tr><tr><td><strong>容错性</strong></td><td>高</td><td>只要有少量节点存活，区块链账本就不会丢失。</td></tr></tbody></table>
<p><img alt="在这里插入图片描述转存失败，建议直接上传图片文件" src="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何深入理解业务需求：从技术视角到价值落地]]></title>    <link>https://juejin.cn/post/7598744870996885547</link>    <guid>https://juejin.cn/post/7598744870996885547</guid>    <pubDate>2026-01-26T03:52:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598744870996885547" data-draft-id="7599496293161812009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何深入理解业务需求：从技术视角到价值落地"/> <meta itemprop="keywords" content="人工智能,架构,全栈"/> <meta itemprop="datePublished" content="2026-01-26T03:52:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何深入理解业务需求：从技术视角到价值落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:52:20.000Z" title="Mon Jan 26 2026 03:52:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">引言</h2>
<p>在软件开发中，<strong>业务需求分析</strong>常常决定了项目的成败。很多技术人员喜欢直接“上手写代码”，却忽视了需求背后的业务逻辑与价值目标。结果往往导致 <strong>“代码没问题，但产品没价值”</strong> 。</p>
<p>本文将从技术视角出发，深入探讨如何理解业务需求，帮助开发者将抽象的业务逻辑转化为可落地的技术实现。本文适用于产品经理、系统架构师以及希望提升“业务敏感度”的技术从业者。</p>
<hr/>
<h2 data-id="heading-1">一、问题与背景：为什么开发者需要理解业务需求？</h2>
<p>在实际项目中，技术人员面对的痛点包括：</p>
<ul>
<li>需求模糊，导致反复返工；</li>
<li>功能实现正确，但未能解决业务痛点；</li>
<li>技术决策与业务目标脱节，缺乏价值导向。</li>
</ul>
<p>例如，某电商项目提出“提升下单转化率”的目标，研发团队却只关注性能优化，而忽略了关键的“推荐逻辑”与“结算体验”。这就是典型的技术脱离业务的案例。</p>
<p>业务需求的理解，不仅是对“做什么”的解读，更是对“为什么做”的抽象和重构。</p>
<hr/>
<h2 data-id="heading-2">二、解决方案与实践方法</h2>
<h3 data-id="heading-3">1. 理解业务需求的“三层模型”</h3>
<p>我们可以将理解业务需求的过程分为三层：</p>

























<table><thead><tr><th>层级</th><th>说明</th><th>输出成果</th></tr></thead><tbody><tr><td>业务层 (Why)</td><td>业务目标、价值与痛点</td><td>业务目标文档、业务指标</td></tr><tr><td>功能层 (What)</td><td>功能模块与流程设计</td><td>功能说明书、用例模型</td></tr><tr><td>技术层 (How)</td><td>技术实现与架构方案</td><td>系统架构、接口定义</td></tr></tbody></table>
<p>例如，需求“提升用户活跃度”：</p>
<ul>
<li><strong>业务层</strong>：分析活跃度低的原因（如留存率低、登录习惯差）。</li>
<li><strong>功能层</strong>：提出“签到领积分”、“推送提醒”等方案。</li>
<li><strong>技术层</strong>：设计对应的微服务接口与任务调度系统。</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. 使用事件风暴(Event Storming)分析业务流程</h3>
<p>事件风暴是一种快速建模方法，帮助团队以 <strong>事件驱动视角</strong> 理解业务。</p>
<h4 data-id="heading-5">实践步骤：</h4>
<ol>
<li><strong>收集关键业务事件</strong>（如“用户注册”“下单成功”“订单支付完成”）。</li>
<li><strong>绘制事件时间线</strong>，展示业务流程中的逻辑顺序。</li>
<li><strong>识别聚合根(Aggregate Root)</strong> ，寻找系统边界与核心实体。</li>
<li><strong>提炼命令与查询模型</strong>，为后续的技术实现做准备。</li>
</ol>
<h4 data-id="heading-6">简化示例（订单支付流程）：</h4>
<pre><code class="hljs language-css" lang="css">graph LR
<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[用户下单]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[系统生成订单]</span>
<span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[库存校验]</span>
C --&gt; D<span class="hljs-selector-attr">[支付网关调用]</span>
D --&gt; E<span class="hljs-selector-attr">[订单支付完成]</span>
E --&gt; F<span class="hljs-selector-attr">[触发发货流程]</span>
</code></pre>
<p>这张简单的业务事件图帮助团队快速识别系统职责与服务边界，例如：</p>
<ul>
<li>库存校验 → 属于“库存微服务”</li>
<li>支付网关调用 → 属于“支付服务”</li>
<li>发货流程 → 属于“物流服务”</li>
</ul>
<hr/>
<h3 data-id="heading-7">3. 转化为技术实现（代码与模型）</h3>
<p>在明确业务逻辑后，技术实现应以“业务语言”命名和组织代码。例如，使用DDD（领域驱动设计）思想：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 示例：订单业务逻辑的领域模型（Python）</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, user_id, items</span>):
        <span class="hljs-variable language_">self</span>.user_id = user_id
        <span class="hljs-variable language_">self</span>.items = items
        <span class="hljs-variable language_">self</span>.status = <span class="hljs-string">"CREATED"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">confirm_payment</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, payment_id</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-symbol">payment_id:</span>
            <span class="hljs-keyword">raise</span> <span class="hljs-title class_">ValueError</span>(<span class="hljs-string">"Invalid payment"</span>)
        <span class="hljs-variable language_">self</span>.status = <span class="hljs-string">"PAID"</span>
        <span class="hljs-variable language_">self</span>.trigger_delivery()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">trigger_delivery</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>):
        print(<span class="hljs-string">"Triggering delivery workflow..."</span>)

<span class="hljs-comment"># 示例调用</span>
order = <span class="hljs-title class_">Order</span>(user_id=<span class="hljs-number">1001</span>, items=[<span class="hljs-string">'item-001'</span>])
order.confirm_payment(payment_id=<span class="hljs-string">'pay-12345'</span>)
</code></pre>
<p>💡 <strong>关键点</strong>：业务行为（如 <code>confirm_payment</code>）在模型中以动词形式出现，使代码本身体现业务语义，而不仅是技术实现。</p>
<hr/>
<h2 data-id="heading-8">三、优缺点分析与实战建议</h2>
<h3 data-id="heading-9">✅ 优点</h3>
<ul>
<li><strong>减少沟通损耗</strong>：业务与技术有共同语言。</li>
<li><strong>提高需求转化效率</strong>：快速定位业务痛点，提升交付质量。</li>
<li><strong>增强系统的可维护性</strong>：业务逻辑内聚清晰、代码语义可读。</li>
</ul>
<h3 data-id="heading-10">⚠️ 缺点</h3>
<ul>
<li><strong>前期投入较大</strong>：业务建模需团队共同参与，初期成本较高。</li>
<li><strong>理解深度依赖领域经验</strong>：缺乏业务背景的团队可能误判需求。</li>
</ul>
<h3 data-id="heading-11">💡 实战建议</h3>
<ol>
<li><strong>与业务方共建模型</strong>：定期举办“业务建模工作坊”。</li>
<li><strong>采用领域术语命名代码</strong>：让代码即文档。</li>
<li><strong>从结果出发反推需求</strong>：始终问自己——“这段代码为业务创造了什么价值？”</li>
</ol>
<hr/>
<h2 data-id="heading-12">四、结论</h2>
<p>理解业务需求，是技术工程师迈向 <strong>“技术与商业融合”</strong> 的必经之路。<br/>
它不仅仅是“看懂PRD”，更是一种将抽象业务目标转化为工程语言的能力。</p>
<p>未来，随着 <strong>AI 辅助建模</strong>、<strong>低代码平台</strong> 的成熟，开发者的角色将不仅限于“技术实现者”，而会成为 <strong>“业务价值创造者”</strong> 。</p>
<hr/>
<h2 data-id="heading-13">五、参考资料</h2>
<ol>
<li>Eric Evans. <em>Domain-Driven Design: Tackling Complexity in the Heart of Software.</em></li>
<li>Alberto Brandolini. <em>Introducing Event Storming: An Act of Deliberate Discovery.</em></li>
<li>Martin Fowler. <a href="https://link.juejin.cn?target=https%3A%2F%2Fmartinfowler.com%2FeaaCatalog%2F" target="_blank" title="https://martinfowler.com/eaaCatalog/" ref="nofollow noopener noreferrer">Patterns of Enterprise Application Architecture</a>.</li>
<li>ThoughtWorks TechRadar: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.thoughtworks.com%2Fradar" target="_blank" title="https://www.thoughtworks.com/radar" ref="nofollow noopener noreferrer">Understanding the Value of Domain-Driven Design</a>.</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[事件风暴（Event Storming）** 通常帮助团队理解复杂业务领域]]></title>    <link>https://juejin.cn/post/7598830215259783204</link>    <guid>https://juejin.cn/post/7598830215259783204</guid>    <pubDate>2026-01-26T03:54:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598830215259783204" data-draft-id="7598830215259750436" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="事件风暴（Event Storming）** 通常帮助团队理解复杂业务领域"/> <meta itemprop="keywords" content="架构,人工智能,全栈"/> <meta itemprop="datePublished" content="2026-01-26T03:54:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            事件风暴（Event Storming）** 通常帮助团队理解复杂业务领域
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:54:52.000Z" title="Mon Jan 26 2026 03:54:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">🧩 一、事件风暴结果的典型构成</h2>
<p>一次完整的事件风暴通常会产出以下几类信息：</p>



































<table><thead><tr><th>类型</th><th>示例</th><th>含义</th></tr></thead><tbody><tr><td><strong>领域事件 (Domain Event)</strong></td><td><code>订单已创建</code>、<code>支付完成</code></td><td>系统中发生的业务事实</td></tr><tr><td><strong>命令 (Command)</strong></td><td><code>创建订单</code>、<code>确认支付</code></td><td>用户或系统的行为意图</td></tr><tr><td><strong>聚合 (Aggregate)</strong></td><td>订单、用户、商品</td><td>管理业务状态与规则的核心模型</td></tr><tr><td><strong>外部系统 / 参与者 (Actor/System)</strong></td><td>支付网关、库存系统</td><td>与本系统交互的外部要素</td></tr><tr><td><strong>策略/流程 (Policy/Process)</strong></td><td>“支付完成后触发发货”</td><td>事件响应逻辑或业务规则</td></tr></tbody></table>
<p>事件风暴的核心价值是：让事件流串联起各领域边界。</p>
<hr/>
<h2 data-id="heading-1">🧭 二、从事件风暴到架构的映射步骤</h2>
<h3 data-id="heading-2"><strong>1️⃣ 步骤一：识别领域边界与限界上下文 (Bounded Context)</strong></h3>
<blockquote>
<p>每个“领域聚集”的事件序列，可归入一个上下文（Context）。</p>
</blockquote>
<p>例如在一个电商事件风暴中：</p>
<ul>
<li>用户注册、登录相关事件 → <code>用户上下文</code></li>
<li>订单创建、支付、发货等事件 → <code>订单上下文</code></li>
<li>积分计算、优惠券使用 → <code>营销上下文</code></li>
</ul>
<p>这些上下文将成为架构中的服务单元（可能是微服务、模块或限界组件）。</p>
<hr/>
<h3 data-id="heading-3"><strong>2️⃣ 步骤二：定义上下文间的交互</strong></h3>
<p>交互通常体现为 <strong>事件流或命令调用</strong>，对应系统中的：</p>
<ul>
<li>异步事件总线（Kafka、RabbitMQ 等）</li>
<li>RESTful API / gRPC 调用</li>
<li>Saga / Event-Driven Orchestration 流程</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">订单上下文(Order Context) 
   ↓ 触发事件 → <span class="hljs-selector-attr">[支付完成事件]</span>
支付上下文(Payment Context)
   ↓ 响应事件 → <span class="hljs-selector-attr">[发货指令]</span>
物流上下文(Shipping Context)
</code></pre>
<p>通过这些交互，可以逐步显现系统架构中的依赖关系。</p>
<hr/>
<h3 data-id="heading-4"><strong>3️⃣ 步骤三：映射到技术架构层级</strong></h3>
<p>将业务上下文映射到常见的三层或微服务架构中：</p>






























<table><thead><tr><th>层级</th><th>内容</th><th>技术实现</th></tr></thead><tbody><tr><td><strong>接口层 (API Layer)</strong></td><td>接收命令</td><td>Spring Boot Controller、NestJS Controller</td></tr><tr><td><strong>应用层 (Application Layer)</strong></td><td>协调业务用例</td><td>Service、CommandHandler</td></tr><tr><td><strong>领域层 (Domain Layer)</strong></td><td>封装领域逻辑</td><td>Entity、Aggregate、Repository</td></tr><tr><td><strong>基础设施层 (Infrastructure Layer)</strong></td><td>外部依赖</td><td>DB、消息队列、远程调用</td></tr></tbody></table>
<p>这些定义帮助从“业务语言”过渡到“工程实现语言”。</p>
<hr/>
<h3 data-id="heading-5"><strong>4️⃣ 步骤四：绘制架构图</strong></h3>
<p>以下是一个示意图，将事件风暴结果映射为服务及事件流：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">graph</span> <span class="hljs-selector-tag">LR</span>
    <span class="hljs-selector-tag">U</span><span class="hljs-selector-attr">[用户上下文]</span> <span class="hljs-selector-tag">--</span>&gt;|创建订单| <span class="hljs-selector-tag">O</span><span class="hljs-selector-attr">[订单服务]</span>
    <span class="hljs-selector-tag">O</span> <span class="hljs-selector-tag">--</span>&gt;|发布事件: 订单已创建| <span class="hljs-selector-tag">P</span><span class="hljs-selector-attr">[支付服务]</span>
    <span class="hljs-selector-tag">P</span> <span class="hljs-selector-tag">--</span>&gt;|触发事件: 支付完成| <span class="hljs-selector-tag">L</span><span class="hljs-selector-attr">[物流服务]</span>
    <span class="hljs-selector-tag">O</span> <span class="hljs-selector-tag">--</span>&gt;|监听事件: 支付完成| <span class="hljs-selector-tag">L</span>
    <span class="hljs-selector-tag">L</span> <span class="hljs-selector-tag">--</span>&gt;|更新订单状态| <span class="hljs-selector-tag">O</span>
    <span class="hljs-selector-tag">subgraph</span> <span class="hljs-selector-tag">MessageBus</span><span class="hljs-selector-attr">[事件总线]</span>
    <span class="hljs-selector-tag">end</span>
    <span class="hljs-selector-tag">O</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt; <span class="hljs-selector-tag">MessageBus</span>
    <span class="hljs-selector-tag">P</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt; <span class="hljs-selector-tag">MessageBus</span>
    <span class="hljs-selector-tag">L</span> <span class="hljs-selector-tag">-</span><span class="hljs-selector-class">.-</span>&gt; <span class="hljs-selector-tag">MessageBus</span>
</code></pre>
<p>🧠 <strong>解读</strong>：</p>
<ul>
<li>各上下文（用户、订单、支付、物流）对应微服务。</li>
<li>它们之间通过 <strong>事件总线</strong> 异步通信。</li>
<li>事件名称直接继承自事件风暴的便利贴结果，语义一致。</li>
</ul>
<hr/>
<h3 data-id="heading-6"><strong>5️⃣ 步骤五：补充系统视角（非功能需求）</strong></h3>
<p>事件风暴主要关注业务，但架构转化时还要考虑：</p>




















<table><thead><tr><th>维度</th><th>示例</th><th>对应设计</th></tr></thead><tbody><tr><td><strong>数据持久化</strong></td><td>订单表、事件溯源表</td><td>MongoDB / PostgreSQL / Event Store</td></tr><tr><td><strong>通信模式</strong></td><td>异步事件 → Kafka；同步接口 → REST/gRPC</td><td/></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多线程的这9种用途，99%的人不知道！]]></title>    <link>https://juejin.cn/post/7598830215259799588</link>    <guid>https://juejin.cn/post/7598830215259799588</guid>    <pubDate>2026-01-26T03:55:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598830215259799588" data-draft-id="7598830215259766820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多线程的这9种用途，99%的人不知道！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T03:55:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多线程的这9种用途，99%的人不知道！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T03:55:06.000Z" title="Mon Jan 26 2026 03:55:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>并发编程是一项非常重要的技术，无论在面试，还是工作中出现的频率非常高。</p>
<p>之前我发表的一篇《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247492962%26idx%3D1%26sn%3D17ed1d2ed950b4e9160218b296d19d4e%26chksm%3Dc0e83d8af79fb49cc72fcafc8ed62822263106e54675ea8406a2e3daadb44e25364275af9082%26token%3D245805875%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247492962&amp;idx=1&amp;sn=17ed1d2ed950b4e9160218b296d19d4e&amp;chksm=c0e83d8af79fb49cc72fcafc8ed62822263106e54675ea8406a2e3daadb44e25364275af9082&amp;token=245805875&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">聊聊并发编程的10个坑</a>》，在全网广受好评。说明了这类文章还是比较有价值的，接下来，打算继续聊聊并发编程这个话题。</p>
<p>并发编程说白了就是多线程编程，但多线程一定比单线程效率更高？</p>
<p>答：不一定，要看具体业务场景。</p>
<p>毕竟如果使用了多线程，那么线程之间的竞争和抢占cpu资源，线程的上下文切换，也是相对来说比较耗时的操作。</p>
<p>下面这几个问题在面试中，你必定遇到过：</p>
<ol>
<li>你在哪来业务场景中使用过多线程？</li>
<li>怎么用的？</li>
<li>踩过哪些坑？</li>
</ol>
<p>今天聊聊我之前在项目中用并发编程的12种业务场景，给有需要的朋友一个参考。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c1cdd0696df47feb415bb55e04c26fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=AX22MWpmhHkaa4S1zqLEkUSOTVI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">1. 简单定时任务</h2>
<p>各位亲爱的朋友，你没看错，<code>Thread</code>类真的能做定时任务。如果你看过一些<code>定时任务框架</code>的源码，你最后会发现，它们的底层也会使用Thread类。</p>
<p>实现这种定时任务的具体代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"下载文件"</span>);
                Thread.sleep(<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(e);
            }
        }
    }).start();
}
</code></pre>
<p>使用Thread类可以做最简单的定时任务，在run方法中有个while的死循环（当然还有其他方式），执行我们自己的任务。有个需要特别注意的地方是，需要用<code>try...catch</code>捕获异常，否则如果出现异常，就直接退出循环，下次将无法继续执行了。</p>
<p>但这种方式做的定时任务，只能周期性执行，不能支持定时在某个时间点执行。</p>
<p>特别提醒一下，该线程建议定义成<code>守护线程</code>，可以通过<code>setDaemon</code>方法设置，让它在后台默默执行就好。</p>
<p>使用场景：比如项目中有时需要每隔5分钟去<code>下载某个文件</code>，或者每隔10分钟去读取模板文件<code>生成静态html页面</code>等等，一些简单的周期性任务场景。</p>
<p>使用<code>Thread</code>类做定时任务的优缺点：</p>
<ul>
<li>
<p>优点：这种定时任务非常简单，学习成本低，容易入手，对于那些简单的周期性任务，是个不错的选择。</p>
</li>
<li>
<p>缺点：不支持指定某个时间点执行任务，不支持延迟执行等操作，功能过于单一，无法应对一些较为复杂的场景。</p>
</li>
</ul>
<h2 data-id="heading-2">2.监听器</h2>
<p>有时候，我们需要写个监听器，去监听某些数据的变化。</p>
<p>比如：我们在使用<code>canal</code>的时候，需要监听<code>binlog</code>的变化，能够及时把数据库中的数据，同步到另外一个业务数据库中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/affe454823004309bd1f1dbe03a9554b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=EXteLiBSOsZaDIQQK6wQ8MkAH94%3D" alt="" loading="lazy"/>
如果直接写一个监听器去监听数据就太没意思了，我们想实现这样一个功能：在配置中心有个开关，配置监听器是否开启，如果开启了使用单线程异步执行。</p>
<p>主要代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> CanalService {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> Thread thread;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CanalConnector canalConnector;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//连接canal</span>
        <span class="hljs-keyword">while</span>(running) {
           <span class="hljs-comment">//业务处理</span>
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
       thread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>::handle, <span class="hljs-string">"name"</span>);
       running = <span class="hljs-literal">true</span>;
       thread.start();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">if</span>(!running) {
          <span class="hljs-keyword">return</span>;
       }
       running = <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<p>在start方法中开启了一个线程，在该线程中异步执行handle方法的具体任务。然后通过调用stop方法，可以停止该线程。</p>
<p>其中，使用<code>volatile</code>关键字控制的running变量作为开关，它可以控制线程中的状态。</p>
<p>接下来，有个比较关键的点是：如何通过配置中心的配置，控制这个开关呢？</p>
<p>以<code>apollo</code>配置为例，我们在配置中心的后台，修改配置之后，自动获取最新配置的核心代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanalConfig</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CanalService canalService;

    <span class="hljs-meta">@ApolloConfigChangeListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">change</span><span class="hljs-params">(ConfigChangeEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> event.getChange(<span class="hljs-string">"test.canal.enable"</span>).getNewValue();
        <span class="hljs-keyword">if</span>(BooleanUtils.toBoolean(value)) {
            canalService.start();
        } <span class="hljs-keyword">else</span> {
            canalService.stop();
        }
    }
}
</code></pre>
<p>通过<code>apollo</code>的<code>ApolloConfigChangeListener</code>注解，可以监听配置参数的变化。</p>
<p>如果<code>test.canal.enable</code>开关配置的true，则调用canalService类的start方法开启canal数据同步功能。如果开关配置的false，则调用canalService类的stop方法，自动停止canal数据同步功能。</p>
<h2 data-id="heading-3">3.收集日志</h2>
<p>在某些高并发的场景中，我们需要收集部分用户的日志（比如：用户登录的日志），写到数据库中，以便于做分析。</p>
<p>但由于项目中，还没有引入消息中间件，比如：<code>kafka</code>、<code>rocketmq</code>等。</p>
<p>如果直接将日志同步写入数据库，可能会影响接口性能。</p>
<p>所以，大家很自然想到了异步处理。</p>
<p>实现这个需求最简单的做法是，开启一个线程，异步写入数据到数据库即可。</p>
<p>这样做，可以是可以。</p>
<p>但如果用户登录操作的耗时，比异步写入数据库的时间要少得多。这样导致的结果是：生产日志的速度，比消费日志的速度要快得多，最终的性能瓶颈在消费端。</p>
<p>其实，还有更优雅的处理方式，虽说没有使用消息中间件，但借用了它的思想。</p>
<p>这套记录登录日志的功能，分为：日志生产端、日志存储端和日志消费端。</p>
<p>如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d39d5d0bdd84f22ac94821a4c7f3dc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=2MIfQwu%2FLeEcPguNAUjA8AQwuhw%3D" alt="" loading="lazy"/></p>
<p>先定义了一个阻塞队列。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginLogQueue</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_MAX_SIZE</span>    <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-type">BlockingQueueblockingQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(QUEUE_MAX_SIZE);

    <span class="hljs-comment">//生成消息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">push</span><span class="hljs-params">(LoginLog loginLog)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.queue.add(loginLog);
    } 

    <span class="hljs-comment">//消费消息</span>
    <span class="hljs-keyword">public</span> LoginLog <span class="hljs-title function_">poll</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LoginLog</span> <span class="hljs-variable">loginLog</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            loginLog = <span class="hljs-built_in">this</span>.queue.take();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>然后定义了一个日志的生产者。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginSerivce</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginLogQueue loginLogQueue;

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">login</span><span class="hljs-params">(UserInfo userInfo)</span> {
        <span class="hljs-comment">//业务处理</span>
        <span class="hljs-type">LoginLog</span> <span class="hljs-variable">loginLog</span> <span class="hljs-operator">=</span> convert(userInfo);
        loginLogQueue.push(loginLog);
    }  
}
</code></pre>
<p>接下来，定义了日志的消费者。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInfoConsumer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginLogQueue queue;

    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> voit init {
       <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
          <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
              <span class="hljs-type">LoginLog</span> <span class="hljs-variable">loginLog</span> <span class="hljs-operator">=</span> queue.take();
              <span class="hljs-comment">//写入数据库</span>
          }
        }).start();
    }
}
</code></pre>
<p>当然，这个例子中使用单线程接收登录日志，为了提升性能，也可以使用线程池来处理业务逻辑（比如：写入数据库）等。</p>
<h2 data-id="heading-4">4.excel导入</h2>
<p>我们可能会经常收到运营同学提过来的excel数据导入需求，比如：将某一大类下的所有子类一次性导入系统，或者导入一批新的供应商数据等等。</p>
<p>我们以导入供应商数据为例，它所涉及的业务流程很长，比如：</p>
<ol>
<li>调用天眼查接口校验企业名称和统一社会信用代码。</li>
<li>写入供应商基本表</li>
<li>写入组织表</li>
<li>给供应商自动创建一个用户</li>
<li>给该用户分配权限</li>
<li>自定义域名</li>
<li>发站内通知</li>
</ol>
<p>等等。</p>
<p>如果在程序中，解析完excel，读取了所有数据之后。用单线程一条条处理业务逻辑，可能耗时会非常长。</p>
<p>为了提升excel数据导入效率，非常有必要使用多线程来处理。</p>
<p>当然在java中实现多线程的手段有很多种，下面重点聊聊java8中最简单的实现方式：<code>parallelStream</code>。</p>
<p>伪代码如下：</p>
<pre><code class="hljs language-java" lang="java">supplierList.parallelStream().forEach(x -&gt; importSupplier(x));
</code></pre>
<p><code>parallelStream</code>是一个并行执行的流，它默认通过<code>ForkJoinPool</code>实现的，能提高你的多线程任务的速度。</p>
<p><code>ForkJoinPool</code>处理的过程会分而治之，它的核心思想是：<code>将一个大任务切分成多个小任务</code>。每个小任务都能单独执行，最后它会把所用任务的执行结果进行汇总。</p>
<p>下面用一张图简单介绍一下ForkJoinPool的原理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49631443b7274584a83313137ae2e2bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=CuRx6HVWAQ%2FvsDml1HdJam2pssk%3D" alt="" loading="lazy"/></p>
<p>当然除了excel导入之外，还有类似的读取文本文件，也可以用类似的方法处理。</p>
<blockquote>
<p>温馨的提醒一下，如果一次性导入的数据非常多，用多线程处理，可能会使系统的cpu使用率飙升，需要特别关注。</p>
</blockquote>
<h2 data-id="heading-5">5.查询接口</h2>
<p>很多时候，我们需要在某个查询接口中，调用其他服务的接口，组合数据之后，一起返回。</p>
<p>比如有这样的业务场景：</p>
<p>在用户信息查询接口中需要返回：用户名称、性别、等级、头像、积分、成长值等信息。</p>
<p>而用户名称、性别、等级、头像在用户服务中，积分在积分服务中，成长值在成长值服务中。为了汇总这些数据统一返回，需要另外提供一个对外接口服务。</p>
<p>于是，用户信息查询接口需要调用用户查询接口、积分查询接口 和 成长值查询接口，然后汇总数据统一返回。</p>
<p>调用过程如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93aa59a74685455d910fc6962f8bdebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=fn66NGI9o5afFQLpZ01x%2FXUUb4w%3D" alt="" loading="lazy"/></p>
<p>调用远程接口总耗时 530ms = 200ms + 150ms + 180ms</p>
<p>显然这种串行调用远程接口性能是非常不好的，调用远程接口总的耗时为所有的远程接口耗时之和。</p>
<p>那么如何优化远程接口性能呢？</p>
<p>既然串行调用多个远程接口性能很差，为什么不改成并行呢？</p>
<p>如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e3ef20c3e04cf98491af9f56fccd28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=RA%2BTjzT%2B%2B0M16pTzvadZicSwHSg%3D" alt="" loading="lazy"/></p>
<p>调用远程接口总耗时 200ms = 200ms（即耗时最长的那次远程接口调用）</p>
<p>在java8之前可以通过实现<code>Callable</code>接口，获取线程返回结果。</p>
<p>java8以后通过<code>CompleteFuture</code>类实现该功能。我们这里以CompleteFuture为例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> UserInfo <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(Long id)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException {
    <span class="hljs-keyword">final</span> <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>();
    <span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">userFuture</span> <span class="hljs-operator">=</span> CompletableFuture.supplyAsync(() -&gt; {
        getRemoteUserAndFill(id, userInfo);
        <span class="hljs-keyword">return</span> Boolean.TRUE;
    }, executor);

    <span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">bonusFuture</span> <span class="hljs-operator">=</span> CompletableFuture.supplyAsync(() -&gt; {
        getRemoteBonusAndFill(id, userInfo);
        <span class="hljs-keyword">return</span> Boolean.TRUE;
    }, executor);

    <span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">growthFuture</span> <span class="hljs-operator">=</span> CompletableFuture.supplyAsync(() -&gt; {
        getRemoteGrowthAndFill(id, userInfo);
        <span class="hljs-keyword">return</span> Boolean.TRUE;
    }, executor);
    CompletableFuture.allOf(userFuture, bonusFuture, growthFuture).join();

    userFuture.get();
    bonusFuture.get();
    growthFuture.get();
    <span class="hljs-keyword">return</span> userInfo;
}
</code></pre>
<p>温馨提醒一下，这两种方式别忘了使用<code>线程池</code>。示例中我用到了<code>executor</code>，表示自定义的线程池，为了防止高并发场景下，出现线程过多的问题。</p>
<h2 data-id="heading-6">6.获取用户上下文</h2>
<p>不知道你在项目开发时，有没有遇到过这样的需求：用户登录之后，在所有的请求接口中，通过某个公共方法，就能获取到当前登录用户的信息？</p>
<p>获取的用户上下文，我们以<code>CurrentUser</code>为例。</p>
<p><code>CurrentUser</code>内部包含了一个<code>ThreadLocal</code>对象，它负责保存当前线程的用户上下文信息。当然为了保证在线程池中，也能从用户上下文中获取到正确的用户信息，这里用了阿里的<code>TransmittableThreadLocal</code>。伪代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CurrentUser</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TransmittableThreadLocal&lt;CurrentUser&gt; THREA_LOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String userName;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String phone;
    ...
    
    <span class="hljs-keyword">public</span> statis <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(CurrentUser user)</span> {
      THREA_LOCAL.set(user);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCurrent</span><span class="hljs-params">()</span> {
      <span class="hljs-keyword">return</span> THREA_LOCAL.get();
    }
}
</code></pre>
<p>这里为什么用了阿里的TransmittableThreadLocal，而不是普通的ThreadLocal呢？在线程池中，由于线程会被多次复用，导致从普通的ThreadLocal中无法获取正确的用户信息。父线程中的参数，没法传递给子线程，而TransmittableThreadLocal很好解决了这个问题。</p>
<p>然后在项目中定义一个全局的spring mvc拦截器，专门设置用户上下文到ThreadLocal中。伪代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerInterceptorAdapter</span> {
   
   <span class="hljs-meta">@Override</span>  
   <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {
      <span class="hljs-type">CurrentUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getUser(request);
      <span class="hljs-keyword">if</span>(Objects.nonNull(user)) {
         CurrentUser.set(user);
      }
   } 
}
</code></pre>
<p>用户在请求我们接口时，会先触发该拦截器，它会根据用户cookie中的token，调用调用接口获取redis中的用户信息。如果能获取到，说明用户已经登录，则把用户信息设置到CurrentUser类的ThreadLocal中。</p>
<p>接下来，在api服务的下层，即business层的方法中，就能轻松通过CurrentUser.getCurrent();方法获取到想要的用户上下文信息了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/716f8f50a1534db785a2eba41e4c6c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=S5WovHiVYbFMen3cheAMaJqlg34%3D" alt="" loading="lazy"/></p>
<p>这套用户体系的想法是很good的，但深入使用后，发现了一个小插曲：</p>
<p>api服务和mq消费者服务都引用了business层，business层中的方法两个服务都能直接调用。</p>
<p>我们都知道在api服务中用户是需要登录的，而mq消费者服务则不需要登录。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44e766b9bfed43ae8af0be092bc68b08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=TyvbIs6k9SghVb969pPlwFCzLS4%3D" alt="" loading="lazy"/></p>
<p>如果business中的某个方法刚开始是给api开发的，在方法深处使用了CurrentUser.getCurrent();获取用户上下文。但后来，某位新来的帅哥在mq消费者中也调用了那个方法，并未发觉这个小机关，就会中招，出现找不到用户上下文的问题。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bcfc398c332429b8cc072d2c57038e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770004506&amp;x-signature=Tqbw%2Fwb6NDWB2uzo19h1BEHljiE%3D" alt="" loading="lazy"/></p>
<p>所以我当时的第一个想法是：代码没做兼容处理，因为之前这类问题偶尔会发生一次。</p>
<p>想要解决这个问题，其实也很简单。只需先判断一下能否从CurrentUser中获取用户信息，如果不能，则取配置的系统用户信息。伪代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BusinessConfig businessConfig;

<span class="hljs-type">CurrentUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> CurrentUser.getCurrent();
<span class="hljs-keyword">if</span>(Objects.nonNull(user)) {
   entity.setUserId(user.getUserId());
   entity.setUserName(user.getUserName());
} <span class="hljs-keyword">else</span> {
   entity.setUserId(businessConfig.getDefaultUserId());
   entity.setUserName(businessConfig.getDefaultUserName());
}
</code></pre>
<p>这种简单无公害的代码，如果只是在一两个地方加还OK。</p>
<p>此外，众所周知，<code>SimpleDateFormat</code>在java8以前，是用来处理时间的工具类，它是非线程安全的。也就是说，用该方法解析日期会有线程安全问题。</p>
<p>为了避免线程安全问题的出现，我们可以把SimpleDateFormat对象定义成<code>局部变量</code>。但如果你一定要把它定义成静态变量，可以使用ThreadLocal保存日期，也能解决线程安全问题。</p>
<h2 data-id="heading-7">8. 传递参数</h2>
<p>之前见过有些同事写代码时，一个非常有趣的用法，即：使用<code>MDC</code>传递参数。</p>
<p>MDC是什么？</p>
<p><code>MDC</code>是<code>org.slf4j</code>包下的一个类，它的全称是<code>Mapped Diagnostic Context</code>，我们可以认为它是一个线程安全的存放诊断日志的容器。</p>
<p><code>MDC</code>的底层是用了<code>ThreadLocal</code>来保存数据的。</p>
<p>例如现在有这样一种场景：我们使用<code>RestTemplate</code>调用远程接口时，有时需要在<code>header</code>中传递信息，比如：traceId，source等，便于在查询日志时能够串联一次完整的请求链路，快速定位问题。</p>
<p>这种业务场景就能通过<code>ClientHttpRequestInterceptor</code>接口实现，具体做法如下：</p>
<p>第一步，定义一个LogFilter拦截所有接口请求，在MDC中设置traceId：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException {
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        MdcUtil.add(UUID.randomUUID().toString());
        System.out.println(<span class="hljs-string">"记录请求日志"</span>);
        chain.doFilter(request, response);
        System.out.println(<span class="hljs-string">"记录响应日志"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
    }
}
</code></pre>
<p>第二步，实现<code>ClientHttpRequestInterceptor</code>接口，MDC中获取当前请求的traceId，然后设置到header中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestTemplateInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClientHttpRequestInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ClientHttpResponse <span class="hljs-title function_">intercept</span><span class="hljs-params">(HttpRequest request, <span class="hljs-type">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="hljs-keyword">throws</span> IOException {
        request.getHeaders().set(<span class="hljs-string">"traceId"</span>, MdcUtil.get());
        <span class="hljs-keyword">return</span> execution.execute(request, body);
    }
}
</code></pre>
<p>第三步，定义配置类，配置上面定义的RestTemplateInterceptor类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestTemplateConfiguration</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RestTemplate</span> <span class="hljs-variable">restTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
        restTemplate.setInterceptors(Collections.singletonList(restTemplateInterceptor()));
        <span class="hljs-keyword">return</span> restTemplate;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplateInterceptor <span class="hljs-title function_">restTemplateInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplateInterceptor</span>();
    }
}
</code></pre>
<p>其中MdcUtil其实是利用MDC工具在<code>ThreadLocal</code>中存储和获取traceId</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MdcUtil</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRACE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TRACE_ID"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> MDC.get(TRACE_ID);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(String value)</span> {
        MDC.put(TRACE_ID, value);
    }
}
</code></pre>
<p>当然，这个例子中没有演示MdcUtil类的add方法具体调的地方，我们可以在<code>filter</code>中执行接口方法之前，生成traceId，调用MdcUtil类的add方法添加到MDC中，然后在同一个请求的其他地方就能通过MdcUtil类的get方法获取到该traceId。</p>
<p>能使用MDC保存traceId等参数的根本原因是，用户请求到应用服务器，<code>Tomcat</code>会从线程池中分配一个线程去处理该请求。</p>
<p>那么该请求的整个过程中，保存到<code>MDC</code>的<code>ThreadLocal</code>中的参数，也是该线程独享的，所以不会有线程安全问题。</p>
<h2 data-id="heading-8">9. 模拟高并发</h2>
<p>有时候我们写的接口，在低并发的场景下，一点问题都没有。</p>
<p>但如果一旦出现高并发调用，该接口可能会出现一些意想不到的问题。</p>
<p>为了防止类似的事情发生，一般在项目上线前，我们非常有必要对接口做一下<code>压力测试</code>。</p>
<p>当然，现在已经有比较成熟的压力测试工具，比如：<code>Jmeter</code>、<code>LoadRunner</code>等。</p>
<p>如果你觉得下载压测工具比较麻烦，也可以手写一个简单的模拟并发操作的工具，用<code>CountDownLatch</code>就能实现，例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">concurrenceTest</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">/**
     * 模拟高并发情况代码
     */</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">atomicInteger</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 相当于计数器，当所有都准备好了，再一起执行，模仿多并发，保证并发量</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 保证所有线程执行完了再打印atomicInteger的值</span>
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            executorService.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-keyword">try</span> {
                        countDownLatch.await(); <span class="hljs-comment">//一直阻塞当前线程，直到计时器的值为0,保证同时并发</span>
                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                        log.error(e.getMessage(),e);
                    }
                    <span class="hljs-comment">//每个线程增加1000次，每次加1</span>
                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                        atomicInteger.incrementAndGet();
                    }
                    countDownLatch2.countDown();
                }
            });
            countDownLatch.countDown();
        }

        countDownLatch2.await();<span class="hljs-comment">// 保证所有线程执行完</span>
        executorService.shutdown();
    } <span class="hljs-keyword">catch</span> (Exception e){
        log.error(e.getMessage(),e);
    }
}
</code></pre>
<h2 data-id="heading-9">10. 处理mq消息</h2>
<p>在高并发的场景中，消息积压问题，可以说如影随形，真的没办法从根本上解决。表面上看，已经解决了，但后面不知道什么时候，就会冒出一次，比如这次：</p>
<p>有天下午，产品过来说：有几个商户投诉过来了，他们说菜品有延迟，快查一下原因。</p>
<p>这次问题出现得有点奇怪。</p>
<p>为什么这么说？</p>
<p>首先这个时间点就有点奇怪，平常出问题，不都是中午或者晚上用餐高峰期吗？怎么这次问题出现在下午？</p>
<p>根据以往积累的经验，我直接看了<code>kafka</code>的<code>topic</code>的数据，果然上面消息有积压，但这次每个<code>partition</code>都积压了十几万的消息没有消费，比以往加压的消息数量增加了几百倍。这次消息积压得极不寻常。</p>
<p>我赶紧查服务监控看看消费者挂了没，还好没挂。又查服务日志没有发现异常。这时我有点迷茫，碰运气问了问订单组下午发生了什么事情没？他们说下午有个促销活动，跑了一个<code>JOB</code>批量更新过有些商户的订单信息。</p>
<p>这时，我一下子如梦初醒，是他们在JOB中批量发消息导致的问题。怎么没有通知我们呢？实在太坑了。</p>
<p>虽说知道问题的原因了，倒是眼前积压的这十几万的消息该如何处理呢？</p>
<p>此时，如果直接调大<code>partition</code>数量是不行的，历史消息已经存储到<code>4</code>个固定的partition，只有新增的消息才会到新的partition。我们重点需要处理的是已有的partition。</p>
<p>直接加服务节点也不行，因为<code>kafka</code>允许同组的多个<code>partition</code>被一个<code>consumer</code>消费，但不允许一个partition被同组的多个consumer消费，可能会造成资源浪费。</p>
<p>看来只有用<code>多线程</code>处理了。</p>
<p>为了紧急解决问题，我改成了用线程池处理消息，核心线程和最大线程数都配置成了<code>50</code>。</p>
<p>大致用法如下：</p>
<ol>
<li>先定义一个线程池：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolConfig</span> {

    <span class="hljs-meta">@Value("${thread.pool.corePoolSize:5}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> corePoolSize;

    <span class="hljs-meta">@Value("${thread.pool.maxPoolSize:10}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxPoolSize;

    <span class="hljs-meta">@Value("${thread.pool.queueCapacity:200}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> queueCapacity;

    <span class="hljs-meta">@Value("${thread.pool.keepAliveSeconds:30}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> keepAliveSeconds;

    <span class="hljs-meta">@Value("${thread.pool.threadNamePrefix:ASYNC_}")</span>
    <span class="hljs-keyword">private</span> String threadNamePrefix;

    <span class="hljs-meta">@Bean("messageExecutor")</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">messageExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(corePoolSize);
        executor.setMaxPoolSize(maxPoolSize);
        executor.setQueueCapacity(queueCapacity);
        executor.setKeepAliveSeconds(keepAliveSeconds);
        executor.setThreadNamePrefix(threadNamePrefix);
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<ol start="2">
<li>再定义一个消息的consumer：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyConsumerService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Executor messageExecutor;
    
    <span class="hljs-meta">@KafkaListener(id="test",topics={"topic-test"})</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listen</span><span class="hljs-params">(String message)</span>{
        System.out.println(<span class="hljs-string">"收到消息："</span> + message);
        messageExecutor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyWork</span>(message);
    }
}
</code></pre>
<ol start="3">
<li>在定义的Runable实现类中处理业务逻辑：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyWork</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">private</span> String message;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyWork</span><span class="hljs-params">(String message)</span> {
       <span class="hljs-built_in">this</span>.message = message;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        System.out.println(message);
    }
}
</code></pre>
<p>果然，调整之后消息积压数量确实下降的非常快，大约半小时后，积压的消息就非常顺利的处理完了。</p>
<p>但此时有个更严重的问题出现：我收到了报警邮件，有两个订单系统的节点down机了。。。</p>
<p>更详细内容，请看看我的另一篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247490289%26idx%3D1%26sn%3Dbc311da9f4a4d3f48ee5dc207bf31a8b%26chksm%3Dc0ebc219f79c4b0fc711116723b9df3a5531cda32f0f5d00f065910aa552af6ff03b3f1528fc%26token%3D751314179%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247490289&amp;idx=1&amp;sn=bc311da9f4a4d3f48ee5dc207bf31a8b&amp;chksm=c0ebc219f79c4b0fc711116723b9df3a5531cda32f0f5d00f065910aa552af6ff03b3f1528fc&amp;token=751314179&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我用kafka两年踩过的一些非比寻常的坑</a>》</p>
<h2 data-id="heading-10">11. 统计数量</h2>
<p>在多线程的场景中，有时候需要统计数量，比如：用多线程导入供应商数据时，统计导入成功的供应商数有多少。</p>
<p>如果这时候用count++统计次数，最终的结果可能会不准。因为count++并非原子操作，如果多个线程同时执行该操作，则统计的次数，可能会出现异常。</p>
<p>为了解决这个问题，就需要使用<code>concurent</code>的<code>atomic</code>包下面的类，比如：<code>AtomicInteger</code>、<code>AtomicLong</code>等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Servcie</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImportSupplierService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">importSupplier</span><span class="hljs-params">(List&lt;SupplierInfo&gt; supplierList)</span> {
       <span class="hljs-keyword">if</span>(CollectionUtils.isEmpty(supplierList)) {
           <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
       }

       supplierList.parallelStream().forEach(x -&gt; {
           <span class="hljs-keyword">try</span> {
             importSupplier(x);
             count.addAndGet(<span class="hljs-number">1</span>);
           } <span class="hljs-keyword">catch</span>(Exception e) {
              log.error(e.getMessage(),e);
           }
       );

      <span class="hljs-keyword">return</span> count.get();
  }    
}
</code></pre>
<p><code>AtomicInteger</code>的底层说白了使用<code>自旋锁</code>+<code>CAS</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">incrementAndGet</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> get();
        <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (compareAndSet(current, next))
            <span class="hljs-keyword">return</span> next;
    }
}
</code></pre>
<p><code>自旋锁</code>说白了就是一个<code>死循环</code>。</p>
<p>而<code>CAS</code>是<code>比较</code>和<code>交换</code>的意思。</p>
<p>它的实现逻辑是：将内存位置处的<code>旧值</code>与<code>预期值</code>进行比较，若相等，则将内存位置处的值替换为<code>新值</code>。若不相等，则不做任何操作。</p>
<h2 data-id="heading-11">12. 延迟定时任务</h2>
<p>我们经常有延迟处理数据的需求，比如：如果用户下单后，超过30分钟还未完成支付，则系统自动将该订单取消。</p>
<p>这里需求就可以使用<code>延迟定时任务</code>实现。</p>
<p><code>ScheduledExecutorService</code>是<code>JDK1.5+</code>版本引进的定时任务，该类位于<code>java.util.concurrent</code>并发包下。</p>
<p>ScheduledExecutorService是基于多线程的，设计的初衷是为了解决<code>Timer</code>单线程执行，多个任务之间会互相影响的问题。</p>
<p>它主要包含4个方法：</p>
<ul>
<li>schedule(Runnable command,long delay,TimeUnit unit)，带延迟时间的调度，只执行一次，调度之后可通过Future.get()阻塞直至任务执行完毕。</li>
<li>schedule(Callable callable,long delay,TimeUnit unit)，带延迟时间的调度，只执行一次，调度之后可通过Future.get()阻塞直至任务执行完毕，并且可以获取执行结果。</li>
<li>scheduleAtFixedRate，表示以固定频率执行的任务，如果当前任务耗时较多，超过定时周期period，则当前任务结束后会立即执行。</li>
<li>scheduleWithFixedDelay，表示以固定延时执行任务，延时是相对当前任务结束为起点计算开始时间。</li>
</ul>
<p>实现这种定时任务的具体代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleExecutorTest</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduledExecutorService</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">5</span>);
        scheduledExecutorService.scheduleAtFixedRate(() -&gt; {
            System.out.println(<span class="hljs-string">"doSomething"</span>);
        },<span class="hljs-number">1000</span>,<span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS);
    }
}
</code></pre>
<p>调用<code>ScheduledExecutorService</code>类的<code>scheduleAtFixedRate</code>方法实现周期性任务，每隔1秒钟执行一次，每次延迟1秒再执行。</p>
<p>这种定时任务是阿里巴巴开发者规范中用来替代<code>Timer</code>类的方案，对于多线程执行周期性任务，是个不错的选择。</p>
<p>使用<code>ScheduledExecutorService</code>类做延迟定时任务的优缺点：</p>
<ul>
<li>
<p>优点：基于多线程的定时任务，多个任务之间不会相关影响，支持周期性的执行任务，并且带延迟功能。</p>
</li>
<li>
<p>缺点：不支持一些较复杂的定时规则。</p>
</li>
</ul>
<p>当然，你也可以使用分布式定时任务，比如：xxl-job或者elastic-job等等。</p>
<p>其实，在实际工作中我使用多线程的场景远远不只这12种，在这里只是抛砖引玉，介绍了一些我认为比较常见的业务场景。</p>
<p>此外，如果你对并发编程中的一些坑，比较感兴趣的话，可以看看我的另一个文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247492962%26idx%3D1%26sn%3D17ed1d2ed950b4e9160218b296d19d4e%26chksm%3Dc0e83d8af79fb49cc72fcafc8ed62822263106e54675ea8406a2e3daadb44e25364275af9082%26token%3D245805875%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247492962&amp;idx=1&amp;sn=17ed1d2ed950b4e9160218b296d19d4e&amp;chksm=c0e83d8af79fb49cc72fcafc8ed62822263106e54675ea8406a2e3daadb44e25364275af9082&amp;token=245805875&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">聊聊并发编程的10个坑</a>》，里面写的非常详细。</p>
<h2 data-id="heading-12">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p>
<p>更多项目实战在我的技术网站：susan.net.cn/project</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈]]></title>    <link>https://juejin.cn/post/7599496293161828393</link>    <guid>https://juejin.cn/post/7599496293161828393</guid>    <pubDate>2026-01-26T04:00:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293161828393" data-draft-id="7598899986856820742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈"/> <meta itemprop="keywords" content="后端,gRPC,protobuf"/> <meta itemprop="datePublished" content="2026-01-26T04:00:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="stark张宇"/> <meta itemprop="url" content="https://juejin.cn/user/1983974643871069"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂RPC、gRPC与Protobuf：分布式通信的核心技术栈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1983974643871069/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    stark张宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T04:00:50.000Z" title="Mon Jan 26 2026 04:00:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统中，不同服务间的高效通信是核心需求之一。RPC、gRPC与Protobuf作为一套协同工作的技术组合，广泛应用于微服务、跨语言通信等场景。本文将逐一拆解三者的核心概念、工作原理，并重点分析RPC与HTTP的差异，帮助大家理清技术选型逻辑。</p>
<h3 data-id="heading-0">一、RPC：远程过程调用的核心范式</h3>
<h4 data-id="heading-1"><strong>什么是RPC</strong></h4>
<p>RPC 是一种编程思想，是一种跨进程通信协议，把在不同服务之间的通信变得高效和简单，全称是远程过程调用（Remote Procedure Call ），其核心思想是“像调用本地方法一样调用远程服务的方法”，调用另一个远程项目（服务提供者）的接口，而不需要了解数据的传输处理过程和底层网络的通信细节，让程序员专注于业务逻辑，快速开发分布式、微服务系统。</p>
<h4 data-id="heading-2"><strong>RPC的核心原理与流程</strong></h4>
<p>一次完整的RPC调用流程包含以下步骤，涉及客户端（调用方）和服务端（提供方）的协同工作：</p>
<ol start="0">
<li><strong>客户端调用本地代理（Stub）</strong> ：客户端将远程方法调用参数传递给本地Stub（类似“代理类”），Stub负责后续的通信封装。</li>
<li><strong>参数序列化</strong>：Stub将调用参数（如对象、基本类型）转换为可在网络中传输的二进制数据（序列化），避免因数据格式不兼容导致的通信问题。</li>
<li><strong>网络传输</strong>：通过底层网络协议（如TCP、UDP）将序列化后的二进制数据发送到服务端。</li>
<li><strong>服务端Stub反序列化</strong>：服务端Stub接收数据后，将二进制数据还原为原始参数（反序列化）。</li>
<li><strong>调用服务端本地方法</strong>：服务端Stub调用对应的本地业务方法，执行核心逻辑并获取返回结果。</li>
<li><strong>结果序列化与回传</strong>：服务端Stub将方法返回结果序列化，通过网络传输回客户端。</li>
<li><strong>客户端处理结果</strong>：客户端Stub反序列化返回数据，将结果传递给客户端业务代码，完成一次远程调用。</li>
</ol>
<p><strong>有了Http为啥还有RPC？</strong> Http的本质是基于请求-响应模式的应用层网络通信协议，而Rpc是远程调用本地化的一种思想，主流的RPC大多采用基于Tcp的二进制格式，传送的数据更紧凑，传送的效率也更高效。一般来说，常用于浏览器与服务器、跨服务接口调用（如RESTful API）。而Rpc更适合服务间的内部通信，RPC与HTTP虽都可用于跨服务通信，但设计目标、特性差异显著。</p>
<p>还有一点补充的是RPC并非与HTTP对立，部分RPC框架（如gRPC）底层基于HTTP/2实现，本质是“用HTTP/2作为传输载体的RPC协议”，兼顾了RPC的易用性和HTTP/2的高效特性。</p>
<h4 data-id="heading-3"><strong>远程调用过程面临的问题?</strong></h4>
<p><strong>1.Call ID映射。</strong></p>
<p>我们怎么告诉远程机器我们要调用的函数ID呢?再本地调用中，函数体是直接通过指针来指定的，我们调用function，编译器就自动帮我们调用它相应的函数指针。</p>
<p>但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，再RPC中，所有的函数都必须有自己的一个ID。这个ID在所有的进程中都是唯一确定的。客户端在做远程调用时，必须附上这个ID。然后还需要再客户端和服务端分别维护一个{函数 &lt;--&gt; Call ID}的对应表。两者的表不一定需要完全相同，但相同函数对应的Call ID必须相同。</p>
<p>当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID,然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应的函数的代码。</p>
<p><strong>2.序列化和反序列化</strong></p>
<p>客户端怎么把参数值传给远程函数呢?在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的不是同一种编程语言，这时候就需要客户端和服务端把参数先转成一个字节流，传给服务端后再把字节流转成自己能读懂的格式，这个过程叫做序列化和反序列化。</p>
<p><strong>3.网络传输</strong></p>
<p>远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后在把序列化后的调用结果返回客户端，只要能完成这两者的，都可以作为传输层使用。</p>
<p>因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分Rpc框架都使用Tcp协议，但其实Udp也可以，gRPC干脆使用了Http2。</p>
<h3 data-id="heading-4">二、Protobuf：高效的序列化协议</h3>
<p>Protobuf（Protocol Buffers）是Google开源的一种<strong>语言无关、平台无关、可扩展</strong>的二进制序列化协议，用于将结构化数据序列化为紧凑的二进制格式，适用于数据存储、通信协议等场景。它是gRPC的默认序列化协议，也是目前高性能RPC通信的首选序列化方案之一。</p>
<h4 data-id="heading-5">Protobuf的核心特性</h4>
<ul>
<li><strong>高效紧凑</strong>：采用二进制编码，序列化后的数据体积远小于JSON/XML，解析速度更快（比JSON快3-5倍甚至更高），减少网络传输开销和解析耗时。</li>
<li><strong>跨语言/跨平台</strong>：支持Java、Go、Python、C++等多种语言，可在不同平台（Windows、Linux、Mac）间无缝传输数据，适配跨语言RPC场景。</li>
<li><strong>可扩展性强</strong>：支持字段的新增和废弃，且向后兼容（旧版本程序可解析新版本数据，新版本程序可兼容旧版本数据），无需担心接口升级导致的兼容性问题。</li>
<li><strong>强类型约束</strong>：通过IDL定义数据结构，编译后生成对应语言的代码，强制数据类型校验，避免因类型不匹配导致的异常，提升代码健壮性。</li>
</ul>
<h4 data-id="heading-6"><strong>我们为什么需要 protoc和protoc-gen-go？</strong></h4>
<p><code>proto</code> 文件本质上是<strong>纯文本的协议定义</strong>，比如定义了消息结构、字段类型、服务接口等，它只是一份 “设计图纸”—— 计算机无法直接识别和使用这份图纸，必须把它转换成对应编程语言（比如 Go）的可执行代码，才能在程序中实现序列化、反序列化、网络通信等功能。</p>
<p>而 protoc 和 protoc-gen-go 就是完成 “图纸转代码” 这个核心任务的工具，二者分工协作，缺一不可。</p>
<p>protoc 要执行的就是把Protobuf文件生成对应语言的源码 ，而protoc-gen-go 是生成Go语言的源码</p>
<p>由于你的 <code>protoc</code> 版本是 3.15.5，直接安装最新版插件会出现版本不兼容问题，因此需要指定适配的版本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 protoc-gen-go（适配 3.15.5 的版本）</span>
go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.27.1

<span class="hljs-comment"># 安装 protoc-gen-go-grpc（适配 3.15.5 的版本）</span>
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.1.0

<span class="hljs-comment"># 查看 protoc-gen-go 版本</span>
protoc-gen-go --version
<span class="hljs-comment"># 查看 protoc-gen-go-grpc 版本</span>
protoc-gen-go-grpc --version
</code></pre>
<p><code>protoc</code>的基础命令格式，参数解释：</p>
<ul>
<li><code>-I .</code>：指定 proto 文件的搜索目录（当前目录）。</li>
<li><code>--go_out=.</code>：指定基础 Protobuf 代码生成到当前目录。</li>
<li><code>--go_opt=paths=source_relative</code>：按 proto 文件的相对路径生成 Go 文件（避免生成多层嵌套目录，新手友好）。</li>
<li><code>--go-grpc_out=.</code>：指定 gRPC 代码生成到当前目录。</li>
<li><code>--go-grpc_opt=paths=source_relative</code>：同上，保证 gRPC 代码和 proto 文件路径对应。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一步：生成基础的 Protobuf Go 代码</span>
protoc -I . helloworld.proto --go_out=. --go_opt=paths=source_relative

<span class="hljs-comment"># 第二步：生成 gRPC 相关的 Go 代码</span>
protoc -I . helloworld.proto --go-grpc_out=. --go-grpc_opt=paths=source_relative
</code></pre>
<h4 data-id="heading-7">Protobuf 文件的编写</h4>
<p>protobuf 标量类型是最基础的数据类型，以下是 proto3 核心标量类型与 Go/Python/PHP 的精准映射（重点标注易踩坑的差异）：</p>





















































































































<table><thead><tr><th>Protobuf 类型</th><th>Go 类型</th><th>Python 类型</th><th>PHP 类型</th><th>备注说明</th></tr></thead><tbody><tr><td>double</td><td>float64</td><td>float</td><td>float</td><td>64 位浮点数</td></tr><tr><td>float</td><td>float32</td><td>float</td><td>float</td><td>32 位浮点数</td></tr><tr><td>int32</td><td>int32</td><td>int</td><td>int</td><td>有符号 32 位整型，可变长编码</td></tr><tr><td>int64</td><td>int64</td><td>int</td><td>string</td><td>PHP 64 位整型易溢出，映射为字符串避免问题</td></tr><tr><td>uint32</td><td>uint32</td><td>int</td><td>int</td><td>无符号 32 位整型，可变长编码</td></tr><tr><td>uint64</td><td>uint64</td><td>int</td><td>string</td><td>同上，PHP 映射为字符串</td></tr><tr><td>sint32</td><td>int32</td><td>int</td><td>int</td><td>有符号可变长编码（负数更高效）</td></tr><tr><td>sint64</td><td>int64</td><td>int</td><td>string</td><td>有符号可变长编码（负数更高效）</td></tr><tr><td>fixed32</td><td>uint32</td><td>int</td><td>int</td><td>固定 4 字节编码，大数更高效</td></tr><tr><td>fixed64</td><td>uint64</td><td>int</td><td>string</td><td>固定 8 字节编码</td></tr><tr><td>sfixed32</td><td>int32</td><td>int</td><td>int</td><td>有符号固定 4 字节编码</td></tr><tr><td>sfixed64</td><td>int64</td><td>int</td><td>string</td><td>有符号固定 8 字节编码</td></tr><tr><td>bool</td><td>bool</td><td>bool</td><td>bool</td><td>布尔值</td></tr><tr><td>string</td><td>string</td><td>str</td><td>string</td><td>UTF-8 编码，长度 ≤ 2^32-1</td></tr><tr><td>bytes</td><td>[]byte</td><td>bytes</td><td>string</td><td>PHP 无原生 bytes 类型，用 string 存二进制</td></tr></tbody></table>
<p><strong>1.proto 简单示例</strong></p>
<pre><code class="hljs language-bash" lang="bash">syntax = <span class="hljs-string">"proto3"</span>; // 必须放在第一行，声明使用proto3语法

// 展示基本类型和默认值的message
message BasicTypeDemo {
  int32 age = 1;          // 默认值：0
  string name = 2;        // 默认值：空字符串
  bool is_student = 3;    // 默认值：<span class="hljs-literal">false</span>
  double score = 4;       // 默认值：0.0
  bytes avatar = 5;       // 默认值：空字节数组
}
</code></pre>
<p><strong>2.option go_package 的作用:</strong> <code>option go_package</code> 是 Go 语言专属的编译选项，核心作用是<strong>指定生成的 Go 代码的包路径和包名</strong>，解决 Go 模块模式下的代码导入冲突问题。</p>
<p>语法格式：<code>option go_package = "模块路径/子目录;包名";</code></p>
<ul>
<li>分号前：生成的 Go 文件存放的<strong>模块相对路径</strong>（如 <code>github.com/yourname/proto-demo/pb</code>）；</li>
<li>分号后：生成的 Go 代码的<strong>包名</strong>（省略则用目录名）。</li>
</ul>
<p>编译时：<code>protoc</code> 会根据该选项自动将生成的<code>.go</code>文件放到指定路径，并设置正确的包名。</p>
<pre><code class="hljs language-bash" lang="bash">syntax = <span class="hljs-string">"proto3"</span>;

// 假设你的Go模块名是 github.com/yourname/proto-demo
// 生成的Go代码会放到 ./pb 目录下，包名是 pb
option go_package = <span class="hljs-string">"github.com/yourname/proto-demo/pb;pb"</span>;

message User {
  string username = 1;
}
</code></pre>
<p><strong>3. proto 文件的 import 导入</strong></p>
<p><code>import</code> 用于复用其他 proto 文件中定义的 message、枚举等结构，是 Protobuf 实现代码复用的核心方式：</p>
<ul>
<li>普通导入：<code>import "路径/文件名.proto";</code>，仅当前文件可使用导入的结构；</li>
<li>公共导入：<code>import public "路径/文件名.proto";</code>，当前文件和导入当前文件的其他文件都能使用；</li>
<li>导入路径：支持相对路径（如 <code>./common.proto</code>）或绝对路径（需配合<code>protoc</code>的<code>-I</code>参数指定根目录）。</li>
</ul>
<p><strong>被导入文件：common.proto</strong></p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 供其他文件复用的枚举
enum Gender {
  GENDER_UNSPECIFIED = 0;
  GENDER_MALE = 1;
  GENDER_FEMALE = 2;
}
</code></pre>
<p><strong>主文件：import_demo.proto</strong></p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 导入common.proto，复用Gender枚举
import "./common.proto";

message User {
  string name = 1;
  Gender gender = 2; // 使用导入的枚举
}
</code></pre>
<p><strong>4.message 对象和 message 对象的嵌套</strong></p>
<p><code>message</code> 是 Protobuf 定义结构化数据的核心单元（类似 Go 的<code>struct</code>），支持两种嵌套方式：</p>
<ul>
<li><strong>内部嵌套</strong>：在一个 message 内定义子 message，仅能通过外部 message 的作用域访问（如 <code>Outer.Inner</code>）；</li>
<li><strong>外部嵌套</strong>：在一个 message 中直接引用其他已定义的 message 作为字段类型（同文件 / 导入的均可）；</li>
<li><code>repeated</code> 关键字：表示字段是数组 / 切片类型（默认空数组）。</li>
</ul>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 外部message（供嵌套引用）
message Phone {
  string number = 1;
  string type = 2; // 如"mobile"、"home"
}

// 主message，包含内部嵌套和外部引用
message UserProfile {
  string username = 1;

  // 内部嵌套message（仅UserProfile可用）
  message ExtraInfo {
    string hobby = 1;
    string signature = 2;
  }

  repeated Phone phones = 2; // 外部嵌套：引用Phone，repeated表示数组
  ExtraInfo extra_info = 3;  // 内部嵌套：使用ExtraInfo
}
</code></pre>
<p><strong>5.枚举类型</strong></p>
<p><code>enum</code> 用于定义命名常量，proto3 有严格规范：</p>
<ol>
<li>第一个枚举值必须为 0（作为默认值），通常命名为<code>XXX_UNSPECIFIED</code>；</li>
<li>可通过<code>option allow_alias = true;</code>开启别名（多个常量映射同一数值）；</li>
<li>枚举可定义在 message 内部（局部可用）或外部（全局可用）；</li>
<li>枚举字段的默认值是第一个值（值为 0 的常量）。</li>
</ol>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";
option go_package = "github.com/yourname/proto-demo/pb;pb";

// 开启别名功能
option allow_alias = true;

// 外部枚举（全局可用）
enum OrderStatus {
  ORDER_STATUS_UNSPECIFIED = 0; // 默认值
  ORDER_STATUS_PENDING = 1;
  ORDER_STATUS_PAID = 2;
  ORDER_STATUS_CONFIRMED = 2;   // 别名：PAID和CONFIRMED都对应2
}

// 内部枚举（仅Order内可用）
message Order {
  enum PaymentMethod {
    PAYMENT_METHOD_UNSPECIFIED = 0;
    PAYMENT_METHOD_ALIPAY = 1;
    PAYMENT_METHOD_WECHAT = 2;
  }

  PaymentMethod payment_method = 1; // 内部枚举
  OrderStatus status = 2;           // 外部枚举
}
</code></pre>
<h3 data-id="heading-8">三、gRPC：基于HTTP/2和Protobuf的RPC框架</h3>
<p>gRPC是Google开源的高性能跨语言RPC框架，基于HTTP/2协议传输，默认使用Protobuf作为序列化协议，完美结合了HTTP/2的高效传输能力和Protobuf的紧凑序列化优势，同时支持多种调用模式和跨语言部署。</p>
<h4 data-id="heading-9">gRPC 流模式</h4>
<p>GRPC 基于 HTTP/2 实现了四种通信模式，其中<strong>流模式</strong>是区别于传统 “一次请求一次响应” 的核心特性，分为三类：</p>
<p><strong>服务器流 RPC</strong>：客户端发送 1 个请求 → 服务器流式返回多个响应（如实时日志推送、数据分页返回）。</p>
<p><strong>客户端流 RPC</strong>：客户端流式发送多个请求 → 服务器返回 1 个响应（如批量数据上传后返回汇总结果）。</p>
<p><strong>双向流 RPC</strong>：客户端和服务器双向流式通信，双方可独立发送 / 接收数据（如即时聊天、实时音视频指令交互）。</p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";

option go_package = "./pb;pb"; // 生成的Go代码路径

// 流模式演示服务
service StreamService {
  // 1. 服务器流RPC：客户端发请求，服务端返回流
  rpc ServerStream(StreamRequest) returns (stream StreamResponse);
  
  // 2. 客户端流RPC：客户端发流，服务端返回单个响应
  rpc ClientStream(stream StreamRequest) returns (StreamResponse);
  
  // 3. 双向流RPC：双向流式通信
  rpc BidirectionalStream(stream StreamRequest) returns (stream StreamResponse);
}

// 请求结构
message StreamRequest {
  string message = 1;
  int32 id = 2;
}

// 响应结构
message StreamResponse {
  string reply = 1;
  int32 code = 2;
}
</code></pre>
<p>服务端实现（server.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"context"</span>
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"log"</span>
  <span class="hljs-string">"net"</span>
  <span class="hljs-string">"time"</span>

  <span class="hljs-string">"google.golang.org/grpc"</span>
  pb <span class="hljs-string">"your-project-path/pb"</span> <span class="hljs-comment">// 替换为实际pb包路径</span>
)

<span class="hljs-comment">// 实现StreamService服务</span>
<span class="hljs-keyword">type</span> streamServer <span class="hljs-keyword">struct</span> {
  pb.UnimplementedStreamServiceServer
}

<span class="hljs-comment">// 1. 服务器流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  log.Printf(<span class="hljs-string">"收到客户端请求：%s (id:%d)"</span>, req.Message, req.Id)
  <span class="hljs-comment">// 模拟流式返回3个响应</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"服务器流响应 %d: %s"</span>, i, req.Message)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// 模拟延迟</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 2. 客户端流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ClientStream(stream pb.StreamService_ClientStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-keyword">var</span> total <span class="hljs-type">int32</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> messages []<span class="hljs-type">string</span>
  <span class="hljs-comment">// 循环接收客户端流式请求</span>
  <span class="hljs-keyword">for</span> {
    req, err := stream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-comment">// 客户端流结束（EOF）</span>
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        reply := fmt.Sprintf(<span class="hljs-string">"客户端共发送%d条消息：%v"</span>, total, messages)
        <span class="hljs-keyword">return</span> stream.SendAndClose(&amp;pb.StreamResponse{Reply: reply, Code: total})
      }
      <span class="hljs-keyword">return</span> err
    }
    total++
    messages = <span class="hljs-built_in">append</span>(messages, req.Message)
    log.Printf(<span class="hljs-string">"收到客户端流请求 %d: %s"</span>, req.Id, req.Message)
  }
}

<span class="hljs-comment">// 3. 双向流RPC实现</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> BidirectionalStream(stream pb.StreamService_BidirectionalStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 协程接收客户端消息</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> {
      req, err := stream.Recv()
      <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"双向流接收结束: %v"</span>, err)
        <span class="hljs-keyword">return</span>
      }
      log.Printf(<span class="hljs-string">"收到双向流请求：%s (id:%d)"</span>, req.Message, req.Id)
    }
  }()

  <span class="hljs-comment">// 主线程发送流式响应</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"双向流服务器响应 %d"</span>, i)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// 监听端口</span>
  lis, err := net.Listen(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":50051"</span>)
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"监听失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 创建GRPC服务器</span>
  s := grpc.NewServer()
  pb.RegisterStreamServiceServer(s, &amp;streamServer{})
  log.Println(<span class="hljs-string">"GRPC服务器启动，端口50051"</span>)
  <span class="hljs-keyword">if</span> err := s.Serve(lis); err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"服务启动失败: %v"</span>, err)
  }
}
</code></pre>
<p>客户端实现（client.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"context"</span>
  <span class="hljs-string">"fmt"</span>
  <span class="hljs-string">"log"</span>
  <span class="hljs-string">"time"</span>

  <span class="hljs-string">"google.golang.org/grpc"</span>
  <span class="hljs-string">"google.golang.org/grpc/credentials/insecure"</span>
  pb <span class="hljs-string">"your-project-path/pb"</span> <span class="hljs-comment">// 替换为实际pb包路径</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// 连接GRPC服务器</span>
  conn, err := grpc.Dial(<span class="hljs-string">":50051"</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"连接失败: %v"</span>, err)
  }
  <span class="hljs-keyword">defer</span> conn.Close()
  client := pb.NewStreamServiceClient(conn)

  <span class="hljs-comment">// 1. 调用服务器流RPC</span>
  fmt.Println(<span class="hljs-string">"=== 测试服务器流RPC ==="</span>)
  serverStream, err := client.ServerStream(context.Background(), &amp;pb.StreamRequest{Message: <span class="hljs-string">"hello server stream"</span>, Id: <span class="hljs-number">1</span>})
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用服务器流失败: %v"</span>, err)
  }
  <span class="hljs-keyword">for</span> {
    resp, err := serverStream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        <span class="hljs-keyword">break</span>
      }
      log.Fatalf(<span class="hljs-string">"接收服务器流响应失败: %v"</span>, err)
    }
    fmt.Printf(<span class="hljs-string">"收到服务器流响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
  }

  <span class="hljs-comment">// 2. 调用客户端流RPC</span>
  fmt.Println(<span class="hljs-string">"\n=== 测试客户端流RPC ==="</span>)
  clientStream, err := client.ClientStream(context.Background())
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用客户端流失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 发送3个流式请求</span>
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    req := &amp;pb.StreamRequest{Message: fmt.Sprintf(<span class="hljs-string">"client stream msg %d"</span>, i), Id: <span class="hljs-type">int32</span>(i)}
    <span class="hljs-keyword">if</span> err := clientStream.Send(req); err != <span class="hljs-literal">nil</span> {
      log.Fatalf(<span class="hljs-string">"发送客户端流请求失败: %v"</span>, err)
    }
    time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)
  }
  <span class="hljs-comment">// 关闭客户端流，接收响应</span>
  resp, err := clientStream.CloseAndRecv()
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"接收客户端流响应失败: %v"</span>, err)
  }
  fmt.Printf(<span class="hljs-string">"客户端流最终响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)

  <span class="hljs-comment">// 3. 调用双向流RPC</span>
  fmt.Println(<span class="hljs-string">"\n=== 测试双向流RPC ==="</span>)
  biStream, err := client.BidirectionalStream(context.Background())
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    log.Fatalf(<span class="hljs-string">"调用双向流失败: %v"</span>, err)
  }
  <span class="hljs-comment">// 协程发送客户端消息</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
      req := &amp;pb.StreamRequest{Message: fmt.Sprintf(<span class="hljs-string">"bi stream msg %d"</span>, i), Id: <span class="hljs-type">int32</span>(i)}
      <span class="hljs-keyword">if</span> err := biStream.Send(req); err != <span class="hljs-literal">nil</span> {
        log.Printf(<span class="hljs-string">"发送双向流请求失败: %v"</span>, err)
        <span class="hljs-keyword">return</span>
      }
      time.Sleep(<span class="hljs-number">800</span> * time.Millisecond)
    }
    <span class="hljs-comment">// 关闭客户端发送流</span>
    <span class="hljs-keyword">if</span> err := biStream.CloseSend(); err != <span class="hljs-literal">nil</span> {
      log.Printf(<span class="hljs-string">"关闭双向流发送失败: %v"</span>, err)
    }
  }()

  <span class="hljs-comment">// 接收服务器流式响应</span>
  <span class="hljs-keyword">for</span> {
    resp, err := biStream.Recv()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
        <span class="hljs-keyword">break</span>
      }
      log.Fatalf(<span class="hljs-string">"接收双向流响应失败: %v"</span>, err)
    }
    fmt.Printf(<span class="hljs-string">"收到双向流响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
  }
}
</code></pre>
<h4 data-id="heading-10">GRPC Metadata 机制</h4>
<p>Metadata 是 GRPC 的<strong>元数据传递机制</strong>，类比 HTTP 的 Header，用于在客户端和服务端之间传递非业务的附加信息（如认证 Token、请求 ID、超时时间、版本号等）：</p>
<ul>
<li>
<p>结构：键值对（key-value），key 推荐小写，以<code>grpc-</code>开头的 key 为 GRPC 保留字段。</p>
</li>
<li>
<p>类型：支持字符串（<code>metadata.Pairs</code>）和二进制值（需转字符串传递）。</p>
</li>
<li>
<p>传递方向：</p>
<ul>
<li>客户端 → 服务端：通过上下文（Context）注入 Metadata。</li>
<li>服务端 → 客户端：分为<code>Header Metadata</code>（响应头）和<code>Trailing Metadata</code>（响应尾），可主动返回。</li>
</ul>
</li>
</ul>
<p><strong>服务端添加 Metadata 处理（server.go）</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/metadata"</span>

<span class="hljs-comment">// 重写ServerStream方法，添加Metadata解析和返回</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 提取客户端传递的Metadata</span>
  md, ok := metadata.FromIncomingContext(stream.Context())
  <span class="hljs-keyword">if</span> !ok {
    log.Println(<span class="hljs-string">"未获取到客户端Metadata"</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> tokens := md.Get(<span class="hljs-string">"token"</span>); <span class="hljs-built_in">len</span>(tokens) &gt; <span class="hljs-number">0</span> {
      log.Printf(<span class="hljs-string">"客户端Token: %s"</span>, tokens[<span class="hljs-number">0</span>])
    }
    <span class="hljs-keyword">if</span> reqIDs := md.Get(<span class="hljs-string">"request-id"</span>); <span class="hljs-built_in">len</span>(reqIDs) &gt; <span class="hljs-number">0</span> {
      log.Printf(<span class="hljs-string">"请求ID: %s"</span>, reqIDs[<span class="hljs-number">0</span>])
    }
  }

  <span class="hljs-comment">// 2. 向客户端返回Header Metadata</span>
  headerMd := metadata.Pairs(
    <span class="hljs-string">"server-version"</span>, <span class="hljs-string">"v1.0.0"</span>,
    <span class="hljs-string">"timestamp"</span>, fmt.Sprintf(<span class="hljs-string">"%d"</span>, time.Now().Unix()),
  )
  <span class="hljs-keyword">if</span> err := stream.SendHeader(headerMd); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
  }

  <span class="hljs-comment">// 3. 向客户端返回Trailing Metadata</span>
  trailingMd := metadata.Pairs(
    <span class="hljs-string">"request-status"</span>, <span class="hljs-string">"success"</span>,
    <span class="hljs-string">"response-count"</span>, <span class="hljs-string">"3"</span>,
  )
  stream.SetTrailer(trailingMd)

  <span class="hljs-comment">// 原有流式响应逻辑（略）</span>
  log.Printf(<span class="hljs-string">"收到客户端请求：%s (id:%d)"</span>, req.Message, req.Id)
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++ {
    reply := fmt.Sprintf(<span class="hljs-string">"服务器流响应 %d: %s"</span>, i, req.Message)
    <span class="hljs-keyword">if</span> err := stream.Send(&amp;pb.StreamResponse{Reply: reply, Code: <span class="hljs-type">int32</span>(i)}); err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> err
    }
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>客户端添加 Metadata 发送和接收（client.go）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/metadata"</span>

<span class="hljs-comment">// 修改服务器流RPC调用逻辑</span>
fmt.Println(<span class="hljs-string">"=== 测试服务器流RPC（带Metadata） ==="</span>)
<span class="hljs-comment">// 1. 创建Metadata</span>
md := metadata.Pairs(
  <span class="hljs-string">"token"</span>, <span class="hljs-string">"user_123456_token"</span>,
  <span class="hljs-string">"request-id"</span>, <span class="hljs-string">"req_987654"</span>,
)
<span class="hljs-comment">// 2. 注入到上下文</span>
ctx := metadata.NewOutgoingContext(context.Background(), md)
<span class="hljs-comment">// 3. 调用RPC</span>
serverStream, err := client.ServerStream(ctx, &amp;pb.StreamRequest{Message: <span class="hljs-string">"hello server stream"</span>, Id: <span class="hljs-number">1</span>})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  log.Fatalf(<span class="hljs-string">"调用服务器流失败: %v"</span>, err)
}

<span class="hljs-comment">// 4. 接收服务端Header Metadata</span>
headerMd, err := serverStream.Header()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  log.Fatalf(<span class="hljs-string">"获取Header Metadata失败: %v"</span>, err)
}
fmt.Printf(<span class="hljs-string">"服务端Header: server-version=%s, timestamp=%s\n"</span>, 
  headerMd.Get(<span class="hljs-string">"server-version"</span>)[<span class="hljs-number">0</span>], headerMd.Get(<span class="hljs-string">"timestamp"</span>)[<span class="hljs-number">0</span>])

<span class="hljs-comment">// 5. 接收流式响应（原有逻辑，略）</span>
<span class="hljs-keyword">for</span> {
  resp, err := serverStream.Recv()
  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">if</span> err.Error() == <span class="hljs-string">"EOF"</span> {
      <span class="hljs-keyword">break</span>
    }
    log.Fatalf(<span class="hljs-string">"接收响应失败: %v"</span>, err)
  }
  fmt.Printf(<span class="hljs-string">"收到响应：%s (code:%d)\n"</span>, resp.Reply, resp.Code)
}

<span class="hljs-comment">// 6. 接收服务端Trailing Metadata</span>
trailingMd := serverStream.Trailer()
fmt.Printf(<span class="hljs-string">"服务端Trailer: request-status=%s, response-count=%s\n"</span>, 
  trailingMd.Get(<span class="hljs-string">"request-status"</span>)[<span class="hljs-number">0</span>], trailingMd.Get(<span class="hljs-string">"response-count"</span>)[<span class="hljs-number">0</span>])
</code></pre>
<h4 data-id="heading-11">GRPC 验证器</h4>
<p>GRPC 验证器用于<strong>请求参数的前置校验</strong>，避免非法请求进入业务逻辑，核心依赖<code>protoc-gen-validate</code>插件：</p>
<ul>
<li>原理：在 Proto 文件中通过注解定义字段验证规则（如非空、长度、数值范围、正则匹配），生成对应的验证代码，服务端调用<code>Validate()</code>方法即可校验。</li>
<li>优势：校验逻辑与业务解耦，规则集中在 Proto 中，跨语言通用。</li>
<li>常用规则：<code>required</code>（非空）、<code>min_len/max_len</code>（字符串长度）、<code>gt/lt</code>（数值范围）、<code>pattern</code>（正则）等。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">go install github.com/bufbuild/protoc-gen-validate@latest
</code></pre>
<p>proto文件</p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";

option go_package = "./pb;pb";

// 导入验证器注解
import "validate/validate.proto";

message StreamRequest {
  // 验证规则：非空，长度1-20
  string message = 1 [(validate.rules).string = {min_len: 1, max_len: 20}];
  // 验证规则：大于0，小于100
  int32 id = 2 [(validate.rules).int32 = {gt: 0, lt: 100}];
}

// 服务定义不变
service StreamService {
  rpc ServerStream(StreamRequest) returns (stream StreamResponse);
  // ... 其他方法
}

message StreamResponse {
  string reply = 1;
  int32 code = 2;
}
</code></pre>
<p>服务端添加验证逻辑</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 新增导入</span>
<span class="hljs-keyword">import</span> (
  <span class="hljs-string">"google.golang.org/grpc/codes"</span>
  <span class="hljs-string">"google.golang.org/grpc/status"</span>
)

<span class="hljs-comment">// 修改ServerStream方法，添加参数验证</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 参数验证（核心）</span>
  <span class="hljs-keyword">if</span> err := req.Validate(); err != <span class="hljs-literal">nil</span> {
    log.Printf(<span class="hljs-string">"参数验证失败: %v"</span>, err)
    <span class="hljs-comment">// 返回INVALID_ARGUMENT状态码</span>
    <span class="hljs-keyword">return</span> status.Error(codes.InvalidArgument, fmt.Sprintf(<span class="hljs-string">"参数非法: %v"</span>, err))
  }
​
  <span class="hljs-comment">// 原有Metadata解析、响应逻辑（略）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-12">GRPC 状态码错误机制</h4>
<p>GRPC 定义了<strong>标准化状态码（StatusCode）</strong> ，用于统一表示请求处理结果，替代 HTTP 状态码，核心特点：</p>
<ul>
<li>核心状态码：共 16 种标准码，常用的有<code>OK(0)</code>（成功）、<code>INVALID_ARGUMENT(3)</code>（参数非法）、<code>UNAUTHENTICATED(16)</code>（认证失败）、<code>FAILED_PRECONDITION(9)</code>（业务规则失败）等。</li>
<li>错误结构：包含<strong>状态码</strong>、<strong>错误消息</strong>、<strong>详细信息</strong>（可通过<code>WithDetails</code>附加）。</li>
<li>使用方式：服务端通过<code>status.Error()</code>返回错误；客户端通过<code>status.FromError()</code>解析状态码和消息。</li>
</ul>
<p>服务端返回不同状态码错误</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *streamServer)</span></span> ServerStream(req *pb.StreamRequest, stream pb.StreamService_ServerStreamServer) <span class="hljs-type">error</span> {
  <span class="hljs-comment">// 1. 参数验证失败 → INVALID_ARGUMENT(3)</span>
  <span class="hljs-keyword">if</span> err := req.Validate(); err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> status.Error(codes.InvalidArgument, fmt.Sprintf(<span class="hljs-string">"参数非法: %v"</span>, err))
  }

  <span class="hljs-comment">// 2. 认证失败 → UNAUTHENTICATED(16)</span>
  md, _ := metadata.FromIncomingContext(stream.Context())
  <span class="hljs-keyword">if</span> tokens := md.Get(<span class="hljs-string">"token"</span>); <span class="hljs-built_in">len</span>(tokens) == <span class="hljs-number">0</span> || tokens[<span class="hljs-number">0</span>] != <span class="hljs-string">"user_123456_token"</span> {
    <span class="hljs-keyword">return</span> status.Error(codes.Unauthenticated, <span class="hljs-string">"token无效或缺失"</span>)
  }

  <span class="hljs-comment">// 3. 业务规则失败 → FAILED_PRECONDITION(9)（带详细信息）</span>
  <span class="hljs-keyword">if</span> req.Id == <span class="hljs-number">5</span> {
    st := status.New(codes.FailedPrecondition, <span class="hljs-string">"业务规则校验失败"</span>)
    <span class="hljs-comment">// 附加详细信息</span>
    st, err := st.WithDetails(&amp;pb.StreamResponse{Reply: <span class="hljs-string">"id不能为5"</span>, Code: <span class="hljs-number">5</span>})
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
      <span class="hljs-keyword">return</span> st.Err()
    }
    <span class="hljs-keyword">return</span> st.Err()
  }

  <span class="hljs-comment">// 原有逻辑（略）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p>客户端解析错误详情</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 调用RPC（id=5）</span>
serverStream, err := client.ServerStream(ctx, &amp;pb.StreamRequest{Message: <span class="hljs-string">"test"</span>, Id: <span class="hljs-number">5</span>})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
  st, ok := status.FromError(err)
  <span class="hljs-keyword">if</span> !ok {
    log.Fatalf(<span class="hljs-string">"非GRPC错误: %v"</span>, err)
  }

  <span class="hljs-comment">// 解析基础信息</span>
  fmt.Printf(<span class="hljs-string">"状态码: %s (数字:%d)\n"</span>, st.Code().String(), st.Code())
  fmt.Printf(<span class="hljs-string">"错误消息: %s\n"</span>, st.Message())

  <span class="hljs-comment">// 解析详细信息</span>
  <span class="hljs-keyword">for</span> _, detail := <span class="hljs-keyword">range</span> st.Details() {
    <span class="hljs-keyword">if</span> resp, ok := detail.(*pb.StreamResponse); ok {
      fmt.Printf(<span class="hljs-string">"详细信息: %s (code:%d)\n"</span>, resp.Reply, resp.Code)
    }
  }
  <span class="hljs-comment">// 输出：</span>
  <span class="hljs-comment">// 状态码: FailedPrecondition (数字:9)</span>
  <span class="hljs-comment">// 错误消息: 业务规则校验失败</span>
  <span class="hljs-comment">// 详细信息: id不能为5 (code:5)</span>
  <span class="hljs-keyword">return</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我和TRAE的这一年]]></title>    <link>https://juejin.cn/post/7598403436699582498</link>    <guid>https://juejin.cn/post/7598403436699582498</guid>    <pubDate>2026-01-24T02:38:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598403436699582498" data-draft-id="7598450302615715886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我和TRAE的这一年"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-24T02:38:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="纱雾13"/> <meta itemprop="url" content="https://juejin.cn/user/3419926705742091"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我和TRAE的这一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3419926705742091/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    纱雾13
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T02:38:45.000Z" title="Sat Jan 24 2026 02:38:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我和TRAE的这一年</h2>
<p>也是和Trae走过一年了！也使用了Trae做出了大大小小的项目，也学会了很多技术栈，也使用Trae参加了一些比赛都获得不错的佳绩了，来看看我和Trae的2025吧</p>
<p><strong>相遇</strong></p>
<p>相遇即在printf("MarsCode"),我还记得那是2024年6月份,我在教室看草坪发布会,我还记得<strong>海建</strong>和<strong>旭东</strong>老师在草坪上演示Marscode的能力,那个时候就深深的爱上了这个插件,在日常的学习还有一些项目的生成都是很不错的!那个时候只能使用ChatGPT豆包这类的生成后代码然后CV,出错再来一遍,现在不需要了!真的很惊艳~然后就到2025年的假期的时候还有超多由杜昔月老师的共学课程,在直播间和她的小助理一起使用Marscode生成一些代码,那个时候就认定了,觉得这个社区很不错,能学到好多开发的技术!也获得了很多周边!
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/575637b9768b4e289c330be82ce4b431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=TPu5S8scp%2FWQGPH7kdqwhyghY5w%3D" alt="img_v3_02tf_594afca5-d3aa-4606-a881-ff2367ee2d0g.jpg" loading="lazy"/></p>
<p><strong>Trae 社区活动真的好多!</strong></p>
<p>8月份进入到了飞书的社群,这里活动更加丰富了,且社群比之前大了好多!有好多大佬进入到这个群里,在这里真的学到了特别多!
也是在这个时候,觉得是我学生时代写的代码和开发项目的巅峰了,在这里参加了各种种类的活动
例如发表到Trae公众号的借用大模型的能力去进行规范事务的一个项目
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3W2wmNS8NpzReUn5ifSsMQ" target="_blank" title="https://mp.weixin.qq.com/s/3W2wmNS8NpzReUn5ifSsMQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/3W2wmNS8N…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8409f118b20341248a6b100d624deb98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=rnE2So5Q89o4p5MqcqHzCh6SFyw%3D" alt="img_v3_02tf_4ec1b381-bb29-4387-b0cb-9b6f9a14689g.jpg" loading="lazy"/>
<img src="" alt="" loading="lazy"/></p>
<p>当然还有在1024程序员节的时候,演示过的项目等等等等超多
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c4d4f4ba384336b74988d6a84ca439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=MPvIyJ%2BhkFwsIvTLsYSvbCoU6fY%3D" alt="img_v3_02tf_f4ce8d62-bd58-4b9a-8c7c-13962f1ab33g.png" loading="lazy"/></p>
<p>当然因为我还是一个学生,使用Trae参加了一些互联网开发的比赛均获得了省里不错的成绩!</p>
<p><strong>Trae的线下活动!</strong></p>
<p>不得不说,我的第一次线下参加关于编程类的活动就是Trae,真的参加第一次,就想参加第二次,学到了很多有干料的开发技巧!</p>
<p>第一次参加的Trae的活动!(luna莫怪我拍的不好看)
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aa63c6df9724399a9ffac8cf3bc4423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=qOFQa9WtFCrk7jLLWT2A2qKB8Ko%3D" alt="img_v3_02tf_c9ace577-1c7f-4c3e-a45d-a2189d0b3ceg.png" loading="lazy"/>
第一次参加Hackathon,就获得了一等奖!且我的同学们也都获取了佳绩!真的很不错的线下体验!
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c196da2aa6104a93831761340497faf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=sMuNUoHGQTgZoRkbfgZUK9KjLvE%3D" alt="img_v3_02tf_0add46fe-f608-4a5f-a12e-e968fc864b6g.jpg" loading="lazy"/>
<strong>Trae周边!</strong></p>
<p>当然这一年也获得了超多的周边!(不完全统计)
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da676d6bb54d4a40978b2d58248bb05e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=BrsX4s7vdvza83M0j6Uh9OyIvJQ%3D" alt="img_v3_02tf_fee564d7-7fa0-4a5c-93ae-06f3b743207g.jpg" loading="lazy"/></p>
<p><strong>使用 Trae 开源自己的 skill</strong></p>
<p>最佳 skill 概念特别好，也是使用 Trae 去做出自己的一套 skill文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwcn1msagbpwc.feishu.cn%2Fwiki%2FP7VPw22RfinnVHk2FeXcvtFfn7b%3Ffrom%3Dfrom_copylink" target="_blank" title="https://wcn1msagbpwc.feishu.cn/wiki/P7VPw22RfinnVHk2FeXcvtFfn7b?from=from_copylink" ref="nofollow noopener noreferrer">Trae Skills 开发技巧</a>
自己检索了现在比较流行的 anthropics/skills、vercel-labs/agent-skills 及ComposioHQ/awesome-claude-skills 这3 个库的精华，自己整合构建出这个skills 库
省流示例如下：</p>
<p>一句话开发，就有专门的 skill 去自动分配任务</p>
<pre><code class="hljs">我想开发一个 简单的 todolist 项目，请带我走一遍全流程。
</code></pre>
<p>就会自动的去划分任务出来，配合 Trae 的 todolist 实现高效开发
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aeea57884fa46979bffba972d64688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qx6Zu-MTM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769827125&amp;x-signature=9eJkN%2BUuHsVL9ZoqqajJwf0Kom0%3D" alt="img_v3_02u6_21f61828-5395-470a-92d4-a8720f61749g.jpg" loading="lazy"/></p>
<p><strong>最后!</strong></p>
<p>那最后呢,希望Trae越来越好,在2026实现更多跨时代的一些功能,惊艳的功能,让 <strong>The Real AI Engineer</strong> 更加伟大!‌</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026：拒绝 AI 焦虑，我手写了一个 ReAct 智能体]]></title>    <link>https://juejin.cn/post/7598947628468125742</link>    <guid>https://juejin.cn/post/7598947628468125742</guid>    <pubDate>2026-01-25T16:00:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598947628468125742" data-draft-id="7598881914204258354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026：拒绝 AI 焦虑，我手写了一个 ReAct 智能体"/> <meta itemprop="keywords" content="前端,Agent,AIGC"/> <meta itemprop="datePublished" content="2026-01-25T16:00:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="辰枫"/> <meta itemprop="url" content="https://juejin.cn/user/2946346892407735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026：拒绝 AI 焦虑，我手写了一个 ReAct 智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346892407735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    辰枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T16:00:43.000Z" title="Sun Jan 25 2026 16:00:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2025年史称“Agent”元年，自从 ChatGPT 的爆火，自己也一直使用的是 Chat 类的 AI工具。其它类型的工具只是推特上看到，但是自己很少使用。有时在自己推特的 timline上会出现很多爆火的AI工具，刷多了会对于自己产生一些焦虑，但仅仅是产生（毕竟人在自己的舒适区，是很难自己走出来的）。加上最近的招聘市场和公司都很注重 Agent 这块，所以决定花时间好好研究下 Agent。为未来做准备，同时也会包装自己。</p>
<p>整体的学习大纲，用最近听到一句话来说“<strong>体系完整先于逻辑自洽和观点正误</strong>”，先学习整体的 Agent 的整体框架再慢慢研究。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae9e11edd0e94dc6ab9e9c5bc22d3e1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L6w5p6r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769961643&amp;x-signature=Qm9qAEnllqVh%2Bvmxa3tsltT10k0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">什么是AI Agent</h2>
<blockquote>
<p><em>“AI agents are software systems that use AI to pursue goals and complete tasks on behalf of users. They show reasoning, planning, and memory and have a level of autonomy to make decisions, learn, and adapt.”</em> <em>— Google Cloud</em></p>
<p>AI 智能体是使用 AI来实现目标和代表用户完成任务的软件系统，其表现中推理、规划和记忆能力。并且有一定的自主性，能够自主学习、适应和做出决定</p>
</blockquote>
<p>这里引用<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaoyu.io%2Fblog%2Fai-agent-frontend-rebirth-from-failure" target="_blank" title="https://baoyu.io/blog/ai-agent-frontend-rebirth-from-failure" ref="nofollow noopener noreferrer">宝王老师</a>对于 AI Agent 的定义：</p>
<p>AI Agent 是为了实现一个目标，循环调用工具的大语言模型。</p>
<ul>
<li>工具循环（Tools）：模型调用工具 -&gt; 获取结果 -&gt; 继续推理</li>
<li>有明确终点：为达成目标，而不是无限调用</li>
<li>目标来源灵活：可以来自用户，也可以来自另一个 LLM</li>
<li>基础记忆能力：通过对话历史保存上下文信息</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f21815462a4cd6b623d30cca302c1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L6w5p6r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769961643&amp;x-signature=fVJpQmQSLJJ64JEmpAeWo%2FdQaB4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">AI Agent （AI 智能体）经典范式</h2>
<h3 data-id="heading-3">ReAct范式</h3>
<p>在 ReAct 范式出现之前，主流的方法可以分为两类：</p>
<ul>
<li>“纯思考”：如<strong>思维链（Chain-of-Thought）</strong> ,引导模型进行复杂的逻辑推理，但无法与外界进行交互，容易生成幻觉</li>
<li>“纯行动”：模型直接输出执行的动作，缺乏规划和纠错能力</li>
</ul>
<h4 data-id="heading-4"><strong>什么是 ReAct 范式</strong></h4>
<p>从字面上看ReAct 单词读和<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2F" target="_blank" title="https://react.dev/" ref="nofollow noopener noreferrer">前端框架 React</a>一样发音，只是把 A进行了大写，但是是完全不同的东西。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2210.03629" target="_blank" title="https://arxiv.org/abs/2210.03629" ref="nofollow noopener noreferrer">ReAct (Reason 和 Act)</a>最早是由<a href="https://link.juejin.cn?target=https%3A%2F%2Fysymyth.github.io%2F" target="_blank" title="https://ysymyth.github.io/" ref="nofollow noopener noreferrer">姚顺雨</a>于 2022 年提出，其核心思想是模仿人类解决问题的方式，将<strong>思考(Reasoning)与行动(Acting)结合</strong>起来。形成一个“思考 -&gt; 行动-&gt;观察”的循环。ReAct 的精妙之处在于，它认识到<strong>思考与行动是相辅相成的</strong>，思考指导行动，而行动的结果又会反过来为思考提供依据。在执行上的是通过一种特殊的Prompt 来引导 LLM，使其每一步都遵循一个固定的轨迹。</p>
<ol>
<li><strong>Thought (思考)</strong> ：在执行任务前，先进行分析当前任务情况、分析任务、规划下一步，或者反思上一步的结果</li>
<li><strong>Action (行动)</strong> ：根据上一步的思考结果决定采用的具体行动，通常会调用外部的 Tools</li>
<li><strong>Observation (观察)</strong> ：这是执行 Action 后从 Tools 返回的结果</li>
</ol>
<p>在这个范式中，Agent会不断的 Loop这个流程，将新的观察结果追加到历史的记录中，形成一个不断增长的上下文，直到 Thought 中判断已经找到正确的答案，然后输出结果。整个过程中<strong>思考使任务更具有目标性，而行动又为下一次的思考提供了事实依据</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0add9da7a86342159d070efcb9e45ead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L6w5p6r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769961643&amp;x-signature=FSZZisLXpeIhHHWRQYSa5f%2FwaaM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">ReAct适用场景</h4>
<ul>
<li><strong>需要外部知识的任务</strong>：查询实时信息</li>
<li><strong>需要精确计算的任务</strong>：数据计算问题</li>
<li><strong>需要与 API交互的任务</strong>：如操作数据库、调用某个 API 完成任务</li>
</ul>
<h4 data-id="heading-6">什么是工具（Tools）</h4>
<p>上面介绍了 ReAct 整体的范式，提到了一个概念 Tools，那么什么是 Tools 呢？</p>
<p>我们都知道 LLM是一个用固定数据训练出来的模型，有自主思考的能力相当于大脑，但是只有大脑还不够还要有“手和脚”与真实的外部世界交互。这些手和脚就是 Tools</p>
<h4 data-id="heading-7">ReAct智能体实战</h4>
<p>了解完了 ReAct 整体的概念，下面我们通过一个具体的需求来实际体验下。</p>
<p>需求：<strong>你需要编写一个智能体，用于<strong><strong>分析</strong></strong>用户的需求，回答用户的问题</strong>。</p>
<p>例如：小米手机的最新手机是哪一款？</p>
<h5 data-id="heading-8">需求分析</h5>
<p>想要解决这个问题，我们需为Agent 提供一个网页搜索的工具。让 LLM 调用去实时搜索信息，然后基于搜索的结果让 LLM再判断是不是正确的结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66812aaa54fe48c794a708c8d4050060~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L6w5p6r:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769961643&amp;x-signature=HkoVvEGls1VThbMzBfyCxMQzwdE%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-9">编码实现</h5>
<h6 data-id="heading-10">系统提示词（Prompt）</h6>
<p>基于 ReAct 整体的机制，我们需要设置一个提示词。主要包含以下点：</p>
<ol>
<li>定义LLM 的角色或使用场景</li>
<li>定义 LLM可使用的工具</li>
<li>定义 LLM响应的格式，从而方便的让程序处理</li>
<li>定义用户的问题和整个思考的过程即动态上下文</li>
</ol>
<p>根据以上几点，我们设计的系统提示词如下：</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REACT_PROMPT_TEMPLATE</span> = <span class="hljs-string">`
请注意， 你是一个有能力调用外部工具的智能助手

可用工具如下：
{tools}

请严格按以下格式回应：

Thought: 你的思考过程，用于分析问题、拆解任务和规划下一步行动
Action: 你采取的行动必须是以下格式之一：
- `</span>{{tool_name}}[{{tool_input}}]<span class="hljs-string">`:调用一个可用工具
- `</span><span class="hljs-title class_">Finish</span>[最终答案]<span class="hljs-string">`: 当你认为已经获取最终答案时

现在请开始解决以下问题：
Question: {question}
History: {history}
`</span>;
</code></pre>
<h6 data-id="heading-11"><strong>工具（Tools）</strong></h6>
<p>按提示词的设计，这里我们先编写给LLM调用的工具函数，选用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fserpapi%2Fserpapi-javascript" target="_blank" title="https://github.com/serpapi/serpapi-javascript" ref="nofollow noopener noreferrer"> SerpApi</a>，根据官方提供的 SDK 封装一个函数（使用前需要去<a href="https://link.juejin.cn?target=https%3A%2F%2Fserpapi.com%2F" target="_blank" title="https://serpapi.com/" ref="nofollow noopener noreferrer">官网</a>注册一个账号获取免费的额度）。</p>
<blockquote>
<p>SearchApi 是一个强大的实时SERP API，可提供来自Google 搜索、Google 招聘、YouTube、Google 新闻等搜索引擎集合的结构化数据</p>
</blockquote>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">import</span> { getJson } <span class="hljs-keyword">from</span> <span class="hljs-string">'serpapi'</span>;
<span class="hljs-keyword">import</span> { requireEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;

<span class="hljs-comment">/**
 * 基于 SerApi实现的网页搜索工具
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">query</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">query: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> apiKey = requireEnv(<span class="hljs-string">'SERPAPI_API_KEY'</span>);
    <span class="hljs-keyword">if</span> (!apiKey) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'错误：SERPAPI_API_KEY没有定义在.env 文件中'</span>;
    }
    
    <span class="hljs-keyword">const</span> params = {
      <span class="hljs-attr">engine</span>: <span class="hljs-string">'google'</span>,
      <span class="hljs-attr">q</span>: query,
      <span class="hljs-attr">api_key</span>: apiKey,
      <span class="hljs-attr">gl</span>: <span class="hljs-string">'cn'</span>,
      <span class="hljs-attr">hl</span>: <span class="hljs-string">'zh-cn'</span>,
    };

    <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getJson</span>(params);

    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(results.<span class="hljs-property">answer_box_list</span>)) {
      <span class="hljs-keyword">return</span> results.<span class="hljs-property">answer_box_list</span>.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
    }

    <span class="hljs-keyword">if</span> (results.<span class="hljs-property">answer_box</span> &amp;&amp; results.<span class="hljs-property">answer_box</span>.<span class="hljs-property">answer</span>) {
      <span class="hljs-keyword">return</span> results.<span class="hljs-property">answer_box</span>.<span class="hljs-property">answer</span>;
    }

    <span class="hljs-keyword">if</span> (
      results.<span class="hljs-property">knowledge_graph</span> &amp;&amp;
      results.<span class="hljs-property">knowledge_graph</span>.<span class="hljs-property">description</span>
    ) {
      <span class="hljs-keyword">return</span> results.<span class="hljs-property">knowledge_graph</span>.<span class="hljs-property">description</span>;
    }

    <span class="hljs-keyword">if</span> (
      <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(results.<span class="hljs-property">organic_results</span>) &amp;&amp;
      results.<span class="hljs-property">organic_results</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
    ) {
      <span class="hljs-comment">// 如果没有直接答案，则返回前三个有机结果的摘要</span>
      <span class="hljs-keyword">const</span> snippets = results.<span class="hljs-property">organic_results</span>
        .<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)
        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">any</span>, i: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-string">`[<span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>] <span class="hljs-subst">${res.title || <span class="hljs-string">''</span>}</span>\n<span class="hljs-subst">${res.snippet || <span class="hljs-string">''</span>}</span>`</span>;
        });
      <span class="hljs-keyword">return</span> snippets.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n\n'</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">`对不起，没有找到关于 '<span class="hljs-subst">${query}</span>' 的信息。`</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`发生错误: <span class="hljs-subst">${error}</span>`</span>;
  }
}
</code></pre>
<p>为了后续我们方便的添加新的 Tools 我们需要构造一个通用的工具构造器</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Tools</span> = {
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">func</span>: <span class="hljs-title class_">Function</span>;
};

<span class="hljs-comment">/**
 * 工具执行器，负责管理和执行工具
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolsExecutor</span> {
  <span class="hljs-attr">tools</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Tools</span>&gt;;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span> = {};
  }

  <span class="hljs-title function_">registerTool</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, desc: <span class="hljs-built_in">string</span>, func: <span class="hljs-built_in">Function</span></span>) {
    <span class="hljs-keyword">if</span> (name <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'同名工具已存在，将进行覆盖'</span>);
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>[name] = { <span class="hljs-attr">description</span>: desc, <span class="hljs-attr">func</span>: func };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`工具 <span class="hljs-subst">${name}</span> 已注册 \n`</span>);
  }

  <span class="hljs-title function_">getTool</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {    
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>).<span class="hljs-title function_">includes</span>(name)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>[name]?.<span class="hljs-property">func</span>;
    }
  }

  <span class="hljs-title function_">getAvailableTools</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> allTools = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [name, info] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>)) {
      allTools.<span class="hljs-title function_">push</span>(<span class="hljs-string">`- <span class="hljs-subst">${name}</span>: <span class="hljs-subst">${info?.description}</span>`</span>);
    }

    <span class="hljs-keyword">return</span> allTools.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
  }
}
</code></pre>
<p>接下来我们测试这些函数</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">import</span> { search } <span class="hljs-keyword">from</span> <span class="hljs-string">"./tools"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  dotenv.<span class="hljs-title function_">config</span>();
  <span class="hljs-keyword">const</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolsExecutor</span>();
  executor.<span class="hljs-title function_">registerTool</span>(
    <span class="hljs-string">'Search'</span>,
    <span class="hljs-string">'基于 SerApi实现的网页搜索工具'</span>,
    search
  );

  <span class="hljs-keyword">const</span> toolFunc = executor.<span class="hljs-title function_">getTool</span>(<span class="hljs-string">'Search'</span>);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'可用工具列表:'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(executor.<span class="hljs-title function_">getAvailableTools</span>());

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n 执行 Search 工具:`</span>);
  <span class="hljs-keyword">if</span> (toolFunc) {
    <span class="hljs-title function_">toolFunc</span>(<span class="hljs-string">'人工智能的未来是什么？'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索结果:'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
    });
  }
}
<span class="hljs-title function_">main</span>();

&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 执行结果如下：
工具 <span class="hljs-title class_">Search</span> 已注册 

可用工具列表:
- <span class="hljs-title class_">Search</span>: 基于 <span class="hljs-title class_">SerApi</span>实现的网页搜索工具

 执行 <span class="hljs-title class_">Search</span> 工具:
搜索结果:
[<span class="hljs-number">1</span>] 人工智能的未来
<span class="hljs-variable constant_">AI</span> 未来的定义将是转向用于实验的开源大规模模型，以及开发更小、更高效的<span class="hljs-variable constant_">AI</span> 模型，以提高易用性并降低成本。

[<span class="hljs-number">2</span>] <span class="hljs-number">2025</span>,人工智能走向何方？我们如何拥抱变化？
“当前，新一代人工智能等数字技术正在爆发式发展，将进一步推动制造业的效率变革，未来有望带动工厂的研发、生产、组织和服务全方面的革新。”中国信息通信研 ...

[<span class="hljs-number">3</span>] 中国人工智能的未来之路
在人口老龄化的大背景下，人工智能对推动中国未来的经济增长将起到至关重要的作用。中国的劳动年龄人口最早将在<span class="hljs-number">2024</span>年达到峰值，并在之后的<span class="hljs-number">50</span>年中减少五分之一。麦肯锡全球 ...
</code></pre>
<h6 data-id="heading-12">实现Agent</h6>
<p>首先，我们要对接大模型厂商提供的服务，OpenAI的接口规范，已经成为 LLM 行业的接口标准。国内的厂商基本都兼容了此标准</p>
<p>免费的厂商服务？现在基本国内的大模型厂商在注册账号之后基本都会提供一定的免费额度，我这里使用的火山引擎下的火山方舟的服务。</p>
<p>先安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fopenai-node" target="_blank" title="https://github.com/openai/openai-node" ref="nofollow noopener noreferrer">open ai sdk</a> <code>npm install openai</code>，然后我们基于这个 SDK 封装一个通用的llm 对接类，方便后续复用</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'openai'</span>;
<span class="hljs-keyword">import</span> { requireEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ChatCompletionMessageParam</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'openai/resources'</span>;

<span class="hljs-comment">/**
 *  Hello Agents 定制的 LLM 客户端
 *  它用于调用任何兼容 OpenAI 接口的服务，并默认使用流式响应
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloAgentsLLM</span> {
  <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">apiKey</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">baseUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    model?: <span class="hljs-built_in">string</span>,
    apiKey?: <span class="hljs-built_in">string</span>,
    baseUrl?: <span class="hljs-built_in">string</span>,
    timeout: <span class="hljs-built_in">number</span> = <span class="hljs-number">60</span>,
  </span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model || requireEnv(<span class="hljs-string">'LLM_MODEL_ID'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">apiKey</span> = apiKey || requireEnv(<span class="hljs-string">'LLM_API_KEY'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseUrl</span> = baseUrl || requireEnv(<span class="hljs-string">'LLM_BASE_URL'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeout</span> = requireEnv(<span class="hljs-string">'LLM_TIMEOUT'</span>)
      ? <span class="hljs-title class_">Number</span>(requireEnv(<span class="hljs-string">'LLM_TIMEOUT'</span>))
      : timeout;

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">baseUrl</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">apiKey</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
        <span class="hljs-string">'模型 ID、API 密钥和服务地址必须被提供或在.env 文件中定义'</span>,
      );
    }

    <span class="hljs-comment">// console.log(this.baseUrl)</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">baseURL</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">baseUrl</span>,    
      <span class="hljs-attr">apiKey</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">apiKey</span>,
      <span class="hljs-comment">// timeout: this.timeout Error: Request timed out.</span>
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">think</span>(<span class="hljs-params">messages: <span class="hljs-built_in">Array</span>&lt;ChatCompletionMessageParam&gt;, temperature = <span class="hljs-number">0</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始调用大模型'</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span>,
        <span class="hljs-attr">messages</span>: messages,
        <span class="hljs-attr">temperature</span>: temperature,
        <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
      });

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用大模型成功 \n'</span>);

      <span class="hljs-keyword">const</span> collectedContent = [];
      <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> response) {
        <span class="hljs-comment">// 处理每个 chunk        </span>
        <span class="hljs-keyword">const</span> c = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>;
        collectedContent.<span class="hljs-title function_">push</span>(c);
      }
      <span class="hljs-keyword">return</span> collectedContent.<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>)
    } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`调用 LLM API时发生错误: <span class="hljs-subst">${e}</span>`</span>)
        <span class="hljs-keyword">return</span>
    }
  }
}
</code></pre>
<p>接下，我们按 ReAct 范式的规范，实现 ReActAgent。</p>
<ol>
<li>在整个 Agent中我们需要初始化：llm客户端、可调用的工具、整个交互的历史信息</li>
</ol>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReActAgent</span> {
  <span class="hljs-attr">llmClient</span>: <span class="hljs-title class_">HelloAgentsLLM</span>;
  <span class="hljs-attr">toolsExecutor</span>: <span class="hljs-title class_">ToolsExecutor</span>;
  <span class="hljs-attr">maxStep</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>[];

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    llmClient: HelloAgentsLLM,
    toolsExecutor: ToolsExecutor,
    maxStep = <span class="hljs-number">5</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">llmClient</span> = llmClient;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolsExecutor</span> = toolsExecutor;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStep</span> = maxStep;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span> = [];
      }
  }
</code></pre>
<ol start="2">
<li>接下来我们来实现核心的 run 方法：</li>
</ol>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">question: <span class="hljs-built_in">string</span></span>) {
   <span class="hljs-comment">// 1. 重置整体流程</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span> = [];
    <span class="hljs-keyword">let</span> currentStep = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 2. 循环调用LLM</span>
    <span class="hljs-keyword">while</span> (currentStep &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxStep</span>) {
      currentStep += <span class="hljs-number">1</span>;

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`--- 执行第 <span class="hljs-subst">${currentStep}</span> 步 ---`</span>);

      <span class="hljs-comment">// 2.1 根据提示词的模版，传入参数。获取完整版本提示词 </span>
      <span class="hljs-keyword">const</span> toolsDesc = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolsExecutor</span>.<span class="hljs-title function_">getAvailableTools</span>();
      <span class="hljs-comment">// 历史上下文拼接</span>
      <span class="hljs-keyword">let</span> historyStr = <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);

      <span class="hljs-keyword">const</span> prompt = <span class="hljs-title function_">formatPrompt</span>(<span class="hljs-variable constant_">REACT_PROMPT_TEMPLATE</span>, {
        <span class="hljs-attr">tools</span>: toolsDesc,
        <span class="hljs-attr">question</span>: question,
        <span class="hljs-attr">history</span>: historyStr,
      });

      <span class="hljs-keyword">let</span> <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">ChatCompletionMessageParam</span>&gt; = [
        {
          <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
          <span class="hljs-attr">content</span>: prompt,
        },
      ];
        
      <span class="hljs-comment">// 2.2 请求 LLM,获取响应</span>
      <span class="hljs-keyword">const</span> responseTxt = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llmClient</span>.<span class="hljs-title function_">think</span>(messages);

      <span class="hljs-keyword">if</span> (!responseTxt) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`错误：大模型返回异常`</span>);
        <span class="hljs-keyword">break</span>;
      }
 }
</code></pre>
<p>之前我们要求 LLM 在返回时必须带有以下格式：</p>
<pre><code class="hljs language-TS" lang="TS">请严格按以下格式回应：

<span class="hljs-title class_">Thought</span>: 你的思考过程，用于分析问题、拆解任务和规划下一步行动
<span class="hljs-title class_">Action</span>: 你采取的行动必须是以下格式之一：
- <span class="hljs-string">`{{tool_name}}[{{tool_input}}]`</span>:调用一个可用工具
- <span class="hljs-string">`Finish[最终答案]`</span>: 当你认为已经获取最终答案时
</code></pre>
<p>接下来，我们只要使用正则表达式，来提取 LLM 的响应即可：</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-comment">/**
     * 解析 LLM 输出，提取 Thought 和 Action
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">_parseOutput</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): { <span class="hljs-attr">thought</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>; <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> } {
        <span class="hljs-keyword">const</span> thoughtMatch = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Thought: (.*)/</span>);
        <span class="hljs-keyword">const</span> actionMatch = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Action: (.*)/</span>);
        <span class="hljs-keyword">const</span> thought = thoughtMatch?.[<span class="hljs-number">1</span>]?.<span class="hljs-title function_">trim</span>() ?? <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">const</span> action = actionMatch?.[<span class="hljs-number">1</span>]?.<span class="hljs-title function_">trim</span>() ?? <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">return</span> { thought, action };
    }
  <span class="hljs-comment">/**
   * 解析 Action 字符串，提取工具名称和输入
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_parseAction</span>(<span class="hljs-attr">actionText</span>: <span class="hljs-built_in">string</span>): [<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>, <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>] {
    <span class="hljs-keyword">const</span> match = actionText.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+)[(.*)]/</span>);
    <span class="hljs-keyword">if</span> (match) {
      <span class="hljs-keyword">return</span> [match[<span class="hljs-number">1</span>] ?? <span class="hljs-literal">null</span>, match[<span class="hljs-number">2</span>] ?? <span class="hljs-literal">null</span>];
    }
    <span class="hljs-keyword">return</span> [<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>];
  }

  <span class="hljs-comment">/**
   * 解析 Action 输入，提取参数
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_parseActionInput</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">const</span> inputMatch = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\w+[(.*)]/</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(inputMatch)
    <span class="hljs-keyword">return</span> inputMatch &amp;&amp; <span class="hljs-keyword">typeof</span> inputMatch[<span class="hljs-number">1</span>] === <span class="hljs-string">'string'</span> ? inputMatch[<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>;
  }
</code></pre>
<ul>
<li><code>_parseOutput</code>：负责从 LLM返回的消息中提取 Thought 和 Action 两个最主要的部分</li>
<li><code>_parseAction</code>：负责Action 字符串中，提取工具名和参数，例如：Search[Oppo]，工具名：Search，参数：Oppo</li>
</ul>
<p>解析响应结果并执行工具函数</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-keyword">const</span> {thought, action} = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_parseOutput</span>(responseTxt);
<span class="hljs-keyword">if</span>(thought) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`思考：<span class="hljs-subst">${thought}</span> \n`</span>)
  }

  <span class="hljs-keyword">if</span>(!action) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'没有下一步Action, 流程终止'</span>)
    <span class="hljs-keyword">break</span>;
  }
  
  <span class="hljs-keyword">if</span>(action.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'`Finish'</span>)) {
    <span class="hljs-keyword">const</span> finalAnswer = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_parseActionInput</span>(action)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`最终答案：<span class="hljs-subst">${finalAnswer}</span> \n`</span>)
    <span class="hljs-keyword">return</span> finalAnswer;
  }

  <span class="hljs-keyword">const</span> [toolName, toolInput] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_parseAction</span>(action);
  <span class="hljs-keyword">if</span>(!toolInput || !toolName) {
    <span class="hljs-keyword">continue</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`行动: <span class="hljs-subst">${toolName}</span> <span class="hljs-subst">${toolInput}</span>\n`</span>)

  <span class="hljs-keyword">const</span> toolFun = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolsExecutor</span>.<span class="hljs-title function_">getTool</span>(toolName)
  <span class="hljs-keyword">let</span> observation = <span class="hljs-string">`错误： 未找到名为 '<span class="hljs-subst">${toolName}</span>' 的工具`</span>
  <span class="hljs-keyword">if</span>(toolFun) {
    <span class="hljs-comment">// 使用 call 来实现工具函数的执行</span>
    observation = <span class="hljs-keyword">await</span> toolFun.<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, toolInput)
  }
</code></pre>
<p>这段代码就是，解析 LLM响应的结果，如果以 <code>Finish</code> 开始就代表 LLM已经给出了最终的结果，如果不是则需要提取<code>Action</code>，并执行 <code>Action</code>获取响应结果。</p>
<p>最后把本次调用响应的结果（<code>observation</code>），放入到 history 中，供下次 LLM 思考参考</p>
<pre><code class="hljs language-TS" lang="TS"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`观察 <span class="hljs-subst">${observation}</span> \n\n`</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Action: <span class="hljs-subst">${action}</span>`</span>)
<span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Observation: <span class="hljs-subst">${observation}</span>`</span>)
</code></pre>
<p>当然，在 while 循环中设置的有 max_step。程序并不会无限循环，达到一定次数自动停止。</p>
<p>下面是运行 console 结果：</p>
<pre><code class="hljs language-TS" lang="TS">工具 <span class="hljs-title class_">Search</span> 已注册 

--- 执行第 <span class="hljs-number">1</span> 步 ---
开始调用大模型
调用大模型成功 

<span class="hljs-title class_">Thought</span>: 为了回答这个问题，我需要查找小米最新发布的手机型号及其主要卖点。由于小米会定期发布新手机，我需要通过搜索工具获取最新的信息。

<span class="hljs-title class_">Action</span>: <span class="hljs-string">`Search[小米最新手机型号和卖点]`</span>
思考：为了回答这个问题，我需要查找小米最新发布的手机型号及其主要卖点。由于小米会定期发布新手机，我需要通过搜索工具获取最新的信息。 

行动: <span class="hljs-title class_">Search</span> 小米最新手机型号和卖点

观察 [<span class="hljs-number">1</span>] 小米全系列选购指南：<span class="hljs-number">2026</span>年爆款机型+各系列核心卖点_手机
小米数字系列定位<span class="hljs-number">3999</span>元以上高端市场，是追求旗舰性能与均衡体验用户的首选。小米<span class="hljs-number">17</span>搭载骁龙<span class="hljs-number">8</span> <span class="hljs-title class_">Gen5</span>处理器，配备2K <span class="hljs-variable constant_">LTPO</span>直屏与5300mAh电池，支持90W快充，机身 ...

[<span class="hljs-number">2</span>] 手机 - 小米商城
<span class="hljs-title class_">Redmi</span> 14C. <span class="hljs-number">599</span>起. <span class="hljs-variable constant_">CPU</span>型号<span class="hljs-title class_">MediaTek</span> <span class="hljs-title class_">Helio</span> <span class="hljs-variable constant_">G81</span>-<span class="hljs-title class_">Ultra</span> ; <span class="hljs-title class_">Redmi</span> <span class="hljs-title class_">Note</span> <span class="hljs-number">14</span> <span class="hljs-title class_">Pro</span>. <span class="hljs-number">1149</span>起 · <span class="hljs-variable constant_">CPU</span>型号天玑<span class="hljs-number">7300</span>-<span class="hljs-title class_">Ultra</span> ; <span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版. <span class="hljs-number">7999</span>起 · <span class="hljs-variable constant_">CPU</span>型号第五代骁龙<span class="hljs-number">8</span>至尊版 ...

[<span class="hljs-number">3</span>] 小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span>的最强卖点，却成了用户退货的理由
小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span>徕卡版因变焦环松动问题引发用户不满，官方回应称是设计预留活动空间所致，但未能消除质疑。该问题涉及产品设计、制造公差和用户体验。 


--- 执行第 <span class="hljs-number">2</span> 步 ---
开始调用大模型
调用大模型成功 

<span class="hljs-title class_">Thought</span>: 根据搜索结果，小米最新的手机型号是小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版。它的卖点包括搭载第五代骁龙<span class="hljs-number">8</span>至尊版处理器，以及徕卡版的影像系统。不过，搜索结果也提到了一些用户对变焦环松动的反馈。为了更全面地了解这款手机的卖点，我需要进一步搜索小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版的详细规格和官方宣传信息。

<span class="hljs-title class_">Action</span>: <span class="hljs-string">`Search[小米17 Ultra 徕卡版 官方卖点]`</span>
思考：根据搜索结果，小米最新的手机型号是小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版。它的卖点包括搭载第五代骁龙<span class="hljs-number">8</span>至尊版处理器，以及徕卡版的影像系统。不过，搜索结果也提到了一些用户对变焦环松动的反馈。为了更全面地了解这款手机的卖点，我需要进一步搜索小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版的详细规格和官方宣传信息。 

行动: <span class="hljs-title class_">Search</span> 小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版 官方卖点

观察 [<span class="hljs-number">1</span>] <span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版
<span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版，方方面面尽徕卡。徕卡相机感设计，徕卡经典红标，中框精雕横滚花，镌刻徕卡铭文。创新大师变焦环，如相机般精密操控；支持功能自定义，时刻服务你的 ...

[<span class="hljs-number">2</span>] <span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版立即购买-小米商城
<span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版 ; <span class="hljs-number">299</span>元. <span class="hljs-title class_">Xiaomi</span> <span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 保值换新服务 · <span class="hljs-number">299</span>元 ; <span class="hljs-title class_">MiCare</span> 无忧版已省<span class="hljs-number">500</span>元. 加购后碎屏保升级为<span class="hljs-number">2</span>年多次，详见服务介绍 · <span class="hljs-number">499</span>元 ; 延长保<span class="hljs-number">1</span>年<span class="hljs-number">349</span>元. 性能 ...

[<span class="hljs-number">3</span>] 小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span>的最强卖点，却成了用户退货的理由
小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span>徕卡版因变焦环松动问题引发用户不满，官方回应称是设计预留活动空间所致，但未能消除质疑。该问题涉及产品设计、制造公差和用户体验。 


--- 执行第 <span class="hljs-number">3</span> 步 ---
开始调用大模型
调用大模型成功 

<span class="hljs-title class_">Thought</span>: 根据搜索结果，小米最新的手机型号是小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版。它的卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计。虽然变焦环设计引发了一些用户的不满，但官方解释这是设计预留的活动空间。因此，可以确认小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版是小米最新的手机，其卖点主要集中在徕卡合作的高端相机体验和设计上。

<span class="hljs-title class_">Action</span>: <span class="hljs-string">`Finish[小米最新的手机是小米17 Ultra 徕卡版。它的主要卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计，提供如相机般的精密操控体验。]`</span>
思考：根据搜索结果，小米最新的手机型号是小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版。它的卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计。虽然变焦环设计引发了一些用户的不满，但官方解释这是设计预留的活动空间。因此，可以确认小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版是小米最新的手机，其卖点主要集中在徕卡合作的高端相机体验和设计上。 
-- 变量 ---
[
  <span class="hljs-string">'Finish[小米最新的手机是小米17 Ultra 徕卡版。它的主要卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计，提供如相机般的精密操控体验。]'</span>,
  <span class="hljs-string">'小米最新的手机是小米17 Ultra 徕卡版。它的主要卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计，提供如相机般的精密操控体验。'</span>,
  <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">input</span>: <span class="hljs-string">'`Finish[小米最新的手机是小米17 Ultra 徕卡版。它的主要卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计，提供如相机般的精密操控体验。]`'</span>,
  <span class="hljs-attr">groups</span>: <span class="hljs-literal">undefined</span>
]
最终答案：小米最新的手机是小米<span class="hljs-number">17</span> <span class="hljs-title class_">Ultra</span> 徕卡版。它的主要卖点包括徕卡相机感设计、徕卡经典红标、中框精雕横滚花、镌刻徕卡铭文，以及创新的变焦环设计，提供如相机般的精密操控体验。
</code></pre>
<p>注意</p>
<p>由于大模型能力的不同，不确认我们的搜索结果也一样。我这里使用的是<code>deepseek-v3-250324</code>这个模型执行的结果。</p>
<p>最后，想看全部的代码请在这里查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjavaswing%2Flearn-agent%2Ftree%2Ffeature%2Fts%2Fchap4%2Fts" target="_blank" title="https://github.com/javaswing/learn-agent/tree/feature/ts/chap4/ts" ref="nofollow noopener noreferrer">github.com/javaswing/l…</a></p>
<h2 data-id="heading-13">总结</h2>
<p>本文，通过对于 ReAct 范式的介绍，并结合 HelloAgent一书中的例子进行了实践。对于 Agent的开发有了体感。征途刚刚开始。</p>
<h2 data-id="heading-14">参考</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fdiscover%2Fwhat-are-ai-agents" target="_blank" title="https://cloud.google.com/discover/what-are-ai-agents" ref="nofollow noopener noreferrer">cloud.google.com/discover/wh…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Faiagent.app%2F" target="_blank" title="https://aiagent.app/" ref="nofollow noopener noreferrer">aiagent.app/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbaoyu.io%2Fblog%2Fai-agent-frontend-rebirth-from-failure" target="_blank" title="https://baoyu.io/blog/ai-agent-frontend-rebirth-from-failure" ref="nofollow noopener noreferrer">baoyu.io/blog/ai-age…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdatawhalechina.github.io%2Fhello-agents%2F%23%2F.%2Fchapter4%2F%25E7%25AC%25AC%25E5%259B%259B%25E7%25AB%25A0%2520%25E6%2599%25BA%25E8%2583%25BD%25E4%25BD%2593%25E7%25BB%258F%25E5%2585%25B8%25E8%258C%2583%25E5%25BC%258F%25E6%259E%2584%25E5%25BB%25BA" target="_blank" title="https://datawhalechina.github.io/hello-agents/#/./chapter4/%E7%AC%AC%E5%9B%9B%E7%AB%A0%20%E6%99%BA%E8%83%BD%E4%BD%93%E7%BB%8F%E5%85%B8%E8%8C%83%E5%BC%8F%E6%9E%84%E5%BB%BA" ref="nofollow noopener noreferrer">datawhalechina.github.io/hello-agent…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fthink%2Ftopics%2Freact-agent" target="_blank" title="https://www.ibm.com/think/topics/react-agent" ref="nofollow noopener noreferrer">www.ibm.com/think/topic…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact-lm.github.io%2F" target="_blank" title="https://react-lm.github.io/" ref="nofollow noopener noreferrer">react-lm.github.io/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：手把手教你创建 Vue 3 + TypeScript 项目]]></title>    <link>https://juejin.cn/post/7599094262591946762</link>    <guid>https://juejin.cn/post/7599094262591946762</guid>    <pubDate>2026-01-25T17:35:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599094262591946762" data-draft-id="7599094262591930378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：手把手教你创建 Vue 3 + TypeScript 项目"/> <meta itemprop="keywords" content="Vue.js,TypeScript"/> <meta itemprop="datePublished" content="2026-01-25T17:35:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼予余"/> <meta itemprop="url" content="https://juejin.cn/user/1345457964195192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：手把手教你创建 Vue 3 + TypeScript 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457964195192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼予余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T17:35:03.000Z" title="Sun Jan 25 2026 17:35:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将带你一步步创建完整的 Vue 3 项目，包含现代化的开发工具链、代码规范和最佳实践。适合前端开发者学习和参考。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>Vue 3 带来了 Composition API、更好的 TypeScript 支持和性能优化，是现代前端开发的较广泛的选择。本教程将从环境搭建开始，逐步创建完整的 Vue 3 项目。</p>
<h2 data-id="heading-1">环境准备</h2>
<h3 data-id="heading-2">1. Node.js 环境</h3>
<p>Vue 3 项目需要 Node.js 环境，推荐使用 LTS 版本。</p>
<h4 data-id="heading-3">Windows 系统</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 访问 Node.js 官网下载安装包</span>
<span class="hljs-comment"># https://nodejs.org/</span>

<span class="hljs-comment"># 或使用 nvm-windows 管理多个版本</span>
<span class="hljs-comment"># 1. 下载 nvm-windows: https://github.com/coreybutler/nvm-windows/releases</span>
<span class="hljs-comment"># 2. 安装并重启命令行</span>
nvm install 20.19.0
nvm use 20.19.0
</code></pre>
<h4 data-id="heading-4">macOS 系统</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 Homebrew 安装</span>
brew install node

<span class="hljs-comment"># 或使用 nvm 管理版本</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
<span class="hljs-built_in">source</span> ~/.bashrc
nvm install 20.19.0
nvm use 20.19.0
</code></pre>
<h4 data-id="heading-5">验证安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查版本</span>
node --version  <span class="hljs-comment"># 应显示 v20.19.0 或更高</span>
npm --version   <span class="hljs-comment"># 应显示 10.x.x 或更高</span>
</code></pre>
<h3 data-id="heading-6">2. 包管理工具</h3>
<p>推荐使用 npm 或 pnpm，yarn 也可以。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装 pnpm (可选)</span>
npm install -g pnpm

<span class="hljs-comment"># 检查版本</span>
pnpm --version
</code></pre>
<h3 data-id="heading-7">3. IDE 配置</h3>
<p>推荐使用 VS Code，并安装 Vue 相关插件。</p>
<h4 data-id="heading-8">必需插件</h4>
<ul>
<li><strong>Vue (Official)</strong> - Vue 官方插件，提供语法高亮和智能提示</li>
<li><strong>TypeScript Importer</strong> - 自动导入 TypeScript 类型</li>
<li><strong>Prettier</strong> - 代码格式化</li>
<li><strong>ESLint</strong> - 代码检查</li>
</ul>
<h4 data-id="heading-9">VS Code 设置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .vscode/settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"typescript.preferences.importModuleSpecifier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"relative"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.vscode-prettier"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"source.fixAll.eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">项目创建</h2>
<h3 data-id="heading-11">方法一：使用 Vite 官方模板</h3>
<p>Vite 是 Vue 官方推荐的构建工具，速度快，开发体验好。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
npm create vue@latest vue-course

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> vue-course
</code></pre>
<h4 data-id="heading-12">配置选项</h4>
<p>在创建过程中选择以下配置：</p>
<pre><code class="hljs">✅ TypeScript
✅ JSX
✅ Vue Router
✅ Pinia
✅ ESLint
✅ Prettier
</code></pre>
<h3 data-id="heading-13">方法二：手动创建项目</h3>
<p>如果你喜欢自定义配置，可以手动创建。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目目录</span>
<span class="hljs-built_in">mkdir</span> vue-course
<span class="hljs-built_in">cd</span> vue-course

<span class="hljs-comment"># 初始化 package.json</span>
npm init -y

<span class="hljs-comment"># 安装核心依赖</span>
npm install vue@latest @vue/compiler-sfc@latest
npm install -D @vitejs/plugin-vue@latest vite@latest
npm install -D typescript@latest vue-tsc@latest
</code></pre>
<h2 data-id="heading-14">项目配置</h2>
<h3 data-id="heading-15">1. Vite 配置</h3>
<p>创建 <code>vite.config.ts</code> 文件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-comment">// https://vitejs.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>)
    }
  },
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'esnext'</span>,
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'esbuild'</span>,
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>
  }
})
</code></pre>
<h3 data-id="heading-16">2. TypeScript 配置</h3>
<p>创建 <code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"env.d.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/__tests__/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"composite"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"vite/client"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>创建 <code>tsconfig.node.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"vite.config.*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"composite"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>创建 <code>env.d.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/// &lt;reference types="vite/client" /&gt;</span>

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'*.vue'</span> {
  <span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DefineComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">DefineComponent</span>&lt;{}, {}, <span class="hljs-built_in">any</span>&gt;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> component
}
</code></pre>
<h3 data-id="heading-17">3. ESLint 配置</h3>
<p>创建 <code>eslint.config.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> js <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>
<span class="hljs-keyword">import</span> typescript <span class="hljs-keyword">from</span> <span class="hljs-string">'@typescript-eslint/eslint-plugin'</span>
<span class="hljs-keyword">import</span> typescriptParser <span class="hljs-keyword">from</span> <span class="hljs-string">'@typescript-eslint/parser'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'app/files-to-lint'</span>,
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.{ts,mts,tsx,vue}'</span>],
  },

  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'app/files-to-ignore'</span>,
    <span class="hljs-attr">ignores</span>: [<span class="hljs-string">'**/dist/**'</span>, <span class="hljs-string">'**/dist-ssr/**'</span>, <span class="hljs-string">'**/coverage/**'</span>],
  },

  js.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
  ...vue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/essential'</span>],

  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'app/vue-rules'</span>,
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vue.<span class="hljs-property">parser</span>,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">parser</span>: typescriptParser,
        <span class="hljs-attr">extraFileExtensions</span>: [<span class="hljs-string">'.vue'</span>],
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      },
    },
  },

  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'app/typescript-rules'</span>,
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.{ts,mts,tsx,vue}'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: typescriptParser,
      <span class="hljs-attr">parserOptions</span>: {
        <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
        <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>,
      },
    },
    <span class="hljs-attr">rules</span>: {
      ...typescript.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>.<span class="hljs-property">rules</span>,
      <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: <span class="hljs-string">'error'</span>,
      <span class="hljs-string">'@typescript-eslint/explicit-function-return-type'</span>: <span class="hljs-string">'off'</span>,
    },
  },
]
</code></pre>
<h3 data-id="heading-18">4. Prettier 配置</h3>
<p>创建 <code>.prettierrc.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-19">项目结构搭建</h2>
<h3 data-id="heading-20">1. 基础文件结构</h3>
<pre><code class="hljs language-arduino" lang="arduino">vue-course/
├── <span class="hljs-keyword">public</span>/
│   ├── favicon.ico
├── src/
│   ├── assets/
│   │   ├── base.css
│   │   ├── main.css
│   │   └── logo.svg
│   ├── components/
│   │   ├── HelloWorld.vue
│   │   ├── TheWelcome.vue
│   │   ├── WelcomeItem.vue
│   │   └── icons/
│   ├── views/
│   │   ├── HomeView.vue
│   │   └── AboutView.vue
│   ├── router/
│   │   └── index.ts
│   ├── stores/
│   │   └── counter.ts
│   ├── App.vue
│   ├── main.ts
│   └── mcp-server.ts
├── .vscode/
│   └── settings.json
├── index.html
├── package.json
├── vite.config.ts
├── tsconfig.json
├── tsconfig.app.json
├── tsconfig.node.json
├── env.d.ts
├── eslint.config.ts
├── .prettierrc.json
└── README.md
</code></pre>
<h3 data-id="heading-21">2. 入口文件</h3>
<p><code>src/main.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-keyword">import</span> <span class="hljs-string">'./assets/main.css'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>())
app.<span class="hljs-title function_">use</span>(router)

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p><code>index.html</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/favicon.ico"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Vue Course<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.ts"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-22">3. 根组件</h3>
<p><code>src/App.vue</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div id="app"&gt;
    &lt;header class="app-header"&gt;
      &lt;h1&gt;Vue 3 项目&lt;/h1&gt;
      &lt;nav&gt;
        &lt;router-link to="/"&gt;首页&lt;/router-link&gt;
        &lt;router-link to="/about"&gt;关于&lt;/router-link&gt;
      &lt;/nav&gt;
    &lt;/header&gt;

    &lt;main class="app-main"&gt;
      &lt;router-view /&gt;
    &lt;/main&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
// 组件逻辑
&lt;/script&gt;

&lt;style scoped&gt;
.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
}

.app-main {
  padding: 2rem;
  min-height: calc(100vh - 80px);
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-23">路由配置</h2>
<h3 data-id="heading-24">1. 安装 Vue Router</h3>
<pre><code class="hljs language-bash" lang="bash">npm install vue-router@4
</code></pre>
<h3 data-id="heading-25">2. 路由配置</h3>
<p><code>src/router/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/HomeView.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'首页'</span> }
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/AboutView.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'关于'</span> }
  }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),
  routes
})

<span class="hljs-comment">// 路由守卫</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`<span class="hljs-subst">${to.meta.title}</span> - Vue Course`</span>
  <span class="hljs-title function_">next</span>()
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<h3 data-id="heading-26">3. 创建页面组件</h3>
<p><code>src/views/HomeView.vue</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="home"&gt;
    &lt;h2&gt;欢迎使用 Vue 3&lt;/h2&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
    &lt;button @click="increment" class="btn"&gt;增加&lt;/button&gt;
    &lt;button @click="decrement" class="btn"&gt;减少&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref } from 'vue'

const count = ref(0)

const increment = () =&gt; count.value++
const decrement = () =&gt; count.value--
&lt;/script&gt;

&lt;style scoped&gt;
.home {
  text-align: center;
  padding: 2rem;
}

.btn {
  margin: 0 0.5rem;
  padding: 0.5rem 1rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
  cursor: pointer;
}

.btn:hover {
  background: #f0f0f0;
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-27">状态管理</h2>
<h3 data-id="heading-28">1. 安装 Pinia</h3>
<pre><code class="hljs language-bash" lang="bash">npm install pinia
</code></pre>
<h3 data-id="heading-29">2. 配置 Pinia</h3>
<p>已经在 <code>main.ts</code> 中配置了。</p>
<h3 data-id="heading-30">3. 创建 Store</h3>
<p><code>src/stores/counter.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

  <span class="hljs-comment">// 动作</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>--
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>
  }

  <span class="hljs-keyword">return</span> {
    count,
    doubleCount,
    increment,
    decrement,
    reset
  }
})
</code></pre>
<h3 data-id="heading-31">4. 在组件中使用</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;计数: {{ counter.count }}&lt;/p&gt;
    &lt;p&gt;双倍: {{ counter.doubleCount }}&lt;/p&gt;
    &lt;button @click="counter.increment"&gt;+&lt;/button&gt;
    &lt;button @click="counter.decrement"&gt;-&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { useCounterStore } from '@/stores/counter'

const counter = useCounterStore()
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-32">样式配置</h2>
<h3 data-id="heading-33">1. 全局样式</h3>
<p><code>src/assets/main.css</code>（项目中使用的是main.css）：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-id">#app</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1280px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">font-weight</span>: normal;
}

<span class="hljs-selector-tag">a</span>,
<span class="hljs-selector-class">.green</span> {
  <span class="hljs-attribute">text-decoration</span>: none;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsla</span>(<span class="hljs-number">160</span>, <span class="hljs-number">100%</span>, <span class="hljs-number">37%</span>, <span class="hljs-number">1</span>);
  <span class="hljs-attribute">transition</span>: <span class="hljs-number">0.4s</span>;
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">hover</span>: <span class="hljs-attribute">hover</span>) {
  <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">hsla</span>(<span class="hljs-number">160</span>, <span class="hljs-number">100%</span>, <span class="hljs-number">37%</span>, <span class="hljs-number">0.2</span>);
  }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1024px</span>) {
  <span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">display</span>: flex;
    place-items: center;
  }

  <span class="hljs-selector-id">#app</span> {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">2rem</span>;
  }
}
</code></pre>
<p><code>src/assets/base.css</code>：</p>
<pre><code class="hljs language-css" lang="css">*,
*<span class="hljs-selector-pseudo">::before</span>,
*<span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-selector-tag">html</span> {
  <span class="hljs-attribute">font-family</span>: -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, Roboto, sans-serif;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
  -webkit-text-size-adjust: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
}

<span class="hljs-selector-tag">h1</span>, <span class="hljs-selector-tag">h2</span>, <span class="hljs-selector-tag">h3</span>, <span class="hljs-selector-tag">h4</span>, <span class="hljs-selector-tag">h5</span>, <span class="hljs-selector-tag">h6</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1rem</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.2</span>;
}

<span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1rem</span> <span class="hljs-number">0</span>;
}

<span class="hljs-selector-tag">a</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#007acc</span>;
  <span class="hljs-attribute">text-decoration</span>: none;
}

<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">text-decoration</span>: underline;
}

<span class="hljs-selector-tag">button</span> {
  <span class="hljs-attribute">font-family</span>: inherit;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-tag">img</span> {
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: auto;
}
</code></pre>
<h2 data-id="heading-34">开发和构建</h2>
<h3 data-id="heading-35">1. 开发服务器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动开发服务器</span>
npm run dev

<span class="hljs-comment"># 或使用自定义端口</span>
npm run dev -- --port 3000
</code></pre>
<h3 data-id="heading-36">2. 构建生产版本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建生产版本</span>
npm run build

<span class="hljs-comment"># 预览构建结果</span>
npm run preview
</code></pre>
<h3 data-id="heading-37">3. 代码检查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 代码格式化</span>
npm run format

<span class="hljs-comment"># 代码检查</span>
npm run lint

<span class="hljs-comment"># 类型检查</span>
npm run type-check
</code></pre>
<h2 data-id="heading-38">部署选项</h2>
<h3 data-id="heading-39">1. 静态站点部署</h3>
<h4 data-id="heading-40">Vercel</h4>
<pre><code class="hljs language-bash" lang="bash">npm i -g vercel
vercel
</code></pre>
<h4 data-id="heading-41">Netlify</h4>
<pre><code class="hljs language-bash" lang="bash">npm i -g netlify-cli
netlify deploy
</code></pre>
<h2 data-id="heading-42">常见问题</h2>
<h3 data-id="heading-43">1. 依赖安装失败</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理缓存</span>
npm cache clean --force
<span class="hljs-built_in">rm</span> -rf node_modules package-lock.json

<span class="hljs-comment"># 使用国内镜像</span>
npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com

<span class="hljs-comment"># 重新安装</span>
npm install
</code></pre>
<h3 data-id="heading-44">2. TypeScript 错误</h3>
<p>确保 <code>tsconfig.json</code> 配置正确：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"extends"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vue/tsconfig/tsconfig.dom.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"env.d.ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"src/**/*.vue"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-45">3. 热重载不工作</h3>
<p>检查 Vite 配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">hmr</span>: <span class="hljs-literal">true</span>
  }
})
</code></pre>
<h2 data-id="heading-46">总结</h2>
<p>通过本教程，你已经创建了一个完整的 Vue 3 项目，包含：</p>
<ul>
<li>✅ 现代化的开发工具链</li>
<li>✅ TypeScript 支持</li>
<li>✅ 组件化架构</li>
<li>✅ 状态管理</li>
<li>✅ 路由系统</li>
<li>✅ 代码规范</li>
<li>✅ 静态站点部署</li>
</ul>
<p>这个项目结构可以作为你开发 Vue 3 应用的起点。根据实际需求，你可以继续添加更多功能，如国际化、权限管理、数据可视化等。</p>
<h2 data-id="heading-47">资源链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvitejs.dev%2F" target="_blank" title="https://vitejs.dev/" ref="nofollow noopener noreferrer">Vite 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2F" target="_blank" title="https://router.vuejs.org/" ref="nofollow noopener noreferrer">Vue Router 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">Pinia 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2F" target="_blank" title="https://www.typescriptlang.org/" ref="nofollow noopener noreferrer">TypeScript 文档</a></li>
</ul>
<hr/>
<p><strong>发布时间</strong>: 2026年1月
<strong>技术标签</strong>: Vue.js, TypeScript, Vite, 前端开发</p>
<p>希望这篇教程对你有帮助！如果有问题欢迎在评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 scrollIntoView 在 Android 企微中失效的踩坑实录]]></title>    <link>https://juejin.cn/post/7599017594519814170</link>    <guid>https://juejin.cn/post/7599017594519814170</guid>    <pubDate>2026-01-26T00:20:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599017594519814170" data-draft-id="7597946284678397971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 scrollIntoView 在 Android 企微中失效的踩坑实录"/> <meta itemprop="keywords" content="前端,Vue.js,Vant"/> <meta itemprop="datePublished" content="2026-01-26T00:20:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhEng"/> <meta itemprop="url" content="https://juejin.cn/user/4398498737560861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 scrollIntoView 在 Android 企微中失效的踩坑实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4398498737560861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhEng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T00:20:23.000Z" title="Mon Jan 26 2026 00:20:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>这是一个看起来“理所当然”，却足以让你怀疑人生的Bug。</strong></p>
<p>它不会在你本地出现，不会在 iOS 上出现，甚至在大多数 Android 浏览器上也“表现正常”。</p>
<p>但它会在 <strong>Android 企业微信</strong> 里，悄无声息地让你的页面—— 滚动不到指定位置</p>
</blockquote>
<h2 data-id="heading-0">1、事情的起点：一个再正常不过的需求</h2>
<p>故事要从一个<strong>移动端项目</strong>说起。</p>
<p>页面很常见：</p>
<ul>
<li>使用 <strong>Vant 组件库</strong></li>
<li>一个 <code>Form</code> 表单</li>
<li>若干个输入项</li>
</ul>
<p>需求也很常见：</p>
<blockquote>
<p>提交表单时触发校验，校验失败就自动滚动到对应的表单项位置。</p>
</blockquote>
<p>做过 PC 或移动端表单的人都知道，这几乎是“标配能力”。</p>
<p>在 Vant 中，对应的实现路径也非常清晰，校验失败后，调用滚动方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> formRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span> {
    <span class="hljs-comment">// TODO</span>
}).<span class="hljs-title function_">cathc</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span> {
    <span class="hljs-keyword">const</span> name = err?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
    name &amp;&amp; formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">scrollToField</span>(name)
})
</code></pre>
<p>在 <strong>PC 端</strong>，这种体验甚至已经“理所当然”。</p>
<h2 data-id="heading-1">2、测试的一句话，让事情开始变味</h2>
<p>提测之后，测试小姐姐提了一个<strong>非常合理、也非常人性化的建议</strong>：</p>
<blockquote>
<p>「现在滚动是瞬间跳过去的，能不能加个过渡？看起来有点生硬。」</p>
</blockquote>
<p>听起来是不是很简单？👉 <strong>“加个平滑滚动而已。”</strong></p>
<p>我第一时间翻了 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fvant-ui.github.io%2Fvant%2F%23%2Fzh-CN%2Fform" target="_blank" title="https://vant-ui.github.io/vant/#/zh-CN/form" ref="nofollow noopener noreferrer">Vant 官方文档</a></strong>。</p>
<p>文档里对 <code>scrollToField</code> 的描述是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc9e2460f5a240d595262201a4501103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemhFbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769991623&amp;x-signature=2moLcqwkbdEnyDVT2XEdfMB3WQM%3D" alt="image.png" loading="lazy"/></p>
<p>类似：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">scrollToField</span>(<span class="hljs-attr">name</span>: string, alignToTop?: boolean)
</code></pre>
<p>但问题在于：</p>
<ul>
<li>文档<strong>没有提</strong>平滑滚动</li>
<li>也<strong>没有提</strong>是否支持更复杂的滚动配置</li>
</ul>
<p>不过，作为一个习惯 <strong>“不完全相信文档”的前端</strong>，我做了一件很自然的事——👉 <strong>去看源码。</strong></p>
<h2 data-id="heading-2">3、源码一看：这不就有戏了吗？</h2>
<p>在 Vant 的源码里，我很快找到了实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// packages/vant/src/form/Form.tsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToField</span> = (<span class="hljs-params">
  name: string,
  options?: boolean | ScrollIntoViewOptions,
</span>) =&gt; {
  children.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">name</span> === name) {
      item.<span class="hljs-property">$el</span>.<span class="hljs-title function_">scrollIntoView</span>(options);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  });
};
</code></pre>
<p>看到这里，好家伙，这不是直接透传 <code>scrollIntoView</code> 吗？</p>
<p>也就是说：</p>
<ul>
<li>不仅能传 <code>boolean</code></li>
<li>还能直接传 <code>ScrollIntoViewOptions</code></li>
</ul>
<p>那事情就简单了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> formRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span> {
    <span class="hljs-comment">// TODO 校验通过</span>
}).<span class="hljs-title function_">cathc</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span> {
    <span class="hljs-keyword">const</span> name = err?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
    name &amp;&amp; formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">scrollToField</span>(name, {
      <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>,
      <span class="hljs-attr">block</span>: <span class="hljs-string">'center'</span>
    })
});
</code></pre>
<p>本地一测：</p>
<ul>
<li>✅ 滚动顺滑</li>
<li>✅ 居中展示</li>
<li>✅ 体验明显提升</li>
</ul>
<h2 data-id="heading-3">4、Bug 来了，而且来得很“安静”</h2>
<p>没过多久，测试小姐姐提了一个 Bug。</p>
<p>描述非常简短：</p>
<blockquote>
<p>「 现在触发校验之后，页面好像滚动不过去了 」</p>
</blockquote>
<p>我第一反应是：</p>
<blockquote>
<p>不可能吧？我刚刚还测过。</p>
</blockquote>
<p>于是我拿起，🍎 <strong>iPhone 16 Pro</strong> 手机，点击表单提交按钮，触发校验</p>
<ul>
<li>一切正常</li>
<li>平滑滚动</li>
<li>定位精准</li>
</ul>
<p>🤔 <strong>我心想：</strong></p>
<blockquote>
<p>那这是啥问题？「 于是我换了测试同款手机 」</p>
</blockquote>
<p><strong>真凶现身：Android + 企业微信</strong> 测试环境复现条件逐渐清晰：</p>
<ul>
<li><strong>Android 手机</strong></li>
<li><strong>企业微信内置浏览器</strong></li>
<li>特定系统版本</li>
</ul>
<p>关键信息最终锁定为：</p>
<ul>
<li>MagicOS 8.0（荣耀 / 华为系，基于 Android 14）</li>
<li>企业微信 5.0.3 （内置 X5 / 系统 WebView）</li>
</ul>
<p>现象也非常“诡异”：</p>
<ul>
<li><code>scrollToField</code> <strong>被调用了</strong></li>
<li>页面<strong>没有任何报错</strong></li>
<li>但页面就是<strong>没有滚动</strong></li>
</ul>
<h2 data-id="heading-4">5、真相：Android WebView 并不“讲武德”</h2>
<p>深入排查后，问题逐渐明朗：</p>
<p><strong>(1)Android WebView 对 <code>scrollIntoView</code> 支持并不完整</strong></p>
<p>在 Android WebView / X5 内核 中：</p>
<ul>
<li>✅ <code>scrollIntoView()</code> 基本可用</li>
<li>❌ <code>block: 'center'</code> 经常被忽略</li>
<li>❌ <code>behavior: 'smooth'</code> 在复杂布局中，会被打断或失效</li>
</ul>
<p><strong>(2) 企业微信 Android 端不是“纯浏览器”</strong></p>
<p>企业微信 Android 端：</p>
<ul>
<li>使用的是系统 WebView 或 X5 内核</li>
<li>滚动是原生 + JS 混合实现</li>
<li>smooth 滚动有「<strong>动画被中断</strong>」的情况</li>
</ul>
<p>而 iOS WKWebView：</p>
<ul>
<li>对 <code>scrollIntoView({ block: 'center' })</code> 支持是规范级别的</li>
<li>滚动计算非常稳定</li>
</ul>
<p>👉 所以看到的是：「 苹果：完美  ;  安卓：玄学 」</p>
<p><strong>（3）Android 对「center」的计算有 Bug（尤其 Android 13+）</strong></p>
<p>在 Android 12+，特别是 14：</p>
<ul>
<li><code>block: 'center'</code> 的中心点</li>
<li>会<strong>忽略滚动容器 padding</strong></li>
<li>或错误使用 <code>offsetParent</code></li>
</ul>
<p>这在 <strong>企微 + MagicOS</strong> 组合下非常容易触发。</p>
<h2 data-id="heading-5">6、最终方案：别再指望 scrollIntoView 了</h2>
<p>问题明确后，解决思路也就清晰了。</p>
<p><strong>方案一：Android 端不使用 <code>smooth</code></strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isAndroid = <span class="hljs-regexp">/Android/i</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">navigator</span>.<span class="hljs-property">userAgent</span>);

element.<span class="hljs-title function_">scrollIntoView</span>({
  <span class="hljs-attr">behavior</span>: isAndroid ? <span class="hljs-string">'auto'</span> : <span class="hljs-string">'smooth'</span>,
  <span class="hljs-attr">block</span>: <span class="hljs-string">'center'</span>
});
</code></pre>
<p><strong>方案二（最稳）：自己计算滚动距离</strong></p>
<p>核心思想只有一句话： <strong>自己算 <code>scrollTop</code>，别把命运交给 WebView。</strong></p>
<p>示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 将目标元素滚动到容器中间
 * <span class="hljs-doctag">@param</span> container 滚动元素
 * <span class="hljs-doctag">@param</span> target 目标元素
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToCenter</span>(container, target) =&gt; {
  <span class="hljs-keyword">const</span> containerRect = container.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> targetRect = target.<span class="hljs-title function_">getBoundingClientRect</span>();

  <span class="hljs-keyword">const</span> offset =
    targetRect.<span class="hljs-property">top</span> -
    containerRect.<span class="hljs-property">top</span> -
    container.<span class="hljs-property">clientHeight</span> / <span class="hljs-number">2</span> +
    target.<span class="hljs-property">clientHeight</span> / <span class="hljs-number">2</span>;

  container.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: container.<span class="hljs-property">scrollTop</span> + offset,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>
  });
}
</code></pre>
<p>usage</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> formRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span> {
    <span class="hljs-comment">// TODO 校验通过</span>
}).<span class="hljs-title function_">cathc</span>(<span class="hljs-function"><span class="hljs-params">err</span>=&gt;</span> {
    <span class="hljs-keyword">const</span> name = err?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> ?? <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>);
    <span class="hljs-keyword">const</span> target = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">'van-field__error-message'</span>)?.[<span class="hljs-number">0</span>]
    <span class="hljs-title function_">scrollToCenter</span>(container, target);
});
</code></pre>
<p>上线测试：</p>
<ul>
<li>✅ Android 企业微信</li>
<li>✅ iOS</li>
<li>✅ 本地浏览器</li>
</ul>
<p><strong>全部通过。</strong></p>
<p>测试小姐姐给了一个评价：「这次的体验很好 👍」 那一刻，真的值了。</p>
<h2 data-id="heading-6">7、踩坑总结</h2>
<p>如果你也在做类似的事情，建议直接收藏：</p>
<ul>
<li>
<p>不要在 Android 企业微信中过度依赖 <code>scrollIntoView</code> 的高级配置项</p>
</li>
<li>
<p>尤其是：</p>
<ul>
<li><code>behavior: 'smooth'</code></li>
<li><code>block: 'center'</code></li>
</ul>
</li>
<li>
<p><strong>iOS 正常 ≠ 代码在所有环境都正确</strong></p>
</li>
</ul>
<p>这类问题的本质往往不是：</p>
<blockquote>
<p>你写错了代码*，</p>
</blockquote>
<p>而是：</p>
<blockquote>
<p><strong>你刚好踩到了 WebView 的能力边界了。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>