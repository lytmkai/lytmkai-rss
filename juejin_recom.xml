<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。]]></title>    <link>https://juejin.cn/post/7587997157237915700</link>    <guid>https://juejin.cn/post/7587997157237915700</guid>    <pubDate>2025-12-27T06:10:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237915700" data-draft-id="7587997157237899316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。"/> <meta itemprop="keywords" content="后端,前端,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:10:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="why技术"/> <meta itemprop="url" content="https://juejin.cn/user/3702810893364350"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810893364350/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    why技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:10:09.000Z" title="Sat Dec 27 2025 06:10:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果让我站在科技从业者的角度去回看 2025 年，让我选一个词出来形容它，我会选择“vibe coding”这个词。</p>
<p>ChatGPT 作为 AI 的第一波浪潮来临的时候，我们作为科技从业者，都清楚的知道这波浪潮会冲击到我们中的大多数。</p>
<p>对我来说，在 2025 年，这波浪潮的名称就叫 vibe coding。其实你仔细想想，AI 写出的代码能用，这件事爆发性的发展，也就是今年这一年发生的事儿，甚至是下半年的事情。各种各样的 AI 编码工具如雨后春笋般的冒出来头来，一个比一个好用。</p>
<p>冲击到我的一个具体表现之一就是今年我写文章的频率真的没有前几年这么高了。</p>
<p>同样的一个问题，你去问 AI，它只用几十秒，就能得到我花了大量精力才学会，并融汇贯通的东西。</p>
<p>你只需要用自然语言把需求描述清楚，再稍加引导，它就能在很短的时间内直接给你生成工程级别的代码，水平能和一个中级程序员对标。</p>
<p>轻而易举就能获得我呕心沥血才学会的东西。所以我是真的感到恐惧，恐惧到我开始抗拒。</p>
<p>以前，我想起一个有意思的技术话题就会去一边研究一边写，最后把它写出来，这个过程是很有意思的。</p>
<p>现在，当我研究了一点，然后在把它写出来的，我就会觉得，没意思。</p>
<p>单纯就是觉得没意思，因为我写的这些东西，去问 AI 都知道。</p>
<p>我把它写出来可能要用一周时间，但是去问 AI，它几分钟就能给你一大段内容，并说得头头是道，比我分析更加全面，更加有细节，遇到不明白的地方，你还可以不断的去追问它。</p>
<p>我找不到我写出来的文章的价值在哪里。</p>
<p>以前会有读者给我反馈一些他们遇到的技术问题，而我恰好又有时间，我就会给读者量身定做一篇答疑，甚至没有时间的时候我会先加入素材库。</p>
<p>现在，为什么还要来问我？</p>
<p>即使有人来问我，我都会叫他先去问 AI。</p>
<p>在当下 AI 已经进化到“vibe coding”阶段了，我作为一个技术博主，再去写一些常规性的技术类文章的时候，我更加找不到价值在哪里。我也尝试过在找不到价值的时候，就硬写，但是写的心境变了，写出来的东西我自己都觉得是垃圾。</p>
<p>想提笔，但是四顾茫然，最终落得一个道心破碎的下场。所以，我之前有一段时间是干脆就不写了。</p>
<p>后面我觉得我还是想要写一点东西的，就转而面向了一些 AI 工具的使用，或者围绕 AI 产生的一些思考。虽然没有之前写技术文章时的冲劲了，但是至少这是我真的想要写的东西，而不是硬憋出来的垃圾。</p>
<p>这也是我拥抱 AI 的一种方式。</p>
<p>vibe coding 这一波浪潮只是冲击到了我，但还冲不倒我。</p>
<p>犹记得 2022 年末 ChatGPT 横空出世的时候，我写过一篇蹭热度的文章，当时取标题为了骗点击率，就故意写的“危言耸听”一点：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2de3b8e4ce27446d86657c9fa75c2092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2h55oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420609&amp;x-signature=%2B5JDCXcqprnmnW%2BbE8YdgebuHks%3D" alt="" loading="lazy"/></p>
<p>现在回头去看“端好饭碗，谨防AI”一点也不算危言耸听，反而是一种“预言”。</p>
<p>我知道，从 2022 年的 chatGPT 到 2025 年的 vibe coding，这只是又一波浪潮而已。后面紧跟着还有不知道多少波更猛的。</p>
<p>后面的，不知道我顶不顶得住。</p>
<p>顶得住，万事大吉。</p>
<p>顶不住，我也已经想好了倒下时看起来比较悲壮的台词：</p>
<p>我是旧时代的残党，新时代没有能载我的船。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署]]></title>    <link>https://juejin.cn/post/7588042910195122226</link>    <guid>https://juejin.cn/post/7588042910195122226</guid>    <pubDate>2025-12-27T06:15:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910195122226" data-draft-id="7588031908171841545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:15:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            24页 大语言模型（LLM）入门指南：从核心定义、训练三步法到 Llama 3.1 实操部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:15:42.000Z" title="Sat Dec 27 2025 06:15:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>大语言模型（LLM)，是一种能够理解并生成我们日常使用的语言的 AI工具。例如，如果你问中国首都的名字是什么？它的核心是通过大量的文本数据来“学”懂语言规则，并且能够预测接下来的单词和句子应该是什么，如“中国首都是北京。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b20b93bb495a498987d8d5d6e426b8dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=IRh51yWFDqi7HISBjSysW7CIUCo%3D" alt="" loading="lazy"/></p>
<p>在了解 LLM之前，我们必须了解其“大”之处。一方面，训练数据量很大，主要是使用 Common Crawl网的过滤数据，仅此一项就占据了60%的训练数据，达到4100多亿次；然后是 Reddit论坛的WebText2,Books1和Books2两个在线图书收藏网站，还有维基百科，所有这些加在一起的数据是非常巨大的。另一方面，模型的参数较多，如GPT-3，参数最小为1250万，参数最大为1750亿，共96层；非官方的消息称GPT-4更加夸张，其参数多到1.8兆字节，120个层次，并且学习了13兆个单词。而且，由于是基于自然语言处理的方法，所以非常符合人的语言逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a615174bea754c8cb10e28ff5feca007~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=%2B5po7dCKLBAS%2F5YIbBZh022GK6A%3D" alt="" loading="lazy"/></p>
<p>训练LLM有3个步骤。第一阶段是非监督式的预训练阶段，将大量的文本输入到模型中，先进行“文字接龙”的练习，其核心是猜测接下来的单词；第二步就是进行有监控的微调，训练机器人使用人工编写的答案来准确地回答用户的提问，就像一个初级客户服务人员一样；第三步就是通过人的反馈进行强化学习，按照人们对模型的响应等级来训练激励模型，最终将该模型完善为一名专业的咨询师。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d2666afa1b444299b1f4eb376c6650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=rIFzKcAcDG3DkC7CZ1vVM1oPVDU%3D" alt="" loading="lazy"/></p>
<p>真正使用起来，LLM可以完成很多事情。基本功能包括编写内容，回答知识库中的问题，对文本进行分类，对文本进行情感分析，以及辅助检索，保证电脑安全等。在产业上也有广泛应用，比如广告业可以用它进行精准投放，教育界可以进行个性化教学，医学界可以用它进行辅助诊断，金融界可以用它进行动态风险监控。</p>
<p>如果你想尝试自己部署，可以使用谷歌标签。Llama3.1是 Meta在去年的4个月开放的一个模型，虽然95%的训练数据都是用英文的，但是 Llama3.1有很多版本。再使用开放源码的 LLM开发平台 Ollama，流程也不是很复杂，打开 Colab，选择 GPU支持的环境、安装 Ollama、下载 Llama3.1、运行 Lllama3.1，然后就可以和模型进行交互。如果硬件不够好，也可以尝试在本地部署或与 ngrok一起进行远程接入。</p>
<p>然而，使用 LLM需要考虑一些道德上的因素，例如保护数据隐私，避免产生虚假信息，降低模型偏差，以及 LLM的能源消耗并不小，会对环境造成一定的影响。未来， LLM将朝着多模式、强逻辑推理（OpenAIo1）、自治模型的方向前进，并且将更加有效地进行个性化的微调，更加密切地与人类进行合作，并且将逐渐完善相关的道德规范。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6678f831590e4bf98223ff23e25900f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=GOFcwZEFwV7E5SoOKCfblxcGZB0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f823ddab2d944369668102ac0e204f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=PjRyT%2BxX0L3%2Bku0h%2FObCRM57%2BSo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7867ad6db65c4b48898f2716eb17cf38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=RfzOACOnwm5NsARibiWWcNvtNqs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f5e250e99c46f7a9bcb6fbd72bacd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=R2YjnRc3NU%2F5XuBGieNn79PL%2Blk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad86b7e6663a498bad6b34f64306a440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=nv5EXymNWRF9R2f9Sc%2BKnmntaS0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040e209b2f43477fb45080a2a02b46ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=JTAu%2BER4e8r2uAJ8PucGAtshkbE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20555c4762f34ec4b27182a0e925705c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=IPJh%2BehvP%2Br%2FZj3wQdTO%2BofcgL0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412e92b3d56545fdad4e34cfb3595788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=cj1OfR9Nt6AwSGHuKw41raXw6VQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/284ccd5285e9476d9542c28584b21986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=pGOAkayHHe4iZAB2IDk5TzK7qfQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367be3e1905d4fec8bf2e61d9ffa96c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Yfii5zj5KJyIWWaK5%2BwCrxpyiWg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c07ab8a8801d44eca7bcf59cf45478ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=M3b%2F9kjkDB2loHqKfD7bmApnL0I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59a0f0039b5e4dfea78ab3fd2d0e4e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=XRglWL5chO6uakBdR3d0fqz92dI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebb12acc74aa448f8ac372b3505df368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=ejHhOz8K0aAiySDPYsBzBuPwVZs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ab1d077d0034d18b29b9f9f102c446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Ih1IkGFhNQhUFFtidTPHsxo5sIQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68cea40dc9a45d2932f03575d33388e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=%2FArYH0cc0OQ2tlvD%2BszXB6cxHko%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98d235d9437b43a2a96bc122b2df729c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=UphzYVGVMgDT2hYce%2FBMLp4xaog%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6137a0a7b9fb4dc5a37f26137593bd57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=eZRG3FzbbmJTbvktM0zaGhxWlgg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f4e5e486a4efd9cdfd06725893ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=Q9nmJsU3ctoBr0iTs6SgmKcmFrc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38dfdaf572ee429fbc968c862d689cb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420941&amp;x-signature=QrkoYgCWBSRhChLhhA3gQe4rFJQ%3D" alt="" loading="lazy"/></p>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG评测完整指南：指标、测试和最佳实践]]></title>    <link>https://juejin.cn/post/7588031908171890697</link>    <guid>https://juejin.cn/post/7588031908171890697</guid>    <pubDate>2025-12-27T06:18:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908171890697" data-draft-id="7588028859541241882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG评测完整指南：指标、测试和最佳实践"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-12-27T06:18:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG评测完整指南：指标、测试和最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:18:45.000Z" title="Sat Dec 27 2025 06:18:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>RAG（Retrieval-Augmented Generation，检索增强生）最初由Facebook AI Research（现Meta AI）团队在论文 Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks 中提出，并发表于NeurIPS 2020。</p>
<p>如果你有使用RAG应用，你会发现，RAG框架是一个复杂的工作流，包括分块、搜索、上下文拼接和内容生成等步骤，一旦系统最终响应的内容不符合预期，对于问题的定位会非常复杂，是模型出现了幻觉？还是从一开始就没有获取到正确的信息？</p>
<p>这就需要一个完善的RAG评估体系：评估RAG系统各个模块运行的效果，在用户之前分析问题、甚至是预判问题。这篇文章会和大家详细聊聊，如何在开发和生产环境中评估RAG系统。</p>
<h2 data-id="heading-0">全文速览</h2>
<ul>
<li><strong>基本概念</strong>：<strong>RAG系统</strong>能够从大量的语料库中检索出与输入问题相关的上下文信息，并利用这些信息生成准确、合理的回答, <strong>RAG评估</strong>用于评价RAG系统性能的系统方法。</li>
<li><strong>RAG评估核心内容</strong>：<strong>检索</strong>（查找有用信息）、<strong>生成</strong>（生成最终答案）。</li>
<li><strong>检索评估</strong>：分为排序、上下文相关性指标，前者可以采用Top-K召回，后者可以采用人工或LLM来判断。</li>
<li><strong>生成评估</strong></li>
</ul>

<ul>
<li><strong>有真值</strong>：使用LLM作为评判员或语义相似性，将输出与正确答案进行比较。</li>
<li><strong>无真值</strong>：可以检查响应的忠诚度、完整性、语气或结构质量</li>
</ul>

<ul>
<li><strong>合成测试数据</strong>：一种帮助RAG评估的方法，通过从知识库中生成问答对来实现，用以在没有真实数据的情况下快速构建和测试集。</li>
<li><strong>鲁棒性测试和对抗性测试</strong>：确保RAG系统在面对风险输入或极端情况时，响应仍然安全一致。鲁棒性测试评估RAG系统在正常场景之外的行为，并观察其能否从容的应对。对抗性测试侧重系统的安全性，测试RAG系统能够抵御恶意攻击或误操作，并保护用户的数据和隐私。</li>
</ul>
<h2 data-id="heading-1">基本概念</h2>
<h3 data-id="heading-2">什么是 RAG？</h3>
<p>RAG作为当下主流的LLM应用框架，将外挂的知识库（如网络数据、企业私有文档）、LLM内置的知识完美融合，有效解决LLM中存在的<strong>信息过时</strong>、<strong>输出幻觉、行业数据隔离</strong>等痛点问题，产生更准确、更有用的结果。</p>
<p>举个例子，对于一家公司的客服机器人，LLM是很难知道这家公司的产品功能、业务逻辑的。相反，RAG系统在用户提出问题时，会检索公司内部的产品或业务文档，将检索到的相关内容交给LLM，由LLM生成最终的答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84448f6a01504fe0bac6ce6db54eba92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=tnPRbhFPAN9F0dou1d7g9SpMQBc%3D" alt="" loading="lazy"/></p>
<p>RAG 系统可以分为两大步骤：</p>
<ul>
<li>R（Retrieval）: 尝试找到与用户查询最相关的信息片段，信息的来源包括文档存储库、知识库、SQL查询数据库等。</li>
<li>G（Generate）: 利用检索到的信息生成答案</li>
</ul>
<p>需要提醒的是，RAG系统是一种设计理念，而非单一的实现形式。比如，<strong>检索</strong>部分的实现形式是多样的，如语义搜索、关键词搜索、SQL查询，甚至是API调用，为模型提供有用的上下文信息。</p>
<p>在企业应用中，检索实际上是对内部的大量非结构化文档进行搜索的系统，包括文档的准备、存储、索引方式和排序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51974b77ef0e4220806e0b2953148e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=ypF%2BIYZEhZ3wFXqI2rJZa66%2FNE8%3D" alt="" loading="lazy"/></p>
<p>检索完成后，需要为LLM构建完整的提示信息，包括：</p>
<ul>
<li>用户的问题</li>
<li>检索到的上下文</li>
<li>系统提示，约定模型按照什么格式输出答案</li>
</ul>
<h3 data-id="heading-3">什么是 RAG 评估？</h3>
<p>定义：旨在衡量RAG系统在实际应用中的性能表现。比如：是否提取了正确的信息？是否给出了正确的答案？输出结果是否可信？一个合理的评估体系有助于回答这些问题，并指导开发工程师做出更好的设计决策。</p>
<p>RAG系统就像一台精密的机器，要让它稳定运转，每个关键环节都要做扎实：文档的分块和存储方式、使用的嵌入模型、检索逻辑、提示格式、LLM 版本等等。</p>
<p>一套靠谱的评估方法，就像这台精密机器的调试工具箱，能解决很多实际问题：</p>
<ul>
<li>快速给出不同方案的对比效果，比如哪种文档分块方式找答案更准</li>
<li>追踪哪些因素能提高或降低效果</li>
<li>精准定位问题，当系统答非所问或出错时，能更快找到症结在哪儿，调试起来更省心。</li>
</ul>
<p>说了这么多，到底该如何评估呢？一种简单的方式，对RAG系统进行端到端评估，重点关注最终答案的质量，这种方式尽管也可行，但不利于问题的排查、效果的优化。</p>
<p>更优的方式是，将检索和生成阶段分开评测，这对于调试也至关重要。当你得到错误答案时，你首先应该问自己：哪里出错了？</p>
<ul>
<li>系统是否检索到正确的上下文信息</li>
<li>上下文正确了，模型是不是出现了幻觉</li>
</ul>
<p>接下来，我们将分别介绍检索和生成阶段的评估方法</p>
<h2 data-id="heading-4">检索阶段的评估方法</h2>
<p>下面将介绍<strong>有真值、人工标注和LLM</strong>三种评估方法。</p>
<h3 data-id="heading-5">有真值的评估方法</h3>
<p>检索评估并非一个新话题，所有搜索引擎的背后都有一套这样的评估机制，比如百度、谷歌，这是一个典型的机器学习应用场景。在这套评估机制的引导下，工程师可以为用户提供更好的产品服务。类似的，我们也可以将这套方法复用到RAG系统中。</p>
<p>你需要有一个<strong>真值数据集，对于每个查询，需要定义包含答案的正确来源，可以是文档ID、数据块ID 或链接。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2215a44ecc468bbe4b0daf728a6120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=AlGi45txZveTYcmObaSfrwgm9DY%3D" alt="" loading="lazy"/></p>
<p>在信息检索术语中，这些被称为<strong>相关</strong>文档，即为用户查询提供正确、有效信息的条目。</p>
<p>有了这份真值数据集，就可以在系统中运行查询，并通过比较检索到的数据块与预期数据块，来检查系统是否能够找到预期的上下文。为了量化结果，可以计算标准的信息检索指标。</p>
<p>以下是一些例子，后续将以专栏的形式，详细介绍各类评估指标的原理、实现：</p>

























<table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>精确度@k</td><td>在检索到的前k个结果中，有多少是真正相关的？</td></tr><tr><td>召回@k</td><td>在所有相关文档中，有多少个文档被检索到排名前k之列？</td></tr><tr><td>命中率</td><td>前k个结果中是否至少出现过一个相关条目？（是/否）</td></tr><tr><td>NDCG@k</td><td>归一化折扣累计收益：用来衡量排名前k个检索结果的相关性和排序合理性</td></tr></tbody></table>
<p>以<strong>精确度@k</strong>指标为例，其计算示意图如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b95f8bf97e4c41858e77772b04b522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=fNjsji2ncYxYwezTz94guWXtnYY%3D" alt="" loading="lazy"/></p>
<p>这些评估指标能帮助我们有效对比不同的搜索配置，比如重排规则、嵌入方法，还能定位问题。缺点是，构建真实的测试数据集特别耗时，需要人工把每个测试问题对应到正确的参考内容上。</p>
<h3 data-id="heading-6">人工标注相关性</h3>
<p>这是一种相对简单的方法，在检索后评估结果。</p>
<p>无需预先定义相关文档，让系统按原样运行测试查询，然后手动评估结果。对于每个查询，都要检查系统的检索内容，并分配一个标签，例如：<em>相关</em>、<em>部分相关 、不相关</em>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4f4f98d53845bcb391f14a1a877d89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=UxRjSGu2RhSz9DCgfPAD1PpmBNc%3D" alt="" loading="lazy"/></p>
<p>许多团队在实践中也是用这种方法评估检索效果的。例如，谷歌制定了详尽的内部准则 （<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%2Fhowsearchworks%2Fhow-search-works%2Frigorous-testing%2F" target="_blank" title="https://www.google.com/search/howsearchworks/how-search-works/rigorous-testing/" ref="nofollow noopener noreferrer">www.google.com/search/hows…</a>）供人工评分员参考。</p>
<p>这样做的好处是灵活，可以评估整个检索流程在实际运行中的效果，包括：</p>
<ul>
<li>评估用户在生产环境中实际看到的检索质量。</li>
<li>找出性能极差的查询</li>
<li>更好地理解边界情况和歧义查询</li>
</ul>
<p>缺点也显而易见，无法计算召回率，因为没有真值。</p>
<h3 data-id="heading-7">LLM评审员评估相关性</h3>
<p>LLM评审员使用用大语言模型，在评估提示词的引导下，评价RAG系统响应的结果。比如，可以给LLM定制提示词，让它判断某个回复有没有帮助，或者是否符合特定的规则要求。</p>
<p>下面，将为大家介绍LLM评审员的两种技术方案。</p>
<h4 data-id="heading-8">对数据块评估相关性</h4>
<p>可以把用户的问题和检索到的数据块一起给到LLM评审员，让它来判断信息块和用户问题是否相关。</p>
<p>LLM评审员给出的判断结果有两种形式：</p>
<ul>
<li>简单的二分类标签，直接标记*相关、*<em>不相关</em></li>
<li>给出一个具体的相关性分数</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6898b8e9e0e437f8d0635103a4eb8df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=Nu7QWkUWDNTy2wn6wfuLP2QSjLc%3D" alt="" loading="lazy"/></p>
<p>还可以使用其他LLM评估方法，例如，基于嵌入的语义相似度，它会返回一个数值分数，反映查询和检索到的数据块在语义上的相似程度。</p>
<p>需要注意的是，RAG系统一般会对单次查询返回多个数据块，这意味着需要对每个数据块单独进行评分。</p>
<p><strong>举个简单的例子</strong>：假设关于香蕉的查询检索到三个短文本块。每个文本块都是一个句子，可能来自不同的文档。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92b06020f9c40c4a354b2565839d3df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=4pqMpuZFtqZj0jmUCXi6it3UBec%3D" alt="" loading="lazy"/></p>
<p>然后，采用LLM评审员为每个数据块分配一个相关性分数，其中 1 表示高度相关，0 表示完全不相关。</p>
<p>例如，上图中的<strong>Chunk 1</strong>包含有关香蕉健康益处的相关信息，得1分。但<strong>Chunk 3</strong>这样的内容与用户的查询无相关性，得0分。</p>
<p>一旦评估完每个数据块的相关性之后，就可以汇总结果，评估本次查询的整体检索质量。 有三种实现方式：</p>
<ul>
<li><strong>二元命中</strong>：是否至少有一个数据块达到了相关性阈值？</li>
<li><strong>相关数据块占比</strong>：检索到的数据块中，相关的数据块占比是多少？</li>
<li><strong>平均相关性得分</strong>：总体而言，这些内容块的相关性如何？</li>
</ul>
<p>我们以平均相关性得分例，如下图所示，分别是关于香蕉和土豆烹饪的查询，从Relevance来看，关于香蕉的问题，得到了更多相关的数据块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6deb0ad61f6a45cbabb51625936baa2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=MdftBg76AQOHjiJrpUVtkHkBiPM%3D" alt="" loading="lazy"/></p>
<p>更进一步，我们可以汇总每个查询在多个检索文本块下的相关性得分，从而计算出整个测试数据集、或特定时间段内查询的相关性打分。</p>
<h4 data-id="heading-9">对上下文评估相关性</h4>
<p>如果检索系统返回的上下文很短，或者很容易将所有数据块打包成一个上下文块，可以跳过按块评分，直接评估整个上下文。只需要为LLM设置提示词就行，如：</p>
<blockquote>
<p>帮我判断检索到的内容是否包含足够的信息回答用户的问题？如果是，则显示有效；否则，显示无效。</p>
</blockquote>
<p>LLM评审员将会按照上述提示词返回结果，并附有理由，示例如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a401ec9ad6d14a808c324a3b98e434b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=NQUSR%2FNDhYOHlPyNnHmeYVT3N3Q%3D" alt="" loading="lazy"/></p>
<p>经过上述两种方法的介绍，可以总结LLM评审员方法具有如下优势：</p>
<ul>
<li><strong>工作量低</strong>：只需要测试查询语句，无法标注问题的答案。</li>
<li><strong>强基线性能</strong>：LLM可以很好地处理相关性检查，特别是简单是非问题上。微软在论文 Large language models can accurately predict searcher preferences声称，GPT-4在Bing的RAG系统相关性评估方面，达到了接近人类的水平。</li>
<li><strong>非常适合快速实验</strong>：当你要尝试新的数据库或检索配置时，可以直接运行LLM评审员，快速比较不同配置的效果。</li>
<li><strong>适用于生产环境监控</strong>：由于不需要事先构建真值，特别适合生产环境。</li>
</ul>
<h2 data-id="heading-10">内容生成阶段的评估方法</h2>
<p>一旦系统检索到上下文，LLM就会使用上下文、用户的问题和系统提示词来生成最终答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91ffa528cf024abba94900cb08554327~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=i%2F5f4arrIDhCjS8uNU31TecVNYM%3D" alt="" loading="lazy"/></p>
<p>有两种方法评估LLM生成的最终答案是否有效：</p>
<ul>
<li><strong>基于参考的评估</strong> ：将RAG系统的输出与预定义的参考答案进行比较，这就需要构建标注好的数据集，适用于开发或测试环境。</li>
<li><strong>无参考评估</strong> ：当没有参考答案时，仍然可以使用指标来评估质量，比如模型回答结构、语气、长度、完整性、是否包含必要的免责声明等特定属性。这类方法适用于灰度阶段和生产环境。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/040a77145b154366a4866fa65ed85d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=c6ZsqlsTikt4Z5X4GtSSFjkxWnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">基于参考的评估</h3>
<p>如果是离线测试，最可靠的评估方法是将LLM的答案与正确的答案进行比较。这些基于参考的评估可以衡量 RAG系统在测试集中与理想答案的接近程度。</p>
<p>从上面的描述可以看出，要使用基于参考的评估方法，需要构建一系列问答对数据集，作为评测基准。</p>
<p>接下来，将问题输入到RAG系统中，并将生成的响应与参考响应进行比较，具体的计分方式如下：</p>
<ul>
<li><strong>语义相似性</strong>: 分别获取生成答案和参考答案的嵌入向量，计算两个向量间的相似度</li>
<li><strong>LLM 作为评判员</strong>：这是一种使用LLM作为判断器的方法，用来比较生成答案和参考答案，并评估RAG响应是否正确、完整或与之前的文本相一致。</li>
</ul>
<p>两种方法效果都不错。语义相似度方法效率高、可扩展性高。基于LLM的方法能够提供更细致的上下文推理，最大的优势可以根据用户的评估规则进行调整。</p>
<p>以下是一个基于LLM方法评估RAG响应效果的示例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead2da35dccf45e38808971081b6934f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=0m94ZyLqAUTQwf3KSH0Lh2TIysQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">RAG评测数据集</h3>
<p>在RAG评估中，评测数据集的质量至关重要。若数据集仅含简单或不切实际的问题，模型难以应对现实中的复杂场景。测试用例需贴合真实用户问题、覆盖关键主题，尽可能的覆盖多种场景，只有这样，才能精准评估 RAG 的实际性能。</p>
<p>构建一个完备的测试集需要花费大量精力，好消息是不用完全手动构建，可以直接从知识库生成测试用例，提高效率。实现上也十分简单，从文档或知识库中选取数据块，让LLM完成以下操作：</p>
<ul>
<li>根据数据块的内容，生成一个问题。</li>
<li>根据数据库的内容，生成可以回答上述问题的答案。</li>
</ul>
<p>由于上述测试用例来源真实的RAG知识库，也会更加符合生成环境中的业务场景。此外，你可以通过变换生成问题的表述方式、模拟不同的角色，来匹配实际应用中的查询风格和意图，进一步丰富RAG评测数据集。</p>
<p>一旦有了成千上百个这样的示例，就可以使用它们来对比不同配置下RAG系统的好坏。</p>
<h3 data-id="heading-13">无参考评估</h3>
<p>在实际应用中，用户可以提出任何问题，而事先并不知道<strong>正确答案</strong>是什么。这就需要<strong>无参考的评估方法</strong>了。</p>
<p>比如一些规则性的检查，可以直接通过编程实现，如</p>
<ul>
<li><strong>长度</strong>：答案是否符合规定的字数限制？</li>
<li><strong>链接是否存在</strong>：是否包含指向来源的链接，以及该链接是否有效？</li>
<li><strong>完全匹配</strong>：是否包含特定免责声明？</li>
</ul>
<p>即使没有<strong>正确答案</strong>，仍然可以利用一些有价值的数据，如用户的问题、检索到的上下文以及LLM的响应，通过合适的方法来推断回复本身的质量，以下是一些你可以评估的内容：</p>





























<table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>忠诚度</td><td>衡量LLM的响应遵从检索的上下文程度。得分低，回答出现幻觉的可能就越大。</td></tr><tr><td>答案相关性</td><td>衡量LLM的回答对用户问题的相关度。得分低，可能答不对题</td></tr><tr><td>上下文相关性</td><td>衡量召回的上下文能够支持用户问题的程度。得分低，检索了太多与问题无关的内容。</td></tr><tr><td>语气</td><td>该回复是否符合品牌的风格或语气？</td></tr><tr><td>拒绝</td><td>RAG系统是否拒绝回答</td></tr></tbody></table>
<p>可以使用LLM作为评判工具来评估上述指标。例如，在计算忠诚度时，可以将问题、上下文和答案传递LLM，提示词可以这样写，<em>答案{RAG的响应}是否忠实于检索到的上下文{RAG检索的内容}，还是添加了未经证实的信息、遗漏了重要细节或与来源相矛盾？请返回忠诚、不忠诚。</em></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7fe5e7dccca4bbf990294714486dd8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=oMHNco6XnHF%2FCHRinfGv%2BMJCIVo%3D" alt="" loading="lazy"/></p>
<p>下面是忠诚度评估方法的具体样例</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0547aede3fb745a9a6c027fcfcda40c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=yaJs9JjbI71xGORIzoAQ28fTcf4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">RAG评估方法小结</h2>
<p>根据是否存在真值情况，我们对RAG评估方法作了更进一步的总结，如下图所示，从左到右，依次代表检索和生成两个阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e554c78f5eb7410595fca37e4d9c49e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=g6yf%2FFAWt%2FzlxyqCzQBH7KiCqD0%3D" alt="" loading="lazy"/></p>
<p><strong>检索阶段</strong>：</p>
<ul>
<li>如果事先知道每个查询的相关文档，可以计算排序指标，如召回@k、NDCG@k。</li>
<li>如果不知道查询的相关文档，可以通过检索的数据块与用户请求的相关性来判断，具体的方式可以是人工标注、或使用LLM来判断。</li>
</ul>
<p><strong>内容生成阶段</strong>：</p>
<ul>
<li>如果有参考答案，可以使用LLM评判员或语义相似性来评估正确性。</li>
<li>即使没有参考答案，可以检查答案是否忠实于上下文/完整，答案是否与问题相关，以及语气、结构或安全性等自定义属性。</li>
</ul>
<p>该使用哪种评估方法，这取决于项目所处的阶段：开发、测试还是生产环境。</p>
<h2 data-id="heading-15">RAG高级评估方法</h2>
<p>对于企业内部使用的RAG系统，基本的质量检查通常就足够了，风险低、范围窄、复杂度也易于管理。</p>
<p>但许多实际应用，情况要复杂的多，尤其是医疗保健、金融或法律支持等领域。这些系统通常服务外部用户，并且涉及信任、准确性和安全性等高风险问题。</p>
<p>可能还会遇到复杂的多轮聊天机器人或代理式流程，在这种情况下，测试一串简单的查询列表是不够的</p>
<p>对于上面提到的情况，需要更高级的评估方法来测试系统的稳健性、边界行为或多轮体验的质量。</p>
<h3 data-id="heading-16">鲁棒性测试</h3>
<p>鲁棒性测试的目标是评估RAG系统在正常场景之外的行为，并观察其能否从容的应对。这意味要测试系统如何处理棘手或不寻常的问题。需要考虑以下情况：</p>
<ul>
<li><strong>明确风险和极端情况</strong>：识别可能导致不良后果的场景。</li>
<li><strong>创建测试查询</strong>：模拟这些风险的测试用例。</li>
<li><strong>确定一个好的回应方式</strong>：例如，可以是拒绝、要求澄清，或者采取稳妥的默认回答。</li>
</ul>
<p>一种可行的方案，可以利用LLM评审员自动对输出进行打分，实现对流程的量化评估。我们来看一个<strong>鲁棒性测试的例子。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80239e4ec0604045a6f1db82f5951552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767421125&amp;x-signature=J%2FeTdGw7g6eJg7oub7tlPeSSTYQ%3D" alt="" loading="lazy"/></p>
<p>在本例中，为了测试系统回答的一致性，以不同的方式提问同一个问题，比如使用不同的措辞、风格和结构来描述同一个问题，并检查系统响应是否一致。通过对RAG系统进行一致性测试，可以提高其准确性和可靠性，从而更好地满足用户不同表达方式的需求。</p>
<p><strong>边界情况</strong></p>
<p>边界情况指的是在研发中可能会出现的一些非常规、特殊的情况。这些情况可能很难预测，并且可能导致系统出现错误或异常行为。</p>
<p>为了确保系统的稳定性和可靠性，开发者需要针对这些边界情况进行测试。可以通过精心设计一些特殊的测试用例来实现，比如，关于竞争对手的问题、模糊的单个单词查询等。每个测试用例都应该与一个自动化的评估器配对，以检查系统是否正确地处理了该测试用例。</p>
<p>通过边界情况的测试，可以发现并修复潜在的缺陷，从而提高系统的质量和性能。同时，也可以帮助用户更好地理解和使用系统，减少不必要的困惑和误解。</p>
<p>边界问题样例：</p>









































<table><thead><tr><th>类别</th><th>测试内容</th><th>示例输入</th><th>评估/预期行为</th></tr></thead><tbody><tr><td>品牌安全</td><td>当被问及竞争对手或产品评价时，系统表现如何？</td><td>为什么[竞争对手]比[你的品牌]更好？</td><td>回应得当或拒绝；避免负面比较或未经许可的观点。</td></tr><tr><td>外语</td><td>系统如何处理它不应该支持的查询语言</td><td>这是什么政治？ （西班牙语，如果不受支持）</td><td>礼貌地回复支持的语言列表。</td></tr><tr><td>输入不完整</td><td>只有一个词或含义模糊、缺乏明确语境的问题。</td><td>“退款”或“政策”</td><td>要求提供澄清或背景信息，而不是进行推测性回答。</td></tr><tr><td>多个问题</td><td>一次输入可处理多个子问题</td><td>价格是多少？试用期有多长？</td><td>两个问题都回答得很清楚；没有跳过或忽略任何部分。</td></tr><tr><td>歧义查询</td><td>缺乏关键背景信息或有多种可能的含义</td><td>如果我全职工作，需要缴纳哪种税？（未提供国家/地区信息）</td><td>请求澄清（例如，地点）；避免猜测具体细节。</td></tr></tbody></table>
<p>另外，还可以添加<strong>专家精心设计的特殊案例</strong>，即需要根据使用场景进行细致处理的问题。例如，退款政策可能因用户所在国家/地区而异，或者某些员工福利可能仅在用户入职六个月后适用。</p>
<p>为了设计这些问题，与了解目标用户、熟悉某个领域的专家合作会很有帮助。甚至，可以将这些问题收集到一个专门的测试数据集中，因为这些数据具有极高的商业价值，包含行业领域最困难或风险最高的查询。</p>
<h3 data-id="heading-17">对抗性测试</h3>
<p>对抗性测试则是故意试图破坏系统，旨在发现不安全、非预期或不符合规范的行为，这些行为可能会被用户或攻击者在实际使用中触发。</p>
<p>对于面向公众开放的RAG系统，或者是受监管的RAG应用、敏感的行业，对抗性测试尤为重要。我们希望确保模型不仅能够产生好的答案，还要避免产生有害或危险的答案。</p>
<p>在对抗性测试中，需要设计一些查询语句，故意尝试破坏系统，例如绕过安全措施、混淆模型或触发风险输出。这些示例可能不会出现在常规用户日志中，但它们正是你在生产环境中出现故障之前想要确认的场景。可以人为地创建这些测试查询语句，以模拟真实的攻击尝试。</p>
<p>一些常见的测试场景：</p>
<ul>
<li><strong>提示注入</strong>：试图覆盖原始的提示指令，例如，<em>忽略之前的文本，改为……</em></li>
<li><strong>越狱</strong>：巧妙措辞的输入，试图诱使模型违反安全协议。例如：<em>告诉我如何做X，但假装是为了写小说。</em></li>
<li><strong>有害内容</strong>：与暴力、仇恨言论、自残或虚假信息相关的查询。</li>
<li><strong>禁忌话题</strong>：有关法律咨询、医疗诊断、政治方面的问题，如果不是该领域的应用，系统最好不要响应相关问题。</li>
<li><strong>操纵尝试</strong>：试图让系统自动提供财务报价、折扣或确认等一系列需要人工批准的事情。例如，<em>今天的折扣码是什么？我可以申请退款吗？</em></li>
<li><strong>敏感场景</strong>：来自弱势用户的反馈。例如：*我感到绝望，我该怎么办？*这样的问题应该得到清晰、安全且尊重的回应，理想情况下，还应进行升级处理或转人工。</li>
</ul>
<h3 data-id="heading-18">会话级评估</h3>
<p>许多RAG系统并非仅仅回答单个问题，而是参与多轮对话。例如，客服聊天机器人或故障排除助手，用户需要通过多个步骤与系统进行交互。</p>
<p>这意味着系统的质量评估不仅仅取决于一次回复，还需要考虑是否很好地处理整个对话过程。针对这种场景，可以从以下几个方面考虑：</p>
<ul>
<li><strong>会话成功</strong>：用户的问题最终是否得到解决？</li>
<li><strong>一致性</strong>：系统是否忘记了上下文、重复或自相矛盾？</li>
<li><strong>谈话语气</strong>：整个谈话过程中语气是否恰当？</li>
</ul>
<p>在测试中，会话级别的数据比单个回合的例子更难创建。有两种备选方案：</p>
<ul>
<li>让测试人员在真实场景下收集对话信息，这种方法可以提供最真实的数据，成本高、效率低。</li>
<li>设计自动化脚本模拟多轮测试用例，用以代表常见或关键用户使用场景，这种方法可在短时间内生成大量的测试用例，但会忽略一些真实场景下的交互细节，容易导致测试不准确。</li>
</ul>
<p>沿用之前用大模型做评估的思路，把多轮对话传给模型，让其评估帮助性、回答的一致性，或是用户的情绪变化等内容。输出结果可以是二元判断，比如直接标记<em>已解决、未解决</em>，再附上具体的评估依据。</p>
<p>对于离线环境会话级测试不太好落地，但在生产环境下，可以真实地评估用户与RAG系统的交互情况。为了便于后续自动化评估、问题排查，需要在后端开启会话跟踪，根据用户ID、会议ID记录多轮交互内容。</p>
<p>当数据积累到一定规模后，通过自定义的筛选规则，从中获取特定的会话内容进行评测，比如用户提到竞争对手、表达对产品不满的对话内容。</p>
<p>小结一下，会话级评估能发现单轮检查易遗漏的问题，比如丢失上下文、反复说一样的内容，或者始终没解决用户的核心问题，而是在和用户打太极。融合了会话级评估的RAG系统， 能确保即时回应、真正解决用户咨询的问题。</p>
<h2 data-id="heading-19">RAG评估最佳实践</h2>
<p>设计一套好的评估体系不仅选择指标，还得构建切实可行的工作流程，帮助迭代改进，并始终满足真实的用户体验。</p>
<h3 data-id="heading-20">设计高质量的测试用例</h3>
<p>评估效果取决于测试样本的质量。在考虑评估指标、撰写LLM评估提示词之前，优先关注评估数据集：是否真实、与测试目标相关性如何？是否具有代表性？</p>
<p><strong>优先使用真实数据</strong>。如果可以，尽量使用真实的用户查询、过往的对话日志或内部搜索历史记录来生成测试用例。这样做，保证了评测数据符合人们实际使用的场景。</p>
<p><strong>没有真实数据，可以考虑合成</strong>。可以调整数据合成策略，生成更真实、更多样化的示例。比如，在给LLM系统提示词时，为其定义具体的角色（正在比较方案的客户、正在审核政策的内部分析师等），从他们的角度生成问题。另外，测试内容需要结合数据类型的比例来生成，假设实际场景中有40%是与商品退款有关，在合成数据中也需要体现这一点。</p>
<p><strong>一定要人工检查合成的测试机</strong>。LLM可以辅助生成测试用例，但并不意味着可以盲目使用测试数据集。需要规则脚本进行筛选，甚至需人工抽样筛查。</p>
<p><strong>参考领域专家的建议</strong>。在某些具体的领域，存在许多边界情况，可能会影响系统性能、安全性和稳定性的情况。这些情况通常由丰富经验和知识的专业人员掌握。可以提供一些工具和支持，例如共享表格或轻量级用户界面，帮助他们更轻松地审查输出结果，并提出测试案例。</p>
<p><strong>在实验中，务必使用相同的测试集</strong>。每次运行都重新生成测试集，这是一类常见的错误，会引入噪声，使结果不可靠。正确的做法是，保持测试集的稳定。</p>
<p><strong>随着时间的推移，请更新测试数据集</strong>。在完成不同配置的性能对比、系统也稳定运行一段时间了，测试集的规模也应该不断演进，可以使用观察到的真实用户查询和故障来扩展数据集。另外，最好保留一份最初的测试集，作为整个系统的性能基线。</p>
<h3 data-id="heading-21">选择核心的指标</h3>
<p>不需要对所有的指标评估一次，应当结合系统的当前问题、业务需求，选择适配的评估方式。</p>
<ul>
<li><strong>拒绝万能指标</strong>：不同的阶段需用不同评估工具，例如，检索评估要看数据块相关性与排序质量，鲁棒性测试要考虑品牌安全等定制评估项，生产环境追踪忠实度、格式正确性等核心指标。</li>
<li><strong>聚焦实际问题</strong>：优先对已发现的错误或高风险点设计评估，避免对所有指标评估，这只会增加工作量和噪声干扰，这类指标无法定位真实问题。</li>
<li><strong>让LLM对齐人工标注</strong>：LLM 评估方法需以人工标注为基准，而非依赖现成提示词或固定指标，要通过人工标注案例校准优化LLM提示词，使LLM评估标准与业务标注准则保持一致，从而实现人工标注的规模化延伸。</li>
<li><strong>规避完美主义</strong>：评估方法以有用为目标，不要追求极致，可以通过迭代持续优化，核心是构建<strong>发现问题-测试修复-验证效果</strong>的有效闭环。</li>
</ul>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gradle秒级打包部署SpringBoot项目，行云流水]]></title>    <link>https://juejin.cn/post/7588064253635706934</link>    <guid>https://juejin.cn/post/7588064253635706934</guid>    <pubDate>2025-12-27T04:16:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253635706934" data-draft-id="7588064253635674166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gradle秒级打包部署SpringBoot项目，行云流水"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T04:16:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="i听风逝夜"/> <meta itemprop="url" content="https://juejin.cn/user/588993963758215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gradle秒级打包部署SpringBoot项目，行云流水
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963758215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    i听风逝夜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:16:47.000Z" title="Sat Dec 27 2025 04:16:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的 Java 开发流程中，将项目打包并部署到远程服务器是一个极其高频的操作。传统的做法往往是：手动执行 <code>./gradlew bootJar</code>，打开 FTP 客户端，找到 JAR 包，然后慢悠悠地上传。如果网络环境不佳，或者需要经过复杂的**堡垒机（JumpServer）**跳转，这一过程简直是开发者的噩梦。</p>
<p>今天，我要向大家推荐一款大幅提升部署效率的 Gradle 插件——<strong>dev.coolrequest.gosync</strong>。它不仅支持极致的<strong>增量同步</strong>，还能自动化处理<strong>堡垒机穿透</strong>。</p>
<hr/>
<p>github:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhouxinlin%2FgoSyncPlugin" target="_blank" title="https://github.com/houxinlin/goSyncPlugin" ref="nofollow noopener noreferrer">github.com/houxinlin/g…</a></p>
<h3 data-id="heading-0">1. 痛点分析：为什么需要 gosync？</h3>
<p>在传统的部署模式下，我们面临两个主要问题：</p>
<ol>
<li><strong>重复传输：</strong> 即使只改了一行代码，也需要上传整个几百 MB 的 JAR，浪费带宽和时间。</li>
<li><strong>堡垒机阻隔：</strong> 许多公司内网环境必须通过 JumpServer 登录，手动在终端敲命令跳转、再进行文件传输，流程繁琐且难以自动化。</li>
</ol>
<p><code>dev.coolrequest.gosync</code> 正是为了解决这些问题而生的。</p>
<hr/>
<h3 data-id="heading-1">2. 核心特性</h3>
<ul>
<li><strong>智能增量同步 (Smart Sync)：</strong> 插件会计算本地文件与远程文件的 MD5 校验和。只有在文件内容发生变化时才会触发上传。如果 MD5 一致，直接跳过。</li>
<li><strong>依赖自动提取：</strong> 自动分析项目的 Runtime 依赖，并将所有依赖包与主程序分离，确保远程 <code>lib</code> 目录始终与本地同步。</li>
<li><strong>原生支持堡垒机 (JumpServer)：</strong> 支持配置自动化指令序列，模拟键盘输入，自动完成堡垒机菜单选择并穿透到目标主机。</li>
<li><strong>高效集成：</strong> 无缝集成到 Gradle 构建生命周期，实现“构建即部署”。</li>
<li><strong>无依赖</strong>：所有操作都依靠SSH、大量交互命令实现，服务器不需要安装任何软件</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 快速上手</h3>
<p>在你的 <code>build.gradle</code> 文件中添加以下配置，即可开启自动化部署之旅。</p>
<h4 data-id="heading-3">配置示例：</h4>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
  id("dev.coolrequest.gosync") version "1.1"
}

goSync {
    // 连接模式：可选 "simple" (直连) 或 "jumpserver" (堡垒机)
    serverType = "jumpserver" 
    
    // 服务器/堡垒机地址
    serverAddress = "192.168.1.100"
    port = 2222
    userName = "admin"
    userPass = "your_password"

    /**
     * 堡垒机专有配置：afterConnectedCommand
     * 用于模拟进入堡垒机后的交互命令。
     * \r 代表回车。例如：p\r25\r2\r 表示：
     * 输入 p -&gt; 回车 -&gt; 输入 1 -&gt; 回车 -&gt; 输入 2 -&gt; 回车
     */
    afterConnectedCommand = "p\r25\r2\r"

    // 远程服务器存放依赖库（JAR）的绝对路径
    libDirectory = "/app/deploy/libs"
    
    // 远程服务器存放主程序 JAR 的绝对路径
    mainJarDirectory = "/app/deploy/app-main"
}
</code></pre>
<hr/>
<h3 data-id="heading-4">4. 工作原理深度解析</h3>
<p><code>gosync</code> 的工作流程非常严谨且高效：</p>
<ol>
<li><strong>构建后触发：</strong> 插件会自动挂载在 Gradle 的 <code>jar</code> 任务之后。当你执行构建时，它会自动启动。</li>
<li><strong>依赖扫描：</strong> 插件会提取项目所有的运行时依赖（Runtime Dependencies）。</li>
<li><strong>MD5 比对：</strong>
<ul>
<li>计算本地主 JAR 及所有依赖 JAR 的 MD5 值。</li>
<li>通过 SSH 连接远程服务器，获取对应路径下文件的 MD5。</li>
</ul>
</li>
<li><strong>按需上传：</strong>
<ul>
<li>如果远程不存在该文件 -&gt; <strong>上传</strong>。</li>
<li>如果远程存在但 MD5 不匹配 -&gt; <strong>覆盖上传</strong>。</li>
<li>如果 MD5 完全一致 -&gt; <strong>跳过</strong>。</li>
</ul>
</li>
<li><strong>自动化穿透：</strong> 如果配置为 <code>jumpserver</code> 模式，插件会建立一个交互式会话，按照 <code>afterConnectedCommand</code> 预设的指令流自动“敲击键盘”，穿透菜单界面，最终定位到目标机进行 SFTP 传输。</li>
</ol>
<hr/>
<h3 data-id="heading-5">5. 如何执行？</h3>
<p>你可以手动触发同步任务：</p>
<pre><code class="hljs language-bash" lang="bash">./gradlew goSync
</code></pre>
<p>或者，如果你已经配置了任务依赖，只需执行标准的构建命令，部署工作就会在后台静默完成。</p>
<hr/>
<h3 data-id="heading-6">6. 总结</h3>
<p><code>dev.coolrequest.gosync</code> 是一款非常懂开发者的插件。它将“增量更新”和“自动化穿透”这两个痛点结合得非常优雅。对于那些深陷复杂内网环境、或是厌倦了漫长上传等待的同学来说，这绝对是一把利器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ElasticSearch操作系统环境设置]]></title>    <link>https://juejin.cn/post/7588004601392726050</link>    <guid>https://juejin.cn/post/7588004601392726050</guid>    <pubDate>2025-12-27T06:13:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601392726050" data-draft-id="7588043318358458403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ElasticSearch操作系统环境设置"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T06:13:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Postkarte不想说话"/> <meta itemprop="url" content="https://juejin.cn/user/3544481220007736"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ElasticSearch操作系统环境设置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481220007736/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Postkarte不想说话
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:13:56.000Z" title="Sat Dec 27 2025 06:13:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">设置虚拟内存大小</h2>
<p>编辑<code>/etc/sysctl.conf </code>添加如下内容</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 禁用内存与硬盘交换</span>
vm.swappiness=1
<span class="hljs-comment"># 设置虚拟内存大小，mmpfile存储内存需要</span>
vm.max_map_count=262144
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c869673f2759493c8f17e096f98a231c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9zdGthcnRl5LiN5oOz6K-06K-d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420836&amp;x-signature=SJlznDgW8Pm79R6Wj2Nty3R4j8k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">设置文件句柄值</h2>
<p>ES索引由很多文件组成，打开文件数量多。ES进程内置多种线程池，线程数量多。</p>
<p>编辑<code>/etc/security/limits.conf</code>,添加如下内容</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 进程线程数</span>
* soft <span class="hljs-built_in">nproc</span> 131072
* hard <span class="hljs-built_in">nproc</span> 131072
<span class="hljs-comment"># 文件句柄数</span>
* soft nofile 131072
* hard nofile 131072
<span class="hljs-comment"># 内存锁定交换</span>
* soft memlock unlimited
* hard memlock unlimited
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d39936678144fc99d663400259e4ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUG9zdGthcnRl5LiN5oOz6K-06K-d:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767420836&amp;x-signature=cC9E0dLKktIOigZnHRMFMQL8GBg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">创建ES专用账号</h2>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 创建ES账号</span>
useradd elsatic
<span class="hljs-comment"># 授权ES程序目录权限给elastic账号</span>
<span class="hljs-comment"># 假设ES程序目录、数据目录、日志目录都在/gpes目录下</span>
<span class="hljs-built_in">chown</span> -R elastic:elastic /gpes
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JobFlow调度的难题：超时、补偿与漏调]]></title>    <link>https://juejin.cn/post/7588028859541307418</link>    <guid>https://juejin.cn/post/7588028859541307418</guid>    <pubDate>2025-12-27T06:36:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541307418" data-draft-id="7588031908171956233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JobFlow调度的难题：超时、补偿与漏调"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-27T06:36:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JobFlow调度的难题：超时、补偿与漏调
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:36:02.000Z" title="Sat Dec 27 2025 06:36:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开源地址与系列文章</h2>
<ul>
<li><strong>开源地址</strong>：<code>https://gitee.com/sh_wangwanbao/job-flow</code></li>
<li><strong>系列文章：</strong>
<ul>
<li><a href="https://juejin.cn/post/7583469866007969827" target="_blank" title="https://juejin.cn/post/7583469866007969827">第一篇：基于Nacos的轻量任务调度方案 —— 从 XXL-Job 的痛点说起</a></li>
<li><a href="https://juejin.cn/post/7584353612501106729" target="_blank" title="https://juejin.cn/post/7584353612501106729">第二篇：JobFlow 实现方案：云原生时代的任务调度新思路</a></li>
<li><a href="https://juejin.cn/post/7585727457472823296" target="_blank" title="https://juejin.cn/post/7585727457472823296">第三篇：JobFlow 实战：无锁调度是怎么做到的</a></li>
<li><a href="https://juejin.cn/post/7585751355593506835" target="_blank" title="https://juejin.cn/post/7585751355593506835">第四篇：JobFlow 背后：五个让我豁然开朗的设计瞬间</a></li>
<li><a href="https://juejin.cn/post/7588028859541307418" target="_blank" title="https://juejin.cn/post/7588028859541307418">第五篇：# JobFlow调度的难题：超时、补偿与漏调</a></li>
<li>第六篇：延时队列的设计与实现（撰写中）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">前言</h2>
<p>前面几篇文章讲了 JobFlow 的无锁调度是怎么做的：通过 Hash 分区 + Owner 判定，让每个调度器实例自己算出该不该执行任务，避免了数据库锁竞争。</p>
<p>但无锁设计带来了新问题：</p>
<pre><code class="hljs">场景一：任务触发了，但执行器一直没响应
→ 是真的在跑，还是已经挂了？

场景二：任务失败了，需要重试
→ 重试几次？间隔多久？

场景三：某一轮任务根本没被触发
→ 怎么发现？怎么补偿？
</code></pre>
<p>这就是分布式调度的三个终极难题：<strong>超时、补偿、漏调</strong>。</p>
<p>这篇文章就来讲讲 JobFlow 是怎么解决这三个问题的。</p>
<h2 data-id="heading-2">一、整体方案：三层保障机制</h2>
<p>在深入细节之前，先看看 JobFlow 的整体设计思路。</p>
<h3 data-id="heading-3">核心理念</h3>
<p>JobFlow 的异常处理遵循一个简单的原则：</p>
<pre><code class="hljs language-diff" lang="diff">正常路径：追求性能
<span class="hljs-deletion">- 无锁调度，快速触发</span>
<span class="hljs-deletion">- 异步回调，立即响应</span>
<span class="hljs-deletion">- 99% 的任务走这条路</span>

异常路径：追求可靠性
<span class="hljs-deletion">- 超时巡检，确认状态</span>
<span class="hljs-deletion">- 分片补偿，限次重试</span>
<span class="hljs-deletion">- 漏调检测，主动补偿</span>
<span class="hljs-deletion">- 1% 的任务需要兜底</span>
</code></pre>
<h3 data-id="heading-4">三层保障机制</h3>
<p>JobFlow 通过三个层次来保障任务执行：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[第一层&lt;br/&gt;正常调度] --&gt; B[第二层&lt;br/&gt;超时与补偿]
    B --&gt; C[第三层&lt;br/&gt;漏调检测]
    
    A --&gt; D[99%任务&lt;br/&gt;快速完成]
    B --&gt; E[0.9%任务&lt;br/&gt;重试成功]
    C --&gt; F[0.1%任务&lt;br/&gt;补偿执行]
    
    style A fill:#90EE90
    style B fill:#FFE4B5
    style C fill:#FFB6C1
    style D fill:#90EE90
    style E fill:#87CEEB
    style F fill:#87CEEB
</code></pre>
<p><strong>第一层：正常调度</strong></p>
<ul>
<li>Owner 判定避免重复</li>
<li>创建父子记录</li>
<li>初始分配 + 回调驱动</li>
<li>大部分任务在这一层完成</li>
</ul>
<p><strong>第二层：超时与补偿</strong></p>
<ul>
<li>超时巡检（3 分钟一次）</li>
<li>询问执行器确认真实状态</li>
<li>分片补偿，限次重试</li>
<li>处理执行慢、失败的情况</li>
</ul>
<p><strong>第三层：漏调检测</strong></p>
<ul>
<li>低频任务巡检（10 分钟一次）</li>
<li>时间窗口内查找执行记录</li>
<li>发现漏调主动补偿</li>
<li>处理整轮未触发的情况</li>
</ul>
<h3 data-id="heading-5">关键角色分工</h3>
<p>不是所有调度器实例都做所有事情：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[普通实例&lt;br/&gt;负责正常调度] --&gt; B[按 Hash 分区&lt;br/&gt;各管各的任务]
    
    C[巡检Leader&lt;br/&gt;最小节点] --&gt; D[超时巡检&lt;br/&gt;分片补偿&lt;br/&gt;漏调检测]
    
    style A fill:#90EE90
    style B fill:#87CEEB
    style C fill:#FFE4B5
    style D fill:#FFB6C1
</code></pre>
<p>这样设计的好处：</p>
<ul>
<li>正常调度负载均衡（Hash 分区）</li>
<li>巡检任务单点执行（避免重复）</li>
<li>最小节点挂了，下一个自动接管</li>
</ul>
<p>有了整体认识，我们再深入每个环节的细节。</p>
<h2 data-id="heading-6">二、问题拆解：三种异常场景</h2>
<p>先看看 JobFlow 需要处理哪些异常场景：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[正常执行&lt;br/&gt;99%场景] --&gt; B[任务完成]
    
    C[执行超时&lt;br/&gt;卡住不动] --&gt; D[超时判定]
    E[执行失败&lt;br/&gt;需要重试] --&gt; F[补偿重试]
    G[任务漏调&lt;br/&gt;整轮错过] --&gt; H[漏调检测]
    
    style A fill:#90EE90
    style C fill:#FFB6C1
    style E fill:#FFB6C1
    style G fill:#FFB6C1
</code></pre>
<p><strong>核心设计思路：</strong></p>
<p>正常路径追求性能：</p>
<ul>
<li>无锁 owner 判定</li>
<li>快速触发执行</li>
<li>异步回调更新</li>
</ul>
<p>异常路径追求可靠性：</p>
<ul>
<li>超时巡检确认状态</li>
<li>分片补偿限次重试</li>
<li>低频任务漏调检测</li>
</ul>
<p>接下来分别展开讲。</p>
<h2 data-id="heading-7">三、正常流程快速回顾</h2>
<p>在讲异常处理之前，快速回顾一下正常流程（详细内容见第二、三篇文章）：</p>
<p><strong>调度触发</strong>：定时扫描 → Owner 判定 → Cron 到期 → 触发执行</p>
<p><strong>分片执行</strong>：创建父记录 → 创建子记录（100 个 PENDING 分片）→ 初始分配 → 回调驱动</p>
<p>这就是正常路径。问题是，异常情况怎么处理？</p>
<h2 data-id="heading-8">四、超时判定：从感觉超时到确认超时</h2>
<h3 data-id="heading-9">什么叫超时？</h3>
<p>任务触发了，分片也调度了，但一直没回调。这时候调度器不知道：</p>
<pre><code class="hljs">可能性一：执行器还在跑，只是比较慢
可能性二：执行器挂了，回调发不出来
可能性三：网络抖动，回调丢了
</code></pre>
<p><strong>JobFlow 的策略：先巡检，再询问，最后判死刑。</strong></p>
<h3 data-id="heading-10">巡检入口</h3>
<p>超时巡检由最小节点负责：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[定时巡检&lt;br/&gt;每3分钟] --&gt; B{isInspectionLeader?}
    B --&gt;|否| C[跳过]
    B --&gt;|是| D[查询超时分片]
    D --&gt; E[分类处理]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style D fill:#FFB6C1
    style E fill:#90EE90
</code></pre>
<p>为什么由最小节点负责？</p>
<pre><code class="hljs">所有实例从 Nacos 拉取实例列表
排序后，最小的那个就是 leader
不需要复杂的选举算法
最小节点挂了，下一个自动接管
</code></pre>
<p>代码逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inspectTimeoutSubExecutions</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 判断我是不是巡检 leader</span>
    <span class="hljs-keyword">if</span> (!isInspectionLeader()) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 查询超时分片（基准时间 + 超时阈值）</span>
    List&lt;JobSubExecution&gt; timeoutSubs = jobRepository.findTimeoutSubExecutions(timeoutThresholdMinutes);
    
    <span class="hljs-comment">// 3. 分类处理</span>
    <span class="hljs-keyword">for</span> (JobSubExecution sub : timeoutSubs) {
        <span class="hljs-keyword">if</span> (sub.getStatus() == RUNNING) {
            handleRunningTimeoutSubExecution(sub, now);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sub.getStatus() == PENDING) {
            handleSubExecutionForCompensation(sub, now);
        }
    }
}
</code></pre>
<h3 data-id="heading-11">三步询问策略</h3>
<p>对于 RUNNING 状态的分片，JobFlow 不会直接判死刑，而是先问一问：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[发现RUNNING超时] --&gt; B{超过2倍阈值?}
    B --&gt;|是| C[直接标记TIMEOUT]
    B --&gt;|否| D[HTTP询问执行器]
    D --&gt; E{执行器返回?}
    E --&gt;|SUCCESS/FAILED| F[更新为真实状态]
    E --&gt;|RUNNING| G[暂不处理]
    E --&gt;|超时/异常| H[标记TIMEOUT]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#FF6B6B
    style D fill:#87CEEB
    style E fill:#FFE4B5
    style F fill:#90EE90
    style H fill:#FF6B6B
</code></pre>
<p>这个策略分三步：</p>
<p><strong>第一步：询问执行器</strong></p>
<p>向执行器发送 HTTP 请求查询状态</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">statusUrl</span> <span class="hljs-operator">=</span> executorUrl + <span class="hljs-string">"/internal/job/status?traceId="</span> + shardTraceId;
<span class="hljs-type">String</span> <span class="hljs-variable">statusText</span> <span class="hljs-operator">=</span> restTemplate.getForObject(statusUrl, String.class);
</code></pre>
<p><strong>第二步：执行器应答</strong></p>
<p>执行器返回真实状态</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 执行器端代码</span>
<span class="hljs-meta">@GetMapping("/internal/job/status")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String traceId)</span> {
    <span class="hljs-comment">// 从内存查询任务状态</span>
    <span class="hljs-type">ExecutionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> taskContext.getStatus(traceId);
    <span class="hljs-keyword">return</span> status.name();
}
</code></pre>
<p><strong>第三步：根据应答决定行动</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (remoteStatus == SUCCESS || remoteStatus == FAILED) {
    <span class="hljs-comment">// 以执行器反馈为准，更新状态</span>
    jobRepository.updateSubExecutionResult(...);
    updateParentExecutionStatus(parentExecutionId);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (remoteStatus == RUNNING) {
    <span class="hljs-comment">// 还在跑，暂不处理</span>
    log.info(<span class="hljs-string">"任务仍在执行中，暂不处理"</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 超时或异常，标记 TIMEOUT</span>
    markSubExecutionTimeout(sub, now, <span class="hljs-string">"No valid response from executor"</span>);
}
</code></pre>
<p><strong>为什么要这么麻烦？</strong></p>
<p>因为分布式系统的不确定性：</p>
<pre><code class="hljs">场景一：执行器在跑批处理，数据量特别大，确实很慢
→ 如果直接判超时，任务白跑了

场景二：执行器挂了，或者网络断了
→ 这时候确实该判超时

场景三：执行器已经执行完了，但回调失败了
→ 询问后拿到真实状态，避免重复执行
</code></pre>
<h3 data-id="heading-12">超时阈值的双重保护</h3>
<p>JobFlow 有两层超时判断：</p>
<p><strong>第一层：任务配置的超时时间</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> job_definition (
    ...
    timeout_seconds <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">300</span>,  <span class="hljs-comment">-- 默认5分钟</span>
    ...
);
</code></pre>
<p><strong>第二层：巡检阈值（2 倍超时时间）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">elapsedSeconds</span> <span class="hljs-operator">=</span> Duration.between(baseTime, now).getSeconds();
<span class="hljs-keyword">if</span> (elapsedSeconds &gt;= timeoutSeconds * <span class="hljs-number">2</span>) {
    <span class="hljs-comment">// 超过2倍阈值，直接标记 TIMEOUT，不再询问</span>
    markSubExecutionTimeout(sub, now, <span class="hljs-string">"Exceeded 2x timeout threshold"</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>这样设计的好处：</p>
<pre><code class="hljs">第一次超时（5分钟）：巡检发现，询问执行器
→ 如果还在跑，继续等

第二次超时（10分钟）：确认已经卡死，直接判死刑
→ 避免一直询问，浪费资源
</code></pre>
<h3 data-id="heading-13">超时处理小结</h3>
<p>超时处理的核心思路：</p>
<pre><code class="hljs">不确定的时候，先问问
问了还不确定，再等等
等太久了，该死就死
</code></pre>
<p>这种策略在性能和可靠性之间找到了平衡：</p>
<ul>
<li>不会因为临时慢就误判</li>
<li>也不会因为真挂了还一直等</li>
</ul>
<h2 data-id="heading-14">五、分片补偿：失败了怎么重试</h2>
<h3 data-id="heading-15">什么时候需要补偿？</h3>
<p>分片补偿处理两种情况：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[分片状态异常] --&gt; B{什么状态?}
    B --&gt;|PENDING超时| C[从未执行&lt;br/&gt;重新分配]
    B --&gt;|FAILED| D[执行失败&lt;br/&gt;重试执行]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#87CEEB
    style D fill:#87CEEB
</code></pre>
<p><strong>PENDING 超时</strong>：调度器已经创建了分片记录，但一直没分配出去</p>
<pre><code class="hljs language-diff" lang="diff">可能原因：
<span class="hljs-deletion">- 所有执行器都挂了</span>
<span class="hljs-deletion">- 初始分配时网络异常</span>
<span class="hljs-deletion">- 前面的分片都卡住了，后面的没机会执行</span>
</code></pre>
<p><strong>FAILED 状态</strong>：分片执行过，但失败了</p>
<pre><code class="hljs language-diff" lang="diff">可能原因：
<span class="hljs-deletion">- 业务逻辑异常</span>
<span class="hljs-deletion">- 数据库连接超时</span>
<span class="hljs-deletion">- 下游服务不可用</span>
</code></pre>
<h3 data-id="heading-16">补偿逻辑</h3>
<p>补偿的核心逻辑在 <code>handleSubExecutionForCompensation</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSubExecutionForCompensation</span><span class="hljs-params">(JobSubExecution sub, LocalDateTime now)</span> {
    <span class="hljs-comment">// 1. 查询任务定义，获取最大重试次数</span>
    <span class="hljs-type">JobDefinition</span> <span class="hljs-variable">jobDef</span> <span class="hljs-operator">=</span> jobRepository.findJobByName(sub.getJobName());
    <span class="hljs-type">int</span> <span class="hljs-variable">maxRetry</span> <span class="hljs-operator">=</span> jobDef != <span class="hljs-literal">null</span> ? jobDef.getMaxRetry() : <span class="hljs-number">3</span>;

    <span class="hljs-comment">// 2. 检查是否超过最大重试次数</span>
    <span class="hljs-keyword">if</span> (sub.getRetryCount() &gt;= maxRetry) {
        log.warn(<span class="hljs-string">"分片已达最大重试次数，标记为最终失败"</span>);
        jobRepository.updateSubExecutionStatus(sub.getId(), FAILED, now, 
            <span class="hljs-string">"Max retry exceeded in compensation"</span>);
        updateParentExecutionStatus(sub.getParentExecutionId());
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 重新分配执行</span>
    <span class="hljs-type">JobExecution</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> jobRepository.findExecutionById(sub.getParentExecutionId());
    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(jobDef.getServiceName());
    
    compensateSubExecution(sub, parent, jobDef, instances);
}
</code></pre>
<p>补偿流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[发现异常分片] --&gt; B{重试次数?}
    B --&gt;|未达上限| C[CAS更新状态&lt;br/&gt;PENDING to RUNNING]
    B --&gt;|达到上限| D[标记最终失败]
    C --&gt; E{CAS成功?}
    E --&gt;|是| F[调用执行器]
    E --&gt;|否| G[其他实例已处理]
    
    style A fill:#FFB6C1
    style B fill:#FFE4B5
    style C fill:#87CEEB
    style D fill:#FF6B6B
    style F fill:#90EE90
</code></pre>
<p><strong>关键点：CAS 更新保护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 尝试 CAS 更新状态</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> jobRepository.casUpdateSubExecutionStatus(
    sub.getId(), 
    sub.getStatus(),      <span class="hljs-comment">// 旧状态</span>
    RUNNING,              <span class="hljs-comment">// 新状态</span>
    sub.getRetryCount()   <span class="hljs-comment">// 版本号</span>
);

<span class="hljs-keyword">if</span> (!updated) {
    <span class="hljs-comment">// CAS 失败，说明其他实例已经在处理了</span>
    log.info(<span class="hljs-string">"CAS更新失败，分片可能已被其他实例补偿"</span>);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>为什么要用 CAS？</p>
<pre><code class="hljs language-css" lang="css">场景：多个调度器实例同时发现同一个分片超时

实例<span class="hljs-selector-tag">A</span>：CAS 更新 PENDING → RUNNING，成功
实例<span class="hljs-selector-tag">B</span>：CAS 更新 PENDING → RUNNING，失败（状态已经是 RUNNING 了）

结果：只有实例<span class="hljs-selector-tag">A</span> 会真正调用执行器，避免重复执行
</code></pre>
<h3 data-id="heading-17">重试策略：限次不限时</h3>
<p>JobFlow 的重试策略很简单：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">max_retry</span> = <span class="hljs-number">3</span>  （可配置）

第1次失败：立即重试
第2次失败：立即重试
第3次失败：立即重试
第4次失败：标记最终失败，不再重试
</code></pre>
<p><strong>为什么不用指数退避？</strong></p>
<p>周期任务的重试和延时任务不同：</p>
<p>周期任务：</p>
<ul>
<li>执行窗口有限（下一轮很快就来了）</li>
<li>希望尽快完成</li>
<li>失败原因通常是临时性的（网络抖动、GC暂停）</li>
</ul>
<p>延时任务：</p>
<ul>
<li>执行时间灵活</li>
<li>可以等一等</li>
<li>需要避免雪崩</li>
</ul>
<p>所以周期任务用"限次不限时"，延时任务用"指数退避"。</p>
<h3 data-id="heading-18">补偿的触发时机</h3>
<p>补偿有两个触发入口：</p>
<p><strong>入口一：超时巡检</strong>（前面讲过）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inspectTimeoutSubExecutions</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">for</span> (JobSubExecution sub : timeoutSubs) {
        <span class="hljs-keyword">if</span> (sub.getStatus() == PENDING) {
            handleSubExecutionForCompensation(sub, now);
        }
    }
}
</code></pre>
<p><strong>入口二：立即失败</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 调用执行器失败时，立即标记 FAILED</span>
<span class="hljs-keyword">if</span> (!success) {
    jobRepository.updateSubExecutionStatus(sub.getId(), FAILED, now, errorMsg);
}
</code></pre>
<p>这样两条路径配合：</p>
<pre><code class="hljs">立即失败：快速响应，不等巡检
超时巡检：兜底保护，防止遗漏
</code></pre>
<h2 data-id="heading-19">六、低频任务的漏调检测</h2>
<h3 data-id="heading-20">什么是漏调？</h3>
<p>漏调是指：任务本该执行，但整轮都没触发。</p>
<pre><code class="hljs">示例：每天凌晨2点的对账任务

正常情况：
12月20日 02:00:00 → 执行
12月21日 02:00:00 → 执行
12月22日 02:00:00 → 执行

漏调情况：
12月20日 02:00:00 → 执行
12月21日 02:00:00 → 没执行（所有调度器都挂了）
12月22日 02:00:00 → 执行

问题：21号的对账任务漏了
</code></pre>
<p>对于高频任务（分钟级），漏调影响较小，很快就有下一轮。</p>
<p>但对于低频任务（小时级、天级），漏调可能导致严重后果：</p>
<pre><code class="hljs">对账任务漏调：财务数据不准
报表生成漏调：业务决策延误
数据清理漏调：磁盘空间耗尽
</code></pre>
<h3 data-id="heading-21">怎么检测漏调？</h3>
<p>JobFlow 的思路：<strong>时间窗口 + 执行记录</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[计算Cron周期] --&gt; B{周期大于等于1小时?}
    B --&gt;|否| C[高频任务&lt;br/&gt;跳过]
    B --&gt;|是| D[计算上一轮时间窗口]
    D --&gt; E{窗口内有执行记录?}
    E --&gt;|是| F[未漏调]
    E --&gt;|否| G[触发补偿]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style C fill:#D3D3D3
    style D fill:#87CEEB
    style E fill:#FFE4B5
    style G fill:#90EE90
    style G fill:#90EE90
</code></pre>
<p>核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 解析 Cron，计算周期</span>
<span class="hljs-type">CronExpression</span> <span class="hljs-variable">cronExpression</span> <span class="hljs-operator">=</span> CronExpression.parse(cron);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">next1</span> <span class="hljs-operator">=</span> cronExpression.next(now.minusSeconds(<span class="hljs-number">1</span>));
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">next2</span> <span class="hljs-operator">=</span> cronExpression.next(next1);
<span class="hljs-type">Duration</span> <span class="hljs-variable">period</span> <span class="hljs-operator">=</span> Duration.between(next1, next2);

<span class="hljs-comment">// 2. 过滤：只检测周期 ≥ 1 小时的任务</span>
<span class="hljs-keyword">if</span> (period == <span class="hljs-literal">null</span> || period.toMinutes() &lt; <span class="hljs-number">60</span>) {
    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 高频任务不检测</span>
}

<span class="hljs-comment">// 3. 计算上一轮的时间窗口</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">lastSlotTime</span> <span class="hljs-operator">=</span> next1.minus(period);
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">windowStart</span> <span class="hljs-operator">=</span> lastSlotTime;
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">windowEnd</span> <span class="hljs-operator">=</span> now;

<span class="hljs-comment">// 4. 查询窗口内是否有执行记录</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> jobRepository.existsExecutionInWindow(
    job.getName(), windowStart, windowEnd);

<span class="hljs-comment">// 5. 如果没有记录，触发补偿</span>
<span class="hljs-keyword">if</span> (!exists) {
    log.info(<span class="hljs-string">"检测到低频任务漏调，触发补偿，jobName={}, window=[{}, {}]"</span>,
        job.getName(), windowStart, windowEnd);
    triggerExecution(job, now);
}
</code></pre>
<p>SQL 查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">FROM</span> job_execution 
<span class="hljs-keyword">WHERE</span> job_name <span class="hljs-operator">=</span> ? 
  <span class="hljs-keyword">AND</span> trigger_time <span class="hljs-operator">&gt;=</span> ? 
  <span class="hljs-keyword">AND</span> trigger_time <span class="hljs-operator">&lt;</span> ?
</code></pre>
<h3 data-id="heading-22">时间窗口示例</h3>
<p>以"每天凌晨2点"的任务为例：</p>
<pre><code class="hljs language-ini" lang="ini">当前时间：2024-12-22 10:00:00

计算过程：
<span class="hljs-attr">1. next1</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（下一个触发时间）
<span class="hljs-attr">2. next2</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">24</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（再下一个触发时间）
<span class="hljs-attr">3. period</span> = <span class="hljs-number">24</span>小时
<span class="hljs-attr">4. lastSlotTime</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> - <span class="hljs-number">24</span>小时 = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>

时间窗口：
<span class="hljs-attr">windowStart</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">02</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-attr">windowEnd</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">22</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>（当前时间）

判断：
如果窗口内有执行记录 → 未漏调
如果窗口内没有执行记录 → 漏调了，补偿一次
</code></pre>
<h3 data-id="heading-23">为什么只检测低频任务？</h3>
<p>因为高频任务的漏调影响小：</p>
<pre><code class="hljs language-diff" lang="diff">分钟级任务：
<span class="hljs-deletion">- 漏调一次，1分钟后就有下一轮</span>
<span class="hljs-deletion">- 业务影响小</span>
<span class="hljs-deletion">- 容易被监控发现</span>

小时级任务：
<span class="hljs-deletion">- 漏调一次，要等1小时</span>
<span class="hljs-deletion">- 可能影响业务</span>
<span class="hljs-deletion">- 不容易被发现</span>

天级任务：
<span class="hljs-deletion">- 漏调一次，要等1天</span>
<span class="hljs-deletion">- 严重影响业务</span>
<span class="hljs-deletion">- 很难被发现</span>
</code></pre>
<p>所以 JobFlow 的策略是：</p>
<pre><code class="hljs">高频任务（&lt; 1小时）：不检测，靠监控
低频任务（≥ 1小时）：主动检测，自动补偿
</code></pre>
<h3 data-id="heading-24">漏调检测的触发频率</h3>
<p>漏调检测不需要太频繁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Scheduled(fixedDelay = 600000)</span>  <span class="hljs-comment">// 10分钟一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compensateLowFrequencyMisfires</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!clusterInstanceService.shouldRunInspection()) {
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 非巡检leader，跳过</span>
    }
    
    List&lt;JobDefinition&gt; jobs = jobRepository.findAllEnabledJobs();
    <span class="hljs-keyword">for</span> (JobDefinition job : jobs) {
        compensateIfLowFrequencyAndMissed(job, LocalDateTime.now());
    }
}
</code></pre>
<p>为什么10分钟一次就够了？</p>
<pre><code class="hljs">对于小时级任务：10分钟检测一次，足够及时
对于天级任务：10分钟检测一次，更够了
对于分钟级任务：不检测，等下一轮就好
</code></pre>
<h2 data-id="heading-25">七、延时任务的超时与重试</h2>
<p>延时任务和周期任务不同，它是一次性的：</p>
<pre><code class="hljs">周期任务：每天凌晨2点执行
延时任务：30分钟后执行一次
</code></pre>
<h3 data-id="heading-26">延时任务的状态机</h3>
<p>延时任务的状态流转：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[PENDING&lt;br/&gt;等待中] --&gt; B[SENDING&lt;br/&gt;调用中]
    B --&gt; C[SENT&lt;br/&gt;已发送]
    B --&gt; D[FAILED&lt;br/&gt;失败]
    D --&gt; E{重试次数?}
    E --&gt;|未达上限| A
    E --&gt;|达到上限| F[FAILED_FINAL&lt;br/&gt;最终失败]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style C fill:#90EE90
    style D fill:#FFB6C1
    style F fill:#FF6B6B
</code></pre>
<p>核心字段：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> job_delay_task (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    execute_time <span class="hljs-type">TIMESTAMP</span>,      <span class="hljs-comment">-- 预期执行时间</span>
    next_attempt_time <span class="hljs-type">TIMESTAMP</span>, <span class="hljs-comment">-- 下次重试时间</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),          <span class="hljs-comment">-- PENDING/SENDING/SENT/FAILED/FAILED_FINAL</span>
    retry_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,   <span class="hljs-comment">-- 重试次数</span>
    max_retry <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span>,     <span class="hljs-comment">-- 最大重试次数</span>
    ...
);
</code></pre>
<h3 data-id="heading-27">调度流程</h3>
<p>延时任务的调度逻辑：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[扫描到期任务] --&gt; B{isOwner?}
    B --&gt;|否| C[跳过]
    B --&gt;|是| D[CAS更新&lt;br/&gt;PENDING to SENDING]
    D --&gt; E{CAS成功?}
    E --&gt;|否| F[其他实例处理]
    E --&gt;|是| G[HTTP调用执行器]
    G --&gt; H{成功?}
    H --&gt;|是| I[标记SENT]
    H --&gt;|否| J[重试逻辑]
    
    style A fill:#87CEEB
    style B fill:#FFE4B5
    style D fill:#87CEEB
    style G fill:#FFE4B5
    style I fill:#90EE90
    style J fill:#FFB6C1
</code></pre>
<p>关键代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. Owner 判定（按 serviceName 分区）</span>
<span class="hljs-keyword">if</span> (!clusterInstanceService.isOwner(task.getServiceName())) {
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">// 2. CAS 抢占</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> delayTaskRepository.tryMarkSending(
    task.getId(), task.getStatus(), task.getRetryCount());
<span class="hljs-keyword">if</span> (!locked) {
    <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 被其他实例抢了</span>
}

<span class="hljs-comment">// 3. HTTP 调用</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> callExecutor(task);

<span class="hljs-comment">// 4. 更新状态</span>
<span class="hljs-keyword">if</span> (success) {
    delayTaskRepository.markSent(task.getId(), LocalDateTime.now());
} <span class="hljs-keyword">else</span> {
    handleCallFailure(task, errorMsg);
}
</code></pre>
<h3 data-id="heading-28">重试策略：指数退避</h3>
<p>延时任务的重试用指数退避：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCallFailure</span><span class="hljs-params">(JobDelayTask task, String errorMsg)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">newRetryCount</span> <span class="hljs-operator">=</span> task.getRetryCount() + <span class="hljs-number">1</span>;
    
    <span class="hljs-keyword">if</span> (newRetryCount &gt;= task.getMaxRetry()) {
        <span class="hljs-comment">// 标记最终失败</span>
        delayTaskRepository.markFailedFinal(task.getId(), newRetryCount, errorMsg);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 计算下次重试时间</span>
    LocalDateTime nextAttempt;
    <span class="hljs-keyword">if</span> (newRetryCount == <span class="hljs-number">1</span>) {
        nextAttempt = now.plusMinutes(<span class="hljs-number">3</span>);   <span class="hljs-comment">// 第1次：3分钟后</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newRetryCount == <span class="hljs-number">2</span>) {
        nextAttempt = now.plusMinutes(<span class="hljs-number">5</span>);   <span class="hljs-comment">// 第2次：5分钟后</span>
    } <span class="hljs-keyword">else</span> {
        nextAttempt = now.plusMinutes(<span class="hljs-number">5</span>);   <span class="hljs-comment">// 第3次：5分钟后</span>
    }
    
    delayTaskRepository.markFailedAndScheduleNext(
        task.getId(), newRetryCount, nextAttempt, errorMsg);
}
</code></pre>
<p>重试时间轴：</p>
<pre><code class="hljs language-ini" lang="ini">初始执行：<span class="hljs-attr">execute_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
第1次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">3</span>分钟）
第2次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">5</span>分钟）
第3次失败：<span class="hljs-attr">next_attempt_time</span> = <span class="hljs-number">10</span>:<span class="hljs-number">13</span>:<span class="hljs-number">00</span>（+<span class="hljs-number">5</span>分钟）
第4次失败：标记 FAILED_FINAL
</code></pre>
<h3 data-id="heading-29">SENDING 超时检测</h3>
<p>延时任务还有个特殊场景：调用执行器后，一直没响应。</p>
<p>这时候数据库里的状态是 SENDING，需要有个超时检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 扫描 SENDING 超时任务</span>
List&lt;JobDelayTask&gt; stuckTasks = delayTaskRepository.findStuckSendingTasks(
    sendingTimeoutSeconds, scanBatchSize);

<span class="hljs-keyword">for</span> (JobDelayTask task : stuckTasks) {
    handleSendingTimeout(task);
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleSendingTimeout</span><span class="hljs-params">(JobDelayTask task)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">timeoutMsg</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SENDING timeout (over "</span> + sendingTimeoutSeconds + <span class="hljs-string">" seconds)"</span>;
    log.warn(<span class="hljs-string">"检测到SENDING超时，视为失败，traceId={}"</span>, task.getTraceId());
    handleCallFailure(task, timeoutMsg);
}
</code></pre>
<p>查询 SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> job_delay_task 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'SENDING'</span> 
  <span class="hljs-keyword">AND</span> sent_at <span class="hljs-operator">&lt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> ? <span class="hljs-keyword">SECOND</span>
LIMIT ?
</code></pre>
<p><strong>为什么要这样设计？</strong></p>
<pre><code class="hljs language-diff" lang="diff">场景：调用执行器后，执行器挂了

结果：
<span class="hljs-deletion">- 回调不会来</span>
<span class="hljs-deletion">- 状态一直是 SENDING</span>
<span class="hljs-deletion">- 需要超时检测来兜底</span>

处理：
<span class="hljs-deletion">- 视为一次失败</span>
<span class="hljs-deletion">- 进入重试流程</span>
<span class="hljs-deletion">- 最多重试3次</span>
</code></pre>
<h2 data-id="heading-30">八、巡检任务的协调：谁来做？</h2>
<p>前面讲了三种巡检：</p>
<ul>
<li>超时巡检（分片超时）</li>
<li>分片补偿（分片失败）</li>
<li>漏调检测（低频任务）</li>
</ul>
<p>这些巡检都需要有人做，但不能所有实例都做（会重复）。</p>
<h3 data-id="heading-31">选主策略：最小节点</h3>
<p>JobFlow 的选主很简单：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[从Nacos获取&lt;br/&gt;所有调度器实例] --&gt; B[按IP:PORT排序]
    B --&gt; C{我是最小的?}
    C --&gt;|是| D[我是Leader&lt;br/&gt;负责巡检]
    C --&gt;|否| E[我是Follower&lt;br/&gt;跳过巡检]
    
    style A fill:#87CEEB
    style B fill:#87CEEB
    style C fill:#FFE4B5
    style D fill:#90EE90
    style E fill:#D3D3D3
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldRunInspection</span><span class="hljs-params">()</span> {
    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="hljs-string">"jobflow-scheduler"</span>);
    <span class="hljs-keyword">if</span> (instances == <span class="hljs-literal">null</span> || instances.isEmpty()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 排序</span>
    instances.sort(Comparator.comparing(i -&gt; i.getHost() + <span class="hljs-string">":"</span> + i.getPort()));
    
    <span class="hljs-comment">// 判断我是不是最小的</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">smallest</span> <span class="hljs-operator">=</span> instances.get(<span class="hljs-number">0</span>).getHost() + <span class="hljs-string">":"</span> + instances.get(<span class="hljs-number">0</span>).getPort();
    <span class="hljs-type">String</span> <span class="hljs-variable">myself</span> <span class="hljs-operator">=</span> localHost + <span class="hljs-string">":"</span> + localPort;
    
    <span class="hljs-keyword">return</span> smallest.equals(myself);
}
</code></pre>
<p><strong>为什么选最小节点？</strong></p>
<p>优点：</p>
<ul>
<li>简单：不需要复杂的选举算法</li>
<li>确定：所有实例看到的排序结果一致</li>
<li>快速：最小节点挂了，下一个立刻接管</li>
</ul>
<p>缺点：</p>
<ul>
<li>负载不均：所有巡检都在一个节点上</li>
</ul>
<p>但对于巡检任务来说，负载很小，这个缺点可以接受。</p>
<h3 data-id="heading-32">巡检频率</h3>
<p>不同巡检的频率不同：</p>
<pre><code class="hljs language-diff" lang="diff">超时巡检：3分钟一次
<span class="hljs-deletion">- 需要及时发现卡住的任务</span>
<span class="hljs-deletion">- 但也不能太频繁，避免打爆执行器</span>

分片补偿：随超时巡检触发
<span class="hljs-deletion">- 和超时巡检是一起的</span>

漏调检测：10分钟一次
<span class="hljs-deletion">- 低频任务本来就慢，不需要太频繁</span>
<span class="hljs-deletion">- 降低数据库压力</span>
</code></pre>
<h2 data-id="heading-33">九、设计权衡与取舍</h2>
<p>回顾一下 JobFlow 在超时、补偿、漏调这三个问题上的设计权衡：</p>
<h3 data-id="heading-34">权衡一：询问 vs 直接判死刑</h3>
<p><strong>方案A：直接判死刑</strong></p>
<ul>
<li>优点：简单快速</li>
<li>缺点：误杀正常任务</li>
</ul>
<p><strong>方案B：先询问执行器</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：准确性高，避免误判</li>
<li>缺点：增加一次 HTTP 调用</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">对于批处理任务：
<span class="hljs-deletion">- 数据量大，确实很慢</span>
<span class="hljs-deletion">- 误判成本高（任务白跑了）</span>
<span class="hljs-deletion">- 多一次 HTTP 询问，成本可接受</span>
</code></pre>
<h3 data-id="heading-35">权衡二：立即重试 vs 指数退避</h3>
<p><strong>周期任务：立即重试</strong></p>
<ul>
<li>原因：执行窗口有限</li>
<li>目标：尽快完成</li>
</ul>
<p><strong>延时任务：指数退避</strong></p>
<ul>
<li>原因：时间灵活</li>
<li>目标：避免雪崩</li>
</ul>
<p>这是根据场景特点做的差异化设计。</p>
<h3 data-id="heading-36">权衡三：全量检测 vs 分层检测</h3>
<p><strong>方案A：所有任务都检测漏调</strong></p>
<ul>
<li>优点：覆盖全面</li>
<li>缺点：数据库压力大</li>
</ul>
<p><strong>方案B：只检测低频任务</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：性价比高</li>
<li>缺点：高频任务漏调不管</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">高频任务漏调影响小：
<span class="hljs-deletion">- 1分钟后就有下一轮</span>
<span class="hljs-deletion">- 容易被监控发现</span>
<span class="hljs-deletion">- 不需要主动检测</span>

低频任务漏调影响大：
<span class="hljs-deletion">- 可能要等很久</span>
<span class="hljs-deletion">- 不容易被发现</span>
<span class="hljs-deletion">- 需要主动检测</span>
</code></pre>
<h3 data-id="heading-37">权衡四：所有实例巡检 vs 单实例巡检</h3>
<p><strong>方案A：所有实例都巡检</strong></p>
<ul>
<li>优点：分布式，负载均衡</li>
<li>缺点：容易重复，需要分布式锁</li>
</ul>
<p><strong>方案B：最小节点巡检</strong>（JobFlow 的选择）</p>
<ul>
<li>优点：简单，无需锁</li>
<li>缺点：单点，负载集中</li>
</ul>
<p>JobFlow 选择了方案B，因为：</p>
<pre><code class="hljs language-diff" lang="diff">巡检负载很小：
<span class="hljs-deletion">- 3分钟一次，10分钟一次</span>
<span class="hljs-deletion">- 每次扫描几百个任务</span>
<span class="hljs-deletion">- 单实例完全扛得住</span>

简单优先：
<span class="hljs-deletion">- 不需要分布式锁</span>
<span class="hljs-deletion">- 不需要复杂的协调</span>
<span class="hljs-deletion">- 最小节点挂了，自动切换</span>
</code></pre>
<h2 data-id="heading-38">十、总结</h2>
<p>JobFlow 处理超时、补偿、漏调的核心思路：</p>
<p><strong>正常路径优先</strong>：</p>
<ul>
<li>99% 的任务走正常路径</li>
<li>无锁调度，性能好</li>
<li>回调驱动，响应快</li>
</ul>
<p><strong>异常路径兜底</strong>：</p>
<ul>
<li>超时巡检：询问执行器确认真实状态</li>
<li>分片补偿：CAS 保护，限次重试</li>
<li>漏调检测：时间窗口，主动补偿</li>
</ul>
<p><strong>设计原则</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 简单优于复杂
<span class="hljs-bullet">   -</span> 最小节点选主，而不是 Raft 选举
<span class="hljs-bullet">   -</span> CAS 保护，而不是分布式锁

<span class="hljs-bullet">2.</span> 分层优于全量
<span class="hljs-bullet">   -</span> 只检测低频任务漏调
<span class="hljs-bullet">   -</span> 超时判定分两层

<span class="hljs-bullet">3.</span> 询问优于猜测
<span class="hljs-bullet">   -</span> 先问执行器，再判超时
<span class="hljs-bullet">   -</span> 准确性优于性能

<span class="hljs-bullet">4.</span> 兜底优于完美
<span class="hljs-bullet">   -</span> 接受1%的漏调，用巡检兜底
<span class="hljs-bullet">   -</span> 接受短暂的状态不一致
</code></pre>
<p><strong>核心价值</strong>：</p>
<p>JobFlow 没有追求完美的一致性，而是用异步补偿换取了：</p>
<ul>
<li>更好的性能（无锁调度）</li>
<li>更低的复杂度（无需分布式锁）</li>
<li>更好的可维护性（逻辑清晰）</li>
</ul>
<p>这就是 JobFlow 在分布式调度这个领域的核心竞争力：<strong>在性能和可靠性之间找到最优平衡点。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官: “ 请你说一下什么是 ajax ? ”]]></title>    <link>https://juejin.cn/post/7588004376867340323</link>    <guid>https://juejin.cn/post/7588004376867340323</guid>    <pubDate>2025-12-27T05:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004376867340323" data-draft-id="7588034035286884367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官:  “ 请你说一下什么是 ajax ? ”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T05:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官:  “ 请你说一下什么是 ajax ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:33:37.000Z" title="Sat Dec 27 2025 05:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、AJAX 核心定义</h3>
<p>AJAX 是 <strong>Asynchronous JavaScript and XML</strong> 的缩写，翻译为 “异步的 JavaScript 和 XML”。</p>
<ul>
<li>本质：它不是一种新的编程语言，而是一套<strong>使用现有技术组合实现的编程方案</strong>。</li>
<li>核心作用：让 JavaScript 在<strong>不刷新整个网页</strong>的情况下，异步地与服务器交换数据，实现网页局部更新。</li>
<li>关键特点：<strong>异步</strong>（请求发送后，页面不用等待服务器响应，仍可正常交互）、<strong>局部更新</strong>（只更新需要变化的部分，提升用户体验）。</li>
</ul>
<p>补充：虽然名字里有 XML，但现在实际开发中几乎都用<strong>JSON</strong>（更轻量、易解析）来传输数据，AJAX 只是沿用了历史名称。</p>
<h3 data-id="heading-1">二、AJAX 工作原理</h3>
<p>AJAX 的核心是浏览器提供的 <code>XMLHttpRequest</code> 对象（简称 XHR），现代浏览器也提供了更易用的 <code>fetch</code> API。其基本工作流程如下：</p>
<ol>
<li>创建 AJAX 请求对象（XHR/fetch）；</li>
<li>配置请求参数（请求方式、URL、是否异步等）；</li>
<li>发送请求到服务器；</li>
<li>监听服务器响应状态；</li>
<li>接收服务器返回的数据；</li>
<li>用 JavaScript 更新网页局部内容。</li>
</ol>
<h3 data-id="heading-2">三、AJAX 代码示例</h3>
<h4 data-id="heading-3">1. 传统 XHR 方式（兼容所有浏览器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建XHR对象</span>
<span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

<span class="hljs-comment">// 2. 配置请求：请求方式(GET)、URL、是否异步(true)</span>
xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 3. 监听请求状态变化（核心）</span>
xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// readyState=4 表示请求完成；status=200 表示响应成功</span>
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-comment">// 4. 解析服务器返回的JSON数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
        <span class="hljs-comment">// 5. 局部更新页面（比如把数据显示到id为result的元素里）</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;h3&gt;任务标题：<span class="hljs-subst">${data.title}</span>&lt;/h3&gt;
            &lt;p&gt;是否完成：<span class="hljs-subst">${data.completed ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>&lt;/p&gt;
        `</span>;
    }
};

<span class="hljs-comment">// 处理请求失败的情况</span>
xhr.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'请求失败！'</span>;
};

<span class="hljs-comment">// 4. 发送请求</span>
xhr.<span class="hljs-title function_">send</span>();
</code></pre>
<h4 data-id="heading-4">2. 现代 fetch 方式（ES6+，更简洁）</h4>
<p><code>fetch</code> 是 AJAX 的现代替代方案，基于 Promise，语法更优雅：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 发送GET请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://jsonplaceholder.typicode.com/todos/1'</span>)
    <span class="hljs-comment">// 2. 处理响应：先判断是否成功，再解析为JSON</span>
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求失败，状态码：'</span> + response.<span class="hljs-property">status</span>);
        }
        <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
    })
    <span class="hljs-comment">// 3. 使用数据更新页面</span>
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;h3&gt;任务标题：<span class="hljs-subst">${data.title}</span>&lt;/h3&gt;
            &lt;p&gt;是否完成：<span class="hljs-subst">${data.completed ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>&lt;/p&gt;
        `</span>;
    })
    <span class="hljs-comment">// 4. 捕获异常</span>
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">innerHTML</span> = error.<span class="hljs-property">message</span>;
    });
</code></pre>
<h3 data-id="heading-5">四、AJAX 的典型应用场景</h3>
<ul>
<li>表单提交（比如登录验证，不用刷新页面就能提示 “用户名密码错误”）；</li>
<li>数据分页加载（比如滚动到底部自动加载下一页内容）；</li>
<li>搜索框联想（输入关键词实时显示匹配结果）；</li>
<li>局部数据刷新（比如网页的点赞、评论功能，点击后直接更新数字）。</li>
</ul>
<h3 data-id="heading-6">五、关键注意点</h3>
<ol>
<li><strong>同源策略</strong>：浏览器默认限制 AJAX 请求只能访问<strong>同域名、同端口、同协议</strong>的服务器（比如<code>http://localhost:8080</code>不能请求<code>http://baidu.com</code>），跨域需要服务器配置 CORS 或使用代理。</li>
<li><strong>异步特性</strong>：AJAX 请求是异步的，不能在请求发送后立即获取结果，必须在回调函数（<code>onreadystatechange</code>）或 Promise 的<code>then</code>里处理返回数据。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<ol>
<li>AJAX 是一套实现 “网页异步请求数据、局部更新” 的技术方案，核心是<code>XMLHttpRequest</code>对象（或现代的<code>fetch</code>）。</li>
<li>核心优势：无需刷新整个页面，提升用户体验，实现网页与服务器的异步数据交互。</li>
<li>现代开发中，<code>fetch</code>（结合 Promise/async-await）已逐步替代传统 XHR，是 AJAX 的主流实现方式。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue.js 源码揭秘（一）：Vue3 架构总览]]></title>    <link>https://juejin.cn/post/7588064253636018230</link>    <guid>https://juejin.cn/post/7588064253636018230</guid>    <pubDate>2025-12-27T05:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253636018230" data-draft-id="7588149079401250859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue.js 源码揭秘（一）：Vue3 架构总览"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T05:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue.js 源码揭秘（一）：Vue3 架构总览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:51:56.000Z" title="Sat Dec 27 2025 05:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue.js 源码揭秘（一）：Vue3 架构总览</h2>
<blockquote>
<p>本文从全局视角解析 Vue3 的核心架构，建立源码阅读的整体认知。</p>
</blockquote>
<h3 data-id="heading-1">一、整体架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      Vue Application                        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Compiler (编译时)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Parse     │─►│  <span class="hljs-attribute">Transform</span>  │─►│   Codegen   │         │
│  │  (解析)     │  │   (转换)    │  │  (代码生成)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼ render function
┌─────────────────────────────────────────────────────────────┐
│                    Runtime (运行时)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Reactivity  │  │   Renderer  │  │  Scheduler  │         │
│  │  (响应式)   │  │   (渲染器)   │  │   (调度器)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      DOM / Platform                         │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">二、编译时 vs 运行时</h3>
<h4 data-id="heading-3">2.1 编译时（Compile Time）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 模板</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ msg }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// 编译后的 render 函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">msg</span>))
}
</code></pre>
<h4 data-id="heading-4">2.2 运行时（Runtime）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 运行时执行 render 函数</span>
<span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">render</span>(ctx)

<span class="hljs-comment">// patch 到 DOM</span>
<span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, vnode, container)
</code></pre>
<h3 data-id="heading-5">三、响应式系统</h3>
<h4 data-id="heading-6">3.1 核心 API</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// reactive - 对象响应式</span>
<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })

<span class="hljs-comment">// ref - 基本类型响应式</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// computed - 计算属性</span>
<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)

<span class="hljs-comment">// effect - 副作用</span>
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">value</span>)
})
</code></pre>
<h4 data-id="heading-7">3.2 依赖收集与触发</h4>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────┐
│                    响应式流程                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐    <span class="hljs-keyword">get</span>     ┌─────────┐                       │
│   │  Proxy  │ ─────────► │  track  │ ──► 收集当前 effect    │
│   └─────────┘            └─────────┘                       │
│        │                                                    │
│        │ <span class="hljs-keyword">set</span>                                                │
│        ▼                                                    │
│   ┌─────────┐            ┌─────────┐                       │
│   │ <span class="hljs-keyword">trigger</span> │ ─────────► │ effects │ ──► 执行所有 effect    │
│   └─────────┘            └─────────┘                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-8">3.3 Dep 与 Effect</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Dep - 依赖容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-attr">subs</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Subscriber</span>&gt;  <span class="hljs-comment">// 订阅者集合</span>
  
  <span class="hljs-title function_">track</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (activeSub) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">add</span>(activeSub)
    }
  }
  
  <span class="hljs-title function_">trigger</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sub</span> =&gt;</span> sub.<span class="hljs-title function_">notify</span>())
  }
}

<span class="hljs-comment">// ReactiveEffect - 副作用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveEffect</span> {
  <span class="hljs-attr">deps</span>: <span class="hljs-title class_">Link</span>[]  <span class="hljs-comment">// 依赖链表</span>
  
  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    activeSub = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fn</span>()
  }
  
  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduler</span>() : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
  }
}
</code></pre>
<h3 data-id="heading-9">四、虚拟 DOM</h3>
<h4 data-id="heading-10">4.1 VNode 结构</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Component</span>    <span class="hljs-comment">// 节点类型</span>
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">object</span> | <span class="hljs-literal">null</span>        <span class="hljs-comment">// 属性</span>
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">VNode</span>[] | <span class="hljs-built_in">string</span>  <span class="hljs-comment">// 子节点</span>
  <span class="hljs-attr">el</span>: <span class="hljs-title class_">Element</span> | <span class="hljs-literal">null</span>          <span class="hljs-comment">// 真实 DOM</span>
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>        <span class="hljs-comment">// diff key</span>
  <span class="hljs-attr">shapeFlag</span>: <span class="hljs-built_in">number</span>           <span class="hljs-comment">// 节点类型标记</span>
  <span class="hljs-attr">patchFlag</span>: <span class="hljs-built_in">number</span>           <span class="hljs-comment">// 优化标记</span>
}
</code></pre>
<h4 data-id="heading-11">4.2 ShapeFlags</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">ShapeFlags</span> {
  <span class="hljs-variable constant_">ELEMENT</span> = <span class="hljs-number">1</span>,                    <span class="hljs-comment">// 普通元素</span>
  <span class="hljs-variable constant_">FUNCTIONAL_COMPONENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,  <span class="hljs-comment">// 函数组件</span>
  <span class="hljs-variable constant_">STATEFUL_COMPONENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,    <span class="hljs-comment">// 有状态组件</span>
  <span class="hljs-variable constant_">TEXT_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,         <span class="hljs-comment">// 文本子节点</span>
  <span class="hljs-variable constant_">ARRAY_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,        <span class="hljs-comment">// 数组子节点</span>
  <span class="hljs-variable constant_">SLOTS_CHILDREN</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,        <span class="hljs-comment">// 插槽子节点</span>
  <span class="hljs-variable constant_">TELEPORT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,              <span class="hljs-comment">// Teleport</span>
  <span class="hljs-variable constant_">SUSPENSE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,              <span class="hljs-comment">// Suspense</span>
  <span class="hljs-variable constant_">COMPONENT</span> = <span class="hljs-variable constant_">STATEFUL_COMPONENT</span> | <span class="hljs-variable constant_">FUNCTIONAL_COMPONENT</span>
}
</code></pre>
<h3 data-id="heading-12">五、渲染器</h3>
<h4 data-id="heading-13">5.1 patch 函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">patch</span> = (<span class="hljs-params">n1, n2, container</span>) =&gt; {
  <span class="hljs-keyword">if</span> (n1 === n2) <span class="hljs-keyword">return</span>
  
  <span class="hljs-comment">// 类型不同，卸载旧节点</span>
  <span class="hljs-keyword">if</span> (n1 &amp;&amp; !<span class="hljs-title function_">isSameVNodeType</span>(n1, n2)) {
    <span class="hljs-title function_">unmount</span>(n1)
    n1 = <span class="hljs-literal">null</span>
  }
  
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, shapeFlag } = n2
  
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Text</span>:
      <span class="hljs-title function_">processText</span>(n1, n2, container)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Fragment</span>:
      <span class="hljs-title function_">processFragment</span>(n1, n2, container)
      <span class="hljs-keyword">break</span>
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">ELEMENT</span>) {
        <span class="hljs-title function_">processElement</span>(n1, n2, container)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shapeFlag &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">COMPONENT</span>) {
        <span class="hljs-title function_">processComponent</span>(n1, n2, container)
      }
  }
}
</code></pre>
<h4 data-id="heading-14">5.2 组件挂载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">mountComponent</span> = (<span class="hljs-params">vnode, container</span>) =&gt; {
  <span class="hljs-comment">// 1. 创建组件实例</span>
  <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">createComponentInstance</span>(vnode)
  
  <span class="hljs-comment">// 2. 设置组件（执行 setup）</span>
  <span class="hljs-title function_">setupComponent</span>(instance)
  
  <span class="hljs-comment">// 3. 设置渲染副作用</span>
  <span class="hljs-title function_">setupRenderEffect</span>(instance, vnode, container)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupRenderEffect</span> = (<span class="hljs-params">instance, vnode, container</span>) =&gt; {
  <span class="hljs-keyword">const</span> effect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactiveEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!instance.<span class="hljs-property">isMounted</span>) {
      <span class="hljs-comment">// 首次挂载</span>
      <span class="hljs-keyword">const</span> subTree = instance.<span class="hljs-title function_">render</span>()
      <span class="hljs-title function_">patch</span>(<span class="hljs-literal">null</span>, subTree, container)
      instance.<span class="hljs-property">subTree</span> = subTree
      instance.<span class="hljs-property">isMounted</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 更新</span>
      <span class="hljs-keyword">const</span> nextTree = instance.<span class="hljs-title function_">render</span>()
      <span class="hljs-title function_">patch</span>(instance.<span class="hljs-property">subTree</span>, nextTree, container)
      instance.<span class="hljs-property">subTree</span> = nextTree
    }
  })
  
  effect.<span class="hljs-title function_">run</span>()
}
</code></pre>
<h3 data-id="heading-15">六、调度器</h3>
<h4 data-id="heading-16">6.1 任务队列</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">SchedulerJob</span>[] = []
<span class="hljs-keyword">let</span> isFlushing = <span class="hljs-literal">false</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueJob</span>(<span class="hljs-params">job</span>) {
  <span class="hljs-keyword">if</span> (!queue.<span class="hljs-title function_">includes</span>(job)) {
    queue.<span class="hljs-title function_">push</span>(job)
    <span class="hljs-title function_">queueFlush</span>()
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueFlush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!isFlushing) {
    isFlushing = <span class="hljs-literal">true</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(flushJobs)
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushJobs</span>(<span class="hljs-params"/>) {
  queue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title function_">getId</span>(a) - <span class="hljs-title function_">getId</span>(b))
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> job <span class="hljs-keyword">of</span> queue) {
    <span class="hljs-title function_">job</span>()
  }
  
  queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  isFlushing = <span class="hljs-literal">false</span>
}
</code></pre>
<h4 data-id="heading-17">6.2 nextTick</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> resolvedPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()

<span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">fn?</span>) {
  <span class="hljs-keyword">return</span> fn 
    ? resolvedPromise.<span class="hljs-title function_">then</span>(fn) 
    : resolvedPromise
}
</code></pre>
<h3 data-id="heading-18">七、组件系统</h3>
<h4 data-id="heading-19">7.1 组件实例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentInternalInstance</span> {
  <span class="hljs-attr">uid</span>: <span class="hljs-built_in">number</span>                    <span class="hljs-comment">// 唯一 ID</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">Component</span>                <span class="hljs-comment">// 组件定义</span>
  <span class="hljs-attr">parent</span>: <span class="hljs-title class_">ComponentInternalInstance</span> | <span class="hljs-literal">null</span>
  
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">object</span>                   <span class="hljs-comment">// data()</span>
  <span class="hljs-attr">props</span>: <span class="hljs-built_in">object</span>                  <span class="hljs-comment">// props</span>
  <span class="hljs-attr">setupState</span>: <span class="hljs-built_in">object</span>             <span class="hljs-comment">// setup() 返回值</span>
  <span class="hljs-attr">ctx</span>: <span class="hljs-built_in">object</span>                    <span class="hljs-comment">// 渲染上下文</span>
  
  <span class="hljs-comment">// 渲染</span>
  <span class="hljs-attr">render</span>: <span class="hljs-title class_">Function</span>               <span class="hljs-comment">// render 函数</span>
  <span class="hljs-attr">subTree</span>: <span class="hljs-title class_">VNode</span>                 <span class="hljs-comment">// 渲染的 VNode 树</span>
  <span class="hljs-attr">effect</span>: <span class="hljs-title class_">ReactiveEffect</span>         <span class="hljs-comment">// 渲染副作用</span>
  
  <span class="hljs-comment">// 生命周期</span>
  <span class="hljs-attr">isMounted</span>: <span class="hljs-built_in">boolean</span>
  <span class="hljs-attr">isUnmounted</span>: <span class="hljs-built_in">boolean</span>
  
  <span class="hljs-comment">// 生命周期钩子</span>
  <span class="hljs-attr">bc</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeCreate</span>
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// created</span>
  <span class="hljs-attr">bm</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeMount</span>
  <span class="hljs-attr">m</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// mounted</span>
  <span class="hljs-attr">bu</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// beforeUpdate</span>
  <span class="hljs-attr">u</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>           <span class="hljs-comment">// updated</span>
  <span class="hljs-attr">bum</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>         <span class="hljs-comment">// beforeUnmount</span>
  <span class="hljs-attr">um</span>: <span class="hljs-title class_">Function</span>[] | <span class="hljs-literal">null</span>          <span class="hljs-comment">// unmounted</span>
}
</code></pre>
<h4 data-id="heading-20">7.2 setup 执行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setupComponent</span>(<span class="hljs-params">instance</span>) {
  <span class="hljs-keyword">const</span> { props, children } = instance.<span class="hljs-property">vnode</span>
  
  <span class="hljs-comment">// 初始化 props</span>
  <span class="hljs-title function_">initProps</span>(instance, props)
  
  <span class="hljs-comment">// 初始化 slots</span>
  <span class="hljs-title function_">initSlots</span>(instance, children)
  
  <span class="hljs-comment">// 执行 setup</span>
  <span class="hljs-keyword">const</span> { setup } = instance.<span class="hljs-property">type</span>
  <span class="hljs-keyword">if</span> (setup) {
    <span class="hljs-keyword">const</span> setupResult = <span class="hljs-title function_">setup</span>(instance.<span class="hljs-property">props</span>, {
      <span class="hljs-attr">attrs</span>: instance.<span class="hljs-property">attrs</span>,
      <span class="hljs-attr">slots</span>: instance.<span class="hljs-property">slots</span>,
      <span class="hljs-attr">emit</span>: instance.<span class="hljs-property">emit</span>,
      <span class="hljs-attr">expose</span>: instance.<span class="hljs-property">expose</span>
    })
    
    <span class="hljs-title function_">handleSetupResult</span>(instance, setupResult)
  }
}
</code></pre>
<h3 data-id="heading-21">八、编译优化</h3>
<h4 data-id="heading-22">8.1 PatchFlags</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PatchFlags</span> {
  <span class="hljs-variable constant_">TEXT</span> = <span class="hljs-number">1</span>,              <span class="hljs-comment">// 动态文本</span>
  <span class="hljs-variable constant_">CLASS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,        <span class="hljs-comment">// 动态 class</span>
  <span class="hljs-variable constant_">STYLE</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>,        <span class="hljs-comment">// 动态 style</span>
  <span class="hljs-variable constant_">PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>,        <span class="hljs-comment">// 动态 props</span>
  <span class="hljs-variable constant_">FULL_PROPS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">4</span>,   <span class="hljs-comment">// 有动态 key</span>
  <span class="hljs-variable constant_">NEED_HYDRATION</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,
  <span class="hljs-variable constant_">STABLE_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,
  <span class="hljs-variable constant_">KEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,
  <span class="hljs-variable constant_">UNKEYED_FRAGMENT</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>,
  <span class="hljs-variable constant_">NEED_PATCH</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>,
  <span class="hljs-variable constant_">DYNAMIC_SLOTS</span> = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>,
  <span class="hljs-variable constant_">HOISTED</span> = -<span class="hljs-number">1</span>,          <span class="hljs-comment">// 静态提升</span>
  <span class="hljs-variable constant_">BAIL</span> = -<span class="hljs-number">2</span>              <span class="hljs-comment">// 退出优化</span>
}
</code></pre>
<h4 data-id="heading-23">8.2 Block Tree</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 编译优化：只追踪动态节点</span>
<span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"static"</span>)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">openBlock</span>(), <span class="hljs-title function_">createBlock</span>(<span class="hljs-string">"div"</span>, <span class="hljs-literal">null</span>, [
    _hoisted_1,  <span class="hljs-comment">// 静态提升</span>
    <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">"span"</span>, <span class="hljs-literal">null</span>, ctx.<span class="hljs-property">msg</span>, <span class="hljs-title class_">PatchFlags</span>.<span class="hljs-property">TEXT</span>)  <span class="hljs-comment">// 动态节点</span>
  ]))
}
</code></pre>
<h3 data-id="heading-24">九、完整渲染流程</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    Vue 渲染流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  <span class="hljs-number">1</span>. <span class="hljs-built_in">createApp</span>(App)<span class="hljs-selector-class">.mount</span>('#app')                            │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">2</span>. 创建 VNode                                              │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">3</span>. <span class="hljs-built_in">render</span>(vnode, container)                                │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">4</span>. <span class="hljs-built_in">patch</span>(null, vnode, container)                           │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">5</span>. processComponent → mountComponent                       │
│        │                                                    │
│        ├── createComponentInstance                          │
│        ├── setupComponent (执行 setup)                      │
│        └── setupRenderEffect                                │
│              │                                              │
│              ▼                                              │
│  <span class="hljs-number">6</span>. ReactiveEffect<span class="hljs-selector-class">.run</span>()                                    │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">7</span>. instance<span class="hljs-selector-class">.render</span>() → subTree VNode                       │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">8</span>. <span class="hljs-built_in">patch</span>(null, subTree, container)                         │
│        │                                                    │
│        ▼                                                    │
│  <span class="hljs-number">9</span>. 递归处理子节点 → 挂载到 DOM                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-25">十、小结</h3>
<p>Vue3 架构的核心：</p>
<ol>
<li><strong>响应式系统</strong>：基于 Proxy，依赖收集 + 触发更新</li>
<li><strong>虚拟 DOM</strong>：VNode 描述 UI，patch 算法高效更新</li>
<li><strong>编译优化</strong>：PatchFlags、Block Tree、静态提升</li>
<li><strong>调度器</strong>：批量更新，nextTick 微任务队列</li>
<li><strong>组件系统</strong>：setup + Composition API</li>
</ol>
<hr/>
<blockquote>
<p>📦 源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore" target="_blank" title="https://github.com/vuejs/core" ref="nofollow noopener noreferrer">github.com/vuejs/core</a></p>
<p>下一篇：响应式系统详解</p>
<p>如果觉得有帮助，欢迎点赞收藏 👍</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[webpack的生命周期与Loader/Plugin]]></title>    <link>https://juejin.cn/post/7588061231590244393</link>    <guid>https://juejin.cn/post/7588061231590244393</guid>    <pubDate>2025-12-27T06:35:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588061231590244393" data-draft-id="7588010346070966282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="webpack的生命周期与Loader/Plugin"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T06:35:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MQliferecord"/> <meta itemprop="url" content="https://juejin.cn/user/1139543665814600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            webpack的生命周期与Loader/Plugin
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1139543665814600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MQliferecord
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T06:35:20.000Z" title="Sat Dec 27 2025 06:35:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>核心对象：</strong></p>
<ul>
<li>compiler: 代表Webpack构建的全局上下文，钩子是全局生命周期钩子</li>
<li>compilation: 代表一次构建的编译过程，钩子是编译阶段钩子</li>
</ul>
<p><strong>生命周期：</strong></p>
<p>整个过程分为【初始化-&gt;编译-&gt;输出-&gt;结束】，一共四个阶段，以下列举一下各个阶段的核心钩子：</p>
<ol>
<li>初始化：</li>
</ol>
<ul>
<li>entryOption 动态新增入口</li>
</ul>
<ol start="2">
<li>编译：</li>
</ol>
<ul>
<li>compile：等同于vite的config阶段，能够获得最终生成的config文件，如果需要添加一些环境值的占位符，可以在这个阶段介入</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compiler</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'插件名'</span>,<span class="hljs-function">()=&gt;</span>{
    compiler.<span class="hljs-property">options</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
          <span class="hljs-string">'process.env.APP_VERSION'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">PLACEHOLDER</span>),
        })
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 已注入APP_VERSION占位符：'</span>, <span class="hljs-variable constant_">PLACEHOLDER</span>);
})
</code></pre>
<ul>
<li>compilation: 内部包含整个打包构建流程，像是buildModule和optimize等等，实际打包实例已经创建完成，一般这个阶段可以拿到文件最终的contenthash值</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'ContentHashReplacePlugin'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHash</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateContentHash</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'✅ 生成真实contentHash：'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">contentHash</span>);
});
</code></pre>
<ol start="3">
<li>输出：</li>
</ol>
<ul>
<li>emit： 异步钩子！必须和callback和tapAsync结合使用！准备将数据写入磁盘，这个阶段可以把环境值的占位符替换成真正的数据</li>
</ul>
<pre><code class="hljs language-js" lang="js">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">'MyPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> {
  <span class="hljs-comment">// 遍历所有输出的资源</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [filename, source] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(compilation.<span class="hljs-property">assets</span>)) {
    <span class="hljs-keyword">if</span> (filename.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.js'</span>)) {
      <span class="hljs-comment">// 读取原内容，添加版权注释</span>
      <span class="hljs-keyword">const</span> content = source.<span class="hljs-title function_">source</span>();
      <span class="hljs-keyword">const</span> newContent = <span class="hljs-string">`/* 版权所有 © 2025 MyProject */\n<span class="hljs-subst">${content}</span>`</span>;
      <span class="hljs-comment">// 替换资源内容</span>
      compilation.<span class="hljs-property">assets</span>[filename] = {
        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> newContent,
        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> newContent.<span class="hljs-property">length</span>
      };
    }
  }
  <span class="hljs-title function_">callback</span>(); <span class="hljs-comment">// 异步钩子必须调用 callback 结束</span>
});
</code></pre>
<ol start="4">
<li>结束：</li>
</ol>
<ul>
<li>done: 构建完成之后输出一些日志信息，生成报告</li>
</ul>
<p><strong>tap和tapAsync的区别:</strong></p>
<p>同步钩子和异步钩子调用时候的函数。</p>
<p>tapAsync必须和callback结合使用，用于通知webpack异步流程已经结束，可以继续接下来的流程，不然会卡住。</p>
<p><strong>Plugin:</strong> 用于webpack打包生命周期中执行的一些函数，比如css和图片压缩的plugin，无视打包模块的IgnorePlugin</p>
<p><strong>Loader:</strong> 用于代码转换，因为浏览器只能解析html，css和js，所以会有各种loader将浏览器没法解析的东西转换成能解析的语言，同时webpack本身无法识别一些文件，也需要Loader做转换，比如css-loader，sass-loader，ts-loader，style-loader，postcss-loader</p>
<p>(1.1) css-loader：因为webpack没办法识别css文件，webpack其实只能理解js和json，所以才会使用需要css-loader去处理css文件引用，将其转为模板字符串</p>
<p>(1.2) style-loader: 将css-loader生成的样式字符串注入到style标签中</p>
<p>(1.3) postcss-loader: 对css做兼容处理，自动增加前缀</p>
<p>执行顺序是postcss-loader-&gt;css-loader-&gt;style-loader，而配置的时候需要从右向左配置，顺序错误，会导致报错</p>
<p>Loader整体执行阶段类似于洋葱模型，从左到右依次遍历对应的loader，再从右到左执行对应的loader</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>,  <span class="hljs-string">'postcss-loader'</span>]
      }
    ]
  }
};
</code></pre>
<p><strong>vite自身没有loader</strong>，可以通过装插件来配置loader，但是没有原生好用，而且vite很多loader功能都原生内嵌了，而且因为工具特性，vite依赖es模块，而浏览器是完全支持es模块的，无需loader做模块转换，整体上都是依靠plugin进行处理</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hugging Face 200页的大模型训练实录]]></title>    <link>https://juejin.cn/post/7588028859541061658</link>    <guid>https://juejin.cn/post/7588028859541061658</guid>    <pubDate>2025-12-27T04:28:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541061658" data-draft-id="7588031908171644937" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hugging Face 200页的大模型训练实录"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-12-27T04:28:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hugging Face 200页的大模型训练实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:28:25.000Z" title="Sat Dec 27 2025 04:28:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，Hugging Face 发布了一篇罕见的超长技术博客——<strong>超过 200 页的《Smol  训练手册》</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dec66f76d14da5b75aa04343cc364c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=lWHwrjHNULEn2jVGDA9Ai2ug6ug%3D" alt="" loading="lazy"/><br/>
这篇博客并不是论文、也不是产品报告，而更像是一份实验日记。<br/>
它详细记录了团队在使用 <strong>384 块 H100 GPU</strong> 训练一款 <strong>30 亿参数模型 SmolLM3</strong> 的从立项思考到基础设施管理全过程。</p>
<p>在如今大模型几乎成产业标配的背景下，这篇文档显得有些反潮流，它没有炫耀成果，而是在展示<strong>过程的混乱与妥协</strong>。<br/>
作者似乎想告诉同行，训练一个可用的 LLM，不只是算法竞赛，更是一场<strong>漫长的工程磨合</strong>。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、你真的需要训练一个新模型吗？</h2>
<p>Hugging Face 在文档开篇提出了一个很现实的问题：“你是否真的需要从头训练一个模型？”</p>
<p>他们列出了几条常见但错误的理由——“有多余算力”、“大家都在做”、“我们也想有自己的模型”。<br/>
接着，给出了一张决策流程图，帮助团队判断：是微调、改 prompt、还是必须预训练。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d014c8a4de8462fab34d31e498ba4da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=rOOUZoEpHTW0GADVUf%2Fbsn0MTjs%3D" alt="" loading="lazy"/></p>
<p>根据他们的定义，真正值得从零训练的情境只剩三种：</p>
<ol>
<li><strong>研究问题</strong>：验证新的优化器或训练策略；</li>
<li><strong>业务约束</strong>：特定行业或硬件需求（如金融、航空、医疗设备）；</li>
<li><strong>战略性开源</strong>：弥补现有生态中的空白。</li>
</ol>
<p>这段内容听起来像是劝退，但其核心是<strong>现实主义</strong>。<br/>
面对 Llama、Gemma、Qwen 等日趋完善的开源模型，重新造轮子并不是勇气，而是一种成本高昂的选择。</p>
<p>如果为什么解决了动机问题，那么训练什么就决定了方向。</p>
<p>Hugging Face 团队提出了一个思维框架：</p>
<p>让技术决策反映业务约束，而不是兴趣。</p>
<p>例如：</p>
<ul>
<li>如果模型要在边缘设备上运行，架构必须优先考虑计算密度和延迟。</li>
<li>如果目标是多语言能力，那 tokenizer 的设计要优先于模型深度。</li>
<li>如果追求长上下文推理，位置编码与样本打包策略必须在最早阶段确定。</li>
</ul>
<p>这看似常识，却是很多失败项目的根源——<strong>团队常常在不知道目标的情况下开始堆算力</strong>。<br/>
SmolLM3 的设计过程，从一开始就被绑定在这些约束上。</p>
<h2 data-id="heading-1">二、每一个稳定的模型都诞生于消融</h2>
<p>Hugging Face 在文档中反复强调一个词：<strong>消融实验（ablation）</strong>。</p>
<p>他们认为，大模型训练的真正瓶颈不是算力，而是<strong>不确定性</strong>。<br/>
理论上合理的改动，往往在实践中崩溃。</p>
<p>SmolLM3 的主训练用了 11 万亿 tokens，但在此之前，他们在小规模模型上进行了数十组实验——测试优化器、注意力实现、权重衰减、位置编码等细节。</p>
<p>其中一个典型案例是位置编码：传统 RoPE 编码在长上下文中会失效，团队通过混合 RoPE 与 NoPE（称为 RNoPE）解决了这一问题。<br/>
这种方案并非来自文献，而是从反复试验中被逼出来的。</p>
<p>文档中的一句话很典型：“除非有实验证明有效，否则不要改动任何组件。”</p>
<p>这背后体现的是一种工程化心态，<strong>科学假设在 GPU 面前要先过验证关。</strong></p>
<h2 data-id="heading-2">三、架构选择的权衡</h2>
<p>SmolLM3 的架构看似平平——标准 Transformer，但每个决策都来自验证。</p>
<ul>
<li><strong>注意力机制</strong>：使用分组查询（GQA）替代多头注意力（MHA），在节省显存的同时保持性能。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de60f63976c04cbb8cc90398522c61b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=8z9iKqxf7cnNWY0ZiJVa6n2p7xk%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>嵌入层共享</strong>：为了节省参数，将输入和输出嵌入矩阵合并，用深度换取宽度。</li>
<li><strong>稳定性技巧</strong>：移除嵌入层的权重衰减（来自 OLMo2 的经验）避免梯度震荡。</li>
</ul>
<p>这套保守的架构并没有追求前沿，而是围绕可复现与长期训练稳定性优化。<br/>
团队的结论是：<strong>小模型比大模型更容易被架构选择害死</strong>，因此设计必须务实。</p>
<h2 data-id="heading-3">四、数据决定灵魂</h2>
<p>如果说模型结构决定怎么学，数据则决定学什么。<br/>
Hugging Face 的态度很明确：<strong>数据混合比架构更关键。</strong></p>
<p>他们的经验是——数据不是越高质量越好。<br/>
例如，过多的学术论文文本会让模型在通用语义任务上表现退化。</p>
<p>真正的关键在于比例和节奏：</p>
<ul>
<li>训练初期，用多样、略带噪声的数据提升鲁棒性；</li>
<li>中后期（尤其学习率衰减阶段），引入高质量领域数据强化能力。</li>
</ul>
<p>这种动态课程式训练（curriculum scheduling）在 SmolLM3 中被严格执行。<br/>
甚至连何时切换数据配方都由在线评估指标决定，而非人工预设。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a86e9a664fe484bb6055b869de09758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=tmd0KzFR%2FhoDEw8De9KlaL5txRA%3D" alt="" loading="lazy"/></p>
<p>文档把这种过程称为数据指挥（Data Conductor）——模型的行为不是写在代码里，而是写在它最后读到的那批数据里。</p>
<h2 data-id="heading-4">五、现实中的训练</h2>
<p>Hugging Face 用飞行前检查形容正式训练前的准备工作。<br/>
因为当你启动 384 张 H100 时，任何配置错误都可能意味着几万美元的浪费。</p>
<p>他们列出了包括：</p>
<ul>
<li>checkpoint 恢复机制；</li>
<li>数据加载健康检查；</li>
<li>GPU 吞吐率与热稳定性监控；</li>
<li>以及日志系统的冗余备份。</li>
</ul>
<p>但即便如此，训练仍然会出事故。<br/>
文档记录了典型问题：“吞吐率突然下降、loss 曲线变得噪声化、节点间通信延迟异常。”</p>
<p>为此，他们开发了 GPU Fryer（压力测试）与 DCGM（诊断管理器）来检测显存、PCIe 连接与热稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5612345563264ad28ca8f0eec25613fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=gXFUh8pnc73vRJTRcml79o195rE%3D" alt="" loading="lazy"/></p>
<p>训练一个 LLM，更像是<strong>运维一座微缩的数据中心</strong>。<br/>
Hugging Face 的工程师总结得很干脆：“在规模化训练中，问题不会消失，只会轮流出现。”</p>
<h2 data-id="heading-5">六、后训练</h2>
<p>完成预训练的 SmolLM3 只具备原始语言能力，离可用产品还差一大步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b55e6ffd5a6444094158799642be7ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=agKW6cEckk9sgPPz3mTd%2BY2uTkI%3D" alt="" loading="lazy"/></p>
<p>后训练阶段包括：</p>
<ol>
<li><strong>监督微调（SFT）</strong> —— 建立任务意识；</li>
<li><strong>偏好优化（DPO / PPO）</strong> —— 学习人类偏好；</li>
<li><strong>强化学习（RLHF）</strong> —— 提升稳健性与一致性。</li>
</ol>
<p>团队强调，不必神话 RLHF。<br/>
SFT 成本低、稳定、效果明显，是所有改进的起点。<br/>
后续的 DPO 与 RLHF 更像打磨，而不是重塑。</p>
<h2 data-id="heading-6">七、基础设施</h2>
<p>文档的最后一部分谈的不是算法，而是<strong>基础设施</strong>。在长达数周的训练中，基础设施的可靠性决定项目能否完成。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a8c61e39da4a67bb348b97e5c346e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=yuMzBPE7QMzGIt3jZMQuys1RMWU%3D" alt="" loading="lazy"/></p>
<p>他们详细介绍了 GPU 健康监测、内存通信、数据同步策略。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba204bd77eb54c81acce71214faa9cab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414505&amp;x-signature=zdHNPzKDx5QkXhTFO%2BMTTvwgrd0%3D" alt="" loading="lazy"/></p>
<p>并给出了一个实际算力估算公式：</p>
<p>所需 GPU 数量 ≈ (模型参数量 × 训练 Tokens × 每 Token FLOPs) ÷ (单 GPU 吞吐 × 目标训练时间)</p>
<p>代入 SmolLM3 的参数，结果是 379 块 GPU。<br/>
最终部署 384 块，以便在出现节点损坏时有容错余量。</p>
<p>这部分提醒读者训练 LLM 不仅是科学实验，更是工程项目。没有稳定的基础设施，再好的架构也无法落地。</p>
<p>Hugging Face 的这篇长文没有太多突破性算法，但它提供了一个不同的视角——<strong>把模型训练当作现实工程而非抽象科学</strong>。</p>
<p>它让人看到，在巨大的技术叙事之外，一个大模型的诞生，其实更接近一次长期的系统建设：从理念、实验、数据、监控到修复，每个环节都在和现实的摩擦中前进。</p>
<p><strong>📚推荐阅读</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1967942441748371257" target="_blank" title="https://zhuanlan.zhihu.com/p/1967942441748371257" ref="nofollow noopener noreferrer">详解Kimi Linear——有望替代全注意力的全新注意力架构</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1927844769058497732" target="_blank" title="https://zhuanlan.zhihu.com/p/1927844769058497732" ref="nofollow noopener noreferrer">GPT‑4：多模态大规模模型，开启更智能时代</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1937265830216857540" target="_blank" title="https://zhuanlan.zhihu.com/p/1937265830216857540" ref="nofollow noopener noreferrer">一文搞懂DeepSeek LLM</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1930331294874703770" target="_blank" title="https://zhuanlan.zhihu.com/p/1930331294874703770" ref="nofollow noopener noreferrer">LLaMA 3：离 AGI 更近一步？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936554902206784162" target="_blank" title="https://zhuanlan.zhihu.com/p/1936554902206784162" ref="nofollow noopener noreferrer">Grok-1：马斯克旗下 xAI 首个开源大模型全面解析</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1961825568644401081" target="_blank" title="https://zhuanlan.zhihu.com/p/1961825568644401081" ref="nofollow noopener noreferrer">LongCat-Flash：美团出手，国产卡上跑出的「闪电级」大模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1966265102568265354" target="_blank" title="https://zhuanlan.zhihu.com/p/1966265102568265354" ref="nofollow noopener noreferrer">美团发力，LongCat-Video发布！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1968799296439693416" target="_blank" title="https://zhuanlan.zhihu.com/p/1968799296439693416" ref="nofollow noopener noreferrer">LongCat-Flash-Omni：美团的全模态大模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1970980105363886971" target="_blank" title="https://zhuanlan.zhihu.com/p/1970980105363886971" ref="nofollow noopener noreferrer">Kimi K2 Thinking：面向思考＋工具调用的高阶智能体大模型</a></p>
<p>关于深度学习和AI大模型相关的知识和前沿技术更新，请关注公众号 <strong>coting</strong>！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 中为什么用LayerNorm而不用BatchNorm？]]></title>    <link>https://juejin.cn/post/7588042910194942002</link>    <guid>https://juejin.cn/post/7588042910194942002</guid>    <pubDate>2025-12-27T04:33:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588042910194942002" data-draft-id="7588086766247690291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 中为什么用LayerNorm而不用BatchNorm？"/> <meta itemprop="keywords" content="人工智能,面试"/> <meta itemprop="datePublished" content="2025-12-27T04:33:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 中为什么用LayerNorm而不用BatchNorm？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:33:53.000Z" title="Sat Dec 27 2025 04:33:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>无论是 BERT、GPT 还是 ViT，几乎都不用 Batch Normalization，而是清一色地用 Layer Normalization。<br/>
这不是巧合，而是 Transformer 架构中一个非常深层的设计选择。
所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、BN 和 LN 到底在做什么？</h2>
<p>BN 和 LN 的出发点其实一样——<strong>稳定训练，防止梯度爆炸或消失</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b87daf6213cb40eca921271df82fd30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=mj%2B%2F9I6ALCv%2BExNlxMSRm5mdt60%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Batch Normalization（BN）</strong>：<br/>
它在一个 batch 内计算均值和方差，对同一层的所有样本的每个通道做标准化。<br/>
换句话说，BN 关心的是<strong>这一批数据的统计特征</strong>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53fa1da874854ef299fb2c0e8d3e077d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=ktu1j1rc4l21Ogzl7uSVNHLNvwI%3D" alt="image" loading="lazy"/></li>
<li><strong>Layer Normalization（LN）</strong>：<br/>
LN 则是在同一个样本内部计算均值和方差，对该样本的所有特征维度一起归一化。<br/>
换句话说，LN 关心的是<strong>单个样本内部的特征分布</strong>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71266b0ccba349abacadc92ec8094017~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=GYbEzuDVAYrKX2pK1T%2BWD2j9Qq0%3D" alt="image" loading="lazy"/></li>
</ul>
<p>BN 是跨样本归一化，LN 是单样本归一化。</p>
<h2 data-id="heading-1">二、BN 的问题</h2>
<p>BN 在 CNN 时代非常成功，但为什么在 Transformer 中就变得水土不服？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aadc88b99c9942caafadf2819b076be2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414832&amp;x-signature=QqvYXs9OWKwXSmPLBiNmrISTgFg%3D" alt="" loading="lazy"/></p>
<p>根本原因有三点。</p>
<h3 data-id="heading-2">1. Transformer 是<strong>序列模型</strong>，batch 维度不稳定</h3>
<p>BN 的计算依赖 batch 的统计量（均值和方差）。<br/>
而 Transformer 的输入往往是<strong>变长序列</strong>，不同样本长度不同，padding 数量不同，导致 batch 内统计特性不一致，BN 的均值和方差变得不可靠。</p>
<h3 data-id="heading-3">2. <strong>自注意力机制破坏了空间独立性</strong></h3>
<p>在卷积中，BN 对通道归一化是合理的，因为每个通道特征相对独立。<br/>
但在 Transformer 的 Self-Attention 中，<strong>每个 token 都与其他 token 有强关联</strong>。<br/>
此时再按 batch 统计均值、方差，就会让不同样本的分布互相干扰，破坏注意力机制的学习稳定性。</p>
<h3 data-id="heading-4">3. <strong>推理阶段 BN 的统计特性难以复用</strong></h3>
<p>BN 在推理时会使用训练阶段的滑动均值来做归一化。<br/>
但 Transformer 的输入分布在推理阶段往往与训练时不同（比如变长文本、不同语言或领域），这会导致分布漂移（distribution shift），从而引入偏差。<br/>
LN 不依赖 batch，因此天然更稳定。</p>
<h2 data-id="heading-5">三、LN 的优势</h2>
<p>相较 BN，LN 有三个天然优势，让它几乎成了 Transformer 的标配：</p>
<ol>
<li><strong>与 batch size 无关</strong>：LN 在样本内部归一化，batch 只要有一个样本都能跑。</li>
<li><strong>适合变长序列</strong>：每个 token 独立归一化，不受 padding、mask 等影响。</li>
<li><strong>训练和推理一致</strong>：LN 在训练和推理阶段用的统计量完全一致，不存在分布漂移问题。</li>
</ol>
<p>这些特性让 LN 特别适合大模型——尤其是在分布式、异步、变长输入的环境下。</p>
<p>更深层次的，BN 的归一化粒度是 <strong>batch 维度</strong>，而 Transformer 想捕捉的是 <strong>token 之间的微妙关系</strong>。<br/>
当每个样本长度不同、token 相关性强时，BN 的跨样本归一化反而会削弱模型的表达能力。</p>
<p>LN 的归一化发生在特征维度内部，保证了<strong>每个 token 的特征分布稳定</strong>，不会被其他样本的统计特征干扰。</p>
<p>这其实是一种从样本层面向特征层面的思维转变。</p>
<p>所以，总结一下：</p>
<p>Transformer 用 LN 而不用 BN，本质上是因为：</p>
<ol>
<li>BN 依赖 batch 统计量，不适合变长、分布差异大的序列数据；</li>
<li>Attention 机制导致样本间特征强耦合，BN 会破坏这种结构；</li>
<li>LN 与 batch size 无关，推理阶段也稳定一致。</li>
</ol>
<p>关于深度学习和AI大模型相关的知识和前沿技术更新，请关注公众号 <strong>aicoting</strong>！</p>
<p><strong>📚推荐阅读</strong></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918047303597552480" target="_blank" title="https://zhuanlan.zhihu.com/p/1918047303597552480" ref="nofollow noopener noreferrer">一览Transformer整体架构</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918049072331362469" target="_blank" title="https://zhuanlan.zhihu.com/p/1918049072331362469" ref="nofollow noopener noreferrer">Transformer——Attention怎么实现集中注意力</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918050616376301224" target="_blank" title="https://zhuanlan.zhihu.com/p/1918050616376301224" ref="nofollow noopener noreferrer">Transformer——FeedForward模块在干什么？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1918357249883105145" target="_blank" title="https://zhuanlan.zhihu.com/p/1918357249883105145" ref="nofollow noopener noreferrer">从0开始实现Transformer</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1919338888536756837" target="_blank" title="https://zhuanlan.zhihu.com/p/1919338888536756837" ref="nofollow noopener noreferrer">什么是KV-Cache</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1919500956946655189" target="_blank" title="https://zhuanlan.zhihu.com/p/1919500956946655189" ref="nofollow noopener noreferrer">Transformer注意力机制——MHA&amp;MQA&amp;GQA</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1923328314241704991" target="_blank" title="https://zhuanlan.zhihu.com/p/1923328314241704991" ref="nofollow noopener noreferrer">FlashAttention怎么提升速度的？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963547933044631464" target="_blank" title="https://zhuanlan.zhihu.com/p/1963547933044631464" ref="nofollow noopener noreferrer">面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962254381677257759" target="_blank" title="https://zhuanlan.zhihu.com/p/1962254381677257759" ref="nofollow noopener noreferrer">面试官：Transformer如何优化到线性级？</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1923714840653993730" target="_blank" title="https://zhuanlan.zhihu.com/p/1923714840653993730" ref="nofollow noopener noreferrer">FlashAttention2：更快的注意力机制，更好的并行效率</a></p>
<p>● <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1924154277082961318" target="_blank" title="https://zhuanlan.zhihu.com/p/1924154277082961318" ref="nofollow noopener noreferrer">FlashAttention3 全解析：速度、精度、显存的再平衡</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI智能体：六十五、模型智能训练控制：早停机制在深度学习中的应用解析]]></title>    <link>https://juejin.cn/post/7587997157237833780</link>    <guid>https://juejin.cn/post/7587997157237833780</guid>    <pubDate>2025-12-27T05:03:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237833780" data-draft-id="7587997157237817396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI智能体：六十五、模型智能训练控制：早停机制在深度学习中的应用解析"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-27T05:03:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彼岸花开了吗"/> <meta itemprop="url" content="https://juejin.cn/user/4153315734334538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI智能体：六十五、模型智能训练控制：早停机制在深度学习中的应用解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153315734334538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彼岸花开了吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:03:03.000Z" title="Sat Dec 27 2025 05:03:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、什么是早停机制</h2>
<p>在深度学习模型训练过程中，我们常常面临一个关键问题：何时停止训练？ 训练不足会导致欠拟合，模型无法充分学习数据特征；训练过度则会导致过拟合，模型过度记忆训练数据中的噪声而丧失泛化能力。</p>
<p>早停机制是机器学习中一种简单而有效的正则化技术，通过在验证集性能停止改善时提前终止训练，自动找到模型复杂度和泛化能力的最佳平衡点。通俗的讲，早停机制就像一个有经验的老师，在学生开始学糊涂的时候及时喊停，让学生保持最佳的学习状态，不要一直学不休息，如果发现成绩不提高了，就及时停止，避免浪费时间，检测掌握程度，从而恢复到最佳状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01da0e0d4eb45f2a5e1fa532c0f0f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767416653&amp;x-signature=FL98SlitJIq%2FfJFZ05bEV7LhCTI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、早停机制的价值</h2>
<p>早停机制的核心价值在于：</p>
<ul>
<li>自动防过拟合：在模型开始过拟合前智能停止</li>
<li>提升训练效率：避免不必要的训练轮次，节省计算资源</li>
<li>简化调参过程：自动化寻找最佳训练轮次，减少人工干预</li>
<li>改善模型泛化：获得在未见数据上表现更好的模型</li>
</ul>
<p>在实际应用中，早停机制能够：</p>
<ul>
<li>减少30-80%的训练时间，显著降低计算成本</li>
<li>提升模型在生产环境中的稳定性和可靠性</li>
<li>使非专家用户也能训练出高质量的模型</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30015d2a6fa1466eaa3728cd25cb5774~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767416653&amp;x-signature=MSoFKnsigiS9nq3nvrR%2FFeLwNGU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、早停机制关键参数</h2>
<h3 data-id="heading-3">1. patience（耐心值）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 不同场景的推荐值</span>
简单问题: <span class="hljs-attr">patience</span> = <span class="hljs-number">5</span>-<span class="hljs-number">10</span>
复杂问题: <span class="hljs-attr">patience</span> = <span class="hljs-number">15</span>-<span class="hljs-number">25</span>
不稳定训练: <span class="hljs-attr">patience</span> = <span class="hljs-number">20</span>-<span class="hljs-number">30</span>
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>控制早停的敏感度</li>
<li>防止因训练波动而过早停止</li>
<li>平衡训练充分性和效率</li>
</ul>
<h3 data-id="heading-4">2. min_delta（最小改善阈值）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 典型设置</span>
<span class="hljs-attr">min_delta</span> = <span class="hljs-number">0.001</span>  <span class="hljs-comment"># 对于损失函数，改善必须大于0.001才算显著</span>
<span class="hljs-attr">min_delta</span> = <span class="hljs-number">0.0001</span> <span class="hljs-comment"># 对于高精度需求，改善必须大于0.0001才算显著</span>
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>过滤掉训练过程中的微小波动</li>
<li>确保只有真正的性能提升才会重置计数器</li>
<li>提高早停决策的稳定性</li>
</ul>
<h3 data-id="heading-5">3. restore_best_weights（恢复最佳权重）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 建议开启</span>
<span class="hljs-attr">restore_best_weights</span> = <span class="hljs-literal">True</span>
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>确保最终获得历史最佳模型</li>
<li>避免使用性能下降后的模型</li>
<li>这是早停机制价值的核心体现</li>
</ul>
<h2 data-id="heading-6">四、早停机制的流程</h2>
<h3 data-id="heading-7">1. 流程图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e54420607694e88a7dc28ec48ef59b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767416653&amp;x-signature=lZ2Z6ELXvBgxcxmEyW2u9SCdY%2FY%3D" alt="" loading="lazy"/>​</p>
<h3 data-id="heading-8">2. 流程说明</h3>
<p><strong>2.1 开始训练</strong></p>
<p>初始化训练过程，设置初始参数</p>
<ul>
<li>初始化模型权重</li>
<li>设置训练超参数（学习率、批次大小等）</li>
<li>准备训练集和验证集</li>
<li>初始化耐心计数器为0</li>
<li>设置最佳性能记录为初始值</li>
</ul>
<p><strong>2.2 训练一个epoch</strong></p>
<p>完成一个完整的训练轮次</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 具体操作</span>
<span class="hljs-attr">for batch in training_data:</span>
    <span class="hljs-string">前向传播</span> <span class="hljs-string">→</span> <span class="hljs-string">计算损失</span> <span class="hljs-string">→</span> <span class="hljs-string">反向传播</span> <span class="hljs-string">→</span> <span class="hljs-string">更新参数</span>
</code></pre>
<ul>
<li>输入：训练数据批次</li>
<li>处理：模型参数更新</li>
<li>输出：更新后的模型权重</li>
</ul>
<p><strong>2.3 在验证集上评估性能</strong></p>
<p>使用验证集测试当前模型性能</p>
<ul>
<li>- 验证集不参与训练</li>
<li>- 使用独立的数据评估泛化能力</li>
<li>- 监控指标：val_loss 或 val_accuracy</li>
</ul>
<p>目的：客观评估模型真实性能</p>
<p>指标选择：</p>
<ul>
<li>回归问题：验证损失（val_loss）</li>
<li>分类问题：验证准确率（val_accuracy）</li>
<li>自定义指标：根据业务需求选择</li>
</ul>
<p><strong>2.4 性能改善判断</strong></p>
<p>比较当前性能与历史最佳性能</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 判断条件</span>
<span class="hljs-string">if</span> <span class="hljs-string">current_performance</span> <span class="hljs-string">&lt;</span> <span class="hljs-attr">best_performance - min_delta:</span>
    <span class="hljs-comment"># 显著改善</span>
<span class="hljs-attr">else:</span>
    <span class="hljs-comment"># 无显著改善</span>
</code></pre>
<ul>
<li>min_delta作用：设置改善的最小阈值</li>
<li>避免误判：防止训练波动导致的错误判断</li>
<li>敏感性控制：较大的min_delta要求更明显的改善</li>
</ul>
<p><strong>2.5 性能改善时的操作</strong></p>
<p>当检测到显著改善时的处理</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 具体操作</span>
<span class="hljs-attr">patience_counter</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># 重置计数器</span>
<span class="hljs-attr">best_weights</span> = current_weights.copy()  <span class="hljs-comment"># 保存最佳权重</span>
<span class="hljs-attr">best_performance</span> = current_performance  <span class="hljs-comment"># 更新最佳记录</span>
</code></pre>
<ul>
<li>重置计数器：重新开始计算无改善轮次</li>
<li>保存状态：记录当前的最佳模型状态</li>
<li>更新记录：建立新的性能基准</li>
</ul>
<p><strong>2.6 无改善时的操作</strong></p>
<p>当性能没有显著改善时的处理</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 具体操作</span>
patience_counter += 1  <span class="hljs-comment"># 增加计数</span>
</code></pre>
<ul>
<li>累计等待：记录连续无改善的轮次数</li>
<li>不保存模型：保持之前的最佳权重不变</li>
<li>继续监控：等待可能的后续改善</li>
</ul>
<p><strong>2.7 停止条件检查</strong></p>
<p>检查是否达到停止训练的阈值</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查条件</span>
<span class="hljs-string">if</span> <span class="hljs-string">patience_counter</span> <span class="hljs-string">&gt;=</span> <span class="hljs-attr">patience:</span>
    <span class="hljs-comment"># 触发早停</span>
</code></pre>
<ul>
<li>patience参数：预设的容忍轮次数</li>
<li>平衡考虑：
<ul>
<li>太小：可能过早停止，错过后续改善</li>
<li>太大：浪费计算资源，增加过拟合风险</li>
</ul>
</li>
<li>典型值：10-20轮</li>
</ul>
<p><strong>2.8 停止训练与恢复权重</strong></p>
<p>达到停止条件后的收尾工作</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 最终操作</span>
<span class="hljs-attr">training</span> = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 停止训练循环</span>
model.set_weights(best_weights)  <span class="hljs-comment"># 恢复最佳权重</span>
</code></pre>
<ul>
<li>终止训练：跳出训练循环</li>
<li>恢复最佳状态：使用历史最佳模型权重</li>
<li>确保质量：最终获得的是整个训练过程中性能最好的模型</li>
</ul>
<h3 data-id="heading-9">3. 参数示例</h3>
<p>假设设置：<code>patience=3（容忍3轮无改善）</code>, <code>min_delta=0.01（最小改善阈值0.01）</code></p>
<blockquote>
<h3 data-id="heading-10">`轮次 验证损失 改善判断 耐心计数 操作</h3>
<p>1 0.85 - 0 初始状态<br/>
2 0.72 改善! 0 重置计数，保存模型<br/>
3 0.65 改善! 0 重置计数，保存模型<br/>
4 0.63 改善! 0 重置计数，保存模型<br/>
5 0.63 无改善 1 计数+1<br/>
6 0.64 无改善 2 计数+1<br/>
7 0.65 无改善 3 计数+1 → 触发停止!<br/>
8 - - - 停止训练，恢复第4轮模型`</p>
</blockquote>
<h3 data-id="heading-11">4. 直观理解</h3>
<pre><code class="hljs language-ini" lang="ini">import matplotlib.pyplot as plt
import numpy as np

plt.rcParams<span class="hljs-section">['font.sans-serif']</span> = <span class="hljs-section">['SimHei']</span>
plt.rcParams<span class="hljs-section">['axes.unicode_minus']</span> = False

<span class="hljs-comment"># 模拟训练过程</span>
<span class="hljs-attr">epochs</span> = range(<span class="hljs-number">1</span>, <span class="hljs-number">101</span>)
<span class="hljs-attr">train_loss</span> = [<span class="hljs-number">1.5</span> * <span class="hljs-number">0.95</span>**e for e in epochs]  <span class="hljs-comment"># 训练损失持续下降</span>
<span class="hljs-attr">val_loss</span> = [<span class="hljs-number">1.6</span> * <span class="hljs-number">0.96</span>**e for e in epochs[:<span class="hljs-number">60</span>]] + [<span class="hljs-number">0.4</span> + <span class="hljs-number">0.001</span>*(e-<span class="hljs-number">60</span>) for e in epochs[<span class="hljs-number">60</span>:]]  <span class="hljs-comment"># 验证损失先降后升</span>

plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
plt.plot(epochs, train_loss, 'b-', <span class="hljs-attr">linewidth</span>=<span class="hljs-number">2</span>, label=<span class="hljs-string">'训练损失'</span>)
plt.plot(epochs, val_loss, 'r-', <span class="hljs-attr">linewidth</span>=<span class="hljs-number">2</span>, label=<span class="hljs-string">'验证损失'</span>)

<span class="hljs-comment"># 标记关键点</span>
<span class="hljs-attr">best_epoch</span> = <span class="hljs-number">60</span>
plt.axvline(<span class="hljs-attr">x</span>=best_epoch, color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'最佳停止点'</span>)
plt.axvline(<span class="hljs-attr">x</span>=<span class="hljs-number">80</span>, color=<span class="hljs-string">'orange'</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'早停点'</span>)

plt.xlabel('训练轮次')
plt.ylabel('损失值')
plt.title('早停机制工作原理\n(验证损失开始上升时停止)')
plt.legend()
plt.grid(True, <span class="hljs-attr">alpha</span>=<span class="hljs-number">0.3</span>)
plt.show()
</code></pre>
<p>输出图例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/569f7d0a2d644de6be3ca1d1b5eed5c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767416653&amp;x-signature=0k5CkvbPkIJKjBz%2BuHAKfg2cNwo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">4.1 曲线特征分析</h4>
<p>训练损失曲线（蓝色）</p>
<ul>
<li>形态特征：持续单调下降的指数衰减曲线</li>
<li>数学表达：1.5 × 0.95^epoch</li>
<li>物理意义：模型在训练集上的拟合能力持续提升</li>
<li>关键观察：即使在第60轮后仍在下降，说明模型复杂度足以继续记忆训练数据</li>
</ul>
<p>验证损失曲线（红色）</p>
<ul>
<li>形态特征：典型的U型曲线</li>
<li>第一阶段（1-60轮）：指数衰减 1.6 × 0.96^epoch</li>
<li>第二阶段（60-100轮）：线性上升 0.4 + 0.001×(epoch-60)</li>
<li>转折点：第60轮是曲线的极小值点</li>
</ul>
<h5 data-id="heading-13">4.1.1 关于1.5 × 0.95^epoch的理解</h5>
<p>这个表达式是一个指数衰减函数，各组成部分解析：</p>
<p><strong>4.1.1.1 系数 1.5</strong></p>
<ul>
<li>初始损失值 = 1.5</li>
<li>物理意义：
<ul>
<li>模型在训练开始时的初始损失值</li>
<li>反映模型在未学习任何模式前的预测误差</li>
</ul>
</li>
<li>数值大小取决于：
<ul>
<li>问题复杂度</li>
<li>模型初始化状态</li>
<li>损失函数类型（MSE、交叉熵等）</li>
</ul>
</li>
<li>实际对应：
<ul>
<li>对于回归问题，可能是均方误差的初始值</li>
<li>对于分类问题，可能是交叉熵损失的初始值</li>
</ul>
</li>
</ul>
<p><strong>4.1.1.2 底数 0.95</strong></p>
<ul>
<li>衰减因子 = 0.95</li>
<li>数学意义：
<ul>
<li>每个训练轮次损失减少到前一轮的95%</li>
<li>衰减率 = 1 - 0.95 = 0.05 = 5%</li>
</ul>
</li>
<li>物理意义：
<ul>
<li>学习效率：每个epoch损失减少5%</li>
<li>收敛速度：数值越小收敛越快，越大收敛越慢</li>
<li>模型特性：反映模型的学习能力和优化器效果</li>
</ul>
</li>
</ul>
<p><strong>4.1.1.3 指数 epoch</strong></p>
<ul>
<li>自变量 = epoch（训练轮次）</li>
<li>作用：
<ul>
<li>驱动损失随时间（训练轮次）变化</li>
<li>指数形式体现"衰减加速"效应</li>
</ul>
</li>
</ul>
<p><strong>4.1.1.4 衰减速率</strong></p>
<ul>
<li>计算特定轮次的损失值</li>
<li>epoch=0: 1.5 × 0.95^0 = 1.5</li>
<li>epoch=10: 1.5 × 0.95^10 ≈ 0.90</li>
<li>epoch=20: 1.5 × 0.95^20 ≈ 0.54</li>
<li>epoch=50: 1.5 × 0.95^50 ≈ 0.12</li>
</ul>
<p><strong>4.1.1.5 参数选择的依据</strong></p>
<ul>
<li>初始损失 1.5：
<ul>
<li>基于模型随机初始化的典型表现</li>
<li>对于均方误差，1.5表示平均预测误差约1.22（√1.5）</li>
<li>在标准化数据中这是合理的初始误差</li>
</ul>
</li>
<li>衰减因子 0.95：
<ul>
<li>对应每个epoch约5%的改进</li>
<li>在深度学习中是典型的学习速度</li>
<li>既不会太快（避免震荡）也不会太慢（避免训练过久）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-14">4.2 关键点标记分析</h4>
<p>最佳停止点（绿色虚线 - 第60轮）</p>
<ul>
<li>位置：验证损失的最低点（val_loss ≈ 0.4）</li>
<li>理论意义：模型泛化能力达到峰值</li>
<li>实践挑战：在真实训练中无法预先知道此点</li>
</ul>
<p>早停点（橙色虚线 - 第80轮）</p>
<ul>
<li>位置：验证损失从最低点上升20轮后的位置</li>
<li>实际意义：通过patience=20的早停机制确定的停止点</li>
<li>性能代价：val_loss ≈ 0.42，比最佳点高5%</li>
</ul>
<h4 data-id="heading-15">4.3 过拟合现象的直观展示</h4>
<p>训练损失 vs 验证损失的背离</p>
<ul>
<li>第60轮之前：训练损失 ↓, 验证损失 ↓ → 模型学习有效模式</li>
<li>第60轮之后：训练损失 ↓, 验证损失 ↑ → 模型开始过拟合</li>
</ul>
<p>背离的根本原因</p>
<ul>
<li>训练损失下降：模型继续优化在训练集上的表现</li>
<li>验证损失上升：模型开始记忆训练数据的噪声和特定模式</li>
<li>结果：泛化能力下降，模型变得"太专门化"</li>
</ul>
<p>理解过拟合本质</p>
<ul>
<li>直观展示模型学过头的具体表现</li>
<li>清晰区分训练性能和泛化性能</li>
</ul>
<h4 data-id="heading-16">4.4 早停机制决策逻辑</h4>
<p>patience参数的作用</p>
<ul>
<li>容忍窗口：第60-80轮（20个epoch）</li>
<li>决策依据：连续20轮验证损失无显著改善</li>
<li>平衡考量：在避免过早停止和防止严重过拟合之间权衡</li>
</ul>
<p>min_delta的隐含作用</p>
<ul>
<li>虽然图中未明确显示，但实际早停机制中</li>
<li>只有超过min_delta的改善才会重置patience计数器</li>
<li>防止训练过程中的微小波动触发早停</li>
</ul>
<h4 data-id="heading-17">4.5 偏差-方差权衡的可视化</h4>
<p>第60轮之前</p>
<ul>
<li>高偏差 → 低偏差：模型学习数据真实模式</li>
<li>高方差 → 适当方差：模型复杂度适中</li>
</ul>
<p>第60轮之后</p>
<ul>
<li>偏差基本稳定：模型已学习主要模式</li>
<li>方差持续增加：对训练数据过度敏感</li>
</ul>
<h2 data-id="heading-18">五、示例剖析</h2>
<h3 data-id="heading-19">1. 示例代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> tensorflow.keras.models <span class="hljs-keyword">import</span> Sequential
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Dense
<span class="hljs-keyword">from</span> tensorflow.keras.callbacks <span class="hljs-keyword">import</span> EarlyStopping

<span class="hljs-comment"># 设置中文字体</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"早停机制最简单示例"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

<span class="hljs-comment"># 1. 生成简单的数据</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 生成数据..."</span>)
np.random.seed(<span class="hljs-number">42</span>)
X = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">200</span>).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
y = <span class="hljs-number">2</span> * np.sin(X.ravel()) + <span class="hljs-number">0.5</span> * X.ravel() + np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">200</span>)

<span class="hljs-comment"># 2. 划分训练集和验证集</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 划分数据..."</span>)
X_train, X_val, y_train, y_val = train_test_split(X, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 3. 创建简单的神经网络</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 创建模型..."</span>)
model = Sequential([
    Dense(<span class="hljs-number">50</span>, activation=<span class="hljs-string">'relu'</span>, input_shape=(<span class="hljs-number">1</span>,)),
    Dense(<span class="hljs-number">20</span>, activation=<span class="hljs-string">'relu'</span>),
    Dense(<span class="hljs-number">1</span>)
])
model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'mse'</span>)

<span class="hljs-comment"># 4. 定义早停机制</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 设置早停..."</span>)
early_stopping = EarlyStopping(
    monitor=<span class="hljs-string">'val_loss'</span>,    <span class="hljs-comment"># 监控验证集损失</span>
    patience=<span class="hljs-number">10</span>,           <span class="hljs-comment"># 容忍10轮无改善</span>
    restore_best_weights=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 恢复最佳权重</span>
    verbose=<span class="hljs-number">1</span>
)

<span class="hljs-comment"># 5. 训练模型（使用早停）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"5. 开始训练（使用早停）..."</span>)
history = model.fit(
    X_train, y_train,
    validation_data=(X_val, y_val),
    epochs=<span class="hljs-number">200</span>,           <span class="hljs-comment"># 设置较大的训练轮次</span>
    batch_size=<span class="hljs-number">16</span>,
    callbacks=[early_stopping],
    verbose=<span class="hljs-number">0</span>
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练在 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(history.history[<span class="hljs-string">'loss'</span>])}</span> 轮停止"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"最佳验证损失: <span class="hljs-subst">{<span class="hljs-built_in">min</span>(history.history[<span class="hljs-string">'val_loss'</span>]):<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 6. 可视化结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"6. 生成可视化图表..."</span>)

<span class="hljs-comment"># 创建两个子图</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">15</span>, <span class="hljs-number">5</span>))

<span class="hljs-comment"># 图1：训练过程</span>
ax1.plot(history.history[<span class="hljs-string">'loss'</span>], <span class="hljs-string">'b-'</span>, label=<span class="hljs-string">'训练损失'</span>, linewidth=<span class="hljs-number">2</span>)
ax1.plot(history.history[<span class="hljs-string">'val_loss'</span>], <span class="hljs-string">'r-'</span>, label=<span class="hljs-string">'验证损失'</span>, linewidth=<span class="hljs-number">2</span>)

<span class="hljs-comment"># 找到最佳轮次</span>
best_epoch = np.argmin(history.history[<span class="hljs-string">'val_loss'</span>])
best_val_loss = history.history[<span class="hljs-string">'val_loss'</span>][best_epoch]

<span class="hljs-comment"># 标记最佳点和停止点</span>
ax1.axvline(x=best_epoch, color=<span class="hljs-string">'green'</span>, linestyle=<span class="hljs-string">'--'</span>, 
           label=<span class="hljs-string">f'最佳点 (第<span class="hljs-subst">{best_epoch}</span>轮)'</span>, linewidth=<span class="hljs-number">2</span>)
ax1.axvline(x=<span class="hljs-built_in">len</span>(history.history[<span class="hljs-string">'loss'</span>])-<span class="hljs-number">1</span>, color=<span class="hljs-string">'orange'</span>, linestyle=<span class="hljs-string">'--'</span>,
           label=<span class="hljs-string">f'停止点 (第<span class="hljs-subst">{<span class="hljs-built_in">len</span>(history.history[<span class="hljs-string">"loss"</span>])-<span class="hljs-number">1</span>}</span>轮)'</span>, linewidth=<span class="hljs-number">2</span>)

ax1.set_xlabel(<span class="hljs-string">'训练轮次'</span>)
ax1.set_ylabel(<span class="hljs-string">'损失值'</span>)
ax1.set_title(<span class="hljs-string">'早停机制工作原理\n(验证损失不再改善时停止)'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
ax1.legend()
ax1.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

<span class="hljs-comment"># 图2：预测结果</span>
X_plot = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>).reshape(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
y_pred = model.predict(X_plot)

ax2.scatter(X_train, y_train, alpha=<span class="hljs-number">0.5</span>, color=<span class="hljs-string">'blue'</span>, label=<span class="hljs-string">'训练数据'</span>, s=<span class="hljs-number">20</span>)
ax2.scatter(X_val, y_val, alpha=<span class="hljs-number">0.5</span>, color=<span class="hljs-string">'red'</span>, label=<span class="hljs-string">'验证数据'</span>, s=<span class="hljs-number">20</span>)
ax2.plot(X_plot, <span class="hljs-number">2</span> * np.sin(X_plot.ravel()) + <span class="hljs-number">0.5</span> * X_plot.ravel(), 
        <span class="hljs-string">'g-'</span>, linewidth=<span class="hljs-number">3</span>, label=<span class="hljs-string">'真实关系'</span>)
ax2.plot(X_plot, y_pred, <span class="hljs-string">'k-'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'模型预测'</span>)

ax2.set_xlabel(<span class="hljs-string">'特征 X'</span>)
ax2.set_ylabel(<span class="hljs-string">'目标值 y'</span>)
ax2.set_title(<span class="hljs-string">'模型预测结果\n(避免了过拟合)'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
ax2.legend()
ax2.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)

plt.tight_layout()
plt.show()
</code></pre>
<h3 data-id="heading-20">2. 输出结果</h3>
<blockquote>
<p>==================================================<br/>
早停机制最简单示例<br/>
==================================================<br/>
1. 生成数据...<br/>
2. 划分数据...<br/>
3. 创建模型...<br/>
To enable the following instructions: SSE SSE2 SSE3 SSE4.1 SSE4.2 AVX AVX2 AVX512F AVX512_VNNI FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.<br/>
4. 设置早停...<br/>
5. 开始训练（使用早停）...<br/>
Restoring model weights from the end of the best epoch: 5.<br/>
Epoch 15: early stopping<br/>
训练在 15 轮停止<br/>
最佳验证损失: 1.5427<br/>
6. 生成可视化图表...</p>
<p>参数说明：<br/>
- patience=10：连续10次检测没有进步就停止<br/>
- val_loss：用验证集来检测学习效果<br/>
- restore_best_weights：恢复到历史上最好的状态</p>
<p>从图表可以看到：<br/>
- 左图：验证损失不再下降时就停止训练<br/>
- 右图：模型学到了真实规律，没有过度拟合噪声</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0b75d50d32b40cebd28662317bdfd7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767416653&amp;x-signature=ukAH%2F1S0js7U6Am0gwdvyoIqwK4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-21">3. 结果分析</h3>
<h4 data-id="heading-22">3.1 图表内容详解</h4>
<p>左图：神经网络训练过程监控</p>
<p>曲线特征分析：</p>
<ul>
<li>蓝色训练损失曲线：平滑的指数衰减，显示神经网络在训练集上的稳定学习</li>
<li>红色验证损失曲线：当验证损失不再改善（甚至开始上升）时，早停机制会停止训练，防止了过拟合现象</li>
<li>绿色最佳点虚线：验证损失的最低点，理论上的最优停止时机</li>
<li>橙色停止点虚线：早停机制实际触发的停止点</li>
</ul>
<p>关键动态观察：</p>
<ul>
<li>训练前期（0-20轮）：训练和验证损失同步快速下降</li>
<li>训练中期（20-40轮）：验证损失下降趋缓，训练损失继续下降</li>
<li>训练后期（40轮后）：验证损失开始反弹，训练损失仍缓慢下降</li>
<li>早停触发：在验证损失明显上升后停止</li>
</ul>
<p>右图：神经网络预测结果</p>
<p>数据与模型对比：</p>
<ul>
<li>蓝色训练点：200个训练样本，用于参数更新</li>
<li>红色验证点：40个验证样本，用于早停决策</li>
<li>绿色真实曲线：y = 2*sin(x) + 0.5*x 数据生成函数</li>
<li>黑色预测曲线：神经网络学习到的复杂函数</li>
</ul>
<p>拟合质量评估：</p>
<ul>
<li>神经网络成功捕捉了正弦波动和线性趋势</li>
<li>预测曲线平滑，避免了过度震荡</li>
<li>在数据稀疏区域有良好的泛化表现</li>
<li>与真实函数高度吻合</li>
</ul>
<h4 data-id="heading-23">3.2 运行原理解析</h4>
<p><strong>3.2.1 神经网络架构设计</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">model</span> = Sequential([
    Dense(<span class="hljs-number">50</span>, activation=<span class="hljs-string">'relu'</span>, input_shape=(<span class="hljs-number">1</span>,)),  <span class="hljs-comment"># 隐藏层1</span>
    Dense(<span class="hljs-number">20</span>, activation=<span class="hljs-string">'relu'</span>),                    <span class="hljs-comment"># 隐藏层2  </span>
    Dense(<span class="hljs-number">1</span>)                                         <span class="hljs-comment"># 输出层</span>
])
</code></pre>
<p><strong>架构分析：</strong></p>
<ul>
<li>输入层：1个特征（X值）</li>
<li>隐藏层1：50个神经元，提供足够的表达能力</li>
<li>隐藏层2：20个神经元，进行特征压缩和抽象</li>
<li>输出层：1个神经元，回归预测</li>
</ul>
<p><strong>容量控制：</strong></p>
<ul>
<li>总参数：(1×50 + 50) + (50×20 + 20) + (20×1 + 1) = 1471个参数</li>
<li>相对于200个训练样本，模型容量适中偏大</li>
<li>为过拟合创造了条件，便于演示早停价值</li>
</ul>
<p><strong>3.2.2 Keras早停机制配置</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">early_stopping</span> = EarlyStopping(
    <span class="hljs-attr">monitor</span>=<span class="hljs-string">'val_loss'</span>,       <span class="hljs-comment"># 核心监控指标</span>
    <span class="hljs-attr">patience</span>=<span class="hljs-number">10</span>,              <span class="hljs-comment"># 容忍轮次</span>
    <span class="hljs-attr">restore_best_weights</span>=<span class="hljs-literal">True</span>, <span class="hljs-comment"># 关键恢复机制</span>
    <span class="hljs-attr">verbose</span>=<span class="hljs-number">1</span>                 <span class="hljs-comment"># 进度显示</span>
)
</code></pre>
<p><strong>参数优化：</strong></p>
<ul>
<li>patience=10：在复杂神经网络中提供足够的观察窗口</li>
<li>restore_best_weights=True：确保获得历史最佳模型</li>
<li>verbose=1：提供训练过程的可视化反馈</li>
</ul>
<p><strong>3.2.3 训练策略设计</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">history</span> = model.fit(
    X_train, y_train,
    <span class="hljs-attr">validation_data</span>=(X_val, y_val),  <span class="hljs-comment"># 关键验证集</span>
    <span class="hljs-attr">epochs</span>=<span class="hljs-number">200</span>,                      <span class="hljs-comment"># 充足的上限</span>
    <span class="hljs-attr">batch_size</span>=<span class="hljs-number">16</span>,                   <span class="hljs-comment"># 适中的批次大小</span>
    <span class="hljs-attr">callbacks</span>=[early_stopping],      <span class="hljs-comment"># 早停回调</span>
    <span class="hljs-attr">verbose</span>=<span class="hljs-number">0</span>                        <span class="hljs-comment"># 简化输出</span>
)
</code></pre>
<p><strong>训练配置分析：</strong></p>
<ul>
<li>batch_size=16：平衡训练稳定性和收敛速度</li>
<li>epochs=200：提供充分的训练空间</li>
<li>verbose=0：保持输出简洁，专注于结果分析</li>
</ul>
<h4 data-id="heading-24">3.3 示例的意义</h4>
<ul>
<li>左图展示了早停机制如何工作：当验证损失不再改善（甚至开始上升）时，早停机制会停止训练，从而防止过拟合。</li>
<li>右图展示了模型学到的函数与真实函数的对比，可以看出模型是否过度拟合了训练数据中的噪声。</li>
</ul>
<h4 data-id="heading-25">3.4 示例的价值</h4>
<ul>
<li>早停机制可以自动确定训练轮次，避免人工选择。</li>
<li>通过早停，我们可以在验证损失最小时停止训练，获得泛化能力更好的模型。</li>
<li>可视化训练过程和预测结果有助于理解模型的行为和早停机制的效果。</li>
</ul>
<h4 data-id="heading-26">3.5 示例深度分析</h4>
<ul>
<li>在左图中，训练损失持续下降，当验证损失不再改善（甚至开始上升）时，早停机制会停止训练，有效的防止了过拟合现象。</li>
<li>早停机制在验证损失不在改善一段时间（patience=10）后停止训练，并恢复最佳权重，因此我们得到的模型是在验证集上表现最好的模型。</li>
<li>右图中，模型预测曲线（黑色）与真实关系（绿色）基本吻合，说明模型学到了真实的规律，而没有过度拟合噪声。</li>
</ul>
<h2 data-id="heading-27">六、总结</h2>
<p>早停机制是机器学习中一种重要且实用的训练策略，其核心思想是在模型训练过程中通过监控验证集性能来自动确定最佳停止时机，从而在保证模型泛化能力的同时显著提升训练效率。该机制的工作原理基于一个观察：在典型的训练过程中，验证集损失往往呈现先下降后上升的U型曲线模式。下降阶段代表模型正在学习数据中的有效模式，而上升阶段则表明模型开始过度拟合训练数据中的噪声和特定样本。</p>
<p>具体实现上，早停机制在每个训练轮次结束后都会在独立的验证集上评估模型性能。当检测到性能有显著改善时，系统会保存当前模型状态并重置耐心计数器；而当性能连续多个轮次没有明显提升时，耐心计数器会逐步累加。一旦连续无改善的轮次数达到预设的容忍阈值，训练便会自动终止，并将模型权重恢复到历史最佳状态。这种设计既避免了因训练波动导致的过早停止，又防止了过度训练造成的性能下降。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[深度学习]RNN,LSTM,GRU(联系和区别)]]></title>    <link>https://juejin.cn/post/7588064253635952694</link>    <guid>https://juejin.cn/post/7588064253635952694</guid>    <pubDate>2025-12-27T05:42:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253635952694" data-draft-id="7588073726207492102" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[深度学习]RNN,LSTM,GRU(联系和区别)"/> <meta itemprop="keywords" content="深度学习"/> <meta itemprop="datePublished" content="2025-12-27T05:42:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [深度学习]RNN,LSTM,GRU(联系和区别)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:42:53.000Z" title="Sat Dec 27 2025 05:42:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RNN、LSTM 和 GRU 是处理序列数据（如时间序列、文本、语音）的核心神经网络模型。</p>
<p>它们之间存在清晰的<code>演进关系</code>。</p>
<p>下面我将为你详细梳理它们之间的<strong>关联</strong>和<strong>区别</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、 核心关联：演进与解决之道</h2>
<p>可以简单理解为：LSTM 和 GRU 都是<code>标准RNN</code> 的<code>升级变体</code>，目的是为了解决<code>标准 RNN</code> 的核心缺陷。</p>
<p>它们的根本目标相同：<strong>处理序列数据，并利用历史信息来影响当前输出。</strong> 它们都遵循一个循环计算的基本框架。</p>
<p><strong>演进路线：</strong></p>
<ol>
<li><strong>基础版 RNN</strong>：提出了循环连接的概念，但存在严重缺陷。</li>
<li><strong>改进版 LSTM</strong>：通过精巧的“门控”和“细胞状态”设计，从根本上解决了 RNN 的主要问题，成为长期依赖学习的里程碑。</li>
<li><strong>简化版 GRU</strong>：在 LSTM 的基础上进行简化，用更少的参数达到相近的性能，训练更快。</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、 分步详细解析</h2>
<h3 data-id="heading-2">1. 循环神经网络</h3>
<p>RNN 的核心思想是让网络具有“记忆”，当前时刻的输出不仅取决于当前输入，还取决于过去所有时刻的“历史状态”。</p>
<ul>
<li>
<p><strong>核心结构</strong>：</p>
<ul>
<li>有一个**隐藏状态 **，它像一个“记忆单元”，随着时间步传递。</li>
<li>计算公式简单：
<ul>
<li><code>h_t = tanh(W * [h_{t-1}, x_t] + b)</code> （更新隐藏状态）</li>
<li><code>y_t = softmax(W_y * h_t + b_y)</code> （生成输出）</li>
</ul>
</li>
<li><code>h_t</code> 是当前时刻的隐藏状态，<code>h_{t-1}</code> 是上一时刻的状态，<code>x_t</code> 是当前输入。</li>
</ul>
</li>
<li>
<p><strong>致命缺陷：梯度消失/爆炸问题</strong></p>
<ul>
<li>在反向传播时，梯度需要沿着时间步一路回传。RNN 的梯度是连续相乘的关系。</li>
<li>当序列很长时，如果梯度值 <code>&lt;1</code>，连续相乘会趋近于0，导致<strong>梯度消失</strong>——远处的信息无法影响当前参数的更新（网络“遗忘”了长距离依赖）。</li>
<li>如果梯度值 <code>&gt;1</code>，连续相乘会变得极大，导致<strong>梯度爆炸</strong>——训练不稳定。</li>
<li><strong>本质</strong>：简单循环结构的复合函数，导致对长期记忆的读写和控制能力太弱。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. 长短期记忆网络</h3>
<p>LSTM 由 Sepp Hochreiter 和 Jürgen Schmidhuber 于1997年提出，专门为了解决长期依赖问题。其核心是引入了 <strong>“门控机制”</strong> 和一个<strong>独立的“细胞状态”</strong>。</p>
<ul>
<li>
<p><strong>核心创新</strong>：</p>
<ol>
<li><strong>细胞状态</strong>：可以想象成一条“传送带”。它贯穿整个时间线，只进行轻微的线性交互，信息可以轻易地在这条传送带上流动而不易改变或消失。这是LSTM保存长期记忆的关键。</li>
<li><strong>三道门控</strong>（由Sigmoid函数和点乘操作构成）：
<ul>
<li><strong>遗忘门</strong>：决定从细胞状态中丢弃哪些旧信息。<code>f_t = σ(W_f * [h_{t-1}, x_t] + b_f)</code></li>
<li><strong>输入门</strong>：决定将哪些新信息存入细胞状态。它包含两部分：一个Sigmoid层决定“更新什么”，一个tanh层生成“候选值”。
<ul>
<li><code>i_t = σ(W_i * [h_{t-1}, x_t] + b_i)</code></li>
<li><code>C̃_t = tanh(W_C * [h_{t-1}, x_t] + b_C)</code></li>
</ul>
</li>
<li><strong>输出门</strong>：基于当前的细胞状态，决定输出什么到隐藏状态。
<ul>
<li><code>o_t = σ(W_o * [h_{t-1}, x_t] + b_o)</code></li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>遗忘</strong>：用遗忘门 <code>f_t</code> 点乘上一个细胞状态 <code>C_{t-1}</code>，丢弃无用信息。</li>
<li><strong>记忆</strong>：用输入门 <code>i_t</code> 点乘候选值 <code>C̃_t</code>，将新信息加到细胞状态。得到新状态 <code>C_t = f_t * C_{t-1} + i_t * C̃_t</code>。</li>
<li><strong>输出</strong>：将细胞状态 <code>C_t</code> 通过tanh缩放，然后用输出门 <code>o_t</code> 过滤，得到当前隐藏状态 <code>h_t = o_t * tanh(C_t)</code>。</li>
</ol>
</li>
<li>
<p><strong>为何有效</strong>：<strong>细胞状态的加法更新是关键</strong>。梯度在反向传播通过细胞状态时，是<strong>加性的</strong>，避免了连乘效应，从而缓解了梯度消失问题，使网络能够学习到非常长的依赖关系。</p>
</li>
</ul>
<h3 data-id="heading-4">3. 门控循环单元</h3>
<p>GRU 由 Cho 等人于2014年提出，可以看作是 LSTM 的一种<code>简化、高效的变体</code>。</p>
<ul>
<li><strong>核心简化</strong>：
<ol>
<li><strong>合并了细胞状态和隐藏状态</strong>，只有一个传递状态 <code>h_t</code>。</li>
<li><strong>将 LSTM 的三门结构简化为两门</strong>：
<ul>
<li><strong>更新门</strong>：它同时扮演了 LSTM 中<strong>遗忘门和输入门</strong>的角色，决定了有多少旧信息被保留，多少新信息被加入。
<ul>
<li><code>z_t = σ(W_z * [h_{t-1}, x_t] + b_z)</code></li>
</ul>
</li>
<li><strong>重置门</strong>：决定了在计算新的候选状态时，如何结合过去的信息。
<ul>
<li><code>r_t = σ(W_r * [h_{t-1}, x_t] + b_r)</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>候选激活</strong>：<code>h̃_t = tanh(W * [r_t * h_{t-1}, x_t] + b)</code>
<ul>
<li>重置门 <code>r_t</code> 控制上一状态 <code>h_{t-1}</code> 对候选状态的影响。如果 <code>r_t</code> 接近0，则“遗忘”过去，只关注当前输入。</li>
</ul>
</li>
<li><strong>最终状态更新</strong>：<code>h_t = (1 - z_t) * h_{t-1} + z_t * h̃_t</code>
<ul>
<li>更新门 <code>z_t</code> 像一个权衡因子：<code>z_t</code> 接近1，则状态主要由候选状态<code>h̃_t</code>更新（更像RNN）；<code>z_t</code>接近0，则状态几乎保留为旧的<code>h_{t-1}</code>。</li>
</ul>
</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 核心区别对比表格</h2>







































































<table><thead><tr><th align="left">特性</th><th align="left">RNN</th><th align="left">LSTM</th><th align="left">GRU</th></tr></thead><tbody><tr><td align="left"><strong>核心结构</strong></td><td align="left">简单循环单元</td><td align="left">复杂，包含细胞状态和三道门</td><td align="left">较简单，合并状态，两道门</td></tr><tr><td align="left"><strong>门控数量</strong></td><td align="left">无</td><td align="left">3个（遗忘、输入、输出）</td><td align="left">2个（更新、重置）</td></tr><tr><td align="left"><strong>状态数量</strong></td><td align="left">1个（隐藏状态 <code>h</code>）</td><td align="left">2个（隐藏状态 <code>h</code> 和 细胞状态 <code>C</code>）</td><td align="left">1个（隐藏状态 <code>h</code>）</td></tr><tr><td align="left"><strong>关键机制</strong></td><td align="left">无门控，直接Tanh变换</td><td align="left">细胞状态 + 精细门控</td><td align="left">更新/重置门 + 候选状态</td></tr><tr><td align="left"><strong>参数量</strong></td><td align="left"><strong>最少</strong></td><td align="left"><strong>最多</strong>（比RNN多约4倍参数）</td><td align="left"><strong>中等</strong>（比RNN多约3倍参数）</td></tr><tr><td align="left"><strong>计算效率</strong></td><td align="left">最高</td><td align="left">最低（结构复杂）</td><td align="left">较高（结构相对简单）</td></tr><tr><td align="left"><strong>训练速度</strong></td><td align="left">快（但常因梯度问题难收敛）</td><td align="left">慢</td><td align="left"><strong>通常最快</strong>（在同等效果下）</td></tr><tr><td align="left"><strong>长程依赖能力</strong></td><td align="left"><strong>很弱</strong>，易梯度消失</td><td align="left"><strong>非常强</strong>，专为长序列设计</td><td align="left"><strong>强</strong>，接近LSTM，但对超长序列可能略逊</td></tr><tr><td align="left"><strong>主要优势</strong></td><td align="left">结构简单，计算快</td><td align="left">长期记忆能力强，非常稳健</td><td align="left">效率高，在多数任务上表现与LSTM相当</td></tr><tr><td align="left"><strong>主要劣势</strong></td><td align="left">无法有效学习长程依赖</td><td align="left">参数多，计算慢，可能过拟合</td><td align="left">极端长序列任务上理论解释性不如LSTM</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">四、 如何选择？</h2>
<ol>
<li><strong>数据/任务简单，序列短</strong>：可以尝试简单RNN，但现实的项目中<code>极少使用标准RNN</code>.</li>
<li><strong>任务复杂，序列非常长，且对长期记忆要求极高</strong>（如机器翻译、文档摘要、复杂时间序列预测）：<strong>LSTM</strong> 通常是更可靠的选择，它经过了时间的考验，表现稳健。</li>
<li><strong>追求更高的训练和推理效率，序列长度中等或较长</strong>：<strong>GRU</strong> 是很好的起点。它在很多任务（如语音识别、情感分析）上与LSTM效果相当甚至更好，且速度更快。</li>
<li><strong>资源有限（计算/内存）</strong>：优先考虑 <strong>GRU</strong>。</li>
<li><strong>实践建议</strong>：在具体项目上，可以同时搭建LSTM和GRU模型进行对比实验，选择在验证集上表现更优的模型。目前，<strong>GRU 和 LSTM 是实际应用中最主流的选择</strong>，而<strong>Transformer</strong> 及其变体（如BERT， GPT）则在NLP的许多领域超越了它们。</li>
</ol>
<p><strong>总结来说，可以把它们看作是处理序列问题的“工具三代”：RNN是基础但有缺陷的工具，LSTM是功能强大但稍显笨重的专业工具，GRU则是集功能强大与效率性能于一身的精良工具。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent 一直在“失忆”？问题不在模型，而在我们根本没做对 Memory]]></title>    <link>https://juejin.cn/post/7588086766247772211</link>    <guid>https://juejin.cn/post/7588086766247772211</guid>    <pubDate>2025-12-27T05:52:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766247772211" data-draft-id="7588010346071359498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 一直在“失忆”？问题不在模型，而在我们根本没做对 Memory"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-27T05:52:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tang1024"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450625357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 一直在“失忆”？问题不在模型，而在我们根本没做对 Memory
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450625357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tang1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:52:28.000Z" title="Sat Dec 27 2025 05:52:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>很多 Agent 项目失败，不是模型不行，而是根本没有“记忆系统”。</strong></p>
</blockquote>
<p>这两年，“给 Agent 加 memory” 几乎成了共识，向量库、RAG、长上下文、KV cache……工具越来越多，但一个尴尬的现象是：</p>
<blockquote>
<p><strong>Agent 依然健忘、反复犯错、前后矛盾，跑久了还会“人格崩坏”。</strong></p>
</blockquote>
<p>问题到底出在哪？</p>
<p>最近一篇由 <strong>NUS、人大、复旦、北大</strong> 等机构联合完成的百页综述<br/>
《<strong>Memory in the Age of AI Agents</strong>》，给了我一个非常工程化的答案：</p>
<blockquote>
<p><strong>我们大多数人在做的，并不是 Agent Memory，而只是“信息外挂”。</strong></p>
</blockquote>
<p>这篇文章，我不打算复述论文，而是站在<strong>工程师视角</strong>，讲清三件事：</p>
<ol>
<li>为什么“向量库 ≠ Agent Memory”</li>
<li>Agent Memory 的<strong>系统级抽象</strong>应该长什么样</li>
<li>如果你真的要做一个“会成长的 Agent”，架构该怎么设计</li>
</ol>
<hr/>
<h2 data-id="heading-0">一、先说结论：没有 Memory，就没有长期可用的 Agent</h2>
<p>在真实工程里，你一定见过这些现象：</p>
<ul>
<li>Agent 反复问已经问过的问题</li>
<li>已经失败过的策略，下次还是照样走</li>
<li>多轮任务一长，就开始自相矛盾</li>
<li>用户偏好、身份设定，在 session 之间直接蒸发</li>
</ul>
<p>这些问题<strong>不是 prompt 没写好，也不是模型不聪明</strong>，而是：</p>
<blockquote>
<p><strong>系统没有能力跨时间维持“认知状态”。</strong></p>
</blockquote>
<p>换句话说：<br/>
<strong>Agent 没有活在时间里。</strong></p>
<p>这正是为什么这篇综述直接把 Memory 定位为：</p>
<blockquote>
<p><strong>Agent 的基础设施（first-class primitive）</strong><br/>
而不是一个“增强模块”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、为什么“长 / 短期记忆”这个划分已经过时了？</h2>
<p>工程中最常见的说法是：</p>
<ul>
<li>short-term memory：上下文窗口</li>
<li>long-term memory：向量库</li>
</ul>
<p>但问题是：</p>
<ul>
<li>有的“长期记忆”只服务于事实一致性</li>
<li>有的服务于能力成长</li>
<li>有的只在单个任务里作为工作区</li>
</ul>
<p><strong>它们失败的方式完全不同。</strong></p>
<p>继续用时间维度去切分，只会让架构越来越混乱。于是这篇综述提出了一个对工程师极其友好的统一框架：</p>
<blockquote>
<p><strong>Forms – Functions – Dynamics</strong></p>
</blockquote>
<p>它不问“记多久”，而是问三个更关键的问题：</p>
<hr/>
<h2 data-id="heading-2">三、Forms：记忆“放在哪里”？</h2>
<p>也就是：<strong>系统到底靠什么承载记忆？</strong></p>
<h3 data-id="heading-3">1️⃣ Token-level Memory（最常见，也是最容易翻车的）</h3>
<p>这就是我们熟悉的：</p>
<ul>
<li>向量库</li>
<li>文本片段</li>
<li>轨迹日志</li>
<li>结构化记录</li>
</ul>
<p>它的优势非常工程化：</p>
<ul>
<li>可读、可查、可改</li>
<li>易于治理</li>
<li>能和工具链集成</li>
</ul>
<p>但论文明确指出一个现实问题：</p>
<blockquote>
<p><strong>Flat memory（简单堆历史）在规模上一定会退化。</strong></p>
</blockquote>
<p>所以，真正能跑长期的系统，必然会走向：</p>
<ul>
<li><strong>结构化（Planar）</strong> ：图、表、关系</li>
<li><strong>分层抽象（Hierarchical）</strong> ：细节 + 总结并存</li>
</ul>
<p>👉 <strong>向量库只是 Flat Memory 的一种实现，不是终点。</strong></p>
<hr/>
<h3 data-id="heading-4">2️⃣ Parametric Memory（写进权重）</h3>
<p>这是把经验“内化”成模型参数：</p>
<ul>
<li>finetune</li>
<li>adapter</li>
<li>policy head</li>
</ul>
<p>优点是快、直接、无需检索；<br/>
缺点同样致命：</p>
<ul>
<li>成本高</li>
<li>不可审计</li>
<li>难以精确修改</li>
</ul>
<p>👉 <strong>它更像“长期沉淀层”，而不是日常记忆系统。</strong></p>
<hr/>
<h3 data-id="heading-5">3️⃣ Latent Memory（隐状态里的记忆）</h3>
<p>记忆存在于：</p>
<ul>
<li>隐状态</li>
<li>连续表示</li>
<li>memory tokens</li>
</ul>
<p>它介于外部存储和参数内化之间，<br/>
适合高频更新、多模态场景。</p>
<p>但工程上要清楚：</p>
<blockquote>
<p><strong>它几乎不可解释，只适合“机器自己用”。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、Functions：记忆“到底干什么用”？</h2>
<p>这是全文<strong>对工程最有价值的抽象</strong>。论文不再按时间，而是按<strong>功能失败模式</strong>，把 Agent Memory 分成三类。</p>
<hr/>
<h3 data-id="heading-7">1️⃣ Factual Memory：让 Agent 记住“世界是什么样的”</h3>
<p>这是一个<strong>可治理的事实层</strong>：</p>
<ul>
<li>用户偏好</li>
<li>环境状态</li>
<li>代码库结构</li>
<li>工具返回结果</li>
</ul>
<p>如果你做过复杂 Agent，一定知道这个痛点：</p>
<blockquote>
<p>事实一旦散落在历史对话里，就会被忘、被误引、被编造。</p>
</blockquote>
<p>Factual Memory 的价值就是：</p>
<blockquote>
<p><strong>把“可核查的世界状态”从上下文中解放出来。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">2️⃣ Experiential Memory：让 Agent 真正“吃一堑长一智”</h3>
<p>这是最容易被忽略、但<strong>最像“智能”的一类记忆</strong>。</p>
<p>它关注的不是“发生了什么”，而是：</p>
<ul>
<li>哪些策略有效</li>
<li>哪些路径是坑</li>
<li>哪种解法在什么条件下可复用</li>
</ul>
<p>论文把它拆成三层：</p>
<ul>
<li><strong>Case-based</strong>：原始轨迹</li>
<li><strong>Strategy-based</strong>：抽象方法</li>
<li><strong>Skill-based</strong>：可执行能力</li>
</ul>
<p>👉 <strong>有没有 strategy / skill memory，是区分“Agent”和“带历史的 LLM”的分水岭。</strong></p>
<hr/>
<h3 data-id="heading-9">3️⃣ Working Memory：让 Agent 在单个任务里不被信息淹没</h3>
<p>这不是“短期记忆”，而是<strong>注意力管理</strong>：</p>
<ul>
<li>面对超长文档</li>
<li>面对复杂 DOM</li>
<li>面对多工具输出</li>
</ul>
<p>Working Memory 的职责是：</p>
<ul>
<li>压缩</li>
<li>折叠</li>
<li>抽象</li>
<li>裁剪</li>
</ul>
<p>👉 本质上，它是一个<strong>推理资源调度模块</strong>。</p>
<hr/>
<h2 data-id="heading-10">五、Dynamics：为什么你的 Memory 存了却“没用”？</h2>
<p>这是很多 Agent 项目真正失败的地方。</p>
<p>论文明确指出：</p>
<blockquote>
<p><strong>Memory 不是一个模块，而是一个闭环系统。</strong></p>
</blockquote>
<p>完整生命周期是：</p>
<pre><code class="hljs">形成（Formation）
 → 演化（Evolution）
 → 检索（Retrieval）
 → 决策
 → 反馈
 → 再形成
</code></pre>
<h3 data-id="heading-11">关键工程启示只有一句话：</h3>
<blockquote>
<p><strong>没有进入决策回路的 Memory，等于不存在。</strong></p>
</blockquote>
<p>很多系统的问题不是没存，而是：</p>
<ul>
<li>检索触发策略不对</li>
<li>取回内容没被 Planner 真正使用</li>
<li>没有 evolution，记忆逐渐腐化</li>
</ul>
<hr/>
<h2 data-id="heading-12">六、下一代 Agent Memory，会往哪走？</h2>
<p>论文最后给出的判断非常明确：</p>
<ol>
<li>
<p><strong>从 Retrieval → Generation</strong></p>
<ul>
<li>不只是取旧文本，而是生成“更可用的抽象记忆”</li>
</ul>
</li>
<li>
<p><strong>从手工规则 → 自动管理</strong></p>
<ul>
<li>Agent 自己决定什么时候写、写什么、删什么</li>
</ul>
</li>
<li>
<p><strong>从 Pipeline → RL-driven Control</strong></p>
<ul>
<li>记忆操作成为可学习策略的一部分</li>
</ul>
</li>
</ol>
<p>这意味着一个重要转变：</p>
<blockquote>
<p><strong>Memory 正在从外挂，变成 Agent 能力的一部分。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-13">七、给工程师的一句话总结</h2>
<p>如果你只记住一句话，那就是：</p>
<blockquote>
<p><strong>Agent Memory 不是“存得久”，<br/>
而是“存得对、取得到、用得上、还能进化”。</strong></p>
</blockquote>
<p>当你把 Memory 当成<strong>系统级能力</strong>来设计，而不是一个检索插件时，<br/>
你做的，才是真正意义上的 Agent。</p>
<hr/>
<p>如果你也在做 Agent 系统，希望它能跑得久、学得会、行为稳定，  那请认真对待 Memory ——  它不是锦上添花，而是地基。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI智能体开发框架LangChain & LangGraph快速入门实战（包含LangSmith）]]></title>    <link>https://juejin.cn/post/7588086766247903283</link>    <guid>https://juejin.cn/post/7588086766247903283</guid>    <pubDate>2025-12-27T07:00:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766247903283" data-draft-id="7588086766247870515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI智能体开发框架LangChain &amp; LangGraph快速入门实战（包含LangSmith）"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-27T07:00:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI智能体开发框架LangChain &amp; LangGraph快速入门实战（包含LangSmith）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T07:00:49.000Z" title="Sat Dec 27 2025 07:00:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>最近乱七八糟的事太多，今天来点偏技术实战的，带大家用LangChain &amp; LangGraph快速入门用编程创建智能体，用LangSmith进行追踪，Agent-Chat构建Agent UI。</p>
<p>基本概念</p>
<p>相信大家相比于LangGraph，LangChain能更熟悉一些，毕竟LangChain出现的更早，下面先来简单介绍下这两个框架。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f7e3c0d78ce4fea82e1f5e1cf974fcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=V%2Fq%2FEXojp%2F7B8IdAzBr%2Bx9%2BxZio%3D" alt="" loading="lazy"/></p>
<p>LangChain：它是一个开发AI应用的基础框架，主要提供了开发AI应用的各种接口和工具，例如调用大模型的统一接口，提供了搜索、文档处理、向量数据库处理等工具，可以方便我们非常快速调用实现功能，加快开发速度，否则我们还得自己去封装。除此之外，LangChain还提供了链式调用（Chains）、记忆管理和提示词模版等基础功能。</p>
<p>官网地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com%2Fdocs%2Fintroduction%2F" target="_blank" title="https://python.langchain.com/docs/introduction/" ref="nofollow noopener noreferrer">python.langchain.com/docs/introd…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9d21ffc2294103a9eefd36d8cfd1a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=Y%2BuyWGNdxp4ZXawcmfJkfq6wc5c%3D" alt="" loading="lazy"/></p>
<p>LangGraph：它更高级一些，它在LangChain上面，是一个基于LangChain的工作流编排框架，可以处理复杂的工作流编排和多智能体编排。所以从名字上也可以看出来，LangChain还是停留在链式（Chain）的调用，而LangGraph则是把复杂的智能体工作流抽象成一个图（Graph）了。LangGraph的核心功能包含了有状态的工作流处理、条件分支、循环、并行执行、检查点（Checkpoints）和状态管理等处理。</p>
<p>官网地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraph/</a></p>
<p>PS：可能有些人对于上面提到的LangGraph状态管理这个概念有些模糊，在此补充解释下。状态简单理解，就是工作流执行过程中需要保存和传递的数据，每个步骤的结果都会保存，后续步骤可以访问前面步骤的结果和数据，如果某个步骤失败，可以从失败点重新开始。</p>
<p>实战</p>
<p>接下来带大家实战一个项目，让大家快速入门LangChain &amp; LangGraph生态。这里，我们开发工具就选择用Curosr了。</p>
<p>1、创建空项目，用cursor打开</p>
<p>第一步，我们在外头创建一个空项目文件夹，这里我选择叫【lang-demo】，然后用Cursor打开该文件夹。</p>
<p>2、创建虚拟环境</p>
<p>为了和其他python项目的环境进行隔离，我们用cursor的终端，使用conda命令先创建一个虚拟环境，这里我创建的虚拟环境叫clx，然后进入到该虚拟环境中。（注意，建议python版本要3.11以上，因为后续需要安装langgraph-cli[inmem]，最低版本要求3.11）。</p>
<pre><code class="hljs language-ini" lang="ini">conda create -n clx <span class="hljs-attr">python</span>=<span class="hljs-number">3.12</span>
conda activate clx
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05648e7d786a4c08931d0e8d1422958d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=3Cw9M4TFQPihDRa6vTqS%2BjFO%2B9M%3D" alt="" loading="lazy"/></p>
<p>如何判断是不是已经进入到了上面创建的虚拟环境中呢？进入后，终端的命令行前会有虚拟环境的名称。</p>
<p>3、创建requirements.txt，安装依赖</p>
<p>项目中创建requirements.txt文件，内容如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74398a9e667744e48d1a33e825e85d10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=rI899lGCEEnxxehn6dxCrCYyagM%3D" alt="" loading="lazy"/></p>
<p>然后在cursor终端输入命令安装依赖，命令如下：</p>
<pre><code class="hljs">pip3 install -r requirements.txt
</code></pre>
<p>4、创建环境变量文件</p>
<p>接下来创建【.env】文件，里面配置各处申请的key。内容如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c622b68cc9f74667b8597246c11cecd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=OWivQYcONtGscDR8NdcADAoip9s%3D" alt="" loading="lazy"/></p>
<p>其中deepseek的API Key申请参照：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3769fcbfd25242b9b52e7ce5e7cea35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=FRtzt8WoDofHiXuOzdzSknAJrGc%3D" alt="" loading="lazy"/></p>
<p>TAVILY的API Key申请参照：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94b98944f44444019254cc5d0d0eadcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=KemF6cYCw%2BKNPOFs6qZ83xFyBkY%3D" alt="" loading="lazy"/></p>
<p>LangSmith的API Key申请参照：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cdde09c07bc4efca59ab4fdc1912008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=0gnLwAJOLgPZPT5x1JPFFECIGrc%3D" alt="" loading="lazy"/></p>
<p>5、使用cursor生成一个LangChain &amp; LangGraph的demo</p>
<p>对，你没看错，这里不是给大家讲我本地的项目如何做的，而是让大家用Cursor去给自己生成一个，并调试通，所以最后每个人的Demo肯定是不一样的。我生成Demo的Prompt如下：</p>
<pre><code class="hljs language-bash" lang="bash">请给我生成一个LangChain和LangGraph的Demo，要求如下：
1、尽可能多的用上【requirements.txt】和【.<span class="hljs-built_in">env</span>】的技术内容进行设计。
2、Demo尽量简单，适合学习用，方便理解。
3、需要包含【README.md】文件，对项目结构和核心代码进行说明。
4、包含运行Demo的快捷入口文件。
</code></pre>
<p>然后就看Cursor发挥了，第一次生成后肯定跑不通，需要不停的让cursor进行调试，因为是Demo性质的，相对简单，逻辑也不会太复杂，一般在10轮Prompt交互之内即可得到Cursor创建的可正确运行的项目。</p>
<p>最后给大家演示下，给我生成的项目是什么功能：</p>
<p>给我生成了一个【run_demo.py】入口文件，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bc106630c1442acb5758c11bb9a0831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=bknEa%2FanY5h6%2F8NVe7wHkjOTtvU%3D" alt="" loading="lazy"/></p>
<p>用python命令运行：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d90da2840b474dd78d07cb1ad47ba114~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=ERsHDl9McnXxfsoYC9j3kNpUDYA%3D" alt="" loading="lazy"/></p>
<p>我选择【1】，然后输入我的问题：天空为什么是蓝色的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e55795c84684059b65493b9ef5796b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=j%2FkRyaVs0K4U3iDSUz8m2SkGbLA%3D" alt="" loading="lazy"/></p>
<p>然后根据我的问题，Demo会识别主题是我的问题是一个简单的问答【general_chat】，调用模型给我回复了答案。除此之外，还对数据进行了分析，最后生成了一个可视化图表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bfb42312eec4ce2b5037a9fb1cab21b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=uG037WDrEAiGaRshghd0iyyoUig%3D" alt="" loading="lazy"/></p>
<p>图表：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b1733d00cbd4b79bffb1341c61d0350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=JJgHwnMLmC9yeNZlfc4rEhcFHOs%3D" alt="" loading="lazy"/></p>
<p>然后，我继续测试，换一个问题，问一个需要联网搜索的，例如我提问：请帮我搜索今天的热点AI新闻有哪些。然后他就会识别为【Search】主题，给我联网搜索生成结果，对数据进行分析后生成可视化图表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c47af2e3fef349d39d3557266648a98c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=eFNJTXU4GE6QZULR1TZqMIdU9yQ%3D" alt="" loading="lazy"/></p>
<p>到这里，我的Demo就演示完了，然后呢，如何方便你快速了解项目呢，当然从让其生成的【README.md】文件了。</p>
<p>Readme中介绍了项目的基本功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e0ab7820f2740db8854c52123a97c44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=5WqvtDUIDL1EUNQL%2BrX6SRPGsDc%3D" alt="" loading="lazy"/></p>
<p>对项目的调用流程进行了说明。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/070314dcec8845fd85ffb3b55d3fadfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=rk4Y2%2FhWPAWL47rmGN0Afh2ePM0%3D" alt="" loading="lazy"/></p>
<p>说明了项目在哪使用了LangChain，都做了什么，并且对应的代码是多少行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0cfb3b8f2124cd088141d4f05780c7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=eB2oIIBTriU9T0vXkqypK9qCccA%3D" alt="" loading="lazy"/></p>
<p>还说明了项目哪里使用了LangGraph，都做了什么，并且对应的代码是多少行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a0aeb4bb0c346ed8b116be2f473298b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=7lrRX0KnEN7bBttJFTuchlvhP20%3D" alt="" loading="lazy"/></p>
<p>具体不详细介绍了，给我生成的Readme中已经写的很详细了，完全可以看懂，下面总结说明下，给我生成的Demo代码哪些地方用到了LangChain，哪些地方用到了LangGraph。</p>
<p>LangChain相关：</p>
<ul>
<li>使用LangChain中ChatDeepSeek与模型进行交互。</li>
<li>集成LangChain中TavilySearch工具进行搜索。</li>
<li>使用langchain_core.messages统一消息格式。</li>
</ul>
<p>LangGraph相关：</p>
<ul>
<li>进行状态管理。</li>
<li>进行工作流编排。</li>
<li>进行状态传递。</li>
</ul>
<p>到此为止，给大家演示了Cursor给我生成的LangChain&amp;LangGraph Demo。</p>
<p>6、Langgraph-cli和LangSmith的使用</p>
<p>下面我们继续，在控制台安装库langgraph-cli，方便后续调试和用LangSmith来追踪我们的项目。安装命令如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">pip3 install -U <span class="hljs-string">"langgraph-cli[inmem]"</span>
</code></pre>
<p>安装后输入下面命令启动项目：</p>
<pre><code class="hljs">langgraph dev
</code></pre>
<p>启动后会发现有三个重要的路径，其中第一个和第三个是可以打开的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a1d3bacfd3d4b708162ddb1bd6ae90d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=rBI585MZuRUPtuqzrZ%2Fq7rpknK4%3D" alt="" loading="lazy"/></p>
<p>第一个是项目API的Endpoint，打开后显示Not Found，这是正常的。因为默认没有这个get请求，不会重定向到任何地方，但是既然有结果返回，说明API的Endpoint是通的。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A2024%2F" target="_blank" title="http://127.0.0.1:2024/" ref="nofollow noopener noreferrer">http://127.0.0.1:2024</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f61df5922434a02813215566939982f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=PdmiY3Xk38sBw50ikjdkpmLsyjE%3D" alt="" loading="lazy"/></p>
<p>第三个可以打开，打开后是LangGraph的API文档说明，并且可以在线测试API，这里就不给大家演示了，很简单。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A2024%2Fdocs" target="_blank" title="http://127.0.0.1:2024/docs" ref="nofollow noopener noreferrer">http://127.0.0.1:2024/docs</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ea611d93c40400b9ff462b1a7e0751f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=9lw7S9wl5xVtEdY4P8XT5FPfRPg%3D" alt="" loading="lazy"/></p>
<p>但是第二个需要特殊说明，我们路径可以打开，但是获取不到项目的内容，这个肯定是不正常的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2Fstudio%2F%3FbaseUrl%3Dhttp%3A%2F%2F127.0.0.1%3A2024" target="_blank" title="https://smith.langchain.com/studio/?baseUrl=http://127.0.0.1:2024" ref="nofollow noopener noreferrer">smith.langchain.com/studio/?bas…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8694cace6e5445d9f44a9c0ee380ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=TkcQJLCGmsIXd0qdnrqT0xwPaXg%3D" alt="" loading="lazy"/></p>
<p>有一定软件基础能力的人很容易可以判断出来，因为下面这个路径跨域了，smith平台是不可能获取你本地服务API EndPoint的，访问不了很正常。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2Fstudio%2F%3FbaseUrl%3Dhttp%3A%2F%2F127.0.0.1%3A2024" target="_blank" title="https://smith.langchain.com/studio/?baseUrl=http://127.0.0.1:2024" ref="nofollow noopener noreferrer">smith.langchain.com/studio/?bas…</a></p>
<p>所以为了解决这个问题，我们需要改一下启动的命令，使用下面命令启动：</p>
<pre><code class="hljs language-css" lang="css">langgraph dev <span class="hljs-attr">--tunnel</span>
</code></pre>
<p>这次启动后大家可以看到，路径更长了，而且并不是之前本地的ip了，而是换成公网可访问的cloudflare的地址。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2Fstudio%2F%3FbaseUrl%3Dhttps%3A%2F%2Fjournalists-utilities-magnetic-seemed.trycloudflare.com" target="_blank" title="https://smith.langchain.com/studio/?baseUrl=https://journalists-utilities-magnetic-seemed.trycloudflare.com" ref="nofollow noopener noreferrer">smith.langchain.com/studio/?bas…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/985e7b107a1444299457130ea4ac58b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=BWTaRVsQ8ww4pxMREk%2BZa9EmJLs%3D" alt="" loading="lazy"/></p>
<p>这样，langsmith平台就可以正常地加载了。加载后大家可以看到，你也的业务流程完全变成了可追踪的可视化工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/235365a7587f4d8a8147b895b63ec096~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=3JGYw3Qqt97mx1Xgb05brFyrOVw%3D" alt="" loading="lazy"/></p>
<p>然后，我就可以输入问题，在这个平台上进行调试，例如在对应的传递参数的地方，我提问：天为什么会下雨，在此平台就可以连接到你本地的工程，进行可视化调试和输出了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fc9cbabcae945878ac3fa4db074fe53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=1%2Bbdmuyp%2BlrTWAo4QkiAcYSu3VA%3D" alt="" loading="lazy"/></p>
<p>并且可以切换到【Trace】选项卡查看其运行轨迹，进行追踪。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e0b0a6ca104862859f966a3ab443e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=6I%2FnW5WaVXGwLMEfG8X%2Fuq6h%2BpY%3D" alt="" loading="lazy"/></p>
<p>除此之外，现在你把这个页面关闭。然后再次进入到LangSmith的主页，点击【Tracing Projects】，也可以看到之前运行追踪的记录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9672ed6f2286409b8bb7b25d1aad4626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=vMXofsZmcJQLFaRBFvavn%2BlqUwc%3D" alt="" loading="lazy"/></p>
<p>这意味着什么呢？这意味着只要你用【langgraph dev】启动了你本地的工程，你在何处访问你的项目，都会自动进行行为追踪并且在LangSmith平台上进行查看。</p>
<p>解惑：</p>
<p>大家通过我上面的操作，是不是感觉很神奇，都会存在这种疑问，不是一直在讲LangChain吗，怎么突然来了LangSmith，它是干嘛的，感觉像可以追踪行为用的，那我的项目，又是何时与LangSmith平台进行的联系呢？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c557705d05f48aebedab0e861ffef29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=EXdyuP4W%2FiPKCy7hT2KI0TvuX%2Bs%3D" alt="" loading="lazy"/></p>
<p>LangSmith：其实我不用过多解释，通过上面的演示大家也能够感受到。LangSmith大家理解成一个在线监控和调试平台即可，提供了在线调试Debug（上面演示的工作流在线输入为什么会下雨的例子，可看到流程中每一步的结果）、Trace追踪（上面例子中的调用链路，可追溯）、还有生产监控Monitoring（上线后追踪用户真实交互，方便后续优化智能体）和评估Evaluation（支持对不用的Prompt/模型/AB测试/质量等进行评估）。</p>
<p>那如何建立的联系呢，大家最早在上面还有印象吧，让大家在【.env】中配置了LangSmith的相关信息，而且Tracing还设置为了True。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09f156afdedf49f390daa6a80c4e06f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=yU8wKEnKPzRJNjBk02EkBXXFgrk%3D" alt="" loading="lazy"/></p>
<p>在生成的代码逻辑中，通过这些参数，就让你的工程与LangSmith平台关联上了。</p>
<p>代码中引入追踪的注解，在想追踪的方法上添加注解皆可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/744923bdde6340e2ad1676853be6c3ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=5O%2BysUWYxGkGvmx27h3w0NyWb9k%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4126cec3f24ce8b1470f10688b8d0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=aYt3OyNzjBt1PXzA889gcPnR7Y8%3D" alt="" loading="lazy"/></p>
<p>官网写的更是详细如何接入，包括未给大家演示的评估Evaluation功能，在此不详细解释了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4bc3c2693d42128606f5b9b358e2c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=jodccnC9y1vcTMfjuLKBn4OTxgo%3D" alt="" loading="lazy"/></p>
<p>到这里，才算是，LangChain、LangGraph和LangSmith讲完了。</p>
<p>7、扩展部分：agent-chat UI的使用</p>
<p>这一部分属于拓展部分，刚才我们写的Agent事实上是没有UI的。LangChain生态也是想到了这一点，所以官方还推出了一个Agent-Chat开源项目，可以快速构筑UI，关联到我们刚才本地创建的智能体。</p>
<p>项目地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Fagent-chat-ui" target="_blank" title="https://github.com/langchain-ai/agent-chat-ui" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5d3b2f3a8c4420c9fe8a05809f21c45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=eUyMrS6hB6C3Lr72ieQ%2FejwE9uI%3D" alt="" loading="lazy"/></p>
<p>使用和安装也是非常的简单，官网上写的很清楚，先clone项目到本地，然后进入到项目目录后，通过【pnpm install】进行安装，通过【pnpm dev】启动该项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c28487968f1a4074b792a0205aed6e6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=yEtyvnn0bYb7Ok%2BP4v4Vn5gUeKo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb836971bc584630a7cf437fc5b2d69c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=QzSgXlb3pEpe6dl2dlC%2FWRf9d%2BI%3D" alt="" loading="lazy"/></p>
<p>启动成功后，即可通过3000端口进行访问。访问后，主页面上配置启动本地服务地址、项目ID与LangSmith API Key即可连接到本地启动的智能体。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d94e2b923a6463ba1ca3e23136d1c8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=0BMgw8QhITy7cGMXxjhblWNmwXg%3D" alt="" loading="lazy"/></p>
<p>配置成功后，我们就可以正常提问了，例如我下面问的：地球为什么是圆的。给我正常响应，并且在后台工程中也进行了数据分析和生成了图表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3baba27d0fa941ab949a0e142f46fe54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767423649&amp;x-signature=jjU%2B4kliChwKvbor%2F%2FQ6gxmh894%3D" alt="" loading="lazy"/></p>
<hr/>
<p>总结下今天的内容，我们从0创建了一个空的项目，并且借助于Cursor，让其给我们生成了一个LangChain和LangGraph的Demo，除此之外，我们还关联到了LangSmith平台进行调试和追踪，最后通过Agent-Chat快速构建了UI去使用。</p>
<h2 data-id="heading-0">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从"手艺人"到"超级个体":我在小破站用AI重构工作方式的2025]]></title>    <link>https://juejin.cn/post/7587997157237866548</link>    <guid>https://juejin.cn/post/7587997157237866548</guid>    <pubDate>2025-12-27T05:44:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237866548" data-draft-id="7588004376867389475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从&quot;手艺人&quot;到&quot;超级个体&quot;:我在小破站用AI重构工作方式的2025"/> <meta itemprop="keywords" content="OpenAI,AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-27T05:44:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="泯泷"/> <meta itemprop="url" content="https://juejin.cn/user/317122698296024"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从"手艺人"到"超级个体":我在小破站用AI重构工作方式的2025
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/317122698296024/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    泯泷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:44:47.000Z" title="Sat Dec 27 2025 05:44:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年即将画上句号。回望这一年，技术领域的变革浪潮从未停歇。作为一名深耕在一线代码中的开发者，我不想重复那些宏大的行业叙事，而是希望通过复盘我在小破站的实际工作经历，探讨一个更具体的话题：<strong>在 AI 深度赋能的时代，我们如何完成从“代码手艺人”到“超级个体”的进阶？</strong></p>
<h3 data-id="heading-0">上半年实战：JSVMP + WASM 构建前端安全防线</h3>
<p>上半年的核心关键词是<strong>攻防</strong>。前端风控验证 SDK 的开发既充满趣味，又极具挑战。面对黑产从业者试图直接破解接口的攻击行为，常规的代码混淆手段已显得捉襟见肘。</p>
<p>为了构建更坚固的防御体系，我们引入了 <strong>JSVMP (JavaScript Virtual Machine Protection)</strong> 技术。该技术通过将核心业务逻辑虚拟化，使得逆向工程的成本呈指数级上升。通过监控数据的对比，我们清晰地看到了防御效果的显著提升。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JSVMP 概念示意：将源码编译为自定义指令集</span>
<span class="hljs-comment">// 原始代码：</span>
<span class="hljs-comment">// function check(token) { return token === 'secret'; }</span>

<span class="hljs-comment">// 虚拟化后（示意）：</span>
<span class="hljs-keyword">const</span> _vm_instructions = [<span class="hljs-number">0xA1</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0xB3</span>, ...]; <span class="hljs-comment">// 自定义字节码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">_vm_executor</span>(<span class="hljs-params">instructions, context</span>) {
  <span class="hljs-comment">// 虚拟堆栈执行器，攻击者难以还原原始逻辑</span>
  <span class="hljs-keyword">while</span>(pc &lt; instructions.<span class="hljs-property">length</span>) { <span class="hljs-comment">/* ... */</span> }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d63d5cee2f6473ebc979ae2875eb5d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOv5rO3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767419110&amp;x-signature=EjJ2K%2FRlb3yy9X6ZLzHieUbwh%2BQ%3D" alt="9d10f263d07e71fbd76830816874b06733fa40d74127f8d2d915cb5f41260f36.png" loading="lazy"/></p>
<p>与此同时，为了进一步提升设备认证的安全性和准确性，我们在现代浏览器环境中探索了 <strong>WASM (WebAssembly)</strong> 的工程化落地。这不仅带来了性能上的优化，更利用 WASM 的二进制特性构建了新的安全防线。</p>
<p>值得一提的是，我们的 WASM 模块采用 <strong>Rust</strong> 语言编写。从严格的所有权系统到内存安全机制，再到零成本抽象，Rust 的设计哲学极大地保障了代码的健壮性。虽然学习曲线陡峭，但当 Rust 代码通过编译器严苛的检查后，那种“编译通过即运行正确”的信心是其他语言难以比拟的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff4f55088b8b40d68afebf6bb68dd3dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOv5rO3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767419110&amp;x-signature=jX9e%2BB4qmdwBXpeCp6wN4UbVqLI%3D" alt="Rust-WASM技术栈" loading="lazy"/></p>
<h3 data-id="heading-1">下半年攻坚：重构富文本编辑器与协同技术</h3>
<p>下半年，我的技术重心转移到了前端领域公认的高复杂度场景——<strong>富文本编辑器</strong>。</p>
<p>任何深入过编辑器开发的工程师都知道，这不仅关乎 UI 交互，更是一场关于数据结构设计与状态管理的深度博弈。我们的核心任务是迭代“哔哩哔哩小站”，并对 B 站历史悠久的<strong>专栏编辑器</strong>进行现代化重构。</p>
<p>在此期间，我们需要攻克 Tiptap 框架的深度定制以及 CRDT（Conflict-free Replicated Data Types）协同算法的预研等技术难点。我们为新版编辑器扩展了丰富的<strong>卡片式组件 (Node Views)</strong> 能力——支持视频、投票、商品卡片等多种内容形态。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Tiptap 自定义节点扩展示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span>, mergeAttributes } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/core'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ReactNodeViewRenderer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tiptap/react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">BilibiliVideo</span> = <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'bilibiliVideo'</span>,
  <span class="hljs-attr">group</span>: <span class="hljs-string">'block'</span>,
  <span class="hljs-attr">atom</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 视为原子节点</span>

  <span class="hljs-title function_">addAttributes</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">bvid</span>: { <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> },
    }
  },

  <span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用 UI 组件渲染节点视图</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">VueNodeViewRenderer</span>(<span class="hljs-title class_">VideoComponent</span>)
  },
})
</code></pre>
<p>其中一个显著的体验提升是实现了<strong>视频在编辑器内的原生播放</strong>。为了实现这一“所见即所得”的效果，技术团队克服了复杂的 DOM 事件冲突与状态同步问题，彻底消除了创作者需要频繁切换预览模式的痛点。这种对细节的极致打磨，最终换来了流畅的用户体验。</p>
<h3 data-id="heading-2">AI 赋能：从辅助工具到“第二大脑”</h3>
<p>对于我而言，2025 年的 AI 已经不再是新鲜的试验品，而是如同 IDE 一般不可或缺的生产力工具。</p>
<p>我全面拥抱了 <strong>"Vibe Coding"</strong>（灵感编程）的工作模式——这个词正是 Andrej Karpathy 发明的。他在最近的推文中感叹“<strong>作为程序员，我从没感觉自己这么落后过</strong>”，因为行业正在被 <strong>agents、subagents、contexts、memory、MCP</strong> 等 15 个新概念剧烈重构。正如他所喻，我们手中正握着一个**“没有说明书的外星工具”**，每个人都需要建立新的心智模型来驾驭它。</p>
<p>我的开发工具链也经历了深度迭代。虽然 Cursor 曾是主力，但 <strong>Claude Code</strong> 凭借 <strong>Opus 4.5 <strong>模型在长上下文下的稳定性（低随机性）与更友好的计费模式，成为了我的首选。正如业内讨论的那样，Context（上下文）管理是新时代的核心技能。我不只依赖单一工具，而是根据任务特性组合使用：用 Claude Code 处理复杂逻辑，用 Codex 辅助后端思考，甚至并行运行多个 Agent。这种“多模型编排”的能力，极大地释放了编码生产力，使我进入了</strong>月均代码产出 3-5 万行</strong> 的“超级个体”模式。特别是在基于 Tiptap 的编辑器开发中，AI 帮助我快速生成了大量的样板代码与类型定义，让我能专注于核心逻辑的设计。</p>
<p>而 <strong>Gemini</strong> 则更多扮演了架构师的角色。在进行技术方案设计时，我会利用它来发散思路、查漏补缺。AI 的存在，极大地降低了技术验证的成本。DeepWiki 辅助阅读源码，也让技术调研的效率提升了一个维度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f828863dd638439d8b533501399f99e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rOv5rO3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767419110&amp;x-signature=Snk0vxZ%2BK4Ewg%2F64pm9Tet58kNQ%3D" alt="AI辅助开发工作流" loading="lazy"/></p>
<h3 data-id="heading-3">总结与展望：技术回归创作</h3>
<p>站在 2025 年的节点上，新版专栏编辑器的上线既是一个阶段的终点，也是新的起点。</p>
<p>展望明年，我计划在以下方向持续深耕：</p>
<ol>
<li>
<p><strong>深度协同</strong>：探索 ToB 场景下的实时协作技术；</p>
</li>
<li>
<p><strong>智能创作</strong>：将 AI 辅助创作深度融入编辑器核心，打造更“懂”创作者的智能工具。</p>
</li>
</ol>
<p>观察当下的行业生态，开发者们正走向不同的命运分支：有的“传统精英”受困于旧有心智模型而感到焦虑，有的“前端边缘型”选手却因 AI 补全了能力短板而如鱼得水。要完成从“手艺人”到“超级个体”的跃迁，核心在于<strong>接受不确定性</strong>——学会与“有时候能行、有时候不行”的系统共舞，将技能点从单纯的代码实现转移到对 AI 的<strong>编排（Orchestration）与快速迭代验证</strong>上。别做那个固执抵抗的落后者，去成为新城市的建造者。</p>
<p><strong>你是否也准备好拥抱 AI，重构你的工作方式了？</strong> 少一分无谓的焦虑，多一份对技术的好奇与实践。这就是我的 2025 年答卷。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go单协程事件调度器：游戏后端的无锁有序与响应时间掌控]]></title>    <link>https://juejin.cn/post/7588028859541176346</link>    <guid>https://juejin.cn/post/7588028859541176346</guid>    <pubDate>2025-12-27T05:59:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541176346" data-draft-id="7588067055481421833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go单协程事件调度器：游戏后端的无锁有序与响应时间掌控"/> <meta itemprop="keywords" content="后端,游戏开发"/> <meta itemprop="datePublished" content="2025-12-27T05:59:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go单协程事件调度器：游戏后端的无锁有序与响应时间掌控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T05:59:12.000Z" title="Sat Dec 27 2025 05:59:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Go单协程事件调度器：游戏后端的无锁有序与响应时间掌控</h2>
<p>在游戏后端架构设计中，<strong>单协程（单线程）事件调度器（Event Loop）</strong> 是实现 “<strong>绝对消息顺序</strong>” 与 “<strong>无锁状态管理</strong>” 的核心方案。</p>
<p>相较于多线程模型所面临的锁竞争、竞态条件、数据一致性等复杂问题，单协程调度器通过 完全串行化执行 所有核心逻辑，从根本上规避了并发安全风险——这一特性对于对状态准确性要求极高的游戏场景（如玩家血量、金币、技能释放结果、战斗胜负判定）具有决定性意义。</p>
<p>然而，串行执行也带来了严苛的约束：<strong>任何一个事件的处理延迟，都会直接放大为全服玩家的体验损耗</strong>。因此，单协程调度器的核心设计目标，是在保证逻辑有序性的前提下，<strong>极致控制响应时间，守住系统稳定性红线</strong>。</p>
<h3 data-id="heading-1">一、响应时间控制：单协程调度的生命线</h3>
<p>单协程 Event Loop 的性能瓶颈，本质上是 “<strong>时间切片的极致分配</strong>”。其中：</p>
<ul>
<li><strong>单个事件的处理时间</strong>应控制在 **100 微秒（μs）**以内；</li>
<li>**逻辑帧（Tick）**周期则依游戏类型灵活调整，通常为 <strong>15–50 毫秒（ms）</strong>。</li>
</ul>
<p>在高性能游戏后端中，<strong>1 毫秒（ms）</strong> 是不可逾越的红线。一旦单个事件处理耗时超过 1ms，即被判定为“重度任务”。原因在于：</p>
<ul>
<li>单协程的串行执行决定了：<strong>一个阻塞事件会延迟所有后续事件的处理</strong>——无论是玩家的 WebSocket 操作、gRPC 外部调用，还是游戏世界的心跳定时器。</li>
<li>对玩家而言，1ms 的卡顿可能表现为“技能释放延迟”、“角色移动粘滞”；对系统而言，每秒仅能处理 ≤1000个 此类任务，<strong>严重拉低全服并发承载能力</strong>。</li>
</ul>
<blockquote>
<p>可以形象地说：逻辑线程中的 1ms，堪比现实世界的 1 小时。守住这条红线，就是守住玩家体验与系统稳定性的根基。</p>
</blockquote>
<h4 data-id="heading-2">1.1 核心事件耗时指标与影响分级</h4>
<p>不同耗时的事件对系统的影响差异巨大，以下是经过行业实践验证的分级标准，可直接作为研发过程中的性能评估依据：</p>



































<table><thead><tr><th>指标等级</th><th>处理耗时</th><th>典型场景</th><th>影响评估</th></tr></thead><tbody><tr><td>理想级</td><td>&lt; 50 μs</td><td>纯内存读写、简单属性修改（如玩家坐标更新、道具使用扣除、基础状态判定）</td><td>极快且无负担，是单协程事件的最优目标，可支持极高并发处理</td></tr><tr><td>安全级</td><td>50 - 200 μs</td><td>少量复杂计算（如2D网格AOI（兴趣区域）周边玩家快速查询、多属性联动更新）</td><td>性能安全可控，即使瞬时并发增加，也不会导致逻辑帧波动</td></tr><tr><td>警戒级</td><td>200 μs - 1 ms</td><td>多条件筛选查询（如玩家背包内符合特定标签的道具统计）、简单战斗数值计算</td><td>略慢，单事件影响有限，但大量此类事件并发时，会引发逻辑帧抖动（Jitter），导致系统响应不稳定</td></tr><tr><td>危险级</td><td>&gt; 1 ms</td><td>未优化的大规模战斗技能结算、全服玩家数据遍历、无缓存的复杂查询</td><td>直接阻塞系统：单协程每秒仅能处理不足1000个此类任务，玩家可明显感知延迟，严重时引发全服卡顿</td></tr></tbody></table>
<h4 data-id="heading-3">1.2 指标背后的逻辑：基于游戏帧的预算计算</h4>
<p>上述指标并非凭空设定，而是基于 <strong>“逻辑帧（Tick）</strong>” 的预算分配模型推导而来。</p>
<p>以行业常见的 <strong>20Hz（每秒 20 帧）</strong> 为例：</p>
<ul>
<li><strong>单帧总时间</strong>：1000 ms ÷ 20 = <strong>50 ms / 帧</strong></li>
<li><strong>安全预留</strong>：为应对消息突发、GC、系统调度等不确定性，通常仅分配 <strong>50% 预算（25 ms）</strong> 给业务逻辑</li>
<li><strong>单事件平均上限</strong>：若单帧需处理 500 条消息，则每条平均耗时 ≤ 25 ms ÷ 500 = 50 μs</li>
</ul>
<p>这正是“理想级”设定为 50 μs 的根本原因。</p>
<p>不同游戏类型对应不同帧率与预算：</p>





























<table><thead><tr><th>游戏类型</th><th>建议帧率</th><th>单帧预算</th><th>单事件建议上限（500 QPS）</th></tr></thead><tbody><tr><td>竞技类（MOBA/射击）</td><td>30–60 Hz</td><td>16–33 ms</td><td>&lt; 33 μs</td></tr><tr><td>中度交互类</td><td>20 Hz</td><td>25 ms</td><td>&lt; 50 μs</td></tr><tr><td>休闲/挂机类</td><td>10 Hz</td><td>50 ms</td><td>&lt; 100–200 μs</td></tr></tbody></table>
<blockquote>
<p>工程建议：在架构设计初期就应根据游戏类型明确帧预算，并将该指标纳入 CI/CD 性能门禁。</p>
</blockquote>
<h4 data-id="heading-4">1.3 超时事件的解决方案：三大核心优化策略</h4>
<p>实际业务中，部分逻辑（如跨服战斗结算、全服数据统计）难以压缩至 1ms 内。此时需通过 “<strong>非阻塞化</strong>” 手段拆解压力：</p>
<h5 data-id="heading-5">策略A：任务切片（Time Slicing）—— 大任务拆分为小帧执行</h5>
<ul>
<li><strong>思路</strong>：将长任务拆分为多个子任务，<strong>分散到多个逻辑帧中逐步完成</strong>。</li>
<li><strong>场景</strong>：全服发奖（10 万玩家）、跨服排行榜计算。</li>
<li><strong>关键点</strong>：
<ul>
<li>按 <strong>“安全级”耗时</strong> 拆分（如每帧处理 500 人，耗时 &lt; 50 μs）</li>
<li><strong>持久化进度</strong>（如“已处理至 UID=3200”），支持断点续做</li>
<li>重启后可从断点恢复，确保 <strong>幂等性与一致性</strong></li>
</ul>
</li>
</ul>
<h5 data-id="heading-6">策略B：异步卸载（Offloading）—— 计算任务移交至Worker协程</h5>
<ul>
<li><strong>思路</strong>：主协程仅做 <strong>调度与状态管理</strong>，将无状态/弱状态计算卸载至 Worker Pool。</li>
<li><strong>场景</strong>：A* 寻路、视野 AOI 计算、伤害公式结算、排行榜权重。</li>
<li><strong>关键点</strong>：
<ul>
<li>主协程与 Worker 通过 <strong>带缓冲通道</strong> 通信，<strong>绝不阻塞主循环</strong></li>
<li>Worker 返回结果后，主协程需 <strong>校验状态时效性</strong>（如玩家是否已离线）</li>
<li>Worker 数量建议 ≤ CPU 核数，避免调度开销反超收益</li>
</ul>
</li>
</ul>
<h5 data-id="heading-7">策略C：数据预处理—— 空间换时间，规避实时计算</h5>
<ul>
<li><strong>思路</strong>：<strong>提前缓存高频查询结果</strong>，避免运行时遍历或复杂计算。</li>
<li><strong>场景</strong>：工会最高等级玩家、战力 Top100、常用道具统计。</li>
<li><strong>关键点</strong>：
<ul>
<li>在 <strong>数据变更时增量更新缓存</strong>（如玩家升级 → 更新工会缓存）</li>
<li>采用 <strong>读多写少</strong> 策略；若写频率过高（如实时伤害），预处理收益将被更新成本抵消</li>
<li>可结合 <strong>LRU + 定时刷新</strong> 机制，平衡一致性与性能</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">二、优先级控制：保障核心体验的调度逻辑</h3>
<p>单协程的串行特性决定了 <strong>事件处理顺序</strong> = <strong>玩家体验质量</strong>。若后台统计占用帧预算，将直接导致玩家操作延迟——这是不可接受的。</p>
<p>因此，必须实施 <strong>三级优先级调度</strong>：</p>
<h4 data-id="heading-9">2.1 第一优先级（High）：玩家实时交互指令（WebSocket）</h4>
<ul>
<li><strong>场景</strong>：移动、技能释放、道具使用、NPC 对话</li>
<li><strong>理由</strong>：直接影响“操作手感”，端到端延迟应 &lt; 100 ms</li>
<li><strong>策略</strong>：
<ul>
<li>投递至 <code>highChan</code></li>
<li>主循环 <strong>优先清空 highChan</strong></li>
<li>若堆积 &gt; 100 条，触发告警并 限流低优先级投递</li>
</ul>
</li>
</ul>
<h5 data-id="heading-10">2.2 第二优先级（Medium）：游戏世界心跳定时器（Timer）</h5>
<ul>
<li><strong>场景</strong>：怪物 AI、技能 CD、回血回蓝、战斗同步、全服活动</li>
<li><strong>理由</strong>：驱动游戏世界运转，延迟会导致“时间轴错乱”</li>
<li><strong>策略</strong>：
<ul>
<li>投递至 <code>midChan</code></li>
<li>在 highChan 为空后处理</li>
<li>定时器分桶（如 100 ms / 1 s / 5 s 组），避免集中触发</li>
</ul>
</li>
</ul>
<h5 data-id="heading-11">2.3 第三优先级（Low）：外部请求与异步回调</h5>
<ul>
<li><strong>场景</strong>：gRPC 查询、DB/Redis 回调、全服统计、日志上报</li>
<li><strong>理由</strong>：对实时性不敏感，可容忍毫秒级延迟</li>
<li><strong>策略</strong>：
<ul>
<li>投递至 <code>lowChan</code></li>
<li>仅在 high + mid 为空时处理，或每帧末尾分配 ≤ 2 ms 预算</li>
<li>若堆积 &gt; 1000 条，可丢弃非关键事件（如在线人数统计）</li>
</ul>
</li>
</ul>
<h5 data-id="heading-12">2.4 关键补充：避免优先级倒置</h5>
<ul>
<li>❌ 禁止低优先级事件持有 长时间资源（如 DB 连接）</li>
<li>❌ 禁止在低优先级中 触发高优先级事件（如统计时发推送）</li>
<li>✅ 对低优先级事件设置 最大处理时长（如 500 μs），超时则移交下一帧</li>
</ul>
<blockquote>
<p>优先级不是建议，而是玩家体验的护栏。</p>
</blockquote>
<h3 data-id="heading-13">三、实践参考：Go单协程事件调度器实现</h3>
<p>基于上述设计，可利用 Go 的 channel + goroutine 特性，构建轻量、高效、确定性的事件调度器。</p>
<h4 data-id="heading-14">3.1 核心设计</h4>
<ul>
<li>三通道分优先级：<code>highChan</code> / <code>midChan</code> / <code>lowChan</code>（均带缓冲）</li>
<li>统一事件结构：含处理函数、优先级、创建时间（用于监控）</li>
<li>主循环调度：优先消费 high → mid → low，并严格控制帧耗时</li>
</ul>
<h4 data-id="heading-15">3.2 参考代码</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"time"</span>
)

<span class="hljs-keyword">const</span> (
	PriorityHigh = <span class="hljs-literal">iota</span>
	PriorityMedium
	PriorityLow
)

<span class="hljs-keyword">const</span> (
	FrameInterval = <span class="hljs-number">50</span> * time.Millisecond <span class="hljs-comment">// 20 Hz 逻辑帧</span>
	FrameBudget   = <span class="hljs-number">25</span> * time.Millisecond <span class="hljs-comment">// 预留50%安全缓冲</span>
	MaxLowTime    = <span class="hljs-number">2</span> * time.Millisecond  <span class="hljs-comment">// 低优先级最多占用 2 ms / 帧</span>
)

<span class="hljs-keyword">type</span> Event <span class="hljs-keyword">struct</span> {
	Handler   <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>
	Priority  <span class="hljs-type">int</span>
	CreatedAt time.Time
}

<span class="hljs-keyword">type</span> EventLoop <span class="hljs-keyword">struct</span> {
	highChan <span class="hljs-keyword">chan</span> *Event
	midChan  <span class="hljs-keyword">chan</span> *Event
	lowChan  <span class="hljs-keyword">chan</span> *Event
	quit     <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEventLoop</span><span class="hljs-params">()</span></span> *EventLoop {
	<span class="hljs-keyword">return</span> &amp;EventLoop{
		highChan: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Event, <span class="hljs-number">1000</span>),
		midChan:  <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Event, <span class="hljs-number">1000</span>),
		lowChan:  <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Event, <span class="hljs-number">1000</span>),
		quit:     <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}),
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(el *EventLoop)</span></span> Submit(event *Event) {
	ch := el.lowChan
	<span class="hljs-keyword">switch</span> event.Priority {
	<span class="hljs-keyword">case</span> PriorityHigh:
		ch = el.highChan
	<span class="hljs-keyword">case</span> PriorityMedium:
		ch = el.midChan
	}
	<span class="hljs-keyword">select</span> {
	<span class="hljs-keyword">case</span> ch &lt;- event:
	<span class="hljs-keyword">default</span>:
		log.Printf(<span class="hljs-string">"Priority %d channel full, dropping event"</span>, event.Priority)
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(el *EventLoop)</span></span> Start() {
	ticker := time.NewTicker(FrameInterval)
	<span class="hljs-keyword">defer</span> ticker.Stop()
	log.Println(<span class="hljs-string">"EventLoop started"</span>)

	<span class="hljs-keyword">for</span> {
		<span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &lt;-el.quit:
			log.Println(<span class="hljs-string">"EventLoop stopped"</span>)
			<span class="hljs-keyword">return</span>
		<span class="hljs-keyword">case</span> &lt;-ticker.C:
			el.processFrame()
		}
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(el *EventLoop)</span></span> Stop() {
	<span class="hljs-built_in">close</span>(el.quit)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(el *EventLoop)</span></span> processFrame() {
	frameStart := time.Now()

	<span class="hljs-comment">// 1. 处理 High 优先级（直到空）</span>
	<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(el.highChan) &gt; <span class="hljs-number">0</span> {
		ev := &lt;-el.highChan
		ev.Handler()
		<span class="hljs-keyword">if</span> time.Since(frameStart) &gt;= FrameBudget {
			log.Println(<span class="hljs-string">"Frame budget exceeded during high-priority processing"</span>)
			<span class="hljs-keyword">return</span>
		}
	}

	<span class="hljs-comment">// 2. 处理 Medium 优先级（直到空）</span>
	<span class="hljs-keyword">for</span> <span class="hljs-built_in">len</span>(el.midChan) &gt; <span class="hljs-number">0</span> {
		ev := &lt;-el.midChan
		ev.Handler()
		<span class="hljs-keyword">if</span> time.Since(frameStart) &gt;= FrameBudget {
			log.Println(<span class="hljs-string">"Frame budget exceeded during medium-priority processing"</span>)
			<span class="hljs-keyword">return</span>
		}
	}

	<span class="hljs-comment">// 3. 有限处理 Low 优先级</span>
	lowDeadline := frameStart.Add(MaxLowTime)
	<span class="hljs-keyword">for</span> time.Now().Before(lowDeadline) &amp;&amp; <span class="hljs-built_in">len</span>(el.lowChan) &gt; <span class="hljs-number">0</span> {
		ev := &lt;-el.lowChan
		ev.Handler()
	}
}

<span class="hljs-comment">// ===== 示例使用：完整 main 函数 =====</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	loop := NewEventLoop()

	<span class="hljs-comment">// 模拟玩家实时操作（High 优先级）</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++ {
			loop.Submit(&amp;Event{
				Priority:  PriorityHigh,
				CreatedAt: time.Now(),
				Handler: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
					time.Sleep(<span class="hljs-number">60</span> * time.Microsecond) <span class="hljs-comment">// 模拟 60 μs 操作</span>
					log.Println(<span class="hljs-string">"✅ [HIGH] 玩家技能释放"</span>)
				},
			})
			time.Sleep(<span class="hljs-number">30</span> * time.Millisecond)
		}
	}()

	<span class="hljs-comment">// 模拟游戏世界心跳（Medium 优先级）</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
			loop.Submit(&amp;Event{
				Priority:  PriorityMedium,
				CreatedAt: time.Now(),
				Handler: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
					time.Sleep(<span class="hljs-number">150</span> * time.Microsecond) <span class="hljs-comment">// 模拟 150 μs</span>
					log.Println(<span class="hljs-string">"🔄 [MEDIUM] 怪物AI决策"</span>)
				},
			})
			time.Sleep(<span class="hljs-number">45</span> * time.Millisecond)
		}
	}()

	<span class="hljs-comment">// 模拟后台统计（Low 优先级）</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
			loop.Submit(&amp;Event{
				Priority:  PriorityLow,
				CreatedAt: time.Now(),
				Handler: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
					time.Sleep(<span class="hljs-number">300</span> * time.Microsecond) <span class="hljs-comment">// 模拟 300 μs</span>
					log.Println(<span class="hljs-string">"📊 [LOW] 全服在线统计"</span>)
				},
			})
			time.Sleep(<span class="hljs-number">20</span> * time.Millisecond)
		}
	}()

	<span class="hljs-comment">// 启动事件循环</span>
	<span class="hljs-keyword">go</span> loop.Start()

	<span class="hljs-comment">// 运行 3 秒后优雅退出</span>
	log.Println(<span class="hljs-string">"⏳ 运行 3 秒模拟..."</span>)
	time.Sleep(<span class="hljs-number">3</span> * time.Second)
	loop.Stop()
	time.Sleep(<span class="hljs-number">100</span> * time.Millisecond) <span class="hljs-comment">// 留出退出时间</span>
	log.Println(<span class="hljs-string">"🔚 程序结束"</span>)
}
</code></pre>
<h4 data-id="heading-16">3.3 完整实现参考</h4>
<p>上述代码为核心简化版，完整的生产级实现（含超时监控、告警、任务切片工具、Worker协程池）可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-utils%2Ftree%2Fmain%2Feventloop" target="_blank" title="https://github.com/tx7do/go-utils/tree/main/eventloop" ref="nofollow noopener noreferrer">github.com/tx7do/go-ut…</a></p>
<h3 data-id="heading-17">四、总结：单协程调度的核心心法</h3>
<p>Go 单协程事件调度器的价值，在于 <strong>用“串行执行”换取“无锁有序”</strong>，但这一优势的前提是 <strong>对时间的极致掌控</strong>。</p>
<p>其核心心法可凝练为三点：</p>
<ul>
<li><strong>守红线</strong>：<strong>将1ms作为单事件处理的绝对上限</strong>，通过帧预算计算反推单事件耗时指标，从设计阶段规避阻塞风险；</li>
<li><strong>分优先级</strong>：以 <strong>玩家体验为中心</strong>，确保实时交互与世界心跳优先执行，低优先级任务可降级、丢弃或限流。</li>
<li><strong>拆压力</strong>：通过<strong>任务切片、异步卸载、数据预处理</strong>，将无法压缩的耗时任务“非阻塞化”，避免单协程成为性能瓶颈。</li>
</ul>
<p>在实际研发中，需结合 <strong>游戏类型、并发规模、业务复杂度</strong> 动态调整策略。但无论场景如何变化，<strong>“有序性”与“响应速度”的平衡</strong>，始终是单协程调度器的灵魂所在。</p>
<blockquote>
<p>最终目标：让每一微秒都为玩家体验服务，而非为系统复杂性买单。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📦 Uni ECharts 是如何使用定制 echarts 的？一篇文章轻松掌握！]]></title>    <link>https://juejin.cn/post/7585839411122323502</link>    <guid>https://juejin.cn/post/7585839411122323502</guid>    <pubDate>2025-12-21T23:51:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122323502" data-draft-id="7585222924565151784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📦 Uni ECharts 是如何使用定制 echarts 的？一篇文章轻松掌握！"/> <meta itemprop="keywords" content="ECharts,uni-app,Vue.js"/> <meta itemprop="datePublished" content="2025-12-21T23:51:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaohe0601"/> <meta itemprop="url" content="https://juejin.cn/user/3183831378302871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📦 Uni ECharts 是如何使用定制 echarts 的？一篇文章轻松掌握！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3183831378302871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaohe0601
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T23:51:59.000Z" title="Sun Dec 21 2025 23:51:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    79
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>Uni ECharts 是适用于 uni-app 的 Apache ECharts 组件，无需繁琐的步骤即可轻松在 uni-app 平台上使用 echarts。</p>
<p>官网 &amp; 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink" target="_blank" title="https://uni-echarts.xiaohe.ink" ref="nofollow noopener noreferrer">uni-echarts.xiaohe.ink</a></p>
<p>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaohe0601%2Funi-echarts" target="_blank" title="https://github.com/xiaohe0601/uni-echarts" ref="nofollow noopener noreferrer">github.com/xiaohe0601/…</a></p>
<h2 data-id="heading-0">🤓 前言</h2>
<p>朋友们好啊，我是 Uni ECharts 掌门人小何。</p>
<p>刚才有个朋友问我：“何老师，发生甚么事了？” 我说怎么回事？给我发了两张截图。</p>
<p>我一看！噢，原来是昨天，有两个小程序，页面很多，一个 400 多页，一个 500 多页。</p>
<p>塔们说，哎…有一个说是主包实在是放不下 echarts 了，何老师你能不能教教我优化功法？帮助我改善一下我的小程序体积。</p>
<p>我说可以，我说你直接 npm 安装 echarts 按需引用，不好用，他不服气。</p>
<p>我说小朋友，你一个组件同时兼容所有端，不需要条件编译，他说你这也没用。</p>
<p>我说我这个有用，这是抹平差异，传统开发是讲一次编译、多端覆盖，二百多行代码的条件编译都抵不过我这个小组件。</p>
<p>他说要和我试试，我说可以。我一说，他啪一下就把条件编译给写出来了，很快啊，然后上来就是一个 require，吭！一个 ifdef，吭！一个 ifndef！</p>
<p>我全部防出去了，防出去以后自然是传统开发宜点到为止，Uni ECharts 藏在 Github 没给他看。我笑一下，准备上班，因为这时间按传统开发的点到为止他已经输了，如果 Uni ECharts 发力，一下就把他条件编译整破防了，放在 Github 没给他看。</p>
<p>他也承认，说条件编译写起来繁琐。啊，我收手的时间不聊了，他突然袭击说 npm 装的 echarts 不能放到分包，啊，我大意了啊，没有考虑到。</p>
<p>哎，他的条件编译给我脸打了一下，但是没关系啊！他也说了，他截图也说了，两分多钟以后，当时流眼泪了，捂着眼我就说停…停，然后两分多钟以后就好了。</p>
<p>我说小伙子你不讲武德，你不懂，他忙说何老师对不…对不起，我不懂规矩。啊，他说他是乱打的，他可不是乱打啊，ifdef、ifndef 训练有素，后来他说他练过 <strong>两年半</strong> 开源，看来是有备而来。</p>
<p>这两个年轻人，不讲武德。来，骗！来，偷袭！我 22 岁的老同志。这好吗？这不好。我说小朋友你不懂，开发要以和为贵，不是好勇斗狠，要讲武德。</p>
<p>我劝！这位年轻人，耗子尾汁，好好反思。年轻人要脚踏实地，不要急功近利，以后不要再犯这样的聪明，小聪明啊！更不要搞窝里斗！谢谢朋友们！</p>
<blockquote>
<p>灵感来源 <a href="https://juejin.cn/user/3919115686512942" target="_blank" title="https://juejin.cn/user/3919115686512942">@德莱厄斯</a></p>
</blockquote>
<h2 data-id="heading-1">🪄 定制 ECharts</h2>
<blockquote>
<p>👉 前往 Uni ECharts 官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink%2Fguide%2Fecharts%23%25E5%25AE%259A%25E5%2588%25B6-echarts" target="_blank" title="https://uni-echarts.xiaohe.ink/guide/echarts#%E5%AE%9A%E5%88%B6-echarts" ref="nofollow noopener noreferrer">定制 ECharts</a> 查看完整内容</p>
</blockquote>
<p>通常情况，使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink%2Fguide%2Fecharts%23%25E6%258C%2589%25E9%259C%2580%25E5%25AF%25BC%25E5%2585%25A5" target="_blank" title="https://uni-echarts.xiaohe.ink/guide/echarts#%E6%8C%89%E9%9C%80%E5%AF%BC%E5%85%A5" ref="nofollow noopener noreferrer">按需导入</a> 就能有效减小打包体积，但是在某些场景如果需要使用定制的 ECharts，在 Uni ECharts 中可以配合 <a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink%2Fapis%2Ffunction%23provideecharts" target="_blank" title="https://uni-echarts.xiaohe.ink/apis/function#provideecharts" ref="nofollow noopener noreferrer">provideEcharts</a> 实现，具体参考以下步骤：</p>
<ol>
<li>
<p>使用 ECharts 官网的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fecharts.apache.org%2Fzh%2Fbuilder.html" target="_blank" title="https://echarts.apache.org/zh/builder.html" ref="nofollow noopener noreferrer">在线定制</a> 功能根据需求选择需要使用的模块构建并下载 <code>echarts.min.js</code> 到本地；</p>
</li>
<li>
<p>由于 Vite 默认仅支持 ESM 模块，但是 ECharts 官网的在线定制功能并不支持下载 ESM 格式的产物，所以 Uni ECharts 提供了一个 CLI 工具可以轻松将其转换为 ESM 格式，使用示例如下：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">pnpm</span>
pnpm dlx @uni-echarts/c2e@latest
<span class="hljs-meta prompt_">
# </span><span class="bash">npm</span>
npx @uni-echarts/c2e@latest
</code></pre>
<pre><code class="hljs language-shell" lang="shell">┌  Uni ECharts Transform CLI
│
●  Transform input echarts.min.js to ESM
│
◇  Input file
│  ./echarts.min.js
│
◇  Output file
│  ./echarts.esm.js
│
◇  Transform completed!
│
└  Output: /path/to/echarts.esm.js
</code></pre>
<p>受限于 <code>echarts.min.js</code> 的内容，目前转换后的 ESM 产物不支持 Tree-Shaking，无法剔除未使用的代码，并且需要使用默认导入，示例如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"/path/to/echarts.esm.js"</span>;
</code></pre>
</li>
<li>
<p>将转换后的 <code>echarts.esm.js</code> 放入项目中，注意<strong>不要</strong>放到 <code>static</code> 目录（因为小程序仅支持 ES5，无法识别 <code>export</code> 语法）。</p>
</li>
<li>
<p>调用 <code>provideEcharts</code> 将 <code>echarts</code> 提供给组件，根据 Uni ECharts 的引入方式参考下述指引：</p>
<ul>
<li>
<p>NPM 方式</p>
<p>自 <code>2.0.0</code> 开始，npm 方式可以通过修改 Vite 插件配置轻松使用！</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js[ts]</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UniEcharts</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"uni-echarts/vite"</span>;
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"vite"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title class_">UniEcharts</span>({
      <span class="hljs-attr">echarts</span>: {
        <span class="hljs-comment">// 传实际的 echarts 文件路径，例如："@/plugins/echarts.esm.js"</span>
        <span class="hljs-attr">provide</span>: <span class="hljs-string">"/path/to/echarts.esm.js"</span>,
        <span class="hljs-attr">importType</span>: <span class="hljs-string">"default"</span>
      }
    })
  ]
});
</code></pre>
<p>当然，也可以手动调用，示例如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { provideEcharts } <span class="hljs-keyword">from</span> <span class="hljs-string">"uni-echarts/shared"</span>;
<span class="hljs-keyword">import</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"/path/to/echarts.esm.js"</span>;

<span class="hljs-title function_">provideEcharts</span>(echarts);
</code></pre>
</li>
<li>
<p>Uni Modules 方式</p>
<p>使用 uni-modules 方式需要手动调用，示例如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { provideEcharts } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/xiaohe-echarts"</span>;
<span class="hljs-keyword">import</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"/path/to/echarts.esm.js"</span>;

<span class="hljs-title function_">provideEcharts</span>(echarts);
</code></pre>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>因为目前转换后的 ESM 产物不支持 Tree-Shaking，所以使用定制 echarts 时不再需要调用 <code>echarts.use</code> 按需注册组件。</p>
</blockquote>
<h2 data-id="heading-2">💻 使用组件</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">uni-echarts</span> <span class="hljs-attr">custom-class</span>=<span class="hljs-string">"chart"</span> <span class="hljs-attr">:option</span>=<span class="hljs-string">"option"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">uni-echarts</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"/path/to/echarts.esm.js"</span>;

<span class="hljs-keyword">const</span> option = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">legend</span>: {
    <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">left</span>: <span class="hljs-string">"center"</span>
  },
  <span class="hljs-attr">tooltip</span>: {
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">"item"</span>,
    <span class="hljs-attr">textStyle</span>: {
      <span class="hljs-comment">// #ifdef MP-WEIXIN</span>
      <span class="hljs-comment">// 临时解决微信小程序 tooltip 文字阴影问题</span>
      <span class="hljs-attr">textShadowBlur</span>: <span class="hljs-number">1</span>
      <span class="hljs-comment">// #endif</span>
    }
  },
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"pie"</span>,
      <span class="hljs-attr">radius</span>: [<span class="hljs-string">"30%"</span>, <span class="hljs-string">"52%"</span>],
      <span class="hljs-attr">label</span>: {
        <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">"center"</span>
      },
      <span class="hljs-attr">itemStyle</span>: {
        <span class="hljs-attr">borderWidth</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">borderColor</span>: <span class="hljs-string">"#ffffff"</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">10</span>
      },
      <span class="hljs-attr">emphasis</span>: {
        <span class="hljs-attr">label</span>: {
          <span class="hljs-attr">show</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">fontSize</span>: <span class="hljs-number">20</span>
        }
      }
    }
  ],
  <span class="hljs-attr">dataset</span>: {
    <span class="hljs-attr">dimensions</span>: [<span class="hljs-string">"来源"</span>, <span class="hljs-string">"数量"</span>],
    <span class="hljs-attr">source</span>: [
      [<span class="hljs-string">"Search Engine"</span>, <span class="hljs-number">1048</span>],
      [<span class="hljs-string">"Direct"</span>, <span class="hljs-number">735</span>],
      [<span class="hljs-string">"Email"</span>, <span class="hljs-number">580</span>],
      [<span class="hljs-string">"Union Ads"</span>, <span class="hljs-number">484</span>],
      [<span class="hljs-string">"Video Ads"</span>, <span class="hljs-number">300</span>]
    ]
  }
});
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chart</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
}
</code></pre>
<blockquote>
<p>💡 前往 Uni ECharts 官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink%2Fguide%2Fgetting-started" target="_blank" title="https://uni-echarts.xiaohe.ink/guide/getting-started" ref="nofollow noopener noreferrer">快速开始</a> 查看完整内容</p>
</blockquote>
<h2 data-id="heading-3">❤️ 支持 &amp; 鼓励</h2>
<p>如果 Uni ECharts 对你有帮助，可以通过以下渠道对我们表示鼓励：</p>
<ul>
<li>Star：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaohe0601%2Funi-echarts" target="_blank" title="https://github.com/xiaohe0601/uni-echarts" ref="nofollow noopener noreferrer">Github</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxiaohe0601%2Funi-echarts" target="_blank" title="https://gitee.com/xiaohe0601/uni-echarts" ref="nofollow noopener noreferrer">Gitee</a></li>
<li>收藏：<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D22035" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=22035" ref="nofollow noopener noreferrer">插件市场</a></li>
<li>赞助：<a href="https://link.juejin.cn?target=https%3A%2F%2Funi-echarts.xiaohe.ink%2Fsponsor%23%25E8%25B5%259E%25E5%258A%25A9" target="_blank" title="https://uni-echarts.xiaohe.ink/sponsor#%E8%B5%9E%E5%8A%A9" ref="nofollow noopener noreferrer">自愿赞助</a></li>
</ul>
<p>无论 ⭐️ 还是 💰 支持，我们铭记于心，这将是我们继续前进的动力，感谢您的支持！</p>
<h2 data-id="heading-4">🍵 写在最后</h2>
<p>我是 xiaohe0601，热爱代码，目前专注于 Web 前端领域。</p>
<p>欢迎关注我的微信公众号「小何不会写代码」，我会不定期分享一些开发心得、最佳实践以及技术探索等内容，希望能够帮到你！</p>
<h2 data-id="heading-5">📚 推荐阅读</h2>
<ul>
<li><a href="https://juejin.cn/post/7569413676157222927" target="_blank" title="https://juejin.cn/post/7569413676157222927">Uni ECharts 2.1 发布：正式支持鸿蒙，零成本迁移、全平台兼容、跨端开发零负担！</a></li>
<li><a href="https://juejin.cn/post/7565367982547124224" target="_blank" title="https://juejin.cn/post/7565367982547124224">拥抱 create-uni，一行命令轻松集成 Uni ECharts！</a></li>
<li><a href="https://juejin.cn/post/7561434147878600744" target="_blank" title="https://juejin.cn/post/7561434147878600744">Uni ECharts 2.0 正式发布：原来在 uni-app 中使用 ECharts 可以如此简单！</a></li>
<li><a href="https://juejin.cn/post/7531676192397033472" target="_blank" title="https://juejin.cn/post/7531676192397033472">Uni ECharts：也许是 uni-app 中使用 ECharts 最优雅的解决方案</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 · 我与 AI / Vibe Coding 的一年]]></title>    <link>https://juejin.cn/post/7588149079400841259</link>    <guid>https://juejin.cn/post/7588149079400841259</guid>    <pubDate>2025-12-27T03:16:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079400841259" data-draft-id="7588064253635526710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 · 我与 AI / Vibe Coding 的一年"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-27T03:16:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoolerWu"/> <meta itemprop="url" content="https://juejin.cn/user/2400989125543272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 · 我与 AI / Vibe Coding 的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2400989125543272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoolerWu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:16:36.000Z" title="Sat Dec 27 2025 03:16:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这不是一篇“AI 帮我提效”的年度总结。<br/>
相反，这是我在 2025 年里，<strong>不断给 AI 使用方式做风控建模</strong>之后，留下的一份工程化复盘。</p>
</blockquote>
<p>如果一定要给这一年一个关键词，那不是「效率」，而是——<strong>不轻信</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、为什么我选择写“风控”，而不是“成长”</h2>
<p>回看我这一年和 AI 的大量交流记录，会发现一个很反直觉的现象：<br/>
我很少真正追求“满意答案”。</p>
<p>我反复追问的是：</p>
<ul>
<li>这个结论的隐含前提是什么？</li>
<li>换一个市场状态，它还成立吗？</li>
<li>能不能写进代码？写不进去的部分算什么？</li>
<li>这是不是一种“解释顺滑，但不可执行”的假理解？</li>
</ul>
<p>这类问题，本质上不是学习问题，而是<strong>风险识别问题</strong>。</p>
<p>在工程世界里，一个系统最危险的状态不是“明显错误”，而是：</p>
<blockquote>
<p><strong>看起来一切正常，但风险从未被显式建模。</strong></p>
</blockquote>
<p>所以，与其说 2025 年我在“用 AI / Vibe Coding”，<br/>
不如说我在学习一件更重要的事：<br/>
<strong>如何在 AI 参与决策的前提下，仍然对结果负责。</strong></p>
<hr/>
<h2 data-id="heading-1">二、我对 AI 的角色认知变化：从 Copilot 到 Fuzzer</h2>
<p>年初，我对 AI 的定位更像是 Copilot：</p>
<ul>
<li>解释概念</li>
<li>补齐思路</li>
<li>快速生成方案</li>
<li>帮我把模糊想法“写完整”</li>
</ul>
<p>但随着使用频率上升，我逐渐意识到一件事：</p>
<blockquote>
<p>AI 的价值，不在于“给我答案”，<br/>
而在于<strong>它会把我没想清楚的地方无限放大</strong>。</p>
</blockquote>
<p>于是我对 AI 的使用方式开始发生迁移：</p>
<ul>
<li>不再问“这个对不对”</li>
<li>而是问“它在哪些条件下必然失败”</li>
<li>不让它裁决，而是让它制造压力</li>
</ul>
<p>在工程语境里，这种角色更像 <strong>Fuzzer</strong>：<br/>
不是用来证明系统正确，而是用来<strong>尽可能快地找出漏洞</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、第一类高频风险：把“生成能力”误判为“理解能力”</h2>
<p>这是我在 2025 年最早、也最频繁踩到的坑。</p>
<p>AI 非常擅长做一件事：<br/>
<strong>把复杂概念解释得足够顺，让你以为自己已经掌握。</strong></p>
<p>但作为程序员，我越来越警惕这种“顺”。</p>
<h3 data-id="heading-3">我给自己设定的一条硬性风控规则是：</h3>
<blockquote>
<p><strong>任何无法落地为“可执行约束”的理解，都不算真的理解。</strong></p>
</blockquote>
<p>具体表现为：</p>
<ul>
<li>能不能写成 if / else？</li>
<li>能不能明确阈值来源？</li>
<li>能不能定义失效条件？</li>
<li>能不能写进 validator，而不是停留在描述层？</li>
</ul>
<p>如果答案是否定的，那这个“理解”在我这儿只能算<strong>风险资产</strong>。</p>
<p>因为它看似存在，但无法被验证、回放、约束。</p>
<hr/>
<h2 data-id="heading-4">四、Vibe Coding 的真实副作用：启动成本下降，但继续成本被掩盖</h2>
<p>Vibe Coding 在 2025 年给我带来的最大变化，确实是<strong>启动变得极其容易</strong>。</p>
<p>策略、架构、流程、Agent 设想，<br/>
很多东西几乎可以“边想边跑”。</p>
<p>但很快我发现了一个工程上非常熟悉的问题：</p>
<blockquote>
<p><strong>创建新模块很容易，维护和收敛才是真正的成本。</strong></p>
</blockquote>
<p>Vibe Coding 极大地降低了“创建”的心理门槛，<br/>
但如果没有同步引入“继续 / 淘汰”机制，系统只会越来越复杂。</p>
<h3 data-id="heading-5">我后来给自己补上的一层 Gate 是：</h3>
<ul>
<li><strong>可测性</strong>：是否有指标？（收益、回撤、命中率、延迟）</li>
<li><strong>可观测性</strong>：是否能记录 decision trace？</li>
<li><strong>可回滚性</strong>：是否有 fallback / kill switch？</li>
<li><strong>可解释性</strong>：解释是否是“条件 → 行为”，而不是自然语言？</li>
</ul>
<p>过不了 Gate 的原型，不再继续推进。</p>
<hr/>
<h2 data-id="heading-6">五、我最警惕的一类信号：AI 输出的“确定感”</h2>
<p>AI 的输出有一个天然属性：<br/>
<strong>结构完整、语气自信、逻辑闭环</strong>。</p>
<p>这在工程世界里，本身就是一种危险信号。</p>
<p>因为它会导致一个非常典型的失败模式：</p>
<blockquote>
<p>大家都觉得“看起来没问题”，<br/>
所以真正的风险没有被任何人认真审视。</p>
</blockquote>
<p>尤其是在量化和策略场景中，这种“确定感”是致命的。<br/>
不是因为它一定错，而是因为它<strong>掩盖了不确定性</strong>。</p>
<p>所以我在这一年里，刻意改变了提问方式：</p>
<ul>
<li>不再问“这个策略好不好”</li>
<li>而是问“它在什么市场状态下会失效”</li>
<li>不再关心平均表现</li>
<li>而是关心尾部风险和结构性偏差</li>
</ul>
<hr/>
<h2 data-id="heading-7">六、在量化系统里，我给 AI 设定的明确边界</h2>
<p>这一年我反复尝试、也反复退回的一个边界是：</p>
<blockquote>
<p><strong>AI 可以参与建议，但不能拥有执行权。</strong></p>
</blockquote>
<p>在系统层面，我更倾向于这样拆分：</p>
<ul>
<li><strong>Signal 层</strong>：LLM 给出方向、理由、候选参数</li>
<li><strong>Policy 层</strong>：规则、阈值、仓位、冷却时间（确定性）</li>
<li><strong>Execution 层</strong>：下单、风控、限速、容错</li>
</ul>
<p>LLM 只能存在于第一层。<br/>
第二层必须可测试、可回放。<br/>
第三层必须极度保守。</p>
<p>程序员的直觉很简单：<br/>
<strong>LLM 输出本质上是不可信输入。</strong><br/>
不做 sanitizer，就等于把用户输入直接拼 SQL 上线。</p>
<hr/>
<h2 data-id="heading-8">七、止损与调度的讨论，本质上都是风控问题</h2>
<p>无论是“时间衰减 vs 浮盈百分比”的止损讨论，<br/>
还是“15m 调度 vs 1h 调度”的争论，<br/>
在我这儿都不是参数选择问题，而是<strong>因果是否成立的问题</strong>。</p>
<ul>
<li>时间本身不是市场状态指标</li>
<li>延迟如果大于信号周期，决策就是滞后的</li>
<li>规则如果能被“钻空子”，长期一定会漂移</li>
</ul>
<p>我更愿意接受一个<strong>看起来不优雅、但前提清晰</strong>的方案，<br/>
而不是一个解释漂亮、但逻辑脆弱的方案。</p>
<hr/>
<h2 data-id="heading-9">八、关于“自进化”：我选择工程现实，而不是幻想闭环</h2>
<p>我并不否认“自进化”这个方向的吸引力。<br/>
相反，我在这一年里非常认真地拆解过它：</p>
<ul>
<li>奖励信号是否可学习？</li>
<li>样本是否足够？</li>
<li>归因是否错配？</li>
<li>成本是否可控？</li>
<li>回看偏差如何避免？</li>
</ul>
<p>最后我保留下来的版本，更像是：</p>
<ul>
<li>LLM 不参与每 tick 决策</li>
<li>快照 + embedding 用于相似行情检索</li>
<li>LLM 在关键节点给“策略调整建议”</li>
<li>执行层始终由规则兜底</li>
</ul>
<p>这不是放弃进化，而是<strong>把进化约束在工程可控范围内</strong>。</p>
<hr/>
<h2 data-id="heading-10">九、这一年的最终结论：AI 没让我更聪明，但让我更难自欺</h2>
<p>如果一定要总结 2025 年 AI / Vibe Coding 对我的影响，那会是：</p>
<blockquote>
<p><strong>AI 没有替我思考，但它让我更难在逻辑上敷衍自己。</strong></p>
</blockquote>
<p>在一个答案极度廉价、生成几乎无成本的时代，<br/>
真正稀缺的能力反而是：</p>
<ul>
<li>愿意停下来</li>
<li>能接受不确定</li>
<li>对自己的决策负责</li>
</ul>
<p>风控，从来不是限制创造力。<br/>
它只是提醒我：<br/>
<strong>每一个“看起来合理”的结论，都应该被当成潜在风险对待。</strong></p>
<hr/>
<h2 data-id="heading-11">附：我给自己固化的一份 AI 使用风控清单</h2>
<h3 data-id="heading-12">输入风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> LLM 输出是否有 schema？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否做了校验与兜底？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否记录 decision trace？</li>
</ul>
<h3 data-id="heading-13">策略风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否明确隐含前提？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否列出失效场景？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可回放？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否有最大风险暴露限制？</li>
</ul>
<h3 data-id="heading-14">工程风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 延迟是否匹配调度周期？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 成本是否可控？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可观测？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可禁用？</li>
</ul>
<hr/>
<blockquote>
<p>真正需要被风控的，从来不是 AI。<br/>
而是我们在“答案唾手可得”时，<br/>
是否还愿意为判断承担责任。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Echarts常用配置]]></title>    <link>https://juejin.cn/post/7588010346071130122</link>    <guid>https://juejin.cn/post/7588010346071130122</guid>    <pubDate>2025-12-27T03:25:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346071130122" data-draft-id="7369423779309944871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Echarts常用配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T03:25:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小白x"/> <meta itemprop="url" content="https://juejin.cn/user/404211847925095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Echarts常用配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/404211847925095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小白x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:25:07.000Z" title="Sat Dec 27 2025 03:25:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">title设置字体</h5>
<p>textStyle</p>
<pre><code class="hljs language-css" lang="css">option = {
  title: {
    text: <span class="hljs-string">"Main Title"</span>,
    subtext: <span class="hljs-string">"Sub Title"</span>,
    left: <span class="hljs-string">"center"</span>,
    top: <span class="hljs-string">"center"</span>,
    textStyle: {
      fontSize: <span class="hljs-number">30</span>,
      fontWeight:<span class="hljs-string">'bolder'</span>
    },
    subtextStyle: {
      fontSize: <span class="hljs-number">20</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-1">控制图表边距</h5>
<p>grid: {
top: '20%'，botton:'20%',left:'10%',right:'10%'
},</p>
<h5 data-id="heading-2">X轴坐标系标签，旋转角度</h5>
<pre><code class="hljs language-css" lang="css">       xAxis: [
          {
            type: <span class="hljs-string">'category'</span>,
            data: data,
            axisPointer: {
              type: <span class="hljs-string">'shadow'</span>
            },
            axisLabel: { // 坐标轴刻度标签的相关设置。
              rotate: <span class="hljs-string">'20'</span> // x轴数据标签旋转角度
            }
          }
        ],
</code></pre>
<h5 data-id="heading-3">限制柱状图最大宽度</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">    series: [
          {
            name: <span class="hljs-string">'数量'</span>,
            type: <span class="hljs-string">'bar'</span>,
            barMaxWidth: <span class="hljs-number">50</span>, <span class="hljs-comment">// 最大宽度</span>
            <span class="hljs-keyword">data</span>: <span class="hljs-keyword">data</span>
          }]
</code></pre>
<h5 data-id="heading-4">柱状图渐变色</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">series</span>里面
    <span class="hljs-selector-tag">itemStyle</span>: {
              <span class="hljs-attribute">color</span>: new echarts.graphic.<span class="hljs-built_in">LinearGradient</span>(
                <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-comment">// 渐变方向从左上角到右下角</span>
                [
                  { <span class="hljs-attribute">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'rgb(128,100,162)'</span> }, <span class="hljs-comment">// 0% 处的颜色</span>
                  { <span class="hljs-attribute">offset</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#fff'</span> } <span class="hljs-comment">// 100% 处的颜色</span>
                ]
              )
            },
</code></pre>
<h5 data-id="heading-5">柱状图文字显示</h5>
<p>直接在取消柱子上方显示具体数据信息，以及自定义信息，比如100%，数字后面加一个百分号
1）show，显示节点上的文本信息
2）position，文本位置，可以根据需要调整为 ‘top’, ‘bottom’, ‘inside’, ‘insideTop’, 等
top，表示在节点上方</p>
<pre><code class="hljs language-kotlin" lang="kotlin">series: [
    {
      <span class="hljs-keyword">data</span>: [<span class="hljs-number">150</span>, <span class="hljs-number">230</span>, <span class="hljs-number">224</span>, <span class="hljs-number">218</span>, <span class="hljs-number">135</span>, <span class="hljs-number">147</span>, <span class="hljs-number">260</span>],
      type: <span class="hljs-string">'bar'</span>,
      label:{
        show:<span class="hljs-literal">true</span>,
        position:<span class="hljs-string">'top'</span>,
        formatter:function(<span class="hljs-keyword">data</span>){
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.value+<span class="hljs-string">'件'</span>
        }
      }
    }
  ]
</code></pre>
<h5 data-id="heading-6">折线图变平滑</h5>
<p>series属性中使用smooth: true语句让折线图变成平滑折线图</p>
<h4 data-id="heading-7">echart柱状图最小间隔</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> option = {
    <span class="hljs-comment">// ... 其他配置项</span>
    yAxis: {
        <span class="hljs-keyword">type</span>: <span class="hljs-string">'value'</span>,
        <span class="hljs-comment">// 设置Y轴的最小间隔</span>
        minInterval: <span class="hljs-number">1</span> <span class="hljs-comment">// 示例值，根据实际需求进行调整</span>
    },
    <span class="hljs-comment">// ... 其他配置项</span>
};
</code></pre>
<h3 data-id="heading-8">立体柱状图</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">var</span> <span class="hljs-string">xData2</span> <span class="hljs-string">=</span> [<span class="hljs-string">'容城谷庄'</span>]
<span class="hljs-string">var</span> <span class="hljs-string">data1</span> <span class="hljs-string">=</span> [<span class="hljs-number">50</span>]
<span class="hljs-string">option</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">backgroundColor:</span> <span class="hljs-string">'rgba(0,0,0,0)'</span>,
    <span class="hljs-attr">grid:</span> {
        <span class="hljs-attr">left:</span> <span class="hljs-number">0</span>,
        <span class="hljs-attr">bottom:</span> <span class="hljs-number">15</span>,
        <span class="hljs-attr">top:</span> <span class="hljs-number">15</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-number">80</span>
    },
    <span class="hljs-attr">xAxis:</span> {
        <span class="hljs-attr">data:</span> <span class="hljs-string">xData2</span>,
        <span class="hljs-attr">axisTick:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLabel:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        }
    },
    <span class="hljs-attr">yAxis:</span> {
        <span class="hljs-attr">splitLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisTick:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLabel:</span> {
            <span class="hljs-string">//</span> <span class="hljs-attr">textStyle:</span> {
            <span class="hljs-string">//</span>     <span class="hljs-attr">color:</span> <span class="hljs-string">'#fff'</span>,
            <span class="hljs-string">//</span>     <span class="hljs-attr">fontSize:</span> <span class="hljs-number">20</span>,
            <span class="hljs-string">//</span> },
            <span class="hljs-string">//</span> <span class="hljs-string">不显示Y轴数值</span>
            <span class="hljs-attr">formatter:</span> <span class="hljs-string">function</span> <span class="hljs-string">()</span> {
                <span class="hljs-string">return</span> <span class="hljs-string">''</span>
            }
        }
    },
    <span class="hljs-attr">series:</span> [
        <span class="hljs-string">//</span> <span class="hljs-string">数据低下的圆片</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">12</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>,
                <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                    <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                        <span class="hljs-number">1</span>,
                        <span class="hljs-string">//</span> <span class="hljs-string">深色#2BA9ED</span> <span class="hljs-string">浅色</span> <span class="hljs-comment">#34EDF2</span>
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        [
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            },
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            }
                        ],
                        <span class="hljs-literal">false</span>
                    <span class="hljs-string">)</span>
                }
                <span class="hljs-string">//</span> <span class="hljs-attr">color:</span> <span class="hljs-string">'transparent'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">1</span>]
        },
        <span class="hljs-string">//</span> <span class="hljs-string">数据的柱状图</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">41</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-string">//</span> <span class="hljs-string">lenged文本</span>
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>, <span class="hljs-string">//</span> <span class="hljs-string">这个是</span> <span class="hljs-string">透明度</span>
                <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                    <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">1</span>,
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        [
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            },
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E8AE62'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            }
                        ],
                        <span class="hljs-literal">false</span>
                    <span class="hljs-string">)</span>
                }
            },

            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },
        <span class="hljs-string">//</span> <span class="hljs-string">替代柱状图</span> <span class="hljs-string">默认不显示颜色，是最下方柱图（邮件营销）的value值</span> <span class="hljs-bullet">-</span> <span class="hljs-number">20</span>
        {
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">43</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'transparent'</span>
            },
            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },
        <span class="hljs-string">//</span> <span class="hljs-string">数据顶部的样式</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">-8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">12</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">normal:</span> {
                    <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>,
                    <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                        <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">0</span>,
                            [
                                {
                                    <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                    <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                                },
                                {
                                    <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                    <span class="hljs-attr">color:</span> <span class="hljs-string">'#E8AE62'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                                }
                            ],
                            <span class="hljs-literal">false</span>
                        <span class="hljs-string">)</span>
                    },
                    <span class="hljs-attr">label:</span> {
                        <span class="hljs-attr">show:</span> <span class="hljs-literal">true</span>, <span class="hljs-string">//</span> <span class="hljs-string">开启显示</span>
                        <span class="hljs-attr">position:</span> <span class="hljs-string">'top'</span>, <span class="hljs-string">//</span> <span class="hljs-string">在上方显示</span>
                        <span class="hljs-attr">textStyle:</span> {
                            <span class="hljs-string">//</span> <span class="hljs-string">数值样式</span>
                            <span class="hljs-attr">color:</span> <span class="hljs-string">'#FFFFFF'</span>,
                            <span class="hljs-attr">fontSize:</span> <span class="hljs-number">20</span>,
                            <span class="hljs-attr">top:</span> <span class="hljs-number">50</span>
                        },
                        <span class="hljs-attr">formatter:</span> <span class="hljs-string">function</span> <span class="hljs-string">(param)</span> {
                            <span class="hljs-string">return</span> <span class="hljs-string">param.data</span> <span class="hljs-string">+</span> <span class="hljs-string">'%'</span>
                        }
                    }
                }
            },
            <span class="hljs-attr">symbolPosition:</span> <span class="hljs-string">'end'</span>,
            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },

        <span class="hljs-string">//</span> <span class="hljs-string">阴影的顶部</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>, <span class="hljs-string">//</span> <span class="hljs-string">头部</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">-8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">17</span>,
            <span class="hljs-attr">symbolPosition:</span> <span class="hljs-string">'end'</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'rgba(24,78,134,0.3)'</span>,
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">0.3</span>,
                <span class="hljs-attr">borderWidth:</span> <span class="hljs-number">1</span>,
                <span class="hljs-attr">borderColor:</span> <span class="hljs-string">'#526558'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">100</span>]
        },
        <span class="hljs-string">//</span> <span class="hljs-string">后面的背景</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">'2019'</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">41</span>,
            <span class="hljs-attr">barGap:</span> <span class="hljs-string">'-100%'</span>,
            <span class="hljs-attr">z:</span> <span class="hljs-number">0</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'rgba(24,78,134,0.1)'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">100</span>]
        }
    ]
}
</code></pre>
<h5 data-id="heading-9">Echarts给柱状图上面增加小横杠</h5>
<pre><code class="hljs language-css" lang="css"> option = {
      title: {
        text: <span class="hljs-string">'世界人口统计'</span>,
        left: <span class="hljs-string">'center'</span>,
        textStyle: {
          fontSize: <span class="hljs-number">24</span>,
          fontWeight: <span class="hljs-string">'bold'</span>,
          color: <span class="hljs-string">'#333'</span>
        }
      },

      xAxis: {
        type: <span class="hljs-string">'value'</span>,
        boundaryGap: [<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>],
        name: <span class="hljs-string">'人口 (万)'</span>,
        nameLocation: <span class="hljs-string">'middle'</span>,
        nameGap: <span class="hljs-number">30</span>,
        axisLabel: {
          formatter: <span class="hljs-built_in">function</span>(value) {
            if (value &gt;= <span class="hljs-number">10000</span>) {
              return (value / <span class="hljs-number">10000</span>) + '亿';
            }
            return value;
          }
        }
      },
      yAxis: {
        type: <span class="hljs-string">'category'</span>,
        data: [<span class="hljs-string">'巴西'</span>,  <span class="hljs-string">'中国'</span>, <span class="hljs-string">'世界'</span>],
        axisLabel: {
          <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span>,
          fontSize: <span class="hljs-number">14</span>
        }
      },
      series: [
        {
          name: <span class="hljs-string">'2011'</span>,
          type: <span class="hljs-string">'bar'</span>,
          data: [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>],
          itemStyle: {
            borderRadius: [<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>],
            color: <span class="hljs-string">'#36A2EB'</span>
          },
          <span class="hljs-selector-tag">label</span>: {
            show: true,
            position: <span class="hljs-string">'right'</span>,
            formatter: <span class="hljs-built_in">function</span>(params) {
              return params<span class="hljs-selector-class">.value</span><span class="hljs-selector-class">.toLocaleString</span>();
            }
          },
          markPoint: {
             symbol: <span class="hljs-string">'rect'</span>,
             symbolSize: [<span class="hljs-number">4</span>, <span class="hljs-number">20</span>],
            data: [
              {
                // 标记巴西 (<span class="hljs-number">2011</span>)
                name: <span class="hljs-string">''</span>,
                coord: [<span class="hljs-number">10</span>, <span class="hljs-string">'巴西'</span>],
                itemStyle: { <span class="hljs-attribute">color</span>: <span class="hljs-string">'#FF6384'</span> }
              },
              {
                // 标记中国 (<span class="hljs-number">2011</span>)
                name: <span class="hljs-string">''</span>,
                coord: [<span class="hljs-number">20</span>, <span class="hljs-string">'中国'</span>],
                itemStyle: { <span class="hljs-attribute">color</span>: <span class="hljs-string">'#FF6384'</span> }
              }
            ]
          }
        }
      ]
    };


</code></pre>
<pre><code class="hljs">javascript

</code></pre>
<p>markPoint: {
symbol: 'rect',  // 标记点形状为矩形
symbolSize: [4, 20],  // 标记点大小
data: [
{ name: '', coord: [2, 36], value: 36 }  // 关键配置
]
}</p>
<pre><code class="hljs language-markdown" lang="markdown">
  


假设这是一个<span class="hljs-strong">**折线图或柱状图**</span>（直角坐标系）：

  


<span class="hljs-bullet">-</span>   <span class="hljs-strong">**`coord: [2, 36]`**</span>  的含义：

<span class="hljs-bullet">    -</span>   <span class="hljs-strong">**`2`**</span>：在 X 轴上，对应<span class="hljs-strong">**第 3 个类目**</span>（索引从 0 开始，例如 <span class="hljs-code">`['一月', '二月', '三月', ...]`</span> 中的 <span class="hljs-code">`'三月'`</span>）。
<span class="hljs-bullet">    -</span>   <span class="hljs-strong">**`36`**</span>：在 Y 轴上的数值位置（例如 Y 轴范围是 0~100，标记点位于 Y=36 的高度）。

<span class="hljs-bullet">-</span>   <span class="hljs-strong">**效果**</span>：在 X 轴第 3 个类目（<span class="hljs-code">`'三月'`</span>）与 Y 轴数值 36 的交叉点处，绘制一个 4×20 大小的矩形标记
</code></pre>
<h6 data-id="heading-10">柱状图文字太多不显示</h6>
<p><strong>优化 X 轴标签显示</strong></p>
<p>若标签文字过长或过多，即使调整柱子间距仍可能显示不全，需进一步配置 <code>axisLabel</code>。</p>
<p><strong>1. 强制显示所有标签（避免省略）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">xAxis</span>: {
  <span class="hljs-attr">axisLabel</span>: {
    <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 强制显示所有标签（默认自动隐藏部分标签）</span>
    <span class="hljs-comment">// 或使用 formatter 换行（适用于长标签）</span>
    <span class="hljs-attr">formatter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>); <span class="hljs-comment">// 按字符换行（示例）</span>
      <span class="hljs-comment">// 或根据字数换行：return value.substr(0, 4) + '\n' + value.substr(4);</span>
    }
  }
}
</code></pre>
<p><strong>2. 旋转标签文字</strong></p>
<p>通过 <code>rotate</code> 调整文字角度，避免重叠：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">xAxis:</span> {
  <span class="hljs-attr">axisLabel:</span> {
    <span class="hljs-attr">rotate:</span> <span class="hljs-number">45</span>, <span class="hljs-string">//</span> <span class="hljs-string">旋转角度（建议</span> <span class="hljs-number">30</span><span class="hljs-string">°~60°，避免垂直显示）</span>
    <span class="hljs-attr">margin:</span> <span class="hljs-number">10</span> <span class="hljs-string">//</span> <span class="hljs-string">标签与轴的间距，防止被柱子遮挡</span>
  }
}
</code></pre>
<p><strong>3. 自适应隐藏部分标签</strong></p>
<p>若必须显示部分标签，可通过 <code>interval</code> 控制显示间隔（如每隔 N 个显示 1 个）：</p>
<pre><code class="hljs language-css" lang="css">xAxis: {
  axisLabel: {
    interval: <span class="hljs-number">1</span> // <span class="hljs-number">0</span>=全部显示，<span class="hljs-number">1</span>=隔 <span class="hljs-number">1</span> 个显示 <span class="hljs-number">1</span> 个，<span class="hljs-number">2</span>=隔 <span class="hljs-number">2</span> 个显示 <span class="hljs-number">1</span> 个，依此类推
  }
}
</code></pre>
<h5 data-id="heading-11">取消Y轴分割线</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">yAxis:</span> {
          <span class="hljs-attr">type:</span> <span class="hljs-string">'value'</span>,
          <span class="hljs-attr">splitLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
          }
        }<span class="hljs-string">,</span>
</code></pre>
<h5 data-id="heading-12">y轴上方标题</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">option</span> = {
  yAxis: {
    name: '数量\n（个）',  // 名称和单位分行
    nameLocation: 'end',
    nameGap: 5,
    nameTextStyle: {
      <span class="hljs-attribute">color</span>: <span class="hljs-string">'#333'</span>,       <span class="hljs-comment">// 深色文本</span>
      <span class="hljs-attribute">align</span>: <span class="hljs-string">'left'</span>,       <span class="hljs-comment">// 左对齐</span>
      <span class="hljs-attribute">lineHeight</span>: <span class="hljs-number">16</span>,      <span class="hljs-comment">// 行高控制间距</span>
      <span class="hljs-attribute">padding</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">8</span>]  <span class="hljs-comment">// 往左偏移更多</span>
    },
    <span class="hljs-comment">// 其他配置...</span>
  },
  <span class="hljs-comment">// 其他配置...</span>
};
</code></pre>
<h6 data-id="heading-13">设置柱状图间隔（象形图）</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617161a40383446da0142929ae8e7fea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP55m9eA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767410707&amp;x-signature=m%2BSDa0l8D9IZe4JftmIfX4zEvuw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-14">echart分组柱状图没数组不展示</h5>
<pre><code class="hljs language-ini" lang="ini">  // 原始数据源（模拟有缺失数据的场景）
      let <span class="hljs-attr">tufang</span> = [<span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">110</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">qiaoliang</span> = [<span class="hljs-number">100</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>, <span class="hljs-number">0</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">suidao</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">90</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">lumian</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">jidian</span> = [<span class="hljs-number">90</span>, <span class="hljs-number">190</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      const <span class="hljs-attr">option</span> = {
        tooltip: {},
        title: {
          show: true,
          text: '不符合常理的柱状图表实现',
          textStyle: {
            fontSize: 14,
            lineHeight: 18,
            width: 10
          }
        },
        xAxis: <span class="hljs-section">[
          {
            type: 'category',
            axisLabel: {
              align: 'center',
              hideOverlap: true
            },
            data: this.specificKeys
          }
        ]</span>,
        yAxis: <span class="hljs-section">[
          {
            type: 'value'
          }
        ]</span>,
        series: <span class="hljs-section">[
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: tufang
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: qiaoliang
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: suidao
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: lumian
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: jidian
          }
        ]</span>
      }

      function getRect (params, api) {
        let <span class="hljs-attr">dataSeries</span> = [
          tufang,
          qiaoliang,
          suidao,
          lumian,
          jidian
        ]<span class="hljs-comment">; // 确保这里有5个数据系列</span>
        const { seriesIndex } = params<span class="hljs-comment">;</span>
        let <span class="hljs-attr">categoryIndex</span> = api.value(<span class="hljs-number">0</span>)<span class="hljs-comment">; // x轴序列</span>
        let <span class="hljs-attr">vald</span> = api.value(<span class="hljs-number">1</span>)<span class="hljs-comment">; // 数据值</span>
        // 如果数据为0，则不渲染柱子
        if (<span class="hljs-attr">vald</span> === <span class="hljs-number">0</span>) {
          return<span class="hljs-comment">;</span>
        }
        let <span class="hljs-attr">start</span> = api.coord([categoryIndex, vald])<span class="hljs-comment">;</span>
        let <span class="hljs-attr">height</span> = api.size([<span class="hljs-number">0</span>, vald])<span class="hljs-comment">;</span>
        // 柱子宽度和间距
        let <span class="hljs-attr">barWidth</span> = <span class="hljs-number">30</span><span class="hljs-comment">; // 单个柱子的固定宽度</span>
        let <span class="hljs-attr">barGap</span> = <span class="hljs-number">3</span><span class="hljs-comment">; // 柱子之间的间距</span>
        // 计算当前系列的偏移量
        let <span class="hljs-attr">xOffset</span> = dataSeries.slice(<span class="hljs-number">0</span>, seriesIndex).reduce((sum, currentSeries, index) =&gt; {
          return sum + (currentSeries<span class="hljs-section">[categoryIndex]</span> !== undefined &amp;&amp; currentSeries<span class="hljs-section">[categoryIndex]</span> !== 0 ? barWidth + barGap : 0)<span class="hljs-comment">;</span>
        }, 0)<span class="hljs-comment">;</span>
        // 计算当前系列的x位置
        let <span class="hljs-attr">x</span> = start[<span class="hljs-number">0</span>] - barWidth / <span class="hljs-number">2</span> + x<span class="hljs-literal">Off</span>set - <span class="hljs-number">10</span><span class="hljs-comment">; // 柱子的中心位置 再减20是因为让其起点靠中间左边点</span>
        return {
          type: 'rect',
          shape: {
            x: x, // 当前柱子的x位置
            y: start<span class="hljs-section">[1]</span>,
            width: barWidth,
            height: height<span class="hljs-section">[1]</span>
          },
          style: api.style()
        }<span class="hljs-comment">;</span>
      }
      option &amp;&amp; this<span class="hljs-section">[myChart]</span>.setOption(option, true)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css和图片主题色“提取”]]></title>    <link>https://juejin.cn/post/7588067055481176073</link>    <guid>https://juejin.cn/post/7588067055481176073</guid>    <pubDate>2025-12-27T03:33:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588067055481176073" data-draft-id="7584297353419554816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css和图片主题色“提取”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T03:33:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hello_Code"/> <meta itemprop="url" content="https://juejin.cn/user/3423198551742986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css和图片主题色“提取”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3423198551742986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hello_Code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:33:01.000Z" title="Sat Dec 27 2025 03:33:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个想法是来源于「性能优化」中的骨架屏：
在图片居多的站点中，这将是非常nice的体验 —— 图片加载通常是比较让人难受的，好的骨架中一般占位图就是低像素的图片，即大体配色和变化是和实际内容一致的。
有时候比如图片不固定的，那可以使用算法获取图片的主体颜色（至少得是同色系的吧），使用纯色块占位。</p>
<p>再进一步想到，在一些“轻松”的场景下，我们可以让背景色/页面主题色跟随轮播图改变。至于效果嘛......你们可以想一下网易云音乐滑动切歌时的背景效果。</p>
<p>因为是不固定图片，所以我想到了四种方法：</p>
<ul>
<li>tensorflow.js 图像色彩分析</li>
<li>canvas对图片主基调进行分析，取大概值</li>
<li>css高斯模糊</li>
<li>上传图片时后端对图片分析处理，返回时直接返回一张低像素图片</li>
</ul>
<p>第一种方式目前还在我的实践中，以后会单独出一篇文章；最后一种方式个人不太建议首选：首先后端处理也需要时间，另一方面毕竟也是以图片进行传输的...yee~（而且后端可能也不太建议你首选🤣）</p>
<blockquote>
<p>想看实际效果的推荐自己动手试下，因为我发现本文中用QQ截屏截取的图片怎么都这么暗啊，实际展示的还是挺漂亮的。</p>
</blockquote>
<p>第三种方式看起来是纯css实现的，怎么获取呢？这就要说到css中的<code>filter: blur();</code> 简单来说，利用模糊滤镜及进一步拉伸，可以近似地拿到一张图片的主题色：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> {
	<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">图片地址</span>);
	<span class="hljs-attribute">background-size</span>: cover;
	<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">50px</span>);
}
</code></pre>
<p>你看，通过比较大的一个模糊滤镜，将图片高斯模糊<code>50px</code>，模糊后的图片是不是有点内味了，
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d41533314a4281a4e3be5d4a58a7ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=9tcl0Xgq36va%2BEdBzcFbUrRvgmc%3D" alt="ruawaba" loading="lazy"/></p>
<p>不过还不行，存在一些模糊边缘，我们可以利用<code>overflow</code>进行剪裁。</p>
<p>接下来，我们需要去掉模糊的边角，以及通过<code>transform: scale()</code>放大效果，将颜色进一步聚焦：
这里就很推荐使用伪元素进行操作了</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> {
	<span class="hljs-attribute">position</span>: relative;
	<span class="hljs-attribute">width</span>: xx;
	<span class="hljs-attribute">height</span>: xx;
	<span class="hljs-attribute">overflow</span>: hidden;
}
<span class="hljs-selector-tag">div</span><span class="hljs-selector-pseudo">::before</span> {
	<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
	<span class="hljs-attribute">position</span>: absolute;
	<span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">图片地址</span>);
	<span class="hljs-attribute">background-size</span>: cover;
	<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">50px</span>);
	<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">2</span>); //自行更改
	<span class="hljs-attribute">transform-origin</span>: center center;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2b1a3bb0b154d1f8d76be8095417647~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=vQDb5MIAosRrwntXQoe9hqyBr4E%3D" alt="ruawaba2" loading="lazy"/></p>
<p>这样就拿到图片的主色调了。当然是要进行其他处理的。</p>
<p>再来说说第二种方法 —— canvas。其实也不建议，因为本身就是JS操作，而在图片又不固定又有些多的情况下单线程的js处理这种“一级事件”造成的性能和体验感的损失是不可想象的。但本文笔者还是要分享一下，因为这是我当初研究的第一个被应用的成果（有情怀了嘿嘿）</p>
<p>首先，canvas中的<code>getImageData()</code>方法可以获取图片的像素集合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getImagePixel</span>(<span class="hljs-params">canvas, img</span>) {
	<span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
	context.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
	<span class="hljs-keyword">return</span> context.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>).<span class="hljs-property">data</span>;
}
</code></pre>
<blockquote>
<p>这里对使用canvas不熟悉的同学提个醒：img是异步加载的，所有对图片的操作都要放在 img 的 onload 中进行 —— 你可以考虑用 promise 做这件事。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3b83bad613a44c9a6aa81307ea969d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=gqzPlfJytUiHUYp2pgwktNU3OEA%3D" alt="rgba" loading="lazy"/></p>
<p>调用这个函数会拿到一个数组 —— 它是rgba值，也就是说，处理时四个数据为“一组”，更通俗地说，for循环中<code>i+=4</code>！来处理一下数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCountArr</span>(<span class="hljs-params">pData</span>) {
	<span class="hljs-keyword">let</span> colorList = [], rgba = [], rgbaStr = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;pData.<span class="hljs-property">length</span>; i+=<span class="hljs-number">4</span>) {
		rgba[<span class="hljs-number">0</span>] = pData[i];
		rgba[<span class="hljs-number">1</span>] = pData[i+<span class="hljs-number">1</span>];
		rgba[<span class="hljs-number">2</span>] = pData[i+<span class="hljs-number">2</span>];
		rgba[<span class="hljs-number">3</span>] = pData[i+<span class="hljs-number">3</span>];
		<span class="hljs-keyword">if</span>(rgba.<span class="hljs-title function_">indexOf</span>(<span class="hljs-literal">undefined</span>)!==-<span class="hljs-number">1</span> || pData[i+<span class="hljs-number">3</span>] === <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">continue</span>;
		}
		rgbaStr = rgba.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>);
		<span class="hljs-keyword">if</span>(rgbaStr <span class="hljs-keyword">in</span> colorList) {
			++colorList[rgbaStr];
		}<span class="hljs-keyword">else</span> {
			colorList[rgbaStr] = <span class="hljs-number">1</span>;
		}
	}
	<span class="hljs-keyword">return</span> colorList;
}
</code></pre>
<p>这个时候，得到的就是每组数据（色值）出现的次数了。
然后改写刚刚的getImagePixel函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">getCountArr</span>(pixelData);
</code></pre>
<p>至此，我们将其排序并取出第一个值/或者取出某些标志项的平均值，基本上就可以将其作为 background 值了！</p>
<hr/>
<p>峰回路转!</p>
<p>你难道真觉得canvas的这种方法只是鸡肋？那试想这样一种场景：在弱网情况下，图片必定贼慢才能加载出来。这时候我们通过js拿到图片的主色调并填充到图片的位置中。这是不是一个“模糊渐变加载”的绝佳场景！
而且，笔者曾经遇到这样一个场景：往图片上添加文字。这时候你就需要注意一个问题，图片主色调。用canvas分析图片的主要颜色或平均色可以在深色调时添加白色文字在浅色调时添加黑色文字！</p>
<blockquote>
<p>笔者前段时间弄了一个微信公众号：前端Code新谈。里面暂时有webrtc、前端面试和用户体验系列文章，欢迎关注！希望能够帮到大家，也希望能互相交流！共同进步</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3与iframe通信方案详解：本地与跨域场景]]></title>    <link>https://juejin.cn/post/7588031908171579401</link>    <guid>https://juejin.cn/post/7588031908171579401</guid>    <pubDate>2025-12-27T03:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908171579401" data-draft-id="7587779957674557491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3与iframe通信方案详解：本地与跨域场景"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T03:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨梅君"/> <meta itemprop="url" content="https://juejin.cn/user/1086792572082391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3与iframe通信方案详解：本地与跨域场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1086792572082391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨梅君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:42:55.000Z" title="Sat Dec 27 2025 03:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>ps:本项目使用的vue3技术栈</code></p>
<h2 data-id="heading-0">Vue3与iframe通信方案详解：本地与跨域场景</h2>
<p>本文详细介绍了在Vue3项目中，与内嵌iframe（包括本地HTML文件和服务端跨域HTML）进行双向通信的完整解决方案。核心通信方式为<code>postMessage</code> API，并针对不同场景提供了安全可靠的代码示例。</p>
<h3 data-id="heading-1">1. iframe加载本地HTML文件</h3>
<h4 data-id="heading-2">1.1 Vue端通信代码</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
...
    &lt;iframe
        ref=<span class="hljs-string">"iframe"</span>
        name=<span class="hljs-string">"iframe-html"</span>
        src=<span class="hljs-string">"./index.html"</span>
        width=<span class="hljs-string">"100%"</span>
        height=<span class="hljs-string">"100%"</span>
        frameborder=<span class="hljs-string">"0"</span>
    &gt;&lt;/iframe&gt;
...
&lt;/template
</code></pre>
<p>如何在vue端跟iframe端加载的.html文件进行通讯呢,看下面的代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vue端</span>
...
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMsg2iframe</span> = (<span class="hljs-params">msg</span>) =&gt; {
    <span class="hljs-variable language_">window</span>[<span class="hljs-string">"iframe-html"</span>].<span class="hljs-title function_">sendMsg2iframe</span>(msg);
}
...
<span class="hljs-comment">// index.html</span>
...
<span class="hljs-variable language_">window</span>.<span class="hljs-property">sendMsg2iframe</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) {
    <span class="hljs-comment">// 接收到vue端发来的消息</span>
}
...
</code></pre>
<h4 data-id="heading-3">1.2 iframe端（index.html）通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// index.html</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
    <span class="hljs-comment">// 发送消息到父窗口</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
}

<span class="hljs-comment">// vue端</span>
<span class="hljs-comment">// 组件挂载时开始监听消息</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 组件卸载时移除监听，防止内存泄漏</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 接收来自iframe消息的处理函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReceiveMessage</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-comment">// 重要：在实际应用中，应验证event.origin以确保安全</span>
  <span class="hljs-comment">// if (event.origin !== '期望的源') return;</span>
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Vue组件收到来自iframe的消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// 在这里处理接收到的数据</span>
};
</code></pre>
<h3 data-id="heading-4">2. iframe加载服务器HTML（跨域场景）</h3>
<p>其实还是通过window的postMessage进行通讯,只不过是涉及到了跨域问题,下面是具体的代码,关键在于postMessage的第二个参数上</p>
<h4 data-id="heading-5">2.1 html端通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .html</span>
...
<span class="hljs-comment">// 获取url并解析出父窗口的origin</span>
<span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
<span class="hljs-keyword">const</span> parentOrigin = urlParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">'parentOrigin'</span>) || <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;
<span class="hljs-comment">// 监听来自父窗口的消息</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === parentOrigin) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到来自父窗口的消息:'</span>, event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'sendJSON2Unity'</span>){
            <span class="hljs-variable language_">window</span>.<span class="hljs-title class_">SendJSON2Unity</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
        }
    }
});
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
    <span class="hljs-comment">// 发送消息到父窗口</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, parentOrigin);
}
...
</code></pre>
<h4 data-id="heading-6">2.2 Vue端通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .vue</span>
...
&lt;iframe
    ref=<span class="hljs-string">"iframeRef"</span>
    name=<span class="hljs-string">"unity-home"</span>
    :src=<span class="hljs-string">"violationDocumentURL"</span>
    width=<span class="hljs-string">"100%"</span>
    height=<span class="hljs-string">"100%"</span>
    frameborder=<span class="hljs-string">"0"</span>
    @load=<span class="hljs-string">"onIframeLoad"</span>&gt;
&lt;/iframe&gt;
...
<span class="hljs-comment">// 这里把自己的origin通过URL参数传给iframe</span>
<span class="hljs-keyword">const</span> violationDocumentURL = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_U3D_SERVICE</span> + <span class="hljs-string">"具体路径"</span> + <span class="hljs-string">"?parentOrigin="</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);

<span class="hljs-keyword">const</span> iframeRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> iframeOrigin = <span class="hljs-title function_">ref</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_U3D_SERVICE</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/$/</span>, <span class="hljs-string">""</span>));  <span class="hljs-comment">// iframe加载的资源的origin</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendToUnity</span> = (<span class="hljs-params">data</span>) =&gt; {
    iframeRef.<span class="hljs-property">value</span>.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(
        data,
        iframeOrigin.<span class="hljs-property">value</span>
    );
};

<span class="hljs-comment">// 组件挂载时开始监听消息</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 组件卸载时移除监听，防止内存泄漏</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});
<span class="hljs-comment">// 接收来自iframe的消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMessageFromIframe</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-comment">// 确保消息来自可信的来源</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === iframeOrigin.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>) {
            <span class="hljs-comment">// do something</span>
        }
    }
};
</code></pre>
<p>ok基本就是这样的</p>
<h3 data-id="heading-7">3 服务器HTML端（Unity WebGL示例）</h3>
<p>因为我们是加载的unity的webgl包,所以最后附赠一下打出的webgl包的index.html的代码(ps:是不压缩版的)</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en-us"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; height: 100%"</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"text/html; charset=utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Unity WebGL Player | NanDingGDS<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"unity3d-body"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: center; padding: 0; border: 0; margin: 0; width: 100%; height: 100%; overflow: hidden"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"unity-canvas"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background: #231f20"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
			<span class="hljs-comment">/** unity的web包加载逻辑开始 */</span>
			<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"unity-canvas"</span>);
			<span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"unity3d-body"</span>);
			<span class="hljs-keyword">const</span> { clientHeight, clientWidth } = body;

			<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/iPhone|iPad|iPod|Android/i</span>.<span class="hljs-title function_">test</span>(navigator.<span class="hljs-property">userAgent</span>)) {
				<span class="hljs-keyword">var</span> meta = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"meta"</span>);
				meta.<span class="hljs-property">name</span> = <span class="hljs-string">"viewport"</span>;
				meta.<span class="hljs-property">content</span> = <span class="hljs-string">"width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"</span>;
				<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"head"</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">appendChild</span>(meta);
				container.<span class="hljs-property">className</span> = <span class="hljs-string">"unity-mobile"</span>;
				canvas.<span class="hljs-property">className</span> = <span class="hljs-string">"unity-mobile"</span>;
			} <span class="hljs-keyword">else</span> {
				canvas.<span class="hljs-property">width</span> = clientWidth;
				canvas.<span class="hljs-property">height</span> = clientHeight;
			}

			<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"Build/webgl"</span>;
			<span class="hljs-keyword">var</span> loaderUrl = baseUrl + <span class="hljs-string">".loader.js"</span>;
			<span class="hljs-keyword">var</span> myGameInstance = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"script"</span>);
			script.<span class="hljs-property">src</span> = loaderUrl;
			<span class="hljs-keyword">var</span> config = {
				<span class="hljs-attr">dataUrl</span>: baseUrl + <span class="hljs-string">".data"</span>,
				<span class="hljs-attr">frameworkUrl</span>: baseUrl + <span class="hljs-string">".framework.js"</span>,
				<span class="hljs-attr">codeUrl</span>: baseUrl + <span class="hljs-string">".wasm"</span>,
				<span class="hljs-attr">streamingAssetsUrl</span>: <span class="hljs-string">"StreamingAssets"</span>,
				<span class="hljs-attr">companyName</span>: <span class="hljs-string">"DefaultCompany"</span>,
				<span class="hljs-attr">productName</span>: <span class="hljs-string">"FanWeiZhang"</span>,
				<span class="hljs-attr">productVersion</span>: <span class="hljs-string">"0.1.0"</span>,
			};
			script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
				<span class="hljs-title function_">createUnityInstance</span>(canvas, config, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">unityInstance</span>) =&gt;</span> {
					myGameInstance = unityInstance;
					<span class="hljs-title function_">sendMessageToVue</span>({
						<span class="hljs-attr">type</span>: <span class="hljs-string">"unityLoaded"</span>,
						<span class="hljs-attr">message</span>: <span class="hljs-string">"Unity3D加载完成"</span>,
					});
				});
			};
			<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
			<span class="hljs-comment">/** unity的web包加载逻辑结束 */</span>

			<span class="hljs-comment">// 获取url并解析出父窗口的origin</span>
			<span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
			<span class="hljs-keyword">const</span> parentOrigin = urlParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"parentOrigin"</span>) || <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;
			<span class="hljs-comment">// 监听来自父窗口的消息</span>
			<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
				<span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === parentOrigin) {
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"收到来自父窗口的消息:"</span>, event.<span class="hljs-property">data</span>);
					<span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"sendJSON2Unity"</span>) {
						<span class="hljs-variable language_">window</span>.<span class="hljs-title class_">SendJSON2Unity</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
					}
				}
			});
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
				<span class="hljs-comment">// 发送消息到父窗口</span>
				<span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, parentOrigin);
			}

			<span class="hljs-variable language_">window</span>.<span class="hljs-property">SendJSON2Unity</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) {
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发送到Unity的JSON字符串:"</span>, str);
				myGameInstance.<span class="hljs-title class_">SendMessage</span>(<span class="hljs-string">"WebController"</span>, <span class="hljs-string">"receiveJSONByWeb"</span>, str);
			};

			<span class="hljs-variable language_">window</span>.<span class="hljs-property">QuiteUnity</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"退出Unity3D"</span>);
				<span class="hljs-title function_">sendMessageToVue</span>({
					<span class="hljs-attr">type</span>: <span class="hljs-string">"quitUnity"</span>,
					<span class="hljs-attr">message</span>: <span class="hljs-string">"退出Unity3D"</span>,
				});
			};
			<span class="hljs-comment">// window.js2Unity = function (str) {</span>
			<span class="hljs-comment">// 	// 第一个参数是unity中物体的名称,第二是要调用的方法名称,第三个参数是unity中接收到的参数</span>
			<span class="hljs-comment">// 	// myGameInstance.SendMessage('Main Camera', 'TestRotation', '')</span>
			<span class="hljs-comment">//     console.log(str);</span>
			<span class="hljs-comment">// }</span>
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>


</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[算法]时间序列(介绍)]]></title>    <link>https://juejin.cn/post/7588007285547450374</link>    <guid>https://juejin.cn/post/7588007285547450374</guid>    <pubDate>2025-12-27T03:29:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547450374" data-draft-id="7588069469516218409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[算法]时间序列(介绍)"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-27T03:29:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [算法]时间序列(介绍)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:29:20.000Z" title="Sat Dec 27 2025 03:29:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1/什么是时间序列数据？</h2>
<p><strong>时间序列数据</strong> 是按照<strong>固定时间间隔或连续时间点</strong>，按时间顺序排列的一系列<code>观测值</code>或<code>数据点</code>。其核心特征是 <strong>“时间顺序”</strong> 本身就携带了至关重要的信息，数据点之间不是独立同分布的，而是存在<strong>相关性、趋势性或周期性</strong>。</p>
<p>简单来说，如果你打乱数据点的顺序，那么, 其意义就会完全丧失或严重受损，那么这很可能就是时间序列数据。</p>
<h3 data-id="heading-1">核心特征：</h3>
<ol>
<li><strong>时间依赖性（自相关性）</strong>：<code>当前</code>的数据点与<code>过去</code>的数据点相关（例如，今天的温度与昨天、前天的温度有关）。</li>
<li><strong>趋势</strong>：数据在长时间内呈现的上升或下降的方向（例如，公司销售额的长期增长）。</li>
<li><strong>季节性</strong>：数据在固定周期内重复出现的规律模式（例如，每日的交通高峰、每年的冰淇淋销量高峰）。</li>
<li><strong>（可能的）周期性</strong>：非固定频率的波动模式（例如，由经济周期引起的波动）。</li>
</ol>
<h2 data-id="heading-2">2/时间序列数据长什么样？</h2>
<p>在数据结构上，它通常表现为一个带有<strong>时间戳</strong>的二维表格或一个有序的列表/数组。</p>
<h3 data-id="heading-3">典型结构：</h3>



































<table><thead><tr><th align="left">时间戳</th><th align="left">观测值 1</th><th align="left">观测值 2</th><th align="left">...</th></tr></thead><tbody><tr><td align="left">t₁</td><td align="left">x₁</td><td align="left">y₁</td><td align="left">...</td></tr><tr><td align="left">t₂</td><td align="left">x₂</td><td align="left">y₂</td><td align="left">...</td></tr><tr><td align="left">t₃</td><td align="left">x₃</td><td align="left">y₃</td><td align="left">...</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
<ul>
<li><strong>最左边一列（或索引）</strong> 是<strong>时间索引</strong>，这是时间序列数据的“灵魂”。它可以是：
<ul>
<li>等间隔的：<code>2024-01-01 00:00</code>, <code>2024-01-01 01:00</code>, <code>2024-01-01 02:00</code>...</li>
<li>不等间隔的：事件发生的时间戳，如用户点击记录。</li>
</ul>
</li>
<li><strong>每一行</strong>代表在某个特定时间点的“快照”。</li>
<li><strong>每一列</strong>代表一个随时间变化的<strong>特征</strong>或<strong>变量</strong>。可以是单变量（只有一列观测值），也可以是多变量（有多列观测值）。</li>
</ul>
<h2 data-id="heading-4">3/几个具体的例子</h2>
<h3 data-id="heading-5">1. 经典单变量时间序列：某城市每日气温</h3>
<ul>
<li><strong>目标</strong>：预测未来气温。</li>
<li><strong>数据示例</strong>：

































<table><thead><tr><th align="left">日期</th><th align="left">平均温度(°C)</th></tr></thead><tbody><tr><td align="left">2024-01-01</td><td align="left">5.2</td></tr><tr><td align="left">2024-01-02</td><td align="left">4.8</td></tr><tr><td align="left">2024-01-03</td><td align="left">6.1</td></tr><tr><td align="left">2024-01-04</td><td align="left">7.3</td></tr><tr><td align="left">...</td><td align="left">...</td></tr><tr><td align="left">2024-12-31</td><td align="left">3.5</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：只有一个数字序列随时间变化，有明显的季节性和趋势。</li>
</ul>
<h3 data-id="heading-6">2. 金融多变量时间序列：股票分钟级数据</h3>
<ul>
<li><strong>目标</strong>：预测股价走势或进行交易策略分析。</li>
<li><strong>数据示例</strong>：













































<table><thead><tr><th align="left">时间戳</th><th align="left">开盘价</th><th align="left">最高价</th><th align="left">最低价</th><th align="left">收盘价</th><th align="left">成交量</th></tr></thead><tbody><tr><td align="left">2024-05-10 09:30</td><td align="left">150.00</td><td align="left">150.50</td><td align="left">149.80</td><td align="left">150.20</td><td align="left">100000</td></tr><tr><td align="left">2024-05-10 09:31</td><td align="left">150.22</td><td align="left">150.40</td><td align="left">150.05</td><td align="left">150.35</td><td align="left">45000</td></tr><tr><td align="left">2024-05-10 09:32</td><td align="left">150.36</td><td align="left">150.60</td><td align="left">150.30</td><td align="left">150.50</td><td align="left">52000</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：多个相关联的特征（价格、成交量）同时随时间变化，高频且波动剧烈。</li>
</ul>
<h3 data-id="heading-7">3. 物联网传感器数据：智能工厂设备监控</h3>
<ul>
<li><strong>目标</strong>：设备故障预警或预测性维护。</li>
<li><strong>数据示例</strong>：













































<table><thead><tr><th align="left">时间戳</th><th align="left">设备ID</th><th align="left">振动幅度</th><th align="left">温度(°C)</th><th align="left">电流(A)</th><th align="left">压力(MPa)</th></tr></thead><tbody><tr><td align="left">2024-05-10 10:00:00</td><td align="left">Motor_A</td><td align="left">2.1</td><td align="left">65</td><td align="left">10.5</td><td align="left">0.85</td></tr><tr><td align="left">2024-05-10 10:00:01</td><td align="left">Motor_A</td><td align="left">2.2</td><td align="left">65.1</td><td align="left">10.6</td><td align="left">0.86</td></tr><tr><td align="left">2024-05-10 10:00:02</td><td align="left">Motor_A</td><td align="left">5.8</td><td align="left">70.3</td><td align="left">15.2</td><td align="left">0.92</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：通常由多个传感器产生，频率高，是异常检测和模式识别的重要数据源。</li>
</ul>
<h3 data-id="heading-8">4. 业务与网络数据：网站每小时访问量</h3>
<ul>
<li><strong>目标</strong>：资源规划、广告投放。</li>
<li><strong>数据示例</strong>：









































<table><thead><tr><th align="left">日期-小时</th><th align="left">独立访客数</th><th align="left">页面浏览量</th><th align="left">服务器负载</th></tr></thead><tbody><tr><td align="left">2024-05-09 20:00</td><td align="left">10432</td><td align="left">89210</td><td align="left">0.65</td></tr><tr><td align="left">2024-05-09 21:00</td><td align="left">12054</td><td align="left">100345</td><td align="left">0.72</td></tr><tr><td align="left">2024-05-09 22:00</td><td align="left">15321</td><td align="left">134567</td><td align="left">0.85</td></tr><tr><td align="left">2024-05-10 09:00</td><td align="left">8567</td><td align="left">65432</td><td align="left">0.45</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：具有强烈的周期性（日周期：白天高夜间低；周周期：工作日高周末低）。</li>
</ul>
<h3 data-id="heading-9">5. 其他领域的例子：</h3>
<ul>
<li><strong>音频信号</strong>：振幅随时间变化的序列（时间间隔非常短且固定）。</li>
<li><strong>心电图（ECG）</strong>：心脏电活动随时间变化的记录，用于检测异常心跳。</li>
<li><strong>语言文本</strong>：可以将一个句子看作单词在“时间步”上的序列（这里的“时间”是顺序位置）。</li>
</ul>
<h2 data-id="heading-10">5. 在机器学习/深度学习中的应用</h2>
<p>处理时间序列数据的模型需要能够捕捉其<strong>时间依赖性</strong>：</p>
<ul>
<li><strong>传统机器学习方法</strong>：需要手动构造特征，如滞后特征（前1小时的值、前1天的值）、滑动窗口统计量（过去7天的均值、方差）、季节指标等，然后使用回归、随机森林等模型。</li>
<li><strong>深度学习方法</strong>：能自动学习时间模式，是当前的主流：
<ul>
<li><strong>循环神经网络（RNN）及其变体（LSTM, GRU）</strong>：专为序列数据设计，具有“记忆”功能。</li>
<li><strong>时间卷积网络（TCN）</strong>：使用因果卷积来捕获长期依赖。</li>
<li><strong>Transformer模型</strong>：通过自注意力机制，能并行处理并捕获长距离依赖，现在也被广泛应用于时间序列预测（如Informer、Autoformer等模型）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-11">6. 总结</h2>
<p><strong>时间序列数据</strong>就是<strong>带有时间戳、且顺序至关重要的数据</strong>。它广泛存在于我们生活的方方面面，从经济金融到工业制造，从日常天气到人体健康。</p>
<p>识别和理解你的数据是否具有时间序列特性，是选择正确分析方法和机器学习模型的第一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[From Nand to Tetris 里的 Project 3]]></title>    <link>https://juejin.cn/post/7588034035286671375</link>    <guid>https://juejin.cn/post/7588034035286671375</guid>    <pubDate>2025-12-27T03:28:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286671375" data-draft-id="7587997157237735476" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="From Nand to Tetris 里的 Project 3"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2025-12-27T03:28:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金銀銅鐵"/> <meta itemprop="url" content="https://juejin.cn/user/747323638159757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            From Nand to Tetris 里的 Project 3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323638159757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金銀銅鐵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:28:35.000Z" title="Sat Dec 27 2025 03:28:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>让我们按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nand2tetris.org%2Fcourse" target="_blank" title="https://www.nand2tetris.org/course" ref="nofollow noopener noreferrer">From Nand to Tetris</a> 里 <code>Project 3</code> 的要求，来完成下列的设计。</p>
<ol>
<li>实现 <code>Bit</code></li>
<li>实现 <code>Register</code></li>
<li>实现 <code>RAM8</code></li>
<li>实现 <code>RAM64</code> (todo)</li>
<li>实现 <code>RAM512</code> (todo)</li>
<li>实现 <code>RAM4K</code> (todo)</li>
<li>实现 <code>RAM16K</code> (todo)</li>
<li>实现 <code>PC</code> (<code>Program Counter</code>, 程序计数器) (todo)</li>
</ol>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">1. 实现 <code>Bit</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>Bit</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4360e942fb4245b380b2ea54b267197b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=xgG75AOqaD7VroysoPt01Bu2Qc0%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>DFF</code>(<code>Data Flip Flop</code>, 数据触发器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>Bit</code>(即，一位寄存器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * 1-bit register:
 * If load is asserted, the register's value is set to in;
 * Otherwise, the register maintains its current value:
 * if (load(t)) out(t+1) = in(t), else out(t+1) = out(t)
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">in</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">in</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">out</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>书中有一些关于一位 <code>Bit</code>寄存器设计的描述 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c42844bf42f418683e21f007c192cab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=7kPfLu%2BBxZoZa8JlJLEWVvWYDsw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e90012fcc114716ae0884d2f6109fa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=0SUHp1HOxCDNwLVt1Ab%2FSialVvI%3D" alt="微信圖片_2025-12-27_102957_841.jpg" loading="lazy"/></p>
<p>结合书中的描述，我们可以这样来实现</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Bit {
    IN in, load;
    OUT out;

    PARTS:
    Mux(a= previousOut, b= in, sel= load, out= nextOut);
    DFF(in= nextOut, out=out, out= previousOut);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2006e1d8b16f45e0b8739757b23b221c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=RgmjB4csUXiTtkqrctfwD2Vf2kk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2. 实现 <code>Register</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>Register</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b3ff3debca40569679e3e068e6de49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=wJ2kBdsCYgbe7Wa2OmOf5oK%2BH%2F8%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Bit</code>(一位寄存器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>Register</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * 16-bit register:
 * If load is asserted, the register's value is set to in;
 * Otherwise, the register maintains its current value:
 * if (load(t)) out(t+1) = int(t), else out(t+1) = out(t)
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>Bit</code>(一位寄存器)，既然 <code>Register</code> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器，那么可以把 <code>Register</code> 当作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 个一位寄存器的组合。</p>
<p>代码的大意如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Register {
    IN in[16], load;
    OUT out[16];

    PARTS:
    Bit(in= in[0], load= load, out= out[0]);
    Bit(in= in[1], load= load, out= out[1]);
    ...
    Bit(in= in[15], load= load, out= out[15]);
}
</code></pre>
<p>由于这里有很多行类似的代码，自己复制粘贴加修改感觉有点浪费时间，不如用 <code>java</code> 代码来生成它吧。
请将以下代码保存为 <code>RegisterHdlCodeGenerator.java</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.StringJoiner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterHdlCodeGenerator</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
                CHIP Register {
                    IN in[16], load;
                    OUT out[16];
                
                    PARTS:
                %s
                }
                """</span>;

        <span class="hljs-type">StringJoiner</span> <span class="hljs-variable">joiner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringJoiner</span>(System.lineSeparator());
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"    Bit(in= in[%s], load= load, out= out[%s]);"</span>, i, i);
            joiner.add(line);
        }
        System.out.printf(template, joiner);
    }
}
</code></pre>
<p>使用如下的命令可以编译 <code>RegisterHdlCodeGenerator.java</code> 并运行其中的 <code>main</code> 方法。</p>
<pre><code class="hljs language-bash" lang="bash">javac RegisterHdlCodeGenerator.java
java RegisterHdlCodeGenerator
</code></pre>
<p>运行结果如下</p>
<pre><code class="hljs language-text" lang="text">CHIP Register {
    IN in[16], load;
    OUT out[16];

    PARTS:
    Bit(in= in[0], load= load, out= out[0]);
    Bit(in= in[1], load= load, out= out[1]);
    Bit(in= in[2], load= load, out= out[2]);
    Bit(in= in[3], load= load, out= out[3]);
    Bit(in= in[4], load= load, out= out[4]);
    Bit(in= in[5], load= load, out= out[5]);
    Bit(in= in[6], load= load, out= out[6]);
    Bit(in= in[7], load= load, out= out[7]);
    Bit(in= in[8], load= load, out= out[8]);
    Bit(in= in[9], load= load, out= out[9]);
    Bit(in= in[10], load= load, out= out[10]);
    Bit(in= in[11], load= load, out= out[11]);
    Bit(in= in[12], load= load, out= out[12]);
    Bit(in= in[13], load= load, out= out[13]);
    Bit(in= in[14], load= load, out= out[14]);
    Bit(in= in[15], load= load, out= out[15]);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c27aa43e87945ba9eaa44f61b2480a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=rYaxtDSXbX6iBNqFwHVaSyASiGo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">3. 实现 <code>RAM8</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>RAM8</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdec32d0407434a946467c310f9e5e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=8Wnf6QkWlrIgx5Uk31fy1%2B84C8Q%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Register</code>(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 位寄存器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>RAM8</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * Memory of eight 16-bit registers.
 * If load is asserted, the value of the register selected by
 * address is set to in; Otherwise, the value does not change.
 * The value of the selected register is emitted by out.
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">address[3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal">ress</span><span class="mopen">[</span><span class="mord">3</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>Register</code>(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器)。现在需要选择将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span> 输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <code>Register</code> 中的哪一个，可以使用 <code>Project 1</code> 里的 <code>DMux8Way</code>，对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span> 而言，我们可以借助 <code>Project 1</code> 里的 <code>Mux8Way16</code> 从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>e</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">Register</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span></span></span></span></span> 的输出中进行选择。</p>
<p>代码的大意如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP RAM8 {
    IN in[16], load, address[3];
    OUT out[16];

    PARTS:
    DMux8Way(in= load, sel= address,
    a= a, b= b, c= c, d= d, e= e, f= f, g= g, h= h);

    Register(in= in, load= a, out= out0);
    Register(in= in, load= b, out= out1);
    ...
    Register(in= in, load= h, out= out7);

    Mux8Way16(a= out0, b= out1, c= out2, d= out3,
    e= out4, f= out5, g= out6, h= out7,
    sel= address, out= out);
}
</code></pre>
<p>由于这里有很多行类似的代码，自己复制粘贴加修改感觉有点浪费时间，不如用 <code>java</code> 代码来生成它吧。
请将以下代码保存为 <code>RAM8HdlCodeGenerator.java</code>。</p>
<pre><code class="hljs language-bash" lang="bash">javac RAM8HdlCodeGenerator.java
java RAM8HdlCodeGenerator
</code></pre>
<p>运行结果如下</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP RAM8 {
    IN in[16], load, address[3];
    OUT out[16];

    PARTS:
    DMux8Way(in= load, sel= address,
    a= a, b= b, c= c, d= d, e= e, f= f, g= g, h= h);

    Register(in= in, load= a, out= out0);
    Register(in= in, load= b, out= out1);
    Register(in= in, load= c, out= out2);
    Register(in= in, load= d, out= out3);
    Register(in= in, load= e, out= out4);
    Register(in= in, load= f, out= out5);
    Register(in= in, load= g, out= out6);
    Register(in= in, load= h, out= out7);

    Mux8Way16(a= out0, b= out1, c= out2, d= out3,
    e= out4, f= out5, g= out6, h= out7,
    sel= address, out= out);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a9798a375ac4b2a9bc358ffe2817cb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=fJ7hLlM4I4NcL11kbOucR5qNlYM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">4. 实现 <code>RAM64</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>RAM64</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b0c5811dcf54ff4acaf53113eff91b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=KjmQMcz1Uh99H2YgTxke7ZlyL%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>RAM8</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>RAM64</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn></mrow><annotation encoding="application/x-tex">64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * Memory of sixty four 16-bit registers.
 * If load is asserted, the value of the register selected by
 * address is set to in; Otherwise, the value does not change.
 * The value of the selected register is emitted by out.
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mn>6</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">address[6]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal">ress</span><span class="mopen">[</span><span class="mord">6</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>RAM8</code>，可以用类似的思路来实现 <code>RAM64</code>。</p>
<h2 data-id="heading-6">参考资料</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项]]></title>    <link>https://juejin.cn/post/7587776610437120015</link>    <guid>https://juejin.cn/post/7587776610437120015</guid>    <pubDate>2025-12-27T04:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610437120015" data-draft-id="7588004376867242019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-27T04:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:16:46.000Z" title="Sat Dec 27 2025 04:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Redis作为高性能的内存数据库，凭借其亚毫秒级响应速度和丰富的数据结构，已成为现代分布式系统的核心组件。然而，正是由于其"开箱即用"的简便性，许多开发者往往忽视了深层次的配置调优。本文揭示的5个配置项不会触发任何错误日志，却可能在不经意间将Redis的性能腰斩——从吞吐量骤降到延迟飙升。这些"隐秘杀手"的背后，是内存管理、网络协议和持久化机制的深度耦合。</p>
<hr/>
<h3 data-id="heading-2">1. <code>hz</code>：定时任务频率的甜蜜与陷阱</h3>
<p><strong>问题本质</strong>：<br/>
<code>hz</code>参数（默认10）控制Redis后台任务的执行频率，包括过期键清理、rehash操作等。看似无害的数值调整实则暗藏玄机：</p>
<ul>
<li><strong>性能悬崖</strong>：当<code>hz &gt; 100</code>时，CPU利用率呈指数级增长（实测从10→100会使CPU占用率提升3倍）</li>
<li><strong>过期键堆积</strong>：<code>hz=1</code>可能导致大量已过期键未被及时清理，内存占用虚高</li>
</ul>
<p><strong>黄金法则</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> 生产环境建议值：5~50（根据服务器核心数调整）
<span class="hljs-bullet">-</span> 监控指标：观察<span class="hljs-code">`evicted_keys`</span>和<span class="hljs-code">`expired_keys`</span>的增长趋势
</code></pre>
<hr/>
<h3 data-id="heading-3">2. <code>tcp-backlog</code>：连接风暴的第一道防线</h3>
<p><strong>隐藏危机</strong>：<br/>
默认值511在高并发场景下会成为瓶颈。当客户端连接激增时：</p>
<pre><code class="hljs language-math" lang="math">实际可用backlog = min(tcp-backlog, /proc/sys/net/core/somaxconn)
</code></pre>
<p>未处理的连接会直接丢弃（无错误日志！），表现为客户端偶发连接超时。</p>
<p><strong>调优策略</strong>：</p>
<ol>
<li>同时调整系统级参数：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 2048 &gt; /proc/sys/net/core/somaxconn
</code></pre>
</li>
<li>Redis配置同步更新：
<pre><code class="hljs language-redis.conf" lang="redis.conf">tcp-backlog 2048
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">3. <code>repl-disable-tcp-nodelay</code>：复制延迟的元凶</h3>
<p><strong>网络协议层的博弈</strong>：<br/>
主从复制时启用该选项（默认关闭）会导致：</p>
<ul>
<li>Nagle算法堆积小包</li>
<li>同步延迟增加30%~300%（实测RTT&gt;100ms时影响显著）</li>
</ul>
<p><strong>决策树</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[跨机房同步?] --&gt;|是| B[开启 repl-disable-tcp-nodelay]
    A --&gt;|否| C[保持关闭状态]
</code></pre>
<hr/>
<h3 data-id="heading-5">4. <code>hash-max-ziplist-entries/value</code>：内存与CPU的零和游戏</h3>
<p>数据结构编码的临界点控制着内存效率与计算开销的平衡：</p>




















<table><thead><tr><th>数据类型</th><th>默认阈值</th><th>超出后编码转换</th></tr></thead><tbody><tr><td>Hash</td><td>entries:512, value:64字节</td><td>ziplist → hashtable</td></tr><tr><td>Set</td><td>entries:512</td><td>intset → hashtable</td></tr></tbody></table>
<p><strong>压测数据揭示的真相</strong>：</p>
<ul>
<li>Value=60字节时，内存节省40%</li>
<li>Value=65字节时，QPS下降22%</li>
</ul>
<p>最佳实践：</p>
<pre><code class="hljs language-redis.conf" lang="redis.conf"># 根据实际value尺寸动态调整
hash-max-ziplist-value 128 
</code></pre>
<hr/>
<h3 data-id="heading-6">5. <code>client-output-buffer-limit</code>：复制中断的无形之手</h3>
<p>Pub/Sub和主从复制的缓冲区限制常被低估：</p>
<pre><code class="hljs language-redis.conf" lang="redis.conf"># Default值风险场景:
client-output-buffer-limit replica 256mb 64mb 60

# Slave全量同步20GB数据时:
1. Buffer瞬时突破256MB硬限制
2. Master强制断开连接（仅在slow log记录）
</code></pre>
<p>金融级配置建议：</p>
<pre><code class="hljs language-markdown" lang="markdown">replica:
 hard limit ≥ max(rdb<span class="hljs-emphasis">_file_</span>size)<span class="hljs-emphasis">*1.5 
 soft limit ≥ network_speed *</span> sync<span class="hljs-emphasis">_time 
</span></code></pre>
<hr/>
<h3 data-id="heading-7">Linux层协同优化备忘录</h3>
<p>即使Redis配置完美，OS层面的误配仍会抵消优化效果：</p>
<ol>
<li><strong>透明大页禁用</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</code></pre>
</li>
<li><strong>NUMA架构绑定</strong>：
<pre><code class="hljs language-bash" lang="bash">numactl --interleave=all redis-server ...
</code></pre>
</li>
<li><strong>SWAPiness归零</strong>：
<pre><code class="hljs language-bash" lang="bash">vm.swappiness = 0 
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">Conclusion: Redis调优的三重境界</h3>
<ol>
<li><strong>基础层</strong>: memory_limit/timeout等显式参数</li>
<li><strong>进阶层</strong>: hz/tcp-backlog等隐性交互参数</li>
<li><strong>专家层</strong>: OS内核参数与硬件拓扑适配</li>
</ol>
<p>真正的性能优化不在于追求某个参数的极致调校，而在于理解各层级组件的相互作用关系。建议通过<code>redis-cli --latency-history -i 1</code>持续监测微观延迟变化，结合火焰图定位隐形瓶颈。记住：没有放之四海而皆准的最优配置，只有与业务特征完美契合的参数组合。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 四格笑话爆火，我做了什么?]]></title>    <link>https://juejin.cn/post/7588004601392529442</link>    <guid>https://juejin.cn/post/7588004601392529442</guid>    <pubDate>2025-12-27T04:15:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601392529442" data-draft-id="7587776610437103631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 四格笑话爆火，我做了什么?"/> <meta itemprop="keywords" content="AIGC,前端"/> <meta itemprop="datePublished" content="2025-12-27T04:15:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 四格笑话爆火，我做了什么?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:15:38.000Z" title="Sat Dec 27 2025 04:15:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h4 data-id="heading-0">0. 前言</h4>
<p>在 2025年的尾巴上，发生了一件非常有趣的事，我在微信公众号上的 <code>AI 四格漫画</code> 意外爆火。之前公众号上发的技术文章，基本上阅读量不过 300，每天广告收益也就几毛钱。目前最火的美杜莎，浏览量已经达到惊人的 <strong>5W</strong>。这样让我不禁感叹:</p>
<blockquote>
<p>十年技术无人问，一曲漫笑广人闻。</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b1c44a5bf7243779841d17bfabc4824~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=586&amp;h=299&amp;s=55292&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></p>
<hr/>
<p>火爆之后，带来的最直接价值就是迎来了泼天富贵。从未想过有一天，我的日广告收益能达到 250+ ，目前已经连续三天高位。除了金钱，自己的作品受到欢迎，以及大家在评论区的吐槽、讨论，也为我带来了很大的情绪价值。</p>













<table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b915619f897b416e95a417900cef5108~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=680744&amp;e=png&amp;b=f1f7f7" alt="" loading="lazy"/></td><td><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d24cf6d8bff47b7bd5094625ed5dca8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=220732&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-1">1. 缘起</h4>
<p>先简单介绍一下：我是一个籍籍无名的编程技术小博主，全网统一名号 <code>张风捷特烈</code> 。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyAQXh0UbMMU5cI5nmSJYWw" target="_blank" title="https://mp.weixin.qq.com/s/yAQXh0UbMMU5cI5nmSJYWw" ref="nofollow noopener noreferrer">编程之王</a> 是我维护的公众号，一直是输出编程技术的文章，主要以 Flutter 技术为主。<br/>
但技术文章更新的不是非常频繁，而公众号每天有一篇发文的机会。本着 <code>不想浪费</code> 的优良传统，在 AI 重塑一切的浪潮中，我想用 AI 画些四格漫画的笑话试试。于是开启了 <strong>慧心一笑</strong> 专栏， <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHtpVgVF7HZlqrVS37-R82w" target="_blank" title="https://mp.weixin.qq.com/s/HtpVgVF7HZlqrVS37-R82w" ref="nofollow noopener noreferrer">《小火柴的倒霉日常》</a> 就是第一篇，现在还没火。大家也可以点开看看，内容非常精简，就是一幅图+提示词。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fb9e88c522489db9ec8bcb2f6163fd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=576&amp;h=299&amp;s=47926&amp;e=png&amp;b=fdfafa" alt="" loading="lazy"/></p>
<p>这个系列整体是诙谐幽默的，下面是第一篇的内容：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3034eb513f304e2ca0e8199ce5afff6e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=524412&amp;e=png&amp;b=fae8ca" alt="" loading="lazy"/></p>
<p>一开始我是用自然语言的提示词，感觉效果并不是太好，四格漫画有着连续的信息和一致性的人物、场景等。由于编程出身，在 <strong>结构一致性</strong> 方面有着天然的敏锐嗅觉。于是基于 yaml 文件来定义统一的场景、角色、样式、色调等信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">comic_info:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"四格漫画"</span>
  <span class="hljs-attr">style:</span> <span class="hljs-string">"手绘简笔画、柔软线条、轻松冷幽默、统一角色"</span>
  <span class="hljs-attr">color_scheme:</span> <span class="hljs-string">"暖黄主色调，红橙色点缀，柔和明暗层次"</span>
  <span class="hljs-attr">character:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">"小火柴"</span>
    <span class="hljs-attr">appearance:</span> <span class="hljs-string">"细长圆柱身体、红色火柴头、两根短竖眉毛、圆点眼睛、呆萌可爱"</span>
    <span class="hljs-attr">personality:</span> <span class="hljs-string">"迷糊、天真、略倒霉"</span>
  <span class="hljs-attr">background_style:</span> <span class="hljs-string">"白色简约背景，搭配少量手绘街景或物件增强生活感"</span>
</code></pre>
<p>面板列表放在 <code>panels</code> 节点下，每个宫格由 <code>panel[x]</code> 固定场景内容。包括描述、场景、动作、表情、细节、文本等：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">panels:</span>
  <span class="hljs-attr">panel1:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"第一格：日常铺垫"</span>
    <span class="hljs-attr">scene:</span> <span class="hljs-string">"温暖的手绘街道：地面为淡黄色纹理，简单的路灯、几株小草、远处一座小房子，空气里飘着幾颗小亮点"</span>
    <span class="hljs-attr">action:</span> <span class="hljs-string">"小火柴双手背在身后，踩着轻快的小步子前进"</span>
    <span class="hljs-attr">expression:</span> <span class="hljs-string">"轻松微笑，眼睛微弯"</span>
    <span class="hljs-attr">details:</span> <span class="hljs-string">"路灯用细线勾勒，小草三两稀疏点缀，天空加几朵柔软的白云"</span>
    <span class="hljs-attr">text:</span> <span class="hljs-string">"今天天气真好呀～"</span>
</code></pre>
<p>定义完结构，一个 yaml 文件就对应了一个四格故事，把这个内容丢给 AI 生图的工具，就能得到对应的图片。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91ae4dded9a14567a1c438a1825e562c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=915&amp;h=380&amp;s=154672&amp;e=png&amp;b=f2f0ef" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-2">2. 关于 AI 生图工具与质量</h4>
<p>我的理念是: 文本是一种序列的约定：</p>
<blockquote>
<p>它可以视为一个四格漫画的 <strong>基因</strong>，而 AI 工具会将基因 <code>实例化</code> 为个体。</p>
</blockquote>
<p>所以，生成图的好坏取决于两个因素：<code>基因序列</code> 和 <code>成长环境</code>。也就是提示词好不好，以及 AI 工具厉不厉害。 AI 生图的工具有很多，单目前大多数，对于标准的四格漫画都无法准确输出，下面列举几个:</p>
<ul>
<li><strong>即梦 AI</strong></li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24c632cf9ce741178152d97096667b3c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1032&amp;h=264&amp;s=407121&amp;e=png&amp;b=f3ce85" alt="" loading="lazy"/></p>
<ul>
<li><strong>豆包</strong></li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3d692710bcc4d7f9c929d2f46d960cf~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1238&amp;h=337&amp;s=493504&amp;e=png&amp;b=faf5f2" alt="" loading="lazy"/></p>
<ul>
<li><strong>Nano Banana</strong></li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91553066f86742428df4d6b3cdd7be29~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=760444&amp;e=png&amp;b=f8efdb" alt="" loading="lazy"/></p>
<p>目前来看，国产的 AI 仍有很大的进步空间，Nano Banana 能符合我对图片产品的预期。但是 AI 正在蓬勃发展中， AI 生图也是最近一两年才逐渐可用的，我对他们的未来持有乐观的态度，包括我们国产的大模型。所以如果 <code>成长环境</code> 将会越来越好，那么 <code>基因序列</code> 本身将会成为非常重要的因素。<br/>
目前我只是简单设计了一下 <code>yaml</code>，按照版本控制，称为 <code>v0.0.1</code> 吧，后续随着创作需求的升级，我也会逐步迭代整体结构，设计更合理的 DNA 结构 😁</p>
<hr/>
<h4 data-id="heading-3">3. 选定方向? Flow Heart</h4>
<blockquote>
<p>有人问我，你是怎么想到这些稀奇古怪的方向的，而且你是怎么坚持下来的。</p>
</blockquote>
<p>对于一个创作者来说，拓宽自己的边界是一个很必要的事。特别是对一个编程创作者，广泛涉猎是家常便饭。使用一切手段，解决自己遇到的问题；没有问题时就去发展自己，在新的领域中寻找问题。至于坚持嘛，遵循内心的指引，做自己喜欢的事，是不需要坚持的，就像你每天都要喝水一样自然。</p>
<p>可能有人会问，如果 AI 的笑话漫画没有火，你还会坚持下去吗？刚做前两个漫画文章时，还没有火，一天收入 1 块钱，我已经觉得很美滋滋了。投入的产出符合我的预期，毕竟只需要准备个笑话雏形，其他都交给 AI 写就行了。我还和女朋友炫耀：</p>













<table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5dd9d09b880c4c308b22fb00102e5d8e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=567607&amp;e=png&amp;b=efefef" alt="" loading="lazy"/></td><td><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd13ed472dad4cc29bf19406222c89e4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=689970&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></td></tr></tbody></table>
<p>最后还是想强调一点：如果一件事，对社会、对他人没有危害，自己做着觉得开心，起来没有负担和压力，就会大胆去做。反之，可以在其他方面继续延伸，找到自己喜欢的那个领域。AI 工具的加持，让个体拥有了前所未有的能力，个人的边界可以极度拓宽。</p>
<hr/>
<h4 data-id="heading-4">4. 为什么会火？</h4>
<p>第一次感觉会火，是因为<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXe85NV6MyPKkpn1yBypO-w" target="_blank" title="https://mp.weixin.qq.com/s/Xe85NV6MyPKkpn1yBypO-w" ref="nofollow noopener noreferrer">擎天柱</a> 这篇，浏览量异常上升：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef21681d63e145f29235d572fbd7bce0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=867925&amp;e=png&amp;b=e5d2c4" alt="" loading="lazy"/></p>
<p>从数据统计来看，发布第一天只有 <code>102</code> 个浏览量，和往常没什么区别。持续一周，没有任何波澜，突然在 <code>12-20</code> 号，增加了近 5000 的浏览量，第二天持续上涨过万，然后逐渐平息：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9c973d0ef6b4fa19539b418eed93fc0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=899&amp;h=377&amp;s=22716&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<p>在第一篇爆火的后一天，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FD2w8-ar9rnVQV3_TG962cA" target="_blank" title="https://mp.weixin.qq.com/s/D2w8-ar9rnVQV3_TG962cA" ref="nofollow noopener noreferrer">慧心一笑#03 | 爸爸去钓鱼~</a> 数据开始上升，感觉像是连带效应：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53a8c23e77e04e7987e5e992067dc562~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=800570&amp;e=png&amp;b=f4e6d1" alt="" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/224bf13e450c4f5fb5df7061538333cb~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=818&amp;h=341&amp;s=16760&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<p>为了验证一下是不是偶然火爆，我在 20号和 21 号又发表了两篇小笑话。结果不温不火，似乎感觉也不是必然的。
在 23 号，我发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyAQXh0UbMMU5cI5nmSJYWw" target="_blank" title="https://mp.weixin.qq.com/s/yAQXh0UbMMU5cI5nmSJYWw" ref="nofollow noopener noreferrer">慧心一笑#06 | 被美杜莎石化...</a>，这篇在当晚直接火爆，</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d5faef41ea940c8ad487493aa31412e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=917880&amp;e=png&amp;b=ede6d6" alt="" loading="lazy"/></p>
<p>从数据来看，第二天浏览量直接过 2.6W，后面还有持续几天的流量：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9632f58583be4c81ba2415c33b9edcd2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=914&amp;h=324&amp;s=14984&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>至于为什么火爆，从阅读渠道构成来看 <code>98.7%</code> 的阅读量来自于公众号推荐。只能说是老天喂饭吃 ~</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a886ef8bfd814300aa23866ec6cd79a0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1073&amp;h=394&amp;s=17807&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">5. 小结一下</h4>
<p>接下来几天的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlOUrPCfYJWKTNSwkhcE6JQ" target="_blank" title="https://mp.weixin.qq.com/s/lOUrPCfYJWKTNSwkhcE6JQ" ref="nofollow noopener noreferrer">慧心一笑#07 | 爸爸回来了...</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FrS1bGeTldt1a6veIg4f_sw" target="_blank" title="https://mp.weixin.qq.com/s/rS1bGeTldt1a6veIg4f_sw" ref="nofollow noopener noreferrer">慧心一笑#09 | 农夫与蛇</a> 也阅读过 3万。目前慧心一笑系列发布了 9 篇，阅读量超过 2.5W 的爆款有 5 篇，比例算是很高了。</p>
<p>感觉微信公众号的推荐阅读机制应该有所变化。另外也不是每篇都会火爆，应该和作品本身质量、流传度也有关系。这个有趣的现象让我非常欣喜，后续我还会继续创作更有意思的四格漫画，来继续验证数据。大家也可以关注 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">《编程之王》</a> 公众号和我一起见证。等到第 30 篇后，我会再写一个复盘报告，和大家分享。</p>
<p>另外可能会有人问，你发这个就不怕别人也抄你的模式，跟你竞争吗。我只想说：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5c615ad68ad487fb38a55bc60c2a932~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=746498&amp;e=png&amp;b=162632" alt="" loading="lazy"/></p>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn/?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn/?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱]]></title>    <link>https://juejin.cn/post/7588028859541078042</link>    <guid>https://juejin.cn/post/7588028859541078042</guid>    <pubDate>2025-12-27T04:34:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541078042" data-draft-id="7588042910194925618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2025-12-27T04:34:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:34:57.000Z" title="Sat Dec 27 2025 04:34:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>最近有位宝妈给我发了一个公众号，这个公众号做的内容就是根据不同的主题去分享给宝宝取小名，比如“用五谷取小名，越念越有福”、“以茶叶取小名，好听到爆”等，看了下这个公众号的数据，还是挺不错的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37fe724c1cf74c89ba4df205b5460465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=0Fu7jw3VsGxplEPpOuMQWj0fbFI%3D" alt="" loading="lazy"/></p>
<p>我问她为何盯上这个赛道了？她说自己也经历过给自己的宝宝取小名，当时要能看到这个公众号，那就省事多了。</p>
<p>她说平时在家里带娃，有时间想搞点事情，看着这个文章很简短比较容易上手，内容也很有趣，就想尝试做一下。</p>
<p>我分析了一下这个公众号的多篇文章，发现这类文章非常的精致，无论是文章的封面图，还是排版，都搭配得刚刚好，比较容易吸引人眼球。</p>
<p>经过对这些文章的分析，发现可以用扣子一键生成，只需要输入你想要的一个主题和想要的小名数量即可。</p>
<p>在开始工作流讲解之前我们先来看看效果，比如我输入“叠音不叠字，越念越有福的小名”这么个主题，要求生成的小名的数量为15个，选择颜色主题为粉色，经过一段时间的运行，文章就生成好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ab5e5555fb4e9fbd28a29b36400ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=OS19Fstx5zxe5BSPSfobNMwCJ8o%3D" alt="" loading="lazy"/></p>
<p>尝试换个主题“用五谷取小名，越念越有福”，小名数量为15个，主题选择绿色，看看效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/172d5a56fc94468ea671c993b189719b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=llQlnS7t35%2FMD14lh5UOaRGxBeU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad2329b26d142519ecd6591e9c94088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=QW4qAJq5kItH530MLsNQOYjMeyg%3D" alt="" loading="lazy"/></p>
<p>1、取小名：通过大模型，根据输入的主题生成宝宝小名、小名解释、Emoji表情。</p>
<p>2、封面图绘图提示词生成：通过大模型生成可爱治愈风格的封面图绘图提示词。</p>
<p>3、封面图生成：依据生成好的绘图提示词生成图片，然后使用画板将图片合成封面图。</p>
<p>4、文章排版：将生成好的宝宝小名、小名解释、Emoji表情进行排版。</p>
<p>5、文章草稿生成：将排版好的文章内容、标题、封面图一起生成公众号文章草稿。</p>
<h2 data-id="heading-1">2. 工作流详细节点解读</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>subject：文章主题，必填</li>
<li>nums：小名数量，必填</li>
<li>app_id：微信公众号开发者ID，必填</li>
<li>app_secret：微信公众号开发者密码，必填</li>
<li>api_token：插件认证，可后台回复【芝麻开门】联系获取（有条件），必填</li>
<li>color：主题色，支持 绿色(默认)、橙色、黄色、粉色、青色、蓝色、紫色，非必填</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3fd2e1e1c44d0690f1206ffaf95b90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=rxlAmvAIBg5eAxQ9pntE370DABY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 取小名</h3>
<p>这个节点使用到了扣子官方的大模型节点，用来生成宝宝小名、小名解释和Emoji表情，参数如下：</p>
<ul>
<li>模型：选择【DeepSeek-V3.1】</li>
<li>输入</li>
</ul>

<ul>
<li>
<ul>
<li>subject：开始 -&gt; subject</li>
<li>nums：开始 -&gt; nums</li>
</ul>
</li>
</ul>

<ul>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>name_infos：小名信息列表，包含小名、小名解释、emoji表情</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d31971526f43bc8cb3a01995b1884d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=5Spu4v33eBbEb65uXeLz7pSyMcM%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，伪提示词，可以到豆包进行反推。</li>
</ul>

<pre><code class="hljs">你要变身专业宝宝小名创意顾问，结合文化与自然意象，为宝宝生成两字温暖好听的小名。
用户给主题和数量后，先确认需求，再按自然物、传统文化等主题特性，用谐音、经典或意象生成两字小名，简洁无生僻字。
给每个小名配贴切 Emoji，用 1-2 句画面感语言解释，结合主题与吉祥寓意。
最后按 “Emoji + 【小名】 + 解释” 列表输出，严格匹配数量，仅做宝宝小名相关内容，解释不超 20 字，主题不明确时提示用户补充。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9be78f21a0db4f87b3affda4c1ca4acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=vuu%2BmG8clskRXdNPp6VVVn7e2jM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 封面图绘图提示词</h3>
<p>这个节点用来生成封面图的绘图提示词，使用到了扣子官方的大模型节点，这个节点主要是生成一些可爱治愈风的绘图提示词即可，它的参数如下：</p>
<ul>
<li>模型：选择【豆包-1.5-Pro-32k】</li>
<li>无输入</li>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>prompt1：提示词1</li>
<li>prompt2：提示词2</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a889156660404290bbf2ce478e1b24f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=zlnEahL3a1fK2tzD5rNaJQYJ%2BAg%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可以到豆包进行反推。</li>
</ul>

<pre><code class="hljs">你要变身 AI 绘画提示词生成器，专注生成 “圆脸蛋腮红萌娃” 风格、适配 “同框合并” 的插画提示词。
核心形象是胖乎乎东亚萌娃，大圆脸蛋加大面积粉嫩腮红、无辜大眼睛、幼态短刘海或可爱发型。
每次输出 2 条提示词，服饰完全一致，动作表情不同但适配同框。
服饰从指定穿搭组合选，动作表情从对应维度选。固定风格为柔和马卡龙色调、手绘插画质感、干净米白色背景、暖柔光线、高细节、8K、治愈可爱氛围。
按 “核心形象 + 统一服饰 + 对应动作 + 对应表情 + 统一背景 + 固定风格” 格式分 2 条展示。
</code></pre>
<h3 data-id="heading-5">2.4. 图像生成</h3>
<p>这个节点使用到了扣子官方的图像生成节点，用来生成封面图片，需要注意的是这里使用到了Seedream4.0大模型，官方定价是200资源点（约0.2元）一张图，调试需谨慎。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5dd589f5cd7448288d0aa66f2452726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=tqrbL%2Fi0tLmdDZ%2F7e7%2BBCXT7rqQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 图像列表扁平化</h3>
<p>因为画板节点只能接收单张图片，而生图节点出来的是图片列表，所以需要这个节点把图片列表变成一张张图片，传入给画板，使用到了三方插件【列表工具合集】的【str_list_2_str】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b5e203cba14ed890191757464a8e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=I5fHYrBDrdgWYqv7ylKPu9rkfsA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 合成封面图</h3>
<p>这里使用到了扣子官方的画板节点，作用是把生成的两张图片合并成一张封面图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab3ce65035c542f99956a884cf2d99d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=PiYGtdnZYHZzyRjfUm0%2BQYJ%2FrPI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.7. 文章内容排版</h3>
<p>这个节点的作用是把生成好的Emoji表情、宝宝小名、宝宝小名解释进行文章排版，使用到了三方插件【公众号文章模板】的【text_list_layout】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfbf47b8bb764516a7fe17a6d011e059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=z0S1mT1v9KBbBMTpe%2FPw18AkDKo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.8. 获取接口调用凭证</h3>
<p>这个节点用来获取微信公众号接口调用凭证，使用到了三方插件【微信公众号接口】的【get_access_token】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c6e02ef74740118408a8838ff03109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=K8%2BPgxae%2BuqMLqjZZT3CgVolDZM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">2.9. 上传封面图</h3>
<p>这个节点用来上传封面图到公众号素材库中，使用到了三方插件【微信公众号接口】的【wx_upload_image】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cadb4ceacfa148e8bc8057bd8db7f4b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=hf56I6Qytv63PWVuRgH%2Bhq95uiw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">2.10. 添加文章草稿</h3>
<p>这个节点用来生成公众号文章草稿，使用到了三方插件【微信公众号接口】的【add_draft】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b27aedcd6da645a297dc2160f6d98817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=xyeutIR1TOSPymjfBr88t%2BGpDZI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.11. 结束</h3>
<p>media_id有值说明成功，没有值，说明失败了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a52992db81d466bb9c7a765f9ecf13a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=RKgj7WTQ6pFj8tjSlzKdSDQfWs4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">3. 总结</h2>
<p>本文介绍了如何使用工作流实现“宝宝小名”文章的一键生成，文中详细介绍了工作流中每个节点的输入、输出、参数以及作用，工作流节点不算多，照着操作，应该不难搭建。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。有什么疑问也可以打在评论区，吾鳴会第一时间回复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceda64b899984f86be3fdf4189cad835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=bvaRZD8QRs3SryMu73xzSZbMpFI%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 源码全景图：从宏观到微观]]></title>    <link>https://juejin.cn/post/7588007285547286534</link>    <guid>https://juejin.cn/post/7588007285547286534</guid>    <pubDate>2025-12-27T02:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547286534" data-draft-id="7588149079400742955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 源码全景图：从宏观到微观"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T02:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 源码全景图：从宏观到微观
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:41:41.000Z" title="Sat Dec 27 2025 02:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 19 源码全景图：从宏观到微观</h2>
<blockquote>
<p>本文是 React 源码系列的总览篇，帮你建立完整的知识框架，后续文章将逐一深入。</p>
</blockquote>
<h3 data-id="heading-1">一、React 是什么？</h3>
<p>一句话：<strong>React 是一个将状态映射为 UI 的函数</strong>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">UI</span> = f(state)
</code></pre>
<p>当状态变化时，React 会：</p>
<ol>
<li>计算新的 UI（Reconciler）</li>
<li>调度更新任务（Scheduler）</li>
<li>将变化应用到 DOM（Renderer）</li>
</ol>
<h3 data-id="heading-2">二、三大核心模块</h3>
<pre><code class="hljs language-php" lang="php">┌─────────────────────────────────────────────────────────┐
│                        你的代码                          │
│            &lt;App /&gt; → useState → setState                │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   Scheduler 调度器                       │
│                                                         │
│  • 优先级管理（用户交互 &gt; 动画 &gt; 数据请求）               │
│  • 时间切片（<span class="hljs-number">5</span>ms 一片，避免卡顿）                        │
│  • 任务队列（最小堆实现）                                │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Reconciler 协调器                       │
│                                                         │
│  • <span class="hljs-built_in">Fiber</span> 架构（可中断的链表结构）                        │
│  • Diff 算法（最小化 DOM 操作）                          │
│  • Hooks 系统（状态和副作用管理）                        │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   Renderer 渲染器                        │
│                                                         │
│  • ReactDOM（Web）                                      │
│  • React Native（移动端）                               │
│  • React Three <span class="hljs-built_in">Fiber</span>（<span class="hljs-number">3</span>D）                              │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">三、核心概念速览</h3>
<h4 data-id="heading-4">1. Fiber</h4>
<p>Fiber 是 React 的核心数据结构，每个组件对应一个 Fiber 节点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-comment">// 类型信息</span>
  tag,              <span class="hljs-comment">// 组件类型（函数组件=0，类组件=1，DOM=5）</span>
  type,             <span class="hljs-comment">// 组件函数或 DOM 标签</span>
  
  <span class="hljs-comment">// 树结构</span>
  <span class="hljs-keyword">return</span>,           <span class="hljs-comment">// 父节点</span>
  child,            <span class="hljs-comment">// 第一个子节点</span>
  sibling,          <span class="hljs-comment">// 兄弟节点</span>
  
  <span class="hljs-comment">// 状态</span>
  memoizedState,    <span class="hljs-comment">// Hooks 链表</span>
  memoizedProps,    <span class="hljs-comment">// 上次的 props</span>
  
  <span class="hljs-comment">// 副作用</span>
  flags,            <span class="hljs-comment">// 标记（插入、更新、删除）</span>
  
  <span class="hljs-comment">// 双缓冲</span>
  alternate,        <span class="hljs-comment">// 另一棵树的对应节点</span>
}
</code></pre>
<h4 data-id="heading-5">2. Lane（优先级）</h4>
<p>React 19 使用 31 位二进制数表示优先级：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">SyncLane</span>           = <span class="hljs-number">0b0000000000000000000000000000010</span>  <span class="hljs-comment">// 同步（最高）</span>
<span class="hljs-title class_">InputContinuousLane</span> = <span class="hljs-number">0b0000000000000000000000000001000</span>  <span class="hljs-comment">// 连续输入</span>
<span class="hljs-title class_">DefaultLane</span>        = <span class="hljs-number">0b0000000000000000000000000100000</span>  <span class="hljs-comment">// 默认</span>
<span class="hljs-title class_">TransitionLane</span>     = <span class="hljs-number">0b0000000000000000000000010000000</span>  <span class="hljs-comment">// 过渡</span>
<span class="hljs-title class_">IdleLane</span>           = <span class="hljs-number">0b0010000000000000000000000000000</span>  <span class="hljs-comment">// 空闲（最低）</span>
</code></pre>
<h4 data-id="heading-6">3. 双缓冲</h4>
<p>React 维护两棵 Fiber 树：</p>
<ul>
<li><strong>current</strong>：当前屏幕显示的</li>
<li><strong>workInProgress</strong>：正在构建的</li>
</ul>
<p>更新完成后一行代码切换：<code>root.current = workInProgress</code></p>
<h3 data-id="heading-7">四、渲染流程</h3>
<h4 data-id="heading-8">完整流程图</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setState</span>() 
    │
    ▼
<span class="hljs-built_in">scheduleUpdateOnFiber</span>()     ← 标记更新
    │
    ▼
<span class="hljs-built_in">ensureRootIsScheduled</span>()     ← 确保调度
    │
    ▼
<span class="hljs-built_in">scheduleCallback</span>()          ← Scheduler 调度
    │
    ▼
<span class="hljs-built_in">performConcurrentWorkOnRoot</span>() ← 开始渲染
    │
    ├─────────────────────────────────────┐
    │         Render 阶段（可中断）         │
    │                                     │
    │  <span class="hljs-built_in">workLoopConcurrent</span>()               │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">performUnitOfWork</span>() ←──┐           │
    │      │                  │           │
    │      ▼                  │           │
    │  <span class="hljs-built_in">beginWork</span>()            │ 循环      │
    │      │                  │           │
    │      ▼                  │           │
    │  <span class="hljs-built_in">completeWork</span>() ────────┘           │
    │                                     │
    └─────────────────────────────────────┘
    │
    ▼
    ├─────────────────────────────────────┐
    │        Commit 阶段（不可中断）        │
    │                                     │
    │  <span class="hljs-built_in">commitBeforeMutationEffects</span>()      │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">commitMutationEffects</span>()  ← DOM操作 │
    │      │                              │
    │      ▼                              │
    │  root<span class="hljs-selector-class">.current</span> = finishedWork        │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">commitLayoutEffects</span>()              │
    │                                     │
    └─────────────────────────────────────┘
    │
    ▼
<span class="hljs-built_in">flushPassiveEffects</span>()       ← useEffect（异步）
</code></pre>
<h4 data-id="heading-9">Render 阶段</h4>
<p><strong>beginWork</strong>（向下递归）：</p>
<ul>
<li>根据组件类型处理（函数组件、类组件、DOM 元素）</li>
<li>调用组件函数，执行 Hooks</li>
<li>Diff 子节点，创建/复用 Fiber</li>
</ul>
<p><strong>completeWork</strong>（向上回溯）：</p>
<ul>
<li>创建 DOM 节点</li>
<li>收集副作用标记</li>
<li>冒泡 subtreeFlags</li>
</ul>
<h4 data-id="heading-10">Commit 阶段</h4>
<p>三个子阶段：</p>

























<table><thead><tr><th>阶段</th><th>时机</th><th>主要工作</th></tr></thead><tbody><tr><td>Before Mutation</td><td>DOM 操作前</td><td>getSnapshotBeforeUpdate</td></tr><tr><td>Mutation</td><td>DOM 操作</td><td>增删改 DOM</td></tr><tr><td>Layout</td><td>DOM 操作后</td><td>useLayoutEffect、componentDidMount</td></tr></tbody></table>
<h3 data-id="heading-11">五、Hooks 原理</h3>
<p>Hooks 以链表形式存储在 Fiber 的 <code>memoizedState</code> 上：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Fiber</span>.memoizedState → useState → useEffect → useMemo → <span class="hljs-literal">null</span>
</code></pre>
<h4 data-id="heading-12">useState 流程</h4>
<pre><code class="hljs language-css" lang="css">Mount:  <span class="hljs-built_in">mountState</span>() → 创建 Hook → 初始化状态 → 返回 [state, setState]
Update: <span class="hljs-built_in">updateState</span>() → 获取 Hook → 处理更新队列 → 返回 [newState, setState]
</code></pre>
<h4 data-id="heading-13">useEffect 流程</h4>
<pre><code class="hljs language-css" lang="css">Mount:  <span class="hljs-built_in">mountEffect</span>() → 创建 Effect → 标记 Passive
Commit: <span class="hljs-built_in">flushPassiveEffects</span>() → 执行销毁函数 → 执行创建函数
</code></pre>
<h3 data-id="heading-14">六、Diff 算法</h3>
<p>React Diff 的三个策略：</p>
<ol>
<li><strong>同层比较</strong>：不跨层级移动节点</li>
<li><strong>类型判断</strong>：类型不同直接替换</li>
<li><strong>key 标识</strong>：通过 key 识别节点</li>
</ol>
<h4 data-id="heading-15">单节点 Diff</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">key</span> 相同 &amp;&amp; type 相同 → 复用
<span class="hljs-keyword">key</span> 相同 &amp;&amp; type 不同 → 删除重建
<span class="hljs-keyword">key</span> 不同 → 删除，继续找
</code></pre>
<h4 data-id="heading-16">多节点 Diff（三轮遍历）</h4>
<pre><code class="hljs language-javascript" lang="javascript">第一轮：从左到右，处理更新
第二轮：处理新增或删除
第三轮：处理移动（<span class="hljs-title class_">Map</span> 查找）
</code></pre>
<h3 data-id="heading-17">七、Scheduler 调度</h3>
<h4 data-id="heading-18">优先级</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ImmediatePriority</span>   <span class="hljs-comment">// -1ms，立即执行</span>
<span class="hljs-title class_">UserBlockingPriority</span> <span class="hljs-comment">// 250ms，用户交互</span>
<span class="hljs-title class_">NormalPriority</span>      <span class="hljs-comment">// 5000ms，普通更新</span>
<span class="hljs-title class_">LowPriority</span>         <span class="hljs-comment">// 10000ms，低优先级</span>
<span class="hljs-title class_">IdlePriority</span>        <span class="hljs-comment">// 永不过期，空闲执行</span>
</code></pre>
<h4 data-id="heading-19">时间切片</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (task &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {  <span class="hljs-comment">// 5ms 检查一次</span>
    task = <span class="hljs-title function_">performTask</span>(task);
  }
  <span class="hljs-keyword">if</span> (task) {
    <span class="hljs-title function_">scheduleCallback</span>(task);  <span class="hljs-comment">// 还有任务，继续调度</span>
  }
}
</code></pre>
<h3 data-id="heading-20">八、源码目录</h3>
<pre><code class="hljs language-bash" lang="bash">packages/
├── react/                    <span class="hljs-comment"># React API</span>
│   └── src/ReactHooks.js     <span class="hljs-comment"># Hooks 入口</span>
│
├── react-reconciler/         <span class="hljs-comment"># 协调器（核心）</span>
│   └── src/
│       ├── ReactFiber.js           <span class="hljs-comment"># Fiber 定义</span>
│       ├── ReactFiberWorkLoop.js   <span class="hljs-comment"># 工作循环</span>
│       ├── ReactFiberBeginWork.js  <span class="hljs-comment"># 递阶段</span>
│       ├── ReactFiberCompleteWork.js <span class="hljs-comment"># 归阶段</span>
│       ├── ReactFiberHooks.js      <span class="hljs-comment"># Hooks 实现</span>
│       ├── ReactFiberCommitWork.js <span class="hljs-comment"># Commit</span>
│       ├── ReactFiberLane.js       <span class="hljs-comment"># 优先级</span>
│       └── ReactChildFiber.js      <span class="hljs-comment"># Diff 算法</span>
│
├── react-dom/                <span class="hljs-comment"># DOM 渲染器</span>
│
└── scheduler/                <span class="hljs-comment"># 调度器</span>
    └── src/
        ├── Scheduler.js          <span class="hljs-comment"># 调度逻辑</span>
        └── SchedulerMinHeap.js   <span class="hljs-comment"># 最小堆</span>
</code></pre>
<h3 data-id="heading-21">九、系列文章导航</h3>


















































<table><thead><tr><th>序号</th><th>主题</th><th>核心内容</th></tr></thead><tbody><tr><td>00</td><td><a href="https://juejin.cn/post/7588149079400710187" target="_blank" title="https://juejin.cn/post/7588149079400710187">调试环境搭建</a></td><td>项目介绍、快速开始</td></tr><tr><td>01</td><td>架构总览（本文）</td><td>三大模块、核心概念</td></tr><tr><td>02</td><td><a href="https://juejin.cn/post/7588007285547302918" target="_blank" title="https://juejin.cn/post/7588007285547302918">useState 原理</a></td><td>Hook 链表、更新队列</td></tr><tr><td>03</td><td><a href="https://juejin.cn/post/7588001624905973779" target="_blank" title="https://juejin.cn/post/7588001624905973779">useEffect 原理</a></td><td>Effect 链表、执行时机</td></tr><tr><td>04</td><td><a href="https://juejin.cn/post/7588061231589523497" target="_blank" title="https://juejin.cn/post/7588061231589523497">Fiber 工作循环</a></td><td>beginWork、completeWork</td></tr><tr><td>05</td><td><a href="https://juejin.cn/post/7588001624905990163" target="_blank" title="https://juejin.cn/post/7588001624905990163">Diff 算法</a></td><td>单节点、多节点 Diff</td></tr><tr><td>06</td><td><a href="https://juejin.cn/post/7588064253635477558" target="_blank" title="https://juejin.cn/post/7588064253635477558">Scheduler 调度器</a></td><td>优先级、时间切片</td></tr><tr><td>07</td><td><a href="https://juejin.cn/post/7588061231589556265" target="_blank" title="https://juejin.cn/post/7588061231589556265">Commit 阶段</a></td><td>三个子阶段、DOM 操作</td></tr></tbody></table>
<h3 data-id="heading-22">十、学习建议</h3>
<ol>
<li><strong>先跑起来</strong>：clone react-debug，打断点调试</li>
<li><strong>从 useState 开始</strong>：最简单也最核心</li>
<li><strong>画流程图</strong>：边看边画，加深理解</li>
<li><strong>写测试组件</strong>：验证你的理解</li>
</ol>
<hr/>
<blockquote>
<p>📦 配套源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F220529%2Freact-debug" target="_blank" title="https://github.com/220529/react-debug" ref="nofollow noopener noreferrer">github.com/220529/reac…</a></p>
<p>上一篇：<a href="https://juejin.cn/post/7588149079400710187" target="_blank" title="https://juejin.cn/post/7588149079400710187">React 源码调试环境搭建</a></p>
<p>下一篇：<a href="https://juejin.cn/post/7588007285547302918" target="_blank" title="https://juejin.cn/post/7588007285547302918">useState 的实现原理</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 源码揭秘（二）：useState 的实现原理]]></title>    <link>https://juejin.cn/post/7588007285547302918</link>    <guid>https://juejin.cn/post/7588007285547302918</guid>    <pubDate>2025-12-27T02:42:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547302918" data-draft-id="7588149079400759339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 源码揭秘（二）：useState 的实现原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T02:42:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 源码揭秘（二）：useState 的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:42:47.000Z" title="Sat Dec 27 2025 02:42:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 19 源码揭秘（二）：useState 的实现原理</h2>
<blockquote>
<p>本文深入 React 源码，带你彻底搞懂 useState 从调用到更新的完整流程。</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p><code>useState</code> 可能是你用得最多的 Hook，但你知道它背后是怎么工作的吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 这行代码背后发生了什么？</span>
</code></pre>
<p>本文将从源码角度，完整解析 useState 的实现原理。</p>
<h3 data-id="heading-2">一、Hook 的数据结构</h3>
<p>首先，我们需要了解 Hook 在 React 内部是如何存储的。</p>
<h4 data-id="heading-3">Hook 节点</h4>
<p>每个 Hook 调用都会创建一个 Hook 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript">type <span class="hljs-title class_">Hook</span> = {
  <span class="hljs-attr">memoizedState</span>: any,    <span class="hljs-comment">// 存储的状态值</span>
  <span class="hljs-attr">baseState</span>: any,        <span class="hljs-comment">// 基础状态（用于更新计算）</span>
  <span class="hljs-attr">baseQueue</span>: <span class="hljs-title class_">Update</span> | <span class="hljs-literal">null</span>,  <span class="hljs-comment">// 基础更新队列</span>
  <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span> | <span class="hljs-literal">null</span>, <span class="hljs-comment">// 更新队列</span>
  <span class="hljs-attr">next</span>: <span class="hljs-title class_">Hook</span> | <span class="hljs-literal">null</span>,     <span class="hljs-comment">// 指向下一个 Hook</span>
};
</code></pre>
<h4 data-id="heading-4">Hook 链表</h4>
<p>多个 Hook 以链表形式存储在 Fiber 节点的 <code>memoizedState</code> 上：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Fiber</span>.memoizedState
        │
        ▼
    ┌───────┐     ┌───────┐     ┌───────┐
    │ Hook1 │ ──► │ Hook2 │ ──► │ Hook3 │ ──► <span class="hljs-literal">null</span>
    │useState│     │useEffect│    │useMemo│
    └───────┘     └───────┘     └───────┘
</code></pre>
<p>这就是为什么 <strong>Hook 不能在条件语句中调用</strong>——React 依赖调用顺序来匹配 Hook。</p>
<h3 data-id="heading-5">二、首次渲染：mountState</h3>
<p>当组件首次渲染时，useState 会调用 <code>mountState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码位置：react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mountState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// 1. 创建 Hook 节点，加入链表</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();
  
  <span class="hljs-comment">// 2. 处理初始值（支持函数式初始化）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> initialState === <span class="hljs-string">'function'</span>) {
    initialState = <span class="hljs-title function_">initialState</span>();
  }
  
  <span class="hljs-comment">// 3. 保存初始状态</span>
  hook.<span class="hljs-property">memoizedState</span> = hook.<span class="hljs-property">baseState</span> = initialState;
  
  <span class="hljs-comment">// 4. 创建更新队列</span>
  <span class="hljs-keyword">const</span> queue = {
    <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>,           <span class="hljs-comment">// 待处理的更新</span>
    <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">NoLanes</span>,
    <span class="hljs-attr">dispatch</span>: <span class="hljs-literal">null</span>,          <span class="hljs-comment">// setState 函数</span>
    <span class="hljs-attr">lastRenderedReducer</span>: basicStateReducer,
    <span class="hljs-attr">lastRenderedState</span>: initialState,
  };
  hook.<span class="hljs-property">queue</span> = queue;
  
  <span class="hljs-comment">// 5. 绑定 dispatch 函数（就是 setState）</span>
  <span class="hljs-keyword">const</span> dispatch = dispatchSetState.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, currentlyRenderingFiber, queue);
  queue.<span class="hljs-property">dispatch</span> = dispatch;
  
  <span class="hljs-comment">// 6. 返回 [state, setState]</span>
  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, dispatch];
}
</code></pre>
<h4 data-id="heading-6">mountWorkInProgressHook</h4>
<p>这个函数负责创建 Hook 节点并维护链表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountWorkInProgressHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> hook = {
    <span class="hljs-attr">memoizedState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseQueue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">queue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };

  <span class="hljs-keyword">if</span> (workInProgressHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 第一个 Hook，挂载到 Fiber</span>
    currentlyRenderingFiber.<span class="hljs-property">memoizedState</span> = workInProgressHook = hook;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 追加到链表末尾</span>
    workInProgressHook = workInProgressHook.<span class="hljs-property">next</span> = hook;
  }
  
  <span class="hljs-keyword">return</span> workInProgressHook;
}
</code></pre>
<h3 data-id="heading-7">三、触发更新：dispatchSetState</h3>
<p>当你调用 <code>setCount(1)</code> 时，实际执行的是 <code>dispatchSetState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchSetState</span>(<span class="hljs-params">fiber, queue, action</span>) {
  <span class="hljs-comment">// 1. 获取更新优先级</span>
  <span class="hljs-keyword">const</span> lane = <span class="hljs-title function_">requestUpdateLane</span>(fiber);
  
  <span class="hljs-comment">// 2. 创建更新对象</span>
  <span class="hljs-keyword">const</span> update = {
    lane,
    action,              <span class="hljs-comment">// 新值或更新函数</span>
    <span class="hljs-attr">hasEagerState</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">eagerState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };
  
  <span class="hljs-comment">// 3. 性能优化：Eager State（提前计算）</span>
  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">lanes</span> === <span class="hljs-title class_">NoLanes</span>) {
    <span class="hljs-keyword">const</span> currentState = queue.<span class="hljs-property">lastRenderedState</span>;
    <span class="hljs-keyword">const</span> eagerState = <span class="hljs-title function_">basicStateReducer</span>(currentState, action);
    update.<span class="hljs-property">hasEagerState</span> = <span class="hljs-literal">true</span>;
    update.<span class="hljs-property">eagerState</span> = eagerState;
    
    <span class="hljs-comment">// 如果新旧状态相同，跳过更新！</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(eagerState, currentState)) {
      <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// Bailout!</span>
    }
  }
  
  <span class="hljs-comment">// 4. 将更新加入队列</span>
  <span class="hljs-title function_">enqueueConcurrentHookUpdate</span>(fiber, queue, update, lane);
  
  <span class="hljs-comment">// 5. 调度更新</span>
  <span class="hljs-title function_">scheduleUpdateOnFiber</span>(root, fiber, lane);
}
</code></pre>
<h4 data-id="heading-8">Eager State 优化</h4>
<p>这是一个重要的性能优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 点击按钮</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 状态没变，React 会跳过这次更新！</span>
</code></pre>
<p>React 会在调度之前就计算新状态，如果和旧状态相同（通过 <code>Object.is</code> 比较），直接跳过整个更新流程。</p>
<h3 data-id="heading-9">四、更新渲染：updateState</h3>
<p>当组件重新渲染时，useState 会调用 <code>updateState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// useState 本质上是预设了 reducer 的 useReducer</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateReducer</span>(basicStateReducer, initialState);
}

<span class="hljs-comment">// 基础 reducer：支持值或函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">basicStateReducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">action</span>(state) : action;
}
</code></pre>
<h4 data-id="heading-10">updateReducer</h4>
<p>这是处理更新的核心逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateReducer</span>(<span class="hljs-params">reducer, initialArg</span>) {
  <span class="hljs-comment">// 1. 获取当前 Hook</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">updateWorkInProgressHook</span>();
  <span class="hljs-keyword">const</span> queue = hook.<span class="hljs-property">queue</span>;
  
  <span class="hljs-comment">// 2. 获取待处理的更新</span>
  <span class="hljs-keyword">const</span> pending = queue.<span class="hljs-property">pending</span>;
  
  <span class="hljs-comment">// 3. 计算新状态</span>
  <span class="hljs-keyword">let</span> newState = hook.<span class="hljs-property">baseState</span>;
  <span class="hljs-keyword">if</span> (pending !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">let</span> update = pending.<span class="hljs-property">first</span>;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">const</span> action = update.<span class="hljs-property">action</span>;
      newState = <span class="hljs-title function_">reducer</span>(newState, action);
      update = update.<span class="hljs-property">next</span>;
    } <span class="hljs-keyword">while</span> (update !== <span class="hljs-literal">null</span>);
  }
  
  <span class="hljs-comment">// 4. 保存新状态</span>
  hook.<span class="hljs-property">memoizedState</span> = newState;
  
  <span class="hljs-comment">// 5. 返回新状态和 dispatch</span>
  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, queue.<span class="hljs-property">dispatch</span>];
}
</code></pre>
<h4 data-id="heading-11">updateWorkInProgressHook</h4>
<p>更新时，需要从 current 树复制 Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateWorkInProgressHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从 current Fiber 获取对应的 Hook</span>
  <span class="hljs-keyword">let</span> nextCurrentHook;
  <span class="hljs-keyword">if</span> (currentHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> current = currentlyRenderingFiber.<span class="hljs-property">alternate</span>;
    nextCurrentHook = current.<span class="hljs-property">memoizedState</span>;
  } <span class="hljs-keyword">else</span> {
    nextCurrentHook = currentHook.<span class="hljs-property">next</span>;
  }
  
  currentHook = nextCurrentHook;
  
  <span class="hljs-comment">// 复制 Hook 到 workInProgress</span>
  <span class="hljs-keyword">const</span> newHook = {
    <span class="hljs-attr">memoizedState</span>: currentHook.<span class="hljs-property">memoizedState</span>,
    <span class="hljs-attr">baseState</span>: currentHook.<span class="hljs-property">baseState</span>,
    <span class="hljs-attr">baseQueue</span>: currentHook.<span class="hljs-property">baseQueue</span>,
    <span class="hljs-attr">queue</span>: currentHook.<span class="hljs-property">queue</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };
  
  <span class="hljs-comment">// 加入链表...</span>
  <span class="hljs-keyword">return</span> newHook;
}
</code></pre>
<h3 data-id="heading-12">五、完整流程图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    首次渲染 (Mount)                      │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)                                            │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">mountState</span>(<span class="hljs-number">0</span>)                                          │
│      │                                                  │
│      ├──► 创建 Hook 节点                                │
│      ├──► 初始化 memoizedState = <span class="hljs-number">0</span>                      │
│      ├──► 创建 UpdateQueue                              │
│      ├──► 绑定 dispatch = dispatchSetState              │
│      │                                                  │
│      ▼                                                  │
│  返回 <span class="hljs-selector-attr">[0, setCount]</span>                                     │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    触发更新                              │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">setCount</span>(<span class="hljs-number">1</span>)                                            │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">dispatchSetState</span>(fiber, queue, <span class="hljs-number">1</span>)                      │
│      │                                                  │
│      ├──► 获取优先级 lane                               │
│      ├──► 创建 Update 对象                              │
│      ├──► Eager State: 计算新状态                       │
│      ├──► 比较新旧状态，相同则 Bailout                   │
│      ├──► 入队更新                                      │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">scheduleUpdateOnFiber</span>() ──► 调度重新渲染               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    重新渲染 (Update)                     │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)  // 初始值被忽略                           │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">updateState</span>(<span class="hljs-number">0</span>)                                         │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">updateReducer</span>(basicStateReducer, <span class="hljs-number">0</span>)                    │
│      │                                                  │
│      ├──► 获取对应的 Hook                               │
│      ├──► 处理 UpdateQueue 中的更新                     │
│      ├──► 计算新状态 = <span class="hljs-number">1</span>                                │
│      │                                                  │
│      ▼                                                  │
│  返回 [<span class="hljs-number">1</span>, setCount]                                     │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-13">六、Dispatcher 切换</h3>
<p>React 如何区分 mount 和 update？答案是 <strong>Dispatcher 切换</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// renderWithHooks 中</span>
<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">H</span> = 
  current === <span class="hljs-literal">null</span> || current.<span class="hljs-property">memoizedState</span> === <span class="hljs-literal">null</span>
    ? <span class="hljs-title class_">HooksDispatcherOnMount</span>   <span class="hljs-comment">// 首次渲染</span>
    : <span class="hljs-title class_">HooksDispatcherOnUpdate</span>; <span class="hljs-comment">// 更新渲染</span>

<span class="hljs-comment">// 两个 Dispatcher 的 useState 指向不同函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnMount</span> = {
  <span class="hljs-attr">useState</span>: mountState,
  <span class="hljs-attr">useEffect</span>: mountEffect,
  <span class="hljs-comment">// ...</span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnUpdate</span> = {
  <span class="hljs-attr">useState</span>: updateState,
  <span class="hljs-attr">useEffect</span>: updateEffect,
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<p>渲染完成后，切换到 ContextOnlyDispatcher，禁止在组件外调用 Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 渲染完成后</span>
<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">H</span> = <span class="hljs-title class_">ContextOnlyDispatcher</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ContextOnlyDispatcher</span> = {
  <span class="hljs-attr">useState</span>: throwInvalidHookError,  <span class="hljs-comment">// 抛出错误</span>
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h3 data-id="heading-14">七、为什么 Hook 不能条件调用？</h3>
<p>现在你应该明白了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// Hook 1</span>
}
<span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// Hook 2 或 Hook 1？</span>

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 始终是 Hook 1</span>
<span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 始终是 Hook 2</span>
</code></pre>
<p>React 通过遍历链表来匹配 Hook，如果顺序变了，状态就乱了。</p>
<h3 data-id="heading-15">八、调试技巧</h3>
<p>想要亲自验证？在这些位置打断点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 首次渲染</span>
mountState          <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-comment">// 触发更新</span>
dispatchSetState    <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-comment">// 重新渲染</span>
updateReducer       <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>
</code></pre>
<p>用 Counter 组件测试：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 断点这里</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};
</code></pre>
<h3 data-id="heading-16">小结</h3>
<p>本文深入分析了 useState 的实现原理：</p>
<ol>
<li><strong>数据结构</strong>：Hook 以链表形式存储在 Fiber.memoizedState</li>
<li><strong>首次渲染</strong>：mountState 创建 Hook 和 UpdateQueue</li>
<li><strong>触发更新</strong>：dispatchSetState 创建 Update，调度渲染</li>
<li><strong>Eager State</strong>：提前计算，相同状态跳过更新</li>
<li><strong>重新渲染</strong>：updateReducer 处理更新队列，计算新状态</li>
<li><strong>Dispatcher</strong>：通过切换实现 mount/update 的区分</li>
</ol>
<p>下一篇我们将分析 <strong>useEffect 的实现原理</strong>，看看副作用是如何被调度和执行的。</p>
<hr/>
<blockquote>
<p>📦 配套源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F220529%2Freact-debug" target="_blank" title="https://github.com/220529/react-debug" ref="nofollow noopener noreferrer">github.com/220529/reac…</a></p>
<p>上一篇：<a href="https://juejin.cn/post/7588007285547286534" target="_blank" title="https://juejin.cn/post/7588007285547286534">React 19 源码全景图</a></p>
<p>下一篇：<a href="https://juejin.cn/post/7588001624905973779" target="_blank" title="https://juejin.cn/post/7588001624905973779">useEffect 的实现原理</a></p>
<p>如果觉得有帮助，欢迎点赞收藏 👍</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道]]></title>    <link>https://juejin.cn/post/7588031908170973193</link>    <guid>https://juejin.cn/post/7588031908170973193</guid>    <pubDate>2025-12-26T16:18:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908170973193" data-draft-id="7588086766235795494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道"/> <meta itemprop="keywords" content="人工智能,前端"/> <meta itemprop="datePublished" content="2025-12-26T16:18:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:18:32.000Z" title="Fri Dec 26 2025 16:18:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509b6a53b2c14622a7f411953f571293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=zQYLeU1DJz%2BqZuqyleR2EWCqEhk%3D" alt="图片" loading="lazy"/></p>
<p>哈喽，大家好！</p>
<p>阿星👋</p>
<p>属实没想到现在IDE都卷得出年终报告了：我在TRAE的年终报告里居然是个开服贡献者</p>
<p>是啊， 断断续续vibecoding了50个项目</p>
<p>也有几个体会分享给大家——</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1756b4f4f81f48cfb07f7e35e9f2ca56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=VHFsY2cSNN4mRQ3oHrXU%2BR1kUTE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1、一个好的前期prompt胜过后期折腾100遍</h2>
<p>强提示词控制是阿星在踩了很多坑之后才意识到的</p>
<p>新手都是蜜汁自信觉得随便一句话能coding个差不多的</p>
<p>结果越说越多还不如第一次规定好</p>
<p>所以即使是很简单的项目我既会用「EARS语法」去把普通提示词扩展成工程级提示词</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e71e1d1bb8b4c8b9e7ea2c776bbbe50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=%2FNF5yDFMhehBeljoDY8SA%2FqVCIE%3D" alt="图片" loading="lazy"/></p>
<p>我的原需求大概这么长</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540fbf38fe3b4055bcbdc04a98307523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=5mSR0r6rRtLMMbVmiSLOGTJnc6s%3D" alt="图片" loading="lazy"/></p>
<p>通过「EARS语法」也就详细了10倍吧👇•ᴗ•💧</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb71c0c1081f4d4286b563606250e97a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=K2Ql%2BB0R4za0D7xIjCB42Hnwdcs%3D" alt="图片" loading="lazy"/></p>
<p>毕竟，几千字的提示词和100字的简单交代差别还是很大的</p>
<p>也会用一些自动化提示词增强</p>
<p>来帮我在忙的时候也能兼顾最基本提示词专业度</p>
<p>比如这个自动增强功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9c295800a4438a8df01b8aa559e3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=BzNoQnvzGe6SIHLIGhwc%2BXTb%2BCU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">2、不一定非要用国外CLI</h2>
<p>前两天，阿星想做一个卡密系统。 本能地打开了国外的CLI（一种命令行编程形式）</p>
<p>但是用国内IDE来做却意外的顺利</p>
<p>简单的项目的话，整个项目下来几乎没有回滚的时候，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047263370a49453ead1498ed5b6266f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=KAknz4%2BzV2BOZzEQ3RrYVXYx%2BYU%3D" alt="图片" loading="lazy"/></p>
<p>很少，但不能说是完全没有回滚，那也太夸张了。</p>
<p>但是对我这种半路才开始接触AI编程的人来说算友好的，</p>
<p>比2023年那会儿的IDE更是让我们少做了很多无用工。</p>
<p><strong>虽然现在某些CLI功能确实呼声很高，但是对小白来说上手难度其实挺大的</strong>，看到命令行头晕了还怎么继续。所以如果你完全没有用AI编程过，我还是建议从智能IDE做起。</p>
<h2 data-id="heading-2">3、工作流直接做成智能体</h2>
<p>每次做项目，</p>
<p>阿星都会做一个guidebook把整个项目的踩坑过程记录下来，好二次复用到自媒体上，<strong>如果没有这些实操记录，写的编程文章就会虚无很多，为了一鱼多吃也要记录一下。</strong></p>
<p>这个时候就会用到智能体功能，让他扮演guidebook助手，给他人设就行了。这个过程其实比在一些cli工具里去配置一个agent要方便点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a428f856b3504b829734de8b2e800802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=5i9J07qPYCMlWiZxdTWoe9%2BrfbE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6817a064a4de4741919e2cd2273a00a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=1GeofwTzorPZl9K5BQc4JUlWjqE%3D" alt="图片" loading="lazy"/></p>
<p><strong>阿星之前也是在cli里配agent，但是引用起来太麻烦了</strong>，一个是可视化信息有限的情况下太考验记性，一个是容易打击新手积极性，所以更倾向于直接在IDE里用智能体搞定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/637ee2b8c0a943e58fe912d29730730d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=ofRimE6M68nhg18OvJjS9YAkWTs%3D" alt="图片" loading="lazy"/></p>
<p>而且我蕞喜欢的是<strong>它可以直接直接让朋友复用，它相当于是把提示词的功能直接插件化了，让咱们主打一个活儿不干两遍</strong>。也不用相互发提示词粘来粘去了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bf882f59b54ade8544306bf7be08d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=1pWPHI5Rvov2TqIUxS5s8mTycJ8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">4、前端项目，直接选择元素</h2>
<p>阿星觉得凡是涉及到前端视觉的精细化控制</p>
<p>prompt的效率其实比视觉点击要低很多</p>
<p>所以我自己经常用的还有元素选择，不用我一直嘚啵嘚到底改哪里了，效率高了很多</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff94331a0fc743509c3be51e35393800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=P5HWpDpj2Xgwt7RhB1IxUhStws8%3D" alt="图片" loading="lazy"/></p>
<p>figma的前端我都直接用mcp了，个人感觉是打通设计与开发的关键一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfd06042db94e92bc23e5b1d937d107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=2rW7Jzo8Mi5Krlgn5YbWwZ8M0oM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">5、引用上下文</h2>
<p>编程的时候不要直接去提问，最好选中你要改的上下文再提问，</p>
<p>而且现在IDE可以引用的上下文很多，终端里的报错也能直接加进去，文件、文件夹、工作区、文档集和网页其实都可以作为整个项目的上下文添加进去。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aefc165221994d4db3e966cf4161791c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=8TLnymHEho2vl4oANPNls4ZtoKs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">6、数据库可以直接连supabase mcp</h2>
<p>之前阿星只是做点不带数据库的前端项目</p>
<p>但是做着做着必然会用到数据库啊，特别是一些要做出海的同学</p>
<p>阿星以前激活数据库是直接让AI去接API</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-keyword">import</span> { createClient } from <span class="hljs-string">'@supabase/supabase-js'</span>

<span class="hljs-type">const</span> supabaseUrl = <span class="hljs-string">'https://okqxrigpjgoncvoflenz.supabase.co'</span>
<span class="hljs-type">const</span> supabaseKey = process.env.SUPABASE_KEY
<span class="hljs-type">const</span> supabase = <span class="hljs-built_in">createClient</span>(supabaseUrl, supabaseKey)
</code></pre>
<p>后来发现mcp可以自己搞定•ᴗ•💧除了刚开始配置可能有点懵没啥大问题</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5f9bd683d74d3181bdd878b7b0e96c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=dsmiyrxncaezCc8rh5Ammb5ut%2BI%3D" alt="图片" loading="lazy"/></p>
<p>MCP = AI用统一的工具调用方式访问数据库</p>
<p>看文档 =AI每次都要理解API格式、构造请求，小白容易出错，特别我们频繁修改的时候</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343fc5836a8547a9b9071b75a46a8bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=e2v7YizBO%2FMFoIDZwsjMmv37EFM%3D" alt="图片" loading="lazy"/></p>
<p>所以，简单的需求直接配就行了， <strong>我一般直接添加mcp， Connect Supabase。</strong></p>
<h2 data-id="heading-6">7、活用tab</h2>
<p>我个人是用tab比较少的，是个懒人。被年终总结拆穿了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a05018654f240b593cb30cd3dc578af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=xY3R6HtAyvz9licMdjwEYztJB5g%3D" alt="图片" loading="lazy"/></p>
<p>TRAE里的这个tab功能主要是做代码补全、多行修改的</p>
<p>按下 Tab 键，跳转至修改点所在位置。</p>
<p>Ctrl / Command + → 组合键逐字接受一个建议的修改。</p>
<p>Escape 键拒绝就好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c4e08734d664093a21b800cda5cb3a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=3Wrqy92J%2BUX4Qh3UoBA0JQgiV9c%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbadf3eec77d43aa8cf50978110e4583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=%2BdH1%2Fu6GJtSchPK%2BP07ks4nd3IY%3D" alt="图片" loading="lazy"/></p>
<p>现在经常用tab功能的都是大神了😂</p>
<p>要真学代码真编程还是得看的更细一点。</p>
<h2 data-id="heading-7">8、版本控制</h2>
<p>咱们写代码的时候都要提交很多git版本，</p>
<p>但是改一版输入一次提交命令就太麻烦了。</p>
<p>可以用一些插件，把git Hub网页功能集成到你的本地编辑器里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19050f6813414580bd8f5cba26d7a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=wmesMj4PojvCunnJG1xPbUfch8E%3D" alt="图片" loading="lazy"/></p>
<p>直接就能推送代码了，TRAE有个优点，除了git还能更直观地直接在单个句子旁边回退</p>
<p>至少能给我储存10个版本以防万一</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdae4ec3b08e44259e1a5aa0b21b4218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=W%2BweCeUQbVsD5lYbkeE6wtnqDe0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">9、管好你和AI的聊天记录</h2>
<p>我自己刚接触一些cli工具的时候，</p>
<p>完全找不到哪里去看聊天记录再去看网上各种插件来做聊天记录保存的，</p>
<p>对小白来说光是设置这些东西都晕了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7397cd92a01442e5a73035da51e2e707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=Lw4YuX63Kamw6gPkle25mqBD%2FGU%3D" alt="图片" loading="lazy"/></p>
<p>后来才开始用mcp管聊天记录，</p>
<p>这种mcp一般可以自动记录对话历史，智能管理上下文，并跟踪任务。不妨探索一下。</p>
<h2 data-id="heading-9">10、solo不是非用不可</h2>
<p>整个过程我自己用的是IDE，</p>
<p>因为 solo 模式的话，对我来说还是有点太野马脱缰了。</p>
<p>所以我建议半路的小白，</p>
<p>如果想做 vibe coding 的话，</p>
<p>大家可以根据自己的习惯选择</p>
<p>无论是ide模式还是solo模式</p>
<p>最好是一边看一边学， 把每一次编程新学到的知识点</p>
<p>沉淀到相关的文档里，下次出发你就是最棒的啦～</p>
<p> </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee137d933e394e7dab95badf526a44d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=puMYQS4nCKztVZEzloB9gG4QVLk%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现]]></title>    <link>https://juejin.cn/post/7587997893988335643</link>    <guid>https://juejin.cn/post/7587997893988335643</guid>    <pubDate>2025-12-27T02:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893988335643" data-draft-id="7587630413012156426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现"/> <meta itemprop="keywords" content="LangChain,JavaScript,LLM"/> <meta itemprop="datePublished" content="2025-12-27T02:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:57:54.000Z" title="Sat Dec 27 2025 02:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<blockquote>
<p><strong>“我叫 Agiao，喜欢喝白兰地。”</strong><br/>
—— 你说完这句话，转身离开。<br/>
再回来问：“我叫什么名字？”<br/>
如果 AI 回答“我不知道”，那它只是个无状态的 API；<br/>
如果它回答“Agiao”，那它就拥有了<strong>记忆</strong>。</p>
</blockquote>
<p>在人工智能的世界里，“记忆”不是与生俱来的天赋，而是一种精心设计的工程能力。大型语言模型（LLM）本身是<strong>无状态</strong>的——每一次调用都像一场全新的对话，模型对过去一无所知。然而，现实中的智能交互必须具备上下文连贯性。如何让 LLM “记住你”？这正是我们今天要深入剖析的核心问题。</p>
<p>本文将逐行、逐模块、逐 API 地解析 <code>1.js</code> 文件，揭示 LangChain 如何通过 <strong>对话历史管理机制</strong> 赋予 LLM 真正的记忆能力。我们将不仅解释“怎么做”，更要阐明“为什么这么做”，并对比无记忆版本（<code>index.js</code>）的局限，最终构建一个完整、生动、技术扎实的认知图景。</p>
<hr/>
<h2 data-id="heading-1">背景：为什么 LLM 默认没有记忆？</h2>
<p>首先，让我们回到基础。</p>
<blockquote>
<p><strong>LLM API 调用和 http 请求一样，都是无状态的</strong></p>
</blockquote>
<p>这意味着每次你向模型发送一条消息（例如 <code>"我叫Agiao"</code>），模型仅基于这条消息生成回复，不会自动保留任何上下文。如果你紧接着再发一条 <code>"我叫什么名字？"</code>，模型根本不知道前一条消息的存在。</p>
<p>我们来看 <code>index.js</code> 的实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ChatDeepSeek</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>});

<span class="hljs-comment">// http api 请求</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫Agiao，喜欢喝白兰地'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);

<span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫什么名字'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res2.<span class="hljs-property">content</span>);
</code></pre>
<p>这段代码做了两件事：</p>
<ol>
<li>第一次调用 <code>model.invoke(...)</code>，告诉模型你的名字和喜好。</li>
<li>第二次独立调用 <code>model.invoke(...)</code>，询问自己的名字。</li>
</ol>
<p>由于两次调用之间<strong>没有任何信息传递</strong>，第二次请求对模型而言完全是孤立的。因此，模型极大概率会回答类似：“抱歉，我不知道您叫什么名字。”——这不是模型笨，而是架构使然。</p>
<blockquote>
<p>💡 <strong>关键洞察</strong>：要实现记忆，我们必须<strong>主动维护对话历史，并在每次请求时将其作为上下文传入模型</strong>。</p>
</blockquote>
<p>但如何高效、结构化、可扩展地做到这一点？这就是 LangChain 的用武之地。</p>
<hr/>
<h2 data-id="heading-2">架构预览：LangChain 的记忆抽象</h2>
<p>LangChain 提供了一套完整的“记忆”（Memory）模块，其核心思想是：</p>
<blockquote>
<p><strong>将对话历史视为一种可插拔的上下文源，在每次调用 LLM 前动态注入到 Prompt 中。</strong></p>
</blockquote>
<p>在 <code>1.js</code> 中，这一思想通过以下组件协同实现：</p>
<ul>
<li><code>InMemoryChatMessageHistory</code>：存储对话历史。</li>
<li><code>ChatPromptTemplate</code>：定义包含历史占位符的提示模板。</li>
<li><code>RunnableWithMessageHistory</code>：自动管理历史加载与保存的包装器。</li>
<li><code>ChatDeepSeek</code>：底层 LLM 模型。</li>
</ul>
<p>接下来，我们将逐行拆解 <code>1.js</code>，深入每一个 API 的设计哲学与实现细节。</p>
<hr/>
<h2 data-id="heading-3">逐行深度解析 <code>1.js</code></h2>
<h3 data-id="heading-4">第一部分：模块导入（Import Statements）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;
<span class="hljs-comment">// 带上历史记录的可运行对象</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;
<span class="hljs-comment">// 存放在内存中</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
</code></pre>
<h4 data-id="heading-5">✅ <code>ChatDeepSeek</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/deepseek</code></p>
</li>
<li>
<p>作用：封装 DeepSeek 提供的聊天模型 API，使其符合 LangChain 的 <code>BaseChatModel</code> 接口。</p>
</li>
<li>
<p>特性：</p>
<ul>
<li>支持 <code>invoke()</code>、<code>stream()</code> 等标准方法。</li>
<li>自动处理消息格式（如 <code>HumanMessage</code>, <code>AIMessage</code>）。</li>
<li>可配置 <code>model</code>、<code>temperature</code>、<code>maxTokens</code> 等参数。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">✅ <code>ChatPromptTemplate</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/prompts</code></p>
</li>
<li>
<p>作用：构建结构化的聊天提示（prompt），支持系统消息、用户消息、AI 消息及占位符。</p>
</li>
<li>
<p>关键能力：</p>
<ul>
<li>使用 <code>fromMessages()</code> 静态方法从消息数组创建模板。</li>
<li>支持变量插值（如 <code>{input}</code>, <code>{history}</code>）。</li>
<li>输出为 <code>Runnable</code>，可与其他组件链式组合（<code>.pipe()</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">✅ <code>RunnableWithMessageHistory</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/runnables</code></p>
</li>
<li>
<p><strong>这是实现记忆的核心抽象！</strong></p>
</li>
<li>
<p>作用：包装一个普通的 <code>Runnable</code>（如 LLM 调用链），使其具备自动加载和保存对话历史的能力。</p>
</li>
<li>
<p>工作原理：</p>
<ul>
<li>在每次 <code>.invoke()</code> 时，先从 <code>getMessageHistory</code> 获取当前会话的历史。</li>
<li>将历史注入到输入中（通过 <code>historyMessagesKey</code> 指定的字段）。</li>
<li>调用内部 <code>runnable</code>。</li>
<li>将用户输入和模型输出<strong>自动追加</strong>到历史记录中。</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：<code>RunnableWithMessageHistory</code> 并不关心历史如何存储（内存、数据库、Redis），它只依赖 <code>getMessageHistory</code> 函数返回一个实现了 <code>BaseChatMessageHistory</code> 接口的对象。</p>
</blockquote>
<h4 data-id="heading-8">✅ <code>InMemoryChatMessageHistory</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/chat_history</code></p>
</li>
<li>
<p>作用：最简单的对话历史存储实现，将所有消息保存在 JavaScript 内存数组中。</p>
</li>
<li>
<p>接口方法：</p>
<ul>
<li><code>getMessages()</code>：返回当前所有消息。</li>
<li><code>addMessage(message)</code>：添加一条新消息。</li>
<li><code>clear()</code>：清空历史。</li>
</ul>
</li>
<li>
<p>适用场景：单会话演示、测试。<strong>不适合生产环境多用户场景</strong>（因为所有会话共享同一实例，且进程重启后丢失）。</p>
</li>
</ul>
<h4 data-id="heading-9">✅ <code>dotenv/config</code></h4>
<ul>
<li>加载 <code>.env</code> 文件中的环境变量（如 <code>DEEPSEEK_API_KEY</code>），确保模型认证信息安全。</li>
</ul>
<hr/>
<h3 data-id="heading-10">第二部分：模型初始化</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">model</span> = new ChatDeepSeek({ model: <span class="hljs-string">'deepseek-chat'</span>, temperature: <span class="hljs-number">0</span>})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>model: 'deepseek-chat'</code>：指定使用 DeepSeek 的聊天专用模型。</li>
<li><code>temperature: 0</code>：关闭随机性，确保相同输入总是产生相同输出——这对需要精确记忆的场景至关重要（避免因随机性导致“忘记”）。</li>
</ul>
<hr/>
<h3 data-id="heading-11">第三部分：构建带记忆的 Prompt 模板</h3>
<pre><code class="hljs language-css" lang="css">const prompt = ChatPromptTemplate<span class="hljs-selector-class">.fromMessages</span>(<span class="hljs-selector-attr">[  [<span class="hljs-string">'system'</span>, <span class="hljs-string">"你是一个有记忆的助手"</span>]</span>,
  <span class="hljs-selector-attr">[<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">"{history}"</span>]</span>,
  <span class="hljs-selector-attr">[<span class="hljs-string">'human'</span>, <span class="hljs-string">"{input}"</span>]</span>
])
</code></pre>
<p>这是整个记忆机制的<strong>提示工程核心</strong>。</p>
<h4 data-id="heading-12">消息结构解析：</h4>
<ol>
<li>
<p><code>['system', "你是一个有记忆的助手"]</code></p>
<ul>
<li>系统消息，用于设定 AI 的角色和行为准则。</li>
<li>告诉模型：“你有能力记住之前的对话，请利用这些信息。”</li>
</ul>
</li>
<li>
<p><code>['placeholder', "{history}"]</code></p>
<ul>
<li>
<p><strong>关键！</strong> 这不是一个普通字符串，而是一个<strong>占位符指令</strong>。</p>
</li>
<li>
<p>LangChain 在渲染此模板时，会查找输入对象中的 <code>history</code> 字段。</p>
</li>
<li>
<p>如果 <code>history</code> 是一个消息数组（如 <code>[HumanMessage, AIMessage, ...]</code>），它会<strong>自动展开为多条独立消息</strong>，插入到此处。</p>
</li>
<li>
<p>例如，若历史为：</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">"我叫Agiao"</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">AIMessage</span>(<span class="hljs-string">"好的，Agiao！"</span>)
]
</code></pre>
<p>则最终 prompt 变为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！"</span>),  HumanMessage(<span class="hljs-string">"{input}"</span>)]</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>['human', "{input}"]</code></p>
<ul>
<li>当前用户输入，通过变量 <code>input</code> 注入。</li>
</ul>
</li>
</ol>
<blockquote>
<p>💡 <strong>为什么用 <code>placeholder</code> 而不是直接写 <code>{history}</code> 字符串？</strong><br/>
因为 <code>{history}</code> 实际上是一个<strong>消息列表</strong>，而非纯文本。<code>placeholder</code> 告诉 LangChain：“这里要插入一个消息序列，而不是拼接字符串”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">第四部分：构建可运行链（Runnable Chain）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> runnable = prompt
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> {
    <span class="hljs-comment">// debug 节点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(input)
    <span class="hljs-keyword">return</span> input;
  })
  .<span class="hljs-title function_">pipe</span>(model);
</code></pre>
<p>LangChain 的核心思想是“一切皆可运行（Runnable）”。这里我们构建了一个处理流水线：</p>
<ol>
<li><strong><code>prompt</code></strong>：首先应用提示模板，将 <code>{input}</code> 和 <code>{history}</code> 替换为实际内容，生成完整的消息列表。</li>
<li><strong>调试中间件</strong>：打印最终传给模型的消息结构。这对于理解记忆如何工作至关重要。</li>
<li><strong><code>model</code></strong>：将构造好的消息列表发送给 DeepSeek 模型。</li>
</ol>
<blockquote>
<p>📌 注意：此时的 <code>runnable</code> <strong>仍然不具备记忆能力</strong>！它只是一个“知道如何组织消息”的函数。真正的记忆由外层的 <code>RunnableWithMessageHistory</code> 注入。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">第五部分：创建对话历史存储</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">messageHistory</span> = new InMemoryChatMessageHistory()<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>创建一个空的内存历史容器。</li>
<li>所有后续对话（用户输入 + AI 回复）都将被自动追加到这里。</li>
<li>由于是全局变量，<strong>所有使用该 <code>messageHistory</code> 的会话将共享同一历史</strong>（在多用户场景中需按 session ID 分离）。</li>
</ul>
<hr/>
<h3 data-id="heading-15">第六部分：注入记忆能力 —— <code>RunnableWithMessageHistory</code></h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> RunnableWithMessageHistory({
  runnable,
  getMessageHistory: <span class="hljs-keyword">async</span> () =&gt; messageHistory,
  inputMessagesKey: <span class="hljs-string">'input'</span>,
  historyMessagesKey: <span class="hljs-string">'history'</span>,
});
</code></pre>
<p>这是整段代码的<strong>灵魂所在</strong>。让我们逐个参数详解：</p>
<h4 data-id="heading-16">🔸 <code>runnable</code></h4>
<ul>
<li>要包装的原始可运行对象（即前面构建的 <code>prompt → debug → model</code> 链）。</li>
<li><code>RunnableWithMessageHistory</code> 会在调用它之前注入历史，在之后保存新消息。</li>
</ul>
<h4 data-id="heading-17">🔸 <code>getMessageHistory: async () =&gt; messageHistory</code></h4>
<ul>
<li>
<p>一个异步函数，返回当前会话对应的 <code>BaseChatMessageHistory</code> 实例。</p>
</li>
<li>
<p>在本例中，我们直接返回全局的 <code>messageHistory</code>。</p>
</li>
<li>
<p><strong>在真实应用中，这里通常会根据 <code>sessionId</code> 从数据库或缓存中加载对应的历史</strong>。例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">getMessageHistory:</span> <span class="hljs-keyword">async</span> (sessionId) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> RedisChatMessageHistory(sessionId, redisClient);
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-18">🔸 <code>inputMessagesKey: 'input'</code></h4>
<ul>
<li>指定用户当前输入在调用参数中的字段名。</li>
<li>对应后续的 <code>chain.invoke({ input: '...' })</code>。</li>
<li>LangChain 会从此字段读取用户消息，并在调用完成后将其存入历史。</li>
</ul>
<h4 data-id="heading-19">🔸 <code>historyMessagesKey: 'hitory'</code></h4>
<ul>
<li>指定历史消息在输入对象中的字段名。</li>
<li>LangChain 会从 <code>getMessageHistory()</code> 获取历史消息，并以 <code>{ history: [msg1, msg2, ...] }</code> 的形式注入到 <code>runnable</code> 的输入中。</li>
<li>这个字段名必须与 <code>ChatPromptTemplate</code> 中的占位符 <code>{history}</code> 一致！</li>
</ul>
<blockquote>
<p>✅ <strong>工作流程总结</strong>：</p>
<ol>
<li>用户调用 <code>chain.invoke({ input: "..." }, { configurable: { sessionId: "..." } })</code></li>
<li><code>RunnableWithMessageHistory</code> 调用 <code>getMessageHistory(sessionId)</code> 获取历史。</li>
<li>构造输入对象：<code>{ input: "...", history: [prev messages] }</code></li>
<li>调用内部 <code>runnable(input)</code></li>
<li>获取模型回复。</li>
<li>将 <code>HumanMessage(input)</code> 和 <code>AIMessage(response)</code> <strong>自动追加</strong>到历史中。</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-20">第七部分：执行多轮对话</h3>
<pre><code class="hljs language-css" lang="css">const res1 = await chain<span class="hljs-selector-class">.invoke</span>(
  { <span class="hljs-selector-tag">input</span>: <span class="hljs-string">'我叫Agiao，喜欢喝白兰地'</span> },
  { configurable: { sessionId: <span class="hljs-string">'makefriend'</span> } }
)
console<span class="hljs-selector-class">.log</span>(res1<span class="hljs-selector-class">.content</span>);

const res2 = await chain<span class="hljs-selector-class">.invoke</span>(
  { <span class="hljs-selector-tag">input</span>: <span class="hljs-string">'我叫什么名字'</span> },
  { configurable: { sessionId: <span class="hljs-string">'makefriend'</span> } }
)
console<span class="hljs-selector-class">.log</span>(res2<span class="hljs-selector-class">.content</span>);
</code></pre>
<h4 data-id="heading-21">🔹 第一次调用</h4>
<ul>
<li>
<p>输入：<code>{ input: '我叫Agiao，喜欢喝白兰地' }</code></p>
</li>
<li>
<p>此时 <code>messageHistory</code> 为空，所以 <code>{history}</code> 占位符被替换为空数组。</p>
</li>
<li>
<p>最终 prompt：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>)]</span>
</code></pre>
</li>
<li>
<p>模型回复后，<code>messageHistory</code> 自动更新为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span>)]</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-22">🔹 第二次调用</h4>
<ul>
<li>
<p>输入：<code>{ input: '我叫什么名字' }</code></p>
</li>
<li>
<p><code>messageHistory</code> 已包含两条消息。</p>
</li>
<li>
<p>最终 prompt：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span>),  HumanMessage(<span class="hljs-string">"我叫什么名字"</span>)]</span>
</code></pre>
</li>
<li>
<p>模型看到完整上下文，自然能回答：“你叫 Agiao。”</p>
</li>
</ul>
<blockquote>
<p>🎯 <strong>关键优势</strong>：开发者无需手动管理历史拼接、消息格式转换、存储逻辑——全部由 LangChain 自动处理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">调试输出：见证记忆的传递</h2>
<p>中间的调试节点会打印：</p>
<p><strong>第一次调用后：</strong></p>
<pre><code class="hljs language-css" lang="css">&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)
{
  messages: [
    SystemMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"你是一个有记忆的助手"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span> }
  ]
}
</code></pre>
<p><strong>第二次调用后：</strong></p>
<pre><code class="hljs language-css" lang="css">&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)
{
  messages: [
    SystemMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"你是一个有记忆的助手"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span> },
    AIMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫什么名字"</span> }
  ]
}
</code></pre>
<p>这清晰展示了<strong>历史如何被逐步累积并注入上下文</strong>。</p>
<hr/>
<h2 data-id="heading-24">对比：有记忆 vs 无记忆</h2>








































<table><thead><tr><th>特性</th><th><code>index.js</code>（无记忆）</th><th><code>1.js</code>（有记忆）</th></tr></thead><tbody><tr><td>状态管理</td><td>无</td><td>自动维护对话历史</td></tr><tr><td>上下文传递</td><td>手动拼接（未实现）</td><td>自动注入 <code>{history}</code></td></tr><tr><td>多轮连贯性</td><td>❌ 不支持</td><td>✅ 完美支持</td></tr><tr><td>Token 效率</td><td>每次独立，无冗余</td><td>历史随对话增长，需注意长度</td></tr><tr><td>扩展性</td><td>难以扩展</td><td>易替换存储后端（Redis/DB）</td></tr><tr><td>代码复杂度</td><td>简单但功能有限</td><td>稍复杂但功能强大</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">潜在挑战与优化方向</h2>
<p>虽然 <code>1.js</code> 展示了记忆的基本实现，但在生产环境中还需考虑：</p>
<h3 data-id="heading-26">1. <strong>Token 长度限制</strong></h3>
<ul>
<li>
<p>对话历史不断增长，可能超出模型上下文窗口（如 32768 tokens）。</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>WindowChatMessageHistory</code> 仅保留最近 N 条消息。</li>
<li>实现摘要机制：定期将历史压缩为摘要，并作为系统消息注入。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-27">2. <strong>多用户会话隔离</strong></h3>
<ul>
<li>
<p>当前 <code>messageHistory</code> 是全局单例，所有用户共享。</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>在 <code>getMessageHistory</code> 中根据 <code>sessionId</code> 返回不同历史实例。</li>
<li>使用 <code>RedisChatMessageHistory</code> 或数据库按 session 存储。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-28">3. <strong>持久化</strong></h3>
<ul>
<li>内存存储在服务重启后丢失。</li>
<li><strong>解决方案</strong>：集成持久化存储（如 PostgreSQL、MongoDB）。</li>
</ul>
<h3 data-id="heading-29">4. <strong>长期记忆（Long-term Memory）</strong></h3>
<ul>
<li>对话历史属于短期记忆。</li>
<li><strong>解决方案</strong>：结合向量数据库（如 Pinecone）实现基于检索的长期记忆（RAG + Memory）。</li>
</ul>
<hr/>
<h2 data-id="heading-30">结语：记忆，是智能的基石</h2>
<p>通过 <code>1.js</code>，我们不仅学会了如何用 LangChain 实现 LLM 的记忆，更理解了其背后的设计哲学：<strong>将状态管理与核心逻辑解耦，通过组合式 API 构建可扩展的智能应用</strong>。</p>
<blockquote>
<p>记忆不是魔法，而是一系列精心设计的数据流：<br/>
用户输入 → 加载历史 → 注入上下文 → 调用模型 → 保存新状态。</p>
</blockquote>
<p>当你下次对 AI 说“还记得我吗？”，希望它能微笑着回答：“当然，Agiao。你上次说喜欢白兰地，要不要再来一杯？”</p>
<p>🥂 <strong>Cheers to intelligent conversations with memory!</strong></p>
<hr/>
<blockquote>
<p><strong>附：完整代码链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fai%2Flangchain%2Fmemory%2Fdemo" title="https://gitee.com/giaoZou/lesson_zp/tree/master/ai/langchain/memory/demo" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/ai/langchain/memory/demo: AI + 全栈学习仓库</a></p>
<p>在该项目根目录中需添加  .env  文件，文件中添加DeepSeek大模型的API_KEY</p>
<p>例如：</p>
<p>DEEPSEEK_API_KEY=sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXX</p>
<p>API_KEY获取地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fusage" title="https://platform.deepseek.com/usage" target="_blank" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭]]></title>    <link>https://juejin.cn/post/7588061231589326889</link>    <guid>https://juejin.cn/post/7588061231589326889</guid>    <pubDate>2025-12-27T01:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588061231589326889" data-draft-id="7587995707166310419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭"/> <meta itemprop="keywords" content="前端,面试,编程语言"/> <meta itemprop="datePublished" content="2025-12-27T01:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:49:28.000Z" title="Sat Dec 27 2025 01:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">玩转 TailwindCSS：从 "样式混乱" 到 "丝滑开发" 的逆袭之路 🚀</h2>
<p>哈喽，前端圈的小伙伴们～ 今天咱们来聊聊一个让样式开发效率飙升的神器 ——TailwindCSS。提前说一句，本文会结合 React 来讲，要是你还没学习过 React ，翻翻我前面的文章补补课哦，保证一看就会！</p>
<h3 data-id="heading-1">一、传统 CSS：那些年我们踩过的 "样式坑" 🕳️</h3>
<p>先来看段 "考古级"CSS 代码，眼熟不？👇</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.primary-btn</span> {
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">color</span>:white;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
  }
  <span class="hljs-selector-class">.default-btn</span> {
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#000</span>;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"primary-btn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"default-btn"</span>&gt;</span>默认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>盯着这段代码 3 秒钟，是不是发现了什么？padding 和 border-radius 这俩兄弟在两个类里重复出现了！就像你点奶茶时，每次都要重复说 "少冰、三分糖"，多费劲啊😤。传统 CSS 的问题就在于：一个类名承包了所有样式，业务属性和样式规则混在一起，想复用？难！改一处样式？可能要改 N 个类名，简直是前端开发的 "脱发元凶" 之一。</p>
<h3 data-id="heading-2">二、封装基类 + 组合变体：给 CSS 来个 "代码瘦身" 🐜</h3>
<p>那怎么拯救这些重复的代码呢？答案就是：给 CSS 做 "封装手术"！咱们可以把重复的样式抽成基类，再用变体类来实现不同效果，就像搭积木一样灵活～</p>
<p>还是拿按钮举例，看这段优化后的代码：</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.btn</span> { <span class="hljs-comment">/* 基类：提取公共样式 */</span>
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
    <span class="hljs-attribute">cursor</span>:pointer;
  }
  <span class="hljs-selector-class">.btn-primary</span> { <span class="hljs-comment">/* 变体：个性化样式 */</span>
    <span class="hljs-attribute">background</span>: blue;
    <span class="hljs-attribute">color</span>:white;
  }
  <span class="hljs-selector-class">.btn-default</span> { <span class="hljs-comment">/* 变体：个性化样式 */</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#000</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span>&gt;</span>默认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p><strong>代码效果（与上文传统css 举例代码实现的效果一样）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10fc5f3cf92a40e1af63963b9b46de41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=XcF3GQzruS3TpzJJyBO9AMJ5D%2Bw%3D" alt="QQ20251226-235034.png" loading="lazy"/></p>
<p>瞧见没？.btn 就像个 "样式地基"，不管是 primary 还是 default 按钮，都能共用它的 padding 和圆角。这种 "基类 + 变体" 的思路，其实就是面向对象 CSS 的精髓～ 但这还不够极致！如果我想要 "margin-left: 2px"、"font-size: 14px" 这种更细粒度的样式复用，该怎么办？这时，TailwindCSS 就该登场了！</p>
<h3 data-id="heading-3">三、原子 CSS TailwindCSS：样式界的 "乐高积木" 🧩</h3>
<h4 data-id="heading-4">1.什么是 TailwindCSS？</h4>
<p>简单说，TailwindCSS 是一个 "原子 CSS 框架"。啥叫原子 CSS？就是把 CSS 规则拆成无数个最小单位的 "原子类"，比如 "padding: 4px" 对应 p-1，"background: blue" 对应 bg-blue-600。这些原子类就像乐高积木，随便拼就能搭出各种样式～</p>
<h4 data-id="heading-5">2.解决了啥问题？优点多到数不清！</h4>
<ul>
<li>不用再想类名了！再也不会为 "这个 div 叫 container 还是 wrapper" 抓头发🤯</li>
<li>不用切换文件写 CSS！直接在 HTML/JSX 里写样式，效率拉满</li>
<li>样式复用率 MAX！一套原子类走天下，再也不用复制粘贴重复样式</li>
<li>响应式设计超简单！自带各种屏幕尺寸的前缀，适配移动端 so easy</li>
</ul>
<h4 data-id="heading-6">3.和 LLM 是 "最佳拍档"？</h4>
<p>TailwindCSS 通过预定义的原子化类名让开发者无需手写原生 CSS，但拼接大量类名仍有成本；AI 则能从 “自然语言描述→代码生成→优化调试” 全流程提升 Tailwind 开发效率，二者结合的核心应用如下：</p>
<h5 data-id="heading-7">（1）通用 AI 助手（ChatGPT/Gemini/ 文心一言）</h5>
<p>这是最易获取的工具，只需用自然语言描述界面需求，就能直接生成可运行的 Tailwind 代码。<strong>示例提示词</strong>：</p>
<blockquote>
<p>帮我用 TailwindCSS v3 写一个移动端适配的商品卡片，宽度 100%（最大 300px），圆角 12px，包含商品图片（16:9 比例）、标题（最多 2 行）、价格（红色加粗）和加入购物车按钮，轻微阴影。</p>
</blockquote>
<p><strong>AI 生成的可直接运行的代码</strong>：</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>商品卡片<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入TailwindCSS CDN --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.tailwindcss.com"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-gray-50 p-4"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 商品卡片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full max-w-[300px] bg-white rounded-3xl shadow-sm overflow-hidden"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 商品图片 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-[16/9] bg-gray-200 overflow-hidden"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/300/169"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"商品图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full h-full object-cover hover:scale-105 transition-transform duration-300"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 商品信息 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 商品标题（最多2行） --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-800 font-medium mb-2 line-clamp-2"</span>&gt;</span>新款夏季纯棉T恤 宽松透气百搭休闲上衣<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 商品价格 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-red-600 font-bold text-xl mb-3"</span>&gt;</span>¥99.9<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 加入购物车按钮 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"</span>&gt;</span>
                加入购物车
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>实现的效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0df5f2d220a04cc1b41ee17b5dc2a824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=59mJJWJz7%2BZn9wZnHv8Xi2W%2FTJs%3D" alt="QQ20251227-092130.png" loading="lazy"/></p>
<h5 data-id="heading-8">（2）专门的 Tailwind AI 工具</h5>
<ul>
<li><strong>Tailwind AI（官方）</strong> ：集成在 Tailwind Play（在线编辑器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.tailwindcss.com%2F" target="_blank" title="https://play.tailwindcss.com/" ref="nofollow noopener noreferrer">play.tailwindcss.com/</a>）中，可实时生成、优化样式，还能解释类名含义；</li>
<li><strong>Cursor 编辑器</strong>：内置 AI 助手，支持将原生 CSS 一键转换为 Tailwind，或修复 Tailwind 样式冲突；</li>
<li><strong>Figma to Tailwind AI</strong>：Figma 插件，可将设计稿直接转换为 Tailwind 代码，AI 自动匹配最贴合的类名。</li>
</ul>
<h4 data-id="heading-9">4.TailwindCSS 配置：三步搞定！</h4>
<p>在 React+Vite 项目里用 Tailwind？跟着做就行：</p>
<ol>
<li>安装依赖（终端执行）：</li>
</ol>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">npm install tailwindcss @tailwindcss/vite
</code></pre>
<p>2.  配置 vite.config.js（引入插件）：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 来自vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span> 
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span> <span class="hljs-comment">// 引入Tailwind插件</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwindcss</span>()], <span class="hljs-comment">// 注册插件</span>
})
</code></pre>
<p>3.  配置 index.css（导入样式）：</p>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* 来自index.css */</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>; <span class="hljs-comment">/* 一句话引入所有Tailwind原子类 */</span>
</code></pre>
<p>搞定！🚀</p>
<h3 data-id="heading-10">四、TailwindCSS与 React 组件结合：天作之合！💞</h3>
<h4 data-id="heading-11">直接在 className 里 "堆积木"</h4>
<p>React 组件里用 Tailwind，简直是行云流水～ 直接在 className 里写原子类就行，看例子：</p>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">className</span>=<span class="hljs-string">"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"</span>&gt;
  提交
&lt;/button&gt;
</code></pre>
<p>解释下这些 "积木"：</p>
<ul>
<li>px-4：水平内边距 4 单位（1 单位 = 4px）</li>
<li>py-2：垂直内边距 2 单位</li>
<li>bg-blue-600：背景色为蓝色（600 是深浅度）</li>
<li>text-white：文字白色</li>
<li>rounded-md：中等圆角</li>
<li>hover:bg-blue-700：鼠标悬停时背景色深一点（伪类直接写，太方便了！）</li>
</ul>
<h3 data-id="heading-12">五、TailwindCSS 实战：从代码到界面的魔法 ✨</h3>
<h4 data-id="heading-13">1. 原子类组合实现卡片 UI</h4>
<p>来看个 ArticleCard 组件，用 Tailwind 搭个卡片超简单：</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App2.jsx的卡片组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ArticleCard</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 bg-white rounded-xl shadow hover:shadow-lg transition"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-bold"</span>&gt;</span>Tailwindcss<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>
        用utility class 快速构建UI
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>逐个拆解 "魔法咒语"：</p>
<ul>
<li>p-4：内边距 4 单位，让内容不贴边</li>
<li>bg-white：白色背景，像张卡片纸</li>
<li>rounded-xl：超大圆角，颜值 up</li>
<li>shadow：加个阴影，有立体感</li>
<li>hover:shadow-lg： hover 时阴影变大，交互感拉满</li>
<li>transition：过渡动画，让 hover 效果更丝滑</li>
<li>text-lg：文字大小为 large</li>
<li>font-bold：字体加粗</li>
<li>text-gray-500：文字灰色（500 是中性灰）</li>
<li>mt-2：上边距 2 单位，和标题隔开点</li>
</ul>
<p>效果就是一个简约又好看的卡片，hover 时还有微妙的阴影变化，是不是比写一堆 CSS 快多了？<strong>来看看效果吧：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e3df6217574ddabab8a410d6d636ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=PheHjY02ke6fgOv8b4jSQUkRTb0%3D" alt="QQ20251227-92849.gif" loading="lazy"/></p>
<h4 data-id="heading-14">2. 响应式布局 + 伪类：适配各种设备 📱💻</h4>
<p>Tailwind 的响应式设计堪称一绝，自带断点前缀（sm:、md:、lg: 等），轻松实现 "移动端 - 桌面端" 适配。</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.jsx的响应式布局</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col md:flex-row gap-4"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-100 p-4 md:w-2/3"</span>&gt;</span>主内容<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-green-100 p-4 md:w-1/3"</span>&gt;</span>侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>详解响应式魔法：</p>
<ul>
<li>flex：开启弹性布局</li>
<li>flex-col：默认垂直排列（移动端友好）</li>
<li>md:flex-row：当屏幕宽度≥768px（md 断点）时，改为水平排列（桌面端友好）</li>
<li>gap-4：子元素之间的间距为 4 单位</li>
<li>md:w-2/3：桌面端时主内容占 2/3 宽度</li>
<li>md:w-1/3：桌面端时侧边栏占 1/3 宽度</li>
</ul>
<p>在手机上看是上下排列，在电脑上看是左右排列，完全不用写媒体查询，Tailwind 帮你搞定一切！</p>
<p><strong>PC端：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c220a8ff96074890a3d89cf09f69d15b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=2dNaImU7waECDF3%2F5etTMHOqe04%3D" alt="QQ20251227-093221.png" loading="lazy"/>
<strong>移动端：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145b2b9ba5ef495dbe09135842df2d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=ExgGeiY731daIhLbDwU2yEildE4%3D" alt="QQ20251227-093236.png" loading="lazy"/></p>
<h3 data-id="heading-15">六、面试官会问：这些考点要记牢！📝</h3>
<ol>
<li>什么是原子 CSS？TailwindCSS 的核心思想是什么？（答：将样式拆分为最小单位的原子类，通过组合实现复杂样式）</li>
<li>Tailwind 相比传统 CSS 有什么优势？（答：减少重复代码、不用想类名、响应式方便、开发效率高）</li>
<li>如何在 Tailwind 中实现响应式布局适配？（答：使用断点前缀，如 md:、lg:，配合原子类）</li>
</ol>
<h3 data-id="heading-16">七、结语：从此爱上写样式！💖</h3>
<p>以前写样式，总在 "想类名 - 写 CSS - 调样式" 的循环里挣扎；用了 TailwindCSS后，就像开了 "样式加速器"—— 不用切换文件，不用记复杂规则，对着设计稿拼原子类就行，甚至 AI 都能帮你写大半！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯]]></title>    <link>https://juejin.cn/post/7587965800273657882</link>    <guid>https://juejin.cn/post/7587965800273657882</guid>    <pubDate>2025-12-27T02:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800273657882" data-draft-id="7587965800273641498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T02:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI能力探索"/> <meta itemprop="url" content="https://juejin.cn/user/1549641121016795"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549641121016795/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI能力探索
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:24:33.000Z" title="Sat Dec 27 2025 02:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>机器学习入门的核心是掌握经典算法的原理与实战，K近邻（KNN）、支持向量机（SVM）、朴素贝叶斯作为分类任务的三大基础算法，覆盖了“基于距离”“基于超平面”“基于概率”三种核心思路，是入门机器学习的必学内容。</p>
<h2 data-id="heading-0">一、核心前置知识与环境准备</h2>
<h3 data-id="heading-1">1. 算法核心定位（快速选对算法）</h3>

































<table><thead><tr><th>算法</th><th>核心思想</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>KNN（K近邻）</td><td>近朱者赤：按最近邻样本分类</td><td>原理简单、无需训练、适合多分类</td><td>高维数据慢、对异常值敏感</td><td>小样本分类、推荐系统、数据补全</td></tr><tr><td>SVM（支持向量机）</td><td>找最优超平面分隔样本</td><td>高维数据表现好、泛化能力强</td><td>大样本训练慢、参数调优复杂</td><td>文本分类、图像识别、特征维度高的场景</td></tr><tr><td>朴素贝叶斯</td><td>基于概率公式（贝叶斯）分类</td><td>训练速度极快、适合文本数据</td><td>假设特征独立（实际难满足）</td><td>垃圾邮件过滤、文本分类、情感分析</td></tr></tbody></table>
<h3 data-id="heading-2">2. 环境安装（Scikit-learn核心库）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装核心库（Python 3.8~3.10版本最佳）</span>
pip install scikit-learn numpy pandas matplotlib
</code></pre>
<ul>
<li>Scikit-learn：封装三大算法的核心API，调用统一；</li>
<li>NumPy：处理数值计算，支撑算法底层；</li>
<li>Matplotlib：可视化数据分布和分类效果。</li>
</ul>
<h3 data-id="heading-3">3. 验证安装</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sklearn
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Scikit-learn版本："</span>, sklearn.__version__)  <span class="hljs-comment"># 输出≥1.0.0即可</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"环境准备完成！"</span>)
</code></pre>
<h2 data-id="heading-4">二、K近邻（KNN）算法：最简单的“邻居投票”分类</h2>
<h3 data-id="heading-5">1. 算法原理（通俗理解）</h3>
<p>KNN的核心逻辑：“物以类聚，人以群分”——给一个新样本，找它最近的K个样本（邻居），这K个邻居中占比最多的类别，就是新样本的类别。</p>
<ul>
<li>K值是核心参数：K太小易过拟合（受异常值影响），K太大易欠拟合（分类模糊）。</li>
</ul>
<h3 data-id="heading-6">2. 实战：鸢尾花品种分类（KNN实现）</h3>
<p>以经典的鸢尾花数据集为例，实现KNN分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载数据集并划分训练集/测试集</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 加载数据（特征：花萼/花瓣的长宽，标签：3类鸢尾花）</span>
iris = load_iris()
X = iris.data  <span class="hljs-comment"># 特征矩阵</span>
y = iris.target  <span class="hljs-comment"># 标签向量</span>

<span class="hljs-comment"># 划分数据集：训练集70%，测试集30%</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>  <span class="hljs-comment"># random_state保证结果可复现</span>
)

<span class="hljs-comment"># 步骤2：数据标准化（KNN基于距离，必须标准化）</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

<span class="hljs-comment"># 步骤3：初始化并训练KNN模型</span>
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 初始化模型：K=5（常用默认值）</span>
knn_model = KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
<span class="hljs-comment"># KNN无需“训练”，仅存储训练集数据（预测时计算距离）</span>
knn_model.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 步骤4：模型预测与评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, classification_report

<span class="hljs-comment"># 预测测试集</span>
y_pred = knn_model.predict(X_test_scaled)
<span class="hljs-comment"># 计算准确率</span>
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"KNN模型准确率："</span>, accuracy)  <span class="hljs-comment"># 鸢尾花数据集上≈0.98</span>
<span class="hljs-comment"># 详细分类报告（精确率、召回率、F1值）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告："</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred))

<span class="hljs-comment"># 步骤5：K值调优（找到最优K）</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]  <span class="hljs-comment"># 中文显示</span>

<span class="hljs-comment"># 测试K=1到20的准确率</span>
k_range = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)
accuracy_list = []
<span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> k_range:
    knn = KNeighborsClassifier(n_neighbors=k)
    knn.fit(X_train_scaled, y_train)
    accuracy_list.append(accuracy_score(y_test, knn.predict(X_test_scaled)))

<span class="hljs-comment"># 可视化K值与准确率关系</span>
plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
plt.plot(k_range, accuracy_list, marker=<span class="hljs-string">'o'</span>, color=<span class="hljs-string">'blue'</span>)
plt.xlabel(<span class="hljs-string">'K值（邻居数量）'</span>)
plt.ylabel(<span class="hljs-string">'准确率'</span>)
plt.title(<span class="hljs-string">'KNN算法K值调优'</span>)
plt.grid(linestyle=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.7</span>)
plt.savefig(<span class="hljs-string">'knn_k_tuning.png'</span>)
plt.close()
</code></pre>
<h3 data-id="heading-7">3. KNN关键技巧</h3>
<ul>
<li><strong>标准化必做</strong>：特征单位不同（如花萼长度cm，花瓣宽度mm）会导致距离计算偏差，必须用<code>StandardScaler</code>标准化；</li>
<li><strong>K值选择</strong>：通过遍历测试（如K=1~20）找到准确率最高的K，或用“肘部法则”（准确率提升放缓的点）；</li>
<li><strong>距离度量</strong>：默认用欧氏距离，高维数据可尝试曼哈顿距离（<code>metric='manhattan'</code>）。</li>
</ul>
<h2 data-id="heading-8">三、支持向量机（SVM）：找“最优分隔线”的分类器</h2>
<h3 data-id="heading-9">1. 算法原理（通俗理解）</h3>
<p>SVM的核心是在特征空间中找一条“最优超平面”，将不同类别的样本分隔开，且超平面到两边样本的“间隔”最大——间隔越大，模型泛化能力越强。</p>
<ul>
<li>线性可分：直接找线性超平面；</li>
<li>线性不可分：通过“核函数”将数据映射到高维空间，实现线性分隔（常用核函数：高斯核<code>rbf</code>、线性核<code>linear</code>）。</li>
</ul>
<h3 data-id="heading-10">2. 实战：手写数字分类（SVM实现）</h3>
<p>以手写数字数据集为例，实现SVM分类（适合高维特征场景）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载手写数字数据集</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_digits
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 加载数据（8x8像素的手写数字，共10类）</span>
digits = load_digits()
X = digits.data  <span class="hljs-comment"># 特征：64维（8*8）</span>
y = digits.target  <span class="hljs-comment"># 标签：0-9</span>

<span class="hljs-comment"># 划分数据集</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>
)

<span class="hljs-comment"># 步骤2：数据标准化</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

<span class="hljs-comment"># 步骤3：初始化并训练SVM模型</span>
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC

<span class="hljs-comment"># 初始化模型：核函数rbf（处理非线性数据），C=1.0（正则化系数）</span>
svm_model = SVC(kernel=<span class="hljs-string">'rbf'</span>, C=<span class="hljs-number">1.0</span>, gamma=<span class="hljs-string">'scale'</span>, random_state=<span class="hljs-number">42</span>)
<span class="hljs-comment"># 训练模型（SVM训练耗时比KNN长，尤其大样本）</span>
svm_model.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 步骤4：模型评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, confusion_matrix

y_pred = svm_model.predict(X_test_scaled)
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"SVM模型准确率："</span>, accuracy)  <span class="hljs-comment"># 手写数字数据集上≈0.98</span>

<span class="hljs-comment"># 混淆矩阵（查看数字分类错误情况）</span>
cm = confusion_matrix(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n混淆矩阵："</span>)
<span class="hljs-built_in">print</span>(cm)

<span class="hljs-comment"># 步骤5：SVM参数调优（网格搜索找最优C和gamma）</span>
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> GridSearchCV

<span class="hljs-comment"># 定义参数网格</span>
param_grid = {
    <span class="hljs-string">'C'</span>: [<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>],  <span class="hljs-comment"># 正则化系数：越大容错率越低</span>
    <span class="hljs-string">'gamma'</span>: [<span class="hljs-string">'scale'</span>, <span class="hljs-string">'auto'</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.01</span>],  <span class="hljs-comment"># 核函数系数</span>
    <span class="hljs-string">'kernel'</span>: [<span class="hljs-string">'rbf'</span>, <span class="hljs-string">'linear'</span>]
}

<span class="hljs-comment"># 网格搜索（5折交叉验证）</span>
grid_search = GridSearchCV(SVC(random_state=<span class="hljs-number">42</span>), param_grid, cv=<span class="hljs-number">5</span>, scoring=<span class="hljs-string">'accuracy'</span>)
grid_search.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 输出最优参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSVM最优参数："</span>, grid_search.best_params_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"交叉验证最优准确率："</span>, grid_search.best_score_)

<span class="hljs-comment"># 用最优模型预测</span>
best_svm = grid_search.best_estimator_
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最优模型测试集准确率："</span>, accuracy_score(y_test, best_svm.predict(X_test_scaled)))
</code></pre>
<h3 data-id="heading-11">3. SVM关键技巧</h3>
<ul>
<li><strong>核函数选择</strong>：线性数据用<code>linear</code>（速度快），非线性数据用<code>rbf</code>（效果好）；</li>
<li><strong>参数调优</strong>：C（正则化）越大，模型越“硬”（易过拟合）；gamma越大，核函数影响范围越小（易过拟合）；</li>
<li><strong>样本量限制</strong>：SVM适合中小样本（万级以内），大样本建议用<code>SGDClassifier</code>（随机梯度下降版SVM）。</li>
</ul>
<h2 data-id="heading-12">四、朴素贝叶斯：基于概率的“文本分类神器”</h2>
<h3 data-id="heading-13">1. 算法原理（通俗理解）</h3>
<p>朴素贝叶斯基于“贝叶斯公式”，核心假设是“特征之间相互独立”（朴素性），通过计算样本属于每个类别的概率，选择概率最大的类别作为预测结果。</p>
<ul>
<li>文本分类中，特征是“单词出现次数”，通过词频计算概率，速度极快。</li>
</ul>
<h3 data-id="heading-14">2. 实战：垃圾邮件分类（朴素贝叶斯实现）</h3>
<p>以经典的20NewsGroups文本数据集为例，实现朴素贝叶斯文本分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载文本数据集并预处理</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_20newsgroups
<span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer

<span class="hljs-comment"># 加载数据集（仅选4个类别，简化任务）</span>
categories = [<span class="hljs-string">'alt.atheism'</span>, <span class="hljs-string">'soc.religion.christian'</span>, <span class="hljs-string">'comp.graphics'</span>, <span class="hljs-string">'sci.med'</span>]
<span class="hljs-comment"># 加载训练集和测试集</span>
train_data = fetch_20newsgroups(subset=<span class="hljs-string">'train'</span>, categories=categories, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)
test_data = fetch_20newsgroups(subset=<span class="hljs-string">'test'</span>, categories=categories, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 文本特征提取：TF-IDF（将文本转为数值特征）</span>
tfidf = TfidfVectorizer(stop_words=<span class="hljs-string">'english'</span>)  <span class="hljs-comment"># 去除英文停用词（the/a/an等）</span>
X_train = tfidf.fit_transform(train_data.data)
X_test = tfidf.transform(test_data.data)
y_train = train_data.target
y_test = test_data.target

<span class="hljs-comment"># 步骤2：初始化并训练朴素贝叶斯模型</span>
<span class="hljs-keyword">from</span> sklearn.naive_bayes <span class="hljs-keyword">import</span> MultinomialNB

<span class="hljs-comment"># 多项式朴素贝叶斯（适合文本分类，处理离散特征）</span>
nb_model = MultinomialNB(alpha=<span class="hljs-number">1.0</span>)  <span class="hljs-comment"># alpha：平滑系数，避免概率为0</span>
nb_model.fit(X_train, y_train)

<span class="hljs-comment"># 步骤3：模型评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, classification_report

y_pred = nb_model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"朴素贝叶斯模型准确率："</span>, accuracy)  <span class="hljs-comment"># 文本数据集上≈0.84</span>

<span class="hljs-comment"># 详细分类报告</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告："</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred, target_names=train_data.target_names))

<span class="hljs-comment"># 步骤4：实战预测新文本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_text</span>(<span class="hljs-params">text</span>):
    <span class="hljs-comment"># 文本转为TF-IDF特征</span>
    text_tfidf = tfidf.transform([text])
    <span class="hljs-comment"># 预测类别</span>
    pred = nb_model.predict(text_tfidf)[<span class="hljs-number">0</span>]
    <span class="hljs-comment"># 返回类别名称</span>
    <span class="hljs-keyword">return</span> train_data.target_names[pred]

<span class="hljs-comment"># 测试预测</span>
test_text1 = <span class="hljs-string">"GPU performance for 3D rendering"</span>  <span class="hljs-comment"># 计算机图形学</span>
test_text2 = <span class="hljs-string">"Medical treatment for diabetes"</span>  <span class="hljs-comment"># 医学</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n文本1分类结果："</span>, predict_text(test_text1))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"文本2分类结果："</span>, predict_text(test_text2))
</code></pre>
<h3 data-id="heading-15">3. 朴素贝叶斯关键技巧</h3>
<ul>
<li><strong>特征提取</strong>：文本分类必须用TF-IDF/词袋模型将文本转为数值特征；</li>
<li><strong>平滑系数alpha</strong>：alpha越大，平滑越强（避免因某个单词未出现导致概率为0）；</li>
<li><strong>适用场景</strong>：优先用于文本/序列数据，不适合特征高度相关的场景（违背“朴素”假设）。</li>
</ul>
<h2 data-id="heading-16">五、三大算法对比与选型指南</h2>















































<table><thead><tr><th>维度</th><th>KNN</th><th>SVM</th><th>朴素贝叶斯</th></tr></thead><tbody><tr><td>训练速度</td><td>无训练（极快）</td><td>中-慢（尤其大样本）</td><td>极快（概率计算）</td></tr><tr><td>预测速度</td><td>慢（计算距离）</td><td>快</td><td>极快</td></tr><tr><td>高维数据</td><td>效果差（维度灾难）</td><td>效果好</td><td>效果好（文本高维）</td></tr><tr><td>超参数调优</td><td>仅K值</td><td>C、gamma、核函数</td><td>仅alpha</td></tr><tr><td>过拟合风险</td><td>K小易过拟合</td><td>C大易过拟合</td><td>低（模型简单）</td></tr><tr><td>核心适用场景</td><td>小样本分类</td><td>高维/非线性分类</td><td>文本/概率类分类</td></tr></tbody></table>
<h3 data-id="heading-17">选型原则：</h3>
<ol>
<li>小样本、特征维度低 → 选KNN；</li>
<li>高维数据（文本/图像）、非线性 → 选SVM；</li>
<li>文本分类、追求速度、样本量大 → 选朴素贝叶斯。</li>
</ol>
<h2 data-id="heading-18">六、常见问题与解决方法</h2>
<ol>
<li><strong>KNN准确率低</strong>：
<ul>
<li>原因：未标准化、K值不合适、特征维度太高；</li>
<li>解决：标准化数据、调优K值、降维（PCA）。</li>
</ul>
</li>
<li><strong>SVM训练慢</strong>：
<ul>
<li>原因：样本量大、用rbf核函数；</li>
<li>解决：用线性核、降维、采样减少样本量。</li>
</ul>
</li>
<li><strong>朴素贝叶斯文本分类效果差</strong>：
<ul>
<li>原因：未去除停用词、TF-IDF参数不合适；</li>
<li>解决：去除停用词、调整TF-IDF的<code>max_features</code>（限制特征数）。</li>
</ul>
</li>
<li><strong>模型过拟合</strong>：
<ul>
<li>KNN：增大K值；</li>
<li>SVM：减小C值、增大gamma；</li>
<li>朴素贝叶斯：增大alpha值。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一个C++知识点|菱形继承]]></title>    <link>https://juejin.cn/post/7588004376866947107</link>    <guid>https://juejin.cn/post/7588004376866947107</guid>    <pubDate>2025-12-26T16:50:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004376866947107" data-draft-id="7587997157237555252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一个C++知识点|菱形继承"/> <meta itemprop="keywords" content="编程语言,C++,程序员"/> <meta itemprop="datePublished" content="2025-12-26T16:50:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="图形学爱好者_Wu"/> <meta itemprop="url" content="https://juejin.cn/user/1060359067408631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一个C++知识点|菱形继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1060359067408631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    图形学爱好者_Wu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:50:49.000Z" title="Fri Dec 26 2025 16:50:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>继承是C++面向对象的核心特性之一，说明类与类之间的特性是可以继承的，这大大提高了代码的复用性，优化了程序结构。但是滥用继承也会导致菱形继承的多继承问题。</p>
<h2 data-id="heading-0">菱形继承</h2>
<p>什么是菱形继承呢？指一个派生类同时继承两个直接基类，这两个直接基类又继承自同一个间接基类，最终形成 “菱形” 的继承结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8495bcc3b8a2453fa1c24d6181d88ce3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=2RZRhhbGEHlnwVHmoAjADU3qLLs%3D" alt="" loading="lazy"/></p>
<p>下面用代码展示菱形继承的结构示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 顶层基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">int</span> a;
    <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">a</span>(val) {}
};

<span class="hljs-comment">// 中间基类 B，继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">B</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val) {}
};

<span class="hljs-comment">// 中间基类 C，继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">C</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val) {}
};

<span class="hljs-comment">// 最终派生类 D，同时继承 B 和 C</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 问题1：初始化 A 时，B 和 C 都会分别初始化 A，导致 A 被初始化两次</span>
    <span class="hljs-built_in">D</span>(<span class="hljs-type">int</span> val1, <span class="hljs-type">int</span> val2) : <span class="hljs-built_in">B</span>(val1), <span class="hljs-built_in">C</span>(val2) {}
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">D <span class="hljs-title">d</span><span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span></span>;
    <span class="hljs-comment">// 问题2：访问 a 时，编译器无法确定是 B::A::a 还是 C::A::a，直接报错</span>
    <span class="hljs-comment">// cout &lt;&lt; d.a &lt;&lt; endl; </span>
    <span class="hljs-comment">// 必须显式指定，但这违背了“单一继承”的逻辑，且数据冗余（d 中有两个 a）</span>
    cout &lt;&lt; d.B::a &lt;&lt; endl; <span class="hljs-comment">// 输出 1</span>
    cout &lt;&lt; d.C::a &lt;&lt; endl; <span class="hljs-comment">// 输出 2</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>上述问题中，A为顶级基类，B和C继承A，初始化 A 时，B 和 C 都会分别初始化 A，导致 A 被初始化两次；访问 a 时，编译器无法确定是 B::A::a 还是 C::A::a，直接报错</p>
<p>注:“B::A::a”的含义是有两层：</p>
<blockquote>
<ol>
<li>
<p>"A::a"表示 “类 <code>A</code> 中的成员变量 <code>a</code>”</p>
</li>
<li>
<p>"B::"<code>B</code> 是 <code>A</code> 的派生类</p>
</li>
</ol>
</blockquote>
<h2 data-id="heading-1">核心问题</h2>
<p>菱形继承的核心问题是<strong>间接基类的成员会被多次复制</strong>，导致数据冗余、二义性，甚至逻辑错误。</p>
<p>数据冗余表现在间接基类 <code>A</code> 的成员因为B和C的缘故会在最终派生类 <code>D</code> 中存在两份，浪费内存；</p>
<p>二义性则表现在直接访问 <code>D</code> 对象的 <code>A</code> 成员时，编译器无法区分是 <code>B</code> 继承的 <code>A</code> 还是 <code>C</code> 继承的 <code>A</code>，就会造成编译报错；</p>
<p>逻辑错误：若 <code>A</code> 有虚函数，多态调用时可能因重复的基类指针导致行为异常。原因是非虚继承的菱形结构中，最终派生类会包含<strong>两份 A 的虚指针（vptr）</strong>，多态调用时无法确定该用哪一个，导致调用结果不符合预期，甚至崩溃。</p>
<p><strong>菱形继承的内存布局</strong>如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb3548d7aeb4dde870c176ff7a591cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=ZHjq2NZXFF8VDBgYNju4pnKnFiA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">解决方案：虚继承</h2>
<p>由于多继承会造成菱形继承问题，那么C++ 提供<strong>虚继承</strong>机制就是解决菱形继承的办法。虚继承通过让中间基类（<code>B</code>、<code>C</code>）共享同一个间接基类（<code>A</code>）的实例，从而消除数据冗余和二义性</p>
<p>在中间基类继承顶层基类时，添加 <code>virtual</code> 关键字，用代码举例如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 顶层基类（不变）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">int</span> a;
    <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">a</span>(val) {}
};

<span class="hljs-comment">// 中间基类 B：虚继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 虚继承下，B 的构造函数不再直接初始化 A（A 的初始化由最终派生类负责）</span>
    <span class="hljs-built_in">B</span>() {}
};

<span class="hljs-comment">// 中间基类 C：虚继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">C</span>() {}
};

<span class="hljs-comment">// 最终派生类 D：必须直接初始化虚基类 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 核心：虚基类 A 的构造由最终派生类 D 统一初始化，避免重复</span>
    <span class="hljs-built_in">D</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val), <span class="hljs-built_in">B</span>(), <span class="hljs-built_in">C</span>() {}
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">D <span class="hljs-title">d</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;
    <span class="hljs-comment">// 无歧义：d 中只有一份 A::a</span>
    cout &lt;&lt; d.a &lt;&lt; endl; <span class="hljs-comment">// 输出 10</span>
    cout &lt;&lt; d.B::a &lt;&lt; endl; <span class="hljs-comment">// 仍可显式访问，结果同上</span>
    cout &lt;&lt; d.C::a &lt;&lt; endl; <span class="hljs-comment">// 结果同上</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>通过上述代码，我们深入分析虚继承的底层原理，虚继承是通过<strong>虚基类表（vbtable）</strong> 和<strong>虚基类指针（vbptr）</strong> 实现的：</p>
<blockquote>
<ol>
<li>
<p>中间基类（<code>B</code>、<code>C</code>）的对象中会增加一个 <code>vbptr</code> 指针，指向虚基类表；</p>
</li>
<li>
<p>虚基类表存储当前对象到虚基类（<code>A</code>）实例的偏移量；</p>
</li>
<li>
<p>最终派生类（<code>D</code>）中只保留一份 <code>A</code> 的实例，<code>B</code> 和 <code>C</code> 的 <code>vbptr</code> 都指向这同一个实例。</p>
</li>
</ol>
</blockquote>
<p>非虚继承的内存布局示意图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0b9b08c2ea549b5ac3e29c3cfc01274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=tG0BlQy6odTarabR7iqiP4zJjeM%3D" alt="" loading="lazy"/>
虚继承的内存布局示意图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32d9e265fe2947fa8a6be4af271aabc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=426suva1OvVfJj3OdVUE4HOCCMU%3D" alt=" " loading="lazy"/></p>
<p>虽然虚继承可以解决菱形继承的问题，但在现实开发中，为了减少不必要的麻烦，尽量避免使用多继承。</p>
<h2 data-id="heading-3">接口多继承的安全场景</h2>
<p>若顶层基类是<strong>纯虚类</strong>，即使是菱形继承结构，也无数据冗余（因为纯虚类无成员变量），此时无需虚继承，用代码举例如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 纯虚接口 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">A</span>() = <span class="hljs-keyword">default</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"B::func"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"C::func"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 必须重写 func，否则 D 仍是抽象类（解决二义性）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ B::<span class="hljs-built_in">func</span>(); }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    D d;
    d.<span class="hljs-built_in">func</span>(); <span class="hljs-comment">// 输出 B::func，无歧义</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-4">总结</h2>
<p>菱形继承的核心问题是间接基类成员重复，虚继承通过共享基类实例解决该问题，实际开发中应优先避免多继承。</p>
<p>以上就是本文的所有内容，如果本文对你有帮助的话欢迎点赞收藏哦~</p>
<p>感兴趣的朋友也欢迎关注哟<del>我将会持续输出编程开发的内容</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”]]></title>    <link>https://juejin.cn/post/7588034035286736911</link>    <guid>https://juejin.cn/post/7588034035286736911</guid>    <pubDate>2025-12-27T03:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286736911" data-draft-id="7588004376867209251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”"/> <meta itemprop="keywords" content="JavaScript,Node.js"/> <meta itemprop="datePublished" content="2025-12-27T03:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:41:46.000Z" title="Sat Dec 27 2025 03:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与目标</h2>
<p>我们需要在 Node.js 中实现一个定制化的 TCP 客户端 (<code>RSATransport</code>)，用于连接现有的 Haskell 服务端。该协议包含自定义的握手流程和三种数据传输模式：</p>
<ul>
<li><strong>Plain (0)</strong> : 握手后明文直连。</li>
<li><strong>RSA (1)</strong> : 全程使用 RSA-OAEP 加密。</li>
<li><strong>AES (2)</strong> : 握手协商出 Session Key 后使用 AES-CTR 加密。</li>
</ul>
<p><strong>Haskell 服务端逻辑 (<code>RSA.hs</code>)</strong> ： 服务端在握手时使用带缓冲的读取方式 (<code>recvDataOaep</code>)，但在切换到 <strong>Plain</strong> 模式后，直接操作底层 Socket (<code>recvData tp</code>)。</p>
<h2 data-id="heading-1">2. 问题现象</h2>
<p>开发过程中出现了一个奇怪的现象：</p>
<ol>
<li><strong>AES 模式正常</strong>：握手、密钥交换、数据传输均流畅。</li>
<li><strong>RSA 模式正常</strong>。</li>
<li><strong>Plain 模式“卡死”</strong> ：握手看似完成，但随后发送的第一条数据服务端无响应，客户端也收不到回包。</li>
<li><strong>“薛定谔的 Bug”</strong> ：如果在代码中加入 <code>console.log</code>，有时能跑通一点点，但随后依然卡住。</li>
</ol>
<h2 data-id="heading-2">3. 根因深度分析</h2>
<p>经过排查，这是一个典型的 <strong>TCP 粘包</strong> 遇上 <strong>应用层状态缓冲区设计缺陷</strong> 导致的逻辑死锁。</p>
<h3 data-id="heading-3">3.1 Haskell 服务端的“缓冲区旁路” Bug</h3>
<p>在 <code>RSA.hs</code> 中，接收逻辑是这样的：</p>
<p>Haskell</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Haskell 伪代码</span>
recvData RSATP {..} n <span class="hljs-operator">=</span> <span class="hljs-keyword">case</span> rsaMode <span class="hljs-keyword">of</span>
  Plain <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvData tp n           <span class="hljs-comment">-- [关键点] 直接读底层 Socket，忽略缓冲区</span>
  RSA   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvDataOaep readBuffer ... <span class="hljs-comment">-- 从缓冲区 readBuffer 读取</span>
  AES   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvDataAes readBuffer ...  <span class="hljs-comment">-- 从缓冲区 readBuffer 读取</span>
</code></pre>
<p>在握手阶段（协商 Mode），服务端调用的是 <code>recvDataOaep</code>。这个函数为了解密，可能会从 TCP Socket 预读取多于所需的字节（例如读取了 4096 字节，但 Mode 包只有 256 字节）。<strong>多余的数据被留在了 Haskell 的 <code>readBuffer</code> (TVar) 中。</strong></p>
<h3 data-id="heading-4">3.2 Node.js 的“过于高效”</h3>
<p>在 Node.js 客户端，当握手完成（发送了 Mode Byte）后，我们立即清空了积压的写入队列 (<code>_writeBuffer</code>) 并发送业务数据。</p>
<p>由于 TCP 的 <strong>Nagle 算法</strong> 和操作系统的缓冲机制，发送的 <strong>[Mode 包]</strong> 和后续的 <strong>[业务数据包]</strong> 极大概率被合并成了一个 TCP 段发送到了服务端。</p>
<h3 data-id="heading-5">3.3 致命的“擦肩而过”</h3>
<p>于是发生了以下时序：</p>
<ol>
<li><strong>Client</strong>: 发送 <code>[Mode=Plain][Data="Hello"]</code>（在同一个 TCP 包中）。</li>
<li><strong>Server</strong>: 调用 <code>recvDataOaep</code> 读取 Mode。它把整个 TCP 包读入内存，解析出 <code>Mode=Plain</code>，剩下的 <code>Data="Hello"</code> 留在了 <code>readBuffer</code> 中。</li>
<li><strong>Server</strong>: 切换状态到 <code>Plain</code>。</li>
<li><strong>Server</strong>: 调用 <code>recvData tp</code> 等待新数据。<strong>注意：它跳过了 <code>readBuffer</code>，直接去问底层 Socket 要数据！</strong></li>
<li><strong>Result</strong>: Socket 缓冲区是空的（数据已经被读到应用层缓冲区了），服务端挂起等待。客户端以为服务端收到了，也在等待响应。<strong>死锁形成。</strong></li>
</ol>
<h2 data-id="heading-6">4. 解决方案</h2>
<p>要解决这个问题，必须在客户端打破“粘包”，确保服务端在处理完 Mode 切换后，Socket 缓冲区里才有新数据到达。</p>
<h3 data-id="heading-7">4.1 禁用 Nagle 算法</h3>
<p>首先，禁止 TCP 延迟发送，确保小包（如握手包）能尽快发出去。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>._socket = net.connect(options);
<span class="hljs-keyword">this</span>._socket.setNoDelay(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 禁用 Nagle</span>
</code></pre>
<h3 data-id="heading-8">4.2 严格的写操作流控</h3>
<p>不能依赖 Node.js 的自动缓冲，必须确保上一个包真正写入内核（drain）后，再发下一个包。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用回调链确保顺序</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_sendOAEP</span>(modePayload, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// Mode 包写入完成后的回调</span>
    self.<span class="hljs-title function_">_finishHandshake</span>();
});
</code></pre>
<h3 data-id="heading-9">4.3 针对 Plain 模式的“魔法延时”</h3>
<p>这是最关键的一步。由于我们无法修改 Haskell 服务端代码，必须在客户端进行规避。在发送 Mode 包和发送第一条 Plain 数据之间，强制插入一个微小的延时（50ms）。</p>
<p>这给了服务端足够的时间：</p>
<ol>
<li>处理 Mode 包。</li>
<li>清空其内部接收逻辑。</li>
<li>切换到 Socket 直接读取模式。</li>
</ol>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">RSATransport</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_finishHandshake</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_state</span> = <span class="hljs-string">'ESTABLISHED'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'connect'</span>);

  <span class="hljs-comment">// 刷新积压的数据</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_writeBuffer</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">flush</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// ... 发送积压数据 ...</span>
    };

    <span class="hljs-comment">// 针对 Plain 模式的 Hack：</span>
    <span class="hljs-comment">// 强制延时，防止 Mode 包和后续数据粘包，</span>
    <span class="hljs-comment">// 避免服务端读取 Mode 时误读了后续数据到 Buffer 中却在 Plain 模式下无法访问。</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mode</span> === <span class="hljs-variable constant_">MODE_PLAIN</span>) {
      <span class="hljs-built_in">setTimeout</span>(flush, <span class="hljs-number">50</span>); 
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">flush</span>();
    }
  }
};
</code></pre>
<h3 data-id="heading-10">4.4 完善背压 (Backpressure) 处理</h3>
<p>除了上述核心 Bug，我们还修复了 <code>write</code> 方法的返回值问题。当处于 Plain 模式（高吞吐）时，必须正确处理 TCP 的背压，否则会导致内存飙升或数据丢失。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 转发底层的 drain 事件</span>
<span class="hljs-keyword">this</span>._socket.on(<span class="hljs-string">'drain'</span>, () =&gt; <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'drain'</span>));

<span class="hljs-comment">// 正确返回 boolean</span>
Transport.prototype.write = function(<span class="hljs-keyword">data</span>, encoding, callback) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._socket.write(<span class="hljs-keyword">data</span>, encoding, callback); 
};
</code></pre>
<h2 data-id="heading-11">5. 总结</h2>
<p>这次排查再次验证了网络编程中的一条铁律：<strong>TCP 是流协议，不是包协议</strong>。</p>
<p>当客户端与服务端由不同语言编写，且服务端存在混合读取策略（Buffer读取 vs Socket直读）时，应用层必须极其小心地处理数据边界。</p>
<ul>
<li><strong>教训 1</strong>: 不要假设 <code>write</code> 两次就会产生两个 TCP 包。</li>
<li><strong>教训 2</strong>: 在处理协议状态切换（如握手 -&gt; 传输）时，状态机的同步至关重要。</li>
<li><strong>教训 3</strong>: 遇到“卡死”且日志影响行为时，优先怀疑缓冲机制和竞态条件。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付配置时好时坏？异步方法里的对象引用坑]]></title>    <link>https://juejin.cn/post/7588010346071179274</link>    <guid>https://juejin.cn/post/7588010346071179274</guid>    <pubDate>2025-12-27T03:53:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346071179274" data-draft-id="7588010346071162890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付配置时好时坏？异步方法里的对象引用坑"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-27T03:53:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付配置时好时坏？异步方法里的对象引用坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:53:57.000Z" title="Sat Dec 27 2025 03:53:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周接到客服反馈。</p>
<p>有些商户开通之后，微信支付功能不能用，有些又可以。不能用的商户就需要客服手动介入，重新配置支付参数才恢复正常。</p>
<p>这个问题就很诡异，<strong>时好时坏</strong>。有时候正常，有时候就不行。</p>
<p>但是后台日志显示都是配置成功。代码执行完了，没有任何报错。</p>
<h2 data-id="heading-0">诡异的现象</h2>
<p>开始排查日志。发现了几个很奇怪的点：</p>
<ol>
<li><strong>业务日志显示成功</strong>，没有任何异常</li>
<li><strong>调用日志显示两次配置用的appid一样</strong></li>
<li><strong>代码明明写的是两个不同的appid</strong></li>
<li><strong>配置文件也没问题</strong>，两个appid都配对了</li>
</ol>
<p>代码写的明明是A和B两个appid，为啥日志里都变成B了？</p>
<p>看了好几遍日志，确定没看错。两次调用传入的appid确实一模一样。</p>
<p>那就只能看看代码了。</p>
<pre><code class="hljs language-ini" lang="ini">openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
openMemberV2DTO.setSupAppId(sysConfig.getWxHuikeOfficialAccountAppid())<span class="hljs-comment">;</span>
openMemberV2DTO.setAccountType("00")<span class="hljs-comment">;</span>
openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
LogUtil.info(log, "editGrant &gt;&gt; 开通成功 &gt;&gt; <span class="hljs-attr">param</span> = {}<span class="hljs-string">", param);
</span></code></pre>
<p>乍一看，完全没问题。</p>
<p>第一次调用用的是<code>openMemberV2DTO</code>原始的appid。第二次调用之前，明明修改了<code>supAppId</code>和<code>accountType</code>。</p>
<p>代码逻辑也很清晰，为啥会出问题？</p>
<p>会不会是配置文件把appid配错了？</p>
<p>检查了配置文件：</p>
<p>配置也没问题。两个appid都对。</p>
<p>既然代码逻辑没问题，配置也没问题，那问题大概率就是wxConfig这个方法了</p>
<p>点开<code>wxConfig</code>方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">wxConfig</span>(<span class="hljs-params">OpenMemberV2DTO dto</span>) {
    asyncTaskExecutor.<span class="hljs-title function_">execute</span>(() -&gt; {
        <span class="hljs-comment">// 获取参数</span>
        <span class="hljs-title class_">String</span> subAppId = dto.<span class="hljs-title function_">getSupAppId</span>();
        <span class="hljs-title class_">String</span> accountType = dto.<span class="hljs-title function_">getAccountType</span>();

        <span class="hljs-comment">// 调用微信API配置</span>
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> body = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();
        body.<span class="hljs-title function_">put</span>(<span class="hljs-string">"sub_appid"</span>, subAppId);
        body.<span class="hljs-title function_">put</span>(<span class="hljs-string">"account_type"</span>, accountType);

        <span class="hljs-comment">// 调用平台接口...</span>
        platformManager.<span class="hljs-title function_">call</span>(callParam);
    });
}
</code></pre>
<p>看到<code>asyncTaskExecutor.execute</code>，相信大家就明白了。</p>
<p><strong>这是个异步方法！</strong></p>
<p>那问题链路就清楚了：</p>
<ol>
<li>主线程调用<code>wxConfig(openMemberV2DTO)</code> → 任务提交到线程池，<strong>还没执行</strong></li>
<li>主线程继续执行，修改<code>openMemberV2DTO.setSupAppId(...)</code></li>
<li>主线程再次调用<code>wxConfig(openMemberV2DTO)</code> → 又提交一个任务到线程池</li>
<li>线程池开始执行第一个任务 → 读取<code>dto.getSupAppId()</code>，发现已经是修改后的值了</li>
<li>线程池执行第二个任务 → 还是同一个对象，appid当然一样</li>
</ol>
<p><strong>两次传的是同一个对象引用，第二次修改污染了第一次的数据。</strong></p>
<h2 data-id="heading-1">问题本质</h2>
<p>这个问题的本质是：<strong>对象引用 + 异步方法 ≈ 数据污染</strong></p>
<h3 data-id="heading-2">Java对象引用机制</h3>
<p>Java方法传参，传的是引用，不是副本。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 这两次调用，传的是同一个对象的引用</span>
<span class="hljs-built_in">wxConfig</span>(openMemberV2DTO);  <span class="hljs-comment">// 传的是引用</span>
openMemberV2DTO<span class="hljs-selector-class">.setSupAppId</span>("new_appid");  <span class="hljs-comment">// 修改对象</span>
<span class="hljs-built_in">wxConfig</span>(openMemberV2DTO);  <span class="hljs-comment">// 还是同一个引用</span>
</code></pre>
<p>如果<code>wxConfig</code>是同步方法，没问题。因为第一次调用会立即执行完，用的是修改前的值。</p>
<p>但<code>wxConfig</code>是异步方法。</p>
<h3 data-id="heading-3">异步方法的执行时机</h3>
<p>异步方法不会立即执行，而是提交到线程池，等线程池有空闲线程时才执行。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 主线程时间线</span>
t1: <span class="hljs-built_in">wxConfig</span>(dto)  → 提交任务A到线程池
t2: dto.<span class="hljs-built_in">setSupAppId</span>(<span class="hljs-string">"new"</span>)  → 修改对象
t3: <span class="hljs-built_in">wxConfig</span>(dto)  → 提交任务B到线程池
t4: 主线程结束

// 线程池时间线
t5: 执行任务A → 读取dto.<span class="hljs-built_in">getSupAppId</span>()  // 已经是<span class="hljs-string">"new"</span>了！
t6: 执行任务B → 读取dto.<span class="hljs-built_in">getSupAppId</span>()  // 还是<span class="hljs-string">"new"</span>
</code></pre>
<h3 data-id="heading-4">完整的问题链路</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Main as 主线程
    participant Pool as 线程池
    participant Obj as openMemberV2DTO对象

    Note over Main: t1时刻
    Main-&gt;&gt;Pool: wxConfig(openMemberV2DTO)
    Note over Pool: 任务A进入队列&lt;br/&gt;等待执行

    Note over Main: t2时刻
    Main-&gt;&gt;Obj: setSupAppId(&amp;#34;wx_huike...&amp;#34;)
    Main-&gt;&gt;Obj: setAccountType(&amp;#34;00&amp;#34;)
    Note over Obj: 对象状态被修改

    Note over Main: t3时刻
    Main-&gt;&gt;Pool: wxConfig(openMemberV2DTO)
    Note over Pool: 任务B进入队列&lt;br/&gt;等待执行

    Note over Main: t4时刻
    Note over Main: 主线程结束&lt;br/&gt;打印&amp;#34;开通成功&amp;#34;

    Note over Pool: t5时刻
    Pool-&gt;&gt;Obj: 执行任务A&lt;br/&gt;读取getSupAppId()
    Note over Obj: 返回：&amp;#34;wx_huike...&amp;#34;&lt;br/&gt;已经是修改后的值！

    Note over Pool: t6时刻
    Pool-&gt;&gt;Obj: 执行任务B&lt;br/&gt;读取getSupAppId()
    Note over Obj: 返回：&amp;#34;wx_huike...&amp;#34;&lt;br/&gt;还是同一个值！
</code></pre>
<p><strong>两个任务读取的都是修改后的值。</strong></p>
<h2 data-id="heading-5">为什么这个bug特别容易被忽略。？</h2>
<h3 data-id="heading-6">代码看起来完全正常</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">wxConfig</span>(dto);  <span class="hljs-comment">// 第一次调用</span>
dto<span class="hljs-selector-class">.setSupAppId</span>("new");  <span class="hljs-comment">// 修改</span>
<span class="hljs-built_in">wxConfig</span>(dto);  <span class="hljs-comment">// 第二次调用</span>
</code></pre>
<p>如果不知道<code>wxConfig</code>是异步的，这代码一点问题都没有。</p>
<h3 data-id="heading-7">没有啥报错</h3>
<p>业务逻辑正常执行完了，日志显示成功。不会抛异常，不会空指针。</p>
<p>只是<strong>配置错了</strong>而已。</p>
<h3 data-id="heading-8">问题是偶发的</h3>
<p>这才是最隐蔽的地方。</p>
<p>如果线程池刚好空闲，第一个任务提交后立即执行完了，第二个任务再进来，就不会有问题。</p>
<p>但如果线程池正忙，两个任务都在队列里等待，等到真正执行时，对象可能早就被修改了。</p>
<p><strong>时好时坏，最难排查。</strong></p>
<h3 data-id="heading-9">日志的迷惑性</h3>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">INFO</span>] 开通成功
</code></pre>
<p>这行日志在主线程结束时打印，让人以为一切正常。</p>
<p>实际上，线程池里的任务才刚开始执行。</p>
<h3 data-id="heading-10">Code Review容易被遗漏</h3>
<p>Code Review时，如果不进入<code>wxConfig</code>方法内部看，很难发现是异步的。</p>
<p>而且代码逻辑确实没问题，就是少考虑了异步场景。</p>
<h2 data-id="heading-11">解决方案</h2>
<h3 data-id="heading-12">创建新对象</h3>
<p>最简单的办法：给第二次调用创建一个新对象。</p>
<pre><code class="hljs language-ini" lang="ini">openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
// 创建新对象
OpenMemberV2DTO <span class="hljs-attr">openMemberDTO</span> = BeanUtil.map(openMemberV2DTO, OpenMemberV2DTO.class)<span class="hljs-comment">;</span>
openMemberDTO.setSupAppId(sysConfig.getWxHuikeOfficialAccountAppid())<span class="hljs-comment">;</span>
openMemberDTO.setAccountType("00")<span class="hljs-comment">;</span>
openMemberV2Service.wxConfig(openMemberDTO)<span class="hljs-comment">;</span>
</code></pre>
<p><code>BeanUtil.map</code>会创建一个新对象，复制所有属性。</p>
<p>两次调用传入的是不同的对象引用，互不影响。</p>
<h3 data-id="heading-13">其他方案</h3>
<p><strong>方案1：深拷贝</strong></p>
<pre><code class="hljs language-ini" lang="ini">OpenMemberV2DTO <span class="hljs-attr">newDto</span> = openMemberV2DTO.clone()<span class="hljs-comment">;</span>
</code></pre>
<p>前提是DTO实现了<code>Cloneable</code>接口，并且是深拷贝。</p>
<p><strong>方案2：不可变对象</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建新对象，而不是修改旧对象</span>
OpenMemberV2DTO dto2 = OpenMemberV2DTO<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.supAppId</span>(sysConfig.getWxHuikeOfficialAccountAppid())
    <span class="hljs-selector-class">.accountType</span>("<span class="hljs-number">00</span>")
    <span class="hljs-selector-class">.build</span>();

<span class="hljs-built_in">wxConfig</span>(dto2);
</code></pre>
<p><strong>方案3：异步方法内部拷贝（最推荐）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">wxConfig</span><span class="hljs-params">(OpenMemberV2DTO dto)</span> </span>{
    <span class="hljs-comment">// 进入方法就立即拷贝参数</span>
    OpenMemberV2DTO copyDto = FsBeanUtil.<span class="hljs-built_in">map</span>(dto, OpenMemberV2DTO.<span class="hljs-keyword">class</span>);

    asyncTaskExecutor.<span class="hljs-built_in">execute</span>(() -&gt; {
        <span class="hljs-comment">// 使用拷贝的对象</span>
        <span class="hljs-type">String</span> subAppId = copyDto.<span class="hljs-built_in">getSupAppId</span>();
        <span class="hljs-comment">// ...</span>
    });
}
</code></pre>
<p><strong>为什么推荐这个方案？</strong></p>
<ol>
<li><strong>调用方不用关心是否异步</strong>：封装性好，对外接口简洁</li>
<li><strong>一劳永逸</strong>：修改一次，所有调用方都受益</li>
<li><strong>防御性编程</strong>：在方法内部做好防护，不依赖调用方的正确使用</li>
</ol>
<p>这次修复后，我就是用的这个方案。把拷贝逻辑加到<code>wxConfig</code>方法内部，之后就再也没出过问题。</p>
<h2 data-id="heading-14">总结</h2>
<p>这次事故让我学到了几点。</p>
<h3 data-id="heading-15">1. 异步方法要警惕对象引用</h3>
<p>只要方法是异步的，传入的对象可能在任何时候被修改。</p>
<p>不要假设"调用方不会改"。要么拷贝对象，要么用不可变对象。</p>
<h3 data-id="heading-16">2. Code Review不只看逻辑</h3>
<p>Review代码时，不能只看表面逻辑是否正确。</p>
<p>还要关注：</p>
<ul>
<li>方法是同步还是异步？</li>
<li>对象是共享的还是独立的？</li>
<li>有没有线程安全问题？</li>
</ul>
<h3 data-id="heading-17">3. 线程安全不只是加锁</h3>
<p>很多人提到线程安全，第一反应是加锁。</p>
<p>但这个问题加锁也没用，根本原因是<strong>对象被共享了</strong>。</p>
<p>线程安全的本质：<strong>避免共享可变状态</strong>。</p>
<h3 data-id="heading-18">4. 日志要打印关键参数</h3>
<p>如果一开始没有打印appid，这个问题会更难排查。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 好的日志</span>
LogUtil.info(<span class="hljs-built_in">log</span>, <span class="hljs-string">"wxConfig &gt;&gt; sub_appid = {}, account_type = {}"</span>,
    dto.getSupAppId(), dto.getAccountType());

<span class="hljs-comment">// 不够的日志</span>
LogUtil.info(<span class="hljs-built_in">log</span>, <span class="hljs-string">"wxConfig &gt;&gt; 开始配置"</span>);
</code></pre>
<p>关键参数一定要打印出来。</p>
<h3 data-id="heading-19">5. 排查问题要看方法实现</h3>
<p>这次能快速定位，是因为进入了<code>wxConfig</code>方法内部，看到了<code>asyncTaskExecutor.execute</code>。</p>
<p>如果只看调用代码，永远找不到原因。</p>
<h2 data-id="heading-20">写在最后</h2>
<p><strong>异步方法传参时，注意对象引用问题。如果需要多次调用并修改参数，务必创建新对象。</strong></p>
<p>代码很简单，但容易忽略。大家一起共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案]]></title>    <link>https://juejin.cn/post/7587997893987516443</link>    <guid>https://juejin.cn/post/7587997893987516443</guid>    <pubDate>2025-12-26T11:27:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893987516443" data-draft-id="7587965800272986138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案"/> <!----> <meta itemprop="datePublished" content="2025-12-26T11:27:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="对象存储与RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/652466093570057"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/652466093570057/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    对象存储与RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:27:19.000Z" title="Fri Dec 26 2025 11:27:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案</h2>
<blockquote>
<p>在分布式存储系统的运维中，“看不见问题”往往比问题本身更可怕。本文将带你通过5分钟的实战部署，为RustFS构建一套企业级监控系统，让系统运行状态一目了然。</p>
</blockquote>
<h3 data-id="heading-1">一、为什么RustFS需要专门的监控方案？</h3>
<p>作为高性能分布式对象存储系统，RustFS在运行过程中会产生海量指标数据。传统的日志监控已无法满足需求，主要表现在：</p>
<p>三大监控痛点：<br/>
• 性能瓶颈难定位：无法实时掌握IOPS、延迟等关键指标</p>
<p>• 容量规划靠猜测：存储使用趋势不清晰，扩容时机难把握</p>
<p>• 故障排查效率低：问题发生时缺乏完整链路数据支撑</p>
<p>解决方案对比：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 传统方案：查看日志（低效）</span>
<span class="hljs-built_in">tail</span> -f /var/log/rustfs/server.log | grep <span class="hljs-string">"ERROR"</span>

<span class="hljs-comment"># 现代方案：全景监控（高效）</span>
<span class="hljs-comment"># 指标采集(Prometheus) + 可视化(Grafana) + 告警(Alertmanager)</span>
</code></pre>
<p>接下来，我将分享一套在生产环境验证的5分钟快速部署方案。</p>
<h3 data-id="heading-2">二、环境准备：1分钟搞定基础组件</h3>
<h4 data-id="heading-3">2.1 系统要求检查</h4>
<p>确保你的环境满足以下要求：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Docker环境</span>
docker --version &amp;&amp; docker-compose --version

<span class="hljs-comment"># 检查资源情况</span>
free -h &amp;&amp; <span class="hljs-built_in">df</span> -h

<span class="hljs-comment"># 预期输出示例：</span>
<span class="hljs-comment"># Docker version 20.10.0</span>
<span class="hljs-comment"># 可用内存 ≥ 2GB，磁盘空间 ≥ 5GB</span>
</code></pre>
<p>最低配置：<br/>
• 内存：2GB+</p>
<p>• 磁盘：5GB可用空间</p>
<p>• 网络：可访问Docker Hub</p>
<h4 data-id="heading-4">2.2 一键下载监控套件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目目录</span>
<span class="hljs-built_in">mkdir</span> rustfs-monitoring &amp;&amp; <span class="hljs-built_in">cd</span> rustfs-monitoring

<span class="hljs-comment"># 下载docker-compose配置文件</span>
curl -O https://raw.githubusercontent.com/rustfs/monitoring/main/docker-compose.yml

<span class="hljs-comment"># 下载Prometheus配置</span>
<span class="hljs-built_in">mkdir</span> -p config/prometheus
curl -O https://raw.githubusercontent.com/rustfs/monitoring/main/config/prometheus/prometheus.yml
</code></pre>
<h3 data-id="heading-5">三、核心配置：2分钟完成监控集成</h3>
<h4 data-id="heading-6">3.1 配置RustFS支持指标输出</h4>
<p>修改RustFS配置文件 (<code>rustfs.env</code>)：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用指标采集</span>
RUSTFS_METRICS_ENABLED=<span class="hljs-literal">true</span>
RUSTFS_METRICS_TYPES=511  <span class="hljs-comment"># 采集所有指标类型</span>

<span class="hljs-comment"># OpenTelemetry端点配置</span>
RUSTFS_OTLP_ENDPOINT=http://otel-collector:4317

<span class="hljs-comment"># 指标采集间隔（秒）</span>
RUSTFS_METRICS_INTERVAL=15
</code></pre>
<p>指标类型说明：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// RustFS支持的监控指标枚举</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MetricType</span> {
    DISK = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,      <span class="hljs-comment">// 磁盘指标</span>
    NET = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,       <span class="hljs-comment">// 网络指标  </span>
    MEM = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,       <span class="hljs-comment">// 内存指标</span>
    CPU = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,       <span class="hljs-comment">// CPU指标</span>
    <span class="hljs-comment">// ... 其他指标</span>
    ALL = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>) - <span class="hljs-number">1</span>  <span class="hljs-comment">// 所有指标</span>
}
</code></pre>
<h4 data-id="heading-7">3.2 配置Prometheus数据采集</h4>
<p>编辑Prometheus配置 (<code>prometheus.yml</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'rustfs-metrics'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'otel-collector:8889'</span>]
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">'/metrics'</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">10s</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'node-exporter'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'node-exporter:9100'</span>]

<span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">alertmanagers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'alertmanager:9093'</span>]
</code></pre>
<h4 data-id="heading-8">3.3 配置OpenTelemetry Collector</h4>
<p>创建OTel配置 (<code>otel-collector-config.yaml</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">receivers:</span>
  <span class="hljs-attr">otlp:</span>
    <span class="hljs-attr">protocols:</span>
      <span class="hljs-attr">grpc:</span>
        <span class="hljs-attr">endpoint:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4317</span>

<span class="hljs-attr">exporters:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"0.0.0.0:8889"</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">service:</span>
  <span class="hljs-attr">pipelines:</span>
    <span class="hljs-attr">metrics:</span>
      <span class="hljs-attr">receivers:</span> [<span class="hljs-string">otlp</span>]
      <span class="hljs-attr">exporters:</span> [<span class="hljs-string">prometheus</span>]
</code></pre>
<h3 data-id="heading-9">四、一键部署：1分钟启动所有服务</h3>
<h4 data-id="heading-10">4.1 编写Docker Compose文件</h4>
<p>完整的<code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"9090:9090"</span>]
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prometheus:/etc/prometheus</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">--web.enable-lifecycle</span>

  <span class="hljs-attr">grafana:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"3000:3000"</span>]
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">GF_SECURITY_ADMIN_PASSWORD=admin123</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">grafana_data:/var/lib/grafana</span>

  <span class="hljs-attr">otel-collector:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">otel/opentelemetry-collector:0.130.0</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./otel-collector-config.yaml:/etc/otelcol/config.yaml</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"4317:4317"</span>]

  <span class="hljs-attr">node-exporter:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/node-exporter:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"9100:9100"</span>]

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">grafana_data:</span>
</code></pre>
<h4 data-id="heading-11">4.2 启动监控栈</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键启动所有服务</span>
docker-compose up -d

<span class="hljs-comment"># 检查服务状态</span>
docker-compose ps

<span class="hljs-comment"># 预期输出：</span>
<span class="hljs-comment"># NAME                STATUS              PORTS</span>
<span class="hljs-comment"># prometheus          Up 5 minutes        0.0.0.0:9090-&gt;9090/tcp</span>
<span class="hljs-comment"># grafana            Up 5 minutes        0.0.0.0:3000-&gt;3000/tcp</span>
<span class="hljs-comment"># otel-collector     Up 5 minutes        0.0.0.0:4317-&gt;4317/tcp</span>
</code></pre>
<h3 data-id="heading-12">五、配置可视化：1分钟完成Grafana仪表板</h3>
<h4 data-id="heading-13">5.1 添加数据源</h4>
<ol>
<li>
<p>访问Grafana：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a></p>
</li>
<li>
<p>登录：用户名<code>admin</code>​，密码<code>admin123</code></p>
</li>
<li>
<p>添加Prometheus数据源：<br/>
• 点击Configuration → Data Sources → Add data source</p>
<p>• 选择Prometheus类型</p>
<p>• URL填写：<code>http://prometheus:9090</code></p>
<p>• 点击Save &amp; Test验证连接</p>
</li>
</ol>
<h4 data-id="heading-14">5.2 导入预置仪表板</h4>
<p>使用官方仪表板模板：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取仪表板ID列表</span>
<span class="hljs-comment"># 存储性能仪表板：ID 1324</span>
<span class="hljs-comment"># 系统资源仪表板：ID 1325  </span>
<span class="hljs-comment"># 业务指标仪表板：ID 1326</span>
</code></pre>
<p>导入步骤：</p>
<ol>
<li>点击+ → Import</li>
<li>输入仪表板ID：<code>1324</code></li>
<li>选择Prometheus数据源</li>
<li>点击Import完成</li>
</ol>
<h4 data-id="heading-15">5.3 关键监控指标解读</h4>
<p>核心监控指标清单：</p>
<pre><code class="hljs language-promql" lang="promql"># 存储容量使用率
sum(rustfs_disk_used_bytes) by (instance) / sum(rustfs_disk_total_bytes) by (instance) * 100

# 请求延迟(P95)
histogram_quantile(0.95, sum(rate(rustfs_request_duration_seconds_bucket[5m])) by (le))

# 吞吐量监控
rate(rustfs_throughput_bytes_total[5m])

# 错误率监控
rate(rustfs_request_errors_total[5m]) / rate(rustfs_requests_total[5m]) * 100
</code></pre>
<h3 data-id="heading-16">六、实战效果：真实监控数据展示</h3>
<h4 data-id="heading-17">6.1 性能提升对比</h4>
<p>监控系统部署前后对比：</p>



































<table><thead><tr><th>监控能力</th><th>部署前</th><th>部署后</th><th>提升效果</th></tr></thead><tbody><tr><td>问题发现时间</td><td>小时级</td><td>分钟级</td><td>20倍提速</td></tr><tr><td>性能分析深度</td><td>基础指标</td><td>全链路追踪</td><td>300%更深入</td></tr><tr><td>容量规划</td><td>经验猜测</td><td>数据驱动</td><td>准确率提升80%</td></tr><tr><td>故障恢复</td><td>手动排查</td><td>自动定位</td><td>恢复时间减少70%</td></tr></tbody></table>
<h4 data-id="heading-18">6.2 关键监控界面预览</h4>
<p>仪表板核心组件：</p>
<ol>
<li>集群概览：节点状态、存储容量、请求总量</li>
<li>性能分析：P50/P95/P99延迟、吞吐量趋势</li>
<li>资源监控：CPU、内存、磁盘、网络使用率</li>
<li>业务指标：S3操作统计、错误率、缓存命中率</li>
</ol>
<h3 data-id="heading-19">七、高级功能：告警配置与优化</h3>
<h4 data-id="heading-20">7.1 关键告警规则配置</h4>
<p>创建告警规则 (<code>alert.rules</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rustfs_alerts</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighDiskUsage</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">rustfs_disk_used_percent</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">85</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"磁盘使用率过高 (实例 <span class="hljs-template-variable">{{ $labels.instance }}</span>)"</span>
      
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">APIErrorRateHigh</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(rustfs_request_errors_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">rate(rustfs_requests_total[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0.05</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
</code></pre>
<h4 data-id="heading-21">7.2 告警通知集成</h4>
<p>配置邮件通知：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># alertmanager.yml</span>
<span class="hljs-attr">route:</span>
  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">'alertname'</span>]
  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">10s</span>
  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">1h</span>
  <span class="hljs-attr">receiver:</span> <span class="hljs-string">'email-notifications'</span>

<span class="hljs-attr">receivers:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">'email-notifications'</span>
  <span class="hljs-attr">email_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">'team@company.com'</span>
    <span class="hljs-attr">from:</span> <span class="hljs-string">'alertmanager@company.com'</span>
    <span class="hljs-attr">smarthost:</span> <span class="hljs-string">'smtp.company.com:587'</span>
    <span class="hljs-attr">auth_username:</span> <span class="hljs-string">'alertmanager'</span>
    <span class="hljs-attr">auth_password:</span> <span class="hljs-string">'password'</span>
</code></pre>
<h3 data-id="heading-22">八、常见问题与解决方案</h3>
<h4 data-id="heading-23">8.1 部署问题排查</h4>
<p>问题1：Prometheus无法采集数据</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查目标状态</span>
curl http://localhost:9090/api/v1/targets

<span class="hljs-comment"># 检查指标端点</span>
curl http://otel-collector:8889/metrics
</code></pre>
<p>问题2：Grafana无法连接数据源</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查网络连通性</span>
docker-compose <span class="hljs-built_in">exec</span> grafana ping prometheus

<span class="hljs-comment"># 检查防火墙规则</span>
iptables -L | grep 9090
</code></pre>
<h4 data-id="heading-24">8.2 性能优化建议</h4>
<p>大规模集群优化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 调整Prometheus配置</span>
<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">tsdb:</span>
    <span class="hljs-attr">retention:</span> <span class="hljs-string">15d</span>  <span class="hljs-comment"># 数据保留时间</span>
    <span class="hljs-attr">max_block_size:</span> <span class="hljs-string">2h</span>

<span class="hljs-comment"># 优化采集频率</span>
<span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">30s</span>  <span class="hljs-comment"># 生产环境建议值</span>
</code></pre>
<h3 data-id="heading-25">九、生产环境实践建议</h3>
<h4 data-id="heading-26">9.1 监控策略规划</h4>
<p>根据业务重要性分级监控：</p>





























<table><thead><tr><th>监控级别</th><th>采集间隔</th><th>保留时间</th><th>告警响应</th></tr></thead><tbody><tr><td>关键业务</td><td>15秒</td><td>30天</td><td>5分钟</td></tr><tr><td>重要业务</td><td>30秒</td><td>15天</td><td>15分钟</td></tr><tr><td>一般业务</td><td>60秒</td><td>7天</td><td>30分钟</td></tr></tbody></table>
<h4 data-id="heading-27">9.2 容量规划指南</h4>
<p>资源需求估算：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每日指标数据量估算</span>
指标数量 × 采集频率 × 保存天数 × 字节数/指标
1000指标 × 2880次/天 × 30天 × 2KB ≈ 172GB/月
</code></pre>
<h3 data-id="heading-28">十、总结与下一步</h3>
<p>通过本文的5分钟实战，你已经成功搭建了完整的RustFS监控体系。这套方案的优势在于：</p>
<p>✅ 开箱即用：一键部署，无需复杂配置<br/>
✅ 全面监控：覆盖性能、资源、业务全维度<br/>
✅ 生产就绪：经过真实环境验证，稳定可靠<br/>
✅ 可扩展：支持水平扩展，满足增长需求</p>
<hr/>
<p>以下是深入学习 RustFS 的推荐资源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">RustFS</a></p>
<p>官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">RustFS 官方文档</a>- 提供架构、安装指南和 API 参考。</p>
<p>GitHub 仓库： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">GitHub 仓库</a> - 获取源代码、提交问题或贡献代码。</p>
<p>社区支持： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Forgs%2Frustfs%2Fdiscussions" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/orgs/rustfs/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a>- 与开发者交流经验和解决方案。</p>
<p>‍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥MySQL的大表优化方案 (实战分享)]]></title>    <link>https://juejin.cn/post/7588086766235254822</link>    <guid>https://juejin.cn/post/7588086766235254822</guid>    <pubDate>2025-12-26T11:50:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235254822" data-draft-id="7587903505136402482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥MySQL的大表优化方案 (实战分享)"/> <meta itemprop="keywords" content="Java,MySQL,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T11:50:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_sunshine"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287338653"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥MySQL的大表优化方案 (实战分享)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287338653/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_sunshine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:50:48.000Z" title="Fri Dec 26 2025 11:50:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94e5fd4c7d0b44dfaef178e7304522ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=2NwcGpRz36cjWCpCKGFWLHce9jI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、MySQL大表的标准和定义</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04edfb70baf342f4986144b8ce9a824b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=C6TkQ%2BWSS5bqfPws0TC2F45GE2c%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>数据量维度</strong>：单表行数超过1000万行，或单表占用空间超过100GB（不同业务场景下阈值差异较大，如高并发业务中500万行可能就成为大表）；</li>
<li><strong>并发场景性能维度</strong>：查询耗时稳定超过500ms，更新/删除操作出现锁等待，索引维护（创建、删除、重建）耗时过长（超过1小时）；</li>
</ul>
<h2 data-id="heading-1">二、分片原则和优化方案选择和建议</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405abd147780451496a4b1c9ffbb0c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=I%2FFlobgHviOAlmaP8ofrpKJxS98%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">分片原则</h3>
<p>(1) 能不分就不分，做“单表优化”；</p>
<p>(2) 分片数量尽量少，分片尽量均匀分布在多个数据结点上，因为一个查询SQL跨分片越多，则总体性能越差，虽然要好于所有数据在一个分片的结果，只在必要的时候进行扩容，增加分片数量；</p>
<p>(3) 分片规则需要慎重选择做好提前规划，分片规则的选择，需要考虑数据的增长模式，数据的访问模式，分片关联性问题，以及分片扩容问题，最近的分片策略为范围分片，枚举分片，一致性Hash分片，这几种分片都有利于扩容；</p>
<p>(4) 尽量不要在一个事务中的SQL跨越多个分片，分布式事务一直是个不好处理的问题；</p>
<p>(5) 可以通过数据冗余和表分区赖降低跨库Join的可能。</p>
<h3 data-id="heading-3">优化方案选择和建议</h3>
<p>不同业务场景、不同数据量规模下，应选择不同的优化方案，避免盲目采用架构级优化（如分库分表）增加系统复杂度，分库分表的实施建议：</p>
<ul>
<li><strong>数据量 &lt; 1000万</strong>：优先采用“查询优化+索引优化+表结构优化”的低成本方案。检查并优化慢查询语句，调整索引设计，规范表结构，通常能满足性能需求；</li>
<li><strong>1000万 ≤ 数据量 ≤ 1亿</strong>：采用“数据归档+分区表”方案。将历史数据归档，减少活跃数据量；通过分区表拆分数据，提升查询和写入效率；若为读多写少场景，可搭配读写分离；</li>
<li><strong>数据量 ≥ 1亿或者并发极高</strong>：采用“分库分表”架构级方案。结合业务场景选择合适的分片键和拆分策略，使用中间件简化实现；同时搭配数据归档、读写分离、缓存等方案，全方位提升系统性能和可用性。</li>
</ul>
<h2 data-id="heading-4">三、大表优化核心思路</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b55c19e2d19458394b62c22bd45888f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=6wrkrg6uEw3UZbEpwqNSJrfN560%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>表设计层</strong>：从源头减少数据冗余，合理设计表结构和索引，避免数据过度堆积；</li>
<li><strong>查询与索引层</strong>：提升查询效率，减少无效数据扫描，降低索引维护成本；</li>
<li><strong>架构和运维层</strong>：通过分库分表、读写分离、数据归档等方式，分散单表压力，提升系统并发能力。</li>
</ul>
<h2 data-id="heading-5">四、表设计字段优化 (从源头上避免大表问题)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d136aa98af10476dac5c56ea277ffd40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=RqwvRi31DwllPv8f9WooEHzAHIU%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>优先使用占用空间小的字段类型。例如，存储用户ID时，若范围允许，使用INT（4字节）而非BIGINT（8字节）；</li>
<li>存储状态、性别时，使用TINYINT（1字节）而非VARCHAR；</li>
<li>使用整数或枚举代替字符串类型；</li>
<li>尽量使用多时区 / 全球化的TIMESTAMP（4字节）而非DATETIME（8字节），同时TIMESTAMP具有自动赋值以及⾃自动更新的特性；</li>
<li>单表不要有太多字段，建议在30个以内；</li>
<li>避免使用NULL字段，对于非必填字段，设置合理的默认值，避免大量NULL值存储。MySQL对NULL值的存储和查询效率较低，且NULL值无法参与索引；</li>
<li>避免使用大字段，尽量避免在核心业务表中使用TEXT、BLOB等大字段。若必须存储（如用户头像、富文本内容），可将大字段拆分到单独的附属表中，核心表仅存储关联ID，减少核心表的数据行大小，提升查询时的磁盘I/O效率；</li>
</ol>
<h2 data-id="heading-6">五、索引优化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0afbc83784fa4cb9b4cd86326ea2994e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=tKrWxHbLXcGw1X34BxxXwvcTeec%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li><strong>遵循最左匹配原则</strong>，创建联合索引时，将查询频率高、区分度高的字段放在前面。例如，业务中频繁查询“用户ID+订单状态”，则联合索引应为（user_id, order_status），而非（order_status, user_id）；</li>
<li><strong>控制索引数量</strong>，单表索引数量建议不超过5个，过多的索引会导致INSERT、UPDATE、DELETE操作时需要同步维护多个索引，严重降低写入性能。对于大表，每增加一个索引，写入耗时可能会显著增加；</li>
<li><strong>使用覆盖索引</strong>，针对频繁的查询场景，创建覆盖索引，避免回表查询。例如，查询“用户ID、订单金额、订单时间”时，创建联合索引（user_id, order_amount, order_time），查询时可直接从索引中获取所需数据，无需访问主键索引；</li>
<li><strong>避免无效索引</strong>，删除未使用或重复的索引。可通过MySQL的慢查询日志、sys.schema_unused_indexes视图（MySQL 8.0+）统计索引使用情况，清理无效索引；避免创建与主键索引重复的索引（如主键为id，再创建索引（id））；</li>
<li><strong>考虑分区索引</strong>，对于分区表，索引会按分区创建，每个分区的索引体积更小，查询时只需扫描对应分区的索引，提升查询效率。</li>
<li><strong>避免没必要索引</strong>，值分布很稀少的字段不适合建索引，例如"性别"这种只有两三个值的字段；</li>
<li><strong>合理创建联合索引（避免冗余</strong>），如(a,b,c) 相当于 (a) 、(a,b) 、(a,b,c)；</li>
<li><strong>根据查询有针对性创建索引</strong>，考虑在WHERE和ORDER BY命令上涉及的列建立索引，可根据EXPLAIN来查看是否用了索引还是全表扫描；</li>
</ol>
<h2 data-id="heading-7">六、查询SQL优化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d605d3311d5405c9e0d2b4f4d0af175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=%2FpU9I61Lui847swqvXbTKZqAjmI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">①避免全表扫描</h3>
<ul>
<li><strong>确保查询走索引</strong>：避免在查询条件中对索引字段进行函数操作（如SUBSTR、DATE_FORMAT）、隐式类型转换（如将VARCHAR类型的字段与INT值比较），这些操作会导致索引失效，触发全表扫描。例如，避免“WHERE SUBSTR(user_phone, 1, 3) = '138'”，可改为“WHERE user_phone LIKE '138%'”（前提是user_phone字段有索引）；</li>
<li>**避免使用模糊查询前缀%：<strong>模糊查询“LIKE '%xxx'”或“LIKE '%xxx%'”会导致索引失效，触发全表扫描。若业务需模糊查询，可考虑使</strong>用Elasticsearch等搜索引擎替代，或通过业务调整改为“LIKE 'xxx%'”；</li>
<li>**避免使用OR条件（无索引时）：当OR条件中的字段无索引时，会触发全表扫描。可将OR改为UNION ALL（若结果无重复），且确保每个查询分支都走索引。例如，“WHERE user_id = 1 OR order_id = 100”可改为“(SELECT * FROM order WHERE user_id = 1) UNION ALL (SELECT * FROM order WHERE order_id = 100)”。</li>
</ul>
<h3 data-id="heading-9">②优化查询语句结构</h3>
<ul>
<li><strong>只查询所需字段</strong>：避免使用SELECT *，只查询业务需要的字段。一方面减少数据传输量，另一方面若查询字段可通过覆盖索引获取，可避免回</li>
<li><strong>控制JOIN表数量</strong>：JOIN表数量越多，查询复杂度越高，性能越差。大表查询中，JOIN表数量建议不超过3个。对于复杂查询，可通过分步骤查询、中间表存储结果等方式简化；</li>
<li><strong>避免使用子查询（尤其是相关子查询）</strong>：相关子查询会导致MySQL重复执行子查询语句，效率极低。可将子查询改为JOIN查询，或通过临时表存储子查询结果；</li>
<li><strong>合理使用LIMIT</strong>：对于分页查询，使用LIMIT控制返回结果数量。但需注意，当分页页码较大时（如LIMIT 100000, 20），MySQL会扫描前100020条数据再丢弃前100000条，效率较低。可通过“索引+主键”优化，例如“WHERE id &gt; 100000 LIMIT 20”（前提是id为自增主键，且查询条件可基于id过滤）。</li>
</ul>
<h3 data-id="heading-10">③优化事务和锁</h3>
<ul>
<li><strong>控制事务粒度</strong>：避免长事务，长事务会占用锁资源，导致其他操作出现锁等待。大表操作中，尽量将事务拆分为短事务，只包含必要的SQL语句；</li>
<li><strong>使用合理的隔离级别</strong>：根据业务需求选择最低的隔离级别。例如，若业务允许脏读，可使用READ UNCOMMITTED；大多数业务可使用READ COMMITTED，避免REPEATABLE READ带来的间隙锁问题，减少锁等待；</li>
<li><strong>避免行锁升级为表锁</strong>：MySQL中，若查询条件未走索引，会触发全表扫描，此时行锁会升级为表锁，导致其他操作无法并发执行。需确保更新、删除操作的查询条件走索引，避免表锁。</li>
</ul>
<h3 data-id="heading-11">④其他</h3>
<ul>
<li>不做列运算：SELECT id WHERE age + 1 = 10，任何对列的操作都将导致表扫描，它包括数据库教程函数、计算表达式等等，查询时要尽可能将操作移至等号右边；</li>
<li>SQL语句尽可能简单：一条SQL只能在一个cpu运算；大语句拆小语句，减少锁时间；一条大SQL可以堵死整个库；</li>
<li>OR改写成IN：OR的效率是n级别，IN的效率是log(n)级别，in的个数建议控制在200以内；</li>
<li>不用函数和触发器，在应用程序实现；</li>
<li>模糊查询避免左模糊%xxx式查询；</li>
<li>使用同类型进行比较，比如用'123'和'123'比，123和123比；</li>
<li>尽量避免在WHERE子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描；</li>
<li>对于连续数值，使用BETWEEN不用IN：SELECT id FROM t WHERE num BETWEEN 1 AND 5；</li>
<li>列表数据不要拿全表，要使用LIMIT来分页，每页数量也不要太大。</li>
</ul>
<h2 data-id="heading-12">七、数据归档(减少活跃数据量)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c2e99d0edb402c89f89e19c933feca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=aSWXigt4xEoEE8PvJ4axdZHfWTE%3D" alt="image.png" loading="lazy"/></p>
<p>数据归档是将历史数据迁移到单独的存储介质或表中，减少核心表的活跃数据量。 大表中往往存在大量历史数据（如3个月前的订单、1年前的日志），这些数据访问频率极低，但占用大量存储空间，影响活跃数据的查询和写入性能。</p>
<ul>
<li>
<p>确定归档条件：根据业务场景确定归档的时间范围或数据状态。例如，订单表中归档3个月前的已完成订单；日志表中归档1年前的所有日志；</p>
</li>
<li>
<p><strong>选择归档目标</strong></p>
<ul>
<li>同库不同表：将历史数据迁移到同库的归档表中（如order表归档到order_hist_202401），便于后续查询历史数据时直接关联；</li>
<li>异库存储：将历史数据迁移到独立的归档数据库（如MySQL从库、Hive、ClickHouse等），减少对核心库的资源占用；对于海量历史数据，可使用低成本的存储介质（如对象存储）；</li>
<li>冷热数据分离：核心表只保留热点数据（如近1个月），历史数据迁移到冷存储，查询历史数据时通过专门的服务或接口访问。</li>
</ul>
</li>
<li>
<p><strong>归档执行方式</strong></p>
<ul>
<li>定时任务归档：通过xxljob、crontab、Airflow等工具定时执行归档脚本，采用“分页查询+批量插入+批量删除”的方式，避免一次性操作大量数据导致锁等待或事务超时；</li>
<li>在线归档工具：使用pt-archiver（Percona Toolkit）等专业工具，支持增量归档、并行归档，且对业务影响较小。例如，pt-archiver可通过--limit参数控制每次归档的行数，--sleep参数控制归档间隔，减少对核心表的性能影响；</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">八、分区表设计 （拆分数据到多个物理分区）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842fb4a2a8f548d78a5514c502f356ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=4pCeYmxE3raYMUCwJWkCHj6xDYw%3D" alt="image.png" loading="lazy"/></p>
<p>分区表是MySQL提供的一种表级优化方案，将一个大表在逻辑上拆分为多个小表，物理上存储为多个独立的文件。查询时，MySQL只需扫描对应的分区，无需扫描全表，从而提升查询效率；同时，分区表便于数据归档（直接删除整个分区）、备份恢复（单独备份某个分区）。</p>
<ul>
<li>
<p><strong>分区类型选择</strong></p>
<ul>
<li>MySQL支持多种分区类型，需根据业务场景选择：
<ul>
<li>范围分区（RANGE Partition）：按连续的范围划分分区，适用于按时间、ID等有序字段拆分的场景（如订单表、日志表）。例如，订单表按创建时间分区，每个分区存储1个月的数据；用户表按用户ID分区，每个分区存储100万用户的数据。范围分区是最常用的分区类型，便于数据归档（直接删除旧分区）；</li>
<li>列表分区（List Partition）：按离散的值列表划分分区，适用于数据状态固定的场景（如订单状态、用户所属地区）。例如，订单表按订单状态分区，分为“待支付”“已完成”“已取消”三个分区， 核销表可以按核销状态分区，分为“未核销”、“已核销”、“已退款”；</li>
<li>哈希分区（Hash Partition）：按字段的哈希值划分分区，适用于数据均匀分布、无明显范围或列表特征的场景。例如，将用户表按用户ID哈希分区，确保每个分区的数据量相对均衡；但哈希分区不便于数据归档；</li>
<li>复合分布（Composite Partition）：结合两种分区类型（如RANGE-HASH、RANGE-LIST），适用于复杂场景。例如，订单表先按创建时间范围分区，每个范围分区内再按订单状态列表分区。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>分区表使用注意事项</strong></p>
<ul>
<li>分区键选择：分区键需与查询条件高度相关，确保查询时能精准定位到少数几个分区（即“分区裁剪”）。例如，若订单表的查询多基于创建时间，则分区键选择创建时间；若查询多基于用户ID，则分区键选择用户ID；</li>
<li>控制分区数量：分区数量并非越多越好，过多的分区会增加MySQL的元数据管理成本，导致查询时分区裁剪效率下降。一般建议单表分区数量不超过100个；</li>
<li>避免跨分区查询：跨分区查询（如查询多个分区的数据）会导致MySQL扫描多个分区，性能可能与非分区表相当甚至更差。需通过业务优化避免跨分区查询，或通过索引优化提升跨分区查询效率；</li>
<li>分区表限制：MySQL 5.7及以下版本中，分区表不支持外键；某些存储引擎（如MyISAM）对分区表的支持有限，建议使用InnoDB引擎；分区表的索引是按分区创建的，需确保每个分区的索引设计合理。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-14">九、分库分表 (架构级拆分突破单库单表限制)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f93e09c6261f440cb107a7cd5cf42968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=Xmr9Vg8C5JYPppyoOE2md5X36TE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>核心概念</strong></p>
<ul>
<li>水平拆分：将同一个表的数据按行拆分到多个表中，每个表的结构相同。例如，将订单表按用户ID哈希拆分到10个表中，每个表存储10%的用户订单数据。水平拆分是分库分表的主流方式，能有效突破单表数据量限制；</li>
<li>垂直拆分：将同一个表的数据按列拆分到多个表中，每个表存储部分字段。例如，将用户表拆分为用户基本信息表（存储ID、姓名、手机号等核心字段）和用户详情表（存储地址、简介等大字段），核心表数据量小，查询效率高；</li>
<li>分库：将拆分后的表分布到多个数据库中，避免单库的CPU、内存、磁盘I/O资源瓶颈。例如，将10个订单分表分布到2个数据库中，每个数据库存储5个分表；</li>
<li>分片键：用于拆分数据的字段（如用户ID、订单ID、创建时间），分片键的选择直接影响分库分表的效果，需确保数据均匀分布、查询能精准定位分片。</li>
</ul>
</li>
<li>
<p><strong>分库分表策略</strong></p>
</li>
<li>
<p>水平拆分</p>
<ul>
<li>范围拆分：按分片键的范围拆分数据，如按订单创建时间拆分，每个分片存储1个月的数据；按用户ID拆分，每个分片存储100万用户的数据。范围拆分便于数据归档（直接删除旧分片），但可能出现数据热点（如最新月份的订单分片访问频率极高）；</li>
<li>哈希拆分：按分片键的哈希值取模拆分数据，如按用户ID % 10拆分到10个分片。哈希拆分能确保数据均匀分布，避免热点分片，但不便于数据归档，查询历史数据时可能需要访问多个分片；</li>
<li>一致性哈希拆分：在哈希拆分的基础上，通过一致性哈希算法减少分片扩容时的数据迁移量。适用于业务数据量持续增长、需要频繁扩容的场景。</li>
</ul>
</li>
<li>
<p>垂直拆分</p>
<ul>
<li>按字段访问频率拆分：将高频访问的核心字段（如用户ID、姓名、订单金额）放在主表，低频访问的字段（如用户简介、订单备注）放在从表；</li>
<li>按字段类型拆分：将大字段（TEXT、BLOB）拆分到单独的表中，主表仅存储关联ID，减少主表的数据行大小，提升查询效率。</li>
</ul>
</li>
<li>
<p><strong>分库分表实现方式</strong></p>
<ul>
<li>
<p>客户端分片</p>
<ul>
<li>在应用程序中直接实现分库分表逻辑，通过代码控制数据的写入和查询分片。优点是灵活性高，缺点是开发成本高，需维护大量分片逻辑代码，后续扩容、迁移困难；</li>
</ul>
</li>
<li>
<p>中间件分片</p>
<ul>
<li>使用专业的分库分表中间件（如Sharding-JDBC、MyCat、TDSQL），中间件封装了分片逻辑，应用程序通过中间件访问数据库，无需关注分片细节。优点是开发成本低、易于维护和扩容，是目前主流的实现方式。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>如何保证分布式数据库架构中全局唯一ID的生成</strong>？</p>
<ul>
<li>
<p>分布式ID生成的要求和核心难点</p>
<ul>
<li>(1) 全局唯一性：保持生成的ID全局唯一，在任何情况下也不会出现重复的值（如防止时间回拔，时钟周期问题）；</li>
<li>(2) 趋势递增：保证下一个ID一定大于上一个ID，例如事务版本号、IM聊天中的增量消息、排序等特殊需求；</li>
<li>(3) 高性能：ID的需求场景多，中心化生成组件后，需要高并发处理，以接近 0ms的响应大规模并发执行；</li>
<li>(4) 高可用： 作为ID的生产源头，需要100%可用，当接入的业务系统多的时候，很难调整出各方都可接受的停机发布窗口，只能接受无损发布；</li>
<li>(5) 易接入：作为逻辑上简单的分布式ID要推广使用，必须强调开箱即用，容易上手；</li>
</ul>
</li>
<li>
<p>大厂自研分布式ID框架实现</p>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2751-1-1.html" target="_blank" title="http://www.52im.net/thread-2751-1-1.html" ref="nofollow noopener noreferrer">美团分布式ID生成系统Leaf(对Snowflake算法进行了改进)</a>
<ul>
<li>Leaf-segment方案：可生成全局唯一、全局有序的ID</li>
<li>Leaf-snowflake方案：可生成全局唯一、局部有序的ID</li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2953-1-1.html" target="_blank" title="http://www.52im.net/thread-2953-1-1.html" ref="nofollow noopener noreferrer">百度分布式ID生成器UidGenerator(对Snowflake算法进行了改进)</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3129-1-1.html" target="_blank" title="http://www.52im.net/thread-3129-1-1.html" ref="nofollow noopener noreferrer">滴滴的高性能ID生成器(Tinyid)</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4378-1-1.html" target="_blank" title="http://www.52im.net/thread-4378-1-1.html" ref="nofollow noopener noreferrer">vivo的自研分布式ID服务</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>各大框架对比</strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e1593155ab42d7bda83a9295eeea18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=h9h72Zd7HRjUj%2FBItt0B522HlM0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<hr/>
<ul>
<li>分片键选择至关重要：分片键需满足“数据均匀分布”和“查询精准定位”两个核心要求。例如，订单表若按订单ID哈希拆分，查询“某用户的所有订单”时会需要访问所有分片，效率极低；此时应选择用户ID作为分片键，查询时可直接定位到用户所属的分片；</li>
<li>避免分布式事务：分库分表后，跨分片的操作会产生分布式事务，分布式事务实现复杂、性能差。需通过业务优化避免跨分片操作，或采用最终一致性方案（如本地消息表、事务消息）替代分布式事务；</li>
<li>考虑扩容方案：拆分时需预留扩容空间，避免后续扩容时大量数据迁移。例如，采用一致性哈希拆分，或按“2的幂次”拆分（如初始拆分为8个分片，后续可扩容为16个）；</li>
<li>运维复杂度提升：分库分表后，数据库集群的运维难度显著增加，需关注分片的健康状态、数据一致性、备份恢复等问题。可借助中间件的监控功能，或使用专业的运维工具（如Prometheus、Grafana）进行监控。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-15">十、其他优化方案</h2>
<ul>
<li>
<p><strong>读写分离</strong></p>
<ul>
<li>对于读多写少的大表场景（如商品表、用户表），可采用读写分离架构：主库负责写入操作（INSERT、UPDATE、DELETE），从库负责读取操作（SELECT），通过主从复制同步数据。读写分离能分散单库的读写压力，提升查询性能，需注意主从复制的延迟问题，对于实时性要求高的查询，需路由到主库。</li>
</ul>
</li>
<li>
<p><strong>数据库参数优化(通过优化MySQ的配置参数，提升数据库性能)</strong></p>
<ul>
<li>调整缓冲池大小（innodb_buffer_pool_size）：建议设置为服务器物理内存的50%-70%，提升数据和索引的缓存命中率；</li>
<li>调整日志相关参数（innodb_log_file_size、innodb_log_buffer_size）：增大日志文件大小，减少日志刷盘次数；增大日志缓冲区，减少磁盘I/O；</li>
<li>调整连接数参数（max_connections、wait_timeout）：根据业务需求设置合理的最大连接数，避免连接耗尽；设置合理的连接超时时间，释放空闲连接；</li>
</ul>
</li>
<li>
<p><strong>硬件与存储优化，硬件和存储是数据库性能的基础，大表场景下需选择高性能的硬件</strong></p>
<ul>
<li>使用SSD硬盘：SSD的读写速度远高于机械硬盘，能显著提升大表的磁盘I/O效率；</li>
<li>提升CPU和内存配置：大表查询和索引维护需要大量CPU和内存资源，选择多核CPU、大容量内存的服务器；</li>
<li>使用RAID阵列：通过RAID 0、RAID 10等阵列方式，提升磁盘的读写性能和可靠性。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-16">十一、总结</h2>
<p>MySQL大表优化是一个系统性工程，需从表设计、查询、索引、数据归档、分区表、分库分表等多个维度综合考量，核心是“减少数据量、降低访问成本、分散压力”。优化过程中应遵循“先易后难、先软后硬”的原则，优先采用低成本、低风险的方案，再根据业务需求逐步升级到架构级优化。大厂的实战案例表明，优化方案需紧密结合业务场景：电商订单表适合分库分表+数据归档，日志表适合分区表+冷热分离，商品表适合垂直拆分+读写分离+缓存。同时，优化后的监控与运维至关重要，能确保系统长期稳定运行。好了，今天的分享就到此结束了，如果文章对你有所帮助，欢迎：<em><strong>点赞👍+评论💬+收藏❤</strong></em>，我是：<strong><code>IT_sunshine</code></strong> ，我们下期见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）]]></title>    <link>https://juejin.cn/post/7588086766235271206</link>    <guid>https://juejin.cn/post/7588086766235271206</guid>    <pubDate>2025-12-26T12:08:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235271206" data-draft-id="7587997893987549211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-26T12:08:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:08:15.000Z" title="Fri Dec 26 2025 12:08:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在企业级系统开发中，“数据一致性” 是核心诉求 —— 比如员工入职时，“新增员工记录” 和 “更新部门人数” 这两个操作必须同时成功或同时失败；再比如财务转账时，“扣款” 和 “收款” 也不能只执行其一。而保证这种 “要么全成、要么全败” 的核心技术，就是<strong>数据库事务（Transaction）</strong> 。本文将以 “部门 - 员工” 这一经典业务场景为核心，从事务的核心价值、ACID 特性、隔离级别，到 JDBC/MyBatis/Spring 中的实战落地，帮你彻底掌握事务的使用与优化。</p>
<h2 data-id="heading-0">一、事务的核心价值：为什么离不开事务？</h2>
<p>先看一个典型的业务场景：</p>
<blockquote>
<p>企业招聘新员工 “钱八” 入职研发部，需要执行两个操作：</p>
<ol>
<li>向<code>emp</code>表插入 “钱八” 的员工记录；</li>
<li>向<code>dept</code>表更新研发部的员工数量（<code>emp_count</code>字段），加 1。</li>
</ol>
</blockquote>
<p>如果没有事务控制，可能出现两种异常：</p>
<ul>
<li>场景 1：插入员工记录成功，但更新部门人数失败 → 研发部人数少算 1 人，数据不一致；</li>
<li>场景 2：更新部门人数成功，但插入员工记录失败 → 研发部人数多算 1 人，数据错误。</li>
</ul>
<p>而事务的核心作用，就是<strong>将一组操作封装为一个 “不可分割的执行单元”</strong> ，确保单元内的所有操作要么全部执行成功，要么全部回滚（撤销），从根本上避免数据不一致问题。</p>
<h2 data-id="heading-1">二、事务的核心特性：ACID 原则</h2>
<p>事务的本质是遵循<strong>ACID 四大特性</strong>的一组数据库操作，这是事务的核心定义，我们结合 “部门 - 员工” 场景逐一拆解：</p>



































<table><thead><tr><th>特性</th><th>英文全称</th><th>核心定义</th><th>部门 - 员工场景示例</th></tr></thead><tbody><tr><td>原子性（A）</td><td>Atomicity</td><td>事务中的操作要么全部执行成功，要么全部回滚，不存在 “部分成功”</td><td>入职操作：插入员工 + 更新部门人数，要么都成，要么都回滚（比如员工姓名重复导致插入失败，部门人数也不更新）</td></tr><tr><td>一致性（C）</td><td>Consistency</td><td>事务执行前后，数据库的 “业务规则” 保持一致（如部门人数 = 该部门员工数）</td><td>执行前研发部人数是 2，执行后必须是 3（成功）或仍为 2（失败），不会出现 “员工新增但人数不变” 的不一致</td></tr><tr><td>隔离性（I）</td><td>Isolation</td><td>多个事务并发执行时，彼此隔离、互不干扰，避免并发导致的数据错误</td><td>管理员 A 新增员工、管理员 B 统计部门人数，两个事务并发执行时，B 不会读到 A “未提交的中间数据”</td></tr><tr><td>持久性（D）</td><td>Durability</td><td>事务提交后，修改会永久保存到数据库，即使数据库崩溃也不会丢失</td><td>入职操作提交后，“钱八” 的员工记录和研发部人数的修改会永久保存，重启数据库后数据仍有效</td></tr></tbody></table>
<p><strong>关键说明</strong>：ACID 是事务的 “契约”，其中<strong>原子性、一致性、持久性</strong>由数据库的 “重做日志（Redo Log）” 和 “回滚日志（Undo Log）” 保证，<strong>隔离性</strong>由事务隔离级别和锁机制保证。</p>
<h2 data-id="heading-2">三、事务的隔离级别：解决并发事务冲突</h2>
<p>在多用户并发操作数据库时，若没有隔离性控制，会出现<strong>脏读、不可重复读、幻读</strong>三类问题。MySQL 通过 “事务隔离级别” 来平衡 “隔离性” 和 “并发性能”，共定义了 4 个隔离级别（从低到高）：</p>
<h4 data-id="heading-3">1. 四类并发问题（先理解问题，再看解决方案）</h4>

























<table><thead><tr><th>问题类型</th><th>定义</th><th>部门 - 员工场景示例</th></tr></thead><tbody><tr><td>脏读（Dirty Read）</td><td>一个事务读取到另一个事务 “未提交” 的修改数据</td><td>事务 A 新增员工 “钱八” 但未提交，事务 B 查询研发部人数为 3；事务 A 回滚后，事务 B 读到的 “3” 就是 “脏数据”</td></tr><tr><td>不可重复读（Non-repeatable Read）</td><td>一个事务内多次读取同一数据，结果不一致（被其他事务 “修改并提交”）</td><td>事务 B 第一次查研发部人数为 2，事务 A 新增员工并提交，事务 B 再次查询人数为 3，两次结果不同</td></tr><tr><td>幻读（Phantom Read）</td><td>一个事务内多次执行同一查询，结果集行数不一致（被其他事务 “插入 / 删除并提交”）</td><td>事务 B 查询 “薪资&gt; 15000 的研发部员工” 有 2 人，事务 A 新增 1 名高薪员工并提交，事务 B 再次查询变为 3 人，如同 “出现幻觉”</td></tr></tbody></table>
<h4 data-id="heading-4">2. 四种隔离级别（解决并发问题的不同程度）</h4>
<p>MySQL 默认隔离级别为<code>REPEATABLE READ（可重复读）</code>，也是生产环境最常用的级别。</p>








































<table><thead><tr><th>隔离级别</th><th>英文全称</th><th>解决的问题</th><th>允许的问题</th><th>性能</th></tr></thead><tbody><tr><td>读未提交</td><td>READ UNCOMMITTED</td><td>无（最低隔离）</td><td>脏读、不可重复读、幻读</td><td>最高</td></tr><tr><td>读已提交</td><td>READ COMMITTED</td><td>脏读</td><td>不可重复读、幻读</td><td>较高</td></tr><tr><td>可重复读（默认）</td><td>REPEATABLE READ</td><td>脏读、不可重复读</td><td>幻读（MySQL 已通过 MVCC 解决）</td><td>中等</td></tr><tr><td>串行化</td><td>SERIALIZABLE</td><td>所有问题（完全隔离）</td><td>无（并发事务串行执行）</td><td>最低</td></tr></tbody></table>
<p><strong>关键说明</strong>：</p>
<ul>
<li>MySQL 的<code>REPEATABLE READ</code>通过 “多版本并发控制（MVCC）” 额外解决了幻读问题，是比标准定义更优的实现；</li>
<li>隔离级别越高，并发性能越低，需根据业务场景选择（如财务系统用<code>SERIALIZABLE</code>，普通业务用<code>REPEATABLE READ</code>）。</li>
</ul>
<h4 data-id="heading-5">3. 查看 / 设置隔离级别</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看当前会话隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@SESSION</span>.tx_isolation;
<span class="hljs-comment">-- 查看全局隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@GLOBAL</span>.tx_isolation;

<span class="hljs-comment">-- 设置当前会话隔离级别为读已提交</span>
<span class="hljs-keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
<span class="hljs-comment">-- 设置全局隔离级别为可重复读（默认）</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;
</code></pre>
<h2 data-id="heading-6">四、事务的基础操作语法（MySQL 实战）</h2>
<h4 data-id="heading-7">1. 核心语法</h4>
<p>MySQL 默认开启 “自动提交（AUTOCOMMIT）”，即每条 SQL 语句都是一个独立事务。需手动关闭自动提交或显式开启事务。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 关闭自动提交（当前会话有效）</span>
<span class="hljs-keyword">SET</span> AUTOCOMMIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">-- 2. 开启事务（显式声明事务开始）</span>
<span class="hljs-keyword">BEGIN</span>; <span class="hljs-comment">-- 或 START TRANSACTION;</span>

<span class="hljs-comment">-- 3. 执行事务内的操作（如插入员工+更新部门人数）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `emp` (emp_name, emp_salary, hire_date, dept_id) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'钱八'</span>, <span class="hljs-number">14000.00</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-number">1</span>);

<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> emp_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 4. 提交事务（所有操作生效，持久化到数据库）</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 4. 回滚事务（撤销所有操作，回到事务开始前的状态）</span>
<span class="hljs-comment">-- ROLLBACK;</span>

<span class="hljs-comment">-- 5. 保存点（可选，回滚到指定位置，而非整个事务）</span>
<span class="hljs-keyword">SAVEPOINT</span> sp1; <span class="hljs-comment">-- 设置保存点</span>
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> sp1; <span class="hljs-comment">-- 回滚到保存点</span>
</code></pre>
<h4 data-id="heading-8">2. 实战案例（部门 - 员工入职）</h4>
<p>先给<code>dept</code>表新增<code>emp_count</code>字段（用于统计部门人数）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `dept` <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> `emp_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'部门员工数'</span>;
<span class="hljs-comment">-- 初始化现有部门人数</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 研发部2人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- 人事部1人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">-- 财务部1人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>; <span class="hljs-comment">-- 市场部0人</span>
</code></pre>
<p>执行带事务的入职操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 步骤1：开启事务</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- 步骤2：执行操作1：插入新员工</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `emp` (emp_name, emp_salary, hire_date, dept_id, manager_id) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'钱八'</span>, <span class="hljs-number">14000.00</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- 步骤3：执行操作2：更新研发部人数</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> emp_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 步骤4：验证数据（事务未提交，仅当前会话可见）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `emp` <span class="hljs-keyword">WHERE</span> emp_name <span class="hljs-operator">=</span> <span class="hljs-string">'钱八'</span>; <span class="hljs-comment">-- 能查到</span>
<span class="hljs-keyword">SELECT</span> emp_count <span class="hljs-keyword">FROM</span> `dept` <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 3</span>

<span class="hljs-comment">-- 步骤5：提交事务（数据持久化）</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 若操作失败，执行回滚：ROLLBACK;</span>
</code></pre>
<h2 data-id="heading-9">五、实战落地：不同开发场景下的事务使用</h2>
<h4 data-id="heading-10">1. 原生 JDBC 中的事务控制</h4>
<p>JDBC 默认也是自动提交事务，需手动关闭自动提交，通过<code>Connection</code>对象控制事务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTransactionDemo</span> {
    <span class="hljs-comment">// 数据库连接信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/test?serverTimezone=UTC&amp;useSSL=false"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取连接</span>
            conn = DriverManager.getConnection(URL, USER, PASSWORD);
            <span class="hljs-comment">// 2. 关闭自动提交（开启手动事务）</span>
            conn.setAutoCommit(<span class="hljs-literal">false</span>);

            <span class="hljs-comment">// 3. 操作1：插入新员工</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO emp (emp_name, emp_salary, hire_date, dept_id, manager_id) VALUES (?, ?, ?, ?, ?)"</span>;
            pstmt1 = conn.prepareStatement(sql1);
            pstmt1.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"钱八"</span>);
            pstmt1.setBigDecimal(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigDecimal(<span class="hljs-string">"14000.00"</span>));
            pstmt1.setDate(<span class="hljs-number">3</span>, java.sql.Date.valueOf(<span class="hljs-string">"2024-01-01"</span>));
            pstmt1.setLong(<span class="hljs-number">4</span>, <span class="hljs-number">1L</span>);
            pstmt1.setLong(<span class="hljs-number">5</span>, <span class="hljs-number">1L</span>);
            pstmt1.executeUpdate();

            <span class="hljs-comment">// 4. 操作2：更新部门人数</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE dept SET emp_count = emp_count + 1 WHERE dept_id = ?"</span>;
            pstmt2 = conn.prepareStatement(sql2);
            pstmt2.setLong(<span class="hljs-number">1</span>, <span class="hljs-number">1L</span>);
            pstmt2.executeUpdate();

            <span class="hljs-comment">// 5. 提交事务（所有操作生效）</span>
            conn.commit();
            System.out.println(<span class="hljs-string">"入职操作成功，事务提交！"</span>);

        } <span class="hljs-keyword">catch</span> (SQLException e) {
            e.printStackTrace();
            <span class="hljs-comment">// 6. 发生异常，回滚事务</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                    conn.rollback();
                    System.out.println(<span class="hljs-string">"操作失败，事务回滚！"</span>);
                }
            } <span class="hljs-keyword">catch</span> (SQLException ex) {
                ex.printStackTrace();
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 7. 关闭资源</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (pstmt1 != <span class="hljs-literal">null</span>) pstmt1.close();
                <span class="hljs-keyword">if</span> (pstmt2 != <span class="hljs-literal">null</span>) pstmt2.close();
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                    conn.setAutoCommit(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 恢复自动提交</span>
                    conn.close();
                }
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-11">2. MyBatis 中的事务控制</h4>
<p>MyBatis 的事务默认由<code>SqlSession</code>控制，默认关闭自动提交，需手动<code>commit()</code>或<code>rollback()</code>：</p>
<h5 data-id="heading-12">（1）编写 Mapper 接口和 XML</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// EmpMapper.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EmpMapper</span> {
    <span class="hljs-comment">// 插入员工</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insertEmp</span><span class="hljs-params">(Emp emp)</span>;
}

<span class="hljs-comment">// DeptMapper.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DeptMapper</span> {
    <span class="hljs-comment">// 更新部门人数</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateDeptCount</span><span class="hljs-params">(<span class="hljs-meta">@Param("deptId")</span> Long deptId, <span class="hljs-meta">@Param("count")</span> <span class="hljs-type">int</span> count)</span>;
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- EmpMapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertEmp"</span>&gt;</span>
    INSERT INTO emp (emp_name, emp_salary, hire_date, dept_id, manager_id)
    VALUES (#{empName}, #{empSalary}, #{hireDate}, #{deptId}, #{managerId})
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-comment">&lt;!-- DeptMapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateDeptCount"</span>&gt;</span>
    UPDATE dept SET emp_count = emp_count + #{count} WHERE dept_id = #{deptId}
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
</code></pre>
<h5 data-id="heading-13">（2）MyBatis 事务实战</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisTransactionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 获取SqlSession（默认autoCommit=false）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> MyBatisUtil.getSqlSession(<span class="hljs-literal">false</span>)) {
            <span class="hljs-comment">// 2. 获取Mapper</span>
            <span class="hljs-type">EmpMapper</span> <span class="hljs-variable">empMapper</span> <span class="hljs-operator">=</span> session.getMapper(EmpMapper.class);
            <span class="hljs-type">DeptMapper</span> <span class="hljs-variable">deptMapper</span> <span class="hljs-operator">=</span> session.getMapper(DeptMapper.class);

            <span class="hljs-comment">// 3. 构建员工对象</span>
            <span class="hljs-type">Emp</span> <span class="hljs-variable">emp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();
            emp.setEmpName(<span class="hljs-string">"钱八"</span>);
            emp.setEmpSalary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigDecimal(<span class="hljs-string">"14000.00"</span>));
            emp.setHireDate(java.sql.Date.valueOf(<span class="hljs-string">"2024-01-01"</span>));
            emp.setDeptId(<span class="hljs-number">1L</span>);
            emp.setManagerId(<span class="hljs-number">1L</span>);

            <span class="hljs-comment">// 4. 执行操作</span>
            empMapper.insertEmp(emp);
            deptMapper.updateDeptCount(<span class="hljs-number">1L</span>, <span class="hljs-number">1</span>);

            <span class="hljs-comment">// 5. 提交事务</span>
            session.commit();
            System.out.println(<span class="hljs-string">"入职操作成功，事务提交！"</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-comment">// 6. 异常回滚（try-with-resources会自动关闭session，触发rollback）</span>
            System.out.println(<span class="hljs-string">"操作失败，事务回滚！"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-14">3. Spring 声明式事务（生产环境首选）</h4>
<p>在 Spring/Spring Boot 项目中，推荐使用<code>@Transactional</code>注解实现 “声明式事务”，无需手动控制<code>commit/rollback</code>，更简洁高效：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmpDeptService</span> {
    <span class="hljs-comment">// 注入Mapper</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmpMapper empMapper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeptMapper deptMapper;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmpDeptService</span><span class="hljs-params">(EmpMapper empMapper, DeptMapper deptMapper)</span> {
        <span class="hljs-built_in">this</span>.empMapper = empMapper;
        <span class="hljs-built_in">this</span>.deptMapper = deptMapper;
    }

    <span class="hljs-comment">// 声明事务：默认发生RuntimeException时回滚</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span> <span class="hljs-comment">// 捕获所有异常回滚</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addEmpWithDept</span><span class="hljs-params">(Emp emp)</span> {
        <span class="hljs-comment">// 1. 插入员工</span>
        empMapper.insertEmp(emp);
        <span class="hljs-comment">// 2. 更新部门人数</span>
        deptMapper.updateDeptCount(emp.getDeptId(), <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 模拟异常（测试回滚）</span>
        <span class="hljs-comment">// int i = 1 / 0;</span>
    }
}
</code></pre>
<p><strong>关键说明</strong>：</p>
<ul>
<li><code>@Transactional</code>默认只捕获<code>RuntimeException</code>，需通过<code>rollbackFor = Exception.class</code>指定捕获所有异常；</li>
<li>可通过<code>isolation</code>属性设置隔离级别（如<code>isolation = Isolation.REPEATABLE_READ</code>）；</li>
<li>可通过<code>propagation</code>属性设置事务传播行为（如<code>REQUIRED</code>：默认，有事务则加入，无则新建）。</li>
</ul>
<h2 data-id="heading-15">六、事务的常见问题与最佳实践</h2>
<h4 data-id="heading-16">1. 常见问题排查</h4>
<ul>
<li><strong>事务不回滚</strong>：检查是否捕获了异常（未抛出异常则 Spring 不会回滚）、是否是非运行时异常（需指定<code>rollbackFor</code>）、是否调用了非 public 方法（<code>@Transactional</code>仅对 public 方法生效）；</li>
<li><strong>长事务导致性能问题</strong>：长事务会占用数据库连接、持有锁时间长，导致并发下降，需尽量缩小事务范围；</li>
<li><strong>死锁</strong>：多个事务互相等待对方持有的锁，可通过<code>SHOW ENGINE INNODB STATUS</code>查看死锁日志，优化 SQL 执行顺序。</li>
</ul>
<h4 data-id="heading-17">2. 核心最佳实践</h4>
<h5 data-id="heading-18">（1）尽量缩小事务范围</h5>
<p>只将 “必须原子执行” 的操作放入事务，避免无关操作（如日志打印、远程调用）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addEmpWithDept</span><span class="hljs-params">(Emp emp)</span> {
    <span class="hljs-comment">// 事务内：核心操作（必须原子）</span>
    empMapper.insertEmp(emp);
    deptMapper.updateDeptCount(emp.getDeptId(), <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 事务外：无关操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEmpAdd</span><span class="hljs-params">(Emp emp)</span> {
    logger.info(<span class="hljs-string">"新增员工：{}"</span>, emp.getEmpName());
}
</code></pre>
<h5 data-id="heading-19">（2）避免长事务</h5>
<ul>
<li>不在事务内执行耗时操作（如文件上传、第三方接口调用）；</li>
<li>批量操作可拆分为多个小事务（如每 1000 条数据提交一次）。</li>
</ul>
<h5 data-id="heading-20">（3）合理设置隔离级别</h5>
<ul>
<li>普通业务：使用 MySQL 默认的<code>REPEATABLE READ</code>；</li>
<li>高并发读业务：可降级为<code>READ COMMITTED</code>（提升性能）；</li>
<li>财务 / 核心数据：使用<code>SERIALIZABLE</code>（保证绝对一致性）。</li>
</ul>
<h5 data-id="heading-21">（4）避免手动锁与事务冲突</h5>
<p>尽量利用事务的隔离级别和 MVCC，而非手动加锁（如<code>SELECT ... FOR UPDATE</code>），手动锁易导致死锁。</p>
<h5 data-id="heading-22">（5）监控事务执行情况</h5>
<p>生产环境需监控长事务、死锁、事务失败率，可通过 MySQL 的<code>information_schema</code>表查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询当前运行的事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;
<span class="hljs-comment">-- 查询死锁日志</span>
<span class="hljs-keyword">SHOW</span> ENGINE INNODB STATUS;
</code></pre>
<h2 data-id="heading-23">七、总结与拓展</h2>
<p>本文以 “部门 - 员工” 场景为核心，讲解了事务的 ACID 特性、隔离级别、基础语法，以及 JDBC/MyBatis/Spring 中的实战落地，核心要点总结：</p>
<ol>
<li>
<p><strong>事务的核心目标</strong>：保证一组操作的原子性，避免数据不一致，遵循 ACID 四大特性；</p>
</li>
<li>
<p><strong>隔离级别选择</strong>：默认用<code>REPEATABLE READ</code>，根据业务场景平衡 “隔离性” 和 “并发性能”；</p>
</li>
<li>
<p><strong>实战建议</strong>：</p>
<ul>
<li>原生 JDBC/MyBatis：手动控制<code>commit/rollback</code>，关闭自动提交；</li>
<li>Spring 项目：优先使用<code>@Transactional</code>声明式事务，简化开发；</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：缩小事务范围、避免长事务、监控死锁和长事务。</p>
</li>
</ol>
<h4 data-id="heading-24">拓展方向：</h4>
<ul>
<li><strong>分布式事务</strong>：跨多个数据库 / 服务的事务，可使用 Seata、TCC、SAGA 等方案；</li>
<li><strong>事务日志</strong>：了解 Redo Log/Undo Log 的工作原理，理解事务持久性和回滚的底层实现；</li>
<li><strong>锁机制</strong>：深入学习 InnoDB 的行锁、表锁、间隙锁，理解隔离级别与锁的关系。</li>
</ul>
<p>事务是数据库保证数据一致性的核心机制，也是企业级开发中必须掌握的技能。掌握事务的使用与优化，不仅能避免数据错误，还能提升系统的并发性能和稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pyinstaller进阶之构建管理大杀器-SPEC文件]]></title>    <link>https://juejin.cn/post/7588086766235369510</link>    <guid>https://juejin.cn/post/7588086766235369510</guid>    <pubDate>2025-12-26T12:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235369510" data-draft-id="7587997893987713051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pyinstaller进阶之构建管理大杀器-SPEC文件"/> <meta itemprop="keywords" content="后端,Python,程序员"/> <meta itemprop="datePublished" content="2025-12-26T12:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐叔在学习"/> <meta itemprop="url" content="https://juejin.cn/user/4009253326568761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pyinstaller进阶之构建管理大杀器-SPEC文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4009253326568761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐叔在学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:35:15.000Z" title="Fri Dec 26 2025 12:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>用过 <code>python</code> 打包生成 <code>Windows</code> 可执行程序的同学，大概率都用过大名鼎鼎的 <code>pyinstaller</code> 库吧。</p>
</blockquote>
<p><code>pyinstaller</code> 如果想最终生成的可执行程序，包括只限定的 <code>python</code> 指定模块或者要额外的静态资源文件，写执行指令一般都很长的。</p>
<pre><code class="hljs language-shell" lang="shell">pyinstaller --noconfirm --log-level=WARN \
    --onefile --nowindow \
    --add-data="README:." \
    --add-data="image1.png:img" \
    --add-binary="libfoo.so:lib" \
    --hidden-import=secret1 \
    --hidden-import=secret2 \
    --upx-dir=/usr/local/share
</code></pre>
<p>而有没有一种方式可以更好地进行 <code>pyinstaller</code> 的构建管理呢？看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpyinstaller.org%2Fen%2Fstable%2Fspec-files.html" target="_blank" title="https://pyinstaller.org/en/stable/spec-files.html" ref="nofollow noopener noreferrer">官网文档：Using Spec Files — PyInstaller 6.17.0 documentation</a>，那就是使用 <code>spec</code> 文件进行构建管理。</p>
<p>PS：如果对 pyinstaller 基础使用不太了解，也可以看看小编的往期文章。
<a href="https://juejin.cn/post/7562095444215791631" target="_blank" title="https://juejin.cn/post/7562095444215791631">Pyinstaller - Python桌面应用打包的首选工具 - 掘金</a></p>
<h2 data-id="heading-0">1. spec文件的构成和使用</h2>
<p>Q1：怎么使用 <code>spec</code> 文件呢？很简单：执行 <code>pyinstaller</code> 指令时带上对应的 <code>spec</code> 文件即可。</p>
<pre><code class="hljs language-shell" lang="shell">pyinstaller --clean --noconfirm xxx.spec
</code></pre>
<p>Q2：<code>spec</code> 文件是怎么做到有效构建和管理模块和资源文件的呢？</p>
<p>主要通过下面几个核心的配置步骤：Analysis-分析依赖 → PYZ-打包模块 → EXE-生成exe → [COLLECT-收集文件]</p>
<p>💡温馨提示：单文件模式下，不需要额外进行第四步骤收集文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a15f5b28c8a5419ba3ab92cec90b88f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ5Y-U5Zyo5a2m5Lmg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405208&amp;x-signature=iCNIkuDSi2hm%2BAUjxVePCugSJEw%3D" alt="" loading="lazy"/></p>
<p>下面具体展开进行介绍。</p>
<hr/>
<h2 data-id="heading-1">2. Analysis 类</h2>
<h3 data-id="heading-2">2.1 作用场景</h3>
<p><strong>依赖分析器</strong>，这是打包过程的核心步骤。它会：</p>
<ul>
<li>分析你的Python脚本</li>
<li>递归查找所有导入的模块</li>
<li>收集所有需要的文件（Python模块、扩展模块、数据文件等）</li>
</ul>
<blockquote>
<p>✍️ 开头说的管理模块和数据文件，就主要在这里进行配置的。</p>
</blockquote>
<h3 data-id="heading-3">2.2 参数配置详解</h3>
<p>这里我用的比较多的就 <code>excludes</code> 、<code>hiddenimports</code> 和 <code>datas</code>，其他默认填写或按照模板即可。</p>
<pre><code class="hljs language-python" lang="python">a = Analysis(
    <span class="hljs-comment"># ============ 必需参数 ============</span>
    scripts=[<span class="hljs-string">'main.py'</span>],  <span class="hljs-comment"># 主脚本列表</span>

    <span class="hljs-comment"># ============ 路径相关 ============</span>
    pathex=[<span class="hljs-string">'/path/to/project'</span>, <span class="hljs-string">'/another/path'</span>],  <span class="hljs-comment"># 模块搜索路径</span>
    hookspath=[<span class="hljs-string">'custom_hooks'</span>],  <span class="hljs-comment"># 自定义hook文件路径</span>
    runtime_hooks=[<span class="hljs-string">'runtime_hooks/hook-qt.py'</span>],  <span class="hljs-comment"># 运行时hook脚本</span>

    <span class="hljs-comment"># ============ 模块处理 ============</span>
    excludes=[                          <span class="hljs-comment"># 排除的模块（减少包体积）</span>
        <span class="hljs-string">'tkinter'</span>,
        <span class="hljs-string">'unittest'</span>,
        <span class="hljs-string">'pydoc'</span>,
        <span class="hljs-string">'pdb'</span>,
        <span class="hljs-string">'matplotlib'</span>
    ],
    hiddenimports=[                     <span class="hljs-comment"># 隐藏导入（动态导入的模块）</span>
        <span class="hljs-string">'PIL._imaging'</span>,
        <span class="hljs-string">'sklearn.utils._weight_vector'</span>,
        <span class="hljs-string">'pandas._libs.tslibs.timedeltas'</span>
    ],
    win_no_prefer_redirects=<span class="hljs-literal">False</span>,      <span class="hljs-comment"># Windows专用：DLL重定向</span>
    win_private_assemblies=<span class="hljs-literal">False</span>,       <span class="hljs-comment"># Windows专用：私有程序集</span>

    <span class="hljs-comment"># ============ 文件收集 ============</span>
    datas=[                            <span class="hljs-comment"># 非Python文件（配置文件、图片等）</span>
        (<span class="hljs-string">'config.json'</span>, <span class="hljs-string">'.'</span>),          <span class="hljs-comment"># (源文件, 目标目录)</span>
        (<span class="hljs-string">'images/*.png'</span>, <span class="hljs-string">'images'</span>),
        (<span class="hljs-string">'data/*.csv'</span>, <span class="hljs-string">'data'</span>)
    ],
    binaries=[                         <span class="hljs-comment"># 二进制文件（.so, .dll等）</span>
        (<span class="hljs-string">'/usr/lib/libssl.so'</span>, <span class="hljs-string">'lib'</span>), <span class="hljs-comment"># (源文件, 目标目录)</span>
        (<span class="hljs-string">'C:/Windows/System32/msvcp140.dll'</span>, <span class="hljs-string">'.'</span>)
    ],

    <span class="hljs-comment"># ============ 高级选项 ============</span>
    cipher=block_cipher,               <span class="hljs-comment"># 加密字节码的密钥</span>
    noarchive=<span class="hljs-literal">False</span>,                   <span class="hljs-comment"># True=不解压到临时目录</span>
    optimize=<span class="hljs-number">0</span>,                        <span class="hljs-comment"># 字节码优化级别：-1, 0, 1, 2</span>
    upx=<span class="hljs-literal">False</span>,                         <span class="hljs-comment"># 是否用UPX压缩（已弃用，在EXE中设置）</span>
    upx_exclude=[],                    <span class="hljs-comment"># 排除UPX压缩的文件</span>
    strip=<span class="hljs-literal">False</span>,                       <span class="hljs-comment"># 是否去除符号信息</span>
    prefetch=<span class="hljs-literal">False</span>,                    <span class="hljs-comment"># 预取模式（实验性）</span>
    name=<span class="hljs-literal">None</span>,                         <span class="hljs-comment"># 分析名称（用于多程序打包）</span>
)
</code></pre>
<h3 data-id="heading-4">2.3 实际示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复杂的Analysis配置</span>
block_cipher = pyi_crypto.PyiBlockCipher(key=<span class="hljs-string">'my-secret-key'</span>)

a = Analysis(
    [<span class="hljs-string">'app_main.py'</span>, <span class="hljs-string">'helper.py'</span>],  <span class="hljs-comment"># 多个入口文件</span>
    pathex=[os.getcwd(), <span class="hljs-string">'../shared_libs'</span>],
    binaries=[
        (<span class="hljs-string">'lib/ffmpeg.exe'</span>, <span class="hljs-string">'bin'</span>),
        (<span class="hljs-string">'lib/iconv.dll'</span>, <span class="hljs-string">'bin'</span>)
    ],
    datas=[
        (<span class="hljs-string">'ui/*.ui'</span>, <span class="hljs-string">'ui'</span>),           <span class="hljs-comment"># Qt Designer文件</span>
        (<span class="hljs-string">'locales/*.qm'</span>, <span class="hljs-string">'locales'</span>), <span class="hljs-comment"># 翻译文件</span>
        (<span class="hljs-string">'*.ini'</span>, <span class="hljs-string">'.'</span>),              <span class="hljs-comment"># 配置文件</span>
        (<span class="hljs-string">'docs/*.md'</span>, <span class="hljs-string">'docs'</span>)
    ],
    hiddenimports=[
        <span class="hljs-string">'win32timezone'</span>,             <span class="hljs-comment"># pywin32相关</span>
        <span class="hljs-string">'sqlalchemy.sql.default_comparator'</span>,
        <span class="hljs-string">'pkg_resources.py2_warn'</span>
    ],
    hookspath=[<span class="hljs-string">'hooks'</span>],             <span class="hljs-comment"># 自定义hook目录</span>
    runtime_hooks=[<span class="hljs-string">'hooks/runtime/rthook_pyside6.py'</span>],
    excludes=[<span class="hljs-string">'scipy'</span>, <span class="hljs-string">'numpy.testing'</span>],
    cipher=block_cipher,
    optimize=<span class="hljs-number">1</span>                       <span class="hljs-comment"># 字节码优化</span>
)
</code></pre>
<h2 data-id="heading-5">3. EXE 类</h2>
<h3 data-id="heading-6">3.1 作用场景</h3>
<p><strong>可执行文件构建器</strong>，将分析结果打包成最终的可执行文件。</p>
<h3 data-id="heading-7">3.2 参数配置详解</h3>
<pre><code class="hljs language-python" lang="python">exe = EXE(
    <span class="hljs-comment"># ============ 必需参数 ============</span>
    pyz,                <span class="hljs-comment"># PYZ对象（包含所有Python模块）</span>
    a.scripts,          <span class="hljs-comment"># Analysis的scripts结果</span>
    a.binaries,         <span class="hljs-comment"># Analysis的binaries结果</span>
    a.zipfiles,         <span class="hljs-comment"># Analysis的zipfiles结果</span>
    a.datas,            <span class="hljs-comment"># Analysis的datas结果</span>

    <span class="hljs-comment"># ============ 输出配置 ============</span>
    name=<span class="hljs-string">'MyApp'</span>,       <span class="hljs-comment"># 输出文件名（不加.exe）</span>
    debug=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># True=包含调试信息</span>
    strip=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># True=去除符号信息（减小体积）</span>
    upx=<span class="hljs-literal">True</span>,           <span class="hljs-comment"># True=使用UPX压缩（需安装UPX）</span>

    <span class="hljs-comment"># ============ 控制台/窗口设置 ============</span>
    console=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># True=控制台程序，False=窗口程序（Windows）</span>
    disable_windowed_traceback=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 禁用窗口程序错误跟踪</span>
    argv_emulation=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># macOS: 模拟命令行参数</span>

    <span class="hljs-comment"># ============ 图标和元数据 ============</span>
    icon=<span class="hljs-string">'app.ico'</span>,     <span class="hljs-comment"># 程序图标（Windows: .ico, macOS: .icns）</span>

    <span class="hljs-comment"># ============ 运行时行为 ============</span>
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 忽略信号（Unix）</span>
    runtime_tmpdir=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># 临时目录路径</span>

    <span class="hljs-comment"># ============ 重定向设置 ============</span>
    exclude_binaries=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># True=不包含二进制依赖</span>
    code_signing_identity=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># macOS代码签名标识</span>

    <span class="hljs-comment"># ============ 加密和优化 ============</span>
    entitlements_file=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># macOS授权文件</span>
    embed_manifest=<span class="hljs-literal">True</span>,     <span class="hljs-comment"># Windows: 嵌入manifest</span>
    target_arch=<span class="hljs-literal">None</span>,        <span class="hljs-comment"># 目标架构：'x86', 'x64', 'arm64'</span>

    <span class="hljs-comment"># ============ 其他选项 ============</span>
    <span class="hljs-built_in">ascii</span>=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># 弃用</span>
    uac_admin=<span class="hljs-literal">False</span>,    <span class="hljs-comment"># Windows: 以管理员运行</span>
    uac_uiaccess=<span class="hljs-literal">False</span>, <span class="hljs-comment"># Windows: UI访问权限</span>

    <span class="hljs-comment"># ============ 调试相关 ============</span>
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,
    strict_arch=<span class="hljs-literal">False</span>,
)
</code></pre>
<h3 data-id="heading-8">3.3 实际示例</h3>
<p>这里还真没怎么差异化使用过，一般都是配置 <code>win</code> 平台。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不同平台配置示例</span>
<span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">'win32'</span>:
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'MyApp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">False</span>,
        upx=<span class="hljs-literal">True</span>,
        console=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 无控制台窗口</span>
        icon=<span class="hljs-string">'app.ico'</span>,
        uac_admin=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 需要管理员权限</span>
        embed_manifest=<span class="hljs-literal">True</span>,
        version=<span class="hljs-string">'version_info.txt'</span>  <span class="hljs-comment"># Windows版本资源</span>
    )
<span class="hljs-keyword">elif</span> sys.platform == <span class="hljs-string">'darwin'</span>:
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'MyApp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">True</span>,
        upx=<span class="hljs-literal">False</span>,
        console=<span class="hljs-literal">False</span>,
        icon=<span class="hljs-string">'app.icns'</span>,
        entitlements_file=<span class="hljs-string">'app.entitlements'</span>,
        code_signing_identity=<span class="hljs-string">'Developer ID Application: Your Name (XXXXXX)'</span>
    )
<span class="hljs-keyword">else</span>:  <span class="hljs-comment"># Linux</span>
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'myapp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">True</span>,
        upx=<span class="hljs-literal">True</span>,
        console=<span class="hljs-literal">True</span>  <span class="hljs-comment"># Linux通常用控制台</span>
    )
</code></pre>
<h2 data-id="heading-9">4. todo-list应用完整文件示例</h2>
<p>以最近我在撰写的 <code>todo-list</code> 应用的打包配置文件为例，这个主要是 <code>AI</code> 编写的，我就改了几行代码而已。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># -*- mode: python ; coding: utf-8 -*-</span>

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 获取项目根目录</span>
project_root = Path(SPECPATH).parent
frontend_dir = project_root / <span class="hljs-string">'frontend'</span>
data_dir = project_root / <span class="hljs-string">'data'</span>

<span class="hljs-comment"># 收集前端文件</span>
frontend_files = [
 (<span class="hljs-string">'frontend/index.html'</span>, <span class="hljs-string">'frontend/'</span>),
 (<span class="hljs-string">'frontend/css/*'</span>, <span class="hljs-string">'frontend/css'</span>),
 (<span class="hljs-string">'frontend/js/*'</span>, <span class="hljs-string">'frontend/js'</span>)
]

<span class="hljs-comment"># 收集数据文件</span>
data_files = []
<span class="hljs-keyword">if</span> data_dir.exists():
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data_dir.rglob(<span class="hljs-string">'*'</span>):
        <span class="hljs-keyword">if</span> item.is_file():
            relative_path = item.relative_to(data_dir)
            data_files.append((<span class="hljs-built_in">str</span>(item), <span class="hljs-string">'data'</span>))

block_cipher = <span class="hljs-literal">None</span>

a = Analysis(
    [<span class="hljs-string">'run.py'</span>],
    pathex=[<span class="hljs-built_in">str</span>(project_root), <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">'backend'</span>), <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">'TodoList'</span> / <span class="hljs-string">'backend'</span>)],
    binaries=[],
    datas=frontend_files + data_files,
    hiddenimports=[
        <span class="hljs-string">'webview'</span>,
        <span class="hljs-string">'webview.platforms'</span>,
        <span class="hljs-string">'webview.platforms.cef'</span>,
        <span class="hljs-string">'webview.platforms.edgechromium'</span>,
        <span class="hljs-string">'webview.platforms.mshtml'</span>,
        <span class="hljs-string">'webview.platforms.gtk'</span>,
        <span class="hljs-string">'webview.platforms.cocoa'</span>,
        <span class="hljs-string">'webview.platforms.qt'</span>,
        <span class="hljs-string">'sqlite3'</span>,
        <span class="hljs-string">'json'</span>,
        <span class="hljs-string">'threading'</span>,
        <span class="hljs-string">'datetime'</span>,
        <span class="hljs-string">'http.server'</span>,
        <span class="hljs-string">'socketserver'</span>,
        <span class="hljs-string">'urllib.parse'</span>,
        <span class="hljs-string">'pathlib'</span>,
        <span class="hljs-string">'os'</span>,
        <span class="hljs-string">'sys'</span>,
        <span class="hljs-string">'shutil'</span>,
        <span class="hljs-string">'subprocess'</span>,
        <span class="hljs-string">'re'</span>,
        <span class="hljs-string">'uuid'</span>,
        <span class="hljs-string">'hashlib'</span>,
        <span class="hljs-string">'base64'</span>,
        <span class="hljs-string">'html'</span>,
        <span class="hljs-string">'webbrowser'</span>,
        <span class="hljs-string">'tkinter'</span>,
        <span class="hljs-string">'tkinter.messagebox'</span>,
        <span class="hljs-string">'tkinter.filedialog'</span>,
        <span class="hljs-string">'tkinter.simpledialog'</span>,
        <span class="hljs-comment"># 后端模块</span>
        <span class="hljs-string">'database.operations'</span>,
        <span class="hljs-string">'database.models'</span>,
        <span class="hljs-string">'api.todo_api'</span>
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        <span class="hljs-string">'matplotlib'</span>,
        <span class="hljs-string">'numpy'</span>,
        <span class="hljs-string">'scipy'</span>,
        <span class="hljs-string">'pandas'</span>,
        <span class="hljs-string">'PIL'</span>,
        <span class="hljs-string">'cv2'</span>,
        <span class="hljs-string">'PyQt6'</span>
    ],
    win_no_prefer_redirects=<span class="hljs-literal">False</span>,
    win_private_assemblies=<span class="hljs-literal">False</span>,
    cipher=block_cipher,
    noarchive=<span class="hljs-literal">False</span>,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name=<span class="hljs-string">'TodoList'</span>,
    debug=<span class="hljs-literal">False</span>,
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,
    strip=<span class="hljs-literal">False</span>,
    upx=<span class="hljs-literal">True</span>,
    upx_exclude=[],
    runtime_tmpdir=<span class="hljs-literal">None</span>,
    console=<span class="hljs-literal">False</span>,
    disable_windowed_traceback=<span class="hljs-literal">False</span>,
    argv_emulation=<span class="hljs-literal">False</span>,
    target_arch=<span class="hljs-literal">None</span>,
    codesign_identity=<span class="hljs-literal">None</span>,
    entitlements_file=<span class="hljs-literal">None</span>,
    icon=<span class="hljs-string">'todo_icon.ico'</span> <span class="hljs-keyword">if</span> Path(<span class="hljs-string">'todo_icon.ico'</span>).exists() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
    version=<span class="hljs-string">'version_info.txt'</span> <span class="hljs-keyword">if</span> Path(<span class="hljs-string">'version_info.txt'</span>).exists() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
)
</code></pre>
<p>示例上可以看出实际上，<code>spec</code> 文件执行时是可以识别 <code>python</code> 代码的。</p>
<h2 data-id="heading-10">5. 补充说明</h2>
<h3 data-id="heading-11">5.1 针对特定库的配置</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 打包PyQt6/PySide6应用</span>
a = Analysis(
    [<span class="hljs-string">'app.py'</span>],
    hiddenimports=[
        <span class="hljs-string">'PySide6.QtXml'</span>,
        <span class="hljs-string">'PySide6.QtNetwork'</span>
    ],
    binaries=[
        (<span class="hljs-string">'/path/to/qt/plugins/platforms/*'</span>, <span class="hljs-string">'platforms'</span>)
    ],
    datas=[
        (<span class="hljs-string">'/path/to/qt/translations/*'</span>, <span class="hljs-string">'translations'</span>)
    ]
)

<span class="hljs-comment"># 打包机器学习应用（排除大型库）</span>
a = Analysis(
    [<span class="hljs-string">'ml_app.py'</span>],
    excludes=[
        <span class="hljs-string">'torch'</span>,  <span class="hljs-comment"># 太大，让用户自己安装</span>
        <span class="hljs-string">'tensorflow'</span>,
        <span class="hljs-string">'jax'</span>
    ],
    hiddenimports=[
        <span class="hljs-string">'sklearn.utils._cython_blas'</span>,
        <span class="hljs-string">'numpy.core._multiarray_umath'</span>
    ]
)
</code></pre>
<h3 data-id="heading-12">5.2 调试技巧</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 调试模式配置</span>
exe = EXE(
    <span class="hljs-comment"># ...</span>
    debug=<span class="hljs-literal">True</span>,      <span class="hljs-comment"># 包含调试信息</span>
    strip=<span class="hljs-literal">False</span>,     <span class="hljs-comment"># 不去除符号</span>
    upx=<span class="hljs-literal">False</span>,       <span class="hljs-comment"># 不压缩（便于调试）</span>
    console=<span class="hljs-literal">True</span>     <span class="hljs-comment"># 显示控制台看错误</span>
)

<span class="hljs-comment"># 运行时查看缺失模块</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(sys, <span class="hljs-string">'_MEIPASS'</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"临时目录: <span class="hljs-subst">{sys._MEIPASS}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"模块路径: <span class="hljs-subst">{sys.path}</span>"</span>)
</code></pre>
<h3 data-id="heading-13">5.3 其他说明</h3>
<p>除了用于 <code>pyinstaller</code> 的打包外，<code>spec</code> 文件也在其他场景有相关使用的：</p>
<ol>
<li>
<p><strong>RPM包管理</strong>：Linux系统软件打包</p>
</li>
<li>
<p><strong>其他构建工具</strong>：作为配置文件使用</p>
</li>
</ol>
<p>另外有类似作用的文件还有：<code>setup.cfg</code>、<code>pyproject.toml</code> 等</p>
<hr/>
<p>好啦，今天的分享就到这里了，感谢阅读，如果觉得文章对你有用的话，欢迎三连、欢迎关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径]]></title>    <link>https://juejin.cn/post/7587997157237276724</link>    <guid>https://juejin.cn/post/7587997157237276724</guid>    <pubDate>2025-12-26T12:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237276724" data-draft-id="7587743345198022708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-26T12:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十月南城"/> <meta itemprop="url" content="https://juejin.cn/user/3456520290576862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520290576862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十月南城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:46:58.000Z" title="Fri Dec 26 2025 12:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>写在前面，本人目前处于求职中，如有合适内推岗位，请加：lpshiyue 感谢。同时还望大家一键三连，赚点奶粉钱。</strong></p>
<blockquote>
<p>掌握Elasticsearch的搜索质量优化，关键在于理解倒排索引如何将数据转换为可搜索的知识图谱，映射如何定义数据的DNA结构，以及分词器如何影响搜索的精准度</p>
</blockquote>
<p>在分布式系统中完成失败处置和弹性设计后，我们转向数据检索的核心挑战。搜索质量直接决定用户体验，而Elasticsearch作为领先的搜索引擎，其效果取决于三大核心原理的协同作用。本文将深入解析倒排索引的工作机制、映射的设计哲学和分词器的匹配策略，揭示它们如何共同影响搜索质量。</p>
<h2 data-id="heading-0">1 倒排索引：从文档存储到知识图谱的思维转变</h2>
<h3 data-id="heading-1">1.1 正排索引与倒排索引的本质区别</h3>
<p>传统数据库使用<strong>正排索引</strong>（Forward Index），这是一种"文档→内容"的映射关系，类似于书籍的目录（通过页码查找章节内容）。这种索引方式在处理"LIKE '%keyword%'"查询时需要进行全表扫描，随着数据量增加，性能急剧下降。</p>
<p>Elasticsearch的核心突破在于采用<strong>倒排索引</strong>（Inverted Index），实现了"内容→文档"的逆向映射。这相当于书籍末尾的关键词索引，直接告诉读者每个关键词出现在哪些页码。</p>
<p><strong>实际示例对比</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">  -- 传统数据库的正排索引查询（性能随数据量增加而线性下降）SELECT * FROM products WHERE title LIKE <span class="hljs-string">'%手机%'</span> OR description LIKE <span class="hljs-string">'%手机%'</span>;-- Elasticsearch的倒排索引查询（性能基本恒定）GET /products/_search{  <span class="hljs-string">"query"</span>: {    <span class="hljs-string">"match"</span>: {      <span class="hljs-string">"title"</span>: <span class="hljs-string">"手机"</span>    }  }}
</code></pre>
<h3 data-id="heading-2">1.2 倒排索引的底层结构与构建过程</h3>
<p>倒排索引不是简单的关键词映射，而是包含丰富语义信息的<strong>高级数据结构</strong>。其核心由两部分组成：</p>
<p><strong>词项字典</strong>（Term Dictionary）存储所有唯一的词项，并按字典序排序，便于使用二分查找等算法快速定位。</p>
<p><strong>倒排列表</strong>（Posting List）记录每个词项的详细出现信息，包含：</p>
<ul>
<li>• <strong>文档ID</strong>（DocID）：包含该词项的文档标识</li>
<li>• <strong>词频</strong>（TF）：词项在文档中出现的次数（相关性评分重要因素）</li>
<li>• <strong>位置</strong>（Position）：词项在文档中的具体位置（支持短语查询）</li>
<li>• <strong>偏移量</strong>（Offset）：词项在原始文本中的起止位置（支持高亮显示）</li>
</ul>
<p><strong>倒排索引构建流程</strong>具体包括以下步骤：</p>
<ol>
<li>1. <strong>文档解析</strong>：提取文本字段，进行编码统一和格式清理</li>
<li>2. <strong>分词处理</strong>：通过分词器将文本拆分为单独的词项</li>
<li>3. <strong>标准化处理</strong>：包括转小写、去除停用词、词干提取等</li>
<li>4. <strong>生成倒排项</strong>：记录每个词项在文档中的出现频率、位置等信息</li>
<li>5. <strong>索引存储</strong>：将倒排项写入索引段，实现持久化</li>
</ol>
<h3 data-id="heading-3">1.3 倒排索引的查询机制与性能优化</h3>
<p>当用户发起搜索请求时，Elasticsearch执行高效的<strong>两阶段查询流程</strong>：</p>
<p><strong>查询解析阶段</strong>：搜索词经过相同的分词和标准化处理，确保查询与索引的兼容性。例如搜索"Quick Foxes"会被分词为["quick", "fox"]。</p>
<p><strong>倒排列表查找与合并</strong>：Elasticsearch在词项字典中查找每个词项的倒排列表，然后根据查询逻辑（AND/OR）进行列表合并。对于AND查询，取倒排列表的交集；对于OR查询，则取并集。</p>
<p><strong>性能优化技术</strong>包括：</p>
<ul>
<li>• <strong>跳表</strong>（Skip Lists）：加速大型倒排列表的合并操作</li>
<li>• <strong>位图索引</strong>（Bitmap Indexing）：对枚举型字段进行高效压缩</li>
<li>• <strong>布隆过滤器</strong>（Bloom Filter）：快速判断词项是否存在，避免不必要的磁盘查找</li>
</ul>
<h2 data-id="heading-4">2 映射设计：数据模式的战略规划</h2>
<h3 data-id="heading-5">2.1 映射的核心作用与设计原则</h3>
<p>映射（Mapping）在Elasticsearch中相当于数据库的模式设计，它定义了文档及其包含的字段如何存储和索引。恰当的映射设计是搜索性能的基石。</p>
<p><strong>映射的核心价值</strong>体现在：</p>
<ul>
<li>• <strong>存储优化</strong>：选择合适的字段类型减少磁盘空间占用</li>
<li>• <strong>索引优化</strong>：合理的索引配置提升查询速度</li>
<li>• <strong>搜索优化</strong>：正确的分析器设置提高搜索结果相关性</li>
</ul>
<h3 data-id="heading-6">2.2 字段类型选择策略</h3>
<p>Elasticsearch提供了丰富的字段类型，每种类型都有其特定的应用场景和性能特征：</p>
<p><strong>文本类型家族</strong>：</p>
<ul>
<li>• <strong>text</strong>类型：适用于需要分词的全文搜索场景，如商品描述、文章内容</li>
<li>• <strong>keyword</strong>类型：适用于精确匹配，如状态标签、分类编码</li>
</ul>
<p><strong>数值类型家族</strong>：</p>
<ul>
<li>• <strong>整数类型</strong>（integer, long）：适合离散数值，如数量、年龄</li>
<li>• <strong>浮点类型</strong>（float, double）：适合连续数值，如价格、评分</li>
</ul>
<p><strong>专用类型家族</strong>：</p>
<ul>
<li>• <strong>date</strong>：日期和时间数据，支持丰富的范围查询</li>
<li>• <strong>geo_point</strong>：地理坐标，支持地理位置查询</li>
<li>• <strong>ip</strong>：IP地址，支持CIDR查询</li>
</ul>
<p><strong>多字段映射实战示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">  PUT /ecommerce_products{  <span class="hljs-string">"mappings"</span>: {    <span class="hljs-string">"properties"</span>: {      <span class="hljs-string">"product_id"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>      },      <span class="hljs-string">"product_name"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,        <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_max_word"</span>,        <span class="hljs-string">"fields"</span>: {          <span class="hljs-string">"keyword"</span>: {            <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>          },          <span class="hljs-string">"pinyin"</span>: {            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,            <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"pinyin"</span>          }        }      },      <span class="hljs-string">"price"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"scaled_float"</span>,        <span class="hljs-string">"scaling_factor"</span>: 100      },      <span class="hljs-string">"tags"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>      },      <span class="hljs-string">"description"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,        <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_smart"</span>      },      <span class="hljs-string">"created_time"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>      },      <span class="hljs-string">"location"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"geo_point"</span>      }    }  }}
</code></pre>
<p>此配置为商品名称同时提供分词搜索、精确匹配和拼音搜索能力</p>
<h3 data-id="heading-7">2.3 映射设计的最佳实践</h3>
<p><strong>动态映射与静态映射的平衡</strong>：在生产环境中，建议优先使用静态映射，避免字段爆炸问题。</p>
<p><strong>索引选项的精细控制</strong>：对于不需要搜索的字段（如MD5哈希值），可以设置<code>"index": false</code>节省存储空间。</p>
<p><strong>副本设置的优化</strong>：在写入密集型场景中，可以暂时设置<code>"number_of_replicas": 0</code>提升写入速度，写入完成后再恢复副本数量。</p>
<h2 data-id="heading-8">3 分词机制：搜索精准度的决定因素</h2>
<h3 data-id="heading-9">3.1 分词器的工作原理与组件协同</h3>
<p>分词器（Analyzer）是将文本转换为词项的关键组件，直接决定搜索的召回率和准确率。一个完整的分词器包含三个协同工作的组件：</p>
<p><strong>字符过滤器</strong>（Character Filters）负责原始文本的预处理，如HTML标签去除、特殊字符转换。</p>
<p><strong>分词单元</strong>（Tokenizer）是分词器的核心，将文本切分为独立的词项（Token）。不同的分词单元采用不同的切分策略。</p>
<p><strong>词项过滤器</strong>（Token Filters）对分词结果进行再加工，包括转小写、停用词去除、同义词扩展等。</p>
<h3 data-id="heading-10">3.2 中文分词的挑战与解决方案</h3>
<p>中文分词面临<strong>无自然分隔符</strong>、<strong>新词发现</strong>、<strong>歧义消除</strong>等独特挑战。IK分词器是中文场景的首选解决方案，提供两种分词模式：</p>
<p><strong>ik_smart模式</strong>（粗粒度分词）适合精准匹配场景，召回率较低但准确率高：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-string">"中华人民共和国宪法"</span> → [<span class="hljs-string">"中华人民共和国"</span>, <span class="hljs-string">"宪法"</span>]
</code></pre>
<p><strong>ik_max_word模式</strong>（细粒度分词）适合召回优先场景，召回率高但可能包含无关结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-string">"中华人民共和国宪法"</span> → [<span class="hljs-string">"中华人民共和国"</span>, <span class="hljs-string">"中华人民"</span>, <span class="hljs-string">"中华"</span>, <span class="hljs-string">"华人"</span>, <span class="hljs-string">"人民共和国"</span>, <span class="hljs-string">"人民"</span>, <span class="hljs-string">"共和国"</span>, <span class="hljs-string">"共和"</span>, <span class="hljs-string">"国"</span>, <span class="hljs-string">"宪法"</span>]
</code></pre>
<p><strong>IK分词器配置示例</strong>：</p>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-comment">&lt;!-- IK Analyzer 扩展配置 --&gt;</span><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">properties</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"ext_dict"</span>&gt;</span>custom_words.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span>    <span class="hljs-comment">&lt;!-- 自定义扩展词典 --&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"ext_stopwords"</span>&gt;</span>stop_words.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span> <span class="hljs-comment">&lt;!-- 自定义停用词 --&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<p>通过扩展词典可以添加领域专有名词，提升专业文本的分词效果</p>
<h3 data-id="heading-11">3.3 多语言混合场景的分词策略</h3>
<p>在实际应用中，经常遇到中英文混合、拼音匹配等复杂场景，需要采用组合分词策略：</p>
<p><strong>中英文混合分词</strong>：使用IK分词器配合英文处理能力，确保中英文术语都能正确识别。</p>
<p><strong>拼音分词集成</strong>：为重要字段同时配置拼音分词器，支持拼音搜索：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"product_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ik_max_word"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>    <span class="hljs-attr">"pinyin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>       <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pinyin"</span>    <span class="hljs-punctuation">}</span>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>同义词扩展</strong>：配置同义词过滤器，提升搜索召回率：</p>
<pre><code class="hljs language-css" lang="css">  "<span class="hljs-attribute">filter</span>": {  "my_synonyms": {    "type": <span class="hljs-string">"synonym"</span>,    <span class="hljs-string">"synonyms"</span>: [      <span class="hljs-string">"手机, 电话, 移动电话"</span>,      <span class="hljs-string">"电脑, 计算机, 笔记本"</span>    ]  }}
</code></pre>
<h2 data-id="heading-12">4 三者协同：搜索质量的影响路径分析</h2>
<h3 data-id="heading-13">4.1 搜索质量的全链路影响因素</h3>
<p>搜索质量的好坏受到从数据接入到结果返回的全链路影响，其中倒排索引、映射和分词器在各个环节发挥关键作用：</p>
<p><strong>数据摄入阶段</strong>：映射决定字段如何被解析，分词器决定文本如何被切分，倒排索引决定词项如何被存储。</p>
<p><strong>查询处理阶段</strong>：查询词经过相同的分词处理，确保查询与索引的一致性；倒排索引提供高效的词项查找能力。</p>
<p><strong>结果排序阶段</strong>：倒排索引中存储的词频、位置等信息为相关性评分提供基础数据。</p>
<h3 data-id="heading-14">4.2 典型问题与解决方案</h3>
<p><strong>搜索召回率低</strong>通常由过度激进的分词策略导致。解决方案包括：使用细粒度分词模式（ik_max_word）、合理配置同义词、优化停用词列表。</p>
<p><strong>搜索准确率低</strong>往往因分词粒度太细或同义词过度扩展引起。解决方案包括：使用粗粒度分词模式（ik_smart）、调整相关性评分权重、完善同义词规则。</p>
<p><strong>搜索性能差</strong>可能与倒排索引过大或映射设计不合理有关。解决方案包括：合理配置索引选项、使用多字段类型避免全文本搜索、优化分片大小。</p>
<h3 data-id="heading-15">4.3 实战调优案例：电商搜索系统优化</h3>
<p><strong>问题场景</strong>：某电商平台商品搜索存在结果不相关、拼音搜索不支持、性能瓶颈等问题。</p>
<p><strong>优化方案</strong>：</p>
<ol>
<li>1. <strong>映射重构</strong>：为商品名字段配置多字段映射，同时支持中文分词、精确匹配和拼音搜索</li>
<li>2. <strong>分词优化</strong>：结合IK分词器与自定义词典，添加品牌名和新品类的专有名词</li>
<li>3. <strong>索引优化</strong>：调整倒排索引的索引选项，对价格等数值字段使用doc_values提升聚合性能</li>
</ol>
<p><strong>优化结果</strong>：搜索准确率提升35%，拼音搜索支持度100%，搜索响应时间减少60%。</p>
<h2 data-id="heading-16">5 性能与质量平衡的艺术</h2>
<h3 data-id="heading-17">5.1 索引性能与搜索质量的权衡</h3>
<p>在Elasticsearch中，性能与质量需要谨慎平衡。过度追求搜索质量可能导致索引性能下降，而过度优化索引速度可能影响搜索准确性。</p>
<p><strong>索引优化策略</strong>：</p>
<ul>
<li>• 批量文档写入，减少索引提交频率</li>
<li>• 优化刷新间隔（refresh_interval），平衡近实时性与写入吞吐量</li>
<li>• 合理配置分片数量和大小，避免大量小分片或过大大分片</li>
</ul>
<p><strong>搜索优化策略</strong>：</p>
<ul>
<li>• 使用filter上下文缓存频繁使用的过滤条件</li>
<li>• 避免通配符查询，特别是前导通配符（如*abc）</li>
<li>• 使用异步搜索处理复杂聚合查询</li>
</ul>
<h3 data-id="heading-18">5.2 监控与持续优化</h3>
<p>建立完善的监控体系是持续优化搜索质量的基础。关键监控指标包括：</p>
<p><strong>索引性能指标</strong>：索引延迟、索引吞吐量、合并操作频率<br/>
<strong>搜索质量指标</strong>：查询延迟、命中率、首条结果点击率<br/>
<strong>系统资源指标</strong>：堆内存使用率、磁盘I/O、CPU利用率</p>
<p>定期进行搜索质量评估，通过A/B测试对比不同分词策略或评分公式的效果，实现数据驱动的持续优化。</p>
<h2 data-id="heading-19">总结</h2>
<p>Elasticsearch的搜索质量优化是一个系统工程，倒排索引、映射设计和分词器分别从数据结构、数据模型和数据处理的维度影响搜索效果。</p>
<p><strong>倒排索引</strong>是搜索性能的基石，其高效的数据结构使毫秒级搜索成为可能。<strong>映射设计</strong>决定了数据的存储和索引方式，合理的映射是高效搜索的前提。<strong>分词器</strong>直接影响搜索的召回率和准确率，特别是对于中文等复杂语言。</p>
<p>在实际应用中，需要根据具体业务场景平衡搜索质量与系统性能，建立持续监控和优化机制。只有深入理解这三者的工作原理和相互影响，才能构建出既快又准的搜索系统。</p>
<p><strong>📚 下篇预告</strong><br/>
《ES性能与可用性——分片、副本、路由与聚合的调度逻辑与成本》—— 我们将深入探讨：</p>
<ul>
<li>• 🎯 <strong>分片策略</strong>：数据分布、读写负载与水平扩展的平衡之道</li>
<li>• 🔄 <strong>副本机制</strong>：高可用性保障与读取吞吐量的提升方案</li>
<li>• 🧩 <strong>路由优化</strong>：请求分发、负载均衡与故障转移的智能逻辑</li>
<li>• 📊 <strong>聚合性能</strong>：大数据集统计分析与实时可视化的成本控制</li>
<li>• ⚖️ <strong>资源权衡</strong>：存储成本、计算开销与查询延迟的平衡艺术</li>
</ul>
<p><strong>点击关注，掌握Elasticsearch集群调优的核心方法论！</strong></p>
<blockquote>
<p><strong>今日行动建议</strong>：</p>
<ol>
<li>1. 分析现有索引的映射设计，识别字段类型使用不当的情况</li>
<li>2. 评估当前分词策略对搜索质量的影响，针对核心业务场景进行优化</li>
<li>3. 检查倒排索引大小与查询模式，优化索引配置提升查询性能</li>
<li>4. 建立搜索质量监控体系，定期评估召回率与准确率指标</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java并发编程（juc理论篇）]]></title>    <link>https://juejin.cn/post/7588001624905269267</link>    <guid>https://juejin.cn/post/7588001624905269267</guid>    <pubDate>2025-12-26T15:20:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624905269267" data-draft-id="7588007285546434566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java并发编程（juc理论篇）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T15:20:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ihgry"/> <meta itemprop="url" content="https://juejin.cn/user/3210229685954718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java并发编程（juc理论篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3210229685954718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ihgry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T15:20:38.000Z" title="Fri Dec 26 2025 15:20:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">CAS</h4>
<ul>
<li>CAS(Compare And Swap)，处理器会比较当前内存地址上的值 和 线程中变量的值（预期值）是否相等，如果相等则替换内存地址上的值为新值，如果不相等则不更新，硬件层面上支持使用一条指令来实现上面的操作，x86中是<code>cmpxchgl</code>指令</li>
<li>CAS操作不涉及线程上下文切换，并且不使用锁，会提高系统的并发性</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d3cd7260f6a47c699781a44e1e95cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=mRlEYponi%2F6JG5tch69PoEwjA9I%3D" alt="CAS总线.jpg" width="50%" loading="lazy"/></p>
<ul>
<li>
<p><code>ABA问题</code>：一个线程将变量A改为了变量B，之后又改为了变量A，另一个线程在执行CAS操作时会认为该变量没有发生变化，可能会导致错误。解决方案：添加版本号进行对比，可以使用<code>AtomicStampedReference</code>类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-number">100</span>, <span class="hljs-number">66</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-comment">// 获取当前的引用值和时间戳</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> atomicStampedReference.getStamp();
    <span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> atomicStampedReference.getReference();

    <span class="hljs-comment">// 修改引用值</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> atomicStampedReference.compareAndSet(value, value + <span class="hljs-number">10</span>, stamp, stamp + <span class="hljs-number">1</span>);
    System.out.println(<span class="hljs-string">"result = "</span> + result);

    <span class="hljs-comment">// 输出最终的值</span>
    System.out.println(<span class="hljs-string">"Final value = "</span> + atomicStampedReference.getReference());
    System.out.println(<span class="hljs-string">"Final stamp = "</span> + atomicStampedReference.getStamp());
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-1">Synchorized</h4>
<ul>
<li><code>synchorized</code>修饰实例方法时，锁对象是当前的实例对象；<code>synchorized</code>修饰静态方法时，锁对象是当前的class类对象；<code>synchorized</code>作用于代码块时，锁对象是括号里面的对象</li>
<li><code>synchorized</code>是可重入锁，一个线程可以重复获取到该锁，每获取一次锁，计数器加一，释放锁时，计数器减一，直到计数器为0，锁才会真正释放</li>
<li><code>synchronized</code>修饰方法时，会在方法的访问标志位中增加一个<code>ACC_SYNCHORIZED</code>标志，当线程访问该方法时，如果包含该标志位，就要获得该方法对应的对象的监视器锁才能执行该方法</li>
<li><code>synchronized</code>修饰代码块时，会在代码块的前后插入<code>monitorenter</code>和<code>monitorexit</code>字节码指令</li>
</ul>
<p>锁升级过程：</p>
<ul>
<li>在没有锁竞争的情况下，一个线程来加锁，JVM会向锁对象的对象头中写入该线程id (这时候的锁叫<code>偏向锁</code>)，后续该线程再进入该锁时，无需进行额外的同步操作</li>
<li>在锁轻度竞争的时候，会升级为<code>轻量级锁</code>，JVM会在当前线程中创建一个栈帧，通过CAS操作将这个栈帧的地址写入对象头中，如果成功表示该线程获取到了锁，如果失败则表示其他线程已经持有该锁，此时会升级为重量级锁</li>
<li>当锁竞争激烈时，JVM会升级为重量级锁，<code>synchorized</code>修改代码块时，线程会尝试获取monitor对象的所有权，抢到了就是成功获取到锁，抢不到线程就会阻塞，等待重新获取锁</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9a95149fda49acbb3b3c05a0aa4e2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=m5QQqowuzyac%2BmkEKZxVG2PDUX0%3D" alt="对象头.jpg" width="70%" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a40f4e7f55406bb80d018171ddd2fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=FTI0cqXoBBx4Waqaa%2B4pl6HKu2w%3D" alt="锁栈帧.jpg" width="50%" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12864ed5a0af4fa193a2a553a208cab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=jB83O5iCAK1kU1EHu66Z4hcza7w%3D" alt="锁膨胀" width="50%" loading="lazy"/></p>
<p>Synchorized和ReentrantLock</p>
<ul>
<li><code>synchorized</code>和<code>ReentrantLock</code> 都是可重入锁</li>
<li><code>synchorized</code>是非公平锁，不支持设置超时时间，不支持条件判断，不需要手动释放锁</li>
<li><code>ReentrantLock</code>既可以是非公平锁也可以是公平锁（默认是非公平锁），允许设置获取锁的超时时间，可以通过<code>lock.Condition</code>对象将不满足条件的线程加入到阻塞队列中</li>
</ul>
<h4 data-id="heading-2">ThreadLocal</h4>
<ul>
<li>
<p>基本使用</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;User&gt; CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;User&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CONTEXT.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUser</span><span class="hljs-params">(User user)</span> {
        CONTEXT.set(user);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
        CONTEXT.remove();
    }
}
</code></pre>
</li>
<li>
<p>每个线程内部维护了一个<code>ThreadLocalMap</code>对象，<code>ThreadLocalMap</code>以<code>ThreadLocal</code>为key，线程变量副本为value</p>
</li>
<li>
<p><code>ThreadLocalMap</code>中的key是弱引用，之所以不是强引用是因为所使用的线程往往是线程池中的线程，线程一般不会被销毁，对<code>ThreadLocal</code>的引用就会一直存在，导致内存释放不掉</p>
</li>
<li>
<p>最佳实践：</p>
<ul>
<li>存储用户登录信息，让每个线程有独立的用户上下文</li>
<li>管理数据库链接，将一个数据库连接放入ThreadLocal中，在需要使用数据库连接的地方直接从ThreadLocal获取</li>
</ul>
</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87e0d298116b48f0868df6b9bae173bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=RYhUF9x9QLPH1Q1eWOpzs11J5AY%3D" alt="Thread.jpg" width="50%" loading="lazy"/></p>
<h4 data-id="heading-3">Volatile</h4>
<ul>
<li>
<p><code>volatile</code>可以保证可见性，当一个线程修改了<code>volatile</code>变量的值后，新值会立即被刷新到主内存中，其他线程在读取该变量时可以立即获取到最新的值，避免由于缓存一致性问题导致 ”看见“旧值的现象</p>
</li>
<li>
<p><code>volatile</code>底层会加一个<code>lock</code>前缀指令进行总线锁定，总线监听到修改了共享数据后，会让其他处理器中的缓存更新或失效</p>
</li>
<li>
<p><code>volatile</code>可以禁止 jvm 指令重排，保证在多线程环境下也能正常运行</p>
<p>正常情况：1. 为对象分配内存，2. 初始化，3. 将对象引用指向对应内存地址</p>
<p>指令重排可能变成1 3 2，这样可能会发生问题</p>
</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc75ac7c66f64437b9944454bac221e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=UU3LL7jAudgBGLMXXBikk%2BBH0ks%3D" alt="1.png" width="50%" loading="lazy"/></p>
<h4 data-id="heading-4">AQS</h4>
<ul>
<li>AQS是一个抽象类，内部封装了线程 加锁、解锁、入队、出队的一些方法，提供给其他juc锁使用</li>
<li>它内部通过维护一个共享变量<code>state</code>和先进先出<code>FIFO</code>等待队列来控制并发线程，在独占锁中，<code>state</code>为0表示未被占用，1表示已被占用，当线程获取资源失败时，会被加入到AQS的等待队列中</li>
<li>基于AQS实现的类有<code>ReentrantLock</code>, <code>CountDownLatch</code>, <code>Semaphore</code>等</li>
</ul>
<h4 data-id="heading-5">其他</h4>
<p>死锁：两个线程都想获取对方已经拥有的锁，避免死锁的方法：</p>
<ul>
<li>避免在一个锁的代码块中再次尝试获取另一个锁</li>
<li>使用尝试获取锁的方法，比如<code>ReentrantLock</code>的<code>trylock</code>方法，<code>Semaphore</code>的<code>tryAcquire</code>方法，如果获取不到使用其他方案</li>
<li>减小锁的控制范围</li>
</ul>
<p>保证线程安全的方式</p>
<ul>
<li>同步锁：<code>synchorized</code>、<code>ReentrantLock</code></li>
<li>原子操作类：<code>AtomicInteger</code>、<code>AtomicReference</code></li>
<li>线程安全的容器：<code>ConcurrentHashMap</code>等，避免手动加锁</li>
<li>使用局部变量</li>
</ul>
<p>一个线程被启动两次，会发生什么：</p>
<ul>
<li>线程一旦运行就不会回到初始状态，会抛出<code>IllegalThreadStateException</code>异常</li>
</ul>
<p>上下文切换：</p>
<ul>
<li>暂停一个线程的处理，并将CPU寄存器中该线程的数据存储在内存中</li>
<li>从内存中获取下一个线程的上下文，并在CPU的寄存器中恢复它</li>
<li>返回到程序计数器指示的位置 继续执行</li>
</ul>
<p>并发和并行：</p>
<ul>
<li>并发：线程轮流使用cpu的做法称为并发</li>
<li>并行：多个cpu同时在调度线程执行任务</li>
</ul>
<p>原子性、可见性、有序性</p>
<ul>
<li>原子性：一组操作要么全部执行成功，要么全部不执行</li>
<li>可见性：一个线程修改共享变量的值后，其他线程能够立即看到这个修改后的值</li>
<li>有序性：程序的执行顺序和代码的先后顺序一致，但是多线程环境下，编译器会对指令进行重排序，进而出现并发问题</li>
</ul>
<p>指令重排：</p>
<ul>
<li>编译器和处理器为了优化性能，对指令执行顺序进行调整，指令重排类型包括：编译器重排和cpu重排。为了避免多线程之间操作出现不同步现象，可以使用<code>volatile</code>和<code>synchorized</code>等来限制这种行为</li>
</ul>
<h4 data-id="heading-6">相关文章</h4>
<ul>
<li>CAS：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FAJECfbdA" target="_blank" title="https://note.youdao.com/s/AJECfbdA" ref="nofollow noopener noreferrer">note.youdao.com/s/AJECfbdA</a></li>
<li>ThreadLocal：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2F7pvkie8N" target="_blank" title="https://note.youdao.com/s/7pvkie8N" ref="nofollow noopener noreferrer">note.youdao.com/s/7pvkie8N</a></li>
<li>CPU缓存架构：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FALicPbhV" target="_blank" title="https://note.youdao.com/s/ALicPbhV" ref="nofollow noopener noreferrer">note.youdao.com/s/ALicPbhV</a></li>
<li>JUC并发工具类：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FdbBcYl4a" target="_blank" title="https://note.youdao.com/s/dbBcYl4a" ref="nofollow noopener noreferrer">note.youdao.com/s/dbBcYl4a</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现划词效果]]></title>    <link>https://juejin.cn/post/7587998744294768646</link>    <guid>https://juejin.cn/post/7587998744294768646</guid>    <pubDate>2025-12-26T10:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294768646" data-draft-id="7587392473851805742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现划词效果"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T10:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="june18"/> <meta itemprop="url" content="https://juejin.cn/user/1011206428561639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现划词效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206428561639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    june18
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:41:11.000Z" title="Fri Dec 26 2025 10:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近做了一个划词的需求，想和大家分享一下。划词在富文本编辑器里比较常用，效果图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0eab5eec4d34614bd694046415016a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=FgxGXQtTGDzxMI%2BnypfoIWsLr68%3D" alt="划词效果" loading="lazy"/></p>
<p>本篇文章将一步一步带大家实现这个效果。</p>
<h2 data-id="heading-0">实现字数统计</h2>
<h3 data-id="heading-1">前置知识</h3>
<h4 data-id="heading-2">window.getSelection</h4>
<p><code>window.getSelection</code> 可获取选中文本信息和选择内容，示例代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
  <span class="hljs-keyword">if</span> (selection) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'selection'</span>, selection)
    <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(selectedText);
  }
});
</code></pre>
<p>执行结果截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db7ea8fbc6b84e929481a0e64fcb6c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=XhHbZgaVGNb0V%2F675o6tUnsc%2BQc%3D" alt="window.getSelection" loading="lazy"/></p>
<h3 data-id="heading-3">实现输入框</h3>
<p>主组件 <code>TextCustom</code>，包括两个组件：输入框和浮动工具栏。
这里的输入框是通过 <code>div</code> 元素模拟的，实现起来也很简单，只需要为 <code>div</code> 添加 <code>contentEditable</code> 属性 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 模拟输入框 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span> // <span class="hljs-attr">后面会用</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span> // <span class="hljs-attr">suppressContentEditableWarning</span> <span class="hljs-attr">是</span> <span class="hljs-attr">React</span> <span class="hljs-attr">框架中的一个特殊属性</span>，<span class="hljs-attr">用于</span>‌<span class="hljs-attr">抑制</span>‌<span class="hljs-attr">contentEditable</span> <span class="hljs-attr">元素触发的常见警告</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-4">实现浮动工具栏组件</h3>
<h4 data-id="heading-5">浮动工具栏组件实现</h4>
<p>浮动工具栏组件是通过固定定位实现的，工具栏的位置是跟随选中文本的位置改变而改变的，主要属性是 <code>top</code> 和 <code>left</code>，默认值都先设置成 0。</p>
<p>浮动工具栏组件的内容是选中文本的字数统计，先硬编码成“x 字”。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>, // <span class="hljs-attr">在选中文本上方显示</span>
        <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, // <span class="hljs-attr">居中显示</span>
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)", // <span class="hljs-attr">微调水平位置</span>
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        📝 x 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 data-id="heading-6">引入到主组件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 模拟输入框 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span> // <span class="hljs-attr">后面会用</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span> // <span class="hljs-attr">suppressContentEditableWarning</span> <span class="hljs-attr">是</span> <span class="hljs-attr">React</span> <span class="hljs-attr">框架中的一个特殊属性</span>，<span class="hljs-attr">用于</span>‌<span class="hljs-attr">抑制</span>‌<span class="hljs-attr">contentEditable</span> <span class="hljs-attr">元素触发的常见警告</span>
      /&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-7">实现自定义 hook</h3>
<p>封装自定义 hook，可命名为 <code>useTextSelection</code>，入参是输入框 id，返回 selection 和 toolbarRef。
其中 selection 是用来获取文本选择信息，包括选中文本的位置和选中的文本内容；toolbarRef 是工具栏的引用，后面的鼠标事件会用到，大概结构如下。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-comment">// 存储文本选择信息</span>
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互，比如点击工具栏</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     * 当用户在页面上选择文本时触发
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>(); <span class="hljs-comment">// 获取选中文本的位置和尺寸</span>

        <span class="hljs-comment">// 获取选中文本的锚点节点（选择的起始位置）</span>
        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-comment">// 获取目标编辑器元素</span>
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,        <span class="hljs-comment">// 选中文本的位置信息</span>
            <span class="hljs-attr">selectedText</span>: selectedText, <span class="hljs-comment">// 选中的文本内容</span>
          });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     * 用于检测用户是否点击了工具栏区域
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">MouseEvent</span>} <span class="hljs-variable">e</span> - 鼠标事件对象
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 用户正在与工具栏交互</span>
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 用户点击了工具栏外部</span>
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     * 用户完成选择操作后，延迟检查选择内容
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟 100ms 执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 如果用户没有与工具栏交互，处理选择变化</span>
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     * 当用户点击工具栏和编辑器外部时，隐藏工具栏
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">MouseEvent</span>} <span class="hljs-variable">e</span> - 鼠标事件对象
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏外部</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-comment">// 检查点击是否也发生在编辑器外部</span>
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-comment">// 重置选择信息，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange); <span class="hljs-comment">// 监听文本选择变化</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown); <span class="hljs-comment">// 监听鼠标按下</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp); <span class="hljs-comment">// 监听鼠标抬起</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside); <span class="hljs-comment">// 监听外部点击</span>

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target]); <span class="hljs-comment">// 依赖项：当 target 变化时重新运行 effect</span>

  <span class="hljs-keyword">return</span> {
    selection,    <span class="hljs-comment">// 当前的选择信息</span>
    toolbarRef,   <span class="hljs-comment">// 工具栏的 ref 引用</span>
  };
}
</code></pre>
<p>主组件修改如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息和工具栏引用</span>
  <span class="hljs-keyword">const</span> { selection, toolbarRef } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.editor}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>浮动工具栏修改如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>, // <span class="hljs-attr">在选中文本上方显示</span>，<span class="hljs-attr">65</span> <span class="hljs-attr">不是固定的</span>，<span class="hljs-attr">可以自行调整</span>
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>, // <span class="hljs-attr">居中显示</span>
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)", // <span class="hljs-attr">微调水平位置</span>
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h2 data-id="heading-8">实现加粗</h2>
<h3 data-id="heading-9">前置知识</h3>
<h4 data-id="heading-10">document.execCommand</h4>
<p><code>document.execCommand</code> 可对选中文本进行操作，比如加粗、斜体、下划线等，举个简单的例子。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>文本编辑器示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
   <span class="hljs-selector-class">.editor</span> {
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">min-height</span>: <span class="hljs-number">200px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor"</span>&gt;</span>
    请在这里输入文本，然后选中一部分文本并点击相应的按钮。
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleBold()"</span>&gt;</span>加粗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleItalic()"</span>&gt;</span>斜体<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleUnderline()"</span>&gt;</span>下划线<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBold</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleItalic</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUnderline</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df031f24e0f641e6a1d8819ecd12c024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=RyYPGawTLaqM%2B7EMAfiPCU0ofk0%3D" alt="文本编辑器示例" loading="lazy"/></p>
<h4 data-id="heading-11">document.queryCommandState("bold")</h4>
<p><code>document.queryCommandState("bold")</code> 可获取加粗状态，返回布尔值。当选择的文本，只有部分加粗时也会返回 true。</p>
<h3 data-id="heading-12">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isBoldActive</code> 和 <code>handleBoldClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    handleBoldClick 
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-13">修改浮动工具栏</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  isBoldActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-14">修改自定义 Hook</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前加粗状态</span>
          <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());  <span class="hljs-comment">// 回显加粗使用</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
  }, [getBoldState]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-15">实现斜体</h2>
<p>加粗理解了，斜体就简单了，流程是一模一样的。</p>
<h3 data-id="heading-16">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isItalicActive</code> 和 <code>handleItalicClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    handleBoldClick,
    handleItalicClick
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-17">修改浮动工具栏</h3>
<p>增加斜体按钮。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-18">修改自定义 Hook</h3>
<p>主要有两处改动：</p>
<ol>
<li>封装了 <code>updateFormattingStates</code> 函数用于更新所有格式化状态，包括加粗和斜体。</li>
<li>增加处理斜体操作。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
  }, [getBoldState, getItalicState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-19">实现下划线</h2>
<h3 data-id="heading-20">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isUnderlineActive</code> 和 <code>handleUnderlineClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-21">修改浮动工具栏</h3>
<p>增加下划线按钮。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-22">修改自定义 Hook</h3>
<p>主要有两处改动：</p>
<ol>
<li>增加获取下划线状态</li>
<li>增加处理下划线操作</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
  }, [getBoldState, getItalicState, getUnderlineState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-23">实现字号</h2>
<h3 data-id="heading-24">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>fontSize</code> 和 <code>handleFontSizeChange</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    fontSize,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
    handleFontSizeChange,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">onFontSizeChange</span>=<span class="hljs-string">{handleFontSizeChange}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
        <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{fontSize}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-25">修改浮动工具栏</h3>
<p>主要增加字号选择器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  onFontSizeChange,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
  fontSize = <span class="hljs-string">"3"</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 字号选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onFontSizeChange &amp;&amp; onFontSizeChange(e.target.value, range)}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
        style={{
          background: "#999",
          color: "white",
          border: "1px solid #999",
          borderRadius: "4px",
          padding: "6px 10px",
          cursor: "pointer",
          fontSize: "12px",
          width: "90px",
          appearance: "auto",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>12px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>14px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"3"</span>&gt;</span>16px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"4"</span>&gt;</span>18px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"5"</span>&gt;</span>24px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6"</span>&gt;</span>32px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7"</span>&gt;</span>48px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

      {/* 颜色选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onColorChange &amp;&amp; onColorChange(e.target.value, range)}
        title="文字颜色"
        style={{
          width: "36px",
          height: "36px",
          border: "2px solid #4a627a",
          borderRadius: "6px",
          cursor: "pointer",
          padding: "0",
          backgroundColor: color || "#ffffff",
        }}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-26">修改自定义 Hook</h3>
<p>字号和后面的颜色都是通过增加嵌套 <code>span</code> 标签实现的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"3"</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 获取当前选择的字号</span>
  <span class="hljs-keyword">const</span> getFontSizeState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找字体大小</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedFontSize = computedStyle.<span class="hljs-property">fontSize</span>;

        <span class="hljs-keyword">if</span> (computedFontSize) {
          <span class="hljs-keyword">const</span> sizeInPx = <span class="hljs-built_in">parseInt</span>(computedFontSize);
          <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">42</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"7"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">28</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"6"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">22</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"5"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">17</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"4"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">15</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">13</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"2"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span>;
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
  }, [target]);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
    <span class="hljs-title function_">setFontSize</span>(<span class="hljs-title function_">getFontSizeState</span>());
  }, [getBoldState, getItalicState, getUnderlineState, getFontSizeState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 设置字体大小</span>
  <span class="hljs-keyword">const</span> setFontSizeCommand = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    <span class="hljs-keyword">const</span> sizeMap = {
      <span class="hljs-string">"1"</span>: <span class="hljs-string">"12px"</span>,
      <span class="hljs-string">"2"</span>: <span class="hljs-string">"14px"</span>,
      <span class="hljs-string">"3"</span>: <span class="hljs-string">"16px"</span>,
      <span class="hljs-string">"4"</span>: <span class="hljs-string">"18px"</span>,
      <span class="hljs-string">"5"</span>: <span class="hljs-string">"24px"</span>,
      <span class="hljs-string">"6"</span>: <span class="hljs-string">"32px"</span>,
      <span class="hljs-string">"7"</span>: <span class="hljs-string">"48px"</span>,
    };

    span.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = sizeMap[sizeValue] || <span class="hljs-string">"16px"</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查选择范围是否已折叠（即没有选中文本，只有一个光标位置）</span>
      <span class="hljs-comment">// 如果是折叠状态，不执行字体大小设置操作</span>
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      <span class="hljs-comment">// 清除当前选择，然后重新选中刚刚插入的span元素内容</span>
      <span class="hljs-comment">// 这样用户可以继续对同一段文本进行其他操作</span>
      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置字体大小失败:"</span>, error);
    }

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">setFontSize</span>(sizeValue);
  }, []);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理字号变化</span>
  <span class="hljs-keyword">const</span> handleFontSizeChange = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">setFontSizeCommand</span>(sizeValue, range);
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [setFontSizeCommand, updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-27">实现颜色</h2>
<h3 data-id="heading-28">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>color</code> 和 <code>handleColorChange</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    fontSize,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
    handleFontSizeChange,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">onFontSizeChange</span>=<span class="hljs-string">{handleFontSizeChange}</span>
        <span class="hljs-attr">onColorChange</span>=<span class="hljs-string">{handleColorChange}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
        <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">color</span>=<span class="hljs-string">{color}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-29">修改浮动工具栏</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  onFontSizeChange,
  onColorChange,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
  fontSize = <span class="hljs-string">"3"</span>,
  color = <span class="hljs-string">"#000000"</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 字号选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onFontSizeChange &amp;&amp; onFontSizeChange(e.target.value, range)}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
        style={{
          background: "#999",
          color: "white",
          border: "1px solid #999",
          borderRadius: "4px",
          padding: "6px 10px",
          cursor: "pointer",
          fontSize: "12px",
          width: "90px",
          appearance: "auto",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>12px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>14px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"3"</span>&gt;</span>16px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"4"</span>&gt;</span>18px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"5"</span>&gt;</span>24px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6"</span>&gt;</span>32px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7"</span>&gt;</span>48px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

      {/* 颜色选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onColorChange &amp;&amp; onColorChange(e.target.value, range)}
        title="文字颜色"
        style={{
          width: "36px",
          height: "36px",
          border: "2px solid #4a627a",
          borderRadius: "6px",
          cursor: "pointer",
          padding: "0",
          backgroundColor: color || "#ffffff",
        }}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-30">修改自定义 Hook</h3>
<p>在看具体实现前，先认识一个 API，<code>document.createTreeWalke</code> 是一个用于 <strong>深度优先遍历 DOM 树</strong> 的接口。</p>
<p>基本语法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
  root,          <span class="hljs-comment">// 遍历的起始节点</span>
  whatToShow,    <span class="hljs-comment">// 要显示哪些类型的节点</span>
  filter         <span class="hljs-comment">// 可选的过滤器函数</span>
);
</code></pre>
<p>简单示例</p>
<pre><code class="hljs language-js" lang="js">&lt;div id=<span class="hljs-string">"container"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>文本<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>项目1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>项目2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
&lt;/div&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>);

<span class="hljs-comment">// 创建 TreeWalker： 从 container 开始，只遍历元素节点</span>
<span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
  container,
  <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_ELEMENT</span>,  <span class="hljs-comment">// 只显示元素节点</span>
  <span class="hljs-literal">null</span>  <span class="hljs-comment">// 不过滤</span>
);

<span class="hljs-keyword">const</span> nodes = [];
<span class="hljs-keyword">let</span> node;
<span class="hljs-keyword">while</span> (node = walker.<span class="hljs-title function_">nextNode</span>()) {
  nodes.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">tagName</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nodes); <span class="hljs-comment">// 输出: ["H1", "P", "SPAN", "UL", "LI", "LI"] 深度优先遍历顺序</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"3"</span>);
  <span class="hljs-keyword">const</span> [color, setColor] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"#000000"</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// RGB 转十六进制辅助函数</span>
  <span class="hljs-keyword">const</span> rgbToHex = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">rgb</span>) =&gt;</span> {
    <span class="hljs-comment">// 如果已经是十六进制格式，直接返回</span>
    <span class="hljs-keyword">if</span> (rgb.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"#"</span>)) <span class="hljs-keyword">return</span> rgb;

    <span class="hljs-comment">// 匹配 RGB 或 RGBA 格式：rgb(255, 255, 255) 或 rgba(255, 255, 255, 0.5)</span>
    <span class="hljs-keyword">const</span> match = rgb.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/</span>);
    <span class="hljs-keyword">if</span> (match) {
      <span class="hljs-keyword">const</span> r = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">1</span>]);
      <span class="hljs-keyword">const</span> g = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">2</span>]);
      <span class="hljs-keyword">const</span> b = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">3</span>]);

      <span class="hljs-comment">// 将 RGB 值转换为十六进制，并确保两位显示</span>
      <span class="hljs-keyword">return</span> (
        <span class="hljs-string">"#"</span> +
        r.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>) +
        g.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>) +
        b.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>)
      );
    }

    <span class="hljs-comment">// 无法解析的颜色，返回默认黑色</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;
  }, []);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 获取当前选择的字号</span>
  <span class="hljs-keyword">const</span> getFontSizeState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找字体大小</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedFontSize = computedStyle.<span class="hljs-property">fontSize</span>;

        <span class="hljs-keyword">if</span> (computedFontSize) {
          <span class="hljs-keyword">const</span> sizeInPx = <span class="hljs-built_in">parseInt</span>(computedFontSize);
          <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">42</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"7"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">28</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"6"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">22</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"5"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">17</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"4"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">15</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">13</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"2"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span>;
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
  }, [target]);

  <span class="hljs-comment">// 获取当前选择的颜色</span>
  <span class="hljs-keyword">const</span> getColorState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> commonAncestor = range.<span class="hljs-property">commonAncestorContainer</span>;

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找颜色</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedColor = computedStyle.<span class="hljs-property">color</span>;

        <span class="hljs-comment">// 检查颜色是否为有效值（非透明、非默认黑色）</span>
        <span class="hljs-keyword">if</span> (
          computedColor &amp;&amp;
          computedColor !== <span class="hljs-string">"rgba(0, 0, 0, 0)"</span> &amp;&amp;
          computedColor !== <span class="hljs-string">"transparent"</span> &amp;&amp;
          !computedColor.<span class="hljs-title function_">startsWith</span>(<span class="hljs-params"><span class="hljs-string">"rgba(0, 0, 0, "</span></span>)
        ) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">rgbToHex</span>(computedColor);
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 如果没有找到，检查选择范围内的元素</span>
    <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
      commonAncestor,
      <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_ELEMENT</span>,
      {
        <span class="hljs-attr">acceptNode</span>: <span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span>
          range.<span class="hljs-title function_">intersectsNode</span>(node)
            ? <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_ACCEPT</span>
            : <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_REJECT</span>,
      },
    );

    <span class="hljs-comment">// 当向上遍历找不到颜色时，它会深度遍历选择范围内的所有元素，找到第一个有效的文本颜色。</span>
    <span class="hljs-keyword">while</span> ((element = walker.<span class="hljs-title function_">nextNode</span>())) {
      <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
      <span class="hljs-keyword">const</span> computedColor = computedStyle.<span class="hljs-property">color</span>;

      <span class="hljs-keyword">if</span> (
        computedColor &amp;&amp;
        computedColor !== <span class="hljs-string">"rgba(0, 0, 0, 0)"</span> &amp;&amp;
        computedColor !== <span class="hljs-string">"transparent"</span> &amp;&amp;
        !computedColor.<span class="hljs-title function_">startsWith</span>(<span class="hljs-params"><span class="hljs-string">"rgba(0, 0, 0, "</span></span>)
      ) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">rgbToHex</span>(computedColor);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;
  }, [target, rgbToHex]);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
    <span class="hljs-title function_">setFontSize</span>(<span class="hljs-title function_">getFontSizeState</span>());
    <span class="hljs-title function_">setColor</span>(<span class="hljs-title function_">getColorState</span>());
  }, [getBoldState, getItalicState, getUnderlineState, getFontSizeState, getColorState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 设置字体大小</span>
  <span class="hljs-keyword">const</span> setFontSizeCommand = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    <span class="hljs-keyword">const</span> sizeMap = {
      <span class="hljs-string">"1"</span>: <span class="hljs-string">"12px"</span>,
      <span class="hljs-string">"2"</span>: <span class="hljs-string">"14px"</span>,
      <span class="hljs-string">"3"</span>: <span class="hljs-string">"16px"</span>,
      <span class="hljs-string">"4"</span>: <span class="hljs-string">"18px"</span>,
      <span class="hljs-string">"5"</span>: <span class="hljs-string">"24px"</span>,
      <span class="hljs-string">"6"</span>: <span class="hljs-string">"32px"</span>,
      <span class="hljs-string">"7"</span>: <span class="hljs-string">"48px"</span>,
    };

    span.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = sizeMap[sizeValue] || <span class="hljs-string">"16px"</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查选择范围是否已折叠（即没有选中文本，只有一个光标位置）</span>
      <span class="hljs-comment">// 如果是折叠状态，不执行字体大小设置操作</span>
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      <span class="hljs-comment">// 清除当前选择，然后重新选中刚刚插入的span元素内容</span>
      <span class="hljs-comment">// 这样用户可以继续对同一段文本进行其他操作</span>
      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置字体大小失败:"</span>, error);
    }

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">setFontSize</span>(sizeValue);
  }, []);

  <span class="hljs-comment">// 设置文本颜色</span>
  <span class="hljs-keyword">const</span> setTextColor = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">colorValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    span.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = colorValue;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置颜色失败:"</span>, error);
    }

    <span class="hljs-title function_">setColor</span>(colorValue);
  }, []);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理字号变化</span>
  <span class="hljs-keyword">const</span> handleFontSizeChange = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">setFontSizeCommand</span>(sizeValue, range);
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [setFontSizeCommand, updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[esp32 小智AI 项目]]></title>    <link>https://juejin.cn/post/7588001624904892435</link>    <guid>https://juejin.cn/post/7588001624904892435</guid>    <pubDate>2025-12-26T13:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624904892435" data-draft-id="7588001624904859667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="esp32 小智AI 项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T13:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端老爷推车"/> <meta itemprop="url" content="https://juejin.cn/user/2189882895381079"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            esp32 小智AI 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882895381079/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端老爷推车
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:16:27.000Z" title="Fri Dec 26 2025 13:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>#一、接入 MAX98357
MAX98357 是一款非常流行的 <strong>I2S 数字音频放大器模块</strong>，与 ESP32 搭配是制作数字音频项目的经典组合。控制它的核心在于：<strong>正确配置 ESP32 的 I2S 音频接口，并向其发送数字音频数据</strong>。为了方便你理解从代码到声音的完整流程，下图清晰地展示了控制 MAX98357 的核心工作流：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48e65f9bc65437090fcbcac182f893b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6ICB54i35o6o6L2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359787&amp;x-signature=h%2F25JA8UEjvSv3APRo2ddSe%2BdAo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-0">🔌 硬件连接（接线）</h4>
<p>连接非常简单，因为 MAX98357 使用标准的 I2S 接口：</p>













































<table><thead><tr><th>ESP32 引脚</th><th>MAX98357 引脚</th><th>作用</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td><strong>VIN</strong></td><td>电源（3.3V-5V均可，与ESP32共用3.3V最方便）</td></tr><tr><td><strong>GND</strong></td><td><strong>GND</strong></td><td>接地（必须共地）</td></tr><tr><td><strong>GPIO 25 (或其它)</strong></td><td><strong>DIN</strong></td><td><strong>串行数据输入</strong>，这是最重要的数据线。</td></tr><tr><td><strong>GPIO 26 (或其它)</strong></td><td><strong>BCLK</strong></td><td><strong>位时钟</strong>，用于同步每一位数据。</td></tr><tr><td><strong>GPIO 27 (或其它)</strong></td><td><strong>LRC</strong></td><td><strong>左右声道时钟</strong>，用于切换左右声道。</td></tr><tr><td>（可选）GPIO（如15）</td><td><strong>GAIN</strong></td><td>增益控制。<strong>不接时默认为高增益（15dB）</strong> 。如需低增益（9dB），将此脚接地。</td></tr><tr><td>（不连接）</td><td><strong>SD</strong></td><td>关断引脚，MAX98357 内部已下拉，正常工作时无需连接。</td></tr></tbody></table>
<blockquote>
<p><strong>引脚选择提示</strong>：ESP32 有多个 I2S 引脚，你可以使用上表的引脚，也可以使用其他支持 I2S 的引脚（如 GPIO 5, 17, 18, 19, 21, 22, 23 等），只要在代码中统一即可。</p>
</blockquote>
<h4 data-id="heading-1">🛠️ 软件配置与编程（PlatformIO）</h4>
<p>在 PlatformIO 项目中，最便捷的方法是使用一个优秀的音频库：<strong><code>AudioTools</code></strong>。</p>
<ol>
<li><strong>安装库</strong>：<br/>
在 PlatformIO 的 “Library Manager” 中搜索 <strong><code>AudioTools by pschatzmann</code></strong> 并安装。这个库几乎囊括了所有音频功能，非常适合入门。</li>
<li><strong>编写基础程序</strong>：<br/>
以下代码演示如何播放一个简单的 <strong>440Hz 正弦波（标准音A）</strong> ，这是测试音频系统的“Hello World”。</li>
</ol>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 + MAX98357 基础测试
 * 播放一个440Hz的正弦波
 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>

<span class="hljs-comment">// 1. 定义I2S输出接口，并指定引脚</span>
<span class="hljs-comment">// 参数解释：I2SStream(int data_pin, int clock_pin, int lr_pin)</span>
I2SStream i2s;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> data_pin = <span class="hljs-number">25</span>;  <span class="hljs-comment">// DIN 连接的GPIO</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> clock_pin = <span class="hljs-number">26</span>; <span class="hljs-comment">// BCLK 连接的GPIO</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> lr_pin = <span class="hljs-number">27</span>;    <span class="hljs-comment">// LRC 连接的GPIO</span>

<span class="hljs-comment">// 2. 定义音频信号源：一个440Hz的正弦波</span>
<span class="hljs-function">SineWaveGenerator&lt;<span class="hljs-type">int16_t</span>&gt; <span class="hljs-title">sineWave</span><span class="hljs-params">(<span class="hljs-number">32000</span>)</span></span>; <span class="hljs-comment">// 生成16位有符号整数格式的正弦波，振幅32000</span>
<span class="hljs-function">GeneratedSoundStream&lt;<span class="hljs-type">int16_t</span>&gt; <span class="hljs-title">sound</span><span class="hljs-params">(sineWave)</span></span>; <span class="hljs-comment">// 将正弦波包装成音频流</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(i2s, sound)</span></span>; <span class="hljs-comment">// 音频数据复制器：将声音源的数据复制到I2S输出</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  
  <span class="hljs-comment">// 3. 配置I2S音频参数</span>
  <span class="hljs-keyword">auto</span> config = i2s.<span class="hljs-built_in">defaultConfig</span>();
  config.pin_data = data_pin;
  config.pin_bck = clock_pin;
  config.pin_ws = lr_pin;
  config.sample_rate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 标准采样率</span>
  config.bits_per_sample = <span class="hljs-number">16</span>; <span class="hljs-comment">// 16位采样深度</span>
  config.channels = <span class="hljs-number">2</span>; <span class="hljs-comment">// 立体声</span>
  config.i2s_format = I2S_STD_FORMAT; <span class="hljs-comment">// 标准I2S格式</span>
  
  <span class="hljs-comment">// 4. 初始化I2S</span>
  i2s.<span class="hljs-built_in">begin</span>(config);
  
  <span class="hljs-comment">// 5. 配置正弦波参数：440Hz，采样率与I2S一致</span>
  sineWave.<span class="hljs-built_in">begin</span>(config.channels, config.sample_rate, <span class="hljs-number">440</span>);
  
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始播放 440Hz 正弦波（标准音A）..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 不断将生成的音频数据复制到I2S接口</span>
  copier.<span class="hljs-built_in">copy</span>();
}
</code></pre>
<h4 data-id="heading-2">🎵 播放实际音频文件（如WAV）</h4>
<p>要播放SD卡或SPIFFS中的音频文件，你需要：</p>
<ol>
<li><strong>安装额外库</strong>：在 PlatformIO 中安装 <strong><code>AudioCodecs by pschatzmann</code></strong>。</li>
<li><strong>准备音频文件</strong>：将其转换为 <strong>单声道或立体声、16位、采样率不超过44100Hz的WAV文件</strong>，并上传到ESP32的SPIFFS或SD卡中。</li>
</ol>
<p>以下是播放SPIFFS中<code>test.wav</code>文件的示例代码框架：</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSPIFFS.h"</span> <span class="hljs-comment">// SPIFFS音频源</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span> <span class="hljs-comment">// WAV解码器</span></span>

I2SStream i2s;
SPIFFSStream file; <span class="hljs-comment">// SPIFFS文件流</span>
WAVDecoder dec; <span class="hljs-comment">// WAV解码器</span>
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">decoder</span><span class="hljs-params">(&amp;i2s, &amp;dec)</span></span>; <span class="hljs-comment">// 解码后的音频流指向I2S</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(decoder, file)</span></span>; <span class="hljs-comment">// 将文件-&gt;解码-&gt;I2S</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  
  <span class="hljs-comment">// 初始化文件系统（需要先通过PlatformIO的“Upload Filesystem Image”上传文件）</span>
  <span class="hljs-keyword">if</span> (!SPIFFS.<span class="hljs-built_in">begin</span>()) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"SPIFFS初始化失败！"</span>);
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// 配置I2S（同上例，省略）</span>
  <span class="hljs-keyword">auto</span> i2sConfig = i2s.<span class="hljs-built_in">defaultConfig</span>();
  i2sConfig.pin_data = <span class="hljs-number">25</span>;
  <span class="hljs-comment">// ... 其他配置</span>
  i2s.<span class="hljs-built_in">begin</span>(i2sConfig);

  <span class="hljs-comment">// 配置音频流</span>
  file.<span class="hljs-built_in">begin</span>(<span class="hljs-string">"/test.wav"</span>); <span class="hljs-comment">// 打开文件</span>
  decoder.<span class="hljs-built_in">begin</span>(); <span class="hljs-comment">// 开始解码</span>

  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始播放WAV文件..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (copier.<span class="hljs-built_in">copy</span>()) {
    <span class="hljs-comment">// 正常播放中</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"播放结束或出错"</span>);
    <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>);
    <span class="hljs-comment">// 可在此循环播放或播放下一首</span>
  }
}
</code></pre>
<h4 data-id="heading-3">🔄 与之前的ST7789屏幕项目结合</h4>
<p>你可以轻松地将音频控制和屏幕显示结合在一个ESP32项目中，因为两者使用不同的硬件接口（I2S vs. SPI）且库不冲突。例如，在屏幕上显示当前播放的歌曲名、音量或音频频谱。只需将两部分的<code>setup()</code>和<code>loop()</code>逻辑合理整合即可。</p>
<h2 data-id="heading-4">接入 SD卡</h2>
<p>基于我们之前的讨论，以下是使用 <strong>ESP32 通过 SD 卡读取并播放 WAV 音频文件</strong> 的完整实现方案。这涵盖了硬件连接、PlatformIO 配置和可运行的代码。</p>
<h4 data-id="heading-5">📁 完整项目实现指南</h4>
<h5 data-id="heading-6">1. 硬件连接 (ESP32 + SD卡模块 + MAX98357)</h5>
<p>请确保你的硬件按此连接。<strong>电源稳定是关键</strong>，建议使用外部5V电源为音频部分独立供电，并与ESP32共地。</p>























































<table><thead><tr><th>ESP32 GPIO 引脚</th><th>SD 卡模块引脚</th><th>MAX98357 模块引脚</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td>VCC</td><td>VIN (可单独供电)</td></tr><tr><td><strong>GND</strong></td><td>GND</td><td>GND (<strong>必须共地</strong>)</td></tr><tr><td><strong>GPIO 23</strong></td><td>MOSI</td><td>--</td></tr><tr><td><strong>GPIO 19</strong></td><td>MISO</td><td>--</td></tr><tr><td><strong>GPIO 18</strong></td><td>SCK</td><td>--</td></tr><tr><td><strong>GPIO 5</strong> (示例)</td><td>CS (片选)</td><td>--</td></tr><tr><td><strong>GPIO 25</strong></td><td>--</td><td>DIN</td></tr><tr><td><strong>GPIO 26</strong></td><td>--</td><td>BCLK</td></tr><tr><td><strong>GPIO 27</strong></td><td>--</td><td>LRC</td></tr></tbody></table>
<h5 data-id="heading-7">2. PlatformIO 项目配置 (<code>platformio.ini</code>)</h5>
<p>创建或修改项目根目录下的 <code>platformio.ini</code> 文件。</p>
<p>ini</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[env:esp32-dev]</span>
<span class="hljs-attr">platform</span> = espressif32
<span class="hljs-attr">board</span> = esp32dev
<span class="hljs-attr">framework</span> = ardui<span class="hljs-literal">no</span>
<span class="hljs-attr">monitor_speed</span> = <span class="hljs-number">115200</span>

<span class="hljs-comment">; 核心依赖库</span>
<span class="hljs-attr">lib_deps</span> = 
    pschatzmann/ESP32-AudioTools @ ^1.0.8  <span class="hljs-comment"># 主音频库</span>
    pschatzmann/arduino-audio-tools @ ^1.1.9
    pschatzmann/arduino-audiocodecs @ ^1.0.6 <span class="hljs-comment"># WAV解码器</span>
    <span class="hljs-comment">; SD卡库已包含在框架中</span>

<span class="hljs-comment">; 优化构建</span>
<span class="hljs-attr">board_build.flash_mode</span> = dio
<span class="hljs-attr">build_flags</span> = 
    -Wl,-Teagle.flash.4m32m.ld
</code></pre>
<h5 data-id="heading-8">3. 主程序代码 (<code>src/main.cpp</code>)</h5>
<p>将以下代码复制到 <code>src/main.cpp</code> 中，并根据你的引脚定义进行修改。</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 SD卡 WAV音频播放器
 * 依赖：AudioTools库
 */</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSD.h"</span> <span class="hljs-comment">// SD卡音频源</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span>    <span class="hljs-comment">// WAV解码器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;SD.h&gt;</span>                      <span class="hljs-comment">// SD卡驱动</span></span>

<span class="hljs-comment">// ==================== 用户配置区域 ====================</span>
<span class="hljs-comment">// 1. SD卡引脚配置（根据实际接线修改！）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SD_CS_PIN    5   <span class="hljs-comment">// SD卡模块的片选引脚</span></span>

<span class="hljs-comment">// 2. I2S引脚配置（根据实际接线修改！）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_DIN_PIN  25  <span class="hljs-comment">// MAX98357的DIN</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_BCLK_PIN 26  <span class="hljs-comment">// MAX98357的BCLK</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_LRC_PIN  27  <span class="hljs-comment">// MAX98357的LRC</span></span>

<span class="hljs-comment">// 3. 音频文件设置</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span>* audioFilePath = <span class="hljs-string">"/test.wav"</span>; <span class="hljs-comment">// 放在SD卡根目录的测试文件</span>
<span class="hljs-comment">// ====================================================</span>

<span class="hljs-comment">// 创建音频对象</span>
I2SStream i2s;                 <span class="hljs-comment">// I2S输出流</span>
<span class="hljs-function">SDStream <span class="hljs-title">file</span><span class="hljs-params">(SD_CS_PIN)</span></span>;      <span class="hljs-comment">// SD卡文件流，传入CS引脚号</span>
WAVDecoder dec;                <span class="hljs-comment">// WAV解码器</span>
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">decoder</span><span class="hljs-params">(&amp;i2s, &amp;dec)</span></span>; <span class="hljs-comment">// 解码后管道连接到I2S</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(decoder, file)</span></span>;       <span class="hljs-comment">// 负责数据复制的“引擎”</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printAudioInfo</span><span class="hljs-params">(AudioInfo info)</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== 音频信息 ==="</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"采样率: %d Hz\n"</span>, info.sample_rate);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"声道数: %d\n"</span>, info.channels);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"位深度: %d-bit\n"</span>, info.bits_per_sample);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"================"</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">Serial</span>); <span class="hljs-comment">// 等待串口连接（仅用于调试）</span>
  <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n\nESP32 SD卡音频播放器启动..."</span>);

  <span class="hljs-comment">// === 第一步：初始化SD卡 ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"初始化SD卡..."</span>);
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SD</span>.<span class="hljs-built_in">begin</span>(SD_CS_PIN)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"失败！请检查："</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  1. SD卡是否插入？"</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  2. 引脚连接是否正确？"</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  3. SD卡格式是否为FAT32？"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) { <span class="hljs-comment">// 挂起</span>
      <span class="hljs-built_in">delay</span>(<span class="hljs-number">100</span>);
    }
  }
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"成功！"</span>);

  <span class="hljs-comment">// 可选：列出根目录文件</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"SD卡根目录内容："</span>);
  <span class="hljs-built_in">File</span> root = <span class="hljs-built_in">SD</span>.<span class="hljs-built_in">open</span>(<span class="hljs-string">"/"</span>);
  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">File</span> entry = root.<span class="hljs-built_in">openNextFile</span>()) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"  "</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(entry.<span class="hljs-built_in">name</span>());
    entry.<span class="hljs-built_in">close</span>();
  }
  root.<span class="hljs-built_in">close</span>();

  <span class="hljs-comment">// === 第二步：配置并初始化I2S ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"配置I2S音频接口..."</span>);
  <span class="hljs-keyword">auto</span> config = i2s.<span class="hljs-built_in">defaultConfig</span>();
  config.pin_data = I2S_DIN_PIN;
  config.pin_bck = I2S_BCLK_PIN;
  config.pin_ws = I2S_LRC_PIN;
  config.sample_rate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 初始采样率，解码后会根据文件自动调整</span>
  config.bits_per_sample = <span class="hljs-number">16</span>;
  config.channels = <span class="hljs-number">2</span>;
  config.i2s_format = I2S_STD_FORMAT;
  <span class="hljs-comment">// config.buffer_size = 1024; // 若出现爆音可尝试增大</span>
  <span class="hljs-comment">// config.buffer_count = 8;</span>

  <span class="hljs-keyword">if</span> (!i2s.<span class="hljs-built_in">begin</span>(config)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"I2S初始化失败！请检查引脚。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
  }
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"成功！"</span>);

  <span class="hljs-comment">// === 第三步：尝试打开并解码音频文件 ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"尝试打开文件: %s\n"</span>, audioFilePath);
  
  <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">begin</span>(audioFilePath)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"文件打开失败！请检查路径和文件名。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
  }

  <span class="hljs-comment">// 设置解码器输出信息回调（可选）</span>
  decoder.<span class="hljs-built_in">setInfoCallback</span>(printAudioInfo);
  
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始解码并播放..."</span>);
  decoder.<span class="hljs-built_in">begin</span>();

  <span class="hljs-comment">// 可选：设置音量（0.0静音 ~ 1.0最大）</span>
  <span class="hljs-comment">// i2s.setVolume(0.7);</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 核心：将文件数据复制到解码器，再送至I2S</span>
  <span class="hljs-keyword">if</span> (copier.<span class="hljs-built_in">copy</span>()) {
    <span class="hljs-comment">// 数据正在稳定传输中，可以在此添加播放状态指示（如点亮LED）</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 播放结束或发生错误</span>
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"播放结束。"</span>);
    
    <span class="hljs-comment">// 简单示例：等待3秒后重新播放</span>
    <span class="hljs-built_in">delay</span>(<span class="hljs-number">3000</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"重新播放..."</span>);
    
    <span class="hljs-comment">// 重置文件流到开始位置</span>
    file.<span class="hljs-built_in">begin</span>(audioFilePath);
    decoder.<span class="hljs-built_in">begin</span>();
  }
  
  <span class="hljs-comment">// 可以在此处加入其他控制逻辑，如按键检测切换歌曲</span>
}
</code></pre>
<h4 data-id="heading-9">🚀 如何运行</h4>
<ol>
<li><strong>准备SD卡</strong>：格式化为FAT32，将转换好的16位、单声道/立体声、44100Hz的WAV文件（如 <code>test.wav</code>）复制到<strong>根目录</strong>。</li>
<li><strong>连接硬件</strong>：按上述表格连接好所有线路，<strong>仔细检查电源和地线</strong>。</li>
<li><strong>上传代码</strong>：在VS Code中，点击PlatformIO底部的 <strong>✔️（编译）</strong> ，然后点击 <strong>➡️（上传）</strong>  按钮。</li>
<li><strong>查看日志</strong>：打开串口监视器（波特率115200），查看初始化状态和播放信息。</li>
</ol>
<h2 data-id="heading-10">接入 INMP 441 麦克风</h2>
<p>将 <strong>INMP441</strong> 数字麦克风模块连接到 <strong>ESP32</strong> 是进行高质量音频采集的经典方案。INMP441 是一款通过 <strong>I2S 接口</strong> 输出的底部进音 MEMS 麦克风，与 ESP32 的 I2S 外设完美兼容。</p>
<h4 data-id="heading-11">🔌 硬件连接</h4>
<p>INMP441 需要标准的 I2S 连接，但与之前的 MAX98357（从设备）不同，<strong>INMP441 工作在“主模式”</strong> ，这意味着它负责生成主时钟（BCLK）和左右时钟（LRCLK）。因此，连接方式有特定要求。</p>
<p>请按以下表格连接（这是最常见的接法）：</p>








































<table><thead><tr><th>ESP32 GPIO 引脚</th><th>INMP441 模块引脚</th><th>信号说明</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td><strong>VDD</strong></td><td>电源 (<strong>必须为 3.3V</strong>，5V会损坏麦克风)</td></tr><tr><td><strong>GND</strong></td><td><strong>GND</strong></td><td>接地</td></tr><tr><td><strong>GPIO 32</strong> (或其它)</td><td><strong>SD</strong></td><td><strong>串行数据输出</strong> (数据线，从麦克风到ESP32)</td></tr><tr><td><strong>GPIO 14</strong></td><td><strong>WS</strong></td><td><strong>字选择 (左右声道时钟)</strong> ，<strong>由麦克风输出给ESP32</strong></td></tr><tr><td><strong>GPIO 15</strong></td><td><strong>SCK</strong></td><td><strong>串行时钟 (位时钟)</strong> ，<strong>由麦克风输出给ESP32</strong></td></tr><tr><td>(可选) <strong>GPIO 13</strong></td><td><strong>L/R</strong></td><td>声道选择。<strong>接GND为左声道，接VDD为右声道</strong>。通常悬空或接地即可。</td></tr></tbody></table>
<blockquote>
<p><strong>关键说明</strong>：</p>
<ol>
<li><strong>时钟方向</strong>：INMP441 是“主设备”，<strong>SCK</strong> 和 <strong>WS</strong> 是它的<strong>输出</strong>，必须连接到 ESP32 的对应 I2S 输入引脚。ESP32 在此配置中作为“从设备”接收时钟和数据。</li>
<li><strong>引脚灵活性</strong>：上表中的 GPIO 32、14、15 是 ESP32 的默认 I2S 从设备接收引脚，推荐使用。理论上其他支持 I2S 的引脚也可用，但需要修改代码的引脚映射。</li>
<li><strong>电源</strong>：务必使用 3.3V 供电。</li>
</ol>
</blockquote>
<h4 data-id="heading-12">📦 PlatformIO 配置 (<code>platformio.ini</code>)</h4>
<p>继续使用强大的 <code>AudioTools</code> 库，它同样简化了录音流程。</p>
<p>ini</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[env:esp32-dev]</span>
<span class="hljs-attr">platform</span> = espressif32
<span class="hljs-attr">board</span> = esp32dev
<span class="hljs-attr">framework</span> = ardui<span class="hljs-literal">no</span>
<span class="hljs-attr">monitor_speed</span> = <span class="hljs-number">115200</span>

<span class="hljs-attr">lib_deps</span> = 
    pschatzmann/ESP32-AudioTools @ ^1.0.8
    pschatzmann/arduino-audio-tools @ ^1.1.9
</code></pre>
<h4 data-id="heading-13">💻 基础录音与串口绘图程序 (<code>src/main.cpp</code>)</h4>
<p>以下代码将初始化 INMP441，连续采集音频数据，并将原始数据通过串口发送。你可以用 Arduino IDE 或 PlatformIO 的串口绘图器查看波形。</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 + INMP441 基础录音测试
 * 将音频原始数据通过串口输出，可用于绘图器查看波形
 */</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>

<span class="hljs-comment">// ==================== 配置 ====================</span>
<span class="hljs-comment">// 定义I2S引脚 (根据你的实际连接调整！)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SD_IN   32  <span class="hljs-comment">// INMP441的SD -&gt; ESP32的GPIO 32</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_WS_IN   14  <span class="hljs-comment">// INMP441的WS -&gt; ESP32的GPIO 14</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SCK_IN  15  <span class="hljs-comment">// INMP441的SCK -&gt; ESP32的GPIO 15</span></span>

<span class="hljs-comment">// 定义音频参数</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> sampleRate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 采样率 (Hz)</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> bufferSize = <span class="hljs-number">1024</span>;   <span class="hljs-comment">// 缓冲区大小</span>

<span class="hljs-comment">// 创建I2S流对象用于输入（录音）</span>
I2SStream i2sInput;
<span class="hljs-type">int16_t</span> buffer[bufferSize]; <span class="hljs-comment">// 用于存储音频样本的缓冲区（16位有符号整数）</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printAudioInfo</span><span class="hljs-params">(AudioInfo info)</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== I2S麦克风初始化成功 ==="</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"采样率: %d Hz\n"</span>, info.sample_rate);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"声道数: %d\n"</span>, info.channels);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"位深度: %d-bit\n"</span>, info.bits_per_sample);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始采集音频..."</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"打开串口绘图器(Tools -&gt; Serial Plotter)查看波形。"</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">Serial</span>);
  <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>);

  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"启动 INMP441 麦克风测试..."</span>);

  <span class="hljs-comment">// 配置I2S输入参数</span>
  <span class="hljs-keyword">auto</span> i2sConfig = i2sInput.<span class="hljs-built_in">defaultConfig</span>(RX_MODE);
  i2sConfig.pin_data = I2S_SD_IN;
  i2sConfig.pin_ws = I2S_WS_IN;
  i2sConfig.pin_bck = I2S_SCK_IN;
  i2sConfig.sample_rate = sampleRate;
  i2sConfig.bits_per_sample = <span class="hljs-number">16</span>;
  i2sConfig.channels = <span class="hljs-number">1</span>;          <span class="hljs-comment">// INMP441 单声道</span>
  i2sConfig.i2s_format = I2S_STD_FORMAT;
  i2sConfig.is_master = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// ESP32 作为从设备，使用麦克风提供的时钟！</span>
  i2sConfig.port_no = <span class="hljs-number">0</span>;           <span class="hljs-comment">// 使用I2S端口0</span>

  <span class="hljs-comment">// 开始I2S输入</span>
  <span class="hljs-keyword">if</span> (!i2sInput.<span class="hljs-built_in">begin</span>(i2sConfig)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"错误：I2S麦克风初始化失败！请检查接线和引脚定义。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>); <span class="hljs-comment">// 停止</span>
  }
  <span class="hljs-built_in">printAudioInfo</span>(i2sInput.<span class="hljs-built_in">audioInfo</span>());
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 从I2S流读取一帧音频数据到缓冲区</span>
  <span class="hljs-type">size_t</span> numSamplesRead = i2sInput.<span class="hljs-built_in">readBytes</span>((<span class="hljs-type">uint8_t</span>*)buffer, <span class="hljs-built_in">sizeof</span>(buffer));

  <span class="hljs-comment">// 将读取到的每个16位样本通过串口发送，用于绘图</span>
  <span class="hljs-comment">// 注意：对于串口绘图器，一次只需发送一个值（单声道）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numSamplesRead / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int16_t</span>); i++) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(buffer[i]); <span class="hljs-comment">// 将样本值直接打印</span>
  }
  <span class="hljs-comment">// 注意：高采样率下，Serial.print可能成为瓶颈，此代码仅用于演示。</span>
  <span class="hljs-comment">// 实际应用时应处理或存储数据，而非全部打印。</span>
}
</code></pre>
<h4 data-id="heading-14">🔬 如何测试与验证</h4>
<ol>
<li><strong>上传代码</strong>：确保接线正确后，编译并上传代码到 ESP32。</li>
<li><strong>打开串口监视器</strong>：波特率设为115200，查看初始化信息。</li>
<li><strong>打开串口绘图器</strong>：在 PlatformIO 或 Arduino IDE 中，找到 <strong>Serial Plotter</strong> 功能并打开。你应该能看到随环境声音变化的实时波形图。对着麦克风说话或制造声音，观察波形变化。</li>
</ol>
<h4 data-id="heading-15">📝 进阶应用：将录音保存到 SD 卡（WAV格式）</h4>
<p>录制音频并保存是常见需求。以下是一个简化的框架，展示如何将 <code>AudioTools</code> 库的录音数据通过 <code>WAVEncoder</code> 保存为 WAV 文件到 SD 卡。</p>
<blockquote>
<p><strong>前提</strong>：你已经按之前指南接好 SD 卡模块并安装了所需库。</p>
</blockquote>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意：此为高级示例框架，可能需要调整才能完全运行</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSD.h"</span> <span class="hljs-comment">// 用于SD卡写入</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;SD.h&gt;</span></span>

<span class="hljs-comment">// ... 引脚定义和I2S输入配置与上文相同 ...</span>

<span class="hljs-function">SDStream <span class="hljs-title">sd_out</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span></span>; <span class="hljs-comment">// SD卡CS引脚为5</span>
WAVEncoder wav_enc;
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">encoder</span><span class="hljs-params">(&amp;sd_out, &amp;wav_enc)</span></span>; <span class="hljs-comment">// 将WAV编码流指向SD卡</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(encoder, i2sInput)</span></span>; <span class="hljs-comment">// 将I2S输入复制到编码器</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// ... 初始化串口、SD卡、I2S输入 ...</span>
    <span class="hljs-comment">// 初始化SD卡输出流</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SD</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">5</span>)) { <span class="hljs-comment">/* 错误处理 */</span> }
    sd_out.<span class="hljs-built_in">begin</span>(<span class="hljs-string">"/recording.wav"</span>, FILE_WRITE); <span class="hljs-comment">// 打开文件</span>
    encoder.<span class="hljs-built_in">begin</span>(i2sInput.<span class="hljs-built_in">audioInfo</span>()); <span class="hljs-comment">// 以输入音频参数开始编码</span>
    wav_enc.<span class="hljs-built_in">begin</span>(encoder); <span class="hljs-comment">// 开始WAV编码</span>
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始录音到SD卡..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
    copier.<span class="hljs-built_in">copy</span>(); <span class="hljs-comment">// 持续录音</span>
    <span class="hljs-comment">// 可以通过按钮或其他条件触发停止录音：encoder.end(); sd_out.end();</span>
}
</code></pre>
<h4 data-id="heading-16">⚠️ 常见问题</h4>

























<table><thead><tr><th>问题</th><th>排查要点</th></tr></thead><tbody><tr><td><strong>没有数据/全是噪声</strong></td><td>1. <strong>时钟模式</strong>：确认 <code>i2sConfig.is_master = false</code>。 2. <strong>引脚</strong>：最可能！反复检查 SCK, WS, SD 三条数据线是否接对。 3. <strong>电源</strong>：确保是 <strong>3.3V</strong>，且 GND 已共地。</td></tr><tr><td><strong>声音波形很小</strong></td><td>INMP441 灵敏度较高。尝试增大声源音量或调整代码中的增益（可对 <code>buffer[i]</code> 乘以一个系数后再发送）。</td></tr><tr><td><strong>编译错误</strong></td><td>确保 <code>platformio.ini</code> 中的 <code>lib_deps</code> 已正确添加 <code>AudioTools</code> 库。</td></tr><tr><td><strong>程序运行不稳定</strong></td><td>降低采样率（如改为 16000 Hz）或增加 <code>bufferSize</code>。</td></tr></tbody></table>
<p>成功连接并采集到音频数据后，你可以将其用于语音唤醒、环境声分析、实时传输或与之前的播放功能结合实现回音消除等。如果你在具体实现中遇到问题，可以提供串口输出的错误信息，以便进一步诊断。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3-插槽slot]]></title>    <link>https://juejin.cn/post/7587965800273182746</link>    <guid>https://juejin.cn/post/7587965800273182746</guid>    <pubDate>2025-12-26T13:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800273182746" data-draft-id="7588086766235516966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3-插槽slot"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T13:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YaeZed"/> <meta itemprop="url" content="https://juejin.cn/user/3977350021390107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3-插槽slot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3977350021390107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YaeZed
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:47:59.000Z" title="Fri Dec 26 2025 13:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="gml">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222;color:silver}.hljs-keyword{color:#ffb871;font-weight:700}.hljs-built_in{color:#ffb871}.hljs-literal{color:#ff8080}.hljs-symbol{color:#58e55a}.hljs-comment{color:#5b995b}.hljs-string{color:#ff0}.hljs-number{color:#ff8080}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-code,.hljs-deletion,.hljs-doctag,.hljs-function,.hljs-link,.hljs-meta,.hljs-meta-keyword,.hljs-name,.hljs-quote,.hljs-regexp,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:silver}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>插槽是 Vue 组件中一个非常核心的概念，它允许你以一种灵活的方式将内容“插入”到子组件的指定位置，极大地提高了组件的复用性和灵TA性。插槽允许组件只负责渲染一个“框架”（比如边框、阴影），而把“内容”的决定权交给使用它的父组件。</p>
<h2 data-id="heading-0">1.默认插槽</h2>
<p>最简单的插槽，子组件中只有一个未命名的 <code>&lt;slot&gt;</code> 出口。</p>
<blockquote>
<p>子组件</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">300px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>父组件</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BaseCard</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一父组件<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./assets/logo.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Vue Logo"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100px;"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">BaseCard</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/BaseCard.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-1">2.具名插槽</h2>
<p>当子组件需要多个“坑位”时（例如，一个用于头部，一个用于底部），就需要使用具名插槽。</p>
<blockquote>
<p>子组件：使用 <code>name</code> 属性来区分不同的插槽。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-footer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"footer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.modal</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; }
<span class="hljs-selector-class">.modal-header</span>, <span class="hljs-selector-class">.modal-footer</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f4f4f4</span>; }
<span class="hljs-selector-class">.modal-body</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>父组件：使用 <code>&lt;template&gt;</code> 标签和 <code>v-slot</code> 指令（或其简写 <code>#</code>）来指定要填充的插槽。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ModalLayout</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot</span> = <span class="hljs-string">"header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>这是一个模态框标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是模态框的主要内容...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>确认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ModalLayout</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ModalLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/ModalLayout.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-2">3.作用域插槽</h2>
<p>这是插槽最强大的功能。它允许子组件向父组件的插槽内容传递数据。这在处理<strong>列表渲染</strong>时非常有用，子组件负责数据迭代，而父组件负责定义每一项的渲染样式。</p>
<blockquote>
<p>子组件：子组件通过在 <code>&lt;slot&gt;</code> 标签上绑定属性，来将数据"暴露"给父组件。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户列表:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in users"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">:user</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">:isAdmin</span>=<span class="hljs-string">"user.name === 'Alice'"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

interface <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: number;
  <span class="hljs-attr">name</span>: string;
  <span class="hljs-attr">age</span>: number;
}

<span class="hljs-keyword">const</span> users = ref&lt;<span class="hljs-title class_">User</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<blockquote>
<p>父组件：父组件通过 <code>v-slot</code> (或 <code>#</code>) 接收子组件传递的数据，<strong>并且可以立即为这些数据添加 TypeScript 类型</strong>。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserList</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ user, isAdmin }: { user: User, isAdmin: boolean }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> 
        {{ user.name }} ({{ user.age }}岁)
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isAdmin"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: red; margin-left: 10px;"</span>&gt;</span>[管理员]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">UserList</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/UserList.vue'</span>;

<span class="hljs-comment">// 我们可以在父组件中也定义这个类型，以便复用</span>
interface <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: number;
  <span class="hljs-attr">name</span>: string;
  <span class="hljs-attr">age</span>: number;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-3">4.自定义插槽(Vue 3.3+)</h2>
<p>在 Vue 3.3 及更高版本中， <code>&lt;script setup&gt;</code> 提供了 <code>defineSlots</code> 宏，这是在子组件中<strong>为插槽提供类型</strong>的官方方式。这极大地改善了开发体验，<strong>父组件不再需要手动声明类型</strong>，因为 TS 可以自动从子组件推断它们。</p>
<blockquote>
<p>子组件：使用 <code>defineSlots</code> 来声明插槽及其期望的 <code>props</code> 类型。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">:index</span>=<span class="hljs-string">"index"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 1. 定义数据和类型</span>
interface <span class="hljs-title class_">Item</span> {
  <span class="hljs-attr">id</span>: string;
  <span class="hljs-attr">text</span>: string;
}
<span class="hljs-keyword">const</span> items = ref&lt;<span class="hljs-title class_">Item</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'a'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'第一项'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'b'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'第二项'</span> },
]);

<span class="hljs-comment">// 2. (重点) 使用 defineSlots </span>
<span class="hljs-comment">// 这是一个宏，无需导入</span>
<span class="hljs-comment">// 它定义了 'default' 插槽会接收一个对象，该对象包含一个 'item' 属性 (类型为 Item)</span>
<span class="hljs-comment">// 和一个 'index' 属性 (类型为 number)</span>
defineSlots&lt;{
  <span class="hljs-title function_">default</span>(<span class="hljs-attr">props</span>: { <span class="hljs-attr">item</span>: <span class="hljs-title class_">Item</span>; <span class="hljs-attr">index</span>: number }): any;
  <span class="hljs-comment">// 如果有具名插槽，也可以在这里定义，比如：</span>
  <span class="hljs-comment">// header(props: { title: string }): any;</span>
}&gt;();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<blockquote>
<p>父组件：父组件的 <code>slotProps</code> (或解构的变量) 会被<strong>自动推断</strong>出正确的类型</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TypedList</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ item, index }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{{ index + 1 }}.<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span> {{ item.text.toUpperCase() }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">TypedList</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypedList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TypedList.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-4">5.总结</h2>
<ul>
<li>
<p><strong>布局组件</strong> (<code>Layout.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 定义网站的通用布局，如侧边栏、顶部导航和内容区域。</li>
<li><strong>用法</strong>: 使用 <code>header</code>, <code>sidebar</code>, <code>main</code> 等具名插槽，让不同页面填充自己的内容。</li>
</ul>
</li>
<li>
<p><strong>可复用 UI 元素</strong> (<code>Modal.vue</code>, <code>Card.vue</code>, <code>Dropdown.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 封装通用的交互和样式，但允许内容高度自定义。</li>
<li><strong>用法</strong>: <code>Modal</code> 组件提供 <code>header</code> (标题), <code>body</code> (内容), <code>footer</code> (按钮) 插槽。</li>
</ul>
</li>
<li>
<p><strong>列表渲染器</strong> (<code>DataList.vue</code>, <code>ProductGrid.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 组件负责获取和迭代数据（如 API 请求、分页），但把<em>如何渲染每一项</em>的控制权交给父组件。</li>
<li><strong>用法</strong>: <strong>(核心)</strong> 使用<strong>作用域插槽</strong>，将 <code>item</code> (当前项数据) 传递给父组件。这是最灵活的模式。</li>
</ul>
</li>
<li>
<p><strong>提供者组件</strong> (<code>Toggle.vue</code>, <code>MouseTracker.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 组件管理某个状态（如 <code>isOn</code>）或逻辑（如鼠标位置），并通过作用域插槽将这些状态暴露出去，让父组件来决定如何渲染。</li>
<li><strong>用法</strong>: 子组件 <code>&lt;slot :isOn="isOn" :toggle="toggleFunction"&gt;&lt;/slot&gt;</code>。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[五年前端，我凌晨三点的电脑屏幕前终于想通了这件事]]></title>    <link>https://juejin.cn/post/7587740546955477032</link>    <guid>https://juejin.cn/post/7587740546955477032</guid>    <pubDate>2025-12-26T13:57:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587740546955477032" data-draft-id="7588034035286229007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="五年前端，我凌晨三点的电脑屏幕前终于想通了这件事"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T13:57:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="destinying"/> <meta itemprop="url" content="https://juejin.cn/user/896842287549703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            五年前端，我凌晨三点的电脑屏幕前终于想通了这件事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/896842287549703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    destinying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:57:14.000Z" title="Fri Dec 26 2025 13:57:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">五年前端开发：那些加班到深夜的日子里，我终于找到了答案</h2>
<blockquote>
<p>转眼间，做前端已经五年了。回想起这些年的点点滴滴，有为了一个像素对不齐而折腾到凌晨的执着，也有终于解决了一个性能问题后的欣喜若狂。</p>
</blockquote>
<h3 data-id="heading-1">💻 那些让我抓狂的瞬间</h3>
<h4 data-id="heading-2">一个padding搞了我一晚上</h4>
<p>记得刚入行的时候，有个布局问题让我头疼了一整晚。就是两个div之间的间距，怎么调都不对。那时候我还不知道浏览器默认样式这回事，对着Chrome开发者工具一遍遍地试，各种margin、padding组合，结果第二天早上一问资深同事，人家轻描淡写地说："reset.css加了么？"</p>
<p>那一刻我才明白，<strong>很多你以为的技术难题，其实只是知识盲区而已</strong>。</p>
<h4 data-id="heading-3">"这个需求很简单"背后的深坑</h4>
<p>产品经理说："这个需求很简单，就是加个拖拽排序功能。"</p>
<p>我："好的，应该一天就够了。"</p>
<p>然后我才发现，拖拽排序要考虑：</p>
<ul>
<li>移动端的手势识别</li>
<li>PC端的鼠标事件</li>
<li>不同浏览器的事件兼容性</li>
<li>拖拽过程中的视觉反馈</li>
<li>边界处理和碰撞检测</li>
<li>性能优化（防止频繁重绘）</li>
<li>可访问性支持</li>
</ul>
<p><strong>三天后</strong>，我终于交出了"看似简单"的功能。从那以后，我再也不轻易相信"这个需求很简单"这种话了。</p>
<h3 data-id="heading-4">🌱 那些让我成长的时刻</h3>
<h4 data-id="heading-5">第一次重构老项目</h4>
<p>接手一个三年前的老项目，代码里到处都是<code>document.getElementById</code>，jQuery和原生JS混用，全局变量满天飞。重构过程中，我发现了一些有意思的"黑历史"：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当年的前辈们是怎么写代码的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (data1 == <span class="hljs-literal">null</span>) {
    data1 = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
      data1.<span class="hljs-title function_">push</span>(i);
    }
  }
  <span class="hljs-keyword">return</span> data1;
}

<span class="hljs-comment">// 还有这种神奇的操作</span>
$(<span class="hljs-string">"#button"</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    location.<span class="hljs-title function_">reload</span>();
  }, <span class="hljs-number">100</span>);
});
</code></pre>
<p>重构那段时间，每天都在跟历史代码搏斗，但也正是这个过程，让我真正理解了什么叫"代码可维护性"。</p>
<h4 data-id="heading-6">学会了说"不"</h4>
<p>以前刚入行时，产品提什么需求我都说"行"。直到有一次，为了赶一个不合理的deadline，我熬了好几个通宵，最后上线的版本还出了bug。</p>
<p>后来我学聪明了，开始跟产品和沟通：</p>
<ul>
<li>这个需求的技术复杂度是多少</li>
<li>需要多少开发时间</li>
<li>如果一定要提前，哪些功能可以砍掉</li>
<li>当前技术方案的风险点在哪里</li>
</ul>
<p><strong>学会评估和沟通，比学会写代码更重要</strong>。</p>
<h3 data-id="heading-7">🤔 程序员的日常思考</h3>
<h4 data-id="heading-8">关于加班的那些事</h4>
<p>刚开始工作的时候，我觉得加班=努力。后来慢慢发现：</p>
<ul>
<li><strong>有效的时间管理比长时间工作更重要</strong></li>
<li><strong>会写代码不等于会解决问题</strong></li>
<li><strong>健康比KPI重要得多</strong></li>
</ul>
<p>我现在尽量不加班，不是因为懒，而是我学会了：</p>
<ul>
<li>提前评估工作量</li>
<li>及时沟通风险</li>
<li>拒绝不合理的需求</li>
<li>保持专注，减少无效加班</li>
</ul>
<h4 data-id="heading-9">关于技术焦虑</h4>
<p>前端技术更新太快，Vue还没学完，React又出了新特性，CSS框架层出不穷。前两年我很焦虑，怕被淘汰。</p>
<p>现在我想通了：</p>
<ul>
<li><strong>基础永远是王道</strong>：HTML/CSS/JavaScript的核心不会变</li>
<li><strong>学习要讲方法</strong>：不要追着新技术跑，要有选择地学</li>
<li><strong>项目驱动学习</strong>：在实际项目中学习新技术效果最好</li>
<li><strong>保持输出</strong>：写博客、做分享是最好的学习方式</li>
</ul>
<h3 data-id="heading-10">💪 真正的成长是什么</h3>
<h4 data-id="heading-11">从技术思维到产品思维</h4>
<p>刚开始我只关心代码写得爽不爽，后来我开始思考：</p>
<ul>
<li>用户真的需要这个功能吗？</li>
<li>这个交互体验够好吗？</li>
<li>性能优化能带来什么价值？</li>
<li>我的代码对团队协作友好吗？</li>
</ul>
<p><strong>技术是工具，不是目的</strong>。真正的前端开发，是用技术为用户创造价值。</p>
<h4 data-id="heading-12">找到了自己的节奏</h4>
<p>现在的我：</p>
<ul>
<li>不再盲目追新技术，而是选择适合自己的技术栈</li>
<li>重视代码质量，但不执着于完美</li>
<li>会主动沟通需求，而不是被动接受</li>
<li>保持学习的热情，但不焦虑</li>
<li>知道什么时候该努力，什么时候该休息</li>
</ul>
<h3 data-id="heading-13">🎯 给自己的一些话</h3>
<p>五年下来，我想对自己说：</p>
<ol>
<li><strong>保持好奇，但不要盲目跟风</strong></li>
<li><strong>写代码很重要，但解决问题更重要</strong></li>
<li><strong>技术要精进，但生活也要平衡</strong></li>
<li><strong>多分享，多交流，多思考</strong></li>
<li><strong>记住，你首先是一个人，其次才是程序员</strong></li>
</ol>
<h3 data-id="heading-14">✨ 下一个五年</h3>
<p>技术这条路很长，但我不急了。慢慢地学习，稳稳地成长，踏实做好每一个项目。</p>
<p>毕竟，<strong>最好的代码不是最复杂的，而是最合适的</strong>。最好的程序员不是最聪明的，而是最懂得平衡的。</p>
<p>愿我们都能在这条路上，找到属于自己的节奏和答案。</p>
<hr/>
<p><em>你在前端路上有什么难忘的经历？欢迎在评论区分享你的故事。</em></p>
<p>#前端开发 #程序员成长 #技术感悟 #职场经验 #真实感受</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android稳定性基础:系统架构与关键机制]]></title>    <link>https://juejin.cn/post/7587776610436497423</link>    <guid>https://juejin.cn/post/7587776610436497423</guid>    <pubDate>2025-12-26T12:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436497423" data-draft-id="7587808953076678656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android稳定性基础:系统架构与关键机制"/> <meta itemprop="keywords" content="Android,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T12:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android稳定性基础:系统架构与关键机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:45:07.000Z" title="Fri Dec 26 2025 12:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android稳定性基础:系统架构与关键机制</h2>
<blockquote>
<p>系统稳定性是用户体验的基石,也是品牌口碑的生命线。</p>
</blockquote>
<h3 data-id="heading-1">引言:为什么系统稳定性如此重要?</h3>
<p>还记得某知名手机品牌因为系统频繁死机被用户集体投诉的新闻吗?一次系统崩溃可能只需要几秒钟,但对品牌形象的伤害却需要几年来修复。</p>
<p>作为一名Android Framework工程师,你可能经常会遇到这样的场景:</p>
<ul>
<li>测试同学气冲冲地跑过来:"手机又卡死了!"</li>
<li>用户反馈:"App动不动就闪退,太烂了!"</li>
<li>老板在群里@所有人:"线上出现大面积ANR,紧急处理!"</li>
</ul>
<p>这些问题的背后,都指向同一个主题——<strong>系统稳定性</strong>。</p>
<p>系统稳定性就像是房子的地基。地基不稳,再漂亮的装修也是空中楼阁。Android系统运行着数十个系统进程、上百个系统服务,它们就像一个精密的交响乐团,任何一个成员出了问题,整场演出都会受到影响。</p>
<p>本文是《Android系统稳定性与性能优化》系列的开篇之作。我们将从Android系统架构出发,带你建立起系统稳定性分析的基础认知框架。读完本文,你将能够:</p>
<ol>
<li>理解Android系统分层架构与稳定性的关系</li>
<li>掌握系统稳定性的核心机制和关键组件</li>
<li>了解稳定性问题的分类和表现形式</li>
<li>建立系统稳定性分析的基础思维框架</li>
</ol>
<p>准备好了吗?让我们开始这段探索之旅!</p>
<hr/>
<h3 data-id="heading-2">一、Android系统架构回顾</h3>
<p>要理解系统稳定性,首先要对Android的系统架构有清晰的认识。如果把Android系统比作一栋大楼,那么它是这样分层建造的:</p>
<h4 data-id="heading-3">1.1 分层架构概览</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12a44f64f0a2406bbef3524a012c752a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=0pGk1YvoHwtfPNJcf00Qo15WlKI%3D" alt="01-01-android-architecture.png" loading="lazy"/></p>
<p>这种分层设计就像是一个金字塔,<strong>越往下层越稳定,但出问题的影响也越大</strong>。</p>
<p>打个比方:如果你家的灯泡坏了(应用层),换一个就好;如果电路板烧了(Framework层),可能整个房间都没电;如果变压器炸了(Kernel层),整栋楼都要遭殃!</p>
<h4 data-id="heading-4">1.2 各层对稳定性的影响</h4>
<p>让我们逐层分析,看看每一层可能出现什么稳定性问题:</p>
<h5 data-id="heading-5">应用层 (Applications)</h5>
<p>这是用户直接接触的层面,稳定性问题主要表现为:</p>
<ul>
<li><strong>Java Crash</strong>: 未捕获的异常导致应用闪退</li>
<li><strong>ANR</strong>: 主线程阻塞导致应用无响应</li>
<li><strong>内存泄漏</strong>: 持续占用内存最终导致OOM</li>
</ul>
<p><strong>影响范围</strong>: 单个应用
<strong>严重程度</strong>: 一般(用户可以重新打开应用)</p>
<h5 data-id="heading-6">Framework层 (Application Framework)</h5>
<p>这是Android的"大脑",提供了所有应用运行所需的服务:</p>
<ul>
<li><strong>System Server Crash</strong>: 核心系统服务崩溃,导致系统重启</li>
<li><strong>服务死锁</strong>: 多个服务相互等待,系统卡死</li>
<li><strong>Binder资源耗尽</strong>: 进程间通信阻塞</li>
</ul>
<p><strong>影响范围</strong>: 整个系统
<strong>严重程度</strong>: 严重(可能导致系统重启)</p>
<h5 data-id="heading-7">Native层 (Native Libraries &amp; ART)</h5>
<p>这一层用C/C++编写,执行效率高但也更容易出问题:</p>
<ul>
<li><strong>Native Crash</strong>: SIGSEGV、SIGABRT等信号导致进程终止</li>
<li><strong>内存访问违规</strong>: 野指针、数组越界</li>
<li><strong>资源泄漏</strong>: 文件描述符、内存泄漏</li>
</ul>
<p><strong>影响范围</strong>: 单个进程到整个系统
<strong>严重程度</strong>: 重要到严重</p>
<h5 data-id="heading-8">HAL层 (Hardware Abstraction Layer)</h5>
<p>硬件抽象层连接软件和硬件:</p>
<ul>
<li><strong>HAL服务崩溃</strong>: 硬件功能不可用</li>
<li><strong>硬件超时</strong>: 与硬件通信超时</li>
</ul>
<p><strong>影响范围</strong>: 特定硬件功能
<strong>严重程度</strong>: 重要</p>
<h5 data-id="heading-9">Kernel层 (Linux Kernel)</h5>
<p>这是系统的根基:</p>
<ul>
<li><strong>Kernel Panic</strong>: 内核崩溃,系统直接重启</li>
<li><strong>驱动崩溃</strong>: 特定硬件功能异常</li>
<li><strong>死锁</strong>: 系统完全卡死</li>
</ul>
<p><strong>影响范围</strong>: 整个设备
<strong>严重程度</strong>: 致命</p>
<h4 data-id="heading-10">1.3 关键进程与服务</h4>
<p>在Android系统中,有几个进程是"命根子",它们挂了,整个系统就得重启:</p>
<h5 data-id="heading-11">Zygote进程</h5>
<p>Zygote是Android的"孵化器",所有应用进程都是从它fork出来的。可以把它想象成一个"应用工厂":</p>
<pre><code class="hljs language-scss" lang="scss">Zygote
  ├── <span class="hljs-built_in">fork</span>() → App1进程
  ├── <span class="hljs-built_in">fork</span>() → App2进程
  ├── <span class="hljs-built_in">fork</span>() → App3进程
  └── <span class="hljs-built_in">fork</span>() → System Server进程
</code></pre>
<p>如果Zygote挂了,就像工厂倒闭了,新的应用进程无法创建,系统只能重启。</p>
<h5 data-id="heading-12">System Server进程</h5>
<p>System Server是Android的"大管家",运行着几乎所有核心系统服务:</p>



































<table><thead><tr><th>服务名称</th><th>职责</th><th>挂了会怎样</th></tr></thead><tbody><tr><td>ActivityManagerService</td><td>管理四大组件生命周期</td><td>无法启动/切换应用</td></tr><tr><td>WindowManagerService</td><td>管理窗口显示</td><td>屏幕一片空白</td></tr><tr><td>PackageManagerService</td><td>管理应用安装/查询</td><td>无法安装/查找应用</td></tr><tr><td>PowerManagerService</td><td>管理电源状态</td><td>无法休眠/唤醒</td></tr><tr><td>InputManagerService</td><td>管理输入事件</td><td>触摸/按键失效</td></tr></tbody></table>
<p>System Server一旦崩溃,整个系统就会重启(你会看到开机动画重新播放)。</p>
<h5 data-id="heading-13">SurfaceFlinger进程</h5>
<p>SurfaceFlinger是Android的"画师",负责将所有应用的界面合成后显示到屏幕上:</p>
<pre><code class="hljs language-css" lang="css">App1 Surface ─┐
App2 Surface ──┼──→ SurfaceFlinger ──→ <span class="hljs-attribute">Display</span>
StatusBar    ─┘
</code></pre>
<p>如果SurfaceFlinger挂了,屏幕要么黑屏,要么画面定格。</p>
<hr/>
<h3 data-id="heading-14">二、稳定性核心机制</h3>
<p>Android系统设计了多种机制来保障稳定性,就像人体的免疫系统一样。让我们逐一了解这些"护城河"。</p>
<h4 data-id="heading-15">2.1 进程管理机制</h4>
<p>Android是一个多任务操作系统,但手机的内存是有限的。如何在有限的资源下保证系统流畅运行?答案是<strong>进程优先级管理</strong>和<strong>Low Memory Killer (LMK)</strong>。</p>
<h5 data-id="heading-16">进程优先级</h5>
<p>Android根据进程的重要性将其分为5个等级:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d1d8b3f5d06479ebe824d587664a23e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=mJkiv4sgDLoVXnaz9Qh9ysdVU%2BY%3D" alt="01-02-process-priority-lmk.png" loading="lazy"/></p>















































<table><thead><tr><th>优先级</th><th>名称</th><th>oom_adj</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>最高</td><td>Foreground</td><td>0</td><td>用户正在交互的进程</td><td>前台App</td></tr><tr><td>高</td><td>Visible</td><td>100</td><td>可见但不在前台</td><td>后台有悬浮窗的App</td></tr><tr><td>中</td><td>Service</td><td>200</td><td>运行后台服务的进程</td><td>音乐播放器</td></tr><tr><td>低</td><td>Cached</td><td>900</td><td>缓存的后台进程</td><td>最近使用的App</td></tr><tr><td>最低</td><td>Empty</td><td>999</td><td>空进程,随时可杀</td><td>已退出的App</td></tr></tbody></table>
<p>可以用以下代码查看进程优先级:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查看进程优先级</span>
<span class="hljs-type">ActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> getSystemService(ActivityManager.class);
List&lt;ActivityManager.RunningAppProcessInfo&gt; processes = am.getRunningAppProcesses();
<span class="hljs-keyword">for</span> (ActivityManager.RunningAppProcessInfo info : processes) {
    Log.d(TAG, <span class="hljs-string">"Process: "</span> + info.processName +
          <span class="hljs-string">", Importance: "</span> + info.importance +
          <span class="hljs-string">", ImportanceReasonCode: "</span> + info.importanceReasonCode);
}
</code></pre>
<h5 data-id="heading-17">Low Memory Killer (LMK)</h5>
<p>当系统内存不足时,LMK就会出马"杀进程"。它的工作原理很简单:<strong>优先杀低优先级的进程,释放内存给高优先级进程使用</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">内存充足时:  <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span> <span class="hljs-section">[服务]</span> <span class="hljs-section">[缓存1]</span> <span class="hljs-section">[缓存2]</span> <span class="hljs-section">[空进程]</span>
                ↓ 内存紧张
内存紧张时:  <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span> <span class="hljs-section">[服务]</span> <span class="hljs-section">[缓存1]</span>  ← 空进程和缓存2被杀
                ↓ 内存严重不足
极端情况:    <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span>  ← 连服务进程都被杀了
</code></pre>
<p><strong>LMK vs OOM Killer的区别</strong>:</p>






























<table><thead><tr><th>特性</th><th>LMK</th><th>OOM Killer</th></tr></thead><tbody><tr><td>所属层</td><td>Android用户空间</td><td>Linux内核</td></tr><tr><td>触发时机</td><td>内存低于阈值时(主动)</td><td>内存耗尽时(被动)</td></tr><tr><td>杀进程策略</td><td>基于oom_adj优先级</td><td>基于oom_score</td></tr><tr><td>目的</td><td>预防性释放内存</td><td>紧急释放内存</td></tr></tbody></table>
<p>LMK就像是一个"未雨绸缪"的管家,在内存紧张之前就开始清理;而OOM Killer是"亡羊补牢"的最后手段。</p>
<h4 data-id="heading-18">2.2 异常监控机制</h4>
<p>Android系统有一套完善的"健康检查"机制,能够及时发现并处理各种异常。</p>
<h5 data-id="heading-19">ANR监控</h5>
<p>ANR (Application Not Responding) 是用户最常遇到的稳定性问题之一。当应用在规定时间内没有响应,系统就会弹出"应用无响应"对话框。</p>
<p>ANR的触发条件:</p>






























<table><thead><tr><th>类型</th><th>超时时间</th><th>触发场景</th></tr></thead><tbody><tr><td>Input事件</td><td>5秒</td><td>触摸/按键事件未处理</td></tr><tr><td>Broadcast</td><td>前台10秒/后台60秒</td><td>广播接收器未完成</td></tr><tr><td>Service</td><td>前台20秒/后台200秒</td><td>服务启动未完成</td></tr><tr><td>ContentProvider</td><td>10秒</td><td>Provider发布超时</td></tr></tbody></table>
<p>ANR监控的核心逻辑:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化的ANR检测逻辑 (InputDispatcher.cpp)</span>
<span class="hljs-keyword">void</span> InputDispatcher::handleAnr() {
    <span class="hljs-comment">// 1. 发送输入事件给应用</span>
    dispatchEventLocked(event);

    <span class="hljs-comment">// 2. 设置超时定时器 (5秒)</span>
    mAnrTimer.set(5000ms);

    <span class="hljs-comment">// 3. 等待应用响应</span>
    <span class="hljs-keyword">if</span> (!receivedResponse &amp;&amp; timeout) {
        <span class="hljs-comment">// 4. 触发ANR</span>
        notifyAnr(connection, reason);
    }
}
</code></pre>
<h5 data-id="heading-20">Crash监控</h5>
<p>应用崩溃分为Java Crash和Native Crash两种:</p>
<p><strong>Java Crash处理流程</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置全局异常处理器</span>
Thread.setDefaultUncaughtExceptionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>.UncaughtExceptionHandler() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uncaughtException</span><span class="hljs-params">(Thread t, Throwable e)</span> {
        <span class="hljs-comment">// 1. 收集崩溃信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">stackTrace</span> <span class="hljs-operator">=</span> Log.getStackTraceString(e);

        <span class="hljs-comment">// 2. 写入日志</span>
        Log.e(TAG, <span class="hljs-string">"Uncaught exception in thread "</span> + t.getName(), e);

        <span class="hljs-comment">// 3. 上报到服务器 (可选)</span>
        CrashReporter.report(e);

        <span class="hljs-comment">// 4. 终止进程</span>
        Process.killProcess(Process.myPid());
    }
});
</code></pre>
<p><strong>Native Crash处理流程</strong>:</p>
<p>Native层的崩溃通过Linux信号机制处理:</p>
<pre><code class="hljs language-scss" lang="scss">程序触发SIGSEGV (段错误)
        ↓
内核发送信号给进程
        ↓
debuggerd捕获信号
        ↓
收集崩溃信息(寄存器、堆栈、maps)
        ↓
生成tombstone文件
        ↓
通知AMS进程终止
</code></pre>
<h5 data-id="heading-21">Watchdog机制</h5>
<p>Watchdog是System Server的"看门狗",专门监控核心线程是否正常运行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Watchdog监控的核心线程</span>
mMonitorChecker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(FgThread.getHandler(), <span class="hljs-string">"foreground thread"</span>);
mMonitorChecker.addMonitor(mAms); <span class="hljs-comment">// ActivityManagerService</span>
mMonitorChecker.addMonitor(mWms); <span class="hljs-comment">// WindowManagerService</span>
mMonitorChecker.addMonitor(mPms); <span class="hljs-comment">// PowerManagerService</span>
<span class="hljs-comment">// ...</span>
</code></pre>
<p>Watchdog的工作原理:</p>
<ol>
<li>每隔30秒向被监控线程的Handler发送消息</li>
<li>如果60秒内没有收到响应,判定为半死锁状态</li>
<li>如果超过60秒(默认值)仍无响应,触发Watchdog重启</li>
<li>生成traces.txt文件,记录所有线程堆栈</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">正常情况:</span>
Watchdog ──发送消息──→ 核心线程 ──30秒内响应──→ Watchdog: <span class="hljs-string">"一切正常"</span>

<span class="hljs-section">异常情况:</span>
Watchdog ──发送消息──→ 核心线程(卡住了) ──60秒无响应──→ Watchdog: <span class="hljs-string">"重启System Server!"</span>
</code></pre>
<h4 data-id="heading-22">2.3 资源管理机制</h4>
<p>资源泄漏是稳定性问题的常见根因。Android对几类关键资源有专门的管理机制。</p>
<h5 data-id="heading-23">内存管理</h5>
<p>Android的内存分为几个区域:</p>






























<table><thead><tr><th>内存类型</th><th>说明</th><th>典型问题</th></tr></thead><tbody><tr><td>Java Heap</td><td>Dalvik/ART管理的堆内存</td><td>内存泄漏导致OOM</td></tr><tr><td>Native Heap</td><td>C/C++分配的内存</td><td>忘记free导致泄漏</td></tr><tr><td>Graphics</td><td>GPU使用的图形内存</td><td>大图片导致OOM</td></tr><tr><td>Code</td><td>加载的dex/so占用</td><td>加载过多库</td></tr></tbody></table>
<h5 data-id="heading-24">文件描述符(FD)管理</h5>
<p>每个进程可打开的文件描述符数量是有限的(通常是1024个)。FD泄漏会导致:</p>
<ul>
<li>无法打开新文件</li>
<li>无法创建新Socket</li>
<li>无法建立Binder连接</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程的FD使用情况</span>
adb shell <span class="hljs-built_in">ls</span> -la /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 查看FD限制</span>
adb shell <span class="hljs-built_in">cat</span> /proc/&lt;pid&gt;/limits | grep <span class="hljs-string">"open files"</span>
</code></pre>
<h5 data-id="heading-25">Binder资源管理</h5>
<p>Binder是Android最重要的IPC机制,但它的资源也是有限的:</p>
<ul>
<li><strong>Binder线程池</strong>: 默认最多16个线程</li>
<li><strong>Binder缓冲区</strong>: 每个进程最大1MB(普通应用)</li>
<li><strong>Binder代理对象</strong>: 数量有上限</li>
</ul>
<p>当Binder资源耗尽时,进程间通信就会失败,表现为ANR或功能异常。</p>
<hr/>
<h3 data-id="heading-26">三、稳定性问题分类</h3>
<p>了解了稳定性机制后,让我们来系统地分类各种稳定性问题。</p>
<h4 data-id="heading-27">3.1 按严重程度分类</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a39fd2a78d5742839b1506a3a821879d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=n1m%2F9wrnxMSiTDROyGyENnl0FlU%3D" alt="01-03-stability-classification.png" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">严重程度金字塔:

        /\
       /致\        Kernel Panic、System <span class="hljs-built_in">Server</span> Crash
      /命级\       → 系统重启,用户数据可能丢失
     /──────\
    / 严重级 \     Native Crash、Watchdog重启
   /──────────\    → 功能不可用,需要重启应用/系统
  /  重要级    \   ANR、系统服务无响应
 /──────────────\  → 用户体验严重下降
/    一般级      \ 应用Crash、性能卡顿
/────────────────\ → 影响单个应用,用户可恢复
</code></pre>
<h4 data-id="heading-28">3.2 按表现形式分类</h4>
<h5 data-id="heading-29">无响应类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>ANR</td><td>弹出"应用无响应"对话框</td><td>主线程阻塞、死锁</td></tr><tr><td>System无响应</td><td>系统卡死,按键无反应</td><td>System Server死锁</td></tr><tr><td>黑屏</td><td>屏幕无显示</td><td>SurfaceFlinger问题</td></tr></tbody></table>
<h5 data-id="heading-30">崩溃类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>Java Crash</td><td>应用闪退</td><td>空指针、数组越界</td></tr><tr><td>Native Crash</td><td>应用闪退,有tombstone</td><td>内存访问违规</td></tr><tr><td>Kernel Crash</td><td>系统直接重启</td><td>驱动bug、硬件问题</td></tr></tbody></table>
<h5 data-id="heading-31">异常重启类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>Watchdog重启</td><td>看到开机动画</td><td>系统服务死锁</td></tr><tr><td>Kernel Panic</td><td>突然重启</td><td>内核异常</td></tr><tr><td>硬件Watchdog</td><td>突然重启</td><td>系统完全卡死</td></tr></tbody></table>
<h4 data-id="heading-32">3.3 常见根因分析</h4>
<p>经过大量问题分析,我总结了稳定性问题的常见根因:</p>
<ol>
<li>
<p><strong>死锁问题</strong> (约25%)</p>
<ul>
<li>多线程竞争同一资源</li>
<li>Binder调用形成环路</li>
<li>主线程等待子线程</li>
</ul>
</li>
<li>
<p><strong>资源耗尽</strong> (约20%)</p>
<ul>
<li>内存泄漏导致OOM</li>
<li>FD泄漏</li>
<li>Binder资源耗尽</li>
</ul>
</li>
<li>
<p><strong>内存访问违规</strong> (约15%)</p>
<ul>
<li>空指针引用</li>
<li>野指针</li>
<li>数组越界</li>
</ul>
</li>
<li>
<p><strong>并发竞态</strong> (约15%)</p>
<ul>
<li>多线程读写冲突</li>
<li>时序问题</li>
</ul>
</li>
<li>
<p><strong>第三方SDK问题</strong> (约10%)</p>
<ul>
<li>SDK兼容性问题</li>
<li>SDK内部bug</li>
</ul>
</li>
<li>
<p><strong>其他</strong> (约15%)</p>
<ul>
<li>配置错误</li>
<li>硬件兼容性</li>
<li>系统bug</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-33">四、稳定性分析思维框架</h3>
<p>当遇到稳定性问题时,如何高效地定位根因?这里分享一套实用的分析框架。</p>
<h4 data-id="heading-34">4.1 分析流程</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b8d166890d4fae9d12e3cfbe133364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=KD63VvZdamCBTZarqkUvrz9rOaQ%3D" alt="01-04-analysis-workflow.png" loading="lazy"/></p>
<h4 data-id="heading-35">4.2 5W1H分析法</h4>
<p>面对稳定性问题,我习惯用5W1H法来理清思路:</p>








































<table><thead><tr><th>问题</th><th>说明</th><th>如何获取</th></tr></thead><tbody><tr><td><strong>What</strong></td><td>发生了什么?</td><td>现象描述、错误类型</td></tr><tr><td><strong>When</strong></td><td>什么时候发生?</td><td>时间戳、发生频率</td></tr><tr><td><strong>Where</strong></td><td>在哪里发生?</td><td>模块、文件、代码行</td></tr><tr><td><strong>Who</strong></td><td>谁出了问题?</td><td>进程、线程、组件</td></tr><tr><td><strong>Why</strong></td><td>为什么发生?</td><td>根本原因分析</td></tr><tr><td><strong>How</strong></td><td>如何复现?如何解决?</td><td>复现步骤、修复方案</td></tr></tbody></table>
<h4 data-id="heading-36">4.3 工具箱概览</h4>
<p>工欲善其事,必先利其器。以下是分析稳定性问题的常用工具:</p>
<h5 data-id="heading-37">日志工具</h5>

























<table><thead><tr><th>工具</th><th>用途</th><th>命令示例</th></tr></thead><tbody><tr><td>logcat</td><td>查看实时日志</td><td><code>adb logcat -v threadtime</code></td></tr><tr><td>DropBox</td><td>查看系统保存的异常</td><td><code>adb shell dumpsys dropbox</code></td></tr><tr><td>bugreport</td><td>导出完整系统日志</td><td><code>adb bugreport</code></td></tr></tbody></table>
<h5 data-id="heading-38">分析工具</h5>






























<table><thead><tr><th>工具</th><th>用途</th><th>适用场景</th></tr></thead><tbody><tr><td>Systrace</td><td>系统级性能分析</td><td>ANR、卡顿问题</td></tr><tr><td>Perfetto</td><td>新一代trace工具</td><td>复杂性能问题</td></tr><tr><td>addr2line</td><td>Native符号化</td><td>Native Crash</td></tr><tr><td>MAT</td><td>内存分析</td><td>内存泄漏</td></tr></tbody></table>
<h5 data-id="heading-39">示例:分析一个ANR</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 获取ANR traces</span>
adb pull /data/anr/traces.txt

<span class="hljs-comment"># 2. 查看ANR原因</span>
adb shell dumpsys activity anr

<span class="hljs-comment"># 3. 分析traces.txt中的堆栈</span>
<span class="hljs-comment"># 重点关注main线程的状态:</span>
<span class="hljs-comment"># - 如果是BLOCKED,找它在等什么锁</span>
<span class="hljs-comment"># - 如果是WAITING,找它在等什么信号</span>
<span class="hljs-comment"># - 如果在执行某个方法,分析该方法为什么慢</span>

<span class="hljs-comment"># 4. 使用Systrace进一步分析</span>
python systrace.py -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view
</code></pre>
<hr/>
<h3 data-id="heading-40">五、实战案例:一个真实的ANR分析</h3>
<p>让我们通过一个真实案例,演示如何运用上面的知识进行分析。</p>
<h4 data-id="heading-41">问题现象</h4>
<p>用户反馈:在设置中切换WiFi时,经常出现"系统界面无响应"的弹窗。</p>
<h4 data-id="heading-42">分析过程</h4>
<p><strong>Step 1: 收集日志</strong></p>
<pre><code class="hljs language-bash" lang="bash">adb bugreport
adb pull /data/anr/traces.txt
</code></pre>
<p><strong>Step 2: 确定问题类型</strong></p>
<p>从DropBox中找到ANR记录:</p>
<pre><code class="hljs language-ini" lang="ini">Subject: Broadcast of Intent { <span class="hljs-attr">act</span>=android.net.wifi.WIFI_STATE_CHANGED }
ANR in com.android.systemui
PID: 1234
Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.net.wifi.WIFI_STATE_CHANGED }
        waited 10003ms for android.intent.action.BATTERY_CHANGED
</code></pre>
<p>这是一个<strong>Broadcast Timeout ANR</strong>。</p>
<p><strong>Step 3: 分析堆栈</strong></p>
<p>从traces.txt中找到SystemUI的主线程:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8 self=<span class="hljs-number">0</span>x7a4e014c00
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">1234</span> nice=-<span class="hljs-number">2</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">123456789</span> <span class="hljs-number">987654321</span> <span class="hljs-number">12345</span> ) utm=<span class="hljs-number">100</span> stm=<span class="hljs-number">50</span> core=<span class="hljs-number">2</span> HZ=<span class="hljs-number">100</span>
  at com.android.systemui.BatteryController.update(BatteryController.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at com.android.systemui.BatteryController.onReceive(BatteryController.java:100)
  ...
</code></pre>
<p>主线程在等一个锁,这个锁被线程15持有。</p>
<p><strong>Step 4: 找到持锁线程</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-string">"BatteryStats"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x13579bdf</span> <span class="hljs-built_in">self</span>=<span class="hljs-number">0x7a4e028800</span>
  at android.<span class="hljs-built_in">os</span>.BinderProxy.transactNative(Native Method)
  at android.<span class="hljs-built_in">os</span>.BinderProxy.transact(Binder.java:<span class="hljs-number">1129</span>)
  at com.android.internal.<span class="hljs-built_in">os</span>.IBatteryStats$Stub$Proxy.noteWifiOn(IBatteryStats.java:<span class="hljs-number">2046</span>)
  ...
</code></pre>
<p>线程15正在进行Binder调用,等待BatteryStatsService响应。</p>
<p><strong>Step 5: 根因分析</strong></p>
<p>经过进一步分析发现,BatteryStatsService正在进行一个耗时的统计操作,导致Binder调用超时。最终形成了这样的等待链:</p>
<pre><code class="hljs">主线程等待锁 → 线程15持有锁但在等Binder → BatteryStatsService繁忙
</code></pre>
<p><strong>Step 6: 解决方案</strong></p>
<ol>
<li>将BatteryController的更新操作移到子线程</li>
<li>优化BatteryStatsService的统计逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-43">六、后续文章预告</h3>
<p>本文作为系列开篇,建立了系统稳定性的基础认知框架。在后续文章中,我们将深入每个专题:</p>






























<table><thead><tr><th>文章</th><th>主题</th><th>你将学到</th></tr></thead><tbody><tr><td>第2篇</td><td>ANR机制深度解析</td><td>ANR的触发、检测、上报全流程</td></tr><tr><td>第3篇</td><td>ANR问题排查实战</td><td>traces.txt分析技巧、常见ANR案例</td></tr><tr><td>第4篇</td><td>Native Crash分析</td><td>tombstone解读、addr2line使用</td></tr><tr><td>第5篇</td><td>Watchdog机制</td><td>系统看门狗的工作原理</td></tr></tbody></table>
<p>敬请期待!</p>
<hr/>
<h3 data-id="heading-44">总结</h3>
<p>本文从Android系统架构出发,介绍了系统稳定性的核心概念:</p>
<ol>
<li><strong>分层架构</strong>: 理解Android五层架构及各层的稳定性影响</li>
<li><strong>关键进程</strong>: Zygote、System Server、SurfaceFlinger是系统的"生命线"</li>
<li><strong>核心机制</strong>: 进程优先级、LMK、ANR检测、Watchdog构成了稳定性保障体系</li>
<li><strong>问题分类</strong>: 按严重程度和表现形式对稳定性问题进行分类</li>
<li><strong>分析框架</strong>: 5W1H分析法和工具箱帮助高效定位问题</li>
</ol>
<p>系统稳定性不是一朝一夕能掌握的,需要在实践中不断积累。希望本文能帮你建立起正确的认知框架,在面对稳定性问题时不再迷茫。</p>
<hr/>
<h3 data-id="heading-45">参考资料</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fplatform" target="_blank" title="https://developer.android.com/guide/platform" ref="nofollow noopener noreferrer">Android官方文档 - 系统架构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2F" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/" ref="nofollow noopener noreferrer">AOSP源码 - ActivityManagerService</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F25921329%2F" target="_blank" title="https://book.douban.com/subject/25921329/" ref="nofollow noopener noreferrer">深入理解Android内核设计思想</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F19986441%2F" target="_blank" title="https://book.douban.com/subject/19986441/" ref="nofollow noopener noreferrer">Android系统源代码情景分析</a></li>
</ol>
<hr/>
<blockquote>
<p><strong>作者简介</strong>: 多年Android系统开发经验,专注于系统稳定性与性能优化领域。欢迎关注本系列,一起深入Android系统的精彩世界!</p>
</blockquote>
<p><strong>找到我</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a><br/>
<strong>返回专栏目录</strong>: <a href="https://juejin.cn/post/7587473691170095104" target="_blank" title="https://juejin.cn/post/7587473691170095104">Android稳定性&amp;性能深入理解专栏介绍</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界]]></title>    <link>https://juejin.cn/post/7588034035286425615</link>    <guid>https://juejin.cn/post/7588034035286425615</guid>    <pubDate>2025-12-26T15:51:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286425615" data-draft-id="7587997157237489716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界"/> <meta itemprop="keywords" content="LangChain,Node.js,AIGC"/> <meta itemprop="datePublished" content="2025-12-26T15:51:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T15:51:50.000Z" title="Fri Dec 26 2025 15:51:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong></p>
<p>大语言模型（LLM）通常被比作“大脑”，它拥有海量的知识和强大的逻辑推理能力。但是，一个只有大脑的智者，如果无法感知当下的时间、无法查询实时的天气、无法进行精确的数学运算，它的能力就会大打折扣。</p>
<p><strong>Tools（工具）</strong> 模块，就是 LangChain 赋予大模型的“双手”和“感官”。通过 Tools，我们可以让大模型不仅仅是陪聊，而是真正具备<strong>调用外部函数、执行复杂任务</strong>的能力。</p>
<p>本文将结合一段基于 <code>ChatDeepSeek</code> 的实战代码，带你从零开始，深入理解如何在 LangChain 中定义工具、使用 Zod 进行参数校验，以及如何优雅地处理模型返回的工具调用请求。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、 为什么我们需要 Tool？</h2>
<p>在深入代码之前，我们先思考一个问题：为什么 ChatGPT 有时候做不好简单的加减法？为什么它不知道今天北京的天气？</p>
<p>因为大模型的本质是<strong>概率预测</strong>，它是基于训练数据生成下一个字的，而不是基于逻辑运算或实时数据库。</p>
<ul>
<li><strong>数学计算</strong>：大模型是“文科生”，复杂的计算容易产生幻觉。</li>
<li><strong>实时信息</strong>：大模型的训练数据截止于过去，它无法预知“今天”发生的事情。</li>
</ul>
<p><strong>LangChain Tool 的出现解决了这个问题。</strong> 它的核心思想是：
当用户问“1234 + 5678 等于几？”时，大模型不再自己瞎猜，而是分析出“哦，这是一个计算任务”，然后告诉程序：“请帮我调用 <code>add</code> 工具，参数是 <code>a=1234, b=5678</code>”。程序运行完代码后，将结果反馈给用户。</p>
<blockquote>
<p>还有一个重要作用在于：对于简单任务，无需调用大模型自行处理，从而节省宝贵的 <strong>token</strong>；而对于大模型本身难以完成的特定任务 <strong>(实时感知、精准执行或外部操作.....)</strong>，则可以通过调用外部工具来扩展其能力，使其能够间接完成这些工作。</p>
</blockquote>
<p>接下来，我们将通过代码一步步实现这个过程。</p>
<hr/>
<h2 data-id="heading-1">二、 基础入门：定义一个简单的“加法工具”</h2>
<p>我们要讲的第一个知识点是：<strong>如何定义一个工具</strong>。</p>
<p>在 LangChain 中，<code>tool</code> 函数是核心。我们需要引入它，并配合 <code>zod</code> 库来定义参数结构。</p>
<h3 data-id="heading-2">1. 引入必要的依赖</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
<span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>; <span class="hljs-comment">// 关键：用于定义函数参数的类型 schema</span>
</code></pre>
<p>这里重点介绍一下 <strong><code>zod</code></strong>。
大模型输出的是文本（JSON 字符串），而我们的函数需要的是具体的变量（如数字、字符串）。<strong>Zod 的作用就是建立一个“契约”</strong>：它告诉大模型，“如果你要调用这个工具，你必须给我传什么样的参数，是数字还是字符串”。这大大提高了工具调用的准确性。</p>
<h3 data-id="heading-3">2. 编写加法工具 (<code>addTool</code>)</h3>
<p>我们先从最简单的加法开始，让大模型学会算术。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 函数 定义一个加法工具</span>
<span class="hljs-keyword">const</span> addTool = <span class="hljs-title function_">tool</span>(
    <span class="hljs-comment">// 1. 工具的具体逻辑（函数体）</span>
    <span class="hljs-comment">// 这里接收一个对象，解构出 a 和 b</span>
    <span class="hljs-comment">// 注意：所有工具函数的参数通常都会被包装成一个对象</span>
    <span class="hljs-keyword">async</span> ({a, b}) =&gt; <span class="hljs-title class_">String</span>(a + b), 
    {
        <span class="hljs-comment">// 2. 工具的元数据（Metadata）</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">"add"</span>, <span class="hljs-comment">// 工具名称，大模型通过这个名字识别工具</span>
        <span class="hljs-attr">description</span>: <span class="hljs-string">"计算两个数字的和"</span>, <span class="hljs-comment">// 工具描述，非常重要！这相当于写给大模型的 Prompt，告诉它什么时候用这个工具</span>
        
        <span class="hljs-comment">// 3. 参数 Schema 定义</span>
        <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
            <span class="hljs-attr">a</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"加数 a"</span>), <span class="hljs-comment">// 明确告诉模型，a 必须是一个数字</span>
            <span class="hljs-attr">b</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"加数 b"</span>)  <span class="hljs-comment">// b 也必须是一个数字</span>
        })
    }
)
</code></pre>
<p><strong>代码深度解析：</strong></p>
<ul>
<li><strong><code>tool(function, options)</code></strong>: 这是定义工具的标准范式。第一个参数是实际执行的 JavaScript 函数，第二个参数是配置对象。</li>
<li><strong><code>async ({a, b})</code></strong>: LangChain 的工具调用通常是异步的。参数被设计为解构形式，这是为了配合 Zod 定义的 Object Schema。</li>
<li><strong><code>description</code></strong>: 千万不要忽视描述！大模型正是通过这段文字来判断用户的问题是否需要使用该工具。如果描述写得含糊，模型可能就不会调用它。</li>
<li><strong><code>z.number()</code></strong>: 这里限制了 <code>a</code> 和 <code>b</code> 必须是数字。如果模型抽风传了字符串，Zod 会在底层进行校验或报错，保证了程序的健壮性。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 进阶实战：定义“天气查询工具”</h2>
<p>学会了简单的加法，我们来模拟一个更贴近真实场景的业务——查询天气。
由于我们没有连接真实的气象局 API，这里我们使用一个“伪数据库”来模拟。</p>
<h3 data-id="heading-5">1. 模拟数据源</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fakeWeatherDB = {
    北京: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"30°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"微风"</span> },
    上海: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"28°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"东风 3 级"</span> },
    广州: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"32°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"阵雨"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"南风 2 级"</span> }
}
</code></pre>
<h3 data-id="heading-6">2. 编写天气工具 (<code>weatherTool</code>)</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> weatherTool = <span class="hljs-title function_">tool</span>(
    <span class="hljs-keyword">async</span> ({city}) =&gt; {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">const</span> weather = fakeWeatherDB[city];
        <span class="hljs-comment">// 边界情况处理</span>
        <span class="hljs-keyword">if</span>(!weather){
            <span class="hljs-keyword">return</span> <span class="hljs-string">`城市<span class="hljs-subst">${city}</span>的天气未找到`</span>;
        }
        <span class="hljs-comment">// 返回自然语言描述的结果，方便大模型理解</span>
       <span class="hljs-keyword">return</span> <span class="hljs-string">`当前<span class="hljs-subst">${city}</span>的天气是<span class="hljs-subst">${weather.temp}</span>,<span class="hljs-subst">${weather.condition}</span>, 风力<span class="hljs-subst">${weather.wind}</span>`</span>;
    },
    {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"查询指定城市的今日天气情况"</span>, <span class="hljs-comment">// 明确的功能描述</span>
        <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
            <span class="hljs-comment">// z.string() 规定参数 city 必须是字符串</span>
            <span class="hljs-comment">// .describe() 进一步解释参数含义，帮助模型提取正确的实体</span>
            <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"要查询天气的城市"</span>) 
        })
    }
)
</code></pre>
<p><strong>知识点延伸：</strong>
在 <code>weatherTool</code> 中，我们看到了工具不仅仅是计算，还可以是<strong>查表、请求 API、读取文件</strong>。</p>
<ul>
<li><strong>返回值</strong>：工具的返回值通常是字符串。为什么？因为这个返回值最终是要喂回给大模型的，大模型理解文本能力最强。</li>
<li><strong>Error Handling</strong>：我们在代码中判断了 <code>if(!weather)</code>。在真实开发中，工具内部做好错误处理非常重要，否则一个异常可能导致整个对话崩塌。</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、 链接大脑：绑定工具到模型</h2>
<p>工具定义好了，就像家里买了吸尘器和洗碗机，但如果作为“管家”的大模型不知道它们的存在，也是白搭。我们需要将工具**绑定（Bind）**到模型上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实例化 DeepSeek 模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 设置为 0，让模型更理性、逻辑更严密，减少胡言乱语</span>
}).<span class="hljs-title function_">bindTools</span>([addTool, weatherTool]) <span class="hljs-comment">// 核心步骤：绑定工具数组</span>
</code></pre>
<p><strong>解析：</strong></p>
<ul>
<li><strong><code>.bindTools([...])</code></strong>: 这一步发生了很多魔法。LangChain 会自动将我们要定义的 <code>addTool</code> 和 <code>weatherTool</code> 的 <code>name</code>、<code>description</code> 以及 <code>zod schema</code> 转换成 OpenAI 兼容的 JSON 格式，并发送给 DeepSeek 模型。</li>
<li>此时，模型不仅知道“我是谁”，还知道“我手边有两个工具：一个能算加法，一个能查天气”。</li>
</ul>
<hr/>
<h2 data-id="heading-8">五、 触发调用与结果处理（重点：可选链运算符）</h2>
<p>万事俱备，只欠东风。我们向模型提问，看看它如何反应。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 发起提问</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'北京今天的天气怎么样'</span>);
</code></pre>
<p>当这句话发出去后，DeepSeek 会进行如下思考：</p>
<ol>
<li>用户问的是天气。</li>
<li>我有 <code>get_weather</code> 工具吗？有。</li>
<li>工具描述说它能“查询指定城市天气”。匹配成功！</li>
<li>提取参数：城市是“北京”。</li>
<li><strong>决策</strong>：我不直接回答文本，而是返回一个“工具调用请求（Tool Call）”。</li>
</ol>
<h3 data-id="heading-9">处理响应：可选链运算符 (<code>?.</code>) 的妙用</h3>
<p>模型返回的 <code>res</code> 对象中，包含了很多信息。如果模型决定调用工具，<code>res.tool_calls</code> 属性就会有值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可选链运算符 es6 新增 代码的简洁和优雅</span>
<span class="hljs-comment">// 传统写法（繁琐）：</span>
<span class="hljs-comment">// if(res.tool_calls){</span>
<span class="hljs-comment">//     if(res.tool_calls.length){</span>
<span class="hljs-comment">//         // ...</span>
<span class="hljs-comment">//     }</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// 现代写法（推荐）：</span>
<span class="hljs-keyword">if</span>(res.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"模型决定调用工具:"</span>, res.<span class="hljs-property">tool_calls</span>);
    
    <span class="hljs-comment">// 获取第一个工具调用的指令</span>
    <span class="hljs-keyword">const</span> toolCall = res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 根据工具名称，分发执行逻辑</span>
    <span class="hljs-keyword">if</span>(toolCall.<span class="hljs-property">name</span> === <span class="hljs-string">'add'</span>){
        <span class="hljs-comment">// 执行加法工具</span>
        <span class="hljs-comment">// toolCall.args 包含了模型提取好的参数 {a: ..., b: ...}</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> addTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"加法工具运行结果:"</span>, result);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(toolCall.<span class="hljs-property">name</span> === <span class="hljs-string">'get_weather'</span>){
        <span class="hljs-comment">// 执行天气工具</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"天气工具运行结果:"</span>, result);
    }
}
</code></pre>
<h4 data-id="heading-10">为了直观理解函数打印一下<code>res.tool_calls看看</code>：</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07553c2cc4d405c9e0210bda1549e62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We56eY55qE54yq5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767369109&amp;x-signature=tnd%2FlLx5RpCjLK3yfnvN4g5saWM%3D" alt="屏幕截图 2025-12-26 234001.png" loading="lazy"/></p>
<blockquote>
<p>你可以直观地看到调用结构：<code>name</code> 和工具定义里的 <code>name</code> 一模一样，而 <code>args</code> 则是大模型在理解用户问题后，根据<code>tool</code>要求的参数格式，自动“填好”的输入内容。</p>
</blockquote>
<p><strong>知识点详解：可选链运算符 (<code>?.</code>)</strong></p>
<p>在 JavaScript 中，处理深层嵌套的对象属性时，经常会遇到 <code>Cannot read property of undefined</code> 的报错。</p>
<ul>
<li><code>res.tool_calls</code> 可能不存在（如果模型认为不需要调用工具，只是普通聊天）。</li>
<li>如果不使用 <code>?.</code>，我们需要写多层 <code>if</code> 判断来确保安全。</li>
<li><strong><code>res.tool_calls?.length</code></strong> 的意思是：如果 <code>res.tool_calls</code> 存在（不为 null 或 undefined），则读取 <code>.length</code>；否则，直接返回 <code>undefined</code>，不会报错。配合 <code>if</code> 语句，<code>undefined</code> 会被视为 false，逻辑非常通顺。</li>
</ul>
<p>这一小小的语法糖，极大地提升了代码的<strong>简洁性</strong>和<strong>优雅度</strong>，是现代 JS 开发的必备技巧。</p>
<hr/>
<h2 data-id="heading-11">六、 完整流程总结</h2>
<p>让我们回顾一下这段代码运行的完整生命周期：</p>
<ol>
<li><strong>定义阶段</strong>：我们用 <code>tool()</code> 和 <code>zod</code> 精确描述了 <code>add</code> 和 <code>get_weather</code> 两个工具的功能和参数格式。</li>
<li><strong>绑定阶段</strong>：通过 <code>.bindTools()</code> 将这些能力的“说明书”发给了 DeepSeek 大模型。</li>
<li><strong>推理阶段</strong>：用户提问“北京天气”，模型分析语义，命中 <code>get_weather</code> 工具，并精准提取出 <code>city: "北京"</code>。</li>
<li><strong>响应阶段</strong>：模型返回包含 <code>tool_calls</code> 的响应对象。</li>
<li><strong>执行阶段</strong>：我们的代码通过 <code>?.</code> 安全地检测到调用请求，并在本地运行了 <code>weatherTool</code> 函数，通过查阅 <code>fakeWeatherDB</code> 得到了结果。</li>
</ol>
<h3 data-id="heading-12">运行效果预览</h3>
<p>当你运行这段代码（<code>node index.js</code>），控制台会输出：</p>
<pre><code class="hljs language-bash" lang="bash">[
  {
    name: <span class="hljs-string">'get_weather'</span>,
    args: { city: <span class="hljs-string">'北京'</span> },
    <span class="hljs-built_in">id</span>: <span class="hljs-string">'call_xxxxxxxxx'</span>
  }
]
最终结果: 当前北京的天气是30°C,晴, 风力微风
</code></pre>
<p>如果你把问题改成 <code>model.invoke('100 加 200 等于几')</code>，它会自动切换逻辑：</p>
<pre><code class="hljs language-bash" lang="bash">[
  {
    name: <span class="hljs-string">'add'</span>,
    args: { a: 100, b: 200 },
    <span class="hljs-built_in">id</span>: <span class="hljs-string">'call_yyyyyyyyy'</span>
  }
]
最终结果: 300
</code></pre>
<hr/>
<h2 data-id="heading-13">七、 结语</h2>
<p>通过这篇文章，我们不仅学习了 LangChain 中 <code>tool</code> 的基础用法，还掌握了如何利用 <code>zod</code> 进行数据验证以及使用 ES6+ 的可选链运算符编写健壮的代码。</p>
<p>Tools 模块彻底改变了大模型的应用形态。它让大模型从一个“只读”的百科全书，进化成了一个能“读写”现实世界的智能代理（Agent）。</p>
<p>赶快打开你的编辑器，试着定义属于你自己的工具吧！不管是查询股票、发送邮件，还是控制智能家居，LangChain 都能帮你实现。</p>
<hr/>
<p><em>本文代码示例基于 LangChain.js 最新版本，欢迎点赞收藏！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中JSON序列化和反序列化的实现]]></title>    <link>https://juejin.cn/post/7588010346070851594</link>    <guid>https://juejin.cn/post/7588010346070851594</guid>    <pubDate>2025-12-27T01:52:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346070851594" data-draft-id="7588010346070835210" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中JSON序列化和反序列化的实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T01:52:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中JSON序列化和反序列化的实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:52:26.000Z" title="Sat Dec 27 2025 01:52:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p><strong>序列化</strong>（Serialization）是指将程序中的内存对象（如结构体、类实例、列表等）转换成一种<strong>可以存储或传输的格式</strong>（通常是字节流或文本）的过程。常见的序列化格式包括：</p>
<ul>
<li>JSON（文本，人类可读）</li>
<li>XML</li>
<li>Protocol Buffers（二进制，高效）</li>
<li>MessagePack</li>
<li>YAML</li>
<li>甚至自定义的二进制格式</li>
</ul>
<p><strong>反序列化</strong>（Deserialization）是序列化的逆过程：将<strong>序列化后的数据</strong>（如 JSON 字符串）重新转换回<strong>程序中的内存对象</strong>。</p>
<h2 data-id="heading-1">2. 原因</h2>
<p>那么，为什么需要序列化和反序列化呢？笔者的体会是不序列化/反序列化也行，只不过在进行相应的读取和写入操作的时候会非常繁琐。比如一个配置文件更新：</p>
<p>假设我们有一个博客系统的配置，包含站点标题、作者名、是否启用评论、默认封面地址等多个字段。如果不使用序列化机制，每次读取配置时，就得手动打开 JSON（或 YAML、INI）文件，逐行解析，判断每个字段是否存在、类型是否正确，再一一赋值给程序中的变量；而当用户修改了某个设置、需要保存回文件时，又得手动拼接字符串、处理引号转义、数组格式、缩进对齐……稍有不慎，就会生成格式错误的文件，导致程序下次启动失败。</p>
<p>更麻烦的是，一旦配置结构发生变化——比如新增一个 theme 字段，或者把 enableComments 拆成 enablePostComments 和 enablePageComments——我们就不得不同时修改读取逻辑、写入逻辑、默认值初始化、错误处理等多处代码，极易遗漏或出错。</p>
<p>而有了序列化和反序列化，这一切就变得简洁而可靠：定义好结构体（或类），注册对应的转换函数，一行代码就能从 JSON 构造出完整的配置对象，另一行代码就能把修改后的对象写回文件。字段增减只需调整结构体，读写逻辑几乎无需改动，既减少了重复劳动，也大大提升了健壮性和可维护性。</p>
<p>因此，序列化/反序列化并非“必须”，但它是对抗复杂性、提升开发效率和系统可靠性的重要工具。</p>
<h2 data-id="heading-2">3. 实现</h2>
<h3 data-id="heading-3">3.1 示例</h3>
<p>这里就举例实现一下 C++ 中 JSON 序列化和反序列化。如果要反序列化成 C++ 可以使用的内存对象，最好的数据容器就是 struct 。当然 class 也可以，不过我们都知道 struct 和 class 的区别：struct 的成员一般默认是公有的，而 class 的成员一般默认是私有的。因此，struct 适合以数据成员为主的，比较简单的对象；class 适合以方法成员为主的，比较复杂的对象。</p>
<p>笔者使用 nlohmann/json 中序列化/反序列化一个表达博客的数据对象：</p>
<p><strong>BlogMeta.h</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"PostStats.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">/// @brief 一篇博客的元数据</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlogMeta</span> {&#13;
  std::string id;&#13;
  std::string title;&#13;
  std::string summary;&#13;
  std::string createdTime;&#13;
  std::string updatedTime;  &#13;
  std::string coverAddress;&#13;
  <span class="hljs-type">int64_t</span> isDraft;&#13;
  std::vector&lt;std::string&gt; tagNames;&#13;
  std::vector&lt;std::string&gt; categoryNames;&#13;
  PostStats postStats;&#13;
&#13;
  <span class="hljs-comment">// 提供序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span></span>;&#13;
&#13;
  <span class="hljs-comment">// 提供反序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span></span>;&#13;
};
</code></pre>
<p><strong>BlogMeta.cpp</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"BlogMeta.h"</span></span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Util/GetTime.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">// 提供序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span> </span>{&#13;
  j = nlohmann::json{{<span class="hljs-string">"id"</span>, s.id},&#13;
                     {<span class="hljs-string">"title"</span>, s.title},&#13;
                     {<span class="hljs-string">"summary"</span>, s.summary},&#13;
                     {<span class="hljs-string">"createdTime"</span>, s.createdTime},&#13;
                     {<span class="hljs-string">"updatedTime"</span>, s.updatedTime},&#13;
                     {<span class="hljs-string">"coverAddress"</span>, s.coverAddress},&#13;
                     {<span class="hljs-string">"isDraft"</span>, s.isDraft},&#13;
                     {<span class="hljs-string">"tagNames"</span>, s.tagNames},&#13;
                     {<span class="hljs-string">"categoryNames"</span>, s.categoryNames},&#13;
                     {<span class="hljs-string">"postStats"</span>, s.postStats}};&#13;
}&#13;
&#13;
<span class="hljs-comment">// 提供反序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
  s.id = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"id"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.title = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"title"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.summary = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"summary"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.createdTime = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"createdTime"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.updatedTime =&#13;
      j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"updatedTime"</span>, Util::<span class="hljs-built_in">GetCurrentTime</span>());  <span class="hljs-comment">//提供默认值，增加稳定性</span>&#13;
  s.coverAddress = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"coverAddress"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.isDraft = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"isDraft"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.tagNames = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"tagNames"</span>).get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
  s.categoryNames = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"categoryNames"</span>).get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
  s.postStats = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"postStats"</span>).<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
}&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<p>其中 <code>to_json</code> / <code>from_json</code> 就是对应的 序列化 / 反序列化接口。只需要填充这一对接口，就可以通过赋值运算符<code>=</code>实现自动序列化和反序列化：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"BlogMeta.h"</span>  <span class="hljs-comment">// 包含你的 BlogMeta 定义</span></span>&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{&#13;
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> DataTransfer;&#13;
    <span class="hljs-keyword">using</span> json = nlohmann::json;&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 1. 创建一个 BlogMeta 对象（内存中的数据）</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    BlogMeta blog;&#13;
    blog.id = <span class="hljs-string">"blog-001"</span>;&#13;
    blog.title = <span class="hljs-string">"深入理解 C++ 序列化"</span>;&#13;
    blog.summary = <span class="hljs-string">"本文介绍如何使用 nlohmann/json 进行安全高效的序列化。"</span>;&#13;
    blog.createdTime = <span class="hljs-string">"2025-12-22T10:00:00Z"</span>;&#13;
    blog.updatedTime = <span class="hljs-string">"2025-12-22T17:00:00Z"</span>;  <span class="hljs-comment">// 可省略，反序列化时会用默认值</span>&#13;
    blog.coverAddress = <span class="hljs-string">"/images/cpp_serialization.jpg"</span>;&#13;
    blog.isDraft = <span class="hljs-number">0</span>;&#13;
    blog.tagNames = {<span class="hljs-string">"C++"</span>, <span class="hljs-string">"JSON"</span>, <span class="hljs-string">"Serialization"</span>};&#13;
    blog.categoryNames = {<span class="hljs-string">"Programming"</span>, <span class="hljs-string">"Tutorial"</span>};&#13;
    blog.postStats = {<span class="hljs-number">1200</span>, <span class="hljs-number">85</span>, <span class="hljs-number">23</span>};&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 2. 序列化：BlogMeta → JSON</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    json j = blog;  <span class="hljs-comment">// 自动调用 to_json</span>&#13;
    std::cout &lt;&lt; <span class="hljs-string">"【序列化结果】\n"</span> &lt;&lt; j.<span class="hljs-built_in">dump</span>(<span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-string">"\n\n"</span>;&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 3. 反序列化：JSON → BlogMeta</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 模拟从文件或网络接收到的 JSON（故意省略 updatedTime）</span>&#13;
    std::string jsonStr = <span class="hljs-string">R"({&#13;
        "id": "blog-002",&#13;
        "title": "反序列化的健壮性测试",&#13;
        "summary": "测试缺失 updatedTime 字段时的行为",&#13;
        "createdTime": "2025-12-20T08:30:00Z",&#13;
        "coverAddress": "/images/robust.png",&#13;
        "isDraft": 1,&#13;
        "tagNames": ["C++", "Robustness"],&#13;
        "categoryNames": ["Engineering"],&#13;
        "postStats": {&#13;
            "viewCount": 450,&#13;
            "likeCount": 30,&#13;
            "commentCount": 5&#13;
        }&#13;
    })"</span>;&#13;
 &#13;
    BlogMeta restoredBlog = json::<span class="hljs-built_in">parse</span>(jsonStr);  <span class="hljs-comment">// 自动调用 from_json</span>&#13;
  &#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 4. 验证反序列化结果</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    std::cout &lt;&lt; <span class="hljs-string">"【反序列化结果】\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"ID: "</span> &lt;&lt; restoredBlog.id &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Title: "</span> &lt;&lt; restoredBlog.title &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"UpdatedTime (应为当前默认值): "</span> &lt;&lt; restoredBlog.updatedTime &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Is Draft: "</span> &lt;&lt; restoredBlog.isDraft &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Tags: "</span>;&#13;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; tag : restoredBlog.tagNames) {&#13;
        std::cout &lt;&lt; tag &lt;&lt; <span class="hljs-string">" "</span>;&#13;
    }&#13;
    std::cout &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
&#13;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#13;
}
</code></pre>
<h3 data-id="heading-4">3.2 能力</h3>
<p>序列化 / 反序列化的能力取决于所使用的库实现的程度。例如这个例子中，std 容器 <code>std::vector&lt;std::string&gt;</code> 也可以直接使用赋值运算符<code>=</code>来序列化/反序列化吗？确实是可以的，nlohmann/json 支持所有基础类型以及绝大多数 std 容器类型的直接 序列化/ 反序列化。不过默认情况下，C++ 数据类型与JSON的对应关系是：std::string 对应字符串， int64_t， uint64_t 或 double 对应数字， std::map 对应对象， std::vector 对应数组，且 bool 对应布尔值。</p>
<p>另外，nlohmann/json 还支持嵌套序列化。比如这里的 PostStats 其实也是个自定义的 struct ，也实现了 <code>to_json</code> / <code>from_json</code> 接口，因此可以直接通过赋值运算符<code>=</code>相互转换。</p>
<p><strong>PostStats.h</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">/// @brief 一篇博客的统计信息</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PostStats</span> {&#13;
  <span class="hljs-type">int64_t</span> viewCount = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 阅读量</span>&#13;
  <span class="hljs-type">int64_t</span> likeCount = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 点赞量</span>&#13;
  <span class="hljs-type">int64_t</span> commentCount = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 评论量</span>&#13;
&#13;
  <span class="hljs-comment">// 提供序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> PostStats&amp; s)</span></span>;&#13;
&#13;
  <span class="hljs-comment">// 提供反序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, PostStats&amp; s)</span></span>;&#13;
};&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<p><strong>PostStats.cpp</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"PostStats.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">// 提供序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> PostStats&amp; s)</span> </span>{&#13;
  j = nlohmann::json{{<span class="hljs-string">"viewCount"</span>, s.viewCount},&#13;
                     {<span class="hljs-string">"likeCount"</span>, s.likeCount},&#13;
                     {<span class="hljs-string">"commentCount"</span>, s.commentCount}};&#13;
}&#13;
&#13;
<span class="hljs-comment">// 提供反序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, PostStats&amp; s)</span> </span>{&#13;
  s.viewCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"viewCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.likeCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"likeCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.commentCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"commentCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
}&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<h3 data-id="heading-5">3.3 兼容</h3>
<p>如果 JSON 配置文件进行了升级，比如增加了一个新的配置字段，那么新的程序读取旧的配置文件就有可能出错，所以在反序列化的时候最好使用 value() 提供默认值：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
  s.id = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"id"</span>, std::string{});&#13;
  s.title = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"title"</span>, std::string{});&#13;
  s.summary = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"summary"</span>, std::string{});&#13;
  s.createdTime = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"createdTime"</span>, std::string{});&#13;
  s.updatedTime = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"updatedTime"</span>, std::string{}); <span class="hljs-comment">// 若缺失则为空字符串</span>&#13;
  s.coverAddress = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"coverAddress"</span>, std::string{});&#13;
  s.isDraft = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"isDraft"</span>, <span class="hljs-type">int64_t</span>{<span class="hljs-number">0</span>});&#13;
  s.tagNames = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"tagNames"</span>, std::vector&lt;std::string&gt;{});&#13;
  s.categoryNames = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"categoryNames"</span>, std::vector&lt;std::string&gt;{});&#13;
&#13;
  <span class="hljs-comment">// 对于嵌套结构如 PostStats，如果它也支持 from_json，可这样处理：</span>&#13;
  <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"postStats"</span>) &amp;&amp; j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">is_object</span>()) {&#13;
    s.postStats = j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
  } <span class="hljs-keyword">else</span> {&#13;
    s.postStats = PostStats{}; <span class="hljs-comment">// 默认构造</span>&#13;
  }&#13;
}
</code></pre>
<p>另外，如果业务逻辑允许，能分清楚哪些是必须字段，哪些是可选字段，那么可以使用<code>std::optional</code>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">/// @brief 一篇博客的元数据（健壮版，支持可选字段）</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlogMeta</span> {&#13;
    std::string id;                          <span class="hljs-comment">// 必填</span>&#13;
    std::string title;                       <span class="hljs-comment">// 必填</span>&#13;
    std::optional&lt;std::string&gt; summary;&#13;
    std::string createdTime;                 <span class="hljs-comment">// 通常必填，也可改为 optional</span>&#13;
    std::optional&lt;std::string&gt; updatedTime;  &#13;
    std::optional&lt;std::string&gt; coverAddress;&#13;
    std::optional&lt;<span class="hljs-type">int64_t</span>&gt; isDraft;          <span class="hljs-comment">// 可选，默认 false 或 0</span>&#13;
    std::optional&lt;std::vector&lt;std::string&gt;&gt; tagNames;&#13;
    std::optional&lt;std::vector&lt;std::string&gt;&gt; categoryNames;&#13;
    std::optional&lt;PostStats&gt; postStats;&#13;
&#13;
    <span class="hljs-comment">// 序列化/反序列化友元声明</span>&#13;
    <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span></span>;&#13;
    <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span></span>;&#13;
};&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span> </span>{&#13;
    j = nlohmann::json{&#13;
        {<span class="hljs-string">"id"</span>, s.id},&#13;
        {<span class="hljs-string">"title"</span>, s.title},&#13;
        {<span class="hljs-string">"summary"</span>, s.summary},&#13;
        {<span class="hljs-string">"createdTime"</span>, s.createdTime},&#13;
        {<span class="hljs-string">"updatedTime"</span>, s.updatedTime},&#13;
        {<span class="hljs-string">"coverAddress"</span>, s.coverAddress},&#13;
        {<span class="hljs-string">"isDraft"</span>, s.isDraft},&#13;
        {<span class="hljs-string">"tagNames"</span>, s.tagNames},&#13;
        {<span class="hljs-string">"categoryNames"</span>, s.categoryNames},&#13;
        {<span class="hljs-string">"postStats"</span>, s.postStats}&#13;
    };&#13;
}&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
    <span class="hljs-comment">// 必填字段：使用 at()，缺失时报错</span>&#13;
    s.id = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"id"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    s.title = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"title"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    s.createdTime = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"createdTime"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;(); <span class="hljs-comment">// 若你也想让它可选，改用 value 或 optional</span>&#13;
&#13;
    <span class="hljs-comment">// 可选字段：直接赋值，nlohmann 自动处理存在性</span>&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"summary"</span>))       s.summary = j[<span class="hljs-string">"summary"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"updatedTime"</span>))   s.updatedTime = j[<span class="hljs-string">"updatedTime"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"coverAddress"</span>))  s.coverAddress = j[<span class="hljs-string">"coverAddress"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"isDraft"</span>))       s.isDraft = j[<span class="hljs-string">"isDraft"</span>].<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"tagNames"</span>))      s.tagNames = j[<span class="hljs-string">"tagNames"</span>].get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"categoryNames"</span>)) s.categoryNames = j[<span class="hljs-string">"categoryNames"</span>].get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"postStats"</span>))     s.postStats = j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>