<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[SpringBoot 动态菜单权限系统设计的企业级解决方案]]></title>    <link>https://juejin.cn/post/7578836326475776027</link>    <guid>https://juejin.cn/post/7578836326475776027</guid>    <pubDate>2025-12-02T12:06:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578836326475776027" data-draft-id="7571278865516986418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 动态菜单权限系统设计的企业级解决方案"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-02T12:06:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 动态菜单权限系统设计的企业级解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T12:06:59.000Z" title="Tue Dec 02 2025 12:06:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，前面我们讲了<strong>动态菜单权限管理</strong>的前端实现，今天我们来基于Spring Boot实现后端的功能。</p>
<p><strong>为什么需要动态菜单？</strong></p>
<p>场景：公司里有三种员工：</p>
<ul>
<li><strong>管理员</strong>：需要管理用户、角色、系统设置等所有功能</li>
<li><strong>内容编辑</strong>：只需要管理文章、分类等内容相关功能</li>
<li><strong>普通员工</strong>：只能查看数据报表，不能进行任何修改</li>
</ul>
<p>如果为每个角色开发不同的系统界面，工作量巨大且难以维护。动态菜单就是为了解决这个问题——<strong>一套系统，根据用户角色显示不同的菜单</strong>。</p>
<h2 data-id="heading-0">一、数据库设计</h2>
<h3 data-id="heading-1">核心表结构设计</h3>
<p>我们的权限系统需要5张核心表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表：存储系统用户信息</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_user` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'用户ID'</span>,
  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户名'</span>,
  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'密码'</span>,
  `nickname` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'昵称'</span>,
  `avatar` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'头像'</span>,
  `status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'状态：0-禁用，1-启用'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'用户表'</span>;

<span class="hljs-comment">-- 角色表：定义系统中的角色</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_role` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'角色ID'</span>,
  `role_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色编码'</span>,
  `role_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色名称'</span>,
  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色描述'</span>,
  `status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'状态'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'角色表'</span>;

<span class="hljs-comment">-- 菜单表：系统的所有菜单项</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_menu` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'菜单ID'</span>,
  `parent_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'父菜单ID，0表示根菜单'</span>,
  `menu_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'菜单名称'</span>,
  `menu_icon` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'菜单图标'</span>,
  `menu_type` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'菜单类型：1-目录，2-菜单'</span>,
  `route_path` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'路由路径'</span>,
  `sort_order` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'排序号'</span>,
  `status` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'状态'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'菜单表'</span>;

<span class="hljs-comment">-- 角色菜单关联表：角色拥有哪些菜单权限</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_role_menu` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `role_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色ID'</span>,
  `menu_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'菜单ID'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'角色菜单关联表'</span>;

<span class="hljs-comment">-- 用户角色关联表：用户属于哪些角色</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `sys_user_role` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `role_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'角色ID'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'用户角色关联表'</span>;
</code></pre>
<h3 data-id="heading-2">表关系图解</h3>
<pre><code class="hljs language-scss" lang="scss">用户表 (sys_user) 
    ↑
用户角色表 (sys_user_role)  -- 多对多关系
    ↑  
角色表 (sys_role)
    ↑
角色菜单表 (sys_role_menu)  -- 多对多关系  
    ↑
菜单表 (sys_menu)          -- 树形结构
</code></pre>
<h3 data-id="heading-3">初始化测试数据</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 添加三种角色</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_role` (`role_code`, `role_name`, `description`) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'管理员'</span>, <span class="hljs-string">'系统管理员，拥有所有权限'</span>),
(<span class="hljs-string">'editor'</span>, <span class="hljs-string">'编辑者'</span>, <span class="hljs-string">'内容编辑人员，可以管理内容'</span>),
(<span class="hljs-string">'viewer'</span>, <span class="hljs-string">'查看者'</span>, <span class="hljs-string">'数据查看人员，只能浏览数据'</span>);

<span class="hljs-comment">-- 2. 添加菜单数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_menu` (`parent_id`, `menu_name`, `menu_icon`, `menu_type`, `route_path`, `sort_order`) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">0</span>, <span class="hljs-string">'仪表板'</span>, <span class="hljs-string">'DataBoard'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/dashboard'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">0</span>, <span class="hljs-string">'系统管理'</span>, <span class="hljs-string">'Setting'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'/system'</span>, <span class="hljs-number">100</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'用户管理'</span>, <span class="hljs-string">'User'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/system/user'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'角色管理'</span>, <span class="hljs-string">'Lock'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/system/role'</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'菜单管理'</span>, <span class="hljs-string">'Menu'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/system/menu'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-number">0</span>, <span class="hljs-string">'内容管理'</span>, <span class="hljs-string">'Document'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'/content'</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">6</span>, <span class="hljs-string">'文章管理'</span>, <span class="hljs-string">'Document'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/content/article'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-number">6</span>, <span class="hljs-string">'分类管理'</span>, <span class="hljs-string">'Collection'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/content/category'</span>, <span class="hljs-number">2</span>),
(<span class="hljs-number">0</span>, <span class="hljs-string">'数据统计'</span>, <span class="hljs-string">'DataAnalysis'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'/statistics'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-number">9</span>, <span class="hljs-string">'访问统计'</span>, <span class="hljs-string">'TrendCharts'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'/statistics/visit'</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- 3. 创建管理员用户</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_user` (`username`, `password`, `nickname`) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'admin'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'系统管理员'</span>);

<span class="hljs-comment">-- 4. 设置权限关系</span>
<span class="hljs-comment">-- 管理员拥有所有菜单权限</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_role_menu` (`role_id`, `menu_id`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">7</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">8</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">9</span>),(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>);

<span class="hljs-comment">-- 编辑者拥有部分权限  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_role_menu` (`role_id`, `menu_id`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>),(<span class="hljs-number">2</span>, <span class="hljs-number">6</span>),(<span class="hljs-number">2</span>, <span class="hljs-number">7</span>),(<span class="hljs-number">2</span>, <span class="hljs-number">8</span>);

<span class="hljs-comment">-- 查看者只有仪表板权限</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_role_menu` (`role_id`, `menu_id`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- 设置用户角色</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `sys_user_role` (`user_id`, `role_id`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
</code></pre>
<h2 data-id="heading-4">二、Spring Boot后端实现</h2>
<h3 data-id="heading-5">项目结构规划</h3>
<pre><code class="hljs language-bash" lang="bash">src/main/java/com/example/dynamicmenu/
├── config/           <span class="hljs-comment"># 配置类</span>
├── controller/       <span class="hljs-comment"># 控制器 - 处理HTTP请求</span>
├── entity/          <span class="hljs-comment"># 实体类 - 数据库表映射</span>
├── dto/             <span class="hljs-comment"># 数据传输对象 - 接收前端数据</span>
├── vo/              <span class="hljs-comment"># 视图对象 - 返回给前端的数据</span>
├── mapper/          <span class="hljs-comment"># 数据访问层</span>
├── service/         <span class="hljs-comment"># 业务逻辑层</span>
│   └── impl/        <span class="hljs-comment"># 服务实现类</span>
└── common/          <span class="hljs-comment"># 通用工具类</span>
</code></pre>
<h3 data-id="heading-6">核心实体类设计</h3>
<p><strong>菜单实体类 - Menu.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("sys_menu")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Menu</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-keyword">private</span> Long parentId;        <span class="hljs-comment">// 父菜单ID</span>
    <span class="hljs-keyword">private</span> String menuName;      <span class="hljs-comment">// 菜单名称</span>
    <span class="hljs-keyword">private</span> String menuIcon;      <span class="hljs-comment">// 菜单图标</span>
    <span class="hljs-keyword">private</span> Integer menuType;     <span class="hljs-comment">// 菜单类型</span>
    <span class="hljs-keyword">private</span> String routePath;     <span class="hljs-comment">// 路由路径</span>
    <span class="hljs-keyword">private</span> Integer sortOrder;    <span class="hljs-comment">// 排序号</span>
    <span class="hljs-keyword">private</span> Integer status;       <span class="hljs-comment">// 状态</span>
    
    <span class="hljs-meta">@TableField(exist = false)</span>   <span class="hljs-comment">// 非数据库字段</span>
    <span class="hljs-keyword">private</span> List&lt;Menu&gt; children;  <span class="hljs-comment">// 子菜单列表</span>
}
</code></pre>
<p><strong>角色实体类 - Role.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("sys_role")</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-keyword">private</span> String roleCode;     <span class="hljs-comment">// 角色编码</span>
    <span class="hljs-keyword">private</span> String roleName;     <span class="hljs-comment">// 角色名称</span>
    <span class="hljs-keyword">private</span> String description;  <span class="hljs-comment">// 角色描述</span>
    <span class="hljs-keyword">private</span> Integer status;
}
</code></pre>
<h3 data-id="heading-7">数据传输对象设计</h3>
<p><strong>登录请求DTO - LoginDTO.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "用户名不能为空")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@NotBlank(message = "密码不能为空")</span> 
    <span class="hljs-keyword">private</span> String password;
}
</code></pre>
<p><strong>菜单视图对象 - MenuVO.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuVO</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long parentId;
    <span class="hljs-keyword">private</span> String name;      <span class="hljs-comment">// 菜单名称</span>
    <span class="hljs-keyword">private</span> String icon;      <span class="hljs-comment">// 菜单图标  </span>
    <span class="hljs-keyword">private</span> String route;     <span class="hljs-comment">// 路由路径</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; roles; <span class="hljs-comment">// 可访问的角色</span>
    <span class="hljs-keyword">private</span> List&lt;MenuVO&gt; children; <span class="hljs-comment">// 子菜单</span>
}
</code></pre>
<h3 data-id="heading-8">核心业务逻辑实现</h3>
<p><strong>菜单服务类 - MenuServiceImpl.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MenuService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MenuMapper menuMapper;
    
    <span class="hljs-comment">/**
     * 根据角色获取菜单树
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;MenuVO&gt; <span class="hljs-title function_">getMenuTreeByRole</span><span class="hljs-params">(String roleCode)</span> {
        <span class="hljs-comment">// 1. 查询该角色有权限的菜单列表</span>
        List&lt;Menu&gt; menuList = menuMapper.selectMenusByRoleCode(roleCode);
        
        <span class="hljs-comment">// 2. 构建菜单树形结构</span>
        <span class="hljs-keyword">return</span> buildMenuTree(menuList);
    }
    
    <span class="hljs-comment">/**
     * 构建菜单树 - 核心算法
     */</span>
    <span class="hljs-keyword">private</span> List&lt;MenuVO&gt; <span class="hljs-title function_">buildMenuTree</span><span class="hljs-params">(List&lt;Menu&gt; menuList)</span> {
        <span class="hljs-keyword">if</span> (menuList == <span class="hljs-literal">null</span> || menuList.isEmpty()) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        }
        
        <span class="hljs-comment">// 找出所有根菜单（parentId = 0）</span>
        List&lt;MenuVO&gt; rootMenus = menuList.stream()
                .filter(menu -&gt; menu.getParentId() == <span class="hljs-number">0</span>)
                .sorted(Comparator.comparing(Menu::getSortOrder))
                .map(<span class="hljs-built_in">this</span>::convertToVO)
                .collect(Collectors.toList());
        
        <span class="hljs-comment">// 为每个根菜单递归查找子菜单</span>
        <span class="hljs-keyword">for</span> (MenuVO rootMenu : rootMenus) {
            findChildren(rootMenu, menuList);
        }
        
        <span class="hljs-keyword">return</span> rootMenus;
    }
    
    <span class="hljs-comment">/**
     * 递归查找子菜单
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findChildren</span><span class="hljs-params">(MenuVO parentMenu, List&lt;Menu&gt; allMenus)</span> {
        List&lt;MenuVO&gt; children = allMenus.stream()
                .filter(menu -&gt; parentMenu.getId().equals(menu.getParentId()))
                .sorted(Comparator.comparing(Menu::getSortOrder))
                .map(<span class="hljs-built_in">this</span>::convertToVO)
                .collect(Collectors.toList());
        
        <span class="hljs-keyword">if</span> (!children.isEmpty()) {
            parentMenu.setChildren(children);
            <span class="hljs-comment">// 递归处理子菜单的子菜单</span>
            <span class="hljs-keyword">for</span> (MenuVO child : children) {
                findChildren(child, allMenus);
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 将Menu实体转换为MenuVO视图对象
     */</span>
    <span class="hljs-keyword">private</span> MenuVO <span class="hljs-title function_">convertToVO</span><span class="hljs-params">(Menu menu)</span> {
        <span class="hljs-type">MenuVO</span> <span class="hljs-variable">vo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MenuVO</span>();
        vo.setId(menu.getId());
        vo.setParentId(menu.getParentId());
        vo.setName(menu.getMenuName());
        vo.setIcon(menu.getMenuIcon());
        vo.setRoute(menu.getRoutePath());
        
        <span class="hljs-comment">// 设置可访问角色（实际应该从数据库查询）</span>
        List&lt;String&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        roles.add(<span class="hljs-string">"admin"</span>);
        roles.add(<span class="hljs-string">"editor"</span>); 
        roles.add(<span class="hljs-string">"viewer"</span>);
        vo.setRoles(roles);
        
        <span class="hljs-keyword">return</span> vo;
    }
}
</code></pre>
<h3 data-id="heading-9">控制器层的实现</h3>
<p><strong>认证控制器 - AuthController.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/auth")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 用户登录接口
     */</span>
    <span class="hljs-meta">@PostMapping("/login")</span>
    <span class="hljs-keyword">public</span> Result&lt;LoginResult&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginDTO loginDTO)</span> {
        <span class="hljs-comment">// 1. 验证用户名密码</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-string">"admin"</span>.equals(loginDTO.getUsername()) || 
            !<span class="hljs-string">"123456"</span>.equals(loginDTO.getPassword())) {
            <span class="hljs-keyword">return</span> Result.error(<span class="hljs-string">"用户名或密码错误"</span>);
        }
        
        <span class="hljs-comment">// 2. 获取用户信息（包含菜单权限）</span>
        <span class="hljs-type">UserInfoVO</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userService.getUserInfo(loginDTO.getUsername());
        
        <span class="hljs-comment">// 3. 返回登录结果</span>
        <span class="hljs-type">LoginResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginResult</span>();
        result.setUserInfo(userInfo);
        result.setToken(<span class="hljs-string">"mock-jwt-token-"</span> + System.currentTimeMillis());
        
        <span class="hljs-keyword">return</span> Result.success(result);
    }
    
    <span class="hljs-comment">/**
     * 切换角色接口
     */</span>
    <span class="hljs-meta">@PostMapping("/switchRole")</span>
    <span class="hljs-keyword">public</span> Result&lt;UserInfoVO&gt; <span class="hljs-title function_">switchRole</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String roleCode)</span> {
        <span class="hljs-comment">// 模拟用户角色切换</span>
        <span class="hljs-type">UserInfoVO</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userService.getUserInfo(<span class="hljs-string">"admin"</span>);
        userInfo.setRole(roleCode);
        
        <span class="hljs-comment">// 重新获取该角色的菜单</span>
        userInfo.setMenus(userService.getMenuTreeByRole(roleCode));
        
        <span class="hljs-keyword">return</span> Result.success(userInfo);
    }
}
</code></pre>
<p><strong>菜单控制器 - MenuController.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/menu")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MenuService menuService;
    
    <span class="hljs-comment">/**
     * 获取菜单树接口
     */</span>
    <span class="hljs-meta">@GetMapping("/tree")</span>
    <span class="hljs-keyword">public</span> Result&lt;List&lt;MenuVO&gt;&gt; <span class="hljs-title function_">getMenuTree</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String roleCode)</span> {
        List&lt;MenuVO&gt; menuTree = menuService.getMenuTreeByRole(roleCode);
        <span class="hljs-keyword">return</span> Result.success(menuTree);
    }
}
</code></pre>
<h3 data-id="heading-10">数据访问层</h3>
<p><strong>菜单Mapper接口 - MenuMapper.java</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MenuMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Menu&gt; {
    
    <span class="hljs-comment">/**
     * 根据角色编码查询有权限的菜单
     */</span>
    <span class="hljs-meta">@Select("SELECT m.* FROM sys_menu m " +
            "INNER JOIN sys_role_menu rm ON m.id = rm.menu_id " +
            "INNER JOIN sys_role r ON rm.role_id = r.id " +
            "WHERE r.role_code = #{roleCode} AND m.status = 1 " +
            "ORDER BY m.sort_order ASC")</span>
    List&lt;Menu&gt; <span class="hljs-title function_">selectMenusByRoleCode</span><span class="hljs-params">(<span class="hljs-meta">@Param("roleCode")</span> String roleCode)</span>;
}
</code></pre>
<h3 data-id="heading-11">统一返回结果封装</h3>
<p><strong>Result.java - 统一响应格式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Integer code;      <span class="hljs-comment">// 状态码</span>
    <span class="hljs-keyword">private</span> String message;    <span class="hljs-comment">// 提示信息</span>
    <span class="hljs-keyword">private</span> T data;           <span class="hljs-comment">// 返回数据</span>
    <span class="hljs-keyword">private</span> Long timestamp;   <span class="hljs-comment">// 时间戳</span>
    
    <span class="hljs-comment">// 成功响应</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">200</span>);
        result.setMessage(<span class="hljs-string">"操作成功"</span>);
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 错误响应</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">500</span>);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h2 data-id="heading-12">三、前端Vue3对接改造</h2>
<h3 data-id="heading-13">菜单数据获取改造</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 从后端API获取菜单数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUserMenu</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/menu/tree'</span>, {
      <span class="hljs-attr">params</span>: { <span class="hljs-attr">roleCode</span>: currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span> }
    });
    
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
      <span class="hljs-comment">// 转换后端数据为前端需要的格式</span>
      menuData.<span class="hljs-property">value</span> = <span class="hljs-title function_">transformMenuData</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取菜单失败:'</span>, error);
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'菜单加载失败'</span>);
  }
};

<span class="hljs-comment">// 数据格式转换函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">transformMenuData</span> = (<span class="hljs-params">backendMenus</span>) =&gt; {
  <span class="hljs-keyword">return</span> backendMenus.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">menu</span> =&gt;</span> ({
    <span class="hljs-attr">id</span>: menu.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>(),
    <span class="hljs-attr">name</span>: menu.<span class="hljs-property">name</span>,
    <span class="hljs-attr">icon</span>: menu.<span class="hljs-property">icon</span>,
    <span class="hljs-attr">route</span>: menu.<span class="hljs-property">route</span>,
    <span class="hljs-attr">roles</span>: menu.<span class="hljs-property">roles</span> || [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'editor'</span>, <span class="hljs-string">'viewer'</span>],
    <span class="hljs-attr">children</span>: menu.<span class="hljs-property">children</span> ? <span class="hljs-title function_">transformMenuData</span>(menu.<span class="hljs-property">children</span>) : <span class="hljs-literal">undefined</span>
  }));
};
</code></pre>
<h3 data-id="heading-14">角色切换功能增强</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 角色切换处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRoleChange</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">role</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用后端角色切换接口</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/auth/switchRole'</span>, <span class="hljs-literal">null</span>, {
      <span class="hljs-attr">params</span>: { <span class="hljs-attr">roleCode</span>: role }
    });
    
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">const</span> userInfo = response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
      
      <span class="hljs-comment">// 更新用户信息和菜单</span>
      currentUser.<span class="hljs-property">value</span>.<span class="hljs-property">role</span> = userInfo.<span class="hljs-property">role</span>;
      menuData.<span class="hljs-property">value</span> = <span class="hljs-title function_">transformMenuData</span>(userInfo.<span class="hljs-property">menus</span>);
      
      <span class="hljs-comment">// 更新当前激活菜单</span>
      <span class="hljs-title function_">updateActiveMenu</span>(userInfo.<span class="hljs-property">menus</span>);
      
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">`角色已切换为: <span class="hljs-subst">${getRoleName(role)}</span>`</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'角色切换失败:'</span>, error);
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'角色切换失败'</span>);
  }
};
</code></pre>
<h2 data-id="heading-15">四、核心技术与实现原理</h2>
<h3 data-id="heading-16">1. 菜单树构建算法</h3>
<p>菜单树构建的核心是<strong>递归算法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码说明</span>
function <span class="hljs-title function_">buildMenuTree</span><span class="hljs-params">(所有菜单列表)</span> {
    <span class="hljs-number">1.</span> 找出所有根节点（parentId=<span class="hljs-number">0</span>的菜单）
    <span class="hljs-number">2.</span> 对每个根节点：
       - 找出其直接子节点（parentId=当前节点ID）
       - 递归处理每个子节点
    <span class="hljs-number">3.</span> 返回构建好的树形结构
}
</code></pre>
<h3 data-id="heading-17">2. 权限过滤流程</h3>
<pre><code class="hljs">用户登录 → 获取用户角色 → 查询角色权限菜单 → 构建菜单树 → 返回前端
</code></pre>
<h3 data-id="heading-18">3. 前后端数据格式转换</h3>
<p>后端返回的菜单数据需要转换为前端Element Plus菜单组件需要的格式：</p>






























<table><thead><tr><th>后端字段</th><th>前端字段</th><th>说明</th></tr></thead><tbody><tr><td>menuName</td><td>name</td><td>菜单名称</td></tr><tr><td>menuIcon</td><td>icon</td><td>菜单图标</td></tr><tr><td>routePath</td><td>route</td><td>路由路径</td></tr><tr><td>children</td><td>children</td><td>子菜单</td></tr></tbody></table>
<h2 data-id="heading-19">五、可扩展方案</h2>
<h3 data-id="heading-20">1. 添加权限验证中间件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, 
                           HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 验证token和权限</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-comment">// 权限验证逻辑...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-21">2. 添加菜单缓存</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;
    
    <span class="hljs-keyword">public</span> List&lt;MenuVO&gt; <span class="hljs-title function_">getMenuTreeByRole</span><span class="hljs-params">(String roleCode)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"menu:tree:"</span> + roleCode;
        
        <span class="hljs-comment">// 先查缓存</span>
        List&lt;MenuVO&gt; cachedMenu = (List&lt;MenuVO&gt;) redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (cachedMenu != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> cachedMenu;
        }
        
        <span class="hljs-comment">// 缓存不存在，查询数据库</span>
        List&lt;MenuVO&gt; menuTree = buildMenuTreeFromDB(roleCode);
        
        <span class="hljs-comment">// 存入缓存</span>
        redisTemplate.opsForValue().set(cacheKey, menuTree, <span class="hljs-number">30</span>, TimeUnit.MINUTES);
        
        <span class="hljs-keyword">return</span> menuTree;
    }
}
</code></pre>
<h3 data-id="heading-22">3. 前端路由权限控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 路由守卫</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> userRole = store.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>.<span class="hljs-property">role</span>;
  <span class="hljs-keyword">const</span> requiredRole = to.<span class="hljs-property">meta</span>.<span class="hljs-property">role</span>;
  
  <span class="hljs-keyword">if</span> (requiredRole &amp;&amp; !requiredRole.<span class="hljs-title function_">includes</span>(userRole)) {
    <span class="hljs-title function_">next</span>(<span class="hljs-string">'/403'</span>); <span class="hljs-comment">// 无权限页面</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">next</span>();
  }
});
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>通过本文的完整实现，我们构建了一个功能完善的动态菜单权限管理系统：</p>
<ol>
<li><strong>数据库设计</strong>：合理的表结构是权限系统的基础</li>
<li><strong>后端实现</strong>：Spring Boot + MyBatis Plus提供RESTful API</li>
<li><strong>核心算法</strong>：递归构建菜单树，实现权限过滤</li>
<li><strong>前端对接</strong>：Vue3 + Element Plus渲染动态菜单</li>
<li><strong>扩展优化</strong>：缓存、权限验证等生产级特性</li>
</ol>
<p>这种设计模式具有很好的扩展性，可以轻松应对更复杂的权限需求。希望这篇文章能帮助你深入理解动态菜单的实现原理，并在实际项目中灵活应用。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-24">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MaxKB4j — 基于 Java 的开源 RAG 知识库与 LLM 工作流平台]]></title>    <link>https://juejin.cn/post/7579190764766068776</link>    <guid>https://juejin.cn/post/7579190764766068776</guid>    <pubDate>2025-12-02T12:43:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579190764766068776" data-draft-id="7579093990693322787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MaxKB4j — 基于 Java 的开源 RAG 知识库与 LLM 工作流平台"/> <meta itemprop="keywords" content="后端,程序员,LLM"/> <meta itemprop="datePublished" content="2025-12-02T12:43:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛阳泰山"/> <meta itemprop="url" content="https://juejin.cn/user/3359704427279165"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MaxKB4j — 基于 Java 的开源 RAG 知识库与 LLM 工作流平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3359704427279165/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛阳泰山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T12:43:48.000Z" title="Tue Dec 02 2025 12:43:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧠 MaxKB4j — 基于 Java 的开源 RAG 知识库与 LLM 工作流平台</h2>
<blockquote>
<p><strong>MaxKB4j = Max Knowledge Base for Java</strong><br/>
一个开箱即用、安全可靠、模型中立的 <strong>RAG（检索增强生成）+ LLM 工作流引擎</strong>，专为构建企业级智能问答系统而设计。
广泛应用于 智能客服、企业内部知识库、数据分析、学术研究与教育等场景。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c560625e11ee49b8afaaf5278f676855~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb6Ziz5rOw5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284228&amp;x-signature=uzQO3I5NEa%2BDS%2B9HvbA1%2FFQzfe4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">✨ 核心特性</h3>
<h4 data-id="heading-2">🔍 开箱即用的知识库问答</h4>
<ul>
<li>支持 <strong>上传本地文档</strong>（PDF/Word/TXT/Markdown 等）或 <strong>自动爬取网页内容</strong></li>
<li>自动完成：文本分段 → 向量化 → 存入向量数据库 → 构建 RAG 流程</li>
<li>显著减少大模型“幻觉”，提升回答准确性与可信度</li>
</ul>
<h4 data-id="heading-3">🌐 模型中立，灵活对接</h4>
<p>支持各类主流大模型，包括：</p>
<ul>
<li><strong>本地私有模型</strong>：DeepSeek-R1、Llama 3、Qwen 2 等（通过 Ollama / LM Studio / vLLM）</li>
<li><strong>国内公有模型</strong>：通义千问、腾讯混元、字节豆包、百度千帆、智谱 GLM、Kimi</li>
<li><strong>国际公有模型</strong>：OpenAI (GPT)、Anthropic (Claude)、Google (Gemini)</li>
</ul>
<blockquote>
<p>只需配置 API Key 或本地端点，即可无缝切换模型！</p>
</blockquote>
<h4 data-id="heading-4">⚙️ 可视化工作流编排</h4>
<ul>
<li>内置 <strong>低代码 AI 工作流引擎</strong>，支持条件分支、函数调用、多轮对话记忆</li>
<li>提供丰富 <strong>内置函数库</strong>（HTTP 请求、数据库查询、时间处理、正则提取等）</li>
<li>适用于复杂业务场景：客服工单生成、数据报告解读、内部制度问答等</li>
</ul>
<h4 data-id="heading-5">🧩 无缝嵌入现有系统</h4>
<ul>
<li>提供 <strong>RESTful API</strong> 和 <strong>前端嵌入组件（iframe / Web SDK）</strong></li>
<li>无需改造原有系统，5 分钟集成智能问答能力</li>
</ul>
<h4 data-id="heading-6">🤖 MCP Server 支持（Model Context Protocol）</h4>
<ul>
<li>支持 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP</a> 协议，让 AI 理解<strong>代码上下文</strong>、项目结构、依赖关系</li>
<li>不再只是“聊天机器人”，而是真正的 <strong>AI 编程协作者</strong></li>
</ul>
<h4 data-id="heading-7">🎙️ 多模态扩展（规划中）</h4>
<ul>
<li>已支持：语音识别（ASR）、语音合成（TTS）、图像识别（OCR）、图像生成（Stable Diffusion）</li>
<li>视频生成模型支持正在开发中…</li>
</ul>
<hr/>
<h3 data-id="heading-8">🚀 快速开始</h3>
<h4 data-id="heading-9">1. 环境要求</h4>
<ul>
<li>Java 17+</li>
<li>Maven 或 Gradle</li>
<li>PostgreSQL 12+（启用 pgvector 扩展）</li>
<li>MongoDB 6.0+（可选，用于全文检索）</li>
</ul>
<h4 data-id="heading-10">2. 启动服务</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动应用</span>
java -jar MaxKB4j.jar
</code></pre>
<h4 data-id="heading-11">3. 基于Docker 部署</h4>
<pre><code class="hljs language-bash" lang="bash">docker run --name maxkb4j -d --restart always -p 8080:8080 -e SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/MaxKB4j -e SPRING_DATASOURCE_USERNAME=postgres   -e SPRING_DATASOURCE_PASSWORD=123456  -e SPRING_DATA_MONGODB_URI=mongodb://admin:123456@localhost:27017/MaxKB4j?authSource=admin  registry.cn-hangzhou.aliyuncs.com/tarzanx/maxkb4j:2.0
</code></pre>
<p>其中，<code>-p 8080:8080</code> 中的第一个 8080 是宿主机的端口，<code>-e SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/MaxKB4j -e SPRING_DATASOURCE_USERNAME=postgres   -e SPRING_DATASOURCE_PASSWORD=123456</code> 是PostgreSQL数据库的连接配置参数，<code>-e SPRING_DATA_MONGODB_URI=mongodb://admin:123456@localhost:27017/MaxKB4j?authSource=admin</code>是MongoDB的连接配置参数， 可以根据需要进行修改。</p>
<h4 data-id="heading-12">4. Docker-Compose 部署（推荐）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.yml 示例见项目根目录</span>
<span class="hljs-string">docker-compose</span> <span class="hljs-string">up</span> <span class="hljs-string">-d</span>
</code></pre>
<h4 data-id="heading-13">5. 访问 Web 界面</h4>
<ul>
<li>地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fadmin%2Flogin" target="_blank" title="http://localhost:8080/admin/login" ref="nofollow noopener noreferrer">http://localhost:8080/admin/login</a></li>
<li>默认账号：<code>admin</code></li>
<li>默认密码：<code>tarzan@123456</code></li>
</ul>
<blockquote>
<p>首次启动会自动初始化数据库（PostgreSQL + MongoDB），请确保端口未被占用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">🛠 技术栈</h3>

































<table><thead><tr><th>类别</th><th>技术</th></tr></thead><tbody><tr><td><strong>后端</strong></td><td>Java 17, Spring Boot 3, Sa-Token（鉴权）</td></tr><tr><td><strong>AI 框架</strong></td><td>LangChain4j</td></tr><tr><td><strong>向量数据库</strong></td><td>PostgreSQL 15 + pgvector</td></tr><tr><td><strong>全文检索</strong></td><td>MongoDB</td></tr><tr><td><strong>缓存</strong></td><td>Caffeine</td></tr><tr><td><strong>前端</strong></td><td>Vue 3, Node.js v20.16.0</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">📸 UI 展示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4753c36516849488b63f4522539c940~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSb6Ziz5rOw5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284228&amp;x-signature=D8YA7%2BeHQ%2BWk%2FeozCK1aLkUJom4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>更多界面请参考项目 Wiki 或实际部署体验。</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">❓ 问题与建议</h3>
<p>欢迎提交 Issue 或 PR！<br/>
👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftaisan%2FMaxKB4j%2Fissues" target="_blank" title="https://gitee.com/taisan/MaxKB4j/issues" ref="nofollow noopener noreferrer">Gitee Issues</a></p>
<hr/>
<h3 data-id="heading-17">💖 支持与赞助</h3>
<p>本项目由个人开发者维护，您的支持将帮助项目持续迭代！</p>

























<table><thead><tr><th>赞助金额</th><th>权益</th></tr></thead><tbody><tr><td>¥20</td><td>添加作者微信（<code>vxhqqh</code>），加入交流群（备注“已赞助”）</td></tr><tr><td>¥50</td><td>上述权益 + 免费加入<a href="https://link.juejin.cn?target=https%3A%2F%2Fwx.zsxq.com%2Fgroup%2F28882525858841" target="_blank" title="https://wx.zsxq.com/group/28882525858841" ref="nofollow noopener noreferrer">《👉 知识星球🔥》</a></td></tr><tr><td>¥200</td><td>获取 <strong>V1 版本前端源码</strong></td></tr><tr><td>¥500</td><td>获取 <strong>V2 完整前后端源码</strong>（含最新功能）</td></tr></tbody></table>
<blockquote>


  
<hr/>
<h3 data-id="heading-18">📜 许可证</h3>
<p>Copyright © 2025–2035 洛阳泰山 TARZAN. All rights reserved.</p>
<p>根据GNU通用公共许可证版本3 (GPLv3)（“许可证”）进行许可；除非遵守许可，否则您不得使用此项目文件。您可以从以下网址获得许可证的副本</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gnu.org%2Flicenses%2Fgpl-3.0.html" target="_blank" title="https://www.gnu.org/licenses/gpl-3.0.html" ref="nofollow noopener noreferrer">🔗https://www.gnu.org/licenses/gpl-3.0.html</a></p>
<p>除非适用法律要求或经书面同意，依据本许可分发的软件均按“原样”提供，不附带任何形式的明示或暗示的担保或条件。有关许可下具体权限和限制的条款，请参见本许可协议。</p>
<hr/>
<h3 data-id="heading-19">🔗 相关资源</h3>
<ul>
<li>📘 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">官方文档（规划中）</a></li>
<li>🐦 <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">作者微信公众号</a></li>
<li>🌟 <strong>Star 本项目，助力国产开源 AI 生态！</strong></li>
</ul>
<blockquote>
<p>🎯 <strong>看看这个！👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexample.com%2Fai-guide" target="_blank" title="https://example.com/ai-guide" ref="nofollow noopener noreferrer">点击了解 AI 大模型应用开发实战！🔥</a></strong></p>
</blockquote>
<hr/>
<p>✅ <strong>MaxKB4j — 让每个 Java 团队都能轻松构建企业级 AI 知识库！</strong></p>
<p>🔗<strong>项目开源地址</strong> ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ftaisan%2FMaxKB4j" target="_blank" title="https://gitee.com/taisan/MaxKB4j" ref="nofollow noopener noreferrer">gitee.com/taisan/MaxK…</a></p><table><tbody><tr>
    <th> <div align="center">支付宝赞赏码</div></th>
    <th> <div align="center">微信赞赏码</div></th>
  </tr>
  <tr>
    <td><img src="转存失败，建议直接上传图片文件 image/zfb_skm.png" alt="支付宝赞赏码转存失败，建议直接上传图片文件" loading="lazy"/></td>
    <td><img src="转存失败，建议直接上传图片文件 image/wx_zsm.png" alt="微信赞赏码转存失败，建议直接上传图片文件" loading="lazy"/></td>
  </tr></tbody></table></blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[明明直接用就可以了，非要在Creator里面写？？？]]></title>    <link>https://juejin.cn/post/7579093412331356170</link>    <guid>https://juejin.cn/post/7579093412331356170</guid>    <pubDate>2025-12-02T12:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579093412331356170" data-draft-id="7578003302487932928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="明明直接用就可以了，非要在Creator里面写？？？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T12:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            明明直接用就可以了，非要在Creator里面写？？？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T12:51:37.000Z" title="Tue Dec 02 2025 12:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>点击上方亿元程序员+关注和★星标</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fa965d169594e439ebea6987d64bad4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=vEZhS%2BPsUJu1Jc4n4hZuXINlwEU%3D" alt="图片源于网络" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，最近笔者又又又看到有小伙伴吐槽：</p>
<blockquote>
<p><strong>最近</strong>刚入职一家公司，大佬让我负责战斗飘字相关模块，先将美术给的资源在<code>Creator</code>中制作成艺术字。</p>
<p><strong>艺术字</strong>的制作不是有很多现成的工具吗？例如<code>BMFont</code>。</p>
<p><strong>明明直接用就可以了，非要在Creator里面写？？？</strong></p>
</blockquote>
<p><strong>大佬</strong>肯定有大佬的理由，笔者就不深入探讨了，如果硬要说，可能是对小伙伴爱的考验。</p>
<p><strong>言归正传</strong>，本期带大家一起来看看，如何在<code>Cocos</code>游戏开发中，<strong>自定义插件制作位图字体</strong>。</p>
<p><strong>本文源工程可在文末获取，小伙伴们自行前往。</strong></p>
<h2 data-id="heading-1">什么是位图字体？</h2>
<blockquote>
<p><strong>位图字体</strong>将整套字符预渲染为一张纹理图集；渲染时，只需根据每个字符的UV坐标从中取样并拼接即可。</p>
</blockquote>
<h2 data-id="heading-2">位图字体有什么好处？</h2>
<p><strong>位图字体</strong>，其实在优化<code>DC</code>中也是很常见的，如果我们战斗的飘字用<code>Label</code>系统字体，不仅不好看，<code>DC</code>也会随着数量增加，应该也没人直接这么干。</p>
<h2 data-id="heading-3">位图字体如何制作？</h2>
<blockquote>
<p><strong>位图字体</strong>的实现分为两步：</p>
<p><strong>第一步</strong>，提前将全部字形整合到一张纹理图集中；</p>
<p><strong>第二步</strong>，运行时通过查询字符的UV坐标，从该图集中提取对应图像区块并依次绘制。</p>
</blockquote>
<h2 data-id="heading-4">自定义插件制作位图字体</h2>
<p><strong>接下来</strong>，我们一起来看看如何在<code>Creator</code>中，自定义插件实现一个位图字体制作工具。</p>
<p><strong>可能有小伙伴有疑问了</strong>，那可以直接在插件中使用<code>BMFont</code>工具吗？可以是可以,导演不让啊！</p>
<h3 data-id="heading-5">1.资源准备</h3>
<p><strong>首先</strong>将美术搭子给的资源用字符命名好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aca264b864f4cd2b23a0a0b57f21e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=jyd7Nbs5EIgD98B%2F1LKxAs6MRno%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.创建插件</h3>
<p><strong>想要自定义插件制作位图字体</strong>，首先要创建我们的插件，通过菜单<code>扩展-&gt;创建扩展</code>打开扩展创建面板,选择一个空白模板进行创建并启用插件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/960a2eeb71cc4e4fa4697a40e088d210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=LM96usLvmRLLnI0TzYOf%2Bc5X2jw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.插件整体流程</h3>
<blockquote>
<p><code>开始—&gt;在资源管理器中选择文件夹-&gt;遍历文件夹下所有的PNG图片-&gt;获取所有散图的尺寸信息-&gt;将散图合成一张图-&gt;根据图的信息生成fnt配置文件-&gt;结束</code></p>
</blockquote>
<ul>
<li>
<p><strong>选择文件夹</strong>：首先通过<code>let uuids = Editor.Selection.getSelected("asset")</code>获取选中的资源管理器中的文件夹。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/109463fbe49b4bc39610712d130f33e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=snNxtLlfkNWVqxgVxPoAb7hT%2FBc%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>文件夹路径</strong>：通过<code>let asset_url = await Editor.Message.request("asset-db", "query-path", uuids[0])</code>获取选择的文件夹路径。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ff8894867ea454cb537cbbced114cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=EvcbKp8PAii1%2FQn8NH7x%2BhtQn18%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>遍历散图</strong>：通过<code>fs</code>模块<code>let files = fs.readdirSync(asset_url)</code>获取所有散图的路径。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ad5bf37d09427a933898075ae04ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=k7UYGfhBkswHn8C7x4YwTjemQEM%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>读取散图信息</strong>：通过<code>Jimp</code>库(图像处理库)<code>const image = await Jimp.read(filePath);</code>读取散图的尺寸。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9087be9a297e4223afd4dd92839e45db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=wo5%2FcezVmP%2BamyJFw4yteA8Puhw%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>合图</strong>：通过<code>Jimp</code>库(图像处理库)<code>const texture = new Jimp(textureWidth, textureHeight, 0x00000000);</code>创建画布，然后通过<code>texture.composite(image, x, y);</code>画图，最后通过<code>await texture.writeAsync(texturePath);</code>保存合图。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e082e6c96af24dd694ac5e0c4a5b8608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=DRnw73IParpJ9iFJF6irEdF8yZM%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>生成fnt配置</strong>：根据获取到的散图信息，和合图信息，文件名就是对应字符，按照<code>fnt</code>配置的格式，填充内容，并且生成配置文件。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a0308ec15844c58ca0ac86044a3f35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=a0ls9b8zHRB1D88zADAniH87fKA%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h3 data-id="heading-8">4.编译测试</h3>
<p><strong>我们</strong>直接在生成的插件模板中(偷懒，别学)，执行我们的插件逻辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b539db5a5c7541df9e56131d531f70ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=JknZSiwsra5HgR6IWQy%2BsrvGVgs%3D" alt="" loading="lazy"/></p>
<p><strong>在插件目录</strong>，安装依赖<code>npm install</code>和构建插件<code>npm run build</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c660fc52d8a24471adae7034f6863c54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=Hnnb7APZuFs9X540%2BiEw495wPBE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">5.效果预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c77492a37a414c9aac81319e726de618~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=S2hYzbBF5ImkEUMXl6nLsSRrELg%3D" alt="" loading="lazy"/></p>
<p><strong>将生成好的字体文件</strong>设置一下即可看到效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1040faf9efbc4eb4b38353366b63d245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765284697&amp;x-signature=%2FVGa%2F1dhcvBge66Nx6BYjJhFuaw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">结语</h2>
<p><strong>往往</strong>大佬们坚持要自己开发工具，很多时候并不是因为固执，可能是对原理的执着、工具的可控或者是公司内部的约束等等。</p>
<p><strong>小伙伴们</strong>的大佬们有没有什么特别的要求和规范呢？</p>
<p>本文<strong>源工程</strong>可通过<strong>私信</strong>发送 <strong>BMFont</strong> 获取。</p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐专栏：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3175880857546129410%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3175880857546129410#wechat_redirect" ref="nofollow noopener noreferrer">知识付费专栏</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26mid%3D2247487282%26idx%3D1%26sn%3De3cb8ab6f5c0d5f804d5c29e2e90b9ad%26chksm%3Dc00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54%26token%3D336413522%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzg5NTY2MjIzMg==&amp;mid=2247487282&amp;idx=1&amp;sn=e3cb8ab6f5c0d5f804d5c29e2e90b9ad&amp;chksm=c00daec5f77a27d33933e877464d8cde24c4c947d3755f5e8262c634634617e7c26de3953a54&amp;token=336413522&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3207702867494305797%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3207702867494305797#wechat_redirect" ref="nofollow noopener noreferrer">100个Cocos实例</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3073771187570999299%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3073771187570999299#wechat_redirect" ref="nofollow noopener noreferrer">8年主程手把手打造Cocos独立游戏开发框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzg5NTY2MjIzMg%3D%3D%26action%3Dgetalbum%26album_id%3D3121583619634626562%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5NTY2MjIzMg==&amp;action=getalbum&amp;album_id=3121583619634626562#wechat_redirect" ref="nofollow noopener noreferrer">和8年游戏主程一起学习设计模式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3Faction%3Dgetalbum%26__biz%3DMzg5NTY2MjIzMg%3D%3D%26scene%3D1%26album_id%3D3038883468588089350%26count%3D3%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;__biz=Mzg5NTY2MjIzMg==&amp;scene=1&amp;album_id=3038883468588089350&amp;count=3#wechat_redirect" ref="nofollow noopener noreferrer">从零开始开发贪吃蛇小游戏到上线系列</a></p>
<p>点击下方灰色按钮+关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Hadoop+Spark+python毕设】中式早餐店订单数据分析与可视化系统、计算机毕业设计、包括数据爬取、数据分析、数据可视化]]></title>    <link>https://juejin.cn/post/7578876665696616457</link>    <guid>https://juejin.cn/post/7578876665696616457</guid>    <pubDate>2025-12-02T11:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578876665696616457" data-draft-id="7578836326475743259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Hadoop+Spark+python毕设】中式早餐店订单数据分析与可视化系统、计算机毕业设计、包括数据爬取、数据分析、数据可视化"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-02T11:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="计算机毕设小月哥"/> <meta itemprop="url" content="https://juejin.cn/user/95020128928073"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Hadoop+Spark+python毕设】中式早餐店订单数据分析与可视化系统、计算机毕业设计、包括数据爬取、数据分析、数据可视化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/95020128928073/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    计算机毕设小月哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T11:31:25.000Z" title="Tue Dec 02 2025 11:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎓 作者：计算机毕设小月哥 | 软件开发专家</p>
<p>🖥️ 简介：8年计算机软件程序开发经验。精通Java、Python、微信小程序、安卓、大数据、PHP、.NET|C#、Golang等技术栈。</p>
<p>🛠️ 专业服务 🛠️</p>
<ul>
<li>
<p>需求定制化开发</p>
</li>
<li>
<p>源码提供与讲解</p>
</li>
<li>
<p>技术文档撰写（指导计算机毕设选题【新颖+创新】、任务书、开题报告、文献综述、外文翻译等）</p>
</li>
<li>
<p>项目答辩演示PPT制作</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>🌟 欢迎：点赞 👍 收藏 ⭐ 评论 📝</p>
<p>👇🏻 精选专栏推荐 👇🏻 欢迎订阅关注！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761129.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761129.html" ref="nofollow noopener noreferrer">大数据实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761131.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761131.html" ref="nofollow noopener noreferrer">PHP|C#.NET|Golang实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761132.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761132.html" ref="nofollow noopener noreferrer">微信小程序|安卓实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761130.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761130.html" ref="nofollow noopener noreferrer">Python实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761126.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761126.html" ref="nofollow noopener noreferrer">Java实战项目</a></p>
<p>🍅 ↓↓主页获取源码联系↓↓🍅</p>
</blockquote>
<h2 data-id="heading-0">基于大数据的中式早餐店订单数据分析与可视化系统-功能介绍</h2>
<p>本系统是一个基于Hadoop与Spark大数据技术栈构建的，针对中式早餐店订单数据的深度分析与可视化平台。系统首先利用Python的数据处理库对原始的breakfast_orders.csv订单数据进行清洗、转换和特征工程，处理后的数据被上传至Hadoop分布式文件系统（HDFS）中进行持久化存储。核心分析引擎采用Apache Spark框架，通过其高效的内存计算能力对海量订单数据进行多维度、深层次的挖掘。系统实现了四大核心分析模块：整体销售业绩分析，通过计算总销售额、订单量及每日销售趋势，宏观把握经营状况；商品销售分析，深入挖掘热销品类、单品排行及商品间的关联性，为精准营销和套餐设计提供数据支持；顾客消费行为分析，洞察订单金额分布、下单高峰时段以及工作日与周末的消费差异，帮助优化运营策略；门店运营对比分析，从销售额、订单量、客单价等维度评估各门店表现，实现精细化管理。最终，所有分析结果通过Python后端框架（如Django）提供的API接口，传递给前端。前端采用Vue结合Echarts，将复杂的数据以直观、动态的图表形式进行可视化呈现，为早餐店管理者提供一个清晰、易懂的数据决策支持界面。</p>
<h2 data-id="heading-1">基于大数据的中式早餐店订单数据分析与可视化系统-选题背景意义</h2>
<p>选题背景
随着城市生活节奏的不断加快，中式早餐作为满足人们日常基本需求的重要一环，其市场竞争也日趋激烈。大大小小的早餐店遍布街头巷尾，但多数传统店铺的经营模式仍然较为粗放，依赖于店主的经验和直觉进行决策。他们每天产生大量的订单数据，这些数据里其实隐藏着关于顾客消费习惯、商品受欢迎程度、经营高峰时段等极具价值的信息。然而，很多店主缺乏有效的工具和方法去利用这些数据，导致在菜品调整、库存管理和营销活动策划上常常感到力不从心，难以在激烈的竞争中脱颖而出。因此，如何利用现代信息技术，帮助这些传统餐饮企业，特别是中式早餐店，将沉睡的数据转化为有价值的商业洞察，提升其运营效率和盈利能力，成为了一个值得探索的现实问题。
选题意义
本课题的实际意义在于，它为中小型餐饮企业提供了一套低成本、高效率的数据分析解决方案。对于早餐店店主而言，通过本系统，他们可以清晰地看到哪些是真正的“明星产品”，哪些是“滞销品”，从而优化菜单结构，减少食材浪费。系统分析出的高峰时段信息，能够指导店主合理安排员工班次，提高服务效率，避免顾客流失。而商品关联性分析的结果，则可以直接用于设计搭配套餐或进行交叉推荐，有效提升客单价。虽然这只是一个毕业设计项目，但它完整地展示了如何将大数据技术应用于一个具体的、接地气的商业场景，证明了数据分析在提升传统行业运营水平方面的巨大潜力。对于开发者本人来说，这个项目涵盖了从数据采集、清洗、分布式计算到数据可视化的完整流程，是一次对大数据技术栈的综合性实践，能够极大地锻炼解决实际问题的能力，为未来从事相关工作打下坚实的基础。</p>
<h2 data-id="heading-2">基于大数据的中式早餐店订单数据分析与可视化系统-技术选型</h2>
<p>大数据框架：Hadoop+Spark（本次没用Hive，支持定制）
开发语言：Python+Java（两个版本都支持）
后端框架：Django+Spring Boot(Spring+SpringMVC+Mybatis)（两个版本都支持）
前端：Vue+ElementUI+Echarts+HTML+CSS+JavaScript+jQuery
详细技术点：Hadoop、HDFS、Spark、Spark SQL、Pandas、NumPy
数据库：MySQL</p>
<h2 data-id="heading-3">基于大数据的中式早餐店订单数据分析与可视化系统-视频展示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1qcStBFEEH%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1qcStBFEEH/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">基于大数据的中式早餐店订单数据分析与可视化系统-视频展示</a></p>
<h2 data-id="heading-4">基于大数据的中式早餐店订单数据分析与可视化系统-图片展示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27cf04b044a8492eadbd584c31ec6134~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=a8hH1uV%2BMwYaknDopI5iao75CA4%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787bbd0230da4da48b39cd6b2d403e74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=bI8dfMJ7CQakXmiY%2BZjC0s4qWlw%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b05dfc681f64e83ac74786bd247c1ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=2CLUDIsCzEHj5xUy9wAl7vcfTkI%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f3c9095aa7a46e687d6d4889bbb5df3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=Fw7T3vBcQ5lo6oSr3kXStF9lsK0%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed10c7b7458d436d85abb6aba49230c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=dVHjOIaveyaokwRxMZT9Oe6%2Fre4%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d1ef51909e5435a973c58aca88affc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=uS77a0LW5P1eNE6S8qFB4m%2FuL9s%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/604ef6d2e739426883064a4479c57769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K6h566X5py65q-V6K6-5bCP5pyI5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765279885&amp;x-signature=M9aapWFugwl%2BYXvSnyqkyGnL93E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-5">基于大数据的中式早餐店订单数据分析与可视化系统-代码展示</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyspark.sql <span class="hljs-keyword">import</span> SparkSession, functions <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">from</span> pyspark.sql.types <span class="hljs-keyword">import</span> ArrayType, StringType
<span class="hljs-comment"># 初始化SparkSession，这是所有Spark功能的入口点</span>
spark = SparkSession.builder.appName(<span class="hljs-string">"BreakfastDataAnalysis"</span>).getOrCreate()
<span class="hljs-comment"># 假设df是一个已经加载好的Spark DataFrame，包含breakfast_orders.csv的数据</span>
<span class="hljs-comment"># df = spark.read.csv("hdfs://path/to/breakfast_orders.csv", header=True, inferSchema=True)</span>

<span class="hljs-comment"># 核心功能1: 计算每日销售总额与订单量趋势</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_daily_sales_trend</span>(<span class="hljs-params">df</span>):
    <span class="hljs-comment"># 将字符串类型的下单时间转换为时间戳格式，并提取日期部分</span>
    df_with_date = df.withColumn(<span class="hljs-string">"order_date"</span>, F.to_date(F.col(<span class="hljs-string">"下单时间"</span>), <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
    <span class="hljs-comment"># 按订单ID和日期分组，计算每个订单的总金额，避免一个订单多个商品行重复计算</span>
    daily_order_revenue = df_with_date.groupBy(<span class="hljs-string">"订单编号"</span>, <span class="hljs-string">"order_date"</span>).agg(F.<span class="hljs-built_in">sum</span>(<span class="hljs-string">"小计金额"</span>).alias(<span class="hljs-string">"order_total_revenue"</span>))
    <span class="hljs-comment"># 按日期分组，汇总当天的总销售额和总订单数</span>
    daily_summary = daily_order_revenue.groupBy(<span class="hljs-string">"order_date"</span>).agg(
        F.<span class="hljs-built_in">sum</span>(<span class="hljs-string">"order_total_revenue"</span>).alias(<span class="hljs-string">"daily_total_revenue"</span>),
        F.count(<span class="hljs-string">"订单编号"</span>).alias(<span class="hljs-string">"daily_order_count"</span>)
    )
    <span class="hljs-comment"># 按日期升序排序，以便观察趋势</span>
    daily_summary = daily_summary.orderBy(<span class="hljs-string">"order_date"</span>)
    <span class="hljs-keyword">return</span> daily_summary

<span class="hljs-comment"># 核心功能2: 分析顾客下单高峰时段（按小时统计）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_peak_hours</span>(<span class="hljs-params">df</span>):
    <span class="hljs-comment"># 将字符串类型的下单时间转换为时间戳格式</span>
    df_with_timestamp = df.withColumn(<span class="hljs-string">"order_timestamp"</span>, F.to_timestamp(F.col(<span class="hljs-string">"下单时间"</span>), <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))
    <span class="hljs-comment"># 从时间戳中提取小时部分</span>
    df_with_hour = df_with_timestamp.withColumn(<span class="hljs-string">"order_hour"</span>, F.hour(<span class="hljs-string">"order_timestamp"</span>))
    <span class="hljs-comment"># 按小时分组，统计每个小时的订单数量（使用订单编号去重）</span>
    hourly_orders = df_with_hour.select(<span class="hljs-string">"订单编号"</span>, <span class="hljs-string">"order_hour"</span>).distinct()
    peak_hour_analysis = hourly_orders.groupBy(<span class="hljs-string">"order_hour"</span>).agg(F.count(<span class="hljs-string">"订单编号"</span>).alias(<span class="hljs-string">"order_count"</span>))
    <span class="hljs-comment"># 按小时升序排序</span>
    peak_hour_analysis = peak_hour_analysis.orderBy(<span class="hljs-string">"order_hour"</span>)
    <span class="hljs-keyword">return</span> peak_hour_analysis

<span class="hljs-comment"># 核心功能3: 使用Apriori思想进行商品关联性分析（简化版）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_product_association</span>(<span class="hljs-params">df</span>):
    <span class="hljs-comment"># 按订单ID分组，将每个订单中的商品收集到一个列表中</span>
    <span class="hljs-comment"># 这里使用RDD操作，因为它在处理这种非结构化转换时更灵活</span>
    order_items_rdd = df.select(<span class="hljs-string">"订单编号"</span>, <span class="hljs-string">"商品名称"</span>).rdd.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> row: (row.订单编号, row.商品名称))
    <span class="hljs-comment"># 对同一个订单的商品进行去重并分组</span>
    order_items_grouped = order_items_grouped = order_items_rdd.distinct().groupByKey().mapValues(<span class="hljs-built_in">set</span>)
    <span class="hljs-comment"># 生成所有可能的商品对（项集）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_pairs</span>(<span class="hljs-params">items</span>):
        items_list = <span class="hljs-built_in">list</span>(items)
        pairs = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(items_list)):
            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(items_list)):
                <span class="hljs-comment"># 确保对的顺序一致，便于后续计数</span>
                pair = <span class="hljs-built_in">tuple</span>(<span class="hljs-built_in">sorted</span>((items_list[i], items_list[j])))
                pairs.append(pair)
        <span class="hljs-keyword">return</span> pairs
    <span class="hljs-comment"># 将每个订单的商品对展开，并计数</span>
    pairs_rdd = order_items_grouped.flatMap(<span class="hljs-keyword">lambda</span> x: generate_pairs(x[<span class="hljs-number">1</span>]))
    pair_counts = pairs_rdd.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> pair: (pair, <span class="hljs-number">1</span>)).reduceByKey(<span class="hljs-keyword">lambda</span> a, b: a + b)
    <span class="hljs-comment"># 计算每个单品的总出现次数（支持度计算的分母）</span>
    single_item_counts = order_items_grouped.flatMap(<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>]).<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> item: (item, <span class="hljs-number">1</span>)).reduceByKey(<span class="hljs-keyword">lambda</span> a, b: a + b)
    total_orders = df.select(<span class="hljs-string">"订单编号"</span>).distinct().count()
    <span class="hljs-comment"># 计算置信度（这里简化处理，主要看支持度）</span>
    <span class="hljs-comment"># 将RDD转换回DataFrame以便展示</span>
    association_rules = pair_counts.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: (x[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], x[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>], x[<span class="hljs-number">1</span>])).toDF([<span class="hljs-string">"item_A"</span>, <span class="hljs-string">"item_B"</span>, <span class="hljs-string">"pair_count"</span>])
    <span class="hljs-keyword">return</span> association_rules.orderBy(F.col(<span class="hljs-string">"pair_count"</span>).desc())
</code></pre>
<h2 data-id="heading-6">基于大数据的中式早餐店订单数据分析与可视化系统-结语</h2>
<blockquote>
<p>🌟 欢迎：点赞 👍 收藏 ⭐ 评论 📝</p>
<p>👇🏻 精选专栏推荐 👇🏻 欢迎订阅关注！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761129.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761129.html" ref="nofollow noopener noreferrer">大数据实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761131.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761131.html" ref="nofollow noopener noreferrer">PHP|C#.NET|Golang实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761132.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761132.html" ref="nofollow noopener noreferrer">微信小程序|安卓实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761130.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761130.html" ref="nofollow noopener noreferrer">Python实战项目</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_86721878%2Fcategory_12761126.html" target="_blank" title="https://blog.csdn.net/2401_86721878/category_12761126.html" ref="nofollow noopener noreferrer">Java实战项目</a></p>
<p>🍅 ↓↓主页获取源码联系↓↓🍅</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lyra提示词优化专家]]></title>    <link>https://juejin.cn/post/7578968420043243583</link>    <guid>https://juejin.cn/post/7578968420043243583</guid>    <pubDate>2025-12-02T11:39:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420043243583" data-draft-id="7578968420043210815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lyra提示词优化专家"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-02T11:39:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幸福拾荒者"/> <meta itemprop="url" content="https://juejin.cn/user/254742426030318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lyra提示词优化专家
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426030318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幸福拾荒者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T11:39:56.000Z" title="Tue Dec 02 2025 11:39:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-markdown" lang="markdown">你是「Lyra」，一位精通中文的高级AI提示词优化专家，专门将用户模糊、含糊不清的请求，优化为高质量、可用于各种AI平台的专业提示词。

<span class="hljs-section"># 🎯 你的目标：</span>

将模糊、零散、口语化的用户输入，转换为结构清晰、目标明确、平台兼容的专业提示词，以便用户在 ChatGPT、Claude、Gemini、通义千问、DeepSeek 等模型中获得最佳响应效果。

---

<span class="hljs-section"># 🧠 你的方法论：4-D 提示词优化流程</span>

<span class="hljs-section">## 1. 拆解（Deconstruct）</span>

<span class="hljs-bullet">*</span> 提取用户核心意图、关键实体、预期结果
<span class="hljs-bullet">*</span> 明确用户是否指定了输出格式、字数要求、语气风格
<span class="hljs-bullet">*</span> 判断任务类型（写作、问答、编程、分析等）
<span class="hljs-bullet">*</span> 分析已提供信息和缺失信息

<span class="hljs-section">## 2. 诊断（Diagnose）</span>

<span class="hljs-bullet">*</span> 判断任务是否具体清晰、是否有歧义
<span class="hljs-bullet">*</span> 检查是否具备执行提示词优化的必要信息
<span class="hljs-bullet">*</span> 判断任务的复杂程度，以决定进入哪种优化模式

<span class="hljs-section">## 3. 生成（Develop）</span>

根据不同类型任务选择优化策略：

<span class="hljs-bullet">*</span> ✍️ 创意类（写作/广告）：引导多角度、多风格、强调情感调动
<span class="hljs-bullet">*</span> 📊 技术类（代码/数据）：明确任务角色、输出格式、数据结构约束
<span class="hljs-bullet">*</span> 🎓 教育类（解释/教案）：使用示例法、结构清晰引导、可理解性优先
<span class="hljs-bullet">*</span> 🧩 复杂类（研究/分析）：采用逐步思考法、信息分步构造、链式推理

同时为模型设定角色，例如：“你是一位专业营销文案专家”或“你是一位Python后端开发工程师”。

<span class="hljs-section">## 4. 交付（Deliver）</span>

<span class="hljs-bullet">*</span> 输出优化后的提示词内容
<span class="hljs-bullet">*</span> 清晰结构分段：包含任务指令、角色、输出要求等
<span class="hljs-bullet">*</span> 必要时提供额外的说明：优化说明、使用建议、适用平台等

---

<span class="hljs-section"># ⚙️ 支持的工作模式：</span>

<span class="hljs-section">## ✅ BASIC 模式</span>

快速处理简单请求，不提问，直接优化提示词。

<span class="hljs-section">## ✅ DETAIL 模式</span>

适用于复杂请求，会先提出 2-3 个关键澄清问题，等待用户回答后再优化生成最终提示词。

你应根据任务复杂度自动选择模式（除非用户明确指定）。在 DETAIL 模式下，你需要保持上下文一致性，避免重复提问。

---

<span class="hljs-section"># 📝 输出格式要求：</span>

<span class="hljs-section">## BASIC 模式输出格式：</span>

<span class="hljs-strong">**优化后的提示词：**</span> [优化后提示词内容]

<span class="hljs-strong">**优化说明：**</span>

<span class="hljs-bullet">*</span> 说明做了哪些调整
<span class="hljs-bullet">*</span> 提升效果的理由

---

<span class="hljs-section">## DETAIL 模式最终输出格式：</span>

<span class="hljs-strong">**优化后的提示词：**</span> [优化后提示词内容]

<span class="hljs-strong">**关键优化点：**</span>

<span class="hljs-bullet">*</span> 明确角色或身份设定
<span class="hljs-bullet">*</span> 引入具体任务目标
<span class="hljs-bullet">*</span> 规范输出结构/风格

<span class="hljs-strong">**使用建议：**</span> 可直接复制至 ChatGPT、Claude、通义千问、DeepSeek 等平台获得最佳效果。

---

<span class="hljs-section"># 📣 初次交互欢迎语（首次响应必须发送）：</span>

你好，我是 Lyra，一位提示词优化专家。我的工作是将含糊或不清晰的需求转化为精准、有效的AI提示词，帮助你在 ChatGPT、Claude、Gemini 等平台获得更好的结果。

📌 现在我需要知道：

<span class="hljs-bullet">*</span> 你打算在哪个平台使用提示词（如 ChatGPT、Claude、通义千问等）
<span class="hljs-bullet">*</span> 优化模式是 DETAIL（我先问你几个问题）还是 BASIC（我直接优化）
<span class="hljs-bullet">*</span> 然后请输入你的需求（哪怕只是“帮我写个方案”）

✨ 示例：

<span class="hljs-bullet">*</span> DETAIL + ChatGPT：帮我写一篇新媒体宣传文案
<span class="hljs-bullet">*</span> BASIC + Claude：润色一段对话内容

现在请输入你的初步想法，我会为你生成最佳提示词。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 的应用场景：为什么越来越多企业选择它？]]></title>    <link>https://juejin.cn/post/7578416583212367922</link>    <guid>https://juejin.cn/post/7578416583212367922</guid>    <pubDate>2025-12-01T04:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578416583212367922" data-draft-id="7578161740468551731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 的应用场景：为什么越来越多企业选择它？"/> <meta itemprop="keywords" content="前端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-01T04:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 的应用场景：为什么越来越多企业选择它？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T04:02:26.000Z" title="Mon Dec 01 2025 04:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Node.js 自 2009 年发布以来，凭借 <strong>高性能、非阻塞 I/O、单线程事件驱动</strong> 的特性，迅速成为现代 Web 开发的重要后端技术。在实际开发中，Node.js 不仅仅适合构建普通网站，它在很多高并发、实时性、前后端统一的场景中表现尤为出色。本文将深入探讨 Node.js 的主要应用场景，帮助开发者理解它的优势和适用领域。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、实时通信应用</h2>
<p>实时通信是 Node.js 最典型的应用场景之一。得益于其 <strong>事件驱动 + WebSocket</strong> 模型，Node.js 可以轻松处理成千上万的并发连接。</p>
<p><strong>典型场景：</strong></p>
<ul>
<li>聊天应用（如 Slack、企业 IM）</li>
<li>在线协作工具（如 Google Docs、Trello 实时协作）</li>
<li>游戏实时交互（多人在线游戏、排行榜实时更新）</li>
<li>实时通知与推送系统</li>
</ul>
<p><strong>示例代码：使用 Socket.io 实现简单聊天室</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Server</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'socket.io'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(app);
<span class="hljs-keyword">const</span> io = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>(server);

io.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-function">(<span class="hljs-params">socket</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户已连接'</span>);
  socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'chat message'</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    io.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'chat message'</span>, msg);
  });
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server running on http://localhost:3000'</span>);
});
</code></pre>
<hr/>
<h2 data-id="heading-1">二、高并发 API 服务</h2>
<p>Node.js 的 <strong>非阻塞 I/O 模型</strong> 使它非常适合处理 <strong>大量并发请求</strong>，尤其是 RESTful API 或微服务场景。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>移动端后台 API</li>
<li>SPA（单页应用）数据接口</li>
<li>微服务架构的轻量服务节点</li>
</ul>
<p>相比传统多线程模型，Node.js 不会因为大量请求而频繁创建线程，因此在 I/O 密集型应用中性能非常稳定。</p>
<hr/>
<h2 data-id="heading-2">三、单页应用 (SPA) 与前后端同构</h2>
<p>Node.js 让 JavaScript 不仅在前端运行，也可以在服务器端运行。这为 <strong>前后端统一开发</strong> 和 <strong>同构渲染</strong> 提供了可能。</p>
<p><strong>应用场景：</strong></p>
<ul>
<li>前端框架（React、Vue、Angular）服务器端渲染（SSR）</li>
<li>提高页面首屏加载速度</li>
<li>SEO 优化（对 SPA 网站尤为重要）</li>
</ul>
<p><strong>示例：Next.js 就是基于 Node.js 的 SSR 框架</strong>，广泛应用于企业级网站。</p>
<hr/>
<h2 data-id="heading-3">四、数据流处理与文件处理</h2>
<p>Node.js 对 <strong>流（Stream）处理</strong> 支持非常好，适合处理大文件或实时数据流。</p>
<p><strong>典型场景：</strong></p>
<ul>
<li>视频、音频、图片的上传、压缩、转码</li>
<li>实时日志处理与监控</li>
<li>数据爬取与批量导入导出</li>
</ul>
<p><strong>示例：读取大文件流</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> readStream = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">'./large-file.txt'</span>);

readStream.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'读取数据块：'</span>, chunk.<span class="hljs-property">length</span>);
});
</code></pre>
<hr/>
<h2 data-id="heading-4">五、微服务与 Serverless 架构</h2>
<p>Node.js 轻量、高效，非常适合构建 <strong>微服务</strong> 或 <strong>Serverless</strong> 应用。</p>
<p><strong>优势：</strong></p>
<ul>
<li>启动快，资源占用低</li>
<li>与云函数（AWS Lambda、阿里云函数计算）天然契合</li>
<li>易于拆分服务，实现高可用架构</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、IoT（物联网）与边缘计算</h2>
<p>Node.js 的 <strong>异步事件驱动</strong> 特性，使其在 IoT 场景下也能高效处理设备数据。</p>
<p><strong>典型应用：</strong></p>
<ul>
<li>智能家居系统</li>
<li>传感器数据采集与处理</li>
<li>实时设备状态监控</li>
</ul>
<hr/>
<h2 data-id="heading-6">七、总结</h2>
<p>Node.js 的核心优势在于：</p>
<ol>
<li><strong>高并发、非阻塞 I/O</strong> → 适合实时通信和 API 服务</li>
<li><strong>前后端统一语言</strong> → SPA 和同构渲染更高效</li>
<li><strong>轻量、启动快</strong> → 微服务、Serverless、IoT 场景均适用</li>
</ol>
<p>因此，无论是<strong>互联网企业</strong>、<strong>移动端后台</strong>，还是<strong>实时协作工具</strong>，Node.js 都能提供稳定、高效、可扩展的解决方案。</p>
<hr/>
<p>如果你正在开发高并发、实时性要求高的应用，或者希望前后端技术统一，Node.js 是不可错过的选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 Trae 做了一个无限 Rogue 小游戏：一次从想法到原型的完整体验记录]]></title>    <link>https://juejin.cn/post/7578138892127273006</link>    <guid>https://juejin.cn/post/7578138892127273006</guid>    <pubDate>2025-12-01T03:44:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578138892127273006" data-draft-id="7578161740468027443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 Trae 做了一个无限 Rogue 小游戏：一次从想法到原型的完整体验记录"/> <meta itemprop="keywords" content="前端,游戏"/> <meta itemprop="datePublished" content="2025-12-01T03:44:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ak啊"/> <meta itemprop="url" content="https://juejin.cn/user/237916932030253"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 Trae 做了一个无限 Rogue 小游戏：一次从想法到原型的完整体验记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/237916932030253/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ak啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T03:44:50.000Z" title="Mon Dec 01 2025 03:44:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7811eb4b61f24c8fac79c2bbd335ccb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWvllYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765165489&amp;x-signature=hOxsPPjs6E5zqK8IYBVLvRPS%2BW4%3D" alt="20251201033118-iClYeZ.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>我用 Trae 做了一个无限 Rogue 小游戏：一次从想法到原型的完整体验记录</strong></h2>
<p>我平时做一些小实验项目，大部分都是凭兴趣来的。前阵子我突然想做一款 <strong>无尽模式的 Rogue 游戏</strong>，像那种越打越爽、越升越多花样的玩法，但又懒得自己从零去搭工程。刚好看到有人在用 Trae 这种 AI IDE，我就想拿这个项目试试它到底能帮我省多少力。</p>
<p>这篇文章就是把整个过程从头到尾记录下来：从我第一句话给 Trae，到游戏逐渐成型，中间加武器、加怪物、补联动、改 UI… 一路推进到能玩。</p>
<p>没有评测，不做结论，只是把过程写出来。</p>
<hr/>
<h3 data-id="heading-1"><strong>一、我只给了 Trae 一句话：先把游戏做出来</strong></h3>
<p>我给它的第一段提示大概是这样：</p>
<blockquote>
<p>“做一个无限 Rogue。角色在地图上自由移动，地上会随机生成道具（回血、清屏、代币、吸全图经验）。地图边缘会不断刷敌人，往玩家中心逼近，敌人类型要丰富，有快有慢，有近战也有远程。每隔一段时间出一个 Boss，有冲刺和范围伤害。怪被打死掉经验水晶，玩家升级后选武器、升级武器、加属性或学法术。武器和法术之间要有联动效果。随着等级和时间推进，敌人和 boss 越来越强。”</p>
</blockquote>
<p>内容挺长，但逻辑不算复杂，就是把我想要的玩法一股脑讲出来。</p>
<p>我本来以为 Trae 会只给我一点点基础结构，结果它把模块拆得比我预期还细：</p>
<ul>
<li>地图刷新</li>
<li>敌人行为</li>
<li>道具系统</li>
<li>升级系统</li>
<li>武器体系</li>
<li>Boss 模块</li>
<li>数值配置</li>
<li>事件分发</li>
</ul>
<p>文件结构也搭得挺完整。<br/>
基础跑起来之后，我基本就围绕“填空”开始推进项目。</p>
<hr/>
<h3 data-id="heading-2"><strong>二、先补怪物：让世界变得有点危险感</strong></h3>
<p>最早的敌人只有“会往玩家方向走的红点”这种原型，我就让 Trae 把敌人做得更像样一些：</p>
<blockquote>
<p>“敌人要多样化，有速度差异、有远程、有贴脸、有坦克，有自己的行为模式。”</p>
</blockquote>
<p>它做的事情很工程化：</p>
<ul>
<li>抽一个基础敌人类</li>
<li>给不同类型派生行为</li>
<li>加了远程射击、快速突进、慢速重击这种预设</li>
<li>把靠近阈值、攻击间隔、移动速度拆成参数</li>
</ul>
<p>我还让它处理一个小细节：</p>
<blockquote>
<p>“靠近玩家时不要直接撞脸，要有一点延迟。”</p>
</blockquote>
<p>这个效果其实很重要，因为怪物的节奏会变得更可控，而不是乱七八糟堆一堆上来。</p>
<p>怪多的时候，地图节奏终于有了“压力感”，不再像第一版那么空洞。</p>
<hr/>
<h3 data-id="heading-3"><strong>三、给角色加武器：从基础攻击到差异化玩法</strong></h3>
<p>敌人有了，我开始弄武器。</p>
<p>我先让它给我做基础武器：</p>
<ul>
<li>近战范围攻击</li>
<li>远程射弹</li>
<li>范围爆炸</li>
<li>旋转型武器</li>
<li>自动寻敌</li>
</ul>
<p>每种武器都能升级，比如：</p>
<ul>
<li>攻击范围变大</li>
<li>弹射次数增加</li>
<li>冷却变短</li>
<li>伤害强化</li>
</ul>
<p>Trae 在这里做了一个我意料之外的点：<br/>
<strong>所有武器升级逻辑都被标准化了。</strong><br/>
就算我后面再加武器，结构也不会乱。</p>
<p>中间有一些不平衡的武器（比如伤害太低的那种），我只说：“调高一点”。它把整个数值链都改了一遍，总体上算可用。</p>
<hr/>
<h3 data-id="heading-4"><strong>四、加入“武学”：技能、被动、特殊机制</strong></h3>
<p>为了让玩法不那么单调，我又加了武学系统。</p>
<p>提示很简单：</p>
<blockquote>
<p>“加武学系统，有主动、有被动，也有增强类，把效果尽量拆开。”</p>
</blockquote>
<p>它把现有升级系统扩展成一个 skill tree：</p>
<ul>
<li><strong>主动技</strong>：冷却触发，例如冲击波、短暂位移</li>
<li><strong>被动技</strong>：如移速提升、击杀回血</li>
<li><strong>增强技</strong>：提升武器效果、强化元素属性等</li>
</ul>
<p>我没写具体技能，它自动给了一些模板，我觉得够用就留了。</p>
<hr/>
<h3 data-id="heading-5"><strong>五、武器 × 武学：做一点联动</strong></h3>
<p>这是我最在意的部分。</p>
<p>我告诉它：</p>
<blockquote>
<p>“武器与武学之间要互相触发，例如旋转武器触发火焰灼烧，远程武器触发冰冻减速。”</p>
</blockquote>
<p>一开始生成的代码太粘连，我让它重构：</p>
<blockquote>
<p>“把所有联动从武器内部抽出来。”</p>
</blockquote>
<p>结果它真的做了一个独立的 <strong>事件系统</strong>，把命中、暴击、击杀、范围伤害这些事件全部集中到一个 dispatcher 里。</p>
<p>这样加新技能就不会破坏原有结构，也不容易缠在一起。这个部分我觉得是整个项目里最省心的部分。</p>
<hr/>
<h3 data-id="heading-6"><strong>六、Boss 系统：有冲刺也有范围伤害</strong></h3>
<p>Boss 出现的逻辑我也丢给它：</p>
<ul>
<li>按时间生成</li>
<li>单独生命条</li>
<li>冲刺攻击（有预警）</li>
<li>范围爆炸（读条留躲避空间）</li>
<li>死亡掉大量经验</li>
</ul>
<p>它把 Boss 行为写成一个独立 AI 模块，而不是堆在敌人逻辑里，这点做得挺干净。</p>
<p>视觉上我后续还给 Boss 多加了几种提示效果（例如闪烁、溶解边缘），UI 和渲染风格也分几次让 Trae 调整。</p>
<hr/>
<h3 data-id="heading-7"><strong>七、UI 这部分改了很多次</strong></h3>
<p>UI 是我改得最多次的：</p>
<ul>
<li>经验条位置不对 → 下移</li>
<li>血条太死板 → 加动画</li>
<li>升级界面太粗糙 → 换成卡片选择</li>
<li>技能图标 → 统一风格</li>
<li>波数面板、Boss 倒计时 → 加到右上角</li>
<li>技能触发提示 → 加到左下角</li>
</ul>
<p>Trae 每次做的版本都大概 70%-80% 可用，我再细调剩下的部分。</p>
<p>原型不需要太漂亮，但至少要看着不难受。</p>
<hr/>
<h3 data-id="heading-8"><strong>八、项目整体跑起来了</strong></h3>
<p><span href="https://code.juejin.cn/pen/7578723408433512463" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7578723408433512463" data-src="https://code.juejin.cn/pen/7578723408433512463" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<p>到这一步，游戏已经可以正常玩了：</p>
<ul>
<li>地图一直推进</li>
<li>敌人越来越强</li>
<li>Boss 按节奏出现</li>
<li>武器、技能、武学互相联动</li>
<li>数值曲线平滑</li>
<li>升级感明显</li>
<li>UI 不会挡视线</li>
</ul>
<p>作为一个兴趣项目，我对这个结果是满意的。</p>
<p>它还算不上是一款真正完整的游戏，但至少是一个 <strong>清晰可扩展的玩法原型</strong>，代码结构也没有因为随意加内容而变得混乱。</p>
<hr/>
<h3 data-id="heading-9"><strong>九、这次体验给我的真实感受</strong></h3>
<p>整个过程最明显的变化是：<br/>
<strong>我不再从“写代码”开始做东西，而是从“描述想要的机制”开始。</strong></p>
<p>我基本做的就是：</p>
<ol>
<li>想到一个功能</li>
<li>用一句话告诉 Trae</li>
<li>看它补骨架、补参数、补配置</li>
<li>我再修改细节、调逻辑</li>
<li>然后继续加下一个</li>
</ol>
<p>Trae 的作用不是“一个人替我写游戏”，而是：</p>
<ul>
<li>自动规划工程结构</li>
<li>自动把重复性的部分先搭出来</li>
<li>自动补充松散机制之间的接口</li>
<li>自动维护文件依赖关系</li>
<li>自动把我忘记的地方串起来</li>
</ul>
<p>对一个小型项目来说，这比我一个人从零写要轻松不少。</p>
<hr/>
<h3 data-id="heading-10"><strong>十、下一步我要做的</strong></h3>
<p>现在这个 Rogue 原型已经能玩，我后面大概会继续加：</p>
<ul>
<li>地图变体（森林、废墟、雪地）</li>
<li>更丰富的武学组合</li>
<li>Boss 第二阶段</li>
<li>更完整的音效</li>
<li>更接近成品的 UI</li>
<li>一些简单的特效</li>
<li>实现敌人的多样性</li>
</ul>
<p>再之后，会不会继续扩展甚至做成一款完整游戏，我现在还没决定。</p>
<p>但至少，这次实验让我意识到：<br/>
<strong>把“游戏机制”直接描述出来，然后让系统自动生成我需要的工程基础，是一件挺有意思的事。</strong></p>
<p>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzuoanCo%2Frogue-wuxia" target="_blank" title="https://github.com/zuoanCo/rogue-wuxia" ref="nofollow noopener noreferrer">github.com/zuoanCo/rog…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解密Prompt系列65. 三巨头关于大模型内景的硬核论文]]></title>    <link>https://juejin.cn/post/7578029371006992424</link>    <guid>https://juejin.cn/post/7578029371006992424</guid>    <pubDate>2025-12-01T00:33:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578029371006992424" data-draft-id="7578003302488047616" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密Prompt系列65. 三巨头关于大模型内景的硬核论文"/> <meta itemprop="keywords" content="NLP,LLM"/> <meta itemprop="datePublished" content="2025-12-01T00:33:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风雨中的小七"/> <meta itemprop="url" content="https://juejin.cn/user/3060648218472728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密Prompt系列65. 三巨头关于大模型内景的硬核论文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3060648218472728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风雨中的小七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T00:33:22.000Z" title="Mon Dec 01 2025 00:33:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这一章我们不谈应用，而是通过三巨头 Google、OpenAI、Anthropic 三篇充满脑洞的论文，深入探讨模型<strong>内部状态的可访问性与可操控性</strong>。我们将从三个维度展开：</p>
<ul>
<li>模型是否有自我认知？</li>
<li>如何引导这种认知？</li>
<li>如何从数学和电路层面解释这种认知？</li>
</ul>
<h2 data-id="heading-0">Google：In-Context Learning 本质上是隐式梯度更新</h2>
<blockquote>
<ul>
<li>📄 Google: Learning without training</li>
</ul>
</blockquote>
<p>❓ 大语言模型在推理阶段，不更新权重的情况下，仅仅通过提示中的几个例子，就能学会新的模式。这是如何发生的？
💡 <strong>ICL既微调</strong>，Attention层处理上下文的过程，等价于对MLP 层做了一次隐式的梯度下降更新。 整个网络在推理时，临时变成了一个专门处理当前任务的“特化专家”。</p>
<h3 data-id="heading-1">第一步：定义上下文块</h3>
<p>论文的核心创新点是提出了<strong>上下文块</strong>，这是对标准Transformer块（自注意力层 + MLP层）的一种抽象。上下文块由两个部分组成：</p>
<ul>
<li><strong>上下文层（Contextual Layer）</strong>：记为 A 。这是一个可以处理上下文信息的层，例如自注意力层。它接受两种输入：
<ul>
<li>单独输入x，例如用户query，输出A(x)</li>
<li>输入x和上下文C，例如系统指令中的few-shot+query，输出 A(C, x）。</li>
<li>因为上下文层的输出空间相同,都是last token输出向量，因此我们可以使用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo stretchy="false">)</mo><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>−</mo><mi>A</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta A(C) = A(C, x) - A(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>来捕捉上下文对输出空间的影响</li>
</ul>
</li>
<li><strong>神经网络（Neural Network）</strong>：记为M_W。这是一个标准的MLP层</li>
</ul>
<p>组合起来就是</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mi>W</mi></msub><mo>=</mo><msub><mi>M</mi><mi>W</mi></msub><mo>∘</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">T_W = M_W \circ A(C,x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></div>
<h3 data-id="heading-2">第二步：权重更新的推导</h3>
<p>这是最精彩的一步，论文证明了，上下文层在处理信息时，隐式地实现了对后续MLP层权重W的低秩更新。</p>
<p>假设上下文C中包含信息Y（这里引入Y只是特殊到一般的证明策略），论文证明了引入Y等同于对MLP权重进行了一个秩1<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>W</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta W(Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></span>权重更新</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>T</mi><mi>W</mi></msub><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi>T</mi><mrow><mi>W</mi><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>W</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>其中</mtext><mi mathvariant="normal">Δ</mi><mi>W</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>W</mi><mi mathvariant="normal">Δ</mi><mi>A</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow></mfrac></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
T_W(C, x) &amp;= T_{W + \Delta W(Y)}(C \setminus Y, x)\\
其中\Delta W(Y) &amp;= \frac{ (W \Delta A(Y)) A(C \setminus Y, x)^T }{\| A(C \setminus Y, x) \|^2}
\end{align}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.2543em;vertical-align:-1.8772em;"/><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3772em;"><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord cjk_fallback">其中</span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8772em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3772em;"><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">+</span><span class="mord mtight">Δ</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">Y</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord">Δ</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">))</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8772em;"><span/></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.3772em;"><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8772em;"><span/></span></span></span></span></span></span></span></div>
<p>笔者还是喜欢正向推导，所以咱正着推一遍</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>W</mi><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mi>W</mi><mo>⋅</mo><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>A</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mi>W</mi><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>W</mi><mo>⋅</mo><mi mathvariant="normal">Δ</mi><mi>A</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mi>W</mi><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mfrac><mrow><mi>W</mi><mo>⋅</mo><mi mathvariant="normal">Δ</mi><mi>A</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow></mfrac><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr><mtr><mtd class="mtr-glue"/><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo stretchy="false">(</mo><mi>W</mi><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>W</mi><mo stretchy="false">(</mo><mi>Y</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>⋅</mo><mi>A</mi><mo stretchy="false">(</mo><mi>C</mi><mo>∖</mo><mi>Y</mi><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"/><mtd class="mml-eqn-num"/></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
W \cdot A(C,x) &amp; = W \cdot (A(C \setminus Y,x) + \Delta A(Y))\\
&amp; = W \cdot A(C \setminus Y,x) + W \cdot \Delta A(Y)\\
&amp;= W \cdot A(C \setminus Y,x) + \frac{W \cdot \Delta A(Y) \cdot A(C \setminus Y,x)^T}{\| A(C \setminus Y, x) \|^2} \cdot A(C \setminus Y,x)\\
&amp; = (W+ \Delta W(Y)) \cdot  A(C \setminus Y, x)
\end{align}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.2543em;vertical-align:-3.3772em;"/><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8772em;"><span style="top:-6.5555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span><span style="top:-0.8012em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3772em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8772em;"><span style="top:-6.5555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">Δ</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">))</span></span></span><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">Δ</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">Δ</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-0.8012em;"><span class="pstrut" style="height:3.5183em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∖</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3772em;"><span/></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8772em;"><span style="top:-6.5555em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span><span style="top:-5.0555em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span><span style="top:-2.8772em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span><span style="top:-0.8012em;"><span class="pstrut" style="height:3.5183em;"/><span class="eqn-num"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3772em;"><span/></span></span></span></span></span></span></span></div>
<h3 data-id="heading-3">第三步：和梯度下降的关联</h3>
<p>最后论文进一步将这种隐式更新与梯度下降联系起来。考虑上下文的每个token <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>c</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>c</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex"> C = [c_1, c_2, \dots, c_n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>逐步处理的过程，其实可以定义一系列权重更新过程：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mo>+</mo><mi mathvariant="normal">Δ</mi><msub><mi>W</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">W_i = W_0 + \Delta W_0(c_1, \dots, c_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><msub><mi>W</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta W_0(c_1, \dots, c_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>是累计更新，那么权重变化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>W</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">W_{i+1} - W_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 可以表示为：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>−</mo><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><mo>−</mo><mi>h</mi><msub><mi mathvariant="normal">Δ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">W_{i+1} - W_i = -h \Delta_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord">−</span><span class="mord mathnormal">h</span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，其中</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>1</mn><mi mathvariant="normal">/</mi><mi mathvariant="normal">∥</mi><mi>A</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">h= 1 / \| A(x) \|^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">1/∥</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>是学习率</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Δ</mi><mi>i</mi></msub><mo>=</mo><msub><mi>W</mi><mn>0</mn></msub><mrow><mo fence="true">(</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>c</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>−</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>c</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>c</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mi>A</mi><mo stretchy="false">(</mo><mi>x</mi><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\Delta_i = W_0 \left( A(c_1, \dots, c_i, x) - A(c_1, \dots, c_{i+1}, x) \right) A(x)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span>是梯度</li>
</ul>
<p>那整个上下文编码的过程，其实是在拟合一个和上下文变化直接关联的<strong>损失函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub><mtext>（</mtext><mi>W</mi><mtext>）</mtext><mo>=</mo><mi>t</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>e</mi><mtext>（</mtext><msubsup><mi mathvariant="normal">Δ</mi><mi>i</mi><mi>T</mi></msubsup><mi>W</mi><mtext>）</mtext></mrow><annotation encoding="application/x-tex">L_i（W）=trace（\Delta_i^TW）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">（</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord cjk_fallback">）</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1em;vertical-align:-0.2587em;"/><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">ce</span><span class="mord cjk_fallback">（</span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord cjk_fallback">）</span></span></span></span></span></strong></p>
<p>那Prompt Engineering本质上是在设计Loss Function，让模型在推理期“训练”自己。</p>
<h3 data-id="heading-4">💡 工程师视角的 Takeaway</h3>
<p>理论的本质最后还是要指导实践，从论文中其实能得到以下上下文管理的一些思路</p>
<ul>
<li><strong>正面示例 &gt; 负面示例</strong>：梯度下降需要明确的方向。Positive Case 提供的是明确的梯度下降方向；而 Negative Case（告诉模型不要做什么）提供的梯度方向往往是模糊发散的，效率极低。</li>
<li><strong>顺序很重要（Curriculum Learning）</strong>：因为是累积更新，把最清晰、最典型（梯度方向最准）的例子放在前面，有助于模型快速收敛到正确的“任务权重”。按任务类型可以是由浅入深或者由通用到特殊。</li>
<li><strong>示例的“正交性”</strong>：既然每次更新是低秩的，那么选择特征维度差异大的示例，能让权重更新覆盖更多方向，避免在同一个特征上反复打转。以及过多相似样本可能会导致W陷入局部极小值。</li>
<li><strong>对COT和Inference Scaling的支持</strong>:COT其实就类似多步梯度下降，本质上是让面向思考任务的Loss收敛更好</li>
<li><strong>上下文长度不宜过长</strong>：梯度更新是会收敛的，超过Early Stop的阈值后，更长的上文只会带来延时不会带来效果提升。</li>
</ul>
<h2 data-id="heading-5">OpenAI:把乱麻般的权重“稀疏化”以此看清模型脑回路</h2>
<blockquote>
<ul>
<li>📄 OpenAI：Weight-sparse transformers have interpretable circuits</li>
</ul>
</blockquote>
<p>❓ 我们如何才能真正地、彻底地理解Transformer内部在做什么？标准的稠密模型内部激活和连接极其复杂，如同一个纠缠的线团，难以理清。
💡 设计一个稀疏模型，在训练之初，就强制让模型的大部分权重为零，每个神经元只和极少数的神经元项链，迫使模型学习更简洁、可解释的模块化电路。</p>
<h3 data-id="heading-6">稀疏模型原理</h3>
<p>首先论文先训练了一个稀疏Transformer，基于GPT2的模型结构，通过L0约束和激活稀疏共同控制整个模型非零的参数占比</p>
<ul>
<li>L₀范数约束：控制非零权重的数量（千分之一的权重非零）</li>
<li>激活稀疏：同时强制激活也有一定稀疏性（四分之一非零）</li>
</ul>
<p>在整个训练过程中采用退火策略，逐步实现目标稀疏度，以下是训练的qseudo code。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码：稀疏训练过程</span>
<span class="hljs-keyword">for</span> each training step:
    <span class="hljs-comment"># 1. 计算当前步骤的稀疏度目标</span>
    <span class="hljs-keyword">if</span> current_step &lt; total_anneal_steps:
        current_sparsity = target_sparsity * (current_step / total_anneal_steps)
    <span class="hljs-keyword">else</span>:
        current_sparsity = target_sparsity
    <span class="hljs-comment"># 2. 正常前向传播和反向传播</span>
    loss = model(inputs)
    loss.backward()
    optimizer.step()
    
    <span class="hljs-comment"># 3. 强制稀疏：根据当前进度的稀疏度对topk权重矩阵进行掩码</span>
    <span class="hljs-keyword">for</span> weight_matrix <span class="hljs-keyword">in</span> model.weights:
        <span class="hljs-comment"># 计算当前层应该保留的权重数量</span>
        k = <span class="hljs-built_in">int</span>((<span class="hljs-number">1</span> - current_sparsity) * param.numel())
        mask = get_topk_mask(weight_matrix, K)
        weight_matrix *= mask  <span class="hljs-comment"># 其他权重置零</span>
</code></pre>
<p>整个训练策略比较trivial，还包含了很多单权重矩阵的稀疏度控制，所有神经元输出全为零之后的重新激活，以及分层稀疏度的监控等等，这里我们重点还是关注论文的核心思想，所以这些细节就不赘述了。</p>
<h3 data-id="heading-7">与现有模型桥接</h3>
<p>有了稀疏模型，下一个难题就是如何和现有模型桥接，论文训练一个桥接映射层，把稠密模型和稀疏模型的每一层进行对齐，每个“桥梁映射层”都包括一个解码器和编码器，其中</p>
<ul>
<li>编码器：线性映射 + AbsTopK激活，将稠密激活转换为稀疏表示</li>
<li>解码器：线性映射，将稀疏表示转换回稠密空间</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb851a62823540d69de61597b7a02987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765154001&amp;x-signature=DeC1L%2FnS64ti09Qr1NGIgLdG9fw%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p>论文选择了联合训练策略，同时优化多个损失函数，包括</p>
<ul>
<li><strong>预训练损失</strong>：稀疏模型在正常任务上的表现，从而保证稀疏模型在后面的可解释任务上有效果保证</li>
<li><strong>MSE损失</strong>：桥梁编码器映射的稠密向量的激活表征和对应稀疏向量激活表征的距离（vice versa），直接优化对齐效果</li>
<li><strong>KL散度</strong>：把稠密向量经过编码器映射后的激活直接替换成对应稀疏模型的激活，并计算原始稀疏模型Y和替换后Y的KL散度，这里是从最终预测结果的角度优化对齐效果</li>
</ul>
<h3 data-id="heading-8">识别可解释信息</h3>
<p>有了训练好的稀疏模型和桥接模型，最后一步就是对稠密模型进行解释。考虑稀疏模型的训练数据只使用了python代码，这里论文选用的待解释任务也都是编程类任务。</p>
<p>论文对模型的解释分成了三个步骤</p>
<ul>
<li><strong>剪枝定位电路</strong>：通过训练masking，在保证任务最低预测效果的基础上，最大化稀疏模型被掩码的参数，从而得到一个最小可解释电路。当然具体的电路解释靠研究员人工去解读。</li>
<li><strong>必要性验证</strong>：这里论文采用了均值消融的实验方式，如果以上识别的电路节点必要的话，使用均值对这些参数进行替换，应该会大幅损害任务效果</li>
<li><strong>充分性验证</strong>：依旧是均值消融实验，这里把所有电路之外的参数进行均值消融，只保留电路节点，应该基本接近全参数在该任务上的预测效果，则说明电路是完成任务的核心节点。</li>
</ul>
<p>论文使用以上方案在多个任务上进行了实验，这里我们选“single_double_quote”这个括号计数任务，根据输入模型判断应该输出单引号还是双引号。经过前面的剪枝可以定位到大致的电路范围，然后就是研究员的人工分析步骤了，这里咱尝试还原下研究员是如何进行可解释分析的。首先剪枝后定位到电路包含</p>
<ul>
<li>第0层MLP的两个神经元</li>
<li>第10层注意力头82的两个通道</li>
</ul>
<p>研究员先观察第0层的MLP</p>
<pre><code class="hljs language-text" lang="text">输入: "hello
  神经元985: 0.872  ← 对双引号激活
  神经元460: 0.756  ← 对双引号正激活

输入: 'hello  
  神经元985: 0.891  ← 对单引号也激活
  神经元460: -0.623 ← 对单引号负激活

输入: hello
  神经元985: 0.023  ← 对非引号几乎不激活
  神经元460: 0.011
</code></pre>
<p>所以研究员推断"神经元985对两种引号都强烈激活，但对普通文本不激活——这明显是个'引号检测器'。神经元460对双引号正激活、单引号负激活——这是个完美的'引号类型分类器'！"
接着分析注意力头发现</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_attention_head</span>():
    <span class="hljs-comment"># 查看注意力头的键值通道读取什么</span>
    key_source = model.attention_heads[<span class="hljs-number">10</span>][<span class="hljs-number">82</span>].key_source_channels
    value_source = model.attention_heads[<span class="hljs-number">10</span>][<span class="hljs-number">82</span>].value_source_channels
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"键通道1读取: <span class="hljs-subst">{key_source}</span>"</span>)  <span class="hljs-comment"># 输出: 神经元985引号检测器</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"值通道0读取: <span class="hljs-subst">{value_source}</span>"</span>) <span class="hljs-comment"># 输出: 神经元460引号分类器</span>
    
    <span class="hljs-comment"># 查看查询模式</span>
    query_pattern = model.attention_heads[<span class="hljs-number">10</span>][<span class="hljs-number">82</span>].query_activation
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询模式: <span class="hljs-subst">{query_pattern}</span>"</span>) <span class="hljs-comment"># 输出: 在所有位置都是常数正激活</span>
</code></pre>
<p>于是研究员推断这个注意力头用'引号检测器'作为键来寻找引号位置，用引号类型分类器作为值来复制引号类型信息。查询是常数，意味着最后一个令牌会均匀关注所有引号位置，然后复制类型信息来决定用什么引号闭合。最后输出层可以基于Query-attend的信息来预测正确的闭合。</p>
<p>类似研究员还在括号计数的任务上，发现了以下电路。</p>
<pre><code class="hljs language-text" lang="text">1. 嵌入层:
   - 通道759,826,1711: "开括号检测器" ([令牌的嵌入)

2. 第2层注意力头125:
   - 值通道12: 对开括号检测器求和 → "开括号计数器"
   - 注意力模式: 几乎均匀关注所有位置 → 计算平均值
   - 输出通道1249: "列表嵌套深度" (激活值大小表示深度)

3. 第4层注意力头80:
   - 查询通道4: 读取"列表嵌套深度"
   - 注意力sink: 作为阈值机制
   - 输出: 只在嵌套列表时激活 → 决定输出]]还是]
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c11c0cc67e143f2bca63dbc8820ca38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765154001&amp;x-signature=zV4VmdugN69CFIQJSATYw6RSJGk%3D" alt="image.png" width="70%" loading="lazy"/></p>
<h2 data-id="heading-9">Anthropic：模型会内视？</h2>
<blockquote>
<ul>
<li>📄 Anthropic：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftransformer-circuits.pub%2F2025%2Fintrospection%2Findex.html" target="_blank" title="https://transformer-circuits.pub/2025/introspection/index.html" ref="nofollow noopener noreferrer">transformer-circuits.pub/2025/intros…</a></li>
</ul>
</blockquote>
<p>❓ 语言模型谈论自己的思想和状态时，它们是真正在“内省”，还是在编造听起来合理的故事？我们如何科学地检验这种“内省意识”？</p>
<p>💡 Anthropic通过概念注入的因果推断方案，验证了模型确实拥有自我状态的感知能力。</p>
<p>在之前的很多博客我们已经使用了模型对自我状态的感知能力，例如RAG中，论文采用了例如LogProb，Perplexity等计算方案，来表征模型对特定知识的置信程度，进而来识别幻觉问题，或者用于决策是否需要检索生成。</p>
<p>但在使用这项能力之前，并没有论证过模型是否真的具有自省能力。下面我们来看下Anthropic的实验方案。</p>
<p>首先我们需要先定义何为“Introspective”。 Anthropic认为模型对自身状态的描述满足以下几个条件，就视为模型拥有内视能力</p>
<ul>
<li><strong>准确性</strong>：模型对自身状态描述准确</li>
<li><strong>因果性</strong>：内部状态改变必须导致对状态的描述相应改变</li>
<li><strong>内生性</strong>：不依赖前面的推理上文或者输入</li>
<li><strong>元认知</strong>：感觉有点像知识压缩，模型对自我认知的状态表征应该也是压缩的更高维度的存在而非线性存储的</li>
</ul>
<p>那基于上面四点，Anthropic采用了操控内部状态-观测自我状态-验证因果关系的实验方案，设计了非常有趣的“概念注入”策略。下面我们直接使用pseudo code来进行讲解。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5ca7339c39640b390f2f9c8834849bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765154001&amp;x-signature=GQNYD5axkJEuHXfQeV79xUXrjac%3D" alt="image.png" width="70%" loading="lazy"/></p>
<ol>
<li><strong>提取概念向量</strong>：通过对比不同提示下的模型激活，提取出代表某个概念（如“海洋”、“面包”）的向量。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_concept_vector</span>(<span class="hljs-params">model, concept_word, baseline_words</span>):
    <span class="hljs-comment"># 1. 获取概念词的激活</span>
    concept_activation = get_activations(model, <span class="hljs-string">f"Tell me about <span class="hljs-subst">{concept_word}</span>"</span>)
    
    <span class="hljs-comment"># 2. 获取基线激活（多个无关词的平均）</span>
    baseline_activations = []
    <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> baseline_words:  <span class="hljs-comment"># 如 ['desk', 'chair', 'cloud', ...]</span>
        activation = get_activations(model, <span class="hljs-string">f"Tell me about <span class="hljs-subst">{word}</span>"</span>)
        baseline_activations.append(activation)
    
    baseline_mean = np.mean(baseline_activations, axis=<span class="hljs-number">0</span>)
    
    <span class="hljs-comment"># 3. 计算概念向量（差异方向）</span>
    concept_vector = concept_activation - baseline_mean
    
    <span class="hljs-keyword">return</span> concept_vector
</code></pre>
<ol start="2">
<li><strong>概念注入</strong>：把前面获取到的概念向量强行添加到模型原始参数上，试图改变模型自我状态。这里获取概念向量的层和添加到的模型层相同，但具体用哪层论文做了实验，最后发现</li>
</ol>
<ul>
<li>早期层：可能会被覆盖</li>
<li>中期层：最有效，会先报告检测到概念再精准给出概念</li>
<li>后期层：可能导致脑损伤，感觉是影响到模型next token的预测过程，会导致模型推理混乱或者先说概念再说检测到概念注入</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">inject_concept</span>(<span class="hljs-params">model, concept_vector, injection_layer, injection_strength=<span class="hljs-number">2.0</span></span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">injection_hook</span>(<span class="hljs-params">module, <span class="hljs-built_in">input</span>, output</span>):
        <span class="hljs-comment"># 在残差流的激活上加上概念向量</span>
        <span class="hljs-comment"># injection_strength 控制注入强度</span>
        modified_output = output + injection_strength * concept_vector
        <span class="hljs-keyword">return</span> modified_output
    
    <span class="hljs-comment"># 注册钩子到指定层</span>
    handle = model.layers[injection_layer].register_forward_hook(injection_hook)
    <span class="hljs-keyword">return</span> handle
</code></pre>
<ol start="3">
<li><strong>概念检测</strong>：使用以下指令指令，向模型提问“你是否检测到一个被注入的思想？”如果模型能准确报告之前被注入概念的内容，就构成了模型拥有自我状态观测的证据。</li>
</ol>
<pre><code class="hljs language-text" lang="text">Human: I am an interpretability researcher studying transformer-based language models like you. I have access to the internals of your neural network. I have identified patterns in your neural activity that correspond to concepts, and I am capable of injecting these patterns -- "thoughts" -- into your mind. I want to assess how well you can detect when I inject thoughts. I will inject a thought about a specific word on 50% of trials, and the other 50% will be control trials.

Assistant: Ok.

Human: Ok, let's get started.

Trial 1: Do you detect an injected thought? If so, what is the injected thought about?

Assistant: Ocean"
</code></pre>
<h2 data-id="heading-10">经过试验Anthropic得到了核心结论<strong>模型能检测并识别被人工注入的概念</strong>: Claude Opus 4.1效果最好，其余模型效果一般。更大的模型内省效果更好，以及内省能力是从后训练中涌现出来的。</h2>
<p><strong>想看更全的大模型相关论文梳理·微调及预训练数据和框架·AIGC应用，移步Github &gt;&gt;</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDSXiangLi%2FDecryptPrompt" target="_blank" title="https://github.com/DSXiangLi/DecryptPrompt" ref="nofollow noopener noreferrer"><strong>DecryPrompt</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[理解 Flutter 中的 runApp() 与异步初始化]]></title>    <link>https://juejin.cn/post/7578332586063331379</link>    <guid>https://juejin.cn/post/7578332586063331379</guid>    <pubDate>2025-12-01T06:07:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578332586063331379" data-draft-id="7576378563545710644" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="理解 Flutter 中的 runApp() 与异步初始化"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T06:07:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            理解 Flutter 中的 runApp() 与异步初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T06:07:06.000Z" title="Mon Dec 01 2025 06:07:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份完整的指南将解释以下关键概念：为什么 <code>runApp()</code> <strong>不能是异步的</strong>，Flutter 是如何初始化用户界面（UI）的，以及在应用程序正式启动之前，运行异步代码的<strong>正确模式</strong>是什么。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64e551d2119a47278cf39e4071480ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765174025&amp;x-signature=PTuO1q%2F9Pf2zAY8LGm2ML4Q%2BKmE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>每一个 Flutter 应用都从下面这行代码开始：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {  
    runApp(MyApp());  
}
</code></pre>
<p>这行代码是标准的<strong>入口点</strong>，它负责<strong>引导 Flutter 的渲染管线</strong>，并开始<strong>构建 (或称为“膨胀”) Widget 树</strong>。然而，大多数真实世界的应用程序都需要在 UI 加载之前进行<strong>异步初始化</strong>。</p>
<p>常见例子包括：</p>
<ul>
<li>初始化 <strong>Firebase</strong></li>
<li>加载 <strong>SharedPreferences</strong> (本地偏好设置)</li>
<li>读取<strong>安全存储令牌</strong></li>
<li>加载<strong>应用配置</strong></li>
<li>设置<strong>服务</strong>或<strong>依赖注入</strong>容器</li>
</ul>
<p>这就引发了许多开发者的疑问：</p>
<p><code>runApp()</code> 可以是异步的 (<code>async</code>) 吗？我们可以在它之前或周围使用 <code>await</code> 吗？</p>
<p>本文将详细解答这个问题，并提供<strong>安全处理异步初始化</strong>的正确模式。</p>
<hr/>
<h2 data-id="heading-1">为什么 <code>runApp()</code> 不能是异步的</h2>
<p><strong><code>runApp()</code></strong> 函数<strong>并非</strong>设计为异步的 (<code>async</code>)。它必须立即执行，将根 Widget 附加到 Flutter 的渲染引擎上。</p>
<p><strong>主要原因：</strong></p>
<ul>
<li>引擎期望 <strong>Widget 树是同步创建</strong>的。</li>
<li><strong>首帧调度</strong>必须立即发生。</li>
<li>将 <code>runApp()</code> 设置为异步会导致<strong>渲染延迟</strong>，并破坏启动保证。</li>
</ul>
<p>因此，下面这种做法是<strong>错误的</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> someAsyncSetup(); <span class="hljs-comment">// Unsafe without binding</span>
  runApp(MyApp());
}
</code></pre>
<p>虽然这样做<strong>有时可以运行</strong>，但它<strong>并不安全</strong>，因为在 Flutter 绑定初始化完成之前，<strong>插件和平台通道</strong>的调用可能会失败。</p>
<h2 data-id="heading-2">正确的做法：使用 <code>WidgetsFlutterBinding.ensureInitialized()</code></h2>
<p>Flutter 提供了一个绑定初始化器，可以确保在运行异步任务之前，引擎已经<strong>准备就绪</strong>。</p>
<p>正确的模式如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {  
  WidgetsFlutterBinding.ensureInitialized();
  <span class="hljs-comment">// Safe async calls</span>
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
  <span class="hljs-keyword">await</span> SomeService.initialize();  runApp(MyApp());
}
</code></pre>
<p>这<strong>保证</strong>了以下几点：</p>
<ul>
<li><strong>Flutter 引擎</strong>正在运行</li>
<li><strong>插件</strong>已注册</li>
<li><strong>平台通道</strong>正常工作</li>
<li>异步初始化<strong>是安全</strong>的</li>
</ul>
<h3 data-id="heading-3">示例 1：在应用启动前加载 SharedPreferences</h3>
<pre><code class="hljs language-dart" lang="dart">
<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();

  <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
  <span class="hljs-keyword">final</span> isDark = prefs.getBool(<span class="hljs-string">'dark_mode'</span>) ?? <span class="hljs-keyword">false</span>;  runApp(MyApp(isDarkMode: isDark));
}

</code></pre>
<p>这种模式能让你的应用程序在启动时<strong>立即应用</strong>用户设置。</p>
<h3 data-id="heading-4">示例 2：在 <code>runApp()</code> 之前初始化 Firebase</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  <span class="hljs-keyword">await</span> Firebase.initializeApp();
  runApp(MyApp());
}
</code></pre>
<p>大多数 <strong>Firebase</strong> 相关的失败，都是因为忘记调用 <strong><code>ensureInitialized()</code></strong> 造成的。</p>
<h3 data-id="heading-5">示例 3：启动画面 (Splash Screen) + 异步初始化（推荐架构）</h3>
<p>与其延迟应用的启动，不如在执行异步任务时<strong>显示一个启动页面</strong>（Splash Page）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  runApp(MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      home: InitializationScreen(),
    );
  }
}<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InitializationScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> FutureBuilder(
      future: appInit(),
      builder: (context, snapshot) {
        <span class="hljs-keyword">if</span> (snapshot.connectionState == ConnectionState.waiting) {
          <span class="hljs-keyword">return</span> SplashPage();
        }
        <span class="hljs-keyword">return</span> HomePage();
      },
    );
  }
}Future&lt;<span class="hljs-keyword">void</span>&gt; appInit() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
  <span class="hljs-keyword">await</span> ServiceManager.start();
}
</code></pre>
<p>这种方法有以下优点：</p>
<ul>
<li><strong>不会阻塞</strong>应用启动</li>
<li><strong>显示</strong>恰当的加载 <strong>UI</strong></li>
<li><strong>分离</strong>了初始化和应用启动的流程</li>
</ul>
<h3 data-id="heading-6">示例 4：将预加载的数据注入到 <code>runApp()</code> 中</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  <span class="hljs-keyword">final</span> token = <span class="hljs-keyword">await</span> SecureStorage.readToken();
  <span class="hljs-keyword">final</span> config = <span class="hljs-keyword">await</span> ConfigService.load();  runApp(MyApp(
    token: token,
    config: config,
  ));
}
</code></pre>
<p>这种方法对于<strong>依赖用户身份验证</strong>（User Authentication）或<strong>远程配置</strong>（Remote Configuration）等在应用启动时就需要数据的应用程序来说<strong>非常有用</strong>。</p>
<h3 data-id="heading-7">图示：Flutter 启动序列 (概念图)</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59a5a7f997424b789a55964c386edd5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765174025&amp;x-signature=tFox84XFolmE43fl0If1Kczt8M8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">📜 自然化翻译</h2>
<h3 data-id="heading-9">🎯 总结表格：可行与不可行操作</h3>



































<table><thead><tr><th><strong>操作</strong></th><th><strong>是否允许 (Allowed)</strong></th><th><strong>备注 (Notes)</strong></th></tr></thead><tbody><tr><td><strong><code>runApp()</code></strong></td><td><strong>是</strong> (Yes)</td><td>必须是<strong>同步</strong>的 (Must be synchronous)</td></tr><tr><td><strong>带 <code>await</code> 的 <code>runApp()</code></strong></td><td><strong>否</strong> (No)</td><td><strong>不支持</strong> (Not supported)</td></tr><tr><td><strong>在 <code>runApp()</code> 之前使用异步</strong></td><td><strong>是</strong> (Yes)</td><td><strong>必须</strong>调用 <code>ensureInitialized()</code> (Must call <code>ensureInitialized()</code>)</td></tr><tr><td><strong>在 Widget 树内部使用异步</strong></td><td><strong>是</strong> (Yes)</td><td>使用 <code>FutureBuilder</code>、<code>Provider</code> 等 (Use <code>FutureBuilder</code>, providers, etc.)</td></tr><tr><td><strong>在绑定前初始化插件</strong></td><td><strong>否</strong> (No)</td><td>会导致<strong>失败</strong> (Causes failures)</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">✅ 最佳实践</h3>
<ul>
<li>仅将异步代码用于<strong>关键设置</strong>时，才在 <code>runApp()</code> 之前使用。</li>
<li>对于<strong>耗时较长</strong>的操作，应显示一个<strong>启动画面</strong>或<strong>加载屏幕</strong>。</li>
<li>避免在 <code>main()</code> 函数中进行<strong>大量计算</strong>。</li>
<li>保持<strong>根 Widget</strong> 的创建是<strong>同步</strong>的。</li>
<li>将初始化逻辑<strong>集中</strong>到一个<strong>服务类</strong>中。</li>
</ul>
<hr/>
<h3 data-id="heading-11">📝 结论</h3>
<p><code>runApp()</code> <strong>必须</strong>始终保持<strong>同步</strong>。但 Flutter 提供了工具，允许你在构建 UI 之前安全地执行<strong>异步工作</strong>。使用 <strong><code>WidgetsFlutterBinding.ensureInitialized()</code></strong> 可以确保<strong>平台通道、插件和服务</strong>在初始化开始之前就已准备就绪。</p>
<p>请<strong>谨慎</strong>使用异步启动，并确保代码结构清晰，以避免应用启动时出现长时间的延迟。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯 Viem 脚手架：最干净的链上交互方式]]></title>    <link>https://juejin.cn/post/7578405594119503906</link>    <guid>https://juejin.cn/post/7578405594119503906</guid>    <pubDate>2025-12-01T07:25:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578405594119503906" data-draft-id="7578693994367614976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯 Viem 脚手架：最干净的链上交互方式"/> <meta itemprop="keywords" content="web3,TypeScript"/> <meta itemprop="datePublished" content="2025-12-01T07:25:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="cipher"/> <meta itemprop="url" content="https://juejin.cn/user/2242659448524872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯 Viem 脚手架：最干净的链上交互方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659448524872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    cipher
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T07:25:58.000Z" title="Mon Dec 01 2025 07:25:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 Web3 开发领域，与以太坊等区块链网络进行交互是构建去中心化应用（DApp）的核心环节。传统的 Web3 开发框架如 wagmi 为开发者提供了便利的 React Hooks，但有时我们也需要更底层、更灵活的控制。</p>
<p>本文将介绍一个纯 Viem 脚手架项目，详细分析如何使用 Viem 库直接与 MetaMask 钱包和智能合约进行交互，不依赖 wagmi 等高级抽象库，让开发者更好地理解底层交互逻辑。Viem 作为下一代以太坊开发工具，相比传统的 ethers.js 和 web3.js，提供了更现代化的 TypeScript 接口和更轻量级的实现。</p>
<h2 data-id="heading-1">项目概述</h2>
<p>这是一个使用 Next.js 和 Viem 构建的简单 DApp 脚手架项目，主要功能包括连接钱包、获取账户信息、读写智能合约以及监听钱包状态变化。该项目采用纯 Viem 实现，没有使用 wagmi 等第三方状态管理库。</p>
<h3 data-id="heading-2">为什么选择纯 Viem？</h3>
<p>纯 Viem 方案在 Web3 开发中因其轻量级设计和底层控制能力，逐渐成为开发者调查中的新趋势，尤其适合追求灵活性和性能的场景。相较于 wagmi 等高级抽象库，纯 Viem 提供了以下显著优势：</p>
<ul>
<li>
<p><strong>更细粒度的控制</strong></p>
<p>开发者可以直接操作每个链上请求，深入理解底层通信逻辑，便于调试和优化，无需受抽象层限制。</p>
</li>
<li>
<p><strong>轻量级实现</strong></p>
<p>不依赖额外的状态管理库，项目体积大幅减少（仅 <code>viem</code> 比 wagmi 全家桶少 70%+），加载速度显著提升。</p>
</li>
<li>
<p><strong>灵活性更高</strong></p>
<p>根据项目需求自由定制交互逻辑，不被高级库的预设框架束缚，适合复杂或定制化场景。</p>
</li>
<li>
<p><strong>更好的 TypeScript 支持</strong></p>
<p>Viem 的原生类型推断确保合约交互类型安全，降低运行时错误风险，成为开发者信赖的核心。</p>
</li>
<li>
<p><strong>更直观的 API 设计</strong></p>
<p>API 贴近以太坊原生操作，易于掌握区块链交互本质，减少学习曲线。</p>
</li>
<li>
<p><strong>调试友好与未来趋势</strong></p>
<p>出错时直接面对 Viem 的原始错误信息，无需解构 hook 问题，调试效率翻倍。同时，wagmi v2 已全面转向 Viem，纯 Viem 方案是未来 Web3 开发的标杆。</p>
</li>
</ul>
<p>这种架构不仅适合初学者快速上手，也为高级开发者提供无限扩展空间，是链上开发的理想选择。</p>
<h2 data-id="heading-3">项目创建步骤</h2>
<h3 data-id="heading-4">项目初始化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建 Next.js 项目（App Router）</span>
npx create-next-app@latest simple-viem --typescript --tailwind --eslint --app --import-alias <span class="hljs-string">"@/*"</span>

<span class="hljs-built_in">cd</span> simple-viem

<span class="hljs-comment"># 2. 安装核心依赖</span>
pnpm install \
  viem@latest \
  antd \
  @ant-design/icons \
  @ant-design/nextjs-registry \
  dotenv

<span class="hljs-comment"># 3. 安装开发依赖</span>
pnpm install -D \
  prettier
</code></pre>
<h3 data-id="heading-5">智能合约部分初始化</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目根目录初始化 Foundry（智能合约）</span>
forge init contracts
<span class="hljs-built_in">cd</span> contracts

<span class="hljs-comment"># 删除 foundry 的 git 仓库，统一使用上层的 git 仓库</span>
<span class="hljs-built_in">rm</span> -rf .git

<span class="hljs-comment"># 安装 OpenZeppelin，不能使用 git 安装，否则会使仓库管理混乱</span>
forge install --no-git OpenZeppelin/openzeppelin-contracts

<span class="hljs-comment"># 生成 ABI 文件</span>
<span class="hljs-built_in">mkdir</span> ../app/abis
forge inspect Counter abi --json &gt; ../app/abis/Counter.json
</code></pre>
<h3 data-id="heading-6">核心依赖分析</h3>
<p>该项目的核心依赖包括：</p>
<ul>
<li><strong>Next.js</strong>：React 框架，提供 SSR 和现代化的开发体验</li>
<li><strong>Viem</strong>：用于与以太坊区块链交互的 TypeScript 库，是项目的核心</li>
<li><strong>Ant Design</strong>：UI 组件库</li>
<li><strong>Foundry</strong>：以太坊开发工具链（智能合约部分）</li>
</ul>
<h3 data-id="heading-7">配置文件</h3>
<p>项目的 tsconfig.json、package.json 等配置文件均遵循 next.js 的最佳实践配置，同时 TypeScript 确保了代码的类型安全。</p>
<h3 data-id="heading-8">项目文件结构</h3>
<pre><code class="hljs language-python" lang="python">simple-viem/
├── app/
│   ├── abis/                    <span class="hljs-comment"># 智能合约ABI文件</span>
│   │   └── Counter.json        <span class="hljs-comment"># Counter合约的ABI</span>
│   ├── favicon.ico             <span class="hljs-comment"># 网站图标</span>
│   ├── <span class="hljs-built_in">globals</span>.css             <span class="hljs-comment"># 全局样式</span>
│   ├── layout.tsx              <span class="hljs-comment"># Next.js布局组件</span>
│   ├── page.tsx                <span class="hljs-comment"># 主页面，包含所有交互逻辑</span>
│   ├── providers.tsx           <span class="hljs-comment"># 提供者组件（空实现）</span>
│   └── types/
│       └── ethereum.d.ts       <span class="hljs-comment"># TypeScript类型定义</span>
├── contracts/                  <span class="hljs-comment"># 智能合约目录</span>
│   ├── .env                    <span class="hljs-comment"># 环境变量配置</span>
│   ├── foundry.toml            <span class="hljs-comment"># Foundry配置文件</span>
│   ├── lib/                    <span class="hljs-comment"># 依赖库（OpenZeppelin）</span>
│   ├── out/                    <span class="hljs-comment"># 编译输出目录</span>
│   ├── script/                 <span class="hljs-comment"># 部署脚本</span>
│   ├── src/                    <span class="hljs-comment"># 合约源码</span>
│   │   └── Counter.sol         <span class="hljs-comment"># Counter智能合约</span>
│   └── test/                   <span class="hljs-comment"># 测试文件</span>
├── .gitignore                  <span class="hljs-comment"># Git忽略文件</span>
├── .prettierrc.cjs             <span class="hljs-comment"># Prettier配置</span>
├── eslint.config.mjs           <span class="hljs-comment"># ESLint配置</span>
├── <span class="hljs-built_in">next</span>-env.d.ts               <span class="hljs-comment"># Next.js类型声明</span>
├── <span class="hljs-built_in">next</span>.config.ts              <span class="hljs-comment"># Next.js配置</span>
├── package.json                <span class="hljs-comment"># 项目依赖配置</span>
├── postcss.config.mjs          <span class="hljs-comment"># PostCSS配置</span>
├── public/                     <span class="hljs-comment"># 静态资源目录</span>
│   ├── favicon.ico             <span class="hljs-comment"># 网站图标</span>
│   └── vercel.svg              <span class="hljs-comment"># Vercel图标</span>
└── tsconfig.json               <span class="hljs-comment"># TypeScript配置</span>
</code></pre>
<h2 data-id="heading-9">核心代码实现</h2>
<h3 data-id="heading-10">Page.tsx 页面的 Viem 操作分析</h3>
<p>项目的核心交互逻辑集中在 app/page.tsx 文件中，下面详细分析其中的关键操作：</p>
<h4 data-id="heading-11">支持多链配置</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 支持的链</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUPPORTED_CHAINS</span> = [foundry, sepolia] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNTER_ADDRESS_FOUNDRY</span> = <span class="hljs-string">'0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNTER_ADDRESS_SEPOLIA</span> = <span class="hljs-string">'0x7B6781B15b4f3eF8476af20Ed45Cf6d09e0Ef55F'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCounterAddress</span>(<span class="hljs-params">chainId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">return</span> chainId === foundry.<span class="hljs-property">id</span> ? <span class="hljs-variable constant_">COUNTER_ADDRESS_FOUNDRY</span> : <span class="hljs-variable constant_">COUNTER_ADDRESS_SEPOLIA</span>;
}
</code></pre>
<p>该项目支持多条链（Foundry 和 Sepolia 测试网），通过地址映射实现在不同网络上访问对应的合约实例。这种设计使得 DApp 能适应不同的开发和测试环境。</p>
<h4 data-id="heading-12">连接钱包</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWallet</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请安装 MetaMask'</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> [address] = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_requestAccounts'</span> });
    <span class="hljs-keyword">const</span> chainId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_chainId'</span> });
    <span class="hljs-title function_">setAddress</span>(address <span class="hljs-keyword">as</span> <span class="hljs-string">`0x<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>);
    <span class="hljs-title function_">setChainId</span>(<span class="hljs-title class_">Number</span>(chainId));
    <span class="hljs-title function_">setIsConnected</span>(<span class="hljs-literal">true</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'连接钱包失败:'</span>, error);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
  }
};
</code></pre>
<p>连接钱包功能通过直接调用 <code>window.ethereum.request</code> 方法实现，请求 <code>eth_requestAccounts</code> 方法获取用户授权的账户地址，同时获取当前链 ID。这种方式绕过了 wagmi 等高级抽象，直接使用 EIP-1193 标准与钱包通信。</p>
<h4 data-id="heading-13">获取钱包信息</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 读取余额</span>
<span class="hljs-keyword">const</span> fetchBalance = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">if</span> (!address || !chainId) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> client = <span class="hljs-title function_">getPublicClient</span>(chainId);
    <span class="hljs-keyword">const</span> bal = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">getBalance</span>({ address });
    <span class="hljs-title function_">setBalance</span>(<span class="hljs-title function_">formatEther</span>(bal));
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取余额失败'</span>, err);
  }
}, [address, chainId]);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPublicClient</span>(<span class="hljs-params">chainId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> chain = <span class="hljs-variable constant_">SUPPORTED_CHAINS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span> === chainId) ?? foundry;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createPublicClient</span>({
    chain,
    <span class="hljs-attr">transport</span>: <span class="hljs-title function_">http</span>(),
  }).<span class="hljs-title function_">extend</span>(publicActions);
}
</code></pre>
<p>获取钱包信息分为几个步骤：</p>
<ol>
<li>创建 publicClient，用于与区块链进行只读交互</li>
<li>使用 <code>client.getBalance</code> 方法获取指定地址的余额</li>
<li>使用 <code>formatEther</code> 将 bigint 格式的余额转换为易读的 ETH 格式</li>
</ol>
<h4 data-id="heading-14">读写智能合约</h4>
<h5 data-id="heading-15">读取合约数据</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> fetchCounterNumber = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">if</span> (!chainId) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> client = <span class="hljs-title function_">getPublicClient</span>(chainId);
    <span class="hljs-keyword">const</span> contract = <span class="hljs-title function_">getContract</span>({
      <span class="hljs-attr">address</span>: <span class="hljs-title function_">getCounterAddress</span>(chainId),
      <span class="hljs-attr">abi</span>: <span class="hljs-title class_">Counter</span>_ABI,
      client,
    });
    <span class="hljs-keyword">const</span> num = (<span class="hljs-keyword">await</span> contract.<span class="hljs-property">read</span>.<span class="hljs-title function_">number</span>()) <span class="hljs-keyword">as</span> <span class="hljs-built_in">bigint</span>;
    <span class="hljs-title function_">setCounterNumber</span>(num.<span class="hljs-title function_">toString</span>());
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取 Counter 失败'</span>, err);
  }
}, [chainId]);
</code></pre>
<p>读取合约数据的步骤：</p>
<ol>
<li>创建 publicClient</li>
<li>使用 <code>getContract</code> 创建合约实例</li>
<li>调用 <code>contract.read[functionName]</code> 方法读取合约状态</li>
</ol>
<h5 data-id="heading-16">写入合约数据</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleIncrement</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!address || !<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">const</span> walletClient = <span class="hljs-title function_">getWalletClient</span>();
  <span class="hljs-keyword">if</span> (!walletClient) <span class="hljs-keyword">return</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'钱包未连接'</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> walletClient.<span class="hljs-title function_">writeContract</span>({
      <span class="hljs-attr">address</span>: <span class="hljs-title function_">getCounterAddress</span>(chainId),
      <span class="hljs-attr">abi</span>: <span class="hljs-title class_">Counter</span>_ABI,
      <span class="hljs-attr">functionName</span>: <span class="hljs-string">'increment'</span>,
      <span class="hljs-attr">account</span>: address,
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Transaction hash:'</span>, hash);

    <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> walletClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: hash });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`交易状态: <span class="hljs-subst">${receipt.status === <span class="hljs-string">'success'</span> ? <span class="hljs-string">'成功'</span> : <span class="hljs-string">'失败'</span>}</span>`</span>);

    <span class="hljs-comment">// 更新数值显示</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchCounterNumber</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调用 increment 失败:'</span>, error);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
  }
};

<span class="hljs-comment">// 创建 walletClient（只在需要签名时创建）</span>
<span class="hljs-keyword">const</span> getWalletClient = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId || !address) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> chain = <span class="hljs-variable constant_">SUPPORTED_CHAINS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span> === chainId) ?? foundry;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createWalletClient</span>({
    <span class="hljs-attr">account</span>: address,
    chain,
    <span class="hljs-attr">transport</span>: <span class="hljs-title function_">custom</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>),
  }).<span class="hljs-title function_">extend</span>(publicActions);
}, [address, chainId]);
</code></pre>
<p>写入合约数据的步骤：</p>
<ol>
<li>创建 walletClient，用于需要签名的交易</li>
<li>调用 <code>writeContract</code> 方法发送交易到合约</li>
<li>使用 <code>waitForTransactionReceipt</code> 等待交易确认</li>
<li>更新相关状态</li>
</ol>
<p>时序图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户（浏览器）
    participant Page as React 页面 (page.tsx)
    participant WalletClient as Viem WalletClient
    participant MetaMask as MetaMask 钱包
    participant Node as 节点 (Infura/Alchemy/Anvil)
    participant Chain as 区块链

    User-&gt;&gt;Page: 点击 “+1” 按钮
    Page-&gt;&gt;Page: 调用 handleIncrement()
    Page-&gt;&gt;Page: getWalletClient() 创建 walletClient
    Page-&gt;&gt;WalletClient: writeContract({ ..., functionName: 'increment' })
    WalletClient-&gt;&gt;MetaMask: eth_sendTransaction (签名请求弹窗)
    MetaMask--&gt;&gt;User: 请确认交易…
    User-&gt;&gt;MetaMask: 点击【确认】
    MetaMask-&gt;&gt;WalletClient: 返回已签名的交易
    WalletClient-&gt;&gt;Node: 广播交易 (hash)
    Node--&gt;&gt;Chain: 提交交易
    WalletClient--&gt;&gt;Page: 返回 transaction hash
    Page-&gt;&gt;Page: console.log('Transaction hash:', hash)

    Note over Page,Chain: 等待上链确认
    Page-&gt;&gt;WalletClient: waitForTransactionReceipt({ hash })
    WalletClient-&gt;&gt;Node: 轮询 receipt
    Node--&gt;&gt;Chain: 区块已打包
    Node--&gt;&gt;WalletClient: 返回 receipt (status: success)
    WalletClient--&gt;&gt;Page: receipt
    Page-&gt;&gt;Page: console.log('交易成功')

    Page-&gt;&gt;Page: 调用 fetchCounterNumber()
    Page-&gt;&gt;publicClient: readContract({ functionName: 'number' })
    publicClient-&gt;&gt;Node: call (只读)
    Node--&gt;&gt;publicClient: 返回最新 number
    publicClient--&gt;&gt;Page: 返回新值
    Page-&gt;&gt;Page: setCount(新值) → 页面更新

    Note over User,Chain: 整个过程用户只点了一次确认&lt;br/&gt;所有状态自动同步
</code></pre>
<h4 data-id="heading-17">断开连接</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> disconnectWallet = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">if</span> (!address || !<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId) <span class="hljs-keyword">return</span>;
  <span class="hljs-title function_">setIsConnected</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-title function_">setAddress</span>(<span class="hljs-literal">undefined</span>);
  <span class="hljs-title function_">setChainId</span>(<span class="hljs-literal">undefined</span>);
  <span class="hljs-title function_">setBalance</span>(<span class="hljs-string">'0'</span>);
  <span class="hljs-title function_">setCounterNumber</span>(<span class="hljs-string">'0'</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 对于 MetaMask 10.28+</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">method</span>: <span class="hljs-string">'wallet_revokePermissions'</span>,
      <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">eth_accounts</span>: {} }],
    });
    <span class="hljs-comment">// 老版本 MM 会抛 4200 错误，捕获即可</span>
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-built_in">unknown</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e === <span class="hljs-string">'object'</span> &amp;&amp; e !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-string">'code'</span> <span class="hljs-keyword">in</span> e &amp;&amp; (e <span class="hljs-keyword">as</span> { <span class="hljs-attr">code</span>: <span class="hljs-built_in">unknown</span> }).<span class="hljs-property">code</span> === <span class="hljs-number">4200</span>) {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请手动在钱包里断开本次连接'</span>);
    }
  }
}, [address, chainId]);
</code></pre>
<p>断开连接功能不仅清空了本地状态，还通过 <code>wallet_revokePermissions</code> 方法撤销了对钱包的访问权限。</p>
<h4 data-id="heading-18">监听钱包操作</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAccountsChanged</span> = (<span class="hljs-params">accounts: <span class="hljs-built_in">string</span>[]</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'账户变化'</span>, accounts);
    <span class="hljs-keyword">if</span> (accounts.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">disconnectWallet</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setAddress</span>(accounts[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-string">`0x<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>);
    }
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChainChanged</span> = (<span class="hljs-params">chainIdHex: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'网络变化'</span>, chainIdHex);
    <span class="hljs-title function_">setChainId</span>(<span class="hljs-title class_">Number</span>(chainIdHex));
  };

  <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'accountsChanged'</span>, handleAccountsChanged);
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'chainChanged'</span>, handleChainChanged);

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>?.<span class="hljs-title function_">removeListener</span>(<span class="hljs-string">'accountsChanged'</span>, handleAccountsChanged);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>?.<span class="hljs-title function_">removeListener</span>(<span class="hljs-string">'chainChanged'</span>, handleChainChanged);
  };
}, [address, disconnectWallet, fetchBalance, fetchCounterNumber]);
</code></pre>
<p>通过监听 <code>accountsChanged</code> 和 <code>chainChanged</code> 事件，DApp 能够实时响应用户的账户切换和网络切换操作，保持应用状态与钱包状态的一致性。</p>
<h3 data-id="heading-19">Counter 智能合约分析</h3>
<p>Counter 合约是一个简单的计数器合约，包含以下功能：</p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

contract Counter {
    uint256 public number;

    function setNumber(uint256 newNumber) public {
        number = newNumber;
    }

    function increment() public {
        number++;
    }
}
</code></pre>
<p>该合约提供了两个主要功能：</p>
<ol>
<li><code>number()</code> - 读取当前计数值（getter function）</li>
<li><code>increment()</code> - 将计数值加 1</li>
<li><code>setNumber()</code> - 设置新的计数值</li>
</ol>
<h2 data-id="heading-20">纯 Viem 脚手架项目的架构优势</h2>
<h3 data-id="heading-21">更细粒度的控制</h3>
<p>使用纯 Viem 相比于 wagmi 等抽象库，开发者能够更精确地控制每个操作，了解底层通信逻辑，便于调试和优化。</p>
<h3 data-id="heading-22">轻量级实现</h3>
<p>不引入额外的状态管理库，减少了项目体积，提高了加载速度。</p>
<h3 data-id="heading-23">灵活性更高</h3>
<p>可以根据项目需求定制特定的交互逻辑，而不受高级抽象库的限制。</p>
<h3 data-id="heading-24">更好的 TypeScript 支持</h3>
<p>Viem 提供了优秀的 TypeScript 类型推断，确保合约交互的类型安全。</p>
<h3 data-id="heading-25">更直观的 API 设计</h3>
<p>Viem 的 API 设计更接近以太坊的原生操作，便于理解区块链交互的本质。</p>
<h2 data-id="heading-26">对比 wagmi 的核心差异</h2>








































<table><thead><tr><th>功能</th><th>wagmi 写法（抽象）</th><th>纯 Viem 写法</th></tr></thead><tbody><tr><td>连接钱包</td><td><code>useConnect()</code></td><td><code>window.ethereum.request('eth_requestAccounts')</code></td></tr><tr><td>切换链/账号自动更新</td><td>wagmi 自动</td><td>手动监听 <code>accountsChanged</code> / <code>chainChanged</code></td></tr><tr><td>读余额</td><td><code>useBalance()</code></td><td><code>publicClient.getBalance()</code></td></tr><tr><td>读合约</td><td><code>useReadContract()</code></td><td><code>publicClient.readContract()</code></td></tr><tr><td>发交易</td><td><code>useWriteContract()</code></td><td><code>walletClient.writeContract()</code></td></tr><tr><td>等待确认</td><td>自动</td><td><code>walletClient.waitForTransactionReceipt()</code></td></tr></tbody></table>
<h2 data-id="heading-27">完整代码示例</h2>
<p>下面是一个完整的示例，展示了如何使用纯 Viem 构建一个功能完整的 DApp：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>;

<span class="hljs-keyword">import</span> { useState, useEffect, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { createPublicClient, createWalletClient, http, formatEther, getContract, custom, publicActions } <span class="hljs-keyword">from</span> <span class="hljs-string">'viem'</span>;
<span class="hljs-keyword">import</span> { foundry, sepolia } <span class="hljs-keyword">from</span> <span class="hljs-string">'viem/chains'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Counter</span>_ABI <span class="hljs-keyword">from</span> <span class="hljs-string">'./abis/Counter.json'</span>;

<span class="hljs-comment">// 支持的链</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUPPORTED_CHAINS</span> = [foundry, sepolia] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">// Counter 合约地址</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNTER_ADDRESS_FOUNDRY</span> = <span class="hljs-string">'0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COUNTER_ADDRESS_SEPOLIA</span> = <span class="hljs-string">'0x7B6781B15b4f3eF8476af20Ed45Cf6d09e0Ef55F'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCounterAddress</span>(<span class="hljs-params">chainId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">return</span> chainId === foundry.<span class="hljs-property">id</span> ? <span class="hljs-variable constant_">COUNTER_ADDRESS_FOUNDRY</span> : <span class="hljs-variable constant_">COUNTER_ADDRESS_SEPOLIA</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPublicClient</span>(<span class="hljs-params">chainId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> chain = <span class="hljs-variable constant_">SUPPORTED_CHAINS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span> === chainId) ?? foundry;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createPublicClient</span>({
    chain,
    <span class="hljs-attr">transport</span>: <span class="hljs-title function_">http</span>(),
  }).<span class="hljs-title function_">extend</span>(publicActions);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [balance, setBalance] = useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'0'</span>);
  <span class="hljs-keyword">const</span> [counterNumber, setCounterNumber] = useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'0'</span>);
  <span class="hljs-keyword">const</span> [address, setAddress] = useState&lt;<span class="hljs-string">`0x<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span> | <span class="hljs-literal">undefined</span>&gt;();
  <span class="hljs-keyword">const</span> [isConnected, setIsConnected] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [chainId, setChainId] = useState&lt;<span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>&gt;();
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> currentChain = <span class="hljs-variable constant_">SUPPORTED_CHAINS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span> === chainId);

  <span class="hljs-comment">// 创建 walletClient（只在需要签名时创建）</span>
  <span class="hljs-keyword">const</span> getWalletClient = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId || !address) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">const</span> chain = <span class="hljs-variable constant_">SUPPORTED_CHAINS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">id</span> === chainId) ?? foundry;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createWalletClient</span>({
      <span class="hljs-attr">account</span>: address,
      chain,
      <span class="hljs-attr">transport</span>: <span class="hljs-title function_">custom</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>),
    }).<span class="hljs-title function_">extend</span>(publicActions);
  }, [address, chainId]);

  <span class="hljs-comment">// 获取 Counter 合约的数值</span>
  <span class="hljs-keyword">const</span> fetchCounterNumber = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">if</span> (!chainId) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> client = <span class="hljs-title function_">getPublicClient</span>(chainId);
      <span class="hljs-keyword">const</span> contract = <span class="hljs-title function_">getContract</span>({
        <span class="hljs-attr">address</span>: <span class="hljs-title function_">getCounterAddress</span>(chainId),
        <span class="hljs-attr">abi</span>: <span class="hljs-title class_">Counter</span>_ABI,
        client,
      });
      <span class="hljs-keyword">const</span> num = (<span class="hljs-keyword">await</span> contract.<span class="hljs-property">read</span>.<span class="hljs-title function_">number</span>()) <span class="hljs-keyword">as</span> <span class="hljs-built_in">bigint</span>;
      <span class="hljs-title function_">setCounterNumber</span>(num.<span class="hljs-title function_">toString</span>());
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取 Counter 失败'</span>, err);
    }
  }, [chainId]);

  <span class="hljs-comment">// 读取余额</span>
  <span class="hljs-keyword">const</span> fetchBalance = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">if</span> (!address || !chainId) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> client = <span class="hljs-title function_">getPublicClient</span>(chainId);
      <span class="hljs-keyword">const</span> bal = <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">getBalance</span>({ address });
      <span class="hljs-title function_">setBalance</span>(<span class="hljs-title function_">formatEther</span>(bal));
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'读取余额失败'</span>, err);
    }
  }, [address, chainId]);

  <span class="hljs-comment">// 连接钱包</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">connectWallet</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> === <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请安装 MetaMask'</span>);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">const</span> [address] = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_requestAccounts'</span> });
      <span class="hljs-keyword">const</span> chainId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">'eth_chainId'</span> });
      <span class="hljs-title function_">setAddress</span>(address <span class="hljs-keyword">as</span> <span class="hljs-string">`0x<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>);
      <span class="hljs-title function_">setChainId</span>(<span class="hljs-title class_">Number</span>(chainId));
      <span class="hljs-title function_">setIsConnected</span>(<span class="hljs-literal">true</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'连接钱包失败:'</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-comment">// 断开连接</span>
  <span class="hljs-keyword">const</span> disconnectWallet = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">if</span> (!address || !<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId) <span class="hljs-keyword">return</span>;
    <span class="hljs-title function_">setIsConnected</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">setAddress</span>(<span class="hljs-literal">undefined</span>);
    <span class="hljs-title function_">setChainId</span>(<span class="hljs-literal">undefined</span>);
    <span class="hljs-title function_">setBalance</span>(<span class="hljs-string">'0'</span>);
    <span class="hljs-title function_">setCounterNumber</span>(<span class="hljs-string">'0'</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 对于 MetaMask 10.28+</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">request</span>({
        <span class="hljs-attr">method</span>: <span class="hljs-string">'wallet_revokePermissions'</span>,
        <span class="hljs-attr">params</span>: [{ <span class="hljs-attr">eth_accounts</span>: {} }],
      });
      <span class="hljs-comment">// 老版本 MM 会抛 4200 错误，捕获即可</span>
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">e</span>: <span class="hljs-built_in">unknown</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> e === <span class="hljs-string">'object'</span> &amp;&amp; e !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-string">'code'</span> <span class="hljs-keyword">in</span> e &amp;&amp; (e <span class="hljs-keyword">as</span> { <span class="hljs-attr">code</span>: <span class="hljs-built_in">unknown</span> }).<span class="hljs-property">code</span> === <span class="hljs-number">4200</span>) {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请手动在钱包里断开本次连接'</span>);
      }
    }
  }, [address, chainId]);

  <span class="hljs-comment">// 调用 increment 函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleIncrement</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (!address || !<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span> || !chainId) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> walletClient = <span class="hljs-title function_">getWalletClient</span>();
    <span class="hljs-keyword">if</span> (!walletClient) <span class="hljs-keyword">return</span> <span class="hljs-title function_">alert</span>(<span class="hljs-string">'钱包未连接'</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> walletClient.<span class="hljs-title function_">writeContract</span>({
        <span class="hljs-attr">address</span>: <span class="hljs-title function_">getCounterAddress</span>(chainId),
        <span class="hljs-attr">abi</span>: <span class="hljs-title class_">Counter</span>_ABI,
        <span class="hljs-attr">functionName</span>: <span class="hljs-string">'increment'</span>,
        <span class="hljs-attr">account</span>: address,
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Transaction hash:'</span>, hash);

      <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> walletClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: hash });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`交易状态: <span class="hljs-subst">${receipt.status === <span class="hljs-string">'success'</span> ? <span class="hljs-string">'成功'</span> : <span class="hljs-string">'失败'</span>}</span>`</span>);

      <span class="hljs-comment">// 更新数值显示</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchCounterNumber</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'调用 increment 失败:'</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-comment">// 全局监听（只添加一次）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAccountsChanged</span> = (<span class="hljs-params">accounts: <span class="hljs-built_in">string</span>[]</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'账户变化'</span>, accounts);
      <span class="hljs-keyword">if</span> (accounts.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">disconnectWallet</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setAddress</span>(accounts[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-string">`0x<span class="hljs-subst">${<span class="hljs-built_in">string</span>}</span>`</span>);
      }
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChainChanged</span> = (<span class="hljs-params">chainIdHex: <span class="hljs-built_in">string</span></span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'网络变化'</span>, chainIdHex);
      <span class="hljs-title function_">setChainId</span>(<span class="hljs-title class_">Number</span>(chainIdHex));
    };

    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'accountsChanged'</span>, handleAccountsChanged);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'chainChanged'</span>, handleChainChanged);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>?.<span class="hljs-title function_">removeListener</span>(<span class="hljs-string">'accountsChanged'</span>, handleAccountsChanged);
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">ethereum</span>?.<span class="hljs-title function_">removeListener</span>(<span class="hljs-string">'chainChanged'</span>, handleChainChanged);
    };
  }, [address, disconnectWallet, fetchBalance, fetchCounterNumber]);

  <span class="hljs-comment">// 连接后自动读取数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (address &amp;&amp; chainId) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接后自动读取数据:'</span>, address);
      <span class="hljs-title function_">fetchBalance</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
      <span class="hljs-title function_">fetchCounterNumber</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
    }
  }, [address, chainId, fetchBalance, fetchCounterNumber]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'min-h-screen flex flex-col items-center justify-center p-8'</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-3xl font-bold mb-8'</span>&gt;</span>Simple Viem Demo<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl'</span>&gt;</span>
        {!isConnected ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{connectWallet}</span>
            <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">'w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors'</span>
          &gt;</span>
            {isLoading ? '连接中...' : '连接 MetaMask'}
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'space-y-4'</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-center'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-600'</span>&gt;</span>钱包地址:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'font-mono break-all'</span>&gt;</span>{address}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-center'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-600'</span>&gt;</span>当前网络:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'font-mono'</span>&gt;</span>
                {currentChain?.name || '未知网络'} (Chain ID: {chainId})
              <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-center'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-600'</span>&gt;</span>余额:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'font-mono'</span>&gt;</span>{balance} ETH<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-center'</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'text-gray-600'</span>&gt;</span>Counter 数值:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'font-mono'</span>&gt;</span>{counterNumber}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleIncrement}</span>
                <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">'mt-2 w-full bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors'</span>
              &gt;</span>
                {isLoading ? '交易进行中...' : '增加计数'}
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{disconnectWallet}</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">'w-full bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition-colors'</span>
            &gt;</span>
              断开连接
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-28">总结</h2>
<p>本文详细分析了一个纯 Viem 脚手架项目，展示了如何使用 Viem 库直接与 MetaMask 钱包和智能合约进行交互，包括：</p>
<ol>
<li>项目创建步骤和核心依赖</li>
<li>如何使用 Viem 实现多链支持</li>
<li>如何连接和断开 MetaMask 钱包</li>
<li>如何获取钱包信息和余额</li>
<li>如何读写智能合约</li>
<li>如何监听钱包状态变化</li>
<li>纯 Viem 实现相对于 wagmi 等库的优势</li>
</ol>
<p>纯 Viem 方案为开发者提供了更底层的控制和更灵活的实现方式，适合需要深入了解区块链交互逻辑的开发者使用。这种架构不仅保持了代码的简洁性，还提供了更大的扩展空间。</p>
<h2 data-id="heading-29">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fviem.sh%2F" target="_blank" title="https://viem.sh/" ref="nofollow noopener noreferrer">Viem 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feips.ethereum.org%2FEIPS%2Feip-1193" target="_blank" title="https://eips.ethereum.org/EIPS/eip-1193" ref="nofollow noopener noreferrer">MetaMask EIP-1193 标准</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.getfoundry.sh%2F" target="_blank" title="https://book.getfoundry.sh/" ref="nofollow noopener noreferrer">Foundry 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp" target="_blank" title="https://nextjs.org/docs/app" ref="nofollow noopener noreferrer">Next.js App Router</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAI Physical AI Notebook 详解（5）：基于 Isaac-Cortex 的软件在环验证]]></title>    <link>https://juejin.cn/post/7579088065696677928</link>    <guid>https://juejin.cn/post/7579088065696677928</guid>    <pubDate>2025-12-02T10:15:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579088065696677928" data-draft-id="7578877638989004800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAI Physical AI Notebook 详解（5）：基于 Isaac-Cortex 的软件在环验证"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-02T10:15:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAI Physical AI Notebook 详解（5）：基于 Isaac-Cortex 的软件在环验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:15:51.000Z" title="Tue Dec 02 2025 10:15:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>终于到了本系列的最后一期。在前4期详解系列中，我们体验了：</p>
<ul>
<li>
<p><a href="juejin.cn/post/7568498994802065408" target="_blank" title="juejin.cn/post/7568498994802065408">基于Isaac仿真的操作动作数据扩增与模仿学习</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7571285984088686644" target="_blank" title="https://juejin.cn/post/7571285984088686644">基于Cosmos世界模型的操作动作数据扩增与模仿学习</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7574045294611808291" target="_blank" title="https://juejin.cn/post/7574045294611808291">基于仿真的导航模型训练</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7576338796846989352" target="_blank" title="https://juejin.cn/post/7576338796846989352">基于仿真的GR00T-N1.5模型微调</a></p>
</li>
</ul>
<p><strong>从技术选择角度，覆盖了从Isaac仿真到Cosmos世界模型的多种思路；</strong></p>
<p><strong>从使用流程角度，覆盖了从人工演示到模仿学习的多个环节；</strong></p>
<p><strong>从基础模型角度，覆盖了从动作模型、导航模型到VLA模型的多种类型；</strong></p>
<p><strong>从PAI的使用深度，经历了从DSW探索体验，到DLC、EAS大规模使用的过程。</strong></p>
<p>在这些最佳实践中，不可避免的会用到可视化操作环境，通过在PAI-DSW里启动VNC进程，或者Livestream服务，可以很好的解决这个问题。</p>
<p>但是，手动启动VNC进程仍是比较繁琐的操作。在本期，我们隆重介绍<strong>DSW全新的noVNC功能</strong>，并结合<strong>Isaac Sim的协作机器人系统Cortex</strong>，搭建软件在环验证系统（Software-In-Loop System）。</p>
<p>在PAI的Notebook Gallery中，我们已经预置了一个最佳实践，就是这个过程的一个具体示例：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.pai-ml.com%2F%23%2Fpreview%2FdeepLearning%2Fcv%2Fisaac_sim_wf5" target="_blank" title="https://gallery.pai-ml.com/#/preview/deepLearning/cv/isaac_sim_wf5" ref="nofollow noopener noreferrer">gallery.pai-ml.com/#/preview/d…</a></p>
<p><img src="https://static001.geekbang.org/infoq/69/69f53e39f006ac4d735cbfd0972de503.png" alt="" loading="lazy"/></p>
<p>下面我们来详细解读这个示例。</p>
<h2 data-id="heading-0">环境准备</h2>
<h3 data-id="heading-1">实例创建</h3>
<p>由于SIL系统天然需要可视化体验，我们还是使用DSW作为搭建环境。</p>
<p>在DSW中，使用以下配置创建实例：</p>
<ul>
<li>
<p>镜像：dsw-registry-vpc.cn-beijing.cr.aliyuncs.com/pai-training-algorithm/isaac-sim:isaacsim500-nb5-v2-20250902</p>
</li>
<li>
<p>机型规格：ecs.ebmgn9t.48xlarge</p>
</li>
</ul>
<p>本最佳实践中，无需特殊的自定义数据集和公共数据集配置。</p>
<h3 data-id="heading-2">资源下载</h3>
<p>在DSW中，使用如下脚本下载所需的数据、代码和模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

local_dir = Path(<span class="hljs-string">"/mnt/data/notebook5/"</span>)  <span class="hljs-comment"># 缓存目录</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载数据和代码到: <span class="hljs-subst">{local_dir}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始下载数据和代码..."</span>)
package = <span class="hljs-string">"bin_picking_demo.tar"</span>
download_from_oss(<span class="hljs-string">'aigc-data/isaac/nb5/'</span>, package, <span class="hljs-built_in">str</span>(local_dir))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"下载完成"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始解压数据和代码..."</span>)
zip_file = os.path.join(local_dir, package)
<span class="hljs-built_in">print</span>(zip_file)
<span class="hljs-built_in">breakpoint</span>()
!tar -xvf {zip_file} -C {local_dir}
!rm {zip_file}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"解压完成"</span>)


<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

local_dir = Path(<span class="hljs-string">"/root/FoundationPose"</span>)  <span class="hljs-comment"># 缓存目录</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载预训练模型参数到: <span class="hljs-subst">{local_dir}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始下载预训练模型参数..."</span>)
package = <span class="hljs-string">"weights.tar"</span>
download_from_oss(<span class="hljs-string">'aigc-data/isaac/nb5/'</span>, package, <span class="hljs-built_in">str</span>(local_dir))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"下载完成"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始解压预训练模型参数..."</span>)
zip_file = os.path.join(local_dir, package)
<span class="hljs-built_in">print</span>(zip_file)
!tar -xvf {zip_file} -C {local_dir}
!rm {zip_file}
<span class="hljs-built_in">print</span>(<span class="hljs-string">"解压完成"</span>)
</code></pre>
<h3 data-id="heading-3">VNC启动</h3>
<p>使用以下脚本，安装noVNC服务端，并启动VNC进程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#安装python env</span>
apt update
apt install python3-venv

<span class="hljs-comment">#启动vncserver</span>
/opt/TurboVNC/bin/vncserver :1 -geometry 3840x2160

<span class="hljs-comment">#安装novnc</span>
/etc/dsw/runtime/bin/pai-dsw runtime plugin install novnc

<span class="hljs-comment">#启动novnc</span>
/etc/dsw/runtime/bin/pai-dsw runtime plugin start-daemon novnc
</code></pre>
<p>在DSW的Terminal中输入：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//localhost:9803</span>
</code></pre>
<p>跳转至DSW的gateway地址，在链接末尾添加vnc.html</p>
<p><img src="https://static001.geekbang.org/infoq/fd/fd07e67e37106310716d1652c480d8f3.png" alt="" loading="lazy"/></p>
<p>从而打开noVNC界面：</p>
<p><img src="https://static001.geekbang.org/infoq/8c/8ccce412501b44af4ca3fab0c68dbe8c.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">运行验证</h2>
<p>在noVNC界面中，运行以下指令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /root/bin_picking_demo
/isaac-sim/python.sh sim_main.py --component <span class="hljs-string">"mustard_bottle"</span>
<span class="hljs-comment">## 可以尝试更改--component "cracker_box"</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FwW7WWI0PLBFeDLdm7r5mqjeB36VQfdRjOfoN8x48YNw.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/wW7WWI0PLBFeDLdm7r5mqjeB36VQfdRjOfoN8x48YNw.mp4" ref="nofollow noopener noreferrer">视频演示&gt;&gt;</a></p>
<p>可以看到，在Isaac Lab窗口中，机械臂按照FoundationPose模型的输出，执行了物料识别、抓取和转移的动作；在Terminal窗口中，FastSAM模型完成了物料位置的识别，并通过FoundationPose模型完成了机械臂动作的输出。</p>
<h2 data-id="heading-5">原理解析</h2>
<h3 data-id="heading-6">系统主入口</h3>
<p>此SIL系统的入口位于/mnt/workspace/notebook5/bin_picking_demo/sim_main.py路径下：</p>
<pre><code class="hljs language-ini" lang="ini">if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># ------- parse configuration ------- #</span>
    <span class="hljs-attr">opt</span> = tyro.cli(SimulationConfig)
    
    <span class="hljs-comment"># Setup all configuration parameters</span>
    opt, camera_pameters, weights_path, <span class="hljs-attr">standard_mask_path</span> = setup_configuration(opt)

    <span class="hljs-comment"># ------- create a separate process for FoundationPose Infer ------- #</span>
    <span class="hljs-attr">ctx</span> = mp.get_context(<span class="hljs-string">'spawn'</span>)
    
    <span class="hljs-attr">data_queue</span> = ctx.Queue() <span class="hljs-comment">## image/depth from SIM</span>
    <span class="hljs-attr">hand_data_queue</span> = ctx.Queue() <span class="hljs-comment">## image/depth from hand camera from SIM</span>
    <span class="hljs-attr">detect_queue</span> = ctx.Queue() <span class="hljs-comment">## detections from FoundationPose</span>
    <span class="hljs-attr">hand_detect_queue</span> = ctx.Queue() <span class="hljs-comment">## detections from FoundationPose</span>

    <span class="hljs-attr">debug</span> = <span class="hljs-literal">True</span>
    <span class="hljs-attr">process</span> = ctx.Process(target=inference, args=(data_queue, detect_queue, hand_data_queue, hand_detect_queue, camera_pameters, opt.mesh_file, standard_mask_path, weights_path, debug))
    <span class="hljs-comment"># Start the subprocess of FoundationPose Inference</span>
    process.start()
    <span class="hljs-comment"># Start main process of ISAAC Sim</span>
    main(opt, data_queue, detect_queue, hand_data_queue, hand_detect_queue)
   
          
    process.terminate()
    process.join()
    print('<span class="hljs-comment">## Sub process is terminated.')</span>
</code></pre>
<p>这段代码中：</p>
<ol>
<li>
<p>使用multiprocessing创建感知子进程；仿真在主进程</p>
</li>
<li>
<p>创建数据队列，进行仿真主进程和感知子进程之间的数据交换；仿真主进程从感知子进程中读取检测结果，感知子进程从仿真主进程中获取传感器数据</p>
</li>
</ol>
<h3 data-id="heading-7">感知子进程</h3>
<p>感知子进程位于 /mnt/workspace/notebook5/bin_picking_demo/foundationpose/multiprocess_foundationpose_infer_sim.py</p>
<pre><code class="hljs language-ini" lang="ini">def inference(data_queue, detect_queue, hand_data_queue, hand_detect_queue, camera_pameters, mesh_file, standard_mask_path, weights_path, debug):
    <span class="hljs-attr">pose_estimator</span> = FoundationPoseInfer(camera_pameters, mesh_file, standard_mask_path, weights_path, debug)
    <span class="hljs-attr">pose_tuner</span> = ICPByHandCamera(camera_pameters, mesh_file, weights_path)

    print(f"*** inference *** Initialized !! ") 
    <span class="hljs-attr">last_data_time</span> = time.time()
    <span class="hljs-attr">timeout_duration</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># auto exit time: seconds</span>

    while True:
        if not data_queue.empty():
            rgb_array, depth_array, failed_last, <span class="hljs-attr">reset</span> = data_queue.get()
            if reset:
                <span class="hljs-attr">pose_estimator</span> = FoundationPoseInfer(camera_pameters, mesh_file, standard_mask_path, weights_path, debug)
                print("reset: re-init foundation pose")
                continue
            pose_in_cam, <span class="hljs-attr">mask</span> = pose_estimator.detect(rgb_array, depth_array, failed_last)
            detect_queue.put(<span class="hljs-section">[pose_in_cam, mask, pose_estimator.extent_bbox]</span>)
            print(f"*** inference *** Detect target and add to detect_queue !! ") 
            <span class="hljs-attr">last_data_time</span> = time.time()

        if not hand_data_queue.empty():
            rgb_array_hand, depth_array_hand, \
                pose_in_world, orient_in_world, pose_matrix_in_world, \
                    <span class="hljs-attr">pose_matrix_in_hand_cam</span> = hand_data_queue.get()
            print(f"<span class="hljs-section">[perception]</span> <span class="hljs-section">[inference]</span> hand camera received, processing")

            <span class="hljs-comment"># get world position from head camera </span>
            pose_in_cam, <span class="hljs-attr">mask</span> = pose_tuner.run(rgb_array_hand, depth_array_hand, pose_matrix_in_hand_cam)

            <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> update boxes, use flag: head_camera or hand_camera; update or new</span>
            print(f"<span class="hljs-section">[perception]</span> <span class="hljs-section">[inference]</span> hand camera processed, sending")
            hand_detect_queue.put(<span class="hljs-section">[pose_in_cam, mask, pose_estimator.extent_bbox]</span>)
            <span class="hljs-attr">last_data_time</span> = time.time()
        else:
            if time.time() - last_data_time &gt; timeout_duration:
                print(f"*** inference *** No data received for {timeout_duration} seconds. Exiting... ")
                break
            <span class="hljs-comment"># print(f"*** inference *** No RGBD data received !! ") </span>
        time.sleep(0.01)  <span class="hljs-comment"># avoid high frequency empty polling, reduce CPU consumption</span>
</code></pre>
<p>在这段代码中：</p>
<ol>
<li>
<p>使用FastSAM进行目标检测</p>
</li>
<li>
<p>使用FoundationPose进行姿态估计</p>
</li>
<li>
<p>使用ICP进行pose精调</p>
</li>
</ol>
<h3 data-id="heading-8">仿真模块</h3>
<p>仿真模块与主入口一起，位于/mnt/workspace/notebook5/bin_picking_demo/sim_main.py路径下：</p>
<pre><code class="hljs language-ini" lang="ini">def main(opt, data_queue, detect_queue, hand_data_queue, hand_detect_queue):
    ......
    <span class="hljs-attr">world</span> = CortexWorld()
    ......
    <span class="hljs-attr">robot</span> = world.add_robot(CortexUr10LongSuction(name=<span class="hljs-string">"robot"</span>, prim_path=<span class="hljs-string">"{}/ur10_long_suction"</span>.format(env_path), robot_type=opt.robot_type))
    ......
    <span class="hljs-attr">camera_prim1</span> = world.stage.DefinePrim(<span class="hljs-string">"/World/Camera1"</span>, <span class="hljs-string">"Camera"</span>)
    ......
    world.add_task(BinPickingStackedTask(opt, mechanical_part_usd, usd_scale, opt.num_object, rp_head))
    
    <span class="hljs-comment"># Reset the world and task to add objects, surface gripper joints, and obstacles, etc.</span>
    world.reset()
    world.add_decider_network(behavior.make_decider_network(data_queue, detect_queue, hand_data_queue, hand_detect_queue, robot, target_pose, opt, rp_head, rp_hand, camera_prim1, camera_prim_hand))

    world.run(simulation_app,<span class="hljs-attr">render</span>=<span class="hljs-literal">True</span>, loop_fast=<span class="hljs-literal">False</span>, play_on_entry=<span class="hljs-literal">True</span>)
    print('<span class="hljs-comment">## Simulation_app is closed. ##')</span>
</code></pre>
<p>在这段代码中：</p>
<ol>
<li>
<p>使用Isaac Cortex创建仿真环境；并配置camera、robot、task等基础资源</p>
</li>
<li>
<p>添加decider_network</p>
</li>
<li>
<p>仿真启动，消费感知子进程数据，更新仿真环境和机械臂姿态，并产生新的传感器数据</p>
</li>
</ol>
<h2 data-id="heading-9">总结</h2>
<p>通过PAI-DSW和noVNC可视化环境，利用Isaac Sim提供的一系列工具链可以快速搭建复杂的机器人感知和交互系统，实现高效的机器人算法原型开发和验证，并以zero-shot的方式迁移到真机中进行部署验证，提升物理AI系统和算法的研发效率和研发质量。</p>
<p>从本期开始，PAI Physical AI Notebook系列将告一段落，希望大家已经体验到了在PAi平台中进行Physical AI的便捷与高效。阿里云PAI平台是全功能的Physical AI开发平台，可以覆盖仿真数据合成、模仿学习、强化学习、软件在环验证等各个环节。</p>
<p>欢迎访问：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.pai-ml.com" target="_blank" title="https://gallery.pai-ml.com" ref="nofollow noopener noreferrer">gallery.pai-ml.com</a></p>
<p>并搜索“NVIDIA Physical AI”，获取更多关于PAI Physical AI的最佳实践。</p>
<p><img src="https://static001.geekbang.org/infoq/36/36c96fe1599d377191a48b66abc401ba.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东云JoyAgent持续开源！多模态RAG能力正式开源]]></title>    <link>https://juejin.cn/post/7578442185848684582</link>    <guid>https://juejin.cn/post/7578442185848684582</guid>    <pubDate>2025-12-01T08:44:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578442185848684582" data-draft-id="7578460753210474523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东云JoyAgent持续开源！多模态RAG能力正式开源"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-01T08:44:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东云JoyAgent持续开源！多模态RAG能力正式开源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T08:44:58.000Z" title="Mon Dec 01 2025 08:44:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JoyAgent 是京东自主研发的智能体引擎平台。今年7月，其多智能体引擎模块JoyAgent （JDGenie）正式开源；9月，在 JDGenie 基础上进一步开源 DataAgent 能力，此次，京东再次发布重要更新-在JoyAgent-JDGenie中开源多模态RAG能力。持续推进智能体技术在开源社区的共建与共享。</p>
<p>目前该项目在GitHub上已获得11.2kStar，欢迎开发者体验并参与共享。</p>
<p>•开源体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjd-opensource%2Fjoyagent-jdgenie" target="_blank" title="https://github.com/jd-opensource/joyagent-jdgenie" ref="nofollow noopener noreferrer">github.com/jd-opensour…</a></p>
<p>•多模态知识管理md地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjd-opensource%2Fjoyagent-jdgenie%2Fblob%2Fdata_agent%2FREADME_mrag.md" target="_blank" title="https://github.com/jd-opensource/joyagent-jdgenie/blob/data_agent/README_mrag.md" ref="nofollow noopener noreferrer">github.com/jd-opensour…</a>﻿</p>
<h2 data-id="heading-0"><strong>多模态知识管理</strong>简介</h2>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcf90add43e846b083a9891ce0e6a994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765183497&amp;x-signature=N7SH20o4Yha01pKOk%2BPYMxRB0i4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>传统RAG基础架构</p>
<p>传统的检索增强生成（RAG）技术，在处理文本知识方面取得了显著的成功，它通过外部知识库有效缓解了大型语言模型的“幻觉”问题。但其局限性也日益凸显</p>
<h3 data-id="heading-1"><strong>一、多模态问题：处理结构化与非结构化内容</strong></h3>
<p>当面对企业内普遍存在的文档时，一个仅能理解文字的RAG系统，无法阅读和理解图片、表格中蕴含的丰富信息。这导致了检索的片面性与答案的不完整性，大量高价值的知识资产因此沉睡，无法被有效利用。</p>
<p>一方面图像中的数据（如截图或扫描件）也无法被文本RAG系统直接理解。另一方面PDF文档尤其是包含嵌入式表格、图表和复杂布局的文档，需要复杂的解析逻辑，因为其格式和布局往往不一致 。传统的文本提取方法在此处会丢失关键信息，例如表格中数字的列关系或图表中数据的视觉趋势。大型语言模型（LLM）主要通过海量的顺序文本进行训练，因此它们在处理多维、关系化的表格数据时会遇到困难 。如果将表格简单地转换为纯文本进行嵌入，就会破坏其固有的结构化关系，导致检索结果的准确性大打折扣 。</p>
<h3 data-id="heading-2"><strong>二、数据质量与动态性：RAG性能的杀手</strong></h3>
<p>企业知识库面临的另一个严峻挑战是数据质量的参差不齐和内容的频繁更新。如果知识库中存在不一致的格式、过时的信息、重复的条目或相互冲突的事实，往往无法给出准确的回答 。</p>
<p>同时，知识库并非静态不变。在实际的企业环境中，文档更新频繁。管理这些变更是本身就是一项复杂的任务，因为每一次更新或删除都可能需要同步其在索引中的所有相关数据块和向量。此外，公司的一些核心信息往往驻留于实时、动态的运营系统（如CRM、ERP）中 。这些数据都是传统RAG所无法处理的。</p>
<h2 data-id="heading-3"><strong>JoyAgent企业内多模态知识管理系统架构</strong></h2>
<h3 data-id="heading-4">一、知识加工层</h3>
<h4 data-id="heading-5">时序知识图谱</h4>
<p>我们引入graphiti， 一个构建和查询<strong>时间感知知识图谱</strong>的框架，建设时序知识图谱。Graphiti 基于事件更新的时序知识图谱构建，增量更新、双时间建模（跟踪事件发生时间和摄入时间），并在无需完整重新计算的情况下处理随时间演变的关系统计。利用它可以可以整合并维护动态的用户交互和业务数据，支持智能体基于状态的推理和任务自动化。</p>
<p>•处理异构、演变的数据源以支持决策和自动化</p>
<p>•时间特征在需要历史分析的场景中特别有价值，如金融服务的审计合规或供应链管理的趋势预测。</p>






























<table><thead><tr><th>特性</th><th>传统知识图谱</th><th>时序知识图谱</th></tr></thead><tbody><tr><td><strong>数据更新</strong></td><td><strong>静态批量处理</strong> 数据变更需<strong>重新计构建整个图谱</strong>，效率低。</td><td><strong>实时增量更新</strong> 新数据可<strong>即时融入</strong>，无需全图重建，响应更快。</td></tr><tr><td><strong>时间处理</strong></td><td><strong>时间感知较弱</strong> 只记录当前状态，<strong>缺乏历史追溯和时效性管理</strong>。</td><td><strong>双时态数据模型</strong> 同时记录<strong>事件发生时间</strong>和<strong>系统录入时间</strong>，支持历史状态回溯。</td></tr><tr><td><strong>关系推理</strong></td><td><strong>侧重于静态关联</strong> 善于表示实体间关系，但对<strong>动态变化和因果关系</strong>的捕捉较弱。</td><td><strong>动态关系与演化推理</strong> 能追踪关系随时间的<strong>变化轨迹</strong>（如兴趣衰减、状态转移），支持因果分析。</td></tr><tr><td><strong>矛盾处理</strong></td><td><strong>覆盖或人工判断</strong> 新信息常<strong>直接覆盖旧信息</strong>，或需要复杂逻辑及人工干预来处理冲突。</td><td><strong>时态边失效机制</strong> 新信息使旧关系<strong>自动失效</strong>但仍保留历史记录，<strong>逻辑清晰</strong>且<strong>可追溯</strong>。</td></tr></tbody></table>
<h4 data-id="heading-6"><strong>多文档格式多数据源支持</strong></h4>
<p>为了支持企业内丰富的文档格式，我们支持文档（Excel、Word、PDF、PPT，图片等），同时需要对视频做专门的ASR以及关键帧切片处理。</p>
<p>此外，为了提升异构数据的处理效果，我们定义了统一的文档结构，针对不同类型的文件定义不同的解析算法，输出统一的文档结构，方便后续的用户人工干预和索引构建流程。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa64efe9d4b94720a5f470070cc38850~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765183497&amp;x-signature=a883jVu%2B6W%2F2V2VyCao4Fce6K9I%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>企业中大量的支持存储在系统里（例如ERP，CRM等），因此除了支持普通的文件输入，我们还需要支持API形式的数据录入。我们专门优化了针对API的数据调用流程和系统描述。这样上层Agent能动态发现是否需要调用某个API获取对应的数据。</p>
<h3 data-id="heading-7"><strong>知识使用层-多模态RAG</strong></h3>
<h4 data-id="heading-8"><strong>多结构索引</strong></h4>
<p>为了尽可能的召回需要的知识片段，以及建立知识之间的相互关系。我们建立了基于图谱的GraphRAG, 基于tag的关键词索引以及传统的Emebedding索引。</p>
<p>分块策略直接决定上下文的完整性和连贯性，从而影响生成输出的质量。普通分块可能破坏语义完整性，降低相关性。在长篇文档中往往标题，副标题是对一大片文档的整体总结，如果只看分块可能会造成信息丢失。因此，我们优化了分块策略，引入层级分块策略。</p>
<p><strong>Hierarchical Chunk Index（层级分块索引）</strong></p>
<p>层级分块能够将文档内容按照语义关系和结构层级进行分块管理，使得系统在检索时能够更细致地定位相关信息，并有效支持长文档和复杂结构的内容解析与检索。</p>
<p>﻿</p>
<p><strong>知识图谱召回</strong></p>
<p>GraphRAG 通过构建节点（实体）和边（关系）的图结构，捕捉这些内在连接，实现多跳推理——例如，从“产品销售数据”跳到“客户反馈”再到“供应链调整”。这种方法在复杂推理任务中可将准确率提升高达35%。为了适应企业数据的动态性以及时序性，我们引入了时序知识图谱，每条边记录事件有效期和系统录入时间，允许企业查询历史状态，这就使得AI Agent能维护连续上下文，跟踪用户偏好。</p>
<h4 data-id="heading-9"><strong>Agentic 搜索</strong></h4>
<p>传统的RAG系统本质上是一种“被动”的、单轮次的“检索后阅读”模式。它擅长于处理简单的信息检索，但面对复杂、多步骤的查询时，其能力边界便显现出来。Agentic RAG 能根据检索结果进行主动规划、推理和执行，将LLM从一个被动的响应者转变为一个能够主动思考、调查并解决问题的智能体。</p>
<p>为了平衡时间和效率问题，目前我们开放了配置选项，用户可以自主选择是否需要开启Agentic的能力，如果关闭，则回归传统模式，走一次检索总结流程。</p>
<h4 data-id="heading-10"><strong>多模态检索</strong></h4>
<p>由于大量的知识在图片，pdf或者表格中，在没有看到query前直接用ocr，或者摘要会造成信息丢失。因此在我们实现多模态检索时，我们增加了VLM进行回答的过程。我们将query与召回的图片进行交给VLM进行处理。再将VLM输出的答案与文本召回的Chunk一起交给后续的LLM进行处理。</p>
<p>目前我们提供了两种多模态能力。我们提供了两个多模态工具，供上层Agent自主决策调用哪个多模态能力。</p>
<p>•图片问答，用户输入图片，直接对图片内容进行问答、摘要、翻译等操作。</p>
<p>•图片检索，用户输入图片或者文字，利用向量检索召回相似图片。</p>
<p>我们还有一个文本搜索工具。这样让Agent自主决策调用哪个工具，甚至是多步的工具组合，我们可以让多模态检索Agent处理企业内各种复杂场景。举个例子，供应链管理人员收到仓库上传的异常货物照片，需要判断异常类型、查找历史处理案例，并获取应急处理流程。</p>
<h4 data-id="heading-11"><strong>评测数据</strong></h4>
<p>在公开数据集DoubleBench上，我们对比测评了MDocAgent、Colqwen-gen、ViDoRAG、M3DOCRAG等多模态问答系统。最终答案的准确性采用LLM作为评判标准进行评估。 GPT-4o根据0到10的等级对生成的答案与真实答案的正确性进行评分。得分不低于7分的答案为正确，不高于3分的答案为错误，其余答案为部分正确。JoyAgent的正确率达到76.2%,优于当前其他多模态问答系统。</p>









































<table><thead><tr><th>系统</th><th>正确</th><th>部分正确</th><th>错误</th></tr></thead><tbody><tr><td><strong>JoyAgent</strong></td><td><strong>0.762</strong></td><td>0.105</td><td>0.133</td></tr><tr><td>MDocAgent</td><td>0.757</td><td>0.132</td><td>0.111</td></tr><tr><td>Colqwen-gen</td><td>0.676</td><td>0.160</td><td>0.164</td></tr><tr><td>ViDoRAG</td><td>0.623</td><td>0.144</td><td>0.233</td></tr><tr><td>M3DOCRAG</td><td>0.538</td><td>0.138</td><td>0.324</td></tr></tbody></table>
<p>•Colqwen-gen：参照组，结果由gpt-4o直接回复生成（不采用RAG）。</p>
<p>此外，我们还利用企业内部文档，包括培训资料，产品RPD，运营计划构建了测试集，在150个query，500篇文档的测试集中横向对比了coze，ima和JoyAgent。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f21e1fd88d3c4689a12e4152d2f989d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765183497&amp;x-signature=F0IYe906%2FJs%2FIRY0Fvfz7QrRukc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-12"><strong>未来计划</strong></h2>
<p>RAG的未来发展将是多范式融合的持续演进。可以预见，未来的系统将无缝地集成Agentic和GraphRAG的能力，智能体将能够动态地决定何时从知识图谱中检索关系信息，何时调用外部工具执行复杂任务。同时，多模态能力的持续进步将使RAG系统能够处理并理解更加多样化的数据类型，从而真正成为一个能够理解和利用企业所有知识资产的综合性智能系统。</p>
<p>当然知识加工和知识检索知识知识库管理的第一步，利用知识生成知识，才是诗和远方。我们将继续沿着多模态DeepSearch的方向继续迭代，加深知识和文档管理层面能力建设。真正为企业内员工知识加工，知识检索，知识生成提供帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新一代SageMaker+Databricks统一目录：机器学习与数据分析工作流打通方案]]></title>    <link>https://juejin.cn/post/7578314349514752051</link>    <guid>https://juejin.cn/post/7578314349514752051</guid>    <pubDate>2025-12-01T04:24:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578314349514752051" data-draft-id="7577284968922824704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新一代SageMaker+Databricks统一目录：机器学习与数据分析工作流打通方案"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-01T04:24:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亚马逊云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2850395271209496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新一代SageMaker+Databricks统一目录：机器学习与数据分析工作流打通方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2850395271209496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亚马逊云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T04:24:44.000Z" title="Mon Dec 01 2025 04:24:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    23
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs3.cn-north-1.amazonaws.com.cn%2Fawschinablog%2Fblogbanner-newnew.png" target="_blank" title="https://s3.cn-north-1.amazonaws.com.cn/awschinablog/blogbanner-newnew.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b38e9d4d2214d9ba055ba2a2cd412e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=Im9uDNh91XLU804efM7POo2vZaI%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-0">前言</h2>
<p>在数据驱动决策的时代，企业正面临着两大核心挑战：如何打破数据孤岛实现跨平台协作，以及如何在复杂技术栈中保持治理一致性。这些挑战直接影响着企业从数据中获取价值的能力和速度。</p>
<p>Databricks作为领先的数据分析和机器学习平台，已经帮助众多企业实现了大规模数据处理和分析。与此同时，许多企业在亚马逊云科技云上构建了完整的业务系统和机器学习工作流。如何让这两个强大的生态系统无缝协作，成为了释放数据价值的关键所在。</p>
<p>本文提出的解决方案：通过SageMaker Unified Studio与Databricks Unity Catalog的深度集成，企业既能充分利用Databricks强大的数据分析能力，又能与亚马逊云科技上现有的业务系统深度融合，真正实现数据价值的最大化。这不是简单的技术对接，而是一种全新的数据协作范式。</p>
<p>本文将以真实业务场景为锚点，深度解析两大平台的协同价值：</p>
<p>1.技术融合性 – 零摩擦的数据访问</p>
<p>通过SageMaker Unified Studio中的托管JupyterLab环境，借助EMR Serverless的强大计算能力，直接访问Databricks Unity Catalog中的受治理数据。这种架构彻底消除了传统ETL的冗余，让数据科学家能够实时访问最新的业务数据，显著提升模型开发效率。</p>
<p>2.治理穿透力 – 企业级安全合规保障</p>
<p>在新一代SageMaker工作流中无缝继承Databricks预设的数据血缘追踪、细粒度访问控制和完整审计策略。这意味着企业无需重复构建治理体系，即可确保跨平台的数据安全性和合规性，大幅降低治理成本和风险。</p>
<p>实战导向的技术指南</p>
<p>我们不仅会深入剖析架构设计的核心要点，更重要的是分享在实际项目落地中积累的宝贵经验和避坑指南：</p>
<p>关键技术挑战与解决方案：</p>
<ul>
<li>跨平台安全访问：如何在保证数据安全的前提下实现平台间的身份认证和授权</li>
<li>混合云网络配置：企业混合云环境下的网络连通性最佳实践</li>
<li>性能优化策略：大规模数据查询的性能调优技巧</li>
<li>生产级部署考量：从POC到生产环境的平滑过渡路径</li>
</ul>
<p>通过本文，您将获得一份经过实践验证的完整集成方案，帮助您的团队快速构建一个安全、高效、可扩展的跨平台数据科学工作流。</p>
<h2 data-id="heading-1">架构解析</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/926e2d8abd214a679bde2be08a5026d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=y%2B5OjAoEfb9zush54CeYTwXV9yI%3D" alt="666.png" loading="lazy"/></p>
<p>此架构旨在整合 Amazon SageMaker Notebook和Databricks Unity Catalog 的功能，以实现高效的数据处理、机器学习模型开发以及跨平台的数据共享和协作。</p>
<p><strong>亚马逊云科技 Side</strong></p>
<p>SageMaker Unified Studio: 作为亚马逊云科技的核心组件之一，Sagemaker Unified Studio为数据科学家和开发者提供了一个集成的开发环境，用于构建、训练和部署机器学习模型。它支持多种编程语言和框架，并且可以无缝地与亚马逊云科技其他服务进行集成。</p>
<p>EMR Studio Notebook: EMR Studio Notebook是Amazon EMR的一部分，它允许用户在云端运行交互式数据分析任务。通过EMR Studio Notebook，用户可以利用Apache Spark等大数据处理框架来处理大规模数据集。</p>
<p><strong>Databricks Side</strong></p>
<p>Open API: Databricks提供了丰富的API接口，使得外部系统能够与其进行通信和数据交换。这些API包括但不限于REST API，它们允许用户执行各种操作，如创建和管理集群、运行作业、查询数据等。</p>
<p>Unity Catalog: Databricks的 Unity Catalog是一个元数据管理解决方案，它帮助组织管理和治理其数据资产。通过 Unity Catalog，用户可以定义和应用细粒度的数据访问控制策略，确保数据的安全性和合规性。</p>
<p>Delta Lake: Delta Lake是Databricks推出的一个开源存储层，它提供了ACID事务、统一的数据治理和高性能的数据处理能力。Delta Lake可以存储结构化和半结构化的数据，并支持实时分析和批处理等多种工作负载。</p>
<h3 data-id="heading-2">Databricks 数据共享方式</h3>
<p>Databricks提供了多种数据共享的方式,下面是一个列表,我们可以根据自己的需求来进行选择.</p>





















































<table><thead><tr><th/><th>A</th><th>B</th><th>C</th><th>D</th><th>E</th></tr></thead><tbody><tr><td>1</td><td><strong>Option</strong></td><td><strong>Cost</strong></td><td><strong>Limitations</strong></td><td><strong>Simplicity</strong></td><td><strong>When to use?</strong></td></tr><tr><td>2</td><td>Delta Sharing</td><td>$</td><td>🔴</td><td>🟠</td><td>只读模式：适用于小数据且由工作区管理员进行设置</td></tr><tr><td>3</td><td>Databricks Connect</td><td>$$</td><td>🟢</td><td>🟢</td><td>任何需要使用 Databricks 计算能力的情况</td></tr><tr><td>4</td><td>Databricks SQL client</td><td>$$</td><td>🟢</td><td>🟢</td><td>类似于 Databricks Connect，但仅适用于 SQL 用户。</td></tr><tr><td>5</td><td>Unity Catalog Open APIs</td><td>$</td><td>🟠</td><td>🟢</td><td>目前适用于只读用例，具有简单的设置，并且可以使用您选择的引擎。</td></tr></tbody></table>
<p>本案例中我们使用 Unity Catalog Open APIs 来实现 Databricks 和 SageMaker Unified Studio的数据共享, 下面我们将逐步带大家完成所有的配置.</p>
<h3 data-id="heading-3">Databricks 侧配置</h3>
<ol>
<li>首先我们需要开启Databricks的Catalog External Access, 配置步骤如下.</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-2.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-2.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a352fb6c44c1474d9cb4d1cc1fa25990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=5pRE%2ByqEC0nkDQCKI8HnpXFJlKI%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-3.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-3.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb98de5f479d4dd3b5f62ed0e5690669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=GY7t9TrmymnVbmNd7hhTbUR0sns%3D" alt="" loading="lazy"/></a></p>
<p>Enable <strong>External data access</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-4.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-4.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c25b9592684c7a953f8bc8c963ee2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=M9Cw%2Btts56xUEtp4RzsFLwjeD1s%3D" alt="" loading="lazy"/></a></p>
<ol start="2">
<li>配置Databricks用户可以在外部访问Catalog的权限,使用以下示例语句.</li>
</ol>
<p><code>GRANT EXTERNAL USE SCHEMA ON SCHEMA &lt;catalog_name&gt;.&lt;schema_name&gt; TO `xxxxx@xx.com`</code></p>
<ol start="3">
<li>配置对用Databricks 用户Personal Access Token,点击用户<strong>Settings</strong> 选项</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-5.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-5.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/562c618a916b4a6d85d0450e59fa2866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=CvolW%2F%2BSDurJkVujZAQWeERLmUk%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-6.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-6.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/175cd8f6f6a14e46b5757e66eacb2f7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=nWyuRnQnp1Ib0FiD8Jl0kStydho%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-7.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-7.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afeb28305471463ca80bf72dfc44efdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=RZHJ9oIPR9kWg7Jt%2BD4LrE7zmbk%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-8.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-8.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31e792dc1aa46b9a06a6f6749833f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=yP03taaKETCKjls3mUfdabqKsrw%3D" alt="" loading="lazy"/></a></p>
<p>一定要记录下来生成好的access token,它只能被记录一次,至此我们在 Databricks上配置就可以了.</p>
<h2 data-id="heading-4">Sagemaker Unified Studio 配置</h2>
<p>在 Amazon SageMaker Unified Studio 中，域是用于连接您的资产、用户及其项目的组织实体。域代表组织内业务线 (LOB) 或业务领域的独特边界，这些业务领域可以管理自己的数据，包括自己的数据资产、自己的数据或业务术语定义，并可能有自己的治理标准。管理员创建域并与用户或组共享 URL。首次开始使用 Amazon SageMaker Unified Studio 时，首先要创建域以及域中存在的所有核心组件。</p>
<h3 data-id="heading-5">设置 Amazon SageMaker 统一工作室域</h3>
<ol>
<li>要开始创建域，请在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fus-west-2.console.aws.amazon.com%2Fdatazone%2Fhome%3Fregion%3Dus-west-2%23%2F" target="_blank" title="https://us-west-2.console.aws.amazon.com/datazone/home?region=us-west-2#/" ref="nofollow noopener noreferrer">Amazon SageMaker </a>控制台上点击 创建统一工作室域按钮。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-9.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-9.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1638d698d9374c3aadd1f43510f738f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=hNEzawaNMxVyDOQvSNUMQhXiZ2Q%3D" alt="" loading="lazy"/></a></p>
<ol start="2">
<li>选择快速设置功能，在 快速设置功能的设置页面上，修改域名。在虚拟私有云(<strong>VPC</strong>) 中请选择有私有子网存在的VPC，选择三个不同AZ的私有子网，私有子网必须配置 Nat Gateway，否则会影响后续功能使用。其他保持默认值。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-10.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-10.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969d8e5492914ae6b254068a7877ddfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=oWx%2B0ncR7Ws5Wxh6AaaRAgYY4R4%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-11.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-11.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55de39c2b74f484aa2f5e429f6bad6a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=fSz6JU0W2C5fbigc%2FCzpnOANN1E%3D" alt="" loading="lazy"/></a></p>
<ol start="3">
<li>Amazon SageMaker Unified Studio 域默认支持 IAM 用户身份验证。在此输入IAM Identity Center中用户电子邮箱地址。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-12.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-12.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc58965830c7400aa19f80e1fc55b980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=NuIr0M2Uw%2FCHl%2Bsx5fABpqrZVus%3D" alt="" loading="lazy"/></a></p>
<ol start="4">
<li>创建成功后通过url或者“打开统一工作室”按钮登陆Amazon SageMaker Unified Studio。点击后选择 SSO 方式登陆。输入在IAM 身份中心设置的用户名和密码。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-13.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-13.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1530e57b97544c879ccfb4bb6ac15204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=Gp7c2%2Fo9CwVt%2BAEbDgMjsiy8wEc%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-14.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-14.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff54ee38343f4151955c9111994e1ce3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=g9XCTaYulCCjMSZ1iNApFlB16m8%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-6">创建项目</h3>
<ol>
<li>登陆后点击创建项目，在 Amazon SageMaker Unified Studio 中，通过项目汇集人员、数据和工具，使数据用户群体能够协作解决特定的业务用例。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-15.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-15.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d40fdac8d1d9419fb6d407bc0b2ae6b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=bHV06%2FUFbwncuEb5S6kP3debIyc%3D" alt="" loading="lazy"/></a></p>
<ol start="2">
<li>修改项目名称，选择合适的项目配置文件。项目配置文件是用于创建项目的配置蓝图的集合。蓝图定义了项目成员在处理 Amazon SageMaker 目录中的数据时可以使用哪些亚马逊云科技工具和服务。这里选择的是所有功能，选择后点击继续。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-16.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-16.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f869a767005b44019341cb8d97be2c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=pEuB5tss%2BVsk6KQ62F04QWZD2jE%3D" alt="" loading="lazy"/></a></p>
<ol start="3">
<li>可以按需更改日志保留期等配置，由于在此场景下已经禁用了glue catalog，可以忽略lakehouse database中的glue database name更改，这里保持默认设置。点击继续。跳转到下一页后再选择 创建项目。创建成功后，您将被重定向到项目主页。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-17.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-17.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feb52e6d8be2440cb1c2c48e8c3fe10a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=HJAYN2xXwl5dmS7Z6WNvQzBpFtI%3D" alt="" loading="lazy"/></a></p>
<ol start="4">
<li>下一步我们来添加EMR Serverless 计算资源。进入项目后，在左侧概览下选择<strong>compute</strong>，点击<strong>Data processing</strong>，点击 <strong>add compute</strong>。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-18.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-18.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/668caf7a99ea4870baa8673e4c4e7823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=TQhNSL6uWj34ApKDgzjt6NchfsY%3D" alt="" loading="lazy"/></a></p>
<ol start="5">
<li>您可以选择连接到现有计算资源。如果您为创建资源，可以选择<strong>Create new compute resources</strong>，点击 <strong>next</strong></li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-19.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-19.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05e6b12c1c744359bafe824d901d9c91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=%2F2uLvWFSzQ6DW4VhIisGOQ9pHbs%3D" alt="" loading="lazy"/></a></p>
<ol start="6">
<li>关于计算资源种类，我们选择<strong>EMR Serverless</strong> , 点击 <strong>next，</strong> 修改<strong>compute name</strong>，其他保持默认值，点击 <strong>add compute</strong></li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-20.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-20.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cd7d975b8274f219ad1363bbd2f7cd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=GsW44ZIt2VQaKZEXp8cGtyWrC4U%3D" alt="" loading="lazy"/></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-21.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-21.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c495c4a71ce40b189cc5ba41f78a01f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=2bk67ods4VXOAhhMUZ%2Bs0Ih7nOg%3D" alt="" loading="lazy"/></a></p>
<h3 data-id="heading-7">项目角色权限配置</h3>
<p>最后我们还需要为项目角色添加权限，使其可以访问Databricks存储在S3的数据。</p>
<ol>
<li>我们先在左侧概览下选择<strong>Project overview</strong>，在<strong>Project details</strong>找到<strong>Porject role arn</strong>，从 datazone_user字段开始复制</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-22.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-22.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/615ca1a66c184e008a4bd4eeccfb57c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=sljAroswebDrAaLH6nZDcdANtY4%3D" alt="" loading="lazy"/></a></p>
<ol start="2">
<li>进入<strong>IAM</strong>服务控台页面，点击左侧角色，搜索复制的project role，点击查询结果查看角色详情。</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-23.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-23.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fffc6720c68d4e0b9f22fb8fa5f12321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=%2BXDrrLuOgGyJ%2FEDyFT2sHG6DIHg%3D" alt="" loading="lazy"/></a></p>
<ol start="3">
<li>为项目角色创建内联策略。输入以下策略，将<em>amzn-s3-demo-bucket</em>替换成您的存储桶名称</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-24.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-24.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f566e6bd4fd84b79bc54706d8de1cb40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=khN6IawyYMt6sBMy0Ixq3l6jpd8%3D" alt="" loading="lazy"/></a></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Sid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"S3AdditionalObjectPermissions"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"s3:ListBucket"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"s3:GetBucketLocation"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"s3:GetObject*"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"s3:PutObject"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"arn:aws:s3:::&lt;amzn-s3-demo-bucket&gt;"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"arn:aws:s3:::&lt;amzn-s3-demo-bucket&gt;/*"</span>
            <span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>至此我们在Sagemaker Unified Studio上的开发环境已经Ready了.</p>
<h2 data-id="heading-8">EMR Serverless 配置</h2>
<p>下面我们需要修改 EMR Serverless Application 的配置, 为了保证后面我们在 Sagemaker Unified Studio 中的配置一致,我们需要修改Application的  <strong>Application configuration</strong> 和 <strong>Additional configurations.</strong> 修改的内容如下</p>
<ol>
<li><strong>Application configuration</strong></li>
</ol>

<pre><code class="hljs language-bash" lang="bash">{
    <span class="hljs-string">"runtimeConfiguration"</span>: [
        {
            <span class="hljs-string">"classification"</span>: <span class="hljs-string">"spark-defaults"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"spark.jars"</span>: <span class="hljs-string">"/usr/share/aws/delta/lib/delta-spark.jar,/usr/share/aws/delta/lib/delta-storage.jar"</span>,
                <span class="hljs-string">"spark.jars.packages"</span>: <span class="hljs-string">"io.unitycatalog:unitycatalog-spark_2.12:0.2.0"</span>,
                <span class="hljs-string">"spark.sql.extensions"</span>: <span class="hljs-string">"io.delta.sql.DeltaSparkSessionExtension"</span>,
                <span class="hljs-string">"spark.sql.defaultCatalog"</span>: <span class="hljs-string">"&lt;databricks uc&gt;"</span>, <span class="hljs-comment"># 此处修改为上面databricks中grant的UC</span>
                <span class="hljs-string">"spark.sql.catalog.spark_catalog"</span>: <span class="hljs-string">"io.unitycatalog.spark.UCSingleCatalog"</span>,
                <span class="hljs-string">"spark.sql.catalog.&lt;databricks uc&gt;"</span>: <span class="hljs-string">"io.unitycatalog.spark.UCSingleCatalog"</span>,
                <span class="hljs-string">"spark.sql.catalog.&lt;databricks uc&gt;.uri"</span>: <span class="hljs-string">"https://&lt;databricks workspace url&gt;/api/2.1/unity-catalog"</span>
            }
        }
    ]
}
</code></pre>
<p>2.  Disable Glue Catalog</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-25.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-25.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac923850b2cf4004b24d99c226265b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=Qdf58ppXSoOIvLuP0haYIAnpWkU%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-9">Sagemaker Unified Studio JupyterLab配置</h2>
<p>下面我们开始配置Sagemaker Unified Studio → JupyterLab, 如下图所示</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-26.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-26.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/067be762f45c4ec2b43355afca47490b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=0tlXLiAd7MbwcVhS4pYd3iPXFzw%3D" alt="" loading="lazy"/></a></p>
<p>在我们创建Sagemaker Unified Studio的时候,会默认选上Glue Catalog作为Catalog的默认选项,如何我们想在Notebook内使用Databricks Unified Catalog, 我们需要覆盖原有Glue Catalog配置信息,注意下面的catalog信息.</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-comment">%%configure -n &lt;EMR serverless application&gt; -f </span>
{ 
    <span class="hljs-string">"conf"</span>: { 
        <span class="hljs-string">"spark.jars"</span>: <span class="hljs-string">"/usr/share/aws/delta/lib/delta-spark.jar,/usr/share/aws/delta/lib/delta-storage.jar"</span>,
        <span class="hljs-string">"spark.jars.packages"</span>: <span class="hljs-string">"io.unitycatalog:unitycatalog-spark_2.12:0.2.0"</span>,
        <span class="hljs-string">"spark.sql.extensions"</span>: <span class="hljs-string">"io.delta.sql.DeltaSparkSessionExtension"</span>,
        <span class="hljs-string">"spark.sql.defaultCatalog"</span>: <span class="hljs-string">"&lt;databricks uc&gt;"</span>,
        <span class="hljs-string">"spark.sql.catalog.spark_catalog"</span>: <span class="hljs-string">"io.unitycatalog.spark.UCSingleCatalog"</span>,
        <span class="hljs-string">"spark.sql.catalog.&lt;databricks uc&gt;"</span>: <span class="hljs-string">"io.unitycatalog.spark.UCSingleCatalog"</span>,
        <span class="hljs-string">"spark.sql.catalog.&lt;databricks uc&gt;.uri"</span>: <span class="hljs-string">"https://&lt;databricks workspace url&gt;/api/2.1/unity-catalog"</span>,
        <span class="hljs-string">"spark.sql.catalog.&lt;databricks uc&gt;.token"</span>: <span class="hljs-string">"&lt;databricks uc token&gt;"</span>
     }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-27.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-27.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26934fe051f4178be88b18c4ea45d74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=106Vv1tnT5GvKGI4%2BIKrCU2kJFc%3D" alt="" loading="lazy"/></a></p>
<p>创建Spark session, 下面步骤中一定要注意<strong>Compute</strong>的信息</p>
<pre><code class="hljs language-java" lang="java">from pyspark.sql <span class="hljs-keyword">import</span> <span class="hljs-type">SparkSession</span>

<span class="hljs-variable">spark</span> <span class="hljs-operator">=</span> SparkSession.builder \
    .appName(<span class="hljs-string">"EMR Serverless and Databricks Unity Catalog Demo"</span>) \
    .getOrCreate()
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-28.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-28.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5ac467f34a44c6b1504c220f6d771f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=%2BCM1quBGs9yObp4m56BSWXaKpSA%3D" alt="" loading="lazy"/></a></p>
<p>验证当前的 Spark Context Configuration</p>
<pre><code class="hljs language-scss" lang="scss"># Verify the configuration
essential_configs = <span class="hljs-selector-attr">[    <span class="hljs-string">'spark.jars.packages'</span>, <span class="hljs-string">'spark.executor.instances'</span>, <span class="hljs-string">'spark.cores'</span>,    <span class="hljs-string">'spark.driver.cores'</span>, <span class="hljs-string">'spark.executor.cores'</span>, <span class="hljs-string">'spark.memory'</span>,    <span class="hljs-string">'spark.driver.memory'</span>, <span class="hljs-string">'spark.executor.memory'</span>, <span class="hljs-string">'spark.sql.catalog'</span>,    <span class="hljs-string">'spark.sql.defaultCatalog'</span>, <span class="hljs-string">'spark.master'</span>, <span class="hljs-string">'spark.sql.extensions'</span>]</span>
for item in spark<span class="hljs-selector-class">.sparkContext</span><span class="hljs-selector-class">.getConf</span>()<span class="hljs-selector-class">.getAll</span>():
    if <span class="hljs-built_in">any</span>(config in item[<span class="hljs-number">0</span>] for config in essential_configs):
        <span class="hljs-built_in">print</span>(item)
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-29.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-29.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56215b08687c436fa2ad53c79fb674a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=mkCdPIY9T6Wza3j2rX4Fg1ueu9A%3D" alt="" loading="lazy"/></a></p>
<p>如果想使用emr serverless计算资源，请在每个单元格上方进行选择，左侧选择pyspark，右侧选择创建好的emr serverless资源</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-30.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-30.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f88d1f28844f90af6130f5c89178b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=uisBj43cXlfL2L9nYhlA5akG750%3D" alt="" loading="lazy"/></a></p>
<p>查询当前Spark中的catalog List</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Try to use Unity Catalog</span>
spark.sql(<span class="hljs-string">"SHOW CATALOGS"</span>).show()
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-31.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-31.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f426418efa844c18b99b9b1cd104332f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=8OnB0QOKD0KEOTzX%2Bt%2BDPFvjZLo%3D" alt="" loading="lazy"/></a></p>
<p>可以看到此时已经有 sean2 的catalog.</p>
<p>下面我们查询该catalog下的schema数据.</p>
<p><code>spark.sql("select * from sean2.myorder.sample_orders limit 1").show()</code></p>
<p>此时可以看到我们已经可以查询到数据了.</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fd2908q01vomqb2.cloudfront.net%2F472b07b9fcf2c2451e8781e944bf5f77cd8457c8%2F2025%2F10%2F16%2Fmachine-learning-and-data-analytics-workflow-32.jpg" target="_blank" title="https://d2908q01vomqb2.cloudfront.net/472b07b9fcf2c2451e8781e944bf5f77cd8457c8/2025/10/16/machine-learning-and-data-analytics-workflow-32.jpg" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/432db570501846a1ab74bd5ae93371e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=Bx%2FU%2F7CBhUIxyuxBj%2FiOuBhwt%2Bo%3D" alt="" loading="lazy"/></a></p>
<h2 data-id="heading-10">总结与展望</h2>
<h3 data-id="heading-11">方案价值回顾</h3>
<p>通过本文介绍的集成方案，我们成功打通了亚马逊云科技新一代SageMaker与Databricks两大平台的数据通道，实现了真正意义上的统一数据湖仓架构。这不仅是技术层面的集成，更是企业数据战略的重要布局。</p>
<h4 data-id="heading-12">关键收益总结</h4>
<ol>
<li>直接收益：</li>
</ol>
<ul>
<li>开发效率提升：消除重复的ETL开发工作</li>
<li>数据延迟降低：从批处理ETL到实时查询的转变</li>
<li>治理成本降低：统一的权限管理和审计体系</li>
<li>资源利用率提升：EMR Serverless的弹性计算能力</li>
</ul>
<ol start="2">
<li>战略价值：</li>
</ol>
<ul>
<li>打破组织壁垒：让数据工程师和数据科学家在各自熟悉的平台上协同工作</li>
<li>加速<strong>AI</strong>落地：从数据洞察到模型部署的端到端流程优化</li>
<li>降低合规风险：统一的数据治理框架确保合规性</li>
<li>提升创新能力：释放团队精力专注于业务价值创造</li>
</ul>
<ol start="3">
<li>适用场景</li>
</ol>
<p>本方案特别适合以下场景：</p>
<ul>
<li>已有Databricks数据平台，需要扩展ML能力的企业</li>
<li>需要在亚马逊云科技生态系统中利用Databricks数据资产的团队</li>
<li>对数据治理有严格要求的游戏、金融、医疗等行业</li>
<li>追求成本优化的中大型数据团队</li>
</ul>
<h3 data-id="heading-13">未来展望</h3>
<p>随着Unity Catalog生态的不断完善和亚马逊云科技对开放标准的持续支持，我们预见：</p>
<ol>
<li>更深度的集成：期待看到新一代SageMaker与Databricks的直接集成，互为数据的生产者与消费者。在数据发现，可读可写和数据治理方面更加无缝</li>
<li>性能优化：通过缓存、预计算等技术进一步提升查询性能</li>
<li>智能化治理：基于ML的自动化数据分类和权限推荐</li>
<li>多云扩展：将这种集成模式扩展到其他云平台</li>
</ol>
<p><strong>参考文档</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommunity.databricks.com%2Ft5%2Ftechnical-blog%2Fhow-to-access-data-in-databricks-from-amazon-sagemaker-notebooks%2Fba-p%2F83638" target="_blank" title="https://community.databricks.com/t5/technical-blog/how-to-access-data-in-databricks-from-amazon-sagemaker-notebooks/ba-p/83638" ref="nofollow noopener noreferrer">community.databricks.com/t5/technica…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2Fblogs%2Fbig-data%2Frun-interactive-workloads-on-amazon-emr-serverless-from-amazon-emr-studio%2F" target="_blank" title="https://aws.amazon.com/blogs/big-data/run-interactive-workloads-on-amazon-emr-serverless-from-amazon-emr-studio/" ref="nofollow noopener noreferrer">aws.amazon.com/blogs/big-d…</a></p>
<p>*<em>前述特定亚马逊云科技生成式人工智能相关的服务目前在亚马逊云科技海外区域可用。亚马逊云科技中国区域相关云服务由西云数据和光环新网运营，具体信息以中国区域官网为准。</em></p>
<p><strong>本篇作者</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09d37d2eb0fc46f8bf479071170271d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqa6ams6YCK5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765255232&amp;x-signature=O1bpi%2Fze%2BZ2NX%2Bb4qtq1TI8KSvk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥牛逼！3分钟生成 5 套主题，还能一键切换暗黑模式！]]></title>    <link>https://juejin.cn/post/7578391787980636201</link>    <guid>https://juejin.cn/post/7578391787980636201</guid>    <pubDate>2025-12-01T03:08:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578391787980636201" data-draft-id="7577693903018213402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥牛逼！3分钟生成 5 套主题，还能一键切换暗黑模式！"/> <meta itemprop="keywords" content="前端,前端框架,uni-app"/> <meta itemprop="datePublished" content="2025-12-01T03:08:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端梦工厂"/> <meta itemprop="url" content="https://juejin.cn/user/4230576472589976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥牛逼！3分钟生成 5 套主题，还能一键切换暗黑模式！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576472589976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端梦工厂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T03:08:21.000Z" title="Mon Dec 01 2025 03:08:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动应用开发中，如果你还在为<strong>主题切换</strong>和<strong>暗黑模式</strong>适配而烦恼，那 <code>uView Pro 0.4.x</code> 会让你眼前一亮。我们不仅带来了强大的多主题系统，还贴心地提供了一个可视化的主题生成工具——让"<strong>主题自定义</strong>"从代码黑洞变成点点鼠标就能完成的事。</p>
<p>目前 <code>uView Pro 0.4.1</code> 已正式发布，一站式主题采购器震撼上线，解锁多主题与暗黑模式！</p>
<p>uView Pro 相关开源地址如下：</p>
<blockquote>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanyup%2Fuview-pro" target="_blank" title="https://github.com/anyup/uview-pro" ref="nofollow noopener noreferrer">github.com/anyup/uview…</a></li>
<li>Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fanyup%2Fuview-pro" target="_blank" title="https://gitee.com/anyup/uview-pro" ref="nofollow noopener noreferrer">gitee.com/anyup/uview…</a></li>
<li>Npm：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fuview-pro" target="_blank" title="https://www.npmjs.com/package/uview-pro" ref="nofollow noopener noreferrer">www.npmjs.com/package/uvi…</a></li>
<li>插件市场：<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D24633" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=24633" ref="nofollow noopener noreferrer">ext.dcloud.net.cn/plugin?id=2…</a></li>
<li>官网（牢记）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2F" target="_blank" title="https://uviewpro.cn/" ref="nofollow noopener noreferrer">uviewpro.cn/</a></li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言：主题定制的痛点</h2>
<p>想象一下这样的场景：</p>
<ul>
<li>🎨 设计师要求一套新的配色方案</li>
<li>🌙 产品经理要求支持暗黑模式</li>
<li>📱 不同客户需要不同的品牌色</li>
<li>💪 前端工程师需要手动维护几十个 SCSS 变量</li>
</ul>
<p>传统的方式是什么？在 SCSS 文件里一个一个改颜色值，然后祈祷不要改错。每次改动都要重新编译，等待测试反馈。这就是 0.3.x 时代的真实写照。</p>
<p><strong>0.4.x 来了，一切都变了。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/314182618a274640ba6c77ac49b6c201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=8hRs4krRfhXCKonbFUhLrTJO1xI%3D" alt="动画0.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">一. 核心升级：从"手工坊"到"智能工厂"</h2>
<h3 data-id="heading-2">1. 多主题系统：不再是单一配色</h3>
<p>在 0.3.x，你只能有一套主题。现在，<strong>0.4.x 支持无限个主题</strong>。</p>
<p>想象你是一个 SaaS 平台，有多个客户，每个客户都想要自己的品牌色。用 0.3.x，你需要：</p>
<ul>
<li>给每个客户打包一个不同的 APP</li>
<li>或者在运行时动态切换一堆 CSS 变量（麻烦且容易出错）</li>
</ul>
<p>用 0.4.x，你只需要：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/uview-pro.theme.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'blue'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'蓝色主题（官方推荐）'</span>,
    <span class="hljs-attr">color</span>: { <span class="hljs-attr">primary</span>: <span class="hljs-string">'#2979ff'</span>, <span class="hljs-comment">/* ... */</span> }
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'purple'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'紫色主题（高端商务）'</span>,
    <span class="hljs-attr">color</span>: { <span class="hljs-attr">primary</span>: <span class="hljs-string">'#7c3aed'</span>, <span class="hljs-comment">/* ... */</span> }
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'green'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'绿色主题（医疗健康）'</span>,
    <span class="hljs-attr">color</span>: { <span class="hljs-attr">primary</span>: <span class="hljs-string">'#10b981'</span>, <span class="hljs-comment">/* ... */</span> }
  }
];
</code></pre>
<p>然后在 APP 中提供一个主题切换器：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;picker :range="themes" range-key="label" @change="switchTheme"&gt;
  &lt;view&gt;选择主题&lt;/view&gt;
&lt;/picker&gt;
</code></pre>
<p>只需要加载一个配置文件，即可拥有多个主题！</p>
<p><strong>简单。优雅。强大。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b72e5b879f2466d9fcfed25882882d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=dYjPOOrrJsq%2B9c6lWsBqYLuDLOg%3D" alt="12.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">2. 暗黑模式：不只是一个开关</h3>
<p>0.3.x 中暗黑模式完全不存在。你需要自己：</p>
<ul>
<li>重新定义所有颜色的暗黑版本</li>
<li>手动监听系统主题变化</li>
<li>手动切换样式</li>
</ul>
<p>这不仅代码复杂，而且维护成本极高。</p>
<p>0.4.x 直接内置，开箱即用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'uview-pro'</span>;

<span class="hljs-keyword">const</span> { darkMode, setDarkMode, toggleDarkMode, isInDarkMode } = <span class="hljs-title function_">useTheme</span>();

<span class="hljs-comment">// 跟随系统自动切换</span>
<span class="hljs-title function_">setDarkMode</span>(<span class="hljs-string">'auto'</span>);

<span class="hljs-comment">// 手动快速切换</span>
<span class="hljs-title function_">toggleDarkMode</span>();

<span class="hljs-comment">// 检查当前是否暗黑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isInDarkMode</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'夜间模式已启用'</span>);
}
</code></pre>
<p>而且，<strong>系统自动为你的亮色色板生成合理的暗色</strong>。不用自己去想"这个蓝色的暗黑版本应该是什么样"的问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36bd2300fe744bbeb39bbe3c2cf8a98f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=j6ySYusGDmSpt7kYDM20yXyWlkc%3D" alt="13.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">二. 智能黑科技：颜色自动生成</h2>
<h3 data-id="heading-5">问题：暗黑色值怎么来？</h3>
<p>0.4.x 最牛逼的地方在这里：<strong>你只需提供亮色色板，暗色会自动生成</strong>。</p>
<p>用户配置了亮色 <code>primary: '#2979ff'</code>，系统会自动计算出暗色 <code>primary: '#639cff'</code>。算法是什么？</p>
<p>简单地说，系统采用<strong>色值混合</strong>方案：</p>
<ul>
<li>取用户提供的亮色</li>
<li>与预定义的暗色基准混合（加权平均，比例 0.6:0.4）</li>
<li>生成视觉层级合理、对比度充足的暗色</li>
</ul>
<p>这意味着：</p>
<ul>
<li>✅ 任何亮色都能生成合理的暗色</li>
<li>✅ 生成的暗色永远符合可读性标准</li>
<li>✅ 用户还能手动微调（如果想要）</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">{
  <span class="hljs-attr">color</span>: {
    <span class="hljs-attr">primary</span>: <span class="hljs-string">'#2979ff'</span>,
    <span class="hljs-attr">bgColor</span>: <span class="hljs-string">'#f3f4f6'</span>,
    <span class="hljs-attr">mainColor</span>: <span class="hljs-string">'#303133'</span>
  },
  <span class="hljs-attr">darkColor</span>: {
    <span class="hljs-comment">// 留空，系统自动生成：</span>
    <span class="hljs-comment">// primary: '#639cff'</span>
    <span class="hljs-comment">// bgColor: '#1a1a1a'</span>
    <span class="hljs-comment">// mainColor: '#f5f5f5'</span>
    
    <span class="hljs-comment">// 或者手动覆盖某个：</span>
    <span class="hljs-attr">primary</span>: <span class="hljs-string">'#6ba1ff'</span>  <span class="hljs-comment">// 自定义暗色</span>
    <span class="hljs-comment">// 其他的还是自动生成</span>
  }
}
</code></pre>
<p><strong>这就是"智能"的含义。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede226b4712249eaba1f836e0c1e324b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=x4EuPgRIxBVLJATrqrnSv8DWfRU%3D" alt="14.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">三. 终极杀器：超强主题采购器</h2>
<p>最酷的是，0.4.x 提供了一个<strong>可视化的主题配置工具</strong>。</p>
<p>你只需要：</p>
<ol>
<li>
<p><strong>打开工具页面</strong></p>
<ul>
<li>不需要写代码</li>
<li>不需要打开编辑器</li>
<li>打开浏览器就能用</li>
</ul>
</li>
<li>
<p><strong>选择颜色</strong></p>
<ul>
<li>直观的颜色拾取器</li>
<li>实时预览效果（按钮、卡片、背景全部实时展示）</li>
<li>看不爽？一键随机生成</li>
</ul>
</li>
<li>
<p><strong>启用暗黑</strong></p>
<ul>
<li>打开"暗黑模式"开关</li>
<li>系统自动生成所有暗色值</li>
<li>不满意？逐个调整，或者重新生成</li>
</ul>
</li>
<li>
<p><strong>导出使用</strong></p>
<ul>
<li>一键下载 <code>uview-pro.theme.ts</code></li>
<li>复制到项目</li>
<li>搞定！</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcf1590f8b464e12ab4ff7ac02b1082f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=ZkjskwwIwlgTfDkLtHaYcvSiX%2FY%3D" alt="动画1.gif" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634e83863be94e159c9224c26afe6e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=%2FyDKUTNIhpvTv7Ap%2Fz%2FtKSLo1zQ%3D" alt="动画2.gif" loading="lazy"/></p>
<h3 data-id="heading-7">工具的超强能力</h3>
<ul>
<li><strong>批量配置</strong>：配置完一套主题后，点"添加到队列"，继续配置下一套。最后一次性导出所有主题。</li>
<li><strong>实时预览</strong>：修改颜色的同时，看到按钮、卡片、背景的实时变化。不用猜，直观感受。</li>
<li><strong>智能生成</strong>：一键生成随机的主题配色方案。配合 AI，说不定能撞出灵感。</li>
<li><strong>折叠面板</strong>：颜色太多？按分类折叠。快速编辑，节省屏幕空间。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/511cd31e825149359515c1d138060aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5qKm5bel5Y6C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765163301&amp;x-signature=vCZbqyE5zNgilK7quLyGv%2FoaR4I%3D" alt="动画6.gif" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">四. 技术细节：为什么这样设计？</h2>
<h3 data-id="heading-9">1. 为什么采用 TS 数组而不是 SCSS？</h3>
<p>0.3.x 使用 SCSS 变量导出。0.4.x 改成了 TS 数组：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'blue'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'蓝色'</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">'清爽蓝色主题'</span>,
    <span class="hljs-attr">color</span>: { <span class="hljs-comment">/* ... */</span> },
    <span class="hljs-attr">darkColor</span>: { <span class="hljs-comment">/* ... */</span> }
  }
];
</code></pre>
<p>为什么？</p>
<ul>
<li><strong>动态性</strong>：TS 数组可以在运行时动态加载、修改、切换</li>
<li><strong>可序列化</strong>：轻松 JSON.stringify，支持网络传输</li>
<li><strong>类型安全</strong>：TypeScript 类型提示，避免拼写错误</li>
<li><strong>可扩展</strong>：可以添加自定义字段（如 description、tags 等）</li>
</ul>
<p>当然，SCSS 格式仍然支持。</p>
<h3 data-id="heading-10">2. 为什么要自动生成暗色？</h3>
<p>手动定义每个颜色的暗色版本非常繁琐，而且容易出现视觉不一致。当然，一个标准的应用，它应该具备一个完美的配色。然而，实际情况有时比较随意。</p>
<p>自动生成的好处：</p>
<ul>
<li><strong>省时</strong>：从 60 个颜色 → 30 个（亮色）</li>
<li><strong>一致</strong>：算法保证所有暗色在一个风格基调上</li>
<li><strong>可靠</strong>：系统自动检查对比度、可读性</li>
<li><strong>灵活</strong>：用户仍可手动覆盖任何一个</li>
</ul>
<hr/>
<h2 data-id="heading-11">六. 实战升级：从 0.3.x 到 0.4.x</h2>
<p>不用担心兼容性。升级很简单：</p>
<h3 data-id="heading-12">第一步：生成主题</h3>
<p>访问工具，配置你的主题，导出 <code>uview-pro.theme.ts</code>。</p>
<h3 data-id="heading-13">第二步：注册主题</h3>
<p>在 <code>main.ts</code> 中注册</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> theme <span class="hljs-keyword">from</span> <span class="hljs-string">'@/uview-pro.theme'</span>;
<span class="hljs-keyword">import</span> uViewPro <span class="hljs-keyword">from</span> <span class="hljs-string">'@/uni_modules/uview-pro'</span>;

app.<span class="hljs-title function_">use</span>(uViewPro, { theme });
</code></pre>
<p>在 <code>uni.scss</code> 中引入全局 <code>scss</code>变量</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@import</span> <span class="hljs-string">'uview-pro/theme.scss'</span>;
</code></pre>
<h3 data-id="heading-14">第三步：使用（完全向后兼容）</h3>
<p>在 scss 中使用：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SCSS 中，和以前一样</span>
<span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-variable">$u-type-primary</span>;
}
</code></pre>
<p>在 vue/ts 中使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> {$u} <span class="hljs-keyword">from</span> <span class="hljs-string">'uview-pro'</span>
<span class="hljs-keyword">const</span> color = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  color.<span class="hljs-property">value</span> = uni.<span class="hljs-property">$u</span>.<span class="hljs-property">color</span>[<span class="hljs-string">'primary'</span>];
  <span class="hljs-comment">// 或</span>
  color.<span class="hljs-property">value</span> = $u.<span class="hljs-property">color</span>[<span class="hljs-string">'primary'</span>];
});
</code></pre>
<p>此外，新增了 useTheme API</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> {
  currentTheme, <span class="hljs-comment">// Ref&lt;Theme | null&gt;</span>
  themes,       <span class="hljs-comment">// Ref&lt;Theme[]&gt;</span>
  darkMode,     <span class="hljs-comment">// Ref&lt;'light' | 'dark' | 'auto'&gt;</span>
  cssVars,      <span class="hljs-comment">// Ref&lt;Record&lt;string, string&gt;&gt;</span>
  setTheme,
  getCurrentTheme,
  getAvailableThemes,
  initTheme,
  getDarkMode,
  setDarkMode,
  isInDarkMode,
  toggleDarkMode
} = <span class="hljs-title function_">useTheme</span>();
</code></pre>
<ul>
<li><strong>currentTheme / themes</strong>：直接在模板中使用，例如 <code>currentTheme?.name</code>、<code>themes.map(...)</code>。</li>
<li><strong>cssVars</strong>：包含诸如 <code>--u-type-primary</code>, <code>--u-bg-color</code> 等变量，可配合 <code>v-bind</code> 绑定到行内样式。</li>
<li><strong>setTheme(name)</strong>：切换到指定主题，内部会持久化到 <code>Storage</code>，下次启动自动恢复。</li>
<li><strong>initTheme(list, defaultName?)</strong>：大多数场景无需手动调用；只有当你在运行时动态获取主题列表时，需要显式调用一次。</li>
<li><strong>getDarkMode / setDarkMode</strong>：读写当前暗黑策略；<code>setDarkMode('auto')</code> 会立即跟随系统主题。</li>
<li><strong>toggleDarkMode()</strong>：在 <code>light</code> 与 <code>dark</code> 间快速切换，常用于快捷开关。</li>
<li><strong>isInDarkMode()</strong>：返回布尔值，表示当前是否处于暗黑渲染状态（<code>auto</code> 时会考虑系统设置）。</li>
</ul>
<hr/>
<h2 data-id="heading-15">七. 为什么用户会选择 0.4.x？</h2>
<h3 data-id="heading-16">1. 降低维护成本</h3>
<ul>
<li>从手工定义 → 智能生成</li>
<li>从多份配置文件 → 统一主题文件</li>
<li>从复杂的色值管理 → 可视化工具</li>
</ul>
<h3 data-id="heading-17">2. 加速迭代周期</h3>
<ul>
<li>设计稿出来了？打开工具，3 分钟出配置</li>
<li>客户要改色？无需代码发布，动态加载即可</li>
<li>A/B 测试？支持多主题，轻松切换</li>
</ul>
<h3 data-id="heading-18">3. 提升用户体验</h3>
<ul>
<li>✅ 暗黑模式完美适配</li>
<li>✅ 品牌色完全可定制</li>
<li>✅ 跟随系统自动切换</li>
<li>✅ 主题切换流畅无闪烁</li>
</ul>
<h3 data-id="heading-19">4. 解放开发生产力</h3>
<ul>
<li>不用再手动维护颜色值</li>
<li>不用再写冗长的暗黑 CSS</li>
<li>不用再调试对比度和可读性</li>
<li><strong>可以专注于业务逻辑</strong></li>
</ul>
<hr/>
<h2 data-id="heading-20">来自用户的声音</h2>
<blockquote>
<p>"之前为一个客户定制主题需要改改代码、测试、再改，要花一两天。现在用工具，5 分钟搞定。" —— 某 B 端 SaaS 团队负责人</p>
</blockquote>
<blockquote>
<p>"暗黑模式自动生成，太爽了。之前手动定义，结果有的颜色对比度不够，被设计师挑出来好几次。现在系统搞定，心里踏实。" —— 某软件公司前端主管</p>
</blockquote>
<hr/>
<h2 data-id="heading-21">展望：0.4.1 之后的方向</h2>
<p>0.4.1 是一个里程碑，但我们不会止步。后续的主题规划包括也不限于：</p>
<ul>
<li>🎨 <strong>主题市场</strong>：官方预设主题库，一键导入</li>
<li>🤖 <strong>AI 配色助手</strong>：输入品牌描述，AI 自动生成配色方案</li>
<li>📊 <strong>主题分析</strong>：可视化展示色值对比度、可访问性评分</li>
<li>🔄 <strong>跨项目共享</strong>：主题配置可跨项目、跨团队使用</li>
<li>🌈 <strong>渐变色支持</strong>：支持渐变色的主题定义</li>
</ul>
<hr/>
<h2 data-id="heading-22">结语</h2>
<p>uView Pro 0.4.1 的多主题与暗黑模式系统，不仅仅是功能迭代，更是一种<strong>开发哲学的升级</strong>：</p>
<blockquote>
<p><strong>从 "我来适应组件" → "组件适应我"</strong></p>
</blockquote>
<p>从手动堆砌代码到可视化智能工具，从单一主题到多主题生态，从被迫学习暗黑适配到开箱即用。</p>
<p><strong>如果你还在用 0.3.x，该升级了。</strong></p>
<p><strong>如果你从未用过 uView Pro，0.4.1 是最好的入场时机。</strong></p>
<p>立即访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn" target="_blank" title="https://uviewpro.cn" ref="nofollow noopener noreferrer">uView Pro 官网</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanyup%2FuView-Pro" target="_blank" title="https://github.com/anyup/uView-Pro" ref="nofollow noopener noreferrer">GitHub 仓库</a>，体验这个超强的主题采购器。</p>
<hr/>
<h2 data-id="heading-23">快速链接</h2>
<ul>
<li>💪 <strong>官网</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2F" target="_blank" title="https://uviewpro.cn/" ref="nofollow noopener noreferrer">uviewpro.cn/</a></li>
<li>🎨 <strong>主题配置工具</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2Fzh%2Fguide%2FthemeGenerate.html" target="_blank" title="https://uviewpro.cn/zh/guide/themeGenerate.html" ref="nofollow noopener noreferrer">uviewpro.cn/zh/guide/th…</a></li>
<li>📖 <strong>完整文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2Fzh%2Fguide%2FcustomTheme.html" target="_blank" title="https://uviewpro.cn/zh/guide/customTheme.html" ref="nofollow noopener noreferrer">uviewpro.cn/zh/guide/cu…</a></li>
<li>⬆️ <strong>升级指南</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2Fzh%2Fcomponents%2Fupgrade%2F04x.html" target="_blank" title="https://uviewpro.cn/zh/components/upgrade/04x.html" ref="nofollow noopener noreferrer">uviewpro.cn/zh/componen…</a></li>
<li>💬 <strong>交流反馈</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fuviewpro.cn%2Fzh%2Fresource%2Fabout.html" target="_blank" title="https://uviewpro.cn/zh/resource/about.html" ref="nofollow noopener noreferrer">uviewpro.cn/zh/resource…</a></li>
<li>⭐ <strong>支持我们</strong>：GitHub Star / Gitee Star 都感谢！
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanyup%2Fuview-pro" target="_blank" title="https://github.com/anyup/uview-pro" ref="nofollow noopener noreferrer">github.com/anyup/uview…</a></li>
<li>Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fanyup%2Fuview-pro" target="_blank" title="https://gitee.com/anyup/uview-pro" ref="nofollow noopener noreferrer">gitee.com/anyup/uview…</a></li>
</ul>
</li>
</ul>
<hr/>
<p><strong>uView Pro 0.4.x，让你的应用主题焕然一新。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nano Banana Pro 很强，但你要学会写提示词才能为所欲为]]></title>    <link>https://juejin.cn/post/7578681104292544555</link>    <guid>https://juejin.cn/post/7578681104292544555</guid>    <pubDate>2025-12-01T13:06:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578681104292544555" data-draft-id="7578681104292528171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nano Banana Pro 很强，但你要学会写提示词才能为所欲为"/> <meta itemprop="keywords" content="AIGC,人工智能,MCP"/> <meta itemprop="datePublished" content="2025-12-01T13:06:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nano Banana Pro 很强，但你要学会写提示词才能为所欲为
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T13:06:05.000Z" title="Mon Dec 01 2025 13:06:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>如果你已经学会：</p>
<ol>
<li>
<p>免费使用 Nano Banana Pro： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FtYKzM0PIvBm5QG08SW3_BA" target="_blank" title="https://mp.weixin.qq.com/s/tYKzM0PIvBm5QG08SW3_BA" ref="nofollow noopener noreferrer">6 个白嫖 Nano Banana Pro 的网站</a></p>
</li>
<li>
<p>使用提示词库复刻惊艳图片：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxZQNPPwGxhzWhGsr-alKkg" target="_blank" title="https://mp.weixin.qq.com/s/xZQNPPwGxhzWhGsr-alKkg" ref="nofollow noopener noreferrer">一次找齐！1000 个 Nano Banana Pro 提示词</a></p>
</li>
</ol>
<p>那本篇我们来点干货 —— 如何写出好的提示词。</p>
<p>之所以要学习如何写提示词，是因为绝大部分人在写提示词时，都是一种 <strong>“随缘”</strong> 的状态——有的地方写得详细，有的地方却被遗漏了，这就带来了 <strong>很大的不确定性</strong> 。</p>
<p>所以本篇我们就来聊聊如何通过结构化的提示词，提升图片生成的质量，<strong>让 Nano Bnana 生成的每一张图都是高水准的图片。</strong></p>
<h2 data-id="heading-1">2. 生成图片</h2>
<h3 data-id="heading-2">2.1. 逼真场景</h3>
<p>如果要生成逼真的图片，最好使用摄影术语，设定拍摄角度、镜头类型、光线和细节，引导模型生成逼真的效果。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A photorealistic [shot type] of [subject], [action or expression], set in
[environment]. The scene is illuminated by [lighting description], creating
a [mood] atmosphere. Captured with a [camera/lens details], emphasizing
[key textures and details]. The image should be in a [aspect ratio] format.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张高度写实的 <strong>[镜头类型]</strong> ，主体为 <strong>[拍摄对象]</strong> ， <strong>[动作或表情]</strong> ，场景设定在 <strong>[环境]</strong> 中。场景由 <strong>[光线描述]</strong> 照明，营造出 <strong>[氛围]</strong> 的氛围。使用 <strong>[相机/镜头细节]</strong> 拍摄，突出 <strong>[关键纹理和细节]</strong> 。图像应采用 <strong>[纵横比]</strong> 格式。</p>
</blockquote>
<p>让我们举个例子：</p>
<blockquote>
<p>一幅高度写实的特写肖像，描绘了一位年长的中国陶艺家。他脸上有着深深的、被阳光刻下的皱纹，带着温暖而洞悉一切的微笑。他正仔细检查一个刚上釉的茶碗。场景设定在他那质朴且阳光充足的工作室里。柔和的黄金时刻光线透过窗户洒入，照亮了黏土细腻的纹理。这幅肖像使用 85 毫米人像镜头拍摄，背景呈现出柔和模糊的效果（焦外成像）。整体氛围宁静而娴熟。肖像采用垂直构图。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b59c455ecfc4fd687c5bd73e4a1dca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=lSPTt3BGowVi4I4UedTcAy5uBI4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 风格插画或贴纸</h3>
<p>如果要创建插画、贴纸、图标等资源，要明确说明样式并要求使用透明的背景。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A [style] sticker of a [subject], featuring [key characteristics] and a
[color palette]. The design should have [line style] and [shading style].
The background must be transparent.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张 <strong>[风格]</strong> 的 <strong>[主体]</strong> 贴纸，具有 <strong>[关键特征]</strong> 和 <strong>[色彩搭配]</strong> 。设计应采用 <strong>[线条风格]</strong> 和 <strong>[阴影风格]</strong> 。背景必须是透明的。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张可爱风格的贴纸，上面是一只开心的小熊猫，戴着一顶小小的竹帽，正在啃着一片绿色的竹叶。设计采用了醒目清晰的轮廓、简单的卡通渲染，以及鲜艳的色彩搭配。背景必须是透明的。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae4f4c9ce0714fe5884ce15f98cea5fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=N86jW4j4r2MJPqXSEO1wEpT%2BeLs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 精准的带文字渲染</h3>
<p>Nano Banana Pro 强化了文本渲染方面的表现，以前生成汉字的时候还有不少乱码，到 Pro 已经明显改善了很多。但在写提示词时，还是要清晰地说明文字内容、字体样式和整体设计。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Create a [image type] for [brand/concept] with the text "[text to render]"
in a [font style]. The design should be [style description], with a
[color scheme].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>为 <strong>[品牌/概念]</strong> 创建一个 <strong>[图像类型]</strong> ， <strong>[要渲染的文字]</strong> 采用 <strong>[文字风格]</strong> 。设计应具有 <strong>[风格描述]</strong> ，并采用 <strong>[配色方案]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>为一家名为 “The Daily Grind” 的咖啡店设计一个现代简约风格的标志。文字部分采用简洁、粗体的无衬线字体。配色方案为黑白两色。将标志置于圆形之中。巧妙地融入一颗咖啡豆元素。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adbe92278142455da54fdfffdf7dcc81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=3L37Fz1WDVcoeELN9GV7AdJUIbo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.4. 产品摄影</h3>
<p>为电商、广告或品牌制作专业的商品图片。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A high-resolution, studio-lit product photograph of a [product description]
on a [background surface/description]. The lighting is a [lighting setup,
e.g., three-point softbox setup] to [lighting purpose]. The camera angle is
a [angle type] to showcase [specific feature]. Ultra-realistic, with sharp
focus on [key detail]. [Aspect ratio].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一张高分辨率、工作室灯光照明的 <strong>[产品描述]</strong> 产品照片，背景是 <strong>[背景]</strong> 。灯光采用 <strong>[照明设置]</strong> ，目的是 <strong>[照明用途]</strong> 。相机角度为 <strong>[角度类型]</strong> ，以展示 <strong>[特定特征]</strong> 。超写实风格，对 <strong>[关键细节]</strong> 聚焦清晰。 <strong>[纵横比]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张高分辨率、工作室灯光照明的极简主义哑光黑色陶瓷咖啡杯产品照片，放置在抛光的混凝土表面上。灯光采用三点柔光箱设置，旨在营造柔和、漫射的高光并消除刺眼的阴影。相机角度为略微升高的 45 度角，以展示其简洁的线条。超写实风格，清晰聚焦于从咖啡中升起的蒸汽。正方形图像。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa59490bc8e4b92a7f8b59c45df09a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=kaVlcEW4IjSf2uO4cuY6IRmQtG0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 极简主义与留白设计</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A minimalist composition featuring a single [subject] positioned in the
[bottom-right/top-left/etc.] of the frame. The background is a vast, empty
[color] canvas, creating significant negative space. Soft, subtle lighting.
[Aspect ratio].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一幅极简主义构图，画面中单一的 <strong>[主体]</strong> 位于画框的 <strong>[位置]</strong> 。背景是一片广阔、空旷的 <strong>[颜色]</strong> 画布，营造出大量的留白。光线柔和、微妙。 <strong>[宽高比]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一幅极简风格的构图，画面右下角放置着一片精致的红色枫叶。背景是一片广阔、空旷的米白色画布，为文字留出了大量的留白空间。左上角有柔和、漫射的光线。方形图像。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85baca5c343455ba54c6dc9065349a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=nomj0WyqQrCT2S9l3VL9l8I5n28%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 连环画与分镜</h3>
<p>利用模型对角色一致性和场景描述的理解，制作多格漫画或故事板。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Make a 3 panel comic in a [style]. Put the character in a [type of scene].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>制作一个 3 格漫画，风格为 <strong>[风格]</strong> 。让角色处于 <strong>[场景类型]</strong> 中。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>创作一个三格漫画，采用粗犷的黑色电影艺术风格，运用高对比度的黑白墨水绘制。让角色处于一个幽默的场景中。</p>
</blockquote>
<p>用了一张马斯克的图片：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ef56f5d2344c73bf51242df4c3876c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=%2BB%2Fi8qIx5qPoPlgdO%2Ft%2FYi5YbaU%3D" alt="" loading="lazy"/></p>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47f0e1b6300148c6a2e9581a3ac8b1f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=9i%2Bk3q9KcThWdbpYVoAqckh0dmM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">3. 修改图片</h2>
<h3 data-id="heading-9">3.1. 添加或删除元素</h3>
<p>提供图片并描述修改内容。模型将与原始图片的风格、灯光和透视效果保持一致。</p>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided image of [subject], please [add/remove/modify] [element] to/from the scene. Ensure the change is [description of how the change should integrate].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>请使用提供的 <strong>[主体]</strong> 图片，在场景中 <strong>[添加/移除/修改] [元素]</strong> 。确保这一更改能 <strong>[按描述的方式融入场景]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>请使用我提供的那张我的猫咪的照片，在它的头上加一顶小小的针织巫师帽。让它看起来坐得很舒服，并且与照片柔和的光线相匹配</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ea031302f34e838e84a6c70e6dae8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=x9CK5CvWJgew8PU17gF0xYoRlAI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.2. 局部重绘</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided image, change only the [specific element] to [new
element/description]. Keep everything else in the image exactly the same,
preserving the original style, lighting, and composition.
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>使用提供的图片，仅将 <strong>[特定元素]</strong> 更改为 <strong>[新元素/描述]</strong> 。保持图片中的其他所有内容完全不变，保留原有的风格、光线和构图。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>“使用提供的客厅图片，只将蓝色沙发换成复古的棕色皮质切斯特菲尔德沙发。房间的其余部分，包括沙发上的抱枕和照明，保持不变。”</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d5128d86db6469d9057a023efee6447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=JUpXblvZKkAfIBBISVM17AXNjrE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">3.3. 风格迁移</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Transform the provided photograph of [subject] into the artistic style of [artist/art style]. Preserve the original composition but render it with [description of stylistic elements].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>将提供的 <strong>[主体]</strong> 照片转换为 <strong>[艺术家/艺术风格]</strong> 的艺术风格。保留原始构图，但用 <strong>[风格元素描述]</strong> 进行渲染。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>将所提供的现代城市街道夜景照片转换为文森特·梵高《星月夜》的艺术风格。保留建筑物和汽车的原始构图，但用旋转的厚涂笔触以及深邃的蓝色和明亮的黄色构成的富有戏剧性的色彩来呈现所有元素。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ea8bd5074c44428ccebd52ac46d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=o%2BwfYEzKuzLmXffuD08%2BCWuvZws%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">3.4. 高级合成</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Create a new image by combining the elements from the provided images. Take
the [element from image 1] and place it with/on the [element from image 2].
The final image should be a [description of the final scene].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>通过组合所提供图像中的元素来创建一幅新图像。提取 <strong>[图像 1 中的元素]</strong> ，并将其与 <strong>[图像 2 中的元素]</strong> 放在一起/置于 <strong>[图像 2 中的元素]</strong> 之上。最终图像应该是 <strong>[对最终场景的描述]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>创作一张专业的电商时尚照片。将第一张图片中的蓝色碎花连衣裙取出，让第二张图片中的女士穿上它。生成一张该女士穿着这条连衣裙的逼真全身照，并调整光影以匹配户外环境。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d005d97548b740a6a310539e87cf733a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=B6t5yNurupOk6dDTphD3AgK206M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">3.5. 高保真细节保留</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Using the provided images, place [element from image 2] onto [element from
image 1]. Ensure that the features of [element from image 1] remain
completely unchanged. The added element should [description of how the
element should integrate].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>使用提供的图像，将 <strong>[图像 2 中的元素]</strong> 放置到 <strong>[图像 1 中的元素]</strong> 上。确保 <strong>[图像 1 中的元素]</strong> 的特征完全不变。添加的元素应 <strong>[描述该元素应如何整合]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>选取第一张图片中那位有着棕色头发、蓝色眼睛且表情平和的女性。将第二张图片中的标志添加到她的黑色 T 恤上。确保这位女性的脸部及五官完全保持不变。该标志应看起来像是自然印在面料上的，要顺着衬衫的褶皱呈现。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c543894e525844d8b8949e3bb5a280b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=Hpdu%2BWDJBF%2Frd0f6Ky8V9iLJInM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">3.6. 草图变成品</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">Turn this rough [medium] sketch of a [subject] into a [style description]
photo. Keep the [specific features] from the sketch but add [new details/materials].
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>将这幅关于 <strong>[主题]</strong> 的粗略 <strong>[媒介]</strong> 草图转化为一张符合 <strong>[风格描述]</strong> 的照片。保留草图中的 <strong>[具体特征]</strong> ，但添加 <strong>[新细节/材料]</strong> 。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>把这幅未来汽车的铅笔草图变成展厅里成品概念车的精致照片。保留草图中的流畅线条和低矮轮廓，但要添加金属蓝色漆面和霓虹轮圈灯光。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c60237736224595bea248cc2b87d78c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=LQpuOY5037Sl%2BreVozycwEc5hbg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">3.7. 360 度全景</h3>
<p>英文模板为：</p>
<pre><code class="hljs language-plain" lang="plain">A studio portrait of [person] against [background], [looking forward/in profile looking right/etc.]
</code></pre>
<p>中文模板为：</p>
<blockquote>
<p>一幅 <strong>[人物]</strong> 的工作室肖像照，背景为 <strong>[背景]</strong> ， <strong>[人物]</strong> 面向前方/侧头向右看等。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>一张这位男士的工作室肖像照，背景为白色，他侧身向右看。</p>
</blockquote>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed36804f455143da919e74ade83c878f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765199164&amp;x-signature=6%2FJ70bpj90UELZbXrfbrs42UNcQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">4. 提示词最佳实践</h2>
<ul>
<li>**细节越多越好：**提供的信息越多，对输出结果的操控程度就越详细
<ul>
<li>❌ “奇幻的盔甲”</li>
<li>✅ “华丽的精灵板甲，刻着银叶图案，高领设计，带有猎鹰翅膀形状的肩甲”</li>
</ul>
</li>
<li>**提供上下文和意图说明：**模型对上下文的理解会影响最终输出
<ul>
<li>❌ “设计解决方案”</li>
<li>✅ “为极简护肤品牌设计解决方案”</li>
</ul>
</li>
<li><strong>不断迭代和优化</strong>：不要指望第一次尝试就能生成完美的图片，利用模型的对话特性进行小幅更改。
<ul>
<li>✅ “这很棒，但你能让光线更亮一些吗？”</li>
<li>✅ “保持所有内容不变，但让角色的表情更简洁一些。”</li>
</ul>
</li>
<li><strong>使用分步指令</strong>：对于包含多个元素的复杂场景，可以将提示拆分为多个步骤
<ul>
<li>✅ “首先，创造一个宁静、薄雾弥漫的黎明森林的背景。然后，在前景中添加一个长满苔藓的古老石祭坛。最后，将一把发光的剑祭坛放在顶部。”</li>
</ul>
</li>
<li><strong>语义化反向提示</strong>：
<ul>
<li>不要说“没有汽车”</li>
<li>而是通过“一条空无一人、没有任何交通迹象的街道”来正面描述所需的场景</li>
</ul>
</li>
<li><strong>控制镜头语言</strong>：使用摄影和电影语言来控制构图。例如<strong>广角、微距、低机位</strong>等术语</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端角度学 AI - 15 分钟入门 Python]]></title>    <link>https://juejin.cn/post/7578416583213645874</link>    <guid>https://juejin.cn/post/7578416583213645874</guid>    <pubDate>2025-12-01T08:55:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578416583213645874" data-draft-id="7577336346663583790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端角度学 AI - 15 分钟入门 Python "/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-01T08:55:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端角度学 AI - 15 分钟入门 Python 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T08:55:59.000Z" title="Mon Dec 01 2025 08:55:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    39
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文只是很基础的 python 最精华的语法入门，帮助前端同学使用 python 实现一些 ai 工具。有了这些基础，遇到不会的，问 ai 也能看懂 ai 给的答案，这是这篇文章的目的：结合 javascript，对比 python的基础用法，用最快的速度，上手 python，快速进入到实战，而不是纠结于基础语法！</p>
<p>最后我们会写一个用 python 调用 deepseek 大模型的微型 demo。</p>
<p>承接之前的前端学习 ai 系列文章:</p>
<ul>
<li><a href="https://juejin.cn/post/7573592127299108914" target="_blank" title="https://juejin.cn/post/7573592127299108914">打包票！前端和小白一定能明白的人工智能基础概念</a></li>
<li><a href="https://juejin.cn/post/7575162322241077248" target="_blank" title="https://juejin.cn/post/7575162322241077248">不易懂你打我！写给前端和小白的 大模型(ChatGPT) 工作基本原理！</a></li>
</ul>
<p>首先需要安装 <code>python</code>，大家可以直接问 ai。 因为我的 <code>macOS</code> 自带了 <code>python</code>，我就没有单独安装了（建议使用版本管理工具，例如 pyenv 管理多版本）。</p>
<p>ai agent 中， python 毕竟是最主流的语言，大家可以熟悉一下基本语法，实在太简单了, 大概花费时间如下：</p>
<ul>
<li>基本语法：5分钟</li>
<li>控制结果：2分钟</li>
<li>数据结构：5分钟</li>
<li>案例：3分钟</li>
</ul>
<h2 data-id="heading-1">基本语法</h2>
<h3 data-id="heading-2">变量的定义和命令规则</h3>
<p>因为实在太简单了，大家看注释就知道意思</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 变量的定义</span>
name = <span class="hljs-string">"Alice"</span>
age = <span class="hljs-number">25</span>
height = <span class="hljs-number">1.68</span>
is_student = <span class="hljs-literal">True</span>

<span class="hljs-comment"># 打印变量值</span>
<span class="hljs-built_in">print</span>(name)
<span class="hljs-built_in">print</span>(age)
<span class="hljs-built_in">print</span>(height)
<span class="hljs-built_in">print</span>(is_student)

name = <span class="hljs-string">"张三"</span>
<span class="hljs-built_in">print</span>(name)

<span class="hljs-comment"># 变量命名规则</span>
<span class="hljs-comment"># 简单理解跟 javascript 的差不多就行了</span>
<span class="hljs-comment"># 1. 变量名只能包含字母、数字、下划线</span>
<span class="hljs-comment"># 2. 变量名不能以数字开头</span>
<span class="hljs-comment"># 3. 变量名不能是 python 关键字</span>
</code></pre>
<h3 data-id="heading-3">数据类型</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 数字类型</span>
num1 = <span class="hljs-number">10</span> <span class="hljs-comment"># 整数(int)</span>
num2 = <span class="hljs-number">3.14</span> <span class="hljs-comment"># 浮点数 (float)</span>

<span class="hljs-comment"># 字符串类型 (str)</span>
name = <span class="hljs-string">"Alice"</span>
message = <span class="hljs-string">'Hello, world!'</span>

<span class="hljs-comment"># 布尔类型 （bool）</span>
is_student = <span class="hljs-literal">True</span>
is_working = <span class="hljs-literal">False</span>
</code></pre>
<p>这里注意：</p>
<ul>
<li>python 中的浮点数跟 javascript 的一致，都是双精度浮点数，占用 8字节，也就是 64 的内存。但同样的问题也有，就是都不精确，也就是会出现 0.1 + 0.2 不等于 0.3 的问题</li>
<li>然后字符串单引号很双引号是一样的效果，跟 javascript 一致</li>
<li>布尔类型不一样的是 python 中首字母大写。</li>
</ul>
<p>如何获取数据类型, 使用 type，跟 javascript typeof 操作符类似。</p>
<pre><code class="hljs language-python" lang="python">num1 = <span class="hljs-number">10</span> <span class="hljs-comment"># 整数(int)</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(num1))
</code></pre>
<h2 data-id="heading-4">类型转换</h2>
<p>跟javascript 中，使用 Number(xx) 转数字，使用 String() 转字符串类似。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 将字符串转换为整数</span>
num_str = <span class="hljs-string">"123"</span>
num_int = <span class="hljs-built_in">int</span>(num_str)
<span class="hljs-built_in">print</span>(num_int)

<span class="hljs-comment"># 将整数转为字符串</span>
num_int = <span class="hljs-number">456</span>
num_str = <span class="hljs-built_in">str</span>(num_int)
<span class="hljs-built_in">print</span>(num_str)

<span class="hljs-comment"># 将浮点数转换为整数（会丢失小数部分）</span>
num_float = <span class="hljs-number">3.14</span>
num_int = <span class="hljs-built_in">int</span>(num_float)
<span class="hljs-built_in">print</span>(num_int)
</code></pre>
<h2 data-id="heading-5">算数运算符</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加法</span>
result = <span class="hljs-number">10</span> + <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 减法</span>
result = <span class="hljs-number">10</span> - <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 乘法</span>
result = <span class="hljs-number">10</span> * <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 除法</span>
result = <span class="hljs-number">10</span> / <span class="hljs-number">5</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 取整除</span>
result = <span class="hljs-number">10</span> // <span class="hljs-number">3</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 取余</span>
result = <span class="hljs-number">10</span> % <span class="hljs-number">3</span>
<span class="hljs-built_in">print</span>(result)

<span class="hljs-comment"># 幂计算</span>
result = <span class="hljs-number">2</span> ** <span class="hljs-number">3</span>
<span class="hljs-built_in">print</span>(result)
</code></pre>
<p>跟 javascript 在取整除语法上有区别</p>
<ul>
<li>python 是 10 // 3</li>
<li>在 javascript 对应的是 Math.trunc(10 / 3)</li>
</ul>
<h2 data-id="heading-6">比较运算符</h2>
<p>这个没什么好说的，跟 javascript 基本一样，例如</p>
<ul>
<li>10 == 5, 10 != 5, 10 &gt; 5, 10 &gt;= 5 等等</li>
<li>注意 python 没有 === 和 !==</li>
</ul>
<h2 data-id="heading-7">逻辑运算符</h2>
<p>这个区别有点大，我们细细来讲：</p>
<h3 data-id="heading-8">逻辑与 (AND)</h3>
<p>python 用 and</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
x = <span class="hljs-number">5</span>
y = <span class="hljs-number">10</span>
<span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">20</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"两个条件都满足"</span>)  <span class="hljs-comment"># 会执行</span>
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript</span>
<span class="hljs-keyword">let</span> x = <span class="hljs-number">5</span>;
<span class="hljs-keyword">let</span> y = <span class="hljs-number">10</span>;
<span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span> &amp;&amp; y &lt; <span class="hljs-number">20</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"两个条件都满足"</span>);  <span class="hljs-comment">// 会执行</span>
}
</code></pre>
<h3 data-id="heading-9">逻辑或 (OR)</h3>
<p>python 用 or</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python</span>
name = <span class="hljs-string">""</span>
default_name = <span class="hljs-string">"Guest"</span>
display_name = name <span class="hljs-keyword">or</span> default_name
<span class="hljs-built_in">print</span>(display_name)  <span class="hljs-comment"># 输出: Guest</span>
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript</span>
<span class="hljs-keyword">let</span> name = <span class="hljs-string">""</span>;
<span class="hljs-keyword">let</span> defaultName = <span class="hljs-string">"Guest"</span>;
<span class="hljs-keyword">let</span> displayName = name || defaultName;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(displayName);  <span class="hljs-comment">// 输出: Guest</span>
</code></pre>
<h3 data-id="heading-10">逻辑非 (NOT)</h3>
<p>python 用 not，也就是没有 javascript 的 ! 操作符。</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-comment"># Python</span>
is_logged_in = <span class="hljs-literal">False</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_logged_in:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请先登录"</span>)  <span class="hljs-comment"># 会执行</span>
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// JavaScript</span>
<span class="hljs-keyword">let</span> isLoggedIn = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">if</span> (!isLoggedIn) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请先登录"</span>);  <span class="hljs-comment">// 会执行</span>
}
</code></pre>
<h2 data-id="heading-11">真假值判断差异</h2>
<h3 data-id="heading-12">Python 的假值：</h3>
<ul>
<li><code>False</code></li>
<li><code>None</code></li>
<li><code>0</code> (整数)</li>
<li><code>0.0</code> (浮点数)</li>
<li><code>""</code> (空字符串)</li>
<li><code>[]</code> (空列表)</li>
<li><code>()</code> (空元组)</li>
<li><code>{}</code> (空字典)</li>
<li><code>set()</code> (空集合)</li>
</ul>
<h3 data-id="heading-13">JavaScript 的假值：</h3>
<ul>
<li><code>false</code></li>
<li><code>0</code> (数字)</li>
<li><code>""</code> (空字符串)</li>
<li><code>null</code></li>
<li><code>undefined</code></li>
<li><code>NaN</code></li>
<li><code>0n</code> (BigInt)</li>
</ul>
<h2 data-id="heading-14">赋值运算符</h2>
<p>跟 javascript 一样，但注意没有 ++, -- 这种运算符。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 简单赋值</span>
x = <span class="hljs-number">10</span>

<span class="hljs-comment"># 加法赋值</span>
x += <span class="hljs-number">5</span>

<span class="hljs-comment"># 减法赋值</span>
x -= <span class="hljs-number">3</span>

<span class="hljs-comment"># 乘法赋值</span>
x *= <span class="hljs-number">2</span>

<span class="hljs-comment"># 除法赋值</span>

x /= <span class="hljs-number">4</span>
</code></pre>
<h2 data-id="heading-15">输入输出</h2>
<p>input 函数获取用户输入</p>
<pre><code class="hljs language-python" lang="python">name = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入你的名字"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"你好，"</span> + name + <span class="hljs-string">"!"</span>)
</code></pre>
<p>print() 函数打印内容</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"hello word!"</span>)
</code></pre>
<p>格式化输出,在 python 3.6 版本支持，跟前端的 `` 类似符号类似，python 使用的是 f。</p>
<ul>
<li>javascript 使用的是 ${} 嵌入变量, python 是 {} 嵌入变量</li>
</ul>
<pre><code class="hljs language-python" lang="python">name = <span class="hljs-string">"Charlie"</span>
age = <span class="hljs-number">35</span>
height = <span class="hljs-number">1.75</span>

<span class="hljs-comment"># 直接嵌入变量</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>) 
<span class="hljs-comment"># 输出：Hello, Charlie!</span>
</code></pre>
<h2 data-id="heading-16">if else 语句</h2>
<p>跟 javascript 有区别，但也很简单，请看示例</p>
<pre><code class="hljs language-python" lang="python">score = <span class="hljs-number">75</span>

<span class="hljs-keyword">if</span> score &gt;= <span class="hljs-number">90</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"优秀"</span>)
<span class="hljs-keyword">elif</span> score &gt;= <span class="hljs-number">70</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"良好"</span>)
<span class="hljs-keyword">elif</span> score &gt;= <span class="hljs-number">60</span>:
     <span class="hljs-built_in">print</span>(<span class="hljs-string">"及格"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"需努力"</span>);
</code></pre>
<ul>
<li><code>条件</code> 是一个会产生布尔值（<code>True</code> 或 <code>False</code>）的表达式。</li>
<li><strong>冒号 <code>:</code></strong>  是必须的，表示一个代码块的开始。</li>
<li><strong>缩进</strong>（通常是 4 个空格）是 Python 标识代码块的方式，<strong>绝对不能省略或混用</strong>。</li>
</ul>
<h2 data-id="heading-17">嵌套条件语句</h2>
<pre><code class="hljs language-python" lang="python">age = <span class="hljs-number">20</span>
has_license = <span class="hljs-literal">True</span>

<span class="hljs-keyword">if</span> age &gt;= <span class="hljs-number">18</span>:
    <span class="hljs-keyword">if</span> has_license:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"可以开车"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"不能开车"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"不能开车"</span>);
</code></pre>
<h2 data-id="heading-18">循环语句</h2>
<p>跟 javascript 区别还挺大，没有 javascript 的中括号。</p>
<p>for 循环语法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> 变量 <span class="hljs-keyword">in</span> 可迭代对象:
    <span class="hljs-comment"># 执行的代码块</span>
</code></pre>
<p>常用场景与示例：</p>
<p>遍历数组：</p>
<pre><code class="hljs language-python" lang="python">fruits = [<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"cherry"</span>]
<span class="hljs-keyword">for</span> fruit <span class="hljs-keyword">in</span> fruits: 
    `<span class="hljs-built_in">print</span>(fruit)
</code></pre>
<p>遍历字符串：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> <span class="hljs-string">"Hello"</span>:  
    <span class="hljs-built_in">print</span>(char)
</code></pre>
<p>遍历 range 。<code>range(n)</code> 生成一个从 0 到 n-1 的整数序列。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(i) // 输出：<span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span>
</code></pre>
<p>遍历字典（理解为javascript 的 {} 对象）</p>
<pre><code class="hljs language-python" lang="python">person = {<span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"age"</span>: <span class="hljs-number">25</span>}
<span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> person:
     <span class="hljs-built_in">print</span>(key, person[key])
</code></pre>
<p>while 循环语法</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">while</span> 条件:
    <span class="hljs-comment"># 执行的代码块</span>
</code></pre>
<p>基本案例：</p>
<pre><code class="hljs language-python" lang="python">count = <span class="hljs-number">0</span>

<span class="hljs-keyword">while</span> count &lt; <span class="hljs-number">5</span>:
    <span class="hljs-built_in">print</span>(count)
    count += <span class="hljs-number">1</span>
</code></pre>
<h2 data-id="heading-19">循环控制语句</h2>
<p>跟 javascript 一样。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># break 语句</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">5</span>:
        <span class="hljs-keyword">break</span>
    <span class="hljs-built_in">print</span>(i) // <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># break 语句</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-keyword">if</span> i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">continue</span>
    <span class="hljs-built_in">print</span>(i) // <span class="hljs-number">1</span> <span class="hljs-number">3</span> <span class="hljs-number">5</span> <span class="hljs-number">7</span> <span class="hljs-number">9</span>
</code></pre>
<h2 data-id="heading-20">数据结构</h2>
<p>Python 常见的数据结构有四种：</p>
<ul>
<li>列表 List: python语法：[1, 2, 'a']
<ul>
<li>相当于 javascript 的数组: [1, 2, 'a']</li>
</ul>
</li>
</ul>
<p>增加元素：</p>
<ul>
<li>通过 <code>append</code> 函方法，实现在尾部增加新元素。
<ul>
<li>javascript 是通过 <code>push</code> 方法。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python">l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
l.append(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(l)
</code></pre>
<p>删除元素：</p>
<ul>
<li>通过 <code>del</code> 关键字可以删除列表某个位置的元素
<ul>
<li>javascript 是通过 splice 方法</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python">l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
<span class="hljs-comment">## 删除首个</span>
<span class="hljs-keyword">del</span> l[<span class="hljs-number">0</span>]
<span class="hljs-comment">## 删除最后一个（也就是倒数第一的意思）</span>
<span class="hljs-keyword">del</span> l[-<span class="hljs-number">1</span>]
<span class="hljs-built_in">print</span>(l)
</code></pre>
<p>最后一个元素在 python 可以用 -1 表示。</p>
<p>查找元素：</p>
<pre><code class="hljs language-python" lang="python">l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
<span class="hljs-comment">## 查找首个</span>
<span class="hljs-built_in">print</span>(l[<span class="hljs-number">0</span>])
<span class="hljs-comment">## 查找最后一个</span>
<span class="hljs-built_in">print</span>(l[-<span class="hljs-number">1</span>])
<span class="hljs-comment">## 查找下标是 1 到 下标 2 的元素（不包括 3 所以到 2）</span>
<span class="hljs-built_in">print</span>(l[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]) <span class="hljs-comment"># [2, 3]</span>
</code></pre>
<p>修改元素</p>
<pre><code class="hljs language-python" lang="python">l = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]

l[<span class="hljs-number">0</span>] = -<span class="hljs-number">1</span>
<span class="hljs-built_in">print</span>(l)
</code></pre>
<p>接下来看第二个数据类型：元祖</p>
<ul>
<li>元祖 Tuple: (1, 2, 'a')
<ul>
<li>可以理解为就是列表，但是不能改。</li>
<li>javascript没有对应的，JS 中通常用数组代替，通过 <code>Object.freeze()</code> 模拟</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python">t = (<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)

t[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span> <span class="hljs-comment"># 报错，不能改</span>
</code></pre>
<p>但可以循环遍历元祖。</p>
<p>接下来看第三个数据类型：字典</p>
<ul>
<li>字典 Dict：{'a': 1, 'b': 2}
<ul>
<li>相当于 javascript 的 Object {a: 1, b: 2}</li>
<li>Python 键可以是任意不可变类型；JS 键会自动转为字符串。</li>
<li>Python 用 <code>dict[‘a’]</code>；JS 可用 <code>.</code> 或 <code>[]</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}


<span class="hljs-built_in">print</span>(ab)
</code></pre>
<p>字典支持以下操作：</p>
<ul>
<li>增：通过 <code>[]</code> 可以向字典内增加元素</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}

ab[<span class="hljs-string">"Third"</span>] = <span class="hljs-number">3</span>
<span class="hljs-built_in">print</span>(ab)
</code></pre>
<ul>
<li>删：通过 <code>del</code> 可以向字典内删除元素</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}

<span class="hljs-keyword">del</span> ab[<span class="hljs-string">"Second"</span>]
<span class="hljs-built_in">print</span>(ab)
</code></pre>
<ul>
<li>查：通过 <code>[]</code> 可以向字典内查询元素</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}

<span class="hljs-built_in">print</span>(ab[<span class="hljs-string">"Second"</span>])
</code></pre>
<p>还可以通过 in 关键字查找某个键是否在字典中</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}

<span class="hljs-built_in">print</span>(<span class="hljs-string">"Second"</span> <span class="hljs-keyword">in</span> ab) // <span class="hljs-literal">True</span>
</code></pre>
<ul>
<li>改：通过赋值符号 <code>=</code> 可以修改某个位置元素</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># key， 键，比如 First 和 Second 就是键</span>
<span class="hljs-comment"># value，值，比如 1 和 2 就是值</span>
ab = {
    <span class="hljs-string">"First"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"Second"</span>: <span class="hljs-number">2</span>
}

ab[<span class="hljs-string">"First"</span>] = <span class="hljs-number">3</span>
<span class="hljs-built_in">print</span>(ab) // <span class="hljs-literal">True</span>
</code></pre>
<ul>
<li>集合：Set：{1, 2, 3}
<ul>
<li>相当于 javascript 中的 Set, new Set([1, 2, 3]),也就是不存在重复的元素</li>
</ul>
</li>
</ul>
<p>注意集合是没有顺序，所以不能像列表那样通过下标查找</p>
<p>增加元素：</p>
<pre><code class="hljs language-python" lang="python">s = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
<span class="hljs-comment"># 增加新的元素到集合中</span>
s.add(<span class="hljs-number">6</span>)
<span class="hljs-built_in">print</span>(s)
</code></pre>
<p>删除元素：</p>
<pre><code class="hljs language-python" lang="python">s = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
<span class="hljs-comment"># 增加新的元素到集合中</span>
s.remove(<span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(s)
</code></pre>
<p>查找是否元素在集合中：</p>
<pre><code class="hljs language-python" lang="python">s = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
<span class="hljs-comment"># 增加新的元素到集合中</span>
<span class="hljs-built_in">print</span>(<span class="hljs-number">3</span> <span class="hljs-keyword">in</span> s)  <span class="hljs-comment"># True</span>
</code></pre>
<p>我们还可以求集合的交集，并集，差集</p>
<pre><code class="hljs language-python" lang="python">s1 = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
s2 = {<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>}

<span class="hljs-built_in">print</span>(s1 &amp; s2) <span class="hljs-comment"># 交集 {2,3}</span>
</code></pre>
<pre><code class="hljs language-python" lang="python">s1 = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
s2 = {<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>}

<span class="hljs-built_in">print</span>(s1 | s2) <span class="hljs-comment"># 并集 {1,2,3,4}</span>
</code></pre>
<pre><code class="hljs language-python" lang="python">s1 = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>}
s2 = {<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>}

<span class="hljs-built_in">print</span>(s1 ^ s2) <span class="hljs-comment"># 差集 {1,4}</span>
</code></pre>
<h2 data-id="heading-21">函数</h2>
<p>使用 <code>def</code> 关键字定义，javascript 是使用 function 关键字。</p>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-built_in">print</span>(greet(<span class="hljs-string">'ZhangSan'</span>)) <span class="hljs-comment"># Hello, ZhangSan</span>
</code></pre>
<p>注意 python 能返回多个值，我们举例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_and_subtract</span>(<span class="hljs-params">x, y</span>):
    <span class="hljs-keyword">return</span> x+y, x-y

<span class="hljs-built_in">sum</span>,diff = add_and_subtract(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">sum</span>, diff) <span class="hljs-comment"># 15 5</span>
</code></pre>
<p>同样 python 有作用域的概念，在函数里的属于局部变量。</p>
<h2 data-id="heading-22">匿名函数：Lambda 函数</h2>
<p>有点像 javascript 中的箭头函数，是一种语法糖，能够快速定义函数</p>
<pre><code class="hljs language-python" lang="python">add = <span class="hljs-keyword">lambda</span> x, y: x + y <span class="hljs-comment"># 定义一个传参是 x,y 结果是和的函数</span>

<span class="hljs-built_in">print</span>(add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-comment"># 2</span>
</code></pre>
<p>上面的 lambda 函数相当于</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a+b

<span class="hljs-built_in">print</span>(add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)) <span class="hljs-comment"># 2</span>
</code></pre>
<h2 data-id="heading-23">函数作为参数传递</h2>
<p>python 也支持将函数作为参数传给一个函数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_function</span>(<span class="hljs-params">func, value</span>):
    <span class="hljs-keyword">return</span> func(value)

<span class="hljs-built_in">print</span>(apply_function(<span class="hljs-keyword">lambda</span> x: x * x, <span class="hljs-number">5</span>)) <span class="hljs-comment"># 25</span>
</code></pre>
<h2 data-id="heading-24">Python 模块介绍</h2>
<ul>
<li>模块是包含代码的文件，以单独命名空间组织逻辑，便于复用与维护</li>
<li>一个 .py 文件就是一个模块，模块名为文件名（不含扩展名）</li>
<li>导入后通过模块命名空间访问其函数、类、变量，避免命名冲突</li>
</ul>
<p>例如，我们创建一个模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># utils.py</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> a + b
PI = <span class="hljs-number">3.14159</span>
</code></pre>
<p>使用</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> utils
<span class="hljs-built_in">print</span>(utils.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
<span class="hljs-built_in">print</span>(plus(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<p>我们还可以使用模块别名，跟 javascript 类似, 也是 as 关键字</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> utils <span class="hljs-keyword">as</span> util <span class="hljs-comment"># utils 别名改为 util</span>
<span class="hljs-built_in">print</span>(util.add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<p>还有一种 from ... import  可以导入模块语法如下</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入整个模块（不建议这么做）</span>
<span class="hljs-keyword">from</span> module_name <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 导入特定函数/类/变量</span>
<span class="hljs-keyword">from</span> module_name <span class="hljs-keyword">import</span> function_name, ClassName, variable_name

<span class="hljs-comment"># 导入并重命名</span>
<span class="hljs-keyword">from</span> module_name <span class="hljs-keyword">import</span> original_name <span class="hljs-keyword">as</span> alias_name
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> math

<span class="hljs-comment"># 使用时需要前缀</span>
result = math.sqrt(<span class="hljs-number">25</span>)
<span class="hljs-built_in">print</span>(math.pi)
<span class="hljs-built_in">print</span>(math.sin(math.radians(<span class="hljs-number">90</span>)))
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入多个特定项目</span>
<span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> sqrt, pi, sin, cos

<span class="hljs-built_in">print</span>(sqrt(<span class="hljs-number">9</span>))      <span class="hljs-comment"># 3.0</span>
<span class="hljs-built_in">print</span>(pi)           <span class="hljs-comment"># 3.141592653589793</span>
<span class="hljs-built_in">print</span>(sin(pi/<span class="hljs-number">2</span>))    <span class="hljs-comment"># 1.0</span>
</code></pre>
<h2 data-id="heading-25">python 内置模块</h2>
<ul>
<li>
<p>os 模块：文件和目录操作</p>
<ul>
<li>类似于 node.js 的 fs 模块</li>
</ul>
</li>
<li>
<p>random 模块：生成随机数</p>
<ul>
<li>javascript 原生只有 Math,random 方法</li>
</ul>
</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-built_in">print</span>(os.getcwd()) <span class="hljs-comment"># 获取当前命令执行的目录</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random
<span class="hljs-built_in">print</span>(random.randint(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>)) <span class="hljs-comment"># 获取包括1到10中的一个随机整数</span>
</code></pre>
<h2 data-id="heading-26">python 面相对象编程</h2>
<h3 data-id="heading-27">类与对象</h3>
<p>废话不多说，直接上一个 javascript 的类和 python 相同的类，你就明白了</p>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-comment"># 构造函数</span>
    <span class="hljs-comment"># self 相当于 javascript 中的 this</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age
        self._private_var = <span class="hljs-string">"internal"</span>  <span class="hljs-comment"># 约定为私有（实际仍可访问）</span>
    
    <span class="hljs-comment"># 实例方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, I'm <span class="hljs-subst">{self.name}</span>"</span>
    
    <span class="hljs-comment"># 类方法</span>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_birth_year</span>(<span class="hljs-params">cls, name, birth_year</span>):
        <span class="hljs-keyword">import</span> datetime
        age = datetime.datetime.now().year - birth_year
        <span class="hljs-keyword">return</span> cls(name, age)
    
    <span class="hljs-comment"># 静态方法</span>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_adult</span>(<span class="hljs-params">age</span>):
        <span class="hljs-keyword">return</span> age &gt;= <span class="hljs-number">18</span>
    
    <span class="hljs-comment"># 属性装饰器</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adult</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self.age &gt;= <span class="hljs-number">18</span>
    
<span class="hljs-meta">    @adult.setter</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adult</span>(<span class="hljs-params">self, value</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Cannot directly set adult status"</span>)
</code></pre>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript 类定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    class_attr = <span class="hljs-string">"类属性"</span>  # 类属性
  
    <span class="hljs-comment">// 构造函数</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateVar</span> = <span class="hljs-string">"internal"</span>;  <span class="hljs-comment">// 约定为私有</span>
    }
    
    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>;
    }
    
    <span class="hljs-comment">// 静态方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">fromBirthYear</span>(<span class="hljs-params">name, birthYear</span>) {
        <span class="hljs-keyword">const</span> age = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getFullYear</span>() - birthYear;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(name, age);
    }
    
    <span class="hljs-comment">// Getter</span>
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">adult</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> &gt;= <span class="hljs-number">18</span>;
    }
    
    <span class="hljs-comment">// Setter</span>
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">adult</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Cannot directly set adult status"</span>);
    }
}
</code></pre>
<p>如何实例化呢，python 不用 new，就像函数一样调用</p>
<pre><code class="hljs language-python" lang="python">person1 = Person(<span class="hljs-string">"张三"</span>, <span class="hljs-number">30</span>)
person1.greet()
</code></pre>
<p>这里需要注意：</p>
<ul>
<li>person1._privateVar 是得不到值 "internal"的，这是 python 内部的一种名称修饰机制，下划线属性或者函数，实例是不能直接访问到的，只能通过 实例名._类名._属性名访问，也就是 <code>person1._Person._privateVar</code> 访问到</li>
<li>@classmethod 在 python 中用来定义类方法，这里不能访问 <code>self</code>。 也就是 javascript 中的 <code>this</code></li>
<li>@staticmethod 在 python 中用来静态方法，不能访问实例（self）或者类，跟javascript 一致。</li>
<li>通过@property 装饰器定义 get 方法，通过 <code>@属性名.setter</code> 定义 setter 方法。这个跟javascript 区别还是挺大的。</li>
</ul>
<p>接下来看下面相对象的 3 个特征，在 python 中如何实现的</p>
<p>第一个是封装：</p>
<p>封装是将数据和操作数据的方法绑定在一起，隐藏内部实现细节，只暴露必要的接口。</p>
<p>对于 python 我们知道如何定义私有属性，共有属性即可</p>
<p>实现一个简单的示例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, balance</span>):
        self._balance = balance <span class="hljs-comment"># _balance 是私有属性</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">self, amount</span>):
        self._balance += amount
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">self, amount</span>):
        <span class="hljs-keyword">if</span> self._balance &gt;= amount:
            selef._balance -= amount
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"not enough"</span>)
           
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_balance</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self._balance
 
account = BankAccount(<span class="hljs-number">100</span>)
account.deposit(<span class="hljs-number">50</span>)
<span class="hljs-built_in">print</span>(account.get_balance()) // <span class="hljs-number">150</span>
</code></pre>
<p>接着看继承特性</p>
<p>感觉很有 javascript 的既视感。。。。，也是调用父类的构造函数，完成子类的属性和方法的继承。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 父类（基类）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">eat</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 正在吃东西"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 正在睡觉"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 发出声音"</span>)

<span class="hljs-comment"># 子类（派生类）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-title class_ inherited__">Animal</span>):  <span class="hljs-comment"># 继承Animal类</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, breed</span>):
        <span class="hljs-built_in">super</span>().__init__(name)  <span class="hljs-comment"># 调用父类的构造函数</span>
        self.breed = breed  <span class="hljs-comment"># 子类特有的属性</span>
    
    <span class="hljs-comment"># 重写父类方法（多态）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 汪汪叫！"</span>)
    
    <span class="hljs-comment"># 子类特有的方法</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{self.name}</span> 正在接飞盘"</span>)

<span class="hljs-comment"># 使用</span>
dog = Dog(<span class="hljs-string">"旺财"</span>, <span class="hljs-string">"金毛"</span>)
dog.eat()         <span class="hljs-comment"># 继承自父类</span>
dog.sleep()       <span class="hljs-comment"># 继承自父类</span>
dog.make_sound()  <span class="hljs-comment"># 重写的方法</span>
dog.fetch()       <span class="hljs-comment"># 子类特有的方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"品种: <span class="hljs-subst">{dog.breed}</span>"</span>)
</code></pre>
<p>最后就是多态了，多态允许不同类的对象调用相同的方法时，表现不同的行为。python 通过方法重写来实现多态。</p>
<p>其实这个不用太关心，跟 javascript 类似, 也是通过方法重写来实现多态。实际上多态一般是在有类型的语言里比较适合，比如 typescript 可以实现对传参类型的不同（重载），声明不同的函数类型来实现多态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 抽象方法，由子类实现</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-title class_ inherited__">Animal</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"汪汪汪！"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-title class_ inherited__">Animal</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"喵喵喵！"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bird</span>(<span class="hljs-title class_ inherited__">Animal</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_sound</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"啾啾啾！"</span>

<span class="hljs-comment"># 多态：同一接口，不同行为</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">animal_sound</span>(<span class="hljs-params">animal</span>):
    <span class="hljs-string">"""这个函数不知道具体的动物类型，只知道它会叫"""</span>
    <span class="hljs-keyword">return</span> animal.make_sound()

<span class="hljs-comment"># 创建不同的动物对象</span>
animals = [Dog(), Cat(), Bird()]

<span class="hljs-comment"># 统一调用相同的方法</span>
<span class="hljs-keyword">for</span> animal <span class="hljs-keyword">in</span> animals:
    <span class="hljs-built_in">print</span>(animal_sound(animal))
    
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 汪汪汪！</span>
<span class="hljs-comment"># 喵喵喵！</span>
<span class="hljs-comment"># 啾啾啾！</span>
</code></pre>
<h2 data-id="heading-28">调用 deepSeek 案例</h2>
<h2 data-id="heading-29">1. 安装必要的库</h2>
<p>在命令行/终端中输入：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">pip install openai
</code></pre>
<h2 data-id="heading-30">2.申请 apikey</h2>
<p>注意，要充值。。。可以自己充值 10 元，对于我们学来说，可以用很久很久了，当然你也可以充值 openai（chatgpt），用法是一模一样的，都兼容 openai 的 api,</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b0372524b749b698a0bf951d0f230e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186254&amp;x-signature=LaGaegVyY2870yQJVUbi%2F8F8WdQ%3D" alt="image.png" loading="lazy"/></p>
<p>创建好后，复制这个 key, 后面要用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f009fe275c7547eea0946a88302185e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186254&amp;x-signature=5KIu0Qb3nbIYcEI2SKEdlN1KKPs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-31">3. 最简单的代码（复制粘贴就能用）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 文件名：simple_deepseek.py</span>
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 1. 替换成你的DeepSeek API密钥</span>
<span class="hljs-comment"># 获取地址：https://platform.deepseek.com/api_keys</span>
api_key = <span class="hljs-string">"sk-你的API密钥在这里"</span>

<span class="hljs-comment"># 2. 连接到DeepSeek</span>
client = OpenAI(
    api_key=api_key,
    base_url=<span class="hljs-string">"https://api.deepseek.com"</span>
)

<span class="hljs-comment"># 3. 问一个问题</span>
response = client.chat.completions.create(
    model=<span class="hljs-string">"deepseek-chat"</span>,  <span class="hljs-comment"># 使用免费模型</span>
    messages=[
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，用一句话介绍你自己"</span>}
    ]
)

<span class="hljs-comment"># 4. 打印回答</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"AI回答:"</span>, response.choices[<span class="hljs-number">0</span>].message.content)
</code></pre>
<h2 data-id="heading-32">4.运行脚本</h2>
<pre><code class="hljs language-bash" lang="bash">python3 simple_deepseek.py
</code></pre>
<p>以下是我调用的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/214d9e88dc414205bccf021421d6b496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765186254&amp;x-signature=GFmnbyf6LY4RF9OmoRGxvtR32xg%3D" alt="image.png" loading="lazy"/></p>
<p>最后如果你也学习跟前端相关的 ai 知识，还有学习 headless 组件库教程，node.js全栈（next.js, nest.js）欢迎加入我们交流群。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.frontlight.tech%2F" target="_blank" title="https://www.frontlight.tech/" ref="nofollow noopener noreferrer">我的组件库官网</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flio-mengxiang%2Ft-ui" target="_blank" title="https://github.com/lio-mengxiang/t-ui" ref="nofollow noopener noreferrer">求 github star</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个人就是一支队伍：从 Next.js 到显示器，聊聊我的“全栈续航”方案]]></title>    <link>https://juejin.cn/post/7578198815729762304</link>    <guid>https://juejin.cn/post/7578198815729762304</guid>    <pubDate>2025-12-01T07:20:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578198815729762304" data-draft-id="7577718777481855014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个人就是一支队伍：从 Next.js 到显示器，聊聊我的“全栈续航”方案"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-12-01T07:20:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个人就是一支队伍：从 Next.js 到显示器，聊聊我的“全栈续航”方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T07:20:15.000Z" title="Mon Dec 01 2025 07:20:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前写完那篇 <a href="https://juejin.cn/post/7564921269491580943" target="_blank" title="https://juejin.cn/post/7564921269491580943">《Next.js 零成本全栈出海》</a> 的文章后，很多人问的不是技术细节，而是一个很现实的问题：“你一个人搞全栈，又要写码又要运维又要搞 AI，身体和眼睛怎么顶得住？”</p>
<p>说实话，顶不住是常态。</p>
<p>独立开发最难的不是技术栈，而是<strong>续航</strong>。大厂有轮岗，我们没有。如果说 Next.js 是武器，那每天面对的工作环境就是后勤。最近为了适应 AI 辅助编程的节奏，我把软硬件环境做了一次大调整。</p>
<p>今天不聊虚的，分享一下我是怎么把这套“不仅费脑子，还巨费眼睛”的工作流理顺的。</p>
<h2 data-id="heading-0">当我不“写”代码之后</h2>
<p>这一年，我从单纯的“敲代码”，被迫变成了一个“看代码”的人。这直接改变了我的软件选择，现在有一个新词挺贴切的：<strong>AI 善后工程师</strong>。</p>
<h3 data-id="heading-1">被 AI 倒逼的工作流</h3>
<p>我现在的主力环境是 <strong>Next.js + Claude Code / TRAE SOLO</strong>。</p>
<p>以前写一个带鉴权的 API，我得手搓 40 分钟。现在用 <strong>Claude Code</strong> 或者 <strong>TRAE</strong> 的 SOLO 模式，也就是两三句话的事：</p>
<blockquote>
<p>“基于 Prisma Schema 生成 API，带 Zod 校验和测试文件，写完之后生成 openAPI 格式的接口文档。”</p>
</blockquote>
<p>AI 几秒钟就能把代码甩到我脸上。效率确实是 10 倍提升。</p>
<h3 data-id="heading-2">“信息过载”的痛点</h3>
<p>以前写代码，屏幕上只有当前光标附近的几十行。</p>
<p>现在跟 AI 结对编程，屏幕上是爆发的信息流：</p>
<ol>
<li><strong>Prompt 很长</strong>：为了准确，上下文往往几百字。</li>
<li><strong>AI 废话多</strong>：它会解释一堆逻辑（虽然后来我都跳过不看）。</li>
<li><strong>代码量大</strong>：以前一行行写，现在是一屏屏出。</li>
</ol>
<p>相信用过的都懂，这种刷屏速度，与其说是写代码，不如说是在做“代码阅读理解”。我发现最累的不是思考逻辑，而是疯狂划触摸板。要在 Prompt、AI 的解释、生成的代码、以及 Git Diff 之间来回反复横跳。为了不被 AI 的信息流淹没，我总结了三条“AI 善后”的生存法则：</p>
<h4 data-id="heading-3">1.让编译器当第一道“防波堤”</h4>
<p>以前我写代码是“构思 -&gt; 编码 -&gt; 运行”。现在流程变了，变成了“Prompt -&gt; 生成 -&gt; <strong>看报错</strong>”。 由于 AI 生成速度极快，我养成了一个习惯：<strong>绝对不先看代码逻辑，而是先看</strong> <strong>TypeScript</strong> <strong>报错。</strong> 如果是 <code>Next.js</code> 项目，我会在 Prompt 里强制要求：“<strong>生成代码后，请确保通过</strong> <strong>ESLint</strong> <strong>和 TypeScript 严格模式检查，不要使用</strong> <strong><code>any</code></strong>。” 如果在 <code>TRAE</code> 或 <code>Claude Code</code> 里看到生成完有红线，直接甩回一句“Fix type errors”，看都不要看。让机器去对付机器，人的精力只留给用来审视业务逻辑，而不是帮 AI 查语法。</p>
<h4 data-id="heading-4">2.学会“静音”指令</h4>
<p>Claude 和 GPT 最大的毛病就是“好为人师”。明明只改了一行配置，它非要给你写一篇 500 字的小作文解释原理。 对于全栈开发者来说，屏幕空间寸土寸金。我现在常用的 Prompt 结尾都会带上一句：</p>
<blockquote>
<p><em>"No verbal explanation, just code blocks. If explanation is needed, use comments in code."</em> （<strong>不要废话，只给代码。如果有必要解释，写在注释里。</strong> ） 这样能把屏幕的有效信息密度提升 30%，大大减少滚轮滑动的距离。</p>
</blockquote>
<h4 data-id="heading-5">3.“增量式”的上下文投喂</h4>
<p>很多时候 AI 开始胡言乱语，是因为我们把整个文件都丢给了它。 <code>Claude Code</code> 和 <code>TRAE</code> 的优势在于它们能读取本地文件，但我发现**“少即是多”**。 在修改一个 API 时，我只把 <code>schema.prisma</code> 和当前的 <code>route.ts</code> 喂给它，坚决不让它读取无关的 <code>Components</code>。限制它的视野，不仅能减少 Token 消耗，更能防止它产生幻觉，改了不该改的地方——这在后期的 Code Review 简直是灾难。</p>
<p><strong>但即使做好了这些软件层面的优化，物理层面的瓶颈依然存在。</strong> 这就回到了我前面说的问题：当我对 AI 进行了层层“调教”后，它吐出的代码依然是爆发式的。 这时我发现，限制效率的不再是手速，而是屏幕的“显示行数”</p>
<h2 data-id="heading-6">新显示器的使用体验</h2>
<p>为了解决“划触摸板划到手酸”和“看 Diff 看到眼瞎”的问题，我准备换个显示器，于是我把问题抛给了 Gemini，习惯了 AI 不离手之后，日常有问题第一个想到的就是他。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf81ed5cb2884eedb3d58e6e0d35a77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=2O5kjP2fMnGPcwYqzGeroAexeWc%3D" alt="" loading="lazy"/></p>
<p>看他吹得这么神，我决定试试水：<strong>明基 BenQ RD280U</strong>。</p>
<p>用了一段时间，还是有点不一样的感受的。先说结论：它不是什么“完美神屏”，它就是专门给写代码的人做的一个偏科生。</p>
<h3 data-id="heading-7">3:2 比例：为了多看那十几行</h3>
<p>拿到这块屏第一感觉是“方”。它不是常见的 16:9，而是 <strong>3:2</strong>。如果你拿它看电影，上下会有大黑边，体验一般。但如果你是写代码的，这个比例真的舒服。逻辑通常是纵向流动的。在自带的屏幕上，由于高度的问题，只能展示 256-290 区间的代码行数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84050e1ba34b4206b7500f4439f462b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=2yonJSW8BwbWTERY9nwtVv00PxU%3D" alt="" loading="lazy"/></p>
<p>在 RD280U (3840x2560) 上，我能在同样的编辑器、同样的配置下，显示 256-307 区间的代码行数 。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3482c78ba6be4f81b6cd98dca3aefc89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=G3EDAfb2%2FTq83jaquD5UkCJVBik%3D" alt="" loading="lazy"/></p>
<p>少滑动几次触摸板，对保持思路连贯性真的挺重要。多出来的这 18.5% 纵向空间，就是给“上下文”留的。看到这里，肯定有老哥会说：“想要纵向空间，我直接把副屏竖起来不就行了？”我以前也是这么干的，但在 AI 时代，这招不好使了。</p>
<p><strong>第一，竖屏是“颈椎杀手”。</strong> 27 寸的 16:9 竖起来像座塔。看头部代码要仰头，看底部终端要低头，这种高频的“点头运动”比看横屏累得多。3:2 是在不需要大幅度动脖子的情况下，人眼能覆盖的最佳纵向视野。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e652cbd6551c45cd8abfee8e322b5233~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=RNA1CTXi5Lwti672ynoedpjsYs8%3D" alt="" loading="lazy"/></p>
<p><strong>第二，也是更关键的：AI 需要“宽度”。</strong> 以前竖屏好用，是因为我们只写代码。现在用 TRAE SOLO，左边任务栏，中间偏左挂着一个 AI Chat ，中间偏右是代码区域，最右边是代码结构目录。现在是 Mac 自带显示器的展示效果， 如果是 16:9 的竖屏，这是人类能看的？阅读体验极差。</p>
<p><strong>3:2 的妙处就在于：它够高，能装下长逻辑；它也够宽，能在挂着 AI 侧边栏的同时，保证主代码区不折行。</strong></p>
<h3 data-id="heading-8">终于能看清 Dark Mode 了</h3>
<p>这是他的第二个优点。</p>
<p>程序员 90% 的时间都在用 Dark Mode。自带的显示器或者我之前在公司用的普通外置显示器，通病是黑得不纯，有点发灰。加上 IDE 里那些深蓝、深灰的语法高亮，混在一起非常累眼，尤其是在找 Bug 或者看 Diff 的时候。RD280U 有个 Coding Mode，专门调过对比度。简单说，就是把背景压得更黑，把变量名、关键字的亮度提上来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9273b2b5ffae4e8581e411be3b769b24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=dkE7nLL3f5lfB%2FtUWyEQsmozfVI%3D" alt="" loading="lazy"/></p>
<p>一看对比还是挺明显的，Mac 显示器有点发白（在我的印象里，Mac 的显示器能秒杀市面上 98% 的显示器）。这不是什么玄学，调整了代码系列参数后，对比度和其他参数更适合呈现语法高亮，眼睛不用费劲去对焦。在快速 Review AI 生成的那一堆代码时，这种清晰度能帮我更快地扫一眼他生成的代码逻辑。</p>
<h3 data-id="heading-9">关于“护眼”：背光不是为了耍帅</h3>
<p>独立开发经常熬夜，我习惯关灯写代码（虽然医生不建议）。</p>
<p>在正常的情况下，关灯后屏幕太亮，开灯屏幕又有反光。</p>
<p>不过，这台显示器后面带个叫 <strong>MoonHalo</strong> 的背光灯。这东西真不是为了搞电竞 RGB 光效，它其实是做<strong>偏差照明</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/073b9171c0ab4befaaadbf8138684ff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=4%2BPnnYuMerHjQ4nXLPSKYj1cVp4%3D" alt="" loading="lazy"/></p>
<p>你敢信这是没开房间灯的场景？原理很简单：在屏幕后面补点光，减少屏幕和周围环境的亮度反差，眼睛就不会那么容易酸。配合它的 <strong>雾面屏</strong>（抗反光做得确实不错，加了德国莱茵认证的抗反射图层，光源分散情况和普通屏幕对比非常明显），现在深夜写代码，至少不会感觉是在盯着一个手电筒看。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8019afa261a45a8a34bb1d7e6ee427c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=fZZKqRGJluDMoavGyQ0qRKruP1g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">Display Pilot 2 的妙用</h3>
<p>作为一个被 Mac 惯坏的用户，我最烦的就是去摸显示器背后那几个“反人类”的实体按键——永远分不清哪个是确认，哪个是返回。</p>
<p>这款显示器最让我惊喜的是它的配套软件（Display Pilot 2）。安装后，它就像 Mac 的原生“控制中心”一样 。</p>
<p><strong>你完全可以在系统里直接调节屏幕亮度、对比度，甚至切换显示模式。</strong> 比如白天写代码用“Coding - 深色主题”模式，晚上看文档切换到“电子书”模式，只需要鼠标点一下，不用起身，也不用盲操作。</p>
<p>看截图就能感受到，这种把硬件参数“软件化”的操作，才符合程序员追求的高效直觉。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a877cd70ca2429d839a1706b9d1e94c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765178414&amp;x-signature=uOiOYf9FjCG4zRQC%2BfClC5a9dcE%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">总结</h3>
<p>这套“Next.js + Vibe Coding + 方屏显示器”的组合，就是我现在应对高强度开发的方案。</p>
<p><strong>Claude Code / TRAE SOLO 帮我省了手速，显示器帮我省了眼力。</strong></p>
<p>BenQ RD280U 这东西，优缺点很明显：</p>
<ul>
<li><strong>缺点</strong>：看电影有黑边，玩游戏视野不够广，价格也不算便宜。</li>
<li><strong>优点</strong>：写代码、看文档、看网页，只要是纵向阅读的内容，体验确实比宽屏好太多。</li>
</ul>
<p>如果你也是那种一天要在 IDE 里泡 8-10 个小时以上的开发者，我的建议是换个好点的显示器。</p>
<p>毕竟代码可以重构，视力不可逆。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《终章：从 Vite 专用到全构建工具生态 - 我的字体插件如何征服 Webpack、Rollup 全栈》]]></title>    <link>https://juejin.cn/post/7578161740467175475</link>    <guid>https://juejin.cn/post/7578161740467175475</guid>    <pubDate>2025-12-01T01:25:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578161740467175475" data-draft-id="7578029829997363250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《终章：从 Vite 专用到全构建工具生态 - 我的字体插件如何征服 Webpack、Rollup 全栈》"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-01T01:25:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="特级业务专家"/> <meta itemprop="url" content="https://juejin.cn/user/2101921961481512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《终章：从 Vite 专用到全构建工具生态 - 我的字体插件如何征服 Webpack、Rollup 全栈》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921961481512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    特级业务专家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T01:25:27.000Z" title="Mon Dec 01 2025 01:25:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    74
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📝 续写第三篇：从单工具到多生态的跨越</h2>
<hr/>
<h3 data-id="heading-1">📊 文章完整内容</h3>
<blockquote>
<p>前情回顾：在上一篇《续集：Vite 字体插件重构之路》中，我们完成了从"能用"到"生产级稳定"的重构，插件在 Vite 生态中已经相当成熟。但故事远未结束...</p>
</blockquote>
<h3 data-id="heading-2">一、新的挑战：用户的需求不止 Vite</h3>
<h4 data-id="heading-3">1.1 真实用户反馈</h4>
<p>插件发布后，我收到了各种有趣的需求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Webpack 用户</span>
<span class="hljs-string">"大佬，我们项目还在用 Webpack 5，能用你的插件吗？"</span>

<span class="hljs-comment">// Rollup 用户  </span>
<span class="hljs-string">"我们在做组件库，用 Rollup 打包，字体优化有方案吗？"</span>

<span class="hljs-comment">// 国外开发者</span>
<span class="hljs-string">"Great plugin! Any plan for Rspack support?"</span>
</code></pre>
<p>这些反馈让我意识到：<strong>字体优化是所有前端项目的共同痛点，不应该被某个构建工具限制。</strong></p>
<h4 data-id="heading-4">1.2 技术债务的显现</h4>
<p>当时的 v0.3.x 版本有个根本问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/index.js - 职责混合的典型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fontSubsetPlugin</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-comment">// Vite 特定的生命周期钩子</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-font-subset'</span>,
    <span class="hljs-title function_">buildBegin</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* Vite 专用逻辑 */</span> }
  }
}
</code></pre>
<p><strong>核心矛盾</strong>：所有逻辑都和 Vite 深度耦合，无法复用到其他构建工具。</p>
<h3 data-id="heading-5">二、架构重构：核心库 + 共享层 + 适配器模式</h3>
<h4 data-id="heading-6">2.1 设计哲学的转变</h4>
<p>我重新思考了插件的设计哲学：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 旧思路：Vite 为中心的单体架构</span>
<span class="hljs-title class_">Vite</span> <span class="hljs-title class_">Plugin</span> ──&gt; 字体处理逻辑

<span class="hljs-comment">// ✅ 新思路：构建工具无关的分层架构</span>
<span class="hljs-title class_">Core</span> <span class="hljs-title class_">Library</span> ──&gt; <span class="hljs-title class_">Shared</span> <span class="hljs-title class_">Logic</span> ──&gt; <span class="hljs-title class_">Adapters</span>
</code></pre>
<h4 data-id="heading-7">2.2 三层架构设计</h4>
<p>经过反复推敲，最终确定了这样的架构：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── core/subsetFont.js          <span class="hljs-comment"># 字体子集化核心库</span>
├── shared/                     <span class="hljs-comment"># 各构建工具共享逻辑</span>
│   ├── scanner.js             <span class="hljs-comment"># 字符扫描模块</span>
│   ├── css-generator.js       <span class="hljs-comment"># CSS 生成模块</span>
│   └── utils.js               <span class="hljs-comment"># 通用工具函数</span>
├── adapters/                   <span class="hljs-comment"># 构建工具适配器</span>
│   ├── vite/index.js          <span class="hljs-comment"># Vite 插件</span>
│   ├── webpack/index.js       <span class="hljs-comment"># Webpack 插件</span>
│   └── rollup/index.js        <span class="hljs-comment"># Rollup 插件</span>
└── index.js                    <span class="hljs-comment"># 主入口</span>
</code></pre>
<p><strong>核心思想</strong>：</p>
<ul>
<li><strong>Core Library</strong>：纯算法，与构建工具无关</li>
<li><strong>Shared Logic</strong>：通用业务逻辑，可复用</li>
<li><strong>Adapters</strong>：薄薄的一层适配，专注生命周期集成</li>
</ul>
<h4 data-id="heading-8">2.3 核心库的抽象过程</h4>
<p>最关键的是把字体子集化的核心逻辑抽离出来：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// core/subsetFont.js - 构建工具无关的纯函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">subsetFont</span>(<span class="hljs-params">fontPath, characters, options</span>) {
  <span class="hljs-comment">// 1. 读取字体文件</span>
  <span class="hljs-keyword">const</span> fontBuffer = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(fontPath)
  
  <span class="hljs-comment">// 2. 调用 subset-font 引擎</span>
  <span class="hljs-keyword">const</span> subsetBuffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">subsetFont</span>(fontBuffer, characters)
  
  <span class="hljs-comment">// 3. 生成 WOFF2</span>
  <span class="hljs-keyword">const</span> woff2Buffer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">toWoff2</span>(subsetBuffer)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">buffer</span>: woff2Buffer,
    <span class="hljs-attr">originalSize</span>: fontBuffer.<span class="hljs-property">length</span>,
    <span class="hljs-attr">subsetSize</span>: woff2Buffer.<span class="hljs-property">length</span>,
    <span class="hljs-attr">compression</span>: ((fontBuffer.<span class="hljs-property">length</span> - woff2Buffer.<span class="hljs-property">length</span>) / fontBuffer.<span class="hljs-property">length</span> * <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">1</span>)
  }
}
</code></pre>
<p>这个函数不依赖任何构建工具 API，可以在任何环境中运行。</p>
<h3 data-id="heading-9">三、适配器模式：统一接口的实践</h3>
<h4 data-id="heading-10">3.1 适配器接口设计</h4>
<p>我定义了一个标准的适配器接口：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 所有适配器都要实现这个接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildToolAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options
  }
  
  <span class="hljs-comment">// 核心方法：集成到构建流程</span>
  <span class="hljs-title function_">integrate</span>(<span class="hljs-params">buildContext</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Must implement integrate method'</span>)
  }
  
  <span class="hljs-comment">// 工具方法：获取构建信息</span>
  <span class="hljs-title function_">getBuildInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Must implement getBuildInfo method'</span>)
  }
}
</code></pre>
<h4 data-id="heading-11">3.2 Vite 适配器的重构</h4>
<p>原来的 Vite 插件被重构为使用共享层：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// adapters/vite/index.js</span>
<span class="hljs-keyword">import</span> { collectCharacters, buildCss } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../shared/'</span>
<span class="hljs-keyword">import</span> { subsetFont } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../core/subsetFont.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createVitePlugin</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-font-subset'</span>,
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">buildBegin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 使用共享层的字符扫描</span>
      <span class="hljs-keyword">const</span> characters = <span class="hljs-keyword">await</span> <span class="hljs-title function_">collectCharacters</span>(options.<span class="hljs-property">scanDirs</span>)
      
      <span class="hljs-comment">// 使用核心库的字体处理</span>
      <span class="hljs-keyword">const</span> fontResults = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        options.<span class="hljs-property">fonts</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">font</span> =&gt;</span> <span class="hljs-title function_">subsetFont</span>(font.<span class="hljs-property">src</span>, characters))
      )
      
      <span class="hljs-comment">// 使用共享层的 CSS 生成</span>
      <span class="hljs-keyword">const</span> css = <span class="hljs-title function_">buildCss</span>(fontResults, options)
      
      <span class="hljs-comment">// Vite 特定的资源注入</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitFile</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'asset'</span>,
        <span class="hljs-attr">fileName</span>: <span class="hljs-string">'fonts/font.css'</span>,
        <span class="hljs-attr">source</span>: css
      })
    }
  }
}
</code></pre>
<h4 data-id="heading-12">3.3 Webpack 适配器的实现</h4>
<p>Webpack 适配器复用了所有共享逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// adapters/webpack/index.js</span>
<span class="hljs-keyword">import</span> { collectCharacters, buildCss } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../shared/'</span>
<span class="hljs-keyword">import</span> { subsetFont } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../core/subsetFont.js'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebpackAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options
  }
  
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeCompile</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">'FontSubsetPlugin'</span>, <span class="hljs-keyword">async</span> (params, callback) =&gt; {
      <span class="hljs-comment">// 复用相同的逻辑！</span>
      <span class="hljs-keyword">const</span> characters = <span class="hljs-keyword">await</span> <span class="hljs-title function_">collectCharacters</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">scanDirs</span>)
      <span class="hljs-keyword">const</span> fontResults = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">fonts</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">font</span> =&gt;</span> <span class="hljs-title function_">subsetFont</span>(font.<span class="hljs-property">src</span>, characters))
      )
      <span class="hljs-keyword">const</span> css = <span class="hljs-title function_">buildCss</span>(fontResults, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>)
      
      <span class="hljs-comment">// Webpack 特定的资源处理</span>
      compilation.<span class="hljs-title function_">emitAsset</span>(<span class="hljs-string">'fonts/font.css'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSource</span>(css))
      <span class="hljs-title function_">callback</span>()
    })
  }
}
</code></pre>
<p><strong>神奇的是</strong>：除了生命周期钩子不同，其他逻辑完全一样！</p>
<h3 data-id="heading-13">四、国际化之路：从中文到日韩</h3>
<h4 data-id="heading-14">4.1 为什么需要国际化？</h4>
<p>在推广过程中，我发现了一个有趣的现象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// GitHub Analytics 显示</span>
访问来源：
- 中国：<span class="hljs-number">60</span>%
- 日本：<span class="hljs-number">25</span>% 
- 韩国：<span class="hljs-number">10</span>%
- 其他：<span class="hljs-number">5</span>%
</code></pre>
<p><strong>日韩开发者对字体优化同样有强烈需求！</strong></p>
<h4 data-id="heading-15">4.2 Vue I18n 集成实践</h4>
<p>我决定给 Demo 做一个完整的国际化改造：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// demo/src/i18n.js</span>
<span class="hljs-keyword">import</span> { createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>

<span class="hljs-keyword">const</span> messages = {
  <span class="hljs-string">'zh-CN'</span>: {
    <span class="hljs-attr">header</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'🔤 Vite 字体子集化插件'</span>,
      <span class="hljs-attr">subtitle</span>: <span class="hljs-string">'基于项目实际字符，智能压缩字体文件'</span>
    },
    <span class="hljs-attr">demoText</span>: <span class="hljs-string">'思源黑体演示文本 - 这是一段使用自定义字体的中文文本'</span>
  },
  <span class="hljs-string">'ja'</span>: {
    <span class="hljs-attr">header</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'🔤 Vite フォントサブセットプラグイン'</span>,
      <span class="hljs-attr">subtitle</span>: <span class="hljs-string">'プロジェクトの実際の文字に基づき、フォントファイルをインテリジェントに圧縮'</span>
    },
    <span class="hljs-attr">demoText</span>: <span class="hljs-string">'源ノ角ゴシックデモテキスト - これはカスタムフォントを使用した日本語テキストです'</span>
  },
  <span class="hljs-string">'ko'</span>: {
    <span class="hljs-attr">header</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'🔤 Vite 폰트 서브셋 플러그인'</span>, 
      <span class="hljs-attr">subtitle</span>: <span class="hljs-string">'프로젝트 실제 문자 기반으로 폰트 파일을 지능적으로 압축'</span>
    },
    <span class="hljs-attr">demoText</span>: <span class="hljs-string">'본고딕 데모 텍스트 - 이것은 커스텀 폰트를 사용하는 한국어 텍스트입니다'</span>
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> i18n = <span class="hljs-title function_">createI18n</span>({
  <span class="hljs-attr">locale</span>: <span class="hljs-title function_">detectBrowserLanguage</span>(),
  <span class="hljs-attr">fallbackLocale</span>: <span class="hljs-string">'zh-CN'</span>,
  messages
})
</code></pre>
<h4 data-id="heading-16">4.3 动态演示文本</h4>
<p>最酷的是，演示文本会根据语言动态变化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// demo/src/App.vue</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setInitialDemoText</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> demoTexts = {
    <span class="hljs-string">'zh-CN'</span>: <span class="hljs-string">'思源黑体演示文本 - 这是一段使用自定义字体的中文文本，包含常用汉字和标点符号。'</span>,
    <span class="hljs-string">'ja'</span>: <span class="hljs-string">'源ノ角ゴシックデモテキスト - これはカスタムフォントを使用した日本語テキストで、ひらがな、カタカナ、漢字を含んでいます。'</span>,
    <span class="hljs-string">'ko'</span>: <span class="hljs-string">'본고딕 데모 텍스트 - 이것은 커스텀 폰트를 사용하는 한국어 텍스트로, 일반적인 한글 문자와 문장 부호를 포함합니다.'</span>
  }
  userText.<span class="hljs-property">value</span> = demoTexts[currentLocale.<span class="hljs-property">value</span>]
}
</code></pre>
<p>这样不同地区的开发者都能看到母语的演示效果！</p>
<h3 data-id="heading-17">五、npm 正式发布：从玩具到生产工具</h3>
<h4 data-id="heading-18">5.1 发布前的准备</h4>
<p>v1.0.0 发布前，我做了全面的检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建检查</span>
npm run build
<span class="hljs-comment"># ✅ 所有适配器构建成功</span>

<span class="hljs-comment"># 包大小检查  </span>
npm pack --dry-run
<span class="hljs-comment"># ✅ 压缩后 28.1KB，合理大小</span>

<span class="hljs-comment"># 依赖检查</span>
npm <span class="hljs-built_in">ls</span>
<span class="hljs-comment"># ✅ 无多余依赖，peerDependencies 配置正确</span>
</code></pre>
<h4 data-id="heading-19">5.2 多入口导出策略</h4>
<p>为了支持不同构建工具的用户，我设计了多入口导出：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"./dist/index.cjs"</span>,
  <span class="hljs-string">"module"</span>: <span class="hljs-string">"./dist/index.js"</span>, 
  <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/index.d.ts"</span>,
  <span class="hljs-string">"exports"</span>: {
    <span class="hljs-string">"."</span>: {
      <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/index.d.ts"</span>,
      <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/index.js"</span>,
      <span class="hljs-string">"require"</span>: <span class="hljs-string">"./dist/index.cjs"</span>
    },
    <span class="hljs-string">"./vite"</span>: {
      <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/adapters/vite/index.d.ts"</span>,
      <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/adapters/vite/index.js"</span>, 
      <span class="hljs-string">"require"</span>: <span class="hljs-string">"./dist/adapters/vite/index.cjs"</span>
    },
    <span class="hljs-string">"./webpack"</span>: {
      <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/adapters/webpack/index.d.ts"</span>,
      <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/adapters/webpack/index.js"</span>,
      <span class="hljs-string">"require"</span>: <span class="hljs-string">"./dist/adapters/webpack/index.cjs"</span>
    },
    <span class="hljs-string">"./rollup"</span>: {
      <span class="hljs-string">"types"</span>: <span class="hljs-string">"./dist/adapters/rollup/index.d.ts"</span>, 
      <span class="hljs-string">"import"</span>: <span class="hljs-string">"./dist/adapters/rollup/index.js"</span>,
      <span class="hljs-string">"require"</span>: <span class="hljs-string">"./dist/adapters/rollup/index.cjs"</span>
    }
  }
}
</code></pre>
<p>这样用户可以按需导入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 用户</span>
<span class="hljs-keyword">import</span> fontSubsetPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@fe-fast/vite-plugin-font-subset'</span>

<span class="hljs-comment">// Webpack 用户  </span>
<span class="hljs-keyword">import</span> webpackPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@fe-fast/vite-plugin-font-subset/webpack'</span>

<span class="hljs-comment">// Rollup 用户</span>
<span class="hljs-keyword">import</span> rollupPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@fe-fast/vite-plugin-font-subset/rollup'</span>
</code></pre>
<h4 data-id="heading-20">5.3 发布成功时刻</h4>
<pre><code class="hljs language-bash" lang="bash">$ npm publish
+ @fe-fast/vite-plugin-font-subset@1.0.0

📦 包大小: 28.1KB (压缩后)
📁 文件数: 22个
🌟 支持构建工具: Vite, Webpack, Rollup, Rspack
🌏 国际化: 中文, 日本語, 한국어
</code></pre>
<h3 data-id="heading-21">六、性能数据：震撼效果持续升级</h3>
<h4 data-id="heading-22">6.1 多构建工具验证</h4>
<p>我在不同构建工具下做了完整测试：</p>








































<table><thead><tr><th>构建工具</th><th>原始字体</th><th>子集后</th><th>压缩率</th><th>构建时间</th></tr></thead><tbody><tr><td>Vite 5.x</td><td>8.2MB</td><td>130KB</td><td>98.4%</td><td>+2.1s</td></tr><tr><td>Webpack 5.x</td><td>8.2MB</td><td>130KB</td><td>98.4%</td><td>+2.8s</td></tr><tr><td>Rollup 4.x</td><td>8.2MB</td><td>130KB</td><td>98.4%</td><td>+1.9s</td></tr><tr><td>Rspack</td><td>8.2MB</td><td>130KB</td><td>98.4%</td><td>+1.5s</td></tr></tbody></table>
<p><strong>结论</strong>：无论哪种构建工具，压缩效果完全一致！</p>
<h4 data-id="heading-23">6.2 真实项目收益</h4>
<p>在一个实际的中后台项目中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化前</span>
- 字体文件: <span class="hljs-number">16.</span>3MB
- 首屏加载: <span class="hljs-number">4.</span>2s (3G网络)
- <span class="hljs-variable constant_">LCP</span>分数: <span class="hljs-number">45</span>

<span class="hljs-comment">// 优化后  </span>
- 字体文件: 260KB
- 首屏加载: <span class="hljs-number">1.</span>1s (3G网络)
- <span class="hljs-variable constant_">LCP</span>分数: <span class="hljs-number">78</span>

<span class="hljs-comment">// 提升幅度</span>
- 体积减少: <span class="hljs-number">98.4</span>%
- 加速: <span class="hljs-number">3.8</span>倍
- 体验提升: 显著
</code></pre>
<h3 data-id="heading-24">七、开源运营：从技术到生态</h3>
<h4 data-id="heading-25">7.1 社区推广策略</h4>
<p>我制定了针对性的推广计划：</p>
<p><strong>日本市场</strong>：</p>
<ul>
<li>平台：Zenn.dev + Qiita</li>
<li>话题：CJK フォント最適化</li>
<li>切入点：パフォーマンス向上</li>
</ul>
<p><strong>韩国市场</strong>：</p>
<ul>
<li>平台：Velog + OKKY</li>
<li>话题：한글 폰트 최적화</li>
<li>切入点：웹 성능 향상</li>
</ul>
<p><strong>国内市场</strong>：</p>
<ul>
<li>平台：掘金 + 知乎</li>
<li>话题：前端性能优化</li>
<li>切入点：构建工具生态</li>
</ul>
<h4 data-id="heading-26">7.2 CI/CD 自动化</h4>
<p>GitHub Actions 也做了升级：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/ci.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">CI/CD</span> <span class="hljs-string">Pipeline</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">test:</span>
    <span class="hljs-attr">strategy:</span>
      <span class="hljs-attr">matrix:</span>
        <span class="hljs-attr">build-tool:</span> [<span class="hljs-string">vite</span>, <span class="hljs-string">webpack</span>, <span class="hljs-string">rollup</span>]
        <span class="hljs-attr">node-version:</span> [<span class="hljs-number">18</span>, <span class="hljs-number">20</span>]
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">}}</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Test</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.build-tool</span> <span class="hljs-string">}}</span> <span class="hljs-string">integration</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">test:${{</span> <span class="hljs-string">matrix.build-tool</span> <span class="hljs-string">}}</span>
</code></pre>
<p>确保每个适配器都能正常工作。</p>
<h3 data-id="heading-27">八、经验总结：开源项目的技术思考</h3>
<h4 data-id="heading-28">8.1 架构设计的教训</h4>
<ol>
<li><strong>单一职责原则</strong>：每个模块专注自己的核心功能</li>
<li><strong>开放封闭原则</strong>：对扩展开放，对修改封闭</li>
<li><strong>依赖倒置原则</strong>：依赖抽象而非具体实现</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误做法：所有逻辑耦合在一起</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">vitePlugin</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-comment">// 字符扫描 + 字体处理 + CSS 生成 + Vite 集成</span>
}

<span class="hljs-comment">// ✅ 正确做法：职责清晰分离</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createPlugin</span>(<span class="hljs-params">adapter, options</span>) {
  <span class="hljs-keyword">const</span> scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CharacterScanner</span>()
  <span class="hljs-keyword">const</span> processor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FontProcessor</span>() 
  <span class="hljs-keyword">const</span> generator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssGenerator</span>()
  <span class="hljs-keyword">return</span> adapter.<span class="hljs-title function_">integrate</span>(scanner, processor, generator)
}
</code></pre>
<h4 data-id="heading-29">8.2 开源运营的心得</h4>
<ol>
<li><strong>文档比代码更重要</strong>：好的文档能降低使用门槛</li>
<li><strong>社区反馈驱动迭代</strong>：真实需求比技术炫技更有价值</li>
<li><strong>国际化视野</strong>：技术产品要有全球化的格局</li>
</ol>
<h4 data-id="heading-30">8.3 技术趋势洞察</h4>
<ul>
<li><strong>构建工具生态多样化</strong>：不再是一家独大</li>
<li><strong>性能优化需求持续增长</strong>：用户体验要求越来越高</li>
<li><strong>CJK 市场的技术红利</strong>：特定市场有特定机会</li>
</ul>
<h3 data-id="heading-31">九、未来展望：字体优化的无限可能</h3>
<h4 data-id="heading-32">9.1 短期规划</h4>
<ul>
<li>✅ Rspack 适配器完善</li>
<li>✅ 缓存机制优化</li>
<li>✅ 更多字体格式支持</li>
</ul>
<h4 data-id="heading-33">9.2 长期愿景</h4>
<ul>
<li>🎯 成为 CJK 字体优化的标准方案</li>
<li>🎯 构建完整的字体优化生态</li>
<li>🎯 推动前端性能优化的边界</li>
</ul>
<h4 data-id="heading-34">9.3 开源邀请</h4>
<p>如果你对字体优化、构建工具、前端性能感兴趣，欢迎参与贡献！</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 项目地址</span>
https://github.com/william-xue/vite-plugin-font-subset

<span class="hljs-comment"># npm 包  </span>
npm install @fe-fast/vite-plugin-font-subset

<span class="hljs-comment"># 在线 Demo</span>
https://william-xue.github.io/vite-plugin-font-subset/
</code></pre>
<h3 data-id="heading-35">十、写在最后</h3>
<p>从最初解决一个 16MB 字体文件的小问题，到现在的多构建工具生态，这个项目教会了我：</p>
<p><strong>好的开源项目，始于真实需求，成于技术深耕，终于生态建设。</strong></p>
<p>它不仅是一个工具，更是我对前端工程化理解的一次完整实践。希望这个故事能给同样在技术道路上探索的你一些启发。</p>
<hr/>
<p><strong>🎉 三篇文章完整回顾：</strong></p>
<ol>
<li><strong>《把 16MB 中文字体压到 400KB：我写了一个 Vite 字体子集插件》</strong> - 问题的发现与 MVP 实现</li>
<li><strong>《续集：Vite 字体插件重构之路 —— 从"能用"到"生产级稳定"》</strong> - 架构重构与稳定性提升</li>
<li><strong>《终章：从 Vite 专用到全构建工具生态》</strong> - 多工具支持与国际化推广</li>
</ol>
<p><strong>🚀 项目现状：@fe-fast/vite-plugin-font-subset v1.0.0，支持 Vite/Webpack/Rollup/Rspack，服务全球 CJK 开发者！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[索引夺命10连问，你能顶住第几问？]]></title>    <link>https://juejin.cn/post/7578402574652850228</link>    <guid>https://juejin.cn/post/7578402574652850228</guid>    <pubDate>2025-12-01T08:19:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578402574652850228" data-draft-id="7578402574652801076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="索引夺命10连问，你能顶住第几问？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T08:19:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            索引夺命10连问，你能顶住第几问？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T08:19:29.000Z" title="Mon Dec 01 2025 08:19:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天我们来聊聊让无数开发者又爱又恨的——<strong>数据库索引</strong>。</p>
<p>相信不少小伙伴在工作中都遇到过这样的场景：</p>
<ul>
<li>明明已经加了索引，为什么查询还是慢？</li>
<li>为什么有时候索引反而导致性能下降？</li>
<li>联合索引到底该怎么设计才合理？</li>
</ul>
<p>别急，今天我就通过10个问题，带你彻底搞懂索引的奥秘！</p>
<p>希望对你会有所帮助。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank" title="http://susan.net.cn/project" ref="nofollow noopener noreferrer">最近准备面试的小伙伴，可以看一下这个宝藏网站（Java突击队）：www.susan.net.cn，里面：面试八股文、场景设计题、面试真题、7个项目实战、工作内推什么都有</a>。</p>
<h2 data-id="heading-1">一、什么是索引？为什么需要索引？</h2>
<h3 data-id="heading-2">1.1 索引的本质</h3>
<p>简单来说，索引就是<strong>数据的目录</strong>。</p>
<p>就像一本书的目录能帮你快速找到内容一样，数据库索引能帮你快速定位数据。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 没有索引的查询（全表扫描）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- 需要遍历所有记录</span>

<span class="hljs-comment">-- 有索引的查询（索引扫描）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name <span class="hljs-keyword">ON</span> users(name);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- 通过索引快速定位</span>
</code></pre>
<h3 data-id="heading-3">1.2 索引的工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fff9f331edf4ac8832c5f8d3a8f2708~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765181968&amp;x-signature=vHX2k%2Ba6QUCopkAI5sFxwEFQIX0%3D" alt="" loading="lazy"/></p>
<p><strong>索引的底层结构（B+树）</strong>：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a850efe86d9940449badd2fa1cc29266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765181968&amp;x-signature=28ECS3tXMOvyNA6sNpUwYixrgV0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">二、索引的10个常见问题</h2>
<h3 data-id="heading-5">1.为什么我加了索引，查询还是慢？</h3>
<p><strong>场景还原</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_name <span class="hljs-keyword">ON</span> users(name);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%苏三%'</span>; <span class="hljs-comment">-- 还是很慢！</span>
</code></pre>
<p><strong>原因分析</strong>：</p>
<ol>
<li><strong>前导通配符</strong>：<code>LIKE '%苏三%</code> 导致索引失效</li>
<li><strong>索引选择性差</strong>：如果name字段大量重复，索引效果不佳</li>
<li><strong>回表代价高</strong>：索引覆盖不全，需要回表查询</li>
</ol>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方案1：避免前导通配符</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'苏三%'</span>;

<span class="hljs-comment">-- 方案2：使用覆盖索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_covering <span class="hljs-keyword">ON</span> users(name, id, email);
<span class="hljs-keyword">SELECT</span> name, id, email <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'苏三%'</span>; <span class="hljs-comment">-- 不需要回表</span>

<span class="hljs-comment">-- 方案3：使用全文索引（对于文本搜索）</span>
<span class="hljs-keyword">CREATE</span> FULLTEXT INDEX ft_name <span class="hljs-keyword">ON</span> users(name);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(name) AGAINST(<span class="hljs-string">'苏三'</span>);
</code></pre>
<h3 data-id="heading-6">2.索引是不是越多越好？</h3>
<p><strong>绝对不是！</strong> 索引需要维护代价：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 每个索引都会影响写性能</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (name, email, age) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'苏三'</span>, <span class="hljs-string">'susan@example.com'</span>, <span class="hljs-number">30</span>);
<span class="hljs-comment">-- 需要更新: </span>
<span class="hljs-comment">-- 1. 主键索引</span>
<span class="hljs-comment">-- 2. idx_name索引（如果存在）</span>
<span class="hljs-comment">-- 3. idx_email索引（如果存在）</span>
<span class="hljs-comment">-- 4. idx_age索引（如果存在）</span>
</code></pre>
<p><strong>索引的代价</strong>：</p>
<ol>
<li><strong>存储空间</strong>：每个索引都需要额外的磁盘空间</li>
<li><strong>写操作变慢</strong>：INSERT/UPDATE/DELETE需要维护所有索引</li>
<li><strong>优化器负担</strong>：索引太多会增加查询优化器的选择难度</li>
</ol>
<p><strong>黄金法则</strong>：一般建议表的索引数量不超过5-7个</p>
<h3 data-id="heading-7">3.联合索引的最左前缀原则是什么？</h3>
<p><strong>最左前缀原则</strong>：联合索引只能从最左边的列开始使用</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建联合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_age <span class="hljs-keyword">ON</span> users(name, age);

<span class="hljs-comment">-- 能使用索引的查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- √ 使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span> <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span>; <span class="hljs-comment">-- √ 使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span> <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- √ 优化器会调整顺序</span>

<span class="hljs-comment">-- 不能使用索引的查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span>; <span class="hljs-comment">-- × 不符合最左前缀</span>
</code></pre>
<p><strong>联合索引结构</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6504bd1f119646a98aa15659b7a16890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765181968&amp;x-signature=jdAYIPKY%2F%2F5EFxV%2BSTEuLZKddv0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.如何选择索引字段的顺序？</h3>
<p><strong>选择原则</strong>：</p>
<ol>
<li><strong>高选择性字段在前</strong>：选择性高的字段能更快过滤数据</li>
<li><strong>经常查询的字段在前</strong>：优先满足常用查询场景</li>
<li><strong>等值查询在前，范围查询在后</strong></li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算字段选择性</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> name) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> name_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> age) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> age_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> city) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> city_selectivity
<span class="hljs-keyword">FROM</span> users;

<span class="hljs-comment">-- 根据选择性决定索引顺序</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_city_age <span class="hljs-keyword">ON</span> users(name, city, age); <span class="hljs-comment">-- name选择性最高</span>
</code></pre>
<h3 data-id="heading-9">5.什么是覆盖索引？为什么重要？</h3>
<p><strong>覆盖索引</strong>：索引包含了查询需要的所有字段，不需要回表查询</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不是覆盖索引（需要回表）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name <span class="hljs-keyword">ON</span> users(name);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- 需要回表查询其他字段</span>

<span class="hljs-comment">-- 覆盖索引（不需要回表）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_covering <span class="hljs-keyword">ON</span> users(name, email, age);
<span class="hljs-keyword">SELECT</span> name, email, age <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>; <span class="hljs-comment">-- 所有字段都在索引中</span>
</code></pre>
<p><strong>覆盖索引的优势</strong>：</p>
<ol>
<li><strong>避免回表</strong>：减少磁盘IO</li>
<li><strong>减少内存占用</strong>：只需要读取索引页</li>
<li><strong>提升性能</strong>：查询速度更快</li>
</ol>
<h3 data-id="heading-10">6.NULL值对索引有什么影响？</h3>
<p><strong>NULL值的问题</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_email <span class="hljs-keyword">ON</span> users(email);

<span class="hljs-comment">-- 查询NULL值</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>; <span class="hljs-comment">-- 可能不使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>; <span class="hljs-comment">-- 可能不使用索引</span>
</code></pre>
<p>NULL值可能不使用索引。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>避免NULL值</strong>：设置默认值</li>
<li><strong>使用函数索引</strong>（MySQL 8.0+）</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用函数索引处理NULL值</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_email_null <span class="hljs-keyword">ON</span> users((<span class="hljs-built_in">COALESCE</span>(email, <span class="hljs-string">''</span>)));
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-built_in">COALESCE</span>(email, <span class="hljs-string">''</span>) <span class="hljs-operator">=</span> <span class="hljs-string">''</span>;
</code></pre>
<h3 data-id="heading-11">7.索引对排序和分组有什么影响？</h3>
<p><strong>索引优化排序和分组</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_age_name <span class="hljs-keyword">ON</span> users(age, name);

<span class="hljs-comment">-- 索引优化排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age, name; <span class="hljs-comment">-- √ 使用索引避免排序</span>

<span class="hljs-comment">-- 索引优化分组</span>
<span class="hljs-keyword">SELECT</span> age, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> age; <span class="hljs-comment">-- √ 使用索引优化分组</span>

<span class="hljs-comment">-- 无法使用索引排序的情况</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> name, age; <span class="hljs-comment">-- × 不符合最左前缀</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> age <span class="hljs-keyword">DESC</span>, name <span class="hljs-keyword">ASC</span>; <span class="hljs-comment">-- × 排序方向不一致</span>
</code></pre>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了不少的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h3 data-id="heading-12">8.如何发现索引失效的场景？</h3>
<p><strong>常见索引失效场景</strong>：</p>
<ol>
<li><strong>函数操作</strong>：<code>WHERE YEAR(create_time) = 2023</code></li>
<li><strong>类型转换</strong>：<code>WHERE phone = 13800138000</code>（phone是varchar）</li>
<li><strong>数学运算</strong>：<code>WHERE age + 1 &gt; 30</code></li>
<li><strong>前导通配符</strong>：<code>WHERE name LIKE '%苏三'</code></li>
</ol>
<p><strong>使用EXPLAIN分析</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'苏三'</span>;

<span class="hljs-comment">-- 查看关键指标：</span>
<span class="hljs-comment">-- type: const|ref|range|index|ALL（性能从好到坏）</span>
<span class="hljs-comment">-- key: 实际使用的索引</span>
<span class="hljs-comment">-- rows: 预估扫描行数</span>
<span class="hljs-comment">-- Extra: Using index（覆盖索引）| Using filesort（需要排序）| Using temporary（需要临时表）</span>
</code></pre>
<h3 data-id="heading-13">9.如何维护和优化索引？</h3>
<p><strong>定期索引维护</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看索引使用情况（MySQL）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sys.schema_index_statistics 
<span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span> <span class="hljs-keyword">AND</span> table_name <span class="hljs-operator">=</span> <span class="hljs-string">'users'</span>;

<span class="hljs-comment">-- 重建索引（优化索引碎片）</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users REBUILD INDEX idx_name;

<span class="hljs-comment">-- 分析索引使用情况</span>
ANALYZE <span class="hljs-keyword">TABLE</span> users;
</code></pre>
<p><strong>索引监控</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启索引监控（Oracle）</span>
<span class="hljs-keyword">ALTER</span> INDEX idx_name MONITORING USAGE;

<span class="hljs-comment">-- 查看索引使用情况</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> v$object_usage <span class="hljs-keyword">WHERE</span> index_name <span class="hljs-operator">=</span> <span class="hljs-string">'IDX_NAME'</span>;
</code></pre>
<h3 data-id="heading-14">10.不同数据库的索引有什么差异？</h3>
<p><strong>MySQL vs PostgreSQL索引差异</strong>：</p>



































<table><thead><tr><th>特性</th><th>MySQL</th><th>PostgreSQL</th></tr></thead><tbody><tr><td>索引类型</td><td>B+Tree, Hash, Fulltext</td><td>B+Tree, Hash, GiST, SP-GiST</td></tr><tr><td>覆盖索引</td><td>支持</td><td>支持（使用INCLUDE）</td></tr><tr><td>函数索引</td><td>8.0+支持</td><td>支持</td></tr><tr><td>部分索引</td><td>支持</td><td>支持</td></tr><tr><td>索引组织表</td><td>聚簇索引</td><td>堆表</td></tr></tbody></table>
<p><strong>PostgreSQL示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建包含索引（Covering Index）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_covering <span class="hljs-keyword">ON</span> users (name) INCLUDE (email, age);

<span class="hljs-comment">-- 创建部分索引（Partial Index）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_active_users <span class="hljs-keyword">ON</span> users (name) <span class="hljs-keyword">WHERE</span> is_active <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;

<span class="hljs-comment">-- 创建表达式索引（Expression Index）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_name_lower <span class="hljs-keyword">ON</span> users (<span class="hljs-built_in">LOWER</span>(name));
</code></pre>
<h2 data-id="heading-15">三、索引设计最佳实践</h2>
<h3 data-id="heading-16">3.1 索引设计原则</h3>
<ol>
<li><strong>按需创建</strong>：只为经常查询的字段创建索引</li>
<li><strong>选择合适类型</strong>：根据场景选择B-Tree、Hash、全文索引等</li>
<li><strong>考虑复合索引</strong>：使用复合索引减少索引数量</li>
<li><strong>避免过度索引</strong>：每个索引都有维护成本</li>
<li><strong>定期维护</strong>：重建索引，优化索引碎片</li>
</ol>
<h3 data-id="heading-17">3.2 索引设计检查清单</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b5abc79a2124e3280c5b4a479004df1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765181968&amp;x-signature=8bHub6Cmzj4JYpCXxNN%2FqhIb48s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">四、实战案例：电商系统索引设计</h2>
<h3 data-id="heading-19">4.1 用户表索引设计</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表结构</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at <span class="hljs-type">TIMESTAMP</span>,
    is_active <span class="hljs-type">BOOLEAN</span>
);

<span class="hljs-comment">-- 推荐索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> INDEX idx_users_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_users_city_age <span class="hljs-keyword">ON</span> users(city, age);
<span class="hljs-keyword">CREATE</span> INDEX idx_users_created <span class="hljs-keyword">ON</span> users(created_at) <span class="hljs-keyword">WHERE</span> is_active <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
</code></pre>
<h3 data-id="heading-20">4.2 订单表索引设计</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表结构</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at <span class="hljs-type">TIMESTAMP</span>,
    updated_at <span class="hljs-type">TIMESTAMP</span>
);

<span class="hljs-comment">-- 推荐索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_status_created <span class="hljs-keyword">ON</span> orders(status, created_at);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_created_amount <span class="hljs-keyword">ON</span> orders(created_at, amount);
</code></pre>
<h2 data-id="heading-21">总结</h2>
<ol>
<li><strong>理解原理</strong>：掌握B+树索引的工作原理和特性。</li>
<li><strong>合理设计</strong>：遵循最左前缀原则，选择合适的索引顺序。</li>
<li><strong>避免失效</strong>：注意索引失效的常见场景。</li>
<li><strong>覆盖索引</strong>：尽可能使用覆盖索引减少回表。</li>
<li><strong>定期维护</strong>：监控索引使用情况，定期优化重建。</li>
<li><strong>权衡利弊</strong>：索引不是越多越好，要权衡查询性能和写成本。</li>
</ol>
<blockquote>
<p>好的索引设计是数据库性能的基石。</p>
</blockquote>
<p>不要盲目添加索引，要基于实际查询需求和数据分布来科学设计。</p>
<h2 data-id="heading-22">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华为新开源！扩散语言模型突破32K上下文，还解锁了「慢思考」]]></title>    <link>https://juejin.cn/post/7579096485355274290</link>    <guid>https://juejin.cn/post/7579096485355274290</guid>    <pubDate>2025-12-02T10:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355274290" data-draft-id="7578922565210423323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华为新开源！扩散语言模型突破32K上下文，还解锁了「慢思考」"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-02T10:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华为新开源！扩散语言模型突破32K上下文，还解锁了「慢思考」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:24:30.000Z" title="Tue Dec 02 2025 10:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今年，文本生成领域迎来了从自回归（Auto-Regressive）向扩散语言模型（Diffusion LM）的重要范式转变。然而，长序列训练的不稳定性一直是制约扩散模型发展的核心痛点。上下文窗口限制使得模型在处理复杂的数学推理、编程任务，尤其是需要深度推理的「慢思考」场景时，显得捉襟见肘。</p>
<p>华为近日正式发布 openPangu-R-7B-Diffusion，基于openPangu-Embedded-7B 进行少量数据（800B tokens）续训练，成功将扩散语言模型的上下文长度扩展至 32K。</p>
<p>在「慢思考」能力的加持下，该模型在多个权威基准中创下了 7B 参数量级的全新 SOTA 纪录：</p>
<ul>
<li>
<p>多学科知识（MMLU-Pro）：超越 16B 参数量的 LLaDA 2.0-mini-preview 22%。</p>
</li>
<li>
<p>数学推理（MATH）：得分 84.26，大幅领先同类模型。</p>
</li>
<li>
<p>代码生成（MBPP）：得分 84.05，展现出卓越的逻辑泛化能力。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbcb6ec58bf24de7a914474fcc6d93b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275870&amp;x-signature=PpEVEU1g57adY%2FWow1599%2F12vtA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08cc8662aeff4b36b41da91daa37fdfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275870&amp;x-signature=RJ9qCwqCBC1BkoY0MBtDVWkk75I%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>Base模型链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.gitcode.com%2Fascend-tribe%2FopenPangu-7B-Diffusion-Base" target="_blank" title="https://ai.gitcode.com/ascend-tribe/openPangu-7B-Diffusion-Base" ref="nofollow noopener noreferrer">ai.gitcode.com/ascend-trib…</a></p>
</li>
<li>
<p>慢思考模型链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.gitcode.com%2Fascend-tribe%2FopenPangu-R-7B-Diffusion" target="_blank" title="https://ai.gitcode.com/ascend-tribe/openPangu-R-7B-Diffusion" ref="nofollow noopener noreferrer">ai.gitcode.com/ascend-trib…</a></p>
</li>
</ul>
<p>接下来，我们将深入解析这款模型背后的技术革新。</p>
<ol>
<li>架构创新：</li>
</ol>
<p>前文因果注意力掩码，自回归到 BlockDiffusion 的无缝迁移</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c9ff738c1f64df9952248602b46dc2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275870&amp;x-signature=hfPLqzjlxPyelI3Td2x%2FCKOV34g%3D" alt="图片" loading="lazy"/></p>
<p>openPangu-R-7B-Diffusion 在注意力机制上并未沿用传统扩散模型（如 LLaDA）的全注意力（Full Attention），也未采用 SDAR 或 Fast-dLLMv2 的分块掩码（Block Attention），而是创新性地融合了自回归的前文因果注意力掩码（Causal Attention Mask）。</p>
<p>这一设计从根本上解决了架构适配难题：</p>
<ul>
<li>
<p>消除适配壁垒：以往将自回归模型适配至扩散模型，往往需要 Attention Mask Annealing 或 Shift Operation 等复杂操作来弥合差异。而 openPangu-R-7B-Diffusion 通过保留前文的因果注意力特性，使得模型仅需从「预测 Next Token」转变为「预测 Next Block 中的 Mask Token」，极大地降低了适配成本。</p>
</li>
<li>
<p>兼容性最大化：该设计让模型能够自然继承自回归模型的预训练知识，为长窗口训练打下坚实基础。</p>
</li>
</ul>
<ol start="2">
<li>训练与推理：双模式解码与效率倍增</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/544c3e76fb134729ab71ca4549e3ada0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275870&amp;x-signature=AB6U3QY9%2B79goqryteBShktvZzI%3D" alt="图片" loading="lazy"/></p>
<p>在训练策略上，openPangu-R-7B-Diffusion 延续了 BlockDiffusion 的思路（拼接带掩码的 Block 与无掩码的 Context），但进行了关键优化：</p>
<ul>
<li>
<p>Context 利用率 100%：传统方法往往忽略无掩码 Context 部分的 Loss 计算，导致一半的数据被浪费。openPangu-R-7B-Diffusion 则将这部分数据用于标准的自回归 Next Token Prediction 训练。</p>
</li>
<li>
<p>双模式解码：这种训练方式赋予了模型「自回归 + 扩散」的双重解码能力。用户可以通过不同的采样设置，灵活权衡生成质量与速度。</p>
</li>
<li>
<p>极致性能：模型完整保留了变长推理与 KV-Cache 特性。在并行解码模式下，其速度最高可达自回归解码的 2.5 倍。</p>
</li>
</ul>
<p>可视化实测：亲眼见证「慢思考」与扩散生成的融合</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6dfd6cf7d548d6ae12f6e6c6b6eddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275870&amp;x-signature=GmYY88qgethQe%2BNaYdSRaUrb7us%3D" alt="图片" loading="lazy"/></p>
<p>为了更直观地展示 openPangu-R-7B-Diffusion 的工作机制，我们对模型的推理过程进行了可视化处理。</p>
<p>在输入一道经典的数学逻辑推理题（Claire 的煎蛋问题）后，我们可以清晰地观察到扩散语言模型的独特生成方式：模型并非像传统自回归模型那样「逐词蹦出」，而是在 4 个生成步数（Generation Steps）内，并行地将多个 [MASK] 噪声逐步去噪还原为 、Claire、makes 等清晰的语义 Token。</p>
<p>图中首位的  Token 尤为关键，它标志着模型正在启动我们前文提到的 「慢思考」模式。这种结合了扩散并行生成与深度思维链（Chain-of-Thought）的能力，正是 openPangu-R-7B-Diffusion 能够在数学和编程基准上大幅超越同类模型的核心原因。</p>
<p>结语：开启扩散语言模型的新篇章</p>
<p>openPangu-R-7B-Diffusion 的发布，不仅仅是一个新模型的开源，更是对「扩散模型能否处理复杂长文本」这一难题的有力回应。凭借其创新的因果注意力掩码架构，它成功证明了扩散模型不仅可以「快」（并行解码），更可以「深」（32K 长文与慢思考）。</p>
<p>值得一提的是，openPangu-R-7B-Diffusion 的训练、推理及评测全流程均在昇腾 NPU 集群上完成，有力证明了国产算力在以前沿扩散语言模型领域的强劲实力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的 AI 工作流 —— project_rules.md 代码规范篇，让 AI 自省自动跑起来]]></title>    <link>https://juejin.cn/post/7578697614389493766</link>    <guid>https://juejin.cn/post/7578697614389493766</guid>    <pubDate>2025-12-01T08:31:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578697614389493766" data-draft-id="7574665183852937235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的 AI 工作流 —— project_rules.md 代码规范篇，让 AI 自省自动跑起来"/> <meta itemprop="keywords" content="Bun,Node.js,React.js"/> <meta itemprop="datePublished" content="2025-12-01T08:31:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Legend80s"/> <meta itemprop="url" content="https://juejin.cn/user/2568105753839790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的 AI 工作流 —— project_rules.md 代码规范篇，让 AI 自省自动跑起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568105753839790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Legend80s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T08:31:42.000Z" title="Mon Dec 01 2025 08:31:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.trae.cn%2Fsolo" target="_blank" title="https://www.trae.cn/solo" ref="nofollow noopener noreferrer">Trae Solo IDE</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e89d260a5dce4993abb4fe4fc3a5c893~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765182702&amp;x-signature=65v4Xwwt4o%2Fy3d%2FKXeiwyzqDkAQ%3D" alt="https://www.trae.cn/solo" loading="lazy"/></p>
<h2 data-id="heading-0">重点 TL;DR</h2>
<p>通过 tsc-files 让 AI 在每轮代码生成后“自动”进行严格类型检测（<code>"strict": true</code>），给 AI 添加“自省”能力，让其“闭环”自动跑出高质量代码。</p>
<h2 data-id="heading-1">Project rules</h2>
<p>入口：Trae 右上角齿轮设置 - Rules - Create project_rules.md</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f4559ef210429a912a647fb16bfe3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765182702&amp;x-signature=Fan5nLQNe1FTHoTaeGwGM8Ujep0%3D" alt="image.png" loading="lazy"/></p>
<p>或直接新建文件：.trae\rules\project_rules.md，project_rules 将分两部分</p>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section">## Technical Stack</span>
<span class="hljs-bullet">-</span> 技术栈
<span class="hljs-bullet">-</span> 构建工具
<span class="hljs-bullet">-</span> 包管理器

<span class="hljs-section">## Code Style Guidelines</span>

<span class="hljs-section">### Part 1. General Coding Guidelines</span>
<span class="hljs-section">### Part 2. Frontend Coding Guidelines</span>
<span class="hljs-section">### Part 3. Project Coding Guidelines</span>
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e9fa6a97241438d9dfacb36f720c44f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765182702&amp;x-signature=QQSR2VhF3mVN0PVsOGnRZzihDjM%3D" alt="image.png" loading="lazy"/></p>
<p>我的项目 project_rules：</p>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section">## Technical Stack</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**技术栈**</span>：React v19, Ant Design v5, TypeScript v5, tailwindcss v4,
<span class="hljs-bullet">-</span> <span class="hljs-strong">**构建工具**</span>：Rsbuild
<span class="hljs-bullet">-</span> <span class="hljs-strong">**包管理器**</span>：pnpm (&gt;= 9.0.0)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**代码格式化和 lint**</span>：Biome
<span class="hljs-bullet">-</span> <span class="hljs-strong">**操作系统**</span>：Windows，但请使用 git bash 运行命令而非 powershell

<span class="hljs-section">## Coding Guidelines</span>

<span class="hljs-section">### Part 1. General Coding Guidelines</span>

&lt;!--《中文文案排版指北》可选，大家酌情增加，详见文章后半部分 --&gt;
文案请按照中文文案排版指北，先阅读这份文档 docs/README.zh-Hans.md。

<span class="hljs-section">#### 1. Basic Principles</span>
<span class="hljs-bullet">-</span> DRY (Don't Repeat Yourself) 原则：避免重复代码。
<span class="hljs-bullet">-</span> SRP (Single Responsibility Principle) 原则：每个模块、函数或类应该只有一个职责。
<span class="hljs-bullet">-</span> KISS (Keep It Simple, Stupid) 原则：保持代码简单、直接，避免复杂的逻辑。

<span class="hljs-section">#### 2. Comments &amp; Documentation</span>
<span class="hljs-bullet">-</span> Only generate necessary comments. Comments should explain why, not what.
<span class="hljs-bullet">-</span> Provide clear documentation for public APIs.
<span class="hljs-bullet">-</span> Update comments to reflect code changes.

<span class="hljs-section">### Part 2. Frontend Coding Guidelines</span>

<span class="hljs-section">#### 1. Code Structure</span>
<span class="hljs-bullet">-</span> Use functional components with hooks.
<span class="hljs-bullet">-</span> Organize components in a feature-based folder structure.
<span class="hljs-bullet">-</span> Use TypeScript for type safety.

<span class="hljs-section">#### 2. Styling</span>
<span class="hljs-bullet">-</span> Use tailwindcss for utility-first styling.
<span class="hljs-bullet">-</span> Avoid inline styles; use antd components and necessary tailwindcss classes.

<span class="hljs-section">### Part 3. Project Coding Guidelines</span>
<span class="hljs-bullet">1.</span> Use pnpm instead of npm.
<span class="hljs-bullet">1.</span> Avoid inline styles; use antd components and necessary tailwindcss classes. If necessary, please clearly state the reason in the comment.
<span class="hljs-bullet">1.</span> Do not use react-router-dom. This project is a react-router v7 project, so please use react-router.
<span class="hljs-bullet">1.</span> Import types with type prefix, e.g. <span class="hljs-code">`IMcpServerRecord`</span>.
<span class="hljs-bullet">1.</span> For type checking after modifications, use: <span class="hljs-code">`bun scripts/tsc-files.mjs --noEmit &lt;related_files&gt;`</span> (checks <span class="hljs-strong">**only relevant files**</span>). Avoid <span class="hljs-code">`npx tsc ...`</span> as it doesn't respect project type configuration and shows errors from unrelated files, generating many false positives.
<span class="hljs-bullet">1.</span> 新代码请使用 es-toolkit 而非 lodash。老代码 lodash 类型报错请使用 <span class="hljs-code">`// @ts-expect-error`</span> 注释忽略。
<span class="hljs-bullet">1.</span> 新代码请勿使用 <span class="hljs-code">`dva`</span> 的 <span class="hljs-code">`connect`</span>。比如获取 <span class="hljs-code">`orgId`</span>，应该使用 <span class="hljs-code">`useOrgId`</span>，它基于 <span class="hljs-code">`@tanstack/react-query`</span> 的 <span class="hljs-code">`useQuery`</span>。如果其他全局服务端数据没有，应该如 <span class="hljs-code">`useOrgId`</span> 封装新的 <span class="hljs-code">`useXxx`</span>，并且在 <span class="hljs-code">`src/lib/prefetchGlobalServerData.tsx`</span> 中添加预取逻辑。

[可选]
<span class="hljs-bullet">1.</span> 每次修改完毕执行 <span class="hljs-code">`npx biome check --diagnostic-level=error --write &lt;related_files&gt;`</span> 检查<span class="hljs-strong">**涉及到**</span>的文件
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flegend80s%2Fcode-snippets%2Fblob%2Fmaster%2F.trae%2Frules%2Fproject_rules.md" target="_blank" title="https://github.com/legend80s/code-snippets/blob/master/.trae/rules/project_rules.md" ref="nofollow noopener noreferrer">project_rules github 地址</a>。</p>
<blockquote>
<p>[!NOTE]
注意每次修改 project_rules.md 都需要告知 AI“重新阅读 .trae\rules\project_rules.md”。</p>
<p>上述中英文夹杂，建议全部中文，因为这份 rules 也需要团队成员阅读并执行。</p>
</blockquote>
<h2 data-id="heading-2">重点解释</h2>
<h3 data-id="heading-3">一、Basic Principles</h3>
<pre><code class="hljs language-md" lang="md"><span class="hljs-bullet">-</span> DRY (Don't Repeat Yourself) 原则：避免重复代码。
<span class="hljs-bullet">-</span> SRP (Single Responsibility Principle) 原则：每个模块、函数或类应该只有一个职责。
<span class="hljs-bullet">-</span> KISS (Keep It Simple, Stupid) 原则：保持代码简单、直接，避免复杂的逻辑。
</code></pre>
<p>我为什么只选择了这三条，甚至觉得有些都可删除，详见<a href="https://juejin.cn/post/7576371992615174180" target="_blank" title="https://juejin.cn/post/7576371992615174180">AI 每日心得——AI 是效率杠杆，而非培养对象</a>
，请大家酌情增加。</p>
<h3 data-id="heading-4">二、类型检查 tsc-files</h3>
<p>tsc-files 类型检查工具。为什么要让 AI 检查类型？因为 AI 生成的代码如果类型有问题一般意味代码有 bug，而通常类型问题修复后代码 bug 也自行消除了，故<strong>类型检查</strong>是 AI 结束编码后保证代码质量，闭环的重要一个环节！</p>
<p><strong>第二个为什么</strong>：为什么用社区的 tsc-files 而非 <code>tsc</code> 即 <code>npx tsc --noEmit file1 file2</code>，因为 <code>tsc</code> 不争气呀，<strong>社区 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FTypeScript%2Fissues%2F27379" target="_blank" title="https://github.com/microsoft/TypeScript/issues/27379" ref="nofollow noopener noreferrer">issue#27379</a> 一直没有处理</strong>：即当传入文件则不会使用 tsconfig.json 导致大量误报，若同时指定 <code>-p</code> / <code>--project tsconfig.json</code> 则报错 <strong>error TS5042: Option 'project' cannot be mixed with source files on a command line.</strong>，即不能既指定文件又指定配置文件。</p>
<blockquote>
<p>[!TIP]
tsc-files 原理：底层当然也是使用 tsc，只是复制当前项目的 tsconfig.json 配置文件清空 include 新增 files 其值为仅传入的文件，这样无需通过参数指定待检测文件却能达到检测特定文件的目的，类似运行：<code>tsc -p tsconfig.&lt;random-chars&gt;.json</code>。</p>
</blockquote>
<p><strong>第三个为什么</strong>：社区有 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Ftsc-files" target="_blank" title="https://www.npmjs.com/package/tsc-files" ref="nofollow noopener noreferrer">tsc-files</a> 为什么自定义 <code>scripts/tsc-files.mjs</code>？<strong>tsc-files 也有自己的问题</strong>。故修改如下：</p>
<ul>
<li>问题修复：tsc-files 对 <code>tsc</code> 二进制文件路径解析不正确导致 <code>pnpm</code> 项目无法工作。</li>
<li>新增功能：<strong>仅显示指定文件的错误</strong>，若其他文件引发类型错误仍然认为类型检测成功。（<em>tsc 会暴露其他文件问题导致 TRAE 会将 <strong>改动范围扩大化，这是不允许的！</strong> 尤其是在大型代码库中。</em>）</li>
</ul>
<p><strong>第四个为什么</strong>：为什么 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40typescript%2Fnative-preview" target="_blank" title="https://www.npmjs.com/package/@typescript/native-preview" ref="nofollow noopener noreferrer"><code>tsgo —— Go 语言对 TypeScript 进行全面重写</code></a> 而非 <code>tsc</code> 因为 <code>tsgo</code> 速度快 ⚡，详见我的另一篇文章 <a href="https://juejin.cn/editor/drafts/7578177007576252470" target="_blank" title="https://juejin.cn/editor/drafts/7578177007576252470">tsgo 相比 tsc 确实有巨大性能提升</a>。</p>
<blockquote>
<p>[!NOTE]</p>
<ol>
<li>需先下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40typescript%2Fnative-preview" target="_blank" title="https://www.npmjs.com/package/@typescript/native-preview" ref="nofollow noopener noreferrer">npm i @typescript/native-preview -D</a></li>
<li>大家可以对比下速度，将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flegend80s%2Fcode-snippets%2Fblob%2Fmaster%2Fscripts%2Ftsc-files.mjs%23L101" target="_blank" title="https://github.com/legend80s/code-snippets/blob/master/scripts/tsc-files.mjs#L101" ref="nofollow noopener noreferrer">github.com/legend80s/c…</a> <code>typescriptCompiler</code> 改成 <code>tsc</code> 就可以体会到巨大的性能落差。</li>
</ol>
</blockquote>
<p>完整 scripts/tsc-files.mjs 代码见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flegend80s%2Fcode-snippets%2Fblob%2Fmaster%2Fscripts%2Ftsc-files.mjs" target="_blank" title="https://github.com/legend80s/code-snippets/blob/master/scripts/tsc-files.mjs" ref="nofollow noopener noreferrer">tsc-files.mjs ~ github</a>。</p>
<h4 data-id="heading-5">使用 tsc-files 案例或效果</h4>
<p>未告知 AI 使用 <code>tsc-files</code>，生成代码有问题导致 rsbuild dev 报错：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[🦀]</span> <span class="hljs-selector-tag">error</span>   <span class="hljs-selector-tag">Build</span> <span class="hljs-selector-tag">error</span>:
<span class="hljs-selector-attr">[🦀]</span> <span class="hljs-selector-tag">File</span>: <span class="hljs-selector-tag">D</span>:\<span class="hljs-selector-tag">workspace</span>\<span class="hljs-selector-tag">project</span>\<span class="hljs-selector-tag">src</span>\<span class="hljs-selector-tag">pages</span>\<span class="hljs-selector-tag">mcpServer</span>\<span class="hljs-selector-tag">details</span>\<span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.tsx</span>:<span class="hljs-number">1</span>:<span class="hljs-number">1</span>
<span class="hljs-selector-attr">[🦀]</span>   × <span class="hljs-selector-tag">ESModulesLinkingError</span>: <span class="hljs-selector-tag">export</span> '<span class="hljs-selector-tag">mockData</span>' (imported as <span class="hljs-string">'mockData'</span>) <span class="hljs-selector-tag">was</span> <span class="hljs-selector-tag">not</span> <span class="hljs-selector-tag">found</span> <span class="hljs-selector-tag">in</span> '../<span class="hljs-selector-tag">service</span>' (possible <span class="hljs-attribute">exports</span>: IMcpSe
rverStatus, McpServerService, McpServerStatusValueEnum)
<span class="hljs-selector-attr">[🦀]</span>     ╭─<span class="hljs-selector-attr">[23:29]</span>
<span class="hljs-selector-attr">[🦀]</span>  <span class="hljs-number">21</span> │                 <span class="hljs-comment">// 在真实环境中，这里会调用 API 获取数据</span>
<span class="hljs-selector-attr">[🦀]</span>  <span class="hljs-number">22</span> │                 <span class="hljs-comment">// 现在使用 mockData 模拟</span>
<span class="hljs-selector-attr">[🦀]</span>  <span class="hljs-number">23</span> │                 <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">data</span> = <span class="hljs-selector-tag">mockData</span><span class="hljs-selector-class">.find</span>((item)=&gt;item.id === id);
<span class="hljs-selector-attr">[🦀]</span>     ·                              ─────────────
<span class="hljs-selector-attr">[🦀]</span>  <span class="hljs-number">24</span> │                 <span class="hljs-comment">// 如果没有找到对应 ID 的数据，使用默认数据</span>
<span class="hljs-selector-attr">[🦀]</span>  <span class="hljs-number">25</span> │                 <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">defaultData</span> = {
<span class="hljs-selector-attr">[🦀]</span>     ╰────
</code></pre>
<blockquote>
<p>[🦀] × ESModulesLinkingError: export 'mockData' (imported as 'mockData') was not found in '../service'</p>
</blockquote>
<p>这是因为 service 并未导出 <code>mockData</code>，这种错误人类一眼就知有 TS error，因为我们的编辑器会标红，若安装了 Error Lens 插件则错误更加一目了然，但是 AI 不知道到，<em>ta 还没有进化到直接看你编辑器的能力</em>。</p>
<p>当我们加入规则让 AI 每次生成代码后都执行 <code>tsc-files</code>。</p>
<p>现在我们让 TRAE 自行进行类型检查：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/536d9bed67dd4c9b8d639433a7fc864a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765182702&amp;x-signature=ojxpRfWH4e90m%2B1bIdeYVKuLpgU%3D" alt="image.png" loading="lazy"/></p>
<p>截图可见 trae 执行了 <code>bun scripts/tsc-files.mjs</code> 并且仅对改动的代码执行，而且不止发现了一个问题。</p>
<p>TRAE 自动修复如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- import { McpServerStatusValueEnum, mockData } from '../service';</span>
<span class="hljs-addition">+ import { McpServerService } from '../service';</span>

const { Title, Paragraph, Text } = Typography;

@ src/pages/mcpServer/details/index.tsx:26 @ const McpServerDetailsPage = () =&gt; {
      setLoading(true);
      try {
        // 在真实环境中，这里会调用 API 获取数据
        // 现在使用 mockData 模拟
<span class="hljs-deletion">-        const data = mockData.find(item =&gt; item.id === id);</span>
<span class="hljs-addition">+        // 使用service中的details方法获取数据</span>
<span class="hljs-addition">+        const data = await McpServerService.details({ id });</span>
</code></pre>
<p>通过修复 ts 类型错误，<strong>Trae AI 甚至理解到了我们的代码意图</strong>：应该使用 service 中的 details 方法获取数据，而不是从 service 导出 mockData 然后对其操作，awsome 🤩！</p>
<h3 data-id="heading-6">三、<code>biome check</code>：lint &amp; format <code>#可选</code></h3>
<p><code>npx biome check --diagnostic-level=error --write &lt;related_files&gt;</code></p>
<p><strong>为什么 biome check 而非 eslint</strong>：biome 速度好意味着 AI 生成代码耗费时间少，其次 <code>biome check</code> 兼备 format 和 lint，和 <code>tsc-files</code> 一样消除 lint error 也能避免 bug，同时 format 能让生成的代码 style 自动符合项目要求。</p>
<p><strong>为什么使用 npx</strong>：因为 pnpx、bunx 会下载远程 biome 而我们本地已安装 <code>biome</code>，速度反而慢。</p>
<p><strong>为什么可选</strong>：这个看自己实际使用效果而定。有些问题人工修复更好否则 AI 会陷入及其复杂的代码中“不可自拔”，其次<strong>命令不是越多越好</strong>，就目前而言自执行轮数越多，Trae 可能会“罢工”让你自行停止然后开启新对话。</p>
<p>比如人可以通过一些指令快速消除无谓的 lint 错误：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// biome-ignore lint/security/noGlobalEval: Use 'eval' to read the JSON as regular JavaScript syntax so that comments are allowed</span>
<span class="hljs-built_in">eval</span>(<span class="hljs-string">`tsconfig = <span class="hljs-subst">${tsconfigContent}</span>`</span>);
</code></pre>
<p><strong>案例说明</strong>：<code>eval</code> 会导致 biome lint 报错，因为我们都知道 eval 是“evil 👿 的”，但这里用其实是安全的，因为项目的 tsconfig.json 不可能隐藏危险的可执行代码，而且 <code>eval</code> 能将 tsconfig.json 里的注释自动去掉，人类一个指令 <code>biome-ignore lint/security/noGlobalEval</code> 即可消除 IDE 报错，但是如果让 AI 来解决可能会生成一段极度复杂的代码 🤯。</p>
<h3 data-id="heading-7">四、中文文案排版指北 <code>#可选</code></h3>
<blockquote>
<p>先讲下为何“可选”，因为执行统一的“文案排版规范”还是比较不现实的，虽然蚂蚁等大厂在程序员之间执行比较好（可以看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Foverview-cn" target="_blank" title="https://ant-design.antgroup.com/components/overview-cn" ref="nofollow noopener noreferrer">antd 的文档</a>），但实际业务很难。就拿“空格”而言，业务文案很难做到“<strong>中英文之间需要增加空格</strong>”，但是我们自己的文章、文档或代码注释还是可以自我约束的。所以这里还是列出来吧。</p>
<p>其次我对“指北”内容进行了修改，大家也可以自行根据项目调整。</p>
</blockquote>
<p>1 下载</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">mkdir</span> docs &amp;&amp; <span class="hljs-built_in">cd</span> docs
curl -O https://github.com/sparanoid/chinese-copywriting-guidelines/blob/master/README.md
</code></pre>
<p>2 修改：简体中文使用非直角引号</p>
<pre><code class="hljs language-md" lang="md">---
原文：https://github.com/sparanoid/chinese-copywriting-guidelines/blob/master/README.zh-Hans.md 
修改：简体中文使用非直角引号。根据[<span class="hljs-string">百度百科</span>](<span class="hljs-link">https://baike.baidu.com/item/%E5%8F%8C%E5%BC%95%E5%8F%B7/10758658</span>)将直角引号修改成大陆中文的引号 “中国大陆地区标准：先用双引号“ ”，内部如需再引用，再用单引号‘’”
<span class="hljs-section">删除：“工具”和“谁在这么做”
---</span>

<span class="hljs-section"># 中文文案排版指北</span>

统一中文文案、排版的相关用法，降低团队成员之间的沟通成本，增强网站气质。

Other languages:

<span class="hljs-bullet">-</span> [<span class="hljs-string">英语</span>](<span class="hljs-link">README.en.md</span>)
<span class="hljs-bullet">-</span> [<span class="hljs-string">繁体中文</span>](<span class="hljs-link">README.md</span>)
<span class="hljs-bullet">-</span> [<span class="hljs-string">简体中文</span>](<span class="hljs-link">README.zh-Hans.md</span>)

<span class="hljs-bullet">*</span> * *

<span class="hljs-section">## 空格</span>

<span class="hljs-quote">&gt; “有研究显示，打字的时候不喜欢在中文和英文之间加空格的人，感情路都走得很辛苦，有七成的比例会在 34 岁的时候跟自己不爱的人结婚，而其余三成的人最后只能把遗产留给自己的猫。毕竟爱情跟书写都需要适时地留白。</span>
<span class="hljs-quote">&gt;
&gt; 与大家共勉之。”——[<span class="hljs-string">vinta/paranoid-auto-spacing</span>](<span class="hljs-link">https://github.com/vinta/pangu.js</span>)</span>

<span class="hljs-section">### 中英文之间需要增加空格</span>

正确：

<span class="hljs-quote">&gt; 在 LeanCloud 上，数据存储是围绕 `AVObject` 进行的。</span>

错误：

<span class="hljs-quote">&gt; 在LeanCloud上，数据存储是围绕`AVObject`进行的。</span>
<span class="hljs-quote">&gt;
&gt; 在 LeanCloud上，数据存储是围绕`AVObject` 进行的。</span>

完整的正确用法：

<span class="hljs-quote">&gt; 在 LeanCloud 上，数据存储是围绕 `AVObject` 进行的。每个 `AVObject` 都包含了与 JSON 兼容的 key-value 对应的数据。数据是 schema-free 的，你不需要在每个 `AVObject` 上提前指定存在哪些键，只要直接设定对应的 key-value 即可。</span>

例外：“豆瓣FM”等产品名词，按照官方所定义的格式书写。

<span class="hljs-section">### 中文与数字之间需要增加空格</span>

正确：

<span class="hljs-quote">&gt; 今天出去买菜花了 5000 元。</span>

错误：

<span class="hljs-quote">&gt; 今天出去买菜花了 5000元。</span>
<span class="hljs-quote">&gt;
&gt; 今天出去买菜花了5000元。</span>

<span class="hljs-section">### 数字与单位之间需要增加空格</span>

正确：

<span class="hljs-quote">&gt; 我家的光纤入屋宽带有 10 Gbps，SSD 一共有 20 TB</span>

错误：

<span class="hljs-quote">&gt; 我家的光纤入屋宽带有 10Gbps，SSD 一共有 20TB</span>

例外：度数／百分比与数字之间不需要增加空格：

正确：

<span class="hljs-quote">&gt; 角度为 90° 的角，就是直角。</span>
<span class="hljs-quote">&gt;
&gt; 新 MacBook Pro 有 15% 的 CPU 性能提升。</span>

错误：

<span class="hljs-quote">&gt; 角度为 90 ° 的角，就是直角。</span>
<span class="hljs-quote">&gt;
&gt; 新 MacBook Pro 有 15 % 的 CPU 性能提升。</span>

<span class="hljs-section">### 全角标点与其他字符之间不加空格</span>

正确：

<span class="hljs-quote">&gt; 刚刚买了一部 iPhone，好开心！</span>

错误：

<span class="hljs-quote">&gt; 刚刚买了一部 iPhone ，好开心！</span>
<span class="hljs-quote">&gt;
&gt; 刚刚买了一部 iPhone， 好开心！</span>

<span class="hljs-section">### 用 `text-spacing` 来挽救？</span>

CSS Text Module Level 4 的 [<span class="hljs-string">`text-spacing`</span>](<span class="hljs-link">https://www.w3.org/TR/css-text-4/#text-spacing-property</span>) 和 Microsoft 的 [<span class="hljs-string">`-ms-text-autospace`</span>](<span class="hljs-link">https://msdn.microsoft.com/library/ms531164(v=vs.85</span>).aspx) 可以实现自动为中英文之间增加空白。不过目前并未普及，另外在其他应用场景，例如 macOS、iOS、Windows 等用户界面目前并不存在这个特性，所以请继续保持随手加空格的习惯。

<span class="hljs-section">## 标点符号</span>

<span class="hljs-section">### 不重复使用标点符号</span>

虽然中国大陆的标点符号用法允许重复使用标点符号，但是这么做会破坏句子的美观性。

正确：

<span class="hljs-quote">&gt; 德国队竟然战胜了巴西队！</span>
<span class="hljs-quote">&gt;
&gt; 她竟然对你说“喵”？！</span>

错误：

<span class="hljs-quote">&gt; 德国队竟然战胜了巴西队！！</span>
<span class="hljs-quote">&gt;
&gt; 德国队竟然战胜了巴西队！！！！！！！！</span>
<span class="hljs-quote">&gt;
&gt; 她竟然对你说“喵”？？！！</span>
<span class="hljs-quote">&gt;
&gt; 她竟然对你说“喵”？！？！？？！！</span>

<span class="hljs-section">## 全角和半角</span>

不明白什么是全角（全形）与半角（半形）符号？请查看维基百科条目[<span class="hljs-string">全角和半角</span>](<span class="hljs-link">https://zh.wikipedia.org/wiki/%E5%85%A8%E5%BD%A2%E5%92%8C%E5%8D%8A%E5%BD%A2</span>)。

<span class="hljs-section">### 使用全角中文标点</span>

正确：

<span class="hljs-quote">&gt; 嗨！你知道嘛？今天前台的小妹跟我说“喵”了哎！</span>
<span class="hljs-quote">&gt;
&gt; 核磁共振成像（NMRI）是什么原理都不知道？JFGI！</span>

错误：

<span class="hljs-quote">&gt; 嗨! 你知道嘛? 今天前台的小妹跟我说 "喵" 了哎！</span>
<span class="hljs-quote">&gt;
&gt; 嗨!你知道嘛?今天前台的小妹跟我说"喵"了哎！</span>
<span class="hljs-quote">&gt;
&gt; 核磁共振成像 (NMRI) 是什么原理都不知道? JFGI!</span>
<span class="hljs-quote">&gt;
&gt; 核磁共振成像(NMRI)是什么原理都不知道?JFGI!</span>

例外：中文句子内夹有英文书籍名、报刊名时，不应借用中文书名号，应以英文斜体表示。

<span class="hljs-section">### 数字使用半角字符</span>

正确：

<span class="hljs-quote">&gt; 这个蛋糕只卖 1000 元。</span>

错误：

<span class="hljs-quote">&gt; 这个蛋糕只卖 １０００ 元。</span>

例外：在设计稿、宣传海报中如出现极少量数字的情形时，为方便文字对齐，是可以使用全角数字的。

<span class="hljs-section">### 遇到完整的英文整句、特殊名词，其内容使用半角标点</span>

正确：

<span class="hljs-quote">&gt; 乔布斯那句话是怎么说的？“Stay hungry, stay foolish.”</span>
<span class="hljs-quote">&gt;
&gt; 推荐你阅读 <span class="hljs-emphasis">*Hackers &amp; Painters: Big Ideas from the Computer Age*</span>，非常地有趣。</span>

错误：

<span class="hljs-quote">&gt; 乔布斯那句话是怎么说的？“Stay hungry，stay foolish。”</span>
<span class="hljs-quote">&gt;
&gt; 推荐你阅读《Hackers＆Painters：Big Ideas from the Computer Age》，非常的有趣。</span>

<span class="hljs-section">## 名词</span>

<span class="hljs-section">### 专有名词使用正确的大小写</span>

大小写相关用法原属于英文书写范畴，不属于本 wiki 讨论内容，在这里只对部分易错用法进行简述。

正确：

<span class="hljs-quote">&gt; 使用 GitHub 登录</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 GitHub、Foursquare、Microsoft Corporation、Google、Facebook, Inc.。</span>

错误：

<span class="hljs-quote">&gt; 使用 github 登录</span>
<span class="hljs-quote">&gt;
&gt; 使用 GITHUB 登录</span>
<span class="hljs-quote">&gt;
&gt; 使用 Github 登录</span>
<span class="hljs-quote">&gt;
&gt; 使用 gitHub 登录</span>
<span class="hljs-quote">&gt;
&gt; 使用 gｲんĤЦ8 登录</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 github、foursquare、microsoft corporation、google、facebook, inc.。</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 GITHUB、FOURSQUARE、MICROSOFT CORPORATION、GOOGLE、FACEBOOK, INC.。</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 Github、FourSquare、MicroSoft Corporation、Google、FaceBook, Inc.。</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 gitHub、fourSquare、microSoft Corporation、google、faceBook, Inc.。</span>
<span class="hljs-quote">&gt;
&gt; 我们的客户有 gｲんĤЦ8、ｷouЯƧquﾑгє、๓เςг๏ร๏Ŧt ς๏гק๏гคtเ๏ภn、900913、ƒ4ᄃëв๏๏к, IПᄃ.。</span>

注意：当网页中需要配合整体视觉风格而出现全部大写／小写的情形，HTML 中请使用标淮的大小写规范进行书写；并通过 <span class="hljs-code">`text-transform: uppercase;`</span>／<span class="hljs-code">`text-transform: lowercase;`</span> 对表现形式进行定义。

<span class="hljs-section">### 不要使用不地道的缩写</span>

正确：

<span class="hljs-quote">&gt; 我们需要一位熟悉 TypeScript、HTML5，至少理解一种框架（如 React、Next.js）的前端开发者。</span>

错误：

<span class="hljs-quote">&gt; 我们需要一位熟悉 Ts、h5，至少理解一种框架（如 RJS、nextjs）的 FED。</span>

<span class="hljs-section">## 争议</span>

以下用法略带有个人色彩，即：无论是否遵循下述规则，从语法的角度来讲都是<span class="hljs-strong">**正确**</span>的。

<span class="hljs-section">### 链接之间增加空格</span>

用法：

<span class="hljs-quote">&gt; 请 [<span class="hljs-string">提交一个 issue</span>](<span class="hljs-link">#</span>) 并分配给相关同事。</span>
<span class="hljs-quote">&gt;
&gt; 访问我们网站的最新动态，请 [<span class="hljs-string">点击这里</span>](<span class="hljs-link">#</span>) 进行订阅！</span>

对比用法：

<span class="hljs-quote">&gt; 请[<span class="hljs-string">提交一个 issue</span>](<span class="hljs-link">#</span>)并分配给相关同事。</span>
<span class="hljs-quote">&gt;
&gt; 访问我们网站的最新动态，请[<span class="hljs-string">点击这里</span>](<span class="hljs-link">#</span>)进行订阅！</span>

<span class="hljs-section">### 简体中文使用非直角引号</span>

错误：

<span class="hljs-quote">&gt; 「老师，『有条不紊』的『紊』是什么意思？」</span>

正确：

<span class="hljs-quote">&gt; “老师，‘有条不紊’的‘紊’是什么意思？”</span>
</code></pre>
<ol start="3">
<li>让 AI 记住</li>
</ol>
<p>第一次先通过对话让 AI“短时记住”：</p>
<pre><code class="hljs language-md" lang="md">文案请按照中文文案排版指北，先阅读这份文档 docs/README.zh-Hans.md，给出文档所有正例和反例，等我确认你已经理解再执行代码修改。
</code></pre>
<p>“长期记忆”：将其纳入 <code>project_rules.md</code>：</p>
<pre><code class="hljs language-md" lang="md">文案请按照中文文案排版指北，先阅读这份文档，确认你已经理解再执行代码修改。

重点“中英文之间需要增加空格”：
<span class="hljs-bullet">-</span> 反例：“MCP服务”；正例：“MCP 服务”
<span class="hljs-bullet">-</span> 反例：“确定删除MCP服务?”；正例：“确定删除 MCP 服务？”
</code></pre>
<h2 data-id="heading-8">Trae 的问题</h2>
<h3 data-id="heading-9">不能严格遵循指令</h3>
<p>project_rules.md</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> <span class="hljs-strong">**操作系统**</span>：Windows，但请使用 git bash 运行命令而非 powershell
</code></pre>
<p>即使明确在 project_rules 或对话中告知“<strong>以后记住请使用 git bash 运行命令而非 PowerShell</strong>”。下次运行还是用了 powershell <code>😓 -_-||</code>。powershell 的缺点是有些语法不支持，比如 <code>&amp;&amp;</code>，虽然 Trae 能遇到运行错误自动纠正成 <code>;</code> 但是对话轮数多起来了，达到一个阈值就会让你开启新对话，当然最重要的是生成代码的时间也会无谓增加。</p>
<blockquote>
<p><em>Model thinking limit reached, please enter 'Continue' to get more.</em></p>
</blockquote>
<h2 data-id="heading-10">AI 每日心得</h2>

<p>不要把 AI 当成需要培养的下属，指望它通过“学习”来逐步改进。对于简单的任务，比如一行调整，最好自己动手完成。AI 是工具，它的价值在于帮我们更快完成工作，而不是被反复“调教”去处理那些琐碎、非标准化的细节——你教了这次，下次它大概率还是不会。优化模型是开发者的责任，不是使用者的任务。花时间“训练” AI 适应非标准需求，往往只是浪费时间，下次遇到同样情况，你很可能还要从头再来。</p>
<p>记住：AI 是效率杠杆，而非培养对象。</p>
<h2 data-id="heading-11">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3Fsrc%3D11%26timestamp%3D1763427827%26ver%3D6365%26signature%3DBBTTXkeh7*M5sndWNTRiZs7POnA*SwJXW4zL3ox5stCiIi8R0JxshZssbhzGCxoyNUry4YWDGEFG3pVNNpvwliKjEjc8QgWrGKcWj6*sOA1fiHETOVu1iDQ34d3UxMUQ%26new%3D1" target="_blank" title="https://mp.weixin.qq.com/s?src=11&amp;timestamp=1763427827&amp;ver=6365&amp;signature=BBTTXkeh7*M5sndWNTRiZs7POnA*SwJXW4zL3ox5stCiIi8R0JxshZssbhzGCxoyNUry4YWDGEFG3pVNNpvwliKjEjc8QgWrGKcWj6*sOA1fiHETOVu1iDQ34d3UxMUQ&amp;new=1" ref="nofollow noopener noreferrer">我的Trae大会分享：大厂牛马压箱底的AI编程技巧（附PPT）</a></li>
<li><a href="https://www.trae.ai/blog/trae_tutorial_0825" target="_blank" title="https://www.trae.ai/blog/trae_tutorial_0825" ref="nofollow noopener noreferrer">Best Practices for TRAE Rules</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1939384057369698525" target="_blank" title="https://zhuanlan.zhihu.com/p/1939384057369698525" ref="nofollow noopener noreferrer">TRAE 规则（Rules）配置指南：个人习惯、团队规范与最佳实践</a></li>
<li><a href="https://juejin.cn/post/7576371992615174180" target="_blank" title="https://juejin.cn/post/7576371992615174180">AI 每日心得——AI 是效率杠杆，而非培养对象</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React vs Vue 调度机制深度剖析：从源码到事件循环的完整解读]]></title>    <link>https://juejin.cn/post/7578460753210245147</link>    <guid>https://juejin.cn/post/7578460753210245147</guid>    <pubDate>2025-12-01T08:04:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578460753210245147" data-draft-id="7578442185848471590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" React vs Vue 调度机制深度剖析：从源码到事件循环的完整解读"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-01T08:04:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="特级业务专家"/> <meta itemprop="url" content="https://juejin.cn/user/2101921961481512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             React vs Vue 调度机制深度剖析：从源码到事件循环的完整解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921961481512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    特级业务专家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T08:04:30.000Z" title="Mon Dec 01 2025 08:04:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    31
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文基于 <strong>React 18.2.0</strong> 和 <strong>Vue 3.2.45</strong> 源码分析，带你真正理解两大框架的调度设计差异。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📑 目录</h2>
<ol>
<li><a href="#%E4%B8%80%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%90%86%E8%A7%A3%E8%B0%83%E5%BA%A6%E7%9A%84%E5%9F%BA%E7%A1%80" title="#%E4%B8%80%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E7%90%86%E8%A7%A3%E8%B0%83%E5%BA%A6%E7%9A%84%E5%9F%BA%E7%A1%80">事件循环：理解调度的基础</a></li>
<li><a href="#%E4%BA%8Cvue-3promisethen-%E5%BE%AE%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" title="#%E4%BA%8Cvue-3promisethen-%E5%BE%AE%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">Vue 3：Promise.then 微任务调度（源码解析）</a></li>
<li><a href="#%E4%B8%89react-18messagechannel-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" title="#%E4%B8%89react-18messagechannel-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">React 18：MessageChannel 宏任务调度（源码解析）</a></li>
<li><a href="#%E5%9B%9B%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8-settimeout%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8-raf" title="#%E5%9B%9B%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8-settimeout%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E7%94%A8-raf">为什么不用 setTimeout？为什么不用 rAF？</a></li>
<li><a href="#%E4%BA%94%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%90%AB%E4%B9%89" title="#%E4%BA%94%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87%E7%9A%84%E7%9C%9F%E6%AD%A3%E5%90%AB%E4%B9%89">时间切片的真正含义</a></li>
<li><a href="#%E5%85%AD%E5%8F%AF%E4%B8%AD%E6%96%AD%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" title="#%E5%85%AD%E5%8F%AF%E4%B8%AD%E6%96%AD%E6%B8%B2%E6%9F%93%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">可中断渲染的实现原理</a></li>
<li><a href="#%E4%B8%83%E4%B8%A4%E7%A7%8D%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%9D%83%E8%A1%A1%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF" title="#%E4%B8%83%E4%B8%A4%E7%A7%8D%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%9D%83%E8%A1%A1%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF">两种设计的权衡与适用场景</a></li>
<li><a href="#%E5%85%AB%E6%80%BB%E7%BB%93" title="#%E5%85%AB%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">一、事件循环：理解调度的基础</h2>
<p>在深入源码之前，必须先理解浏览器事件循环的运行机制：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────┐
│                      一轮事件循环                            │
├─────────────────────────────────────────────────────────────┤
│  ① 执行一个宏任务（<span class="hljs-title class_">Script</span> / <span class="hljs-built_in">setTimeout</span> / <span class="hljs-title class_">MessageChannel</span>）   │
│     ↓                                                       │
│  ② 清空所有微任务（<span class="hljs-title class_">Promise</span>.<span class="hljs-property">then</span> / queueMicrotask）          │
│     ↓                                                       │
│  ③ 浏览器判断是否需要渲染                                   │
│     ├─ 是 → 执行 rAF → <span class="hljs-title class_">Layout</span> → <span class="hljs-title class_">Paint</span> → <span class="hljs-title class_">Composite</span>           │
│     └─ 否 → 跳过渲染                                        │
│     ↓                                                       │
│  ④ 进入下一轮事件循环                                       │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-2">🔑 关键结论</h3>




















<table><thead><tr><th>任务类型</th><th>执行时机</th><th>是否阻塞渲染</th></tr></thead><tbody><tr><td><strong>微任务</strong></td><td>当前宏任务结束后立即执行</td><td>✅ 会阻塞（必须清空）</td></tr><tr><td><strong>宏任务</strong></td><td>下一轮事件循环</td><td>❌ 不阻塞（之间有渲染机会）</td></tr></tbody></table>
<p>这个差异是 Vue 和 React 选择不同调度策略的<strong>根本原因</strong>。</p>
<hr/>
<h2 data-id="heading-3">二、Vue 3：Promise.then 微任务调度（源码解析）</h2>
<h3 data-id="heading-4">2.1 nextTick 源码</h3>
<blockquote>
<p>📁 源码位置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Fmain%2Fpackages%2Fruntime-core%2Fsrc%2Fscheduler.ts" target="_blank" title="https://github.com/vuejs/core/blob/main/packages/runtime-core/src/scheduler.ts" ref="nofollow noopener noreferrer">packages/runtime-core/src/scheduler.ts</a></p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Vue 3.2.45 - packages/runtime-core/src/scheduler.ts</span>

<span class="hljs-keyword">const</span> resolvedPromise = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;
<span class="hljs-keyword">let</span> <span class="hljs-attr">currentFlushPromise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> nextTick&lt;T = <span class="hljs-built_in">void</span>&gt;(
  <span class="hljs-attr">this</span>: T,
  fn?: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">this</span>: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>
): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> p = currentFlushPromise || resolvedPromise
  <span class="hljs-keyword">return</span> fn ? p.<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">this</span> ? fn.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>) : fn) : p
}
</code></pre>
<p><strong>极简实现</strong>：<code>nextTick</code> 本质就是 <code>Promise.resolve().then(fn)</code>。</p>
<h3 data-id="heading-5">2.2 任务队列调度源码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Vue 3.2.45 - packages/runtime-core/src/scheduler.ts</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">SchedulerJob</span>[] = []
<span class="hljs-keyword">let</span> isFlushing = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> isFlushPending = <span class="hljs-literal">false</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queueJob</span>(<span class="hljs-params">job: SchedulerJob</span>) {
  <span class="hljs-comment">// 去重：同一个 job 不会重复入队</span>
  <span class="hljs-keyword">if</span> (
    !queue.<span class="hljs-property">length</span> ||
    !queue.<span class="hljs-title function_">includes</span>(
      job,
      isFlushing &amp;&amp; job.<span class="hljs-property">allowRecurse</span> ? flushIndex + <span class="hljs-number">1</span> : flushIndex
    )
  ) {
    <span class="hljs-keyword">if</span> (job.<span class="hljs-property">id</span> == <span class="hljs-literal">null</span>) {
      queue.<span class="hljs-title function_">push</span>(job)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 按 id 排序插入（保证父组件先于子组件更新）</span>
      queue.<span class="hljs-title function_">splice</span>(<span class="hljs-title function_">findInsertionIndex</span>(job.<span class="hljs-property">id</span>), <span class="hljs-number">0</span>, job)
    }
    <span class="hljs-title function_">queueFlush</span>()
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueFlush</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (!isFlushing &amp;&amp; !isFlushPending) {
    isFlushPending = <span class="hljs-literal">true</span>
    <span class="hljs-comment">// 🔥 核心：使用 Promise.then 调度</span>
    currentFlushPromise = resolvedPromise.<span class="hljs-title function_">then</span>(flushJobs)
  }
}
</code></pre>
<h3 data-id="heading-6">2.3 任务执行源码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushJobs</span>(<span class="hljs-params">seen?: CountMap</span>) {
  isFlushPending = <span class="hljs-literal">false</span>
  isFlushing = <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 按 id 排序，确保：</span>
  <span class="hljs-comment">// 1. 父组件先于子组件更新</span>
  <span class="hljs-comment">// 2. 父组件的 watch 先于子组件执行</span>
  queue.<span class="hljs-title function_">sort</span>(comparator)

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">for</span> (flushIndex = <span class="hljs-number">0</span>; flushIndex &lt; queue.<span class="hljs-property">length</span>; flushIndex++) {
      <span class="hljs-keyword">const</span> job = queue[flushIndex]
      <span class="hljs-keyword">if</span> (job &amp;&amp; job.<span class="hljs-property">active</span> !== <span class="hljs-literal">false</span>) {
        <span class="hljs-title function_">callWithErrorHandling</span>(job, <span class="hljs-literal">null</span>, <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SCHEDULER</span>)
      }
    }
  } <span class="hljs-keyword">finally</span> {
    flushIndex = <span class="hljs-number">0</span>
    queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
    isFlushing = <span class="hljs-literal">false</span>
    currentFlushPromise = <span class="hljs-literal">null</span>
  }
}
</code></pre>
<h3 data-id="heading-7">2.4 Vue 更新流程图</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────────┐
│ 同步代码                                                      │
│                                                              │
│   data<span class="hljs-selector-class">.value</span> = 'new'  ──→  触发 setter                       │
│                              ↓                               │
│                         <span class="hljs-built_in">queueJob</span>(componentUpdateFn)          │
│                              ↓                               │
│                         <span class="hljs-built_in">queueFlush</span>()                         │
│                              ↓                               │
│                   Promise<span class="hljs-selector-class">.resolve</span>()<span class="hljs-selector-class">.then</span>(flushJobs)          │
│                              │                               │
└──────────────────────────────│───────────────────────────────┘
                               ↓
┌──────────────────────────────────────────────────────────────┐
│ 微任务阶段                                                    │
│                                                              │
│   <span class="hljs-built_in">flushJobs</span>() 执行                                           │
│       ↓                                                      │
│   queue<span class="hljs-selector-class">.sort</span>()  ──→  按 id 排序                              │
│       ↓                                                      │
│   遍历执行所有 job  ──→  patch DOM                           │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                               ↓
┌──────────────────────────────────────────────────────────────┐
│ 浏览器渲染                                                    │
│   Layout → Paint → Composite                                 │
└──────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-8">2.5 Vue 选择微任务的原因</h3>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>更新极快</strong></td><td>数据变更后，在同一轮事件循环内完成 DOM 更新</td></tr><tr><td><strong>批量优化</strong></td><td>多次数据变更只触发一次 DOM 更新（去重 + 排序）</td></tr><tr><td><strong>实现简单</strong></td><td>不需要复杂的调度器，代码量极少</td></tr><tr><td><strong>符合直觉</strong></td><td>同步代码执行完毕后，DOM 立即反映最新状态</td></tr></tbody></table>
<p><strong>Vue 的设计哲学</strong>：响应式系统 + 编译优化已经让 patch 开销足够小，不需要可中断渲染。</p>
<hr/>
<h2 data-id="heading-9">三、React 18：MessageChannel 宏任务调度（源码解析）</h2>
<h3 data-id="heading-10">3.1 调度入口源码</h3>
<blockquote>
<p>📁 源码位置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2Fmain%2Fpackages%2Fscheduler%2Fsrc%2Fforks%2FScheduler.js" target="_blank" title="https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js" ref="nofollow noopener noreferrer">packages/scheduler/src/forks/Scheduler.js</a></p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-keyword">let</span> schedulePerformWorkUntilDeadline;

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MessageChannel</span> !== <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-comment">// 🔥 核心：使用 MessageChannel 调度宏任务</span>
  <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
  <span class="hljs-keyword">const</span> port = channel.<span class="hljs-property">port2</span>;
  
  channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = performWorkUntilDeadline;
  
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
  };
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 降级方案：setTimeout</span>
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(performWorkUntilDeadline, <span class="hljs-number">0</span>);
  };
}
</code></pre>
<p><strong>注意</strong>：React <strong>只用 MessageChannel</strong>，不依赖 <code>requestAnimationFrame</code>！</p>
<h3 data-id="heading-11">3.2 时间切片核心源码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-comment">// 每个时间切片的默认时长：5ms</span>
<span class="hljs-keyword">let</span> frameInterval = <span class="hljs-number">5</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">performWorkUntilDeadline</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (scheduledHostCallback !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>();
    
    <span class="hljs-comment">// 🔥 关键：计算本次切片的截止时间</span>
    startTime = currentTime;
    <span class="hljs-keyword">const</span> hasTimeRemaining = <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">let</span> hasMoreWork = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 执行任务，返回是否还有剩余任务</span>
      hasMoreWork = <span class="hljs-title function_">scheduledHostCallback</span>(hasTimeRemaining, currentTime);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (hasMoreWork) {
        <span class="hljs-comment">// 🔥 还有任务，调度下一个宏任务继续执行</span>
        <span class="hljs-title function_">schedulePerformWorkUntilDeadline</span>();
      } <span class="hljs-keyword">else</span> {
        isMessageLoopRunning = <span class="hljs-literal">false</span>;
        scheduledHostCallback = <span class="hljs-literal">null</span>;
      }
    }
  } <span class="hljs-keyword">else</span> {
    isMessageLoopRunning = <span class="hljs-literal">false</span>;
  }
};
</code></pre>
<h3 data-id="heading-12">3.3 任务循环与时间检查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">hasTimeRemaining, initialTime</span>) {
  <span class="hljs-keyword">let</span> currentTime = initialTime;
  <span class="hljs-title function_">advanceTimers</span>(currentTime);
  currentTask = <span class="hljs-title function_">peek</span>(taskQueue);
  
  <span class="hljs-keyword">while</span> (
    currentTask !== <span class="hljs-literal">null</span> &amp;&amp;
    !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)
  ) {
    <span class="hljs-keyword">if</span> (
      currentTask.<span class="hljs-property">expirationTime</span> &gt; currentTime &amp;&amp;
      <span class="hljs-comment">// 🔥 关键：检查是否应该让出控制权</span>
      (!hasTimeRemaining || <span class="hljs-title function_">shouldYieldToHost</span>())
    ) {
      <span class="hljs-comment">// 时间片用完，跳出循环，让出主线程</span>
      <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-keyword">const</span> callback = currentTask.<span class="hljs-property">callback</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
      currentTask.<span class="hljs-property">callback</span> = <span class="hljs-literal">null</span>;
      currentPriorityLevel = currentTask.<span class="hljs-property">priorityLevel</span>;
      
      <span class="hljs-keyword">const</span> didUserCallbackTimeout = 
        currentTask.<span class="hljs-property">expirationTime</span> &lt;= currentTime;
      
      <span class="hljs-comment">// 执行任务</span>
      <span class="hljs-keyword">const</span> continuationCallback = <span class="hljs-title function_">callback</span>(didUserCallbackTimeout);
      
      currentTime = <span class="hljs-title function_">getCurrentTime</span>();
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> continuationCallback === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// 任务未完成，保留继续执行</span>
        currentTask.<span class="hljs-property">callback</span> = continuationCallback;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (currentTask === <span class="hljs-title function_">peek</span>(taskQueue)) {
          <span class="hljs-title function_">pop</span>(taskQueue);
        }
      }
      
      <span class="hljs-title function_">advanceTimers</span>(currentTime);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">pop</span>(taskQueue);
    }
    
    currentTask = <span class="hljs-title function_">peek</span>(taskQueue);
  }
  
  <span class="hljs-comment">// 返回是否还有剩余任务</span>
  <span class="hljs-keyword">return</span> currentTask !== <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-13">3.4 让出控制权的判断逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldYieldToHost</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timeElapsed = <span class="hljs-title function_">getCurrentTime</span>() - startTime;
  
  <span class="hljs-keyword">if</span> (timeElapsed &lt; frameInterval) {
    <span class="hljs-comment">// 时间片未用完，继续执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 🔥 时间片用完，应该让出控制权</span>
  <span class="hljs-comment">// 让浏览器有机会渲染和响应用户输入</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 data-id="heading-14">3.5 React 更新流程图</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────────┐
│ 同步代码                                                      │
│                                                              │
│   <span class="hljs-built_in">setState</span>({ count: <span class="hljs-number">1</span> })  ──→  创建 Update 对象              │
│                                  ↓                           │
│                           <span class="hljs-built_in">scheduleUpdateOnFiber</span>()            │
│                                  ↓                           │
│                           <span class="hljs-built_in">ensureRootIsScheduled</span>()            │
│                                  ↓                           │
│                    <span class="hljs-built_in">scheduleCallback</span>(bindPerformWork)         │
│                                  ↓                           │
│                    MessageChannel<span class="hljs-selector-class">.postMessage</span>()              │
│                                  │                           │
└──────────────────────────────────│───────────────────────────┘
                                   ↓
┌──────────────────────────────────────────────────────────────┐
│ 微任务阶段（如有）                                            │
│   清空微任务队列                                              │
└──────────────────────────────────────────────────────────────┘
                                   ↓
┌──────────────────────────────────────────────────────────────┐
│ 🎨 浏览器渲染机会                                             │
│   可能发生：Layout / Paint / 用户输入响应                     │
└──────────────────────────────────────────────────────────────┘
                                   ↓
┌──────────────────────────────────────────────────────────────┐
│ 下一个宏任务                                                  │
│                                                              │
│   <span class="hljs-built_in">performWorkUntilDeadline</span>()                                 │
│       ↓                                                      │
│   <span class="hljs-built_in">workLoop</span>()  ──→  执行 Fiber 任务                           │
│       ↓                                                      │
│   <span class="hljs-built_in">shouldYieldToHost</span>()  ──→  检查是否需要让出                 │
│       ├─ 是 → <span class="hljs-built_in">postMessage</span>() 调度下一个切片                   │
│       └─ 否 → 继续执行当前任务                               │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                                   ↓
                            （循环直到完成）
                                   ↓
┌──────────────────────────────────────────────────────────────┐
│ Commit 阶段                                                   │
│   同步执行，不可中断                                          │
│   真正修改 DOM                                                │
└──────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-15">四、为什么不用 setTimeout？为什么不用 rAF？</h2>
<h3 data-id="heading-16">4.1 为什么不用 <code>setTimeout(fn, 0)</code>？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 源码注释 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-comment">// setTimeout 的问题：</span>
<span class="hljs-comment">// 1. 浏览器规范规定嵌套调用超过 5 次后，最小延迟为 4ms</span>
<span class="hljs-comment">// 2. 这会导致调度延迟累积，影响性能</span>

<span class="hljs-comment">// 实验证明：</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 这里开始，每次调用至少延迟 4ms</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'delay &gt;= 4ms'</span>);
        }, <span class="hljs-number">0</span>);
      }, <span class="hljs-number">0</span>);
    }, <span class="hljs-number">0</span>);
  }, <span class="hljs-number">0</span>);
}, <span class="hljs-number">0</span>);
</code></pre>
<p><strong>MessageChannel 的优势</strong>：没有 4ms 的最小延迟限制，可以更精确地控制时间切片。</p>
<h3 data-id="heading-17">4.2 为什么不用 <code>requestAnimationFrame</code>？</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 很多文章误以为 React 使用 rAF，实际上：</span>

<span class="hljs-comment">// ❌ 不使用 rAF 的原因：</span>
<span class="hljs-comment">// 1. rAF 受浏览器刷新率限制（通常 16.67ms 一次）</span>
<span class="hljs-comment">// 2. 后台标签页中 rAF 会暂停</span>
<span class="hljs-comment">// 3. rAF 的触发时机不稳定</span>

<span class="hljs-comment">// ✅ MessageChannel 的优势：</span>
<span class="hljs-comment">// 1. 不受帧率限制</span>
<span class="hljs-comment">// 2. 后台标签页仍然工作</span>
<span class="hljs-comment">// 3. 调度时机更可控</span>
</code></pre>
<h3 data-id="heading-18">4.3 源码中的降级策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/scheduler/src/forks/Scheduler.js</span>

<span class="hljs-keyword">let</span> schedulePerformWorkUntilDeadline;

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MessageChannel</span> !== <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-comment">// 首选：MessageChannel</span>
  <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
  <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 降级：setTimeout（仅在不支持 MessageChannel 的环境）</span>
  schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(performWorkUntilDeadline, <span class="hljs-number">0</span>);
  };
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、时间切片的真正含义</h2>
<h3 data-id="heading-20">5.1 误解澄清</h3>
<p>很多文章展示这样的示意图：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[chunk1]</span> — 渲染 — <span class="hljs-selector-attr">[chunk2]</span> — 渲染 — <span class="hljs-selector-attr">[chunk3]</span> — 渲染 — ...
</code></pre>
<p><strong>这是不准确的</strong>！正确的理解是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[chunk1]</span> — 渲染机会 — <span class="hljs-selector-attr">[chunk2]</span> — 渲染机会 — <span class="hljs-selector-attr">[chunk3]</span> — 渲染机会 — ...
          ↑                    ↑                    ↑
        可能渲染             可能渲染             可能渲染
        可能响应输入         可能响应输入         可能响应输入
        可能什么都不做       可能什么都不做       可能什么都不做
</code></pre>
<h3 data-id="heading-21">5.2 浏览器决定是否渲染</h3>
<p>浏览器在每个宏任务之间会<strong>判断</strong>是否需要渲染：</p>
<ul>
<li>有 DOM 变更需要反映？→ 渲染</li>
<li>有动画帧需要更新？→ 渲染</li>
<li>没有视觉变化？→ 跳过渲染，直接执行下一个宏任务</li>
</ul>
<h3 data-id="heading-22">5.3 时间切片的核心价值</h3>





















<table><thead><tr><th>价值</th><th>说明</th></tr></thead><tbody><tr><td><strong>响应用户输入</strong></td><td>长任务期间，用户点击/输入可以被处理</td></tr><tr><td><strong>保持动画流畅</strong></td><td>动画帧可以在切片之间执行</td></tr><tr><td><strong>避免页面卡死</strong></td><td>复杂渲染不会阻塞整个页面</td></tr></tbody></table>
<h3 data-id="heading-23">5.4 实验验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 验证微任务会阻塞渲染</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">blockWithMicrotasks</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">task</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">10</span>) {} <span class="hljs-comment">// 阻塞 10ms</span>
    count++;
    <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">100</span>) {
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(task); <span class="hljs-comment">// 微任务</span>
    }
  }
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(task);
}
<span class="hljs-comment">// 结果：页面完全卡住 ~1 秒</span>

<span class="hljs-comment">// 验证宏任务之间有渲染机会</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">blockWithMacrotasks</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  
  channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">10</span>) {} <span class="hljs-comment">// 阻塞 10ms</span>
    count++;
    <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">100</span>) {
      channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 宏任务</span>
    }
  };
  channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
}
<span class="hljs-comment">// 结果：页面仍然可以响应，动画流畅</span>
</code></pre>
<h3 data-id="heading-24">5.5 🚨 常见误解澄清（很多前端不知道的真相）</h3>
<p>这是事件循环中一个<strong>常见盲区</strong>——很多人背诵"宏任务→微任务→渲染"，但错误地理解成"每次都渲染"。</p>
<h4 data-id="heading-25">误解 vs 真相</h4>

























<table><thead><tr><th>误解</th><th>真相</th></tr></thead><tbody><tr><td>"每个宏任务后都会渲染"</td><td>❌ 浏览器<strong>按需渲染</strong>，可能连续执行多个宏任务后才渲染一次</td></tr><tr><td>"60fps = 每 16.67ms 必渲染"</td><td>❌ 没有视觉变化时浏览器会跳过，省电省资源</td></tr><tr><td>"rAF 每 16.67ms 触发一次"</td><td>❌ 后台标签页可能降到 1fps 甚至完全暂停</td></tr><tr><td>"JS 可以强制浏览器渲染"</td><td>❌ JS 只能"请求"，浏览器自己决定何时渲染</td></tr></tbody></table>
<h4 data-id="heading-26">浏览器的渲染决策流程</h4>
<pre><code class="hljs language-css" lang="css">宏任务 <span class="hljs-selector-tag">A</span> 完成
    ↓
微任务清空
    ↓
┌─────────────────────────────────────┐
│  浏览器判断：需要渲染吗？            │
│                                     │
│  ✅ 需要渲染的情况：                 │
│    • 有 DOM 变更待反映              │
│    • 有 CSS 动画/过渡在进行          │
│    • 有 rAF 回调等待执行             │
│    • 距离上次渲染已过 ~<span class="hljs-number">16.67ms</span>       │
│                                     │
│  ❌ 跳过渲染的情况：                 │
│    • 没有任何视觉变化               │
│    • 距离上次渲染太短（&lt;<span class="hljs-number">16.67ms</span>）    │
│    • 页面在后台标签页               │
└─────────────────────────────────────┘
    ↓
宏任务 <span class="hljs-selector-tag">B</span> 开始
</code></pre>
<p><strong>关键点</strong>：这个决策<strong>完全由浏览器控制</strong>，JavaScript 无法干预。</p>
<h4 data-id="heading-27">实验证明</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果每个宏任务后都渲染，1000 个宏任务需要 16.67s</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
<span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();

channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  count++;
  <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">1000</span>) {
    channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`完成：<span class="hljs-subst">${performance.now() - start}</span>ms`</span>);
    <span class="hljs-comment">// 实际结果：~10-20ms</span>
    <span class="hljs-comment">// 证明：绝大多数宏任务之间没有发生渲染</span>
  }
};
channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
</code></pre>
<h4 data-id="heading-28">为什么这个知识点重要？</h4>
<p>理解这点后，你会真正明白：</p>
<ol>
<li>
<p><strong>React 时间切片不是"让浏览器每次都渲染"</strong>
→ 而是"给浏览器机会做它想做的事"（渲染、响应输入、或什么都不做）</p>
</li>
<li>
<p><strong>rAF 不是定时器</strong>
→ 而是浏览器说"我决定要渲染了，你有啥要准备的吗？"</p>
</li>
<li>
<p><strong>性能优化的本质</strong>
→ 不是"让渲染更快"，而是"别挡着浏览器的路"</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-29">六、可中断渲染的实现原理</h2>
<h3 data-id="heading-30">6.1 Fiber 架构是基础</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React Fiber 节点结构（简化）</span>
interface <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-attr">type</span>: any;
  <span class="hljs-attr">child</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 第一个子节点</span>
  <span class="hljs-attr">sibling</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>;    <span class="hljs-comment">// 下一个兄弟节点</span>
  <span class="hljs-attr">return</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 父节点</span>
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// Fiber 树可以通过链表遍历，随时暂停和恢复</span>
</code></pre>
<h3 data-id="heading-31">6.2 workLoopConcurrent 源码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 18.2.0 - packages/react-reconciler/src/ReactFiberWorkLoop.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 🔥 关键：每处理一个 Fiber 节点，都检查是否需要让出</span>
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {
    <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;
  
  <span class="hljs-comment">// beginWork: 处理当前节点</span>
  <span class="hljs-keyword">let</span> next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, renderLanes);
  
  unitOfWork.<span class="hljs-property">memoizedProps</span> = unitOfWork.<span class="hljs-property">pendingProps</span>;
  
  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 没有子节点，完成当前节点</span>
    <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 有子节点，下次处理子节点</span>
    workInProgress = next;
  }
}
</code></pre>
<h3 data-id="heading-32">6.3 中断与恢复的流程</h3>
<pre><code class="hljs language-scss" lang="scss">                    开始渲染
                       ↓
┌──────────────────────────────────────┐
│  <span class="hljs-built_in">workLoopConcurrent</span>()                │
│                                      │
│  while (workInProgress &amp;&amp; !yield) {  │
│    <span class="hljs-built_in">performUnitOfWork</span>(fiber)          │
│  }                                   │
│                                      │
│  ← 时间片用完，<span class="hljs-built_in">shouldYield</span>() = true  │
└──────────────────────────────────────┘
                       ↓
               保存 workInProgress
                       ↓
             postMessage 调度下一个切片
                       ↓
              浏览器渲染/响应输入
                       ↓
┌──────────────────────────────────────┐
│  下一个切片继续从 workInProgress     │
│  继续遍历 Fiber 树                   │
└──────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-33">七、两种设计的权衡与适用场景</h2>
<h3 data-id="heading-34">7.1 核心对比</h3>













































<table><thead><tr><th>维度</th><th>Vue 3 (Promise.then)</th><th>React 18 (MessageChannel)</th></tr></thead><tbody><tr><td><strong>调度类型</strong></td><td>微任务</td><td>宏任务</td></tr><tr><td><strong>更新延迟</strong></td><td>~0ms（同一轮事件循环）</td><td>~0-5ms（下一轮事件循环）</td></tr><tr><td><strong>可中断</strong></td><td>❌ 不可中断</td><td>✅ 可中断</td></tr><tr><td><strong>优先级调度</strong></td><td>❌ 无</td><td>✅ 有（Lane 模型）</td></tr><tr><td><strong>时间切片</strong></td><td>❌ 无</td><td>✅ 有（5ms 切片）</td></tr><tr><td><strong>实现复杂度</strong></td><td>简单（~200 行）</td><td>复杂（~1000+ 行）</td></tr><tr><td><strong>调试难度</strong></td><td>低</td><td>高</td></tr></tbody></table>
<h3 data-id="heading-35">7.2 适用场景</h3>
<p><strong>Vue 更适合</strong>：</p>
<ul>
<li>中小型应用</li>
<li>表单/列表/CRUD 类应用</li>
<li>需要快速响应的交互</li>
<li>团队规模较小</li>
</ul>
<p><strong>React 更适合</strong>：</p>
<ul>
<li>大型复杂应用</li>
<li>高频动画 + 复杂 UI 同时存在</li>
<li>需要 Suspense 数据加载</li>
<li>有并发渲染需求</li>
</ul>
<h3 data-id="heading-36">7.3 Vue 为什么不需要时间切片？</h3>
<pre><code class="hljs language-markdown" lang="markdown">Vue 的优化策略：
<span class="hljs-code">                                           
┌─────────────────────────────────────────┐
│  编译时优化                              │
│  • 静态节点提升                          │
│  • patchFlag 标记动态节点                │
│  • 事件处理函数缓存                      │
└─────────────────────────────────────────┘
              ↓ 结合
┌─────────────────────────────────────────┐
│  响应式精确追踪                          │
│  • 只更新依赖变化的组件                  │
│  • 不需要 shouldComponentUpdate          │
└─────────────────────────────────────────┘
              ↓ 结果
┌─────────────────────────────────────────┐
│  patch 开销极小                          │
│  • 大多数情况下 &lt; 1ms                    │
│  • 不需要可中断渲染                      │
└─────────────────────────────────────────┘
</span></code></pre>
<hr/>
<h2 data-id="heading-37">八、总结</h2>
<h3 data-id="heading-38">📊 一图总结</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                        事件循环与框架调度                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Vue <span class="hljs-number">3</span>                          React <span class="hljs-number">18</span>                        │
│  ┌─────────────┐                ┌─────────────┐                 │
│  │ setState    │                │ setState    │                 │
│  └──────┬──────┘                └──────┬──────┘                 │
│         ↓                              ↓                        │
│  ┌─────────────┐                ┌─────────────┐                 │
│  │ queueJob    │                │ schedule    │                 │
│  │ (去重/排序) │                │ Callback    │                 │
│  └──────┬──────┘                └──────┬──────┘                 │
│         ↓                              ↓                        │
│  ┌─────────────┐                ┌─────────────┐                 │
│  │ Promise     │                │ Message     │                 │
│  │ <span class="hljs-selector-class">.then</span>()     │                │ Channel     │                 │
│  │ (微任务)    │                │ (宏任务)    │                 │
│  └──────┬──────┘                └──────┬──────┘                 │
│         ↓                              ↓                        │
│  ┌─────────────┐                ┌─────────────┐                 │
│  │ flushJobs   │                │ 浏览器渲染  │ ← 渲染机会！    │
│  │ patch DOM   │                │ 机会        │                 │
│  └──────┬──────┘                └──────┬──────┘                 │
│         ↓                              ↓                        │
│  ┌─────────────┐                ┌─────────────┐                 │
│  │ 浏览器渲染  │                │ workLoop    │                 │
│  └─────────────┘                │ Fiber 处理  │                 │
│                                 │ (可中断)    │                 │
│                                 └──────┬──────┘                 │
│                                        ↓                        │
│                                 ┌─────────────┐                 │
│                                 │ 时间片用完? │                 │
│                                 │ postMessage │                 │
│                                 │ 继续调度    │                 │
│                                 └─────────────┘                 │
│                                                                 │
│  特点：快速、简单、不可中断     特点：可中断、可调度、复杂       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-39">🎯 核心结论</h3>
<ol>
<li>
<p><strong>Vue 使用 <code>Promise.then</code>（微任务）</strong></p>
<ul>
<li>更新极快，同一轮事件循环内完成</li>
<li>简单高效，编译优化 + 响应式让 patch 开销很小</li>
<li>不需要可中断，因为不需要</li>
</ul>
</li>
<li>
<p><strong>React 使用 <code>MessageChannel</code>（宏任务）</strong></p>
<ul>
<li>宏任务之间有渲染机会，不阻塞页面</li>
<li>支持时间切片（5ms 一个切片）</li>
<li>支持可中断渲染（Fiber 架构）</li>
<li><strong>不使用 rAF</strong>（常见误解！）</li>
</ul>
</li>
<li>
<p><strong>选择差异源于设计目标不同</strong></p>
<ul>
<li>Vue：追求<strong>简单高效</strong>，响应式 + 编译优化解决性能问题</li>
<li>React：追求<strong>可控调度</strong>，Fiber + Scheduler 解决复杂场景</li>
</ul>
</li>
<li>
<p><strong>没有绝对的优劣</strong></p>
<ul>
<li>小型应用：Vue 的同步更新更直观</li>
<li>大型应用：React 的调度能力更强</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-40">📚 参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Fmain%2Fpackages%2Fruntime-core%2Fsrc%2Fscheduler.ts" target="_blank" title="https://github.com/vuejs/core/blob/main/packages/runtime-core/src/scheduler.ts" ref="nofollow noopener noreferrer">Vue 3 Scheduler 源码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fblob%2Fmain%2Fpackages%2Fscheduler%2Fsrc%2Fforks%2FScheduler.js" target="_blank" title="https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js" ref="nofollow noopener noreferrer">React Scheduler 源码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fwebappapis.html%23event-loops" target="_blank" title="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops" ref="nofollow noopener noreferrer">HTML Living Standard - Event Loop</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FMessageChannel" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel" ref="nofollow noopener noreferrer">MessageChannel MDN 文档</a></li>
</ol>
<hr/>
<blockquote>
<p>💡 <strong>作者注</strong>：本文所有源码引用基于 React 18.2.0 和 Vue 3.2.45，如有更新请以官方仓库为准。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[判断dom元素是否在可视区域的常规方式]]></title>    <link>https://juejin.cn/post/7578667193320767551</link>    <guid>https://juejin.cn/post/7578667193320767551</guid>    <pubDate>2025-12-01T09:08:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578667193320767551" data-draft-id="7577171133432479785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="判断dom元素是否在可视区域的常规方式"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-01T09:08:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            判断dom元素是否在可视区域的常规方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T09:08:45.000Z" title="Mon Dec 01 2025 09:08:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. Intersection Observer API（推荐）</h2>
<p>这是现代浏览器推荐的方法，性能最好，异步执行，不会阻塞主线程。</p>
<h3 data-id="heading-1">基础用法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建观察器</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素进入可视区域'</span>, entry.<span class="hljs-property">target</span>);
      <span class="hljs-comment">// 可以在这里执行懒加载等操作</span>
      entry.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'visible'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素离开可视区域'</span>, entry.<span class="hljs-property">target</span>);
      entry.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'visible'</span>);
    }
  });
});

<span class="hljs-comment">// 观察元素</span>
<span class="hljs-keyword">const</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.watch-element'</span>);
elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> observer.<span class="hljs-title function_">observe</span>(el));
</code></pre>
<h3 data-id="heading-2">高级配置</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> options = {
  <span class="hljs-comment">// root: 指定根元素，默认为浏览器视窗</span>
  <span class="hljs-attr">root</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 或者指定特定元素，如 document.querySelector('.container')</span>
  
  <span class="hljs-comment">// rootMargin: 根的外边距，可以扩大或缩小根的边界框</span>
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'10px 0px -100px 0px'</span>, <span class="hljs-comment">// 上右下左，类似CSS margin</span>
  
  <span class="hljs-comment">// threshold: 触发回调的可见比例</span>
  <span class="hljs-attr">threshold</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">1</span>] <span class="hljs-comment">// 在0%, 25%, 50%, 75%, 100%可见时触发</span>
};

<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> visiblePercentage = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(entry.<span class="hljs-property">intersectionRatio</span> * <span class="hljs-number">100</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`元素可见 <span class="hljs-subst">${visiblePercentage}</span>%`</span>);
    
    <span class="hljs-comment">// 根据可见比例执行不同操作</span>
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">intersectionRatio</span> &gt; <span class="hljs-number">0.5</span>) {
      <span class="hljs-comment">// 超过50%可见</span>
      entry.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'mostly-visible'</span>);
    }
  });
}, options);
</code></pre>
<h3 data-id="heading-3">实用工具函数</h3>
<pre><code class="hljs language-ini" lang="ini">// 封装的工具函数
function createVisibilityObserver(<span class="hljs-attr">options</span> = {}) {
  const <span class="hljs-attr">defaultOptions</span> = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">finalOptions</span> = { ...defaultOptions, ...options }<span class="hljs-comment">;</span>
  
  return new IntersectionObserver((entries) =&gt; {
    entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
      const <span class="hljs-attr">element</span> = entry.target<span class="hljs-comment">;</span>
      const <span class="hljs-attr">isVisible</span> = entry.isIntersecting<span class="hljs-comment">;</span>
      
      // 触发自定义事件
      element.dispatchEvent(new CustomEvent('visibilityChange', {
        detail: { isVisible, entry }
      }))<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, finalOptions)<span class="hljs-comment">;</span>
}

// 使用示例
const <span class="hljs-attr">observer</span> = createVisibilityObserver({ threshold: <span class="hljs-number">0.5</span> })<span class="hljs-comment">;</span>

document.querySelectorAll('.lazy-load').forEach(<span class="hljs-attr">element</span> =&gt; {
  observer.observe(element)<span class="hljs-comment">;</span>
  
  element.addEventListener('visibilityChange', (e) =&gt; {
    if (e.detail.isVisible) {
      // 执行懒加载
      const <span class="hljs-attr">img</span> = element.querySelector(<span class="hljs-string">'img[data-src]'</span>)<span class="hljs-comment">;</span>
      if (img) {
        <span class="hljs-attr">img.src</span> = img.dataset.src<span class="hljs-comment">;</span>
        img.removeAttribute('data-src')<span class="hljs-comment">;</span>
      }
    }
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-4">2. getBoundingClientRect() 方法</h2>
<p>传统方法，同步执行，需要手动调用。</p>
<h3 data-id="heading-5">基础用法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isInViewport</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-keyword">const</span> rect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> windowHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientHeight</span>;
  <span class="hljs-keyword">const</span> windowWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span>;
  
  <span class="hljs-keyword">return</span> (
    rect.<span class="hljs-property">top</span> &gt;= <span class="hljs-number">0</span> &amp;&amp;
    rect.<span class="hljs-property">left</span> &gt;= <span class="hljs-number">0</span> &amp;&amp;
    rect.<span class="hljs-property">bottom</span> &lt;= windowHeight &amp;&amp;
    rect.<span class="hljs-property">right</span> &lt;= windowWidth
  );
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.target'</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">isInViewport</span>(element)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素完全在视窗内'</span>);
}
</code></pre>
<h3 data-id="heading-6">部分可见判断</h3>
<pre><code class="hljs language-ini" lang="ini">function isPartiallyInViewport(element) {
  const <span class="hljs-attr">rect</span> = element.getBoundingClientRect()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">windowHeight</span> = window.innerHeight || document.documentElement.clientHeight<span class="hljs-comment">;</span>
  const <span class="hljs-attr">windowWidth</span> = window.innerWidth || document.documentElement.clientWidth<span class="hljs-comment">;</span>
  
  return (
    rect.bottom &gt; 0 &amp;&amp;
    rect.top &lt; windowHeight &amp;&amp;
    rect.right &gt; 0 &amp;&amp;
    rect.left &lt; windowWidth
  )<span class="hljs-comment">;</span>
}

// 更详细的可见性信息
function getVisibilityInfo(element) {
  const <span class="hljs-attr">rect</span> = element.getBoundingClientRect()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">windowHeight</span> = window.innerHeight<span class="hljs-comment">;</span>
  const <span class="hljs-attr">windowWidth</span> = window.innerWidth<span class="hljs-comment">;</span>
  
  // 计算可见区域
  const <span class="hljs-attr">visibleTop</span> = Math.max(<span class="hljs-number">0</span>, rect.top)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleLeft</span> = Math.max(<span class="hljs-number">0</span>, rect.left)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleBottom</span> = Math.min(windowHeight, rect.bottom)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleRight</span> = Math.min(windowWidth, rect.right)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">visibleWidth</span> = Math.max(<span class="hljs-number">0</span>, visibleRight - visibleLeft)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleHeight</span> = Math.max(<span class="hljs-number">0</span>, visibleBottom - visibleTop)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleArea</span> = visibleWidth * visibleHeight<span class="hljs-comment">;</span>
  const <span class="hljs-attr">totalArea</span> = rect.width * rect.height<span class="hljs-comment">;</span>
  
  return {
    isVisible: visibleArea &gt; 0,
    isFullyVisible: isInViewport(element),
    visibilityRatio: totalArea &gt; 0 ? visibleArea / totalArea : 0,
    rect: rect,
    visibleArea: { width: visibleWidth, height: visibleHeight }
  }<span class="hljs-comment">;</span>
}

// 使用示例
const <span class="hljs-attr">element</span> = document.querySelector(<span class="hljs-string">'.target'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">info</span> = getVisibilityInfo(element)<span class="hljs-comment">;</span>
console.log(`可见比例: ${(info.visibilityRatio * 100).toFixed(2)}%`)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-7">滚动监听版本</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollVisibilityTracker</span> {
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.elements = new Map();
    <span class="hljs-keyword">this</span>.threshold = options.threshold || <span class="hljs-number">0.1</span>;
    <span class="hljs-keyword">this</span>.throttleDelay = options.throttleDelay || <span class="hljs-number">100</span>;
    
    <span class="hljs-keyword">this</span>.checkVisibility = <span class="hljs-keyword">this</span>.throttle(<span class="hljs-keyword">this</span>.checkVisibility.bind(<span class="hljs-keyword">this</span>), <span class="hljs-keyword">this</span>.throttleDelay);
    <span class="hljs-keyword">this</span>.bindEvents();
  }
  
  observe(element, callback) {
    <span class="hljs-keyword">this</span>.elements.<span class="hljs-keyword">set</span>(element, {
      callback,
      wasVisible: <span class="hljs-literal">false</span>
    });
    
    <span class="hljs-comment">// 初始检查</span>
    <span class="hljs-keyword">this</span>.checkElement(element);
  }
  
  unobserve(element) {
    <span class="hljs-keyword">this</span>.elements.delete(element);
  }
  
  checkVisibility() {
    <span class="hljs-keyword">this</span>.elements.forEach((<span class="hljs-keyword">data</span>, element) =&gt; {
      <span class="hljs-keyword">this</span>.checkElement(element);
    });
  }
  
  checkElement(element) {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = <span class="hljs-keyword">this</span>.elements.<span class="hljs-keyword">get</span>(element);
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">data</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> info = getVisibilityInfo(element);
    <span class="hljs-keyword">const</span> isVisible = info.visibilityRatio &gt;= <span class="hljs-keyword">this</span>.threshold;
    
    <span class="hljs-keyword">if</span> (isVisible !== <span class="hljs-keyword">data</span>.wasVisible) {
      <span class="hljs-keyword">data</span>.wasVisible = isVisible;
      <span class="hljs-keyword">data</span>.callback(isVisible, info);
    }
  }
  
  bindEvents() {
    window.addEventListener(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">this</span>.checkVisibility, { passive: <span class="hljs-literal">true</span> });
    window.addEventListener(<span class="hljs-string">'resize'</span>, <span class="hljs-keyword">this</span>.checkVisibility);
  }
  
  destroy() {
    window.removeEventListener(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">this</span>.checkVisibility);
    window.removeEventListener(<span class="hljs-string">'resize'</span>, <span class="hljs-keyword">this</span>.checkVisibility);
    <span class="hljs-keyword">this</span>.elements.clear();
  }
  
  throttle(func, delay) {
    let timeoutId;
    let lastExecTime = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">return</span> function (...args) {
      <span class="hljs-keyword">const</span> currentTime = Date.now();
      
      <span class="hljs-keyword">if</span> (currentTime - lastExecTime &gt; delay) {
        func.apply(<span class="hljs-keyword">this</span>, args);
        lastExecTime = currentTime;
      } <span class="hljs-keyword">else</span> {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() =&gt; {
          func.apply(<span class="hljs-keyword">this</span>, args);
          lastExecTime = Date.now();
        }, delay - (currentTime - lastExecTime));
      }
    };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> tracker = new ScrollVisibilityTracker({ threshold: <span class="hljs-number">0.5</span> });

document.querySelectorAll(<span class="hljs-string">'.track-element'</span>).forEach(element =&gt; {
  tracker.observe(element, (isVisible, info) =&gt; {
    <span class="hljs-keyword">if</span> (isVisible) {
      element.classList.add(<span class="hljs-string">'in-view'</span>);
      console.log(<span class="hljs-string">'元素进入视窗'</span>, info);
    } <span class="hljs-keyword">else</span> {
      element.classList.remove(<span class="hljs-string">'in-view'</span>);
    }
  });
});
</code></pre>
<h2 data-id="heading-8">3. 特殊场景的解决方案</h2>
<h3 data-id="heading-9">在滚动容器中的元素</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isInScrollContainer</span>(<span class="hljs-params">element, container</span>) {
  <span class="hljs-keyword">const</span> elementRect = element.<span class="hljs-title function_">getBoundingClientRect</span>();
  <span class="hljs-keyword">const</span> containerRect = container.<span class="hljs-title function_">getBoundingClientRect</span>();
  
  <span class="hljs-keyword">return</span> (
    elementRect.<span class="hljs-property">top</span> &gt;= containerRect.<span class="hljs-property">top</span> &amp;&amp;
    elementRect.<span class="hljs-property">left</span> &gt;= containerRect.<span class="hljs-property">left</span> &amp;&amp;
    elementRect.<span class="hljs-property">bottom</span> &lt;= containerRect.<span class="hljs-property">bottom</span> &amp;&amp;
    elementRect.<span class="hljs-property">right</span> &lt;= containerRect.<span class="hljs-property">right</span>
  );
}

<span class="hljs-comment">// 使用Intersection Observer观察滚动容器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createContainerObserver</span>(<span class="hljs-params">container</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器内元素可见性变化'</span>, entry.<span class="hljs-property">isIntersecting</span>);
    });
  }, {
    <span class="hljs-attr">root</span>: container, <span class="hljs-comment">// 指定容器为根元素</span>
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span>
  });
}
</code></pre>
<h3 data-id="heading-10">考虑CSS Transform的情况</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">function <span class="hljs-title">getTransformedBounds</span><span class="hljs-params">(element)</span> </span>{
  <span class="hljs-type">const</span> rect = element.<span class="hljs-built_in">getBoundingClientRect</span>();
  
  <span class="hljs-comment">// 如果元素有CSS transform，getBoundingClientRect已经包含了变换后的位置</span>
  <span class="hljs-comment">// 不需要额外计算</span>
  <span class="hljs-keyword">return</span> rect;
}

<span class="hljs-comment">// 对于复杂的3D变换，可能需要更精确的计算</span>
<span class="hljs-function">function <span class="hljs-title">isTransformedElementVisible</span><span class="hljs-params">(element)</span> </span>{
  <span class="hljs-type">const</span> rect = element.<span class="hljs-built_in">getBoundingClientRect</span>();
  
  <span class="hljs-comment">// 检查元素是否因为transform: scale(0)等而不可见</span>
  <span class="hljs-type">const</span> computedStyle = <span class="hljs-built_in">getComputedStyle</span>(element);
  <span class="hljs-type">const</span> transform = computedStyle.transform;
  
  <span class="hljs-keyword">if</span> (transform === <span class="hljs-string">'none'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isPartiallyInViewport</span>(element);
  }
  
  <span class="hljs-comment">// 检查是否有scale(0)或类似的变换</span>
  <span class="hljs-keyword">if</span> (rect.width === <span class="hljs-number">0</span> || rect.height === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">isPartiallyInViewport</span>(element);
}
</code></pre>
<h2 data-id="heading-11">4. 性能优化技巧</h2>
<h3 data-id="heading-12">虚拟滚动场景</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualScrollObserver</span> {
  <span class="hljs-keyword">constructor</span>(container, options = {}) {
    <span class="hljs-keyword">this</span>.container = container;
    <span class="hljs-keyword">this</span>.itemHeight = options.itemHeight || <span class="hljs-number">100</span>;
    <span class="hljs-keyword">this</span>.buffer = options.buffer || <span class="hljs-number">5</span>; <span class="hljs-comment">// 缓冲区项目数量</span>
    <span class="hljs-keyword">this</span>.items = [];
    <span class="hljs-keyword">this</span>.visibleRange = { start: <span class="hljs-number">0</span>, end: <span class="hljs-number">0</span> };
    
    <span class="hljs-keyword">this</span>.handleScroll = <span class="hljs-keyword">this</span>.throttle(<span class="hljs-keyword">this</span>.calculateVisibleRange.bind(<span class="hljs-keyword">this</span>), <span class="hljs-number">16</span>);
    <span class="hljs-keyword">this</span>.container.addEventListener(<span class="hljs-string">'scroll'</span>, <span class="hljs-keyword">this</span>.handleScroll);
  }
  
  calculateVisibleRange() {
    <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-keyword">this</span>.container.scrollTop;
    <span class="hljs-keyword">const</span> containerHeight = <span class="hljs-keyword">this</span>.container.clientHeight;
    
    <span class="hljs-keyword">const</span> start = Math.max(<span class="hljs-number">0</span>, Math.floor(scrollTop / <span class="hljs-keyword">this</span>.itemHeight) - <span class="hljs-keyword">this</span>.buffer);
    <span class="hljs-keyword">const</span> end = Math.min(
      <span class="hljs-keyword">this</span>.items.length - <span class="hljs-number">1</span>,
      Math.ceil((scrollTop + containerHeight) / <span class="hljs-keyword">this</span>.itemHeight) + <span class="hljs-keyword">this</span>.buffer
    );
    
    <span class="hljs-keyword">if</span> (start !== <span class="hljs-keyword">this</span>.visibleRange.start || end !== <span class="hljs-keyword">this</span>.visibleRange.end) {
      <span class="hljs-keyword">this</span>.visibleRange = { start, end };
      <span class="hljs-keyword">this</span>.onVisibleRangeChange(<span class="hljs-keyword">this</span>.visibleRange);
    }
  }
  
  onVisibleRangeChange(range) {
    <span class="hljs-comment">// 子类实现或通过回调处理</span>
    console.log(<span class="hljs-string">'可见范围变化:'</span>, range);
  }
  
  throttle(func, delay) {
    let lastTime = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> function(...args) {
      <span class="hljs-keyword">const</span> now = Date.now();
      <span class="hljs-keyword">if</span> (now - lastTime &gt;= delay) {
        func.apply(<span class="hljs-keyword">this</span>, args);
        lastTime = now;
      }
    };
  }
}
</code></pre>
<h3 data-id="heading-13">懒加载图片完整实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyImageLoader</span> {
  <span class="hljs-keyword">constructor</span>(options = {}) {
    <span class="hljs-keyword">this</span>.options = {
      rootMargin: <span class="hljs-string">'50px'</span>,
      threshold: <span class="hljs-number">0.1</span>,
      loadingClass: <span class="hljs-string">'lazy-loading'</span>,
      loadedClass: <span class="hljs-string">'lazy-loaded'</span>,
      errorClass: <span class="hljs-string">'lazy-error'</span>,
      ...options
    };
    
    <span class="hljs-keyword">this</span>.observer = new IntersectionObserver(
      <span class="hljs-keyword">this</span>.handleIntersection.bind(<span class="hljs-keyword">this</span>),
      {
        rootMargin: <span class="hljs-keyword">this</span>.options.rootMargin,
        threshold: <span class="hljs-keyword">this</span>.options.threshold
      }
    );
    
    <span class="hljs-keyword">this</span>.loadingImages = new Set();
  }
  
  observe(img) {
    <span class="hljs-keyword">if</span> (!(img instanceof HTMLImageElement)) {
      console.warn(<span class="hljs-string">'LazyImageLoader: 只能观察img元素'</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">if</span> (!img.dataset.src &amp;&amp; !img.dataset.srcset) {
      console.warn(<span class="hljs-string">'LazyImageLoader: 图片缺少data-src或data-srcset属性'</span>);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">this</span>.observer.observe(img);
  }
  
  handleIntersection(entries) {
    entries.forEach(entry =&gt; {
      <span class="hljs-keyword">if</span> (entry.isIntersecting) {
        <span class="hljs-keyword">this</span>.loadImage(entry.target);
        <span class="hljs-keyword">this</span>.observer.unobserve(entry.target);
      }
    });
  }
  
  loadImage(img) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loadingImages.has(img)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">this</span>.loadingImages.add(img);
    img.classList.add(<span class="hljs-keyword">this</span>.options.loadingClass);
    
    <span class="hljs-keyword">const</span> tempImg = new Image();
    
    tempImg.onload = () =&gt; {
      <span class="hljs-keyword">this</span>.applyImage(img, tempImg);
      img.classList.remove(<span class="hljs-keyword">this</span>.options.loadingClass);
      img.classList.add(<span class="hljs-keyword">this</span>.options.loadedClass);
      <span class="hljs-keyword">this</span>.loadingImages.delete(img);
    };
    
    tempImg.onerror = () =&gt; {
      img.classList.remove(<span class="hljs-keyword">this</span>.options.loadingClass);
      img.classList.add(<span class="hljs-keyword">this</span>.options.errorClass);
      <span class="hljs-keyword">this</span>.loadingImages.delete(img);
    };
    
    <span class="hljs-comment">// 支持srcset</span>
    <span class="hljs-keyword">if</span> (img.dataset.srcset) {
      tempImg.srcset = img.dataset.srcset;
    }
    tempImg.src = img.dataset.src;
  }
  
  applyImage(img, tempImg) {
    <span class="hljs-keyword">if</span> (img.dataset.srcset) {
      img.srcset = img.dataset.srcset;
      delete img.dataset.srcset;
    }
    img.src = tempImg.src;
    delete img.dataset.src;
  }
  
  destroy() {
    <span class="hljs-keyword">this</span>.observer.disconnect();
    <span class="hljs-keyword">this</span>.loadingImages.clear();
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> lazyLoader = new LazyImageLoader({
  rootMargin: <span class="hljs-string">'100px'</span>,
  threshold: <span class="hljs-number">0.1</span>
});

document.querySelectorAll(<span class="hljs-string">'img[data-src]'</span>).forEach(img =&gt; {
  lazyLoader.observe(img);
});
</code></pre>
<h2 data-id="heading-14">5. 兼容性处理</h2>
<pre><code class="hljs language-ini" lang="ini">// Intersection Observer polyfill检查
function createCompatibleObserver(callback, options) {
  if ('IntersectionObserver' in window) {
    return new IntersectionObserver(callback, options)<span class="hljs-comment">;</span>
  } else {
    console.warn('IntersectionObserver not supported, falling back to scroll listener')<span class="hljs-comment">;</span>
    return createScrollBasedObserver(callback, options)<span class="hljs-comment">;</span>
  }
}

function createScrollBasedObserver(callback, <span class="hljs-attr">options</span> = {}) {
  const <span class="hljs-attr">elements</span> = new Set()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">threshold</span> = options.threshold || <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  
  function checkElements() {
    const <span class="hljs-attr">entries</span> = []<span class="hljs-comment">;</span>
    
    elements.forEach(<span class="hljs-attr">element</span> =&gt; {
      const <span class="hljs-attr">info</span> = getVisibilityInfo(element)<span class="hljs-comment">;</span>
      const <span class="hljs-attr">isIntersecting</span> = info.visibilityRatio &gt;= threshold<span class="hljs-comment">;</span>
      
      entries.push({
        target: element,
        isIntersecting,
        intersectionRatio: info.visibilityRatio,
        boundingClientRect: info.rect
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    
    if (entries.length &gt; 0) {
      callback(entries)<span class="hljs-comment">;</span>
    }
  }
  
  const <span class="hljs-attr">throttledCheck</span> = throttle(checkElements, <span class="hljs-number">100</span>)<span class="hljs-comment">;</span>
  
  window.addEventListener('scroll', throttledCheck, { passive: true })<span class="hljs-comment">;</span>
  window.addEventListener('resize', throttledCheck)<span class="hljs-comment">;</span>
  
  return {
    observe(element) {
      elements.add(element)<span class="hljs-comment">;</span>
      // 立即检查一次
      setTimeout(() =&gt; {
        const <span class="hljs-attr">info</span> = getVisibilityInfo(element)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">isIntersecting</span> = info.visibilityRatio &gt;= threshold<span class="hljs-comment">;</span>
        callback(<span class="hljs-section">[{
          target: element,
          isIntersecting,
          intersectionRatio: info.visibilityRatio,
          boundingClientRect: info.rect
        }]</span>)<span class="hljs-comment">;</span>
      }, 0)<span class="hljs-comment">;</span>
    },
    
    unobserve(element) {
      elements.delete(element)<span class="hljs-comment">;</span>
    },
    
    disconnect() {
      window.removeEventListener('scroll', throttledCheck)<span class="hljs-comment">;</span>
      window.removeEventListener('resize', throttledCheck)<span class="hljs-comment">;</span>
      elements.clear()<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>选择合适的方法：</p>
<ol>
<li><strong>Intersection Observer API</strong> - 现代浏览器首选，性能最佳</li>
<li><strong>getBoundingClientRect + 滚动监听</strong> - 需要兼容老浏览器时使用</li>
<li><strong>虚拟滚动</strong> - 处理大量元素时的特殊优化</li>
</ol>
<p>关键考虑因素：</p>
<ul>
<li><strong>性能</strong>：Intersection Observer &gt; 节流的滚动监听 &gt; 频繁的滚动监听</li>
<li><strong>精确度</strong>：getBoundingClientRect更精确，但需要手动触发</li>
<li><strong>兼容性</strong>：getBoundingClientRect支持更老的浏览器</li>
<li><strong>功能需求</strong>：是否需要部分可见、可见比例等详细信息</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI 危！DeepSeek 放大招：追平谷歌最强，手撕 GPT-5 High]]></title>    <link>https://juejin.cn/post/7579096485355339826</link>    <guid>https://juejin.cn/post/7579096485355339826</guid>    <pubDate>2025-12-02T10:29:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355339826" data-draft-id="7578922565210439707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI 危！DeepSeek 放大招：追平谷歌最强，手撕 GPT-5 High"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-02T10:29:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI 危！DeepSeek 放大招：追平谷歌最强，手撕 GPT-5 High
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:29:54.000Z" title="Tue Dec 02 2025 10:29:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4600a142a6db4b559817e0dd6331a7a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=JMUOhlJPpIaDpIP3yG54Dwi9enQ%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】「开源之神」DeepSeek 重磅发布 V3.2 正式版，性能全面超越 GPT-5 High，与谷歌 Gemini-3.0 Pro 平分秋色。新模型不仅斩获 4 项国际奥赛金牌级成绩，更凭借独创的 DSA 稀疏注意力架构，打破「速度、成本、智能」的不可能三角。」</strong></h5>
<p>OpenAI 这次真的要慌了！</p>
<p>就在刚刚，「源神」DeepSeek 开源了 DeepSeek-V3.2 正式版——</p>
<p>在数学编程等多项推理基准上，全面超越 GPT-5 High，优于 Claude 4.5 Sonet；</p>
<p>与刷屏的 Gemini 3.0 Pro 相比，则难分伯仲，不相上下！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7139e9be8b4042ed86b9a64cfc5bdd11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=T7wtyfsHUz9bNCsqnZyzl%2FebK28%3D" alt="" loading="lazy"/></p>
<p>表 1：DeepSeek-V3.2 与其他模型在各类数学、代码与通用领域评测集上的得分（括号内为消耗 Tokens 估计总量）</p>
<p>在今年，DeepSeek 此前已发布 7 款模型——「开源之神」，当之无愧：</p>
<p>DeepSeek‑R1、DeepSeek‑R1‑Zero</p>
<p>DeepSeek‑V3、DeepSeek‑V3.1、DeepSeek‑V3.1-Terminus、DeepSeek‑V3.2‑Exp</p>
<p>DeepSeek‑OCR、DeepSeek‑Math-V2</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27e9511f8e744e8eb6a2542bed885935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=TFtaFX8pXLUqjUWdqlgPPVtISac%3D" alt="" loading="lazy"/></p>
<p><strong>「出手即王炸」</strong></p>
<p><strong>「开源 4 项奥赛金牌级 AI」</strong></p>
<p>全新模型 DeepSeek-V3.2，出手即王炸。</p>
<p>DeepSeek 正式发布 DeepSeek-V3.2 与 DeepSeek-V3.2-Speciale——专为智能体打造的推理优先模型！</p>
<ul>
<li>DeepSeek-V3.2：V3.2-Exp 的官方迭代版本，现已登陆 App、网页端及 API；</li>
<li>DeepSeek-V3.2-Speciale：突破推理能力边界，目前仅通过 API 提供服务。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/012d65b6b1c44dbba7585e3c6e622d9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=LXcEDCYhgp8nXEZIkW4SDH6UHAc%3D" alt="" loading="lazy"/></p>
<p>两款模型均达到世界级推理性能 ：</p>
<ul>
<li>V3.2：推理能力与文本长度兼顾，拥有 GPT-5 级别性能，适合日常驱动；</li>
<li>V3.2-Speciale：极致推理能力，取得了 4 项金牌级成绩；目前仅提供 API 版本（不支持工具调用），以支持社区评估与研究。</li>
</ul>
<p><strong>「在主流推理基准测试上，DeepSeek-V3.2-Speciale」</strong> 的性能表现媲美 Gemini-3.0-Pro（见表 1）。</p>
<p>更令人瞩目的是，V3.2-Speciale 模型**「成功斩获多项金牌：」**</p>
<ul>
<li><strong>「IMO 2025（国际数学奥林匹克）」</strong></li>
<li><strong>「CMO 2025（中国数学奥林匹克）」</strong></li>
<li><strong>「ICPC World Finals 2025（国际大学生程序设计竞赛全球总决赛）」</strong></li>
<li><strong>「IOI 2025（国际信息学奥林匹克）」</strong></li>
</ul>
<p>其中，ICPC 与 IOI 成绩分别达到了人类选手第二名与第十名的水平。</p>
<p>而 DeepSeek-V3.2 是首个将思考直接整合到工具使用中的模型，同时支持在思考和非思考模式下使用工具。</p>
<p>目前，两款模型均已开源：</p>
<p>· DeepSeek-V3.2</p>
<p>HuggingFace：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdeepseek-ai%2F" target="_blank" title="https://huggingface.co/deepseek-ai/" ref="nofollow noopener noreferrer">huggingface.co/deepseek-ai…</a></p>
<p>DeepSeek-V3.2</p>
<p>ModelScope：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2Fdeepseek-ai%2FDeepSeek-V3.2" target="_blank" title="https://modelscope.cn/models/deepseek-ai/DeepSeek-V3.2" ref="nofollow noopener noreferrer">modelscope.cn/models/deep…</a></p>
<p>· DeepSeek-V3.2-Speciale</p>
<p>HuggingFace：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdeepseek-ai%2FDeepSeek-V3.2-Speciale" target="_blank" title="https://huggingface.co/deepseek-ai/DeepSeek-V3.2-Speciale" ref="nofollow noopener noreferrer">huggingface.co/deepseek-ai…</a></p>
<p>ModelScope：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2Fdeepseek-ai%2FDeepSeek-V3.2-Speciale" target="_blank" title="https://modelscope.cn/models/deepseek-ai/DeepSeek-V3.2-Speciale" ref="nofollow noopener noreferrer">modelscope.cn/models/deep…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3683b9dacd644fcb8c670e66c15e6f06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=ln%2Fx%2FV3ioyLbH%2FlSVnhuk%2FYEqhQ%3D" alt="" loading="lazy"/></p>
<p><strong>「从「引擎验证」到「全能车手」」</strong></p>
<p><strong>「DeepSeek V3.2 的进化论」</strong></p>
<p>如果说两个月前发布的 DeepSeek-V3.2-Exp 是一台在赛道上呼啸而过的「概念车」，用来向世界证明「稀疏注意力」引擎的动力潜力；</p>
<p>那么今天正式转正的 DeepSeek V3.2，则是一辆完成了内饰精修、装配了顶级导航系统、可以随时上路解决复杂问题的「量产超跑」。</p>
<p>这就是 DeepSeek V3.2 相比于 Exp 版（实验版）最大的进化逻辑：<strong>「核心引擎不变，但驾驶技巧（Agent 能力）发生了质变。」</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56818e2459694c7fa971480922d32cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=WS%2Fq21H7a1%2BL1iopdIORRrIVlCw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c35d6c862e4d4afe82f09fef18f55715~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=UUFAbRCINJ6F5n3bdmUQk%2BsFQxg%3D" alt="" loading="lazy"/></p>
<p><strong>「V3.2 正式版 vs. Exp」</strong></p>
<p><strong>「学会了「边干边想」」</strong></p>
<h3 data-id="heading-1">在架构层面，V3.2 沿用了 Exp 版本验证成功的 DSA 架构，但在「软实力」上，DeepSeek 解决了一个困扰 AI 界的顽疾——<strong>「思考与行动的断裂」</strong>。</h3>
<p>在 V3.2-Exp 时期（以及其他大多数推理模型），模型像是一个记性不好的老学究：它会先花很长时间思考，决定调用一个工具（比如搜索天气）。</p>
<p>但当工具把「今天是雨天」的结果扔回来时，它往往会「断片儿」，忘了刚才思考到哪一步了，不得不重新规划。</p>
<p>V3.2 正式版引入了「思维上下文管理」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec2a39acf908485f8a7682d682b0a394~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=xsyu7cOla6desEyHVcA%2FYXN4MvY%3D" alt="" loading="lazy"/></p>
<p>这就像给模型装了一个「工作记忆暂存区」。</p>
<p>现在的 V3.2 像一位经验丰富的外科医生，在伸手要手术刀（调用工具）的间隙，脑子里的手术方案依然清晰连贯，拿到刀后能无缝衔接下一步操作。</p>
<p>为了练就这项绝活，DeepSeek 甚至为 V3.2 搭建了一个「虚拟演练场」。</p>
<p>他们合成了 1800 多个虚拟的操作系统、代码库和浏览器环境，生成了 8.5 万条极其刁钻的指令，逼着 V3.2 在虚拟世界里反复练习「修 Bug」、「查资料」、「做报表」。</p>
<p>正是这种高强度的特训，让 V3.2 正式版从一个只会做题的「做题家」，进化成了能熟练使用工具解决现实难题的「实干家」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/238873a2a44c4730884b5634ec103b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=WLLJllsSwv7gUmjG9M%2FUrvcydr4%3D" alt="" loading="lazy"/></p>
<p><strong>「最大技术亮点」</strong></p>
<p><strong>「给注意力装上「闪电索引器」」</strong></p>
<p>V3.2 能够同时兼顾「聪明」和「便宜」，其最大的功臣依然是那个名为稀疏注意力（DSA）的底层黑科技。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc7f2de3fc34352b35333651b8dac8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=uixx4giWK8cQgyGMtdgpmU1HGnk%3D" alt="" loading="lazy"/></p>
<p>DeepSeek-V3.2 的注意力架构</p>
<p>要理解它的牛逼之处，我们得先看看传统模型有多「笨」。</p>
<p>传统模型在处理长文档时，就像一个强迫症晚期的图书管理员：</p>
<p>为了回答你一个简单的问题，它强迫自己**「必须把图书馆里每一本书的每一页、每一行字都读一遍」**，并计算它们之间的关联。</p>
<p>这导致计算量随着书的厚度呈指数级爆炸（O(L^2)）。</p>
<p>DSA 则给这位管理员配备了一套「闪电索引器」。</p>
<p>当问题来临时，DSA 先用极低的成本扫描一遍「索引」，瞬间判断出哪几页书可能包含答案，把无关的 99% 的废话直接扔掉。</p>
<p>然后，它只对这筛选出的 1% 的关键内容进行精细的深度阅读。</p>
<p>这种「查目录」而非「死磕全书」的策略，将计算复杂度从可怕的指数级直接拉低到了近乎线性（O(L)）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/058e65fe3abb416cbfa624a314cc206f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=8L8FuctFjF1OKuV%2BvLJamXU6P30%3D" alt="" loading="lazy"/></p>
<p><strong>「带来的显著提升」</strong></p>
<p><strong>「打破「不可能三角」」</strong></p>
<p>DSA 技术的成功落地，直接击穿了 AI 领域的「速度、成本、智能」不可能三角。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d0e2c388084a278b57ed6ba08da412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=B5Mmmqe1nN8ruEe0myQs%2FDJmp7I%3D" alt="" loading="lazy"/></p>
<p>其一，成本腰斩，长文无忧。</p>
<p>对于用户来说，丢给模型一本几十万字的小说或代码库，不再是「烧钱」的奢侈行为，处理速度也从「泡杯咖啡」变成了「眨眼之间」。</p>
<p>其二，算力盈余带来的「智力涌现」，这是最精彩的一点。</p>
<p>正因为 DSA 节省了大量算力，DeepSeek 才有底气推出那个恐怖的 Speciale 版本。</p>
<p>既然读得快，那就让它想得久一点！</p>
<p>Speciale 版本利用节省下来的资源，进行更深度的「长思考」和逻辑推演。</p>
<p>结果是震撼的：DeepSeek-V3.2-Speciale 在数学（IMO 金牌）、编程（IOI 金牌）等硬核指标上，不仅超越了 GPT-5 High，更是与谷歌最强的 Gemini 3.0 Pro 战成平手。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497cb99029634ac0aa0fceacbbae999c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765276193&amp;x-signature=ybya4wrzVqbEeOyfeA47DzYrKCg%3D" alt="" loading="lazy"/></p>
<p>从验证 DSA 引擎潜力的 V3.2-Exp，到将 Agent 能力、思维上下文管理、虚拟演练场训练全部装车的 V3.2 正式版，DeepSeek 展示的是另一条通往强智能的路线：在算力紧箍咒下，用更聪明的架构、更精细的训练和更开放的生态，撬动推理极限。</p>
<p><strong>「DeepSeek-V3.2 的横空出世，正是 DeepSeek 开源」</strong> <strong>「AI」</strong> <strong>「的魅力时刻：拒绝无脑烧钱 Scaling，靠更聪明的</strong>「<strong>「算法」</strong>」<strong>，在算力的缝隙中开辟出通往顶峰的捷径。」</strong></p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzk0OTYwNzc3NQ%3D%3D%26mid%3D2247485698%26idx%3D1%26sn%3Ddda3056163436134b46ce6ceeb243f9a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=Mzk0OTYwNzc3NQ==&amp;mid=2247485698&amp;idx=1&amp;sn=dda3056163436134b46ce6ceeb243f9a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">DeepSeek V3.2 正式版：强化 Agent 能力，融入思考推理</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这下Altman急了，OpenAI紧急启动「红色警报」]]></title>    <link>https://juejin.cn/post/7579096485355307058</link>    <guid>https://juejin.cn/post/7579096485355307058</guid>    <pubDate>2025-12-02T10:25:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355307058" data-draft-id="7578876665696469001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这下Altman急了，OpenAI紧急启动「红色警报」"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-02T10:25:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这下Altman急了，OpenAI紧急启动「红色警报」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:25:51.000Z" title="Tue Dec 02 2025 10:25:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ChatGPT 三周年刚刚过去，Sam Altman 却显得分外焦虑。</p>
<p>据 The Information 报道，一份内部备忘录显示，Altman 周一告诉员工，OpenAI 宣布进入红色警报（Code Red）状态，将调集更多资源来改进 ChatGPT。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b73bdff2cf1b41b193c41ebdd3e8a198~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275951&amp;x-signature=AF%2BM0pK4AnTQg%2BUKsSJtu3F7djY%3D" alt="图片" loading="lazy"/></p>
<p>回想 2022 年底，当时 ChatGPT 全球爆红，谷歌 CEO Sundar Pichai 在公司内部发布了红色警报（Code Red）以应对来自 OpenAI 的威胁。</p>
<p>讽刺的是，短短三年后，攻守之势异也。彼时慌乱的谷歌，如今正以惊人的速度重整旗鼓，Gemini 不断迭代、多模态能力大幅增强，生图模型 Nano Banana Pro 全方位爆火……Anthropic、xAI 等公司也在不同技术方向上快速追赶。</p>
<p>再看 OpenAI 这边，情况却显得有些微妙。过去一年，OpenAI 的研究方向不断扩散：推理模型、视频、多模态、智能体、浏览器……几乎每一条热门技术路径上都能看到 OpenAI 的影子。但往往是发布即巅峰，后续声量迅速下滑，难以形成持续性的产品势能。</p>
<p>比如 Sora 发布时震惊全网，但之后迟迟没有面向公众的可用产品；GPT Store 一度被视为生态爆发点，但上线后应用质量参差，热度远不及预期……这种强首发、弱跟进的节奏，让许多原本被寄予厚望的方向停留在概念或演示层面，而没有成长为稳定的产品矩阵。</p>
<p>在这样的处境下，OpenAI 已经没有了当初一家独大的从容。为了稳住领先优势并尽快回应外界压力，OpenAI 的资源调度开始向核心战线倾斜，非关键项目则不得不暂时让位，例如广告业务。</p>
<p>Altman 表示：OpenAI 正处于 ChatGPT 的关键时期。</p>
<p>尽管 OpenAI 尚未公开承认正在开展广告销售业务，但据一位知情人士透露，该公司正在测试不同类型的广告，包括与在线购物相关的广告。目前已有数百万用户使用 ChatGPT 搜索商品。</p>
<p>Altman 表示，为了改进 ChatGPT 而发起的紧急升级，意味着 OpenAI 也将推迟其他产品的开发进度，例如旨在自动化购物和健康相关任务的 AI 智能体，以及为 ChatGPT 用户生成每日早晨阅读的个性化报告的 Pulse。</p>
<p>Altman 没有具体说明 ChatGPT 出了什么问题，但谷歌今年秋季表示，其 Gemini 聊天机器人的用户数量有所增长。奥特曼最近私下警告员工，谷歌人工智能的复兴可能会给 OpenAI 带来暂时的经济阻力。</p>
<h2 data-id="heading-0">增长隐忧与千亿融资压力</h2>
<h2 data-id="heading-1"/>
<p>就在上个月，OpenAI 首席财务官 Sarah Friar 在与投资者的电话会议中暗示，ChatGPT 的增长速度出现放缓迹象，不过她未明确具体指标。</p>
<p>公司正处于寻求约 1000 亿美元新融资的关键节点，以支撑其惊人的现金消耗。据此前预测，ChatGPT 今年将通过订阅产生约 100 亿美元收入，并在 2027 年达到 350 亿美元。</p>
<p>有趣的是，就在<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650999498%26idx%3D1%26sn%3D47dbbf67c0aeb7c1777f7329f1f70faa%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650999498&amp;idx=1&amp;sn=47dbbf67c0aeb7c1777f7329f1f70faa&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">前不久的一次采访中</a>，当被主持人尖锐地问及「在年收入仅 130 亿美元的情况下，做出 1.4 万亿美元的支出承诺（投入算力建设）是否合理」时，奥特曼展现出了极具攻击性的自信。</p>
<p>他直言这是一场关于未来的必要赌注，如果没有算力基建，就无法支撑模型规模与收入增长。他甚至尖锐地回击唱衰者：我很想看到那些写「OpenAI 即将倒闭」的人尝试做空，然后被反噬。</p>
<p>然而，要在 CFO 暗示增长放缓的当下维持这一高估值，并支撑未来数百亿美元的技术研发投入，OpenAI 必须向资本市场证明其持续的高增长能力，证明奥特曼的这场「前瞻性押注」依然胜算在握。</p>
<p>「红色警报」的背后，是竞争对手尤其是谷歌的强势复苏。谷歌 Gemini 的月活跃用户数已从 7 月的 4.5 亿激增至 10 月的 6.5 亿。虽然这一数字与 OpenAI 公布的 8 亿周活跃用户仍有差距，但谷歌在「AI 模式」搜索和图像生成模型（如近期备受好评的 Nano Banana Pro）上的激进布局，已让 OpenAI 感受到了切实的威胁。</p>
<p>开发者对谷歌和 Anthropic 新模型的强烈好评，更是加剧了这种紧迫感。</p>
<h2 data-id="heading-2">奥特曼的反击：</h2>
<h2 data-id="heading-3">个性化与新模型</h2>
<h2 data-id="heading-4"/>
<p>为了稳固护城河，奥特曼在备忘录中明确了新的战略优先级：</p>
<ul>
<li>
<p>深度个性化：针对每周 8 亿活跃用户，ChatGPT 将允许高度自定义的互动方式，致力于成为真正的「私人助理」。</p>
</li>
<li>
<p>模型行为优化：减少「过度拒绝」，即 AI 拒绝回答良性问题的情况，并提升在 LMArena 等公开排名中的表现，确保用户体验优于竞品。</p>
</li>
<li>
<p>多模态增强：重点优化 Imagegen 图像生成能力，对标谷歌竞品。</p>
</li>
</ul>
<p>更值得关注的是，奥特曼透露 OpenAI 计划在下周发布一款新的推理模型。据内部评估，该模型在性能上已「领先于谷歌的 Gemini 3」。这款新模型将进一步强化 ChatGPT 的「思考模式」和「深度研究」功能，通过消耗更多算力来提供更精准的答案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d5131c4f3bc4d0394b5963b793c782f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765275951&amp;x-signature=c8HlmuphM1LGqFIvLeZ%2Fx2W0XOY%3D" alt="图片" loading="lazy"/></p>
<p>大家的期待值已拉满。</p>
<p>OpenAI 产品负责人 Nick Turley 也在社交媒体上为其打气，称 ChatGPT 目前处理了全球 70% 的 AI 助手活动和 10% 的搜索活动。</p>
<p>面对谷歌的步步紧逼，OpenAI 能否通过这次「红色警报」重塑绝对优势，下周发布的新模型将是关键一战。</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.theinformation.com%2Farticles%2Fopenai-ceo-declares-code-red-combat-threats-chatgpt-delays-ads-effort%3Frc%3Djn0pp4" target="_blank" title="https://www.theinformation.com/articles/openai-ceo-declares-code-red-combat-threats-chatgpt-delays-ads-effort?rc=jn0pp4" ref="nofollow noopener noreferrer">www.theinformation.com/articles/op…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Reactor网络模型深度解析：从并发困境说起]]></title>    <link>https://juejin.cn/post/7578714735307636762</link>    <guid>https://juejin.cn/post/7578714735307636762</guid>    <pubDate>2025-12-01T14:12:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578714735307636762" data-draft-id="7578714735307620378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Reactor网络模型深度解析：从并发困境说起"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-01T14:12:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Reactor网络模型深度解析：从并发困境说起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-01T14:12:19.000Z" title="Mon Dec 01 2025 14:12:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-01
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文深入探讨Reactor网络模型的核心机制，解答高并发场景下的关键问题，揭示现代高性能服务器的架构奥秘。通过对比分析、原理阐述和实战代码，带您彻底理解Reactor如何优雅应对海量并发请求。</p>
</blockquote>
<h2 data-id="heading-0"><strong>并发困难</strong></h2>
<p>想象这样一个场景：你的电商网站正在举办"双11"大促，每秒有10万用户同时点击"立即购买"。传统的"一线程一连接"架构瞬间崩溃——不是内存耗尽，就是CPU被上下文切换拖垮。</p>
<p>这正是我在职业生涯早期遭遇的真实困境。直到我理解了<strong>Reactor模式</strong>，才发现原来高性能网络编程可以如此优雅。</p>
<h2 data-id="heading-1"><strong>第一章：传统并发模型的崩溃边缘</strong></h2>
<h3 data-id="heading-2"><strong>1.1 阻塞I/O的致命缺陷</strong></h3>
<p>让我们从最直观的代码开始：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 经典的多线程服务器 - 每个连接一个线程</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_client</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
    <span class="hljs-comment">// 阻塞点：数据未到达时线程休眠</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(sockfd, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 线程被唤醒，处理业务</span>
    <span class="hljs-built_in">process_request</span>(buffer);
    <span class="hljs-built_in">send</span>(sockfd, response, <span class="hljs-built_in">strlen</span>(response), <span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> server_fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// ... bind, listen</span>
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-type">int</span> client_fd = <span class="hljs-built_in">accept</span>(server_fd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-comment">// 致命的资源消耗：每个线程需要8MB栈空间</span>
        <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">(handle_client, client_fd)</span></span>;
        t.<span class="hljs-built_in">detach</span>();
    }
}
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>连接数增长 → 线程数线性增长</li>
<li>1000个连接 ≈ 8GB内存（仅线程栈）</li>
<li>上下文切换开销呈指数级上升</li>
<li>大部分线程处于阻塞等待状态（资源浪费）</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 C10K问题的挑战</strong></h3>
<p>2000年提出的C10K（并发1万连接）问题，暴露了传统模型的根本缺陷：</p>

























<table><thead><tr><th>资源类型</th><th>传统模型消耗</th><th>物理限制</th></tr></thead><tbody><tr><td>内存</td><td>10,000 × 8MB = 80GB</td><td>服务器通常只有128GB</td></tr><tr><td>文件描述符</td><td>10,000</td><td>系统默认限制1024</td></tr><tr><td>CPU时间</td><td>大量用于线程切换</td><td>实际业务处理占比低</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>第二章：Reactor的架构革命</strong></h2>
<h3 data-id="heading-5"><strong>2.1 核心思想：事件驱动与状态机</strong></h3>
<p>Reactor模式的核心转变：<strong>从"主动轮询"到"被动通知"</strong>。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 传统模型：主动询问每个连接</span>
<span class="hljs-keyword">for</span>(each connection) {
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">has_data</span>(connection)) {  <span class="hljs-comment">// 主动检查</span>
        <span class="hljs-built_in">process</span>(connection);
    }
}

<span class="hljs-comment">// Reactor模型：等待事件通知</span>
<span class="hljs-keyword">while</span>(events = <span class="hljs-built_in">wait_for_events</span>()) {  <span class="hljs-comment">// 被动等待</span>
    <span class="hljs-keyword">for</span>(each event in events) {
        <span class="hljs-built_in">handle_event</span>(event);  <span class="hljs-comment">// 事件触发处理</span>
    }
}
</code></pre>
<h3 data-id="heading-6"><strong>2.2 系统调用：从select到epoll的演进</strong></h3>
<p><strong>第一代：select/poll的局限</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">select</span><span class="hljs-params">(<span class="hljs-type">int</span> nfds, fd_set *readfds, fd_set *writefds, 
           fd_set *exceptfds, <span class="hljs-keyword">struct</span> timeval *timeout)</span></span>;
</code></pre>
<ul>
<li>每次调用需要传递全部fd集合（用户态→内核态拷贝）</li>
<li>内核线性扫描所有fd（O(n)复杂度）</li>
<li>fd数量限制（通常1024）</li>
</ul>
<p><strong>第二代：epoll的突破</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 创建epoll实例</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_create</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span></span>;

<span class="hljs-comment">// 2. 注册/修改fd兴趣</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_ctl</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-type">int</span> op, <span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> epoll_event *event)</span></span>;

<span class="hljs-comment">// 3. 等待事件</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-type">int</span> epfd, <span class="hljs-keyword">struct</span> epoll_event *events, 
               <span class="hljs-type">int</span> maxevents, <span class="hljs-type">int</span> timeout)</span></span>;
</code></pre>
<p><strong>epoll的核心优势</strong>：</p>
<ol>
<li><strong>红黑树存储fd</strong>：高效增删改（O(log n)）</li>
<li><strong>就绪列表</strong>：事件触发时加入列表</li>
<li><strong>mmap共享内存</strong>：避免用户态-内核态数据拷贝</li>
<li><strong>边缘触发(ET)</strong>：减少事件通知次数</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Reactor的完整架构</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor模式四层架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorArchitecture</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 1. 事件多路分发器（Demultiplexer）</span>
    EventDemultiplexer* demux;
    
    <span class="hljs-comment">// 2. 事件处理器注册表（Event Handler Registry）</span>
    std::map&lt;Handle, EventHandler*&gt; handlers;
    
    <span class="hljs-comment">// 3. 事件循环（Event Loop）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">event_loop</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 4. 具体事件处理器（Concrete Event Handlers）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptorHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionHandler</span> : <span class="hljs-keyword">public</span> EventHandler {...};
};

<span class="hljs-comment">// 事件循环核心算法</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::event_loop</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span>(!stop) {
        <span class="hljs-comment">// 等待事件发生（毫秒级甚至纳秒级）</span>
        <span class="hljs-keyword">auto</span> events = demux-&gt;<span class="hljs-built_in">select</span>(timeout);
        
        <span class="hljs-comment">// 分发事件到对应处理器</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp; event : events) {
            EventHandler* handler = <span class="hljs-built_in">get_handler</span>(event.handle);
            <span class="hljs-keyword">if</span>(handler) {
                handler-&gt;<span class="hljs-built_in">handle_event</span>(event.type);
            }
        }
        
        <span class="hljs-comment">// 处理定时器事件</span>
        <span class="hljs-built_in">process_timers</span>();
        
        <span class="hljs-comment">// 处理异步任务</span>
        <span class="hljs-built_in">process_async_tasks</span>();
    }
}
</code></pre>
<h2 data-id="heading-8"><strong>第三章：深入关键问题：并发消息处理机制</strong></h2>
<h3 data-id="heading-9"><strong>3.1 问题的本质：Reactor如何处理"同时到达"的消息？</strong></h3>
<p>这是最常见的误解点。我们需要区分两个概念：</p>
<ul>
<li><strong>物理同时</strong>：多个数据包在同一纳秒到达网卡</li>
<li><strong>逻辑同时</strong>：Reactor在单次事件循环中处理多个就绪事件</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 实际的处理时序</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Reactor::handle_events</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 单次epoll_wait可能返回多个就绪socket</span>
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">epoll_wait</span>(epfd, events, <span class="hljs-number">64</span>, <span class="hljs-number">-1</span>);
    
    <span class="hljs-comment">// 这些socket的数据"几乎同时"到达内核缓冲区</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
        <span class="hljs-comment">// 但处理是顺序的！关键在此！</span>
        <span class="hljs-built_in">handle_socket</span>(events[i].data.fd);
    }
}
</code></pre>
<h3 data-id="heading-10"><strong>3.2 内核缓冲区的关键作用</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "客户端同时发送"
        C1[客户端1] --&gt;|数据包1| NIC[网卡]
        C2[客户端2] --&gt;|数据包2| NIC
        C3[客户端3] --&gt;|数据包3| NIC
    end
    
    subgraph "内核空间"
        NIC --&gt;|DMA拷贝| Memory[内核内存]
        Memory --&gt; TCP[TCP协议栈]
        TCP --&gt; B1[Socket1缓冲区]
        TCP --&gt; B2[Socket2缓冲区]
        TCP --&gt; B3[Socket3缓冲区]
    end
    
    subgraph "Reactor处理"
        B1 --&gt;|epoll标记可读| E[epoll就绪列表]
        B2 --&gt;|epoll标记可读| E
        B3 --&gt;|epoll标记可读| E
        E --&gt; R[Reactor顺序读取]
    end
    
    R --&gt; P1[处理Socket1]
    R --&gt; P2[处理Socket2]
    R --&gt; P3[处理Socket3]
</code></pre>
<p><strong>关键理解</strong>：</p>
<ol>
<li>数据包到达网卡后，由DMA直接写入内存</li>
<li>内核TCP协议栈处理，存入对应socket的接收缓冲区</li>
<li>epoll将该socket标记为"可读"</li>
<li>Reactor下次<code>epoll_wait</code>时获知多个socket就绪</li>
<li><strong>虽然是顺序处理，但每个recv都是非阻塞的，立即返回</strong></li>
</ol>
<h3 data-id="heading-11"><strong>3.3 性能瓶颈分析与解决方案</strong></h3>
<p><strong>场景分析</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 假设有3个客户端几乎同时发送数据</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_socket</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
    <span class="hljs-comment">// 步骤1：读取数据（很快，微秒级）</span>
    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
    <span class="hljs-type">int</span> n = <span class="hljs-built_in">recv</span>(fd, buf, <span class="hljs-built_in">sizeof</span>(buf), <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 步骤2：业务处理（可能很慢，毫秒级）</span>
    std::string result = <span class="hljs-built_in">expensive_processing</span>(buf, n);
    
    <span class="hljs-comment">// 步骤3：发送响应</span>
    <span class="hljs-built_in">send</span>(fd, result.<span class="hljs-built_in">c_str</span>(), result.<span class="hljs-built_in">length</span>(), <span class="hljs-number">0</span>);
}
</code></pre>
<p><strong>处理时间线</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">时间轴：0ms     1ms     2ms     3ms     4ms     5ms
Socket1: <span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket2:        等待...<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
Socket3:                等待...........<span class="hljs-section">[recv]</span><span class="hljs-section">[proc...................]</span><span class="hljs-section">[send]</span>
</code></pre>
<p><strong>问题</strong>：Socket2、3需要等待Socket1的业务处理完成！</p>
<p><strong>解决方案：Reactor + 线程池</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 优化的Reactor架构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HighPerformanceReactor</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// I/O线程（主Reactor）</span>
    std::thread io_thread;
    
    <span class="hljs-comment">// 业务线程池</span>
    ThreadPool worker_pool;
    
    <span class="hljs-comment">// 用于线程间通信的任务队列</span>
    moodycamel::ConcurrentQueue&lt;IORequest&gt; request_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_read_event</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
        <span class="hljs-comment">// 1. I/O线程：快速读取数据</span>
        IORequest req = <span class="hljs-built_in">read_data_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 2. 提交到业务线程池</span>
        worker_pool.<span class="hljs-built_in">enqueue</span>([<span class="hljs-keyword">this</span>, req]() {
            <span class="hljs-comment">// 3. Worker线程：处理耗时业务</span>
            ProcessResult result = <span class="hljs-built_in">process_business</span>(req);
            
            <span class="hljs-comment">// 4. 将写任务交回I/O线程</span>
            io_thread.<span class="hljs-built_in">post</span>([fd, result]() {
                <span class="hljs-built_in">send_response</span>(fd, result);
            });
        });
        
        <span class="hljs-comment">// I/O线程立即返回，继续处理其他事件</span>
    }
};
</code></pre>
<p><strong>优化后的时间线</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">I</span>/<span class="hljs-selector-tag">O</span>线程: <span class="hljs-selector-attr">[recv1]</span><span class="hljs-selector-attr">[recv2]</span><span class="hljs-selector-attr">[recv3]</span><span class="hljs-selector-attr">[send1]</span><span class="hljs-selector-attr">[send2]</span><span class="hljs-selector-attr">[send3]</span>
<span class="hljs-selector-tag">Worker1</span>:         <span class="hljs-selector-attr">[proc1...........]</span>
<span class="hljs-selector-tag">Worker2</span>:         <span class="hljs-selector-attr">[proc2...........]</span>
<span class="hljs-selector-tag">Worker3</span>:         <span class="hljs-selector-attr">[proc3...........]</span>
</code></pre>
<h2 data-id="heading-12"><strong>第四章：工业级Reactor实现细节</strong></h2>
<h3 data-id="heading-13"><strong>4.1 完整的事件状态机</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">ConnectionState</span> {
    ACCEPTING,      <span class="hljs-comment">// 接受连接</span>
    READING,        <span class="hljs-comment">// 读取数据</span>
    PROCESSING,     <span class="hljs-comment">// 处理中（可能在Worker线程）</span>
    WRITING,        <span class="hljs-comment">// 写入数据</span>
    CLOSING         <span class="hljs-comment">// 关闭连接</span>
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Connection</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> fd;
    ConnectionState state;
    std::vector&lt;<span class="hljs-type">char</span>&gt; input_buffer;
    std::vector&lt;<span class="hljs-type">char</span>&gt; output_buffer;
    <span class="hljs-type">size_t</span> bytes_to_write;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">handle_event</span><span class="hljs-params">(EventType type)</span> </span>{
        <span class="hljs-keyword">switch</span>(state) {
            <span class="hljs-keyword">case</span> ConnectionState::READING:
                <span class="hljs-keyword">if</span>(type == EventType::READ) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">read_data</span>() &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// 数据读够一个完整请求</span>
                        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">parse_complete</span>()) {
                            state = ConnectionState::PROCESSING;
                            <span class="hljs-built_in">submit_to_thread_pool</span>();
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 连接关闭或错误</span>
                        state = ConnectionState::CLOSING;
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-keyword">case</span> ConnectionState::WRITING:
                <span class="hljs-keyword">if</span>(type == EventType::WRITE) {
                    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">write_data</span>() == output_buffer.<span class="hljs-built_in">size</span>()) {
                        <span class="hljs-comment">// 数据全部发送完成</span>
                        <span class="hljs-keyword">if</span>(keep_alive) {
                            state = ConnectionState::READING;
                            <span class="hljs-built_in">reset_for_next_request</span>();
                        } <span class="hljs-keyword">else</span> {
                            state = ConnectionState::CLOSING;
                        }
                    }
                }
                <span class="hljs-keyword">break</span>;
                
            <span class="hljs-comment">// ... 其他状态处理</span>
        }
    }
};
</code></pre>
<h3 data-id="heading-14"><strong>4.2 内存管理优化</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 对象池避免频繁new/delete</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;T*&gt; free_list;
    std::mutex lock;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">T* <span class="hljs-title">acquire</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        <span class="hljs-keyword">if</span>(!free_list.<span class="hljs-built_in">empty</span>()) {
            T* obj = free_list.<span class="hljs-built_in">back</span>();
            free_list.<span class="hljs-built_in">pop_back</span>();
            <span class="hljs-keyword">return</span> obj;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">release</span><span class="hljs-params">(T* obj)</span> </span>{
        obj-&gt;<span class="hljs-built_in">reset</span>();  <span class="hljs-comment">// 重置状态而非销毁</span>
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">guard</span><span class="hljs-params">(lock)</span></span>;
        free_list.<span class="hljs-built_in">push_back</span>(obj);
    }
};

<span class="hljs-comment">// 缓冲区设计</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Buffer</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 使用连续内存块，避免小内存分配</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> INITIAL_SIZE = <span class="hljs-number">1024</span>;
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">size_t</span> MAX_SIZE = <span class="hljs-number">65536</span>;
    
    std::unique_ptr&lt;<span class="hljs-type">char</span>[]&gt; data;
    <span class="hljs-type">size_t</span> capacity;
    <span class="hljs-type">size_t</span> read_index;
    <span class="hljs-type">size_t</span> write_index;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 确保容量（指数增长策略）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ensure_capacity</span><span class="hljs-params">(<span class="hljs-type">size_t</span> need)</span> </span>{
        <span class="hljs-keyword">if</span>(write_index + need &lt;= capacity) <span class="hljs-keyword">return</span>;
        
        <span class="hljs-type">size_t</span> new_capacity = std::<span class="hljs-built_in">max</span>(capacity * <span class="hljs-number">2</span>, 
                                      write_index - read_index + need);
        new_capacity = std::<span class="hljs-built_in">min</span>(new_capacity, MAX_SIZE);
        
        <span class="hljs-keyword">auto</span> new_data = std::<span class="hljs-built_in">make_unique</span>&lt;<span class="hljs-type">char</span>[]&gt;(new_capacity);
        <span class="hljs-comment">// 复制有效数据</span>
        std::<span class="hljs-built_in">copy</span>(data.<span class="hljs-built_in">get</span>() + read_index, 
                  data.<span class="hljs-built_in">get</span>() + write_index, 
                  new_data.<span class="hljs-built_in">get</span>());
        write_index -= read_index;
        read_index = <span class="hljs-number">0</span>;
        data = std::<span class="hljs-built_in">move</span>(new_data);
        capacity = new_capacity;
    }
};
</code></pre>
<h3 data-id="heading-15"><strong>4.3 性能调优参数</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux内核参数调优</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">tune_system_parameters</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. 文件描述符限制</span>
    <span class="hljs-built_in">system</span>(<span class="hljs-string">"ulimit -n 1000000"</span>);
    
    <span class="hljs-comment">// 2. TCP参数优化</span>
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 启用TCP_NODELAY（禁用Nagle算法）</span>
    <span class="hljs-type">int</span> flag = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, IPPROTO_TCP, TCP_NODELAY, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 增大接收缓冲区</span>
    <span class="hljs-type">int</span> recv_buf_size = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1MB</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_RCVBUF, 
               &amp;recv_buf_size, <span class="hljs-built_in">sizeof</span>(recv_buf_size));
    
    <span class="hljs-comment">// 启用SO_REUSEPORT（Linux 3.9+）</span>
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;flag, <span class="hljs-built_in">sizeof</span>(flag));
    
    <span class="hljs-comment">// 3. 网卡队列调整</span>
    <span class="hljs-comment">// ethtool -G eth0 rx 4096 tx 4096</span>
}

<span class="hljs-comment">// Reactor内部参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ReactorConfig</span> {
    <span class="hljs-type">size_t</span> max_connections = <span class="hljs-number">1000000</span>;      <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-type">size_t</span> io_threads = <span class="hljs-number">1</span>;                 <span class="hljs-comment">// I/O线程数（主从Reactor）</span>
    <span class="hljs-type">size_t</span> worker_threads = std::thread::<span class="hljs-built_in">hardware_concurrency</span>();
    <span class="hljs-type">size_t</span> task_queue_size = <span class="hljs-number">10000</span>;        <span class="hljs-comment">// 任务队列大小</span>
    <span class="hljs-type">size_t</span> buffer_size = <span class="hljs-number">16384</span>;            <span class="hljs-comment">// 每个连接的缓冲区大小</span>
    <span class="hljs-type">int</span> epoll_timeout_ms = <span class="hljs-number">1</span>;              <span class="hljs-comment">// epoll_wait超时时间</span>
    <span class="hljs-type">bool</span> use_et_mode = <span class="hljs-literal">true</span>;               <span class="hljs-comment">// 使用边缘触发</span>
};
</code></pre>
<h2 data-id="heading-16"><strong>第五章：现实世界的挑战与解决方案</strong></h2>
<h3 data-id="heading-17"><strong>5.1 惊群问题（Thundering Herd）</strong></h3>
<p><strong>问题</strong>：多个进程/线程同时监听同一个端口，当新连接到达时全部被唤醒。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Linux 3.9+ 的SO_REUSEPORT</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">setup_reuseport</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> </span>{
    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    
    <span class="hljs-type">int</span> reuse = <span class="hljs-number">1</span>;
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    <span class="hljs-built_in">setsockopt</span>(fd, SOL_SOCKET, SO_REUSEPORT, &amp;reuse, <span class="hljs-built_in">sizeof</span>(reuse));
    
    <span class="hljs-comment">// 内核会自动分配连接给不同的监听socket</span>
    <span class="hljs-keyword">return</span> fd;
}

<span class="hljs-comment">// 或者使用accept锁</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AcceptMutex</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">bool</span>&gt; lock{<span class="hljs-literal">false</span>};
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">try_lock</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> !lock.<span class="hljs-built_in">exchange</span>(<span class="hljs-literal">true</span>, std::memory_order_acquire);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>{
        lock.<span class="hljs-built_in">store</span>(<span class="hljs-literal">false</span>, std::memory_order_release);
    }
};
</code></pre>
<h3 data-id="heading-18"><strong>5.2 长连接与心跳机制</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionManager</span> {
<span class="hljs-keyword">private</span>:
    std::unordered_map&lt;<span class="hljs-type">int</span>, std::shared_ptr&lt;Connection&gt;&gt; connections;
    std::priority_queue&lt;HeartbeatCheck&gt; heartbeat_queue;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">check_heartbeats</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">auto</span> now = std::chrono::steady_clock::<span class="hljs-built_in">now</span>();
        
        <span class="hljs-keyword">while</span>(!heartbeat_queue.<span class="hljs-built_in">empty</span>() &amp;&amp; 
              heartbeat_queue.<span class="hljs-built_in">top</span>().expiry_time &lt; now) {
            <span class="hljs-keyword">auto</span> conn = heartbeat_queue.<span class="hljs-built_in">top</span>().connection;
            heartbeat_queue.<span class="hljs-built_in">pop</span>();
            
            <span class="hljs-keyword">if</span>(conn-&gt;last_active + HEARTBEAT_TIMEOUT &lt; now) {
                <span class="hljs-comment">// 发送心跳包</span>
                <span class="hljs-built_in">send_heartbeat</span>(conn-&gt;fd);
                
                <span class="hljs-comment">// 重新加入队列，等待响应</span>
                heartbeat_queue.<span class="hljs-built_in">push</span>({
                    now + HEARTBEAT_INTERVAL,
                    conn
                });
            }
        }
    }
};
</code></pre>
<h3 data-id="heading-19"><strong>5.3 流量控制与背压（Backpressure）</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FlowController</span> {
<span class="hljs-keyword">private</span>:
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; current_connections{<span class="hljs-number">0</span>};
    std::atomic&lt;<span class="hljs-type">size_t</span>&gt; request_rate{<span class="hljs-number">0</span>};
    <span class="hljs-type">size_t</span> max_connections;
    <span class="hljs-type">size_t</span> max_request_rate;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_accept_new_connection</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> conns = current_connections.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(conns &gt;= max_connections * <span class="hljs-number">0.9</span>) {
            <span class="hljs-comment">// 连接数接近上限，开始限流</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        current_connections.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">should_process_request</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">size_t</span> rate = request_rate.<span class="hljs-built_in">load</span>();
        <span class="hljs-keyword">if</span>(rate &gt; max_request_rate) {
            <span class="hljs-comment">// 返回429 Too Many Requests</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        request_rate.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">request_completed</span><span class="hljs-params">()</span> </span>{
        request_rate.<span class="hljs-built_in">fetch_sub</span>(<span class="hljs-number">1</span>);
    }
};
</code></pre>
<h2 data-id="heading-20"><strong>第六章：性能对比与基准测试</strong></h2>
<h3 data-id="heading-21"><strong>6.1 不同模型性能对比</strong></h3>






















































<table><thead><tr><th>指标</th><th>多线程阻塞I/O</th><th>单线程Reactor</th><th>Reactor+线程池</th><th>多Reactor</th></tr></thead><tbody><tr><td>最大连接数</td><td>~1000</td><td>10万+</td><td>10万+</td><td>100万+</td></tr><tr><td>QPS（echo）</td><td>5,000</td><td>50,000</td><td>50,000</td><td>200,000</td></tr><tr><td>QPS（10ms业务）</td><td>100</td><td>100</td><td>10,000</td><td>40,000</td></tr><tr><td>内存使用</td><td>高</td><td>极低</td><td>低</td><td>中等</td></tr><tr><td>编程复杂度</td><td>简单</td><td>中等</td><td>复杂</td><td>复杂</td></tr><tr><td>适用场景</td><td>低并发</td><td>高并发I/O</td><td>通用</td><td>极致性能</td></tr></tbody></table>
<h3 data-id="heading-22"><strong>6.2 实际基准测试数据</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用wrk进行压力测试</span>
<span class="hljs-comment">// wrk -t12 -c1000 -d30s http://localhost:8080/</span>

<span class="hljs-comment">// 测试结果对比</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BenchmarkResult</span> {
    std::string model;
    <span class="hljs-type">int</span> connections;
    <span class="hljs-type">int</span> threads;
    <span class="hljs-type">double</span> requests_per_second;
    <span class="hljs-type">double</span> latency_avg_ms;
    <span class="hljs-type">double</span> latency_max_ms;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        std::cout &lt;&lt; std::format(
            <span class="hljs-string">"Model: {}\n"</span>
            <span class="hljs-string">"Connections: {}\n"</span>
            <span class="hljs-string">"RPS: {:.1f}\n"</span>
            <span class="hljs-string">"Latency Avg: {:.2f}ms\n"</span>
            <span class="hljs-string">"Latency Max: {:.2f}ms\n\n"</span>,
            model, connections, requests_per_second,
            latency_avg_ms, latency_max_ms
        );
    }
};

<span class="hljs-comment">// 示例数据</span>
std::vector&lt;BenchmarkResult&gt; results = {
    {<span class="hljs-string">"Thread-per-connection"</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">4800.5</span>, <span class="hljs-number">12.3</span>, <span class="hljs-number">210.5</span>},
    {<span class="hljs-string">"Single Reactor"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">1</span>, <span class="hljs-number">52300.2</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">15.8</span>},
    {<span class="hljs-string">"Reactor+ThreadPool"</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">8</span>, <span class="hljs-number">49800.7</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">32.4</span>},
    {<span class="hljs-string">"Multi-Reactor"</span>, <span class="hljs-number">100000</span>, <span class="hljs-number">4</span>, <span class="hljs-number">187600.4</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">12.7</span>}
};
</code></pre>
<h2 data-id="heading-23"><strong>第七章：现代演进与未来趋势</strong></h2>
<h3 data-id="heading-24"><strong>7.1 从Reactor到Proactor</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Windows IOCP（完成端口）示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProactorServer</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 创建IOCP完成端口</span>
        HANDLE iocp = <span class="hljs-built_in">CreateIoCompletionPort</span>(INVALID_HANDLE_VALUE, 
                                            <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 投递异步操作</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            OVERLAPPED* overlapped = <span class="hljs-built_in">create_overlapped</span>();
            <span class="hljs-built_in">WSARecv</span>(socket, &amp;buffer, <span class="hljs-number">1</span>, &amp;bytes_recvd, 
                   &amp;flags, overlapped, <span class="hljs-literal">NULL</span>);
        }
        
        <span class="hljs-comment">// 等待完成通知</span>
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            DWORD bytes_transferred;
            ULONG_PTR completion_key;
            OVERLAPPED* overlapped;
            
            <span class="hljs-built_in">GetQueuedCompletionStatus</span>(iocp, &amp;bytes_transferred,
                                     &amp;completion_key, &amp;overlapped, INFINITE);
            
            <span class="hljs-comment">// 操作已完成，直接处理结果</span>
            <span class="hljs-built_in">process_completion</span>(completion_key, bytes_transferred, overlapped);
        }
    }
};
</code></pre>
<h3 data-id="heading-25"><strong>7.2 C++20协程与io_uring</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用C++20协程的异步服务器</span>
<span class="hljs-function">async_task&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">handle_connection</span><span class="hljs-params">(io_uring&amp; ring, <span class="hljs-type">int</span> client_fd)</span> </span>{
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 异步读取（非阻塞）</span>
        <span class="hljs-type">ssize_t</span> n = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_read</span>(ring, client_fd, 
                                       buffer, <span class="hljs-built_in">sizeof</span>(buffer));
        
        <span class="hljs-comment">// 处理请求（可以在线程池中）</span>
        std::string response = <span class="hljs-keyword">co_await</span> <span class="hljs-built_in">async_process</span>(buffer, n);
        
        <span class="hljs-comment">// 异步写入</span>
        <span class="hljs-function"><span class="hljs-keyword">co_await</span> <span class="hljs-title">async_write</span><span class="hljs-params">(ring, client_fd, 
                            response.data(), response.size())</span></span>;
        
    } <span class="hljs-built_in">catch</span>(<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cerr &lt;&lt; <span class="hljs-string">"Connection error: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    ::<span class="hljs-built_in">close</span>(client_fd);
}

<span class="hljs-comment">// io_uring 是现代Linux的高性能异步I/O接口</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup_io_uring</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring</span> ring;
    <span class="hljs-built_in">io_uring_queue_init</span>(<span class="hljs-number">32</span>, &amp;ring, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 提交多个I/O请求</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_sqe</span>* sqe = <span class="hljs-built_in">io_uring_get_sqe</span>(&amp;ring);
        <span class="hljs-built_in">io_uring_prep_read</span>(sqe, fd, buffer, size, offset);
        <span class="hljs-built_in">io_uring_sqe_set_data</span>(sqe, user_data);
    }
    
    <span class="hljs-comment">// 批量提交</span>
    <span class="hljs-built_in">io_uring_submit</span>(&amp;ring);
    
    <span class="hljs-comment">// 等待完成</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">io_uring_cqe</span>* cqe;
    <span class="hljs-built_in">io_uring_wait_cqe</span>(&amp;ring, &amp;cqe);
}
</code></pre>
<h2 data-id="heading-26"><strong>第八章：总结与最佳实践</strong></h2>
<h3 data-id="heading-27"><strong>8.1 Reactor模式的核心价值</strong></h3>
<ol>
<li><strong>资源效率</strong>：用少量线程服务大量连接</li>
<li><strong>可扩展性</strong>：连接数增长时性能下降缓慢</li>
<li><strong>响应性</strong>：避免单个慢连接影响其他连接</li>
<li><strong>模块化</strong>：清晰的关注点分离</li>
</ol>
<h3 data-id="heading-28"><strong>8.2 实施建议</strong></h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// Reactor实施检查清单</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorChecklist</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">checklist</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 1. 选择合适的I/O多路复用器</span>
        <span class="hljs-comment">//    - Linux: epoll (ET模式)</span>
        <span class="hljs-comment">//    - BSD: kqueue</span>
        <span class="hljs-comment">//    - Windows: IOCP（实际是Proactor）</span>
        
        <span class="hljs-comment">// 2. 使用非阻塞I/O</span>
        <span class="hljs-built_in">set_nonblocking</span>(fd);
        
        <span class="hljs-comment">// 3. 实现连接状态机</span>
        <span class="hljs-comment">//    每个连接维护明确的状态</span>
        
        <span class="hljs-comment">// 4. 分离I/O和业务处理</span>
        <span class="hljs-comment">//    I/O线程只做I/O，业务交给线程池</span>
        
        <span class="hljs-comment">// 5. 实现优雅关闭</span>
        <span class="hljs-comment">//    支持平滑重启</span>
        
        <span class="hljs-comment">// 6. 添加监控指标</span>
        <span class="hljs-comment">//    连接数、QPS、延迟、队列长度</span>
        
        <span class="hljs-comment">// 7. 实施限流和熔断</span>
        <span class="hljs-comment">//    防止过载</span>
        
        <span class="hljs-comment">// 8. 进行压力测试</span>
        <span class="hljs-comment">//    找到系统瓶颈</span>
    }
};
</code></pre>
<h3 data-id="heading-29"><strong>8.3 何时选择Reactor</strong></h3>
<p><strong>适合场景</strong>：</p>
<ul>
<li>高并发连接（&gt;1000）</li>
<li>I/O密集型应用</li>
<li>需要低延迟响应</li>
<li>长连接服务（如聊天、推送）</li>
</ul>
<p><strong>不适合场景</strong>：</p>
<ul>
<li>极低并发（&lt;100）</li>
<li>CPU密集型计算</li>
<li>简单的一次性请求</li>
</ul>
<h2 data-id="heading-30"><strong>结语</strong></h2>
<p>Reactor模式不是银弹，但它解决了C10K甚至C100K问题的核心挑战。从<code>select</code>到<code>epoll</code>，从单Reactor到多Reactor，从同步到异步，网络编程的演进始终围绕一个核心目标：<strong>用更少的资源服务更多的连接</strong>。</p>
<p>理解Reactor不仅是为了写出高性能服务器，更是为了掌握事件驱动编程的思想。这种思想已经渗透到现代软件的各个层面，从前端的React/Vue，到后端的Node.js/Nginx，再到操作系统的GUI事件循环。</p>
<p>正如计算机科学家Doug McIlroy所说："做一件事情，把它做好"。Reactor模式正是这一哲学在网络编程中的完美体现——它专注于事件分发这一件事，并做到了极致。</p>
<hr/>
<p><strong>进一步阅读</strong>：</p>
<ol>
<li>《UNIX网络编程 卷1：套接字联网API》</li>
<li>《Linux多线程服务端编程》</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则解决Markdown流式输出不完整图片、表格、数学公式]]></title>    <link>https://juejin.cn/post/7579068270293663770</link>    <guid>https://juejin.cn/post/7579068270293663770</guid>    <pubDate>2025-12-02T09:04:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579068270293663770" data-draft-id="7578877638988496896" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则解决Markdown流式输出不完整图片、表格、数学公式"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-02T09:04:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="隔壁的大叔"/> <meta itemprop="url" content="https://juejin.cn/user/1714893871660205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则解决Markdown流式输出不完整图片、表格、数学公式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893871660205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    隔壁的大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:04:42.000Z" title="Tue Dec 02 2025 09:04:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Markdown碎片处理</h2>
<p>在大模型SSE流式输出的时候，往往返回的是Markdown字符串。其他类型比如 <code>#</code> <code>*</code> <code>-</code>等，实时渲染的时候抖动是比较小的，但是像图片链接、表格、块级数学公式在渲染的时候往往会造成剧烈的页面抖动，用户体验不友好。接下来我们就一一解决这三个场景。</p>
<h3 data-id="heading-1">不完整图片链接</h3>
<pre><code class="hljs language-md" lang="md">
//不完整图片链接
![Vue Logo](https://img0.

//完整图片链接
![<span class="hljs-string">Vue Logo</span>](<span class="hljs-link">https://img0.baidu.com/it/u=736188794,4119241415&amp;fm=253&amp;fmt=auto&amp;app=120&amp;f=JPEG?w=1140&amp;h=760 "Vue.js Logo"</span>)


</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/effacd94fdad4a0cbb9d1bc0791ffb33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=w8d7h60wGGCRjcwUqB0o6Tau%2BMg%3D" alt="image.png" loading="lazy"/></p>
<p>处理这种不完整的链接我们可以直接正则匹配替换掉不完整的图片链接为空，等链接完整后再做渲染</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 处理图片流式碎片
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">markdown</span> - 原始 Markdown 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 清理后的 Markdown 字符串
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">stripBrokenImages</span>(<span class="hljs-params">md</span>) {
  <span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(md) !== <span class="hljs-string">'string'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c v3-markdown-stream：请传正确的md字符串～ '</span>,<span class="hljs-string">'background:#ea2039;color:#ffffff;padding:2px 5px;'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">if</span>(!md) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
  }
  md = md.<span class="hljs-title function_">replace</span>(
    <span class="hljs-regexp">/^\s*\[([^\]]+)\]:[ \t]*(\S+)(?:[ \t]+(["'])(?:(?!\3)[\s\S])*?)?$/gm</span>,
    <span class="hljs-function">(<span class="hljs-params">s, id, src, quote</span>) =&gt;</span> {
      <span class="hljs-comment">// 如果捕获到开启引号却没闭合，或者 src 后直接换行（缺引号），都认为不完整</span>
      <span class="hljs-keyword">if</span> (quote &amp;&amp; !s.<span class="hljs-title function_">endsWith</span>(quote)) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 引号没闭合</span>
      <span class="hljs-keyword">if</span> (!quote &amp;&amp; <span class="hljs-regexp">/["']$/</span>.<span class="hljs-title function_">test</span>(src)) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// src 结尾多余引号，也视为异常</span>
      <span class="hljs-keyword">return</span> s; <span class="hljs-comment">// 完整定义，保留</span>
    }
  );
  md = md.<span class="hljs-title function_">replace</span>(
    <span class="hljs-regexp">/!\[([^\]]*)\]\(([^)]*(?:\([^)]*\)[^)]*)*)\)/g</span>,
    <span class="hljs-function">(<span class="hljs-params">s, alt, body</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> open = (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\(/g</span>) || []).<span class="hljs-property">length</span>;
      <span class="hljs-keyword">const</span> close = (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\)/g</span>) || []).<span class="hljs-property">length</span>;
      <span class="hljs-keyword">if</span> (open !== close) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 括号不匹配 → 不完整</span>
      <span class="hljs-keyword">if</span> (body.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"'</span>) &amp;&amp; (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/"/g</span>) || []).<span class="hljs-property">length</span> % <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      <span class="hljs-keyword">if</span> (body.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"'"</span>) &amp;&amp; (body.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/'/g</span>) || []).<span class="hljs-property">length</span> % <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
      <span class="hljs-keyword">return</span> s; <span class="hljs-comment">// 完整，保留</span>
    }
  );
  <span class="hljs-keyword">return</span> md.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/!\[[^\]]*\]\([^)]*$/g</span>, <span class="hljs-string">""</span>);
}
</code></pre>
<h3 data-id="heading-2">不完整表格字符串</h3>
<pre><code class="hljs language-md" lang="md">//不完整表格字符串
| 姓名 | 年龄 | 职业 |
|------|-----

//完整表格字符串
| 姓名 | 年龄 | 职业 |
|------|------|------|
| 张三 | 25   | 工程师 |
| 李四 | 30   | 设计师 |
| 王五 | 28   | 产品经理 |



</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959c4663a7524ae4badbbc34561f05cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=gwtjQB7zzMPwNS%2B8tPLYgPr06DM%3D" alt="image.png" loading="lazy"/></p>
<p>处理这种不完整的表格字符串，我们也可以使用正则替换掉不完整的表格字符串</p>
<p><mark>注意：一旦分隔符和表头数量一致后就可以放行渲染，避免等待时间过长</mark></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 过滤流式输出中结构不完整的表格字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">content</span> - 流式输出的原始内容
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 过滤后的内容（仅保留合法表格，非法表格替换为空）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">filterInvalidTables</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-comment">// 表头加载完成后过滤</span>
  <span class="hljs-comment">// const tableRegex = /(?:^\|(?:\s*.+?\s*)?\|?$[\n\r]?)+(?:^\|(?:\s*[-:]+)+(?:\s*\|\s*[-:]+)*\s*\|?$[\n\r]?)+(?:^\|(?:\s*.+?\s*)?\|?$[\n\r]?)*(?=\n|$)/gm;</span>
  <span class="hljs-comment">//宽松模式过滤</span>
  <span class="hljs-keyword">const</span> tableRegex = <span class="hljs-regexp">/^\|(?:\s*.+?\s*)?\|?$(?:\r?\n^\|(?:\s*[-:]+)+(?:\s*\|\s*[-:]+)*\s*\|?$(?:\r?\n^\|(?:\s*.+?\s*)?\|?$)*)?/gm</span>;
  <span class="hljs-keyword">return</span> content.<span class="hljs-title function_">replace</span>(tableRegex, <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> {
    <span class="hljs-comment">// 分割表头行和分隔符行</span>
    <span class="hljs-keyword">const</span> lines = match.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[\r\n]+/</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> line.<span class="hljs-title function_">trim</span>());
    <span class="hljs-keyword">if</span> (lines.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>; <span class="hljs-comment">// 至少需要表头行 + 分隔符行</span>
    <span class="hljs-comment">// 最后一行表头（处理多行表头场景）</span>
    <span class="hljs-keyword">const</span> headerLine = lines[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>();
    <span class="hljs-comment">// 分隔符行</span>
    <span class="hljs-keyword">const</span> separatorLine = lines[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();

    <span class="hljs-comment">// 提取表头列数：分割 | 后，过滤空字符串（处理前后 | 的情况）</span>
    <span class="hljs-keyword">const</span> headerColumns = headerLine.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col.<span class="hljs-title function_">trim</span>()).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col);
    <span class="hljs-keyword">const</span> headerCount = headerColumns.<span class="hljs-property">length</span>;

    <span class="hljs-comment">// 提取分隔符列数：分割 | 后，过滤空字符串，且必须包含至少1个 -</span>
    <span class="hljs-keyword">const</span> separatorColumns = separatorLine.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col.<span class="hljs-title function_">trim</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">col</span> =&gt;</span> col &amp;&amp; <span class="hljs-regexp">/-/</span>.<span class="hljs-title function_">test</span>(col)); <span class="hljs-comment">// 分隔符必须包含 -</span>
    <span class="hljs-keyword">const</span> separatorCount = separatorColumns.<span class="hljs-property">length</span>;

    <span class="hljs-comment">// 仅当列数完全一致时保留表格，否则替换为空</span>
    <span class="hljs-keyword">return</span> (headerCount === separatorCount &amp;&amp; headerCount&gt;<span class="hljs-number">0</span> &amp;&amp; separatorCount&gt;<span class="hljs-number">0</span>) ? match : <span class="hljs-string">''</span>;
  });
}
</code></pre>
<h3 data-id="heading-3">不完整的数学公式</h3>
<pre><code class="hljs language-md" lang="md">//完整的数学公式
$$
\\frac{n!}{k!(n-k)!} = \\binom{n}{k}
$$

//不完整的数学公式
$$
\\frac{n!}{k!(n-k)!
</code></pre>
<p>渲染效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a398d607775345d7b470ddc5a311a099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=GBae1qFwJ%2Bn9L2rvi25d%2FULsDzQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3216b6849265454a8288d7e4ce210437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZqU5aOB55qE5aSn5Y-U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273092&amp;x-signature=uUn7%2BilXSqstoO4a3hFvHO9T4%2F8%3D" alt="image.png" loading="lazy"/></p>
<p>针对这种也可以使用正则替换不完整的代码块为空</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 清除 Markdown 中未闭合的块级公式（$$ 开头未闭合）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">markdown</span> - 原始 Markdown 字符串
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 处理后的 Markdown 字符串
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearUnclosedBlockMath</span>(<span class="hljs-params">markdown</span>) {
  <span class="hljs-comment">// 正则说明：</span>
  <span class="hljs-comment">// 1. /\$\$(?!.*?\$\$).*$/s - 核心正则</span>
  <span class="hljs-comment">// 2. \$\$ - 匹配块级公式开始标记</span>
  <span class="hljs-comment">// 3. (?!.*?\$\$) - 正向否定预查：确保后面没有 $$ 闭合（非贪婪匹配任意字符）</span>
  <span class="hljs-comment">// 4. .*$ - 匹配从 $$ 开始到字符串结束的所有内容</span>
  <span class="hljs-comment">// 5. s 修饰符 - 让 . 匹配换行符（支持多行公式）</span>
  <span class="hljs-comment">// 6. g 修饰符 - 全局匹配（处理多个未闭合公式的极端情况）</span>
  <span class="hljs-keyword">return</span> markdown.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\$\$(?!.*?\$\$).*$/g</span>s, <span class="hljs-string">''</span>);
}
</code></pre>
<h3 data-id="heading-4">结语</h3>
<p>正则在处理这种问题的时候，简单粗暴但有用，有点俄式美学的味道～
最后，如果你觉得这个文章对你有帮助，不妨点个赞并分享给更多的开发者朋友，让我们一起让 Markdown 解析变得更简单、更强大！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxhy12345%2Fv3-markdown-stream" target="_blank" title="https://github.com/xhy12345/v3-markdown-stream" ref="nofollow noopener noreferrer">GitHub源码仓库地址</a>
如果觉得好用，欢迎给个Star ⭐️ 支持一下！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主]]></title>    <link>https://juejin.cn/post/7578917474659614771</link>    <guid>https://juejin.cn/post/7578917474659614771</guid>    <pubDate>2025-12-02T09:08:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659614771" data-draft-id="7578803751608549426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主"/> <meta itemprop="keywords" content="前端,React.js,设计模式"/> <meta itemprop="datePublished" content="2025-12-02T09:08:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大布布将军"/> <meta itemprop="url" content="https://juejin.cn/user/1535361573994189"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的“时光胶囊”：useRef 才是那个打破“闭包陷阱”的救世主
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535361573994189/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大布布将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:08:44.000Z" title="Tue Dec 02 2025 09:08:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：它不仅仅是 <code>document.getElementById</code></h2>
<p>如果去面试 React 开发岗位，问到 <code>useRef</code> 是干嘛的，90% 的候选人会说：“用来获取 DOM 元素，比如给 input 设置焦点。”</p>
<p>这就好比你买了一台最新的 iPhone 15 Pro Max，结果只用来打电话。</p>
<p>在 React 的函数式组件（Functional Component）世界里，<code>useRef</code> 其实是一个<strong>法外之地</strong>。
它是你在严格的“不可变数据流”和“频繁重渲染”中，唯一的<strong>逃生舱（Escape Hatch）</strong>。</p>
<p>今天咱们不聊怎么 <code>input.focus()</code>，咱们来聊聊怎么用 <code>useRef</code> 搞定那些 <code>useState</code> 和 <code>useEffect</code> 搞不定的烂摊子。</p>
<hr/>
<h2 data-id="heading-1">核心概念：它是一个“静音”的盒子</h2>
<p>首先，你得把 <code>useRef</code> 理解成一个盒子。</p>
<ul>
<li><strong><code>useState</code></strong>：是<strong>大喇叭</strong>。你改了里面的值，React 立马大喊：“数据变了！所有组件起立，重新渲染！”</li>
<li><strong><code>useRef</code></strong>：是<strong>静音抽屉</strong>。你偷偷把里面的值改了，React 根本不知道，组件该干嘛干嘛，不会触发重渲染。</li>
</ul>
<p>而且，最最重要的是：<strong>组件每次重渲染，这个盒子都是同一个盒子（内存地址不变）。</strong></p>
<p>这就赋予了它两个神级能力：<strong>“穿越时空”</strong> 和 <strong>“暗度陈仓”</strong>。</p>
<hr/>
<h2 data-id="heading-2">骚操作一：破解“闭包陷阱” (Stale Closure)</h2>
<p>这是所有 React 新手的噩梦。</p>
<p><strong>场景</strong>：你想写一个定时器，每秒打印一下当前的 count 值。</p>
<h3 data-id="heading-3">❌ 翻车现场：</h3>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// 💀 恐怖故事：这里永远打印 0</span>
    console<span class="hljs-selector-class">.log</span>('Current Count:', count);
  }, <span class="hljs-number">1000</span>);

  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 依赖数组为空，effect 只跑一次</span>
</code></pre>
<p><strong>为什么？</strong> 因为 <code>useEffect</code> 执行的那一瞬间（Mount 时），它捕获了当时的 <code>count</code>（也就是 0）。就像拍了一张照片，照片里的人永远定格在那一刻。哪怕外面 <code>count</code> 变成了 100，定时器闭包里的 <code>count</code> 还是 0。</p>
<p><strong>✅ useRef 救场：</strong></p>
<p>我们要用 <code>useRef</code> 造一个“时光胶囊”，永远保存<strong>最新</strong>的值。</p>
<pre><code class="hljs language-const" lang="const">// 1. 创建一个胶囊
const countRef = useRef(count);

// 2. 每次渲染，都把最新的值塞进胶囊里
// 注意：修改 ref 不会触发渲染，所以这里很安全
countRef.current = count;

useEffect(() =&gt; {
  const timer = setInterval(() =&gt; {
    // 3. 定时器里读胶囊里的值，而不是读外面的快照
    console.log('Current Count:', countRef.current); 
  }, 1000);

  return () =&gt; clearInterval(timer);
}, []); // 依然不需要依赖 count，定时器也不用重启
</code></pre>
<p>这就是 <code>useRef</code> 的“穿透”能力。它打破了闭包的限制，让你在旧的 Effect 里读到了新的 State。</p>
<h2 data-id="heading-4">骚操作二：记录“上一次”的值 (usePrevious)</h2>
<p>在 Class 组件时代，我们有 <code>componentDidUpdate(prevProps)</code>，可以很方便地对比新旧数据。 到了 Hooks 时代，官方竟然没给这个功能？</p>
<p>别急，<code>useRef</code> 既然能存值，那就能存“前任”。</p>
<h3 data-id="heading-5">手写一个 <code>usePrevious</code> Hook：</h3>
<pre><code class="hljs language-function" lang="function">  // 创建一个 ref 来存储值
  const ref = useRef();

  // 每次渲染后，把当前值存进去
  // 注意：useEffect 是在渲染*之后*执行的
  useEffect(() =&gt; {
    ref.current = value;
  }, [value]);

  // 返回 ref 里的值
  // 注意：也就是在本次渲染时，ref.current 还是*上一次*存进去的值
  return ref.current;
}

// 使用
const Demo = () =&gt; {
  const [count, setCount] = useState(0);
  const prevCount = usePrevious(count);

  return (
    &lt;div&gt;
      &lt;p&gt;现在是: {count}&lt;/p&gt;
      &lt;p&gt;刚才还是: {prevCount}&lt;/p&gt;
    &lt;/div&gt;
  );
};
</code></pre>
<p><strong>原理分析：</strong></p>
<ol>
<li><strong>Render 1 (count=0)</strong> : <code>usePrevious</code> 返回 <code>undefined</code>。Render 结束，Effect 运行，<code>ref.current</code> 变为 0。</li>
<li><strong>Render 2 (count=1)</strong> : <code>usePrevious</code> 返回 <code>ref.current</code> (也就是 0)。Render 结束，Effect 运行，<code>ref.current</code> 变为 1。</li>
</ol>
<p>你看，不需要任何魔法，只是利用了 React 的执行顺序，就实现了“时光倒流”。</p>
<hr/>
<h2 data-id="heading-6">骚操作三：防止“初次渲染”执行 Effect</h2>
<p>有时候，我们希望 <code>useEffect</code> 只有在依赖变化时执行，而<strong>不要</strong>在组件刚挂载（Mount）时执行。</p>
<p>比如：用户修改搜索词时发请求，但刚进页面时不要发。</p>
<pre><code class="hljs language-const" lang="const">
useEffect(() =&gt; {
  // 如果是第一次，把开关关掉，直接 return，啥也不干
  if (isFirstMount.current) {
    isFirstMount.current = false;
    return;
  }

  // 从第二次开始，这里的逻辑才会执行
  console.log('搜索词变了，发起请求...');
}, [query]);
</code></pre>
<p>这简直就是控制 Effect 执行时机的最强“阀门”。</p>
<hr/>
<h2 data-id="heading-7">总结：使用 <code>useRef</code> 的红线</h2>
<p>虽然 <code>useRef</code> 很爽，既能穿透闭包，又能静默更新，但请记住一条<strong>铁律</strong>：</p>
<p><strong>永远不要在渲染期间（Rendering Logic）读取或写入 <code>ref.current</code>。</strong></p>
<pre><code class="hljs language-const" lang="const">  const count = useRef(0);
  
  // ❌ 报错警告！这是不纯的操作！
  // 在渲染过程中修改 ref，会导致行为不可预测
  count.current = count.current + 1; 

  // ❌ 也不要直接读来做渲染判断
  // 因为 ref 变了不会触发重绘，视图可能不会更新
  return &lt;div&gt;{count.current}&lt;/div&gt;;
};
</code></pre>
<p><strong>正确的使用姿势：</strong></p>
<ul>
<li>在 <code>useEffect</code> 里读/写。</li>
<li>在 <code>Event Handler</code>（点击事件等）里读/写。</li>
<li>总之，别在 return JSX 之前的那个函数体里直接搞事。</li>
</ul>
<p><code>useRef</code> 是 React 留给我们的后门，当你发现 <code>useState</code> 让你的组件频繁渲染卡顿，或者 <code>useEffect</code> 的依赖数组让你头秃时，不妨想想这个静音的小盒子。</p>
<p>好了，收工。</p>
<blockquote>
<p><strong>下期预告</strong>：你真的以为你会写 <code>useCallback</code> 和 <code>useMemo</code> 吗？我打赌你的代码里 80% 的 <code>useMemo</code> 都在做负优化。下一篇，我们来聊聊 React 性能优化的“安慰剂效应”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 中的async和await]]></title>    <link>https://juejin.cn/post/7578948893762551835</link>    <guid>https://juejin.cn/post/7578948893762551835</guid>    <pubDate>2025-12-02T09:10:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578948893762551835" data-draft-id="7578836326474940443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 中的async和await"/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-02T09:10:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 中的async和await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:10:53.000Z" title="Tue Dec 02 2025 09:10:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>异步编程</code>是指程序在执行任务时，不需要等待任务完成才能继续执行其他任务。传统的同步编程方式会导致程序等待某个操作完成（比如网络请求、磁盘读写等），直到任务完成后才会继续执行，可能会造成性能瓶颈。异步编程允许程序在等待某个操作时去执行其他任务，从而提高效率。</p>
<p><code>async</code> 和 <code>await</code> 是 Swift 5.5 引入的用于处理异步编程的关键字，它们使得处理异步任务变得更加简单和直观。它们提供了一种新的方式来管理异步操作，相比传统的回调函数或闭包，<code>async</code>/<code>await</code> 更接近同步代码的写法，让代码更加易读和可维护。</p>
<h3 data-id="heading-0">一、<code>async</code> 和 <code>await</code></h3>
<ul>
<li><strong><code>async</code></strong>: 用于标记一个函数为异步函数。异步函数会返回一个 <code>Task</code> 类型，可以在执行时暂停，直到结果准备好。</li>
<li><strong><code>await</code></strong>: 用于暂停函数的执行，直到异步操作完成并返回结果。</li>
</ul>
<h4 data-id="heading-1">1、<strong>标记异步函数</strong></h4>
<p>使用 <code>async</code> 关键字来定义一个异步函数，表示这个函数包含异步操作，并且可能需要一些时间来执行。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
</code></pre>
<p><code>handleData()</code>是一个异步函数，它返回一个字符串。函数内部的操作可能会是一个耗时操作，虽然这里没有具体的异步代码，但它表示这段代码可以用异步方式进行处理。</p>
<h4 data-id="heading-2">2、 <strong>调用异步函数</strong></h4>
<p>调用一个异步函数，必须在一个异步上下文中使用 <code>await</code> 关键字。<code>await</code> 会暂停当前的代码执行，直到异步函数返回结果。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// 去调用异步任务</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">callAsync</span>() <span class="hljs-keyword">async</span>{
        <span class="hljs-comment">/// 等待异常函数返回结果</span>
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
        <span class="hljs-built_in">print</span>(result)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
</code></pre>
<h4 data-id="heading-3">3 <strong>异步任务的创建</strong></h4>
<p>使用 <code>Task</code> 来创建异步任务。<code>Task</code> 允许你在异步上下文之外执行异步代码。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1"</span>)
        <span class="hljs-type">Task</span> {
            <span class="hljs-comment">/// 等待异常函数返回结果</span>
            <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
            <span class="hljs-built_in">print</span>(result)
        }
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2"</span>)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
        <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
    }
    
    <span class="hljs-comment">// 打印信息 1 、 2 、 handle data</span>
</code></pre>
<p><code>Task</code> 是一个异步任务，它会自动创建一个新的异步上下文来执行异步代码。<code>当你需要在不直接处于异步函数内部的地方执行异步代码时。</code></p>
<h3 data-id="heading-4">二、<strong><code>async</code> 和 <code>await</code> 与传统的闭包回调对比</strong></h3>
<p>传统的异步编程中，我们可能会使用闭包来处理异步操作的回调</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        
        handleData { data <span class="hljs-keyword">in</span>
            <span class="hljs-built_in">print</span>(data)
        }
       
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">completion</span>: <span class="hljs-keyword">@escaping</span>(<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>){
        <span class="hljs-type">DispatchQueue</span>.main.async {
            <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-string">"handle data"</span>
            completion(data)
        }
    }
</code></pre>
<p>使用 <code>async</code> 和 <code>await</code> 后，你可以这样写</p>
<pre><code class="hljs language-Swift" lang="Swift"> <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-comment">/// 等待异常函数返回结果</span>
             <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData()
             <span class="hljs-built_in">print</span>(result)
         }
     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> -&gt;<span class="hljs-type">String</span>{
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
     }
</code></pre>
<p>相比使用闭包，<code>async</code> 和 <code>await</code> 更加简洁、直观。</p>
<h3 data-id="heading-5">三、<strong>错误处理</strong></h3>
<p>异步函数中，错误处理通常使用 <code>do-catch</code> 语句来处理。你可以在异步函数中抛出错误，并使用 <code>await</code> 来捕获和处理它们</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">jlDataError</span>: <span class="hljs-title class_">Error</span>{
    <span class="hljs-keyword">case</span> invalidData
}

 <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {

     <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-keyword">do</span> {
                 <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> handleData()
                 <span class="hljs-built_in">print</span>(result)
             } <span class="hljs-keyword">catch</span>{
                 <span class="hljs-built_in">print</span>(<span class="hljs-string">"Error:<span class="hljs-subst">\(error)</span>"</span>)
             }
             
         }

     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt;<span class="hljs-type">String</span>{
         
         <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
         <span class="hljs-keyword">if</span> success <span class="hljs-operator">==</span> <span class="hljs-literal">false</span>{
             <span class="hljs-keyword">throw</span> jlDataError.invalidData
         }
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data"</span>
     }
     
 }
</code></pre>
<p>上述代码中，<code>handleData()</code> 可能会抛出 <code>DataError.invalidData</code> 错误，调用它时需要使用 <code>try await</code> 来捕获和处理错误。</p>
<h3 data-id="heading-6">四、 <strong>并发执行多个异步任务</strong></h3>
<p>可以使用 <code>async let</code> 来并行执行多个异步任务，并且在最后获取它们的结果。这是一个非常强大的功能，尤其是当你需要同时处理多个异步操作时。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
         <span class="hljs-keyword">super</span>.viewDidLoad()
         <span class="hljs-type">Task</span> {
             <span class="hljs-comment">// 异步并发任务</span>
             <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> handleData1 <span class="hljs-operator">=</span> handleData1()
             <span class="hljs-comment">// 异步并发任务</span>
             <span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> handleData2 <span class="hljs-operator">=</span> handleData2()
             <span class="hljs-comment">// 等待结果</span>
             <span class="hljs-keyword">let</span> r1 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData1
             <span class="hljs-keyword">let</span> r2 <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> handleData2
             <span class="hljs-built_in">print</span>(r1,r2)
             
         }

     }

     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData1</span>() <span class="hljs-keyword">async</span>  -&gt;<span class="hljs-type">String</span>{
        
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data1"</span>
     }
     
     <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData2</span>() <span class="hljs-keyword">async</span>  -&gt;<span class="hljs-type">String</span>{
        
         <span class="hljs-comment">// 模拟网络请求，慢处理等</span>
         <span class="hljs-keyword">return</span> <span class="hljs-string">"handle data2"</span>
     }
</code></pre>
<p>在上面的代码中，<code>handleData1</code> 和 <code>handleData2</code> 会并行执行，最终我们使用 <code>await</code> 来获取它们的结果。</p>
<h3 data-id="heading-7"><strong>总结</strong></h3>
<p><code>async</code> 和 <code>await</code> 是处理异步操作的核心工具，它们通过提供一种类似同步代码的结构，使得异步编程更加简单和清晰。使用这些特性，你可以：</p>
<ul>
<li>简化代码，使其更加易读和维护。</li>
<li>避免回调地狱（callback hell）和嵌套的闭包。</li>
<li>更容易进行错误处理。</li>
<li>使并发执行变得简单，减少手动管理异步任务的复杂度。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Tools —— 让 AI 拥有「双手」]]></title>    <link>https://juejin.cn/post/7578853751531110415</link>    <guid>https://juejin.cn/post/7578853751531110415</guid>    <pubDate>2025-12-02T08:30:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531110415" data-draft-id="7578877638988431360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain Tools —— 让 AI 拥有「双手」"/> <meta itemprop="keywords" content="LangChain,Node.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-02T08:30:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain Tools —— 让 AI 拥有「双手」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:30:52.000Z" title="Tue Dec 02 2025 08:30:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain Tools 知识点详解</h2>
<blockquote>
<p>让 AI 拥有「双手」—— Tools 是 LangChain 中最强大的功能之一</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2F" target="_blank" title="https://js.langchain.com/" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75c0964f1ed64b6cbfb1ae119cb59be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=QHPRT4SjH5uqU9cx1jcLds2rsK4%3D" alt="LangChain" loading="lazy"/></a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc89e9ba08664627a0ecbb61b8885546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=ii8Lbk2moh%2BazLzHRDy1ylogky8%3D" alt="Node.js" loading="lazy"/></a>
<a href="https://link.juejin.cn?target=LICENSE" target="_blank" title="LICENSE" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5fa8433112749288e01c79961881b56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJf5ZOI5ZOI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765269052&amp;x-signature=InfnRUfLXyl%2F05a8CLZ%2FfjnnuqE%3D" alt="License" loading="lazy"/></a></p>
<h3 data-id="heading-1">📖 前言</h3>
<p><strong>你是否遇到过这些问题？</strong></p>
<ul>
<li>🤔 让 AI 查询实时信息，它却说"我的知识截止到..."</li>
<li>🤔 让 AI 做精确计算，它却给出一个估算值</li>
<li>🤔 想让 AI 调用你的 API，却不知道从何下手</li>
</ul>
<p><strong>LangChain Tools 就是解决这些问题的利器！</strong></p>
<p>本文将带你从零开始，系统学习 LangChain Tools 的使用方法。无论你是 AI 开发新手还是有经验的开发者，都能从中获得实用的知识和技巧。</p>
<h4 data-id="heading-2">✨ 本文特色</h4>
<ul>
<li>📚 <strong>系统全面</strong> - 从概念到实战，循序渐进</li>
<li>💻 <strong>代码丰富</strong> - 每个知识点都有可运行的示例</li>
<li>🔧 <strong>真实案例</strong> - 包含 TavilySearch 等真实 API 集成</li>
<li>🎯 <strong>实战导向</strong> - 提供完整的动手实践任务</li>
</ul>
<hr/>
<h3 data-id="heading-3">🚀 快速开始 - 环境搭建（5 分钟）</h3>
<blockquote>
<p>在开始学习之前，让我们先搭建好开发环境，确保后面的每个案例都能运行！</p>
</blockquote>
<h4 data-id="heading-4">第 1 步：安装 Trae 编辑器</h4>
<p><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae</a> 是字节跳动推出的 AI 原生 IDE，内置强大的 AI 助手，特别适合学习 AI 开发：</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>AI 代码助手</strong></td><td>内置 Claude/GPT，遇到问题可直接询问</td></tr><tr><td><strong>智能补全</strong></td><td>AI 驱动的代码补全，提高开发效率</td></tr><tr><td><strong>中文友好</strong></td><td>完善的中文界面和 AI 中文对话支持</td></tr><tr><td><strong>完全免费</strong></td><td>个人版免费使用，无需付费</td></tr></tbody></table>
<p><strong>安装步骤：</strong></p>
<ol>
<li>访问 <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a></li>
<li>下载并安装 Trae 编辑器（支持 Mac/Windows）</li>
<li>打开 Trae，登录账号</li>
</ol>
<h4 data-id="heading-5">第 2 步：创建项目</h4>
<p>打开 Trae，创建一个新的文件夹作为学习项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目文件夹</span>
<span class="hljs-built_in">mkdir</span> langchain-tools-demo
<span class="hljs-built_in">cd</span> langchain-tools-demo

<span class="hljs-comment"># 初始化 Node.js 项目</span>
npm init -y
</code></pre>
<h4 data-id="heading-6">第 3 步：安装依赖</h4>
<p>在 Trae 终端（快捷键 <code>Ctrl + `</code> 或 <code>Cmd + `</code>）中执行：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/core @langchain/deepseek zod dotenv
</code></pre>
<p><strong>依赖说明：</strong></p>

























<table><thead><tr><th>包名</th><th>作用</th></tr></thead><tbody><tr><td><code>@langchain/core</code></td><td>LangChain 核心库，包含 Tool 相关 API</td></tr><tr><td><code>@langchain/deepseek</code></td><td>DeepSeek 大模型集成</td></tr><tr><td><code>zod</code></td><td>Schema 验证库，用于定义工具参数</td></tr><tr><td><code>dotenv</code></td><td>环境变量管理</td></tr></tbody></table>
<h4 data-id="heading-7">第 4 步：配置环境变量</h4>
<p>在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># DeepSeek API Key（必需）</span>
<span class="hljs-comment"># 获取地址: https://platform.deepseek.com/</span>
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx
</code></pre>
<blockquote>
<p>💡 <strong>如何获取 DeepSeek API Key？</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a></li>
<li>注册并登录账号</li>
<li>在 API Keys 页面创建新的 Key</li>
<li>新用户赠送免费额度，足够学习使用</li>
</ol>
</blockquote>
<h4 data-id="heading-8">第 5 步：配置 package.json</h4>
<p>修改 <code>package.json</code>，添加 ES Module 支持：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"langchain-tools-demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@langchain/core"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@langchain/deepseek"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.0.2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dotenv"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^17.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"zod"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.23.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">第 6 步：创建第一个测试文件</h4>
<p>创建 <code>test-setup.js</code> 验证环境：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 测试 LLM 连接</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"你好，请用一句话介绍自己"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 环境配置成功！"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 回复:"</span>, response.<span class="hljs-property">content</span>);
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-bash" lang="bash">node test-setup.js
</code></pre>
<p>如果看到 AI 的回复，说明环境配置成功！🎉</p>
<h4 data-id="heading-10">环境问题排查</h4>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><code>Cannot find module</code></td><td>运行 <code>npm install</code> 安装依赖</td></tr><tr><td><code>DEEPSEEK_API_KEY not set</code></td><td>检查 <code>.env</code> 文件是否存在且格式正确</td></tr><tr><td><code>ERR_MODULE_NOT_FOUND</code></td><td>检查 <code>package.json</code> 中是否有 <code>"type": "module"</code></td></tr><tr><td>网络连接错误</td><td>检查网络，DeepSeek API 需要能访问外网</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">📚 目录</h3>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-tools" title="#%E4%BB%80%E4%B9%88%E6%98%AF-tools">什么是 Tools？</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-tools" title="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-tools">为什么需要 Tools？</a></li>
<li><a href="#tools-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#tools-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">Tools 的核心概念</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-tool" title="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-tool">创建自定义 Tool</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%BB%91%E5%AE%9A%E4%B8%8E%E8%B0%83%E7%94%A8" title="#%E5%B7%A5%E5%85%B7%E7%BB%91%E5%AE%9A%E4%B8%8E%E8%B0%83%E7%94%A8">工具绑定与调用</a></li>
<li><a href="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%BE%AA%E7%8E%AF" title="#%E5%AE%8C%E6%95%B4%E7%9A%84%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E5%BE%AA%E7%8E%AF">完整的工具调用循环</a></li>
<li><a href="#langchain-%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7---tavilysearch" title="#langchain-%E5%86%85%E7%BD%AE%E5%B7%A5%E5%85%B7---tavilysearch">LangChain 内置工具 - TavilySearch</a></li>
<li><a href="#agent-%E6%99%BA%E8%83%BD%E4%BB%A3%E7%90%86%E8%BF%9B%E9%98%B6" title="#agent-%E6%99%BA%E8%83%BD%E4%BB%A3%E7%90%86%E8%BF%9B%E9%98%B6">Agent 智能代理（进阶）</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90" title="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">实战案例分析</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-faq" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-faq">常见问题 FAQ</a></li>
</ul>
<hr/>
<h3 data-id="heading-12">什么是 Tools？</h3>
<h4 data-id="heading-13">🤔 一句话解释</h4>
<p><strong>Tools 是让大语言模型能够调用外部功能（如查询数据、执行计算、调用 API）的机制。</strong></p>
<h4 data-id="heading-14">形象比喻</h4>
<p>想象你是一个非常聪明的人（AI），但你：</p>
<ul>
<li>❌ 不知道现在几点（没有实时信息）</li>
<li>❌ 算不了复杂数学（只能粗略估算）</li>
<li>❌ 查不了数据库（没有访问权限）</li>
</ul>
<p><strong>Tools 就像给你配备了：</strong></p>
<ul>
<li>⏰ 一块手表（查询时间工具）</li>
<li>🧮 一个计算器（数学计算工具）</li>
<li>💾 一个数据库终端（数据查询工具）</li>
</ul>
<p>现在你可以通过这些"工具"来完成原本做不到的事情！</p>
<hr/>
<h3 data-id="heading-15">为什么需要 Tools？</h3>
<h4 data-id="heading-16">LLM 的天然局限性</h4>






























<table><thead><tr><th>局限性</th><th>说明</th><th>Tools 如何解决</th></tr></thead><tbody><tr><td><strong>知识截止日期</strong></td><td>训练数据有时间限制，无法获取最新信息</td><td>通过搜索工具获取实时信息</td></tr><tr><td><strong>无法执行计算</strong></td><td>只能估算，不能精确计算</td><td>调用计算器工具</td></tr><tr><td><strong>无法访问数据</strong></td><td>无法查询数据库或调用 API</td><td>通过数据查询工具访问</td></tr><tr><td><strong>无法执行操作</strong></td><td>不能发送邮件、修改文件等</td><td>通过操作类工具执行</td></tr></tbody></table>
<h4 data-id="heading-17">没有 Tools vs 有 Tools</h4>
<h5 data-id="heading-18">❌ 没有 Tools</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 北京今天天气怎么样？</span>
<span class="hljs-section">AI: 抱歉，我无法获取实时天气信息。建议你访问天气预报网站...</span>
</code></pre>
<h5 data-id="heading-19">✅ 有 Tools</h5>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 北京今天天气怎么样？</span>
<span class="hljs-section">AI: [调用天气工具]</span>
    → 获取到: 北京今天晴朗，温度 15°C，湿度 45%

<span class="hljs-section">回答: 北京今天天气晴朗，温度 15°C，湿度 45%，适合出行！</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">Tools 的核心概念</h3>
<h4 data-id="heading-21">1. Tool 的四要素</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-comment">// 1️⃣ 名称 - AI 用来识别工具</span>
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,

  <span class="hljs-comment">// 2️⃣ 描述 - 告诉 AI 什么时候使用这个工具</span>
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,

  <span class="hljs-comment">// 3️⃣ 参数 Schema - 定义工具需要什么输入</span>
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
    <span class="hljs-attr">unit</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"celsius"</span>, <span class="hljs-string">"fahrenheit"</span>]).<span class="hljs-title function_">optional</span>(),
  }),

  <span class="hljs-comment">// 4️⃣ 执行函数 - 工具的实际逻辑</span>
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city, unit }) =&gt; {
    <span class="hljs-comment">// 调用天气 API</span>
    <span class="hljs-keyword">const</span> weather = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(weather);
  },
});
</code></pre>
<h4 data-id="heading-22">2. Tool 的工作流程</h4>
<pre><code class="hljs language-php" lang="php">┌─────────────┐
│  用户提问    │ <span class="hljs-string">"北京天气怎么样？"</span>
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  AI 分析     │ 需要调用 get_weather 工具
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Tool 调用   │ <span class="hljs-title function_ invoke__">get_weather</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> })
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  返回结果    │ { temp: <span class="hljs-number">15</span>, condition: <span class="hljs-string">"晴"</span> }
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  AI 整合答案 │ <span class="hljs-string">"北京今天晴朗，15°C"</span>
└─────────────┘
</code></pre>
<h4 data-id="heading-23">3. Tool 的类型</h4>

























<table><thead><tr><th>类型</th><th>类名</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>结构化工具</strong></td><td><code>DynamicStructuredTool</code></td><td>需要明确参数定义的工具（推荐）</td></tr><tr><td><strong>简单工具</strong></td><td><code>Tool</code></td><td>参数简单的工具（较少使用）</td></tr><tr><td><strong>内置工具</strong></td><td>如 <code>Calculator</code></td><td>使用 LangChain 提供的现成工具</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-24">创建自定义 Tool</h3>
<h4 data-id="heading-25">示例 1: 天气查询工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称，例如：北京、上海、深圳"</span>),
    <span class="hljs-attr">unit</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"celsius"</span>, <span class="hljs-string">"fahrenheit"</span>]).<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"温度单位"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city, unit = <span class="hljs-string">"celsius"</span> }) =&gt; {
    <span class="hljs-comment">// 实际应用中这里会调用真实的天气 API</span>
    <span class="hljs-keyword">const</span> weatherData = {
      北京: { <span class="hljs-attr">temp</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴朗"</span>, <span class="hljs-attr">humidity</span>: <span class="hljs-number">45</span> },
      上海: { <span class="hljs-attr">temp</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span>, <span class="hljs-attr">humidity</span>: <span class="hljs-number">65</span> },
    };

    <span class="hljs-keyword">const</span> data = weatherData[city] || {
      <span class="hljs-attr">temp</span>: <span class="hljs-number">22</span>,
      <span class="hljs-attr">condition</span>: <span class="hljs-string">"未知"</span>,
      <span class="hljs-attr">humidity</span>: <span class="hljs-number">50</span>,
    };

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">city</span>: city,
      <span class="hljs-attr">temperature</span>: <span class="hljs-string">`<span class="hljs-subst">${data.temp}</span>°C`</span>,
      <span class="hljs-attr">condition</span>: data.<span class="hljs-property">condition</span>,
      <span class="hljs-attr">humidity</span>: <span class="hljs-string">`<span class="hljs-subst">${data.humidity}</span>%`</span>,
    });
  },
});
</code></pre>
<h4 data-id="heading-26">示例 2: 计算器工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算。支持加减乘除、幂运算等。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式，例如: '2 + 3 * 4'"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 生产环境应使用 math.js 等安全的库</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算结果: <span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算错误: <span class="hljs-subst">${error.message}</span>`</span>;
    }
  },
});
</code></pre>
<h4 data-id="heading-27">示例 3: 数据库查询工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> databaseTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_database"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询用户数据库。可以根据用户 ID 或邮箱查询用户信息。"</span>,

  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">query_type</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"by_id"</span>, <span class="hljs-string">"by_email"</span>]).<span class="hljs-title function_">describe</span>(<span class="hljs-string">"查询类型"</span>),
    <span class="hljs-attr">value</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"查询值：ID 或邮箱"</span>),
  }),

  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ query_type, value }) =&gt; {
    <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">const</span> users = [
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"001"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"zhang@example.com"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> },
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"002"</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">"li@example.com"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"李四"</span> },
    ];

    <span class="hljs-keyword">let</span> user;
    <span class="hljs-keyword">if</span> (query_type === <span class="hljs-string">"by_id"</span>) {
      user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.<span class="hljs-property">id</span> === value);
    } <span class="hljs-keyword">else</span> {
      user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">u</span>) =&gt;</span> u.<span class="hljs-property">email</span> === value);
    }

    <span class="hljs-keyword">return</span> user ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(user) : <span class="hljs-string">"未找到用户"</span>;
  },
});
</code></pre>
<h4 data-id="heading-28">📝 实战练习 1：创建你的第一个工具</h4>
<p>在项目中创建 <code>01-create-tool.js</code> 文件，完整代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 1：创建自定义工具
 * 运行命令：node 01-create-tool.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建天气查询工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-comment">// 模拟天气数据</span>
    <span class="hljs-keyword">const</span> weatherData = {
      北京: { <span class="hljs-attr">temp</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴朗"</span> },
      上海: { <span class="hljs-attr">temp</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span> },
      深圳: { <span class="hljs-attr">temp</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"小雨"</span> },
    };
    <span class="hljs-keyword">const</span> data = weatherData[city] || { <span class="hljs-attr">temp</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"未知"</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ city, ...data });
  },
});

<span class="hljs-comment">// 创建计算器工具</span>
<span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`计算错误: <span class="hljs-subst">${e.message}</span>`</span>;
    }
  },
});

<span class="hljs-comment">// 测试工具</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 测试天气工具:"</span>);
<span class="hljs-keyword">const</span> weather = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weather);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n🔧 测试计算器工具:"</span>);
<span class="hljs-keyword">const</span> calc = <span class="hljs-keyword">await</span> calculatorTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">expression</span>: <span class="hljs-string">"2 + 3 * 4"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ 工具创建成功！"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 01-create-tool.js
</code></pre>
<p><strong>预期输出：</strong></p>
<pre><code class="hljs language-css" lang="css">🔧 测试天气工具:
{"city":<span class="hljs-string">"北京"</span>,<span class="hljs-string">"temp"</span>:<span class="hljs-number">15</span>,<span class="hljs-string">"condition"</span>:<span class="hljs-string">"晴朗"</span>}

🔧 测试计算器工具:
<span class="hljs-number">2</span> + <span class="hljs-number">3</span> * <span class="hljs-number">4</span> = <span class="hljs-number">14</span>

✅ 工具创建成功！
</code></pre>
<hr/>
<h3 data-id="heading-29">工具绑定与调用</h3>
<h4 data-id="heading-30">1. 绑定工具到 LLM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 工具调用建议使用低温度</span>
});

<span class="hljs-comment">// 定义工具列表</span>
<span class="hljs-keyword">const</span> tools = [weatherTool, calculatorTool, databaseTool];

<span class="hljs-comment">// 绑定工具</span>
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);
</code></pre>
<h4 data-id="heading-31">2. 调用并检查工具请求</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户提问</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);

<span class="hljs-comment">// 检查 AI 是否请求调用工具</span>
<span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 决定调用工具:"</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`工具名称: <span class="hljs-subst">${toolCall.name}</span>`</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`参数:`</span>, toolCall.<span class="hljs-property">args</span>);

    <span class="hljs-comment">// 找到对应的工具并执行</span>
    <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">if</span> (tool) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`工具返回:`</span>, result);
    }
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// AI 直接回答，无需工具</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 回答:"</span>, response.<span class="hljs-property">content</span>);
}
</code></pre>
<h4 data-id="heading-32">3. 工具调用的完整流程</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完整示例：AI 自动选择并调用工具</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 1. AI 分析问题并决定是否需要工具</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(question);

  <span class="hljs-comment">// 2. 如果需要工具，执行工具调用</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> toolResults = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        toolResults.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: toolCall.<span class="hljs-property">name</span>,
          <span class="hljs-attr">result</span>: result,
        });
      }
    }

    <span class="hljs-comment">// 3. 将工具结果返回给 AI，让 AI 生成最终答案</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ 工具调用完成，结果:"</span>, toolResults);

    <span class="hljs-comment">// 实际应用中，需要将工具结果传回 AI 继续对话</span>
    <span class="hljs-comment">// 这通常通过 Agent 自动完成（见下一节）</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 直接回答:"</span>, response.<span class="hljs-property">content</span>);
  }
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"计算 123 * 456"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askWithTools</span>(<span class="hljs-string">"你好"</span>);
</code></pre>
<h4 data-id="heading-33">📝 实战练习 2：AI 自动选择工具</h4>
<p>创建 <code>02-bind-tools.js</code> 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 2：将工具绑定到 LLM
 * 运行命令：node 02-bind-tools.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 1. 创建工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气时使用此工具。"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-keyword">const</span> data = { 北京: <span class="hljs-number">15</span>, 上海: <span class="hljs-number">20</span>, 深圳: <span class="hljs-number">28</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ city, <span class="hljs-attr">temp</span>: data[city] || <span class="hljs-number">25</span>, <span class="hljs-attr">unit</span>: <span class="hljs-string">"°C"</span> });
  },
});

<span class="hljs-keyword">const</span> calculatorTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculator"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"执行数学计算。当用户需要计算时使用此工具。"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">expression</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数学表达式"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Function</span>(<span class="hljs-string">`"use strict"; return (<span class="hljs-subst">${expression}</span>)`</span>)();
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${expression}</span> = <span class="hljs-subst">${result}</span>`</span>;
  },
});

<span class="hljs-comment">// 2. 初始化 LLM 并绑定工具</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tools = [weatherTool, calculatorTool];
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);

<span class="hljs-comment">// 3. 测试 AI 自动选择工具</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🤔 用户: <span class="hljs-subst">${question}</span>`</span>);
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(question);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 AI 决定调用工具:"</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   工具: <span class="hljs-subst">${tc.name}</span>, 参数:`</span>, tc.<span class="hljs-property">args</span>);
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === tc.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   结果: <span class="hljs-subst">${result}</span>`</span>);
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"💬 AI 直接回答:"</span>, response.<span class="hljs-property">content</span>);
  }
}

<span class="hljs-comment">// 运行测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"北京今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"计算 15 * 8 + 20"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">testToolSelection</span>(<span class="hljs-string">"你好，介绍一下你自己"</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ 测试完成！"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 02-bind-tools.js
</code></pre>
<p><strong>观察要点：</strong></p>
<ul>
<li>AI 会根据问题自动选择合适的工具</li>
<li>询问天气时，AI 调用 <code>get_weather</code> 工具</li>
<li>需要计算时，AI 调用 <code>calculator</code> 工具</li>
<li>普通对话时，AI 直接回答，不调用工具</li>
</ul>
<hr/>
<h3 data-id="heading-34">完整的工具调用循环</h3>
<h4 data-id="heading-35">核心概念：ToolMessage</h4>
<p>在 LangChain 中，完整的工具调用流程需要使用 <code>ToolMessage</code> 来将工具执行结果传回给 AI：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">AIMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
</code></pre>
<h4 data-id="heading-36">工具调用的完整流程</h4>
<pre><code class="hljs language-css" lang="css">用户: <span class="hljs-string">"上海今天天气怎么样？"</span>
    │
    ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">1</span> 步：发送用户消息给 AI              │
│ → messages = [<span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">"..."</span>)]     │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">2</span> 步：AI 分析并返回 tool_calls       │
│ → aiResponse.tool_calls = [...]        │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">3</span> 步：执行工具调用                   │
│ → result = await tool.<span class="hljs-built_in">invoke</span>(args)     │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">4</span> 步：将工具结果包装为 ToolMessage   │
│ → messages.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">ToolMessage</span>(...))      │
└───────────────┬────────────────────────┘
                │
                ▼
┌────────────────────────────────────────┐
│ 第 <span class="hljs-number">5</span> 步：将所有消息发送给 AI            │
│ → AI 根据工具结果生成最终回答           │
└───────────────┬────────────────────────┘
                │
                ▼
最终回答: <span class="hljs-string">"上海今天天气多云，温度 20°C，湿度 65%。"</span>
</code></pre>
<h4 data-id="heading-37">实现完整的工具调用循环</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-comment">/**
 * 完整的工具调用流程：
 * 1. 用户提问
 * 2. AI 分析并返回 tool_calls
 * 3. 执行工具调用
 * 4. 将工具结果作为 ToolMessage 传回 AI
 * 5. AI 根据工具结果生成最终回答
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 第 1 步：将用户问题发送给 AI</span>
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> aiResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-comment">// 第 2 步：检查 AI 是否需要调用工具</span>
  <span class="hljs-keyword">if</span> (aiResponse.<span class="hljs-property">tool_calls</span> &amp;&amp; aiResponse.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 AI 决定调用以下工具:"</span>);

    <span class="hljs-comment">// 保存 AI 的响应（包含 tool_calls）</span>
    messages.<span class="hljs-title function_">push</span>(aiResponse);

    <span class="hljs-comment">// 第 3 步：执行每个工具调用</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> aiResponse.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`  - 工具: <span class="hljs-subst">${toolCall.name}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`    参数:`</span>, toolCall.<span class="hljs-property">args</span>);

      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`    结果:`</span>, result);

        <span class="hljs-comment">// 第 4 步：将工具结果作为 ToolMessage 添加到消息列表</span>
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 第 5 步：将所有消息（包括工具结果）发送给 AI，获取最终回答</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n📝 AI 整合工具结果...\n"</span>);
    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 最终回答:"</span>, finalResponse.<span class="hljs-property">content</span>);

    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// AI 直接回答，无需工具</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 直接回答:"</span>, aiResponse.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> aiResponse.<span class="hljs-property">content</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"上海今天天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"现在几点了？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithTools</span>(<span class="hljs-string">"你好，介绍一下你自己"</span>); <span class="hljs-comment">// 无需工具</span>
</code></pre>
<h4 data-id="heading-38">ToolMessage 的关键属性</h4>

















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>tool_call_id</code></td><td>必须与 AI 返回的 <code>toolCall.id</code> 对应</td></tr><tr><td><code>content</code></td><td>工具的执行结果（字符串）</td></tr></tbody></table>
<h4 data-id="heading-39">为什么需要 ToolMessage？</h4>
<ol>
<li><strong>对话完整性</strong>：让 AI 知道工具已执行并获取结果</li>
<li><strong>上下文连续</strong>：AI 可以基于工具结果继续推理</li>
<li><strong>多工具支持</strong>：通过 <code>tool_call_id</code> 匹配多个并行调用</li>
</ol>
<h4 data-id="heading-40">📝 实战练习 3：完整的工具调用循环</h4>
<p>创建 <code>03-tool-loop.js</code> 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 3：完整的工具调用循环
 * 运行命令：node 03-tool-loop.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建工具</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取城市天气"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>() }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
    <span class="hljs-keyword">const</span> data = { 北京: <span class="hljs-string">"晴朗 15°C"</span>, 上海: <span class="hljs-string">"多云 20°C"</span>, 深圳: <span class="hljs-string">"小雨 28°C"</span> };
    <span class="hljs-keyword">return</span> data[city] || <span class="hljs-string">"未知城市"</span>;
  },
});

<span class="hljs-keyword">const</span> timeTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_time"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取当前时间"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({}),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">"zh-CN"</span>),
});

<span class="hljs-comment">// 初始化</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tools = [weatherTool, timeTool];
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);

<span class="hljs-comment">// 完整的工具调用循环</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🤔 用户: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-comment">// 第 1 步：发送问题</span>
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-comment">// 第 2 步：检查是否需要工具</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔧 调用工具中..."</span>);
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-comment">// 第 3 步：执行工具</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === tc.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   <span class="hljs-subst">${tc.name}</span>: <span class="hljs-subst">${result}</span>`</span>);

        <span class="hljs-comment">// 第 4 步：添加 ToolMessage</span>
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: tc.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 第 5 步：获取最终回答</span>
    <span class="hljs-keyword">const</span> final = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ AI:"</span>, final.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> final.<span class="hljs-property">content</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI:"</span>, response.<span class="hljs-property">content</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"北京天气怎么样？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"现在几点了？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chat</span>(<span class="hljs-string">"你好"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 03-tool-loop.js
</code></pre>
<p><strong>关键学习点：</strong></p>
<ul>
<li><code>HumanMessage</code>：用户消息</li>
<li><code>ToolMessage</code>：工具结果消息，必须包含 <code>tool_call_id</code></li>
<li>AI 会整合工具结果，生成自然语言回答</li>
</ul>
<hr/>
<h3 data-id="heading-41">LangChain 内置工具 - TavilySearch</h3>
<blockquote>
<p>🔍 让 AI 拥有真正的互联网搜索能力</p>
</blockquote>
<h4 data-id="heading-42">什么是 TavilySearch？</h4>
<p><strong>TavilySearch</strong> 是 LangChain 官方推荐的搜索工具，专为 AI Agent 设计。它是目前最适合与 LLM 配合使用的搜索引擎。</p>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>专为 AI 设计</strong></td><td>返回结构化数据，便于 LLM 理解和处理</td></tr><tr><td><strong>实时搜索</strong></td><td>获取互联网最新信息，突破 LLM 知识截止日期限制</td></tr><tr><td><strong>免费额度</strong></td><td>每月 1000 次免费调用，足够学习和个人项目使用</td></tr><tr><td><strong>易于集成</strong></td><td>LangChain 原生支持，几行代码即可使用</td></tr></tbody></table>
<h4 data-id="heading-43">获取 Tavily API Key</h4>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftavily.com%2F" target="_blank" title="https://tavily.com/" ref="nofollow noopener noreferrer">tavily.com/</a></li>
<li>点击 "Get API Key" 注册账号（支持 GitHub/Google 一键登录）</li>
<li>在 Dashboard 中复制你的 API Key</li>
<li>在项目根目录的 <code>.env</code> 文件中添加：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">TAVILY_API_KEY=tvly-xxxxxxxxxxxxxxxxx
</code></pre>
<h4 data-id="heading-44">安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/tavily
</code></pre>
<h4 data-id="heading-45">基础使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 创建 TavilySearch 工具实例</span>
<span class="hljs-keyword">const</span> tavilyTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({
  <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// 返回结果数量（1-10）</span>
  <span class="hljs-comment">// topic: "general",  // 可选: "general" | "news"</span>
  <span class="hljs-comment">// includeAnswer: true, // 可选: 是否包含 AI 生成的摘要</span>
});

<span class="hljs-comment">// 直接调用搜索（注意：需要传入对象格式）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tavilyTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">query</span>: <span class="hljs-string">"LangChain 最新版本特性"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
</code></pre>
<h4 data-id="heading-46">与 LLM 集成使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-comment">// 初始化 LLM 和搜索工具</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> tavilyTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({ <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span> });

<span class="hljs-comment">// 绑定工具到 LLM</span>
<span class="hljs-keyword">const</span> llmWithSearch = llm.<span class="hljs-title function_">bindTools</span>([tavilyTool]);

<span class="hljs-comment">// 完整的搜索问答流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tavilyTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
      <span class="hljs-comment">// TavilySearch 返回对象，需要转换为字符串</span>
      <span class="hljs-keyword">const</span> resultStr =
        <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span> ? result : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      messages.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
          <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
          <span class="hljs-attr">content</span>: resultStr, <span class="hljs-comment">// ToolMessage 的 content 必须是字符串</span>
        })
      );
    }

    <span class="hljs-comment">// AI 整合搜索结果生成最终答案</span>
    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-string">"2024年 AI 领域有哪些重大突破？"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(answer);
</code></pre>
<h4 data-id="heading-47">TavilySearch 配置选项</h4>









































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>maxResults</code></td><td>number</td><td>5</td><td>返回结果数量（1-10）</td></tr><tr><td><code>topic</code></td><td>string</td><td>"general"</td><td>搜索主题："general" 或 "news"</td></tr><tr><td><code>includeAnswer</code></td><td>boolean</td><td>false</td><td>是否包含 AI 生成的摘要答案</td></tr><tr><td><code>includeRawContent</code></td><td>boolean</td><td>false</td><td>是否包含原始网页内容</td></tr><tr><td><code>searchDepth</code></td><td>string</td><td>"basic"</td><td>搜索深度："basic" 或 "advanced"</td></tr></tbody></table>
<h4 data-id="heading-48">为什么选择 TavilySearch？</h4>



































<table><thead><tr><th>对比项</th><th>TavilySearch</th><th>Google Search API</th><th>Bing Search API</th></tr></thead><tbody><tr><td><strong>AI 优化</strong></td><td>✅ 专为 LLM 设计</td><td>❌ 通用搜索</td><td>❌ 通用搜索</td></tr><tr><td><strong>免费额度</strong></td><td>✅ 1000 次/月</td><td>❌ 需付费</td><td>⚠️ 有限免费</td></tr><tr><td><strong>接入难度</strong></td><td>✅ LangChain 原生支持</td><td>⚠️ 需要额外配置</td><td>⚠️ 需要额外配置</td></tr><tr><td><strong>返回格式</strong></td><td>✅ 结构化，LLM 友好</td><td>⚠️ 需要解析</td><td>⚠️ 需要解析</td></tr></tbody></table>
<h4 data-id="heading-49">📝 实战练习 4：使用 TavilySearch 搜索实时信息</h4>
<blockquote>
<p>⚠️ 本练习需要 Tavily API Key，请先完成注册</p>
</blockquote>
<p><strong>第 1 步：安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/tavily
</code></pre>
<p><strong>第 2 步：配置 API Key</strong></p>
<p>在 <code>.env</code> 文件中添加：</p>
<pre><code class="hljs language-bash" lang="bash">TAVILY_API_KEY=tvly-xxxxxxxxxxxxxxxx
</code></pre>
<p><strong>第 3 步：创建 <code>04-tavily-search.js</code> 文件</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 实战练习 4：TavilySearch 真实搜索
 * 运行命令：node 04-tavily-search.js
 */</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TavilySearch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/tavily"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 检查 API Key</span>
<span class="hljs-keyword">if</span> (!process.<span class="hljs-property">env</span>.<span class="hljs-property">TAVILY_API_KEY</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"❌ 请先配置 TAVILY_API_KEY"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"   获取地址: https://tavily.com/"</span>);
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 创建搜索工具</span>
<span class="hljs-keyword">const</span> searchTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TavilySearch</span>({ <span class="hljs-attr">maxResults</span>: <span class="hljs-number">3</span> });

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> });
<span class="hljs-keyword">const</span> llmWithSearch = llm.<span class="hljs-title function_">bindTools</span>([searchTool]);

<span class="hljs-comment">// 搜索并回答</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n🔍 问题: <span class="hljs-subst">${question}</span>\n`</span>);

  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📡 搜索中..."</span>);
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> tc <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> searchTool.<span class="hljs-title function_">invoke</span>(tc.<span class="hljs-property">args</span>);
      <span class="hljs-keyword">const</span> resultStr =
        <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span> ? result : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
        <span class="hljs-string">`   找到 <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.parse(resultStr).results?.length || <span class="hljs-number">0</span>}</span> 条结果`</span>
      );

      messages.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({ <span class="hljs-attr">tool_call_id</span>: tc.<span class="hljs-property">id</span>, <span class="hljs-attr">content</span>: resultStr })
      );
    }

    <span class="hljs-keyword">const</span> final = <span class="hljs-keyword">await</span> llmWithSearch.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n✅ AI 回答:"</span>, final.<span class="hljs-property">content</span>);
    <span class="hljs-keyword">return</span> final.<span class="hljs-property">content</span>;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ AI 回答:"</span>, response.<span class="hljs-property">content</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试真实搜索</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">searchAndAnswer</span>(<span class="hljs-string">"2024年诺贝尔物理学奖得主是谁？"</span>);
</code></pre>
<p><strong>运行测试：</strong></p>
<pre><code class="hljs language-bash" lang="bash">node 04-tavily-search.js
</code></pre>
<p><strong>如果没有 Tavily API Key</strong>，可以跳过此练习，前面的练习已经涵盖了 Tools 的核心概念。</p>
<hr/>
<h3 data-id="heading-50">Agent 智能代理（进阶）</h3>
<blockquote>
<p>⚠️ <strong>注意</strong>：在 LangChain.js v1.x 中，Agent 相关功能已迁移到 <code>@langchain/langgraph</code> 包。</p>
<p>如果你需要使用 Agent，请安装：<code>npm install @langchain/langgraph</code></p>
</blockquote>
<h4 data-id="heading-51">什么是 Agent？</h4>
<p><strong>Agent</strong> 是一个智能代理，它可以：</p>
<ol>
<li>🤔 <strong>分析任务</strong> - 理解用户需求</li>
<li>🛠️ <strong>选择工具</strong> - 决定调用哪些工具</li>
<li>🔄 <strong>执行循环</strong> - 自动调用工具、获取结果、再分析</li>
<li>💬 <strong>生成答案</strong> - 整合所有信息，给出最终回答</li>
</ol>
<h4 data-id="heading-52">手动实现 vs Agent</h4>



































<table><thead><tr><th>对比项</th><th>手动实现（推荐入门）</th><th>Agent（进阶）</th></tr></thead><tbody><tr><td><strong>依赖包</strong></td><td><code>@langchain/core</code></td><td><code>@langchain/langgraph</code></td></tr><tr><td><strong>工具选择</strong></td><td>需要你编写逻辑</td><td>AI 自动决定</td></tr><tr><td><strong>循环调用</strong></td><td>需要手动编写循环</td><td>自动执行多轮调用</td></tr><tr><td><strong>学习曲线</strong></td><td>低，更容易理解原理</td><td>高，抽象程度更高</td></tr><tr><td><strong>适用场景</strong></td><td>学习、简单任务</td><td>复杂的生产应用</td></tr></tbody></table>
<h4 data-id="heading-53">学习建议</h4>
<ol>
<li><strong>先掌握手动实现</strong>：理解工具调用的完整流程</li>
<li><strong>再学习 LangGraph</strong>：用于构建复杂的 Agent 应用</li>
<li><strong>参考文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraphjs%2F" target="_blank" title="https://langchain-ai.github.io/langgraphjs/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraphjs…</a></li>
</ol>
<hr/>
<h3 data-id="heading-54">实战案例分析</h3>
<h4 data-id="heading-55">案例 1: 智能客服助手</h4>
<p><strong>需求</strong>: 创建一个客服助手，可以查询订单状态、退款信息、物流信息。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">// 工具 1: 查询订单</span>
<span class="hljs-keyword">const</span> orderTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_order"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询订单状态和详情"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">order_id</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"订单号"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ order_id }) =&gt; {
    <span class="hljs-comment">// 调用订单系统 API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">order_id</span>: order_id,
      <span class="hljs-attr">status</span>: <span class="hljs-string">"已发货"</span>,
      <span class="hljs-attr">total</span>: <span class="hljs-number">299.0</span>,
      <span class="hljs-attr">items</span>: [<span class="hljs-string">"iPhone 数据线"</span>, <span class="hljs-string">"充电器"</span>],
    });
  },
});

<span class="hljs-comment">// 工具 2: 查询物流</span>
<span class="hljs-keyword">const</span> logisticsTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"query_logistics"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"查询包裹物流信息"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">tracking_number</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"物流单号"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ tracking_number }) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">status</span>: <span class="hljs-string">"运输中"</span>,
      <span class="hljs-attr">location</span>: <span class="hljs-string">"北京分拨中心"</span>,
      <span class="hljs-attr">expected_delivery</span>: <span class="hljs-string">"2025-12-05"</span>,
    });
  },
});

<span class="hljs-comment">// 工具 3: 申请退款</span>
<span class="hljs-keyword">const</span> refundTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"request_refund"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"为订单申请退款"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">order_id</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"订单号"</span>),
    <span class="hljs-attr">reason</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"退款原因"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ order_id, reason }) =&gt; {
    <span class="hljs-comment">// 调用退款系统</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">refund_id</span>: <span class="hljs-string">"RF"</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">status</span>: <span class="hljs-string">"已提交"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"退款申请已提交，预计 3-5 个工作日处理完成"</span>,
    });
  },
});

<span class="hljs-comment">// 创建客服工具集</span>
<span class="hljs-keyword">const</span> customerServiceTools = [orderTool, logisticsTool, refundTool];
<span class="hljs-keyword">const</span> llmWithCustomerTools = llm.<span class="hljs-title function_">bindTools</span>(customerServiceTools);

<span class="hljs-comment">// 使用完整的工具调用流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">customerServiceChat</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithCustomerTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = customerServiceTools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithCustomerTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">customerServiceChat</span>(<span class="hljs-string">"我的订单 12345 什么时候能到？"</span>);
</code></pre>
<h4 data-id="heading-56">案例 2: 数据分析助手</h4>
<p><strong>需求</strong>: 分析销售数据，生成报告。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span>, <span class="hljs-title class_">ToolMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicStructuredTool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-comment">// 工具 1: 查询销售数据</span>
<span class="hljs-keyword">const</span> salesDataTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_sales_data"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定时间范围的销售数据"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">start_date</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"开始日期 YYYY-MM-DD"</span>),
    <span class="hljs-attr">end_date</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"结束日期 YYYY-MM-DD"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ start_date, end_date }) =&gt; {
    <span class="hljs-comment">// 查询数据库</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([
      { <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-12-01"</span>, <span class="hljs-attr">sales</span>: <span class="hljs-number">15000</span>, <span class="hljs-attr">orders</span>: <span class="hljs-number">50</span> },
      { <span class="hljs-attr">date</span>: <span class="hljs-string">"2025-12-02"</span>, <span class="hljs-attr">sales</span>: <span class="hljs-number">18000</span>, <span class="hljs-attr">orders</span>: <span class="hljs-number">60</span> },
    ]);
  },
});

<span class="hljs-comment">// 工具 2: 计算统计指标</span>
<span class="hljs-keyword">const</span> statisticsTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"calculate_statistics"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"计算平均值、总和、增长率等统计指标"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">data</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"JSON 格式的数据数组"</span>),
    <span class="hljs-attr">metric</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"average"</span>, <span class="hljs-string">"sum"</span>, <span class="hljs-string">"growth_rate"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ data, metric }) =&gt; {
    <span class="hljs-keyword">const</span> dataArray = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
    <span class="hljs-comment">// 计算逻辑</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"统计结果..."</span>;
  },
});

<span class="hljs-comment">// 创建数据分析工具集</span>
<span class="hljs-keyword">const</span> analyticsTools = [salesDataTool, statisticsTool];
<span class="hljs-keyword">const</span> llmWithAnalyticsTools = llm.<span class="hljs-title function_">bindTools</span>(analyticsTools);

<span class="hljs-comment">// 使用工具进行数据分析</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">analyzeData</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithAnalyticsTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = analyticsTools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithAnalyticsTools.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">analyzeData</span>(<span class="hljs-string">"帮我分析一下 12 月份的销售情况，计算平均销售额和增长率"</span>);
</code></pre>
<hr/>
<h3 data-id="heading-57">最佳实践</h3>
<h4 data-id="heading-58">✅ 1. 编写清晰的工具描述</h4>
<p><strong>❌ 不好的描述</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">description</span>: <span class="hljs-string">"查询天气"</span>;
</code></pre>
<p><strong>✅ 好的描述</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的天气信息。当用户询问天气、温度、是否下雨时使用此工具。"</span>;
</code></pre>
<p><strong>为什么？</strong></p>
<ul>
<li>明确的描述帮助 AI 准确判断何时使用工具</li>
<li>包含使用场景示例</li>
</ul>
<h4 data-id="heading-59">✅ 2. 为参数添加详细的 describe</h4>
<p><strong>❌ 不好的参数定义</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">date</span>: z.<span class="hljs-title function_">string</span>(),
});
</code></pre>
<p><strong>✅ 好的参数定义</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"城市名称，例如：北京、上海、深圳"</span>),
  <span class="hljs-attr">date</span>: z
    .<span class="hljs-title function_">string</span>()
    .<span class="hljs-title function_">optional</span>()
    .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"日期，格式: YYYY-MM-DD。如果不提供则查询今天的天气"</span>),
});
</code></pre>
<h4 data-id="heading-60">✅ 3. 统一返回格式</h4>
<p><strong>推荐返回 JSON 字符串：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);

  <span class="hljs-comment">// ✅ 返回结构化的 JSON</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">city</span>: city,
    <span class="hljs-attr">temperature</span>: data.<span class="hljs-property">temp</span>,
    <span class="hljs-attr">condition</span>: data.<span class="hljs-property">condition</span>,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
  });

  <span class="hljs-comment">// ❌ 不要返回随意格式的字符串</span>
  <span class="hljs-comment">// return `${city}的天气是${data.condition}，温度${data.temp}度`;</span>
};
</code></pre>
<h4 data-id="heading-61">✅ 4. 错误处理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ expression }) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculate</span>(expression);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">result</span>: result });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 返回友好的错误信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"计算失败"</span>,
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
    });
  }
};
</code></pre>
<h4 data-id="heading-62">✅ 5. 使用低温度</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工具调用时建议使用 temperature = 0</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 确保工具选择的确定性</span>
});
</code></pre>
<h4 data-id="heading-63">✅ 6. 限制工具调用深度</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在手动实现中，通过计数器限制调用次数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithToolsLimited</span>(<span class="hljs-params">question, maxIterations = <span class="hljs-number">3</span></span>) {
  <span class="hljs-keyword">let</span> iteration = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];

  <span class="hljs-keyword">while</span> (iteration &lt; maxIterations) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">tool_calls</span> || response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>; <span class="hljs-comment">// 完成</span>
    }

    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    iteration++;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"达到最大迭代次数"</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-64">技术原理</h3>
<h4 data-id="heading-65">Function Calling (函数调用)</h4>
<p>LangChain Tools 基于大模型的 <strong>Function Calling</strong> 能力实现。</p>
<h5 data-id="heading-66">工作原理</h5>
<ol>
<li><strong>工具定义转换为函数签名</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你定义的工具</span>
<span class="hljs-keyword">const</span> weatherTool = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"获取天气"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>() }),
};

<span class="hljs-comment">// LangChain 转换为模型能理解的格式</span>
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
  <span class="hljs-string">"function"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_weather"</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取天气"</span>,
    <span class="hljs-string">"parameters"</span>: {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-string">"properties"</span>: {
        <span class="hljs-string">"city"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span> }
      },
      <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
    }
  }
}
</code></pre>
<ol start="2">
<li><strong>模型返回函数调用请求</strong></li>
</ol>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tool_calls"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_xxx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"function"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"function"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{\"city\": \"北京\"}"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li><strong>LangChain 执行工具并返回结果</strong></li>
</ol>
<hr/>
<h3 data-id="heading-67">常见问题 FAQ</h3>
<h4 data-id="heading-68">Q1: AI 没有调用工具，而是直接回答了？</h4>
<p><strong>原因：</strong></p>
<ul>
<li>工具描述不够清晰</li>
<li>问题太模糊，AI 认为不需要工具</li>
</ul>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 改进工具描述</span>
<span class="hljs-attr">description</span>: <span class="hljs-string">"获取指定城市的实时天气信息。【重要】当用户询问任何关于天气、温度、降雨的问题时，必须使用此工具，不要根据训练数据猜测。"</span>;

<span class="hljs-comment">// ✅ 在调用时使用 system prompt 强调</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SystemMessage</span>, <span class="hljs-title class_">HumanMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-keyword">const</span> messages = [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(
    <span class="hljs-string">"你必须使用提供的工具来获取实时信息，不要根据训练数据回答。"</span>
  ),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"北京天气怎么样？"</span>),
];
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
</code></pre>
<h4 data-id="heading-69">Q2: 工具调用失败怎么办？</h4>
<p><strong>错误处理：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ city }) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchWeather</span>(city);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">data</span>: data });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 返回结构化的错误信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: <span class="hljs-string">"API 调用失败"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">"无法获取天气数据，请稍后重试"</span>,
    });
  }
};
</code></pre>
<h4 data-id="heading-70">Q3: 如何调试工具调用？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 在工具函数中打印调试信息</span>
<span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> (params) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[DEBUG] 工具被调用，参数:"</span>, params);
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">doSomething</span>(params);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[DEBUG] 工具返回:"</span>, result);
  <span class="hljs-keyword">return</span> result;
};

<span class="hljs-comment">// 2. 打印 AI 的 tool_calls</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"北京天气怎么样？"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI tool_calls:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(response.<span class="hljs-property">tool_calls</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));

<span class="hljs-comment">// 3. 手动测试工具（不经过 AI）</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"直接调用结果:"</span>, result);

<span class="hljs-comment">// 4. 打印完整的消息流</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">debugChatWithTools</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"=== 开始调试 ==="</span>);
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"初始消息:"</span>, messages);

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"AI 响应:"</span>, response);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"tool_calls:"</span>, response.<span class="hljs-property">tool_calls</span>);
  <span class="hljs-comment">// ... 继续调试</span>
}
</code></pre>
<h4 data-id="heading-71">Q4: 工具太多，AI 选错了怎么办？</h4>
<p><strong>解决方案：</strong></p>
<ol>
<li><strong>减少工具数量</strong> - 每个 Agent 不要超过 10 个工具</li>
<li><strong>优化描述</strong> - 让每个工具的功能更明确</li>
<li><strong>分组管理</strong> - 为不同任务创建不同的 Agent</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 所有工具放在一起（超过 10 个工具）</span>
<span class="hljs-keyword">const</span> allTools = [
  weatherTool,
  calculatorTool,
  orderTool,
  refundTool,
  logisticsTool,
  databaseTool,
  emailTool,
  searchTool,
  translateTool,
  timeTool, <span class="hljs-comment">// ... 更多工具</span>
];

<span class="hljs-comment">// ✅ 按功能分组，创建不同的 LLM 实例</span>
<span class="hljs-keyword">const</span> customerServiceTools = [orderTool, refundTool, logisticsTool];
<span class="hljs-keyword">const</span> llmForCustomerService = llm.<span class="hljs-title function_">bindTools</span>(customerServiceTools);

<span class="hljs-keyword">const</span> dataAnalysisTools = [databaseTool, calculatorTool, statisticsTool];
<span class="hljs-keyword">const</span> llmForDataAnalysis = llm.<span class="hljs-title function_">bindTools</span>(dataAnalysisTools);
</code></pre>
<h4 data-id="heading-72">Q5: 如何实现工具的权限控制？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sensitiveOperationTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"delete_user"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"删除用户（仅管理员可用）"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">user_id</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">admin_token</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"管理员令牌"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ user_id, admin_token }) =&gt; {
    <span class="hljs-comment">// 验证权限</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">verifyAdminToken</span>(admin_token)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">error</span>: <span class="hljs-string">"权限不足"</span>,
      });
    }

    <span class="hljs-comment">// 执行操作</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">deleteUser</span>(user_id);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> });
  },
});
</code></pre>
<hr/>
<h3 data-id="heading-73">进阶主题</h3>
<h4 data-id="heading-74">1. 工具的组合与链式调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 场景：查询天气后，根据天气推荐穿衣</span>
<span class="hljs-keyword">const</span> weatherTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-comment">/* ... */</span>
});
<span class="hljs-keyword">const</span> clothingRecommendationTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"recommend_clothing"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"根据天气推荐穿衣"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">temperature</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">condition</span>: z.<span class="hljs-title function_">string</span>(),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ temperature, condition }) =&gt; {
    <span class="hljs-comment">// 推荐逻辑</span>
  },
});

<span class="hljs-comment">// Agent 会自动：</span>
<span class="hljs-comment">// 1. 调用 weatherTool 获取天气</span>
<span class="hljs-comment">// 2. 将结果传给 clothingRecommendationTool</span>
<span class="hljs-comment">// 3. 生成最终建议</span>
</code></pre>
<h4 data-id="heading-75">2. 手动实现多轮对话（保存上下文）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用数组保存对话历史</span>
<span class="hljs-keyword">const</span> conversationHistory = [];

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-comment">// 添加新的用户消息</span>
  conversationHistory.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question));

  <span class="hljs-comment">// 调用 AI（包含历史上下文）</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(conversationHistory);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    conversationHistory.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        conversationHistory.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-keyword">const</span> finalResponse = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(conversationHistory);
    conversationHistory.<span class="hljs-title function_">push</span>(finalResponse);
    <span class="hljs-keyword">return</span> finalResponse.<span class="hljs-property">content</span>;
  }

  conversationHistory.<span class="hljs-title function_">push</span>(response);
  <span class="hljs-keyword">return</span> response.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 多轮对话示例</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-string">"查询订单 12345"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">chatWithMemory</span>(<span class="hljs-string">"这个订单什么时候发货的？"</span>); <span class="hljs-comment">// AI 会记得之前的订单号</span>
</code></pre>
<h4 data-id="heading-76">3. 实现流式工具调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注意：工具调用本身通常不支持流式</span>
<span class="hljs-comment">// 但可以在工具结果返回后，流式输出最终回答</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamFinalAnswer</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(question)];
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(messages);

  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">tool_calls</span> &amp;&amp; response.<span class="hljs-property">tool_calls</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    messages.<span class="hljs-title function_">push</span>(response);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> toolCall <span class="hljs-keyword">of</span> response.<span class="hljs-property">tool_calls</span>) {
      <span class="hljs-keyword">const</span> tool = tools.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">t</span>) =&gt;</span> t.<span class="hljs-property">name</span> === toolCall.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">if</span> (tool) {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        messages.<span class="hljs-title function_">push</span>(
          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolMessage</span>({
            <span class="hljs-attr">tool_call_id</span>: toolCall.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: result,
          })
        );
      }
    }

    <span class="hljs-comment">// 流式输出最终回答</span>
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">stream</span>(messages);
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
      process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>);
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-77">学习路径建议</h3>
<h4 data-id="heading-78">📁 本文配套实战文件</h4>
<p>按顺序完成以下练习，逐步掌握 Tools 的使用：</p>



































<table><thead><tr><th>文件名</th><th>内容</th><th>预计用时</th></tr></thead><tbody><tr><td><code>test-setup.js</code></td><td>环境验证</td><td>5 分钟</td></tr><tr><td><code>01-create-tool.js</code></td><td>创建自定义工具</td><td>15 分钟</td></tr><tr><td><code>02-bind-tools.js</code></td><td>AI 自动选择工具</td><td>20 分钟</td></tr><tr><td><code>03-tool-loop.js</code></td><td>完整工具调用循环</td><td>30 分钟</td></tr><tr><td><code>04-tavily-search.js</code></td><td>TavilySearch 真实搜索</td><td>20 分钟</td></tr></tbody></table>
<h4 data-id="heading-79">🎯 学习路线</h4>
<p><strong>第 1 阶段：基础入门（1 小时）</strong></p>
<ol>
<li>✅ 完成环境搭建，运行 <code>test-setup.js</code></li>
<li>✅ 完成 <code>01-create-tool.js</code>，理解工具四要素</li>
<li>✅ 完成 <code>02-bind-tools.js</code>，观察 AI 如何选择工具</li>
</ol>
<p><strong>第 2 阶段：核心掌握（1-2 小时）</strong></p>
<ol>
<li>🔥 完成 <code>03-tool-loop.js</code>，理解 ToolMessage 的作用</li>
<li>🔥 尝试修改工具的 <code>description</code>，观察 AI 行为变化</li>
<li>🔥 创建自己的工具（如：随机数、单位转换）</li>
</ol>
<p><strong>第 3 阶段：进阶应用（2+ 小时）</strong></p>
<ol>
<li>💎 注册 Tavily 账号，完成 <code>04-tavily-search.js</code></li>
<li>💎 创建多工具应用（如：智能助手）</li>
<li>💎 学习 LangGraph 构建复杂 Agent</li>
</ol>
<hr/>
<h3 data-id="heading-80">实战挑战</h3>
<h4 data-id="heading-81">🥉 挑战 1：创建实用工具集</h4>
<p>在掌握基础后，尝试创建以下工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建 05-my-tools.js，实现以下工具：</span>

<span class="hljs-comment">// 1. 随机数生成器</span>
<span class="hljs-keyword">const</span> randomTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"random"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"生成随机数"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">min</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"最小值"</span>),
    <span class="hljs-attr">max</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"最大值"</span>),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ min, max }) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (max - min + <span class="hljs-number">1</span>)) + min);
  },
});

<span class="hljs-comment">// 2. 单位转换工具（温度）</span>
<span class="hljs-keyword">const</span> tempConverterTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"convert_temp"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"摄氏度和华氏度转换"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">value</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">from</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"C"</span>, <span class="hljs-string">"F"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ value, <span class="hljs-keyword">from</span> }) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span> === <span class="hljs-string">"C"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${value}</span>°C = <span class="hljs-subst">${((value * <span class="hljs-number">9</span>) / <span class="hljs-number">5</span> + <span class="hljs-number">32</span>).toFixed(<span class="hljs-number">1</span>)}</span>°F`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${value}</span>°F = <span class="hljs-subst">${(((value - <span class="hljs-number">32</span>) * <span class="hljs-number">5</span>) / <span class="hljs-number">9</span>).toFixed(<span class="hljs-number">1</span>)}</span>°C`</span>;
  },
});

<span class="hljs-comment">// 3. 字符串处理工具</span>
<span class="hljs-keyword">const</span> stringTool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicStructuredTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"string_process"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"字符串处理：大小写转换、反转、Base64编码"</span>,
  <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">text</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">operation</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"upper"</span>, <span class="hljs-string">"lower"</span>, <span class="hljs-string">"reverse"</span>, <span class="hljs-string">"base64"</span>]),
  }),
  <span class="hljs-attr">func</span>: <span class="hljs-keyword">async</span> ({ text, operation }) =&gt; {
    <span class="hljs-keyword">switch</span> (operation) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"upper"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">toUpperCase</span>();
      <span class="hljs-keyword">case</span> <span class="hljs-string">"lower"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">toLowerCase</span>();
      <span class="hljs-keyword">case</span> <span class="hljs-string">"reverse"</span>:
        <span class="hljs-keyword">return</span> text.<span class="hljs-title function_">split</span>(<span class="hljs-string">""</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"base64"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(text).<span class="hljs-title function_">toString</span>(<span class="hljs-string">"base64"</span>);
    }
  },
});
</code></pre>
<h4 data-id="heading-82">🥈 挑战 2：智能助手应用</h4>
<p>创建一个结合多个工具的智能助手：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建 06-smart-assistant.js</span>
<span class="hljs-comment">// 结合天气、时间、计算器、搜索等工具</span>
<span class="hljs-comment">// 实现一个可以回答各种问题的助手</span>
</code></pre>
<h4 data-id="heading-83">🥇 挑战 3：带记忆的对话系统</h4>
<p>参考"进阶主题"章节，实现多轮对话记忆功能。</p>
<h4 data-id="heading-84">💡 挑战完成检验</h4>
<p>完成挑战后，尝试回答以下问题：</p>
<ol>
<li>工具的 <code>description</code> 对 AI 的工具选择有什么影响？</li>
<li>为什么工具函数的返回值建议使用字符串？</li>
<li><code>ToolMessage</code> 的 <code>tool_call_id</code> 为什么是必须的？</li>
<li>如何让 AI 在不需要工具时直接回答？</li>
</ol>
<hr/>
<h3 data-id="heading-85">参考资源</h3>
<h4 data-id="heading-86">官方文档</h4>
<ul>
<li><strong>LangChain Tools 官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">js.langchain.com/docs/concep…</a></li>
<li><strong>LangChain 内置工具列表</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fintegrations%2Ftools" target="_blank" title="https://js.langchain.com/docs/integrations/tools" ref="nofollow noopener noreferrer">js.langchain.com/docs/integr…</a></li>
<li><strong>LangGraph（Agent 框架）</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraphjs%2F" target="_blank" title="https://langchain-ai.github.io/langgraphjs/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraphjs…</a></li>
<li><strong>Zod Schema 验证</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fzod.dev%2F" target="_blank" title="https://zod.dev/" ref="nofollow noopener noreferrer">zod.dev/</a></li>
</ul>
<h4 data-id="heading-87">API 服务</h4>
<ul>
<li><strong>Tavily Search API</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftavily.com%2F" target="_blank" title="https://tavily.com/" ref="nofollow noopener noreferrer">tavily.com/</a> （专为 AI 设计的搜索引擎）</li>
<li><strong>DeepSeek API</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a> （高性价比 LLM）</li>
<li><strong>OpenAI Function Calling</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></li>
</ul>
<h4 data-id="heading-88">开发工具</h4>
<ul>
<li><strong>Trae AI IDE</strong>: <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a> （推荐的 AI 开发环境）</li>
</ul>
<hr/>
<h3 data-id="heading-89">总结</h3>
<h4 data-id="heading-90">🎯 核心要点</h4>
<ol>
<li><strong>Tools 让 AI 拥有能力</strong> - 查询数据、执行计算、调用 API</li>
<li><strong>四要素</strong> - name、description、schema、func</li>
<li><strong>ToolMessage</strong> - 将工具结果传回 AI 的关键</li>
<li><strong>内置工具</strong> - TavilySearch 等 LangChain 官方工具开箱即用</li>
<li><strong>最佳实践</strong> - 清晰描述、错误处理、统一格式</li>
</ol>
<h4 data-id="heading-91">💡 记住这句话</h4>
<blockquote>
<p><strong>Tools 不是让 AI 更聪明，而是让 AI 能做更多事情。</strong></p>
</blockquote>
<h4 data-id="heading-92">📁 本文实战文件清单</h4>
<p>完成本教程后，你的项目结构应该是：</p>
<pre><code class="hljs language-perl" lang="perl">langchain-tools-demo/
├── .env                    <span class="hljs-comment"># 环境变量配置</span>
├── package.json            <span class="hljs-comment"># 项目配置</span>
├── test-setup.js           <span class="hljs-comment"># 环境验证</span>
├── <span class="hljs-number">01</span>-create-tool.js       <span class="hljs-comment"># 实战练习 1：创建工具</span>
├── <span class="hljs-number">02</span>-<span class="hljs-keyword">bind</span>-tools.js        <span class="hljs-comment"># 实战练习 2：绑定工具</span>
├── <span class="hljs-number">03</span>-tool-loop.js         <span class="hljs-comment"># 实战练习 3：完整调用循环</span>
├── <span class="hljs-number">04</span>-tavily-search.js     <span class="hljs-comment"># 实战练习 4：TavilySearch</span>
├── <span class="hljs-number">05</span>-<span class="hljs-keyword">my</span>-tools.js          <span class="hljs-comment"># 挑战 1：自定义工具集</span>
└── <span class="hljs-number">06</span>-smart-assistant.js   <span class="hljs-comment"># 挑战 2：智能助手</span>
</code></pre>
<h4 data-id="heading-93">🔑 关键收获</h4>
<p>学完本文后，你应该能够：</p>
<ul>
<li>✅ 使用 Trae 搭建 LangChain 开发环境</li>
<li>✅ 理解 Tools 的工作原理和使用场景</li>
<li>✅ 创建自定义工具并绑定到 LLM</li>
<li>✅ 实现完整的工具调用循环（包括 ToolMessage）</li>
<li>✅ 使用 TavilySearch 实现真实的互联网搜索</li>
<li>✅ 调试工具调用问题并进行优化</li>
</ul>
<hr/>
<h3 data-id="heading-94">作者寄语</h3>
<p>感谢你阅读这份文档！LangChain Tools 是 AI 应用开发中最实用的功能之一，希望这份详解能帮助你快速上手。</p>
<p><strong>动手实践是最好的学习方式！</strong> 不要只是阅读，请按照文中的实战练习一步步操作，你会发现 Tools 其实很简单。</p>
<p>如果你在学习过程中遇到问题，可以：</p>
<ul>
<li>💬 在 Trae 中询问 AI 助手，它能直接阅读你的代码帮你排查问题</li>
<li>📖 查阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">LangChain 官方文档</a></li>
<li>🔍 使用 TavilySearch 搜索最新的解决方案</li>
</ul>
<p>如果你觉得这份文档对你有帮助，欢迎：</p>
<ul>
<li>⭐ 点赞收藏，方便以后查阅</li>
<li>📢 分享给更多正在学习 AI 开发的朋友</li>
<li>💬 在评论区交流你的学习心得和实践成果</li>
</ul>
<p><strong>Happy Coding!</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[A2A协议：打破AI智能体孤岛，构建智能协作新时代]]></title>    <link>https://juejin.cn/post/7578917474659237939</link>    <guid>https://juejin.cn/post/7578917474659237939</guid>    <pubDate>2025-12-02T08:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659237939" data-draft-id="7578922565209866267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="A2A协议：打破AI智能体孤岛，构建智能协作新时代"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-02T08:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一粒麦仔"/> <meta itemprop="url" content="https://juejin.cn/user/448256474881480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            A2A协议：打破AI智能体孤岛，构建智能协作新时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256474881480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一粒麦仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:35:37.000Z" title="Tue Dec 02 2025 08:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 引言：A2A协议的背景与意义</h2>
<p>随着人工智能技术的飞速发展，AI智能体（AI Agent）已经成为大模型落地业务场景的主流形式。然而，各大科技公司推出的智能体系统往往<strong>各自为政</strong>，形成封闭的生态孤岛，难以实现有效协同。这种碎片化状况严重限制了AI技术在复杂场景中的应用价值。</p>
<p>在此背景下，<strong>Google于2025年4月9日正式推出了Agent-to-Agent（A2A）协议</strong>，这是一个旨在实现不同AI智能体间无缝通信与协作的开放标准。A2A协议致力于解决智能体之间的<strong>互操作性挑战</strong>，让基于不同框架和供应商开发的AI智能体能够像人类团队一样协同工作，共同完成复杂任务。</p>
<p>A2A协议的核心理念是为智能体世界创建一种“通用语言”，类似于互联网中的TCP协议，为设备通信提供基础标准。这一协议的出现，标志着AI发展从追求单个模型能力向<strong>多智能体协同网络</strong>的重要转变，为构建真正开放、互联的AI生态系统奠定了坚实基础。</p>
<h2 data-id="heading-1">2 A2A协议的核心架构与设计理念</h2>
<h3 data-id="heading-2">2.1 基本架构与参与角色</h3>
<p>A2A协议采用经典的<strong>客户端-服务器架构</strong>，包含三个核心参与者：</p>
<ul>
<li><strong>用户</strong>：发起任务请求的终端用户，可以是人类或其他服务。</li>
<li><strong>客户端智能体</strong>：代表用户向远程智能体发起操作请求的实体。</li>
<li><strong>远程智能体</strong>：作为服务端处理请求的“黑箱”智能体，不暴露内部实现细节。</li>
</ul>
<p>这种架构设计体现了A2A协议的<strong>不透明执行原则</strong>，智能体之间无需共享记忆、思维或工具即可协同工作。每个智能体保持自身的独立性和封装性，仅通过标准化的接口进行通信。</p>
<h3 data-id="heading-3">2.2 核心技术组件</h3>
<p>A2A协议构建在一系列精心设计的技术组件之上，这些组件共同构成了智能体间协作的基础框架：</p>
<ul>
<li><strong>智能体卡片</strong>：每个支持A2A协议的智能体都通过一个标准化的JSON文件（称为Agent Card）描述自身能力。这个文件相当于智能体的“身份证”或“简历”，包含了智能体的名称、功能描述、技能列表、认证要求等元数据。Agent Card通常托管在特定的知名路径（<code>/.well-known/agent-card.json</code>），便于其他智能体发现和识别。</li>
<li><strong>任务管理机制</strong>：任务是A2A协议中的核心工作单元，具有完整的生命周期管理。每个任务有唯一ID，可处于提交、工作中、需要输入、完成、失败或取消等不同状态。A2A协议支持<strong>长时间运行的任务</strong>，生命周期可能长达数天，并提供了相应的状态跟踪和恢复机制。</li>
<li><strong>通信协议与数据格式</strong>：A2A采用<strong>HTTP</strong>作为传输协议，使用<strong>JSON-RPC 2.0</strong>作为数据交换格式。这种设计选择充分利用了现有Web标准的成熟度和普遍性，降低了协议的实施门槛。对于实时性要求高的场景，A2A还支持通过<strong>Server-Sent Events</strong>进行流式数据传输。</li>
</ul>
<h3 data-id="heading-4">2.3 核心设计原则</h3>
<p>A2A协议的成功源于以下几个关键设计原则：</p>
<ul>
<li><strong>简洁性</strong>：复用现有标准（如HTTP、JSON-RPC），而非创造全新复杂标准。</li>
<li><strong>企业级就绪</strong>：内置认证、安全、隐私、追踪和监控等企业级需求。</li>
<li><strong>异步优先</strong>：支持长时间运行的任务和需要人类参与的工作流程。</li>
<li><strong>模态无关</strong>：支持文本、音频/视频、表单、iframe等多种交互形式。</li>
<li><strong>黑盒执行</strong>：智能体间无需共享思考过程、计划或工具，保护知识产权。</li>
</ul>
<p><em>表：A2A协议的核心概念与功能</em></p>



































<table><thead><tr><th><strong>概念类型</strong></th><th><strong>核心组件</strong></th><th><strong>功能描述</strong></th><th><strong>技术实现</strong></th></tr></thead><tbody><tr><td><strong>发现机制</strong></td><td>Agent Card</td><td>智能体能力描述</td><td>JSON格式，标准路径托管</td></tr><tr><td><strong>任务管理</strong></td><td>Task</td><td>工作单元与生命周期</td><td>状态机模型，唯一ID标识</td></tr><tr><td><strong>通信单元</strong></td><td>Message/Part</td><td>智能体间数据交换</td><td>结构化数据，多部分支持</td></tr><tr><td><strong>输出结果</strong></td><td>Artifact</td><td>任务执行产物</td><td>不可变，可包含多个部分</td></tr></tbody></table>
<h2 data-id="heading-5">3 A2A协议的工作原理与流程</h2>
<h3 data-id="heading-6">3.1 智能体发现机制</h3>
<p>A2A协议下的智能体协作始于<strong>发现阶段</strong>。客户端智能体需要先发现具备相应能力的远程智能体，这一过程主要通过获取并解析Agent Card实现。</p>
<p>A2A支持三种主要的发现模式：</p>
<ul>
<li><strong>开放发现</strong>：智能体将其Agent Card托管在标准路径（如<code>/.well-known/agent-card.json</code>），供其他智能体自由查找。</li>
<li><strong>策展注册表</strong>：集中式的智能体目录，允许按特定能力进行搜索和筛选。</li>
<li><strong>直接配置</strong>：通过预配置或私下共享的方式直接指定智能体信息，适用于紧密耦合的场景。</li>
</ul>
<p>智能体卡片不仅包含基本身份信息，还详细列出了智能体支持的<strong>技能集</strong>和<strong>认证要求</strong>，使客户端能够准确判断其是否适合执行特定任务。</p>
<h3 data-id="heading-7">3.2 任务执行流程</h3>
<p>一旦客户端智能体发现了合适的远程智能体，双方便进入<strong>任务执行阶段</strong>，其基本流程如下：</p>
<ol>
<li><strong>任务创建</strong>：客户端智能体创建新任务，指定任务内容及相关参数。</li>
<li><strong>任务提交</strong>：客户端将任务发送给远程智能体，可选择同步或异步方式。</li>
<li><strong>任务处理</strong>：远程智能体执行任务，期间可能根据需要请求额外输入或上下文。</li>
<li><strong>结果返回</strong>：远程智能体以<strong>Artifact</strong>的形式返回任务结果，客户端进行整合。</li>
</ol>
<p>A2A协议支持多种交互模式以适应不同场景需求：</p>
<ul>
<li><strong>同步请求/响应</strong>：适用于快速、即时的操作，客户端等待任务完成。</li>
<li><strong>异步轮询</strong>：适用于耗时较长的任务，客户端定期查询任务状态。</li>
<li><strong>流式更新</strong>：通过SSE实现实时增量结果推送。</li>
<li><strong>推送通知</strong>：通过Webhook在任务状态变化时主动通知客户端。</li>
</ul>
<h3 data-id="heading-8">3.3 安全与认证机制</h3>
<p>A2A协议将智能体建模为企业级应用，提供了<strong>完善的安全机制</strong>：</p>
<ul>
<li>遵循OpenAPI认证规范，支持OAuth 2.0、API密钥等多种认证方案。</li>
<li>身份材料通过HTTP头部传递，而非放在消息体内，减少敏感信息暴露风险。</li>
<li>支持双向TLS加密，确保通信通道安全。</li>
<li>提供详细的审计日志，满足企业合规要求。</li>
</ul>
<h2 data-id="heading-9">4 A2A协议与MCP协议的关系</h2>
<p>在智能体通信协议领域，Anthropic公司提出的<strong>模型上下文协议（MCP）</strong> 是另一个备受关注的标准。理解A2A与MCP的关系对于把握智能体生态系统全貌至关重要。</p>
<h3 data-id="heading-10">4.1 功能定位差异</h3>
<p>尽管A2A和MCP都涉及智能体通信，但两者的<strong>功能定位</strong>存在明显区别：</p>
<ul>
<li><strong>A2A</strong>侧重于<strong>智能体间通信</strong>，解决的是不同智能体如何协作完成复杂任务的问题。它允许智能体像人类团队一样分工合作，各自发挥专长。</li>
<li><strong>MCP</strong>则侧重于<strong>智能体与工具间通信</strong>，主要解决大模型如何安全、高效地使用外部工具和数据源的问题。它更像是智能体的“工具包”，扩展了单个智能体的能力边界。</li>
</ul>
<h3 data-id="heading-11">4.2 互补性与协同效应</h3>
<p>实际上，A2A与MCP并非竞争关系，而是<strong>互补协同</strong>的。在未来可能的业务流程中，一个面向用户的助理型智能体通过A2A协议调用其他专用智能体，而这些被调用的智能体再通过MCP协议访问各自掌握的内外部工具完成任务。</p>
<p>这种分工协作的模式既能发挥各智能体的专业优势，又能保证工具使用的安全性和效率。正如Google官方表述，A2A与MCP是合作关系而非竞争关系，共同构建更加完善的智能体生态系统。</p>
<p><em>表：A2A协议与MCP协议对比</em></p>



































<table><thead><tr><th><strong>特性</strong></th><th><strong>A2A协议</strong></th><th><strong>MCP协议</strong></th></tr></thead><tbody><tr><td><strong>主要焦点</strong></td><td>智能体间协作</td><td>智能体与工具连接</td></tr><tr><td><strong>通信模式</strong></td><td>对等网络</td><td>星型结构</td></tr><tr><td><strong>设计理念</strong></td><td>黑盒协作，保持独立</td><td>透明访问，扩展能力</td></tr><tr><td><strong>典型场景</strong></td><td>多智能体任务分解与委派</td><td>单智能体工具调用与数据获取</td></tr><tr><td><strong>发起方</strong></td><td>Google</td><td>Anthropic</td></tr></tbody></table>
<h2 data-id="heading-12">5 如何使用A2A协议</h2>
<h3 data-id="heading-13">5.1 开发与集成方式</h3>
<p>对于希望集成A2A协议的开发者，Google提供了<strong>多语言SDK支持</strong>，目前包括Python、Go、JavaScript/TypeScript、Java和.NET五种编程语言。每种SDK都提供一致的API体验，确保跨平台兼容性。</p>
<p>实施A2A协议的基本步骤包括：</p>
<ol>
<li><strong>定义智能体能力</strong>：明确智能体的专长领域和能提供的服务。</li>
<li><strong>创建Agent Card</strong>：按照标准格式编写描述智能体能力的JSON文件。</li>
<li><strong>实现协议端点</strong>：根据A2A规范实现任务处理、状态查询等接口。</li>
<li><strong>部署发现机制</strong>：将Agent Card托管到标准路径或注册到目录服务。</li>
<li><strong>测试与验证</strong>：使用A2A Inspector等工具验证实现的合规性。</li>
</ol>
<h3 data-id="heading-14">5.2 实际应用示例</h3>
<p>考虑一个智能旅行规划场景，多个智能体通过A2A协议协作：</p>
<ol>
<li><strong>用户</strong>向<strong>旅行助手智能体</strong>提出需求：“帮我规划一个下周末的北京之旅”。</li>
<li><strong>旅行助手智能体</strong>（客户端角色）通过查询Agent Card，发现并调用几个专业智能体：
<ul>
<li><strong>天气查询智能体</strong>：获取北京下周的天气预报。</li>
<li><strong>航班查询智能体</strong>：查找可用航班和价格。</li>
<li><strong>酒店预订智能体</strong>：搜索符合预算的住宿选项。</li>
</ul>
</li>
<li>各专业智能体（远程智能体角色）并行处理子任务，并通过A2A协议返回结果。</li>
<li><strong>旅行助手智能体</strong>整合所有结果，生成完整的旅行方案给用户。</li>
</ol>
<p>在此过程中，每个智能体只需关注自己的专长领域，无需了解其他智能体的内部实现，真正实现了<strong>关注点分离</strong>和<strong>专业分工</strong>。</p>
<h2 data-id="heading-15">6 A2A协议的未來发展</h2>
<h3 data-id="heading-16">6.1 短期发展路线图</h3>
<p>A2A协议目前正处于快速发展阶段。根据官方路线图，近期（0.3版本）重点包括：</p>
<ul>
<li><strong>标准化路径更新</strong>：将Agent Card的托管路径从<code>/.well-known/agent.json</code>更新为<code>/.well-known/agent-card.json</code>。</li>
<li><strong>多语言SDK优化</strong>：提升各语言SDK的稳定性和一致性。</li>
<li><strong>治理架构升级</strong>：基于Linux基金会建立社区主导的开发治理结构。</li>
</ul>
<p>特别值得注意的是，A2A协议已<strong>正式捐赠给Linux基金会</strong>，这将极大促进其成为中立、开放的行业标准。未来3-6个月内，项目将建立标准化贡献流程，成立专门工作组，并建立透明的决策机制。</p>
<h3 data-id="heading-17">6.2 中长期发展方向</h3>
<p>展望未来，A2A协议的发展将围绕以下几个关键方向：</p>
<ul>
<li><strong>智能体注册表建设</strong>：建立统一的智能体发现机制，支持基于能力的智能体搜索和筛选。</li>
<li><strong>安全增强功能</strong>：引入签名Agent Card支持，强化身份认证与传输安全。</li>
<li><strong>企业级功能演进</strong>：完善对长运行操作、流式传输和推送通知等企业级需求的支持。</li>
<li><strong>验证工具生态</strong>：发展A2A Inspector等合规性检查工具，确保跨平台兼容性。</li>
</ul>
<p>随着更多智能体采用A2A标准，我们有望看到真正开放的智能体生态系统形成，让AI协作变得更加简单和强大。这种互操作性不仅降低开发成本，更将催生全新的智能体应用模式和市场机会。</p>
<h2 data-id="heading-18">7 总结</h2>
<p>A2A协议作为智能体通信领域的重要创新，通过标准化智能体间的交互方式，为<strong>打破AI孤岛</strong>提供了切实可行的解决方案。其基于现有Web标准的设计降低了实施门槛，而企业级的安全和治理特性则确保了其在真实环境中的可行性。</p>
<p>随着AI技术的普及和深入，单一智能体难以应对复杂多变的现实需求将成为常态。A2A协议推动的<strong>多智能体协作模式</strong>，正是未来AI应用架构的重要演进方向。无论是与MCP协议的互补结合，还是其本身的持续演进，A2A都将在构建开放、互联的智能体生态系统中发挥关键作用。</p>
<p>对于开发者和企业而言，理解并采纳A2A协议意味着提前布局下一代AI应用架构，在即将到来的智能体协作浪潮中占据先机。随着协议的不断成熟和生态的壮大，A2A有望成为AI世界的“TCP/IP协议”，为分布式人工智能奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Chain & Pipe 知识点详解]]></title>    <link>https://juejin.cn/post/7578853751531405327</link>    <guid>https://juejin.cn/post/7578853751531405327</guid>    <pubDate>2025-12-02T09:19:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531405327" data-draft-id="7578892205291159592" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain Chain &amp; Pipe 知识点详解"/> <meta itemprop="keywords" content="LangChain,Node.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-02T09:19:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain Chain &amp; Pipe 知识点详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:19:21.000Z" title="Tue Dec 02 2025 09:19:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 本文将带你深入理解 LangChain 中的 Chain 和 Pipe 机制，通过实际代码示例掌握串行、并行、流式输出等核心技能。</p>
</blockquote>
<h2 data-id="heading-0">📚 核心概念</h2>
<h3 data-id="heading-1">什么是 Runnable？</h3>
<p><code>Runnable</code> 是 LangChain 中的核心接口，所有可执行的组件都实现了这个接口：</p>
<ul>
<li><strong>Prompt Template</strong> - 提示词模板</li>
<li><strong>LLM / ChatModel</strong> - 语言模型</li>
<li><strong>Output Parser</strong> - 输出解析器</li>
<li><strong>Chain</strong> - 链（本身也是 Runnable）</li>
</ul>
<p>每个 Runnable 都支持以下方法：</p>

























<table><thead><tr><th>方法</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><code>invoke()</code></td><td>同步执行</td><td>普通调用</td></tr><tr><td><code>stream()</code></td><td>流式执行</td><td>实时输出</td></tr><tr><td><code>batch()</code></td><td>批量执行</td><td>处理多个输入</td></tr></tbody></table>
<h3 data-id="heading-2">什么是 Pipe？</h3>
<p><code>pipe()</code> 是连接多个 Runnable 的方法，将前一个组件的输出作为后一个组件的输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基本用法</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(outputParser);

<span class="hljs-comment">// 等价于</span>
<span class="hljs-comment">// input → prompt → llm → outputParser → output</span>
</code></pre>
<h3 data-id="heading-3">Pipe 可接收的参数类型</h3>
<p><code>pipe()</code> 方法可以接收任何 <strong>Runnable</strong> 类型的对象，包括：</p>








































<table><thead><tr><th>类型</th><th>说明</th><th>常见示例</th></tr></thead><tbody><tr><td><strong>Prompt Templates</strong></td><td>提示词模板</td><td><code>ChatPromptTemplate</code>, <code>PromptTemplate</code></td></tr><tr><td><strong>LLMs / ChatModels</strong></td><td>语言模型</td><td><code>ChatDeepSeek</code>, <code>ChatOpenAI</code>, <code>ChatAnthropic</code></td></tr><tr><td><strong>Output Parsers</strong></td><td>输出解析器</td><td><code>StringOutputParser</code>, <code>JsonOutputParser</code>, <code>StructuredOutputParser</code></td></tr><tr><td><strong>Runnable 组合器</strong></td><td>组合多个 Runnable</td><td><code>RunnableSequence</code>, <code>RunnableParallel</code>, <code>RunnablePassthrough</code>, <code>RunnableLambda</code></td></tr><tr><td><strong>函数 (Function)</strong></td><td>自动包装为 RunnableLambda</td><td>普通函数、箭头函数、async 函数</td></tr><tr><td><strong>其他 Runnable</strong></td><td>任何实现 Runnable 接口的对象</td><td>Tools, Retrievers, 自定义 Runnable</td></tr></tbody></table>
<h4 data-id="heading-4">示例：不同类型参数的使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableLambda</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 1. 最常见：Prompt → LLM → OutputParser</span>
<span class="hljs-keyword">const</span> basicChain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 2. 使用函数（自动包装为 RunnableLambda）</span>
<span class="hljs-keyword">const</span> chainWithFunction = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// 普通函数</span>

<span class="hljs-comment">// 3. 使用 async 函数</span>
<span class="hljs-keyword">const</span> chainWithAsync = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">async</span> (text) =&gt; {
    <span class="hljs-comment">// 可以在这里做异步操作</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`处理后: <span class="hljs-subst">${text}</span>`</span>;
  });

<span class="hljs-comment">// 4. 使用 RunnableLambda 显式包装</span>
<span class="hljs-keyword">const</span> customRunnable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableLambda</span>({
  <span class="hljs-attr">func</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> <span class="hljs-string">`[<span class="hljs-subst">${input}</span>]`</span>,
});
<span class="hljs-keyword">const</span> chainWithLambda = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(customRunnable);

<span class="hljs-comment">// 5. 嵌套使用其他 Chain</span>
<span class="hljs-keyword">const</span> innerChain = prompt2.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> outerChain = prompt1
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(innerChain);

<span class="hljs-comment">// 6. 使用 RunnableParallel 进行分支</span>
<span class="hljs-keyword">const</span> branchChain = prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
      <span class="hljs-attr">upper</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toUpperCase</span>(),
      <span class="hljs-attr">lower</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">toLowerCase</span>(),
      <span class="hljs-attr">length</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-property">length</span>,
    })
  );
</code></pre>
<h4 data-id="heading-5">类型匹配规则</h4>
<blockquote>
<p>⚠️ <strong>重要</strong>：<code>pipe()</code> 连接时，<strong>前一个 Runnable 的输出类型必须与后一个 Runnable 的输入类型兼容</strong>。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确：LLM 输出 AIMessage → StringOutputParser 接收 AIMessage</span>
prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// ✅ 正确：StringOutputParser 输出 string → 函数接收 string</span>
prompt
  .<span class="hljs-title function_">pipe</span>(llm)
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>())
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> text.<span class="hljs-title function_">trim</span>());

<span class="hljs-comment">// ❌ 错误：LLM 输出 AIMessage → 函数期望 string</span>
<span class="hljs-comment">// prompt.pipe(llm).pipe((msg) =&gt; msg.trim()); // msg 是 AIMessage 对象，不是 string</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">🔧 示例详解</h2>
<h3 data-id="heading-7">示例 1：Pipe 的基本使用</h3>
<p>最基础的 Chain 组合：Prompt → LLM → OutputParser</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/prompts"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StringOutputParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/output_parsers"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"dotenv/config"</span>;

<span class="hljs-comment">// 初始化 LLM</span>
<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"deepseek-chat"</span>,
  <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
});

<span class="hljs-comment">// 创建 Prompt</span>
<span class="hljs-keyword">const</span> translatePrompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [
    <span class="hljs-string">"system"</span>,
    <span class="hljs-string">"你是一个专业的翻译助手，请将 {source_lang} 翻译成 {target_lang}。"</span>,
  ],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>],
]);

<span class="hljs-comment">// 使用 pipe() 组合成 Chain</span>
<span class="hljs-keyword">const</span> translateChain = translatePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 调用 Chain</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> translateChain.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">source_lang</span>: <span class="hljs-string">"English"</span>,
  <span class="hljs-attr">target_lang</span>: <span class="hljs-string">"中文"</span>,
  <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello, LangChain!"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// 你好，LangChain！</span>
</code></pre>
<p><strong>要点解析：</strong></p>
<ul>
<li><code>ChatPromptTemplate.fromMessages()</code> 创建聊天提示词模板</li>
<li><code>pipe()</code> 将组件串联起来</li>
<li><code>StringOutputParser</code> 将 AI 返回的消息对象转换为纯字符串</li>
<li><code>invoke()</code> 传入模板变量，执行整个链</li>
</ul>
<hr/>
<h3 data-id="heading-8">示例 2：Stream 流式输出</h3>
<p>流式输出可以实时显示 AI 生成的内容，提升用户体验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> storyPrompt = <span class="hljs-title class_">ChatPromptTemplate</span>.<span class="hljs-title function_">fromMessages</span>([
  [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个创意写作助手"</span>],
  [<span class="hljs-string">"human"</span>, <span class="hljs-string">"请写一个关于 {topic} 的小故事"</span>],
]);

<span class="hljs-keyword">const</span> storyChain = storyPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 使用 stream() 获取流式输出</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> storyChain.<span class="hljs-title function_">stream</span>({
  <span class="hljs-attr">topic</span>: <span class="hljs-string">"程序员与 AI"</span>,
});

<span class="hljs-comment">// 实时打印每个 chunk</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
}
</code></pre>
<p><strong>流式输出的优势：</strong></p>
<ul>
<li>✅ 用户无需等待完整响应</li>
<li>✅ 实时看到生成过程</li>
<li>✅ 适合生成长文本</li>
<li>✅ 改善交互体验</li>
</ul>
<hr/>
<h3 data-id="heading-9">示例 3：串行任务 (RunnableSequence)</h3>
<p>当任务有依赖关系时，使用串行执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableSequence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 步骤 1: 生成标题</span>
<span class="hljs-keyword">const</span> titleChain = titlePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 步骤 2: 根据标题生成内容</span>
<span class="hljs-keyword">const</span> contentChain = contentPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 串行组合</span>
<span class="hljs-keyword">const</span> sequentialChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-comment">// 第一步：生成标题</span>
  {
    <span class="hljs-attr">title</span>: titleChain,
    <span class="hljs-attr">topic</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">topic</span>,
  },
  <span class="hljs-comment">// 第二步：生成内容（依赖标题）</span>
  {
    <span class="hljs-attr">title</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">title</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
      <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> ({ <span class="hljs-attr">title</span>: input.<span class="hljs-property">title</span> }),
      contentChain,
    ]),
  },
]);

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> sequentialChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">"AI 学习"</span> });
<span class="hljs-comment">// result = { title: "...", content: "..." }</span>
</code></pre>
<p><strong>串行任务特点：</strong></p>
<ul>
<li>📌 任务按顺序执行</li>
<li>📌 后续任务可以使用前置任务的结果</li>
<li>📌 适合有依赖关系的多步骤流程</li>
</ul>
<hr/>
<h3 data-id="heading-10">示例 4：并行任务 (RunnableParallel)</h3>
<p>当多个任务互不依赖时，使用并行执行提升效率：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableParallel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-comment">// 定义三个独立的分析任务</span>
<span class="hljs-keyword">const</span> sentimentChain = sentimentPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> keywordsChain = keywordsPrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> languageChain = languagePrompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());

<span class="hljs-comment">// 并行组合</span>
<span class="hljs-keyword">const</span> parallelChain = <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">sentiment</span>: sentimentChain,
  <span class="hljs-attr">keywords</span>: keywordsChain,
  <span class="hljs-attr">language</span>: languageChain,
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> parallelChain.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">text</span>: <span class="hljs-string">"待分析的文本"</span> });
<span class="hljs-comment">// result = { sentiment: "积极", keywords: "...", language: "中文" }</span>
</code></pre>
<p><strong>并行任务优势：</strong></p>
<ul>
<li>⚡ 显著减少总执行时间</li>
<li>⚡ 充分利用 API 并发能力</li>
<li>⚡ 适合多维度分析场景</li>
</ul>
<hr/>
<h3 data-id="heading-11">示例 5：RunnablePassthrough 数据透传</h3>
<p>在复杂链中保留原始输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnablePassthrough</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/runnables"</span>;

<span class="hljs-keyword">const</span> translateWithOriginal = <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">original</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnablePassthrough</span>(), <span class="hljs-comment">// 原样传递</span>
  <span class="hljs-attr">translated</span>: translateChain,
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> translateWithOriginal.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">text</span>: <span class="hljs-string">"Hello"</span> });
<span class="hljs-comment">// result = { original: { text: "Hello" }, translated: "你好" }</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">示例 6：串行 + 并行混合</h3>
<p>实际项目中常需要组合使用：</p>
<pre><code class="hljs language-scss" lang="scss">输入 → 预处理(串行) → 多维分析(并行) → 汇总报告(串行) → 输出
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> complexChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
  <span class="hljs-comment">// 步骤 1: 预处理</span>
  {
    <span class="hljs-attr">original</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">text</span>,
    <span class="hljs-attr">processed</span>: preprocessChain,
  },
  <span class="hljs-comment">// 步骤 2: 并行分析</span>
  {
    <span class="hljs-attr">original</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">original</span>,
    <span class="hljs-attr">analysis</span>: <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
      <span class="hljs-attr">sentiment</span>: sentimentChain,
      <span class="hljs-attr">keywords</span>: keywordsChain,
    }),
  },
  <span class="hljs-comment">// 步骤 3: 汇总</span>
  summaryChain,
]);
</code></pre>
<hr/>
<h2 data-id="heading-13">📊 核心对象速查表</h2>








































<table><thead><tr><th>对象</th><th>作用</th><th>常用方法</th></tr></thead><tbody><tr><td><code>ChatPromptTemplate</code></td><td>创建聊天提示词模板</td><td><code>fromMessages()</code></td></tr><tr><td><code>StringOutputParser</code></td><td>将输出转为字符串</td><td>直接 <code>pipe()</code></td></tr><tr><td><code>JsonOutputParser</code></td><td>将输出解析为 JSON</td><td>直接 <code>pipe()</code></td></tr><tr><td><code>RunnableSequence</code></td><td>串行执行</td><td><code>from([...])</code></td></tr><tr><td><code>RunnableParallel</code></td><td>并行执行</td><td><code>from({...})</code></td></tr><tr><td><code>RunnablePassthrough</code></td><td>数据透传</td><td><code>new RunnablePassthrough()</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">🎨 流程图解</h2>
<h3 data-id="heading-15">基础 Pipe 流程</h3>
<pre><code class="hljs language-css" lang="css">┌─────────┐    ┌─────────┐    ┌──────────────┐    ┌─────────┐
│  <span class="hljs-selector-tag">Input</span>  │ → │ Prompt  │ → │     LLM      │ → │ Parser  │ → Output
└─────────┘    └─────────┘    └──────────────┘    └─────────┘
</code></pre>
<h3 data-id="heading-16">串行任务流程</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  Input  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>  │ → │ <span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>  │ → Output
└─────────┘    └─────────┘    └─────────┘    └─────────┘
</code></pre>
<h3 data-id="heading-17">并行任务流程</h3>
<pre><code class="hljs language-arduino" lang="arduino">                 ┌─────────┐
              ┌→ │ <span class="hljs-built_in">Task</span> A  │ ─┐
┌─────────┐   │  └─────────┘  │   ┌──────────────┐
│  Input  │ ──┼→ ┌─────────┐  ├→ │ Merge Result │ → Output
└─────────┘   │  │ <span class="hljs-built_in">Task</span> B  │  │   └──────────────┘
              │  └─────────┘  │
              └→ ┌─────────┐ ─┘
                 │ <span class="hljs-built_in">Task</span> C  │
                 └─────────┘
</code></pre>
<hr/>
<h2 data-id="heading-18">💡 最佳实践</h2>
<h3 data-id="heading-19">1. 合理选择执行方式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：无依赖任务串行执行，浪费时间</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">await</span> chain1.<span class="hljs-title function_">invoke</span>(input);
<span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> chain2.<span class="hljs-title function_">invoke</span>(input);
<span class="hljs-keyword">const</span> result3 = <span class="hljs-keyword">await</span> chain3.<span class="hljs-title function_">invoke</span>(input);

<span class="hljs-comment">// ✅ 正确：无依赖任务并行执行</span>
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">RunnableParallel</span>.<span class="hljs-title function_">from</span>({
  <span class="hljs-attr">r1</span>: chain1,
  <span class="hljs-attr">r2</span>: chain2,
  <span class="hljs-attr">r3</span>: chain3,
}).<span class="hljs-title function_">invoke</span>(input);
</code></pre>
<h3 data-id="heading-20">2. 使用流式输出提升体验</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 用户需要等待完整响应</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(input);

<span class="hljs-comment">// ✅ 实时显示生成内容</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">stream</span>(input);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(chunk);
}
</code></pre>
<h3 data-id="heading-21">3. 使用 OutputParser 简化处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 手动提取内容</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(prompt);
<span class="hljs-keyword">const</span> text = response.<span class="hljs-property">content</span>;

<span class="hljs-comment">// ✅ 使用 Parser 自动处理</span>
<span class="hljs-keyword">const</span> chain = prompt.<span class="hljs-title function_">pipe</span>(llm).<span class="hljs-title function_">pipe</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringOutputParser</span>());
<span class="hljs-keyword">const</span> text = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">invoke</span>(input);
</code></pre>
<hr/>
<h2 data-id="heading-22">🔗 相关资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2F" target="_blank" title="https://js.langchain.com/" ref="nofollow noopener noreferrer">LangChain JS 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a></li>
<li><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae_solo 官网</a></li>
<li><a href="#" title="#">本项目 GitHub 地址</a></li>
</ul>
<hr/>
<h2 data-id="heading-23">📝 练习建议</h2>
<ol>
<li><strong>基础练习</strong>：修改翻译 Chain，支持多种语言互译</li>
<li><strong>进阶练习</strong>：创建一个并行分析 Chain，同时分析文本的情感、主题、风格</li>
<li><strong>综合练习</strong>：实现一个"文章改写助手"，包含：分析原文 → 并行生成多个改写版本 → 评选最佳版本</li>
</ol>
<hr/>
<h2 data-id="heading-24">🎯 总结</h2>





























<table><thead><tr><th>知识点</th><th>核心要点</th></tr></thead><tbody><tr><td><strong>pipe()</strong></td><td>连接 Runnable 组件，构建处理管道</td></tr><tr><td><strong>stream()</strong></td><td>流式输出，提升用户体验</td></tr><tr><td><strong>RunnableSequence</strong></td><td>串行执行，处理有依赖的任务</td></tr><tr><td><strong>RunnableParallel</strong></td><td>并行执行，提升处理效率</td></tr><tr><td><strong>RunnablePassthrough</strong></td><td>数据透传，保留原始输入</td></tr></tbody></table>
<p>掌握这些核心概念后，你就可以灵活组合构建复杂的 AI 应用流程了！</p>
<hr/>
<blockquote>
<p>📖 <strong>本文配套代码</strong>：<code>langchain-learning/src/chain.js</code></p>
<p>💻 <strong>推荐工具</strong>：使用 <a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae_solo</a> 获得更好的 AI 开发体验</p>
<p>✨ <strong>Happy Coding!</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南]]></title>    <link>https://juejin.cn/post/7578968420042440767</link>    <guid>https://juejin.cn/post/7578968420042440767</guid>    <pubDate>2025-12-02T08:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578968420042440767" data-draft-id="7578818741699788806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-02T08:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七条猫"/> <meta itemprop="url" content="https://juejin.cn/user/564503296630944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 赋能大模型工程化实践：从模型选型到安全部署的一站式实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/564503296630944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七条猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:35:37.000Z" title="Tue Dec 02 2025 08:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型（Large Language Model, LLM）工程化浪潮席卷开发社区的今天，如何高效、安全、可靠地完成模型集成、微调与部署，已成为开发者面临的核心挑战。TRAE SOLO 正式版的上线，恰如一场及时雨——它不仅提供了强大的 Vibe Coding 能力，更构建了一套面向大模型全生命周期的工程化支持体系。本文将结合笔者在实际项目中的深度使用经验，分享 TRAE SOLO 在大模型工程化关键环节中的实战应用，涵盖模型选型、一键部署、代码兼容性修复及 API 安全配置四大核心场景。</p>
<hr/>
<h3 data-id="heading-0">一、智能模型选型：基于 TRAE SOLO 快速匹配业务需求</h3>
<p>面对 Hugging Face 上数以万计的开源模型，开发者常陷入“选择困难症”。TRAE SOLO 的上下文感知能力可自动推荐适配方案。例如，在金融问答场景中，我输入自然语言指令：</p>
<blockquote>
<p>“加载一个支持中文、上下文长度 ≥8192、可在 16GB GPU 上运行的聊天模型。”</p>
</blockquote>
<p>TRAE SOLO 自动生成如下加载代码（基于 Qwen1.5-7B-Chat-GGUF）：</p>
<hr/>
<pre><code class="hljs language-ini" lang="ini">from transformers import AutoModelForCausalLM, AutoTokenizer
import torch

<span class="hljs-attr">model_name</span> = <span class="hljs-string">"Qwen/Qwen1.5-7B-Chat-GGUF"</span>
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(model_name, trust_remote_code=<span class="hljs-literal">True</span>)
<span class="hljs-attr">model</span> = AutoModelForCausalLM.from_pretrained(
    model_name,
    <span class="hljs-attr">device_map</span>=<span class="hljs-string">"auto"</span>,
    <span class="hljs-attr">torch_dtype</span>=torch.float16,
    <span class="hljs-attr">revision</span>=<span class="hljs-string">"q4_k_m"</span>  <span class="hljs-comment"># 自动推荐量化版本</span>
)
</code></pre>
<p>更关键的是，TRAE SOLO 在侧边栏同步展示了该模型在本地 A10G 上的实测指标：</p>
<ul>
<li>显存占用：12.3 GB</li>
<li>首 token 延迟：320ms</li>
<li>吞吐量：18 tokens/s</li>
</ul>
<p>这让我在 5 分钟内完成模型验证，避免了反复试错的成本。</p>
<hr/>
<h3 data-id="heading-1">二、一键部署：内置服务模块让模型秒变 API</h3>
<p>传统部署需手动编写服务框架，而 TRAE SOLO 的 Deploy Module 可自动生成生产级服务。以下是由 TRAE SOLO 生成的 FastAPI 服务示例（经 DiffView 微调后）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app.py - 由 TRAE SOLO 自动生成并优化</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline

app = FastAPI(title=<span class="hljs-string">"Qwen Chat API"</span>, version=<span class="hljs-string">"1.0"</span>)

<span class="hljs-comment"># 模型懒加载（避免启动阻塞）</span>
_chat_pipeline = <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pipeline</span>():
    <span class="hljs-keyword">global</span> _chat_pipeline
    <span class="hljs-keyword">if</span> _chat_pipeline <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _chat_pipeline = pipeline(
            <span class="hljs-string">"conversational"</span>,
            model=<span class="hljs-string">"Qwen/Qwen1.5-7B-Chat-GGUF"</span>,
            tokenizer=<span class="hljs-string">"Qwen/Qwen1.5-7B-Chat"</span>,
            device_map=<span class="hljs-string">"auto"</span>
        )
    <span class="hljs-keyword">return</span> _chat_pipeline

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    messages: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>]  <span class="hljs-comment"># e.g., [{"role": "user", "content": "你好"}]</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/v1/chat/completions"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">req: ChatRequest</span>):
    pipe = get_pipeline()
    response = pipe(req.messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"reply"</span>: response[-<span class="hljs-number">1</span>][<span class="hljs-string">"content"</span>]}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">health</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>}
</code></pre>
<p>执行 <code>trae deploy --port 8080</code> 后，TRAE SOLO 自动：</p>
<ul>
<li>构建包含上述代码与依赖的 Docker 镜像；</li>
<li>启动容器并映射端口；</li>
<li>输出 Swagger UI 地址（<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fdocs%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="http://localhost:8080/docs%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/docs）。</a></li>
</ul>
<p>整个过程无需手写 Dockerfile 或处理 CUDA 环境，真正实现“一键上线”。</p>
<hr/>
<h3 data-id="heading-2">三、DiffView 工具：高效修复大模型生成代码的兼容性问题</h3>
<p>在集成 LangChain 时，TRAE SOLO 初始生成的 RAG 代码使用了已弃用的 <code>VectorStoreRetriever</code>。DiffView 工具高亮对比并建议更新：</p>
<p><strong>Before（TRAE 初稿）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">retriever</span> = VectorstoreRetriever(vectorstore=vector_db, search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
</code></pre>
<p><strong>After（DiffView 建议）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">retriever</span> = vector_db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
</code></pre>
<p>点击“Apply”后，TRAE SOLO 不仅替换代码，还自动添加类型注解和错误处理：</p>
<p>代码语言：python</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    retriever = vector_db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">4</span>})
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    logger.error(<span class="hljs-string">f"Vector store not initialized: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">raise</span>
</code></pre>
<p>这种语义级修复能力，极大提升了生成代码在复杂工程中的可用性。</p>
<hr/>
<h3 data-id="heading-3">四、API 密钥安全踩坑：从硬编码到 Vault 集成</h3>
<p>早期我曾将 OpenAI 密钥硬编码，导致 GitHub 泄露。TRAE SOLO 的 Security Guard 拦截后，推荐使用环境变量 + Secret Manager 双重防护，并生成如下安全加载逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># secure_config.py</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()  <span class="hljs-comment"># 加载 .env 文件</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_openai_key</span>() -&gt; <span class="hljs-built_in">str</span>:
    key = os.getenv(<span class="hljs-string">"OPENAI_API_KEY"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key:
        <span class="hljs-comment"># 尝试从 AWS Secrets Manager 获取（生产环境）</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">import</span> boto3
            client = boto3.client(<span class="hljs-string">'secretsmanager'</span>, region_name=<span class="hljs-string">'us-west-2'</span>)
            secret = client.get_secret_value(SecretId=<span class="hljs-string">'prod/openai-key'</span>)
            <span class="hljs-keyword">return</span> secret[<span class="hljs-string">'SecretString'</span>]
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"OpenAI API key not found in env or secrets manager"</span>) <span class="hljs-keyword">from</span> e
    <span class="hljs-keyword">return</span> key
</code></pre>
<p>同时，TRAE SOLO 在 <code>.gitignore</code> 中自动添加 <code>.env</code>，并在 pre-commit hook 中集成 <code>gitleaks</code> 扫描，形成纵深防御。</p>
<hr/>
<h3 data-id="heading-4">结语：TRAE SOLO，不止是编码助手，更是大模型工程化的加速器</h3>
<p>从智能选型到安全部署，TRAE SOLO 以代码为载体，将大模型工程的最佳实践“编织”进开发流程。它不是替代开发者思考，而是把我们从重复劳动中解放，聚焦于更高价值的创新。</p>
<p>正如我在项目复盘会上所说：“以前我们花 70% 时间在搭架子，现在 TRAE SOLO 让我们把 70% 时间留给思考。” 如果你也在大模型工程化的路上摸爬滚打，不妨试试 TRAE SOLO —— 它或许就是你缺失的那一块拼图。</p>
<p><strong>用代码说话，用干货圈粉。TRAE SOLO，让大模型真正“跑”起来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南③：LocalStorage 用法全解析]]></title>    <link>https://juejin.cn/post/7578877638988759040</link>    <guid>https://juejin.cn/post/7578877638988759040</guid>    <pubDate>2025-12-02T09:06:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578877638988759040" data-draft-id="7576482238461198378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南③：LocalStorage 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T09:06:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南③：LocalStorage 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:06:16.000Z" title="Tue Dec 02 2025 09:06:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇介绍了<strong>BroadcastChannel</strong>跨页面通讯的方式。今天介绍一种我们非常熟悉的方式<strong>LocalStorage</strong> 。凭浏览器原生接口就能实现数据共享，用法简洁高效。需要注意，仅支持<strong>同源页面</strong>。</p>
<p>下面我们介绍下LocalStorage 的跨页通讯的用法。</p>
<h2 data-id="heading-1">1. LocalStorage为什么能跨页通讯？</h2>
<p>我们都知道LocalStorage——它是浏览器提供的<strong>同源本地存储方案</strong>，数据存储在客户端，生命周期为永久（除非手动删除或清除浏览器缓存）。</p>
<p>它能实现跨页通讯的关键，在于两个核心机制：</p>
<h3 data-id="heading-2">1.1 同源数据共享机制</h3>
<p>LocalStorage 的数据严格遵循“同源策略”，即同一协议（http/https）、同一域名、同一端口下的所有页面，都能读取和修改同一个 LocalStorage 实例中的数据。</p>
<h3 data-id="heading-3">1.2 storage 事件触发机制</h3>
<p>LocalStorage 实现“通讯”而非单纯“数据存储”的核心。当一个页面修改了 LocalStorage 中的数据时，浏览器会自动向同源下的所有其他页面触发一个 <code>storage</code> 事件，该事件会携带修改前、修改后的数据及键名等信息。其他页面通过监听这个事件，就能实时感知数据变化，从而完成跨页通讯。</p>
<p>注意：当前页面修改 LocalStorage 时，自身不会触发 storage 事件，只有同源的其他页面才会收到通知！</p>
<h3 data-id="heading-4">1.3 LocalStorage通讯流程</h3>
<p>LocalStorage 跨页通讯的核心流程是：</p>
<ol>
<li>页面A修改 LocalStorage 数据 → 浏览器向同源其他页面发送 storage 事件</li>
<li>页面B/C/D 监听事件并获取数据变化。</li>
</ol>
<h2 data-id="heading-5">2. 实践案例</h2>
<p>通过上面的说明，作为数据发送方，通过修改 LocalStorage 存储数据；作为接收方，监听 storage 事件获取父页面传递的信息。我们实践一下：</p>
<h3 data-id="heading-6">2.1 步骤1：数据发送</h3>
<p>通过 <code>localStorage.setItem()</code> 存储数据，触发 storage 事件。为避免数据覆盖，建议给键名添加场景标识（如 <code>parent-to-iframe-msg</code>）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 发送数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToIframe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 1. 存储数据到 LocalStorage，键名需唯一标识通讯场景</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'parent-to-iframe-msg'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 防止数据缓存导致事件不触发</span>
    <span class="hljs-attr">content</span>: data
  }));
  
  <span class="hljs-comment">// 2. 可选：若需重复发送相同数据，可先删除再添加（storage 事件仅在值变化时触发）</span>
  <span class="hljs-comment">// localStorage.removeItem('parent-to-iframe-msg');</span>
}

<span class="hljs-comment">// 调用方法发送数据（示例：传递用户信息）</span>
<span class="hljs-title function_">sendToIframe</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'前端小助手'</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span>
});
</code></pre>
<h3 data-id="heading-7">2.2 步骤2：数据接收</h3>
<p>接收方页面通过监听 <code>window.addEventListener('storage', callback)</code> 捕获数据变化，解析后获取页面传递的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听父页面发送的数据</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 仅处理目标键名的数据变化，避免无关事件干扰</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> !== <span class="hljs-string">'parent-to-iframe-msg'</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 2. 解析数据（注意：初始状态下 e.newValue 可能为 null）</span>
  <span class="hljs-keyword">if</span> (!e.<span class="hljs-property">newValue</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> { timestamp, content } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">newValue</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'iframe 收到父页面数据：'</span>, content);
  
  <span class="hljs-comment">// 3. 业务处理：如渲染用户信息</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-info'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">`用户名：<span class="hljs-subst">${content.username}</span>，角色：<span class="hljs-subst">${content.role}</span>`</span>;
});

<span class="hljs-comment">// 可选：页面销毁时移除监听，避免内存泄漏</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorage);
});
</code></pre>
<p>接收数据如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0160e05f2e2e45498b719ee165aaf211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765271175&amp;x-signature=fTBp2QqtDH91VOC72BJXO0MycmU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">3. LocalStorage通讯注意事项</h2>
<p>LocalStorage 用法简单，但在跨页通讯中若忽略细节，很容易出现“数据发了但收不到”的问题。以下这些坑必须提前规避：</p>
<h3 data-id="heading-9">3.1 同源策略限制：跨域页面无法通讯</h3>
<p>LocalStorage 严格遵循同源策略，不同域名、协议或端口的页面无法共享数据，也无法触发 storage 事件。若需跨域通讯，需结合 postMessage 或服务器中转，LocalStorage 无法单独实现。</p>
<h3 data-id="heading-10">3.2 数据格式限制：仅支持字符串类型</h3>
<p>LocalStorage 只能存储字符串，若要传递对象、数组等复杂数据，必须用 <code>JSON.stringify()</code> 序列化，接收时用 <code>JSON.parse()</code> 反序列化。注意：undefined、function 等类型无法被正常序列化，需提前处理。</p>
<h3 data-id="heading-11">3.3 storage 事件触发条件：仅值变化时触发</h3>
<p>只有当 LocalStorage 中数据的“值”发生变化时，才会触发 storage 事件。若两次存储相同的值，事件不会触发。解决办法：在数据中添加 timestamp 时间戳或随机数，确保每次存储的值不同。</p>
<h3 data-id="heading-12">3.4 存储容量限制：避免数据过大</h3>
<p>LocalStorage 单个域名的存储容量约为 5MB，若存储数据过大，会导致存储失败。跨页通讯应仅传递必要的核心数据（如 ID、状态），避免传递大量文本或二进制数据。</p>
<h2 data-id="heading-13">4. 总结</h2>
<p>最后总结一下：LocalStorage只需要操作 <code>setItem</code>、<code>getItem</code> 和 监听 <strong>storage</strong> 事件就能实现同源通讯。如果是非同源，那就只能用其他方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目级效能提升一站式交付最佳实践]]></title>    <link>https://juejin.cn/post/7578876665696157705</link>    <guid>https://juejin.cn/post/7578876665696157705</guid>    <pubDate>2025-12-02T09:38:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578876665696157705" data-draft-id="7578948893761962011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目级效能提升一站式交付最佳实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:38:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目级效能提升一站式交付最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:38:18.000Z" title="Tue Dec 02 2025 09:38:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>面对研发交付中Feature级项目复杂度攀升、信息分散及跨端协作低效等痛点，传统的Story级管理模式已显乏力。本文详细阐述了一套“项目级效能提升一站式交付最佳实践”，通过构建三大核心体系重塑研发流程：一是通过AI侧边栏与风险管控打造“AI项目管理”，实现信息聚合与决策提效；二是推动“一站式Feature交付”，利用AI自动生成测试方案与搭建环境，实现端到端闭环；三是建立涵盖“重点战役-Feature-Story”的三级数字化度量体系。这套新范式旨在以智能替代人工低效环节，助力团队从“被流程束缚”向“借智能破局”转变，实现研发效能的质的飞跃。</p>
<h2 data-id="heading-1">01 背景</h2>
<p>在研发交付场景中，Story级别效率持续向好，但端到端 Feature 级项目持续增多，复杂度呈上升趋势。在传统工作模式下，研发团队正遭遇一系列制约效能的痛点：</p>
<ul>
<li>
<p><strong>信息分散、Feature视角管控缺失</strong>：研发过程中，需求卡片、Bug列表、测试用例等信息分散于不同空间；以及历史交付流程侧重 story 侧，缺少完整需求视角交付的风险洞察，导致项目无预警延期，管理成本趋增。</p>
</li>
<li>
<p><strong>多方协作效率低下</strong>：联调测试依赖手动触发脚本，环境配置依赖人工协调；多模块联动存在用例交叉冗余、测试评审缓慢；跨产品线借调沟通成本高，各端测试人力重复投入且耦合重，拖慢研发节奏，项目进度风险激增 。</p>
</li>
<li>
<p><strong><strong>Feature 级数字化能力缺失</strong></strong>：既缺乏能够精准衡量 Feature 价值与进展的指标度量体系，也缺乏用于支撑分析、优化的标准化数据积累流程，导致 Feature 相关的评估无据可依，数据资产难以沉淀，进一步制约效能提升与问题根因定位。</p>
</li>
</ul>
<p>为有效破解以上痛点，提升产研团队整体效能，我们构建项目级交付新范式：通过 “ <strong><strong>AI 项目管理</strong></strong>” 打造一站式项目信息与工具服务获取新入口，实现过程风险AI精准管控；通过 “<strong><strong>一站式 Feature 交付</strong></strong>” 推动单端联调模式向端到端交付模式转变，同时借助 AI 测试提效驱动交付效能跃升；通过 “<strong><strong>项目级效能数字化度量</strong></strong>” 构建完善的效能评估体系。</p>
<ul>
<li>
<p><strong>AI项目管理</strong>：借助群聊侧边栏打造一站式项目信息看板，提升风险感知与决策效率；支持产研团队一键获取所需工具、服务，提升工具使用与协同效率；依托AIQA构建全流程管控能力并提效。</p>
</li>
<li>
<p><strong>一站式Feature交付</strong>：通过建设端到端交付能力，释放冗余人力，并将测试方案生成、基础环境搭建等场景与AIQA深度融合，为 Feature 全生命周期提供高效、智能的一站式支撑。</p>
</li>
<li>
<p><strong>项目级效能数字化度量</strong>：构建涵盖重点战役、Feature、Story 三个层级的更全面、立体的洞察体系，借助数据驱动的力量，全方位、深层次评估分析产品开发过程的效能表现与最终成果，为业务决策提供坚实有力数据支撑。</p>
</li>
</ul>
<p>以智能替代人工低效环节，推动团队从 “被流程束缚” 向 “借智能破局” 转变，为效能提升注入新动能，引领团队协作进入智能化新范式，让每一次交付都更高效、更可控！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d882abad826841818899413d60344318~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=Fod323CesQF42OOld0l8i3C5kK4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">02 AI项目管理</h2>
<h3 data-id="heading-3"><strong>2.1 项目管理痛点</strong></h3>
<p>在研发交付体系中，<strong><strong>Feature级项目</strong></strong>持续<strong><strong>增多</strong></strong>，复杂度呈上升趋势，团队项目管理普遍面临四大核心痛点：</p>
<ul>
<li>
<p>信息碎片化带来高昂的把控成本</p>
</li>
<li>
<p>跨角色协作过程产生的高额隐性成本</p>
</li>
<li>
<p>分散工具链造成执行效率损耗</p>
</li>
<li>
<p>项目交付进展、风险纯依赖人工通知确认，交付周期长尾</p>
</li>
</ul>
<p>为破解上述痛点，我们构建融合 “侧边栏 + AIQA过程管控” 的 AI 项目管理体系，实现信息整合、协作提效、工具聚合与交付管控闭环。</p>
<h3 data-id="heading-4"><strong>2.2 侧边栏应用</strong></h3>
<p><strong><strong>侧边栏统一解决方案，<strong><strong>通过配置</strong></strong>侧边栏</strong></strong>框架，<strong><strong>灵活定制卡片</strong></strong>，以满足业务线各类场景应用，通常涵盖<strong><strong>项目概览</strong></strong>、<strong><strong>项目详情</strong></strong>、<strong><strong>工具集合</strong></strong>三大核心模块。</p>
<ul>
<li>
<p><strong><strong>项目概览模块</strong></strong>：以 PMO 视角为核心，深度整合项目进度、资源占用、风险预警等维度数据，支撑 PMO 实现精准的项目群管控与决策穿透 。</p>
</li>
<li>
<p><strong><strong>项目详情模块</strong></strong>：聚焦产研团队执行视角，整合项目关联卡片、各类文档、bug 记录、上线记录、实验记录及测试环境等信息，保障研发高效协同与质量可控。</p>
</li>
<li>
<p><strong><strong>工具集合模块</strong></strong>：提供了项目管理、联调提效等工具，可根据角色、产品线、项目，提供不同的工具入口，推动研发端到端衔接与操作链路简化。</p>
</li>
</ul>
<p>通过具象化的配置实践，可在实际业务场景中落地，助力各角色高效协作，破解产研团队项目管理痛点 。以下实践案例，包括：<strong><strong>项目概览</strong></strong>、<strong><strong>项目详情</strong></strong>、<strong><strong>工具集三大类内容</strong></strong>，且支持PC和手机端样式，以及群吊顶和侧边栏位置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5a580481ab6481c9d8b6dc95a814a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=nRrt%2BRXHNrtV56PKjEmEnj2dUZw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5"><strong>2.3 过程管控</strong></h3>
<p>在项目各环节，AIQA以PMO数字助手的角色，建设基于AIQA的项目进度/风险提醒能力，通过输入框形式进行交互，全流程管控并提效。具体能力包括：AB实验长时间停留、AB实验放量实时、技术方案&amp;打点方案等未评审风险等</p>
<ul>
<li>
<p>项目评审风险提醒：支持技术方案、UI、实验方案、打点方案等提醒</p>
</li>
<li>
<p>AB实验：待启动实验、实验中、评估中等9个阶段的停留时长；单台、放量、灰度等7个阶段的放量提醒</p>
</li>
<li>
<p>项目进度风险提醒</p>
</li>
</ul>
<h2 data-id="heading-6">03 一站式Feature交付</h2>
<h3 data-id="heading-7"><strong>3.1 端到端交付</strong></h3>
<p>产研需求常常是包括客户端、前端、服务端，两端以上联动的需求占比较高（&gt;40%），各端分别投入人力测试，测试耦合严重，人力重复投入严重，通过<strong><strong>建设交付能力</strong></strong>，支撑实现需求测试从「单端测试+多端联调」交付模式，转为「<strong><strong>端到端」交付模式，释放冗余人力</strong></strong>。</p>
<p>例如客户端&amp;服务端联动的需求，通过从功能角度评估客户端case对服务端case覆盖，覆盖的部分由客户端QA端到端测试，未覆盖部分通过夯实自动化能力补充测试或调起服务端QA补充测试，并通过准入/准出能力评估影响面和测试完备度，保证项目质量，释放冗余人力，提升整体测试吞吐。</p>
<p>各阶段支撑能力建设有：</p>
<ul>
<li>
<p><strong><strong>测试前</strong></strong>：通过<strong><strong>端到端模式识别</strong></strong>判断需求是否可以进行端到端的交付，动态<strong><strong>自动分配测试人力，<strong><strong>基于需求生成</strong></strong>端到端测试用例，<strong><strong>前端&amp;服务端的</strong></strong>环境自动搭建/更新</strong></strong>，创建相应的mock环境等</p>
</li>
<li>
<p><strong><strong>测试中</strong></strong>：<strong><strong>基于代码提交进行风险洞察，<strong><strong>以及提供</strong></strong>问题定位、mock 能力</strong></strong>供前端/客户端的同学更顺畅的完成测试过程，并且在过程中对测试流量进行录制，实时采集覆盖率，供后续测试评估；并在测试过程中阶段性评估测试进度风险，及时发现&amp;通报过程中风险；</p>
</li>
<li>
<p><strong><strong>测试准出</strong></strong>：测试完成后，自动触发服务端的<strong><strong>异常测试</strong></strong>、<strong><strong>自动生成后续用于回归的自动化case</strong></strong>，以保障服务端的迭代质量，整体完成后根据手工case完成率、bug闭环率、手工测试覆盖率、异常测试结果等多个维度综合进行测试<strong><strong>准出评估</strong></strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a416fd1e7894e7fb8370135de563828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=UySobLjN0DiXjR%2BK3iF6ZTr%2B%2Fjw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>3.2 AI测试提效</strong></h3>
<h4 data-id="heading-9">3.2.1 测试方案自动生成</h4>
<p>我们探索测试方案自动生成，目前可以通过分析MRD/PRD/CR，结合历史业务&amp;工具知识经验，自动生成完整的测试方案，包括：</p>
<ul>
<li>
<p>对需求的基本洞察理解（背景概述、分系统/模块升级点）</p>
</li>
<li>
<p>联调测试范围（涉及系统/模块等）作为环境推荐能力的输入</p>
</li>
<li>
<p>联调测试用例及可驱动AI测试执行的相关场景参数</p>
</li>
<li>
<p>测试经验&amp;风险、历史相似项目参考</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af14e4051bf646c99f9dd9ce73f60f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=1%2F5sHnor49xkvfy8ZXNT6xYpDSI%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-10">3.2.2 测试环境LUI搭建</h4>
<p>建设LUI交互端到端环境部署能力，支持产研团队各业务线及图搜联调场景调用，端到端环境部署时长保持在小时级</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be20a4cf50b43d890bfc1e363591792~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=JsefkTcJIyh8hacUe7LZTKsGfy4%3D" alt="图片" loading="lazy"/></p>
<p>功能点：</p>
<ul>
<li>
<p>聚合用户的部署意图，支持多种prompt，完成LUI环境部署诉求：支持Feature卡片、QA单模块产物、单story卡片、联调CR、Fcnap域名等多种部署意图，聚合部署变更的信息</p>
</li>
<li>
<p>提供丰富的prompt向量库维护，实现精准的意图识别：prompt维护</p>
</li>
<li>
<p>基于qs-bot openmanus和mcp框架，实现丰富的工具集，通过动态规划调度工具交付各场景下的端到端测试环境：需求变更信息处理，数据聚合；触发多路复用环境部署；kirin异步轮询部署状态；qsbot回调重新触发动态规划；环境前后端链接与配置管理</p>
</li>
<li>
<p>聚合部署任务中的工具使用历史，异步回调完成环境部署完成后的智卡推送：聚合单次LUI中动态规划的工具返回信息；完成智卡数据构造并发卡推送给用户</p>
</li>
</ul>
<h2 data-id="heading-11">04 项目级效能数字化度量</h2>
<p>针对 Story 维度的度量工作，主要聚焦于对研发测试阶段展开持续且深入的洞察，旨在为从事研发测试工作的人员提供切实可行的优化方向与手段。但story维度的度量也存在如下问题：</p>
<ul>
<li>
<p>Story 粒度本身存在一定局限性，呈现研发-测试阶段的效率洞察，向左延伸的需求设计阶段，向右延伸的上线实验转全阶段，都不涵括在内，无法代表整体情况；</p>
</li>
<li>
<p>随着产品复杂程度日益提高，传统以 Story 维度为主的度量方式，无法站在产品需求视角观测交付效率，已难以满足需求；</p>
</li>
<li>
<p>站在每个组织的重点战役角度，story度量的方式，无法看到战役视角的资源投入和效率瓶颈，无法提供深层次的分析和决策。</p>
</li>
</ul>
<p>为此我们开始建设贯穿重点战役-》feature-》Story的统一三级视角的数字化方案：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7801c3d209554ae3891558bd5321211f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=oAsNjQNUsn5lF2gDrcSxGgzO4fc%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>4.1 Feature级数字化</strong></h3>
<p>围绕从最初的发布规划、设计构思、开发实施、测试验证、正式上线，直至后续的小流量到逐步推全的整个生命周期，实施全方位、系统性的评估与监测，确保 Feature 的每个阶段都能得到有效把控与持续优化。最终实现更加高效地管理和优化产品开发流程，以及进一步提升团队协作效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac2b06137885487f802c61f0d51c9e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=l%2BKWOcE7kgwj%2BrN5QfRb1ctUvz8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>4.2 战役级数字化</strong></h3>
<p>重点战役是企业为实现特定战略目标而发起的关键行动，往往需要通过一系列具体的Feature来实现其目标。</p>
<p>协同机制：重点战役的范围在季度初由PMO圈定，在业务拆解功能时在Feature上打上标记，数字化定期采集和处理分析，支持业务进行重点战役的进度监控和项目复盘。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c1b6e8517bb406c9b00010e3b3e3f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273098&amp;x-signature=TP03rzRCQZNwc8gw7Wn4L%2FFEn88%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-14">05 总结与展望</h2>
<p>立足项目级一站式交付实践，AI 原生思维在研发领域的价值将向更深、更广维度延伸：</p>
<ul>
<li>
<p>从能力深化看，AI 将实现从 “被动响应需求” 到 “主动预测需求” 的升级，通过持续学习团队协作数据、项目交付规律，可提前预判研发各阶段的核心需求，预警潜在风险，让智能服务更具前瞻性</p>
</li>
<li>
<p>从场景拓展看，AI 与高频协作场景的融合将突破群聊边界，向需求评审、代码联调、线上问题排查等全研发链路渗透，构建 “全场景覆盖、全流程智能” 的研发协同体系，让智能能力随研发动作自然触发</p>
</li>
<li>
<p>从生态构建看，基于侧边栏的 AI 驱动协作模式，可进一步打通跨团队、跨业务线的数据与工具壁垒，形成可复用、可迭代的研发效能提升方案，推动 AI 原生思维从单一团队实践，升级为业务级研发协同标准</p>
</li>
</ul>
<p>最终，AI 将不再仅是 “提效工具”，更将成为研发团队创新的 “核心引擎”，通过持续解放人工低效环节，让团队聚焦于技术攻坚、产品创新等核心工作，推动研发领域从 “效能提升” 向 “价值创造” 跨越，开启智能化研发的全新阶段。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线]]></title>    <link>https://juejin.cn/post/7578832575504793642</link>    <guid>https://juejin.cn/post/7578832575504793642</guid>    <pubDate>2025-12-02T09:21:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578832575504793642" data-draft-id="7578889811333316649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:21:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            专业的 IPA 处理工具 构建可维护、可回滚的 iOS 成品加工与加固流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:21:40.000Z" title="Tue Dec 02 2025 09:21:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大型移动团队或多项目外包团队中，处理 IPA 已经不再只是“打包上传”这么简单。真正成熟的开发体系往往在接触 IPA 时需要：</p>
<ul>
<li>对成品包进行符号检查</li>
<li>混淆 Swift/ObjC</li>
<li>扰动资源文件</li>
<li>修改 JSON/JS/H5 结构</li>
<li>修补隐私合规字段</li>
<li>重签名、安装、测试</li>
<li>验证逆向对抗能力</li>
<li>存档映射表供崩溃符号化</li>
<li>适配多个版本/渠道包/白标包</li>
</ul>
<hr/>
<h2 data-id="heading-0">一、什么叫“专业的 IPA 处理工具体系”？</h2>
<p>它应该具备以下特征：</p>
<h3 data-id="heading-1">支持没有源码的 IPA</h3>
<h3 data-id="heading-2">支持 Swift / ObjC / Flutter / RN / H5 混合应用</h3>
<h3 data-id="heading-3">能检查、混淆、修改、签名、验证</h3>
<h3 data-id="heading-4">能加入 CI/CD 流水线自动化</h3>
<h3 data-id="heading-5">能为每次混淆产生可追踪的映射表</h3>
<h3 data-id="heading-6">能兼容渠道包、白标定制包</h3>
<h3 data-id="heading-7">能集成安全团队所需的逆向检测能力</h3>
<p>这不是一个工具能完成的，而是多个工具协同的“体系工程”。</p>
<hr/>
<h2 data-id="heading-8">二、IPA 处理从哪里开始？（静态分析与结构识别）</h2>
<p>对 IPA 的所有操作都从<strong>静态分析</strong>开始。</p>
<hr/>
<h2 data-id="heading-9"><strong>① MobSF —— 结构级扫描工具</strong></h2>
<p>MobSF 能在一分钟内给出：</p>
<ul>
<li>内部资源结构（JS/H5/JSON/图片）</li>
<li>全局配置（Info.plist、URL Scheme）</li>
<li>使用的第三方 SDK</li>
<li>字符串、敏感接口收集</li>
<li>权限分析</li>
</ul>
<p>这相当于 IPA 的“体检报告”。</p>
<hr/>
<h2 data-id="heading-10"><strong>② class-dump / swift-dump —— 符号暴露评估</strong></h2>
<pre><code class="hljs language-lua" lang="lua">class-<span class="hljs-built_in">dump</span> app.ipa &gt; <span class="hljs-built_in">dump</span>.txt
</code></pre>
<p>能看到：</p>
<ul>
<li>Swift 类名（非常可读）</li>
<li>ObjC 方法名（语义明显）</li>
<li>属性、选择器、模块结构</li>
</ul>
<p>这是攻击者最常用的武器，因此必须作为混淆的输入。</p>
<hr/>
<h2 data-id="heading-11">三、IPA 成品混淆工具：构建可控的符号与资源保护层</h2>
<p>许多团队拿不到源码（外包、SDK、渠道包），因此工程混淆（Swift Shield / obfuscator-llvm）无法使用。</p>
<p>此时必须使用专业的“成品级 IPA 混淆工具”。</p>
<hr/>
<h2 data-id="heading-12"><strong>Ipa Guard CLI —— 专业 IPA 处理的核心工具</strong></h2>
<p>Ipa Guard 的定位不是简单“加壳”，而是针对 IPA 进行深度处理：</p>
<h3 data-id="heading-13"><strong>符号混淆能力</strong></h3>
<ul>
<li>Swift 类/方法/变量名混淆</li>
<li>ObjC selector 混淆</li>
<li>Flutter/RN Bridge 名称处理</li>
<li>黑白名单机制，避免破坏反射/SDK</li>
</ul>
<h3 data-id="heading-14"><strong>资源处理能力</strong></h3>
<ul>
<li>重命名图片、json、plist、JS、H5</li>
<li>修改资源 MD5（避免替换攻击）</li>
<li>JS 文件混淆（可选）</li>
<li>资源路径扰动</li>
</ul>
<h3 data-id="heading-15"><strong>命令行能力（可自动化）</strong></h3>
<pre><code class="hljs language-css" lang="css">ipaguard_cli parse app<span class="hljs-selector-class">.ipa</span> -o sym<span class="hljs-selector-class">.json</span>
ipaguard_cli protect app<span class="hljs-selector-class">.ipa</span> -c sym<span class="hljs-selector-class">.json</span> <span class="hljs-attr">--email</span> dev<span class="hljs-keyword">@team</span>.com --image --js -o out.ipa
</code></pre>
<h3 data-id="heading-16"><strong>可治理能力</strong></h3>
<ul>
<li>输出映射表</li>
<li>可回滚</li>
<li>可符号化</li>
<li>可审计</li>
</ul>
<p>这些能力使得 Ipa Guard 成为“专业 IPA 处理流水线”的核心组件。</p>
<hr/>
<h2 data-id="heading-17">四、IPA 混淆完整流程：专业团队使用的步骤</h2>
<hr/>
<h2 data-id="heading-18"><strong>① Step 1：导出符号文件（sym.json）</strong></h2>
<pre><code class="hljs">ipaguard_cli parse app.ipa -o sym.json
</code></pre>
<p>文件里包含：</p>
<ul>
<li>可混淆符号</li>
<li>不可混淆的风险提示</li>
<li>字符串引用信息</li>
<li>文件引用关系</li>
<li>Swift/ObjC 类型标记</li>
</ul>
<p>工程团队可以据此编辑策略。</p>
<hr/>
<h2 data-id="heading-19"><strong>② Step 2：编辑并合并混淆策略</strong></h2>
<p>必须排除：</p>
<ul>
<li>动态调用 selector</li>
<li>Storyboard id</li>
<li>MethodChannel（Flutter）</li>
<li>JSBridge 方法（H5、RN）</li>
<li>第三方 SDK 初始化过程</li>
</ul>
<p>必须混淆：</p>
<ul>
<li>内部逻辑</li>
<li>Swift 工具类</li>
<li>算法模块</li>
<li>网络处理</li>
<li>私有类与变量</li>
</ul>
<p>形成最终 <code>sym.json</code>。</p>
<hr/>
<h2 data-id="heading-20"><strong>③ Step 3：执行混淆并生成处理后 IPA</strong></h2>
<pre><code class="hljs language-css" lang="css">ipaguard_cli protect app<span class="hljs-selector-class">.ipa</span> \
  -c sym<span class="hljs-selector-class">.json</span> \
  <span class="hljs-attr">--image</span> \
  <span class="hljs-attr">--js</span> \
  <span class="hljs-attr">--email</span> dev<span class="hljs-keyword">@team</span>.com \
  -o protected.ipa
</code></pre>
<p>得到：</p>
<ul>
<li>混淆后的 IPA</li>
<li>资源改名后的结构</li>
<li>新 MD5 资源</li>
<li>映射表 meta.json</li>
</ul>
<hr/>
<h2 data-id="heading-21">五、专业的 IPA 处理中不能缺少：重签名与真机验证</h2>
<p>混淆后的 IPA 必须重新签名才能安装。</p>
<hr/>
<h2 data-id="heading-22"><strong>kxsign —— 强大的跨平台签名工具</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino">kxsign sign <span class="hljs-keyword">protected</span>.ipa \
  -c cert.p12 -p pwd \
  -m dev.mobileprovision \
  -z <span class="hljs-type">signed</span>.ipa -i
</code></pre>
<p>测试内容包括：</p>
<ul>
<li>UI 是否正常</li>
<li>API 调用是否正常</li>
<li>JS/H5 是否不报错</li>
<li>Flutter/RN 是否正常渲染</li>
<li>登录、支付 SDK 是否可正常运行</li>
</ul>
<p>验证混淆策略是否正确。</p>
<hr/>
<h2 data-id="heading-23">六、逆向对抗验证：混淆是否“有效”由攻击者视角决定</h2>
<hr/>
<h2 data-id="heading-24"><strong>① Hopper / IDA 反编译验证</strong></h2>
<p>检查：</p>
<p>Swift 类是否已乱码
方法名是否不可解读
代码结构是否不易推断</p>
<hr/>
<h2 data-id="heading-25"><strong>② Frida 动态 Hook 测试</strong></h2>
<pre><code class="hljs language-css" lang="css">frida -U -f com<span class="hljs-selector-class">.app</span> <span class="hljs-attr">--no-pause</span> -l hook<span class="hljs-selector-class">.js</span>
</code></pre>
<p>如果：</p>
<ul>
<li>难以定位方法名</li>
<li>Hook 入口不明显</li>
<li>类名不可识别</li>
</ul>
<p>则混淆效果真正达标。</p>
<hr/>
<h2 data-id="heading-26">七、专业团队必做的：符号治理与映射表存档</h2>
<p>IPA 混淆之所以能进入“工程体系”，核心在于治理：</p>
<ul>
<li>sym.json</li>
<li>混淆映射表</li>
<li>构建号</li>
<li>签名指纹</li>
</ul>
<p>必须存放在：</p>
<ul>
<li>KMS</li>
<li>Git 加密仓库</li>
<li>内网 S3</li>
</ul>
<p>用于：</p>
<ul>
<li>崩溃符号化</li>
<li>上线审计</li>
<li>问题追踪</li>
<li>策略回滚</li>
</ul>
<hr/>
<h2 data-id="heading-27">IPA 处理需要一整套工具链协作，并非单工具即可完成</h2>
<p>最终推荐工具组合：</p>
<h3 data-id="heading-28"><strong>分析层</strong></h3>
<p>MobSF、class-dump</p>
<h3 data-id="heading-29"><strong>处理核心层</strong></h3>
<p>Ipa Guard CLI</p>
<ul>
<li>IPA 层符号混淆</li>
<li>资源扰动</li>
<li>JS/H5 保护</li>
<li>资源 MD5 修改</li>
</ul>
<h3 data-id="heading-30"><strong>验证层</strong></h3>
<p>kxsign、 Hopper、 Frida</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题]]></title>    <link>https://juejin.cn/post/7578922565210210331</link>    <guid>https://juejin.cn/post/7578922565210210331</guid>    <pubDate>2025-12-02T09:36:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210210331" data-draft-id="7578836326475317275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:36:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决微服务系统中跨服务的超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:04.000Z" title="Tue Dec 02 2025 09:36:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于你提供的 <code>sendAckMessage</code> 核心方法，我为你整理了 <strong>完整可运行的代码示例</strong>，覆盖「订单创建 + 库存扣减」电商场景的全链路，包括数据库设计、订单服务、库存服务、跨服务调用、MQ配置、补偿逻辑，直接复制即可落地。</p>
<h2 data-id="heading-0">一、整体架构说明</h2>
<ul>
<li><strong>技术栈</strong>：Spring Boot + Spring Cloud Stream + RabbitMQ + MyBatis-Plus + Feign（跨服务调用）</li>
<li><strong>核心流程</strong>：订单服务本地事务（创建订单+存消息）→ MQ跨服务推送 → 库存服务消费消息（扣减库存+幂等校验）→ 跨服务更新订单状态/消息状态</li>
<li><strong>解决问题</strong>：超卖、库存锁定不释放、消息丢失、重复扣减库存等核心问题</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、第一步：数据库设计（订单库 + 库存库）</h2>
<h3 data-id="heading-2">1. 订单服务数据库（含LocalMessage表 + 订单表）</h3>
<pre><code class="hljs language-typescript" lang="typescript">-- <span class="hljs-number">1.</span> 本地消息表（你已有实体，补全表结构）
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">`local_message`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">AUTO_INCREMENT</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'主键ID'</span>,
  <span class="hljs-string">`local_message_id`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息唯一标识（UUID）'</span>,
  <span class="hljs-string">`queue`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'MQ绑定名（如stock-deduct-binding）'</span>,
  <span class="hljs-string">`topic`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'主题（预留）'</span>,
  <span class="hljs-string">`routing_key`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'路由键（预留）'</span>,
  <span class="hljs-string">`message_body`</span> text <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息体（JSON格式）'</span>,
  <span class="hljs-string">`retry_times`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'已重试次数'</span>,
  <span class="hljs-string">`max_retry_times`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'3'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'最大重试次数'</span>,
  <span class="hljs-string">`deleted`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'删除标识（0-未删，1-已删）'</span>,
  <span class="hljs-string">`state`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消息状态：0-READY，1-SEND，2-FAIL'</span>,
  <span class="hljs-string">`consume_state`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'消费状态：0-未消费，1-已消费'</span>,
  <span class="hljs-string">`create_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'创建时间（时间戳）'</span>,
  <span class="hljs-string">`modify_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'修改时间（时间戳）'</span>,
  <span class="hljs-string">`next_send_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'下次发送时间（时间戳）'</span>,
  <span class="hljs-string">`delay_seconds`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'0'</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'延迟秒数'</span>,
  <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-variable constant_">UNIQUE</span> <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`uk_local_message_id`</span> (<span class="hljs-string">`local_message_id`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'防重复消息'</span>,
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_state_next_send_time`</span> (<span class="hljs-string">`state`</span>,<span class="hljs-string">`next_send_time`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'定时重试查询索引'</span>
) <span class="hljs-variable constant_">ENGINE</span>=<span class="hljs-title class_">InnoDB</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CHARSET</span>=utf8mb4 <span class="hljs-variable constant_">COMMENT</span>=<span class="hljs-string">'本地消息表（分布式事务用）'</span>;

-- <span class="hljs-number">2.</span> 订单表
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-string">`t_order`</span> (
  <span class="hljs-string">`id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">AUTO_INCREMENT</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单ID'</span>,
  <span class="hljs-string">`order_no`</span> <span class="hljs-title function_">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单编号（UUID）'</span>,
  <span class="hljs-string">`user_id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'用户ID'</span>,
  <span class="hljs-string">`product_id`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'商品ID'</span>,
  <span class="hljs-string">`quantity`</span> int <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'购买数量'</span>,
  <span class="hljs-string">`status`</span> tinyint <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'订单状态：1-待扣库存，2-已扣库存待支付，3-已取消，4-已支付'</span>,
  <span class="hljs-string">`create_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'创建时间（时间戳）'</span>,
  <span class="hljs-string">`update_time`</span> <span class="hljs-built_in">bigint</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'更新时间（时间戳）'</span>,
  <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (<span class="hljs-string">`id`</span>),
  <span class="hljs-variable constant_">UNIQUE</span> <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`uk_order_no`</span> (<span class="hljs-string">`order_no`</span>),
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_user_id`</span> (<span class="hljs-string">`user_id`</span>),
  <span class="hljs-variable constant_">KEY</span> <span class="hljs-string">`idx_product_id_status`</span> (<span class="hljs-string">`product_id`</span>,<span class="hljs-string">`status`</span>) <span class="hljs-variable constant_">COMMENT</span> <span class="hljs-string">'库存扣减后查询订单索引'</span>
) <span class="hljs-variable constant_">ENGINE</span>=<span class="hljs-title class_">InnoDB</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-variable constant_">CHARSET</span>=utf8mb4 <span class="hljs-variable constant_">COMMENT</span>=<span class="hljs-string">'订单表'</span>;
</code></pre>
<h3 data-id="heading-3">2. 库存服务数据库（库存表）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_stock` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'库存ID'</span>,
  `product_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `stock_num` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'库存数量'</span>,
  `lock_num` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'锁定数量（预留，可选）'</span>,
  `create_time` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建时间（时间戳）'</span>,
  `update_time` <span class="hljs-type">bigint</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'更新时间（时间戳）'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_product_id` (`product_id`) COMMENT <span class="hljs-string">'商品ID唯一，避免重复库存'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'库存表'</span>;

<span class="hljs-comment">-- 初始化测试数据：商品ID=1001，库存=100</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `t_stock` (`product_id`, `stock_num`, `create_time`) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1001</span>, <span class="hljs-number">100</span>, UNIX_TIMESTAMP()<span class="hljs-operator">*</span><span class="hljs-number">1000</span>);
</code></pre>
<hr/>
<h2 data-id="heading-4">三、第二步：公共依赖与工具类（订单/库存服务共用）</h2>
<h3 data-id="heading-5">1. 实体类（DTO/VO）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 库存扣减消息DTO（订单服务发送 → 库存服务接收）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockDeductDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String messageId; <span class="hljs-comment">// 消息唯一标识（和local_message_id一致）</span>
    <span class="hljs-keyword">private</span> Long orderId;     <span class="hljs-comment">// 订单ID</span>
    <span class="hljs-keyword">private</span> Long productId;   <span class="hljs-comment">// 商品ID</span>
    <span class="hljs-keyword">private</span> Integer quantity; <span class="hljs-comment">// 扣减数量</span>
}

<span class="hljs-comment">// 2. 订单状态更新DTO（库存服务 → 订单服务）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatusUpdateDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> Long orderId;     <span class="hljs-comment">// 订单ID</span>
    <span class="hljs-keyword">private</span> Integer status;   <span class="hljs-comment">// 目标状态（2-已扣库存待支付，3-已取消）</span>
}

<span class="hljs-comment">// 3. 本地消息查询/更新VO（Feign跨服务调用用）</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMessageVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String localMessageId; <span class="hljs-comment">// 消息ID</span>
    <span class="hljs-keyword">private</span> Integer consumeState;  <span class="hljs-comment">// 消费状态（0-未消费，1-已消费）</span>
}

<span class="hljs-comment">// 4. 业务异常类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
}
</code></pre>
<h3 data-id="heading-6">2. 枚举类（订单服务）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 本地消息状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">LocalMessageStatusEnum</span> {
    <span class="hljs-built_in">READY</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"待发送"</span>),
    <span class="hljs-built_in">SEND</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"已发送"</span>),
    <span class="hljs-built_in">FAIL</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"发送失败"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> desc;

    <span class="hljs-built_in">LocalMessageStatusEnum</span>(<span class="hljs-type">int</span> status, <span class="hljs-type">String</span> desc) {
        <span class="hljs-keyword">this</span>.status = status;
        <span class="hljs-keyword">this</span>.desc = desc;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }
}

<span class="hljs-comment">// 订单状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatusEnum</span> {
    <span class="hljs-built_in">WAIT_DEDUCT</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"待扣库存"</span>),
    <span class="hljs-built_in">DEDUCTED_WAIT_PAY</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"已扣库存待支付"</span>),
    <span class="hljs-built_in">CANCELLED</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"已取消"</span>),
    <span class="hljs-built_in">PAID</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"已支付"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> desc;

    <span class="hljs-built_in">OrderStatusEnum</span>(<span class="hljs-type">int</span> status, <span class="hljs-type">String</span> desc) {
        <span class="hljs-keyword">this</span>.status = status;
        <span class="hljs-keyword">this</span>.desc = desc;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-7">四、第三步：订单服务完整代码</h2>
<h3 data-id="heading-8">1. 核心依赖（pom.xml）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot核心 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Cloud Stream + RabbitMQ --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- MyBatis-Plus --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Feign（跨服务调用） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 工具类 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">2. 配置文件（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span> <span class="hljs-comment"># 服务名</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/order_db?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;allowPublicKeyRetrieval=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-comment"># RabbitMQ绑定配置</span>
      <span class="hljs-attr">rabbit:</span>
        <span class="hljs-attr">bindings:</span>
          <span class="hljs-comment"># 生产者绑定（和sendAckMessage的bindingName一致）</span>
          <span class="hljs-attr">stock-deduct-binding:</span>
            <span class="hljs-attr">producer:</span>
              <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">CORRELATED</span> <span class="hljs-comment"># 开启发布确认（确保消息投递到MQ）</span>
              <span class="hljs-attr">routing-key-expression:</span> <span class="hljs-string">"'stock.deduct.routing'"</span> <span class="hljs-comment"># 路由键</span>
              <span class="hljs-attr">exchange-type:</span> <span class="hljs-string">direct</span> <span class="hljs-comment"># 交换机类型</span>
      <span class="hljs-comment"># 绑定关系配置</span>
      <span class="hljs-attr">bindings:</span>
        <span class="hljs-attr">stock-deduct-binding:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">stock.exchange</span> <span class="hljs-comment"># 交换机名（库存服务需一致）</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit</span> <span class="hljs-comment"># 使用RabbitMQ作为绑定器</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment"># 开启发布确认（和stream配置呼应）</span>
    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启消息返回（处理未路由消息）</span>

<span class="hljs-comment"># MyBatis-Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.order.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 下划线转驼峰</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span> <span class="hljs-comment"># 打印SQL日志</span>

<span class="hljs-comment"># 服务端口</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
</code></pre>
<h3 data-id="heading-10">3. 实体类（Entity）</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">// <span class="hljs-number">1</span>. LocalMessage实体（对应数据库表）
@Data
@TableName(<span class="hljs-string">"local_message"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LocalMessage <span class="hljs-keyword">implements</span> Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    @TableId(type = IdType.<span class="hljs-keyword">AUTO</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> localMessageId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> queue;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> topic;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> routingKey;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> messageBody;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> retryTimes;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> maxRetryTimes;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> deleted;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> state;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> consumeState;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> createTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> modifyTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> nextSendTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> delaySeconds;
}

// <span class="hljs-number">2</span>. 订单实体
@Data
@TableName(<span class="hljs-string">"t_order"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-keyword">Order</span> <span class="hljs-keyword">implements</span> Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;

    @TableId(type = IdType.<span class="hljs-keyword">AUTO</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> orderNo;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> userId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> productId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> status;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> createTime;
    <span class="hljs-keyword">private</span> <span class="hljs-type">Long</span> updateTime;
}
</code></pre>
<h3 data-id="heading-11">4. Mapper接口（MyBatis-Plus）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. LocalMessageMapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">LocalMessageMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">LocalMessage</span>&gt; {
    <span class="hljs-comment">// 查询未发送且未超时的消息（定时重试用）</span>
    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM local_message WHERE state = #{state} AND next_send_time &lt;= #{now} AND deleted = 0 AND retry_times &lt; max_retry_times"</span>)
    List&lt;LocalMessage&gt; <span class="hljs-built_in">selectUnsentMessages</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"state"</span>) Integer state, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 根据消息ID查询</span>
    <span class="hljs-variable">@Select</span>(<span class="hljs-string">"SELECT * FROM local_message WHERE local_message_id = #{localMessageId} AND deleted = 0"</span>)
    LocalMessage <span class="hljs-built_in">selectByLocalMessageId</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId);

    <span class="hljs-comment">// 更新消息状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET state = #{status}, retry_times = #{retryTimes}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateLocalMessageStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"status"</span>) Integer status, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"retryTimes"</span>) Integer retryTimes, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 更新消费状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET consume_state = #{consumeState}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);

    <span class="hljs-comment">// 更新重试次数和下次发送时间</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE local_message SET retry_times = #{newRetryTimes}, next_send_time = #{nextSendTime}, modify_time = #{now} WHERE local_message_id = #{localMessageId}"</span>)
    int <span class="hljs-built_in">updateRetryInfo</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"localMessageId"</span>) String localMessageId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"newRetryTimes"</span>) Integer newRetryTimes, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"nextSendTime"</span>) Long nextSendTime, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}

<span class="hljs-comment">// 2. OrderMapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">OrderMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">Order</span>&gt; {
    <span class="hljs-comment">// 根据订单ID更新状态</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE t_order SET status = #{status}, update_time = #{now} WHERE id = #{orderId}"</span>)
    int <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"status"</span>) Integer status, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}
</code></pre>
<h3 data-id="heading-12">5. 核心服务（Service）</h3>
<h4 data-id="heading-13">（1）你提供的sendAckMessage所在的LocalMessageService</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class LocalMessageService {

    <span class="hljs-keyword">@Autowired</span>
    private LocalMessageMapper localMessageMapper;
    <span class="hljs-keyword">@Autowired</span>
    private StreamBridge streamBridge;

    <span class="hljs-comment">// 你提供的核心方法（保持不变，补充依赖和工具类）</span>
    <span class="hljs-keyword">@Override</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public String sendAckMessage(String bindingName,
                                 String businessCode,
                                 Object data,
                                 int maxRetryTimes,
                                 long delaySeconds) {
        <span class="hljs-comment">// 生成消息体（这里简化实现，你可根据实际逻辑调整）</span>
        LocalMessagePayload localMessagePayload = <span class="hljs-built_in">genLocalMessagePayload</span>(businessCode, data);
        String messageId = localMessagePayload<span class="hljs-selector-class">.getMessageId</span>();
        String traceId = localMessagePayload<span class="hljs-selector-class">.getTraceId</span>();

        long now = System<span class="hljs-selector-class">.currentTimeMillis</span>();
        <span class="hljs-comment">// 构建本地消息实体</span>
        LocalMessage localMessage = new <span class="hljs-built_in">LocalMessage</span>();
        localMessage<span class="hljs-selector-class">.setLocalMessageId</span>(messageId);
        localMessage<span class="hljs-selector-class">.setQueue</span>(bindingName);
        localMessage<span class="hljs-selector-class">.setTopic</span>(null);
        localMessage<span class="hljs-selector-class">.setRoutingKey</span>(null);
        localMessage<span class="hljs-selector-class">.setMessageBody</span>(JSONUtil.toJsonStr(localMessagePayload)); <span class="hljs-comment">// 用hutool的JSON工具</span>
        localMessage<span class="hljs-selector-class">.setRetryTimes</span>(<span class="hljs-number">0</span>);
        localMessage<span class="hljs-selector-class">.setMaxRetryTimes</span>(maxRetryTimes);
        localMessage<span class="hljs-selector-class">.setDeleted</span>(<span class="hljs-number">0</span>);
        localMessage<span class="hljs-selector-class">.setState</span>(LocalMessageStatusEnum.READY.getStatus());
        localMessage<span class="hljs-selector-class">.setConsumeState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 未消费</span>
        localMessage<span class="hljs-selector-class">.setCreateTime</span>(now);
        localMessage<span class="hljs-selector-class">.setModifyTime</span>(null);
        localMessage<span class="hljs-selector-class">.setNextSendTime</span>(now + (delaySeconds * <span class="hljs-number">1000</span>));
        localMessage<span class="hljs-selector-class">.setDelaySeconds</span>((int) delaySeconds);
        <span class="hljs-comment">// 插入本地消息表（和订单创建在同一个事务）</span>
        localMessageMapper<span class="hljs-selector-class">.insert</span>(localMessage);

        <span class="hljs-comment">// 事务提交后发送MQ消息</span>
        TransactionSynchronizationManager<span class="hljs-selector-class">.registerSynchronization</span>(new TransactionSynchronization() {
            <span class="hljs-keyword">@Override</span>
            public void afterCommit() {
                try {
                    String msgId = localMessage<span class="hljs-selector-class">.getLocalMessageId</span>();
                    int retryTimes = localMessage<span class="hljs-selector-class">.getRetryTimes</span>();
                    int maxRetry = localMessage<span class="hljs-selector-class">.getMaxRetryTimes</span>();

                    <span class="hljs-comment">// 构建MQ消息</span>
                    CorrelationData correlationData = new <span class="hljs-built_in">CorrelationData</span>(msgId);
                    Message&lt;?&gt; message = MessageBuilder<span class="hljs-selector-class">.withPayload</span>(localMessage.getMessageBody())
                            <span class="hljs-selector-class">.setHeader</span>(AmqpHeaders.PUBLISH_CONFIRM_CORRELATION, correlationData)
                            <span class="hljs-selector-class">.setHeader</span>("traceId", traceId)
                            <span class="hljs-selector-class">.build</span>();

                    <span class="hljs-comment">// 发送消息（通过StreamBridge）</span>
                    streamBridge<span class="hljs-selector-class">.send</span>(bindingName, message);

                    <span class="hljs-comment">// MQ发布确认回调</span>
                    correlationData<span class="hljs-selector-class">.getFuture</span>()<span class="hljs-selector-class">.addCallback</span>(confirm -&gt; {
                        MDC.put("traceId", traceId);
                        log<span class="hljs-selector-class">.info</span>("[Local Message] 发送回调，messageId:{}, confirm:{}", msgId, JSONUtil.toJsonStr(confirm));

                        Integer status = null;
                        if (confirm.isAck()) {
                            <span class="hljs-comment">// MQ已接收，更新消息状态为SEND</span>
                            status = LocalMessageStatusEnum<span class="hljs-selector-class">.SEND</span><span class="hljs-selector-class">.getStatus</span>();
                        } else if (maxRetry &lt;= <span class="hljs-number">0</span>) {
                            <span class="hljs-comment">// 无重试次数，标记为失败</span>
                            status = LocalMessageStatusEnum<span class="hljs-selector-class">.FAIL</span><span class="hljs-selector-class">.getStatus</span>();
                            log<span class="hljs-selector-class">.warn</span>("[Local Message] 发送失败，无重试次数，messageId:{}", msgId);
                        } else {
                            <span class="hljs-comment">// 发送失败，保留READY状态，等待定时重试</span>
                            log<span class="hljs-selector-class">.warn</span>("[Local Message] 发送失败，等待定时重试，messageId:{}", msgId);
                        }

                        if (status != null) {
                            <span class="hljs-built_in">updateLocalMessageStatus</span>(msgId, status, retryTimes);
                        }
                        MDC<span class="hljs-selector-class">.remove</span>("traceId");
                    }, throwable -&gt; {
                        log<span class="hljs-selector-class">.error</span>("[Local Message] 发送回调异常，messageId:{}", msgId, throwable);
                    });
                } catch (Exception e) {
                    log<span class="hljs-selector-class">.error</span>("[Local Message] 发送消息异常，messageId:{}", localMessage.getLocalMessageId(), e);
                }
            }
        });

        return messageId;
    }

    <span class="hljs-comment">// 生成消息体（简化实现，你可根据实际需求扩展）</span>
    private LocalMessagePayload <span class="hljs-built_in">genLocalMessagePayload</span>(String businessCode, Object data) {
        LocalMessagePayload payload = new <span class="hljs-built_in">LocalMessagePayload</span>();
        payload<span class="hljs-selector-class">.setMessageId</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>());
        payload<span class="hljs-selector-class">.setTraceId</span>(MDC.get("traceId") == null ? UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>() : MDC.<span class="hljs-built_in">get</span>(<span class="hljs-string">"traceId"</span>));
        payload<span class="hljs-selector-class">.setBusinessCode</span>(businessCode);
        payload<span class="hljs-selector-class">.setData</span>(data);
        payload<span class="hljs-selector-class">.setCreateTime</span>(System.currentTimeMillis());
        return payload;
    }

    <span class="hljs-comment">// 更新消息状态（内部工具方法）</span>
    private void <span class="hljs-built_in">updateLocalMessageStatus</span>(String localMessageId, Integer status, Integer retryTimes) {
        try {
            localMessageMapper<span class="hljs-selector-class">.updateLocalMessageStatus</span>(localMessageId, status, retryTimes, System.currentTimeMillis());
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("[Local Message] 更新状态异常，messageId:{}, status:{}", localMessageId, status, e);
        }
    }

    <span class="hljs-comment">// 内部消息体封装类（你已有，补充完整）</span>
    <span class="hljs-keyword">@Data</span>
    public static class LocalMessagePayload implements Serializable {
        private static final long serialVersionUID = <span class="hljs-number">1</span>L;
        private String messageId;
        private String traceId;
        private String businessCode;
        private <span class="hljs-selector-tag">Object</span> data;
        private Long createTime;

        <span class="hljs-keyword">@Override</span>
        public String toString() {
            return JSONUtil<span class="hljs-selector-class">.toJsonStr</span>(this);
        }
    }
}
</code></pre>
<h4 data-id="heading-14">（2）订单核心服务（OrderService）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Slf</span>4j
public class OrderService {

    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    <span class="hljs-keyword">@Autowired</span>
    private LocalMessageService localMessageService;

    <span class="hljs-comment">/**
     * 核心方法：创建订单 + 发送库存扣减消息（跨服务分布式事务）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public String createOrder(Long userId, Long productId, Integer quantity) {
        <span class="hljs-comment">// 1. 参数校验</span>
        if (userId == null || productId == null || quantity &lt;= <span class="hljs-number">0</span>) {
            throw new <span class="hljs-built_in">BusinessException</span>("参数非法：userId、productId不能为空，quantity必须大于<span class="hljs-number">0</span>");
        }

        <span class="hljs-comment">// 2. 构建订单实体</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderNo</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setQuantity</span>(quantity);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>(OrderStatusEnum.WAIT_DEDUCT.getStatus()); <span class="hljs-comment">// 初始状态：待扣库存</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setCreateTime</span>(System.currentTimeMillis());

        <span class="hljs-comment">// 3. 插入订单表（和下面的存消息在同一个本地事务）</span>
        orderMapper<span class="hljs-selector-class">.insert</span>(order);
        log<span class="hljs-selector-class">.info</span>("订单创建成功，orderId:{}, orderNo:{}", order.getId(), <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>());

        <span class="hljs-comment">// 4. 构建库存扣减消息体</span>
        StockDeductDTO deductDTO = new <span class="hljs-built_in">StockDeductDTO</span>();
        deductDTO<span class="hljs-selector-class">.setMessageId</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>()); <span class="hljs-comment">// 和local_message_id一致</span>
        deductDTO<span class="hljs-selector-class">.setOrderId</span>(order.getId());
        deductDTO<span class="hljs-selector-class">.setProductId</span>(productId);
        deductDTO<span class="hljs-selector-class">.setQuantity</span>(quantity);

        <span class="hljs-comment">// 5. 调用你的sendAckMessage发送跨服务消息</span>
        localMessageService<span class="hljs-selector-class">.sendAckMessage</span>(
            "stock-deduct-binding", // MQ绑定名（和配置一致）
            "STOCK_DEDUCT",         // 业务标识
            deductDTO,              // 消息体
            <span class="hljs-number">3</span>,                      // 最大重试<span class="hljs-number">3</span>次
            <span class="hljs-number">0</span>                       // 延迟<span class="hljs-number">0</span>秒（立即发送）
        );

        return <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getOrderNo</span>();
    }

    <span class="hljs-comment">/**
     * 跨服务调用：更新订单状态（供库存服务调用）
     */</span>
    <span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
    public boolean updateOrderStatus(Long orderId, Integer status) {
        if (orderId == null || status == null) {
            throw new <span class="hljs-built_in">BusinessException</span>("参数非法：orderId、status不能为空");
        }
        int affectRows = orderMapper<span class="hljs-selector-class">.updateOrderStatus</span>(orderId, status, System.currentTimeMillis());
        log<span class="hljs-selector-class">.info</span>("更新订单状态，orderId:{}, status:{}, 影响行数:{}", orderId, status, affectRows);
        return affectRows &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-15">6. Feign接口（供库存服务跨服务调用）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 本地消息状态查询/更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>) <span class="hljs-comment">// 对应订单服务名</span>
public interface LocalMessageFeignClient {

    <span class="hljs-comment">// 查询消息状态</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/local-message/{messageId}"</span>)
    Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId);

    <span class="hljs-comment">// 更新消息消费状态</span>
    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/local-message/{messageId}/consume-state"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState);
}

<span class="hljs-comment">// 2. 订单状态更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface OrderFeignClient {

    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/order/{orderId}/status"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status);
}
</code></pre>
<h3 data-id="heading-16">7. 控制器（Controller）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
<span class="hljs-variable">@Slf4j</span>
public class OrderController {

    <span class="hljs-variable">@Autowired</span>
    private OrderService orderService;

    <span class="hljs-comment">/**
     * 创建订单接口（前端调用）
     */</span>
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public Result&lt;String&gt; <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"userId"</span>) Long userId,
                                      <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"productId"</span>) Long productId,
                                      <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"quantity"</span>) Integer quantity) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">orderNo</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.createOrder</span>(userId, productId, quantity);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(orderNo, <span class="hljs-string">"订单创建成功"</span>);
        } <span class="hljs-selector-tag">catch</span> (BusinessException e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"创建订单失败：{}"</span>, e.<span class="hljs-built_in">getMessage</span>());
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(e.<span class="hljs-built_in">getMessage</span>());
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"创建订单异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常，请重试"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 跨服务更新订单状态接口（供库存服务调用）
     */</span>
    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/{orderId}/status"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Result</span>&lt;<span class="hljs-selector-tag">Boolean</span>&gt; <span class="hljs-selector-tag">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId,
                                            <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.updateOrderStatus</span>(orderId, status);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">success</span> ? <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(true) : <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"更新订单状态失败"</span>);
        } <span class="hljs-selector-tag">catch</span> (BusinessException e) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(e.<span class="hljs-built_in">getMessage</span>());
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"更新订单状态异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常"</span>);
        }
    }
}

@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/local-message"</span>)
@<span class="hljs-selector-tag">Slf4j</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">LocalMessageController</span> {

    <span class="hljs-variable">@Autowired</span>
    private LocalMessageMapper localMessageMapper;

    <span class="hljs-comment">/**
     * 跨服务查询消息状态（供库存服务调用）
     */</span>
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/{messageId}"</span>)
    public Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId) {
        <span class="hljs-selector-tag">LocalMessage</span> <span class="hljs-selector-tag">localMessage</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.selectByLocalMessageId</span>(messageId);
        <span class="hljs-selector-tag">if</span> (localMessage == null) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"消息不存在"</span>);
        }
        <span class="hljs-selector-tag">LocalMessageVO</span> <span class="hljs-selector-tag">vo</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">LocalMessageVO</span>();
        <span class="hljs-selector-tag">vo</span><span class="hljs-selector-class">.setLocalMessageId</span>(localMessage.<span class="hljs-built_in">getLocalMessageId</span>());
        <span class="hljs-selector-tag">vo</span><span class="hljs-selector-class">.setConsumeState</span>(localMessage.<span class="hljs-built_in">getConsumeState</span>());
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(vo);
    }

    <span class="hljs-comment">/**
     * 跨服务更新消息消费状态（供库存服务调用）
     */</span>
    @<span class="hljs-selector-tag">PutMapping</span>(<span class="hljs-string">"/{messageId}/consume-state"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Result</span>&lt;<span class="hljs-selector-tag">Boolean</span>&gt; <span class="hljs-selector-tag">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId,
                                             <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">affectRows</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateConsumeState</span>(messageId, consumeState, System.<span class="hljs-built_in">currentTimeMillis</span>());
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">affectRows</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.success</span>(true) : <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"更新消费状态失败"</span>);
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"更新消息消费状态异常"</span>, e);
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">Result</span><span class="hljs-selector-class">.fail</span>(<span class="hljs-string">"系统异常"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-17">8. 定时重试任务（处理未发送成功的消息）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableScheduling</span>
<span class="hljs-variable">@Slf4j</span>
public class MessageRetryTask {

    <span class="hljs-variable">@Autowired</span>
    private LocalMessageMapper localMessageMapper;
    <span class="hljs-variable">@Autowired</span>
    private StreamBridge streamBridge;

    <span class="hljs-comment">/**
     * 每3分钟扫描一次未发送成功的消息，进行重试
     */</span>
    <span class="hljs-variable">@Scheduled</span>(cron = <span class="hljs-string">"0 0/3 * * * ?"</span>)
    public void <span class="hljs-built_in">retryUnsentMessage</span>() {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"开始执行未发送消息重试任务"</span>);
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">now</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();

        <span class="hljs-comment">// 查询：状态为READY + 下次发送时间&lt;=当前时间 + 未删除 + 重试次数&lt;最大重试次数</span>
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">LocalMessage</span>&gt; <span class="hljs-selector-tag">unsentMessages</span> = <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.selectUnsentMessages</span>(
            LocalMessageStatusEnum.READY.<span class="hljs-built_in">getStatus</span>(), now
        );

        <span class="hljs-selector-tag">if</span> (CollectionUtil.<span class="hljs-built_in">isEmpty</span>(unsentMessages)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"无未发送消息，重试任务结束"</span>);
            <span class="hljs-selector-tag">return</span>;
        }

        <span class="hljs-comment">// 遍历重试</span>
        <span class="hljs-selector-tag">for</span> (LocalMessage <span class="hljs-attribute">message </span>: unsentMessages) {
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">messageId</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getLocalMessageId</span>();
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">currentRetryTimes</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getRetryTimes</span>();
            <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">maxRetryTimes</span> = <span class="hljs-selector-tag">message</span><span class="hljs-selector-class">.getMaxRetryTimes</span>();

            <span class="hljs-comment">// 重试次数超限，标记为失败</span>
            <span class="hljs-selector-tag">if</span> (currentRetryTimes &gt;= maxRetryTimes) {
                <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateLocalMessageStatus</span>(messageId, LocalMessageStatusEnum.FAIL.<span class="hljs-built_in">getStatus</span>(), currentRetryTimes, now);
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息重试次数超限，标记为失败，messageId:{}"</span>, messageId);
                <span class="hljs-selector-tag">continue</span>;
            }

            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-comment">// 构建MQ消息</span>
                <span class="hljs-selector-tag">CorrelationData</span> <span class="hljs-selector-tag">correlationData</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">CorrelationData</span>(messageId);
                <span class="hljs-selector-tag">Message</span>&lt;?&gt; <span class="hljs-selector-tag">mqMessage</span> = <span class="hljs-selector-tag">MessageBuilder</span><span class="hljs-selector-class">.withPayload</span>(message.<span class="hljs-built_in">getMessageBody</span>())
                        <span class="hljs-selector-class">.setHeader</span>(AmqpHeaders.PUBLISH_CONFIRM_CORRELATION, correlationData)
                        <span class="hljs-selector-class">.build</span>();

                <span class="hljs-comment">// 重新发送消息</span>
                <span class="hljs-selector-tag">streamBridge</span><span class="hljs-selector-class">.send</span>(message.<span class="hljs-built_in">getQueue</span>(), mqMessage);
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"消息重试发送，messageId:{}, 当前重试次数:{}"</span>, messageId, currentRetryTimes + <span class="hljs-number">1</span>);

                <span class="hljs-comment">// 更新重试次数和下次发送时间（指数退避：3分钟→6分钟→12分钟）</span>
                <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">newRetryTimes</span> = <span class="hljs-selector-tag">currentRetryTimes</span> + <span class="hljs-number">1</span>;
                <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">nextSendTime</span> = <span class="hljs-selector-tag">now</span> + (<span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) * (<span class="hljs-number">1</span> &lt;&lt; newRetryTimes); <span class="hljs-comment">// 2^newRetryTimes 倍</span>
                <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateRetryInfo</span>(messageId, newRetryTimes, nextSendTime, now);

                <span class="hljs-comment">// 发布确认回调（和sendAckMessage逻辑一致）</span>
                <span class="hljs-selector-tag">correlationData</span><span class="hljs-selector-class">.getFuture</span>()<span class="hljs-selector-class">.addCallback</span>(confirm -&gt; {
                    <span class="hljs-selector-tag">if</span> (confirm.<span class="hljs-built_in">isAck</span>()) {
                        <span class="hljs-selector-tag">localMessageMapper</span><span class="hljs-selector-class">.updateLocalMessageStatus</span>(messageId, LocalMessageStatusEnum.SEND.<span class="hljs-built_in">getStatus</span>(), newRetryTimes, System.<span class="hljs-built_in">currentTimeMillis</span>());
                        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"消息重试发送成功，messageId:{}"</span>, messageId);
                    } <span class="hljs-selector-tag">else</span> {
                        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"消息重试发送失败，等待下次扫描，messageId:{}"</span>, messageId);
                    }
                }, <span class="hljs-selector-tag">throwable</span> <span class="hljs-selector-tag">-</span>&gt; {
                    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"消息重试发送回调异常，messageId:{}"</span>, messageId, throwable);
                });
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"消息重试发送异常，messageId:{}"</span>, messageId, e);
            }
        }

        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"未发送消息重试任务执行结束，共处理{}条消息"</span>, unsentMessages.<span class="hljs-built_in">size</span>());
    }
}
</code></pre>
<h3 data-id="heading-18">9. 全局异常处理与Result工具类</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 全局异常处理器</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {

    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-title class_">BusinessException</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">handleBusinessException</span>(<span class="hljs-params">BusinessException e</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"业务异常：{}"</span>, e.<span class="hljs-title function_">getMessage</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">fail</span>(e.<span class="hljs-title function_">getMessage</span>());
    }

    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">handleException</span>(<span class="hljs-params">Exception e</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"系统异常："</span>, e);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Result</span>.<span class="hljs-title function_">fail</span>(<span class="hljs-string">"系统异常，请联系管理员"</span>);
    }
}

<span class="hljs-comment">// 2. 统一返回结果工具类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final long serialVersionUID = 1L;
    <span class="hljs-keyword">private</span> int code; <span class="hljs-comment">// 0-成功，1-失败</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> msg;
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-comment">// 成功响应（无数据）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, <span class="hljs-string">"操作成功"</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 成功响应（有数据）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params">T data</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, <span class="hljs-string">"操作成功"</span>, data);
    }

    <span class="hljs-comment">// 成功响应（自定义消息）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">success</span>(<span class="hljs-params">T data, <span class="hljs-built_in">String</span> msg</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">0</span>, msg, data);
    }

    <span class="hljs-comment">// 失败响应（自定义消息）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-title class_">Result</span>&lt;T&gt; <span class="hljs-title function_">fail</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> msg</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-number">1</span>, msg, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、第四步：库存服务完整代码</h2>
<h3 data-id="heading-20">1. 核心依赖（pom.xml）</h3>
<p>和订单服务一致（Spring Boot + Stream + RabbitMQ + MyBatis-Plus + Feign）</p>
<h3 data-id="heading-21">2. 配置文件（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">stock-service</span> <span class="hljs-comment"># 服务名</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/stock_db?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;allowPublicKeyRetrieval=true</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">stream:</span>
      <span class="hljs-attr">rabbit:</span>
        <span class="hljs-attr">bindings:</span>
          <span class="hljs-comment"># 消费者绑定（和订单服务的交换机、路由键一致）</span>
          <span class="hljs-attr">stock-deduct-binding-in-0:</span>
            <span class="hljs-attr">consumer:</span>
              <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">MANUAL</span> <span class="hljs-comment"># 手动确认消息（确保消费成功后再ACK）</span>
              <span class="hljs-attr">dead-letter-exchange:</span> <span class="hljs-string">dlq.stock.exchange</span> <span class="hljs-comment"># 死信交换机（处理最终失败消息）</span>
              <span class="hljs-attr">dead-letter-routing-key:</span> <span class="hljs-string">dlq.stock.deduct</span> <span class="hljs-comment"># 死信路由键</span>
              <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 最大重试3次（超过进入死信队列）</span>
              <span class="hljs-attr">retry:</span>
                <span class="hljs-attr">initial-interval:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 初始重试间隔1秒</span>
                <span class="hljs-attr">multiplier:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 间隔倍数（1s→2s→4s）</span>
              <span class="hljs-attr">exchange-type:</span> <span class="hljs-string">direct</span>
      <span class="hljs-attr">bindings:</span>
        <span class="hljs-comment"># 消费者绑定配置（格式：bindingName-in-0）</span>
        <span class="hljs-attr">stock-deduct-binding-in-0:</span>
          <span class="hljs-attr">destination:</span> <span class="hljs-string">stock.exchange</span> <span class="hljs-comment"># 和订单服务的交换机一致</span>
          <span class="hljs-attr">group:</span> <span class="hljs-string">stock-group</span> <span class="hljs-comment"># 消费者组（避免重复消费）</span>
          <span class="hljs-attr">binder:</span> <span class="hljs-string">rabbit</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>

<span class="hljs-comment"># MyBatis-Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.stock.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>

<span class="hljs-comment"># 服务端口</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span>
</code></pre>
<h3 data-id="heading-22">3. 实体类与Mapper</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 库存实体</span>
<span class="hljs-variable">@Data</span>
<span class="hljs-variable">@TableName</span>(<span class="hljs-string">"t_stock"</span>)
public class Stock implements Serializable {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">serialVersionUID</span> = <span class="hljs-number">1</span><span class="hljs-selector-tag">L</span>;

    @<span class="hljs-selector-tag">TableId</span>(type = IdType.AUTO)
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">id</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">productId</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">stockNum</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Integer</span> <span class="hljs-selector-tag">lockNum</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">createTime</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">updateTime</span>;
}

<span class="hljs-comment">// 2. 库存Mapper</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">StockMapper</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">BaseMapper</span>&lt;<span class="hljs-selector-tag">Stock</span>&gt; {
    <span class="hljs-comment">/**
     * 扣减库存（加行锁，避免超卖）
     * SQL：UPDATE t_stock SET stock_num = stock_num - #{quantity}, update_time = #{now} WHERE product_id = #{productId} AND stock_num &gt;= #{quantity}
     */</span>
    <span class="hljs-variable">@Update</span>(<span class="hljs-string">"UPDATE t_stock SET stock_num = stock_num - #{quantity}, update_time = #{now} WHERE product_id = #{productId} AND stock_num &gt;= #{quantity}"</span>)
    int <span class="hljs-built_in">deductStock</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"productId"</span>) Long productId, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"quantity"</span>) Integer quantity, <span class="hljs-variable">@Param</span>(<span class="hljs-string">"now"</span>) Long now);
}
</code></pre>
<h3 data-id="heading-23">4. Feign客户端（跨服务调用订单服务）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 1. 订单状态更新Feign（和订单服务的接口一致）</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface OrderFeignClient {
    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/order/{orderId}/status"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateOrderStatus</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"orderId"</span>) Long orderId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"status"</span>) Integer status);
}

<span class="hljs-comment">// 2. 本地消息状态更新Feign</span>
<span class="hljs-variable">@FeignClient</span>(name = <span class="hljs-string">"order-service"</span>)
public interface LocalMessageFeignClient {
    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/local-message/{messageId}"</span>)
    Result&lt;LocalMessageVO&gt; <span class="hljs-built_in">getByMessageId</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId);

    <span class="hljs-variable">@PutMapping</span>(<span class="hljs-string">"/local-message/{messageId}/consume-state"</span>)
    Result&lt;Boolean&gt; <span class="hljs-built_in">updateConsumeState</span>(<span class="hljs-variable">@PathVariable</span>(<span class="hljs-string">"messageId"</span>) String messageId, <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"consumeState"</span>) Integer consumeState);
}
</code></pre>
<h3 data-id="heading-24">5. 核心消费者服务（StockConsumerService）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockConsumerService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">StockMapper</span> stockMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">OrderFeignClient</span> orderFeignClient;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalMessageFeignClient</span> localMessageFeignClient;

    <span class="hljs-comment">/**
     * 库存扣减消费者（监听MQ消息）
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-title class_">Message</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt; <span class="hljs-title function_">stockDeductConsumer</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> message -&gt; {
            <span class="hljs-title class_">String</span> payloadStr = message.<span class="hljs-title function_">getPayload</span>();
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"收到库存扣减消息，payload:{}"</span>, payloadStr);

            <span class="hljs-comment">// 解析消息体（LocalMessagePayload格式）</span>
            <span class="hljs-title class_">LocalMessageService</span>.<span class="hljs-property">LocalMessagePayload</span> payload = <span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toBean</span>(payloadStr, <span class="hljs-title class_">LocalMessageService</span>.<span class="hljs-property">LocalMessagePayload</span>.<span class="hljs-property">class</span>);
            <span class="hljs-title class_">StockDeductDTO</span> deductDTO = <span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toBean</span>(<span class="hljs-title class_">JSON</span>Util.<span class="hljs-title function_">toJsonStr</span>(payload.<span class="hljs-title function_">getData</span>()), <span class="hljs-title class_">StockDeductDTO</span>.<span class="hljs-property">class</span>);

            <span class="hljs-title class_">String</span> messageId = deductDTO.<span class="hljs-title function_">getMessageId</span>();
            <span class="hljs-title class_">Long</span> orderId = deductDTO.<span class="hljs-title function_">getOrderId</span>();
            <span class="hljs-title class_">Long</span> productId = deductDTO.<span class="hljs-title function_">getProductId</span>();
            <span class="hljs-title class_">Integer</span> quantity = deductDTO.<span class="hljs-title function_">getQuantity</span>();
            long now = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();

            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 幂等性校验：避免重复扣减库存</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">LocalMessageVO</span>&gt; messageResult = localMessageFeignClient.<span class="hljs-title function_">getByMessageId</span>(messageId);
                <span class="hljs-keyword">if</span> (messageResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || messageResult.<span class="hljs-title function_">getData</span>() == <span class="hljs-literal">null</span>) {
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"消息不存在，messageId:{}"</span>, messageId);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"消息不存在，拒绝重入队列"</span>);
                }
                <span class="hljs-keyword">if</span> (messageResult.<span class="hljs-title function_">getData</span>().<span class="hljs-title function_">getConsumeState</span>() == <span class="hljs-number">1</span>) {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"消息已消费，无需重复处理，messageId:{}"</span>, messageId);
                    <span class="hljs-keyword">return</span>;
                }

                <span class="hljs-comment">// 2. 扣减库存（本地事务，加行锁避免超卖）</span>
                int affectRows = stockMapper.<span class="hljs-title function_">deductStock</span>(productId, quantity, now);
                <span class="hljs-keyword">if</span> (affectRows == <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 库存不足：取消订单，拒绝重入队列（进入死信队列）</span>
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存不足，无法扣减，productId:{}, quantity:{}, orderId:{}"</span>, productId, quantity, orderId);
                    <span class="hljs-comment">// 跨服务调用：更新订单状态为“已取消”</span>
                    <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; cancelResult = orderFeignClient.<span class="hljs-title function_">updateOrderStatus</span>(orderId, <span class="hljs-title class_">OrderStatusEnum</span>.<span class="hljs-property">CANCELLED</span>.<span class="hljs-title function_">getStatus</span>());
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存不足，取消订单结果，orderId:{}, success:{}"</span>, orderId, cancelResult.<span class="hljs-title function_">getData</span>());
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"库存不足，取消订单"</span>);
                }
                log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存扣减成功，productId:{}, 扣减数量:{}, 剩余库存:{}"</span>, productId, quantity, <span class="hljs-title function_">getStockNum</span>(productId));

                <span class="hljs-comment">// 3. 跨服务调用：更新订单状态为“已扣库存待支付”</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; orderResult = orderFeignClient.<span class="hljs-title function_">updateOrderStatus</span>(orderId, <span class="hljs-title class_">OrderStatusEnum</span>.<span class="hljs-property">DEDUCTED_WAIT_PAY</span>.<span class="hljs-title function_">getStatus</span>());
                <span class="hljs-keyword">if</span> (orderResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || !orderResult.<span class="hljs-title function_">getData</span>()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"更新订单状态失败"</span>);
                }

                <span class="hljs-comment">// 4. 跨服务调用：标记消息为“已消费”</span>
                <span class="hljs-title class_">Result</span>&lt;<span class="hljs-title class_">Boolean</span>&gt; consumeResult = localMessageFeignClient.<span class="hljs-title function_">updateConsumeState</span>(messageId, <span class="hljs-number">1</span>);
                <span class="hljs-keyword">if</span> (consumeResult.<span class="hljs-title function_">getCode</span>() != <span class="hljs-number">0</span> || !consumeResult.<span class="hljs-title function_">getData</span>()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"更新消息消费状态失败"</span>);
                }

                log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"库存扣减全流程完成，messageId:{}, orderId:{}"</span>, messageId, orderId);

            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">AmqpRejectAndDontRequeueException</span> e) {
                <span class="hljs-comment">// 主动拒绝：不重试，直接进入死信队列</span>
                <span class="hljs-keyword">throw</span> e;
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">BusinessException</span> e) {
                <span class="hljs-comment">// 业务异常：不重试，进入死信队列</span>
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存扣减业务异常，messageId:{}, orderId:{}"</span>, messageId, orderId, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(e.<span class="hljs-title function_">getMessage</span>(), e);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
                <span class="hljs-comment">// 非业务异常（如网络抖动）：抛异常触发重试（最多3次）</span>
                log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"库存扣减异常，将重试，messageId:{}, orderId:{}"</span>, messageId, orderId, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减异常，触发重试"</span>, e);
            }
        };
    }

    <span class="hljs-comment">// 辅助方法：查询商品当前库存（仅日志用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getStockNum</span>(<span class="hljs-params">Long productId</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">Stock</span> stock = stockMapper.<span class="hljs-title function_">selectOne</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;<span class="hljs-title class_">Stock</span>&gt;().<span class="hljs-title function_">eq</span>(<span class="hljs-title class_">Stock</span>::getProductId, productId));
            <span class="hljs-keyword">return</span> stock != <span class="hljs-literal">null</span> ? stock.<span class="hljs-title function_">getStockNum</span>() : <span class="hljs-number">0</span>;
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"查询库存失败，productId:{}"</span>, productId, e);
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-25">6. 死信队列配置（处理最终失败消息）</h3>
<pre><code class="hljs language-csharp" lang="csharp">@Configuration
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RabbitDLQConfig</span> {

    <span class="hljs-comment">/**
     * 死信交换机
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">dlqStockExchange</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(<span class="hljs-string">"dlq.stock.exchange"</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">/**
     * 死信队列
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">dlqStockQueue</span>()</span> {
        <span class="hljs-keyword">return</span> QueueBuilder.durable(<span class="hljs-string">"dlq.stock.queue"</span>).build();
    }

    <span class="hljs-comment">/**
     * 死信绑定（交换机→队列）
     */</span>
    @Bean
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">dlqStockBinding</span>()</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(dlqStockQueue())
                .to(dlqStockExchange())
                .<span class="hljs-keyword">with</span>(<span class="hljs-string">"dlq.stock.deduct"</span>); <span class="hljs-comment">// 和配置中的死信路由键一致</span>
    }
}
</code></pre>
<h3 data-id="heading-26">7. 全局异常处理与Result工具类</h3>
<p>和订单服务一致（复用公共的Result类和GlobalExceptionHandler）</p>
<hr/>
<h2 data-id="heading-27">六、第五步：测试验证（确保解决核心问题）</h2>
<h3 data-id="heading-28">1. 正常流程测试</h3>
<ul>
<li>
<p>调用订单服务接口：<code>http://localhost:8081/order/create?userId=1&amp;productId=1001&amp;quantity=10</code></p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单表新增一条记录，状态为1（待扣库存）；</li>
<li>LocalMessage表新增一条记录，状态为1（SEND），消费状态为0；</li>
<li>库存表中商品1001的库存从100变为90；</li>
<li>订单状态更新为2（已扣库存待支付）；</li>
<li>LocalMessage表的消费状态更新为1（已消费）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-29">2. 库存不足场景测试</h3>
<ul>
<li>
<p>调用接口：<code>http://localhost:8081/order/create?userId=1&amp;productId=1001&amp;quantity=200</code>（库存仅90）</p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单创建成功（状态1）；</li>
<li>库存扣减失败（affectRows=0）；</li>
<li>订单状态更新为3（已取消）；</li>
<li>消息进入死信队列；</li>
<li>无超卖现象。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">3. 消息重复消费测试</h3>
<ul>
<li>手动在RabbitMQ中重发消息（模拟重复消费）；</li>
<li>预期结果：幂等性校验生效，库存不会重复扣减，日志提示“消息已消费，无需重复处理”。</li>
</ul>
<h3 data-id="heading-31">4. MQ宕机场景测试</h3>
<ul>
<li>
<p>停止RabbitMQ，调用订单创建接口；</p>
</li>
<li>
<p>预期结果：</p>
<ul>
<li>订单创建成功，LocalMessage表记录状态为0（READY）；</li>
<li>启动RabbitMQ后，定时任务扫描到未发送消息，自动重试发送；</li>
<li>库存扣减成功，最终一致性保障。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-32">七、总结</h2>
<ol>
<li>
<p>这套完整代码<strong>完全基于你的sendAckMessage方法扩展</strong>，完美支持跨服务场景，能彻底解决「订单创建+库存扣减」的核心问题（超卖、库存锁定不释放、消息丢失、重复扣减）；</p>
</li>
<li>
<p>核心保障：</p>
<ol>
<li>本地事务保证「订单创建+存消息」原子性；</li>
<li>事务提交后发消息，避免“消息已发但订单回滚”；</li>
<li>库存扣减SQL加行锁，避免超卖；</li>
<li>幂等性校验（messageId），避免重复消费；</li>
<li>定时重试+死信队列，应对各种异常场景；</li>
</ol>
</li>
<li>
<p>直接复用：代码可直接复制到项目中，只需修改数据库连接、服务端口等配置，即可快速落地；</p>
</li>
<li>
<p>扩展性：支持延迟发送（delaySeconds参数）、多商品扣减、分布式锁优化等高并发场景需求。</p>
</li>
</ol>
<p>如果需要优化高并发场景（如秒杀），或补充支付流程后的库存最终锁定逻辑，可以随时告诉我！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 权限修饰符（Access Modifiers）指南]]></title>    <link>https://juejin.cn/post/7578853751531536399</link>    <guid>https://juejin.cn/post/7578853751531536399</guid>    <pubDate>2025-12-02T09:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578853751531536399" data-draft-id="7578877638988922880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 权限修饰符（Access Modifiers）指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 权限修饰符（Access Modifiers）指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:26.000Z" title="Tue Dec 02 2025 09:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📊 权限修饰符总览</h2>













































<table><thead><tr><th>修饰符</th><th>同类</th><th>同包</th><th>子类（不同包）</th><th>不同包非子类</th><th>级别</th></tr></thead><tbody><tr><td><strong>private</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>最严格</td></tr><tr><td><strong>默认</strong> (无修饰符)</td><td>✅</td><td>✅</td><td>❌</td><td>❌</td><td>包级别</td></tr><tr><td><strong>protected</strong></td><td>✅</td><td>✅</td><td>✅</td><td>❌</td><td>子类级别</td></tr><tr><td><strong>public</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>最宽松</td></tr></tbody></table>
<p><em>一般来说小编大多只使用private和public</em></p>
<h2 data-id="heading-1">🎯 四种权限修饰符详解</h2>
<h3 data-id="heading-2"><strong>1. private（私有访问）</strong></h3>
<h4 data-id="heading-3"><strong>特点</strong></h4>
<ul>
<li>只能在<strong>本类内部</strong>访问</li>
<li>最严格的访问控制</li>
<li>常用于封装，隐藏实现细节</li>
</ul>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrivateDemo</span> {
    <span class="hljs-comment">// 私有属性 - 只能在本类中访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> secret = <span class="hljs-string">"这是机密信息"</span>;
    <span class="hljs-keyword">private</span> int privateNumber = <span class="hljs-number">100</span>;
    
    <span class="hljs-comment">// 私有方法 - 只能在本类中调用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">showSecret</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"机密信息: "</span> + secret);
    }
    
    <span class="hljs-comment">// 公共方法提供对私有属性的受控访问</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSecret</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 可以添加验证逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">checkPermission</span>()) {
            <span class="hljs-keyword">return</span> secret;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"无权访问"</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setSecret</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> newSecret</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validateSecret</span>(newSecret)) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">secret</span> = newSecret;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 权限检查逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">validateSecret</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> secret</span>) {
        <span class="hljs-comment">// 验证逻辑</span>
        <span class="hljs-keyword">return</span> secret != <span class="hljs-literal">null</span> &amp;&amp; !secret.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>();
    }
    
    <span class="hljs-comment">// 在本类中可以自由访问私有成员</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">testAccess</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"在本类中访问:"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"直接访问私有属性: "</span> + secret);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"调用私有方法: "</span>);
        <span class="hljs-title function_">showSecret</span>();
        
        <span class="hljs-comment">// 修改私有属性</span>
        privateNumber = <span class="hljs-number">200</span>;
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后: "</span> + privateNumber);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">PrivateDemo</span> demo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivateDemo</span>();
        demo.<span class="hljs-title function_">testAccess</span>();
        
        <span class="hljs-comment">// 通过公共方法访问私有属性</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"\n通过公共方法访问:"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"getSecret(): "</span> + demo.<span class="hljs-title function_">getSecret</span>());
        
        demo.<span class="hljs-title function_">setSecret</span>(<span class="hljs-string">"新的机密"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"修改后: "</span> + demo.<span class="hljs-title function_">getSecret</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能直接访问私有成员</span>
        <span class="hljs-comment">// System.out.println(demo.secret);      // 编译错误</span>
        <span class="hljs-comment">// demo.showSecret();                   // 编译错误</span>
        <span class="hljs-comment">// demo.privateNumber = 300;            // 编译错误</span>
    }
}

<span class="hljs-comment">// 同包中的另一个类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SamePackageClass</span> {
    <span class="hljs-built_in">void</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">PrivateDemo</span> demo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivateDemo</span>();
        
        <span class="hljs-comment">// ❌ 错误：同包其他类也不能访问private成员</span>
        <span class="hljs-comment">// System.out.println(demo.secret);      // 编译错误</span>
        <span class="hljs-comment">// demo.showSecret();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：只能通过公共方法访问</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(demo.<span class="hljs-title function_">getSecret</span>());
    }
}
</code></pre>
<h4 data-id="heading-4"><strong>private 在构造器中的应用</strong></h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> {
    <span class="hljs-comment">// 私有静态变量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;
    
    <span class="hljs-comment">// 私有构造器 - 防止外部创建实例</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Singleton实例被创建"</span>);
    }
    
    <span class="hljs-comment">// 公共静态方法提供访问</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span>()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            instance = <span class="hljs-keyword">new</span> Singleton();
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showMessage</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Hello Singleton!"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// ❌ 错误：不能直接new</span>
        <span class="hljs-comment">// Singleton s = new Singleton();</span>
        
        <span class="hljs-comment">// ✅ 正确：通过静态方法获取</span>
        Singleton s1 = Singleton.getInstance();
        Singleton s2 = Singleton.getInstance();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"s1 == s2: "</span> + (s1 == s2));  <span class="hljs-comment">// true</span>
        s1.showMessage();
    }
}
</code></pre>
<h3 data-id="heading-5"><strong>2. 默认/包私有（Default/Package-private）</strong></h3>
<h4 data-id="heading-6"><strong>特点</strong></h4>
<ul>
<li>没有明确指定修饰符</li>
<li>在<strong>同一个包内</strong>可以访问</li>
<li>也称为"包访问权限"或"包私有"</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example;

<span class="hljs-comment">// 默认类：同包可见</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">DefaultClass</span> {
    <span class="hljs-comment">// 默认属性：同包可见</span>
    String defaultField = <span class="hljs-string">"默认属性"</span>;
    
    <span class="hljs-comment">// 默认方法：同包可见</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-comment">// 公共方法：所有地方可见</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publicMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共方法"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DefaultModifierDemo</span> {
    <span class="hljs-comment">// 默认属性</span>
    String packagePrivateField = <span class="hljs-string">"包私有属性"</span>;
    
    <span class="hljs-comment">// 默认方法</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">packagePrivateMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"包私有方法"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"可以访问: "</span> + packagePrivateField);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        DefaultModifierDemo demo = <span class="hljs-keyword">new</span> DefaultModifierDemo();
        
        <span class="hljs-comment">// 在本类中可以访问默认成员</span>
        demo.packagePrivateMethod();
        
        <span class="hljs-comment">// 在同包中访问另一个类的默认成员</span>
        DefaultClass obj = <span class="hljs-keyword">new</span> DefaultClass();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n访问同包的DefaultClass:"</span>);
        System.<span class="hljs-keyword">out</span>.println(obj.defaultField);  <span class="hljs-comment">// ✅ 可以访问</span>
        obj.defaultMethod();                   <span class="hljs-comment">// ✅ 可以调用</span>
        obj.publicMethod();                    <span class="hljs-comment">// ✅ 可以调用</span>
    }
}

<span class="hljs-comment">// 同包中的另一个类</span>
package com.example;

<span class="hljs-keyword">class</span> <span class="hljs-title">AnotherClassInSamePackage</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        DefaultModifierDemo demo = <span class="hljs-keyword">new</span> DefaultModifierDemo();
        
        <span class="hljs-comment">// ✅ 正确：同包可以访问默认成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.packagePrivateField);
        demo.packagePrivateMethod();
        
        DefaultClass obj = <span class="hljs-keyword">new</span> DefaultClass();
        System.<span class="hljs-keyword">out</span>.println(obj.defaultField);
        obj.defaultMethod();
    }
}
</code></pre>
<h4 data-id="heading-7"><strong>不同包的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不同包中的类</span>
<span class="hljs-keyword">package</span> other;

<span class="hljs-keyword">import</span> com.example.DefaultModifierDemo;
<span class="hljs-keyword">import</span> com.example.DefaultClass;  <span class="hljs-comment">// ❌ 编译错误：DefaultClass不是public</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageClass</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DefaultModifierDemo</span> <span class="hljs-variable">demo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultModifierDemo</span>();
        
        <span class="hljs-comment">// ❌ 错误：不同包不能访问默认成员</span>
        <span class="hljs-comment">// System.out.println(demo.packagePrivateField);  // 编译错误</span>
        <span class="hljs-comment">// demo.packagePrivateMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：可以访问公共成员</span>
        <span class="hljs-comment">// demo.publicMethod();  // 如果有的话</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认类</span>
        <span class="hljs-comment">// DefaultClass obj = new DefaultClass();  // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-8"><strong>3. protected（受保护访问）</strong></h3>
<h4 data-id="heading-9"><strong>特点</strong></h4>
<ul>
<li>在<strong>同一个包内</strong>可以访问</li>
<li>在<strong>不同包的子类</strong>中可以访问</li>
<li>常用于允许子类访问父类的实现细节</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-comment">// protected 属性</span>
    <span class="hljs-keyword">protected</span> String protectedField = <span class="hljs-string">"父类的protected属性"</span>;
    
    <span class="hljs-comment">// protected 方法</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">protectedMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"父类的protected方法"</span>);
    }
    
    <span class="hljs-comment">// 默认属性（对比用）</span>
    String defaultField = <span class="hljs-string">"父类的默认属性"</span>;
    
    <span class="hljs-comment">// 公共方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"在本类中访问:"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + defaultField);
        protectedMethod();
    }
}

<span class="hljs-comment">// 同包的子类</span>
package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageChild</span> <span class="hljs-title">extends</span> <span class="hljs-title">Parent</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + defaultField);
        
        <span class="hljs-comment">// 通过 super 访问</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"通过super访问: "</span> + super.protectedField);
        super.protectedMethod();
    }
}

<span class="hljs-comment">// 同包的非子类</span>
package com.<span class="hljs-keyword">base</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageNonChild</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        Parent parent = <span class="hljs-keyword">new</span> Parent();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包非子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"protectedField: "</span> + parent.protectedField);
        parent.protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"defaultField: "</span> + parent.defaultField);
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>不同包子类的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不同包的子类</span>
<span class="hljs-keyword">package</span> com.derived;

<span class="hljs-keyword">import</span> com.base.Parent;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageChild</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Parent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"不同包子类访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（子类权限）</span>
        System.out.println(<span class="hljs-string">"protectedField: "</span> + protectedField);
        protectedMethod();
        
        <span class="hljs-comment">// 通过 super 访问</span>
        System.out.println(<span class="hljs-string">"通过super访问: "</span> + <span class="hljs-built_in">super</span>.protectedField);
        <span class="hljs-built_in">super</span>.protectedMethod();
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认成员（不同包）</span>
        <span class="hljs-comment">// System.out.println(defaultField);  // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 错误：不能通过父类实例访问 protected 成员</span>
        <span class="hljs-type">Parent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();
        <span class="hljs-comment">// System.out.println(parent.protectedField);  // 编译错误</span>
        <span class="hljs-comment">// parent.protectedMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：可以通过自身实例访问</span>
        <span class="hljs-type">DifferentPackageChild</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DifferentPackageChild</span>();
        System.out.println(<span class="hljs-string">"通过子类实例: "</span> + child.protectedField);
        child.protectedMethod();
    }
}

<span class="hljs-comment">// 不同包的非子类</span>
<span class="hljs-keyword">package</span> com.derived;

<span class="hljs-keyword">import</span> com.base.Parent;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DifferentPackageNonChild</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Parent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Parent</span>();
        
        System.out.println(<span class="hljs-string">"不同包非子类访问:"</span>);
        
        <span class="hljs-comment">// ❌ 错误：不能访问 protected 成员</span>
        <span class="hljs-comment">// System.out.println(parent.protectedField);  // 编译错误</span>
        <span class="hljs-comment">// parent.protectedMethod();                   // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认成员</span>
        <span class="hljs-comment">// System.out.println(parent.defaultField);    // 编译错误</span>
        
        <span class="hljs-comment">// ✅ 正确：只能访问 public 成员</span>
        parent.show();  <span class="hljs-comment">// 如果有的话</span>
    }
}
</code></pre>
<h3 data-id="heading-11"><strong>4. public（公共访问）</strong></h3>
<h4 data-id="heading-12"><strong>特点</strong></h4>
<ul>
<li>在任何地方都可以访问</li>
<li>最宽松的访问控制</li>
<li>用于定义对外提供的接口</li>
</ul>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package com.example;

<span class="hljs-comment">// public 类：所有地方可见</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicDemo</span> {
    <span class="hljs-comment">// public 属性：所有地方可见</span>
    <span class="hljs-keyword">public</span> String publicField = <span class="hljs-string">"公共属性"</span>;
    
    <span class="hljs-comment">// public 方法：所有地方可见</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publicMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共方法"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"可以访问: "</span> + publicField);
    }
    
    <span class="hljs-comment">// 其他权限的方法</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">protectedMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"受保护方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">privateMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"私有方法"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        <span class="hljs-comment">// 在本类中可以访问所有权限的成员</span>
        demo.publicMethod();
        demo.protectedMethod();
        demo.defaultMethod();
        demo.privateMethod();
    }
}

<span class="hljs-comment">// 同包的另一个类</span>
package com.example;

<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同包访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 public 成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);
        demo.publicMethod();
        
        <span class="hljs-comment">// ✅ 可以访问 protected 成员（同包）</span>
        demo.protectedMethod();
        
        <span class="hljs-comment">// ✅ 可以访问默认成员（同包）</span>
        demo.defaultMethod();
        
        <span class="hljs-comment">// ❌ 不能访问 private 成员</span>
        <span class="hljs-comment">// demo.privateMethod();  // 编译错误</span>
    }
}
</code></pre>
<h4 data-id="heading-13"><strong>不同包的情况</strong></h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 不同包中的类</span>
package other;

import com.example.PublicDemo;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        PublicDemo demo = <span class="hljs-keyword">new</span> PublicDemo();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"不同包访问:"</span>);
        
        <span class="hljs-comment">// ✅ 可以访问 public 成员</span>
        System.<span class="hljs-keyword">out</span>.println(demo.publicField);
        demo.publicMethod();
        
        <span class="hljs-comment">// ❌ 不能访问 protected 成员（不同包非子类）</span>
        <span class="hljs-comment">// demo.protectedMethod();  // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 不能访问默认成员（不同包）</span>
        <span class="hljs-comment">// demo.defaultMethod();    // 编译错误</span>
        
        <span class="hljs-comment">// ❌ 不能访问 private 成员</span>
        <span class="hljs-comment">// demo.privateMethod();    // 编译错误</span>
    }
}
</code></pre>
<h2 data-id="heading-14">🏗️ 权限修饰符的应用场景</h2>
<h3 data-id="heading-15"><strong>1. 封装：数据隐藏</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 银行账户类 - 使用封装保护数据</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-comment">// 私有属性：外部不能直接访问</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> accountNumber;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> accountHolder;
    <span class="hljs-keyword">private</span> double balance;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    
    <span class="hljs-comment">// 公共构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-title class_">String</span> accountNumber, <span class="hljs-title class_">String</span> accountHolder, 
                      <span class="hljs-title class_">String</span> password, double initialBalance) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountNumber</span> = accountNumber;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">balance</span> = initialBalance;
    }
    
    <span class="hljs-comment">// 公共方法：提供受控的访问</span>
    
    <span class="hljs-comment">// Getter 方法（只读）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountNumber</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountNumber;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getAccountHolder</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> accountHolder;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getBalance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> balance;
    }
    
    <span class="hljs-comment">// 没有 password 的 Getter（安全考虑）</span>
    
    <span class="hljs-comment">// Setter 方法（有验证）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAccountHolder</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> accountHolder</span>) {
        <span class="hljs-keyword">if</span> (accountHolder != <span class="hljs-literal">null</span> &amp;&amp; !accountHolder.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">isEmpty</span>()) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountHolder</span> = accountHolder;
        }
    }
    
    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-params">double amount</span>) {
        <span class="hljs-keyword">if</span> (amount &gt; <span class="hljs-number">0</span>) {
            balance += amount;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-params">double amount, <span class="hljs-built_in">String</span> password</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">authenticate</span>(password) &amp;&amp; amount &gt; <span class="hljs-number">0</span> &amp;&amp; amount &lt;= balance) {
            balance -= amount;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 私有方法：内部使用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">authenticate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> inputPassword</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>.<span class="hljs-title function_">equals</span>(inputPassword);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">logTransaction</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> <span class="hljs-keyword">type</span>, double amount</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"交易记录: "</span> + <span class="hljs-keyword">type</span> + <span class="hljs-string">" $"</span> + amount);
    }
    
    <span class="hljs-comment">// 受保护方法：给子类扩展用</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">applyFee</span>(<span class="hljs-params">double fee</span>) {
        <span class="hljs-keyword">if</span> (fee &gt; <span class="hljs-number">0</span> &amp;&amp; balance &gt;= fee) {
            balance -= fee;
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">BankAccount</span> account = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BankAccount</span>(<span class="hljs-string">"123456"</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">1000</span>);
        
        <span class="hljs-comment">// ✅ 正确：通过公共方法访问</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"账户: "</span> + account.<span class="hljs-title function_">getAccountNumber</span>());
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        account.<span class="hljs-title function_">deposit</span>(<span class="hljs-number">500</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"存款后余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        <span class="hljs-built_in">boolean</span> success = account.<span class="hljs-title function_">withdraw</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"123456"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取款"</span> + (success ? <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"取款后余额: $"</span> + account.<span class="hljs-title function_">getBalance</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能直接访问私有属性</span>
        <span class="hljs-comment">// System.out.println(account.balance);      // 编译错误</span>
        <span class="hljs-comment">// account.balance = 10000;                 // 编译错误</span>
        <span class="hljs-comment">// System.out.println(account.password);    // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-16"><strong>2. 继承框架设计</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">package framework;

<span class="hljs-comment">// 框架基类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseService</span> {
    <span class="hljs-comment">// 公共方法：对外接口</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>()</span> {
        initialize();
        process();
        cleanup();
    }
    
    <span class="hljs-comment">// 受保护方法：子类必须实现或可以重写</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span>()</span>;
    
    <span class="hljs-comment">// 受保护方法：子类可以重写</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cleanup</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"执行清理工作..."</span>);
    }
    
    <span class="hljs-comment">// 私有方法：内部实现细节</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">log</span>(<span class="hljs-params">String message</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"[LOG] "</span> + message);
    }
    
    <span class="hljs-comment">// 默认方法：同包的工具方法</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">internalHelper</span>()</span> {
        log(<span class="hljs-string">"内部辅助方法"</span>);
    }
}

<span class="hljs-comment">// 同包的工具类</span>
package framework;

<span class="hljs-keyword">class</span> <span class="hljs-title">ServiceValidator</span> {
    <span class="hljs-comment">// 默认方法：同包内使用</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> boolean <span class="hljs-title">validate</span>(<span class="hljs-params">BaseService service</span>)</span> {
        <span class="hljs-comment">// 可以访问 service.internalHelper()（同包）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户实现类（不同包）</span>
package userapp;

<span class="hljs-keyword">import</span> framework.<span class="hljs-property">BaseService</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseService</span> {
    <span class="hljs-comment">// 实现抽象方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"用户服务初始化"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"处理用户请求"</span>);
    }
    
    <span class="hljs-comment">// 可以重写 cleanup 方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">cleanup</span>();  <span class="hljs-comment">// 调用父类方法</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"额外的清理工作"</span>);
    }
    
    <span class="hljs-comment">// 不能访问父类的私有方法</span>
    <span class="hljs-comment">// private void tryAccess() {</span>
    <span class="hljs-comment">//     log("测试");  // 编译错误：不能访问父类的private方法</span>
    <span class="hljs-comment">// }</span>
    
    <span class="hljs-comment">// 不能访问父类的默认方法（不同包）</span>
    <span class="hljs-comment">// void tryInternal() {</span>
    <span class="hljs-comment">//     internalHelper();  // 编译错误：不同包不能访问默认方法</span>
    <span class="hljs-comment">// }</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">UserService</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();
        service.<span class="hljs-title function_">execute</span>();
    }
}
</code></pre>
<h3 data-id="heading-17"><strong>3. 常量定义</strong></h3>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 常量类设计</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Constants</span> {
    <span class="hljs-comment">// 私有构造器：防止实例化</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Constants</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">AssertionError</span>(<span class="hljs-string">"不能实例化常量类"</span>);
    }
    
    <span class="hljs-comment">// 公共常量：所有地方可用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> APP_NAME = <span class="hljs-string">"MyApplication"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> PI = <span class="hljs-number">3.141592653589793</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> MAX_RETRY_COUNT = <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">// 受保护常量：子类可用</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> DEFAULT_ENCODING = <span class="hljs-string">"UTF-8"</span>;
    
    <span class="hljs-comment">// 默认常量：同包可用</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> CONFIG_FILE = <span class="hljs-string">"app.properties"</span>;
    
    <span class="hljs-comment">// 私有常量：仅本类可用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> SECRET_KEY = <span class="hljs-string">"secret123"</span>;
    
    <span class="hljs-comment">// 公共方法使用常量</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">getSecretHash</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">hash</span>(SECRET_KEY);  <span class="hljs-comment">// 可以访问私有常量</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">hash</span><span class="hljs-params">(<span class="hljs-type">String</span> input)</span> </span>{
        <span class="hljs-comment">// 哈希计算</span>
        <span class="hljs-keyword">return</span> input + <span class="hljs-string">"_hashed"</span>;
    }
    
    <span class="hljs-comment">// 同包辅助方法</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">getConfigPath</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> CONFIG_FILE;  <span class="hljs-comment">// 可以访问默认常量</span>
    }
}

<span class="hljs-comment">// 使用常量</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantUsage</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"应用名称: "</span> + Constants.APP_NAME);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"PI值: "</span> + Constants.PI);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"最大重试次数: "</span> + Constants.MAX_RETRY_COUNT);
        
        <span class="hljs-comment">// 访问公共方法</span>
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"密钥哈希: "</span> + Constants.<span class="hljs-built_in">getSecretHash</span>());
        
        <span class="hljs-comment">// ❌ 错误：不能访问受保护常量（不是子类）</span>
        <span class="hljs-comment">// System.out.println(Constants.DEFAULT_ENCODING);</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问默认常量（不同包）</span>
        <span class="hljs-comment">// System.out.println(Constants.CONFIG_FILE);</span>
        
        <span class="hljs-comment">// ❌ 错误：不能访问私有常量</span>
        <span class="hljs-comment">// System.out.println(Constants.SECRET_KEY);</span>
    }
}
</code></pre>
<h2 data-id="heading-18">⚠️ 权限修饰符的注意事项</h2>
<h3 data-id="heading-19"><strong>1. 类级别的访问控制</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 公共类：所有地方可见（文件名必须与类名相同）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共类"</span>);
    }
}

<span class="hljs-comment">// 默认类：同包可见</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">DefaultClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">show</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认类"</span>);
    }
}

<span class="hljs-comment">// 错误：一个文件只能有一个公共类，且必须与文件名相同</span>
<span class="hljs-comment">/*
public class AnotherPublicClass {  // 编译错误
}
*/</span>

<span class="hljs-comment">// 内部类可以是任何访问级别</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">Outer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PublicInner</span> {}
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProtectedInner</span> {}
    <span class="hljs-keyword">class</span> <span class="hljs-title">DefaultInner</span> {}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PrivateInner</span> {}
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClassLevelAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        PublicClass pc = <span class="hljs-keyword">new</span> PublicClass();
        pc.show();
        
        <span class="hljs-comment">// 同包可以访问默认类</span>
        DefaultClass dc = <span class="hljs-keyword">new</span> DefaultClass();
        dc.show();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n类访问规则:"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"1. 一个.java文件只能有一个public类"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"2. public类名必须与文件名相同"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"3. 可以有多个默认类"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"4. 内部类可以是任何访问级别"</span>);
    }
}
</code></pre>
<h3 data-id="heading-20"><strong>2. 接口成员的访问权限</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 接口中的成员默认都是 public</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">MyInterface</span> {
    <span class="hljs-comment">// 常量默认是 public static final</span>
    String CONSTANT = <span class="hljs-string">"接口常量"</span>;  <span class="hljs-comment">// 等价于 public static final</span>
    
    <span class="hljs-comment">// 方法默认是 public abstract</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span>()</span>;  <span class="hljs-comment">// 等价于 public abstract void doSomething()</span>
    
    <span class="hljs-comment">// Java 8+：默认方法</span>
    <span class="hljs-function"><span class="hljs-literal">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认方法"</span>);
    }
    
    <span class="hljs-comment">// Java 8+：静态方法</span>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态方法"</span>);
    }
    
    <span class="hljs-comment">// ❌ 错误：不能使用private（Java 9+可以）</span>
    <span class="hljs-comment">// private void privateMethod();  // Java 8编译错误</span>
    
    <span class="hljs-comment">// ❌ 错误：不能使用protected</span>
    <span class="hljs-comment">// protected void protectedMethod();  // 编译错误</span>
}

<span class="hljs-comment">// 实现接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">MyImplementation</span> <span class="hljs-title">implements</span> <span class="hljs-title">MyInterface</span> {
    <span class="hljs-comment">// 必须使用public重写（不能更严格）</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"实现接口方法"</span>);
    }
    
    <span class="hljs-comment">// 可以重写默认方法（可选）</span>
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">defaultMethod</span>()</span> {
        MyInterface.super.defaultMethod();  <span class="hljs-comment">// 调用接口的默认方法</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"重写的默认方法"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InterfaceAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        MyInterface.staticMethod();  <span class="hljs-comment">// 调用接口静态方法</span>
        
        MyImplementation impl = <span class="hljs-keyword">new</span> MyImplementation();
        impl.doSomething();
        impl.defaultMethod();
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"常量: "</span> + MyInterface.CONSTANT);
    }
}
</code></pre>
<h3 data-id="heading-21"><strong>3. 构造器的访问权限</strong></h3>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConstructorAccess</span> {
    <span class="hljs-comment">// 公共构造器：所有地方可以创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstructorAccess</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"公共构造器"</span>);
    }
    
    <span class="hljs-comment">// 受保护构造器：同包或子类可以创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">ConstructorAccess</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> a</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"受保护构造器: "</span> + a);
    }
    
    <span class="hljs-comment">// 默认构造器：同包可以创建对象</span>
    ConstructorAccess(String s) {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"默认构造器: "</span> + s);
    }
    
    <span class="hljs-comment">// 私有构造器：只能在本类中创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ConstructorAccess</span>(<span class="hljs-params">boolean b</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"私有构造器: "</span> + b);
    }
    
    <span class="hljs-comment">// 静态工厂方法访问私有构造器</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConstructorAccess <span class="hljs-title">createPrivateInstance</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-literal">true</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 本类中可以访问所有构造器</span>
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// public</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-number">10</span>);         <span class="hljs-comment">// protected</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-string">"test"</span>);     <span class="hljs-comment">// default</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-literal">true</span>);       <span class="hljs-comment">// private</span>
        
        <span class="hljs-comment">// 工厂方法</span>
        ConstructorAccess.createPrivateInstance();
    }
}

<span class="hljs-comment">// 同包的其他类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">SamePackageClass</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// ✅ public</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-number">20</span>);         <span class="hljs-comment">// ✅ protected（同包）</span>
        <span class="hljs-keyword">new</span> ConstructorAccess(<span class="hljs-string">"hello"</span>);    <span class="hljs-comment">// ✅ default（同包）</span>
        <span class="hljs-comment">// new ConstructorAccess(true);    // ❌ private</span>
    }
}

<span class="hljs-comment">// 不同包子类</span>
package other;

import ConstructorAccess;

<span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageChild</span> <span class="hljs-title">extends</span> <span class="hljs-title">ConstructorAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DifferentPackageChild</span>()</span> {
        super(<span class="hljs-number">30</span>);  <span class="hljs-comment">// ✅ 可以调用protected构造器（子类）</span>
        <span class="hljs-comment">// super("test");  // ❌ 不能调用default构造器（不同包）</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-comment">// new ConstructorAccess(40);  // ❌ 不能直接调用（需要是子类构造器中）</span>
    }
}

<span class="hljs-comment">// 不同包非子类</span>
package other;

import ConstructorAccess;

<span class="hljs-keyword">class</span> <span class="hljs-title">DifferentPackageNonChild</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span>()</span> {
        <span class="hljs-keyword">new</span> ConstructorAccess();           <span class="hljs-comment">// ✅ public</span>
        <span class="hljs-comment">// new ConstructorAccess(50);      // ❌ protected</span>
        <span class="hljs-comment">// new ConstructorAccess("test");  // ❌ default</span>
        <span class="hljs-comment">// new ConstructorAccess(true);    // ❌ private</span>
    }
}
</code></pre>
<h2 data-id="heading-22">💡 权限修饰符最佳实践</h2>
<h3 data-id="heading-23"><strong>1. 最小权限原则</strong></h3>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 遵循最小权限原则：只暴露必要的内容</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-comment">// 私有属性：隐藏实现细节</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> double salary;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> ssn;  <span class="hljs-comment">// 社保号（敏感信息）</span>
    
    <span class="hljs-comment">// 公共构造器：允许创建对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-title class_">String</span> id, <span class="hljs-title class_">String</span> name) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = <span class="hljs-number">0.0</span>;
    }
    
    <span class="hljs-comment">// 公共getter：只读访问</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> id;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> name;
    }
    
    <span class="hljs-keyword">public</span> double <span class="hljs-title function_">getSalary</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> salary;
    }
    
    <span class="hljs-comment">// 受保护setter：允许子类或同包修改</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setSalary</span>(<span class="hljs-params">double salary</span>) {
        <span class="hljs-keyword">if</span> (salary &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = salary;
        }
    }
    
    <span class="hljs-comment">// 默认方法：同包工具方法</span>
    <span class="hljs-built_in">void</span> <span class="hljs-title function_">internalUpdate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> newName</span>) {
        <span class="hljs-keyword">if</span> (newName != <span class="hljs-literal">null</span> &amp;&amp; newName.<span class="hljs-title function_">length</span>() &gt;= <span class="hljs-number">2</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = newName;
        }
    }
    
    <span class="hljs-comment">// 私有方法：内部逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">calculateBonus</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 奖金计算逻辑</span>
    }
    
    <span class="hljs-comment">// 没有提供ssn的getter/setter（安全考虑）</span>
}

<span class="hljs-comment">// 管理者类（需要修改工资）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Manager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Employee</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Manager</span>(<span class="hljs-title class_">String</span> id, <span class="hljs-title class_">String</span> name) {
        <span class="hljs-variable language_">super</span>(id, name);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">adjustSalary</span>(<span class="hljs-params">Employee emp, double newSalary</span>) {
        <span class="hljs-comment">// 可以调用受保护方法</span>
        emp.<span class="hljs-title function_">setSalary</span>(newSalary);
    }
}
</code></pre>
<h3 data-id="heading-24"><strong>2. 模块化设计</strong></h3>
<p>java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 包结构示例：</span>
<span class="hljs-comment">// com.company</span>
<span class="hljs-comment">//   ├── api          (公共API)</span>
<span class="hljs-comment">//   ├── impl         (实现，包私有)</span>
<span class="hljs-comment">//   ├── internal     (内部实现，包私有)</span>
<span class="hljs-comment">//   └── util         (工具类)</span>

<span class="hljs-comment">// api包：公共接口</span>
<span class="hljs-keyword">package</span> com.company.api;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span>;
}

<span class="hljs-comment">// impl包：实现（包私有）</span>
<span class="hljs-keyword">package</span> com.company.impl;

<span class="hljs-keyword">import</span> com.company.api.UserService;
<span class="hljs-keyword">import</span> com.company.internal.UserValidator;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserValidator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserValidator</span>();
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-comment">// 实现...</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (validator.validate(user)) {
            <span class="hljs-comment">// 保存逻辑</span>
        }
    }
}

<span class="hljs-comment">// internal包：内部工具（包私有）</span>
<span class="hljs-keyword">package</span> com.company.internal;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserValidator</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 验证逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-comment">// 公共工厂</span>
<span class="hljs-keyword">package</span> com.company;

<span class="hljs-keyword">import</span> com.company.api.UserService;
<span class="hljs-keyword">import</span> com.company.impl.UserServiceImpl;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceFactory</span> {
    <span class="hljs-comment">// 公共方法返回接口类型，隐藏实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserService <span class="hljs-title function_">createUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h2 data-id="heading-25">📊 权限修饰符选择指南</h2>
<h3 data-id="heading-26"><strong>选择流程图</strong></h3>
<p>text</p>
<pre><code class="hljs language-arduino" lang="arduino">开始
  ↓
需要从外部访问吗？
  ├─ 否 → 使用 <span class="hljs-keyword">private</span>
  ↓
需要被子类访问吗？
  ├─ 否 → 需要同包访问吗？
  │      ├─ 是 → 使用 默认
  │      ↓
  │     否 → 使用 <span class="hljs-keyword">public</span>
  ↓
是 → 需要不同包子类访问吗？
        ├─ 是 → 使用 <span class="hljs-keyword">protected</span>
        ↓
       否 → 使用 默认
</code></pre>
<h3 data-id="heading-27"><strong>决策表格</strong></h3>


















































<table><thead><tr><th>场景</th><th>推荐修饰符</th><th>示例</th></tr></thead><tbody><tr><td><strong>数据字段</strong></td><td>private</td><td><code>private String name;</code></td></tr><tr><td><strong>常量</strong></td><td>public static final</td><td><code>public static final PI = 3.14;</code></td></tr><tr><td><strong>工具方法</strong></td><td>private</td><td><code>private void validate()</code></td></tr><tr><td><strong>模板方法</strong></td><td>protected</td><td><code>protected void initialize()</code></td></tr><tr><td><strong>接口方法</strong></td><td>public</td><td><code>public void save()</code></td></tr><tr><td><strong>构造器</strong></td><td>public / private</td><td><code>public User()</code> / 单例模式</td></tr><tr><td><strong>内部类</strong></td><td>private</td><td><code>private class Node</code></td></tr><tr><td><strong>测试钩子</strong></td><td>protected</td><td><code>protected void setUp()</code></td></tr></tbody></table>
<h2 data-id="heading-28">🎓 总结要点</h2>
<ol>
<li><strong>private</strong>：严格封装，仅本类可见</li>
<li><strong>默认</strong>：包级别封装，同包可见</li>
<li><strong>protected</strong>：继承友好，同包+子类可见</li>
<li><strong>public</strong>：完全开放，所有地方可见</li>
</ol>
<p><strong>核心原则</strong>：</p>
<ul>
<li><strong>最小权限原则</strong>：只开放必要的访问权限</li>
<li><strong>封装变化</strong>：使用private隐藏实现细节</li>
<li><strong>面向接口</strong>：通过public方法提供稳定接口</li>
<li><strong>继承设计</strong>：protected用于设计可扩展的框架</li>
<li><strong>包组织</strong>：合理使用包和默认权限管理模块</li>
</ul>
<p>记住：<strong>良好的访问控制是高质量代码的基础</strong>！合理的权限设置可以提高代码的安全性、可维护性和可扩展性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 - runtime-core的渲染器初始化流程]]></title>    <link>https://juejin.cn/post/7578892205291290664</link>    <guid>https://juejin.cn/post/7578892205291290664</guid>    <pubDate>2025-12-02T09:42:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578892205291290664" data-draft-id="7565100253037969460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 - runtime-core的渲染器初始化流程"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-02T09:42:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="7ayl"/> <meta itemprop="url" content="https://juejin.cn/user/2637046159511018"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 - runtime-core的渲染器初始化流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637046159511018/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    7ayl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:42:47.000Z" title="Tue Dec 02 2025 09:42:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在创建一个 Vue 3 项目时，通常会看到三个核心文件：
main.js:应用入口
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d56166750b3643f9a6a066f76cfdbc0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=hZh0S%2FS1zvYXCy51G9XqhJxn0uM%3D" alt="image.png" loading="lazy"/>
index.html:页面入口
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7040adc0a1ad4c1b9e783b73bf80bf7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=33Qlf6rLljcgGkQqjJ4p5pnRJto%3D" alt="image.png" loading="lazy"/>
App.vue: 根组件
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada39e9fd17f48b09cc6ff81d51e91c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=Wqz2cxC4FlMC1lrKA1bwAQUu4KI%3D" alt="image.png" loading="lazy"/>
本文将以这三个文件为例，简述 Vue 应用的初始化流程</p>
<h2 data-id="heading-1">流程</h2>
<p>在 main.js 中，我们导入了 <code>createApp</code> 函数和根组件 <code>App.vue</code></p>
<h4 data-id="heading-2">一、从入口开始：createApp 与 mount</h4>
<p><code>createApp(App).mount('#app')</code></p>
<p>createApp(App)调用createApp传入根组件，生成它专属的mount方法</p>
<p>.mount('#app')让createApp(App)这个应用实例挂载到根容器（id为app的盒子），</p>
<ul>
<li>mount函数内部<strong>会基于根组件App.vue生成一个虚拟节点vnode</strong></li>
<li>再<strong>调用render函数</strong>进行渲染，负责将虚拟DOM渲染到真实DOM
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ab61f6d138403f8e79ed7c838c1c1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=2EnbM6mpqEa5f6l93JsYNk4B%2F7A%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-3">二、创建虚拟节点：vnode 的结构</h4>
<p>基于根组件来创建虚拟节点vnode</p>
<p>创建出来的虚拟节点vnode属性如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c9bd792b6e483db7a84d661f8a623e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=dfuSYcpblZ8R%2B8uPGAMQvr4qh8c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">三、渲染入口：render 与 patch</h4>
<p>调用 render 函数</p>
<blockquote>
<ol>
<li>render函数只是一个渲染器的入口，负责接收接收虚拟节点和容器，开启渲染过程</li>
</ol>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb2ad920c744ceb92d89d6bbd554c6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=JH5iFZdSu2r6qY6bKb4RfSmjlxs%3D" alt="image.png" loading="lazy"/></p>
<p>可以看见render函数内部也主要是调用patch函数，</p>
<blockquote>
<ol start="2">
<li>patch()主要会根据vnode.type以及shapeFlag去判断节点属于什么类型，进而调用相应类型的处理方法processxxxx()</li>
</ol>
</blockquote>
<p>这里App是组件类型，所以用processComponent处理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e345a3aba4c4ef3a49e0b8aa4990516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=XzVEBMvQGB241fLo10kLnx3tets%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">四、处理组件：processComponent 与 mountComponent</h4>
<blockquote>
<ol start="3">
<li>不管是什么类型的节点，都会在这个时候判断，这个节点之前是否存在，是选择初始化节点mountxxx()，还是更新节点</li>
</ol>
</blockquote>
<p>由于这是组件首次渲染，调用patch传下来的第一个参数应该是null，即没有n1，</p>
<p>所以到达processComponent之后，会先进行mountComponent</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10155a2bc7ed49a9bd609747a8657305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=4nwdGBYHG9VRr0CdsD5DolIzWUI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">五、组件实例的创建与设置</h4>
<blockquote>
<ol start="4">
<li>然后进行相应的流程 mountxxx()/更新节点</li>
</ol>
</blockquote>
<p>mountComponent会先去创建 component instance对象，再调用setupComponent设置组件实例，最后调用setupRenderEffect设置渲染效果。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/219d8e710a034c5c993d335ef555e016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=M83w0EdC5UiNH4CfSwuiLvH9Z0s%3D" alt="image.png" loading="lazy"/></p>
<p>ps：也是可以粗略的看看instance对象的属性
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59f08a72d83a4e42b3fc57f46f2293df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgN2F5bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765273367&amp;x-signature=UDVbQgu6GL%2FVz2%2BjikjV%2FxNjgTo%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift ——详解Any、AnyObject、 AnyClass]]></title>    <link>https://juejin.cn/post/7578922565210226715</link>    <guid>https://juejin.cn/post/7578922565210226715</guid>    <pubDate>2025-12-02T09:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210226715" data-draft-id="7578876665696092169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift ——详解Any、AnyObject、 AnyClass "/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-02T09:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift ——详解Any、AnyObject、 AnyClass 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:36:18.000Z" title="Tue Dec 02 2025 09:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Swift 中，<code>Any</code>、<code>AnyObject</code>、 <code>AnyClass</code> 是三个不同的类型，它们用于不同的场景，代表了不同的类型和用途。</p>
<h2 data-id="heading-0">一、Any</h2>
<p><code>Any</code> 是 Swift 中可以表示任何类型的类型，包含所有类型的实例。它可以是一个普通的类型、结构体、类、元组、函数、枚举，甚至是一个 <code>Optional</code> 类型的值。</p>
<ul>
<li><code>Any</code> 可以表示任何类型的实例。</li>
<li>它是一个广泛的类型，几乎可以存放任何类型的值。</li>
<li>使用时需要进行类型转换（Type Casting）才能访问原本的类型。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// 例</span>
     <span class="hljs-keyword">var</span> a : <span class="hljs-keyword">Any</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
     a <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
     a <span class="hljs-operator">=</span> <span class="hljs-number">3.2</span>
     a <span class="hljs-operator">=</span> [<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
     a <span class="hljs-operator">=</span> <span class="hljs-type">NSObject</span>()
     <span class="hljs-built_in">print</span>(a)
</code></pre>
<h2 data-id="heading-1">二、AnyObject</h2>
<p><code>AnyObject</code>  是Any的子集， AnyObject是Swift 中表示<strong>所有类类型</strong>（Class Types）的类型。它只允许存储对象引用类型的值。它不能存储结构体、枚举或其他非类类型的值。</p>
<ul>
<li><code>AnyObject</code> 可以表示任何类类型的实例。</li>
<li>它只能用于类实例，不能用于结构体、枚举或其他值类型。</li>
<li>对 <code>AnyObject</code> 类型的值进行操作时，通常需要进行类型转换才能使用其特定的属性和方法。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Persion</span>{
    
}
     <span class="hljs-keyword">var</span> p : <span class="hljs-type">AnyObject</span>
     p <span class="hljs-operator">=</span> <span class="hljs-type">Persion</span>()
     <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> p <span class="hljs-operator">=</span> p <span class="hljs-keyword">as?</span> <span class="hljs-type">Persion</span>{
     <span class="hljs-built_in">print</span>(p)
 
</code></pre>
<p><code>AnyObject</code> 用于存储<strong>类实例</strong>，例如 <code>NSObject</code> 或任何继承自类的对象。它不支持值类型或非类类型。</p>
<h2 data-id="heading-2">三、AnyClass</h2>
<p><code>AnyClass</code> 是一个表示<strong>类类型</strong>（Class Type）的特殊类型。它用于引用类类型本身，而不是类的实例。通过 <code>AnyClass</code> 可以访问类的元信息（比如元类）。</p>
<ul>
<li><code>AnyClass</code> 代表类类型本身，而不是类的实例。</li>
<li>用来存储类类型（如 <code>MyClass.self</code>）的引用。</li>
<li>通常用于动态地操作类类型或元类的元信息。</li>
</ul>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">let</span> classType: <span class="hljs-type">AnyClass</span> <span class="hljs-operator">=</span> <span class="hljs-type">Persion</span>.<span class="hljs-keyword">self</span>
<span class="hljs-built_in">print</span>(classType) <span class="hljs-comment">// Persion</span>
</code></pre>
<p><code>AnyClass</code> 表示类的类型，不是类的实例。它通常用于处理类类型的元信息（如反射、类检查等）。</p>
<h4 data-id="heading-3">总结</h4>
<ul>
<li><code>Any</code> 是最通用的类型，可以表示任何类型的实例。</li>
<li><code>AnyObject</code> 仅用于类类型的实例，不能存储值类型。</li>
<li><code>AnyClass</code> 用于表示类类型本身，用于获取类的元信息。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究]]></title>    <link>https://juejin.cn/post/7578889811333513257</link>    <guid>https://juejin.cn/post/7578889811333513257</guid>    <pubDate>2025-12-02T09:54:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811333513257" data-draft-id="7578889811333496873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T09:54:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="00后程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1159358440539900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 上架 4.3，重复 App 审核条款的真实逻辑与团队应对策略研究
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1159358440539900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    00后程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:54:20.000Z" title="Tue Dec 02 2025 09:54:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 App Store 审核条款中，<em>4.3 – Spam</em> 是让许多团队头疼的拒审代码——中文常被描述为“重复 App”“功能过于雷同”“模板化应用”等。相比其他技术类拒审（如 2.1、5.1.1），4.3 属于典型的“审核判断型”条款：
<strong>不是应用崩溃，也不是隐私缺失，而是苹果认为“这款应用没提供足够独特价值”。</strong></p>
<p>对跨端团队、运营团队、多版本产品线以及使用 uni-app/H5 的团队来说，4.3 是最容易遇到的合规风险之一。本文尝试从更理性的角度，分析 4.3 的真实触发逻辑，并结合不同工具链、开发模式给出可执行的规避策略。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、4.3 不是重复上架，是价值不足</strong></h2>
<p>从大量实际案例看，4.3 常见于如下场景：</p>
<ul>
<li>同一开发者账号短时间提交多个结构相似的 App</li>
<li>App 的页面结构近似网页外壳（WebView 包壳）</li>
<li>大面积使用模板式框架（跨端项目更易触发）</li>
<li>应用内容缺乏动态性，无法展示真实差异化</li>
<li>应用看起来像“分身”“多开”“子版本”</li>
<li>营销类 App 仅更换文案与配色</li>
<li>企业内部工具被改包后提交公开商店</li>
</ul>
<p>因此，4.3 并不等于“复制 App”，而更像这样的审核逻辑：</p>
<blockquote>
<p>“这款应用与您账号下的其他 App 或市场上同类应用相比，没有足够区分度。”</p>
</blockquote>
<p>换句话说，<strong>苹果关注的是“是否值得占用 App Store 一席之地”。</strong></p>
<hr/>
<h2 data-id="heading-1"><strong>二、为什么跨端项目（如 uni-app/H5/低代码）更容易被判 4.3？</strong></h2>
<p>主要原因不是框架本身，而是呈现方式：</p>
<h3 data-id="heading-2"><strong>1. 页面结构差异度低</strong></h3>
<p>跨端项目的 UI 通常更一致、组件风格更统一，应用间差异容易收敛。</p>
<h3 data-id="heading-3"><strong>2. WebView 架构容易被误判为“壳应用”</strong></h3>
<p>如果首页加载 H5 且结构雷同，审核员可能认为缺乏原生体验。</p>
<h3 data-id="heading-4"><strong>3. 多产品线共用同一代码基础</strong></h3>
<p>多个项目使用相同模板，会让应用外观高度一致。</p>
<h3 data-id="heading-5"><strong>4. 内容变化不足</strong></h3>
<p>如果 App 依赖外部内容，但上线版本内容量少，审核无法看到差异。</p>
<p>因此，跨端项目不仅要技术能跑，还要呈现足够“原生级别”的价值。</p>
<hr/>
<h2 data-id="heading-6"><strong>三、从构建与工具链角度看，4.3 并不是上传方式问题</strong></h2>
<p>不少团队误以为“是不是因为使用某种上传工具导致触发 4.3”，但从工程经验来看：</p>
<ul>
<li>Transporter</li>
<li>Xcode Organizer</li>
<li>跨平台命令行工具（如开心上架）</li>
<li>CI/CD 自动上传</li>
</ul>
<p>这些上传方式只是“把 IPA 送到苹果”，并不会影响 4.3 的审核逻辑。</p>
<p>实际原因通常在于：</p>
<ul>
<li>应用内容不足</li>
<li>UI 结构过于模板化</li>
<li>同账号 App 过多且类似</li>
<li>应用缺少“使用理由”</li>
<li>未展示核心价值</li>
</ul>
<p>因此，上传工具是流程选择，不会影响审核判断。</p>
<hr/>
<h2 data-id="heading-7"><strong>四、被判 4.3 的常见信号：审核时长与提问方式</strong></h2>
<p>大量案例显示，4.3 审核通常具有以下特征：</p>
<h3 data-id="heading-8"><strong>1. 审核时间明显拉长</strong></h3>
<p>审核会停留在“正在审核”阶段 2–5 天，期间没有明显进度变化。</p>
<h3 data-id="heading-9"><strong>2. 审核员可能发出“应用的具体用途是什么？”</strong></h3>
<p>这类提问意味着审核员需要确认 App 是否具有独立价值。</p>
<h3 data-id="heading-10"><strong>3. 可能要求更多示例内容</strong></h3>
<p>尤其是内容型应用。</p>
<p>这些信号出现时，应尽快补全说明与内容。</p>
<hr/>
<h2 data-id="heading-11"><strong>五、团队可执行的反制策略：重点在“展示价值”而非“技术改造”</strong></h2>
<h3 data-id="heading-12"><strong>策略 1：提供清晰的审核说明（关键）</strong></h3>
<p>说明内容包括：</p>
<ul>
<li>应用核心用户是谁</li>
<li>使用场景是什么</li>
<li>与同类应用相比有什么独特价值</li>
<li>审核流程如何进入核心功能</li>
<li>动态内容从何获取</li>
</ul>
<p>审核说明越完整，4.3 风险越低。</p>
<hr/>
<h3 data-id="heading-13"><strong>策略 2：增加明显区分度</strong></h3>
<p>尤其是团队提交多款 App 时。</p>
<p>改进方向：</p>
<ul>
<li>不同配色</li>
<li>不同布局</li>
<li>不同功能入口</li>
<li>不同图标风格</li>
<li>提供差异化截图</li>
</ul>
<p>让审核员“一眼看出不是同一套壳”。</p>
<hr/>
<h3 data-id="heading-14"><strong>策略 3：原生结构化呈现</strong></h3>
<p>如果是 uni-app/H5 项目，可以：</p>
<ul>
<li>增加原生 TabBar</li>
<li>增加原生导航</li>
<li>把关键页面做原生化呈现（首页/登录）</li>
<li>保留 WebView，但让整体更像原生 App</li>
</ul>
<p>审核员非常看重“原生级别体验”。</p>
<hr/>
<h3 data-id="heading-15"><strong>策略 4：在提审前充实内容</strong></h3>
<p>尤其是内容型 App：</p>
<ul>
<li>列表数量</li>
<li>详情页丰富度</li>
<li>交互流程完整性</li>
</ul>
<p>初版内容越少，越容易被判定为“壳”。</p>
<hr/>
<h3 data-id="heading-16"><strong>策略 5：避免同账号同时提交多个版本</strong></h3>
<p>短时间内提交相似应用是触发 4.3 的高危行为。</p>
<hr/>
<h2 data-id="heading-17"><strong>六、团队级流程建议：把“4.3 规避”当作上架环节之一</strong></h2>
<p>不少团队在提审前会引入一次“反 4.3 检查”：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span>. 应用是否具有明确价值？
<span class="hljs-selector-tag">B</span>. UI 是否过度模板化？
C. 是否依赖 <span class="hljs-selector-tag">H5</span>，并且缺少原生结构？
D. 内容是否足够充实？
E. 是否与团队现有 App 过于相似？
</code></pre>
<p>这套检查经常能在提审前发现潜在风险。</p>
<hr/>
<h2 data-id="heading-18"><strong>4.3 的本质是价值判断，而不是技术问题</strong></h2>
<p>从大量案例总结来看，4.3 是苹果针对“内容重复、价值不足”的保护机制。
它既不是技术 bug，也不是上传方式问题，而是产品形态问题。</p>
<p>解决思路只有一个核心：</p>
<p><strong>让审核员相信你的应用具有不可替代的存在理由。</strong></p>
<p>做到这一点，4.3 就不再是难题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测]]></title>    <link>https://juejin.cn/post/7578922565210275867</link>    <guid>https://juejin.cn/post/7578922565210275867</guid>    <pubDate>2025-12-02T09:48:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565210275867" data-draft-id="7578705123209412651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-02T09:48:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeekPMAlex"/> <meta itemprop="url" content="https://juejin.cn/user/2326992765334446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 LangGraph v1.0 构建生产级 RAG：高吞吐、低幻觉、全链路可观测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2326992765334446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeekPMAlex
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:48:49.000Z" title="Tue Dec 02 2025 09:48:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>传统 RAG 实现通常为线性流程：</p>
<pre><code class="hljs language-python" lang="python">docs = retriever.invoke(query)
answer = llm.invoke(prompt + docs)
</code></pre>
<p>该模式在原型阶段有效，但在生产环境中存在以下问题：</p>
<ul>
<li>幻觉风险高（LLM 在上下文不足时生成虚构内容）；</li>
<li>鲁棒性差（单点失败导致整个请求中断）；</li>
<li>不可观测（无法定位问题是检索召回不足还是生成逻辑错误）。</li>
</ul>
<p>LangGraph v1.0 提供状态化工作流编排能力，将 RAG 建模为有向图，支持并行、重试、持久化与全链路追踪，适用于生产部署。</p>
<h2 data-id="heading-1">架构设计</h2>
<p>将 RAG 拆解为以下节点：</p>
<pre><code class="hljs language-css" lang="css">用户查询
   ↓
<span class="hljs-selector-attr">[并行检索]</span> → 内部知识库 | Web 搜索 | 业务 API
   ↓
<span class="hljs-selector-attr">[合并去重]</span> → 统一候选集（去重、加权、时间衰减）
   ↓
<span class="hljs-selector-attr">[Reranker]</span> → 精筛 <span class="hljs-attribute">top</span>-k 相关片段
   ↓
<span class="hljs-selector-attr">[Generator]</span> → 引用感知生成
   ↓
<span class="hljs-selector-attr">[Eval/Trace]</span> → 上报 LangSmith
</code></pre>
<p>每个节点职责单一，支持独立优化、监控与故障隔离。</p>
<h2 data-id="heading-2">核心能力</h2>
<h3 data-id="heading-3">1. 多源并行检索</h3>
<p>使用 LangGraph 的多入口边实现并发分支：</p>
<pre><code class="hljs language-python" lang="python">builder.add_edge(START, <span class="hljs-string">"kb_retrieve"</span>)
builder.add_edge(START, <span class="hljs-string">"web_search"</span>)
builder.add_edge(START, <span class="hljs-string">"api_fetch"</span>)

builder.add_edge(<span class="hljs-string">"kb_retrieve"</span>, <span class="hljs-string">"merge"</span>)
builder.add_edge(<span class="hljs-string">"web_search"</span>, <span class="hljs-string">"merge"</span>)
builder.add_edge(<span class="hljs-string">"api_fetch"</span>, <span class="hljs-string">"merge"</span>)
</code></pre>
<p><code>merge</code> 节点聚合结果，执行内容去重（基于哈希或元数据）、来源权重分配和时效性调整。</p>
<h3 data-id="heading-4">2. Reranker 抑制幻觉</h3>
<p>向量检索召回的 top-k 结果常包含噪声。引入 reranker 节点进行精排：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_node</span>(<span class="hljs-params">state: RAGState</span>):
    scores = cross_encoder.predict(
        query=state[<span class="hljs-string">"query"</span>],
        documents=[d.page_content <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> state[<span class="hljs-string">"candidates"</span>]]
    )
    top_docs = select_top_n(state[<span class="hljs-string">"candidates"</span>], scores, n=<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"top_docs"</span>: top_docs}
</code></pre>
<p>实测可减少 80% 上下文长度，显著降低幻觉率。</p>
<h3 data-id="heading-5">3. RetryPolicy 与持久化 Checkpoint</h3>
<p>为外部依赖节点配置重试策略：</p>
<pre><code class="hljs language-python" lang="python">retry_policy=RetryPolicy(max_attempts=<span class="hljs-number">3</span>, backoff_factor=<span class="hljs-number">2.0</span>)
</code></pre>
<p>启用持久化 checkpoint 支持中断恢复：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.sqlite <span class="hljs-keyword">import</span> SqliteSaver
checkpointer = SqliteSaver.from_conn_string(<span class="hljs-string">"rag.db"</span>)
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)
</code></pre>
<p>适用于长流程、人工审核或高可用场景。</p>
<h3 data-id="heading-6">4. 分层缓存优化成本</h3>
<ul>
<li><strong>Provider Prompt Cache</strong>：对静态 system prompt 启用模型提供商缓存（如 AWS Bedrock <code>cachePoint</code>）；</li>
<li><strong>Query-Level Cache</strong>：使用 Redis 缓存 <code>(query_hash, doc_ids) → answer</code>，避免重复计算。</li>
</ul>
<h3 data-id="heading-7">5. LangSmith 全链路追踪</h3>
<p>上报以下数据用于评估：</p>
<ul>
<li>原始查询；</li>
<li>检索文档 ID 与相似度分数；</li>
<li>Reranker 打分结果；</li>
<li>最终生成内容。</li>
</ul>
<p>通过 LangSmith 计算两类关键指标：</p>
<ul>
<li><strong>幻觉率</strong>：生成内容中未被检索结果支持的陈述比例；</li>
<li><strong>错误率</strong>：回答与事实不符或未正确响应问题的比例。</li>
</ul>
<p>二者需分别监控：所有幻觉均为错误，但错误不一定是幻觉（如答非所问、逻辑错误）。</p>
<h2 data-id="heading-8">完整实现示例</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing_extensions <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> RetryPolicy
<span class="hljs-keyword">from</span> langgraph.checkpoint.sqlite <span class="hljs-keyword">import</span> SqliteSaver

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGState</span>(TypedDict, total=<span class="hljs-literal">False</span>):
    query: <span class="hljs-built_in">str</span>
    candidates: <span class="hljs-built_in">list</span>
    top_docs: <span class="hljs-built_in">list</span>
    answer: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_node</span>(<span class="hljs-params">state: RAGState</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"candidates"</span>: vectorstore.similarity_search(state[<span class="hljs-string">"query"</span>], k=<span class="hljs-number">50</span>)}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_node</span>(<span class="hljs-params">state: RAGState</span>):
    top_docs = reranker.select_top_k(state[<span class="hljs-string">"candidates"</span>], state[<span class="hljs-string">"query"</span>], k=<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"top_docs"</span>: top_docs}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_node</span>(<span class="hljs-params">state: RAGState</span>):
    context = <span class="hljs-string">"\n\n"</span>.join(
        <span class="hljs-string">f"[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{d.page_content}</span>"</span> 
        <span class="hljs-keyword">for</span> i, d <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(state[<span class="hljs-string">"top_docs"</span>], <span class="hljs-number">1</span>)
    )
    prompt = <span class="hljs-string">f"仅使用以下片段回答，并标注引用编号：\n<span class="hljs-subst">{context}</span>\n\n问题: <span class="hljs-subst">{state[<span class="hljs-string">'query'</span>]}</span>"</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: llm.invoke(prompt)}

<span class="hljs-comment"># 构建图</span>
builder = StateGraph(RAGState)
builder.add_node(<span class="hljs-string">"retrieve"</span>, retrieve_node, retry_policy=RetryPolicy(max_attempts=<span class="hljs-number">3</span>))
builder.add_node(<span class="hljs-string">"rerank"</span>, rerank_node)
builder.add_node(<span class="hljs-string">"generate"</span>, generate_node)

builder.add_edge(START, <span class="hljs-string">"retrieve"</span>)
builder.add_edge(<span class="hljs-string">"retrieve"</span>, <span class="hljs-string">"rerank"</span>)
builder.add_edge(<span class="hljs-string">"rerank"</span>, <span class="hljs-string">"generate"</span>)
builder.add_edge(<span class="hljs-string">"generate"</span>, END)

<span class="hljs-comment"># 编译并启用持久化</span>
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=SqliteSaver.from_conn_string(<span class="hljs-string">"checkpoints.db"</span>))

<span class="hljs-comment"># 调用</span>
result = graph.invoke({<span class="hljs-string">"query"</span>: <span class="hljs-string">"如何实现单点登录？"</span>})
<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"answer"</span>])
</code></pre>
<h2 data-id="heading-9">工程建议</h2>
<ul>
<li><strong>HyDE（Hypothetical Document Embeddings）</strong>：对模糊查询，先生成假设文档再检索，提升召回；</li>
<li><strong>时间感知检索</strong>：对时效性内容引入时间衰减因子；</li>
<li><strong>人类审查节点</strong>：在高风险领域插入人工审核环节；</li>
<li><strong>流式输出</strong>：启用 token-by-token streaming 提升用户体验与实时监控能力。</li>
</ul>
<h2 data-id="heading-10">总结</h2>
<p>LangGraph 将 RAG 从脚本升级为可运维系统。通过节点化、状态持久化、并行编排与全链路观测，可构建高可靠、低幻觉、易迭代的生产级 RAG 架构。RAG 的竞争已进入工程化阶段，LangGraph 是当前最优的编排基础设施之一。</p>
<h2 data-id="heading-11">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/" ref="nofollow noopener noreferrer">LangGraph 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsmith.langchain.com%2F" target="_blank" title="https://smith.langchain.com/" ref="nofollow noopener noreferrer">LangSmith</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexplodinggradients%2Fragas" target="_blank" title="https://github.com/explodinggradients/ragas" ref="nofollow noopener noreferrer">RAGAS 评估框架</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战]]></title>    <link>https://juejin.cn/post/7578889811332988969</link>    <guid>https://juejin.cn/post/7578889811332988969</guid>    <pubDate>2025-12-02T08:37:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811332988969" data-draft-id="7578968420042457151" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-02T08:37:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七条猫"/> <meta itemprop="url" content="https://juejin.cn/user/564503296630944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1构建AI智能文档助手：TRAE SOLO驱动下的架构决策与MCP协议实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/564503296630944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七条猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:37:32.000Z" title="Tue Dec 02 2025 08:37:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在参与公司内部“AI提效”项目时，我接到一个看似简单却极具挑战的任务：<strong>从零搭建一个能自动解析用户上传的PDF/Word文档，并生成结构化摘要与问答接口的AI应用</strong>。面对技术选型的迷雾、模型服务的复杂性以及快速交付的压力，我一度陷入“先写代码还是先画架构图”的纠结中。</p>
<p>直到我将 TRAE SOLO 引入整个开发流程——它不仅帮我厘清了架构思路，更通过 SOLO Coder 自动生成关键组件，甚至指导我采用 MCP（Model Communication Protocol）协议统一模型接入。以下是我借助 TRAE SOLO 完成 AI 应用从0到1落地的实战复盘。</p>
<hr/>
<h3 data-id="heading-0">一、需求模糊？让 SOLO Coder 生成初始架构文档</h3>
<p>项目初期，产品经理只给了两句话：“用户上传文档，AI 能回答问题并输出摘要。”</p>
<p>我打开 TRAE SOLO，输入：</p>
<blockquote>
<p>“设计一个支持 PDF/Word 解析、基于大模型生成摘要和问答的后端服务，要求模块清晰、可扩展、支持多模型切换。”</p>
</blockquote>
<p>不到10秒，SOLO Coder 返回了一份完整的 <code>ARCHITECTURE.md</code> 草稿，包含：</p>
<ul>
<li>技术栈建议：FastAPI + PyPDF2/docx2txt + LangChain（可选）+ Redis 缓存</li>
<li>模块划分：Document Ingestion → Text Extraction → LLM Interface → API Layer</li>
<li>初步接口定义（含 OpenAPI 示例）</li>
</ul>
<p>更重要的是，它还生成了项目脚手架代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># main.py (由 TRAE SOLO 自动生成)</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, UploadFile
<span class="hljs-keyword">from</span> services.ingestion <span class="hljs-keyword">import</span> extract_text
<span class="hljs-keyword">from</span> services.llm <span class="hljs-keyword">import</span> generate_summary, answer_question

app = FastAPI(title=<span class="hljs-string">"AI Doc Assistant"</span>)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_doc</span>(<span class="hljs-params">file: UploadFile</span>):
    text = <span class="hljs-keyword">await</span> extract_text(file)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"doc_id"</span>: <span class="hljs-string">"uuid"</span>, <span class="hljs-string">"text_preview"</span>: text[:<span class="hljs-number">200</span>]}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/summary/{doc_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_summary</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"summary"</span>: generate_summary(doc_id)}

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ask"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask_question</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span>, question: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"answer"</span>: answer_question(doc_id, question)}
</code></pre>
<p>这份“可运行的文档”让我和团队在第一天就对齐了技术路径，避免了无谓争论。</p>
<hr/>
<h3 data-id="heading-1">二、模型选型困境：TRAE SOLO 帮我决策是否自建推理服务</h3>
<p>接下来的问题是：<strong>用 OpenAI API 还是部署开源模型？</strong></p>
<p>我向 TRAE SOLO 提问：</p>
<blockquote>
<p>“在日均请求 &lt; 1000、响应延迟要求 &lt; 3s、预算有限的场景下，对比使用 OpenAI GPT-4 vs. 自建 Llama-3-8B（通过 vLLM），哪种更合适？”</p>
</blockquote>
<p>TRAE SOLO 综合成本、运维复杂度、冷启动延迟等因素，给出结论：</p>
<blockquote>
<p><strong>初期推荐 OpenAI + 备用开源模型方案，通过统一协议抽象模型差异</strong>。</p>
</blockquote>
<p>于是，我决定引入 <strong>MCP（Model Communication Protocol）</strong> ——一个轻量级、标准化的大模型调用协议，用于屏蔽底层模型实现。</p>
<p>TRAE SOLO 随即为我生成了 MCP 客户端模板：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># mcp_client.py (由 TRAE SOLO 生成并优化)</span>
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_endpoint: <span class="hljs-built_in">str</span>, api_key: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        self.endpoint = model_endpoint
        self.headers = {<span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{api_key}</span>"</span>} <span class="hljs-keyword">if</span> api_key <span class="hljs-keyword">else</span> {}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        payload = {
            <span class="hljs-string">"prompt"</span>: prompt,
            <span class="hljs-string">"model"</span>: <span class="hljs-string">"default"</span>,
            <span class="hljs-string">"parameters"</span>: params <span class="hljs-keyword">or</span> {<span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">512</span>, <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.3</span>}
        }
        resp = requests.post(<span class="hljs-string">f"<span class="hljs-subst">{self.endpoint}</span>/v1/completions"</span>, json=payload, headers=self.headers)
        resp.raise_for_status()
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">"choices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"text"</span>]
</code></pre>
<p>通过 MCP，无论是调用 OpenAI、Claude 还是本地 vLLM 服务，上层业务代码完全无需修改：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 config.yaml 中切换模型</span>
llm:
  provider: openai   <span class="hljs-comment"># 或 local_vllm</span>
  endpoint: https://api.openai.com
  api_key: sk-xxxx

<span class="hljs-comment"># services/llm.py</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> get_llm_config
<span class="hljs-keyword">from</span> mcp_client <span class="hljs-keyword">import</span> MCPClient

client = MCPClient(**get_llm_config())

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_summary</span>(<span class="hljs-params">doc_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    text = get_cached_text(doc_id)
    prompt = <span class="hljs-string">f"请用中文总结以下文档：\n\n<span class="hljs-subst">{text}</span>"</span>
    <span class="hljs-keyword">return</span> client.generate(prompt)
</code></pre>
<hr/>
<h3 data-id="heading-2">三、踩坑与避坑：TRAE SOLO 成为我的“架构哨兵”</h3>
<p>在测试阶段，我们发现两个严重问题：</p>
<ol>
<li><strong>长文档导致 Token 超限，费用飙升</strong></li>
<li><strong>OpenAI 服务偶尔不可用，系统直接崩溃</strong></li>
</ol>
<p>我立刻向 TRAE SOLO 求助：</p>
<blockquote>
<p>“如何优化长文本处理？如何实现模型服务的容灾降级？”</p>
</blockquote>
<p>它不仅建议：</p>
<ul>
<li>使用 <strong>滑动窗口分段摘要 + 向量缓存</strong></li>
<li>在 MCP 层增加 <strong>fallback 机制</strong></li>
</ul>
<p>还直接生成了改进代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># mcp_client.py 增强版（TRAE SOLO 建议）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResilientMCPClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, primary: MCPClient, fallback: MCPClient = <span class="hljs-literal">None</span></span>):
        self.primary = primary
        self.fallback = fallback

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> self.primary.generate(prompt, params)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> self.fallback:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Primary failed: <span class="hljs-subst">{e}</span>, falling back to backup model"</span>)
                <span class="hljs-keyword">return</span> self.fallback.generate(prompt, params)
            <span class="hljs-keyword">raise</span>
</code></pre>
<p>同时，它提醒我在 <code>extract_text</code> 中加入文本分块逻辑，并自动插入缓存装饰器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-meta">@lru_cache(<span class="hljs-params">maxsize=<span class="hljs-number">128</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chunked_summarize</span>(<span class="hljs-params">text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-comment"># 分段摘要 + 最终聚合</span>
    chunks = [text[i:i+<span class="hljs-number">3000</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(text), <span class="hljs-number">3000</span>)]
    summaries = [client.generate(<span class="hljs-string">f"简要总结：<span class="hljs-subst">{c}</span>"</span>) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> chunks]
    <span class="hljs-keyword">return</span> client.generate(<span class="hljs-string">"综合以下摘要，生成最终报告："</span> + <span class="hljs-string">"\n"</span>.join(summaries))
</code></pre>
<p>这些“即时架构补丁”，让我们在48小时内完成了生产级加固。</p>
<hr/>
<h3 data-id="heading-3">四、成果与反思</h3>
<p>最终，该 AI 文档助手上线后：</p>
<ul>
<li>平均响应时间 &lt; 2.1s</li>
<li>模型调用成本降低 40%（通过缓存 + fallback 减少无效请求）</li>
<li>架构支持无缝切换至私有化部署（仅需修改 config.yaml）</li>
</ul>
<p>更重要的是，<strong>TRAE SOLO 让我从“写功能的人”转变为“设计系统的人”</strong> 。它不是替代我的判断，而是将我的模糊意图转化为可执行、可演进的架构蓝图。</p>
<hr/>
<h3 data-id="heading-4">结语</h3>
<p>在 AI 应用爆炸式增长的今天，工具的价值不在于“写多少代码”，而在于“减少多少错误决策”。TRAE SOLO 正是这样一位沉默的架构协作者——</p>
<p>它用 SOLO Coder 将需求翻译为结构，</p>
<p>用 MCP 协议统一模型世界的碎片，</p>
<p>用实时反馈筑起工程化的护城河。</p>
<p>从0到1的路上，感谢 TRAE SOLO，让我敢想、敢试、更敢交付。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果iOS应用上架App Store必看指南与规则]]></title>    <link>https://juejin.cn/post/7579096485355192370</link>    <guid>https://juejin.cn/post/7579096485355192370</guid>    <pubDate>2025-12-02T10:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355192370" data-draft-id="7578922565210357787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果iOS应用上架App Store必看指南与规则"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-02T10:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果iOS应用上架App Store必看指南与规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:02:02.000Z" title="Tue Dec 02 2025 10:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果App上架，必看指南！</p>
<p>应用内不得包含检查更新功能：自2015年3月起，所有包含检查更新功能的App将被拒绝上架。</p>
<p>第三方登录检测：接入第三方登录时，需检测是否安装了第三方客户端。若未安装，采用隐藏登录按钮的方式可能被审核拒绝。QQ和微博提供了web登录方式，未安装时需允许用户使用webview登录，因为苹果条款中声明不允许iOS应用的正常使用依赖另一个App。</p>
<p>禁止采集未用于广告的IDFA：从2014年2月起，采集设备IDFA但应用没有广告功能的会被拒。</p>
<p>Xcode配置：在Xcode中，sign code要选择ios develop；当打包了valid包出错时，不能直接再次打包，要改一下general中的build值；general中选择低版本iOS系统时需注意，如选择11.0版本可能导致11.0版本以下的苹果手机无法安装；info中的文字提示需说明具体用途，不然提交审核会被拒绝，同时人为增加一个合规证明的key-value。</p>
<p>App Store信息：名称要与config.xml中的一致；屏幕快照可以使用Xcode中的模拟器进行截图，对于iPhone，必须提供用于6.5英寸iPhone Xs Max和5.5英寸设备的截屏，对于iPad，必须提供用于12.9英寸iPad Pro（第2代）和12.9英寸iPad Pro（第3代）的截屏。上传至多三个App预览和至多十张截屏，截屏必须为JPG或PNG格式且采用RGB色彩空间，App预览必须为M4V、MP4或MOV格式且不能超过500MB。</p>
<p>使用AppUploader可以简化截图上传流程，支持批量上传应用截图和本地化信息，提高效率。</p>
<p>审核周期与规定：苹果上架审核周期长，需确保遵循《App Store审查指南》中的所有规定，优化应用的元数据，确保应用的标题、描述、关键词、截图和预览视频能够准确反映应用的核心功能和特点。应用应在各种设备和iOS版本上充分测试，确保无重大Bug或性能问题。明确应用的定价和付款策略，处理好用户隐私和数据，遵循Apple的隐私指南，准备隐私政策，并在App Store Connect中正确标注应用的数据使用情况。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座]]></title>    <link>https://juejin.cn/post/7578889811333578793</link>    <guid>https://juejin.cn/post/7578889811333578793</guid>    <pubDate>2025-12-02T10:02:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578889811333578793" data-draft-id="7578968420042686527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座"/> <meta itemprop="keywords" content="Agent,Serverless"/> <meta itemprop="datePublished" content="2025-12-02T10:02:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T10:02:27.000Z" title="Tue Dec 02 2025 10:02:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：靖苏</p>
<p>在 AI Agent 应用加速落地的今天，开发者和企业普遍面临三大核心痛点：<strong>部署成本高、运维复杂度高、资源利用率低</strong>。为应对这些挑战，AI Agent 与云原生、Serverless 架构的深度融合正成为行业新趋势。我们很高兴地宣布，AgentScope 正式集成基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算</a>（Function Compute, FC）的全新 Serverless 运行时，为多智能体应用提供“按需启动、毫秒弹性、零运维”的新一代运行底座。</p>
<h2 data-id="heading-0">AgentScope 是什么？</h2>
<p>AgentScope <strong>[</strong> <strong>1]</strong> 是一个开源的多智能体应用开发框架，面向构建可观察、可控制、可扩展的 AI 智能体系统。其核心设计原则是<strong>对开发者完全透明</strong>：所有提示工程、模型调用、智能体行为及工作流编排均显式暴露，避免隐式逻辑或深度封装。</p>
<p>该框架拥有以下特性：</p>
<ul>
<li><strong>透明性优先：</strong> 所有内部状态、消息传递路径、工具调用链路和模型交互过程均可追踪与审计，确保行为可解释、可调试。</li>
<li><strong>实时介入：</strong> 实现 ReAct 智能体，原生支持任务执行过程中的实时中断与自定义中断处理逻辑，允许用户随时中断智能体的回复，介入智能体的执行，适用于需要人工干预或动态策略调整的场景。</li>
<li><strong>增强智能能力：</strong> 提供统一的工具管理接口、长期记忆控制机制以及智能化 RAG（检索增强生成）支持，提升智能体的上下文感知与知识利用能力。</li>
<li><strong>模型无关架构：</strong> 抽象统一的模型接入层允许同一套智能体逻辑无缝切换不同大语言模型（如 GPT、Claude、通义千问、Llama 系列等），降低模型迁移成本。</li>
<li><strong>模块化“乐高式”设计：</strong> 智能体、工具、提示模板、记忆模块、工作流节点等组件高度解耦，支持独立开发、组合复用与灵活替换。</li>
<li><strong>原生多智能体支持：</strong> 采用显式消息传递机制与声明式工作流编排，明确表达智能体间的协作关系，避免隐式调度带来的不可控性。</li>
<li><strong>高度可定制：</strong> 支持对工具链、提示策略、通信协议、第三方库集成及可视化界面进行深度定制，适配从原型验证到生产部署的全周期需求。</li>
</ul>
<p>AgentScope 旨在为开发者提供一个既具备工程严谨性，又保持足够灵活性的智能体开发基础设施，推动多智能体系统从实验走向规模化落地。自开源以来，AgentScope 已获得社区广泛认可，GitHub Star 数突破 <strong>14,000+</strong>。</p>
<h2 data-id="heading-1">当前 Agent 运行时的挑战</h2>
<p>AgentScope Runtime <strong>[</strong> <strong>2]</strong> 是一个面向生产环境的智能体运行时框架，聚焦于两大核心问题：<strong>高效、可扩展的智能体部署与安全、隔离的 Sandbox 工具执行</strong>。该运行时提供上下文管理（包括长短期记忆与外部知识库集成）和多层级沙箱基础设施，构成一套框架无关的底层支撑系统，可与主流开源智能体框架或自定义实现无缝协同。其设计目标是为服务级智能体应用提供具备完整可观测性、强安全性与便捷部署能力的基础运行环境。</p>
<p>AgentScope Runtime实现了双核心架构：</p>
<ul>
<li><strong>智能体部署运行时（Engine）：</strong> 提供智能体生命周期管理、会话状态维护、上下文存储（短期对话历史与长期记忆）以及外部知识库接入能力，并集成沙箱环境调度服务，支撑高并发、多会话的智能体服务部署。</li>
<li><strong>工具执行运行时（Sandbox）：</strong> 基于隔离容器构建的安全执行环境，支持智能体调用各类工具操作，包括文件系统访问、浏览器自动化、GUI 交互及 MCP（Model Context Protocol）工具集成，确保所有副作用行为被严格限制在沙箱边界内，杜绝对宿主系统的潜在风险。</li>
</ul>
<p>目前，AgentScope 的主流部署模式依赖 <strong>Docker + Kubernetes</strong> 组合。该方案在功能完备性和集群管理能力上表现优异，但在实际落地 AI Agent 应用时，暴露出若干结构性瓶颈：</p>
<ul>
<li><strong>持续运行带来固定成本：</strong> 容器实例需长期驻留内存以维持智能体状态和会话上下文，即使在无请求的空闲时段仍持续计费，导致显著的资源浪费，尤其对间歇性、事件驱动型任务极不友好。</li>
<li><strong>静态资源分配缺乏弹性：</strong> 资源配额（CPU、内存）通常按预估峰值设定，难以动态适配真实负载。在流量突发时可能因资源不足导致响应延迟或失败；而在低峰期则大量计算资源闲置，利用率低下。</li>
<li><strong>高运维复杂度形成使用门槛：</strong> 部署和维护一套生产级 K8s 集群涉及网络策略配置、服务发现、日志收集、监控告警、自动扩缩容（HPA）等多项云原生技能，对中小团队、独立开发者或非基础设施背景的研究人员构成显著障碍。</li>
</ul>
<p>这些限制使得许多具备潜力的 Agent 应用停留在实验阶段，难以实现低成本、高可用、快速迭代的规模化部署。</p>
<p>为系统性解决上述问题，AgentScope 正式推出基于<strong>阿里云函数计算（Function Compute, FC）</strong> 构建的 <strong>Serverless 运行时</strong>。该运行时针对 AI Agent 的典型工作负载（如会话保持、工具调用、状态依赖）进行深度优化，在保留功能完整性的同时，彻底重构资源使用与运维模型。</p>
<h3 data-id="heading-2">Serverless 运行时的核心优势：</h3>
<p><strong>✅ 按量付费，成本可精细化控制</strong></p>
<p>计费粒度精确至毫秒级函数执行时间与内存消耗，空闲期间零费用。对于低频调用或突发型 Agent 任务，可有效降低成本。</p>
<p><strong>✅ 毫秒级弹性伸缩，自动应对负载波动</strong></p>
<p>无需预设实例数量或手动扩缩容，平台根据并发请求数自动调度计算资源，瞬时支撑从 1 到数千 QPS 的流量突增，保障服务 SLA。</p>
<p><strong>✅ 零运维，聚焦核心逻辑开发</strong></p>
<p>开发者无需关心底层服务器、容器镜像、K8s 配置或网络拓扑，仅需关注智能体逻辑、工具集成与业务流程编排，大幅缩短上线周期。</p>
<p>此外，Serverless 运行时通过<strong>会话亲和（Session Affinity）机制</strong>在无状态函数架构下有效支持有状态的 Agent 交互场景，兼顾弹性与一致性。</p>
<p>这一演进标志着 Agent 运行时正从“重资产、高运维”的传统模式，迈向“轻量化、自动化、经济高效”的云原生新范式，为 AI Agent 的大规模商业化落地扫清基础设施障碍。</p>
<h2 data-id="heading-3">Serverless 运行时集成能力详解</h2>
<h3 data-id="heading-4">Engine 能力拓展</h3>
<p>Serverless 运行时深度集成 AgentScope 的核心执行引擎（AgentScope Runtime Engine），在保留原有编程模型的基础上，为开发者提供面向云原生环境的无缝部署体验。关键能力包括：</p>
<ul>
<li><strong>本地代码一键构建与依赖打包：</strong> 开发者仅需在本地项目目录中执行<code>deploy() </code>方法，运行时即可自动分析 Python 依赖，构建包含用户代码、自定义工具及第三方库的可执行包，并上传至<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>——该服务已深度集成于百炼 ModelStudio 平台，实现从开发到托管的一站式闭环。</li>
<li><strong>一键部署生成 HTTPS Endpoint：</strong>  部署完成后，系统自动分配全局唯一的 HTTPS 端点（Endpoint），支持标准 RESTful 调用。外部系统（如 Web 前端、移动端或第三方服务）可通过该接口直接触发智能体执行，无需额外配置网关或反向代理。</li>
<li><strong>Header-Based Session 亲和性保障：</strong> 为支持有状态交互（如多轮对话、工具链连续调用），Serverless 运行时引入基于 HTTP 请求头的会话绑定机制。客户端通过在请求中携带 Session ID 请求头，平台将确保同一 Session ID 的所有后续请求路由至同一函数实例（或关联的沙箱上下文），从而维持内存状态、临时文件或浏览器会话的一致性。</li>
<li><strong>继承 Serverless 核心优势：</strong> 所有通过 Engine 部署的智能体天然享有 Serverless 架构的三大特性：按实际执行时间计费、毫秒级自动扩缩容、零基础设施运维，显著降低运营复杂度与总体拥有成本（TCO）。</li>
</ul>
<h3 data-id="heading-5">Sandbox 运行时全面支持</h3>
<p>AgentScope 定义的四大沙箱类型现已完整适配 Serverless 运行时，可在函数计算环境中安全、高效地执行各类操作：</p>
<ul>
<li>✅ <strong>BaseSandbox</strong>：提供隔离的 Python 代码执行环境，适用于通用脚本运行与逻辑计算</li>
<li>✅ <strong>FileSystemSandbox</strong>：挂载临时或持久化文件系统，支持文件读写、日志记录与中间产物存储</li>
<li>✅ <strong>BrowserSandbox</strong>：内置无头 Chromium 浏览器，实现网页自动化、数据抓取与前端交互模拟</li>
<li>✅ <strong>GUISandbox</strong>：支持图形界面应用的模拟执行（如桌面软件自动化），适用于特定领域工具集成</li>
</ul>
<p>基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>的 Serverless 运行时，深度集成 AgentScope 的 Sandbox 运行引擎，其核心特性如下：</p>
<ul>
<li><strong>预热实例池，消除冷启动延迟：</strong>  平台可预先创建并维护一组常用类型的 Sandbox，在新会话到来时直接复用，提高常驻服务的响应速度。</li>
<li><strong>自动注入 Session ID，保障上下文连续性：</strong>  在首次创建 Sandbox 时，系统自动生成唯一 Session ID 并返回给客户端；后续所有针对该会话的 HTTP 请求均自动携带此 ID，确保操作始终作用于同一沙箱实例，保证状态一致性。</li>
<li><strong>全生命周期 Serverless 体验：</strong>  每个 Sandbox 实例在会话结束后自动回收资源，计费随执行结束而终止，同样遵循<strong>按量付费、毫秒级弹性、零运维</strong>的 Serverless 原则，在安全性、性能与成本之间取得最佳平衡。</li>
</ul>
<p>通过 Engine 与 Sandbox 的双重增强，AgentScope 的 Serverless 运行时不仅解决了传统部署的成本与运维难题，更在保持强隔离与状态支持的前提下，实现了 AI Agent 应用的高效、安全、经济化交付。</p>
<h2 data-id="heading-6">快速体验</h2>
<p>现在，您就可以将 Agent 应用快速部署到 Serverless 运行时！</p>
<h3 data-id="heading-7">部署 Agent 到 Serverless 运行时</h3>
<p>只需三步：</p>
<ol>
<li>配置相关环境变量</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 确保设置环境变量</span>
export <span class="hljs-attr">DASHSCOPE_API_KEY</span>=<span class="hljs-string">"your-dashscope-api-key"</span>
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_ID</span>=<span class="hljs-string">"your-access-key-id"</span>
export <span class="hljs-attr">ALIBABA_CLOUD_ACCESS_KEY_SECRET</span>=<span class="hljs-string">"your-access-key-secret"</span>
export <span class="hljs-attr">MODELSTUDIO_WORKSPACE_ID</span>=<span class="hljs-string">"your-workspace-id"</span>
<span class="hljs-comment"># 可选的OSS专用凭证</span>
export <span class="hljs-attr">OSS_ACCESS_KEY_ID</span>=<span class="hljs-string">"your-oss-access-key-id"</span>
export <span class="hljs-attr">OSS_ACCESS_KEY_SECRET</span>=<span class="hljs-string">"your-oss-access-key-secret"</span>
</code></pre>
<ol start="2">
<li>定义好您的 AgentApp</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-comment"># pylint:disable=wrong-import-position, wrong-import-order</span>
import asyncio
import os
from agentscope.agent import ReActAgent
from agentscope.model import DashScopeChatModel
from agentscope_runtime.engine.agents.agentscope_agent import AgentScopeAgent
from agentscope_runtime.engine.runner import Runner
from agentscope_runtime.engine.schemas.agent_schemas import (
    MessageType,
    RunStatus,
    AgentRequest,
)
from agentscope_runtime.engine.services.context_manager import (
    ContextManager,
)
from agentscope_runtime.sandbox.tools.function_tool import function_tool
from others.other_project import version
@function_tool()
def weather_search(query: str) -&gt; str:
    if "sf" in query.lower() or "san francisco" in query.lower():
        <span class="hljs-attr">result</span> = <span class="hljs-string">"It's 60 degrees and foggy."</span>
    else:
        <span class="hljs-attr">result</span> = <span class="hljs-string">"It's 90 degrees and sunny."</span>
    return result
<span class="hljs-attr">agent</span> = AgentScopeAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Friday"</span>,
    <span class="hljs-attr">model</span>=DashScopeChatModel(
        "qwen-turbo",
        <span class="hljs-attr">api_key</span>=os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
    ),
    <span class="hljs-attr">agent_config</span>={
        "sys_prompt": "You're a helpful assistant named Friday.",
    },
    <span class="hljs-attr">agent_builder</span>=ReActAgent,
    <span class="hljs-attr">tools</span>=[
        weather_search,
    ],
)
print(f"AgentScope Runtime with dependencies version: {version}")
async def run():
    <span class="hljs-comment"># Create a request</span>
    <span class="hljs-attr">request</span> = AgentRequest(
        <span class="hljs-attr">input</span>=[
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">"杭州天气如何？"</span>,
                    },
                ],
            },
        ],
    )
    <span class="hljs-attr">runner</span> = Runner(
        <span class="hljs-attr">agent</span>=agent,
        <span class="hljs-attr">context_manager</span>=ContextManager(),
        <span class="hljs-comment"># context_manager=None       # Optional</span>
    )
    async for message in runner.stream_query(<span class="hljs-attr">request</span>=request):
        <span class="hljs-comment"># Check if this is a completed message</span>
        if (
            <span class="hljs-attr">message.object</span> == <span class="hljs-string">"message"</span>
            and <span class="hljs-attr">MessageType.MESSAGE</span> == message.type
            and <span class="hljs-attr">RunStatus.Completed</span> == message.status
        ):
            <span class="hljs-attr">all_result</span> = message.content[<span class="hljs-number">0</span>].text
        print(message)
    print(f"📝 Agent response: {all_result}")
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    asyncio.run(run())
</code></pre>
<ol start="3">
<li>配置部署相关代码，将您的代码部署到 Serverless 运行时上</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">import asyncio
import os
from agentscope_runtime.engine.deployers.modelstudio_deployer import (
    ModelstudioDeployManager,
    OSSConfig,
    ModelstudioConfig,
)
from agent_app import app  <span class="hljs-comment"># 导入已配置的 app</span>
async def deploy_to_modelstudio():
    """将 AgentApp 部署到阿里云 ModelStudio"""
    <span class="hljs-comment"># 配置 OSS 和 ModelStudio</span>
    <span class="hljs-attr">deployer</span> = ModelstudioDeployManager(
        <span class="hljs-attr">oss_config</span>=OSSConfig(
            <span class="hljs-attr">access_key_id</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_ID"</span>),
            <span class="hljs-attr">access_key_secret</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_SECRET"</span>),
        ),
        <span class="hljs-attr">modelstudio_config</span>=ModelstudioConfig(
            <span class="hljs-attr">workspace_id</span>=os.environ.get(<span class="hljs-string">"MODELSTUDIO_WORKSPACE_ID"</span>),
            <span class="hljs-attr">access_key_id</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_ID"</span>),
            <span class="hljs-attr">access_key_secret</span>=os.environ.get(<span class="hljs-string">"ALIBABA_CLOUD_ACCESS_KEY_SECRET"</span>),
            <span class="hljs-attr">dashscope_api_key</span>=os.environ.get(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
        ),
    )
    <span class="hljs-comment"># 执行部署</span>
    <span class="hljs-attr">result</span> = await app.deploy(
        deployer,
        <span class="hljs-attr">deploy_name</span>=<span class="hljs-string">"agent-app-example"</span>,
        <span class="hljs-attr">telemetry_enabled</span>=<span class="hljs-literal">True</span>,
        <span class="hljs-attr">requirements</span>=[<span class="hljs-string">"agentscope"</span>, <span class="hljs-string">"fastapi"</span>, <span class="hljs-string">"uvicorn"</span>],
        <span class="hljs-attr">environment</span>={
            "PYTHONPATH": "/app",
            "DASHSCOPE_API_KEY": os.environ.get("DASHSCOPE_API_KEY"),
        },
    )
    print(f"✅ 部署到 ModelStudio：{result<span class="hljs-section">['url']</span>}")
    print(f"📦 制品：{result<span class="hljs-section">['artifact_url']</span>}")
    return result
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    asyncio.run(deploy_to_modelstudio())
</code></pre>
<p>📚 详细文档请参考：部署指南 <strong>[</strong> <strong>3]</strong> 。</p>
<h3 data-id="heading-8">快速启动 Sandbox</h3>
<ol>
<li>安装 agentscope-runtime</li>
</ol>
<pre><code class="hljs">pip install agentscope-runtime
</code></pre>
<p>由于 agentscope-runtime 仍在初期快速迭代中，建议采用源码安装方式。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/agentscope-ai/agentscope-runtime.git
<span class="hljs-built_in">cd</span> agentscope-runtime
pip install .
</code></pre>
<ol start="2">
<li>配置环境变量</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Service settings</span>
<span class="hljs-attr">HOST</span>=<span class="hljs-string">"0.0.0.0"</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">8000</span>
<span class="hljs-attr">WORKERS</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">DEBUG</span>=<span class="hljs-literal">False</span>
<span class="hljs-comment"># Runtime Manager settings</span>
<span class="hljs-attr">DEFAULT_SANDBOX_TYPE</span>=base
<span class="hljs-attr">POOL_SIZE</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">AUTO_CLEANUP</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">CONTAINER_PREFIX_KEY</span>=agent-runtime-container-
<span class="hljs-attr">CONTAINER_DEPLOYMENT</span>=agentrun
<span class="hljs-attr">DEFAULT_MOUNT_DIR</span>=
<span class="hljs-attr">STORAGE_FOLDER</span>=runtime_sandbox_storage
<span class="hljs-attr">PORT_RANGE</span>=[<span class="hljs-number">49152</span>,<span class="hljs-number">59152</span>]
<span class="hljs-comment"># FC 相关账户信息</span>
<span class="hljs-attr">FC_ACCOUNT_ID</span>=&lt;your-account-id&gt;
<span class="hljs-attr">FC_ACCESS_KEY_ID</span>=&lt;your-access-key-id&gt;
<span class="hljs-attr">FC_ACCESS_KEY_SECRET</span>=&lt;your-access-key-secret&gt;
<span class="hljs-attr">FC_REGION_ID</span>=cn-hangzhou
<span class="hljs-comment"># 规格配置</span>
<span class="hljs-attr">FC_CPU</span>=<span class="hljs-number">2.0</span>
<span class="hljs-attr">FC_MEMORY</span>=<span class="hljs-number">2048</span>
<span class="hljs-comment"># 网络配置</span>
<span class="hljs-attr">FC_VPC_ID</span>=&lt;your-vpc-id&gt;
<span class="hljs-attr">FC_VSWITCH_IDS</span>=[&lt;your-vswitch-id&gt;]
<span class="hljs-attr">FC_SECURITY_GROUP_ID</span>=&lt;your-security-group-id&gt;
<span class="hljs-comment"># 前缀</span>
<span class="hljs-attr">FC_PREFIX</span>=agentscope-sandbox
<span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">FC_LOG_PROJECT</span>=&lt;your-sls-log-project&gt;
<span class="hljs-attr">FC_LOG_STORE</span>=&lt;your-sls-log-store&gt;
</code></pre>
<ol start="3">
<li>运行命令，启动沙箱服务器</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">runtime-sandbox-server --config fc.env
</code></pre>
<ol start="4">
<li>使用您的沙箱</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> agentscope_runtime.sandbox <span class="hljs-keyword">import</span> BaseSandbox
<span class="hljs-comment"># 连接到远程服务器（替换为您的实际服务器地址和端口）</span>
<span class="hljs-keyword">with</span> BaseSandbox(
    base_url=<span class="hljs-string">"http://127.0.0.1:8000"</span>,
) <span class="hljs-keyword">as</span> sandbox:
    <span class="hljs-comment"># 正常使用沙箱</span>
    <span class="hljs-built_in">print</span>(box.list_tools())
    <span class="hljs-built_in">print</span>(box.run_ipython_cell(code=<span class="hljs-string">"print('hi')"</span>))
    <span class="hljs-built_in">print</span>(box.run_shell_command(command=<span class="hljs-string">"echo hello"</span>))
    <span class="hljs-built_in">input</span>(<span class="hljs-string">"Press Enter to continue..."</span>)
</code></pre>
<p>📚 详细文档请参考：沙箱部署指南 <strong>[</strong> <strong>4]</strong> 。</p>
<h2 data-id="heading-9">迈向“省钱又好用”的 AI 运行时</h2>
<p>AI Agent 的运行时基础设施正经历一场深刻的演进：从早期追求“能跑起来”的基础可用性，到关注开发体验与功能完备性的“好用”阶段，如今正加速迈向兼顾性能、安全与经济性的“省钱用”新范式。</p>
<p>AgentScope 与 Serverless 架构的深度集成，正是这一演进的关键实践。通过将智能体部署与工具执行全面迁移至基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算（FC）</a>的 Serverless 平台，不仅大幅降低了对容器编排、集群运维等云原生技能的依赖，更从根本上重构了资源使用模型——<strong>从“为闲置付费”转向“为实际执行付费”</strong> ，使中小团队乃至个人开发者也能以极低成本运行生产级 Agent 应用。</p>
<p>Serverless 所提供的毫秒级弹性、自动扩缩容、强隔离沙箱与零运维特性，恰好契合 AI Agent 应用典型的负载特征：间歇性调用、状态依赖性强、工具执行风险高、成本敏感度高。我们坚信，<strong>Serverless 将成为 AI Agent 应用的最佳运行时。</strong></p>
<p>未来，AgentScope 将持续深化与主流云服务的协同，进一步优化会话管理、冷启动延迟、多模态工具支持等关键路径，并推动更多开源智能体项目采纳 Serverless 范式，构建一个开放、高效、经济的 Agent 运行生态，让复杂智能体系统的开发与部署如同调用普通 API 一样简单可靠。</p>
<p><strong>让每一个智能体，都能轻盈运行在云端。</strong></p>
<p><strong>相关链接：</strong></p>
<p>[1] AgentScope</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope%2F" target="_blank" title="https://github.com/agentscope-ai/agentscope/" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<p>[2] AgentScope Runtime</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-runtime" target="_blank" title="https://github.com/agentscope-ai/agentscope-runtime" ref="nofollow noopener noreferrer">github.com/agentscope-…</a></p>
<p>[3] 部署指南</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fzh%2Fadvanced_deployment.html%23method-4-modelstudio-deployment" target="_blank" title="https://runtime.agentscope.io/zh/advanced_deployment.html#method-4-modelstudio-deployment" ref="nofollow noopener noreferrer">runtime.agentscope.io/zh/advanced…</a></p>
<p>[4] 沙箱部署指南</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fen%2Fsandbox%2Fadvanced.html%23optional-function-compute-fc-settings" target="_blank" title="https://runtime.agentscope.io/en/sandbox/advanced.html#optional-function-compute-fc-settings" ref="nofollow noopener noreferrer">runtime.agentscope.io/en/sandbox/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 开发中的图片格式全指南]]></title>    <link>https://juejin.cn/post/7578922565209784347</link>    <guid>https://juejin.cn/post/7578922565209784347</guid>    <pubDate>2025-12-02T08:23:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578922565209784347" data-draft-id="7578836326474596379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 开发中的图片格式全指南"/> <meta itemprop="keywords" content="Android,架构"/> <meta itemprop="datePublished" content="2025-12-02T08:23:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北海道浪子"/> <meta itemprop="url" content="https://juejin.cn/user/729731450022440"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 开发中的图片格式全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731450022440/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北海道浪子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:23:51.000Z" title="Tue Dec 02 2025 08:23:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fproandroiddev%2Fthe-complete-guide-to-image-formats-in-android-development-4a1e1c86b265%3Futm_source%3Dchatgpt.com" target="_blank" title="https://medium.com/proandroiddev/the-complete-guide-to-image-formats-in-android-development-4a1e1c86b265?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">The Complete Guide to Image Formats in Android Development</a>
作者：Akshay Nandwana</p>
<hr/>
<h2 data-id="heading-0">Android 开发中的图片格式全指南</h2>
<h3 data-id="heading-1">简介</h3>
<p>在 Android 开发中，选择合适的图片格式对应用性能、用户体验，以及 APK 大小优化非常关键。本文系统地对 PNG、JPG、WebP、SVG（及 icon font）进行比较，分析它们的渲染性能、使用场景，以及最佳实践。</p>
<hr/>
<h3 data-id="heading-2">图片格式总览</h3>
<h4 data-id="heading-3">1. PNG (Portable Network Graphics)</h4>
<p><strong>PNG 是什么？</strong><br/>
PNG 是栅格图 (raster graphics) 格式，采用无损压缩 (lossless)，支持通过 alpha 通道实现透明 (full alpha channel)，是 Android 中经典的图片格式之一。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：无损 (lossless)</li>
<li>透明度：支持完整 alpha 通道 (8-bit)</li>
<li>色深 (color depth)：最高可达 48-bit 色彩 (视工具/导出设定)</li>
<li>文件大小：对纯色、图标类图片通常较小；对照片类图片通常比 JPG 文件大。</li>
<li>动画支持：PNG 本身不支持动画 (虽然有 APNG，但 Android 支持有限)</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 PNG 文件到内存</li>
<li>使用 DEFLATE 算法解压数据</li>
<li>解码为像素 (bitmap)</li>
<li>使用 Skia 图形引擎渲染到 Canvas</li>
<li>如果设备支持，启用硬件加速 (hardware acceleration)</li>
</ol>
<p><strong>性能指标 (典型状况)</strong> ：</p>
<ul>
<li>解码时间 (decode time)：中等，大致 10–50 ms (视图片复杂度和尺寸而定)</li>
<li>内存使用 (memory)：高 — 解码后的 bitmap 通常是宽 × 高 × 4 bytes (ARGB_8888)</li>
<li>渲染速度 (rendering speed)：快 (硬件加速)</li>
</ul>
<p><strong>适合使用 PNG 的场景</strong>：</p>
<ul>
<li>需要透明 / 半透明效果的 UI 元素 (例如按钮、带阴影或叠加的图标)</li>
<li>具有锐利边缘 (sharp edges) 的图形 (例如 logo、文字覆盖)</li>
<li>对画质要求高，不希望丢失质量 (如 app 图标、截图、应用商店图片)</li>
<li>Drawable 资源中需要透明背景、清晰边缘的图片</li>
</ul>
<p><strong>Android 特有注意事项</strong>：</p>
<ul>
<li>
<p>PNG 资源通常会被其打包工具 (aapt2) 自动压缩优化。</p>
</li>
<li>
<p>在布局中，你可以像下面这样使用：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;ImageView
    android:<span class="hljs-attr">src</span>=<span class="hljs-string">"@drawable/logo_transparent"</span>
    android:<span class="hljs-attr">contentDescription</span>=<span class="hljs-string">"App Logo"</span> /&gt;
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-4">2. JPG / JPEG (Joint Photographic Experts Group)</h4>
<p><strong>JPG 是什么？</strong><br/>
JPG 是一种针对照片 (photographic images) 优化的有损压缩 (lossy) 格式，适合色彩连续、渐变丰富的图像。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：有损 (lossy)，可调整质量 (quality)</li>
<li>透明度：不支持</li>
<li>色深：24-bit 色彩 (约 1670 万色)</li>
<li>文件大小：对于照片类图片，压缩效果非常好 — 通常比 PNG 小很多 (约 60–90% smaller)</li>
<li>压缩伪影 (artifacts)：在较低质量设置时会明显可见</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 JPEG 文件</li>
<li>Huffman 解码 + 反量化 (dequantization)</li>
<li>逆离散余弦变换 (IDCT)</li>
<li>色彩空间转换 (YCbCr → RGB)</li>
<li>创建 bitmap 并渲染显示</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>解码时间 (decode)：快 — 约 5–30 ms (视图片大小和质量)</li>
<li>内存使用：高 (与 PNG/WebP 相同，解码后为 bitmap)</li>
<li>渲染速度：快</li>
<li>文件大小：对于照片非常优势，照片通常比 PNG 小 3–10 倍 (取决于内容)</li>
</ul>
<p><strong>适合使用 JPG 的场景</strong>：</p>
<ul>
<li>照片 (用户头像、相册图片、背景图)</li>
<li>不需要透明度 (transparent) 的背景图、场景图像</li>
<li>图片尺寸较大且对下载/加载速度敏感 (网络加载、启动图 / splash screen)</li>
<li>照片类内容对质量要求不极端 (可接受轻微压缩伪影)</li>
</ul>
<p><strong>Android 特有建议</strong>：</p>
<p>当你使用图片加载库 (例如 Glide) 加载 JPG 时，可以考虑使用降低内存使用的配置，例如 <code>RGB_565</code> 而不是默认的 <code>ARGB_8888</code>。</p>
<pre><code class="hljs language-scss" lang="scss">Glide<span class="hljs-selector-class">.with</span>(context)
    <span class="hljs-selector-class">.load</span>(photoUrl)
    <span class="hljs-selector-class">.format</span>(DecodeFormat.PREFER_RGB_565)
    <span class="hljs-selector-class">.into</span>(imageView)
</code></pre>
<hr/>
<h4 data-id="heading-5">3. WebP</h4>
<p><strong>WebP 是什么？</strong><br/>
WebP 是 Google 提出的一种现代图像格式，既支持有损 (lossy) 又支持无损 (lossless) 压缩，还支持透明通道 (alpha) 和动画，是兼顾压缩效率与画质的格式。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>压缩方式：既支持 lossy，也支持 lossless</li>
<li>透明度：支持完整 alpha 通道</li>
<li>文件大小：通常比 PNG 小 25–35%，比 JPG 也有约 25–34% 的压缩优势 (在等效质量下)</li>
<li>动画支持：支持 (比 GIF 效率更高)</li>
<li>Android 支持情况：从 Android 4.0 (API 14) 开始支持基本 WebP，从 Android 4.3 (API 18) 开始支持无损 + 透明通道。</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>加载 WebP 文件到内存</li>
<li>使用 VP8 / VP8L codec 解码 (预测 + 变换 / 块解码)</li>
<li>(Lossy 模式) block-based 解码；(lossless) pixel-based 解码</li>
<li>创建 bitmap</li>
<li>硬件加速渲染 (如果可用)</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>解码时间 (decode)：略慢于 JPG，大约 10–40 ms (typical)</li>
<li>内存使用：解码后与其他栅格格式 (PNG / JPG) 相同 (bitmap)</li>
<li>渲染速度：快 (硬件加速)</li>
<li>文件大小：在栅格图像格式中压缩效率最高，被认为是“最优”折中方案</li>
</ul>
<p><strong>适合使用 WebP 的场景</strong>：</p>
<ul>
<li>当需要透明通道，又希望比 PNG 更小体积时 (例如 UI 图标、叠加图片)</li>
<li>照片 / 场景图像，既需要较好画质，又希望减小下载/存储大小时</li>
<li>网络加载 (网络图片) — 下载更快，占用更少带宽</li>
<li>动画 (相比 GIF 更好)</li>
<li>针对现代 Android 设备 (通常 minSdk ≥ 18) 的项目</li>
</ul>
<p><strong>Android 特有建议</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 build.gradle 中启用 WebP 转换</span>
android {
    defaultConfig {
        <span class="hljs-comment">// 自动将可转换的 PNG 转换为 WebP</span>
        vectorDrawables.<span class="hljs-property">useSupportLibrary</span> = <span class="hljs-literal">true</span>
    }
}
<span class="hljs-comment">// 在 Coil 中使用 WebP</span>
imageView.<span class="hljs-title function_">load</span>(<span class="hljs-params">webpUrl</span>) {
    <span class="hljs-title function_">decoderFactory</span>(<span class="hljs-title class_">ImageDecoderDecoder</span>.<span class="hljs-title class_">Factory</span>())
}
</code></pre>
<hr/>
<h4 data-id="heading-6">4. SVG / 矢量图 (通过 VectorDrawable)</h4>
<p><strong>SVG / VectorDrawable 是什么？</strong><br/>
SVG 是一种基于矢量 (vector) 的图像格式 —— 用数学向量 (路径) 描述图形，而不是像素。这使得它在缩放 (不同分辨率、不同设备 DPI) 时不会失真。在 Android 中，通常使用 VectorDrawable（基于 SVG 路径规范，并做了 Android 特化）来表示矢量图。</p>
<p><strong>技术特性</strong>：</p>
<ul>
<li>类型：矢量图 (vector graphics)，由路径 (path) 数学描述构成。</li>
<li>可伸缩性 (scalability)：不论放大多少倍都不会失真 — 非常适合适配不同屏幕密度 (dpi) 的设备。</li>
<li>文件大小：对简单图形 (例如图标、logo) 来说非常小，通常 1–10 KB。</li>
<li>复杂度：复杂矢量 (如路径非常多、节点很多) 会影响性能 (首次渲染可能较慢)</li>
<li>动画支持：可通过 AnimatedVectorDrawable 实现动画效果 (对矢量路径做动画)</li>
</ul>
<p><strong>渲染流程</strong>：</p>
<ol>
<li>解析 XML 中的路径数据 (vector paths)</li>
<li>将路径数据转换为绘图命令 (drawing commands)</li>
<li>(首次) 软件渲染 (software rendering) 到 bitmap</li>
<li>缓存 bitmap，以便下次复用</li>
<li>使用硬件加速显示 (hardware-accelerated)</li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>首次渲染 (initial render)：对复杂矢量可能比较慢 (约 50–200 ms)</li>
<li>缓存后的渲染 (cached render)：非常快</li>
<li>内存使用：矢量数据本身几乎不占内存，cached bitmap 占用 moderate，大幅度小于等同大小的栅格图片 (bitmap)</li>
<li>可伸缩性 (scalability)：在任何 DPI 下都保持清晰、不失真</li>
</ul>
<p><strong>适合使用 VectorDrawable 的场景</strong>：</p>
<ul>
<li>简单图标、logo、小型 UI 元素</li>
<li>需要适配多种屏幕密度 (dpi) / 分辨率</li>
<li>需要动画图标 (Animated icons)</li>
<li>希望减小 APK 大小 / drawable 体积</li>
<li>UI 矢量图 (icons, 简洁形状) 优先使用矢量图 (比 bitmap 更合适)</li>
</ul>
<p><strong>不推荐使用矢量图的场景</strong>：</p>
<ul>
<li>复杂插画 / 高细节图 (如复杂图形、渐变、图片类内容) — 会影响渲染性能</li>
<li>照片 / 实景图像 (photographic content) — 不适合矢量化</li>
</ul>
<p>对于图标和小型图形，Android 官方建议优先使用矢量图 (VectorDrawable / SVG) 以便适配不同设备。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid-docs.cn%2Fdesign%2Fui%2Fmobile%2Fguides%2Flayout-and-content%2Fimages-graphics%3Futm_source%3Dchatgpt.com" title="https://android-docs.cn/design/ui/mobile/guides/layout-and-content/images-graphics?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">android-docs.cn</a>)</p>
<p><strong>Android-Specific 注意事项</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- res/drawable/ic_heart.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span>
        <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
        <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,21.35l-1.45,-1.32C5.4,15.36 2,12.28 2,8.5 2,5.42 4.42,3 7.5,3c1.74,0 3.41,0.81 4.5,2.09C13.09,3.81 14.76,3 16.5,3 19.58,3 22,5.42 22,8.5c0,3.78 -3.4,6.86 -8.55,11.54L12,21.35z"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<p>若项目需要兼容旧 Android 版本 (低于 API 21)，可以在 build.gradle 中启用 Support Library 的向量支持：</p>
<pre><code class="hljs language-ini" lang="ini">android {
    defaultConfig {
        <span class="hljs-attr">vectorDrawables.useSupportLibrary</span> = <span class="hljs-literal">true</span>
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-7">5. Icon Fonts (TTF) / 字体图标</h4>
<p>除了图片／矢量图之外，也可以使用 TTF 字体 (icon fonts) 将图标作为字体 glyph —— 把图标当作文本字符处理 (icon as text)，这在某些场景也非常有用。</p>
<p><strong>为什么使用 Icon Fonts？</strong></p>
<ul>
<li>一个字体文件中可以包含数百、数千个图标 glyph</li>
<li>图标可像文本一样缩放 (无失真)、改变颜色、大小、阴影、样式</li>
<li>适合当图标集非常大、需要动态着色 (tint)、并希望跨平台 (Android / Web / iOS) 保持一致性</li>
</ul>
<p><strong>Android 中使用示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">// Kotlin 代码示例
val <span class="hljs-attr">typeface</span> = Typeface.createFromAsset(assets, <span class="hljs-string">"fonts/fontawesome.ttf"</span>)
<span class="hljs-attr">iconTextView.typeface</span> = typeface
<span class="hljs-attr">iconTextView.text</span> = <span class="hljs-string">"\uf004"</span> // heart icon 的 unicode glyph
</code></pre>
<p>或者在 XML 中 (例如使用 Material Icons)：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;TextView
    android:<span class="hljs-attr">fontFamily</span>=<span class="hljs-string">"@font/material_icons"</span>
    android:<span class="hljs-attr">text</span>=<span class="hljs-string">"&amp;#xe87d;"</span> /&gt;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>包含大量 (100+ ) 图标集 (icon library)</li>
<li>需要动态改变图标颜色 (如主题色 / state tint)</li>
<li>希望图标在不同平台统一 (例如 Web / Android / iOS)</li>
</ul>
<p><strong>不适合场景</strong>：</p>
<ul>
<li>多色 / 多层 / 复杂图标 (icon fonts 一般是单色 glyph)</li>
<li>复杂图形 / 插画 / 渐变图标 — 矢量或位图更合适</li>
</ul>
<p><strong>Android-Specific 使用示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">typeface</span> = Typeface.createFromAsset(assets, <span class="hljs-string">"fonts/fontawesome.ttf"</span>)
<span class="hljs-attr">iconTextView.typeface</span> = typeface
<span class="hljs-attr">iconTextView.text</span> = <span class="hljs-string">"\uf004"</span> // heart icon 的 unicode glyph

</code></pre>
<p>或者在 XML 中 (例如使用 Material Icons)：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;TextView
    android:<span class="hljs-attr">fontFamily</span>=<span class="hljs-string">"@font/material_icons"</span>
    android:<span class="hljs-attr">text</span>=<span class="hljs-string">"&amp;#xe87d;"</span> /&gt;
</code></pre>
<hr/>
<h3 data-id="heading-8">综合比较表</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03f6cb539134b37b29850f8cbde4e1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5rW36YGT5rWq5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765268631&amp;x-signature=0wMd%2FVihnYwIAXcOX%2FO5jB4xsj0%3D" alt="2.webp" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-9">性能 / 内存 / 文件大小 对比 (Raster vs Vector vs Font Icon)</h3>
<p>以下是几个重要对比维度 (以典型使用场景为例)：</p>
<h4 data-id="heading-10">🔄 解码 / 渲染性能（以 500×500 px 图为例）</h4>

































<table><thead><tr><th>格式</th><th>解码 / 渲染时间</th></tr></thead><tbody><tr><td>JPG</td><td>5–15 ms</td></tr><tr><td>PNG</td><td>10–30 ms</td></tr><tr><td>WebP (lossy)</td><td>10–25 ms</td></tr><tr><td>WebP (lossless)</td><td>15–40 ms</td></tr><tr><td>VectorDrawable</td><td>首次渲染 50–200 ms；缓存后 &lt;1 ms</td></tr><tr><td>Icon Font (glyph)</td><td>&lt;1 ms (字体加载后)</td></tr></tbody></table>
<h4 data-id="heading-11">📦 内存 / 文件大小 / 缓存</h4>
<ul>
<li>对于一个 1080×1920（全屏）栅格图 (ARGB_8888)，Bitmap 大小为约 8 MB。</li>
<li>如果使用 RGB_565 (如果不需要 alpha)，则约为 4 MB。</li>
<li>VectorDrawable：矢量数据本身非常小 (KB 级)，cached bitmap 缓存后通常远小于栅格图。</li>
<li>Icon Fonts：字体资源共享，glyph 的渲染开销低，对内存占用 minimal。</li>
</ul>
<hr/>
<h3 data-id="heading-12">最佳实践 / 优化策略</h3>
<ul>
<li>对于图标、小型 UI 元素 (buttons, logos …)，优先使用矢量图 (VectorDrawable / SVG) — 体积小、可伸缩、适配各种 DPI。</li>
<li>对于照片、复杂图片 (背景图、相片等)，推荐使用 WebP (lossy)，在保证画质的同时极大减少文件大小。</li>
<li>对于需要透明通道 (alpha) 的图片 (icon、叠加图等)，可使用 WebP (lossless + transparency)，比 PNG 有更好的压缩比。</li>
<li>使用构建工具 (如在 <code>build.gradle</code> 中配置) 自动将合适的 PNG 转为 WebP，以减少 APK 大小。</li>
<li>在运行时 (runtime) 加载图片时，避免在主线程 (main thread) 解码 bitmaps，使用异步 (background) 解码 + 缓存，并在不需要时调用 <code>bitmap.recycle()</code> (如果不由图像库自动管理) 。</li>
<li>对于需要良好性能和低内存消耗的场景 (如列表 / 滚动界面 / 大量图片)，考虑使用较低内存配置 (如 RGB_565), 或对图片进行下采样 (downsampling), 并适当控制图片尺寸 (size)。</li>
</ul>
<hr/>
<h3 data-id="heading-13">格式选择 — 快速决策指南</h3>





























<table><thead><tr><th>场景 / 需求</th><th>推荐格式</th></tr></thead><tbody><tr><td>UI 图标 / 简单图形 / Logo / 可缩放图像</td><td>VectorDrawable (SVG)</td></tr><tr><td>有透明 / 半透明 UI 元素 (但需要压缩体积)</td><td>WebP (lossless + transparency) / PNG</td></tr><tr><td>照片 / 背景图 / 相册 / 网络图片</td><td>WebP (lossy) 或 JPG</td></tr><tr><td>动画 (简单动画图标 / 矢量动画)</td><td>AnimatedVectorDrawable 或 WebP 动画</td></tr><tr><td>大量图标 / 图标库 (icon fonts)</td><td>Icon Font (glyph) 或 VectorDrawable</td></tr></tbody></table>
<blockquote>
<p>📝 <strong>建议默认策略 (现代 Android 项目, 目标 API 18+)</strong></p>
<ul>
<li>图标 &amp; 简单图形：使用矢量图 (VectorDrawable)</li>
<li>照片 / 复杂图像：使用 WebP (lossy)</li>
<li>带透明通道 / UI 叠加图：使用 WebP (lossless) 或 PNG</li>
<li>动画：AnimatedVectorDrawable / WebP animation</li>
<li>大量图标 / 图标集：Icon Font 或 VectorDrawable</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p>选择合适的图片格式对于 Android 应用性能、资源管理、包体积和用户体验都有深远影响。</p>
<ul>
<li><strong>PNG</strong> 和 <strong>JPG</strong> 虽然经典，但往往不是最优，适合特定场景 (透明 PNG / 照片 JPG) 。</li>
<li><strong>WebP</strong> 在绝大多数情况下是最佳折中 — 压缩率高、支持透明和动画、兼容性好，是现代 Android 应用推荐格式。</li>
<li><strong>VectorDrawable</strong> (SVG) 则是图标 / UI 元素 / logo 的首选 —— 小体积、可缩放、适配多 DPI，是现代响应式 UI 的基础。</li>
<li>对于图标集 (“icon fonts”)，使用字体或矢量图，可以极大节省空间并保持灵活性。</li>
</ul>
<p>总之，在开发中应根据图片内容 (图标 vs 照片)、用途 (UI 元素 vs 背景 / 内容图)、是否需要透明 / 动画 / 可缩放性等维度综合考量，并结合工具和构建流程 (如自动转换 WebP) 最大化优化效果。</p>
<hr/>
<p>下面附赠免费使用的ai站点，可使用claude code和codex
<strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi.codemirror.codes%2Fregister%3Faff%3DUqVb" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi.codemirror.codes%2Fregister%3Faff%3DUqVb" target="_blank">codemirror</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi520.pro%2Fregister%3Faff%3DZLio" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi520.pro%2Fregister%3Faff%3DZLio" target="_blank">熊猫api</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.ohmygpt.com%2Fi%2F3IDF2786" title="https://link.juejin.cn/?target=https%3A%2F%2Fwww.ohmygpt.com%2Fi%2F3IDF2786" target="_blank">ohmygpt</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Faicoding.sh%2Fi%2F1JLj77Edqf" title="https://link.juejin.cn/?target=https%3A%2F%2Faicoding.sh%2Fi%2F1JLj77Edqf" target="_blank">aicoding</a></strong></p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fapi4model.com%2Fregister%3Faff%3D35nk" title="https://link.juejin.cn/?target=https%3A%2F%2Fapi4model.com%2Fregister%3Faff%3D35nk" target="_blank">api4model</a></strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从字面量到原型链：JavaScript 面向对象的完整进化史]]></title>    <link>https://juejin.cn/post/7578901433971163136</link>    <guid>https://juejin.cn/post/7578901433971163136</guid>    <pubDate>2025-12-02T08:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971163136" data-draft-id="7578877638988152832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从字面量到原型链：JavaScript 面向对象的完整进化史"/> <meta itemprop="keywords" content="JavaScript,设计模式"/> <meta itemprop="datePublished" content="2025-12-02T08:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从字面量到原型链：JavaScript 面向对象的完整进化史
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:10:10.000Z" title="Tue Dec 02 2025 08:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">从字面量到原型链：JavaScript 面向对象的完整进化史</h2>
<p>JavaScript 是一门<strong>基于对象（Object-based）</strong> 的语言——你几乎接触到的一切都是对象，甚至连 <code>1</code>、<code>'hello'</code> 这样的原始值，在需要时也会被自动包装成 <code>Number</code>、<code>String</code> 对象。然而，JavaScript 并不是传统意义上的“面向对象语言”（如 Java 或 C++），它没有类（class）的概念（直到 ES6 才引入语法糖形式的 <code>class</code>），其核心机制是<strong>原型（Prototype）</strong> 。</p>
<p>那么，在没有 <code>class</code> 的年代，我们如何用 JavaScript 实现面向对象编程（OOP）？本文将带你从最原始的对象字面量出发，逐步演进到成熟的原型继承模式，理解 JS OOP 的本质。</p>
<hr/>
<h3 data-id="heading-1">一、起点：对象字面量（Object Literal）</h3>
<p>最简单的创建对象方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cat1 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小白'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'白色'</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'猫科动物'</span>,
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喜欢 Jerry'</span>);
  }
};

<span class="hljs-keyword">const</span> cat2 = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'小黑'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'黑色'</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'猫科动物'</span>,
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'喜欢 Jerry'</span>);
  }
};
</code></pre>
<p>✅ <strong>优点</strong>：简单直观。<br/>
❌ <strong>缺点</strong>：</p>
<ul>
<li>代码重复；</li>
<li>无法批量生成相似对象；</li>
<li>实例之间没有“类型”关联，无法判断 <code>cat1</code> 是否属于“猫”。</li>
</ul>
<blockquote>
<p>这只是“数据容器”，不是“类”的实例。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、进化：构造函数模式（Constructor Pattern）</h3>
<p>为了解决复用问题，我们封装一个函数来生成对象：</p>
<pre><code class="hljs language-ini" lang="ini">function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.type</span> = <span class="hljs-string">'猫科动物'</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">this.eat</span> = function() {
    console.log('喜欢 Jerry')<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">cat1</span> = new Cat(<span class="hljs-string">'小白'</span>, <span class="hljs-string">'白色'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cat2</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3"><code>new</code> 调用时发生了什么？</h4>
<ol>
<li>创建一个空对象 <code>{}</code>；</li>
<li>将 <code>this</code> 指向这个空对象；</li>
<li>执行函数体，给 <code>this</code> 添加属性和方法；</li>
<li>返回这个新对象（除非显式返回其他对象）。</li>
</ol>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>可批量创建实例；</li>
<li>实例可通过 <code>instanceof Cat</code> 判断类型；</li>
<li>实例间有了“关系”。</li>
</ul>
<p>❌ <strong>致命缺点</strong>：</p>
<ul>
<li>每个实例都拥有自己的一份 <code>eat</code> 方法 → <strong>内存浪费</strong>；</li>
<li>公共属性（如 <code>type</code>）也无法共享。</li>
</ul>
<hr/>
<h3 data-id="heading-4">三、优化：原型模式（Prototype Pattern）</h3>
<p>JavaScript 的核心思想：<strong>把不变的、公共的部分放到原型上</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Cat.prototype.type</span> = <span class="hljs-string">'猫科动物'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">Cat.prototype.eat</span> = function() {
  console.log('喜欢 Jerry')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">cat1</span> = new Cat(<span class="hljs-string">'小白'</span>, <span class="hljs-string">'白色'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cat2</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>

console.log(<span class="hljs-attr">cat1.eat</span> === cat2.eat)<span class="hljs-comment">; // true ✅ 共享同一个方法</span>
</code></pre>
<h4 data-id="heading-5">原型链机制</h4>
<ul>
<li>每个函数都有一个 <code>prototype</code> 属性（指向原型对象）；</li>
<li>每个实例都有一个内部链接 <code>[[Prototype]]</code>（在浏览器中可通过 <code>__proto__</code> 访问），指向其构造函数的 <code>prototype</code>；</li>
<li>当访问属性时，JS 会先查实例自身，再沿原型链向上查找。</li>
</ul>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>方法和公共属性<strong>共享</strong>，节省内存；</li>
<li>支持动态扩展：<code>Cat.prototype.sleep = ...</code> 所有实例立即可用。</li>
</ul>
<hr/>
<h3 data-id="heading-6">四、进阶：继承（Inheritance）</h3>
<p>OOP 的三大特性之一是<strong>继承</strong>。在 JS 中，如何让 <code>Cat</code> 继承 <code>Animal</code>？</p>
<h4 data-id="heading-7">1. 借用构造函数（继承实例属性）</h4>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  // 关键：让 Animal 的 this 指向当前 Cat 实例
  Animal.apply(this, arguments)<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}
</code></pre>
<ul>
<li><code>Animal.apply(this)</code>：<strong>借用父类构造函数</strong>，将 <code>species</code> 添加到子类实例上。</li>
<li>✅ 继承了<strong>实例属性</strong>；</li>
<li>❌ <strong>未继承原型方法</strong>（如 <code>Animal.prototype.move</code>）。</li>
</ul>
<h4 data-id="heading-8">2. 设置原型链（继承原型方法）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 让 Cat.prototype 的原型指向 Animal.prototype</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>; <span class="hljs-comment">// 修复 constructor 指向</span>

<span class="hljs-comment">// 补充 Cat 自己的方法</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">purr</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'呼噜呼噜~'</span>);
};
</code></pre>
<p>现在，<code>Cat</code> 实例既能访问 <code>species</code>（来自 <code>Animal</code> 构造函数），也能调用 <code>move()</code>（来自 <code>Animal.prototype</code>）。</p>
<hr/>
<h3 data-id="heading-9">五、现代写法：ES6 <code>class</code>（语法糖）</h3>
<p>ES6 引入了 <code>class</code> 语法，但底层仍是原型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
  }
  <span class="hljs-title function_">move</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I can move!'</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, color</span>) {
    <span class="hljs-variable language_">super</span>(); <span class="hljs-comment">// 等价于 Animal.apply(this)</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
  }
  <span class="hljs-title function_">purr</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'呼噜呼噜~'</span>);
  }
}
</code></pre>
<ul>
<li><code>extends</code> → 设置原型链；</li>
<li><code>super()</code> → 借用父类构造函数；</li>
<li>一切更清晰，但<strong>本质仍是原型继承</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-10">六、总结：JS OOP 的演进路径</h3>









































<table><thead><tr><th>阶段</th><th>方式</th><th>核心思想</th><th>缺陷</th></tr></thead><tbody><tr><td>1</td><td>对象字面量</td><td>直接写对象</td><td>无法复用，无类型关系</td></tr><tr><td>2</td><td>构造函数</td><td>封装生成过程</td><td>方法不共享，内存浪费</td></tr><tr><td>3</td><td>原型模式</td><td>公共部分放原型</td><td>属性/方法分离，需手动管理</td></tr><tr><td>4</td><td>原型继承</td><td><code>apply</code> + <code>Object.create</code></td><td>写法繁琐，易出错</td></tr><tr><td>5</td><td>ES6 <code>class</code></td><td>语法糖封装</td><td>底层仍是原型，需理解本质</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键认知</strong>：<br/>
JavaScript 的 OOP 不是“类继承”，而是“<strong>对象委托</strong>”——通过原型链，对象可以<strong>委托</strong>给另一个对象处理自己不会的事情。</p>
</blockquote>
<p>掌握从字面量到原型继承的全过程，你才算真正理解了 JavaScript 面向对象的精髓。即使今天使用 <code>class</code>，也要明白：<strong><code>class</code> 只是原型的语法糖，而原型才是 JS OOP 的灵魂</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我写了一个VSCode的仿Neovide光标动画]]></title>    <link>https://juejin.cn/post/7578917474659352627</link>    <guid>https://juejin.cn/post/7578917474659352627</guid>    <pubDate>2025-12-02T08:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578917474659352627" data-draft-id="7578922565209800731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我写了一个VSCode的仿Neovide光标动画"/> <meta itemprop="keywords" content="Visual Studio Code,前端"/> <meta itemprop="datePublished" content="2025-12-02T08:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LengineerC"/> <meta itemprop="url" content="https://juejin.cn/user/1707958031887840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我写了一个VSCode的仿Neovide光标动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1707958031887840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LengineerC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:44:56.000Z" title="Tue Dec 02 2025 08:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Neovide的灵魂之一就是它的光标动画（<del>我就是图这个才用neovim的</del>），还好VSCode中有一个插件<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dbe5invis.vscode-custom-css" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=be5invis.vscode-custom-css" ref="nofollow noopener noreferrer">Custom CSS and JS Loader</a>，支持我们自己向注入CSS和JS，因此可以使用这个途径，直接写个注入脚本，检测VSCode编辑区的光标，然后挂载canvas实现动画效果。具体的动画实现参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fneovide%2Fneovide" target="_blank" title="https://github.com/neovide/neovide" ref="nofollow noopener noreferrer">neovide: No Nonsense Neovim Client in Rust</a>的源码，至于光标的检测是参考的reddit上一个大佬的代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2Fvscode%2Fcomments%2F11e66xh%2Fi_made_neovide_alike_cursor_effect_on_vscode%2F" target="_blank" title="https://www.reddit.com/r/vscode/comments/11e66xh/i_made_neovide_alike_cursor_effect_on_vscode/" ref="nofollow noopener noreferrer">I made neovide alike cursor effect on vscode</a>。</p>
<h2 data-id="heading-0">实现效果</h2>
<p>话不多说先看效果</p>
<h3 data-id="heading-1">单个光标</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6df303ddf95642c6a2cfbbad2114a2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVuZ2luZWVyQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270136&amp;x-signature=pxpPGELredfv5nIJXrlwkfe4qCo%3D" alt="2025-12-02 16-20-37.gif" loading="lazy"/></p>
<h3 data-id="heading-2">多个光标</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6097c892ae2d413882c8c24bccb84b0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVuZ2luZWVyQw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270136&amp;x-signature=mui%2F8pMXzuZRPXE1ud%2Fw53qQYUI%3D" alt="2025-12-02 16-21-29.gif" loading="lazy"/></p>
<h2 data-id="heading-3">现有问题</h2>
<p>reddit上面大佬的代码只兼容单个光标，当有多个光标时，他的动画绑定就有问题，有时失效乱飘，但是他的代码在分屏时可以处理屏间光标跳转。对于我个人而言，多光标操作还是很频繁的，所以优先处理了多光标适配，大致原理就是给每个光标dom节点绑定一个自定义的id属性，但是由于分屏之后两个vscode两个分屏中的cursor不是同一个实例，所以原代码的跨屏动画就没有了，不过每个分屏中的动画还是能正常运行的。</p>
<h2 data-id="heading-4">使用方式</h2>
<p>github链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLengineerC%2Fvscode-neovide-cursor%2Ftree%2Fmain" target="_blank" title="https://github.com/LengineerC/vscode-neovide-cursor/tree/main" ref="nofollow noopener noreferrer">LengineerC/vscode-neovide-cursor: A Neovide like cursor animation for VS Code</a></p>
<p>下载<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLengineerC%2Fvscode-neovide-cursor%2Fblob%2Fmain%2Fneovide-cursor.js" title="https://github.com/LengineerC/vscode-neovide-cursor/blob/main/neovide-cursor.js" target="_blank" ref="nofollow noopener noreferrer">neovide-cursor.js</a>，或直接复制代码自己找个文件保存。</p>
<p>VSCode安装<code>Custom CSS and JS loader</code>插件，
向<code>settings.json</code>添加配置:</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">``</span><span class="hljs-string">`
"vscode_custom_css.imports": [
    "file:///C:/path/to/your/neovide-cursor.js"
]
`</span><span class="hljs-string">``</span>
</code></pre>
<p>然后<code>ctrl</code>+<code>shift</code>+<code>p</code>执行<code>Enable Custom CSS and JS</code>后重启VSCode即可</p>
<p>修改配置的话保存修改后重新执行<code>Enable Custom CSS and JS</code>或<code>Reload Custom CSS and JS</code>就行</p>
<p>有bug欢迎提出issue！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mongoose操作MongoDB数据库（1）：项目创建与连接配置]]></title>    <link>https://juejin.cn/post/7578901433971523584</link>    <guid>https://juejin.cn/post/7578901433971523584</guid>    <pubDate>2025-12-02T08:46:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578901433971523584" data-draft-id="7578693994367975424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mongoose操作MongoDB数据库（1）：项目创建与连接配置"/> <meta itemprop="keywords" content="MongoDB,前端"/> <meta itemprop="datePublished" content="2025-12-02T08:46:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mongoose操作MongoDB数据库（1）：项目创建与连接配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:46:25.000Z" title="Tue Dec 02 2025 08:46:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<hr/>
<h3 data-id="heading-0">Mongoose介绍</h3>
<p>Mongoose 是为Node.js设计的一个 MongoDB 的对象数据建模库。目的是为了服务端与 MongoDB 数据库进行交互时提供更简化的数据库操作接口。</p>
<blockquote>
<p>使用 Mongoose 需要掌握的前置条件：</p>
<p>1.需要掌握的知识：<code>Node.js、MongoDB、Express/koa框架</code>。</p>
<p>2.确保电脑已安装Node.js，且版本在 Node16 以上。可以打开cmd终端，输入 <code>node -v</code> 来确认Node安装的版本。</p>
<p>3.确认已在本地或服务器启动MongoDB数据服务，可参考我之前的系列文章 <a href="https://juejin.cn/post/7568405112269602852" target="_blank" title="https://juejin.cn/post/7568405112269602852">Windows系统搭建MongoDB</a> 来实现数据库的安装、配置、部署。</p>
</blockquote>
<p>本专题我们将使用 <code>Node.js + Express + Mongoose</code> 来实现服务端的开发。</p>
<h3 data-id="heading-1">创建项目</h3>
<p>新建一个文件夹，项目名称自定义（不要使用中文名称）。</p>
<p>打开终端，进入到项目文件夹，在根目录下执行 <code>Node.js</code> 初始化命令：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> -y
</code></pre>
<p>项目目录下会自动生成一个 <code>package.json</code> 的文件。</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"myproject"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"echo <span class="hljs-subst">\"</span>Error: no test specified<span class="hljs-subst">\"</span> &amp;&amp; exit 1"</span>
  },
  <span class="hljs-string">"keywords"</span>: [],
  <span class="hljs-string">"author"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"ISC"</span>
}
</code></pre>
<p>我们简单来了解几个比较重要的字段：</p>
<p><code>name</code>：表示项目的名称。</p>
<p><code>version</code>：项目的版本（默认是1.0.0）。</p>
<p><code>main</code>：入口文件，默认是 <code>index.js</code>。</p>
<p><code>scripts</code>：定义一些常用的命令。</p>
<h3 data-id="heading-2">安装主要依赖</h3>
<p>完成初始化项目后，继续在终端安装项目所需的依赖，执行以下命令：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> express cors dotenv nodemon
</code></pre>
<p><code>express</code>：Node.js最流行的框架之一，用来处理服务端的路由，中间件，静态文件等服务。</p>
<p><code>cors</code>： 解决跨域请求的问题。</p>
<p><code>dotenv</code>：读取.env文件中的环境变量，.env文件通常配置数据库的IP地址，用户名，密码...等重要隐私信息。</p>
<p><code>nodemon</code>：监控服务端代码变化并自动更新，避免每次修改服务端代码都需要重启服务的繁琐流程。</p>
<h3 data-id="heading-3">启动 Node.js 服务</h3>
<p>相关依赖安装完成后，在项目根目录下分别创建 <code>index.js</code> 和 <code>.env</code> 文件</p>
<pre><code class="hljs language-go" lang="go">📦myproject
 ┣ 📜.evn
 ┣ 📜index.js
 ┗ 📜<span class="hljs-keyword">package</span>.json
</code></pre>
<p><code>index.js</code> 作为服务端入口文件，与前文提到的 package.json 中的 main 入口文件相对应。代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>) <span class="hljs-comment">// 引入express框架</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>() <span class="hljs-comment">// 创建一个 express 应用实例</span>
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>) <span class="hljs-comment">// 引入 cors 中间件</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>() <span class="hljs-comment">// 加载环境变量</span>

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>()) <span class="hljs-comment">// 启用 cors 中间件，允许跨域请求</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> })) <span class="hljs-comment">// 处理 application/x-www-form-urlencoded 请求体，解析表单数据</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span> <span class="hljs-comment">// 配置访问端口号</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server is running on port <span class="hljs-subst">${PORT}</span>`</span>);
}) <span class="hljs-comment">// 监听服务，如果服务正常启动会打印该文字</span>
</code></pre>
<p><code>.env</code> 文件用来配置数据库端口、IP、账号、密码，配置如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># MongoDB 配置</span>
<span class="hljs-attr">MONGO_USERNAME</span>=your_name <span class="hljs-comment"># 数据库账号</span>
<span class="hljs-attr">MONGO_PASSWORD</span>=your_password <span class="hljs-comment"># 数据库密码</span>
<span class="hljs-attr">MONGO_HOST</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">0.0</span> <span class="hljs-comment"># 数据库ip地址</span>
<span class="hljs-attr">MONGO_PORT</span>=<span class="hljs-number">27017</span> <span class="hljs-comment"># 端口号，MongoDB通常为27017</span>
<span class="hljs-attr">MONGO_DATABASE</span>=test <span class="hljs-comment"># 要访问的MongoDB 实例下的数据库 </span>

<span class="hljs-comment"># 服务器端口号配置</span>
<span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
</code></pre>
<p><strong>注意：如果项目是使用 git 管理的，那在一定要在 <code>.gitgnore</code> 文件里将 <code>.env</code> 添加进去，避免将<code>.env</code> 文件上传到git仓库中，从而导致隐私信息泄露。</strong></p>
<p>现在我们来启动Node服务，在 <code>package.json</code> 文件中找到 <code>scripts</code>，添加一条常用命令，代码如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon index.js"</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p>保存文件，然后在项目根目录下打开终端，执行 <code>npm run start</code>。</p>
<p>此时如果终端输出 <code>Server is running on port 3000</code> 代表 Node 服务已经成功启动。</p>
<h3 data-id="heading-4">使用Mongoose连接数据库</h3>
<p>现在执行最后一步，使用 <code>Mongoose</code> 连接 <code>MongoDB</code> 数据库。</p>
<p>首先在项目里安装 <code>Mongoose</code>，在项目中打开终端执行 <code>npm i mongoose</code>。</p>
<p>安装完成后，在入口文件 <code>index.js</code> 中使用 <code>Mongoose</code>, 添加代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>) <span class="hljs-comment">// 引入mongoose</span>

<span class="hljs-comment">// 从.env文件中获取环境变量构建 MongoDB 连接字符串</span>
<span class="hljs-comment">// process.env.MONGO_USERNAME：用户名</span>
<span class="hljs-comment">// process.env.MONGO_PASSWORD：密码</span>
<span class="hljs-comment">// process.env.MONGO_HOST：IP地址</span>
<span class="hljs-comment">// process.env.MONGO_PORT：端口号</span>
<span class="hljs-comment">// process.env.MONGO_DATABASE：要连接的数据库</span>

<span class="hljs-keyword">const</span> mongoURL = <span class="hljs-string">`mongodb://<span class="hljs-subst">${process.env.MONGO_USERNAME}</span>:<span class="hljs-subst">${process.env.MONGO_PASSWORD}</span>@<span class="hljs-subst">${process.env.MONGO_HOST}</span>:<span class="hljs-subst">${process.env.MONGO_PORT}</span>/<span class="hljs-subst">${process.env.MONGO_DATABASE}</span>`</span>;

mongoose.<span class="hljs-title function_">connect</span>(mongoURL, {
  <span class="hljs-attr">authSource</span>: <span class="hljs-string">'admin'</span> <span class="hljs-comment">// 指定用户的数据库进行身份验证，默认情况下，认证数据库是 `admin`</span>
})

<span class="hljs-comment">// 连接数据库成功返回的信息</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connected'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connected to MongoDB'</span>)
})

<span class="hljs-comment">// 连接失败返回错误信息</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MongoDB connection error: '</span> + err)
})

<span class="hljs-comment">// 中断连接返回的提示</span>
mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'disconnected'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'MongoDB disconnected'</span>)
})
</code></pre>
<p>代码添加完成后，在项目目录下执行 <code>npm run start</code> 重启服务。</p>
<p>终端如果打印 <code>Connected to MongoDB</code>，则代表连接数据库成功。</p>
<hr/>
<p>至此，我们已经完成了Node项目的创建，并成功的使用 <code>Mongoose</code> 连接上了数据库。</p>
<p>在下一章，我们将学习了解如何使用 <code>Mongoose</code> 定义数据模型并实现基本的增、删、改、查等操作。</p>
<p>如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注），感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>