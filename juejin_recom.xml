<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[剑指offer-70、把数字翻译成为字符串]]></title>    <link>https://juejin.cn/post/7600260767687196698</link>    <guid>https://juejin.cn/post/7600260767687196698</guid>    <pubDate>2026-01-29T00:14:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767687196698" data-draft-id="7598459769238552610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-70、把数字翻译成为字符串"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-29T00:14:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-70、把数字翻译成为字符串
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:14:03.000Z" title="Thu Jan 29 2026 00:14:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>有⼀种将字⺟编码成数字的⽅式：'a'-&gt;1, 'b-&gt;2', ... , 'z-&gt;26'。</p>
<p>现在给⼀串数字，返回有多少种可能的译码结果</p>
<p>示例1
输⼊："12"
返回值：2
说明：2种可能的译码结果（”ab” 或”l”）</p>
<p>示例2
输⼊："31717126241541717"
返回值：192
说明：192种可能的译码结果</p>
<p>仔细观察，就会发现上⾯的编码从 1 到 26，也就是可能⼀次译码使⽤是 1 位，也可能是⼀次译码⽤了 2位，⽐如 12 ，可以第⼀次⽤ 1，2 分开分别译码，也可以把 1，2 合并起来进⾏译码。</p>
<h2 data-id="heading-1">思路及解法</h2>
<h3 data-id="heading-2">暴力递归</h3>
<p>假设⼀个字符是S，第⼀次拆解就有两种情况，然后分别对后⾯的部分分别译码，使⽤递归即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/267dbb39aa15443fa280beb787c9e8ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250443&amp;x-signature=uldx8tdz1ZtqEHub%2FH69MdoQhsY%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution46</span> {
     <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">solve</span> <span class="hljs-params">(String nums)</span> {
     	<span class="hljs-keyword">return</span> recursion(nums.toCharArray(), <span class="hljs-number">0</span>);
     }
    
     <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">char</span>[] nums, <span class="hljs-type">int</span> start)</span>{
         <span class="hljs-keyword">if</span>(start == nums.length){
         	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
         }
         
         <span class="hljs-keyword">if</span>(nums[start] == <span class="hljs-string">'0'</span>)
         	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
         
         <span class="hljs-comment">// 使⽤⼀位字符译码</span>
         <span class="hljs-type">int</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> recursion(nums,start+<span class="hljs-number">1</span>);
         <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
         <span class="hljs-comment">// 符合两位字符的译码</span>
         <span class="hljs-keyword">if</span>((start &lt; nums.length-<span class="hljs-number">1</span>) &amp;&amp; (nums[start] == <span class="hljs-string">'1'</span> || (nums[start] == <span class="hljs-string">'2'</span> &amp;&amp;nums[start+<span class="hljs-number">1</span>] &lt;= <span class="hljs-string">'6'</span>))){
         	count2 = recursion(nums,start+<span class="hljs-number">2</span>);
         }
         <span class="hljs-keyword">return</span> count1 + count2;
     }
}
</code></pre>
<p>但是上⾯的代码时间复杂度太⾼了，只要字符稍微⻓⼀点，运⾏时间就容易超过限制了：</p>
<h3 data-id="heading-3">记忆化递归</h3>
<p>为了避免重复计算子问题，我们使用一个备忘录（<code>memo</code>）来存储已经计算过的结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 备忘录，初始化为-1表示未计算</span>
        Integer[] memo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>[s.length()];
        <span class="hljs-keyword">return</span> dfs(s, <span class="hljs-number">0</span>, memo);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(String s, <span class="hljs-type">int</span> index, Integer[] memo)</span> {
        <span class="hljs-comment">// 基准情况1：成功解码到末尾，算作一种有效方法</span>
        <span class="hljs-keyword">if</span> (index == s.length()) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">// 基准情况2：当前字符是'0'，无法解码，此路径无效</span>
        <span class="hljs-keyword">if</span> (s.charAt(index) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-comment">// 如果当前子问题已经计算过，直接返回结果</span>
        <span class="hljs-keyword">if</span> (memo[index] != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> memo[index];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">ways</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 选择1：解码当前1位数字</span>
        ways += dfs(s, index + <span class="hljs-number">1</span>, memo);
        
        <span class="hljs-comment">// 选择2：如果存在下一位，并且当前两位数字在10-26之间，则解码当前2位数字</span>
        <span class="hljs-keyword">if</span> (index + <span class="hljs-number">1</span> &lt; s.length()) {
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(index) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + (s.charAt(index + <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>);
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                ways += dfs(s, index + <span class="hljs-number">2</span>, memo);
            }
        }
        
        <span class="hljs-comment">// 将结果存入备忘录</span>
        memo[index] = ways;
        <span class="hljs-keyword">return</span> ways;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个子问题最多被计算一次。</li>
<li><strong>空间复杂度</strong>：O(n)，递归栈的深度和备忘录的空间</li>
</ul>
<h3 data-id="heading-4">动态规划</h3>
<p>将过程逆推，要想求得当前的字符串的译码类型，其实有两种，最后⼀个单独翻译，另外⼀种是倒数最后两个字符合起来翻译，这两者之和就是我们所要求的结果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f516444015464593b28bf49ea453996c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250443&amp;x-signature=LBeqh8teE%2Fi6q3LehxeoM8FA%2Fi4%3D" alt="" loading="lazy"/></p>
<p>⽽要求前⾯的值，需要求更前⾯的值，最后⼀定会求得⼀个字符和两个字符的结果。其实这就是动态规划⾥⾯说的状态变化。递归其实就是逆推，这样会导致很多重复的计算。动态规划,则是从⼩数值计算到⼤数值。</p>
<p>既然我们知道是动态规划，定义 dp[i] 为数字串从左到右第i个数字结尾的当前数字串所拥有的翻译⽅法数，接着就需要找出状态转移⽅程：</p>
<ul>
<li>如果 i=0 , dp[i]=1</li>
<li>否则
<ul>
<li>如果nums[i]=0，说明需要和前⾯⼀个字符⼀起翻译
<ul>
<li>如果i == 1，以10或者20开头， dp[i] = 1</li>
<li>否则，数字串中存在10或者20的情况下，当前译码数等于后退两步的译码数， dp[i] =dp[i-2];</li>
</ul>
</li>
<li>否则，在符合字符范围内， dp[i]=dp[i-1]+dp[i-2]</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span> || s.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 处理空串或以'0'开头的无效情况</span>
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        <span class="hljs-type">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n + <span class="hljs-number">1</span>];
        <span class="hljs-comment">// 初始化</span>
        dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 空字符串有一种解码方式（解码为空）</span>
        dp[<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 第一个字符只要不是'0'（前面已判断），就有1种解码方式</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= n; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">oneDigit</span> <span class="hljs-operator">=</span> s.charAt(i - <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>;  <span class="hljs-comment">// 看最后一个字符（1位数字）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(i - <span class="hljs-number">2</span>) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + oneDigit; <span class="hljs-comment">// 看最后两个字符（2位数字）</span>

            <span class="hljs-comment">// 情况1：最后一个字符可以单独解码（必须是1-9）</span>
            <span class="hljs-keyword">if</span> (oneDigit &gt;= <span class="hljs-number">1</span> &amp;&amp; oneDigit &lt;= <span class="hljs-number">9</span>) {
                dp[i] += dp[i - <span class="hljs-number">1</span>];
            }
            <span class="hljs-comment">// 情况2：最后两个字符可以组合解码（必须是10-26）</span>
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                dp[i] += dp[i - <span class="hljs-number">2</span>];
            }
        }
        <span class="hljs-keyword">return</span> dp[n];
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，需要遍历整个字符串一次。</li>
<li><strong>空间复杂度</strong>：O(n)，用于存储 <code>dp</code>数组。</li>
</ul>
<h3 data-id="heading-5">空间优化动态规划（推荐）</h3>
<p>观察上面的代码可以发现，计算 <code>dp[i]</code>时只依赖于 <code>dp[i-1]</code>和 <code>dp[i-2]</code>。因此，我们可以不用维护整个数组，只用两个变量来滚动记录之前的状态即可，从而将空间复杂度优化到常数级别。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">numDecodings</span><span class="hljs-params">(String s)</span> {
        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> || s.length() == <span class="hljs-number">0</span> || s.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'0'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();
        <span class="hljs-comment">// 使用变量替代dp数组</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">prevPrev</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 对应于 dp[i-2]，初始化为dp[0]=1</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;     <span class="hljs-comment">// 对应于 dp[i-1]，初始化为dp[1]=1</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt;= n; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">oneDigit</span> <span class="hljs-operator">=</span> s.charAt(i - <span class="hljs-number">1</span>) - <span class="hljs-string">'0'</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">twoDigits</span> <span class="hljs-operator">=</span> (s.charAt(i - <span class="hljs-number">2</span>) - <span class="hljs-string">'0'</span>) * <span class="hljs-number">10</span> + oneDigit;

            <span class="hljs-comment">// 情况1：单独解码最后一个字符</span>
            <span class="hljs-keyword">if</span> (oneDigit &gt;= <span class="hljs-number">1</span> &amp;&amp; oneDigit &lt;= <span class="hljs-number">9</span>) {
                current += prev; <span class="hljs-comment">// 相当于 dp[i] += dp[i-1]</span>
            }
            <span class="hljs-comment">// 情况2：组合解码最后两个字符</span>
            <span class="hljs-keyword">if</span> (twoDigits &gt;= <span class="hljs-number">10</span> &amp;&amp; twoDigits &lt;= <span class="hljs-number">26</span>) {
                current += prevPrev; <span class="hljs-comment">// 相当于 dp[i] += dp[i-2]</span>
            }
            
            <span class="hljs-comment">// 滚动更新变量，为下一次迭代做准备</span>
            prevPrev = prev;
            prev = current;
        }
        <span class="hljs-keyword">return</span> prev;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)。</li>
<li><strong>空间复杂度</strong>：O(1)，只使用了固定数量的变量</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？]]></title>    <link>https://juejin.cn/post/7600265780349861928</link>    <guid>https://juejin.cn/post/7600265780349861928</guid>    <pubDate>2026-01-29T00:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600265780349861928" data-draft-id="7600296037542674432" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T00:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:17:20.000Z" title="Thu Jan 29 2026 00:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，以其“约定优于配置”的理念和丰富的 Starter 依赖极大地简化了开发流程。然而，很多开发者仅停留在基础用法上，忽略了 SpringBoot 提供的一些隐藏技巧。这些技巧不仅能减少样板代码，还能显著提升开发效率。本文将深入剖析 <strong>5 个鲜为人知但极其实用的 SpringBoot 技巧</strong>，帮助你从“会用”进阶到“精通”。</p>
<hr/>
<h3 data-id="heading-2">1. Lombok + @Builder.Default：优雅处理默认值</h3>
<h4 data-id="heading-3">问题场景</h4>
<p>在实体类或 DTO 中，我们经常需要为字段设置默认值。传统做法是在构造函数或 <code>@Data</code> 注解生成的 <code>setter</code> 方法中硬编码，但这会导致代码冗余且难以维护。</p>
<h4 data-id="heading-4">解决方案</h4>
<p>结合 Lombok 的 <code>@Builder</code> 和 <code>@Builder.Default</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACTIVE"</span>;
    
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">createdAt</span> <span class="hljs-operator">=</span> LocalDateTime.now();
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>清晰直观</strong>：通过注解显式声明默认值。</li>
<li><strong>线程安全</strong>：每次构建对象时会重新计算默认值（如 <code>LocalDateTime.now()</code>）。</li>
<li><strong>与 Jackson 无缝集成</strong>：反序列化时自动应用默认值。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">注意事项</h4>
<ul>
<li>Lombok v1.18.4+ 版本支持此特性。</li>
<li>避免在 <code>@Builder.Default</code> 中使用可变对象（如 <code>List</code>），建议用不可变集合（如 <code>Collections.unmodifiableList</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. @ConfigurationProperties + Validation：强类型的配置管理</h3>
<h4 data-id="heading-7">问题场景</h4>
<p>SpringBoot 的 <code>application.properties</code>/<code>.yml</code> 通常通过 <code>@Value</code>注入，但这种方式缺乏类型安全和结构化验证。</p>
<h4 data-id="heading-8">解决方案</h4>
<p>使用 <code>@ConfigurationProperties</code> + JSR-303 Validation：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">app:</span>
   <span class="hljs-attr">max-retry:</span> <span class="hljs-number">3</span>
   <span class="hljs-attr">endpoints:</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/users"</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/products"</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Min(1)</span> <span class="hljs-meta">@Max(10)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxRetry;
    
    <span class="hljs-meta">@NotEmpty</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; endpoints;
    
    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>类型安全</strong>：避免拼写错误和类型转换问题。</li>
<li><strong>自动补全支持</strong>：IDE（如 IntelliJ）能识别配置项。</li>
<li><strong>启动时验证</strong>：配置错误会直接抛出异常。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">进阶技巧</h4>
<p>通过 <code>spring-boot-configuration-processor</code>生成元数据文件，实现配置提示：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">3. Spring DevTools + LiveReload：极速热部署</h3>
<h4 data-id="heading-11">Why DevTools?</h4>
<p>传统的重启式热部署（如 JRebel）需要付费或复杂配置。Spring DevTools是官方提供的免费方案：</p>
<ol>
<li><strong>快速重启</strong>：仅重载变更的类（比冷启动快5-10倍）。</li>
<li><strong>LiveReload集成</strong>：自动刷新浏览器（需安装LiveReload插件）。</li>
</ol>
<h4 data-id="heading-12">Hidden Features:</h4>
<ul>
<li><strong>排除静态资源重启</strong>：</li>
</ul>
<pre><code class="hljs language-properties" lang="properties">spring.devtools.restart.exclude=static/**
</code></pre>
<ul>
<li><strong>远程调试支持</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run -Dspring.devtools.restart.enabled=<span class="hljs-literal">true</span> 
</code></pre>
<h4 data-id="heading-13">Profiling结果对比：</h4>

















<table><thead><tr><th>Method</th><th>Avg Restart Time</th></tr></thead><tbody><tr><td>Cold Start</td><td>~8s</td></tr><tr><td>With DevTools</td><td>~1s</td></tr></tbody></table>
<hr/>
<p>###4 .自定义FailureAnalyzer ：让启动错误一目了然</p>
<p>当SpringBoot应用启动失败时,默认的错误日志可能晦涩难懂 。通过实现FailureAnalyzer接口,可以将底层异常转换为友好的错误提示 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanFailureAnalyzer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FailureAnalyzer</span> {
<span class="hljs-meta">@Override</span> 
<span class="hljs-keyword">public</span> FailureAnalysis <span class="hljs-title function_">analyze</span><span class="hljs-params">(Throwable failure)</span> { 
<span class="hljs-keyword">if</span> (failure <span class="hljs-keyword">instanceof</span> UnsatisfiedDependencyException ex) { 
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FailureAnalysis</span>(
<span class="hljs-string">"Bean依赖注入失败: "</span>+ex.getInjectionPoint(),
<span class="hljs-string">"检查是否存在对应的Bean定义"</span>, 
failure); } <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; } }
</code></pre>
<p>注册到META-INF/spring.factories :</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.diagnostics.FailureAnalyzer</span>=\ com.example.MyBeanFailureAnalyzer 
</code></pre>
<p>效果对比 :</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Before : NoSuchBeanDefinitionException ... 
After : [ACTION REQUIRED] Bean依赖注入失败: UserService.userDao → Check <span class="hljs-keyword">if</span> <span class="hljs-meta">@Repository</span> <span class="hljs-keyword">is</span> missing!
</code></pre>
<hr/>
<p>###5 .Smart Initialization ：优化启动性能</p>
<p>SpringBoot默认按顺序初始化所有Bean,导致启动慢 。通过以下方式优化 :</p>
<p>1 .懒加载特定Bean :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Lazy</span> <span class="hljs-meta">@Service</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyService</span> { ... } 
</code></pre>
<p>2 .分批初始化 (Spring Boot2.4+) :</p>
<pre><code class="hljs language-properties" lang="properties">spring.main.lazy-initialization=true #全局懒加载 spring.main.eager-init-beans[0]=criticalService #强制提前加载关键Bean 
</code></pre>
<p>3 .使用ApplicationRunner控制顺序 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Order(1)</span> <span class="hljs-meta">@Bean</span> <span class="hljs-keyword">public</span> ApplicationRunner <span class="hljs-title function_">initDB</span><span class="hljs-params">()</span> { .. } 

实测效果 (基于<span class="hljs-number">100</span>个Bean的项目 ):
| Configuration       | Startup Time |
|----------------------|--------------|
| Default              | ~12s         |
| Smart Initialization | ~6s          |
</code></pre>
<hr/>
<p>###总结</p>
<p>本文揭示的五个技巧覆盖了从编码 、配置到调试 、优化的完整链路 :</p>
<p>• Lombok的 Builder.Default →减少样板代码 • ConfigurationProperties →强化配置管理 • DevTools深度使用 →加速开发循环 • Custom FailureAnalyzer →提升可维护性 • Smart Initialization →优化运行时性能</p>
<p>掌握这些鲜为人知却至关重要的技术 ,你的SpringBoot开发效率将产生质的飞跃 。建议收藏本文并实践每一个案例 ,它们都来自真实项目的最佳实践 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你知道 Android 有哪些 Drawable 吗？]]></title>    <link>https://juejin.cn/post/7600292312216600628</link>    <guid>https://juejin.cn/post/7600292312216600628</guid>    <pubDate>2026-01-29T00:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600292312216600628" data-draft-id="7598537377472200742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你知道 Android 有哪些 Drawable 吗？"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-01-29T00:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你知道 Android 有哪些 Drawable 吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:14:35.000Z" title="Thu Jan 29 2026 00:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为小说《逆袭西二旗》的技术讲解，用于详细说明<a href="https://juejin.cn/post/7599600549763629091" target="_blank" title="https://juejin.cn/post/7599600549763629091">剧情</a>里涉及的开发细节。</em></p>
<h2 data-id="heading-0">如何使用 Drawable</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eebcd1bc50d476b989dc0b70fb8f785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=Y%2FhSaTw%2BJh4nB6S6wnz%2FfR8J0%2FM%3D" alt="00.png" loading="lazy"/></p>
<p><code>Drawable</code> 是一个通用抽象概念，代表任何可以绘制在屏幕上的内容。它是各种图形内容（如图像、矢量图形和基于形状的元素）的基类。</p>
<p><code>Drawable</code> 广泛用于 UI 组件中，包括背景、按钮、图标和自定义视图。</p>
<p>Android 提供了不同类型的 <code>Drawable</code> 对象，每种都针对特定的使用场景设计。</p>
<h3 data-id="heading-1">面试问题</h3>
<p>如何仅使用 <code>Drawable</code> 创建一个动态背景，使其能根据用户交互改变形状和颜色？</p>
<h3 data-id="heading-2">BitmapDrawable</h3>
<p><code>BitmapDrawable</code> 用于显示 <strong>PNG</strong>、<strong>JPG</strong> 或 <strong>GIF</strong> 等光栅图像。它支持对 Bitmap 图像进行缩放、平铺和过滤。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bitmap</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/sample_image"</span>
    <span class="hljs-attr">android:tileMode</span>=<span class="hljs-string">"repeat"</span> /&gt;</span>
</code></pre>
<p>这通常用于在 <code>ImageView</code> 组件中显示图像或作为背景（对于列表的分割线，极为有用）。</p>
<h3 data-id="heading-3">VectorDrawable</h3>
<p><code>VectorDrawable</code> 使用 XML 路径表示可缩放矢量图形（类 SVG）。与位图不同，矢量图形在任何分辨率下都能保持质量。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">vector</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:width</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:height</span>=<span class="hljs-string">"24dp"</span>
    <span class="hljs-attr">android:viewportWidth</span>=<span class="hljs-string">"24"</span>
    <span class="hljs-attr">android:viewportHeight</span>=<span class="hljs-string">"24"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">path</span>
        <span class="hljs-attr">android:fillColor</span>=<span class="hljs-string">"#FF0000"</span>
        <span class="hljs-attr">android:pathData</span>=<span class="hljs-string">"M12,2L15,8H9L12,2Z"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">vector</span>&gt;</span>
</code></pre>
<p><code>VectorDrawable</code> 非常适合图标、Logo 和可缩放 UI 元素，以避免在不同屏幕密度下出现像素化问题。</p>
<h3 data-id="heading-4">NinePatchDrawable</h3>
<p><code>NinePatchDrawable</code> 是一种特殊的 <code>bitmap</code>，允许在调整大小时保留特定区域（如四周的角）。它非常适合创建可拉伸的 UI 组件，如聊天气泡和按钮。</p>
<p><em>你的 <code>.9</code> 在运行的时会自动转换成 <code>NinePatchDrawable</code>，开发者自己一般不手动创建 <code>NinePatchDrawable</code>。</em></p>
<p>一个 <code>.9</code> 图片包含额外的 1 像素边框，用于定义可拉伸区域和固定区域。</p>
<p>要创建 <code>.9.png</code> 文件，请使用 Android Studio 的工具定义可拉伸区域。</p>
<p><em>我工作中发现很多开发不知道 Android Studio 有 <code>.9</code> 制作工具，很多时候都是让 UI 去做的。这样做合理，但是沟通成本太高了，很多 UI 不明白 <code>.9</code> 的工作原理，导致做出来的 <code>.9</code> 反而不满足 UI 的设计。</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82f3304df99f42a9a5b335bac16b934d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=y7vcLJu8OHYnOrp6TUu3G6wisws%3D" alt="33.png" loading="lazy"/></p>
<p><em>如图所示，在图片上右键，会出现 <strong>Create 9-Patch file</strong> 选项。</em></p>
<h3 data-id="heading-5">ShapeDrawable</h3>
<p><code>ShapeDrawable</code> 在 XML 中定义，可用于创建圆角矩形、椭圆或其他简单形状，而无需使用图像。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">shape</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:shape</span>=<span class="hljs-string">"rectangle"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">solid</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">"#FF5733"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">corners</span> <span class="hljs-attr">android:radius</span>=<span class="hljs-string">"8dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">shape</span>&gt;</span>
</code></pre>
<p><code>ShapeDrawable</code> 可用于按钮、背景和自定义 UI 组件。</p>
<p>因为 <code>ShapeDrawable</code> 不需要 UI 参与制作，所以它对研发来讲，能迅速的完成 UI 实现，同时还能显著的缩小 APK 大小。</p>
<h3 data-id="heading-6">LayerDrawable</h3>
<p><code>LayerDrawable</code> 用于将多个 <code>Drawable</code> 组合成一个单层结构，适用于复杂的 UI 背景。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">layer-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">shape</span> <span class="hljs-attr">android:shape</span>=<span class="hljs-string">"rectangle"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">solid</span> <span class="hljs-attr">android:color</span>=<span class="hljs-string">"#000000"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">shape</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/icon"</span> <span class="hljs-attr">android:top</span>=<span class="hljs-string">"10dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">layer-list</span>&gt;</span>
</code></pre>
<p>这可用于创建叠加效果和堆叠视觉元素。</p>
<h3 data-id="heading-7">总结</h3>
<p><code>Drawable</code> 类提供了一种灵活的方式来处理 Android 中的不同类型图形。</p>
<p>选择合适的 <code>Drawable</code> 取决于使用场景，例如设计需求、可扩展性和 UI 复杂度。通过利用这些不同的 <code>Drawable</code> 类型，开发者可以在 <code>Android</code> 应用中创建经过优化且视觉吸引人的 UI 组件。</p>
<h2 data-id="heading-8">如何高效处理大型 Bitmap？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b9f656af6dc4159a6424e6c45adee50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=G3EGaGib5wvNwaASrW4eA%2F7Mk3Q%3D" alt="11.png" loading="lazy"/></p>
<p>Bitmap 是内存中图像的表示形式。它存储像素数据，通常用于在屏幕上渲染图像，无论这些图像来自资源、文件还是远程源。</p>
<p>由于 Bitmap 对象会保存大量像素数据，尤其是高分辨率图像，处理不当很容易导致内存耗尽和 <code>OutOfMemoryError</code>。</p>
<h3 data-id="heading-9">面试问题</h3>
<p>将大型 Bitmap 加载到内存中有哪些风险？</p>
<p>如何避免这些风险？</p>
<h3 data-id="heading-10">大型 Bitmap 的问题</h3>
<p>许多图像（例如来自相机或从互联网下载的图像）比显示它们的 UI 组件所需的尺寸大得多。不必要地加载这些全分辨率图像会：</p>
<ul>
<li>消耗过多内存</li>
<li>带来性能开销</li>
<li>导致应用因内存压力而崩溃</li>
</ul>
<h3 data-id="heading-11">不分配内存读取 Bitmap 尺寸</h3>
<p>在加载 Bitmap 之前，检查其尺寸以决定是否需要完整加载非常重要。<code>BitmapFactory.Options</code> 类允许你设置 <code>inJustDecodeBounds = true</code>，这样可以在不分配内存存储像素数据的情况下解码图像元数据：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> options = BitmapFactory.Options().apply {
    inJustDecodeBounds = <span class="hljs-literal">true</span>
}
BitmapFactory.decodeResource(resources, R.id.myimage, options)

<span class="hljs-keyword">val</span> imageWidth = options.outWidth
<span class="hljs-keyword">val</span> imageHeight = options.outHeight
<span class="hljs-keyword">val</span> imageType = options.outMimeType
</code></pre>
<p><em><code>inJustDecodeBounds</code> 这个参数的意思就是仅解析图片的元数据（如宽高、MIME 类型等），而不实际加载像素数据到内存中。</em></p>
<p>这一步有助于评估图像尺寸是否符合你的显示需求，从而避免不必要的内存分配。</p>
<h3 data-id="heading-12">使用采样加载缩小的 Bitmap</h3>
<p>一旦知道了尺寸，你可以使用 <code>inSampleSize</code> 选项将 Bitmap 缩小到适合目标尺寸。这会通过以 2、4 等因子（一般给 2 的 N 次方）对图像进行下采样来减少内存使用。例如，一个 2048×1536 的图像在 <code>inSampleSize = 4</code> 时会被加载为 512×384 的 Bitmap：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateInSampleSize</span><span class="hljs-params">(options: <span class="hljs-type">BitmapFactory</span>.<span class="hljs-type">Options</span>, reqWidth: <span class="hljs-type">Int</span>, reqHeight: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">var</span> inSampleSize = <span class="hljs-number">1</span>
    <span class="hljs-keyword">val</span> (height, width) = options.run { outHeight to outWidth }

    <span class="hljs-keyword">if</span> (height &gt; reqHeight || width &gt; reqWidth) {
        <span class="hljs-keyword">val</span> halfHeight = height / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> halfWidth = width / <span class="hljs-number">2</span>
        <span class="hljs-keyword">while</span> (halfHeight / inSampleSize &gt;= reqHeight &amp;&amp; halfWidth / inSampleSize &gt;= reqWidth) {
            inSampleSize *= <span class="hljs-number">2</span>
        }
    }
    <span class="hljs-keyword">return</span> inSampleSize
}
</code></pre>
<p>这有助于在图像质量和内存效率之间取得平衡。</p>
<h3 data-id="heading-13">完整解码流程</h3>
<p>使用 <code>calculateInSampleSize</code>，你可以分两步解码 Bitmap：</p>
<ol>
<li>仅解码边界。</li>
<li>设置计算出的 <code>inSampleSize</code> 并解码缩放后的 Bitmap。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decodeSampledBitmapFromResource</span><span class="hljs-params">(
    res: <span class="hljs-type">Resources</span>,
    resId: <span class="hljs-type">Int</span>,
    reqWidth: <span class="hljs-type">Int</span>,
    reqHeight: <span class="hljs-type">Int</span>
)</span></span>: Bitmap {
    <span class="hljs-keyword">return</span> BitmapFactory.Options().run {
        inJustDecodeBounds = <span class="hljs-literal">true</span>
        BitmapFactory.decodeResource(res, resId, <span class="hljs-keyword">this</span>)

        inSampleSize = calculateInSampleSize(<span class="hljs-keyword">this</span>, reqWidth, reqHeight)
        inJustDecodeBounds = <span class="hljs-literal">false</span>

        BitmapFactory.decodeResource(res, resId, <span class="hljs-keyword">this</span>)
    }
}
</code></pre>
<p>要在 <code>ImageView</code> 中使用它，只需调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">imageview.setImageBitmap(
    decodeSampledBitmapFromResource(resources, R.id.myimage, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>)
)
</code></pre>
<p>这种方法确保你的 UI 获得尺寸合适的图像，同时优化了内存使用。</p>
<h3 data-id="heading-14">总结</h3>
<p>Bitmap 是 Android 中内存密集型的图像表示形式。为避免性能问题和崩溃，首先使用 <code>inJustDecodeBounds</code> 检查图像尺寸，然后使用 <code>inSampleSize</code> 对大型 Bitmap 进行下采样，只加载需要的部分，最后使用两步策略进行高效解码和缩放。</p>
<p>这个过程对于在内存受限的设备上构建处理大量图像的稳健应用至关重要。</p>
<h3 data-id="heading-15">进阶：为大型 Bitmap 实现缓存</h3>
<p>高效管理大型 Bitmap 对于构建流畅、内存安全的 Android 应用至关重要——尤其是在处理图像列表、网格或轮播时。
Android 提供了两种有效的策略：使用 <code>LruCache</code> 进行内存缓存，以及使用 <code>DiskLruCache</code> 进行基于磁盘的缓存。</p>
<p>大名鼎鼎的 <code>Glide</code> 广泛使用了 <code>LruCache</code> 和 <code>DiskLruCache</code> 相关技术，不过其实现比直接使用这两个类更复杂、更模块化，并且做了大量优化。</p>
<p>先来看看如何使用 <code>LruCache</code> 进行内存缓存。</p>
<p><code>LruCache</code> 是 Bitmap 的首选内存缓存解决方案。它会保留对最近使用项的强引用，并在内存紧张时自动回收最少使用的项。工作原理如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> LruCacheManager {
    <span class="hljs-keyword">val</span> maxMemory = (Runtime.getRuntime().maxMemory() / <span class="hljs-number">1024</span>).toInt()
    <span class="hljs-keyword">val</span> cacheSize = maxMemory / <span class="hljs-number">8</span>

    <span class="hljs-keyword">val</span> memoryCache = <span class="hljs-keyword">object</span> : LruCache&lt;String, Bitmap&gt;(cacheSize) {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sizeOf</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: <span class="hljs-built_in">Int</span> {
            <span class="hljs-keyword">return</span> bitmap.byteCount / <span class="hljs-number">1024</span>
        }
    }
}
</code></pre>
<p>分配约 1/8 的可用内存以确保安全。此设置可快速访问图像并避免重复解码。使用方式如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadBitmap</span><span class="hljs-params">(imageId: <span class="hljs-type">Int</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
    <span class="hljs-keyword">val</span> key = imageId.toString()
    LruCacheManager.memoryCache.<span class="hljs-keyword">get</span>(key)?.let {
        imageView.setImageBitmap(it)
    } ?: run {
        imageView.setImageResource(R.drawable.image_placeholder)

        <span class="hljs-keyword">val</span> workRequest = OneTimeWorkRequestBuilder&lt;BitmapDecodeWorker&gt;()
            .setInputData(workDataOf(<span class="hljs-string">"imageId"</span> to imageId))
            .build()
        WorkManager.getInstance(context).enqueue(workRequest)
    }
}
</code></pre>
<p>在 <code>Worker</code> 中实现如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapDecodeWorker</span>(
    context: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(context, workerParams) {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span>: Result {
        <span class="hljs-keyword">val</span> imageId = inputData.getInt(<span class="hljs-string">"imageId"</span>, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> (imageId == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> Result.failure()

        <span class="hljs-keyword">val</span> bitmap = decodeSampledBitmapFromResource(
            applicationContext.resources,
            imageId,
            reqWidth = <span class="hljs-number">100</span>,
            reqHeight = <span class="hljs-number">100</span>
        )

        bitmap?.let {
            LruCacheManager.memoryCache.put(imageId.toString(), it)
            <span class="hljs-keyword">return</span> Result.success()
        }
        <span class="hljs-keyword">return</span> Result.failure()
    }
}
</code></pre>
<p>接下来，使用 DiskLruCache 进行磁盘缓存。</p>
<p>在 Android 中，内存是有限且易失的。为确保 Bitmap 在应用会话之间持久化并避免重新计算，你可以使用 <code>DiskLruCache</code> 库将 Bitmap 存储在磁盘上。</p>
<p>这对于资源密集型图像或处理可滚动图像列表特别有用。</p>
<p>首先，编写 <code>DiskCacheManager</code>，它包装 <code>DiskLruCache</code>，提供安全的哈希和 I/O 逻辑来持久化解码后的 Bitmap：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DiskCacheManager</span>(<span class="hljs-keyword">val</span> context: Context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cachePath = context.cacheDir.path + File.separator + <span class="hljs-string">"images"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cacheFile = File(cachePath)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> diskLruCache = DiskLruCache.<span class="hljs-keyword">open</span>(cacheFile, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span> <span class="hljs-comment">/* 10 megabytes */</span>)

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">filenameForKey</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> MessageDigest
            .getInstance(<span class="hljs-string">"SHA-1"</span>)
            .digest(key.toByteArray())
            .joinToString(separator = <span class="hljs-string">""</span>, transform = { Integer.toHexString(<span class="hljs-number">0xFF</span> and it.toInt()) })
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">get</span><span class="hljs-params">(key: <span class="hljs-type">String</span>)</span></span>: Bitmap? {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> filename = filenameForKey(key)
            <span class="hljs-keyword">val</span> inputStream = diskLruCache.<span class="hljs-keyword">get</span>(filename).getInputStream(<span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> BitmapFactory.decodeStream(inputStream)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">set</span><span class="hljs-params">(key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span> {
        <span class="hljs-keyword">val</span> filename = filenameForKey(key)
        <span class="hljs-keyword">val</span> snapshot = diskLruCache.<span class="hljs-keyword">get</span>(filename)
        <span class="hljs-keyword">if</span> (snapshot == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">val</span> editor = diskLruCache.edit(filename)
            <span class="hljs-keyword">val</span> outputStream = editor.newOutputStream(<span class="hljs-number">0</span>)
            bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="hljs-number">100</span>, outputStream)
            editor.commit()
            outputStream.close()
        }
        snapshot?.getInputStream(<span class="hljs-number">0</span>)?.close()
    }
}
</code></pre>
<p>这个类确保：</p>
<ul>
<li>基于 SHA-1 的安全文件名生成</li>
<li>安全的 I/O 操作</li>
<li>避免重复写入</li>
</ul>
<p>接下来，使用 <strong>WorkManager</strong> 的 <code>CoroutineWorker</code> 在主线程之外执行磁盘缓存，安全地结合内存和磁盘策略：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BitmapWorker</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context,
    workerParams: WorkerParameters
) : CoroutineWorker(context, workerParams) {

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span>: Result {
        <span class="hljs-keyword">val</span> key = inputData.getString(<span class="hljs-string">"imageKey"</span>) ?: <span class="hljs-keyword">return</span> Result.failure()
        <span class="hljs-keyword">val</span> resId = inputData.getInt(<span class="hljs-string">"resId"</span>, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> (resId == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> Result.failure()

        <span class="hljs-comment">// 先尝试磁盘缓存</span>
        <span class="hljs-keyword">val</span> bitmapFromDisk = getBitmapFromDiskCache(key)
        <span class="hljs-keyword">if</span> (bitmapFromDisk != <span class="hljs-literal">null</span>) {
            LruCacheManager.memoryCache.put(key, bitmapFromDisk)
            <span class="hljs-keyword">return</span> Result.success()
        }

        <span class="hljs-comment">// 如果未找到则解码并缓存</span>
        <span class="hljs-keyword">val</span> bitmap = decodeSampledBitmapFromResource(
            applicationContext.resources,
            resId,
            reqWidth = <span class="hljs-number">100</span>,
            reqHeight = <span class="hljs-number">100</span>
        )

        <span class="hljs-comment">// 你必须将此移到 Application 类中，或者从依赖注入获取实例。</span>
        <span class="hljs-comment">// 如果每次 Worker 执行时都创建实例，磁盘缓存就失去了意义。</span>
        <span class="hljs-keyword">val</span> diskCacheManager = DiskCacheManager(context)
        <span class="hljs-keyword">try</span> {
            addBitmapToCache(diskCacheManager, key, bitmap)
            <span class="hljs-keyword">return</span> Result.success()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-keyword">return</span> Result.failure()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addBitmapToCache</span><span class="hljs-params">(diskCacheManager: <span class="hljs-type">DiskCacheManager</span>, key: <span class="hljs-type">String</span>, bitmap: <span class="hljs-type">Bitmap</span>)</span></span> {
        <span class="hljs-keyword">if</span> (LruCacheManager.memoryCache.<span class="hljs-keyword">get</span>(key) == <span class="hljs-literal">null</span>) {
            LruCacheManager.memoryCache.put(key, bitmap)
        }

        <span class="hljs-keyword">if</span> (diskCacheManager.<span class="hljs-keyword">get</span>(key) != <span class="hljs-literal">null</span>) {
            diskCacheManager.<span class="hljs-keyword">set</span>(key, bitmap)
        }
    }
}
</code></pre>
<p>这个 <code>Worker</code>：</p>
<ul>
<li>尽可能从磁盘读取</li>
<li>如果未找到则回退到解码</li>
<li>将结果存储到内存和磁盘缓存中</li>
<li>在主线程之外安全运行</li>
</ul>
<p>总之。</p>
<p>要在 Android 中高效缓存大型 Bitmap，请使用 <code>LruCache</code> 进行快速的最近访问内存缓存，并使用 <code>DiskLruCache</code> 在应用会话之外持久化 Bitmap。</p>
<p>结合这两种策略，并在配置更改时保留内存缓存，以获得无缝体验。</p>
<p>通过使用 <strong>WorkManager</strong> 进行适当的初始化和后台工作，这种混合功能可以提高处理大型 Bitmap 时的应用性能和用户体验。</p>
<p><em>使用 <strong>WorkManager</strong> 是可选项，你可以使用协程，后台现成来完成这工作。不过各位有兴趣可以看看 <strong>WorkManager</strong>，在运行长时间的，不确定的后台任务时，<strong>WorkManager</strong> 是非常棒的选择。</em></p>
<h2 data-id="heading-16">如何实现动画</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ebfc21301be4334b2d43cb7874ce147~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770250474&amp;x-signature=M3bwKODSl8RCBG0hYH89ej0sSlY%3D" alt="22.png" loading="lazy"/></p>
<p>动画通过创建平滑过渡、吸引对变化的注意力并提供视觉反馈来增强用户体验。Android 提供了多种实现动画的机制，从基本的属性变化到复杂的布局动画。</p>
<h3 data-id="heading-17">面试问题</h3>
<p>如何实现按钮在点击时平滑地展开和收缩，并确保其高效运行？</p>
<p>何时使用 <code>MotionLayout</code> 而不是传统的 <code>View</code> 动画？它有哪些优势？</p>
<h3 data-id="heading-18">View 属性动画</h3>
<p>在 API 级别 11 中引入，<code>View</code> 属性动画允许你为 <code>View</code> 对象的属性（如 <code>alpha</code>、<code>translationX</code>、<code>translationY</code>、<code>rotation</code> 和 <code>scaleX</code>）设置动画。</p>
<p>这种方法非常适合简单的变换。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> view: View = findViewById(R.id.my_view)
view.animate()
    .alpha(<span class="hljs-number">0.5f</span>)
    .translationX(<span class="hljs-number">100f</span>)
    .setDuration(<span class="hljs-number">500</span>)
    .start()
</code></pre>
<h3 data-id="heading-19">ObjectAnimator</h3>
<p><code>ObjectAnimator</code> 允许你为任何具有 <code>setter</code> 方法的对象的属性设置动画，而不仅仅是 <code>View</code> 对象（有  <code>setter</code> 方法皆可，可以是一个普通类）。它为动画自定义属性提供了更大的灵活性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">300f</span>)
animator.duration = <span class="hljs-number">500</span>
animator.start()
</code></pre>
<h3 data-id="heading-20">AnimatorSet</h3>
<p><code>AnimatorSet</code> 可以组合多个动画，使其按顺序或同时运行，非常适合协调复杂的动画。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> fadeAnimator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"alpha"</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>)
<span class="hljs-keyword">val</span> moveAnimator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">200f</span>)

<span class="hljs-keyword">val</span> animatorSet = AnimatorSet()
animatorSet.playSequentially(fadeAnimator, moveAnimator)
animatorSet.duration = <span class="hljs-number">1000</span>
animatorSet.start()
</code></pre>
<h3 data-id="heading-21">ValueAnimator</h3>
<p><code>ValueAnimator</code> 提供了在任意值之间进行动画的功能，可高度定制且灵活。
通过使用插值器控制动画进度，它可以适应各种使用场景，例如为宽度、高度、alpha 或任何其他属性设置动画。
这使其成为为特定需求定制精确且动态动画的绝佳选择。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> valueAnimator = ValueAnimator.ofInt(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)
valueAnimator.duration = <span class="hljs-number">500</span>
valueAnimator.addUpdateListener { animation -&gt;
    <span class="hljs-keyword">val</span> animatedValue = animation.animatedValue <span class="hljs-keyword">as</span> <span class="hljs-built_in">Int</span>
    binding.progressbar.updateLayoutParams {
        width = (screenSize / <span class="hljs-number">100</span>) * animatedValue.toInt()
    }
}
valueAnimator.start()
</code></pre>
<h3 data-id="heading-22">基于 XML 的 View 动画</h3>
<p>基于 XML 的动画在资源文件中定义，以实现简洁性和可重用性。这些动画可以影响位置、缩放、旋转和透明度。</p>
<p>下面是一个 XML 示例：<code>res/anim/slide_in.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">translate</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:fromXDelta</span>=<span class="hljs-string">"-100%"</span>
    <span class="hljs-attr">android:toXDelta</span>=<span class="hljs-string">"0%"</span>
    <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"500"</span> /&gt;</span>
</code></pre>
<p>使用方法也非常简单：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animation = AnimationUtils.loadAnimation(<span class="hljs-keyword">this</span>, R.anim.slide_in)
view.startAnimation(animation)
</code></pre>
<h3 data-id="heading-23">MotionLayout</h3>
<p><code>MotionLayout</code> 是 Android 中创建复杂运动和布局动画的强大工具。它构建在 <code>ConstraintLayout</code> 之上，允许你使用 XML 定义动画和状态之间的过渡。</p>
<p>XML 示例：<code>res/layout/motion_scene.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MotionScene</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Transition</span>
        <span class="hljs-attr">app:constraintSetStart</span>=<span class="hljs-string">"@id/start"</span>
        <span class="hljs-attr">app:constraintSetEnd</span>=<span class="hljs-string">"@id/end"</span>
        <span class="hljs-attr">app:duration</span>=<span class="hljs-string">"500"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">OnSwipe</span>
            <span class="hljs-attr">app:touchAnchorId</span>=<span class="hljs-string">"@id/box"</span>
            <span class="hljs-attr">app:touchAnchorSide</span>=<span class="hljs-string">"top"</span>
            <span class="hljs-attr">app:dragDirection</span>=<span class="hljs-string">"dragDown"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Transition</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">MotionScene</span>&gt;</span>
</code></pre>
<p>在布局中使用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.motion.widget.MotionLayout</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">app:layoutDescription</span>=<span class="hljs-string">"@xml/motion_scene"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">View</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/box"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/blue"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.motion.widget.MotionLayout</span>&gt;</span>
</code></pre>
<p><code>MotionLayout</code> 非常适合创建复杂的动画，可精确控制过渡和状态。</p>
<h3 data-id="heading-24">Drawable 动画</h3>
<p><code>Drawable</code> 动画涉及使用 <code>AnimationDrawable</code> 进行逐帧过渡，适合创建简单的动画，如加载 spinner。</p>
<p>XML 示例：<code>res/drawable/animation_list.xml</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">animation-list</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span> <span class="hljs-attr">android:oneshot</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/frame1"</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"100"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">android:drawable</span>=<span class="hljs-string">"@drawable/frame2"</span> <span class="hljs-attr">android:duration</span>=<span class="hljs-string">"100"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">animation-list</span>&gt;</span>
</code></pre>
<p>使用方法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animationDrawable = imageView.background <span class="hljs-keyword">as</span> AnimationDrawable
animationDrawable.start()
</code></pre>
<p>注意，只设置 <code>background</code> 为 <code>AnimationDrawable</code> 是不会工作的，一定不要忘了 <code>start</code>。</p>
<h3 data-id="heading-25">基于物理的动画</h3>
<p>基于物理的动画模拟现实世界的动力学效果。Android 提供了 <code>SpringAnimation</code> 和 <code>FlingAnimation</code> API，用于创建自然且动态的运动效果。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> springAnimation = SpringAnimation(view, DynamicAnimation.TRANSLATION_Y, <span class="hljs-number">0f</span>)
springAnimation.spring.stiffness = SpringForce.STIFFNESS_LOW
springAnimation.spring.dampingRatio = SpringForce.DAMPING_RATIO_HIGH_BOUNCY
springAnimation.start()
</code></pre>
<h3 data-id="heading-26">总结</h3>
<p>Android 提供了一系列实现动画的工具，从简单的属性变化到复杂的状态驱动过渡。</p>
<p>对于缩放或平移等简单变换，<code>View</code> 属性动画 和 <code>ObjectAnimator</code> 是有效的选择。</p>
<p>对于更复杂的场景，<code>AnimatorSet</code> 可以协调多个动画，而 <code>ValueAnimator</code> 提供了灵活的方式来为任意值设置动画。</p>
<p>不过这种传统的动画有个开发上的痛点，就是取消！</p>
<p>传动的动画把控取消的合适位置是很难的，所以如果你使用 Compose 进行开发，就直接使用 Compose 的动画，忘记这些传统动画吧！</p>
<h3 data-id="heading-27">进阶：插值器是如何工作的</h3>
<p>插值器通过修改动画值随时间变化的速率来定义动画的进度。它控制动画的加速、减速或匀速运动，使动画看起来更自然或更具视觉吸引力。</p>
<p>插值器用于定义动画在起始值和结束值之间的行为。例如，你可以让动画开始时缓慢，然后加速，最后在停止前减速。
这提供了对动画执行方式的灵活性和控制，超越了线性进度。</p>
<p>Android 提供了几种预定义的插值器，你可以根据所需效果选择：</p>
<ol>
<li><code>LinearInterpolator</code>：以恒定速率动画，没有加速或减速。</li>
<li><code>AccelerateInterpolator</code>：开始时缓慢，然后逐渐加速。</li>
<li><code>DecelerateInterpolator</code>：开始时快速，然后向结束时减速。</li>
<li><code>AccelerateDecelerateInterpolator</code>：结合了加速和减速，以获得平滑效果。</li>
<li><code>BounceInterpolator</code>：使动画看起来像在弹跳，模拟物理弹跳效果。</li>
<li><code>OvershootInterpolator</code>：动画会超出最终值，然后再回退到最终值。</li>
</ol>
<p>你可以将插值器应用于任何动画对象，如 <code>ObjectAnimator</code>、<code>ValueAnimator</code> 或 <code>ViewPropertyAnimator</code>。
插值器通过 <code>setInterpolator()</code> 方法设置。</p>
<p>下面举例，将插值器应用于 <code>ObjectAnimator</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> animator = ObjectAnimator.ofFloat(view, <span class="hljs-string">"translationX"</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">500f</span>)
animator.duration = <span class="hljs-number">1000</span>
animator.interpolator = OvershootInterpolator()
animator.start()
</code></pre>
<p>在这个示例中，<code>OvershootInterpolator</code> 会让视图在最终位置上过度动画，然后再回到最终位置，创造出动态且吸引人的效果。</p>
<p>你还可以通过扩展 <code>Interpolator</code> 接口并覆盖 <code>getInterpolation()</code> 方法来创建自己的插值器。这允许你完全自定义动画的时间曲线。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomInterpolator</span> : <span class="hljs-type">Interpolator</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInterpolation</span><span class="hljs-params">(input: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-comment">// 自定义动画时间逻辑</span>
        <span class="hljs-keyword">return</span> input * input
    }
}

<span class="hljs-comment">// 使用自定义插值器</span>
animator.interpolator = CustomInterpolator()
</code></pre>
<p>这个自定义插值器会让动画呈二次方进度，开始缓慢，然后随时间加速。</p>
<p>总之。</p>
<p>插值器通过控制动画的时间和进度来增强 Android 动画，提供了创建更视觉上吸引人且逼真效果的方法。</p>
<p>Android 提供了几种内置插值器用于常见场景，你也可以定义自定义插值器来实现独特的行为。</p>
<p>通过有效利用插值器，你可以显著提升用户体验，实现平滑自然的动画。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第二十四章(Prisma)]]></title>    <link>https://juejin.cn/post/7600489282821783602</link>    <guid>https://juejin.cn/post/7600489282821783602</guid>    <pubDate>2026-01-29T00:35:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282821783602" data-draft-id="7600224355295199259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第二十四章(Prisma)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-01-29T00:35:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第二十四章(Prisma)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:35:01.000Z" title="Thu Jan 29 2026 00:35:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ORM框架(Object-Relational Mapping)</h2>
<p>在传统开发模式中，我们需要把数据存储到<code>数据库</code>，所以需要通过SQL语句来进行操作，例如<code>查询</code> <code>新增</code> <code>修改</code> <code>删除</code>等操作，但是SQL语句太多了，还比较繁琐，所以就有了ORM框架。</p>
<p>ORM框架简单来说就是让我们通过熟悉的语法来操作数据库，我们可以直接使用面向对象的方式来操作数据库，ORM会把我们的操作映射成SQL语句，然后执行。</p>
<p>面向对象查询:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
    <span class="hljs-attr">where</span>: {
        <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
    },
    <span class="hljs-attr">select</span>: {
        <span class="hljs-attr">id</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>
    }
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user)
</code></pre>
<p>SQL查询:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> id, name, email <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<h4 data-id="heading-1">Prisma</h4>
<p>ORM框架比较多，这里我选择使用<code>Prisma</code>，因为<code>Prisma</code>是<code>TypeScript</code>优先的ORM框架，并且支持多种数据库，包括<code>MySQL</code> <code>PostgreSQL</code> <code>SQLite</code> <code>MongoDB</code>等。它以其出色的性能、类型安全性以及与 GraphQL 和 REST API 的集成而闻名</p>
<blockquote>
<p>注：我们当前使用的prisma版本是<code>7.3.0</code>为目前最新版(2026-01-29)，他每个大版本是有很大差异的，所以建议大家跟我安装一样的版本。</p>
</blockquote>
<h4 data-id="heading-2">Postgresql</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f64c74fd0c6647ef9c2ad6856c7de1e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=4jWy95vOyw7mS7ypt2Gg8UUbH2w%3D" alt="image.png" width="20%" loading="lazy"/>
<p>数据库的种类也是非常多的，这里我选择使用<code>PostgreSQL</code>，完全开源免费，我称为世界第一数据库(个人言论)，因为他有非常强大的功能，例如支持高级数据类型，<code>JSON</code> <code>数组</code> <code>枚举</code> <code>布尔值</code> <code>地理空间GIS</code>,事务与并发能力更强，并且还支持自定义扩展其功能。</p>
<h4 data-id="heading-3">PostgresSQL安装教程</h4>
<ol>
<li>简单粗暴，访问官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postgresql.org%2Fdownload%2F" target="_blank" title="https://www.postgresql.org/download/" ref="nofollow noopener noreferrer">www.postgresql.org/download/</a>，选择适合你操作系统的版本，然后下载安装即可。</li>
</ol>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e4d4fb089d648c09885924b6c25316a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=ok3l5Dm%2BhMlIznu%2Busw%2BPPhhchs%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39108fde6606498ba9aeb7c68d3e613a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=DpATMGTq1EJjeJ%2F0PEYV2o2LfDw%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/950307e147f94d72a38206e8fd46dd56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=GuoeHtXjgF8CI66AzjM4lvPN7NY%3D" alt="image.png" width="100%" loading="lazy"/>
<ol start="2">
<li>使用<code>docker</code>安装</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker pull postgres:18
docker run -d --name postgresServer -p 6666:5432 -e POSTGRES_PASSWORD=123456 postgres:18
</code></pre>
<p>账号默认为<code>postgres</code>，密码为<code>123456</code>，端口号为<code>6666</code>。</p>
<p>安装数据库可视化工具：打开<code>vsCode</code> / <code>Cursor</code> / <code>WebStorm</code>等代码编辑器，安装<code>Database Client</code>插件，然后连接数据库即可。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e105526bdfea4b1fbf1d58036b515637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=SF4ODw4vO807RMyEf1aW0MKUMoA%3D" alt="image.png" width="100%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27b94da3c538456d8522aabefcd79e3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=InKY0%2FiKQP%2FdrFjuTagJz1k82yM%3D" alt="image.png" width="100%" loading="lazy"/>
<h4 data-id="heading-4">开始使用Prisma</h4>
<p>安装prisma:</p>
<pre><code class="hljs language-bash" lang="bash">npm i prisma -D
</code></pre>
<p>安装prisma客户端:</p>
<pre><code class="hljs language-bash" lang="bash">npm install @prisma/client @prisma/adapter-pg pg dotenv
</code></pre>
<blockquote>
<p>注: prisma7版本需要独立安装适配器</p>
</blockquote>
<p>例如<code>postgresql</code>需要安装<code>@prisma/adapter-pg</code>，<code>mysql</code>需要安装<code>@prisma/adapter-mariadb</code>。</p>
<p>其他数据库请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2Fdocs%2Fgetting-started%2Fprisma-orm%2Fquickstart%2Fprisma-postgres" target="_blank" title="https://www.prisma.io/docs/getting-started/prisma-orm/quickstart/prisma-postgres" ref="nofollow noopener noreferrer">www.prisma.io/docs/gettin…</a></p>
<p>在Next.js项目根目录执行以下命令，初始化<code>prisma</code>:</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma init
</code></pre>
<p>执行完成之后他会自动生成<code>prisma</code>文件夹，并且生成<code>schema.prisma</code>文件，以及创建一个<code>env</code>文件和<code>prisma.config.ts</code>文件。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/546b5109d7b741e38f427901e2ffad92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=SzkakRbzzdwxHet6naiAIGYKilc%3D" alt="image.png" width="100%" loading="lazy"/>
<p>打开prisma/schema.prisma文件，添加以下内容：</p>
<pre><code class="hljs language-prisma" lang="prisma">generator client {
  provider = "prisma-client" //使用什么客户端
  output   = "../src/generated/prisma" //生成客户端代码的目录
}

datasource db {
  provider = "postgresql" //连接什么数据库
}

model User {
  id        String   @id @default(cuid()) //主键 
  name      String //用户名
  email     String   @unique //邮箱
  password  String //密码
  createdAt DateTime @default(now()) //创建时间
  updatedAt DateTime @updatedAt //更新时间
  posts     Post[] //关联文章
}

model Post {
  id        String   @id @default(cuid()) //主键
  title     String //标题
  content   String //内容
  createdAt DateTime @default(now()) //创建时间
  updatedAt DateTime @updatedAt //更新时间
  authorId  String //作者ID
  author    User     @relation(fields: [authorId], references: [id],onDelete: Cascade,onUpdate: Cascade) //一对多关联
}
</code></pre>
<ul>
<li>@id:主键对应sql语句的<code>PRIMARY KEY</code></li>
<li>@default(cuid()):默认生成一个唯一ID 类似于sql语句的<code>AUTO_INCREMENT</code></li>
<li>@unique:唯一约束对应sql语句的<code>UNIQUE</code></li>
<li>@relation:一对多关联对应sql语句的<code>FOREIGN KEY</code></li>
<li>@relation(fields: [authorId], references: [id],onDelete: Cascade,onUpdate: Cascade):一对多关联对应sql语句的<code>FOREIGN KEY</code></li>
<li>@default(now()):默认生成当前时间 类似于sql语句的<code>CURRENT_TIMESTAMP</code></li>
<li>@updatedAt:更新时间 类似于sql语句的<code>UPDATE CURRENT_TIMESTAMP</code></li>
<li>onDelete: Cascade:级联删除(表示删除主表的时候，从表也删除，非常的方便啊)</li>
<li>onUpdate: Cascade:级联更新(表示更新主表的时候，从表也更新，非常的方便啊)</li>
</ul>
<p>打开<code>.env</code>文件，修改数据库连接信息：</p>
<p>连接规则:DATABASE_URL="postgresql://username:password@localhost:5432/mydb?schema=public"</p>
<ul>
<li><code>postgresql</code>:数据库类型</li>
<li><code>username</code>:用户名</li>
<li><code>password</code>:密码</li>
<li><code>localhost</code>:主机名</li>
<li><code>5432</code>:端口号</li>
<li><code>mydb</code>:数据库名</li>
<li><code>schema=public</code>:模式</li>
</ul>
<pre><code class="hljs language-env" lang="env">DATABASE_URL="postgresql://postgres:123456@localhost:6666/test_db"
</code></pre>
<p>执行数据库迁移命令:</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma migrate dev --name init
</code></pre>
<p>执行完成之后他会在<code>prisma/migrations</code>文件夹中生成一个<code>migration</code>文件，并且生成一个sql文件，然后自动执行sql文件，创建表结构。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a440849a2140cba2ba53a718d3b064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=l8C5hYa3wLJeragmwV%2BGCzotN0g%3D" alt="image.png" loading="lazy"/></p>
<p>接着执行生成客户端代码命令：</p>
<pre><code class="hljs language-bash" lang="bash">npx prisma generate
<span class="hljs-comment">#生成路径是 schema.prisma 文件中client output的目录</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ff63983a8e1419fa56fc0b81bad85ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=BcTRigPCQr0M14MzFVHv%2BfVKMDY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">编写增删改查</h4>
<p>src/lib/prisma.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../generated/prisma/client'</span> <span class="hljs-comment">//引入生成客户端代码</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaPg</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/adapter-pg'</span> <span class="hljs-comment">//引入适配器</span>
<span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaPg</span>({ <span class="hljs-attr">connectionString</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_URL</span> }) <span class="hljs-comment">//创建连接池</span>
<span class="hljs-keyword">const</span> prisma = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrismaClient</span>({ <span class="hljs-attr">adapter</span>: pool }) <span class="hljs-comment">//创建客户端</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> prisma <span class="hljs-comment">//导出客户端</span>
</code></pre>
<p>src/app/api/route.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> prisma <span class="hljs-keyword">from</span> <span class="hljs-string">"@/lib/prisma"</span>; <span class="hljs-comment">//@lib是我在tsconfig.json中配置的别名，表示src目录下的lib文件夹</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span>, <span class="hljs-title class_">NextResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>; <span class="hljs-comment">//引入NextRequest, NextResponse</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> users = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>() <span class="hljs-comment">//查询所有用户</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(users) <span class="hljs-comment">//返回用户列表</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { name, email, password } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">data</span>: { name, email, password } <span class="hljs-comment">//创建用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回创建的用户</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">PATCH</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { id, name, email, password } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">update</span>({
        <span class="hljs-attr">where</span>: { id },
        <span class="hljs-attr">data</span>: { name, email, password } <span class="hljs-comment">//更新用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回更新后的用户</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DELETE</span>(<span class="hljs-params">request: NextRequest</span>) {
    <span class="hljs-keyword">const</span> { id } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>() <span class="hljs-comment">//获取请求体</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">user</span>.<span class="hljs-title function_">delete</span>({
        <span class="hljs-attr">where</span>: { id } <span class="hljs-comment">//删除用户</span>
    })
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">json</span>(user) <span class="hljs-comment">//返回删除后的用户</span>
}
</code></pre>
<p>index.http</p>
<p>执行http文件需要在插件市场安装<code>REST Client</code>，然后打开http文件，点击<code>Send Request</code>按钮即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45782deca2d74a0db1da3fe702262d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770251705&amp;x-signature=3pN5JoTZIxoQ7K3R%2FL7BwtNrl38%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-http" lang="http">### 创建用户
POST http://localhost:8888/api
Content-Type: application/json

{
    "name": "test",
    "email": "1test@test.com",
    "password": "123456"
}

### 查询所有用户
GET http://localhost:8888/api


### 更新用户
PATCH http://localhost:8888/api
Content-Type: application/json

{
    "id": "cmkyoxflr00004ck82ywc6joi",
    "name": "xiaoman",
    "email": "xiaomansdasdas",
    "password": "dasdasda"
}

### 删除用户
DELETE http://localhost:8888/api
Content-Type: application/json

{
    "id": "cmkyoxflr00004ck82ywc6joi"
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot + JPackage：构建独立安装包]]></title>    <link>https://juejin.cn/post/7600284420633952297</link>    <guid>https://juejin.cn/post/7600284420633952297</guid>    <pubDate>2026-01-28T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600284420633952297" data-draft-id="7600296037542428672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot + JPackage：构建独立安装包"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot + JPackage：构建独立安装包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T23:58:11.000Z" title="Wed Jan 28 2026 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从 JDK 14 开始，Java 官方引入了 <strong>JPackage</strong> 工具（在 JDK 16 正式成为标准功能），它能够将 Java 应用打包成特定平台的原生安装包，<strong>自带定制化的 JRE 运行环境</strong>。这意味着用户无需提前安装 Java 环境，双击安装包即可完成应用部署，极大地简化了交付流程。</p>
<p>本文将介绍如何使用 JPackage 工具将 Spring Boot 项目打包成 Windows、macOS 或 Linux 平台的原生安装包。</p>
<h2 data-id="heading-1">一、JPackage 简介</h2>
<h4 data-id="heading-2">1.1 什么是 JPackage</h4>
<p>JPackage 是 JDK 自带的打包工具，位于 <code>$JAVA_HOME/bin</code> 目录下。它的核心功能是：</p>
<p><strong>生成平台原生安装包</strong>：Windows 的 <code>.exe</code>/<code>.msi</code>、macOS 的 <code>.dmg</code>/<code>.pkg</code>、Linux 的 <code>.deb</code>/<code>.rpm</code></p>
<p><strong>自定义 JRE</strong>：使用 <code>jlink</code> 工具裁剪 JDK，仅打包应用所需的模块，大幅减小安装包体积</p>
<p><strong>简化部署</strong>：用户无需预装 Java 环境，安装包自带运行时</p>
<h4 data-id="heading-3">1.2 JPackage 的优势</h4>

























<table><thead><tr><th>传统部署方式</th><th>JPackage 方式</th></tr></thead><tbody><tr><td>需要预装 JRE/JDK</td><td>自带 JRE，无需额外安装</td></tr><tr><td>环境版本可能不匹配</td><td>绑定特定 JRE 版本，环境一致</td></tr><tr><td>手动编写启动脚本</td><td>自动生成启动器</td></tr><tr><td>跨平台需要多套脚本</td><td>一键生成各平台安装包</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、环境准备</h2>
<h4 data-id="heading-5">2.1 JDK 版本要求</h4>
<p><strong>推荐使用 JDK 17 或更高版本</strong>（JPackage 在 JDK 16 才成为标准功能，JDK 17 是 LTS 版本）</p>
<p>确认 JPackage 可用：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage --version
</code></pre>
<h4 data-id="heading-6">2.2 平台特定工具</h4>
<p>根据目标操作系统，需要安装对应的打包工具：</p>
<h5 data-id="heading-7">Windows</h5>
<p><strong>WiX Toolset 3.11+</strong>（用于生成 <code>.msi</code> 安装包）<br/>
下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwixtoolset.org%2F" target="_blank" title="https://wixtoolset.org/" ref="nofollow noopener noreferrer">wixtoolset.org/</a><br/>
安装后将 <code>bin</code> 目录添加到系统环境变量 <code>PATH</code></p>
<h5 data-id="heading-8">macOS</h5>
<p>Xcode 命令行工具（用于生成 <code>.dmg</code>/<code>.pkg</code>）</p>
<pre><code class="hljs language-bash" lang="bash">xcode-select --install
</code></pre>
<h5 data-id="heading-9">Linux</h5>
<p><strong>Debian/Ubuntu</strong>：安装 <code>fakeroot</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install fakeroot
</code></pre>
<p><strong>RedHat/CentOS</strong>：安装 <code>rpm-build</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install rpm-build
</code></pre>
<h2 data-id="heading-10">三、Spring Boot 项目准备</h2>
<h4 data-id="heading-11">3.1 示例项目结构</h4>
<p>假设我们有一个标准的 Spring Boot 项目：</p>
<pre><code class="hljs language-css" lang="css">my-springboot-app/
├── <span class="hljs-attribute">src</span>/
│   └── <span class="hljs-selector-tag">main</span>/
│       ├── java/
│       └── resources/
├── pom<span class="hljs-selector-class">.xml</span>
└── target/
    └── my-app-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.jar</span>
</code></pre>
<h4 data-id="heading-12">3.2 构建可执行 JAR</h4>
<p>首先使用 Maven 或 Gradle 构建项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven</span>
mvn clean package

<span class="hljs-comment"># Gradle</span>
gradle clean build
</code></pre>
<p>确保生成的 JAR 包是可执行的（Spring Boot 默认打包方式）。</p>
<h2 data-id="heading-13">四、使用 JPackage 打包</h2>
<h4 data-id="heading-14">4.1 基础打包命令</h4>
<p>以下是一个基础的 JPackage 命令示例（以 Windows 为例）：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span> \
  --description <span class="hljs-string">"基于 Spring Boot 的企业级应用"</span> \
  --icon src/main/resources/app-icon.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut
</code></pre>
<h5 data-id="heading-15">参数说明</h5>

















































<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--input</code></td><td>输入目录，包含 JAR 包和依赖</td></tr><tr><td><code>--name</code></td><td>应用名称</td></tr><tr><td><code>--main-jar</code></td><td>主 JAR 包文件名</td></tr><tr><td><code>--main-class</code></td><td>主类（Spring Boot 使用 <code>JarLauncher</code>）</td></tr><tr><td><code>--type</code></td><td>安装包类型（<code>msi</code>/<code>exe</code>/<code>dmg</code>/<code>pkg</code>/<code>deb</code>/<code>rpm</code>）</td></tr><tr><td><code>--app-version</code></td><td>应用版本号</td></tr><tr><td><code>--icon</code></td><td>应用图标（Windows 用 <code>.ico</code>，macOS 用 <code>.icns</code>）</td></tr><tr><td><code>--win-dir-chooser</code></td><td>允许用户选择安装目录</td></tr><tr><td><code>--win-menu</code></td><td>创建开始菜单项</td></tr><tr><td><code>--win-shortcut</code></td><td>创建桌面快捷方式</td></tr></tbody></table>
<h4 data-id="heading-16">4.2 自定义 JRE（使用 jlink）</h4>
<p>为了减小安装包体积，可以使用 <code>jlink</code> 裁剪 JRE，仅包含必要的模块。</p>
<h5 data-id="heading-17">步骤 1：查找应用依赖的模块</h5>
<pre><code class="hljs language-bash" lang="bash">jdeps --list-deps target/my-app-1.0.0.jar
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-csharp" lang="csharp">java.<span class="hljs-keyword">base</span>
java.logging
java.sql
java.naming
java.desktop
...
</code></pre>
<h5 data-id="heading-18">步骤 2：使用 jlink 创建自定义 JRE</h5>
<pre><code class="hljs language-bash" lang="bash">jlink \
  --add-modules java.base,java.logging,java.sql,java.naming,java.desktop,java.xml,java.management \
  --output custom-jre \
  --strip-debug \
  --no-header-files \
  --no-man-pages \
  --compress=2
</code></pre>
<h5 data-id="heading-19">步骤 3：使用自定义 JRE 打包</h5>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --runtime-image custom-jre \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>：Spring Boot 应用通常依赖较多模块，建议先不裁剪 JRE，确保功能正常后再优化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">五、不同平台的打包示例</h2>
<h4 data-id="heading-21">5.1 Windows 平台（MSI）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --icon src/main/resources/app.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut \
  --win-menu-group <span class="hljs-string">"我的应用"</span>
</code></pre>
<h4 data-id="heading-22">5.2 macOS 平台（DMG）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> dmg \
  --app-version 1.0.0 \
  --icon src/main/resources/app.icns \
  --mac-package-name <span class="hljs-string">"com.mycompany.myapp"</span> \
  --mac-package-identifier <span class="hljs-string">"com.mycompany.myapp"</span>
</code></pre>
<h4 data-id="heading-23">5.3 Linux 平台（DEB）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name myapp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> deb \
  --app-version 1.0.0 \
  --icon src/main/resources/app.png \
  --linux-shortcut \
  --linux-menu-group <span class="hljs-string">"Development"</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">六、集成到 Maven 构建流程</h2>
<p>为了自动化打包流程，可以将 JPackage 命令集成到 Maven 的 <code>pom.xml</code> 中。</p>
<h4 data-id="heading-25">6.1 使用 exec-maven-plugin</h4>
<p>在 <code>pom.xml</code> 中添加以下插件配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot Maven 插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JPackage 打包插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.mojo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>exec-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">executable</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">executable</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">arguments</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--input<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>target<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--name<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>MySpringBootApp<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.build.finalName}.jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-class<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>org.springframework.boot.loader.JarLauncher<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--type<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>msi<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--app-version<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.version}<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--vendor<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>我的公司<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-dir-chooser<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-menu<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-shortcut<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">arguments</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-26">6.2 执行构建</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean package
</code></pre>
<p>构建完成后，安装包将生成在项目根目录下。</p>
<h2 data-id="heading-27">七、总结</h2>
<p>JPackage 工具为 Java 应用的分发提供了强大的支持，从简单的命令行操作到集成到自动化构建流程，JPackage 都能很好地满足需求。</p>
<p>在实际项目中，建议根据应用特点选择合适的打包策略，平衡安装包体积、部署便利性和运行性能，为用户提供最佳的使用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系]]></title>    <link>https://juejin.cn/post/7600296037542526976</link>    <guid>https://juejin.cn/post/7600296037542526976</guid>    <pubDate>2026-01-28T15:14:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037542526976" data-draft-id="7600292312216387636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-28T15:14:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别碎片化学习：这个开源项目如何用38万star，重塑编程知识体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:14:54.000Z" title="Wed Jan 28 2026 15:14:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>简介</strong>：在茫茫编程资源中寻宝？免费、优质、全球化的学习资料其实触手可及！🌟 今天要推荐GitHub上拥有38万星标的开源宝库——free-programming-books。这里汇聚了全球40多种语言的编程书籍，涵盖Python、JavaScript、算法、机器学习等全领域，完全免费且持续更新。 无论你是编程新手还是资深开发者，这个由开源社区共同维护的知识库，都能为你提供系统化的学习路径。告别碎片化知识，从这里开始构建坚实的技能体系！ 立即探索这个知识无国界的编程学习殿堂吧！ #编程学习 #开源项目 #免费资源 #技术提升 #开发者工具</p>
</blockquote>
<p>在这个信息爆炸的时代，编程学习者往往面临一种“幸福的烦恼”：资源繁多，却不知从何入手。付费课程价格不菲，而网络上的免费资源又良莠不齐。有没有一个地方，能够汇聚全球优质的免费编程学习资料，并且保持持续更新与维护？</p>
<p>答案是肯定的。今天要介绍的，正是 GitHub 上被誉为“程序员学习宝库”的明星项目——<strong>free-programming-books</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6d171a2235d42998ba6db1f1b523d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=FhRSxC3vQBGl1oVgZpBoVgfe8Ms%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🔍项目概览：一个开源学习的典范</h2>
<p>free-programming-books 始于 2013 年，最初源自 Stack Overflow 上一个关于免费编程书籍的列表。随着时间推移，项目迁移至 GitHub，在开源社区的共同努力下，它已成长为 <strong>GitHub 上最受欢迎的知识库之一</strong>。</p>
<p>该项目由非营利组织 <strong>Free Ebook Foundation</strong> 负责维护，致力于推动免费电子书的创作、分发、存档与可持续发展。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEbookFoundation%2Ffree-programming-books" target="_blank" title="https://github.com/EbookFoundation/free-programming-books" ref="nofollow noopener noreferrer">github.com/EbookFounda…</a></p>
<p>在线地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books%2F" target="_blank" title="https://ebookfoundation.github.io/free-programming-books/" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<p>目前，该项目在 GitHub 上已获得 <strong>381k</strong> ⭐ star 关注。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306377a4814b46e780932eee222daaa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=8RT3dv%2BnUeyZ52yLOhAwPfEyl9Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">📚 丰富的资源体系</h2>
<ul>
<li><strong>按编程语言分类</strong>：涵盖 Python、JavaScript、Rust、Go 等几乎所有主流语言</li>
<li><strong>按主题分类</strong>：包括算法、数据结构、网络安全、机器学习等专业方向</li>
<li><strong>多语言支持</strong>：收录 <strong>40 多种语言</strong> 的编程书籍，如中文、日文、韩文、法文、德文等</li>
</ul>
<h2 data-id="heading-2">🚀如何使用这个宝库？</h2>
<p>项目提供了两个便捷的访问途径：</p>
<ul>
<li>
<p><strong>动态搜索网站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books-search%2F%3F%26sect%3Dbooks%26file%3Dfree-programming-books-zh.md" target="_blank" title="https://ebookfoundation.github.io/free-programming-books-search/?&amp;sect=books&amp;file=free-programming-books-zh.md" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<ul>
<li>支持按书名或作者搜索</li>
<li>界面简洁，查找高效</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb2adce3dc9b463bb495ca3a9703b934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=6heA%2BraHEptKlRypuSHL1MuISvs%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>静态浏览网站</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Febookfoundation.github.io%2Ffree-programming-books%2Fbooks%2Ffree-programming-books-zh.html" target="_blank" title="https://ebookfoundation.github.io/free-programming-books/books/free-programming-books-zh.html" ref="nofollow noopener noreferrer">ebookfoundation.github.io/free-progra…</a></p>
<ul>
<li>按分类浏览全部资源</li>
<li>适合探索与发现式学习</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afcdde9580a8474881c20ef6057953dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=fN1E7fHkkTDiTVYVcXCuCudbB1I%3D" alt="" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-3">🎖️项目的独特价值</h2>
<h3 data-id="heading-4">🌍 真正的全球化视野</h3>
<p>不同于许多仅聚焦英语内容的资源，该项目积极收录多语种资料，让非英语母语的学习者也能获得高质量学习资源。</p>
<h3 data-id="heading-5">🔄 持续维护与更新</h3>
<p>依托开源社区的协作力量，项目始终保持活力。每天都有新资源加入，过时链接也会及时清理。</p>
<h3 data-id="heading-6">✅ 严格的质量管控</h3>
<p>尽管资源数量庞大，但项目设有清晰的贡献指南与质量标准，确保列表中的内容具备真正的学习价值。</p>
<h3 data-id="heading-7">🆓 完全免费与合法</h3>
<p>所有收录资源均为合法免费提供，用户无需担心版权风险。</p>
<h2 data-id="heading-8">📌为什么推荐系统性学习？</h2>
<p>尽管网络上充斥着大量技术博文，能够快速解答特定问题，但这些知识往往是零散和碎片化的。相比之下，通过书籍或完整项目进行系统性学习，有助于构建起完整的知识体系。</p>
<p>网络博文如同知识的拼图碎片，虽然能呈现某个局部细节，却难以展示完整的知识图景。它们通常针对特定场景或最新技术，缺乏前后逻辑的串联，容易让人陷入“只见树木，不见森林”的困境。</p>
<p>系统性学习——无论通过结构严谨的书籍，还是设计完整的项目——能够帮助学习者：</p>
<ul>
<li><strong>构建知识框架</strong>：从基础到进阶，层层递进，形成完整的认知体系</li>
<li><strong>理解内在逻辑</strong>：掌握知识间的关联与演变脉络，做到既知其然，也知其所以然</li>
<li><strong>培养系统思维</strong>：在解决复杂问题时，能从整体视角分析，而非仅仅局部应对</li>
<li><strong>建立长期记忆</strong>：系统化的知识更易于大脑组织和存储，转化为持久的专业能力</li>
</ul>
<p>在技术领域尤其如此：一个看似简单的功能背后，往往涉及算法优化、设计模式、性能考量等多重维度。唯有通过系统性学习，才能深入理解技术本质，而非停留于表层使用。</p>
<p>因此，虽然碎片化学习能快速应对眼前问题，但若想真正深入某一领域，建立扎实的专业基础，系统性学习依然是更可靠、更有效的路径。它不仅传授知识，更塑造一种能够持续学习与自我更新的能力结构。</p>
<h2 data-id="heading-9">📢缺点与局限</h2>
<p>如同任何项目一样，free-programming-books 也并非完美，存在一些客观的局限性：</p>
<ul>
<li>内容虽丰，但良莠需自辨：作为社区驱动的链接集合，其收录的资源质量仍依赖用户自行判断与筛选。</li>
<li>更新依赖社区：部分冷门主题或链接的更新和维护可能不够及时，需要使用者留意。</li>
<li>AI等前沿领域覆盖有限：对于人工智能、大语言模型等近年爆发式发展的前沿领域，其收录的免费、系统性的经典书籍或最新资源相对较少，学习者需结合其他渠道（如官方文档、前沿论文、专业课程）进行补充。</li>
</ul>
<h2 data-id="heading-10">📝结语</h2>
<p>在知识付费日益普遍的今天，free-programming-books 项目如同一股清流，始终秉持“知识共享、教育平等”的开源精神。它不只是一个资源列表，更是全球编程学习者互助共进的社区象征。</p>
<p>无论你是刚刚入门的编程新手，还是希望拓展技能的经验开发者，或是正在寻找教学材料的教育工作者，这个宝库都能为你提供宝贵的支持。</p>
<p><strong>知识不应设有门槛，学习不该存在障碍</strong>——这正是 free-programming-books 项目带给我们的深刻启示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e7c436891f4450a8856e3610e1da439~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770218094&amp;x-signature=xh7t5D4S7hlVqq1ga9vk6KdPsXs%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建无障碍组件之Link Pattern]]></title>    <link>https://juejin.cn/post/7600060691350552618</link>    <guid>https://juejin.cn/post/7600060691350552618</guid>    <pubDate>2026-01-28T15:18:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350552618" data-draft-id="7600240045366657078" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建无障碍组件之Link Pattern"/> <meta itemprop="keywords" content="前端,HTML,交互设计"/> <meta itemprop="datePublished" content="2026-01-28T15:18:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anOnion"/> <meta itemprop="url" content="https://juejin.cn/user/553809592722589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建无障碍组件之Link Pattern
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809592722589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anOnion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:18:10.000Z" title="Wed Jan 28 2026 15:18:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Link Pattern 详解：构建无障碍链接组件</h2>
<p>链接是 Web 页面中最核心的导航元素，它将用户从一个资源引导到另一个资源。根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Flink%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/link/" ref="nofollow noopener noreferrer">W3C WAI-ARIA Link Pattern 规范</a>，正确实现的链接组件不仅要提供清晰的导航功能，更要确保所有用户都能顺利访问，包括依赖屏幕阅读器等辅助技术的用户。本文将深入探讨 Link Pattern 的核心概念、实现要点以及最佳实践。</p>
<h3 data-id="heading-1">一、链接的定义与核心功能</h3>
<p>链接是一个允许用户导航到另一个页面、页面位置或其他资源的界面组件。链接的本质是<strong>超文本引用</strong>，它告诉用户<strong>这里有你可能感兴趣的另一个资源</strong>。与按钮执行动作不同，链接的作用是导航，这是两者最本质的区别。</p>
<p>在实际开发中，浏览器为原生 HTML 链接提供了丰富的功能支持，例如在新窗口中打开目标页面、将目标 URL 复制到系统剪贴板等。因此，<strong>应尽可能使用 HTML a 元素创建链接</strong>。</p>
<h3 data-id="heading-2">二、何时需要自定义链接实现</h3>
<p>在某些情况下，需要使用非 a 元素实现链接功能，例如：</p>
<ul>
<li>图片作为导航入口</li>
<li>使用 CSS 伪元素创建的可视化链接</li>
<li>复杂的 UI 组件中需要链接行为的元素</li>
</ul>
<p>根据 WAI-ARIA 规范，当必须使用非 a 元素时，需要手动添加必要的 ARIA 属性和键盘支持。</p>
<h3 data-id="heading-3">三、键盘交互规范</h3>
<p>键盘可访问性是 Web 无障碍设计的核心要素之一。链接组件必须支持完整的键盘交互，确保无法使用鼠标的用户也能顺利操作。根据 Link Pattern 规范：</p>
<p><strong>回车键</strong>是激活链接的主要方式。当用户按下回车键时，链接被触发执行导航操作。</p>
<p><strong>上下文菜单</strong>（可选）：按 <code>Shift + F10</code> 键可以打开链接的上下文菜单，提供复制链接地址、在新窗口中打开等选项。</p>

















<table><thead><tr><th>操作系统</th><th>打开上下文菜单</th></tr></thead><tbody><tr><td>Windows</td><td><code>Shift + F10</code> 或 <code>Menu</code> 键</td></tr><tr><td>macOS</td><td><code>Control + 点击</code></td></tr></tbody></table>
<h3 data-id="heading-4">四、WAI-ARIA 角色、状态和属性</h3>
<p>正确使用 WAI-ARIA 属性是构建无障碍链接组件的技术基础。</p>
<p><strong>角色声明</strong>是基础要求。非 a 元素的链接需要将 role 属性设置为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23link" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#link" ref="nofollow noopener noreferrer">link</a>，向辅助技术表明这是一个链接组件。</p>
<p>示例：使用 span 元素模拟链接：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>&gt;</span>
  示例网站
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
</code></pre>
<p><strong>可访问名称</strong>是链接最重要的可访问性特征之一。链接必须有可访问的名称，可以通过元素文本内容、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-label" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-label" ref="nofollow noopener noreferrer">aria-label</a> 或 alt 属性提供。</p>
<p>示例 1：使用 img 元素作为链接时，通过 alt 属性提供可访问名称：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"logo.png"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例网站"</span> /&gt;</span>
</code></pre>
<p>示例 2：使用 aria-label 为链接提供可访问名称：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"text-link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://example.com/')"</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"访问示例网站"</span>
  &gt;</span>🔗&lt;/span
&gt;
</code></pre>
<p><strong>焦点管理</strong>需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23tabindex" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#tabindex" ref="nofollow noopener noreferrer">tabindex="0"</a>，将链接元素包含在页面 Tab 序列中，使其可通过键盘聚焦。</p>
<h3 data-id="heading-5">五、完整示例</h3>
<p>以下是使用不同元素实现链接的完整示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 示例 1：span 元素作为链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>&gt;</span>
  W3C 网站
<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 示例 2：img 元素作为链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"logo.svg"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"W3C 网站"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 示例 3：使用 aria-label 的链接 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"link-styled"</span>
  <span class="hljs-attr">onclick</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">onkeydown</span>=<span class="hljs-string">"goToLink(event, 'https://w3.org/')"</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"W3C 网站"</span>
  &gt;</span>🔗&lt;/span
&gt;

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">goToLink</span>(<span class="hljs-params">event, url</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">'keydown'</span> &amp;&amp; event.<span class="hljs-property">key</span> !== <span class="hljs-string">'Enter'</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url, <span class="hljs-string">'_blank'</span>);
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.link-styled</span> {
    <span class="hljs-attribute">color</span>: blue;
    <span class="hljs-attribute">text-decoration</span>: underline;
    <span class="hljs-attribute">cursor</span>: pointer;
  }
  <span class="hljs-selector-class">.link-styled</span><span class="hljs-selector-pseudo">:focus</span> {
    <span class="hljs-attribute">outline</span>: <span class="hljs-number">2px</span> solid blue;
    <span class="hljs-attribute">outline-offset</span>: <span class="hljs-number">2px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">六、最佳实践</h3>
<h4 data-id="heading-7">6.1 优先使用原生元素</h4>
<p>尽可能使用原生 HTML a 元素创建链接。浏览器为原生链接提供了丰富的功能和更好的兼容性，无需额外添加 ARIA 属性。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐做法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span>
  <span class="hljs-attr">href</span>=<span class="hljs-string">"https://example.com/"</span>
  <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>
  &gt;</span>访问示例&lt;/a
&gt;

<span class="hljs-comment">&lt;!-- 不推荐做法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">span</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"link"</span>
  <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>
  &gt;</span>访问示例&lt;/span
&gt;
</code></pre>
<h4 data-id="heading-8">6.2 正确处理键盘事件</h4>
<p>自定义链接需要同时处理 onclick 和 onkeydown 事件，确保用户可以通过回车键激活链接。</p>
<pre><code class="hljs language-javascript" lang="javascript">element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-comment">// 执行导航操作</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">url</span>;
  }
});
</code></pre>
<h4 data-id="heading-9">6.3 提供视觉反馈</h4>
<p>链接应该有明确的视觉样式，让用户能够识别这是一个可交互的元素。同时，应该提供键盘焦点样式。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#0066cc</span>;
  <span class="hljs-attribute">text-decoration</span>: underline;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-comment">/* 焦点状态：仅对键盘 Tab 导航显示焦点框，鼠标点击时不显示 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:focus</span>-visible,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:focus</span>-visible {
  <span class="hljs-attribute">outline</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#0066cc</span>;
  <span class="hljs-attribute">outline-offset</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
}

<span class="hljs-comment">/* 悬停状态：加深颜色并加粗下划线，提供鼠标交互反馈 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#004499</span>;
  <span class="hljs-attribute">text-decoration</span>-thickness: <span class="hljs-number">2px</span>;
}

<span class="hljs-comment">/* 已访问状态：使用紫色标识用户已访问的链接 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:visited</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:visited</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#551a8b</span>;
}

<span class="hljs-comment">/* 激活状态：点击瞬间的颜色变化 */</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:active</span>,
<span class="hljs-selector-attr">[role=<span class="hljs-string">'link'</span>]</span><span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff0000</span>;
}
</code></pre>
<h4 data-id="heading-10">6.4 避免过度使用 ARIA</h4>
<p>WAI-ARIA 有一条重要原则：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpractices%2Fread-me-first%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/practices/read-me-first/" ref="nofollow noopener noreferrer"><strong>没有 ARIA 比糟糕的 ARIA 更好</strong></a>。在某些情况下，错误使用 ARIA 可能会导致比不使用更糟糕的可访问性体验。只有在确实需要时才使用自定义链接实现。</p>
<h3 data-id="heading-11">七、链接与按钮的区别</h3>
<p>在 Web 开发中，正确区分按钮和链接至关重要。</p>



































<table><thead><tr><th>特性</th><th>链接</th><th>按钮</th></tr></thead><tbody><tr><td>功能</td><td>导航到其他资源</td><td>触发动作</td></tr><tr><td>HTML 元素</td><td><code>&lt;a&gt;</code></td><td><code>&lt;button&gt;</code>、<code>&lt;input type="button"&gt;</code></td></tr><tr><td>键盘激活</td><td>Enter</td><td>Space、Enter</td></tr><tr><td>role 属性</td><td>link</td><td>button</td></tr><tr><td>典型用途</td><td>页面跳转、锚点导航</td><td>提交表单、打开对话框</td></tr></tbody></table>
<h3 data-id="heading-12">八、总结</h3>
<p>构建无障碍的链接组件需要关注多个层面的细节。从语义化角度，应优先使用原生 HTML a 元素；从键盘交互角度，必须支持回车键激活；从 ARIA 属性角度，需要正确使用 role="link" 和可访问名称。</p>
<p>WAI-ARIA Link Pattern 为我们提供了清晰的指导方针，遵循这些规范能够帮助我们创建更加包容和易用的 Web 应用。每一个正确实现的链接组件，都是构建无障碍网络环境的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！]]></title>    <link>https://juejin.cn/post/7600240045366738998</link>    <guid>https://juejin.cn/post/7600240045366738998</guid>    <pubDate>2026-01-28T15:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366738998" data-draft-id="7600219080046247979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T15:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            耗时 20 天，AI 漫剧 APP 和 Web 全部开源， 已斩获 764 星！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:35:24.000Z" title="Wed Jan 28 2026 15:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 474 篇原创！</p>
<p>大家好，我是消失了一段时间的苍何。</p>
<p>1 月 5 号，我写了篇文章，并开源了 AI 漫剧 APP，获得了很多朋友的喜欢。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87d1b268437f4324bdbf6cc2b867ff67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=wru5ixN9hLIu1MN5zQalUj2yY0Q%3D" alt="图片" loading="lazy"/></p>
<p>然后在 GitHub 上一共获得了 764 星和 181 fork，让我有些吃惊。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6674bf206b3f4bb38f4adccfdd09375c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=SYrmRRTnpOhFG7NbwNVsqjZFMyI%3D" alt="图片" loading="lazy"/></p>
<p>说实话，这个项目远超我们的预期，甚至连歪果哥都来给我们提 issue，希望支持双语。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6068bebc4f5048b4b9c9062b24940633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=roJqrc69eBmVHXysNBnR7Y5HBhY%3D" alt="图片" loading="lazy"/></p>
<p>甚至还有老板来咨询问我卖不卖这个 APP，我说，大哥，咱都开源了，自己去整吧，不用付费，哈哈哈。</p>
<p><strong>这或许就是开源的魅力吧。</strong></p>
<p>但我发现，APP 还是不大方便，评论区也不少求 web 版本的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b78ec091807f4a089db97d69f55b5cd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=l7rtxD%2B8qnJIhStNYhIUo08a0Oo%3D" alt="图片" loading="lazy"/></p>
<p>于是，我们又花了 20 天，开源了个 Web 版本的 AI 漫剧平台，他是长这个样子的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0205d2082434fc89b6e92c1a19fba93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=jdip%2FzjUkIkdV1DIf6Y2fA9YNgY%3D" alt="图片" loading="lazy"/></p>
<p>主打的人群还是对 AI 漫剧感兴趣的小白群体，能够<strong>一句话生成漫剧故事</strong>。</p>
<p>如果你不知道生成什么故事，也可以使用系统内置的模板，比如「马到成功送祝福」、「马上有美食」等新年主题的故事。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cac2544976284a41b186b16ac1e0bfa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=EyQVLECXjpe8ZIph6Q0Ezb69e1M%3D" alt="图片" loading="lazy"/></p>
<p>为了照顾一些朋友想要自由发挥的需求，我们还添加了自定义工作流选项，也就是从创建角色到分镜编排，再到生成镜头，最后导出，都可以自定义。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1aa206712bf4a36a5b9d4fa6b9000be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=rhmPqtV%2B5b555wO7IK4HOwC4SBg%3D" alt="图片" loading="lazy"/></p>
<p>在编排的时候，你可以自定义不同的镜头，比如全景、中景、特写，可以添加镜头和场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ece00e56e15345608d75dc9ea353f5ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=bLSu54he7zFZwSe%2FAGrX30oLFuA%3D" alt="图片" loading="lazy"/></p>
<p>可以生成不同的镜头视频。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3146fb151034b4fbbf9eee72ab10124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=9nurWApTwE%2FJB%2Fc8xrz%2FNhcUdg8%3D" alt="图片" loading="lazy"/></p>
<p>在底层，做了很多的处理，能保证角色的一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01a7a94705de4463836abaab3b721382~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=IuST1eYsWgUD%2BPlytFmmmceWWtE%3D" alt="图片" loading="lazy"/></p>
<p>做了几个系列，分别对应 2D、3D、写实等场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166ac7c0a2d54678af353579a371cb5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=BucbT97AJDc7BM8BzC%2FR%2BhF9VbU%3D" alt="图片" loading="lazy"/></p>
<p>我们做了非常多深度的调优，在保持人物一致性的同时也添加了不少细节去优化生成的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ff76835c664810bc245cc2244f4319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=laGNqRNZ0MLpE6QLUZrA1HS3fWs%3D" alt="图片" loading="lazy"/></p>
<p>下面，我来分享下在开发这个项目过程中，我们踩过的坑，和一些可能算不上什么经验的经验，另外也教下大家怎么使用。</p>
<blockquote>
<p>创作和开源不易，如果文章对你有帮助，欢迎点赞转发。</p>
</blockquote>
<h2 data-id="heading-0">经验分享</h2>
<p>我感觉最头疼的问题之一是角色一致性问题，也就是角色在不同画面中长得不一样，该如何很好的解决。</p>
<p>我们尝试使用了不少办法，甚至引入了本地 ComfyUI，开启锁定种子，第一张图的种子会被记录，后续所有图使用相同的种子，以保持整体风格的一致性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbed639d07dc4c9ca140e878907f7b30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=vn45dDXvs0eqQ5wiElt9TY9rYYE%3D" alt="图片" loading="lazy"/></p>
<p>总结出角色一致性最佳实践如下：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 参考图选择：清晰、无遮挡、多角度</span>
<span class="hljs-deletion">- 描述格式：「性别+年龄+发型+发色+眼睛+服装+特征」</span>
<span class="hljs-deletion">- 示例：「25岁女性，黑色长直发，棕色大眼睛，穿白色衬衫和黑色西装裙，戴细框眼镜」</span>
</code></pre>
<p>对于镜头，考虑很多像我一样对运镜不大熟悉的小白，我们内置了 9 种标准镜头模板，AI 根据故事自动选择不同分镜的镜头。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e8ae7f5e1a4ddb8fa3985ff66253d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=lhRgiIWCOfgJQSHWDwno7XEHUc4%3D" alt="图片" loading="lazy"/></p>
<p>对于生成质量上，有以下几点可以给大家分享：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 画面描述要具体，避免模糊词汇</span>
<span class="hljs-deletion">- 使用「锁定种子」保持风格统一</span>
<span class="hljs-deletion">- 负面提示词排除不想要的元素</span>
<span class="hljs-deletion">- 多生成几次，选择最满意的</span>
</code></pre>
<p>在镜头节奏上，建议采用如下方式：</p>
<pre><code class="hljs language-markdown" lang="markdown">基本原则：

<span class="hljs-bullet">-</span> 全景→中景→特写（渐进式）
<span class="hljs-bullet">-</span> 对话场景用过肩镜头正反打
<span class="hljs-bullet">-</span> 情绪高潮用特写
<span class="hljs-bullet">-</span> 场景转换用全景或框中框

示例分镜节奏：
<span class="hljs-bullet">1.</span> T1 全景俯瞰 - 城市远景（建立环境）
<span class="hljs-bullet">2.</span> T2 环境中景 - 主角走在街上（角色入场）
<span class="hljs-bullet">3.</span> T4 标准中景 - 主角看手机（日常动作）
<span class="hljs-bullet">4.</span> T6 特写 - 手机屏幕显示消息（信息传递）
<span class="hljs-bullet">5.</span> T6 特写 - 主角惊讶表情（情绪反应）
<span class="hljs-bullet">6.</span> T8 跟随视角 - 主角奔跑（动态转场）
</code></pre>
<h2 data-id="heading-1">如何使用</h2>
<p>我们整理了一份详细的使用指南，还没放到 GitHub，大家如果需要可以评论区留言，或者等我们推到 GitHub 哈。</p>
<p>先来看下整体流程：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[导入剧本]</span> → <span class="hljs-selector-attr">[创建角色]</span> → <span class="hljs-selector-attr">[创建场景]</span> → <span class="hljs-selector-attr">[编排分镜]</span> → <span class="hljs-selector-attr">[生成图片]</span> → <span class="hljs-selector-attr">[生成视频]</span> → <span class="hljs-selector-attr">[导出]</span>
    ↓            ↓            ↓            ↓            ↓            ↓
  (可选)      上传参考图    上传参考图    选择模板      AI生成       (可选)
             填写描述      填写描述      写画面描述    保持一致性
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32bee0c912914af29029f56c3588326f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=Rq4HiXXh37%2B2%2Br%2BMhqllw%2F4yEqQ%3D" alt="图片" loading="lazy"/></p>
<p>生图这里你可以选择本地 ComfyUI 的方式，也可以选择 API 的方式。</p>
<p>这里以 API 为例，如果你希望稳定，性价比高的 API 平台，可以试试 Atlas Cloud。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.atlascloud.ai%3Fref%3DAXZ9S7" target="_blank" title="https://www.atlascloud.ai?ref=AXZ9S7" ref="nofollow noopener noreferrer">www.atlascloud.ai?ref=AXZ9S7</a></p>
<p>在漫剧场景中稳定出图出视频很重要，而且对于内容角色的生成，最好避开接口的审查和限制规则。</p>
<p>Atlas Cloud 这个 API 聚合平台能很好的满足漫剧这个场景的需求，毕竟它主打的是企业级 API 聚合，拥有 300+ 知名大模型，总结下来是：<strong>稳定、易用、低价</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee96dd3cb999461e8f9e2b9e5d6ad30b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=vPmg9qd%2BhxGi8TRfp19kOXb3yaE%3D" alt="图片" loading="lazy"/></p>
<p>那该如何使用呢？注册登录后，打开控制台，新建 API 密钥。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2433e95becd4b56960d845bb31e1996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=FaX3ZWMhFWLqHtcP4nzx0TZmuAo%3D" alt="图片" loading="lazy"/></p>
<p>多说一嘴，Atlas Cloud 目前注册绑卡即可白嫖 1 美元使用额度，可以免费生成不少图了。</p>
<p>填写名称后，点击创建：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/700a454d98bd40c3b504fe13ecc444a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=VHNPxkFbb4m%2BzJeIDFtFFYSRLoE%3D" alt="图片" loading="lazy"/></p>
<p>然后复制这个 API，填入到环境变量中：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b6756b1984b4e4e917bf3ef1af8baae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=sfSByKjzlrTQP7Wa8fEtGjejVDU%3D" alt="图片" loading="lazy"/></p>
<p>需要复制一份 env，然后把改调用方式为使用云端 API 的方式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1a3a6f95c854df399f7ff3697c16d41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=eME%2BYM90yPpxiCaO0%2BK8OW5aHz8%3D" alt="图片" loading="lazy"/></p>
<p>然后就可以启动项目，项目启动后，你可以一句话生成故事，也可以按照流程自定义，你可以先创建一个角色并添加场景：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46014f2a1b78445891faf66be2df7ddb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=oJNZxwKrOjglH%2BBrNPRJ5aDpzaY%3D" alt="图片" loading="lazy"/></p>
<p>角色描述和场景描述都可以用 AI 生成，也可以自定义更改。</p>
<p>然后就是对镜头进行编排，可以添加自定义镜头，描述同样也可以 AI 一键生成，不满意可以改。在这里你可以选择需要出镜的角色：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3325638652334daeab18ee3dc5c6b71c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=IVI9xbarxI2E0cKMgv78Ikat3Zg%3D" alt="图片" loading="lazy"/></p>
<p>可以看到已经添加的镜头列表，有专业分镜格式的标准提示语，对于分镜的生成效果会更好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/364cb87ca8a4446fb1464380bbf1bdc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=6cMEKUkijbH045m02vFxnH8%2Bed0%3D" alt="图片" loading="lazy"/></p>
<p>然后就可以生成镜头和对应的分镜视频：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b947c6f4914eccbf4e4223e66a6957~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=Jb4NULMnwdlmpFoR0REXBruT5p8%3D" alt="图片" loading="lazy"/></p>
<p>可以选择一键生成全部视频，这里选择 API 的方式来生成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34791f33acf844f28ae38fa3ae7a001e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=5OLHjRzMJdRA4NyYEN7af%2BAueKM%3D" alt="图片" loading="lazy"/></p>
<p>最后，你可以导出所有的图片包、视频包、分镜脚本，做素材备份，最后就是做视频的合成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ad26ec3c95d42728246a7a836950836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=0e7Ld8mvV7oLKESbaGhRO0YPdgY%3D" alt="图片" loading="lazy"/></p>
<p>我们做了比较详细的产品特点说明说和使用说明书，目前还在优化中，如果你想提前看看，可以评论区告诉我。</p>
<p>说真的，这套系统，我认为，还是又再次满足了我做漫剧的激情，虽然我们不是专业的漫导，也非该行业的从业者。</p>
<p>但通过 AI 编程，我们也能做出一个，算是能满足我们需求的工具，然后去满足我们做漫剧的心。</p>
<p>因为是开源平台，你可以自定义各种花式玩法，觉得哪儿不满意，甚至可以让 Claude Code 帮你改。</p>
<p>有时候，我觉得 AI 编程最大的价值，或许在于：</p>
<p><strong>满足自己的灵魂，而非取悦别人。</strong></p>
<p>如果你喜欢我们的作品，也欢迎给我们 star，如果你想加入我们平台共建，也欢迎联系我。</p>
<p>目前平台有三个核心贡献者，分别是猫哥，蜗牛和苍何。</p>
<p>我们会在深夜畅聊产品的，沟通如何优化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d276de74e3e9459a88d3a7a83254a22b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=FEj0VG8UoLeIuJUy9yhg%2BjC6v3A%3D" alt="图片" loading="lazy"/></p>
<p>每当在 GitHub 上有新的进步，我们会为此而欢呼，当然，我们今年的目标是破千 star，也不知道能不能完成，哈哈哈。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d676c13181c7475caf6fa9077b9a7733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770219324&amp;x-signature=%2B1917ZJZYcZ3s5dMsOlFHmZCXtk%3D" alt="图片" loading="lazy"/></p>
<p>当然我知道，我们做的远远不足，很多想要优化的点都还没优化，一方面是因为我们时间精力问题，另一方面，我们对漫剧这个行业的 know how 还有限。</p>
<p>当然了，我也在不断的学习，学习优秀的产品，学习他们如何做出精品的漫剧。</p>
<p>最近也在用 oiioii 来学做精品漫剧，到时候再来和大家分享了。</p>
<p>好啦，最后，如果你有一定的 vibe coding 能力，同时也是 AI 漫剧的热爱者，欢迎加入我们 GitHub 开源项目的共建。</p>
<p>感谢你喜欢我的文章，我们下一期见啦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”]]></title>    <link>https://juejin.cn/post/7600248718361083946</link>    <guid>https://juejin.cn/post/7600248718361083946</guid>    <pubDate>2026-01-28T15:57:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600248718361083946" data-draft-id="7600223321041862662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”"/> <meta itemprop="keywords" content="前端,JavaScript,设计模式"/> <meta itemprop="datePublished" content="2026-01-28T15:57:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vilan_微澜"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267199320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267199320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vilan_微澜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:57:10.000Z" title="Wed Jan 28 2026 15:57:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、前言</h2>
<p>大家好，我是微澜。今天来分享一个基于 <strong>WeakMap</strong> 实现的<strong>快速对树形结构数据进行增删改查操作</strong>的<code>useTree hook</code>函数，它是基于<code>JavaScript</code> 的 <code>WeakMap</code> 特性，在不改动原始数据的前提下，实现了一套 <strong>O(1)</strong> 查找的<strong>影子索引结构</strong>，这个<strong>影子</strong>其实就是对象的<strong>引用地址</strong>，让树形数据操作像操作数组一样简单！</p>
<h2 data-id="heading-1">二、为什么选择 WeakMap？</h2>
<h3 data-id="heading-2">1. 非侵入性 (Non-invasive)</h3>
<p>通过 <code>WeakMap</code> 在内存中构建了一套 <code>Node -&gt; Parent</code> 的映射。原始数据对象保持纯净，没有任何多余属性，完美支持序列化。</p>
<h3 data-id="heading-3">2. 内存安全 (Memory Safety)</h3>
<p>这是最关键的一点。<code>WeakMap</code> 对键（对象）是<strong>弱引用</strong>的。</p>
<ul>
<li>
<p>如果你删除了原始树中的某个节点，且没有其他地方引用它，垃圾回收器（GC）会自动清理索引表中的对应项。</p>
</li>
<li>
<p>这种特性非常适合处理大型动态树，完全不用担心手动维护索引带来的内存泄漏。</p>
</li>
</ul>
<h3 data-id="heading-4">3、不同实现方案对比</h3>
<p>在开始之前，我们先看看为什么选择 <strong>WeakMap</strong>。我们可以通过一个综合对比来看看<strong>操作树形数据</strong>不同方案的差异：</p>






















































<table><thead><tr><th align="left"><strong>维度 / 方案</strong></th><th align="left"><strong>传统递归遍历</strong></th><th align="left"><strong>节点注入 parent</strong></th><th align="left"><strong>Map 缓存方案</strong></th><th align="left"><strong>WeakMap 优化方案 (本项目)</strong></th></tr></thead><tbody><tr><td align="left"><strong>初始化复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> (双层循环)</td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span> (单次递归)</strong></td></tr><tr><td align="left"><strong>溯源时间复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span> (D为深度，极快)</strong></td></tr><tr><td align="left"><strong>数据污染</strong></td><td align="left">无</td><td align="left">高（直接修改对象）</td><td align="left">无</td><td align="left"><strong>无（外部映射，保持纯净）</strong></td></tr><tr><td align="left"><strong>内存管理</strong></td><td align="left">差</td><td align="left">一般</td><td align="left">一般 (强引用，需手动清理)</td><td align="left"><strong>优秀（弱引用自动 GC）</strong></td></tr><tr><td align="left"><strong>序列化友好度</strong></td><td align="left">友好</td><td align="left">极差（循环引用）</td><td align="left">友好</td><td align="left"><strong>友好</strong></td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">极小数据量</td><td align="left">中等数据量</td><td align="left">中等数据量</td><td align="left"><strong>大规模数据、高频转换</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">三、核心实现原理</h2>
<h3 data-id="heading-6">1. 整体架构图</h3>
<p>我们通过一个外部的 <code>WeakMap</code> 来存储<strong>节点与其父级的对应关系</strong>。这种设计最大的好处是：“不改变原始树结构，不产生循环引用，且能实现 O(1) 的溯源。”</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[原始树形数据] --&gt; B{useTree Hook}
    B -- "1. 递归扫描" --&gt; C[WeakMap 存储库]

    subgraph "WeakMap 存储策略"
    C -- "Key: 根节点" --&gt; D["Value: 整个 Tree 数组 (方便删除)"]
    C -- "Key: 子节点" --&gt; E["Value: 直接父节点对象 (实现溯源)"]
    end

    F[业务请求: 查找/删除] --&gt; C
    C -- "返回父级引用" --&gt; G[完成操作]
</code></pre>
<h3 data-id="heading-7">2. 数据映射图解 (核心逻辑)</h3>
<p>为了让大家更直观地看到 <code>WeakMap</code> 里到底存了什么，我们看下面这个例子：</p>
<p><strong>示例数据：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> list = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'掘金'</span>,
    <span class="hljs-attr">children</span>: [ { <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'前端组'</span> } ]
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'社区'</span>,
    <span class="hljs-attr">children</span>: []
  }
];
</code></pre>
<p><strong>WeakMap 内部映射关系：</strong></p>





























<table><thead><tr><th align="left">节点 (Key)</th><th align="left">映射值 (Value)</th><th align="left">Value类型</th><th align="left">存储逻辑说明</th></tr></thead><tbody><tr><td align="left"><code>{ id: 11, name: '前端组' }</code></td><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><strong>Object (父节点)</strong></td><td align="left"><strong>非根节点</strong>：指向它的直接父对象</td></tr><tr><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr><tr><td align="left"><code>{ id: 2, name: '社区', children: [] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>核心秘诀</strong>：
以上设计了一套巧妙的判断规则：如果节点是<strong>根节点</strong>，其映射值就是<strong>数组</strong>；如果节点是<strong>子节点</strong>，其映射值就是<strong>父对象</strong>。
这样在执行 <code>removeChild</code> 时，我们只需要判断 <code>Array.isArray(parent)</code>，就能自动切换“从数组中删除”<strong>根节点</strong>或“从 <code>children</code> 属性中删除”<strong>子节点</strong>的逻辑，极其优雅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、useTree()实现方法逐一拆解</h2>
<p>接下来，我们看看 <code>useTree</code> 内部每个方法的具体实现原理。</p>
<h3 data-id="heading-9">1. <code>initTree</code> - 初始化索引</h3>
<p><strong>功能</strong>：递归遍历整棵树，建立 <code>WeakMap</code> 映射。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数据索引对象</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-keyword">const</span> useTree = (
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">Props</span> = {
    <span class="hljs-comment">// 外部数据对象字段映射</span>
    <span class="hljs-attr">treeNodeProp</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'value'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'label'</span>,
      <span class="hljs-attr">children</span>: <span class="hljs-string">'children'</span>,
    }
  }
){
    <span class="hljs-comment">// 初始化树结构索引</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list, parent</span>){...}
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }
</code></pre>
<p><strong>原理</strong>：在组件挂载或数据更新时调用。通过这种“差异化映射”，我们让每个节点都拥有了一个指向其“归属集合”的指针，也就是指向了<strong>父级的引用地址</strong>。</p>
<p>以上文的表格列出的示例数据为例，调用<code>initTree</code>方法初始化后，可以得到以下对应关系：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Keys [节点对象 - Key]
        K11("前端组 (id:11)")
        K1("掘金 (id:1)")
        K2("社区 (id:2)")
    end

    subgraph Values [映射值 - Value]
        V_Obj1["父节点对象 (id:1)"]
        V_Arr["根数据数组 [Tree]"]
    end

    K11 -- "指向直接父级" --&gt; V_Obj1
    K1 -- "指向所属根数组" --&gt; V_Arr
    K2 -- "指向所属根数组" --&gt; V_Arr

    style K11 fill:#f9f,stroke:#333
    style K1 fill:#bbf,stroke:#333
    style K2 fill:#bbf,stroke:#333
    style V_Arr fill:#dfd,stroke:#333
    style V_Obj1 fill:#fff,stroke:#333
</code></pre>
<h3 data-id="heading-10">2. <code>_setParent</code> - 节点索引设置</h3>
<p><strong>功能</strong>：建立节点与其所属容器（父节点对象或根数组）的映射关系。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }
</code></pre>
<p><strong>原理</strong>：这是对 <code>WeakMap.set</code> 的一层简单封装。通过这种方式，我们将节点对象引用作为 <code>Key</code>，其父级引用作为 <code>Value</code> 存入索引库。通过<code>_</code>前缀标记为<strong>私有</strong>是为了防止外部直接篡改映射关系，保证索引的单一可靠性。</p>
<h3 data-id="heading-11">3. <code>getParent</code> - 获取父节点</h3>
<p><strong>功能</strong>：获取指定节点的直接父节点。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }
</code></pre>
<ul>
<li><strong>原理</strong>：利用 <code>WeakMap.get</code> 直接获取。时间复杂度为 <strong>O(1)</strong>。</li>
</ul>
<h3 data-id="heading-12">4. <code>getParents</code> - 获取全路径父节点</h3>
<p><strong>功能</strong>：递归向上检索父级，获取从当前节点到根部的所有父节点数组。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }
  
  <span class="hljs-comment">// 判断是否根节点，下文都用这个方法判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }
</code></pre>
<p><strong>原理</strong>：通过节点自身的引用地址在<code>WeakMap</code>中查找父级。相比于<code>DFS</code>(深度优先遍历)全树，这种<strong>垂直爬升</strong>的方式效率极高。
什么是<strong>垂直爬升</strong>？</p>
<p><strong>类似于：</strong></p>
<blockquote>
<p><code>show code is me.parent.parent.  ......</code></p>
</blockquote>
<p>就这样，连祖宗十八代都能给你扒出来！</p>
<h3 data-id="heading-13">5. <code>addChild</code> - 动态添加节点</h3>
<p><strong>功能</strong>：向指定节点添加子节点，并自动更新索引。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }
</code></pre>
<p><strong>原理</strong>：在操作原始数据的同时，同步更新 <code>WeakMap</code>索引。也就是为新增的对象建立父级索引。</p>
<p><strong>注意</strong>：这里不能把新添加的<code>child</code>对象当做<code>WeakMap</code>的<code>Key</code>，因为<code>child</code>只是一个外部传入的一个<strong>临时变量</strong>，还没有和整棵树建立联系，需要在添加到树当中后，获取<strong>树当中的对象地址</strong>作为<code>Key</code>建立索引。</p>
<h3 data-id="heading-14">6. <code>removeChild</code> - 删除指定节点</h3>
<p><strong>功能</strong>：无痛删除任意节点，无需手动遍历查找。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }
</code></pre>
<p><strong>原理</strong>：这是该方案最精妙的地方！通过 <code>initTree</code> 建立的差异化映射，我们只需要简单的 <code>Array.isArray</code> 判断，就能准确找到节点所在的“容器”，实现秒删。</p>
<hr/>
<h2 data-id="heading-15">五、完整代码实现</h2>
<p>代码不多，却能<strong>快速~</strong>实现对树形数据的增删改查操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useTree.ts</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-comment">// 树形数据字段名映射类型</span>
  <span class="hljs-attr">treeNodeProp</span>: <span class="hljs-title class_">TreeNodeProp</span>
}

<span class="hljs-comment">// 树节点属性映射类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNodeProp</span> = {
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">children</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 数节点</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNode</span> = <span class="hljs-built_in">any</span>

<span class="hljs-comment">/**
 * 树结构索引数据
 * key为节点本身，value为父节点或根节点数组(即整棵树)
 * 如果value为Array，代表根节点数组
 * 如果value为Object，代表子节点
 */</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-comment">// 使用weakmap构建树形数据数据索引</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTree</span> = (<span class="hljs-params">
  props: Props = {
    // 外部数据对象字段映射
    treeNodeProp: {
      value: <span class="hljs-string">'value'</span>,
      label: <span class="hljs-string">'label'</span>,
      children: <span class="hljs-string">'children'</span>,
    }
  }
</span>) =&gt; {
  <span class="hljs-keyword">const</span> { treeNodeProp } = props;

  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }

  <span class="hljs-comment">// 判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }

  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }

  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }

  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }

  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }

  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }

  <span class="hljs-comment">// 获取节点的所有父节点label数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentLabels</span>(<span class="hljs-params">item: TreeNode, labelList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, labelList, treeNodeProp.<span class="hljs-property">label</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-comment">// 获取节点的所有父节点value数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentValues</span>(<span class="hljs-params">item: TreeNode, valueList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, valueList, treeNodeProp.<span class="hljs-property">value</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-keyword">return</span> {
    getParents,
    getParentLabels,
    getParentValues,
    getParent,
    initTree,
    addChild,
    removeChild,
  };
};

</code></pre>
<h2 data-id="heading-16">六、总结</h2>
<p>通过 <code>WeakMap</code> 实现的 <code>useTree</code>，核心优势在于<strong>解耦</strong>。它将“业务数据”与“层级关系”分离开来，既保证了数据的纯净，又获得了极高的查找性能。</p>
<p><code>WeakMap</code> 作为一个<strong>容易被忽视</strong>的原生特性，在处理这类关联<strong>关系映射</strong>时有着天然的优势。</p>
<p>如果你也在为<strong>复杂树结构</strong>的管理发愁，不妨尝试下这种“<strong>影子索引</strong>”的思路。</p>
<p>如有不足或可优化的地方，欢迎在评论区交流讨论，如果觉得有用，点个👍也挺好的！👏</p>
<p><strong>如果你在处理大型树形表格或复杂的组织架构，这个 Hook 绝对是你的提效神器！</strong></p>
<h2 data-id="heading-17">七、预览和源码地址</h2>
<h4 data-id="heading-18">多场景演示 (Demo)</h4>
<ul>
<li>
<p><strong>项目预览总入口</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2F" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>原生 HTML 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fhtml%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/html/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>Vue 3 + Element+ 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fvue%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/vue/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>React + AntD 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Freact%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/react/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
</ul>
<h4 data-id="heading-19">项目源码地址</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjava6688%2FTree_By_WeakMap" target="_blank" title="https://github.com/java6688/Tree_By_WeakMap" ref="nofollow noopener noreferrer">github：https://github.com/java6688/Tree_By_WeakMap</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ从实战到源码：SpringBoot整合RocketMQ]]></title>    <link>https://juejin.cn/post/7600060691350470698</link>    <guid>https://juejin.cn/post/7600060691350470698</guid>    <pubDate>2026-01-28T14:18:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350470698" data-draft-id="7600240045366591542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ从实战到源码：SpringBoot整合RocketMQ"/> <meta itemprop="keywords" content="后端,RocketMQ"/> <meta itemprop="datePublished" content="2026-01-28T14:18:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ从实战到源码：SpringBoot整合RocketMQ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:18:42.000Z" title="Wed Jan 28 2026 14:18:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ从实战到源码：SpringBoot整合RocketMQ</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c33ed4ee428469db4621f0d3f673b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=GbDQMs9j51WT9%2BOtBqvLxwFWMVI%3D" alt="rocketmq封面.png" loading="lazy"/></p>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构中，消息中间件是实现服务解耦、削峰填谷、异步通信的核心组件，而 RocketMQ 作为阿里开源的高性能、高可靠分布式消息中间件，凭借高吞吐量、低延迟、强一致性等特性，广泛应用于各类分布式系统。SpringBoot 则以“约定大于配置”的理念，极大简化了第三方组件的整合成本。本文将从实操角度出发，详细讲解 RocketMQ 与 SpringBoot 的完整整合流程，包含环境准备、依赖配置、生产者/消费者实现、测试验证，以及常见问题排查，适合新手快速上手，也可作为开发参考手册。</p>
<h3 data-id="heading-2">1 整合 SpringBoot</h3>
<h4 data-id="heading-3">1.1 环境</h4>
<p>rocketmq: 2.2.3 RocketMQ 与 SpringBoot 的整合依赖官方提供的 starter 组件，版本适配至关重要，否则会出现自动配置失效、Bean 注入失败等问题。本文选用业内稳定兼容版本组合（新手直接照搬即可），版本对应关系参考 Apache RocketMQ 官方兼容性矩阵：</p>
<ul>
<li>JDK：17（需要 1.8+，RocketMQ 对 JDK 11+ 兼容性一般，生产环境优先选用 JDK 8，避免踩坑）</li>
<li>SpringBoot：2.7.x（稳定版，避免使用 3.x 版本，与 RocketMQ starter 存在兼容断点）</li>
<li>RocketMQ：4.9.7（稳定版，社区长期维护，适配 SpringBoot 2.7.x）</li>
<li>RocketMQ SpringBoot Starter：2.2.3（如果使用 2.3 的版本，jdk 需要 17，并且 springboot 需要 3.0 以上）</li>
<li>Maven：3.6+（项目构建工具）</li>
</ul>
<h4 data-id="heading-4">1.2 引入依赖</h4>
<p>创建 SpringBoot 项目，引入 RocketMQ 整合依赖，核心是 RocketMQ 官方提供的 spring-boot-starter，无需手动引入原生 RocketMQ 客户端依赖，starter 会自动完成依赖管理和自动配置。</p>
<pre><code class="hljs language-java" lang="java">&lt;!-- RocketMQ 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;<span class="hljs-number">2.2</span><span class="hljs-number">.3</span>&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4 data-id="heading-5">1.3 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># rocketmq 配置项，对应 RocketMQProperties 配置类</span>
<span class="hljs-attr">rocketmq:</span>
  <span class="hljs-attr">name-server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.109</span><span class="hljs-number">.134</span><span class="hljs-string">:9876</span> <span class="hljs-comment"># RocketMQ Namesrv</span>
  <span class="hljs-comment"># Producer 配置项 （只有配置了生产者，才会初始化RocketMQTemplate）</span>
  <span class="hljs-attr">producer:</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">demo-spring-group</span> <span class="hljs-comment"># 生产者分组(自定义)</span>
    <span class="hljs-attr">send-message-timeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment"># 发送消息超时时间，单位：毫秒。默认为 3000 。</span>
    <span class="hljs-attr">compress-message-body-threshold:</span> <span class="hljs-number">4096</span> <span class="hljs-comment"># 消息压缩阀值，当消息体的大小超过该阀值后，进行消息压缩。默认为 4 * 1024B</span>
    <span class="hljs-attr">max-message-size:</span> <span class="hljs-number">4194304</span> <span class="hljs-comment"># 消息体的最大允许大小。。默认为 4 * 1024 * 1024B</span>
    <span class="hljs-attr">retry-times-when-send-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 同步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-times-when-send-async-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 异步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-next-server:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 发送消息给 Broker 时，如果发送失败，是否重试另外一台 Broker 。默认为 false</span>
    <span class="hljs-attr">access-key:</span> <span class="hljs-comment"># Access Key ，可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/acl/user_guide.md 文档</span>
    <span class="hljs-attr">secret-key:</span> <span class="hljs-comment"># Secret Key</span>
    <span class="hljs-attr">enable-msg-trace:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 是否开启消息轨迹功能。默认为 true 开启。可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/msg_trace/user_guide.md 文档</span>
    <span class="hljs-attr">customized-trace-topic:</span> <span class="hljs-string">RMQ_SYS_TRACE_TOPIC</span> <span class="hljs-comment"># 自定义消息轨迹的 Topic 。默认为 RMQ_SYS_TRACE_TOPIC 。</span>
  <span class="hljs-comment"># Consumer 配置项 (可以不在这里配置，不在这里配置需要在注解中配置)</span>

</code></pre>
<p>启动类不需要配置，就跟使用 redis 一样。</p>
<h4 data-id="heading-6">1.4 代码</h4>
<p>简单进行操作，做个简单的消费者和生产者进行测试。</p>
<p>构建一个消息类，实际开发中常发送对象消息（如订单信息、用户信息），需创建实体类并实现 Serializable 接口（避免序列化失败）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SPRING-DEMO-01"</span>;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Demo01Message{"</span> +
        <span class="hljs-string">"id="</span> + id +
        <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<p>生产者代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-comment">/**
     * 同步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> SendResult <span class="hljs-title function_">syncSend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        <span class="hljs-comment">// 同步发送消息</span>
        <span class="hljs-keyword">return</span> rocketMQTemplate.syncSend(Demo01Message.TOPIC, message);
    }

    <span class="hljs-comment">/**
     * 异步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@param</span> callback 回调
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncSend</span><span class="hljs-params">(Integer id, SendCallback callback)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.asyncSend(Demo01Message.TOPIC, message, callback);
    }

    <span class="hljs-comment">/**
     * 单向发送
     * <span class="hljs-doctag">@param</span> id
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onewaySend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.sendOneWay(Demo01Message.TOPIC, message);
    }

}
</code></pre>
<p>通过使用 <code>RocketMQTemplate</code>进行发送消息，以上案例测试了 3 种消息发送方式（同步、异步、单向）。</p>
<p>消费者代码</p>
<p>:::info
SpringBoot 整合 RocketMQ 后，消费者无需手动启动监听，只需创建一个监听类，实现 RocketMQListener 接口，并用 @RocketMQMessageListener 注解指定订阅的主题和消费者组，Spring 会自动扫描并启动监听。</p>
<p>:::</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = Demo01Message.TOPIC,
        consumerGroup = "GROUP-" + Demo01Message.TOPIC)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;Demo01Message&gt; {
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"消费者监听已启动..."</span>);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Demo01Message messageExt)</span> {
        log.info(<span class="hljs-string">"[消费者][线程号:{} 监听到消息：{}]"</span>, Thread.currentThread().getId(), messageExt);
    }
}
</code></pre>
<blockquote>
<p>注：这个 onMessage 的类型 Demo01Message 可以放原来的类 MessageExt</p>
</blockquote>
<p>消费者的声明的所有属性通过@RocketMQMessageListener注解声明，实现 RocketMQListener 接口。</p>
<p>我们构建一个测试类进行擦看测试结果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RocketProducerTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Producer producer;

    <span class="hljs-comment">/**
     * 测试同步发送
     */</span>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        <span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.syncSend(id);
        log.info(<span class="hljs-string">"[测试同步发送][发送编号：[{}] 发送结果：[{}]]"</span>, id, result);

        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        producer.asyncSend(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
                log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功，结果为：[{}]]"</span>, id, sendResult);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable throwable)</span> {
                log.info(<span class="hljs-string">"[testASyncSend][发送编号：[{}] 发送异常]]"</span>, id, throwable);
            }
        });


        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOnewaySend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);

        producer.onewaySend(id);
        log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功, 不关心是否被消费！"</span>, id);
        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

}
</code></pre>
<p>运行结果</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3dd8b8eab8b4270bcaee5d0eb36d0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=PSumvrNM84PaFXFGvRDE7kGcMIk%3D" alt="" loading="lazy"/></p>
<p>更多案例查看 gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliyongde%2Fjava-trial%2Ftree%2Fmaster%2FTrial1-RocketMQ%2FTrial1-RocketMQ-Demo1" target="_blank" title="https://gitee.com/liyongde/java-trial/tree/master/Trial1-RocketMQ/Trial1-RocketMQ-Demo1" ref="nofollow noopener noreferrer">rocketmq-demo</a></p>
<h3 data-id="heading-7">2 相关配置</h3>
<p>结合前文配置文件，补充 RocketMQ 与 SpringBoot 整合的核心配置说明（对应 application.yml），帮助大家根据业务场景灵活调整，避免盲目配置：</p>















































<table><thead><tr><th><strong>配置项</strong></th><th><strong>含义</strong></th><th><strong>默认值</strong></th><th><strong>使用场景</strong></th></tr></thead><tbody><tr><td>rocketmq.name-server</td><td>NameServer 地址，生产者/消费者通过该地址找到 Broker</td><td>无（必配）</td><td>单机/集群部署均需配置，集群用分号分隔多个地址</td></tr><tr><td>rocketmq.producer.group</td><td>生产者组名称，同类生产者归为一组</td><td>无（必配）</td><td>用于容错和负载均衡，不可与消费者组重名</td></tr><tr><td>rocketmq.consumer.group</td><td>消费者组名称，同类消费者归为一组</td><td>无（必配）</td><td>集群模式下分摊消费，广播模式下仅用于标识</td></tr><tr><td>rocketmq.consumer.message-model</td><td>消费模式，CLUSTERING（集群）/BROADCASTING（广播）</td><td>CLUSTERING</td><td>集群模式：一条消息仅被组内一个消费者消费；广播模式：组内所有消费者都能收到</td></tr><tr><td>rocketmq.producer.retry-times-when-send-failed</td><td>同步发送失败重试次数（不含第一次发送）</td><td>2</td><td>网络波动、Broker 繁忙时，提高消息发送成功率</td></tr><tr><td>rocketmq.consumer.consume-message-batch-max-size</td><td>每次批量消费的消息数量</td><td>1</td><td>消息量大时，调大该值提高消费效率（不宜过大，避免内存溢出）</td></tr></tbody></table>
<h3 data-id="heading-8">3 常见问题与注意事项（避坑重点）</h3>
<p>整合过程中，新手容易遇到各类问题，以下是高频问题及解决方案，结合参考资料中的兼容问题和实操踩坑经验整理：</p>
<h4 data-id="heading-9">3.1 常见问题及解决方案</h4>
<ul>
<li>问题1：项目启动失败，提示“Could not autowire. No beans of 'RocketMQTemplate' type found” 解决方案：检查 RocketMQ starter 依赖是否引入，版本是否与 SpringBoot 适配（SpringBoot 2.7.x 对应 starter 2.2.3+）；检查配置文件中 rocketmq.name-server 是否配置正确。</li>
<li>问题2：消息发送成功，但消费者收不到消息 解决方案：① 检查生产者和消费者的 topic 是否一致；② 检查消费者组名称是否与 application.yml 中配置的一致；③ 检查消费模式是否正确，集群模式下若多个消费者实例，消息会分摊消费，可关闭其他实例重试；④ 检查 RocketMQ 服务是否正常运行，NameServer 与 Broker 连接是否正常。</li>
<li>问题3：发送对象消息时，消费者接收失败，提示“序列化失败” 解决方案：实体类必须实现 Serializable 接口；确保生产者和消费者的实体类全路径一致（包名、类名完全相同）；避免实体类中存在不可序列化的字段（如 transient 修饰的字段）。</li>
<li>问题4：项目启动失败，提示“ApplicationContext 初始化失败” 解决方案：大概率是版本不兼容，SpringBoot 2.7.x 不可使用低于 2.2.3 版本的 RocketMQ starter；避免混合使用不同版本的 Spring 相关依赖。</li>
<li>问题5：消息消费失败，无法触发重试 解决方案：消费方法中若出现异常，需手动抛出 RuntimeException（不可捕获后不抛出），Spring 会感知异常并触发重试；检查重试次数配置（默认16次），重试达到上限后消息会进入死信队列。</li>
</ul>
<h4 data-id="heading-10">3.2 注意事项</h4>
<ul>
<li>版本适配是关键：严格按照本文推荐的版本组合配置，避免因版本不兼容导致各类异常，具体可参考 Apache RocketMQ 官方兼容性矩阵。</li>
<li>组名称规范：生产者组和消费者组不可重名，同一业务场景的生产者/消费者归为同一组，不同业务场景使用不同的组名称。</li>
<li>生产环境配置：生产环境中，需关闭 Broker 的 autoCreateTopicEnable 配置，提前手动创建主题和队列；消息发送失败需做降级处理（如存入数据库，后续补偿发送），避免消息丢失。</li>
<li>消息重试与死信队列：消费失败会触发重试，重试达到上限后消息进入死信队列（DLQ），需手动处理死信队列中的消息，避免数据丢失。</li>
<li>配置文件规范：尽量避免硬编码，消费者组、主题等可通过配置文件读取，方便后续环境切换（开发/测试/生产）。</li>
</ul>
<blockquote>
<p>整合 springboot 是很简单的，使用方法跟 redis 类似，主要是需要了解在什么场景用什么消息发送机制，以及消息发送机制可能会影响的效率。</p>
</blockquote>
<h3 data-id="heading-11">4 总结</h3>
<p>本文详细讲解了 RocketMQ 与 SpringBoot 的完整整合流程，从环境准备、依赖配置、生产者/消费者实现，到测试验证和避坑指南，全程贴合开发实际场景，突出实操性。核心亮点是利用 SpringBoot 的自动配置特性，通过 RocketMQTemplate 和 @RocketMQMessageListener 注解，摒弃了原生 API 繁琐的实例创建和配置，让开发者能够快速实现消息的发送与接收。</p>
<p>整合的核心要点的是“版本适配”和“配置规范”，只要严格遵循本文的版本组合和配置要求，就能顺利完成整合。后续可基于本文的基础，扩展 RocketMQ 的高级功能，如事务消息、延迟消息、消息过滤等，适配更复杂的业务场景（如分布式事务、定时任务通知等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent Nexus 版本核心场景测试报告]]></title>    <link>https://juejin.cn/post/7600060691350487082</link>    <guid>https://juejin.cn/post/7600060691350487082</guid>    <pubDate>2026-01-28T14:31:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350487082" data-draft-id="7600248718360936490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent Nexus 版本核心场景测试报告"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:31:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent Nexus 版本核心场景测试报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:31:28.000Z" title="Wed Jan 28 2026 14:31:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ooderAgent Nexus 版本核心场景测试报告</h2>
<h3 data-id="heading-1">报告概述</h3>
<p>本报告基于 ooderAgent Nexus 版本（v0.6.5）的核心功能测试，涵盖了 5 个关键场景的验证结果。旨在为系统的生产环境落地提供技术依据。</p>
<h3 data-id="heading-2">一、服务发现测试：P2P 网络基础能力</h3>
<h4 data-id="heading-3">测试目的</h4>
<p>验证基于 UDP 广播的服务发现机制在局域网环境下的可靠性和效率。</p>
<h4 data-id="heading-4">测试内容</h4>
<ol>
<li>单台 End Agent 服务发现测试</li>
<li>10 台 End Agent 同时服务发现测试</li>
<li>网络波动场景下的服务发现恢复测试</li>
</ol>
<h4 data-id="heading-5">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff04e953411426b95c71b9b02fb27a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=CWojqBzNvk8Yvh%2FMlQ2Zgw7UY6A%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-6">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">响应时间</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">单台 End Agent 发现</td><td align="left">✅ 通过</td><td align="left">127ms</td><td align="left">100%</td></tr><tr><td align="left">10 台 End Agent 同时发现</td><td align="left">✅ 通过</td><td align="left">平均 183ms</td><td align="left">100%</td></tr><tr><td align="left">网络波动恢复</td><td align="left">✅ 通过</td><td align="left">231ms</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-7">技术验证</h4>
<p>服务发现机制在局域网环境下表现稳定，响应时间符合预期，能够快速发现和加入网络。UDP 广播方式实现简单、轻量，适合个人和小型企业部署。</p>
<h3 data-id="heading-8">二、代理层次测试：三层架构协同能力</h3>
<h4 data-id="heading-9">测试目的</h4>
<p>验证 MCP Agent → Route Agent → End Agent 三层架构的协同工作能力和消息传递机制。</p>
<h4 data-id="heading-10">测试内容</h4>
<ol>
<li>三层 Agent 消息传递测试</li>
<li>Route Agent 场景管理测试</li>
<li>MCP Agent 资源管理测试</li>
</ol>
<h4 data-id="heading-11">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0395ff4b3cf4b7680bb6ad745d0f325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=MblbUFa86xBoxHwOXDJO%2FPqmnR0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-12">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">消息传递延迟</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">三层消息传递</td><td align="left">✅ 通过</td><td align="left">平均 68ms</td><td align="left">100%</td></tr><tr><td align="left">场景管理</td><td align="left">✅ 通过</td><td align="left">平均 45ms</td><td align="left">100%</td></tr><tr><td align="left">资源管理</td><td align="left">✅ 通过</td><td align="left">平均 82ms</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-13">技术验证</h4>
<p>三层 Agent 架构职责清晰，消息传递高效，场景管理和资源调度功能正常。架构设计具备横向扩展能力，为后续企业级应用预留了接口。</p>
<h3 data-id="heading-14">三、网络环境测试：多网络场景适配能力</h3>
<h4 data-id="heading-15">测试目的</h4>
<p>验证系统在本地网络和局域网环境下的性能表现和稳定性。</p>
<h4 data-id="heading-16">测试内容</h4>
<ol>
<li>本地网络（同一主机）测试</li>
<li>局域网（同一网段）测试</li>
<li>网络环境切换测试</li>
</ol>
<h4 data-id="heading-17">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6eb72ed8fba48458e333d02ddd1fdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=GytE%2BFe8t1dCidN6cp2949M7sNA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-18">测试结果</h4>





























<table><thead><tr><th align="left">网络环境</th><th align="left">服务发现成功率</th><th align="left">平均通信延迟</th><th align="left">稳定性评分</th></tr></thead><tbody><tr><td align="left">本地网络</td><td align="left">✅ 100%</td><td align="left">42ms</td><td align="left">9.8/10</td></tr><tr><td align="left">局域网</td><td align="left">✅ 99.5%</td><td align="left">115ms</td><td align="left">9.5/10</td></tr><tr><td align="left">网络切换</td><td align="left">✅ 99%</td><td align="left">158ms</td><td align="left">9.2/10</td></tr></tbody></table>
<h4 data-id="heading-19">技术验证</h4>
<p>系统能够自动检测网络环境并调整配置，在本地网络和局域网环境下表现稳定。网络环境切换功能正常，能够适应不同网络场景的需求。</p>
<h3 data-id="heading-20">四、性能测试：常规并发处理能力</h3>
<h4 data-id="heading-21">测试目的</h4>
<p>验证系统在常规并发场景下的响应速度和吞吐量。</p>
<h4 data-id="heading-22">测试内容</h4>
<ol>
<li>10 并发请求测试</li>
<li>50 并发请求测试</li>
<li>并发场景下的资源占用测试</li>
</ol>
<h4 data-id="heading-23">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/990d44d7925c4fd3b7678caf6deb3777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=u1LdT39NV%2F19EzQ8D3JtcmDIBO8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-24">测试结果</h4>


























<table><thead><tr><th align="left">并发数</th><th align="left">平均响应时间</th><th align="left">吞吐量</th><th align="left">CPU使用率</th><th align="left">内存使用率</th></tr></thead><tbody><tr><td align="left">10</td><td align="left">87ms</td><td align="left">114.9 requests/sec</td><td align="left">12%</td><td align="left">28%</td></tr><tr><td align="left">50</td><td align="left">143ms</td><td align="left">349.7 requests/sec</td><td align="left">35%</td><td align="left">35%</td></tr></tbody></table>
<h4 data-id="heading-25">技术验证</h4>
<p>系统在常规并发场景下表现良好，响应时间和吞吐量符合预期，资源占用合理。能够满足个人和小型企业的日常使用需求。</p>
<h3 data-id="heading-26">五、可靠性测试：常见异常恢复能力</h3>
<h4 data-id="heading-27">测试目的</h4>
<p>验证系统在常见网络波动和 Agent 重启场景下的恢复能力。</p>
<h4 data-id="heading-28">测试内容</h4>
<ol>
<li>短暂网络中断恢复测试（30秒）</li>
<li>End Agent 重启恢复测试</li>
<li>Route Agent 重启恢复测试</li>
</ol>
<h4 data-id="heading-29">测试流程图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e6c9c63cdb4f29828e67b48e42d6f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216461&amp;x-signature=tpWoA1w8SQp6fLa4%2Fz%2FoX9shpRs%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-30">测试结果</h4>





























<table><thead><tr><th align="left">测试项</th><th align="left">测试结果</th><th align="left">恢复时间</th><th align="left">成功率</th></tr></thead><tbody><tr><td align="left">网络中断恢复</td><td align="left">✅ 通过</td><td align="left">2.1秒</td><td align="left">100%</td></tr><tr><td align="left">End Agent 重启恢复</td><td align="left">✅ 通过</td><td align="left">3.5秒</td><td align="left">100%</td></tr><tr><td align="left">Route Agent 重启恢复</td><td align="left">✅ 通过</td><td align="left">4.8秒</td><td align="left">100%</td></tr></tbody></table>
<h4 data-id="heading-31">技术验证</h4>
<p>系统在常见异常场景下能够快速恢复，保持稳定运行。恢复时间符合预期，能够满足日常使用中的稳定性要求。</p>
<h3 data-id="heading-32">技术验证总结</h3>
<h4 data-id="heading-33">核心技术能力验证</h4>
<ol>
<li><strong>服务发现能力</strong>：UDP 广播服务发现机制在局域网环境下可靠高效，响应时间快</li>
<li><strong>三层架构协同</strong>：MCP → Route → End 三层架构职责清晰，消息传递高效</li>
<li><strong>网络环境适配</strong>：能够自动检测网络环境并调整配置，适应不同网络场景</li>
<li><strong>性能处理能力</strong>：常规并发场景下表现良好，资源占用合理</li>
<li><strong>可靠性保障</strong>：常见异常场景下能够快速恢复，保持系统稳定</li>
</ol>
<h4 data-id="heading-34">技术优化建议</h4>
<ol>
<li><strong>UDP 服务发现优化</strong>：
<ul>
<li>增加静态注册中心作为跨网段场景的兜底方案</li>
<li>实现请求-响应确认机制，提高传输可靠性</li>
</ul>
</li>
<li><strong>消息路由优化</strong>：
<ul>
<li>实现消息定向转发，减少冗余消息</li>
<li>引入轻量级消息队列，提升并发处理能力</li>
</ul>
</li>
<li><strong>网络环境适配优化</strong>：
<ul>
<li>补充网络质量检测指标，动态调整系统配置</li>
<li>实现网络切换实时适配，提升系统稳定性</li>
</ul>
</li>
<li><strong>工程化落地优化</strong>：
<ul>
<li>建立日志监控体系，方便问题排查</li>
<li>加强安全加固，提升系统安全性</li>
<li>实现配置持久化，确保系统重启后配置不丢失</li>
</ul>
</li>
</ol>
<h3 data-id="heading-35">结论与建议</h3>
<h4 data-id="heading-36">测试结论</h4>
<p>ooderAgent Nexus 版本（v0.6.5）的核心功能测试全部通过，验证了系统在局域网环境下的可靠性、稳定性和性能表现。系统具备个人和小型企业生产环境初步落地的技术基础，能够满足日常使用需求。</p>
<h4 data-id="heading-37">落地建议</h4>
<ol>
<li><strong>适用场景</strong>：推荐在个人、家庭和小型企业的局域网环境下部署使用</li>
<li><strong>部署建议</strong>：
<ul>
<li>局域网环境优先使用 UDP 广播服务发现</li>
<li>确保网络设备允许 UDP 广播包传输</li>
<li>合理规划 Route Agent 部署位置，确保网络覆盖</li>
</ul>
</li>
<li><strong>后续优化</strong>：
<ul>
<li>优先实现跨网段服务发现能力</li>
<li>加强系统安全性和监控能力</li>
<li>完善文档和部署指南，降低使用门槛</li>
</ul>
</li>
</ol>
<p>ooderAgent Nexus 版本已经具备了核心功能的技术验证基础，通过持续的优化和完善，有望成为分布式 AI 代理系统的优秀解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力]]></title>    <link>https://juejin.cn/post/7600229327436906546</link>    <guid>https://juejin.cn/post/7600229327436906546</guid>    <pubDate>2026-01-28T14:22:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436906546" data-draft-id="7600229327436890162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2026-01-28T14:22:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Akamai Cloud客户案例 | Multivrse 信赖 Akamai 为其业务增长提供动力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:22:07.000Z" title="Wed Jan 28 2026 14:22:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“只要 Multivrse 存在，我们就会使用 Akamai。这份合作关系至关重要。”</p>
<p>——Amol Patankar，Multivrse 创始人</p>
</blockquote>
<p><strong><strong>赋能全球对话</strong></strong></p>
<p>澳大利亚多语言服务公司 Multivrse Digital 面临着一个常见而紧迫的挑战：持续攀升的云成本、不够稳定的技术支持，以及AWS本身的复杂性，正逐渐阻碍其业务发展的脚步。在其大规模提供快速、准确且符合文化背景的内容的使命中，敏捷性和基础设施的简洁性至关重要。通过迁移至 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fcloud%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external1_blogarticles246" target="_blank" title="https://www.akamai.com/zh/cloud?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external1_blogarticles246" ref="nofollow noopener noreferrer">Akamai 云计算服务</a>，Multivrse 实现了更快速的资源调配，节省高达 70% 的成本，并获得了始终如一的支持，从而能够安心地向全球扩展业务。</p>
<p><strong><strong>亟需克服云复杂性与成本压力</strong></strong></p>
<p>Multivrse 由 Amol Patankar 创立，致力于帮助企业以受众偏好的语言连接全球用户。其采用的混合方法结合了 AI 驱动的翻译与母语语言专家。结果如何？内容不仅准确，更契合文化背景并保持品牌一致性。“我们不仅是翻译服务提供商，” Patankar 解释道，“更是帮助品牌全球化扩张并深化客户参与的战略合作伙伴。”</p>
<p>作为一家精益初创企业，Multivrse 需要的云平台不仅技术过硬，还需具备成本效益、用户友好，并有响应迅速的供应商支持。“在 AWS 时，我们没有专属联系人。获取回复需要数天时间。这种延迟对成长中的企业是行不通的，” Patankar 表示。</p>
<p>Multivrse 技术与运营主管 Vivek Sathyaganesh 指出：“此外，AWS 的定价难以预测。每项功能都是额外收费。而且定价因地区而异，导致我们每月都无法预估开支。”</p>
<p>随着业务增长和客户需求跨地域扩展，Multivrse 不得不重新评估其基础设施。</p>
<p><strong><strong>信赖 Akamai 的定价透明度、技术匹配与战略指导</strong></strong></p>
<p>迁移至 Akamai 的决定源于长达十年的信任。Patankar 此前在航空和零售行业担任企业职位时曾与 Akamai 合作，亲身见证了 Akamai 在性能、安全性和指导方面的价值。</p>
<p>“当我创立 Multivrse 时，我就知道我们最终会迁移到 Akamai，” 他说，“Akamai 的团队始终随时可用，善于协作且以解决方案为导向。这样的支持是无价的。”</p>
<p>对于负责 Multivrse 平台管理的 Sathyaganesh 而言，Akamai 的以下能力尤为突出：直接明了的资源调配、透明的定价、对开发者友好的工具，以及边缘与计算集成。“AWS 将出口流量分为不同层级、区域和数据类型，导致定价过于复杂，” 他强调说。</p>
<p><strong><strong>轻松从 AWS 迁移至 Akamai 云计算服务</strong></strong></p>
<p>从一开始，Akamai 的协作方式就给 Multivrse 留下了深刻印象。Akamai 使从 AWS 的迁移变得无忧无虑。这一体验与 AWS 截然不同，后者在不同区域间迁移十分复杂。“迁移到 Akamai 非常容易，并且管理起来立即变得更为简便，” Sathyaganesh 表示。</p>
<p>具体而言，Multivrse 使用以下 Akamai 云计算服务替代了 EC2、RDS、S3 和 Route53：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-cloud-computing%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external2_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-cloud-computing?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external2_blogarticles246" ref="nofollow noopener noreferrer">Cloud Firewall</a>：内置规则的防火墙帮助 Multivrse 保护工作负载，无需外部工具。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-container%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external3_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-container?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external3_blogarticles246" ref="nofollow noopener noreferrer">DNS Manager</a>：Akamai Cloud Manager 中的这一综合界面使全球域名管理变得轻松便捷。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-is-a-firewall%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external4_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-is-a-firewall?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external4_blogarticles246" ref="nofollow noopener noreferrer">NodeBalancers</a>：这些完全托管、高可用的负载均衡器可在数分钟内部署，确保高可用性和性能。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-cloud-resources%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external5_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-cloud-resources?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external5_blogarticles246" ref="nofollow noopener noreferrer">Managed Databases</a>：这项完全托管的数据库服务提供自动备份和更新，使 Multivrse 能够轻松部署高性能数据库集群。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fhow-do-apis-work%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external6_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/how-do-apis-work?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external6_blogarticles246" ref="nofollow noopener noreferrer">Object Storage</a>：这种持久、可扩展且经济高效的存储与 S3 兼容，定价简化，访问容易。</li>
<li>Longview：Multivrse 使用这一集成监控与分析工具来了解云计算服务器的健康状况和性能。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fglossary%2Fwhat-are-databases%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external7_blogarticles246" target="_blank" title="https://www.akamai.com/zh/glossary/what-are-databases?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external7_blogarticles246" ref="nofollow noopener noreferrer">Essential Compute</a>：这种简化的虚拟机托管可以快速调配，并提供统一透明的定价。</li>
<li>Private Networking：Multivrse 使用此云计算服务建立虚拟网络，隔离流量以实现安全的多层部署。</li>
</ul>
<p><strong><strong>实现关键成果：更快的资源调配、成本节约与更低延迟</strong></strong></p>
<p>迁移至 Akamai 带来了定量与定性的双重收益。用 Akamai 云计算服务替代 AWS 实现了：</p>
<ul>
<li>计算和存储成本降低 <strong><strong>50%–70%</strong></strong>，特别是针对内存优化和高需求工作负载</li>
<li>虚拟机资源调配速度提升 <strong><strong>30%–40%</strong></strong></li>
<li>通过 Akamai 的分布式骨干网，全球用户延迟降低 <strong><strong>20%–50%</strong></strong></li>
</ul>
<p>Sathyaganesh 表示：“Akamai 云计算服务对开发者非常友好。其控制面板和命令行界面清晰、直观，相比 AWS 或 Azure 更易于操作。启动虚拟机、对象存储和 NodeBalancers 只需点击几下，过程简单明了。”</p>
<p>“与 Akamai 相比，AWS 的成本异常高昂。” Patankar 补充道，“在 Akamai 上，我们过去为一个 AWS 实例支付的费用现在能获得三个实例。这对我们这样的初创企业来说是颠覆性的改变。”</p>
<p><strong><strong>凭借企业级指导与支持做出明智的基础设施选择</strong></strong></p>
<p>一个关键差异在于 Akamai 的咨询式方法和协作式技术评审，这帮助 Multivrse 做出了更智能的基础设施决策。“Akamai 娴熟而清晰地指导我们避免了不必要的 Kubernetes 复杂性，转而采用适合我们需求的标准模型，” Sathyaganesh 解释道，“在当前阶段建议我们暂不使用 Kubernetes，为我们节省了时间和成本，并提供了一条更清晰的技术路径。”</p>
<p>Multivrse 同样看重 Akamai 的可用性和响应速度。“我们可以随时拨打电话，联系到理解我们业务和技术需求的人，并及时获得建议，” Patankar 说，“这很难得——而这是我们在 AWS 未曾获得的体验。”</p>
<p><strong><strong>赋能全球扩展与未来增长</strong></strong></p>
<p>基于 Akamai 稳健的基础设施，Multivrse 的多语言平台利用先进的计算能力，结合专有算法和流程，提供更快速、更个性化的客户体验——使公司能够在覆盖范围和创新能力上实现全球扩展。以 Akamai 作为云合作伙伴，Multivrse 定位于持续实现其愿景：帮助品牌快速、高效且有意义地讲述每一位客户的语言。</p>
<p>“随着我们的成长，我们计划根据客户需求扩展至更多地区。我们知道，有了 Akamai，我们前进的每一步都将获得支持，” Patankar 总结道。</p>
<p><strong><strong>关于 Multivrse Digital</strong></strong></p>
<p>Multivrse 是一家技术驱动的多语言服务公司，致力于帮助品牌跨越语言和文化，与客户建立更有意义的连接。通过将基于 AI 的翻译技术与母语专家经验相结合，Multivrse 为网站、营销活动和客户沟通提供可扩展的高质量多语言解决方案。我们的使命是让数字体验更具包容性、可访问性和吸引力——帮助组织扩大影响范围、增强客户忠诚度、推动全球增长，并最终更贴近客户。</p>
<p><strong><strong>关于 Akamai</strong></strong></p>
<p>Akamai 是一家为在线业务提供动力并予以保护的网络安全和云计算公司。我们市场领先的安全解决方案、卓越的威胁情报和全球运营团队提供深度防御，随时随地保护企业数据和应用程序。Akamai 的全栈云计算解决方案在全球分布最广的平台上提供高性能与高性价比。全球企业信赖 Akamai 提供行业领先的可靠性、规模与专业能力，以自信地发展业务。了解更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external8_blogarticles246" target="_blank" title="https://www.akamai.com/zh?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external8_blogarticles246" ref="nofollow noopener noreferrer">akamai.com</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Fblog%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_260128_external9_blogarticles246" target="_blank" title="https://www.akamai.com/zh/blog?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_260128_external9_blogarticles246" ref="nofollow noopener noreferrer">akamai.com/blog</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[type-challenges（ts类型体操）: 7 - 对象属性只读]]></title>    <link>https://juejin.cn/post/7600224355294822427</link>    <guid>https://juejin.cn/post/7600224355294822427</guid>    <pubDate>2026-01-28T14:45:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294822427" data-draft-id="7600245693997776906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="type-challenges（ts类型体操）: 7 - 对象属性只读"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-28T14:45:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            type-challenges（ts类型体操）: 7 - 对象属性只读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:45:17.000Z" title="Wed Jan 28 2026 14:45:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">7 - 对象属性只读</h2>
<p>by Anthony Fu (@antfu) #简单 #built-in #readonly #object-keys</p>
<h3 data-id="heading-1">题目</h3>
<p>不要使用内置的<code>Readonly&lt;T&gt;</code>，自己实现一个。</p>
<p>泛型 <code>Readonly&lt;T&gt;</code> 会接收一个 <em>泛型参数</em>，并返回一个完全一样的类型，只是所有属性都会是只读 (readonly) 的。</p>
<p>也就是不可以再对该对象的属性赋值。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">todo</span>: <span class="hljs-title class_">MyReadonly</span>&lt;<span class="hljs-title class_">Todo</span>&gt; = {
  <span class="hljs-attr">title</span>: <span class="hljs-string">"Hey"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"foobar"</span>
}

todo.<span class="hljs-property">title</span> = <span class="hljs-string">"Hello"</span> <span class="hljs-comment">// Error: cannot reassign a readonly property</span>
todo.<span class="hljs-property">description</span> = <span class="hljs-string">"barFoo"</span> <span class="hljs-comment">// Error: cannot reassign a readonly property</span>
</code></pre>
<blockquote>
<p>在 Github 上查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fzh-CN" target="_blank" title="https://tsch.js.org/7/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/7/zh-CN</a></p>
</blockquote>
<h3 data-id="heading-2">代码</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 你的代码 _____________ */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReadonly</span>&lt;T&gt; = {
  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P]
}

</code></pre>
<p>关键解释：</p>
<ul>
<li><code>readonly</code> 关键字用于将属性设置为只读，即不能对其进行赋值操作；</li>
<li><code>[P in keyof T]</code> 用于遍历泛型 <code>T</code> 的所有属性键；</li>
<li><code>T[P]</code> 用于获取属性 <code>P</code> 的类型。</li>
</ul>
<h3 data-id="heading-3">相关知识点</h3>
<h4 data-id="heading-4"><code>readonly</code></h4>
<ul>
<li>核心作用：标记后，目标（属性 / 数组 / 元组）只能在初始化阶段赋值（比如接口实例化、类构造函数、变量声明时），后续任何修改操作都会被 TS 编译器拦截报错；</li>
<li>运行时特性：<code>readonly</code> 仅做编译时检查，不会生成任何额外 JS 代码，也无法真正阻止运行时的修改（比如通过类型断言绕开的话，运行时仍能改）；</li>
<li>与 <code>const</code> 的区别：<code>const</code> 是变量层面的不可重新赋值（但变量指向的对象 / 数组内部属性仍可改），<code>readonly</code> 是属性 / 类型层面的不可修改（变量本身可重新赋值，除非变量也用 <code>const</code>）。</li>
</ul>
<p>常用使用场景：</p>
<ol>
<li>作用于接口 / 类型别名的属性（最基础）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义带只读属性的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性：只能初始化赋值，后续不可改</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 普通属性：可修改</span>
}

<span class="hljs-comment">// 初始化时赋值（合法）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> };

<span class="hljs-comment">// 尝试修改只读属性（报错）</span>
user.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：无法分配到 "id"，因为它是只读属性</span>
<span class="hljs-comment">// 修改普通属性（合法）</span>
user.<span class="hljs-property">name</span> = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// ✅ 合法</span>
</code></pre>
<ol start="2">
<li>作用于类的属性: 类中使用 <code>readonly</code> 标记属性，只能在<strong>声明时</strong>或<strong>构造函数中</strong>赋值，后续无法修改</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 构造函数中给 readonly 属性赋值（唯一合法的后续赋值方式）</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">updateInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// ❌ 报错：id 是只读属性</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"王五"</span>; <span class="hljs-comment">// ✅ 合法</span>
  }
}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"赵六"</span>);
person.<span class="hljs-property">id</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// ❌ 报错：只读属性不可修改</span>
</code></pre>
<ol start="3">
<li>作用于数组 / 元组（只读数组）: <code>readonly</code> 可标记数组为 “只读数组”，禁止修改数组元素、调用 <code>push/pop</code> 等修改方法</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 方式1：使用 readonly 修饰数组类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr1</span>: <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
arr1.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>); <span class="hljs-comment">// ❌ 报错：readonly 数组不存在 push 方法</span>
arr1[<span class="hljs-number">0</span>] = <span class="hljs-number">10</span>; <span class="hljs-comment">// ❌ 报错：无法修改只读数组的元素</span>

<span class="hljs-comment">// 方式2：使用 ReadonlyArray&lt;T&gt; 类型（等价于 readonly T[]）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arr2</span>: <span class="hljs-title class_">ReadonlyArray</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>];
arr2.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// ❌ 报错</span>

<span class="hljs-comment">// 作用于元组（只读元组）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Point</span> = <span class="hljs-keyword">readonly</span> [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-keyword">const</span> <span class="hljs-attr">point</span>: <span class="hljs-title class_">Point</span> = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>];
point[<span class="hljs-number">0</span>] = <span class="hljs-number">30</span>; <span class="hljs-comment">// ❌ 报错：只读元组元素不可修改</span>
</code></pre>
<ol start="4">
<li>结合 <code>keyof</code> + <code>in</code> 批量创建只读类型（映射类型）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">stock</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 批量创建只读版本的 Product（TS 内置的 Readonly&lt;T&gt; 就是这么实现的）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyProduct</span> = {
  <span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof <span class="hljs-title class_">Product</span>]: <span class="hljs-title class_">Product</span>[K];
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">product</span>: <span class="hljs-title class_">ReadonlyProduct</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">"手机"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">2999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">100</span> };
product.<span class="hljs-property">price</span> = <span class="hljs-number">3999</span>; <span class="hljs-comment">// ❌ 报错：price 是只读属性</span>

<span class="hljs-comment">// TS 内置了 Readonly&lt;T&gt;，可直接使用（无需手动写映射类型）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">product2</span>: <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Product</span>&gt; = { <span class="hljs-attr">name</span>: <span class="hljs-string">"电脑"</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">5999</span>, <span class="hljs-attr">stock</span>: <span class="hljs-number">50</span> };
product2.<span class="hljs-property">stock</span> = <span class="hljs-number">60</span>; <span class="hljs-comment">// ❌ 报错</span>
</code></pre>
<ol start="5">
<li>只读索引签名：如果类型使用索引签名，也可以标记为 <code>readonly</code>，禁止通过索引修改属性</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 只读索引签名：只能读取，不能修改</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyDict</span> = {
  <span class="hljs-keyword">readonly</span> [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">dict</span>: <span class="hljs-title class_">ReadonlyDict</span> = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
dict[<span class="hljs-string">"a"</span>] = <span class="hljs-number">3</span>; <span class="hljs-comment">// ❌ 报错：索引签名是只读的</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dict[<span class="hljs-string">"b"</span>]); <span class="hljs-comment">// ✅ 合法：仅读取</span>
</code></pre>
<h4 data-id="heading-5"><code>keyof</code></h4>
<p><code>keyof</code> 操作符用于获取对象类型的所有属性名（包括索引签名），并将其转换为联合类型。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoKeys</span> = keyof <span class="hljs-title class_">Todo</span> <span class="hljs-comment">// "title" | "description" | "completed"</span>
</code></pre>
<h4 data-id="heading-6"><code>in</code></h4>
<p><code>in</code> 操作符用于遍历联合类型中的每个成员。</p>
<p>例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoKeys</span> = <span class="hljs-string">'title'</span> | <span class="hljs-string">'description'</span> | <span class="hljs-string">'completed'</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">TodoPreview</span> = {
  [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">TodoKeys</span>]: <span class="hljs-title class_">Todo</span>[P]
}
<span class="hljs-comment">// TodoPreview 类型为：</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   title: string</span>
<span class="hljs-comment">//   description: string</span>
<span class="hljs-comment">//   completed: boolean</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h3 data-id="heading-7">测试用例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/* _____________ 测试用例 _____________ */</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Equal</span>, <span class="hljs-title class_">Expect</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-challenges/utils'</span>

<span class="hljs-keyword">type</span> cases = [
  <span class="hljs-title class_">Expect</span>&lt;<span class="hljs-title class_">Equal</span>&lt;<span class="hljs-title class_">MyReadonly</span>&lt;<span class="hljs-title class_">Todo1</span>&gt;, <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Todo1</span>&gt;&gt;&gt;,
]

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo1</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">author</span>: <span class="hljs-built_in">string</span>
  }
}

</code></pre>
<h3 data-id="heading-8">相关链接</h3>
<blockquote>
<p>分享你的解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fanswer%2Fzh-CN" target="_blank" title="https://tsch.js.org/7/answer/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/7/answer/zh…</a>
查看解答：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2F7%2Fsolutions" target="_blank" title="https://tsch.js.org/7/solutions" ref="nofollow noopener noreferrer">tsch.js.org/7/solutions</a>
更多题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftsch.js.org%2Fzh-CN" target="_blank" title="https://tsch.js.org/zh-CN" ref="nofollow noopener noreferrer">tsch.js.org/zh-CN</a></p>
</blockquote>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770216317&amp;x-signature=RuBFNnp%2BFwjiDs0CLPw5aBOdr00%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从理论到实战，一期彻底搞懂 Agent Skills！]]></title>    <link>https://juejin.cn/post/7600296037542477824</link>    <guid>https://juejin.cn/post/7600296037542477824</guid>    <pubDate>2026-01-28T14:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037542477824" data-draft-id="7600296037542461440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从理论到实战，一期彻底搞懂 Agent Skills！"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ConardLi"/> <meta itemprop="url" content="https://juejin.cn/user/3949101466785709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从理论到实战，一期彻底搞懂 Agent Skills！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3949101466785709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ConardLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:56:04.000Z" title="Wed Jan 28 2026 14:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>本期视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1GXzaByEEo%2F" target="_blank" title="https://www.bilibili.com/video/BV1GXzaByEEo/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1GX…</a></strong></p>
<p>Agent Skills 最近非常的火，它是既 MCP 后 Anthropic 推出的又一个 Agent 领域的行业标准。</p>
<p>它的成长路线和 MCP 也非常像，25 年 10 月份发布时只有 Anthropic 自家产品支持，后来 Cursor、Codex、Opencode、Gemini CLI 等产品看到了 Skills 的优势于是纷纷开始支持。</p>
<p>再后来社区开始涌现大量的开源 Skills 以及 Skills 开放市场，当下大家已经默认 Skills 成为了又一个扩展 Agent 能力的标准实践。</p>
<p>简单来说，Skills 的作用就是将那些重复性的、专业的流程进行打包封装。当你需要使用某种能力时，不再需要像过去那样每次都去查阅手册或重新输入冗长的提示词，而是像调用工具一样直接使用。</p>
<p>在本篇文章中，我们将从浅入深，和大家一起学习以下知识：</p>
<ol>
<li>Skills 入门理解：Skills 到底是什么？长什么样？怎么工作的？</li>
<li>Skills VS MCP：Skills 和 MCP 的区别是什么，MCP 会被淘汰吗？</li>
<li>Skills 初步尝试：去哪里找 Skill？怎么使用 Skill？怎么自己创建一个 Skill？</li>
<li>Skills 实战使用：如何用 Skills 实现外部知识检索？比传统 RAG 的优势在哪？</li>
<li>Skills 安全分析：Skills 的安全性如何？使用它有哪些风险？</li>
</ol>
<h2 data-id="heading-0">一、 Skills 入门理解</h2>
<h3 data-id="heading-1">1.1 Skills 到底是什么？</h3>
<p>在传统的 AI 聊天模式中，AI 的能力取决于：</p>
<ul>
<li>它原本学过什么（训练数据）</li>
<li>你临时在对话框里告诉它什么（提示词、工具、记忆）</li>
</ul>
<p>这就像你招了个什么都懂一点的实习生，每次干活你都得重新教一遍。</p>
<p>而 Agent Skills 带来了一种全新的玩法：模块化能力插件。</p>
<p>你可以把 Claude（支持 Skills 的客户端）想象成一个超级大脑，而 Agent Skills 就是给这个大脑安装的外接工具箱。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd5bf7a07e0403fa28be4c59f879816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=PsoI3q%2FQFDSzfUQRN%2BHJ3JSp3qs%3D" alt="" loading="lazy"/></p>
<p>这个工具箱里不仅有工具本身，还包含了详细的 “官方使用说明书”，大脑不需要理解具体有哪些工具以及工具的用法是什么，只需要在需要使用某个工具时查看工具说明书，再把工具拿出来用。</p>
<h3 data-id="heading-2">1.2 Skills 长什么样？</h3>
<p>Agent Skills 的官方文档中强调了一个核心关键词：File-system based（基于文件系统）。</p>
<p>如果你写过代码，可能很容易理解。</p>
<p>要编写一个程序，并不一定所有代码都是我们自己写的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afcd5073dd804f8f8302c34627be0920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=zsINEVF8pG4I72rBZxZqG%2FngYAo%3D" alt="" loading="lazy"/></p>
<p>我们可能会通过 import xxx 来引入一些外部包，这些包存放在固定的位置（如 node_modules）。</p>
<p>当程序需要调用这些包的能力时，就会从指定文件夹取出对应的代码然后执行。</p>
<p>Agent Skills 也是类似的逻辑，每个 Skill 都是一个实实在在存在的文件夹，它存放在一个固定的位置（如 .claude/skills）这个文件夹里装着下面几样东西：</p>
<ol>
<li>指令（SKILL.md）： 告诉 AI 怎么干活的 SOP。</li>
<li>参考（reference）： 更详细的参考文档（可选）。</li>
<li>脚本（scripts）： 比如 Python 代码，让 Skill 也能调用外部能力（可选）。</li>
<li>资源（assets）：图片、模版等可能使用到的资源（可选）。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/335192c6069042bbbcb02b518a0ad6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=qf5QYfctQbbaHXE75AprDVq2DRo%3D" alt="" loading="lazy"/></p>
<p>如果你在你的 Agent（如 Claude Code）执行目录（如你的项目代码目录）下放了这个文件夹，</p>
<p>那下次和 Agent 对话的时候就能自动根据你的需求匹配到这个 Skill，不需要再进行任何额外的配置。</p>
<p>比如，你希望 Agent 帮你润色文章，就可以编写一个下面这样的 Skill：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a311faa36846e482f443b125c6938f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=K979LbaPu%2Fv5WfMuuYtPRnsZaxw%3D" alt="" loading="lazy"/></p>
<p>上面的三根短横线部分相当于 Skill 的「身份证」：</p>
<ul>
<li>name 是它的唯一标识，起个简单好记的英文名字就行</li>
<li>description 则决定什么时候会触发这个 Skill，描述这个 Skills 是做什么的、遇到什么样的用户请求应该用它、提醒读者：描述越具体，越容易在正确场景被调用</li>
</ul>
<p>下面就是 Skill 的正文部分：</p>
<ul>
<li>目标：简单描述清楚这个 Skill 要做的事情</li>
<li>使用步骤：列出 Skill 的操作流程（先搞清楚想要什么风格、再读原文、再改写、最后规定输出格式）</li>
<li>注意事项：告诉模型「什么不要做」（不要乱加内容、不要替用户做决定、有歧义要提醒）</li>
</ul>
<hr/>
<p>看起来挺普通的？似乎很多能力都可以做这件事？</p>
<ul>
<li>可以把这段文字和要润色的文章直接发给大模型？</li>
<li>可以把这段文字放到系统提示词？</li>
<li>可以把这段固定的流程封装为一个 Workflow？</li>
<li>可以把这段文字编写为一个 Agent.md 或者项目级的 Rules？</li>
</ul>
<p>这些方式看似不同，但本质上只是把提示词放在了不同的位置，你给 AI 的每次对话都会带上这些提示词。</p>
<p>在真实的业务场景中，一个 Agent 不可能只干一件这么简单的事。大家试想一下，如果你要给 AI 装 50 个技能，每个技能都有几千字的说明书，要是系统一启动就把这些全塞进 AI 的脑子（Context Window）里，那么就会：</p>
<ul>
<li>成本爆炸，每次对话可能都会消耗几万 Token。</li>
<li>AI 的注意力也会被分散，变得“这也想干，那也想干”。</li>
</ul>
<p>Skill 的出现就是为了解决这种问题，它有一个非常核心的机制，叫渐进式披露（Progressive Disclosure）。说人话就是：按需加载，用多少拿多少。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a3edef71fbc44839ab60fae6780ac28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=7VqkVFiLdSWnv0tLQjlWjlOwjIs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">1.3 Skills 的核心机制</h3>
<p>这是我觉得 Agent Skills 设计得最聪明的地方。你可以把它想象成我们在图书馆查资料的三个步骤，非常直观：</p>
<p>第一层：先看目录（元数据 Metadata）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e08b156bd28438faa15a528d77c9f5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=GRZR1ZtZ0hQLOXfcOYDDA%2BGO5F4%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 系统刚启动的时候。</li>
<li>加载什么？ 只加载每个技能的名字和一段简短的描述。</li>
<li>有什么用？ 这一层占用的资源极少，可能就几百个 Token。它的作用就是告诉 Claude：“嘿，你的工具箱里有‘查周报’、‘处理 Excel’ 这几个工具哦。”</li>
<li>结果： Claude 知道自己 “会什么”，但还不知道 “具体怎么做”。</li>
</ul>
<hr/>
<p>第二层：翻开手册（指令 Instructions）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194d42e19c31488a9dbf9f937a752d8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=oQzJ8xml2gYEVbGNCc4ix0JB610%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 当你说 “帮我把这个 Excel 处理一下” 的时候。</li>
<li>加载什么？ Claude 发现这事儿归 “Excel 处理” 这个技能管，于是它才会通过后台命令，去读取那个文件夹里的 SKILL.md 文件。</li>
<li>有什么用？ 只有在这个时候，那些详细的操作步骤、注意事项才会进入 AI 的脑子。</li>
</ul>
<p>第三层：动手干活（运行时资源 Runtime Resources）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8ee8c38563644ca94b83c9df1fc98b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=Yc1SKtgWUcx7hDlNGzxwqXWKDEg%3D" alt="" loading="lazy"/></p>
<ul>
<li>什么时候加载？ 真正执行具体步骤的时候。加载什么？
<ul>
<li>参考（reference）： 用户下达的任务可能是分析 Excel，也可能是创建 Excel，这两个操作可能有完全不同的处理步骤，详细的步骤不一定都在 SKILL.md 中，可以分开放在不同的参考文献（reference）下，当 Claude 识别到你要做的是分析 Excel 时，才会去查阅分析 Excel 的 reference。</li>
<li>脚本（scripts）：Skill 中可以内置一些可执行的 Excel 处理脚本，在  SKILL.md 或者具体的参考文献（reference）下会告诉你应该调用以及如何调用这些脚本。还有最重要的一点，Claude 只需要按照指引执行脚本，而脚本本身的代码是不会塞给 AI 去读的，你完全不用担心一个超大代码文件会消耗 Token。</li>
</ul>
</li>
</ul>
<blockquote>
<p>这意味着：一个 Skill 可以打包整套说明文档、大量的执行脚本，但只要任务不需要，这些内容就永远不会占用上下文。</p>
</blockquote>
<h2 data-id="heading-4">二、Skills VS MCP</h2>
<p>看到这，你可能会觉得 Skills 和 MCP 有点像？</p>
<p>它们似乎都可以做到按需加载、给 AI 扩展外部能力？</p>
<p>这也是很多同学可能会弄混的问题。</p>
<h3 data-id="heading-5">2.1 MCP 有什么问题</h3>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyP6D_mnxwFsL3SbC4qZnYg%3Ftoken%3D1267907119%26lang%3Dzh_CN" target="_blank" title="https://mp.weixin.qq.com/s/yP6D_mnxwFsL3SbC4qZnYg?token=1267907119&amp;lang=zh_CN" ref="nofollow noopener noreferrer">全网最细，一文带你弄懂 MCP 的核心原理！</a> 中，我们介绍了 MCP 出现的意义和执行原理：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f61586c73d3c4011aaec7f33f3744867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=TApcRtcMBWw2R95mkxL7ZLsacf4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>MCP（Model Context Protocol，模型上下文协议）是由 Anthropic 公司推出的一个开放标准协议，它就像是一个 “通用插头” 或者 “USB 接口”，制定了统一的规范，不管是连接数据库、第三方 API，还是本地文件等各种外部资源，都可以通过这个 “通用接口” 来完成，让 AI 模型与外部工具或数据源之间的交互更加标准化、可复用。</p>
</blockquote>
<p>所以 MCP 的本质，还是在做 “标准化”，它让给 AI 扩展外部能力这件事更 “标准化”。</p>
<p>假如你的 Agent 连接了多个 MCP，它似乎也能实现 “按需加载”（根据用户的意图决定调用哪个工具）。</p>
<p>但这个 “按需加载” 背后的代价是非常巨大的，在 MCP 的架构下，仅仅是“连接”这个动作，就已经在透支你的额度了。</p>
<p>这是由 LLM 的工具调用机制决定的。为了让 AI 知道它有哪些能力可用，每一个连接的 MCP Server 必须在对话开始前，将其所有工具的完整定义（名称、详细描述、参数 Schema、使用示例）一次性注入 LLM 的上下文中。</p>
<p>每个 MCP Server 一般都会包含大量的工具，比如 Github MCP ，它自己就包含了 30 多个工具：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe45f4124831425894e7f07f23c1e1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=k14tPumkaPhlak0Kiv7r%2FDLJ1IY%3D" alt="" loading="lazy"/></p>
<p>假如每个工具消耗 500 个 Token，那只链接这一个工具就需要消耗将近 20000 Token。</p>
<p>在真实环境下，一个 Agent 不会仅链接一个 MCP Server。</p>
<p>假如你只问了 AI 一个非常简单的问题（1+1=？），Agent 已经烧掉了大几万的 Token，这个成本是非常恐怖的。</p>
<p>更深层的问题在于链接过多的 MCP Server 可能导致 LLM 的 “注意力” 下降，从而降低工具调用的准确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6021a9e48a94ec782b79782618085bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=ryfkjkCQ5A3pCJddBwCSJlkJ96U%3D" alt="" loading="lazy"/></p>
<p>我在之前的文章中有讲过一个专门测试 MCP Server 调用准确度的基准：MCP Atlas（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FkQIcb6gggF5wf08qjuJcyQ%3Ftoken%3D1267907119%26lang%3Dzh_CN" target="_blank" title="https://mp.weixin.qq.com/s/kQIcb6gggF5wf08qjuJcyQ?token=1267907119&amp;lang=zh_CN" ref="nofollow noopener noreferrer">世界最顶级的大模型，都在 PK 些啥？ （大模型评估完全指南）</a>），在这个基准中包含了 40 多个不同服务器、300 多个工具的复杂环境。</p>
<p>模型必须自己发现合适的工具、正确调用，并把多步结果汇总成最终答案。目前最强的 Claude Opus 4.5 也只能拿到 62% 的准确率，这个值还会随着工具的增多而进一步下降。</p>
<p>而我们上面讲到的 Skills 的核心机制：渐进式披露 ，恰好可以解决这两个问题：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0efd5e659a84e1c9567f5d68821fd1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=q6y5ig6pl%2BvXV0gtIVHyjA4x7Fw%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>节省 Token：首次链接时，相比 MCP 需要将 40 多个 MCP Server 下 300 个工具全部塞进模型上下文（消耗数万 Token），模型只需要加载 40 个 Skills 的元数据（几千 Token）。</p>
</li>
<li>
<p>提升注意力： 面对几百个工具，AI 很容易分心。Skills 采用的是“漏斗式”引导：先通过目录判断大方向，确认要干活了，再加载具体的说明，最后通过说明找到详细的文档和脚本最后再执行。让 AI 每次只专注于当前任务。即使是能力稍弱的模型，在这种机制下也能保持极高的调用准确率。</p>
</li>
</ul>
<h3 data-id="heading-6">2.2 MCP 会被淘汰吗？</h3>
<p>看到这你可能会问了，Skills 看起来更智能、更节省资源，那 MCP 会被淘汰吗？</p>
<blockquote>
<p>结论是：MCP 不会被完全淘汰，但对它的需求会大幅减少！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b60e1a4520a4a25bf576029b34db8bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=rB6WRaBkl2FAII0NxN8EBF9fqXE%3D" alt="" loading="lazy"/></p>
<p>首先，MCP 协议层的价值不可替代： MCP 的真正价值不在于它如何把文本塞进 Prompt，而在于它制定了一套标准接口。</p>
<p>它统一了 AI 连接世界的方式。如果你是一个通用的三方平台（高德地图、Notion 等），想发布一个工具让其他 Agent 都能用上你的能力，那首先选择的还是 MCP。</p>
<p>但是，如果你有一些重复性的工作流，比如要以固定的流程读写本地文件、要用一个标准的范式来 Review 代码、有一套固定的风格来编写文章，这些场景都推荐使用 Skill 来实现。</p>
<p>在过去这几个需求中的本地文件读写、链接 Github、给文章生成图片这些需要链接外部世界的能力都得通过 MCP 去实现，但现在你可以都把它们打包到 Skill 里。</p>
<p>未来的格局可能是这样的（来自宝玉老师）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b4c2ab83df4aa7acc86c6c698f6564~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=kAIHjl9bX3C4JEiWFD3sdICD%2BeQ%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>Agent 本身内置部分核心能力（bash、read、edit、write）</p>
</li>
<li>
<p>少数通用 MCP Server 负责远程连接（数据库、云 API、SaaS 集成）</p>
</li>
<li>
<p>大量 Skills 负责封装标准工作流、连接本地知识库</p>
</li>
<li>
<p>两者在必要时协作，但 Skills 会承担绝大部分 “教 AI 怎么做事” 的工作（这其中也包含教 AI 怎么用 McpServer、怎么用其他 Skills、怎么更好的调用核心能力）</p>
</li>
</ul>
<h2 data-id="heading-7">三、Skills 的初步尝试</h2>
<h3 data-id="heading-8">3.1 去哪找 Skills？</h3>
<p>和 MCP 一样，Skills 成了开放标准后开始爆发式增长，社区出现了大量的开源 Skills，很多 Skills 开放市场也应运而生，之前大部分 MCP Market 也都增加了 Skills 的分类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6f9e0d0fa634d93b0ed13cc7437bee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=j63UkXDBLUcAFd2tS4B1S9WY9vM%3D" alt="https://skillsmp.com/" loading="lazy"/></p>
<p>我们可以看到 skillsmp 中的 Skills 数量在最近经历着爆发式增长，这个增长速度要比之前的 MCP 爆火的时候还要快。这就不得不提 Skills 的另一大优点：编写门槛低！</p>
<p>MCP 虽然有一套标准的规范，但终究还是要靠代码编写的，即便有了 AI 辅助，对于小白来讲还是有一定的门槛的。</p>
<p>而 Skills 就不一样了，只要你会写提示词，就能写 Skill，可以预见的是，之前那些大量的固定工作流在未来可能都会被编写为 Skill，这也意味着 Agent 的编写门槛被再一次大幅降低了！</p>
<h3 data-id="heading-9">3.2 怎么使用 Skills？</h3>
<p>我们随便进入一个 MCP 市场，然后搜索我们要使用的 Skills，比如这里我们还以绘图软件 Excalidraw 为例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381b6b22dbce4bd0b0985d4d9790fbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=yrEldzKmOu%2BOWltsHtKjF%2FV3bu4%3D" alt="" loading="lazy"/></p>
<p>可以看到社区已经有大量 Excalidraw 的 Skill 了，我们这里选择 Star 最多的一款：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a71b7f5d7c9d41118bafc6753b5eae53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=BABGXdm3reRs0QDNVFG6AsVCxek%3D" alt="" loading="lazy"/></p>
<p>进入详情后，我们选择一个最简单的安装方式，直接把这个 Skill 下载到本地，点击 wget skill.zip：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eea9076dce84a829c4190159a1fb4a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=oWOx%2BNLsEGh68ks4bfwOM9fGBz4%3D" alt="" loading="lazy"/></p>
<p>然后我们把这个压缩包解压，你就会看到熟悉的目录。接下来，你只需要把这个目录下载到指定的位置：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560d95454fa7433cbeed63806a92cd52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=lI5OU%2BLKvcePSj6ODY7C%2F%2BNvIa0%3D" alt="" loading="lazy"/></p>
<p>不同客户端的目录大同小异，基本上都是  .agentName/skills 目录，这里我们使用最近比较火的 OpenCode 进行演示（大家看可以自行选择 Cusor、Codex 等支持 skills 的客户端），所以我们创建一个新的文件夹，然后把刚刚下载的文件夹放到 .opencode/skills 目录下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e906cc5be0543fcbb04dfa38a2c5d13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=fNvojl%2BAffOXEYYzGgdF84DbfDE%3D" alt="" loading="lazy"/></p>
<p>接下来，我们在这个目录下打开 opencode 客户端，输入下面的提示词：</p>
<blockquote>
<p>帮我绘制一个架构图，讲解什么是 5W2H 分析法，直接帮我在当前目录下生成一个 excalidraw 文件。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac281475695a44f9afc1c4ab80c42ead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=Ti%2FwNax1uHB0Hn71z268MrDEYh0%3D" alt="" loading="lazy"/></p>
<p>你不需要手动去 “安装” 或 “运行” Skill，只要文件放对位置了，OpenCode 的 AI 就会自动根据用户的需求判断要调用这个 Skill，然后帮我生成了代码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e64c284bb1cd487facff3a48ad791100~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=XFrSu3szoiZ2fOV6nTfGd8e5Daw%3D" alt="" loading="lazy"/></p>
<p>我们将生成的代码粘贴到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexcalidraw.com%2F%25EF%25BC%258C%25E5%25B0%25B1%25E5%258F%25AF%25E4%25BB%25A5%25E7%259C%258B%25E5%2588%25B0%25E5%25B7%25B2%25E7%25BB%258F%25E7%2594%259F%25E6%2588%2590%25E5%25A5%25BD%25E7%259A%2584%25E6%259E%25B6%25E6%259E%2584%25E5%259B%25BE%25EF%25BC%259A" target="_blank" title="https://excalidraw.com/%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%B7%B2%E7%BB%8F%E7%94%9F%E6%88%90%E5%A5%BD%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE%EF%BC%9A" ref="nofollow noopener noreferrer">excalidraw.com/，就可以看到已经生成好…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f1a3a2134074c44b8af3a750724df63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=QQ0iZ2oHlIqNNMhP%2FmX07tfpjv8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.3 创建你的第一个 Skill</h3>
<p>下面，我们一起来尝试做第一个 Skill，虽然 Skill 的开发门槛低，但这不意味着我们就要自己写！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52327788e2c48978b4eb4479a793131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=42sJ5XeD8Dt95sOrZeVnpz0ZLhA%3D" alt="" loading="lazy"/></p>
<p>Anthropic 官方直接给我们提供了一个 生产 Skills 的 Skill：Skill Creator。你不需要写一行代码或配置文件，只需要用自然语言告诉它你想做什么，它就会自动为你生成一个符合标准的 Skill 包。</p>
<p>接下来，按照刚才的流程，我们把这个 Skill 下载下来，放到 .opencode/skills 目录下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb224af2da5044e3b13892932bfbd5a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=4bvQ3I0ylcGrAdqoclUY8rc9vfQ%3D" alt="" loading="lazy"/></p>
<p>然后我们给出下面的提示词：</p>
<blockquote>
<p>帮我创建一个可以准确获取当前系统时间的 Skill，描述使用中文，脚本使用 Node.js。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1438eb4a744798af212af05b1570b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=faeXrM6LUqYCZ05ApFO0Vrhh%2BTw%3D" alt="" loading="lazy"/></p>
<p>然后，opencode 识别到我们的需求，开始调用 skill-creator：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c848b3ecaf1e4d408db8483feb7b6bd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=8S1q5TjcJi8LH1orzV7vxel9GrM%3D" alt="" loading="lazy"/></p>
<p>然后我们打开本地的 .opencode/skills  目录，发现多了一个 current-time-node skill，包含一个 SKILL.md 加一个获取准确时间的 Node.js 脚本：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce1633c10d444cdbb95d845c03d6263c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=B4w67RLm7sz9O6jpczRxJ%2FlBK%2Fg%3D" alt="" loading="lazy"/></p>
<p>接下来，我们询问 opencode：“获取当前系统时间”，然后它就会自动找到刚刚生成的 Skill 并调用里面的脚本：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c37a692f34e243e9b3bff1ecd04248db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770217024&amp;x-signature=ZiBUairT8WmZeid2loH%2FVV0%2BG8k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">最后</h2>
<p>本期教程我们就先讲到这。</p>
<p>大家已经了解了 Agent Skill 的基本原理，以及如何使用和创建一个 Skill。</p>
<p>如果本期教程对你有所帮助，希望得到一个免费的三连和关注。</p>
<p>下一期，我们会进入实战章节，一期来使用 Agent Skill 实现一个知识库检索的功能，相比传统的 RAG ，它的效果究竟怎么样呢，我们下期见。</p>
<p>关注《code秘密花园》从此学习 AI 不迷路，相关链接：</p>
<ul>
<li>AI 教程完整汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Frncg5jvpme.feishu.cn%2Fwiki%2FU9rYwRHQoil6vBkitY8cbh5tnL9" target="_blank" title="https://rncg5jvpme.feishu.cn/wiki/U9rYwRHQoil6vBkitY8cbh5tnL9" ref="nofollow noopener noreferrer">rncg5jvpme.feishu.cn/wiki/U9rYwR…</a></li>
<li>相关学习资源汇总在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-learn-ai" target="_blank" title="https://github.com/ConardLi/easy-learn-ai" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
<li>本期视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1GXzaByEEo%2F" target="_blank" title="https://www.bilibili.com/video/BV1GXzaByEEo/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1GX…</a></li>
</ul>
<p>如果本期对你有所帮助，希望得到一个免费的三连，感谢大家支持！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native新架构之iOS端初始化源码分析]]></title>    <link>https://juejin.cn/post/7600223321041879046</link>    <guid>https://juejin.cn/post/7600223321041879046</guid>    <pubDate>2026-01-28T13:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041879046" data-draft-id="7594000527509274665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native新架构之iOS端初始化源码分析"/> <meta itemprop="keywords" content="React Native,iOS,源码阅读"/> <meta itemprop="datePublished" content="2026-01-28T13:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程之路从0到1"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359744296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native新架构之iOS端初始化源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359744296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程之路从0到1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:41:51.000Z" title="Wed Jan 28 2026 13:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native新架构之iOS端初始化源码分析</h2>
<h3 data-id="heading-1">前言</h3>
<p>注意，本文是基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Ftree%2Fv0.83.0" target="_blank" title="https://github.com/facebook/react-native/tree/v0.83.0" ref="nofollow noopener noreferrer">React Native</a> 0.83版本源码进行分析。有了前面几篇Android端分析文章打基础，再来理解iOS端就易如反掌了。总的来说，iOS端的实现要比Android端简单太多了，这是因为Android端的Java/Kotlin 都是运行在Java的虚拟机环境中，其与C++通信要经过JNI，并不如OC与C++互调那么简单直接。此外，RN基于Android的Gradle构建机制，也使问题更加复杂。</p>
<h3 data-id="heading-2">初始化流程</h3>
<p>React Native的iOS端相比于安卓端要简单很多。现在我们基于Swift入口来分析一下初始化流程。首先找到RN源码工程中的测试工程，打开源码<code>react-native/private/helloworld/ios/HelloWorld/AppDelegate.swift</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> React                          <span class="hljs-comment">// React Native 核心模块</span>
<span class="hljs-keyword">import</span> ReactAppDependencyProvider     <span class="hljs-comment">// Codegen 生成的依赖提供者</span>
<span class="hljs-keyword">import</span> React_RCTAppDelegate           <span class="hljs-comment">// AppDelegate 相关类</span>
<span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {
  <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?

  <span class="hljs-keyword">var</span> reactNativeDelegate: <span class="hljs-type">ReactNativeDelegate</span>?
  <span class="hljs-keyword">var</span> reactNativeFactory: <span class="hljs-type">RCTReactNativeFactory</span>?

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
    <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
    <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
  ) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-comment">// 1: 创建 ReactNativeDelegate</span>
    <span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">ReactNativeDelegate</span>()
    <span class="hljs-comment">// 2: 创建 RCTReactNativeFactory</span>
    <span class="hljs-keyword">let</span> factory <span class="hljs-operator">=</span> <span class="hljs-type">RCTReactNativeFactory</span>(delegate: delegate)
    <span class="hljs-comment">// 3: 配置依赖提供者（Codegen 生成的模块）</span>
    delegate.dependencyProvider <span class="hljs-operator">=</span> <span class="hljs-type">RCTAppDependencyProvider</span>()

    <span class="hljs-comment">// 保持强引用</span>
    reactNativeDelegate <span class="hljs-operator">=</span> delegate
    reactNativeFactory <span class="hljs-operator">=</span> factory

    <span class="hljs-comment">// 4: 配置开发菜单（仅 DEBUG 模式）</span>
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-keyword">let</span> devMenuConfiguration <span class="hljs-operator">=</span> <span class="hljs-type">RCTDevMenuConfiguration</span>(
      devMenuEnabled: <span class="hljs-literal">true</span>,
      shakeGestureEnabled: <span class="hljs-literal">true</span>,
      keyboardShortcutsEnabled: <span class="hljs-literal">true</span>
    )
    reactNativeFactory<span class="hljs-operator">?</span>.devMenuConfiguration <span class="hljs-operator">=</span> devMenuConfiguration
    <span class="hljs-keyword">#endif</span>

    <span class="hljs-comment">// 5: 创建主窗口</span>
    window <span class="hljs-operator">=</span> <span class="hljs-type">UIWindow</span>(frame: <span class="hljs-type">UIScreen</span>.main.bounds)

    <span class="hljs-comment">// 6: 启动 React Native</span>
    factory.startReactNative(
      withModuleName: <span class="hljs-string">"HelloWorld"</span>,
      in: window,
      launchOptions: launchOptions
    )

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactNativeDelegate</span>: <span class="hljs-title class_">RCTDefaultReactNativeFactoryDelegate</span> {
  <span class="hljs-comment">// 旧架构兼容（新架构中会调用 bundleURL）</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">sourceURL</span>(<span class="hljs-params">for</span> <span class="hljs-params">bridge</span>: <span class="hljs-type">RCTBridge</span>) -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">self</span>.bundleURL()
  }

  <span class="hljs-comment">// 提供 JS Bundle 的 URL</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">bundleURL</span>() -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-comment">// 开发模式：从 Metro 开发服务器加载</span>
    <span class="hljs-type">RCTBundleURLProvider</span>.sharedSettings().jsBundleURL(forBundleRoot: <span class="hljs-string">"index"</span>)
    <span class="hljs-keyword">#else</span>
    <span class="hljs-comment">// 生产模式：从 App Bundle 加载</span>
    <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"main"</span>, withExtension: <span class="hljs-string">"jsbundle"</span>)
    <span class="hljs-keyword">#endif</span>
  }
}
</code></pre>
<p>Swift 新架构使用 <code>@main</code> 注解作为应用入口，无需 <code>main.m</code> 或 <code>main.swift</code> 文件。<code>ReactNativeDelegate</code> 继承自 <code>RCTDefaultReactNativeFactoryDelegate</code>，负责提供 Bundle URL 和自定义配置。</p>
<p>这里<code>RCTAppDependencyProvider</code>是Objective-C++代码，这是为了方便与C++互调。源码<code>tcode/react-native/packages/react-native/Libraries/AppDelegate/RCTReactNativeFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RCTReactNativeFactory</span> () &lt;</span>
    RCTComponentViewFactoryComponentProvider, <span class="hljs-comment">// Fabric 组件提供者</span>
    RCTHostDelegate,                          <span class="hljs-comment">// RCTHost 代理</span>
    RCTJSRuntimeConfiguratorProtocol,         <span class="hljs-comment">// JS Runtime 配置</span>
    RCTTurboModuleManagerDelegate&gt;            <span class="hljs-comment">// TurboModule 管理器代理</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTReactNativeFactory</span></span>

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithDelegate:delegate releaseLevel:Stable];
}

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate releaseLevel:(RCTReleaseLevel)releaseLevel
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-keyword">self</span>.delegate = delegate;
    [<span class="hljs-keyword">self</span> _setUpFeatureFlags:releaseLevel];
    <span class="hljs-comment">// 设置默认颜色空间</span>
    [RCTColorSpaceUtils applyDefaultColorSpace:[<span class="hljs-keyword">self</span> defaultColorSpace]];
    RCTEnableTurboModule(<span class="hljs-literal">YES</span>);

    <span class="hljs-comment">// 创建 RCTRootViewFactory</span>
    <span class="hljs-keyword">self</span>.rootViewFactory = [<span class="hljs-keyword">self</span> createRCTRootViewFactory];
    <span class="hljs-comment">// 设置第三方 Fabric 组件提供者</span>
    [RCTComponentViewFactory currentComponentViewFactory].thirdPartyFabricComponentsProvider = <span class="hljs-keyword">self</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>可以看到RCTReactNativeFactory的构造逻辑非常简单，但它实现了四个关键协议，这使得它可以作为多个子系统的代理。</p>
<p>先重点看一下<code>createRCTRootViewFactory</code>方法的实现，这是一个关键方法，同时设置了大量的回调 Block 来桥接代理模式：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTRootViewFactory *)createRCTRootViewFactory
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 1. 创建 Bundle URL 提供者 Block</span>
  RCTBundleURLBlock bundleUrlBlock = ^{
    auto *strongSelf = weakSelf;
    <span class="hljs-keyword">return</span> strongSelf.bundleURL;
  };

  <span class="hljs-comment">// 2. 创建配置对象（新架构默认全部启用）</span>
  RCTRootViewFactoryConfiguration *configuration =
      [[RCTRootViewFactoryConfiguration alloc] initWithBundleURLBlock:bundleUrlBlock
                                                       newArchEnabled:<span class="hljs-literal">YES</span>
                                                   turboModuleEnabled:<span class="hljs-literal">YES</span>
                                                    bridgelessEnabled:<span class="hljs-literal">YES</span>];

  <span class="hljs-comment">// 省略旧架构代码......</span>

  <span class="hljs-comment">// 3.配置根视图自定义回调</span>
  configuration.customizeRootView = ^(<span class="hljs-built_in">UIView</span> *_Nonnull rootView) {
    [weakSelf.delegate customizeRootView:(RCTRootView *)rootView];
  };

  <span class="hljs-comment">// 4.配置 Bundle URL 获取回调</span>
  configuration.sourceURLForBridge = ^<span class="hljs-built_in">NSURL</span> *_Nullable(RCTBridge *_Nonnull bridge)
  {
    <span class="hljs-comment">// 新架构：直接使用 bundleURL，不再依赖 bridge</span>
    <span class="hljs-keyword">return</span> [weakSelf.delegate bundleURL];
  };

  <span class="hljs-comment">// 5.配置 Bundle 加载回调（支持进度）</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:onProgress:onComplete:)]) {
    configuration.loadSourceForBridgeWithProgress =
        ^(RCTBridge *_Nonnull bridge,
          RCTSourceLoadProgressBlock _Nonnull onProgress,
          RCTSourceLoadBlock _Nonnull loadCallback) {
          <span class="hljs-comment">// 新架构：使用 loadBundleAtURL 替代旧的 loadSourceForBridge</span>
          [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL onProgress:onProgress onComplete:loadCallback];
        };
  }

  <span class="hljs-comment">// 6.配置无进度的 Bundle 加载回调</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:withBlock:)]) {
    configuration.loadSourceForBridge = ^(RCTBridge *_Nonnull bridge, RCTSourceLoadBlock _Nonnull loadCallback) {
      <span class="hljs-comment">// 新架构：使用 loadBundleAtURL，进度回调为空</span>
      [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL
                              onProgress:^(RCTLoadingProgress *progressData) {
                              }
                              onComplete:loadCallback];
    };
  }

  <span class="hljs-comment">// 7.设置 JS Runtime 代理</span>
  configuration.jsRuntimeConfiguratorDelegate = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 8.创建并返回 RCTRootViewFactory</span>
  <span class="hljs-keyword">return</span> [[RCTRootViewFactory alloc] initWithTurboModuleDelegate:<span class="hljs-keyword">self</span> hostDelegate:<span class="hljs-keyword">self</span> configuration:configuration];
}
</code></pre>
<p>这里的大概流程是非常清楚的，主要就是设置了四个协议的代理。我们将流程绘制成一个关系图：</p>
<pre><code class="hljs language-lua" lang="lua">┌─────────────────────────────────────────────────────────────────────────┐
│                        RCTReactNativeFactory                             │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 实现协议:                                                          │  │
│  │  • RCTTurboModuleManagerDelegate    → TurboModule 类/实例查找      │  │
│  │  • RCTHostDelegate                  → Host 生命周期 + Bundle 加载  │  │
│  │  • RCTJSRuntimeConfiguratorProtocol → JS Runtime 工厂创建         │  │
│  │  • RCTComponentViewFactoryComponentProvider → Fabric 组件注册     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ createRCTRootViewFactory() 中设置:                                 │  │
│  │  • initWithTurboModuleDelegate: <span class="hljs-built_in">self</span>  ← RCTTurboModuleManagerDelegate│
│  │  • hostDelegate: <span class="hljs-built_in">self</span>                 ← RCTHostDelegate              │
│  │  • jsRuntimeConfiguratorDelegate: <span class="hljs-built_in">self</span> ← RCTJSRuntimeConfiguratorProtocol│
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 初始化时设置:                                                       │  │
│  │  • thirdPartyFabricComponentsProvider = <span class="hljs-built_in">self</span>                       │  │
│  │    ← RCTComponentViewFactoryComponentProvider                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">RCTTurboModuleManagerDelegate</h4>
<p>主要负责 TurboModule 的类查找和实例创建，源码<code>react-native/packages/react-native/ReactCommon/react/nativemodule/core/platform/ios/ReactCommon/RCTTurboModuleManager.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTBridgeProxy</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTTurboModuleManager</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfigurationDecorator</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 给定模块名称，返回其实际类。如果返回 nil，则执行基本的 ObjC 类查找
 */</span>
- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 给定一个模块类，为其提供一个实例。如果返回值为 nil，则使用默认初始化器
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass;

<span class="hljs-keyword">@optional</span>

<span class="hljs-comment">/**
 * 此方法用于获取一个工厂对象，该对象可以创建 `facebook::react::TurboModule` 实例。
 * 实现 `RCTTurboModuleProvider` 接口的类必须是 Objective-C 类，以便我们可以使用代码生成工具对其进行动态初始化。
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 创建一个 TurboModule 实例，而无需依赖任何 ObjC++ 模块实例
 */</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:
                                                          (std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker;

- (<span class="hljs-type">void</span>)installJSBindings:(facebook::jsi::Runtime &amp;)runtime;

- (<span class="hljs-type">void</span>)invalidate;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>再来看看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTTurboModuleManagerDelegate</span>

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleClassFromName:)]) {
    Class moduleClass = [_delegate getModuleClassFromName:name];
    <span class="hljs-keyword">if</span> (moduleClass != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleClass;
    }
  }
  <span class="hljs-keyword">return</span> RCTCoreModulesClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleProvider:)]) {
    <span class="hljs-keyword">return</span> [_delegate getModuleProvider:name];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

<span class="hljs-comment">// 创建纯 C++ TurboModule</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getTurboModule:jsInvoker:)]) {
    <span class="hljs-keyword">return</span> [_delegate getTurboModule:name jsInvoker:jsInvoker];
  }

  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_OSS_CODEGEN</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.delegate.dependencyProvider == <span class="hljs-literal">nil</span>) {
    [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"ReactNativeFactoryDelegate dependencyProvider is nil"</span>
                format:<span class="hljs-string">@"Delegate must provide a valid dependencyProvider"</span>];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleInstanceFromClass:)]) {
    <span class="hljs-type">id</span>&lt;RCTTurboModule&gt; moduleInstance = [_delegate getModuleInstanceFromClass:moduleClass];
    <span class="hljs-keyword">if</span> (moduleInstance != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleInstance;
    }
  }
  <span class="hljs-comment">// 使用默认方式创建（通过 dependencyProvider）</span>
  <span class="hljs-keyword">return</span> RCTAppSetupDefaultModuleFromClass(moduleClass, <span class="hljs-keyword">self</span>.delegate.dependencyProvider);
}
</code></pre>
<h4 data-id="heading-4">RCTHostDelegate</h4>
<p>主要负责 RCTHost 的生命周期和 Bundle 加载。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTFabricSurface</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTHost</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTModuleRegistry</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfiguration</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span>;</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NSURL</span> *_Nullable (^RCTHostBundleURLProvider)(<span class="hljs-type">void</span>);

<span class="hljs-comment">// Runtime API</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTHostDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>
<span class="hljs-comment">// Host 启动完成通知</span>
- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host;

<span class="hljs-keyword">@optional</span>
<span class="hljs-comment">// 需要在主线程初始化的模块列表</span>
- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup;

<span class="hljs-comment">// 加载 Bundle（支持进度回调）</span>
- (<span class="hljs-type">void</span>)loadBundleAtURL:(<span class="hljs-built_in">NSURL</span> *)sourceURL
             onProgress:(RCTSourceLoadProgressBlock)onProgress
             onComplete:(RCTSourceLoadBlock)loadCallback;

<span class="hljs-keyword">@end</span>


<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTHostDelegate</span>

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(hostDidStart:)]) {
    [_delegate hostDidStart:host];
  }
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginUnstableModulesRequiringMainQueueSetup();
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.delegate.dependencyProvider)
      : @[];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<h4 data-id="heading-5">RCTJSRuntimeConfiguratorProtocol</h4>
<p>主要负责创建 JS Runtime 工厂，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTJSRuntimeConfiguratorProtocol.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-comment">// Forward declarations for umbrella headers.</span>
<span class="hljs-comment">// In implementations, import `&lt;react/runtime/JSRuntimeFactoryCAPI.h&gt;` to obtain the actual type.</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *JSRuntimeFactoryRef;

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTJSRuntimeConfiguratorProtocol</span></span>

<span class="hljs-comment">// 创建 JS Runtime 工厂（通常返回 Hermes）</span>
- (JSRuntimeFactoryRef)createJSRuntimeFactory;

<span class="hljs-keyword">@end</span>

<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTJSRuntimeConfiguratorProtocol</span>

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
  <span class="hljs-comment">// 委托给用户的 delegate</span>
  <span class="hljs-keyword">return</span> [_delegate createJSRuntimeFactory];
}
</code></pre>
<h4 data-id="heading-6">RCTComponentViewFactoryComponentProvider</h4>
<p>主要负责提供第三方 Fabric 组件，源码<code>react-native/packages/react-native/React/Fabric/Mounting/RCTComponentViewFactory.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">/**
 * 可用于向 Fabric 提供第三方组件的协议。
 * Fabric 将检查此映射表，以确定是否存在需要注册的组件。
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTComponentViewFactoryComponentProvider</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 返回一个第三方组件字典，其中 `key` 是组件处理程序，`value` 是一个符合 `RCTComponentViewProtocol` 协议的类
 */</span>
- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTComponentViewFactoryComponentProvider</span>

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(thirdPartyFabricComponents)]) {
    <span class="hljs-keyword">return</span> _delegate.thirdPartyFabricComponents;
  }
  <span class="hljs-comment">// 回退到 dependencyProvider（Codegen 生成）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider ? <span class="hljs-keyword">self</span>.delegate.dependencyProvider.thirdPartyFabricComponents : @{};
}
</code></pre>
<h4 data-id="heading-7">RCTDefaultReactNativeFactoryDelegate</h4>
<p>以上协的很多方法的实现，其实也是代理给<strong>RCTReactNativeFactory</strong> 中的<code>delegate</code>对象。此<code>delegate</code>也就是我们最开始自定义的<code>ReactNativeDelegate</code>实例。其也是继承自<code>RCTDefaultReactNativeFactoryDelegate</code>，现在分析一下此类的实现，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTDefaultReactNativeFactoryDelegate.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTDefaultReactNativeFactoryDelegate</span></span>

<span class="hljs-keyword">@synthesize</span> dependencyProvider;
<span class="hljs-comment">// 抽象方法：子类必须实现</span>
- (<span class="hljs-built_in">NSURL</span> *_Nullable)sourceURLForBridge:(<span class="hljs-keyword">nonnull</span> RCTBridge *)bridge
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTBridgeDelegate::sourceURLForBridge not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid sourceURLForBridge method"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

- (<span class="hljs-built_in">UIViewController</span> *)createRootViewController
{
  <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIViewController</span> new];
}

- (<span class="hljs-type">void</span>)setRootView:(<span class="hljs-built_in">UIView</span> *)rootView toRootViewController:(<span class="hljs-built_in">UIViewController</span> *)rootViewController
{
  rootViewController.view = rootView;
}

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_THIRD_PARTY_JSC != 1</span>
  <span class="hljs-keyword">return</span> jsrt_create_hermes_factory();
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-type">void</span>)customizeRootView:(RCTRootView *)rootView
{
  <span class="hljs-comment">// Override point for customization after application launch.</span>
}

- (RCTColorSpace)defaultColorSpace
{
  <span class="hljs-keyword">return</span> RCTColorSpaceSRGB;
}

- (<span class="hljs-built_in">NSURL</span> *_Nullable)bundleURL
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTAppDelegate::bundleURL not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid getBundleURL method"</span>];
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.thirdPartyFabricComponents : @{};
}

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr)
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.dependencyProvider)
      : @[];
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-built_in">NSString</span> *providerName = [<span class="hljs-built_in">NSString</span> stringWithCString:name encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.moduleProviders[providerName] : nullptr;
}

- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTArchConfiguratorProtocol</span>

- (<span class="hljs-type">BOOL</span>)newArchEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)bridgelessEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)fabricEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)turboModuleEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">void</span>)loadSourceForBridge:(RCTBridge *)bridge
                 onProgress:(RCTSourceLoadProgressBlock)onProgress
                 onComplete:(RCTSourceLoadBlock)loadCallback
{
  [RCTJavaScriptLoader loadBundleAtURL:[<span class="hljs-keyword">self</span> sourceURLForBridge:bridge] onProgress:onProgress onComplete:loadCallback];
}

<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-8">React Native 启动</h4>
<p>对于以上四个协议以及代理，我们已经有了大概认识，现在应该把视线拉回<strong>AppDelegate</strong>中的初始化流程，继续分析<code>startReactNative</code>方法的实现，它对应的OC方法名应该是<code>startReactNativeWithModuleName</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  [<span class="hljs-keyword">self</span> startReactNativeWithModuleName:moduleName inWindow:window initialProperties:<span class="hljs-literal">nil</span> launchOptions:launchOptions];
}

- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                     initialProperties:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)initialProperties
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  <span class="hljs-comment">// 1. 通过 RootViewFactory 创建根视图</span>
  <span class="hljs-built_in">UIView</span> *rootView = [<span class="hljs-keyword">self</span>.rootViewFactory viewWithModuleName:moduleName
                                            initialProperties:initialProperties
                                                launchOptions:launchOptions
                                         devMenuConfiguration:<span class="hljs-keyword">self</span>.devMenuConfiguration];
  <span class="hljs-comment">// 2. 创建 RootViewController</span>
  <span class="hljs-built_in">UIViewController</span> *rootViewController = [_delegate createRootViewController];
  <span class="hljs-comment">// 3. 设置根视图</span>
  [_delegate setRootView:rootView toRootViewController:rootViewController];
  <span class="hljs-comment">// 4. 配置窗口并显示</span>
  window.rootViewController = rootViewController;
  [window makeKeyAndVisible];
}
</code></pre>
<p>可以看到，流程十分清楚，我们继续跟踪<code>viewWithModuleName</code>方法实现。</p>
<h5 data-id="heading-9">RCTHost  (ReactHost)初始化</h5>
<p>查看源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTRootViewFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-built_in">UIView</span> *)viewWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
             initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)initProps
                 launchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
          devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// 1. 初始化 ReactHost</span>
  [<span class="hljs-keyword">self</span> initializeReactHostWithLaunchOptions:launchOptions devMenuConfiguration:devMenuConfiguration];

  <span class="hljs-comment">// 2. 创建 Fabric Surface</span>
  RCTFabricSurface *surface = [<span class="hljs-keyword">self</span>.reactHost createSurfaceWithModuleName:moduleName
                                                        initialProperties:initProps ? initProps : @{}];
   <span class="hljs-comment">// 3. 创建 SurfaceHostingProxyRootView</span>
  RCTSurfaceHostingProxyRootView *surfaceHostingProxyRootView =
      [[RCTSurfaceHostingProxyRootView alloc] initWithSurface:surface];

  surfaceHostingProxyRootView.backgroundColor = [<span class="hljs-built_in">UIColor</span> systemBackgroundColor];
  <span class="hljs-keyword">if</span> (_configuration.customizeRootView != <span class="hljs-literal">nil</span>) {
    <span class="hljs-comment">// 4. 自定义根视图</span>
    _configuration.customizeRootView(surfaceHostingProxyRootView);
  }
  <span class="hljs-keyword">return</span> surfaceHostingProxyRootView;
}


- (<span class="hljs-type">void</span>)initializeReactHostWithLaunchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
                        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// Enable TurboModule interop by default in Bridgeless mode</span>
  RCTEnableTurboModuleInterop(<span class="hljs-literal">YES</span>);
  RCTEnableTurboModuleInteropBridgeProxy(<span class="hljs-literal">YES</span>);

  [<span class="hljs-keyword">self</span> createReactHostIfNeeded:launchOptions devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-keyword">return</span>;
}

- (<span class="hljs-type">void</span>)createReactHostIfNeeded:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
           devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.reactHost) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">self</span>.reactHost = [<span class="hljs-keyword">self</span> createReactHost:launchOptions devMenuConfiguration:devMenuConfiguration];
}


- (RCTHost *)createReactHost:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  RCTHost *reactHost =
      [[RCTHost alloc] initWithBundleURLProvider:<span class="hljs-keyword">self</span>-&gt;_configuration.bundleURLBlock
                                    hostDelegate:_hostDelegate
                      turboModuleManagerDelegate:_turboModuleManagerDelegate
                                jsEngineProvider:^std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;() {
                                  <span class="hljs-keyword">return</span> [weakSelf createJSRuntimeFactory];
                                }
                                   launchOptions:launchOptions
                            devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-comment">// 设置 Bundle URL 提供者</span>
  [reactHost setBundleURLProvider:^<span class="hljs-built_in">NSURL</span> *() {
    <span class="hljs-keyword">return</span> [weakSelf bundleURL];
  }];
  <span class="hljs-comment">// 启动 ReactHost</span>
  [reactHost start];
  <span class="hljs-keyword">return</span> reactHost;
}
</code></pre>
<h5 data-id="heading-10">RCTInstance 初始化</h5>
<p>继续跟踪<code>RCTHost</code>的<code>start</code>方法。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)start
{
  <span class="hljs-comment">// 1. 设置 Bundle URL</span>
  <span class="hljs-keyword">if</span> (_bundleURLProvider) {
    [<span class="hljs-keyword">self</span> _setBundleURL:_bundleURLProvider()];
  }

  <span class="hljs-comment">// 2. 设置 Inspector Target（用于调试）</span>
  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();
  <span class="hljs-keyword">if</span> (inspectorFlags.getFuseboxEnabled() &amp;&amp; !_inspectorPageId.has_value()) {
    _inspectorTarget =
        facebook::react::jsinspector_modern::HostTarget::create(*_inspectorHostDelegate, [](auto callback) {
          RCTExecuteOnMainQueue(^{
            callback();
          });
        });
    __<span class="hljs-keyword">weak</span> RCTHost *weakSelf = <span class="hljs-keyword">self</span>;
    _inspectorPageId = facebook::react::jsinspector_modern::getInspectorInstance().addPage(
        <span class="hljs-string">"React Native Bridgeless"</span>,
        <span class="hljs-comment">/* vm */</span> <span class="hljs-string">""</span>,
        [weakSelf](std::unique_ptr&lt;facebook::react::jsinspector_modern::IRemoteConnection&gt; remote)
            -&gt; std::unique_ptr&lt;facebook::react::jsinspector_modern::ILocalConnection&gt; {
          RCTHost *strongSelf = weakSelf;
          <span class="hljs-keyword">if</span> (!strongSelf) {
            <span class="hljs-comment">// This can happen if we're about to be dealloc'd. Reject the connection.</span>
            <span class="hljs-keyword">return</span> nullptr;
          }
          <span class="hljs-keyword">return</span> strongSelf-&gt;_inspectorTarget-&gt;connect(std::move(remote));
        },
        {.nativePageReloads = <span class="hljs-literal">true</span>, .prefersFuseboxFrontend = <span class="hljs-literal">true</span>});
  }
  <span class="hljs-keyword">if</span> (_instance) {
    RCTLogWarn(
        <span class="hljs-string">@"RCTHost should not be creating a new instance if one already exists. This implies there is a bug with how/when this method is being called."</span>);
    [_instance invalidate];
  }

  <span class="hljs-comment">// 3. 创建 RCTInstance</span>
  _instance = [[RCTInstance alloc] initWithDelegate:<span class="hljs-keyword">self</span>
                                   jsRuntimeFactory:[<span class="hljs-keyword">self</span> _provideJSEngine]
                                      bundleManager:_bundleManager
                         turboModuleManagerDelegate:_turboModuleManagerDelegate
                                     moduleRegistry:_moduleRegistry
                              parentInspectorTarget:_inspectorTarget.get()
                                      launchOptions:_launchOptions
                               devMenuConfiguration:_devMenuConfiguration];
  <span class="hljs-comment">// 4. 通知代理 Host 已启动</span>
  [_hostDelegate hostDidStart:<span class="hljs-keyword">self</span>];
}
</code></pre>
<p>继续查看<code>RCTInstance</code>的构造实现，源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTInstance.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTInstanceDelegate&gt;)delegate
                jsRuntimeFactory:(std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;)jsRuntimeFactory
                   bundleManager:(RCTBundleManager *)bundleManager
      turboModuleManagerDelegate:(<span class="hljs-type">id</span>&lt;RCTTurboModuleManagerDelegate&gt;)tmmDelegate
                  moduleRegistry:(RCTModuleRegistry *)moduleRegistry
           parentInspectorTarget:(jsinspector_modern::HostTarget *)parentInspectorTarget
                   launchOptions:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span> *)launchOptions
            devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-comment">// 性能监控初始化</span>
    _performanceLogger = [RCTPerformanceLogger new];
    registerPerformanceLoggerHooks(_performanceLogger);
    [_performanceLogger markStartForTag:RCTPLReactInstanceInit];

    <span class="hljs-comment">// 保存外部传入的关键依赖</span>
    _delegate = delegate;
    _jsRuntimeFactory = jsRuntimeFactory;
    _appTMMDelegate = tmmDelegate;
    _jsThreadManager = [RCTJSThreadManager new];

    <span class="hljs-comment">// 开发菜单配置</span>
    _devMenuConfigurationDecorator =
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU</span>
        [[RCTDevMenuConfigurationDecorator alloc] initWithDevMenuConfiguration:devMenuConfiguration];
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
        <span class="hljs-literal">nil</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    _parentInspectorTarget = parentInspectorTarget;

    <span class="hljs-comment">// JS 模块调用器配置(设置 Bridgeless 模式下的 JS 模块方法调用器)</span>
    {
      __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
      [_bridgeModuleDecorator.callableJSModules
          setBridgelessJSModuleMethodInvoker:^(
              <span class="hljs-built_in">NSString</span> *moduleName, <span class="hljs-built_in">NSString</span> *methodName, <span class="hljs-built_in">NSArray</span> *args, dispatch_block_t onComplete) {
            [weakSelf callFunctionOnJSModule:moduleName method:methodName args:args];
            <span class="hljs-keyword">if</span> (onComplete) {
              [weakSelf
                  callFunctionOnBufferedRuntimeExecutor:[onComplete](facebook::jsi::Runtime &amp;_) { onComplete(); }];
            }
          }];
    }
    _launchOptions = launchOptions;

    <span class="hljs-comment">// 内存警告监听</span>
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span>
                                             selector:<span class="hljs-keyword">@selector</span>(_handleMemoryWarning)
                                                 name:<span class="hljs-built_in">UIApplicationDidReceiveMemoryWarningNotification</span>
                                               object:<span class="hljs-literal">nil</span>];
    <span class="hljs-comment">// 启动核心初始化</span>
    [<span class="hljs-keyword">self</span> _start];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>接下来，我们来看整个初始化过程的核心方法<code>_start</code>实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_start
{
  <span class="hljs-comment">// 1.设置定时器系统</span>
  auto objCTimerRegistry = std::make_unique&lt;ObjCTimerRegistry&gt;();
  auto timing = objCTimerRegistry-&gt;timing;
  auto *objCTimerRegistryRawPtr = objCTimerRegistry.get();

  auto timerManager = std::make_shared&lt;TimerManager&gt;(std::move(objCTimerRegistry));
  objCTimerRegistryRawPtr-&gt;setTimerManager(timerManager);

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  auto onJsError = [=](jsi::Runtime &amp;runtime, <span class="hljs-keyword">const</span> JsErrorHandler::ProcessedError &amp;error) {
    [weakSelf _handleJSError:error withRuntime:runtime];
  };

  <span class="hljs-comment">// 2.创建 ReactInstance (C++ 层)</span>
  _reactInstance = std::make_unique&lt;ReactInstance&gt;(
      _jsRuntimeFactory-&gt;createJSRuntime(_jsThreadManager.jsMessageThread),
      _jsThreadManager.jsMessageThread,
      timerManager,
      onJsError,
      _parentInspectorTarget);
  _valid = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 3.设置 RuntimeExecutor</span>
  RuntimeExecutor bufferedRuntimeExecutor = _reactInstance-&gt;getBufferedRuntimeExecutor();
  timerManager-&gt;setRuntimeExecutor(bufferedRuntimeExecutor);

  auto jsCallInvoker = make_shared&lt;RuntimeSchedulerCallInvoker&gt;(_reactInstance-&gt;getRuntimeScheduler());
  <span class="hljs-comment">// 省略旧架构......</span>

  <span class="hljs-comment">// 4.创建 TurboModuleManager</span>
  _turboModuleManager = [[RCTTurboModuleManager alloc] initWithBridgeProxy:bridgeProxy
                                                     bridgeModuleDecorator:_bridgeModuleDecorator
                                                                  delegate:<span class="hljs-keyword">self</span>
                                                                 jsInvoker:jsCallInvoker
                                             devMenuConfigurationDecorator:_devMenuConfigurationDecorator];

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
  <span class="hljs-comment">/**
    * 实例化 DevMenu 会产生副作用，即通过 RCTDevMenu 注册
    * CMD + d、CMD + i 和 CMD + n 的快捷键。 
    * 因此，启用 TurboModules 时，我们必须手动创建此NativeModule。
   */</span>
  [_turboModuleManager moduleForName:<span class="hljs-string">"RCTDevMenu"</span>];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// end RCT_DEV</span></span>

  <span class="hljs-comment">// 初始化 RCTModuleRegistry，以便 TurboModules 可以引用其他 TurboModules</span>
  [_bridgeModuleDecorator.moduleRegistry setTurboModuleRegistry:_turboModuleManager];

  <span class="hljs-keyword">if</span> (ReactNativeFeatureFlags::enableEagerMainQueueModulesOnIOS()) {
    <span class="hljs-comment">/**
     * 某些原生模块需要在主线程上捕获 UIKit 对象。
     * 因此，请在此处的主队列上开始初始化这些模块。JavaScript 线程将等待这些模块初始化完成后，才会执行 JavaScript 代码包。
     */</span>
    <span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *modulesRequiringMainQueueSetup = [_delegate unstableModulesRequiringMainQueueSetup];

    std::shared_ptr&lt;std::mutex&gt; mutex = std::make_shared&lt;std::mutex&gt;();
    std::shared_ptr&lt;std::condition_variable&gt; cv = std::make_shared&lt;std::condition_variable&gt;();
    std::shared_ptr&lt;<span class="hljs-type">bool</span>&gt; isReady = std::make_shared&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-literal">false</span>);

    _waitUntilModuleSetupComplete = ^{
      std::unique_lock&lt;std::mutex&gt; lock(*mutex);
      cv-&gt;wait(lock, [isReady] { <span class="hljs-keyword">return</span> *isReady; });
    };

    <span class="hljs-comment">// TODO(T218039767): 将性能日志记录功能集成到主队列模块初始化过程中</span>
    RCTExecuteOnMainQueue(^{
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *moduleName <span class="hljs-keyword">in</span> modulesRequiringMainQueueSetup) {
        [<span class="hljs-keyword">self</span>-&gt;_bridgeModuleDecorator.moduleRegistry moduleForName:[moduleName UTF8String]];
      }

      RCTScreenSize();
      RCTScreenScale();
      RCTSwitchSize();

      std::lock_guard&lt;std::mutex&gt; lock(*mutex);
      *isReady = <span class="hljs-literal">true</span>;
      cv-&gt;notify_all();
    });
  }

  RCTLogSetBridgelessModuleRegistry(_bridgeModuleDecorator.moduleRegistry);
  RCTLogSetBridgelessCallableJSModules(_bridgeModuleDecorator.callableJSModules);

  <span class="hljs-comment">// 5.创建 ContextContainer</span>
  auto contextContainer = std::make_shared&lt;ContextContainer&gt;();
  [_delegate didCreateContextContainer:contextContainer];
  <span class="hljs-comment">// 插入核心模块</span>
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTImageLoader"</span>, facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTImageLoader"</span>]));
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTEventDispatcher"</span>,
      facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTEventDispatcher"</span>]));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeModuleDecorator"</span>, facebook::react::wrapManagedObject(_bridgeModuleDecorator));
  contextContainer-&gt;insert(RuntimeSchedulerKey, std::weak_ptr&lt;RuntimeScheduler&gt;(_reactInstance-&gt;getRuntimeScheduler()));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeProxy"</span>, facebook::react::wrapManagedObject(bridgeProxy));

  <span class="hljs-comment">// 6.创建 SurfacePresenter</span>
  _surfacePresenter = [[RCTSurfacePresenter alloc]
        initWithContextContainer:contextContainer
                 runtimeExecutor:bufferedRuntimeExecutor
      bridgelessBindingsExecutor:std::optional(_reactInstance-&gt;getUnbufferedRuntimeExecutor())];

  <span class="hljs-comment">// 这使得模块中的 RCTViewRegistry 能够通过其 viewForReactTag 方法返回 UIView 对象</span>
  __<span class="hljs-keyword">weak</span> RCTSurfacePresenter *weakSurfacePresenter = _surfacePresenter;
  [_bridgeModuleDecorator.viewRegistry_DEPRECATED setBridgelessComponentViewProvider:^<span class="hljs-built_in">UIView</span> *(<span class="hljs-built_in">NSNumber</span> *reactTag) {
    RCTSurfacePresenter *strongSurfacePresenter = weakSurfacePresenter;
    <span class="hljs-keyword">if</span> (strongSurfacePresenter == <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }

    <span class="hljs-keyword">return</span> [strongSurfacePresenter findComponentViewWithTag_DO_NOT_USE_DEPRECATED:reactTag.integerValue];
  }];

  <span class="hljs-comment">// 7.创建DisplayLink （用于调用计时器回调函数）</span>
  _displayLink = [RCTDisplayLink new];

  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();

  ReactInstance::JSRuntimeFlags options = {
      .isProfiling = inspectorFlags.getIsProfilingBuild(),
      .runtimeDiagnosticFlags = [RCTInstanceRuntimeDiagnosticFlags() UTF8String]};

  <span class="hljs-comment">// 8.初始化 JS Runtime 并加载 Bundle</span>
  _reactInstance-&gt;initializeRuntime(options, [=](jsi::Runtime &amp;runtime) {
    __<span class="hljs-keyword">strong</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
    <span class="hljs-keyword">if</span> (!strongSelf) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 安装 TurboModule JS 绑定</span>
    [strongSelf-&gt;_turboModuleManager installJSBindings:runtime];
    <span class="hljs-comment">// 绑定 Native Logger</span>
    facebook::react::bindNativeLogger(runtime, [](<span class="hljs-keyword">const</span> std::string &amp;message, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> logLevel) {
      _RCTLogJavaScriptInternal(static_cast&lt;RCTLogLevel&gt;(logLevel), [<span class="hljs-built_in">NSString</span> stringWithUTF8String:message.c_str()]);
    });

    <span class="hljs-comment">// 安装 Native Component Registry 绑定</span>
    RCTInstallNativeComponentRegistryBinding(runtime);

    <span class="hljs-comment">// 通知代理 Runtime 已初始化</span>
    [strongSelf-&gt;_delegate instance:strongSelf didInitializeRuntime:runtime];

    <span class="hljs-comment">// 设置 DisplayLink</span>
    <span class="hljs-type">id</span>&lt;RCTDisplayLinkModuleHolder&gt; moduleHolder = [[RCTBridgelessDisplayLinkModuleHolder alloc] initWithModule:timing];
    [strongSelf-&gt;_displayLink registerModuleForFrameUpdates:timing withModuleHolder:moduleHolder];
    [strongSelf-&gt;_displayLink addToRunLoop:[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]];

    <span class="hljs-comment">// 尝试同步加载bundle包，如果失败则回退到异步加载。</span>
    [strongSelf-&gt;_performanceLogger markStartForTag:RCTPLScriptDownload];
    [strongSelf _loadJSBundle:[strongSelf-&gt;_bridgeModuleDecorator.bundleManager bundleURL]];
  });

  [_performanceLogger markStopForTag:RCTPLReactInstanceInit];
}
</code></pre>
<h5 data-id="heading-11">JS Bundle 加载</h5>
<p>继续查看<code>_loadJSBundle</code>方法的实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_loadJSBundle:(<span class="hljs-built_in">NSURL</span> *)sourceURL
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
  {
    <span class="hljs-comment">// 显示加载视图</span>
    <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
        (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
    [loadingView showWithURL:sourceURL];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 通过代理加载 Bundle</span>
  [_delegate loadBundleAtURL:sourceURL
      onProgress:^(RCTLoadingProgress *progressData) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
        <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
            (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
        [loadingView updateProgress:progressData];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }
      onComplete:^(<span class="hljs-built_in">NSError</span> *error, RCTSource *source) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (error) {
          [strongSelf handleBundleLoadingError:error];
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// _loadScriptFromSource 函数的回调函数需要 DevSettings 模块，因此需要提前进行初始化。</span>
        RCTDevSettings *<span class="hljs-keyword">const</span> devSettings =
            (RCTDevSettings *)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevSettings"</span>];

        <span class="hljs-comment">// 加载脚本</span>
        [strongSelf _loadScriptFromSource:source];
        <span class="hljs-comment">// 仅在开发环境中启用热模块重载功能。</span>
        [strongSelf-&gt;_performanceLogger markStopForTag:RCTPLScriptDownload];
        [devSettings setupHMRClientWithBundleURL:sourceURL];
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
        [strongSelf _logOldArchitectureWarnings];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }];
}


- (<span class="hljs-type">void</span>)_loadScriptFromSource:(RCTSource *)source
{
  std::lock_guard&lt;std::mutex&gt; lock(_invalidationMutex);
  <span class="hljs-keyword">if</span> (!_valid) {
    <span class="hljs-keyword">return</span>;
  }

  auto script = std::make_unique&lt;<span class="hljs-built_in">NSDataBigString</span>&gt;(source.data);
  <span class="hljs-keyword">const</span> auto *url = deriveSourceURL(source.url).UTF8String;

  auto beforeLoad = [waitUntilModuleSetupComplete = <span class="hljs-keyword">self</span>-&gt;_waitUntilModuleSetupComplete](jsi::Runtime &amp;_) {
    <span class="hljs-keyword">if</span> (waitUntilModuleSetupComplete) {
      waitUntilModuleSetupComplete();
    }
  };
  auto afterLoad = [](jsi::Runtime &amp;_) {
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:<span class="hljs-string">@"RCTInstanceDidLoadBundle"</span> object:<span class="hljs-literal">nil</span>];
  };
  <span class="hljs-comment">// 在 ReactInstance 中执行脚本</span>
  _reactInstance-&gt;loadScript(std::move(script), url, beforeLoad, afterLoad);
}
</code></pre>
<h5 data-id="heading-12">Surface 创建与启动</h5>
<p>现在，我们把视线拉回<code>viewWithModuleName</code>方法中，继续分析后面的<code>createSurfaceWithModuleName</code>方法的实现。源码<code>RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> createSurfaceWithModuleName:moduleName mode:DisplayMode::Visible initialProperties:properties];
}

- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                                             mode:(DisplayMode)displayMode
                                initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-comment">// 1. 创建 FabricSurface</span>
  RCTFabricSurface *surface = [[RCTFabricSurface alloc] initWithSurfacePresenter:<span class="hljs-keyword">self</span>.surfacePresenter
                                                                      moduleName:moduleName
                                                               initialProperties:properties];
  <span class="hljs-comment">// 2. 设置显示模式</span>
  surface.surfaceHandler.setDisplayMode(displayMode);

  <span class="hljs-comment">// 3. 附加 Surface</span>
  [<span class="hljs-keyword">self</span> _attachSurface:surface];

  __<span class="hljs-keyword">weak</span> RCTFabricSurface *weakSurface = surface;
  <span class="hljs-comment">// 在 JS Bundle 执行完成后，使用BufferedRuntimeExecutor启动Surface</span>
  [_instance callFunctionOnBufferedRuntimeExecutor:[weakSurface](facebook::jsi::Runtime &amp;_) { [weakSurface start]; }];
  <span class="hljs-keyword">return</span> surface;
}
</code></pre>
<h3 data-id="heading-13">总结</h3>
<p>初始化的大概流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Swift</span> <span class="hljs-string">应用层</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">AppDelegate</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactNativeDelegate:</span> <span class="hljs-string">ReactNativeDelegate</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">reactNativeFactory:</span> <span class="hljs-string">RCTReactNativeFactory</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">ReactNativeDelegate :</span> <span class="hljs-string">RCTDefaultReactNativeFactoryDelegate</span>  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">bundleURL()</span> <span class="hljs-string">→</span> <span class="hljs-string">URL?</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">dependencyProvider:</span> <span class="hljs-string">RCTAppDependencyProvider</span>          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Factory</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTReactNativeFactory</span>                                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">delegate:</span> <span class="hljs-string">RCTReactNativeFactoryDelegate</span>               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">rootViewFactory:</span> <span class="hljs-string">RCTRootViewFactory</span>                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">startReactNative(withModuleName:in:)</span>                  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTRootViewFactory</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactHost:</span> <span class="hljs-string">RCTHost</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">view(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">UIView</span>                        <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createReactHost()</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTHost</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                         <span class="hljs-string">Host</span> <span class="hljs-string">层</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTHost</span>                                                     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">instance:</span> <span class="hljs-string">RCTInstance</span>                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">bundleManager:</span> <span class="hljs-string">RCTBundleManager</span>                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">start()</span>                                               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createSurface(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTFabricSurface</span>     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                       <span class="hljs-string">Instance</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTInstance</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactInstance:</span> <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">turboModuleManager:</span> <span class="hljs-string">RCTTurboModuleManager</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">surfacePresenter:</span> <span class="hljs-string">RCTSurfacePresenter</span>                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">displayLink:</span> <span class="hljs-string">RCTDisplayLink</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">_start()</span>                                              <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">C++</span> <span class="hljs-string">Runtime</span> <span class="hljs-string">层</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                                         <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">jsRuntime:</span> <span class="hljs-string">jsi::Runtime</span> <span class="hljs-string">(Hermes)</span>                      <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">runtimeScheduler:</span> <span class="hljs-string">RuntimeScheduler</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">timerManager:</span> <span class="hljs-string">TimerManager</span>                            <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">initializeRuntime()</span>                                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">loadScript()</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！]]></title>    <link>https://juejin.cn/post/7600229327436709938</link>    <guid>https://juejin.cn/post/7600229327436709938</guid>    <pubDate>2026-01-28T13:45:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436709938" data-draft-id="7600245693997547530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-28T13:45:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot是否才是真正的AI入口产品？一文带你搞懂Clawdbot架构！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:45:02.000Z" title="Wed Jan 28 2026 13:45:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于Anthropic认为Clawdbot这个名字太容易被市场误解为Claude Code的产品，所以要求改名，目前Clawdbot刚改名为Moltbot，以下皆用Clawdbot代替。</p>
</blockquote>
<h2 data-id="heading-0">它是什么</h2>
<p>不是聊天机器人。是一个<strong>拥有键盘、屏幕和身份的高权限代理</strong>。</p>
<p>它运行在你的 Mac 或服务器上，通过 Telegram、Slack、iMessage 这些你已经在用的聊天软件作为入口，直接操控本地文件、终端、浏览器。你在手机上说一句"帮我把桌面的报告发给老板"，它真的会去读文件、打开邮件客户端、发送出去。</p>
<p>传统 AI 是"对话框里的聊天伴侣"，你得跳出工作流去迁就它。Moltbot 把自己变成后台进程，<strong>你不需要打开任何新 App，它就在你的聊天窗口里等着</strong>。</p>
<p>技术上，这是一个<strong>本地优先、统一控制平面</strong>的架构：Gateway 进程独占所有消息通道和工具权限，通过 WebSocket 协议管理多 Agent、多会话、多设备。数据不出本地，执行不经云端。</p>
<h2 data-id="heading-1">整体架构</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b807f8e76b41e5b7bf1f38380b0f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbW9zaHV5aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770212701&amp;x-signature=LvHg88uI0jcOpZtd1eDFQRxc4PU%3D" alt="26n5y12000rb4n79dE78D.png" loading="lazy"/></p>
<p>假设你在 Telegram 给 Clawdbot 发了一条消息："帮我看看桌面有哪些 PDF 文件"。</p>
<p><strong>第一站：Channel Layer</strong></p>
<p>Telegram 的消息被 <code>grammY</code> SDK 捕获，进入 Channel 适配层。这一层的职责是<strong>抹平差异</strong>——WhatsApp 用 Baileys、Discord 用 discord.js、Signal 用 signal-cli，每个平台 SDK 不同、消息格式不同、认证方式不同。Channel Layer 把它们统一成一个结构：谁发的、从哪来、内容是什么。</p>
<p>为什么要这样？因为 AI 不应该关心消息是从 Telegram 还是 iMessage 来的，它只需要知道"用户说了什么"。</p>
<p><strong>第二站：Routing System</strong></p>
<p>消息到了 Gateway，但 Gateway 可能管理着多个 Agent（比如一个工作助手、一个生活助手）。Routing 系统决定这条消息交给谁处理。</p>
<p>路由规则是多级的：先看发送者（peer）、再看群组（guild）、再看账号（account）、再看通道（channel），最后才是默认。这意味着你可以配置"来自老板的消息走工作 Agent，来自家人的消息走生活 Agent"。</p>
<p>同时，Routing 还生成 <code>sessionKey</code>——这条消息属于哪个会话。会话隔离是核心设计：不同对话的上下文不会串，A 群的聊天历史不会出现在 B 群。</p>
<p><strong>第三站：Agent Runtime</strong></p>
<p>消息和会话上下文一起交给 Agent。Agent 的核心是 Pi Agent Core 框架，负责：</p>
<ol>
<li>构建 prompt（系统提示 + 历史消息 + 当前输入）</li>
<li>调用 AI 模型（Ollama 本地、OpenAI 云端，或其他）</li>
<li>解析模型响应，判断是直接回复还是需要调用工具</li>
</ol>
<p>对于"看桌面 PDF"这个请求，模型会判断需要调用 <code>bash</code> 工具。</p>
<p><strong>第四站：Tools System</strong></p>
<p>Agent 发起工具调用：<code>ls ~/Desktop/*.pdf</code>。</p>
<p>工具系统不是简单地执行命令——它有权限控制（哪些目录可访问）、沙箱隔离（非 main 会话在 Docker 里跑）、超时管理（防止命令卡死）。执行结果返回给 Agent，Agent 把结果组织成自然语言回复。</p>
<p><strong>回程</strong></p>
<p>回复沿着原路返回：Agent → Gateway → Channel → Telegram → 你的手机。</p>
<p>整个过程，Gateway 是唯一的调度中心。为什么单点？因为消息通道（WhatsApp session、Telegram bot）的状态是独占的，多进程会冲突。单一 Gateway 确保所有状态一致。</p>
<h2 data-id="heading-2">全局数据流</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Channel as 消息通道
    participant Gateway as Gateway
    participant Router as 路由系统
    participant Agent as Agent Runtime
    participant Model as AI 模型
    participant Tool as 工具系统

    User-&gt;&gt;Channel: 发送消息
    Channel-&gt;&gt;Gateway: 接收消息
    Gateway-&gt;&gt;Router: 解析路由
    Router-&gt;&gt;Gateway: 返回 agent + sessionKey
    Gateway-&gt;&gt;Agent: 调用 agent.run()
    Agent-&gt;&gt;Model: 调用 AI 模型
    Model--&gt;&gt;Agent: 流式响应
    Agent-&gt;&gt;Tool: 工具调用（如有）
    Tool--&gt;&gt;Agent: 工具结果
    Agent--&gt;&gt;Gateway: 最终响应
    Gateway-&gt;&gt;Channel: 发送回复
    Channel-&gt;&gt;User: 显示消息
</code></pre>
<h2 data-id="heading-3">完全内网部署（Ollama）</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git &amp;&amp; <span class="hljs-built_in">cd</span> moltbot
pnpm install &amp;&amp; pnpm build &amp;&amp; pnpm ui:build

<span class="hljs-comment"># 2. 配置 Ollama</span>
ollama pull llama3.3
<span class="hljs-built_in">export</span> OLLAMA_API_KEY=<span class="hljs-string">"ollama-local"</span>  <span class="hljs-comment"># 自动发现本地模型</span>

<span class="hljs-comment"># 3. 启动</span>
pnpm moltbot gateway  <span class="hljs-comment"># Gateway 启动后访问 http://127.0.0.1:18789</span>
</code></pre>
<p><strong>Ollama 配置要点</strong>：</p>
<ul>
<li>设置 <code>OLLAMA_API_KEY</code> 后，Clawdbot 自动发现本地模型（查询 <code>/api/tags</code>）</li>
<li>只有报告 <code>tools</code> 能力的模型才会被识别</li>
<li>推荐模型：<code>llama3.3</code>、<code>qwen2.5-coder:32b</code>、<code>deepseek-r1:32b</code></li>
</ul>
<p>三、产品层面思考</p>
<p>你有没有想过，为什么这一年冒出来这么多 AI App，但你手机里真正留下的没几个？</p>
<p>豆包、Kimi、ChatGPT……每个都想成为你的"AI 入口"，每个都让你下载、注册、记住一个新地方。但说实话，微信已经够好用了，Telegram 已经够好用了。用户不缺聊天工具，缺的是聊天工具里<strong>能帮他干活的东西</strong>。</p>
<p>Clawdbot 选了一条不一样的路：不做独立 App，直接"住进"你已有的聊天软件里。Telegram 里的一个 bot，Slack 里的一个 integration，iMessage 里的一个联系人。你不用切换任何东西，在原来的地方说话就行。</p>
<p>这让我想，也许 AI 产品的竞争，最后不是"谁的模型更强"，而是"谁能更无缝地嵌入用户已有的生活"。</p>
<p>大部分 AI 产品把你的聊天记录、记忆、偏好全存在云端。你不知道它存了什么，怎么用，会不会泄露。Clawdbot 做了个很"硬核"的决定：所有数据都以 Markdown 文件存在你本地。你可以像翻笔记一样查看 AI 的"思考过程"，随时删、改、备份。</p>
<p>对企业用户来说，这意味着数据合规问题天然解决。对个人用户来说，这意味着"我的 AI 只属于我"。</p>
<p>在 AI 时代，"数据主权"会不会成为一个真正的卖点？我不确定，但这个方向值得琢磨。</p>
<p>五、安全风险</p>
<p>这东西本质上是一个<strong>拥有你电脑完整控制权的代理</strong>。能读文件、执行命令、用你的身份发消息。配置失误、边界失守，泄露的不只是数据，而是你的身份和整台机器的控制权。</p>
<p>部署前，白名单一定要配（<code>allowFrom</code>），群组里 mention 门控一定要开，敏感操作最好用 Docker 沙箱隔离。绝对不要暴露到公网，绝对不要让不信任的人能访问。</p>
<p>现阶段，它还是个高危实验品。适合技术敏感度高、愿意折腾、能自己兜底的人。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot" target="_blank" title="https://clawd.bot" ref="nofollow noopener noreferrer">clawd.bot</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclawdbot%2Fclawdbot" target="_blank" title="https://github.com/clawdbot/clawdbot" ref="nofollow noopener noreferrer">github.com/clawdbot/cl…</a>
文档 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.clawd.bot" target="_blank" title="https://docs.clawd.bot" ref="nofollow noopener noreferrer">docs.clawd.bot</a>
技能市场 ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawdhub.com" target="_blank" title="https://clawdhub.com" ref="nofollow noopener noreferrer">clawdhub.com</a>
Discord社区：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.gg%2Fclawd" target="_blank" title="https://discord.gg/clawd" ref="nofollow noopener noreferrer">discord.gg/clawd</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent Nexus 版本分支正式提交[号外]—核心四问]]></title>    <link>https://juejin.cn/post/7600032104249311295</link>    <guid>https://juejin.cn/post/7600032104249311295</guid>    <pubDate>2026-01-28T14:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249311295" data-draft-id="7600219080046100523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent Nexus 版本分支正式提交[号外]—核心四问"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T14:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent Nexus 版本分支正式提交[号外]—核心四问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:02:39.000Z" title="Wed Jan 28 2026 14:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ooderAgent Nexus 版本分支已正式完成提交，经多维度严苛验证，5 大全场景测试全部通过，标志着这一年轻开源项目正式从技术原型迈入有实际场景、有核心价值的产品级新阶段。本次 Nexus 版本围绕 “AIGC 时代 AI 能力枢纽” 的核心定位完成全维度升级，核心更新覆盖技术底座、生态落地、工具创新、核心模式四大维度，配套推出 SkillCenter 多中心设计，实现技术与价值的双闭环。以下为本次版本核心疑问的深度解答，精准诠释 Nexus 版本的核心升级与创新价值。</p>
<h2 data-id="heading-0">1. 本次更新都包含了什么？为什么被称为 Nexus 版本？</h2>
<p>本次 Nexus 版本是 ooderAgent 的关键产品级迭代，核心更新覆盖四大维度，且全量功能均通过 5 大全场景实战验证：技术侧完成 A2UI 工程化升级、VFS 分布式事务存储搭建、协议标准化落地及 mcpAgent SDK 易用性优化，筑牢 AI 能力枢纽的技术底座；生态侧打通 trae-solo skills 生态，实现个人用户零门槛接入 AI 资源，完成生态连接的核心突破；创新侧推出全新 RAD 可视化开发工具，验证 OneCode 全栈技术与 AI 的深度融合，实现工具链的创新升级；核心模式侧落地 Nexus P2P 能力分发体系，重构 AI 能力与用户需求的连接逻辑，同时配套推出 SkillCenter 多中心设计，形成 “能力枢纽 - 能力分发 - 能力落地 - 能力协同” 的完整闭环。</p>
<p>将该版本命名为 Nexus（枢纽），核心源于本次更新实现了技术与价值的双闭环，让 ooderAgent 从单一的 AI Agent 开发框架，进化为 AIGC 时代下连接 AI 能力、开发者、个人及企业用户的核心枢纽。本版本以高速发展的 AIGC 为核心驱动力，向上无缝对接各类 LLM 模型与 AI 能力，向下全面支撑个人开发、企业落地等多样化需求，中间通过标准化协议、分布式存储、SkillCenter、P2P 模式实现能力的高效调度、分发与协同，所有更新均围绕 “打造 AI 能力核心枢纽” 展开。而 5 大全场景测试的全部通过，更是为这一枢纽能力的商业化、规模化落地提供了坚实的质量保障，Nexus 的称号也因此成为该版本最贴切的诠释。</p>
<h2 data-id="heading-1">2. 本次更新的 SkillCenter 看似无所不能，它实际解决了哪些问题？</h2>
<p>SkillCenter 并非全能型工具，而是 ooderAgent 在 AI 能力落地实战中的核心总结与针对性解决方案，经全场景验证后正式落地，直击 AI 应用落地过程中的不确定性、可控性、规模化三大核心痛点，推动 AI 能力从 “随机生成” 走向 “规范、稳定落地”。</p>
<p>AI 的 “生成能力” 虽能快速响应需求，甚至仅凭一句话就能输出贴合需求的结果，但这份便捷背后存在天然的不确定性 —— 即便在 AI 编程这类确定性较强的领域，也会因输出的 “朝秦暮楚” 导致实际落地困难。skills 技术理念的推出，让 AI 重回确定性发展路线，而要打造 100% 避免无依据幻想的确定性产品，需在兼顾 AI 能力与创造力的同时，做好落地的规范约束，SkillCenter 正是这一需求的核心落地载体。</p>
<p>其核心解决的问题体现在两大维度：一是通过Remote Skills 远程技能服务，将 AI 能力落地全流程中确定性的问题抽象为标准化、确定性的结果服务，让这些结果摆脱本地 skills 框架的约束，在 AI 天然的道德约束之外，搭建起一层 “法律式” 的规则约束，确保 AI 能力稳定、可控发挥，从根源上解决 AI 输出的不确定性问题；二是通过多中心设计，构建起 AI 能力落地的标准化规范体系，让分散、个性化的 skills 能力能在统一体系中实现调度、分发与管理，解决了 AI 能力规模化落地的规范难题，成为 AI 能力从技术走向实际场景的核心桥梁。且这一设计已在 5 大全场景中完成实战验证，具备规模化落地的成熟条件。</p>
<h2 data-id="heading-2">3. 本次重要更新的 RAD 版本有什么特殊之处？</h2>
<p>RAD（快速应用开发）工具的更新，是 ooderAgent 一次跳出传统认知、颠覆式的技术创新，并非简单的 “旧瓶装新酒”，该功能经全场景测试验证后正式推出，其特殊性体现在技术选型、设计目标、AI 融合三大维度，核心验证了 OneCode 全栈技术与 AI 的深度结合，以及 ooderAgent 工具链为 AI 定制化设计的技术优势。</p>
<p>从技术选型来看，RAD 打破了行业固有认知：与人交互的可视化交互软件，本是工程与技术长期磨合的产物，而设计器作为软件技术的 “皇冠”，历来被认为需要高灵活性的技术架构，本次 RAD 却首次采用被认为 “灵活性、扩展性相对受限” 的 OneCode 全栈技术开发，技术实现难度不言而喻。但在 AI 的辅助下，OneCode 的优势被充分释放，短期内突破了其旧有架构的边界，实现了全套全新 UI、全套样式图标体系、多语言支持、渐进式整体升级、响应式 UI 设计等一系列此前难以完成的任务，完成了技术选型的反向验证，且所有功能均在全场景测试中实现稳定运行。</p>
<p>从设计目标来看，传统 RAD 与 AI 的确定性技术路线相悖，而本次 ooderAgent 的 RAD 设计，核心是打造AI 原生的可视化开发工具，将 AI 能力深度融入开发全流程。在已放出的演示视频中，能清晰看到 AI 与工具链的协同创新：LLM 可通过浏览器 debug 日志实时诊断脚本错误，通过实时截图获取定位信息偏差，运算输出 JavaScript 后通过浏览器预览实时调整布局，定位效果达标后再分析样式语法，精准找到需要修改的 OneCode 注解并完成精确修改。这一过程中，不仅验证了 LLM 的核心能力，更体现了 ooderAgent 强大的工具链支撑，以及框架层面对 AI 的专属定制化设计，让 RAD 成为 AI 辅助开发的核心载体。</p>
<p>从技术创新来看，本次 RAD 实现了实时反馈、自主编程等新技术的实战验证，将 AI 从 “辅助生成” 推向 “主动开发”，是对传统 RAD 工具的彻底重构，让可视化开发与 AI 能力实现无缝融合，成为 ooderAgent 技术创新的重要标杆。且该创新模式已在 5 大全场景中完成落地验证，具备实际应用价值，也为行业提供了 AI 与可视化开发融合的全新思路。</p>
<h2 data-id="heading-3">4. 本次更新支持的 P2P 模式是什么背景下的？为什么会反复宣传？</h2>
<p>Nexus P2P 是本次版本发布的核心核心，作为 ooderAgent 打造 AI 能力枢纽的核心模式，该功能经 5 大全场景严苛测试后正式落地，其推出的背景，源于 AI 能力落地的 “第一性原理”：在真实的用户需求中，永远只有 AI 与本质性的用户需求两大核心，二者之间的任何中间环节、包装层级，最终都会被需求跨越、击穿。而当前 AI 生态中，存在大量的能力包装、层级冗余问题，导致 AI 能力与用户需求之间的连接效率低下，这一行业痛点成为 P2P 模式推出的核心背景。</p>
<p>之所以反复宣传 Nexus P2P，核心在于它是一场AI 能力分发的革命，彻底重构了 AI 能力与用户需求的连接逻辑：让需求和能力之间，只存在 “AI” 与 “Agent Nexus”，砍掉了所有冗余的中间环节，实现了 AI 能力的直连式分发，且这一直连模式已在全场景中完成实战验证，确保高效、稳定运行。</p>
<p>Agent Nexus 围绕 “需求与能力直连” 这一核心需求，对 AI 能力落地的全流程进行层层拆解，剥去了所有非必要的包装与层级，但同时又通过标准化的规则与节奏，保障了能力分发的有序性与可控性 —— 这正是 “Agent Nexus” 的核心价值：既实现了 AI 能力与用户本质需求的无阻碍连接，又避免了无规则直连带来的混乱，让 AI 能力能高效、规范地触达用户。这种模式彻底打破了传统的能力分发逻辑，让 AI 能力落地回归本质，是 ooderAgent 从 “AI 能力枢纽” 走向 “AI 生态核心” 的关键，也是其区别于其他 AI Agent 框架的核心竞争力，更是本次 Nexus 版本能实现技术与价值双闭环的核心支撑，因此成为本次版本发布的核心宣传点。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>ooderAgent Nexus 版本分支的正式提交与 5 大全场景测试的全部通过，是这一年轻开源项目的重要里程碑。从技术原型到产品级形态，从单一框架到 AI 能力枢纽，Nexus 版本的每一次升级、每一项创新，都围绕 “AIGC 时代让 AI 能力更高效、更规范、更普惠地落地” 这一核心目标。而 SkillCenter、RAD、Nexus P2P 的创新落地，不仅为 ooderAgent 自身生态奠定了基础，也为 AI Agent 行业的发展提供了全新的实践思路。未来，ooderAgent 将继续以技术创新为核心，完善生态布局，让 AI 能力真正服务于每一个开发者、每一个实际需求场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事]]></title>    <link>https://juejin.cn/post/7600223321041682438</link>    <guid>https://juejin.cn/post/7600223321041682438</guid>    <pubDate>2026-01-28T12:13:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041682438" data-draft-id="7600223321041666054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事"/> <meta itemprop="keywords" content="AI编程,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T12:13:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第5篇）：最近火爆硅谷的ClaudBot，真不是什么不得了的事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:13:51.000Z" title="Wed Jan 28 2026 12:13:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"当技术圈的狂欢遇到冷静的理性分析，真相往往比营销更值得关注。"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第5篇文章。今天带你了解的项目是 <strong>Moltbot</strong>（原名 Clawdbot，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>最近这个项目在技术圈刷屏了：GitHub 星标狂飙到 72k+，被吹成"7×24小时AI员工""开源贾维斯"，甚至有人说它"带火了Mac mini销量"。但冷静分析后会发现，它的火爆更多是踩中了情绪，而非技术上的颠覆性创新。</p>
<h2 data-id="heading-1">项目背景</h2>
<h3 data-id="heading-2">项目简介</h3>
<p><strong>Moltbot</strong>（原名 Clawdbot）是一个<strong>开源的个人AI助手</strong>，支持多平台、多渠道运行。它通过 Gateway（网关）架构，将AI能力与桌面系统、社交软件、办公工具等连接起来，实现从"聊天"到"执行"的闭环。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>AI助手只能聊天，无法执行实际任务</li>
<li>需要统一的接口来连接各种服务和工具</li>
<li>个人数据隐私和本地部署的需求</li>
<li>开发者需要可定制的AI代理框架</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>技术极客和开发者</li>
<li>对隐私敏感的用户</li>
<li>需要高度定制化AI助手的用户</li>
<li>愿意折腾配置的技术爱好者</li>
</ul>
<h3 data-id="heading-3">作者/团队介绍</h3>
<p><strong>作者：Peter Steinberger (@steipete)</strong></p>
<ul>
<li><strong>背景</strong>：专注于AI和开发者工具的开源开发者</li>
<li><strong>理念</strong>：为 Molty（一只空间龙虾AI助手）构建个人AI代理</li>
<li><strong>项目起源</strong>：最初为个人需求开发，后开源给社区</li>
</ul>
<p><strong>项目创建时间</strong>：2024年（从 GitHub 提交历史可以看出项目持续活跃）</p>
<h3 data-id="heading-4">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 72.3k+（持续快速增长）</li>
<li>🍴 <strong>Forks</strong>: 9.2k+</li>
<li>📦 <strong>版本</strong>: Clawdbot 2026.1.24（最新版本，2026年1月25日发布）</li>
<li>📄 <strong>License</strong>: MIT（完全开源，自由使用）</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: 包含详细的文档和平台指南</li>
<li>💬 <strong>社区</strong>: GitHub Issues 和 Discussions 活跃</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2024年：项目启动，最初名为 Clawdbot</li>
<li>2024-2025年：快速发展，添加多平台支持</li>
<li>2025年底：项目更名，从 Clawdbot 改为 Moltbot</li>
<li>2026年：持续优化，社区活跃度极高</li>
</ul>
<hr/>
<h2 data-id="heading-5">主要功能</h2>
<h3 data-id="heading-6">核心作用</h3>
<p>Moltbot 的核心作用是<strong>将AI大模型的能力与桌面系统、各种服务连接起来</strong>，实现从自然语言指令到实际任务执行的完整闭环。它通过 Gateway 架构，统一管理各种渠道（Telegram、Slack、Discord、iMessage等）和工具（浏览器控制、文件操作、系统调用等）。</p>
<h3 data-id="heading-7">使用场景</h3>
<ol>
<li>
<p><strong>多渠道AI助手</strong></p>
<ul>
<li>通过 Telegram、Slack、Discord 等渠道与AI对话</li>
<li>统一管理多个社交和办公平台</li>
<li>实现跨平台的任务执行</li>
</ul>
</li>
<li>
<p><strong>桌面自动化</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>自动化文件操作和系统任务</li>
<li>实现复杂的多步骤工作流</li>
</ul>
</li>
<li>
<p><strong>本地AI代理</strong></p>
<ul>
<li>本地部署，数据不上云</li>
<li>长期记忆和上下文管理</li>
<li>可对接本地大模型</li>
</ul>
</li>
<li>
<p><strong>智能家居集成</strong></p>
<ul>
<li>通过开源生态整合智能家居</li>
<li>自定义Agent和技能</li>
<li>实现个性化的自动化场景</li>
</ul>
</li>
<li>
<p><strong>开发者工具</strong></p>
<ul>
<li>作为AI代理开发框架</li>
<li>支持自定义扩展和插件</li>
<li>用于构建专属AI应用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">快速开始</h3>
<h4 data-id="heading-9">安装方式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 npm/pnpm/yarn 安装</span>
npm install -g @moltbot/cli

<span class="hljs-comment"># 或使用 Docker</span>
docker run -it --<span class="hljs-built_in">rm</span> moltbot/moltbot

<span class="hljs-comment"># 或从源码构建</span>
git <span class="hljs-built_in">clone</span> https://github.com/moltbot/moltbot.git
<span class="hljs-built_in">cd</span> moltbot
pnpm install
pnpm build
</code></pre>
<h4 data-id="heading-10">基本配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml</span>
<span class="hljs-attr">channels:</span>
  <span class="hljs-attr">telegram:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_BOT_TOKEN"</span>
  
  <span class="hljs-attr">discord:</span>
    <span class="hljs-attr">token:</span> <span class="hljs-string">"YOUR_DISCORD_TOKEN"</span>
  
  <span class="hljs-attr">slack:</span>
    <span class="hljs-attr">botToken:</span> <span class="hljs-string">"YOUR_SLACK_BOT_TOKEN"</span>
    <span class="hljs-attr">appToken:</span> <span class="hljs-string">"YOUR_SLACK_APP_TOKEN"</span>

<span class="hljs-attr">browser:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">color:</span> <span class="hljs-string">"#FF4500"</span>

<span class="hljs-attr">ai:</span>
  <span class="hljs-attr">provider:</span> <span class="hljs-string">"openai"</span>  <span class="hljs-comment"># 或 "anthropic", "local" 等</span>
  <span class="hljs-attr">model:</span> <span class="hljs-string">"gpt-4"</span>
  <span class="hljs-attr">apiKey:</span> <span class="hljs-string">"YOUR_API_KEY"</span>
</code></pre>
<h3 data-id="heading-11">核心特性</h3>
<ol>
<li>
<p><strong>Gateway 架构</strong></p>
<ul>
<li>统一的网关管理所有渠道和工具</li>
<li>支持多平台（Windows、macOS、Linux、iOS、Android）</li>
<li>可扩展的插件系统</li>
</ul>
</li>
<li>
<p><strong>多渠道支持</strong></p>
<ul>
<li>Telegram、Slack、Discord、Signal、iMessage、Microsoft Teams</li>
<li>WebChat 界面</li>
<li>统一的对话接口</li>
</ul>
</li>
<li>
<p><strong>浏览器控制</strong></p>
<ul>
<li>通过自然语言控制浏览器</li>
<li>支持网页操作、表单填写、数据提取</li>
<li>可视化操作反馈</li>
</ul>
</li>
<li>
<p><strong>本地记忆系统</strong></p>
<ul>
<li>每日日志和长期记忆</li>
<li>本地MD文件存储</li>
<li>人类可编辑和审查</li>
</ul>
</li>
<li>
<p><strong>技能系统（Skills）</strong></p>
<ul>
<li>可组合的技能库</li>
<li>支持自定义技能开发</li>
<li>自动触发和执行</li>
</ul>
</li>
<li>
<p><strong>远程访问</strong></p>
<ul>
<li>支持SSH隧道和Tailnet</li>
<li>安全的远程控制</li>
<li>多设备同步</li>
</ul>
</li>
<li>
<p><strong>开源生态</strong></p>
<ul>
<li>MIT协议，完全开源</li>
<li>支持本地大模型对接</li>
<li>可定制和扩展</li>
</ul>
</li>
<li>
<p><strong>安全控制</strong></p>
<ul>
<li>访问权限管理</li>
<li>认证和授权机制</li>
<li>可配置的安全策略</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">项目详细剖析</h2>
<h3 data-id="heading-13">核心差异分析：被过度炒作的"亮点"背后</h3>
<h4 data-id="heading-14">❶ 桌面系统高权限操作：不是做不到，而是敢不敢</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 实现了AI对桌面系统的完全控制，这是其他工具做不到的！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这不是技术壁垒，而是<strong>产品定位和风险承担的选择</strong>。</p>
<p><strong>技术层面</strong>：</p>
<ul>
<li>豆包、千问App等成熟产品<strong>完全有技术能力</strong>实现全量桌面权限</li>
<li>macOS 的 Accessibility API、Windows 的 UI Automation、Linux 的 D-Bus 都是公开的系统接口</li>
<li>任何有系统编程能力的开发者都能实现类似功能</li>
</ul>
<p><strong>为什么闭源产品不这么做？</strong></p>
<ol>
<li><strong>合规风险</strong>：面向大众用户，开放高权限意味着巨大的合规和隐私风险</li>
<li><strong>安全责任</strong>：厂商需要为安全漏洞承担责任，而开源项目由用户自行承担</li>
<li><strong>用户教育成本</strong>：普通用户难以正确配置安全策略，容易造成隐私泄露</li>
<li><strong>法律风险</strong>：高权限操作可能涉及法律边界，厂商需要谨慎</li>
</ol>
<p><strong>Moltbot 的选择</strong>：</p>
<ul>
<li>把权限交给用户，让技术党自己承担风险</li>
<li>这是<strong>人群定位的选择</strong>，而非技术鸿沟</li>
<li>适合技术极客，不适合普通用户</li>
</ul>
<p><strong>结论</strong>：这不是技术优势，而是<strong>风险转移</strong>。</p>
<h4 data-id="heading-15">❷ 全渠道打通社交/办公软件：本质是提前配置的结果</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 无缝打通了所有社交和办公软件，实现了真正的统一入口！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这本质上是<strong>提前配置的结果</strong>，而非独家技术。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>Telegram Bot API、Slack API、Discord API 都是公开的</li>
<li>需要的是：Bot Token、App Token、Webhook URL 等配置信息</li>
<li>配置流程：注册应用 → 获取Token → 配置到Moltbot</li>
</ul>
<p><strong>类比理解</strong>：
就像给豆包配置好邮箱账号，它就能自动发邮件一样。Moltbot 的"无缝体验"来自：</p>
<ol>
<li><strong>部署时的账号对接</strong>：用户需要手动配置各种服务的Token</li>
<li><strong>统一的接口封装</strong>：Moltbot 把这些API调用封装成了统一的接口</li>
<li><strong>配置流程整合</strong>：把配置流程整合到了开源框架里</li>
</ol>
<p><strong>这不是技术突破，而是"一站式折腾"</strong>：</p>
<ul>
<li>用户需要：注册多个服务、获取多个Token、配置多个参数</li>
<li>对于普通用户，这个配置成本可能比使用多个独立工具还高</li>
<li>对于技术极客，这种统一管理确实有价值</li>
</ul>
<p><strong>结论</strong>：这是<strong>工程整合</strong>，不是技术创新。</p>
<h4 data-id="heading-16">❸ 本地长期记忆：真正的亮点，但没那么神</h4>
<p><strong>被吹捧的说法</strong>：</p>
<blockquote>
<p>"Moltbot 的本地记忆系统比云端AI的上下文窗口更强大，实现了真正的长期记忆！"</p>
</blockquote>
<p><strong>真相分析</strong>：</p>
<p>这确实是 Moltbot <strong>为数不多的真正亮点</strong>，但也没那么神。</p>
<p><strong>技术实现</strong>：</p>
<ul>
<li>记忆存储在本地MD文件中</li>
<li>分两层：每日日志（daily logs）和长期沉淀（long-term memory）</li>
<li>重启不丢失，人类可编辑和审查</li>
</ul>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 比云端AI的上下文窗口更持久（不受Token限制）</li>
<li>✅ 成本更低（不需要为长上下文付费）</li>
<li>✅ 隐私可控（数据不上云）</li>
<li>✅ 人类可审查和编辑（透明度高）</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>❌ 这种本地存储的思路，闭源产品<strong>只要想做，完全可以复刻</strong></li>
<li>❌ 只是会增加开发和维护成本，但不存在技术壁垒</li>
<li>❌ 记忆检索和关联能力，相比向量数据库等专业方案，可能还有差距</li>
</ul>
<p><strong>结论</strong>：这是<strong>产品设计亮点</strong>，但不是不可复制的技术壁垒。</p>
<h4 data-id="heading-17">❹ 真正的核心差异：开源生态</h4>
<p><strong>唯一不可替代的优势</strong>：</p>
<p>Moltbot 真正的核心差异，<strong>只有一个：开源生态</strong>。</p>
<p><strong>开源带来的价值</strong>：</p>
<ol>
<li>
<p><strong>按需定制</strong></p>
<ul>
<li>可以修改代码，对接本地大模型</li>
<li>可以开发专属Agent和技能</li>
<li>可以整合智能家居、IoT设备</li>
</ul>
</li>
<li>
<p><strong>数据主权</strong></p>
<ul>
<li>代码完全透明，可审计</li>
<li>数据完全本地，不上云</li>
<li>不依赖任何第三方服务</li>
</ul>
</li>
<li>
<p><strong>社区生态</strong></p>
<ul>
<li>72k+ Stars，活跃的社区贡献</li>
<li>丰富的扩展和插件</li>
<li>持续的功能迭代</li>
</ul>
</li>
<li>
<p><strong>学习价值</strong></p>
<ul>
<li>可以学习AI代理的实现</li>
<li>可以理解Gateway架构设计</li>
<li>可以作为开发框架使用</li>
</ul>
</li>
</ol>
<p><strong>但这个优势的受众极窄</strong>：</p>
<ul>
<li>普通用户根本折腾不动</li>
<li>需要技术背景和开发能力</li>
<li>配置和维护成本高</li>
</ul>
<p><strong>结论</strong>：开源生态是 Moltbot 的<strong>唯一不可替代优势</strong>，但受众面窄。</p>
<h3 data-id="heading-18">为什么能火出圈？营销与情绪的双重作用</h3>
<h4 data-id="heading-19">✅ 踩中了"AI从聊天到执行"的趋势</h4>
<ul>
<li>把大模型的"嘴"接上了桌面系统的"手"</li>
<li>实现了任务闭环，戳中了大家对"全能AI管家"的期待</li>
<li>这是技术趋势，不是 Moltbot 的独家能力</li>
</ul>
<h4 data-id="heading-20">✅ 开源+本地部署的标签</h4>
<ul>
<li>精准击中了技术党对数据主权、隐私可控的需求</li>
<li>在AI隐私担忧的背景下，这个标签自带传播力</li>
<li>但普通用户可能并不关心这些</li>
</ul>
<h4 data-id="heading-21">✅ 营销造势到位</h4>
<ul>
<li>"贾维斯平替""7×24小时AI员工"等话题自带传播度</li>
<li>"带火Mac mini销量"等话题放大了实际价值</li>
<li>技术圈的集体狂欢，放大了项目影响力</li>
</ul>
<h3 data-id="heading-22">狂欢背后的槽点：理性看待风险</h3>
<h4 data-id="heading-23">☑ 上手门槛高</h4>
<p><strong>看似开箱即用，实则复杂需求需要大量调试</strong>：</p>
<ul>
<li>基础配置需要：安装、配置Token、设置权限</li>
<li>复杂需求需要：编写自定义技能、调试Agent逻辑</li>
<li>那些"躺床上重构网站"的案例，都是开发者的秀操作</li>
<li>小白照搬只会全是报错</li>
</ul>
<p><strong>真实使用体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">用户：<span class="hljs-string">"帮我整理一下桌面文件"</span>
Moltbot：<span class="hljs-string">"我需要访问文件系统权限..."</span>
用户：<span class="hljs-string">"好的，怎么配置？"</span>
Moltbot：<span class="hljs-string">"请修改 config.yaml，设置 fileSystem.accessLevel: 'full'..."</span>
用户：<span class="hljs-string">"然后呢？"</span>
Moltbot：<span class="hljs-string">"请确保系统权限已授予..."</span>
用户：<span class="hljs-string">"系统提示权限被拒绝..."</span>
Moltbot：<span class="hljs-string">"请检查系统设置 → 隐私与安全性 → 辅助功能..."</span>
用户：<span class="hljs-string">"算了，我还是手动整理吧..."</span>
</code></pre>
<h4 data-id="heading-24">☑ 安全风险拉满</h4>
<p><strong>默认开放高权限，配置不当就是隐私定时炸弹</strong>：</p>
<ul>
<li>目前已有大量实例存在认证漏洞</li>
<li>配置不当可能导致：
<ul>
<li>文件系统被恶意访问</li>
<li>敏感信息泄露</li>
<li>系统被远程控制</li>
<li>社交账号被盗用</li>
</ul>
</li>
</ul>
<p><strong>安全建议</strong>：</p>
<ul>
<li>仅在可信网络环境使用</li>
<li>严格配置访问权限</li>
<li>定期审查日志和记忆文件</li>
<li>不要在生产环境使用</li>
</ul>
<h4 data-id="heading-25">☑ 并非大众产品</h4>
<p><strong>轻度使用的自动化需求，现有闭源工具更省心</strong>：</p>
<ul>
<li>为了整理文件开放全量权限，性价比太低</li>
<li>普通用户的自动化需求，Mac Automator、Windows Task Scheduler 更简单</li>
<li>轻度AI助手需求，豆包、千问App 更省心</li>
</ul>
<p><strong>适用场景对比</strong>：</p>








































<table><thead><tr><th align="left">使用场景</th><th align="left">Moltbot</th><th align="left">闭源工具</th></tr></thead><tbody><tr><td align="left"><strong>重度定制需求</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>隐私敏感用户</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐</td></tr><tr><td align="left"><strong>技术极客</strong></td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">⭐⭐⭐</td></tr><tr><td align="left"><strong>普通用户轻度使用</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>快速上手</strong></td><td align="left">⭐⭐</td><td align="left">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>安全可控</strong></td><td align="left">⭐⭐（需自行保障）</td><td align="left">⭐⭐⭐⭐⭐（厂商保障）</td></tr></tbody></table>
<h3 data-id="heading-26">与其他AI桌面操作工具的深度对比</h3>
<h4 data-id="heading-27">vs 豆包/千问App：定位差异</h4>
<p><strong>豆包/千问App</strong>：</p>
<ul>
<li>定位：面向大众的AI助手</li>
<li>权限：受限，以安全为先</li>
<li>部署：云端为主，部分本地</li>
<li>定制：有限，依赖厂商能力</li>
<li>适用：普通用户日常使用</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>定位：面向技术极客的AI代理框架</li>
<li>权限：全量，用户自行承担风险</li>
<li>部署：完全本地，数据不上云</li>
<li>定制：高度可定制，开源生态</li>
<li>适用：技术极客、隐私敏感用户</li>
</ul>
<p><strong>核心差异</strong>：不是技术差异，而是<strong>产品定位和用户群体的差异</strong>。</p>
<h4 data-id="heading-28">vs AutoGPT/AutoGen：架构差异</h4>
<p><strong>AutoGPT/AutoGen</strong>：</p>
<ul>
<li>架构：Agent框架，专注于任务规划</li>
<li>能力：AI推理和规划能力强</li>
<li>工具：需要自行集成桌面操作能力</li>
<li>适用：研究和实验场景</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>架构：Gateway + Protocol，专注于系统集成</li>
<li>能力：系统集成和工具调用能力强</li>
<li>工具：内置丰富的桌面操作能力</li>
<li>适用：实际生产场景</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 更注重<strong>系统集成</strong>，AutoGPT 更注重<strong>AI推理</strong>。</p>
<h4 data-id="heading-29">vs 传统自动化工具：AI能力差异</h4>
<p><strong>传统自动化工具</strong>（Mac Automator、Windows Task Scheduler）：</p>
<ul>
<li>能力：基于规则的自动化</li>
<li>灵活性：需要预先定义规则</li>
<li>AI能力：无，无法理解自然语言</li>
<li>适用：固定流程的自动化</li>
</ul>
<p><strong>Moltbot</strong>：</p>
<ul>
<li>能力：基于AI的智能自动化</li>
<li>灵活性：可以理解自然语言，动态规划任务</li>
<li>AI能力：强，可以处理复杂和不确定的任务</li>
<li>适用：需要智能决策的自动化</li>
</ul>
<p><strong>核心差异</strong>：Moltbot 的<strong>AI能力</strong>是传统工具无法替代的。</p>
<h3 data-id="heading-30">技术实现深度剖析</h3>
<h4 data-id="heading-31">Gateway 架构的优势与局限</h4>
<p><strong>优势</strong>：</p>
<ul>
<li>解耦设计，易于扩展</li>
<li>统一协议，降低复杂度</li>
<li>状态管理，支持多设备同步</li>
</ul>
<p><strong>局限</strong>：</p>
<ul>
<li>Gateway 成为单点故障</li>
<li>协议转换可能带来性能损耗</li>
<li>状态同步在复杂场景下可能不一致</li>
</ul>
<h4 data-id="heading-32">本地记忆系统的设计</h4>
<p><strong>存储结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">.moltbot/</span>
<span class="hljs-string">├──</span> <span class="hljs-string">memory/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-string">daily/</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-number">2026-01-27.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-number">2026-01-28.</span><span class="hljs-string">md</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">long-term/</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">facts.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">├──</span> <span class="hljs-string">preferences.md</span>
<span class="hljs-string">│</span>       <span class="hljs-string">└──</span> <span class="hljs-string">relationships.md</span>
</code></pre>
<p><strong>检索机制</strong>：</p>
<ul>
<li>基于关键词匹配</li>
<li>结合时间戳和相关性</li>
<li>人类可编辑和审查</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>相比向量数据库，检索精度可能不足</li>
<li>大规模记忆管理可能成为瓶颈</li>
<li>需要人工维护和清理</li>
</ul>
<h4 data-id="heading-33">技能系统的扩展性</h4>
<p><strong>技能结构</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># skill.yaml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"file-organizer"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"自动整理文件"</span>
<span class="hljs-attr">triggers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"整理文件"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">"organize files"</span>
<span class="hljs-attr">actions:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">"file-system"</span>
    <span class="hljs-attr">operation:</span> <span class="hljs-string">"organize"</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">pattern:</span> <span class="hljs-string">"*.pdf"</span>
        <span class="hljs-attr">destination:</span> <span class="hljs-string">"Documents/PDFs"</span>
</code></pre>
<p><strong>扩展能力</strong>：</p>
<ul>
<li>支持自定义技能开发</li>
<li>技能可以组合和复用</li>
<li>社区贡献丰富的技能库</li>
</ul>
<p><strong>局限性</strong>：</p>
<ul>
<li>技能开发需要技术背景</li>
<li>技能之间的冲突处理机制不完善</li>
<li>缺乏技能市场和审核机制</li>
</ul>
<hr/>
<h2 data-id="heading-34">项目地址与资源</h2>
<h3 data-id="heading-35">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmolt.bot" target="_blank" title="https://molt.bot" ref="nofollow noopener noreferrer">molt.bot</a></li>
<li>📚 <strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot" target="_blank" title="https://docs.molt.bot" ref="nofollow noopener noreferrer">docs.molt.bot</a></li>
<li>🐛 <strong>Issues</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fissues" target="_blank" title="https://github.com/moltbot/moltbot/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
<li>💬 <strong>Discussions</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fdiscussions" target="_blank" title="https://github.com/moltbot/moltbot/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a></li>
<li>📦 <strong>Releases</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Freleases" target="_blank" title="https://github.com/moltbot/moltbot/releases" ref="nofollow noopener noreferrer">GitHub Releases</a></li>
</ul>
<h3 data-id="heading-36">相关资源</h3>
<ul>
<li><strong>作者博客</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsteipete.me" target="_blank" title="https://steipete.me" ref="nofollow noopener noreferrer">steipete.me</a></li>
<li><strong>Molty介绍</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.me" target="_blank" title="https://clawd.me" ref="nofollow noopener noreferrer">clawd.me</a></li>
<li><strong>社区贡献</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fgraphs%2Fcontributors" target="_blank" title="https://github.com/moltbot/moltbot/graphs/contributors" ref="nofollow noopener noreferrer">GitHub Contributors</a></li>
<li><strong>安全报告</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot%2Fsecurity" target="_blank" title="https://github.com/moltbot/moltbot/security" ref="nofollow noopener noreferrer">GitHub Security</a></li>
</ul>
<h3 data-id="heading-37">适用人群</h3>
<p><strong>强烈推荐</strong>：</p>
<ul>
<li>✅ 技术极客和开发者</li>
<li>✅ 对隐私敏感的用户</li>
<li>✅ 需要高度定制化AI助手的用户</li>
<li>✅ 愿意折腾配置的技术爱好者</li>
<li>✅ 想要学习AI代理实现的研究者</li>
</ul>
<p><strong>不推荐</strong>：</p>
<ul>
<li>❌ 普通用户（配置成本太高）</li>
<li>❌ 轻度使用需求（现有工具更省心）</li>
<li>❌ 对安全要求极高的生产环境（风险自行承担）</li>
<li>❌ 缺乏技术背景的用户（上手难度高）</li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析]]></title>    <link>https://juejin.cn/post/7600060691350405162</link>    <guid>https://juejin.cn/post/7600060691350405162</guid>    <pubDate>2026-01-28T12:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350405162" data-draft-id="7600219080046002219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析"/> <meta itemprop="keywords" content="Android,源码阅读,性能优化"/> <meta itemprop="datePublished" content="2026-01-28T12:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:20:27.000Z" title="Wed Jan 28 2026 12:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>网络连接是现代移动设备最核心的功能之一。从打开网页、收发消息，到视频通话、在线游戏，每一个网络操作背后，都有Android网络子系统在默默工作。而<strong>ConnectivityService</strong>，正是这个庞大系统的"中枢大脑"。</p>
<p>在本系列的第一篇文章中，我们将深入探索：</p>
<h3 data-id="heading-1">为什么ConnectivityService如此重要？</h3>
<p>想象这样一个场景：你正在用WiFi观看高清视频，突然WiFi信号变弱。Android系统需要在1秒内完成以下复杂操作：</p>
<ol>
<li><strong>监测WiFi质量下降</strong> - NetworkMonitor持续验证网络</li>
<li><strong>评估切换时机</strong> - NetworkRanker对比WiFi和移动网络得分</li>
<li><strong>准备移动网络</strong> - TelephonyNetworkFactory激活移动数据</li>
<li><strong>无缝切换</strong> - 在不中断视频的情况下迁移连接</li>
<li><strong>通知应用</strong> - 通过NetworkCallback告知网络变更</li>
</ol>
<p>这一切，都由ConnectivityService协调完成。它就像交通指挥中心，管理着设备上所有网络的"交通"。</p>
<h3 data-id="heading-2">本文内容概览</h3>
<ol>
<li>
<p><strong>ConnectivityService架构总览</strong></p>
<ul>
<li>核心职责与设计理念</li>
<li>与其他系统服务的关系</li>
<li>Android 15的架构演进</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制深度解析</strong></p>
<ul>
<li>NetworkAgent生命周期</li>
<li>网络状态上报流程</li>
<li>WiFi/Cellular的Agent实现</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>网络请求匹配机制</li>
<li>Factory评分与竞争</li>
<li>按需网络激活</li>
</ul>
</li>
<li>
<p><strong>网络状态管理</strong></p>
<ul>
<li>9种网络状态详解</li>
<li>状态机转换流程</li>
<li>Linger机制</li>
</ul>
</li>
<li>
<p><strong>WiFi与移动网络切换</strong></p>
<ul>
<li>切换决策算法</li>
<li>NetworkRanker评分机制</li>
<li>无缝切换实现</li>
</ul>
</li>
<li>
<p><strong>实战：网络问题诊断</strong></p>
<ul>
<li>WiFi连接失败排查</li>
<li>网络切换异常定位</li>
<li>性能优化技巧</li>
</ul>
</li>
</ol>
<p>让我们开始这段深入Android网络核心的旅程！</p>
<hr/>
<h2 data-id="heading-3">一、ConnectivityService架构总览</h2>
<h3 data-id="heading-4">1.1 ConnectivityService的核心职责</h3>
<p>ConnectivityService是Android网络栈的"总管家"，负责：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌────────────────────────────────────────┐
│      ConnectivityService核心职责        │
├────────────────────────────────────────┤
│ <span class="hljs-number">1.</span> 网络生命周期管理                     │
│    - 创建/销毁网络                      │
│    - 监控网络状态                       │
│    - 处理网络切换                       │
│                                        │
│ <span class="hljs-number">2.</span> 网络请求调度                         │
│    - 接收NetworkRequest                │
│    - 分发到对应NetworkFactory          │
│    - 管理请求优先级                     │
│                                        │
│ <span class="hljs-number">3.</span> 网络能力管理                         │
│    - NetworkCapabilities匹配           │
│    - 网络评分(NetworkScore)            │
│    - 默认网络选择                       │
│                                        │
│ <span class="hljs-number">4.</span> 网络验证                            │
│    - 触发NetworkMonitor验证            │
│    - 处理Captive Portal               │
│    - 管理部分连接状态                   │
│                                        │
│ <span class="hljs-number">5.</span> 应用网络权限                         │
│    - <span class="hljs-built_in">UID</span>网络访问控制                    │
│    - 后台数据限制                       │
│    - VPN隧道管理                       │
└────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">1.2 整体架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424ee010e395475da12c022ee30aad87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=tjXJzYy5buG2mXRro1kDAt7b2co%3D" alt="07-01-connectivityservice-architecture.png" loading="lazy"/></p>
<p><strong>架构分层说明</strong>：</p>
<h4 data-id="heading-6"><strong>应用层（Application Layer）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用使用ConnectivityManager API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
    context.getSystemService(Context.CONNECTIVITY_SERVICE);

<span class="hljs-comment">// 请求网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用</span>
    }
});
</code></pre>
<h4 data-id="heading-7"><strong>Framework层（ConnectivityService核心）</strong></h4>
<p>ConnectivityService源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/ConnectivityService.java
</code></pre>
<p><strong>核心数据结构</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../ConnectivityService.java (精简版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectivityService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IConnectivityManager</span>.Stub {

    <span class="hljs-comment">// 所有NetworkAgent的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;Messenger, NetworkAgentInfo&gt; mNetworkAgentInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkRequest的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SparseArray&lt;NetworkRequestInfo&gt; mNetworkRequests =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseArray</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkFactory的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;NetworkFactoryInfo&gt; mNetworkFactoryInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 当前默认网络</span>
    <span class="hljs-keyword">private</span> NetworkAgentInfo mDefaultNetwork;

    <span class="hljs-comment">// 网络评分器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRanker mNetworkRanker;

    <span class="hljs-comment">// 权限监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PermissionMonitor mPermissionMonitor;

    <span class="hljs-comment">// 核心方法：注册NetworkAgent</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNetworkAgent</span><span class="hljs-params">(Messenger messenger,
                                     NetworkInfo networkInfo,
                                     LinkProperties linkProperties,
                                     NetworkCapabilities networkCapabilities,
                                     <span class="hljs-type">int</span> currentScore,
                                     NetworkAgentConfig networkAgentConfig,
                                     <span class="hljs-type">int</span> factorySerialNumber)</span> {

        <span class="hljs-comment">// 1. 创建NetworkAgentInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">nai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncChannel</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Network</span>(mNextNetworkId++),
            networkInfo, linkProperties,
            networkCapabilities, currentScore,
            mContext, mHandler,
            networkAgentConfig, <span class="hljs-built_in">this</span>,
            mNetd, mDnsResolver,
            mNMS, factorySerialNumber);

        <span class="hljs-comment">// 2. 分配NetId</span>
        <span class="hljs-keyword">try</span> {
            mNetd.networkCreate(nai.network.netId,
                               NativeNetworkType.PHYSICAL);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            loge(<span class="hljs-string">"Error creating network "</span> + nai.network.netId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 添加到管理列表</span>
        mNetworkAgentInfos.put(messenger, nai);

        <span class="hljs-comment">// 4. 通知NetworkMonitor开始验证</span>
        nai.networkMonitor.start();

        <span class="hljs-comment">// 5. 匹配NetworkRequest</span>
        rematchNetworkAndRequests(nai, ReapUnvalidatedNetworks.DONT_REAP);
    }

    <span class="hljs-comment">// 核心方法：处理NetworkRequest</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestNetwork</span><span class="hljs-params">(NetworkCapabilities nc,
                               Messenger messenger,
                               <span class="hljs-type">int</span> timeoutMs,
                               IBinder binder,
                               <span class="hljs-type">int</span> legacyType,
                               <span class="hljs-meta">@CallbackFlags</span> <span class="hljs-type">int</span> callbackFlags)</span> {

        <span class="hljs-comment">// 1. 权限检查</span>
        enforceAccessPermission();

        <span class="hljs-comment">// 2. 创建NetworkRequestInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkRequestInfo</span> <span class="hljs-variable">nri</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(nc, legacyType,
            nextNetworkRequestId(), NetworkRequest.Type.REQUEST),
            binder);

        <span class="hljs-comment">// 3. 保存请求</span>
        mNetworkRequests.put(nri.request.requestId, nri);

        <span class="hljs-comment">// 4. 发送给所有NetworkFactory</span>
        <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {
            nfi.asyncChannel.sendMessage(
                android.net.NetworkFactory.CMD_REQUEST_NETWORK,
                nri.request);
        }

        <span class="hljs-comment">// 5. 尝试匹配现有网络</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">bestNetwork</span> <span class="hljs-operator">=</span>
            getBestNetwork(nri.request, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (bestNetwork != <span class="hljs-literal">null</span>) {
            callCallbackForRequest(nri, bestNetwork,
                                  ConnectivityManager.CALLBACK_AVAILABLE);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">1.3 与其他系统服务的关系</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌──────────────────────────────────────────────┐
│           ConnectivityService                │
│              (核心协调者)                      │
└─────────────┬────────────────────────────────┘
              │
    ┌─────────┼─────────┬──────────┬──────────┐
    │         │         │          │          │
    ▼         ▼         ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐
│NetworkStack│Netd │ │Telephony│ <span class="hljs-built_in">WiFi</span> │ │VpnManager
│        │ │      │ │Service │ |Service│ │        │
│验证网络  │ │路由  │ │蜂窝网络 │ |无线   │  │VPN隧道  │
│        │ │配置   │ │        │|      │  │        │
└────────┘ └──────┘ └────────┘ └──────┘ └────────┘
</code></pre>
<p><strong>关键交互</strong>：</p>
<ol>
<li><strong>与NetworkStack交互</strong> - 网络验证</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService触发验证</span>
nai.networkMonitor.notifyNetworkConnected(
    nai.linkProperties, nai.networkCapabilities);

<span class="hljs-comment">// NetworkStack执行HTTP探测</span>
<span class="hljs-comment">// 返回验证结果(VALID/PORTAL/INVALID)</span>
</code></pre>
<ol start="2">
<li><strong>与Netd交互</strong> - 路由配置</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置默认网络</span>
mNetd.networkSetDefault(nai.network.netId);

<span class="hljs-comment">// 添加路由规则</span>
mNetd.networkAddRoute(netId, ifname, destination, nexthop);
</code></pre>
<ol start="3">
<li><strong>与TelephonyService交互</strong> - 移动网络</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求移动数据连接</span>
telephonyNetworkFactory.needNetworkFor(request);

<span class="hljs-comment">// 接收数据连接状态变化</span>
onDataConnectionStateChanged(state, networkType);
</code></pre>
<h3 data-id="heading-9">1.4 Android 15的架构改进</h3>
<h4 data-id="heading-10"><strong>改进1：模块化NetworkStack</strong></h4>
<p>Android 10开始，NetworkStack从system_server独立为单独进程：</p>
<pre><code class="hljs language-markdown" lang="markdown">Android 9及之前:
┌────────────────────────┐
│    system<span class="hljs-emphasis">_server       │
│  ┌──────────────────┐  │
│  │ConnectivityService│  │
│  │  + NetworkMonitor │  │ ← 验证逻辑耦合
│  └──────────────────┘  │
└────────────────────────┘

Android 10+:
┌────────────────────────┐     ┌──────────────┐
│    system_</span>server       │     │NetworkStack  │
│  ┌──────────────────┐  │     │  进程         │
│  │ConnectivityService│◄─────►│┌────────────┐│
│  └──────────────────┘  │ AIDL││NetworkMonitor│
└────────────────────────┘     │└────────────┘│
<span class="hljs-code">                              └──────────────┘
                              ↑ 可独立更新
</span></code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>NetworkStack可通过APK更新，无需OTA</li>
<li>隔离故障，NetworkStack崩溃不影响system_server</li>
<li>更好的安全边界</li>
</ul>
<h4 data-id="heading-11"><strong>改进2：eBPF网络策略</strong></h4>
<p>Android 15使用eBPF替代iptables：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel BPF程序 - 快速数据包过滤</span>
SEC(<span class="hljs-string">"cgroup/sock"</span>)
<span class="hljs-type">int</span> <span class="hljs-title function_">bpf_cgroup_sock_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_sock *sk)</span> {
    __u32 uid = bpf_get_current_uid_gid();

    <span class="hljs-comment">// 查询UID是否允许访问网络</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_permission_value</span> *<span class="hljs-title">value</span> =</span>
        bpf_map_lookup_elem(&amp;uid_permission_map, &amp;uid);

    <span class="hljs-keyword">if</span> (value &amp;&amp; value-&gt;permission == PERMISSION_DENIED)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 拒绝连接</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 允许连接</span>
}
</code></pre>
<p><strong>性能提升</strong>：</p>
<ul>
<li>iptables规则匹配：O(n)</li>
<li>eBPF哈希查找：O(1)</li>
<li>延迟降低：~100μs → ~10μs</li>
</ul>
<h4 data-id="heading-12"><strong>改进3：Multi-Network API增强</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15新增：网络切片(Network Slicing)支持</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)  <span class="hljs-comment">// 企业专网</span>
    .setEnterpriseId(NET_ENTERPRISE_ID_1)      <span class="hljs-comment">// 切片ID</span>
    .build();

<span class="hljs-comment">// 5G网络切片可以为不同业务提供差异化QoS</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">二、NetworkAgent机制深度解析</h2>
<h3 data-id="heading-14">2.1 NetworkAgent是什么？</h3>
<p><strong>NetworkAgent</strong>是网络提供者（如WiFi、Cellular、Ethernet、VPN）与ConnectivityService之间的"信使"。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">WiFi</span>底层驱动
    ↓
<span class="hljs-built_in">WiFiNetworkAgent</span> (继承NetworkAgent)
    ↓ Messenger通信
ConnectivityService
</code></pre>
<h3 data-id="heading-15">2.2 NetworkAgent生命周期</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7e77cfb92d4126a7313de48768dae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=gKkU%2FnrZvJp7TwzFeV%2B%2FRB9HLPU%3D" alt="07-02-network-state-machine.png" loading="lazy"/></p>
<p><strong>9种核心状态详解</strong>：</p>
<h4 data-id="heading-16"><strong>1. DISCONNECTED（断开）</strong></h4>
<ul>
<li>初始状态，NetworkAgent尚未创建</li>
<li>或网络已完全销毁</li>
</ul>
<h4 data-id="heading-17"><strong>2. CONNECTING（连接中）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// WiFiNetworkAgent创建时</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WiFiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WiFiNetworkAgent</span><span class="hljs-params">(Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(context, looper, TAG,
              networkInfo,        <span class="hljs-comment">// 初始状态：CONNECTING</span>
              networkCapabilities,
              linkProperties,
              networkScore,
              config);
    }
}
</code></pre>
<h4 data-id="heading-18"><strong>3. CONNECTED（已连接）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 物理连接建立后，Agent上报</span>
sendLinkProperties(linkProperties);
sendNetworkCapabilities(networkCapabilities);
sendNetworkScore(score);

<span class="hljs-comment">// ConnectivityService收到后更新状态 → CONNECTED</span>
</code></pre>
<h4 data-id="heading-19"><strong>4. VALIDATING（验证中）</strong></h4>
<p>ConnectivityService自动触发NetworkMonitor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/NetworkStack/.../NetworkMonitor.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyNetworkConnected</span><span class="hljs-params">(LinkProperties lp,
                                   NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. HTTP探测</span>
    <span class="hljs-type">ValidationProbeEvent</span> <span class="hljs-variable">probeResult</span> <span class="hljs-operator">=</span>
        isCaptivePortal(mCleartextDnsNetwork);

    <span class="hljs-comment">// 2. HTTPS探测</span>
    probeResult = httpsProbe();

    <span class="hljs-comment">// 3. DNS探测</span>
    probeResult = sendDnsProbe(mPrivateDnsProviderHostname);

    <span class="hljs-comment">// 4. 返回验证结果</span>
    <span class="hljs-keyword">if</span> (allProbesSucceeded) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationResult</span>(
            NetworkValidationResult.VALID, ...);
    }
}
</code></pre>
<p><strong>验证URL（可配置）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP</span>
http://connectivitycheck.gstatic.com/generate_204

<span class="hljs-comment"># HTTPS</span>
https://www.google.com/generate_204

<span class="hljs-comment"># 返回HTTP 204表示验证通过</span>
</code></pre>
<h4 data-id="heading-20"><strong>5. VALIDATED（已验证）</strong></h4>
<p>验证通过后，网络成为"候选默认网络"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNetworkInfo</span><span class="hljs-params">(NetworkAgentInfo nai, NetworkInfo info)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> nai.getCurrentScore();

    <span class="hljs-keyword">if</span> (info.getDetailedState() == NetworkInfo.DetailedState.CONNECTED) {
        <span class="hljs-comment">// 网络验证通过，提升评分</span>
        nai.setScore(oldScore + <span class="hljs-number">10</span>);

        <span class="hljs-comment">// 重新评估默认网络</span>
        rematchAllNetworksAndRequests();
    }
}
</code></pre>
<h4 data-id="heading-21"><strong>6. CAPTIVE_PORTAL（强制门户）</strong></h4>
<p>检测到需要网页登录（如公共WiFi）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor检测到HTTP 302重定向</span>
<span class="hljs-keyword">if</span> (probeResult.isPortal()) {
    <span class="hljs-comment">// 显示登录通知</span>
    showSignInNotification(nai);

    <span class="hljs-comment">// 等待用户登录后重新验证</span>
    scheduleReevaluation(REEVALUATION_DELAY_MS);
}
</code></pre>
<p>用户体验：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 连接WiFi
<span class="hljs-bullet">2.</span> 系统检测到强制门户
<span class="hljs-bullet">3.</span> 弹出通知："需要登录WiFi网络"
<span class="hljs-bullet">4.</span> 点击通知打开登录页面
<span class="hljs-bullet">5.</span> 登录成功后自动重新验证
<span class="hljs-bullet">6.</span> 状态变为VALIDATED
</code></pre>
<h4 data-id="heading-22"><strong>7. LOSING（即将丢失）</strong></h4>
<p>Linger机制 - 给应用迁移时间：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../ConnectivityService.java</span>

<span class="hljs-comment">// 当更好的网络出现时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingerComplete</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// Linger倒计时开始（默认30秒）</span>
    nai.lingerExpiryMs = SystemClock.elapsedRealtime()
                        + mLingerDelayMs;

    <span class="hljs-comment">// 通知应用网络即将失去</span>
    <span class="hljs-keyword">for</span> (NetworkRequestInfo nri : nai.networkRequests) {
        callCallbackForRequest(nri, nai,
            ConnectivityManager.CALLBACK_LOSING,
            mLingerDelayMs);
    }
}
</code></pre>
<p>应用可以：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到CALLBACK_LOSING</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLosing</span><span class="hljs-params">(Network network, <span class="hljs-type">int</span> maxMsToLive)</span> {
    <span class="hljs-comment">// 还有maxMsToLive毫秒，快速迁移连接</span>
    <span class="hljs-keyword">if</span> (maxMsToLive &gt; <span class="hljs-number">0</span> &amp;&amp; maxMsToLive &lt; <span class="hljs-number">30000</span>) {
        <span class="hljs-comment">// 将TCP连接迁移到新网络</span>
        migrateConnectionsToNewNetwork();
    }
}
</code></pre>
<h4 data-id="heading-23"><strong>8. SUSPENDED（暂停）</strong></h4>
<p>网络物理可用但逻辑暂停（如飞行模式）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 进入飞行模式</span>
when (Intent.ACTION_AIRPLANE_MODE_CHANGED) {
    <span class="hljs-keyword">if</span> (isAirplaneModeOn) {
        <span class="hljs-comment">// 暂停所有网络（除了local-only）</span>
        <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
            <span class="hljs-keyword">if</span> (!nai.isLocalNetwork()) {
                nai.networkInfo.setDetailedState(
                    NetworkInfo.DetailedState.SUSPENDED,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-24"><strong>9. DISCONNECTING（断开中）</strong></h4>
<p>主动或被动断开：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主动断开</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Agent通知ConnectivityService</span>
    mAsyncChannel.sendMessage(CMD_NETWORK_DISCONNECT);
}

<span class="hljs-comment">// ConnectivityService处理</span>
<span class="hljs-keyword">case</span> CMD_NETWORK_DISCONNECT:
    <span class="hljs-comment">// 1. 移除路由</span>
    mNetd.networkDestroy(nai.network.netId);

    <span class="hljs-comment">// 2. 通知应用</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 3. 清理Agent</span>
    mNetworkAgentInfos.remove(nai.messenger);
    <span class="hljs-keyword">break</span>;
</code></pre>
<h3 data-id="heading-25">2.3 NetworkAgent实现示例：WiFiNetworkAgent</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Wifi/service/java/com/android/server/wifi/WifiNetworkAgent.java
</code></pre>
<p><strong>创建过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../WifiNetworkAgent.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WifiInfo mWifiInfo;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkAgent</span><span class="hljs-params">(Context context, Looper looper,
                           WifiInfo wifiInfo,
                           NetworkCapabilities nc,
                           LinkProperties lp,
                           NetworkScore score)</span> {
        <span class="hljs-built_in">super</span>(context, looper, <span class="hljs-string">"WifiNetworkAgent"</span>,
              nc, lp, score, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentConfig</span>.Builder().build(),
              NetworkProvider.ID_WIFI);

        mWifiInfo = wifiInfo;
        register();  <span class="hljs-comment">// 向ConnectivityService注册</span>
    }

    <span class="hljs-comment">// 当WiFi连接信息变化时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
        <span class="hljs-comment">// 更新WiFi特定能力</span>
        nc.setSignalStrength(mWifiInfo.getRssi());
        nc.setLinkUpstreamBandwidthKbps(
            mWifiInfo.getLinkSpeed() * <span class="hljs-number">1000</span>);

        <span class="hljs-built_in">super</span>.sendNetworkCapabilities(nc);
    }

    <span class="hljs-comment">// 当IP配置完成时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendLinkProperties</span><span class="hljs-params">(LinkProperties lp)</span> {
        <span class="hljs-comment">// WiFi接口名</span>
        lp.setInterfaceName(mWifiInfo.getInterfaceName());

        <span class="hljs-comment">// IP地址</span>
        lp.addLinkAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkAddress</span>(ipAddress, prefixLength));

        <span class="hljs-comment">// DNS服务器</span>
        <span class="hljs-keyword">for</span> (InetAddress dns : dnsServers) {
            lp.addDnsServer(dns);
        }

        <span class="hljs-comment">// 路由</span>
        lp.addRoute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RouteInfo</span>(destination, gateway, ifname));

        <span class="hljs-built_in">super</span>.sendLinkProperties(lp);
    }
}
</code></pre>
<p><strong>状态上报流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">WiFi驱动: DHCP成功获取IP
    ↓
WifiStateMachine: 解析IP配置
    ↓
WifiNetworkAgent.<span class="hljs-built_in">sendLinkProperties</span>(lp)
    ↓
NetworkAgent.<span class="hljs-built_in">sendMessage</span>(EVENT_NETWORK_PROPERTIES_CHANGED, lp)
    ↓
ConnectivityService收到消息
    ↓
<span class="hljs-built_in">updateLinkProperties</span>(nai, lp)
    ↓
触发NetworkMonitor验证
    ↓
<span class="hljs-built_in">notifyNetworkCallbacks</span>(CALLBACK_IP_CHANGED)
    ↓
应用收到<span class="hljs-built_in">onLinkPropertiesChanged</span>()回调
</code></pre>
<hr/>
<h2 data-id="heading-26">三、NetworkFactory工作原理</h2>
<h3 data-id="heading-27">3.1 NetworkFactory的角色</h3>
<p><strong>NetworkFactory</strong>是"网络工厂"，负责按需创建网络连接。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">应用请求：<span class="hljs-string">"我需要WiFi网络"</span>
    ↓
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-string">"哪个Factory能提供WiFi?"</span>
    ↓
<span class="hljs-symbol">WiFiNetworkFactory:</span> <span class="hljs-string">"我可以！"</span>
    ↓
WiFiNetworkFactory激活WiFi连接
    ↓
创建WifiNetworkAgent并注册
</code></pre>
<h3 data-id="heading-28">3.2 Factory注册与评分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Wifi/.../WifiNetworkFactory.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkFactory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkFactory</span><span class="hljs-params">(Looper looper, Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(looper, context, <span class="hljs-string">"WifiNetworkFactory"</span>,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>.Builder()
                  .addTransportType(TRANSPORT_WIFI)
                  .addCapability(NET_CAPABILITY_INTERNET)
                  .addCapability(NET_CAPABILITY_NOT_RESTRICTED)
                  .build());

        <span class="hljs-comment">// 注册到ConnectivityService</span>
        register();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">needNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// 收到ConnectivityService的网络请求</span>

        <span class="hljs-comment">// 1. 检查是否能满足请求</span>
        <span class="hljs-keyword">if</span> (!request.hasCapability(NET_CAPABILITY_INTERNET)) {
            <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 不处理</span>
        }

        <span class="hljs-comment">// 2. 启动WiFi扫描</span>
        mWifiManager.startScan();

        <span class="hljs-comment">// 3. 连接最佳AP</span>
        <span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> selectBestNetwork(scanResults);
        mWifiManager.connect(config, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// NetworkRequest被取消，可以断开WiFi</span>
        <span class="hljs-keyword">if</span> (noMoreRequests()) {
            mWifiManager.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-29">3.3 NetworkRequest匹配机制</h3>
<p><strong>NetworkCapabilities匹配规则</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkCapabilities.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">satisfiedByNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. Transport类型必须匹配</span>
    <span class="hljs-keyword">if</span> ((mTransportTypes &amp; nc.mTransportTypes) != mTransportTypes) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 必须的Capability都要有</span>
    <span class="hljs-keyword">if</span> ((mNetworkCapabilities &amp; nc.mNetworkCapabilities)
        != mNetworkCapabilities) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 禁止的Capability不能有</span>
    <span class="hljs-keyword">if</span> ((mUnwantedNetworkCapabilities &amp; nc.mNetworkCapabilities) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 链路上下行带宽满足要求</span>
    <span class="hljs-keyword">if</span> (getLinkDownstreamBandwidthKbps() &gt;
        nc.getLinkDownstreamBandwidthKbps()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>示例：复杂NetworkRequest</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用请求：高速、非计费、WiFi直连网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .addCapability(NET_CAPABILITY_NOT_METERED)  <span class="hljs-comment">// 非计费</span>
    .addTransportType(TRANSPORT_WIFI)           <span class="hljs-comment">// 必须WiFi</span>
    .setLinkDownstreamBandwidthKbps(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 至少10Mbps</span>
    .setNetworkSpecifier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WifiNetworkSpecifier</span>.Builder()
        .setSsid(<span class="hljs-string">"MyNetwork"</span>)                   <span class="hljs-comment">// 指定SSID</span>
        .build())
    .build();

cm.requestNetwork(request, callback);
</code></pre>
<p><strong>ConnectivityService匹配过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUpdatedScoreToFactories</span><span class="hljs-params">(NetworkRequest request)</span> {
    <span class="hljs-comment">// 遍历所有Factory</span>
    <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {

        <span class="hljs-comment">// 计算该Factory对这个Request的匹配得分</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> nfi.networkCapabilities
            .calculateScore(request.networkCapabilities);

        <span class="hljs-comment">// 发送REQUEST_NETWORK消息，附带分数</span>
        nfi.asyncChannel.sendMessage(CMD_REQUEST_NETWORK,
                                     score, <span class="hljs-number">0</span>, request);
    }
}
</code></pre>
<h3 data-id="heading-30">3.4 Factory竞争机制</h3>
<p>当多个Factory都能满足请求时，通过评分竞争：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkFactory.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> CMD_REQUEST_NETWORK:
            <span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (NetworkRequest) msg.obj;
            <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> msg.arg1;

            <span class="hljs-comment">// 如果分数为0，说明不匹配，释放网络</span>
            <span class="hljs-keyword">if</span> (score == <span class="hljs-number">0</span>) {
                releaseNetworkFor(request);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 分数越高，越应该积极响应</span>
                <span class="hljs-keyword">if</span> (score &gt; mCurrentScore) {
                    needNetworkFor(request);
                }
            }
            <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p><strong>实际场景</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">用户请求：联网但不指定类型

WiFiNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">60</span> (WiFi已连接)
  - 无需操作，WiFi已激活

TelephonyNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">50</span> (移动数据可用但未连接)
  - score &lt; WiFi，不激活移动数据

VpnNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">0</span> (VPN无法满足普通请求)
  - 释放VPN请求(如果有)

最终：使用WiFi网络
</code></pre>
<hr/>
<h2 data-id="heading-31">四、WiFi与移动网络切换</h2>
<h3 data-id="heading-32">4.1 切换触发条件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rematchAllNetworksAndRequests</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 重新评估所有网络</span>
    <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
        updateNetworkScore(nai);
    }

    <span class="hljs-comment">// 2. 重新选择最佳网络</span>
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">newDefault</span> <span class="hljs-operator">=</span> getBestNetwork();

    <span class="hljs-comment">// 3. 如果默认网络变化</span>
    <span class="hljs-keyword">if</span> (newDefault != mDefaultNetwork) {
        <span class="hljs-comment">// 触发切换</span>
        makeDefault(newDefault);
    }
}
</code></pre>
<p><strong>常见触发场景</strong>：</p>



































<table><thead><tr><th align="left">场景</th><th align="left">触发条件</th><th align="left">切换方向</th></tr></thead><tbody><tr><td align="left">WiFi信号变弱</td><td align="left">RSSI &lt; -75dBm</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">WiFi验证失败</td><td align="left">HTTP探测失败</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">移动数据打开</td><td align="left">用户手动启用</td><td align="left">无 → 移动网络</td></tr><tr><td align="left">连接到更好的WiFi</td><td align="left">新WiFi RSSI更高</td><td align="left">移动网络 → WiFi</td></tr><tr><td align="left">移出WiFi覆盖</td><td align="left">WiFi断开</td><td align="left">WiFi → 移动网络</td></tr></tbody></table>
<h3 data-id="heading-33">4.2 NetworkRanker评分算法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkRanker.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkRanker</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rankNetwork</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 1. 基础分数（Transport类型）</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            score += <span class="hljs-number">60</span>;  <span class="hljs-comment">// WiFi基础分60</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_CELLULAR)) {
            score += <span class="hljs-number">50</span>;  <span class="hljs-comment">// 移动网络基础分50</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_ETHERNET)) {
            score += <span class="hljs-number">70</span>;  <span class="hljs-comment">// 以太网基础分70</span>
        }

        <span class="hljs-comment">// 2. 验证状态加分</span>
        <span class="hljs-keyword">if</span> (nai.everValidated) {
            score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// 曾经验证通过+10分</span>
        }
        <span class="hljs-keyword">if</span> (nai.lastValidated) {
            score += <span class="hljs-number">20</span>;  <span class="hljs-comment">// 最近验证通过+20分</span>
        }

        <span class="hljs-comment">// 3. 网络能力加分</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_METERED)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非计费网络+5分</span>
        }
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_ROAMING)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非漫游+5分</span>
        }

        <span class="hljs-comment">// 4. 信号强度影响(WiFi)</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">rssi</span> <span class="hljs-operator">=</span> nai.networkCapabilities.getSignalStrength();
            <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">60</span>) score += <span class="hljs-number">10</span>;      <span class="hljs-comment">// 优秀信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">70</span>) score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 良好信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &lt; -<span class="hljs-number">80</span>) score -= <span class="hljs-number">10</span>; <span class="hljs-comment">// 差信号扣分</span>
        }

        <span class="hljs-comment">// 5. 链路速度影响</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">linkSpeed</span> <span class="hljs-operator">=</span> nai.networkCapabilities
            .getLinkDownstreamBandwidthKbps();
        <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">100000</span>) score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// &gt;100Mbps</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">10000</span>) score += <span class="hljs-number">5</span>; <span class="hljs-comment">// &gt;10Mbps</span>

        <span class="hljs-comment">// 6. VPN特殊处理</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_VPN)) {
            score += <span class="hljs-number">101</span>;  <span class="hljs-comment">// VPN总是优先</span>
        }

        <span class="hljs-keyword">return</span> score;
    }
}
</code></pre>
<p><strong>示例计算</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">场景：<span class="hljs-built_in">WiFi</span>和LTE同时可用

<span class="hljs-built_in">WiFi</span>网络:
  基础分: <span class="hljs-number">60</span>
  验证通过: +<span class="hljs-number">20</span>
  非计费: +<span class="hljs-number">5</span>
  信号强度(<span class="hljs-number">-65</span>dBm): +<span class="hljs-number">5</span>
  速度(<span class="hljs-number">50</span>Mbps): +<span class="hljs-number">5</span>
  总分: <span class="hljs-number">95</span>

LTE网络:
  基础分: <span class="hljs-number">50</span>
  验证通过: +<span class="hljs-number">20</span>
  漫游: <span class="hljs-number">0</span>
  总分: <span class="hljs-number">70</span>

结果：<span class="hljs-built_in">WiFi</span>得分更高，成为默认网络
</code></pre>
<h3 data-id="heading-34">4.3 无缝切换实现</h3>
<p><strong>第一阶段：准备新网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeDefault</span><span class="hljs-params">(NetworkAgentInfo newDefault)</span> {
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">oldDefault</span> <span class="hljs-operator">=</span> mDefaultNetwork;

    <span class="hljs-keyword">if</span> (oldDefault == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 首次建立默认网络</span>
        setDefaultNetwork(newDefault);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 1. 配置新网络路由（但不设为默认）</span>
    mNetd.networkAddRoute(newDefault.network.netId,
                         newDefault.linkProperties.getInterfaceName(),
                         <span class="hljs-string">"0.0.0.0/0"</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 2. 通知应用新网络可用</span>
    callCallbackForRequest(nri, newDefault, CALLBACK_AVAILABLE);

    <span class="hljs-comment">// 3. 给旧网络30秒Linger时间</span>
    handleLingerComplete(oldDefault);
}
</code></pre>
<p><strong>第二阶段：迁移连接</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到onAvailable回调</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
    <span class="hljs-comment">// 主动将Socket绑定到新网络</span>
    network.bindSocket(mySocket);

    <span class="hljs-comment">// 或使用Network.openConnection</span>
    <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
        network.openConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://example.com"</span>));
}
</code></pre>
<p><strong>第三阶段：切换默认网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Linger超时后，切换默认路由</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingered</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// 1. 移除旧网络默认路由</span>
    mNetd.networkClearDefault();

    <span class="hljs-comment">// 2. 设置新网络为默认</span>
    mNetd.networkSetDefault(mDefaultNetwork.network.netId);

    <span class="hljs-comment">// 3. 通知应用旧网络已丢失</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 4. 销毁旧NetworkAgent</span>
    nai.networkMonitor.stop();
    mNetworkAgentInfos.remove(nai.messenger);
}
</code></pre>
<p><strong>用户体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">时刻<span class="hljs-number">0</span>s: <span class="hljs-built_in">WiFi</span>信号变弱
  → NetworkMonitor检测到验证失败
  → NetworkRanker重新评分
  → LTE得分超过<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">0.1</span>s: 准备LTE网络
  → TelephonyNetworkFactory激活数据连接
  → <span class="hljs-number">3</span><span class="hljs-number">-5</span>秒后LTE连接建立

时刻<span class="hljs-number">5</span>s: 通知应用
  → 发送<span class="hljs-built_in">CALLBACK_AVAILABLE</span>(LTE)
  → 应用开始迁移连接

时刻<span class="hljs-number">5</span><span class="hljs-number">-35</span>s: Linger期
  → <span class="hljs-built_in">WiFi</span>和LTE并存
  → 新连接使用LTE
  → 旧连接仍用<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">35</span>s: 完成切换
  → <span class="hljs-built_in">WiFi</span>成为默认网络
  → 发送<span class="hljs-built_in">CALLBACK_LOST</span>(<span class="hljs-built_in">WiFi</span>)
  → <span class="hljs-built_in">WiFi</span>断开

用户感知：几乎无感知切换
</code></pre>
<h3 data-id="heading-35">4.4 避免频繁切换</h3>
<p><strong>问题</strong>：WiFi信号在临界值附近波动导致频繁切换</p>
<p><strong>解决方案：Hysteresis（滞后）机制</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkRanker.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldSwitchToNewNetwork</span><span class="hljs-params">(NetworkAgentInfo oldNai,
                                        NetworkAgentInfo newNai)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> rankNetwork(oldNai);
    <span class="hljs-type">int</span> <span class="hljs-variable">newScore</span> <span class="hljs-operator">=</span> rankNetwork(newNai);

    <span class="hljs-comment">// 新网络必须显著优于旧网络才切换</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HYSTERESIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 滞后阈值</span>

    <span class="hljs-keyword">if</span> (newScore &gt; oldScore + HYSTERESIS) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 新网络显著更好</span>
    }

    <span class="hljs-comment">// 避免抖动：仅当新网络远优于旧网络时才切换</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>效果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">不使用滞后:
时间  <span class="hljs-built_in">WiFi</span> RSSI  分数  默认网络
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到LTE
<span class="hljs-number">3</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    → 切换到<span class="hljs-built_in">WiFi</span>
<span class="hljs-number">4</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到<span class="hljs-built_in">LTE</span>  (频繁抖动)

使用滞后(阈值<span class="hljs-number">10</span>):
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    <span class="hljs-built_in">WiFi</span>  (<span class="hljs-number">60</span> vs <span class="hljs-number">50</span>+<span class="hljs-number">10</span>=<span class="hljs-number">60</span>, 不切换)
<span class="hljs-number">3</span>s    <span class="hljs-number">-77</span>dBm    <span class="hljs-number">55</span>    → 切换到<span class="hljs-built_in">LTE</span> (<span class="hljs-number">55</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>)
<span class="hljs-number">4</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">LTE</span>   (<span class="hljs-number">63</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>, 仍用LTE)
</code></pre>
<hr/>
<h2 data-id="heading-36">五、网络验证与Captive Portal处理</h2>
<h3 data-id="heading-37">5.1 NetworkMonitor验证流程</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/NetworkStack/src/android/net/captiveportal/CaptivePortalProbeResult.java
packages/modules/NetworkStack/src/android/net/NetworkMonitor.java
</code></pre>
<p><strong>完整验证流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateMachine</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTP_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"http://connectivitycheck.gstatic.com/generate_204"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTPS_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"https://www.google.com/generate_204"</span>;

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">isCaptivePortal</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. HTTP探测</span>
        <span class="hljs-type">CaptivePortalProbeResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTP);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-comment">// HTTP 204返回，说明可以访问互联网</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">if</span> (result.isPortal()) {
            <span class="hljs-comment">// HTTP重定向，说明是Captive Portal</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 2. HTTPS探测（更可靠）</span>
        result = sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTPS);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 3. DNS探测（检查DNS是否被劫持）</span>
        result = sendDnsProbe(mPrivateDnsProviderHostname);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendHttpProbe</span><span class="hljs-params">(
            Network network, <span class="hljs-type">int</span> validationType)</span> {

        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (validationType == VALIDATION_TYPE_HTTPS)
                ? mHttpsUrl : mHttpUrl;

        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            conn = (HttpURLConnection) network.openConnection(url);
            conn.setInstanceFollowRedirects(<span class="hljs-literal">false</span>);
            conn.setConnectTimeout(SOCKET_TIMEOUT_MS);
            conn.setReadTimeout(SOCKET_TIMEOUT_MS);
            conn.setUseCaches(<span class="hljs-literal">false</span>);
            conn.addRequestProperty(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"close"</span>);

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime();
            conn.getInputStream();
            <span class="hljs-type">long</span> <span class="hljs-variable">latency</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime() - start;

            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
            <span class="hljs-type">String</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> conn.getHeaderField(<span class="hljs-string">"Location"</span>);

            <span class="hljs-comment">// HTTP 204 = 验证通过</span>
            <span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">204</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.SUCCESS, latency);
            }

            <span class="hljs-comment">// HTTP 200 = 可能是Captive Portal</span>
            <span class="hljs-keyword">if</span> (responseCode &gt;= <span class="hljs-number">200</span> &amp;&amp; responseCode &lt;= <span class="hljs-number">399</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.PORTAL,
                    location, latency);
            }

            <span class="hljs-comment">// 其他 = 验证失败</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, latency);

        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-38">5.2 Captive Portal登录流程</h3>
<p><strong>场景：连接星巴克WiFi</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Step 1:</span> <span class="hljs-string">物理连接</span>
  <span class="hljs-string">用户:</span> <span class="hljs-string">选择"Starbucks</span> <span class="hljs-string">WiFi"</span>
  <span class="hljs-attr">WiFi:</span> <span class="hljs-string">DHCP获取IP</span> <span class="hljs-string">(192.168.1.100)</span>
  <span class="hljs-attr">WiFiNetworkAgent:</span> <span class="hljs-string">上报CONNECTED状态</span>

<span class="hljs-attr">Step 2:</span> <span class="hljs-string">NetworkMonitor验证</span>
  <span class="hljs-string">HTTP探测</span> <span class="hljs-string">→</span> <span class="hljs-string">http://connectivitycheck.gstatic.com/generate_204</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">302</span> <span class="hljs-string">Redirect</span>
  <span class="hljs-attr">Location:</span> <span class="hljs-string">http://星巴克登录页面.com/login</span>

  <span class="hljs-string">结论:</span> <span class="hljs-string">检测到Captive</span> <span class="hljs-string">Portal</span>

<span class="hljs-attr">Step 3:</span> <span class="hljs-string">通知用户</span>
  <span class="hljs-string">系统通知:</span> <span class="hljs-string">"需要登录WiFi网络"</span>
  <span class="hljs-string">点击后打开:</span> <span class="hljs-string">CaptivePortalLoginActivity</span>

<span class="hljs-attr">Step 4:</span> <span class="hljs-string">用户登录</span>
  <span class="hljs-string">WebView加载登录页</span>
  <span class="hljs-string">用户输入信息</span> <span class="hljs-string">/</span> <span class="hljs-string">同意条款</span>
  <span class="hljs-string">登录成功</span>

<span class="hljs-attr">Step 5:</span> <span class="hljs-string">重新验证</span>
  <span class="hljs-attr">NetworkMonitor:</span> <span class="hljs-string">再次发送HTTP探测</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">204</span> <span class="hljs-string">(验证通过)</span>
  <span class="hljs-string">状态:</span> <span class="hljs-string">CAPTIVE_PORTAL</span> <span class="hljs-string">→</span> <span class="hljs-string">VALIDATED</span>
</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CaptivePortalLoginActivity.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptivePortalLoginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-keyword">private</span> WebView mWebView;
    <span class="hljs-keyword">private</span> Network mNetwork;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);

        <span class="hljs-comment">// 获取要验证的网络</span>
        mNetwork = getIntent().getParcelableExtra(
            ConnectivityManager.EXTRA_NETWORK);

        <span class="hljs-comment">// 设置WebView使用该网络</span>
        mWebView = findViewById(R.id.webview);
        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PortalWebViewClient</span>());

        <span class="hljs-comment">// 加载登录页面</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getIntent().getStringExtra(
            ConnectivityManager.EXTRA_CAPTIVE_PORTAL_URL);
        mWebView.loadUrl(url);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PortalWebViewClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebViewClient</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
            <span class="hljs-comment">// 检查是否登录成功</span>
            <span class="hljs-keyword">if</span> (isSuccessUrl(url)) {
                <span class="hljs-comment">// 通知系统重新验证</span>
                notifyPortalLoginSuccess();
                finish();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPortalLoginSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> getSystemService(
            ConnectivityManager.class);
        cm.reportNetworkConnectivity(mNetwork, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-39">5.3 Android 15 Private DNS支持</h3>
<p><strong>DoT (DNS over TLS)</strong> - 加密DNS查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java - Android 15新增</span>
<span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendDnsProbe</span><span class="hljs-params">(String hostname)</span> {
    <span class="hljs-keyword">if</span> (isPrivateDnsValidationRequired()) {
        <span class="hljs-comment">// 使用TLS加密的DNS查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SSLSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> (SSLSocket)
                SSLSocketFactory.getDefault()
                    .createSocket(mPrivateDnsServerIp, <span class="hljs-number">853</span>);

            socket.startHandshake();

            <span class="hljs-comment">// 发送DNS查询</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> DnsPacket.createQuery(
                hostname, TYPE_A);
            socket.getOutputStream().write(query.getBytes());

            <span class="hljs-comment">// 接收响应</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> DnsPacket.parse(
                socket.getInputStream());

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.SUCCESS, <span class="hljs-number">0</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        }
    }
}
</code></pre>
<p><strong>配置Private DNS</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 → 网络和互联网 → 私人DNS</span>
adb shell settings put global private_dns_mode hostname
adb shell settings put global private_dns_specifier dns.google

<span class="hljs-comment"># 验证</span>
adb shell getprop net.dns1
<span class="hljs-comment"># 输出: 8.8.8.8 (使用Google Public DNS)</span>
</code></pre>
<hr/>
<h2 data-id="heading-40">六、实战：网络问题诊断</h2>
<h3 data-id="heading-41">6.1 WiFi连接失败排查</h3>
<p><strong>症状</strong>：WiFi显示"已连接"但无法上网</p>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 1: 检查网络状态</span>
adb shell dumpsys connectivity | grep -A 30 <span class="hljs-string">"Active networks"</span>

<span class="hljs-comment"># 输出示例:</span>
<span class="hljs-comment"># NetworkAgentInfo{ ni{[WIFI () - 100]}</span>
<span class="hljs-comment">#   network{151}  handle{151}</span>
<span class="hljs-comment">#   lp{{InterfaceName: wlan0</span>
<span class="hljs-comment">#       LinkAddresses: [ 192.168.1.100/24 ]</span>
<span class="hljs-comment">#       DnsAddresses: [ 192.168.1.1 ]</span>
<span class="hljs-comment">#       Routes: [ 0.0.0.0/0 -&gt; 192.168.1.1 wlan0 ]}}</span>
<span class="hljs-comment">#   nc{[ Transports: WIFI</span>
<span class="hljs-comment">#        Capabilities: NOT_METERED</span>
<span class="hljs-comment">#        NOT_ROAMING INTERNET NOT_SUSPENDED VALIDATED]}  ← 注意这里</span>
<span class="hljs-comment">#   Score{current=60 validated=true}}</span>

<span class="hljs-comment"># 关键字段:</span>
<span class="hljs-comment"># - VALIDATED: 网络已验证 (如果没有此字段，说明验证失败)</span>
<span class="hljs-comment"># - DnsAddresses: DNS服务器 (检查是否正确)</span>
<span class="hljs-comment"># - LinkAddresses: 本机IP (检查是否在合理范围)</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 2: 检查网络验证结果</span>
adb shell dumpsys network_stack | grep -i <span class="hljs-string">"validation"</span>

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=234 result=204 ...}  ← HTTP 204表示通过</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=5000 result=timeout ...}  ← 超时</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 3: 手动测试连通性</span>
adb shell

<span class="hljs-comment"># Ping网关</span>
ping -c 4 192.168.1.1
<span class="hljs-comment"># 如果不通，说明局域网问题</span>

<span class="hljs-comment"># Ping DNS</span>
ping -c 4 8.8.8.8
<span class="hljs-comment"># 如果不通，说明路由问题</span>

<span class="hljs-comment"># Ping域名</span>
ping -c 4 www.google.com
<span class="hljs-comment"># 如果不通，说明DNS问题</span>

<span class="hljs-comment"># HTTP测试</span>
curl -I http://connectivitycheck.gstatic.com/generate_204
<span class="hljs-comment"># 应该返回 HTTP/1.1 204 No Content</span>
</code></pre>
<p><strong>常见原因与解决方案</strong>：</p>



































<table><thead><tr><th align="left">现象</th><th align="left">原因</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">Ping网关不通</td><td align="left">WiFi驱动/硬件问题</td><td align="left">重启WiFi，检查驱动日志</td></tr><tr><td align="left">Ping DNS不通</td><td align="left">路由器未设置默认网关</td><td align="left">检查DHCP配置</td></tr><tr><td align="left">Ping域名不通</td><td align="left">DNS服务器故障</td><td align="left">手动设置DNS为8.8.8.8</td></tr><tr><td align="left">HTTP返回302</td><td align="left">Captive Portal</td><td align="left">打开浏览器完成登录</td></tr><tr><td align="left">HTTP超时</td><td align="left">防火墙拦截</td><td align="left">检查iptables规则</td></tr></tbody></table>
<h3 data-id="heading-42">6.2 网络切换异常定位</h3>
<p><strong>症状</strong>：从WiFi切换到移动网络后，应用无法联网</p>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看当前默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>
<span class="hljs-comment"># 输出: Active default network: 151</span>

<span class="hljs-comment"># 2. 查看该网络详情</span>
adb shell dumpsys connectivity networks 151
<span class="hljs-comment"># 确认是否是期望的网络(WiFi/LTE)</span>

<span class="hljs-comment"># 3. 检查应用是否绑定了旧网络</span>
adb shell dumpsys connectivity requests | grep <span class="hljs-string">"YOUR_PACKAGE"</span>
<span class="hljs-comment"># 输出会显示应用的NetworkRequest和绑定的Network</span>

<span class="hljs-comment"># 4. 抓取网络切换日志</span>
adb logcat -b all | grep -E <span class="hljs-string">"ConnectivityService|NetworkAgent"</span>
</code></pre>
<p><strong>典型日志分析</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 正常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [WIFI] validation passed
<span class="hljs-symbol">ConnectivityService:</span> Setting <span class="hljs-keyword">default</span> network <span class="hljs-keyword">to</span> <span class="hljs-number">151</span> (WIFI)
<span class="hljs-symbol">ConnectivityService:</span> Lingering network <span class="hljs-number">149</span> (MOBILE)
... (<span class="hljs-number">30</span>秒后)
<span class="hljs-symbol">ConnectivityService:</span> Tearing down network <span class="hljs-number">149</span>

# 异常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [MOBILE] validation failed
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-built_in">Not</span> setting <span class="hljs-keyword">default</span> <span class="hljs-keyword">to</span> unvalidated network
← 移动网络验证失败，未切换
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用代码修复：使用ConnectivityManager.NetworkCallback</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;
<span class="hljs-type">NetworkCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用时，将Socket绑定到新网络</span>
        <span class="hljs-keyword">try</span> {
            network.bindSocket(mySocket);
            <span class="hljs-comment">// 或重新创建连接</span>
            recreateConnection(network);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            Log.e(TAG, <span class="hljs-string">"Failed to bind socket"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLost</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络丢失时，清理资源</span>
        closeConnection();
    }
};

<span class="hljs-comment">// 注册监听</span>
cm.registerDefaultNetworkCallback(callback);
</code></pre>
<h3 data-id="heading-43">6.3 性能优化：减少网络切换延迟</h3>
<p><strong>问题</strong>：WiFi→LTE切换需要5-8秒</p>
<p><strong>优化方案</strong>：</p>
<h4 data-id="heading-44"><strong>方案1：预连接移动网络</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 12引入的MultiPath API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;

<span class="hljs-comment">// 请求同时使用WiFi和LTE</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 保持LTE连接处于激活状态</span>
        <span class="hljs-comment">// 当WiFi断开时，可立即切换</span>
    }
}, MULTI_PATH_PREFERENCE_PERFORMANCE);
</code></pre>
<h4 data-id="heading-45"><strong>方案2：快速失败检测</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 缩短验证超时时间</span>
adb shell settings put global captive_portal_http_url_timeout_ms <span class="hljs-number">3000</span>

<span class="hljs-comment">// 默认值：10000ms (10秒)</span>
<span class="hljs-comment">// 优化后：3000ms (3秒)</span>
</code></pre>
<h4 data-id="heading-46"><strong>方案3：应用层优化 - Happy Eyeballs</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RFC 8305: 同时尝试IPv4和IPv6，使用最快响应的</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">connectWithHappyEyeballs</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
    List&lt;InetAddress&gt; addresses =
        InetAddress.getAllByName(host);  <span class="hljs-comment">// 获取所有IP</span>

    List&lt;Future&lt;Socket&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-comment">// 并发连接所有地址</span>
    <span class="hljs-keyword">for</span> (InetAddress addr : addresses) {
        futures.add(executor.submit(() -&gt; {
            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
            socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(addr, port), <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">return</span> socket;
        }));
    }

    <span class="hljs-comment">// 返回第一个成功的连接</span>
    <span class="hljs-keyword">for</span> (Future&lt;Socket&gt; future : futures) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 继续尝试下一个</span>
        }
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"All connection attempts failed"</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-47">七、Android 15新特性</h2>
<h3 data-id="heading-48">7.1 Satellite Connectivity（卫星连接）</h3>
<p>Android 15新增卫星网络支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检测卫星网络可用性</span>
<span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">nc</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(network);

<span class="hljs-keyword">if</span> (nc.hasTransport(NetworkCapabilities.TRANSPORT_SATELLITE)) {
    <span class="hljs-comment">// 这是卫星连接</span>
    <span class="hljs-comment">// 特点：高延迟(500-800ms)、低带宽(几Kbps)、高成本</span>

    <span class="hljs-comment">// 应用应该:</span>
    <span class="hljs-comment">// 1. 使用文本通信而非语音/视频</span>
    <span class="hljs-comment">// 2. 压缩数据</span>
    <span class="hljs-comment">// 3. 减少请求频率</span>
}
</code></pre>
<h3 data-id="heading-49">7.2 Network Slicing (5G网络切片)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求特定的5G切片</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)
    .setEnterpriseId(NET_ENTERPRISE_ID_1)  <span class="hljs-comment">// 企业专网切片</span>
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 使用企业专网，享受:</span>
        <span class="hljs-comment">// - 更低延迟 (&lt;10ms)</span>
        <span class="hljs-comment">// - 更高带宽保证</span>
        <span class="hljs-comment">// - 更好的QoS</span>
    }
});
</code></pre>
<h3 data-id="heading-50">7.3 Thread Network Support</h3>
<p>Android 15支持Thread协议（用于智能家居）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 连接Thread网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addTransportType(NetworkCapabilities.TRANSPORT_THREAD)
    .build();

<span class="hljs-comment">// Thread特点:</span>
<span class="hljs-comment">// - 低功耗</span>
<span class="hljs-comment">// - Mesh网络</span>
<span class="hljs-comment">// - IPv6 only</span>
<span class="hljs-comment">// - 用于IoT设备</span>
</code></pre>
<hr/>
<h2 data-id="heading-51">八、总结与展望</h2>
<h3 data-id="heading-52">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>ConnectivityService架构</strong></p>
<ul>
<li>系统网络管理中枢</li>
<li>协调NetworkAgent和NetworkFactory</li>
<li>管理网络生命周期</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制</strong></p>
<ul>
<li>9种网络状态</li>
<li>状态机驱动</li>
<li>基于Messenger通信</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>按需激活网络</li>
<li>Capability匹配</li>
<li>评分竞争机制</li>
</ul>
</li>
<li>
<p><strong>网络切换</strong></p>
<ul>
<li>NetworkRanker评分算法</li>
<li>Linger优雅断开</li>
<li>Hysteresis防抖动</li>
</ul>
</li>
<li>
<p><strong>网络验证</strong></p>
<ul>
<li>HTTP/HTTPS探测</li>
<li>Captive Portal处理</li>
<li>Private DNS支持</li>
</ul>
</li>
</ol>
<h3 data-id="heading-53">8.2 ConnectivityService演进史</h3>













































<table><thead><tr><th align="left">版本</th><th align="left">关键变化</th><th align="left">影响</th></tr></thead><tbody><tr><td align="left">Android 5.0</td><td align="left">引入NetworkRequest/NetworkCallback</td><td align="left">应用可主动请求网络</td></tr><tr><td align="left">Android 7.0</td><td align="left">MultiNetwork API</td><td align="left">应用可同时使用多个网络</td></tr><tr><td align="left">Android 9.0</td><td align="left">强制使用HTTPS</td><td align="left">安全性提升</td></tr><tr><td align="left">Android 10.0</td><td align="left">NetworkStack模块化</td><td align="left">可独立更新</td></tr><tr><td align="left">Android 11.0</td><td align="left">eBPF网络策略</td><td align="left">性能大幅提升</td></tr><tr><td align="left">Android 12.0</td><td align="left">Network Slicing</td><td align="left">5G网络切片支持</td></tr><tr><td align="left">Android 15.0</td><td align="left">Satellite + Thread</td><td align="left">扩展连接场景</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 未来展望</h3>
<p><strong>趋势1：AI驱动的网络管理</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 未来可能的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AINetworkRanker</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.model = load_ml_model(<span class="hljs-string">"network_predictor.tflite"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_network_quality</span>(<span class="hljs-params">self, nai</span>):
        features = extract_features(nai)  <span class="hljs-comment"># RSSI, 速度, 延迟等</span>
        score = self.model.predict(features)
        <span class="hljs-keyword">return</span> score
</code></pre>
<p><strong>趋势2：Seamless Multi-Path</strong></p>
<ul>
<li>同时使用WiFi+5G，自动负载均衡</li>
<li>关键数据走5G（低延迟），大数据走WiFi（省流量）</li>
</ul>
<p><strong>趋势3：边缘计算集成</strong></p>
<ul>
<li>ConnectivityService感知MEC(多接入边缘计算)节点</li>
<li>自动将流量路由到最近的边缘服务器</li>
</ul>
<hr/>
<h2 data-id="heading-55">九、参考资源</h2>
<h3 data-id="heading-56">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ConnectivityService核心</span>
packages/modules/Connectivity/service/src/com/android/server/
├── ConnectivityService.java          <span class="hljs-comment"># 核心服务</span>
├── NetworkAgentInfo.java             <span class="hljs-comment"># Agent信息</span>
├── NetworkRequestInfo.java           <span class="hljs-comment"># 请求信息</span>
└── connectivity/
    ├── NetworkRanker.java            <span class="hljs-comment"># 网络排名</span>
    └── PermissionMonitor.java        <span class="hljs-comment"># 权限监控</span>

<span class="hljs-comment"># NetworkStack</span>
packages/modules/NetworkStack/src/
├── android/net/NetworkMonitor.java    <span class="hljs-comment"># 网络验证</span>
├── android/net/apf/                   <span class="hljs-comment"># APF包过滤</span>
└── android/net/ip/IpClient.java       <span class="hljs-comment"># IP配置</span>

<span class="hljs-comment"># NetworkAgent实现</span>
packages/modules/Wifi/service/java/com/android/server/wifi/
└── WifiNetworkAgent.java              <span class="hljs-comment"># WiFi Agent</span>

frameworks/opt/telephony/src/java/com/android/internal/telephony/
└── dataconnection/DcNetworkAgent.java <span class="hljs-comment"># Cellular Agent</span>
</code></pre>
<h3 data-id="heading-57">9.2 调试命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络</span>
adb shell dumpsys connectivity networks

<span class="hljs-comment"># 查看默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>

<span class="hljs-comment"># 查看NetworkRequest</span>
adb shell dumpsys connectivity requests

<span class="hljs-comment"># 查看NetworkFactory</span>
adb shell dumpsys connectivity factories

<span class="hljs-comment"># 触发网络验证</span>
adb shell cmd connectivity force-network-validation &lt;netId&gt;

<span class="hljs-comment"># 模拟网络切换</span>
adb shell svc wifi <span class="hljs-built_in">disable</span> &amp;&amp; <span class="hljs-built_in">sleep</span> 2 &amp;&amp; adb shell svc wifi <span class="hljs-built_in">enable</span>

<span class="hljs-comment"># 查看eBPF统计</span>
adb shell dumpsys connectivity trafficcontroller
</code></pre>
<h3 data-id="heading-58">9.3 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fconnect" target="_blank" title="https://source.android.com/docs/core/connect" ref="nofollow noopener noreferrer">Connectivity Overview</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FConnectivityManager" target="_blank" title="https://developer.android.com/reference/android/net/ConnectivityManager" ref="nofollow noopener noreferrer">ConnectivityManager API</a></li>
</ul>
<h3 data-id="heading-59">9.4 相关RFC</h3>
<ul>
<li>RFC 3093: DHCP</li>
<li>RFC 8305: Happy Eyeballs v2</li>
<li>RFC 7858: DNS over TLS</li>
<li>RFC 8910: Captive Portal API</li>
</ul>
<hr/>
<h2 data-id="heading-60">后记</h2>
<p>ConnectivityService是Android系统中最复杂的服务之一，管理着设备与外界的所有网络连接。从简单的WiFi连接，到复杂的多网络并发、VPN隧道、5G切片，ConnectivityService都能游刃有余地处理。</p>
<h3 data-id="heading-61">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7599330434427158579" target="_blank" title="https://juejin.cn/post/7599330434427158579">上一篇：Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆]]></title>    <link>https://juejin.cn/post/7600223321041780742</link>    <guid>https://juejin.cn/post/7600223321041780742</guid>    <pubDate>2026-01-28T12:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041780742" data-draft-id="7600223321041764358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-28T12:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别AI塑料感？通义Z-Image开源：6B参数要把“大众脸”送进历史堆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:43:25.000Z" title="Wed Jan 28 2026 12:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在AI绘画圈子里摸爬滚打了这么久，大家是不是都有点审美疲劳了？</p>
<p>不管是用哪个主流模型，跑多了你总能发现某种“诡异的默契”：千篇一律的完美光影，像是同一个整容医生刀下的“网红脸”，还有那种一眼就能看穿的塑料质感。这种“同质化”就像是AI绘画头顶的一层玻璃天花板，好看是好看，但总觉得少了点灵魂。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.07.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.07.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9204d8f4eb934554a925c3c99c74110b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=rq8skxf9Fxb%2FDMQ8H778w8AVheE%3D" alt="iShot_2026-01-28_20.34.07" loading="lazy"/></a></p>
<p>不过，就在2026年1月28日，阿里云通义团队搞了个大动作，开源了名为 <strong>Z-Image</strong> 的基座模型。看完这波技术细节，我感觉这层天花板可能要被敲出裂缝了。</p>
<h3 data-id="heading-0">不止是快，更重要的是“原生”</h3>
<p>这次发布的 Z-Image 是一个 6B（60亿）参数量的模型。在这个百亿甚至千亿参数横行的年代，6B听起来似乎不算庞然大物，但它的定位非常精准：<strong>做一个完美的“底座”</strong>。</p>
<p>这就得聊聊这次发布的一个核心关键词——<strong>非蒸馏</strong>。</p>
<p>之前的很多模型为了追求极速出图（比如所谓的Turbo版），往往使用了蒸馏技术。这就像是把浓缩咖啡兑水变成了速溶，速度是快了，但很多细腻的风味（权重分布）丢失了。而这次开源的 Z-Image Base 版本，保留了全量的权重分布。</p>
<p>这对我们这些喜欢折腾的人来说意味着什么？意味着它的可塑性极强。它原生支持 CFG 引导机制，更是 LoRA 和 ControlNet 的绝佳温床。如果你想训练一个属于自己独特画风的模型，或者要把自家猫主子炼进去，这个“非蒸馏”的底子绝对比那些为了速度而阉割过的模型要好用得多。</p>
<h3 data-id="heading-1">向“AI大众脸”宣战</h3>
<p>Z-Image 最让我感兴趣的，是它试图解决“人像同质化”的野心。</p>
<p>官方在技术文档里提到，他们优化了采样空间的分布。翻译成人话就是：它不再总是偷懒去抄那几张最稳妥的“标准脸”作业了。</p>
<p>以前我们抽卡，十张图里有八张脸型差不多，但在 Z-Image 的逻辑里，不同的种子和提示词会真的导向截然不同的面孔特征和构图逻辑。它不仅能驾驭从写实摄影到二次元动漫的跨度，更重要的是，它试图在多人场景中剥离那种“克隆人军团”的感觉。这对于需要做连环画、游戏资产或者故事绘本的创作者来说，简直是刚需中的刚需。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.13.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.13.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/305ccea409aa47f782969f9966ea046a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=5cwQ73kG%2Fi5IQaL%2FBVmDZoeIPj0%3D" alt="iShot_2026-01-28_20.34.13" loading="lazy"/></a></p>
<h3 data-id="heading-2">门槛打下来了，玩法升上去了</h3>
<p>聊聊配置。6B 的参数量，显存占用控制得相当克制。根据目前的测试，主流的消费级显卡（16GB显存就是一个很舒服的甜点区，甚至更低配置通过量化也能跑）完全能扛得住。</p>
<p>这意味着你不需要租昂贵的A100服务器，在自己的本地电脑上就能跑起来。对于开发者而言，它基于 S³-DiT（单流扩散Transformer）架构，推理效率本身就很高。</p>
<h3 data-id="heading-3">写在最后</h3>
<p>目前的AI绘图圈，缺的其实不是那种能一秒钟出图的工具，而是缺一个能真正理解“差异化”、能让创作者深度定制的扎实地基。</p>
<p>阿里云通义这次把 Z-Image 的基座开源，显然是想走“生态包围”的路子。虽然官方目前还没把牛吹上天，但作为开源社区的一员，我能预感到，很快 ModelScope 和 Hugging Face 上就会涌现出一大批基于 Z-Image 微调的惊艳模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-28_20.34.19-741x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-28_20.34.19-741x1024.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55ca5d878d684de0b4c5186d119efbf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770209008&amp;x-signature=WLZOeM%2BzyhQHG7AeNp1trvq85bg%3D" alt="iShot_2026-01-28_20.34.19" loading="lazy"/></a></p>
<p>如果你也受够了千篇一律的AI脸，或者想亲手炼制一个真正听话的模型，不妨去魔搭社区或者 GitHub 上把这个权重拉下来试试。毕竟，工具只是画笔，真正的艺术，还得看握笔的人怎么用。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这10个隐藏扣子skills，每一个都能让你封神]]></title>    <link>https://juejin.cn/post/7600238071038345225</link>    <guid>https://juejin.cn/post/7600238071038345225</guid>    <pubDate>2026-01-28T11:22:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038345225" data-draft-id="7600245693997006858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这10个隐藏扣子skills，每一个都能让你封神"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-28T11:22:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这10个隐藏扣子skills，每一个都能让你封神
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:04.000Z" title="Wed Jan 28 2026 11:22:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97c7a06ce0fa45b1a46f6e6866d2d5d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=wZoI9IkNjg7nu7mLeJ19HtJoGxI%3D" alt="图片" loading="lazy"/></p>
<p> </p>
<p>哈喽，大家好</p>
<p>我是阿星👋</p>
<p>自从扣子出了skills，阿星就在商店里各种收藏。</p>
<p>其中10个分享给大家。</p>
<p>（首先你需要下载个扣子app/去官网才能继续）——</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce5464243744156be0715faca3cc1c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=PTvm1vSq2FgU%2FShtz8R1mO7VD%2Fo%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1、新年绘本</h2>
<p>扣子新年绘本sklls是真的打印实体的画册啊，不是pdf啊。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/463d91fe32ec426dac2993febedf7feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=35cT%2Bncf1CXsjwQl%2FNuqe26DBCw%3D" alt="图片" loading="lazy"/></p>
<p>其实就是用这个新年绘本skills做的，很傻瓜的操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ed547c80e04ffdb58bcd778f5294e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=3XrRMEDGgu1vqu%2Bhra5AIEMun24%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38096c95ce004e9bacc9b8f4fa7b175d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=cIlcky7M2CNSYAyHywQ%2FhBCk1tI%3D" alt="图片" loading="lazy"/></p>
<p>把提示词发它，你可以改成自己或者宝宝的成长日记，</p>
<p>这样就更有纪念意义了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446077a7b5844c08a04980dbaf239aed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=LXFx58ZD%2Fp7CK2ISIRX80qGma2E%3D" alt="图片" loading="lazy"/></p>
<p>然后它就开始生成了，</p>
<p>一顿代码输出，</p>
<p>播放起来竟然还是带音频的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85bf515b373245d182d015ce093318dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=mPYNAShEVl0kninMm1EGVDloHZc%3D" alt="图片" loading="lazy"/></p>
<p>最后，一键打印坐等就ok啦~而且可以保存成pdf自己留个底儿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924b74fcdd7545ccbef28c16ad06a6c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UT5672LYt15XsQVj2mf8g4fEMcA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1edd4df6b80a42ebb532e3e83d2287ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=5wJsulfVModvA426HTcGPB9bwvA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">2、快速榨干一本书</h2>
<p>一款为AI提供的书籍内容深度处理工具，能提取核心知识并给出执行建议。</p>
<p>阿星用《理解媒介》试了试，可能因为这本书太长了（444页）只能先给大家展示一部分效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed66c22ba8f44404adc063068a6d86c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=masWyQlzqysQSrfmjHAGKAlkh54%3D" alt="图片" loading="lazy"/></p>
<p>这个工具最核心的提示词是四层榨取法—— <strong>通过骨架提取（定义核心概念）、肉质挖掘（配置3类案例）、精华萃取（跨行业迁移和执行SOP）、残渣利用（批判性视角）四个层次来解读。</strong></p>
<p>要求每个知识点必须包含： <strong>定义+逻辑+3个案例+跨行业迁移矩阵+执行</strong> SOP+批判性视角，每个案例还要80-150字加50-100字解读。主要文件如下，大家可以按照自己的理解尝试复现一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62050228aed64ee9a4cef3c7e7d6f673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=v9FxL4FUI5eW3wYc7pPJznSBwLI%3D" alt="图片" loading="lazy"/></p>
<p>从参考文件（references/）可以看出，作者对文章的结构进行了深层级、格式、 给样例等辅助操作才完成了内容结构的规划。</p>
<p>然后又通过脚本文件（scripts/）做了一些格式上的处理。比如markdown转pdf，但是我不建议大家用因为它要安装的包太多了。非常慢。直接看markdown就行了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8a185291984d5fbdb3b47dde66b5af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=vnL2ickTJy4cQyQ1uW8%2FImlKAGA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">3、AI漫剧分镜提示词</h2>
<p>看到这个漫剧skills我一下就被吸引住了，</p>
<p>因为最近漫剧实在是太火了奈何阿星自己没学过编剧，</p>
<p>我还以为是随便给我生成个表格，结果它咔咔生成了好几分钟真的太专业了。</p>
<p>然后可以得到用来做整个漫剧图片的提示词。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21775308dd1a426ca3e2f45d766f488a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Z9EejsKkTRNFE5KKjSNqqxgRi7Q%3D" alt="图片" loading="lazy"/></p>
<p>我们来看看产出物怎么样。</p>
<p>我惊喜的是它连人物一致性的关键词都给了。</p>
<p>阿星之前一直不想尝试漫剧就是因为定角色太麻烦了，这个skills竟然连主角的关键词都给我定好了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6cd0cf004f479ba33420130d7c1640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=rc3Ys1LkrLUFRhPxw4df4CJ52xA%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">4、答案之书</h2>
<p>看到这个答案之书sklls阿星要笑出猪叫，我最近正在疯狂搜集这类视觉。</p>
<p>它的用法就是你跟他提问，它直接让你抽卡来回答你。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebae3e3c83a6400b9d32d07de340848d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=Wom13pGRhAdFrP15EoFHOOxGLxE%3D" alt="图片" loading="lazy"/></p>
<p>大家也可以利用media pipe</p>
<p>做一个类似的演示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bbe519dda21467dadfb9ce5eb6e6796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=76ibMNFEAIANQ1G0oEpWvHNgvMo%3D" alt="图片" loading="lazy"/></p>
<p>这个sklls我建议大家在PC端用。因为它涉及到手势调用。手机摄像头是启动失败的无法感受神奇交互。</p>
<p>我问它我是否会成为中国AI赛道第一IP，他就会生成一个脚本，结果还不错必然登顶。棒！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0152a08effca4e91a8ab07c8dc9ecb25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=yfS1RFpL2hW%2BaEDMGmnQieDx5SE%3D" alt="图片" loading="lazy"/></p>
<p>原理是里面预制了不少答案，随机给我抽了一个。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd26d7218a044baeb3556cda7e5bbecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=xAifP9vuesyBZMrHRrubg4CthY4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">5、二次元谷子定制助手</h2>
<p>二次元们可以用它定制周边，让心爱角色触手可及。</p>
<p>重点是生成完了还能直接变视频，擦除背景，</p>
<p>主要优点是比较方便我们二次修改。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1a09c5b5be4a8397bf643db0da52c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=9rnRxjovGTdsBSw3MMFXkLqIagU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">6、Obsidian入门</h2>
<p>众所周知Obsidian摸索起来费老大劲，要学的实在太多了。</p>
<p>之前我还看看到过类似的书专门讲Obsidian的。那也太痛苦了，学个Obsidian还得看书。</p>
<p>这个技能提供Obsidian咋用的知识，适合老baby们入坑。</p>
<p>像我很久没用这个Obsidian都是因为学习成本太高，现在好了，需要什么学什么吧～</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0f6d6287204dc680d4a72660b76889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=DaJR1jZA6R8do54ZOjG2KgmFfIM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-6">7、DanKoe爆文写作</h2>
<p>Dan Koe风格爆文生成skills适合实在不会写作的同学，</p>
<p>可以一键生成标题、深度内容、封面及网页。</p>
<p>我建议大家但凡会写作就要自己动手写，让AI只是做辅助</p>
<p><strong>大神的写作模板只适合完全没有基础的同学模仿</strong> ，不适合想打造个人特色的同学。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75116bdf149144e598dde90c1b402035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=7WqTsu5AkFdpMU6PM7JgR0Np81g%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">8、SEO专家</h2>
<p>SEO专家是一个搜索引擎优化辅助skills。</p>
<p>它本质上是两个脚本构成的，</p>
<ol>
<li>
<ol>
<li>seo_analyzer.py - 自动化 SEO 分析脚本</li>
</ol>
</li>
<li>
<ol start="2">
<li>generate_sitemap.py - XML 站点地图生成器</li>
</ol>
</li>
</ol>
<p>特别跟小白同学说下，它和我们平常理解的seo标题文章生成不一样，</p>
<p>是针对项目工程本身的代码结构的检查，并且会给出详细的建议。</p>
<p>甚至帮你生成站点地图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a3979d1258412b930dff4224347390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=iZRK%2FbRe5zIrh0CI%2FkwvTs5SRD4%3D" alt="图片" loading="lazy"/></p>
<p>特别是站点地图，初学者可能不知道这个东西。但是这个skills可以直接生成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25df68e0da0453d8955cd92714f5fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=N2HaviMPHxNjrlSdMScxN0zQcXY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">9、文章一键转PPT</h2>
<p>将长篇文章智能转化为专业级HTML演示文稿，</p>
<p>支持商务、科技、极客等多维视觉风格。可以体验一下，</p>
<p>正儿八经做大家最好还是在本地编辑一下再。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920dc1bf98414d218ad1369da5df8e00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=spr25VACUtk%2B3bw5795dahf759U%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">10、新年人生四宫格</h2>
<p>新年人生四宫格技能是我最喜欢的一个。</p>
<p>过年的时候用它当头像太方便啦～</p>
<p>新的一年换上红红的头像，感觉寓意也很好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845792dd7cc84b698e34ee46de366003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=XPOs5lQfx8bVfLn2PPUqoIqoKI0%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ba8571d32984c2eaa760bc7b3d16e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=1Rp6wK7ehUbM1MY9shhHorAvRKo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c944ecc39d0445ca9ff653cb8a4b47e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204214&amp;x-signature=UHRm0ccz%2BwIn4qXjfck%2Bh08WoXQ%3D" alt="图片" loading="lazy"/></p>
<p>ok，我是阿星，更多AI应用，我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（一）：初识 Compose]]></title>    <link>https://juejin.cn/post/7600032104249032767</link>    <guid>https://juejin.cn/post/7600032104249032767</guid>    <pubDate>2026-01-28T11:22:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104249032767" data-draft-id="7600060691350290474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（一）：初识 Compose"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-28T11:22:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（一）：初识 Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:22:16.000Z" title="Wed Jan 28 2026 11:22:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>声明式 UI 的时代来临，让我们一起开启 Compose 学习之旅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>如果你还在用 XML 写布局、用 <code>findViewById</code> 查找视图、用 <code>setOnClickListener</code> 设置点击事件，那么你可能已经落后于时代了。</p>
<p>2021 年，Google 正式发布 <strong>Jetpack Compose 1.0</strong> 稳定版，标志着 Android 开发进入了<strong>声明式 UI</strong> 的新时代。今天，无论是 Google 官方应用、全新的 Android Studio，还是各大互联网厂的新项目，Compose 已经成为首选方案。</p>
<p>作为 Android 开发者，学习 Compose 不再是"可选项"，而是"必修课"。</p>
<p>本系列文章将带你从入门到精通，系统掌握 Jetpack Compose。今天的第一篇，我们先来打好基础，了解 Compose 是什么，并完成环境搭建。</p>
<hr/>
<h2 data-id="heading-1">一、Compose 是什么？</h2>
<h3 data-id="heading-2">1.1 官方定义</h3>
<p><strong>Jetpack Compose</strong> 是 Google 推出的用于构建 Android 界面的<strong>现代声明式 UI 工具包</strong>。它基于 Kotlin 语言，采用函数式编程思想，让界面开发变得更加简洁、直观和高效。</p>
<h3 data-id="heading-3">1.2 传统方式 vs Compose</h3>
<p>让我们用一段代码直观感受两者的区别：</p>
<p><strong>传统 View 系统（命令式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// XML 布局文件</span>
&lt;TextView
    android:id=<span class="hljs-string">"@+id/textView"</span>
    android:layout_width=<span class="hljs-string">"wrap_content"</span>
    android:layout_height=<span class="hljs-string">"wrap_content"</span> /&gt;

<span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">val</span> textView = findViewById&lt;TextView&gt;(R.id.textView)
textView.text = <span class="hljs-string">"Hello World"</span>
textView.setTextColor(Color.BLUE)
textView.setOnClickListener {
    <span class="hljs-comment">// 处理点击</span>
}
</code></pre>
<p><strong>Compose（声明式）：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>"</span>,
        color = Color.Blue,
        modifier = Modifier.clickable {
            <span class="hljs-comment">// 处理点击</span>
        }
    )
}
</code></pre>
<p>可以看到，Compose 的代码更加简洁，布局与逻辑写在一起，无需在 XML 和 Kotlin 之间来回切换。</p>
<h3 data-id="heading-4">1.3 核心特性</h3>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>声明式语法</strong></td><td>描述"界面应该是什么样子"，而不是"如何创建界面"</td></tr><tr><td><strong>纯 Kotlin 实现</strong></td><td>无需 XML，类型安全、智能提示更好</td></tr><tr><td><strong>组合而非继承</strong></td><td>通过组合小型组件构建复杂界面，符合单一职责原则</td></tr><tr><td><strong>智能重组</strong></td><td>系统自动跟踪状态变化，只更新必要的部分</td></tr><tr><td><strong>实时预览</strong></td><td>Android Studio 实时预览，无需运行应用</td></tr></tbody></table>
<h3 data-id="heading-5">1.4 为什么要学 Compose？</h3>
<p><strong>传统 View 系统的痛点：</strong></p>
<ol>
<li><strong>命令式编程复杂</strong> - 手动管理视图状态，<code>findViewById</code> 容易出错</li>
<li><strong>XML 与代码分离</strong> - 布局在 XML，逻辑在 Kotlin，维护困难</li>
<li><strong>状态管理困难</strong> - 状态分散在各个 View 中，数据流难以追踪</li>
<li><strong>重复代码多</strong> - 自定义 View 需要继承并重写多个方法</li>
</ol>
<p><strong>Compose 的优势：</strong></p>
<ul>
<li>代码量减少 <strong>50%+</strong></li>
<li>开发效率大幅提升</li>
<li>状态管理更加清晰</li>
<li>跨平台支持（Compose Multiplatform）</li>
</ul>
<p><strong>行业趋势：</strong></p>
<ul>
<li>iOS：SwiftUI 已成为推荐方案</li>
<li>Web：React、Vue 早已普及声明式开发</li>
<li>Android：Compose 正在快速普及，成为默认选择</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、环境搭建</h2>
<h3 data-id="heading-7">2.1 系统要求</h3>
<ul>
<li><strong>Android Studio</strong>：Arctic Fox (2020.3.1) 或更高版本（推荐最新稳定版）</li>
<li><strong>Kotlin</strong>：1.5.10 或更高版本</li>
<li><strong>minSdk</strong>：API 21 (Android 5.0) 或更高</li>
</ul>
<h3 data-id="heading-8">2.2 创建新项目</h3>
<p><strong>步骤 1：新建项目</strong></p>
<p>打开 Android Studio，选择 <strong>New Project</strong> → <strong>Empty Activity</strong>（注意选择 Compose 模板）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87899d9bc93c46ec90113fad7f9f47f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YK56Zi_5rab5rab5rab5rab5rab5rab5rab5rab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204608&amp;x-signature=7m36cG41AEg1t2e%2BTuXXW1G4dSM%3D" alt="image.png" loading="lazy"/>
<strong>步骤 2：配置项目</strong></p>
<ul>
<li><strong>Name</strong>：ComposeDemo</li>
<li><strong>Package name</strong>：com.example.composedemo</li>
<li><strong>Minimum SDK</strong>：API 21: Android 5.0 (Lollipop)</li>
<li><strong>Build configuration language</strong>：Kotlin DSL (build.gradle.kts)</li>
</ul>
<blockquote>
<p>💡 <strong>注意</strong>：确保勾选 "Use Compose" 选项（新版 Android Studio 默认启用）。</p>
</blockquote>
<p><strong>步骤 3：查看自动生成的配置</strong></p>
<p>项目创建完成后，<code>build.gradle.kts</code> (Module: app) 会自动包含以下配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }

    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span> <span class="hljs-comment">// 根据实际版本调整</span>
    }

    kotlinOptions {
        jvmTarget = <span class="hljs-string">"1.8"</span>
    }
}

dependencies {
    <span class="hljs-comment">// Compose BOM（物料清单）</span>
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    androidTestImplementation(composeBom)

    <span class="hljs-comment">// 核心库</span>
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-graphics"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    
    <span class="hljs-comment">// Material Design 3</span>
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    
    <span class="hljs-comment">// 调试工具</span>
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-test-manifest"</span>)
}
</code></pre>
<h3 data-id="heading-9">2.3 现有项目添加 Compose</h3>
<p>如果是现有项目，需要手动添加配置：</p>
<p><strong>build.gradle.kts (Module: app)：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        compose = <span class="hljs-literal">true</span>
    }
    
    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.10"</span>
    }
}

dependencies {
    <span class="hljs-keyword">val</span> composeBom = platform(<span class="hljs-string">"androidx.compose:compose-bom:2024.02.00"</span>)
    implementation(composeBom)
    
    implementation(<span class="hljs-string">"androidx.compose.ui:ui"</span>)
    implementation(<span class="hljs-string">"androidx.compose.material3:material3"</span>)
    implementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling-preview"</span>)
    debugImplementation(<span class="hljs-string">"androidx.compose.ui:ui-tooling"</span>)
}
</code></pre>
<h3 data-id="heading-10">2.4 第一个 Compose 应用</h3>
<p>创建项目后，<code>MainActivity.kt</code> 已经自动生成基础代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            ComposeDemoTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    Greeting(<span class="hljs-string">"Android"</span>)
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    Text(
        text = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>!"</span>,
        modifier = modifier
    )
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingPreview</span><span class="hljs-params">()</span></span> {
    ComposeDemoTheme {
        Greeting(<span class="hljs-string">"Android"</span>)
    }
}
</code></pre>
<p><strong>运行应用：</strong></p>
<p>点击 Android Studio 的 <strong>Run</strong> 按钮（▶），即可在模拟器或真机上看到 "Hello Android!" 的界面。</p>
<p><strong>实时预览：</strong></p>
<p>在 <code>GreetingPreview</code> 函数右侧，点击 <strong>Split</strong> 或 <strong>Design</strong> 模式，即可看到实时预览效果，无需运行应用！</p>
<hr/>
<h2 data-id="heading-11">三、Composable 函数基础</h2>
<h3 data-id="heading-12">3.1 什么是 Composable 函数？</h3>
<p><strong>Composable 函数</strong>是 Compose 的基本构建块，用 <code>@Composable</code> 注解标记。它描述了 UI 的某一部分，类似于传统 View 系统中的自定义 View。</p>
<p><strong>基本结构：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// UI 描述</span>
}
</code></pre>
<h3 data-id="heading-13">3.2 命名规范</h3>
<ul>
<li>Composable 函数名使用<strong>大驼峰命名法</strong>（PascalCase）</li>
<li>名词或名词短语，描述 UI 的功能</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">()</span></span> { }

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginButton</span><span class="hljs-params">()</span></span> { }

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">userProfile</span><span class="hljs-params">()</span></span> { }  <span class="hljs-comment">// 小写开头</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showButton</span><span class="hljs-params">()</span></span> { }   <span class="hljs-comment">// 动词开头</span>
</code></pre>
<h3 data-id="heading-14">3.3 参数传递</h3>
<p>Composable 函数可以接受参数，实现数据驱动的 UI：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Greeting</span><span class="hljs-params">(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">Int</span>)</span></span> {
    Text(text = <span class="hljs-string">"Hello, <span class="hljs-variable">$name</span>! You are <span class="hljs-variable">$age</span> years old."</span>)
}

<span class="hljs-comment">// 使用</span>
Greeting(name = <span class="hljs-string">"张三"</span>, age = <span class="hljs-number">25</span>)
</code></pre>
<h3 data-id="heading-15">3.4 Modifier 基础</h3>
<p><strong>Modifier</strong> 是 Compose 中用于修饰 UI 元素的重要工具，可以设置尺寸、边距、点击事件等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StyledText</span><span class="hljs-params">()</span></span> {
    Text(
        text = <span class="hljs-string">"Hello Compose"</span>,
        modifier = Modifier
            .padding(<span class="hljs-number">16.</span>dp)           <span class="hljs-comment">// 内边距</span>
            .fillMaxWidth()           <span class="hljs-comment">// 宽度填满父容器</span>
            .height(<span class="hljs-number">50.</span>dp)            <span class="hljs-comment">// 高度</span>
            .background(Color.LightGray) <span class="hljs-comment">// 背景色</span>
            .clickable {              <span class="hljs-comment">// 点击事件</span>
                <span class="hljs-comment">// 处理点击</span>
            }
    )
}
</code></pre>
<p><strong>常用 Modifier：</strong></p>

































<table><thead><tr><th>Modifier</th><th>作用</th></tr></thead><tbody><tr><td><code>padding()</code></td><td>设置内边距</td></tr><tr><td><code>fillMaxWidth()</code> / <code>fillMaxHeight()</code></td><td>填满父容器宽度/高度</td></tr><tr><td><code>size()</code> / <code>width()</code> / <code>height()</code></td><td>设置尺寸</td></tr><tr><td><code>background()</code></td><td>设置背景色</td></tr><tr><td><code>clickable()</code></td><td>添加点击事件</td></tr><tr><td><code>border()</code></td><td>添加边框</td></tr></tbody></table>
<h3 data-id="heading-16">3.5 预览注解</h3>
<p><code>@Preview</code> 注解用于在 Android Studio 中显示 Composable 的预览效果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(
    name = <span class="hljs-string">"默认预览"</span>,
    showBackground = true,      // 显示背景
    backgroundColor = 0xFFFFFFFF, // 背景颜色（白色）
    widthDp = 360,              // 预览宽度
    heightDp = 640              // 预览高度
)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyPreview</span><span class="hljs-params">()</span></span> {
    MyComponent()
}
</code></pre>
<p><strong>多个预览：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Preview(name = <span class="hljs-string">"浅色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_NO)</span>
<span class="hljs-meta">@Preview(name = <span class="hljs-string">"深色模式"</span>, uiMode = Configuration.UI_MODE_NIGHT_YES)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemePreview</span><span class="hljs-params">()</span></span> {
    MyAppTheme {
        MyComponent()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-17">四、Material Design 3 组件初探</h2>
<h3 data-id="heading-18">4.1 什么是 Material Design 3？</h3>
<p><strong>Material Design 3</strong>（简称 M3）是 Google 最新的设计系统，提供了丰富的预构建组件，帮助开发者快速构建美观、一致的界面。</p>
<h3 data-id="heading-19">4.2 常用基础组件</h3>
<h4 data-id="heading-20">Text（文本）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextDemo</span><span class="hljs-params">()</span></span> {
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        <span class="hljs-comment">// 基础文本</span>
        Text(<span class="hljs-string">"Hello World"</span>)
        
        <span class="hljs-comment">// 样式设置</span>
        Text(
            text = <span class="hljs-string">"Styled Text"</span>,
            fontSize = <span class="hljs-number">20.</span>sp,
            fontWeight = FontWeight.Bold,
            color = Color.Blue
        )
        
        <span class="hljs-comment">// 多行文本</span>
        Text(
            text = <span class="hljs-string">"这是一段很长的文本，可能会自动换行显示。"</span>,
            maxLines = <span class="hljs-number">2</span>,
            overflow = TextOverflow.Ellipsis
        )
    }
}
</code></pre>
<h4 data-id="heading-21">Button（按钮）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ButtonDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
        verticalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp)
    ) {
        <span class="hljs-comment">// 基础按钮</span>
        Button(onClick = { <span class="hljs-comment">/* 点击处理 */</span> }) {
            Text(<span class="hljs-string">"点击我"</span>)
        }
        
        <span class="hljs-comment">// 带图标的按钮</span>
        Button(onClick = { }) {
            Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
            Spacer(modifier = Modifier.width(<span class="hljs-number">8.</span>dp))
            Text(<span class="hljs-string">"添加"</span>)
        }
        
        <span class="hljs-comment">// 描边按钮</span>
        OutlinedButton(onClick = { }) {
            Text(<span class="hljs-string">"描边按钮"</span>)
        }
        
        <span class="hljs-comment">// 文本按钮</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"文本按钮"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-22">Card（卡片）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CardDemo</span><span class="hljs-params">()</span></span> {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(<span class="hljs-number">16.</span>dp),
        elevation = CardDefaults.cardElevation(defaultElevation = <span class="hljs-number">4.</span>dp)
    ) {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(
                text = <span class="hljs-string">"卡片标题"</span>,
                style = MaterialTheme.typography.titleLarge
            )
            Spacer(modifier = Modifier.height(<span class="hljs-number">8.</span>dp))
            Text(
                text = <span class="hljs-string">"这是卡片的内容描述文本。"</span>,
                style = MaterialTheme.typography.bodyMedium
            )
        }
    }
}
</code></pre>
<h4 data-id="heading-23">TextField（输入框）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TextFieldDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    OutlinedTextField(
        value = text,
        onValueChange = { text = it },
        label = { Text(<span class="hljs-string">"用户名"</span>) },
        placeholder = { Text(<span class="hljs-string">"请输入用户名"</span>) },
        leadingIcon = {
            Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
        },
        modifier = Modifier.fillMaxWidth()
    )
}
</code></pre>
<h3 data-id="heading-24">4.3 基础布局</h3>
<h4 data-id="heading-25">Column（垂直排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ColumnDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.fillMaxSize(),
        verticalArrangement = Arrangement.Center,  <span class="hljs-comment">// 垂直居中</span>
        horizontalAlignment = Alignment.CenterHorizontally  <span class="hljs-comment">// 水平居中</span>
    ) {
        Text(<span class="hljs-string">"第一行"</span>)
        Text(<span class="hljs-string">"第二行"</span>)
        Text(<span class="hljs-string">"第三行"</span>)
    }
}
</code></pre>
<h4 data-id="heading-26">Row（水平排列）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RowDemo</span><span class="hljs-params">()</span></span> {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceEvenly,  <span class="hljs-comment">// 均匀分布</span>
        verticalAlignment = Alignment.CenterVertically
    ) {
        Text(<span class="hljs-string">"左侧"</span>)
        Text(<span class="hljs-string">"中间"</span>)
        Text(<span class="hljs-string">"右侧"</span>)
    }
}
</code></pre>
<h4 data-id="heading-27">Box（层叠布局）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BoxDemo</span><span class="hljs-params">()</span></span> {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        <span class="hljs-comment">// 底层</span>
        CircularProgressIndicator()
        
        <span class="hljs-comment">// 上层</span>
        Text(<span class="hljs-string">"加载中..."</span>)
    }
}
</code></pre>
<h3 data-id="heading-28">4.4 完整示例：登录界面</h3>
<p>让我们用学到的组件组合一个简单的登录界面：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> username <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> password <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(<span class="hljs-number">24.</span>dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        <span class="hljs-comment">// 标题</span>
        Text(
            text = <span class="hljs-string">"欢迎登录"</span>,
            style = MaterialTheme.typography.headlineLarge,
            modifier = Modifier.padding(bottom = <span class="hljs-number">32.</span>dp)
        )
        
        <span class="hljs-comment">// 用户名输入</span>
        OutlinedTextField(
            value = username,
            onValueChange = { username = it },
            label = { Text(<span class="hljs-string">"用户名"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
            },
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 密码输入</span>
        OutlinedTextField(
            value = password,
            onValueChange = { password = it },
            label = { Text(<span class="hljs-string">"密码"</span>) },
            leadingIcon = {
                Icon(Icons.Default.Lock, contentDescription = <span class="hljs-literal">null</span>)
            },
            visualTransformation = PasswordVisualTransformation(),
            modifier = Modifier.fillMaxWidth()
        )
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">24.</span>dp))
        
        <span class="hljs-comment">// 登录按钮</span>
        Button(
            onClick = { <span class="hljs-comment">/* 登录逻辑 */</span> },
            modifier = Modifier.fillMaxWidth()
        ) {
            Text(<span class="hljs-string">"登录"</span>)
        }
        
        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))
        
        <span class="hljs-comment">// 注册链接</span>
        TextButton(onClick = { }) {
            Text(<span class="hljs-string">"还没有账号？立即注册"</span>)
        }
    }
}

<span class="hljs-meta">@Preview(showBackground = true)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginScreenPreview</span><span class="hljs-params">()</span></span> {
    MaterialTheme {
        LoginScreen()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-29">五、本篇小结</h2>
<p>今天我们完成了 Compose 的入门学习：</p>
<ol>
<li><strong>了解了 Compose 是什么</strong> - 现代声明式 UI 工具包，代码简洁、开发高效</li>
<li><strong>完成了环境搭建</strong> - 创建项目、配置依赖、运行第一个应用</li>
<li><strong>学习了 Composable 基础</strong> - 函数定义、参数传递、Modifier 使用、预览注解</li>
<li><strong>初探 Material Design 3 组件</strong> - Text、Button、Card、TextField 等常用组件，以及 Column、Row、Box 基础布局</li>
</ol>
<hr/>
<h2 data-id="heading-30">下篇预告</h2>
<p><strong>第二篇：核心基石</strong> 将深入讲解：</p>
<ul>
<li>Modifier 修饰符全解析</li>
<li>Column、Row、Box 布局详解</li>
<li>LazyColumn 与列表性能优化</li>
<li>ConstraintLayout in Compose</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-31">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose" target="_blank" title="https://developer.android.com/jetpack/compose" ref="nofollow noopener noreferrer">Jetpack Compose 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2Fcomponents" target="_blank" title="https://m3.material.io/components" ref="nofollow noopener noreferrer">Material Design 3 组件库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcompose-samples" target="_blank" title="https://github.com/android/compose-samples" ref="nofollow noopener noreferrer">Compose 示例代码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose（当前）✅</li>
<li>第二篇：核心基石</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言，我会及时回复。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot]]></title>    <link>https://juejin.cn/post/7600240045366411318</link>    <guid>https://juejin.cn/post/7600240045366411318</guid>    <pubDate>2026-01-28T11:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600240045366411318" data-draft-id="7600240045366394934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot"/> <meta itemprop="keywords" content="程序员,人工智能,开源"/> <meta itemprop="datePublished" content="2026-01-28T11:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摆烂工程师"/> <meta itemprop="url" content="https://juejin.cn/user/1552933235470589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （新手推荐）教你如何安装和使用 Clawdbot 的保姆级教程，另外 Clawdbot 已被迫改名为 Moltbot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1552933235470589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摆烂工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:35:39.000Z" title="Wed Jan 28 2026 11:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近几天相信大家都被 <strong>Clawdbot</strong> 疯狂的刷屏了，跟去年的 <strong>Manus</strong> 发布时差不多一样，在互联网上爆发式的展开。</p>
<p>原先是小龙虾，现在的 Logo 是脱了壳的小龙虾，已命名为：<strong>Moltbot</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d0bfe9a8a564a59b43f1853bfc4da66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Ql3%2FdtDavHHy6qmkLkKsFl2nLwU%3D" alt="" loading="lazy"/></p>
<p>这是因为 Clawd 的读音跟 Claude 商标冲突，被 Anthropic 给告了，被迫改为 <strong>Moltbot</strong> 。</p>
<p>Anthropic 认为 Clawdbot 这个名字太容易被市场误解为 Claude Code的衍生产品，所以 Clawdbot 已改名为 Moltbot。</p>
<blockquote>
<p>Moltbot 取自龙虾的脱壳行为，符合原本的龙虾元素，并且规避了 Claude 的商标问题。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2839fdcbb72b4629b880547da12d5c5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=VurR58pCHiA3IoiiO5dnwtEd%2FBk%3D" alt="" loading="lazy"/></p>
<p><strong>什么是 Clawdbot 呢？</strong></p>
<p>Clawdbot 是一个 AI 助手，可以部署在本地电脑上或者服务器，可以理解为是一个拥有系统超级权限（root）的 Agent。</p>
<p>如果你用过 Claude Code， 就可以把它理解为拥有各种 skills 以及可以调用各种 MCP 服务协助完成任务的闭环。</p>
<p>可以让它帮你整理邮件、管理日程、炒股、写推文、读PPT等，在后台24小时运行，但这是非常耗 Token。</p>
<p><strong>因为 Clawdbot 拥有的权限比较高，一不小心可能会把电脑系统的东西删除了就麻烦啦！！！</strong></p>
<blockquote>
<p>另外 Clawdbot 的安全性堪忧，直接部署和一些线上服务联合在一起，你的 Clawdbot 大部分网关可是暴露在公网上的，没有任何身份验证，就可以拥有完整的 Shell 访问权限。 小心黑客直接偷家了哦</p>
</blockquote>
<p>需要尝试的伙伴，建议在虚拟机上部署，或者在一台不怎么用的 Mac 电脑也行。</p>
<h2 data-id="heading-0">如何安装使用 Clawdbot</h2>
<p>电脑系统需要的<strong>环境要求：</strong></p>
<ul>
<li>Node.js 版本 &gt;= 22 以上。</li>
<li>Git</li>
</ul>
<p><strong>Windows 电脑用户建议优先选择 WSL2 （推荐 Ubuntu 系统）</strong>，Mac 电脑用户直接开箱即用。</p>
<p>安装 Clawdbot 相对比较简单，只需要用到一条 shell 命令就行。</p>
<ul>
<li>macOS / Linux / Ubuntu / Debian安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<ul>
<li>Windows (PowerShell) 安装使用下面命令**（推荐）**：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">iwr -useb https://molt.bot/install.ps1 | iex
</code></pre>
<ul>
<li>如果你需要用最新 beta 版本，可以用最新的指令：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">curl -fsSL https://molt.bot/install.sh | bash -s -- --beta
</code></pre>
<p>当然了，可以使用 Npm 包管理进行安装，你安装了 Node.js 环境之后，都有 Npm 工具的。</p>
<p>不管是 Mac / Linux / Ubuntu / Windows 都可以直接用 Npm 工具进行管理版本和安装：</p>
<ul>
<li>支持所有系统，全局安装的指令（对npm不熟悉的，不要使用这种方式安装）：</li>
</ul>
<p>因为 npm 是官方刚发布的，可能运行有点问题，建议还是使用上面的其他指令安装。 这边知道一下就行哈。</p>
<pre><code class="hljs language-shell" lang="shell">npm i -g moltbot@latest
</code></pre>
<p>npm 安装后，如果执行 moltbot 找不到指令的话，可以改为 clawdbot 指令。</p>
<blockquote>
<p>上面的指令，使用其中一条就行，按照自己的系统使用对应的指令。</p>
</blockquote>
<h2 data-id="heading-1">当前是 Mac 苹果电脑进行安装</h2>
<p>目前我是 Node.js 22.15 版本，执行指令后，等待一段时间，会进行克隆 Github 上的仓库。</p>
<p><code>curl -fsSL https://molt.bot/install.sh | bash</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e8fdb9cc2c43879ff01bba523b9c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WMJSYQVEyvMZB6WaVWhGmZUdCyE%3D" alt="" loading="lazy"/></p>
<p>当你安装成功之后，会问你是否知道 Clawdbot 的风险很高，选择 yes 之后，就可以继续。</p>
<p>如果你选择 no，那么就会直接退出安装向导。</p>
<p>这边选择 <strong>QuickStart</strong> 模式，可以默认使用 Clawdbot 的配置。</p>
<p>这是分配的默认端口：18789， <strong>然后 Clawdbot 是支持 ChatGPT 和 Claude 的 OAuth 授权登录方式。</strong></p>
<p>也就是你可以不需要去购买API，使用会员的 Codex 或者 Claude Code。</p>
<blockquote>
<p>但是，这里建议别用 Claude 授权登录，因为 Claude 是小气鬼，会阻止你使用非 Claude Code 的服务去调用 Claude。 如果你非要用 Claude 的话，但是没有 Claude 账号，可以在这里申请一个：chatshare.cc</p>
</blockquote>
<p>因为我平时的主力是 Codex，所以我选择 OpenAI, 使用 Codex 的 OAuth 就行，<strong>另外你只要是 GPT 会员（Plus、Business、Pro）就可以用这个方式。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4490e61ad95407c9a125678b42b8346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=WaquS0Hr%2FJDQmmHqLnUk8kjIdnE%3D" alt="" loading="lazy"/></p>
<p>虽然我本地有 Codex CLI，为了方便大家了解 ChatGPT 授权登录的方式，这边我先选择第 2 种。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43675a47b5004b6c8dbef9d60caf3745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=7mteplvYFCnbdB3RWWm%2B39U8zYA%3D" alt="" loading="lazy"/></p>
<p>会给你一条 ChatGPT 授权登录的链接，正常你的电脑会自动弹起浏览器，你只需要选择对应的会员进行登录即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0678374324a94ef6a1dcf1e6b0f6f43e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=9gGVRHn2WWsGXfJHr%2BnH2%2BB9AtU%3D" alt="" loading="lazy"/></p>
<p>这边我是开通了 ChatGPT Businss 会员 和 Plus 会员，不过平时我会优先消耗 Business 会员的 额度，这里我就选择 Business 会员。</p>
<p><strong>因为 ChatGPT Business 会员比较便宜，目前有优惠活动价，几十块钱就可以用跟 Plus 会员一样的 Codex 额度。</strong></p>
<p><strong>高性价比体验 Clawdbot 的方式：</strong></p>
<blockquote>
<p><strong>ChatGPT Business 优惠开通的地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fupchatgpt.com" target="_blank" title="https://upchatgpt.com" ref="nofollow noopener noreferrer">upchatgpt.com</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0824fc26cda544bbb36d2a55c4a76c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=gtNaiOfZAXdZXp1OPSySFGHrmjM%3D" alt="" loading="lazy"/></p>
<p>点击继续后，就会进行回调，告诉你授权成功后，你就可以回到终端查看安装状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7dbb5a91f0f4292922de728f4d74ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SnIA8C08XWZ6zh8swqkcgmP2FXY%3D" alt="" loading="lazy"/></p>
<p>PS：<strong>如果你的终端没有自动回调获取到 Code 的话，你就把当前这条回调地址，localhost 开头的，全部复制，粘贴到终端就成功登录啦</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb84ce3d4da48e6bdf326f2cbfedf92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=%2FY4MUkwa4i0yF9dY8oU9YUEy1Go%3D" alt="" loading="lazy"/></p>
<p>我选择了默认 GPT-5.2-Codex 模型，然后就会进入选择频道，我是测试了 TG 的机器人，这里教程的话，我就先跳过啦。</p>
<p>你可以跳过，后续再选择，或者配置其他的频道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d543e1bf06204d12b7dedc983b14b8ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=LW0%2BQhscCyqYi6VFkZD0%2Fo6p%2FvI%3D" alt="" loading="lazy"/></p>
<p>接下来就是配置 <strong>skills</strong>，是的，这个 skills 就是你平时听到的那个 skills。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78101277044e495fad74c71229b7fe69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SdFTTDb3z4rRkrLFwMeJKpeAbvs%3D" alt="" loading="lazy"/></p>
<p>接着就是包管理工具，这里选择平时自己喜欢的就行，默认用的 npm 就行。</p>
<p>后面就会给你一些 Skills，你可以按需选择，或者先跳过也可以。 后续都可以安装的，直接跟 Clawdbot 说安装对应的 skills 就行。</p>
<p>无需手动哦，只需对话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514d371d47234936adb2a0f2faebf961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=c7EdvsnhV428UfUHmLhsFQWS174%3D" alt="" loading="lazy"/></p>
<p>后续出现一些 API KEY 的设置，如果你没有，直接回车：No 就行。 这里是一些图片生成之类的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d63748cf3c44e68217e78254c1386e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=SevMG2GO%2FoO9M3yWG1JEqib9YtI%3D" alt="" loading="lazy"/></p>
<p>最后，问你需不需要开启钩子，这三个都是 <strong>Moltbot 的内置 hooks（钩子脚本）</strong>，用来在特定事件发生时自动做事：</p>
<ul>
<li>boot-md：网关（gateway）启动后自动读取并执行工作区里的 BOOT.md 里的引导/启动指令。</li>
<li>command-logger：把所有命令事件记录到本地审计日志文件（默认 ~/.clawdbot/logs/commands.log）</li>
<li>session-memory：当你发出 /new 时，把当前会话上下文保存成一份“记忆快照”到工作区（默认 ~/clawd/memory/ 相关路径）。</li>
</ul>
<p>建议直接三个都钩上开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7eb6b2317ae496a8a56a80d39040cca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Vz%2FxXPCYujTmweTKnzVaZzKLiIY%3D" alt="" loading="lazy"/></p>
<p>接下来会问你用什么方式开启使用你的 AI 助手。对于新手的话，<strong>建议选择 web ui</strong> ，就是有页面可以操作，不需要输入各种指令进行操作。</p>
<p>配置基本都完成啦，现在可以运行你的 Clawdbot 。</p>
<p>可以执行下面指令，就会自动打开 web ui 控制页面啦：</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>默认本地服务运行的端口和地址：<code>http://127.0.0.1:18789</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db3222e815f24cd5ba25a8b50d41220a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770204947&amp;x-signature=Y6n8T6EesiVXeSJxmu2XKmddN60%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>提示：虽然 Clawdbot 改名为 Moltbot，但是目前的工具的指令还没有更新为 moltbot，所以你用官方的指令可能无法确认自己是否成功安装！ 那么，你可以直接把 moltbot 相关 改为 clawdbot 去运行指令，就可以啦！</p>
</blockquote>
<h2 data-id="heading-2">一些常用的 Clawdbot 指令说明</h2>
<ul>
<li>快速诊断当前 clawdbot 的状态（含模型提供商用量/配额等信息）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<ul>
<li>打开 clawdbot 浏览器 Web UI（最快开始聊天/看状态）的管理页面：</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<ul>
<li>查看频道配置、探测频道健康、看频道日志。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot channels list|status|logs
</code></pre>
<ul>
<li>直接在终端里开 TUI 聊天（没浏览器/远程机很爽）。</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot tui
</code></pre>
<ul>
<li>重新跑配置向导（改模型/频道/技能时很好用）</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">clawdbot configure
</code></pre>
<ul>
<li>管理网关（ <strong>Clawdbot 服务</strong> ） 服务的状态/安装/停/重启。</li>
</ul>
<p>如果要关闭你现在在运行的 clawdbot，直接用 <code>clawdbot gateway stop</code> 就可以啦～</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway status|install|stop|restart
</code></pre>
<p>现在你可以去体验 Clawdbot 啦！当然，如果你不使用 Codex、Claude 这些服务运行 Clawdbot 的话，也可以配置第三方 API 和 KEY，就是可以用国内模型运行 Clawdbot。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（69）Hibernate与JPA的关系]]></title>    <link>https://juejin.cn/post/7600229327436382258</link>    <guid>https://juejin.cn/post/7600229327436382258</guid>    <pubDate>2026-01-28T11:42:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600229327436382258" data-draft-id="7600068892989079562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（69）Hibernate与JPA的关系"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:42:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（69）Hibernate与JPA的关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:42:44.000Z" title="Wed Jan 28 2026 11:42:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate和JPA（Java Persistence API）密切相关，Hibernate是JPA的一种实现。JPA是一种Java EE规范，定义了一组用于对象关系映射（ORM）的标准接口，而Hibernate是一个流行的ORM框架，它实现了JPA规范并扩展了其功能。</p>
<p>以下是详细解释它们关系的步骤：</p>
<h3 data-id="heading-0">1. JPA概述</h3>
<p>JPA是一种Java EE规范，Java EE 5引入了它，用于简化开发持久化层。JPA定义了一组标准接口，使开发人员可以使用不同的持久化提供程序而不需要改变应用程序代码。JPA提供了以下功能：</p>
<ul>
<li>实体（Entity）类：持久化的Java对象。</li>
<li>实体管理器（EntityManager）：用于管理实体的生命周期。</li>
<li>查询语言（JPQL）：一种面向对象的查询语言。</li>
</ul>
<h3 data-id="heading-1">2. Hibernate概述</h3>
<p>Hibernate是一个广泛使用的ORM框架，它实现了JPA规范并增加了许多额外的功能。Hibernate允许开发人员通过使用持久化类和映射来与数据库进行交互。</p>
<h3 data-id="heading-2">3. JPA与Hibernate的关系</h3>
<ul>
<li><strong>JPA是规范，Hibernate是实现</strong>：JPA定义了一组接口和规则，而Hibernate是一个具体的实现。</li>
<li><strong>标准化和灵活性</strong>：通过使用JPA接口，开发人员可以轻松地更换持久化提供程序，而不需要改变业务逻辑代码。Hibernate作为JPA的实现，提供了标准化的接口和额外的功能。</li>
</ul>
<h3 data-id="heading-3">4. 代码示例</h3>
<p>以下是一个使用JPA和Hibernate的完整代码示例，展示了如何配置和使用它们。</p>
<h4 data-id="heading-4">4.1. 项目依赖</h4>
<p>使用Maven进行依赖管理，在<code>pom.xml</code>中添加JPA和Hibernate的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate JPA Implementation --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Data JPA if using Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">4.2. 配置数据源</h4>
<p>在<code>application.properties</code>中配置数据源和JPA属性：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h4 data-id="heading-6">4.3. 定义实体类</h4>
<p>定义一个简单的实体类，例如<code>User</code>：</p>
<h5 data-id="heading-7"><code>User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h4 data-id="heading-8">4.4. 创建DAO层</h4>
<p>创建一个数据访问对象（DAO）接口，用于访问数据库。如果使用Spring Data JPA，可以简化为一个接口。</p>
<h5 data-id="heading-9"><code>UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">4.5. 创建服务层</h4>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h5 data-id="heading-11"><code>UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-12">4.6. 编写控制器</h4>
<p>利用上述服务类来编写RESTful API控制器。</p>
<h5 data-id="heading-13"><code>UserController.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">createdUser</span> <span class="hljs-operator">=</span> userService.createUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdUser);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;User&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> {
        user.setId(id); <span class="hljs-comment">// Ensure the user ID is set correctly</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-14">5. 运行应用</h3>
<ol>
<li><strong>启动MySQL数据库</strong>：确保你的MySQL数据库运行在<code>localhost:3306</code>，并且已创建了名为<code>mydatabase</code>的数据库。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-15">6. 访问API</h3>
<p>通过以下API访问用户数据：</p>
<ul>
<li><code>POST /users</code>：创建用户。</li>
<li><code>GET /users/{id}</code>：按ID获取用户。</li>
<li><code>GET /users</code>：获取所有用户。</li>
<li><code>PUT /users/{id}</code>：更新用户。</li>
<li><code>DELETE /users/{id}</code>：删除用户。</li>
</ul>
<h3 data-id="heading-16">总结</h3>
<p>通过上述步骤，我们展示了如何使用Hibernate和JPA，从配置项目依赖、设置数据源、定义实体类、创建DAO层和服务层，并编写RESTful API控制器。此外，我们解释了Hibernate和JPA的关系，JPA作为规范提供了接口和规则，而Hibernate作为实现提供了实际的ORM功能。这样，应用程序可以利用Hibernate实现JPA规范，进行高效的数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（70）如何在多数据库环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600234310965198886</link>    <guid>https://juejin.cn/post/7600234310965198886</guid>    <pubDate>2026-01-28T11:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965198886" data-draft-id="7600245693997137930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（70）如何在多数据库环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（70）如何在多数据库环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:43:43.000Z" title="Wed Jan 28 2026 11:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多数据库环境中使用Hibernate，需要配置多个数据源（DataSource）和多个实体管理器（EntityManager）。通常情况下，你可能需要在Spring Boot项目中使用Hibernate来连接多个数据库。下面是详细步骤和代码示例，展示如何在Spring Boot项目中配置和使用多个数据库。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置多个数据源</h3>
<p>需要在<code>application.properties</code>或<code>application.yml</code>文件中配置多个数据源。</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties"># Primary DataSource
spring.datasource.primary.url=jdbc:mysql://localhost:3306/primarydb
spring.datasource.primary.username=root
spring.datasource.primary.password=rootpassword
spring.datasource.primary.driver-class-name=com.mysql.cj.jdbc.Driver

# Secondary DataSource
spring.datasource.secondary.url=jdbc:mysql://localhost:3306/secondarydb
spring.datasource.secondary.username=root
spring.datasource.secondary.password=rootpassword
spring.datasource.secondary.driver-class-name=com.mysql.cj.jdbc.Driver

# Hibernate properties
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</code></pre>
<h3 data-id="heading-3">3. 配置多数据源与实体管理器</h3>
<p>需要创建配置类来配置多个数据源与对应的实体管理器。</p>
<h4 data-id="heading-4"><code>PrimaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.primary",
        entityManagerFactoryRef = "primaryEntityManagerFactory",
        transactionManagerRef = "primaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "primaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.primary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "primaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">primaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.primary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "primaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">primaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h4 data-id="heading-5"><code>SecondaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.secondary",
        entityManagerFactoryRef = "secondaryEntityManagerFactory",
        transactionManagerRef = "secondaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "secondaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.secondary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "secondaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">secondaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.secondary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "secondaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">secondaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-6">4. 定义实体类和DAO层</h3>
<p>根据不同的数据源，将实体类和DAO层放在不同的包中。</p>
<h4 data-id="heading-7">主数据源实体类和DAO层</h4>
<h5 data-id="heading-8"><code>com.example.primary.entity.User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h5 data-id="heading-9"><code>com.example.primary.repository.UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.repository;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">次数据源实体类和DAO层</h4>
<h5 data-id="heading-11"><code>com.example.secondary.entity.Order.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String orderNumber;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderNumber;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderNumber</span><span class="hljs-params">(String orderNumber)</span> {
        <span class="hljs-built_in">this</span>.orderNumber = orderNumber;
    }
}
</code></pre>
<h5 data-id="heading-12"><code>com.example.secondary.repository.OrderRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.repository;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
    Order <span class="hljs-title function_">findByOrderNumber</span><span class="hljs-params">(String orderNumber)</span>;
}
</code></pre>
<h3 data-id="heading-13">5. 创建服务层</h3>
<h4 data-id="heading-14">主数据源服务层</h4>
<h5 data-id="heading-15"><code>com.example.primary.service.UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.service;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> com.example.primary.repository.UserRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-16">次数据源服务层</h4>
<h5 data-id="heading-17"><code>com.example.secondary.service.OrderService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.service;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> com.example.secondary.repository.OrderRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kimi 开源新模型，不输 Gemini 3，太有眼力见了！]]></title>    <link>https://juejin.cn/post/7600216277426864162</link>    <guid>https://juejin.cn/post/7600216277426864162</guid>    <pubDate>2026-01-28T10:09:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600216277426864162" data-draft-id="7600265780349173800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kimi 开源新模型，不输 Gemini 3，太有眼力见了！"/> <meta itemprop="keywords" content="前端,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-28T10:09:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杆"/> <meta itemprop="url" content="https://juejin.cn/user/4182956056773160"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kimi 开源新模型，不输 Gemini 3，太有眼力见了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4182956056773160/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:09:54.000Z" title="Wed Jan 28 2026 10:09:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在昨天，Kimi 正式发布了 K2.5 版本。点开公告一看，好家伙，这是要 “掀桌子” 啊！</p>
<p>这次 Kimi 不仅把模型能力拉满了（Lookahead 推理、长上下文），还直接开源了 K2.5 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a62ffddd77d49b08b764ef190ce6e3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=AeL41udDxlmOsTonNUhItVBS7G8%3D" alt="" loading="lazy"/></p>
<p>不过，数据好不代表用起来好，是骡子是马还得先拉出来溜溜。</p>
<p>这次更新最大的两个亮点：<strong>Visual Coding（视觉编程）</strong> 和 <strong>Agent 集群</strong>。简单说，就是 AI 不仅能看懂你的屏幕，还能分身成一支团队帮你干活。</p>
<p>刚好我有个 idea 想试试，做一个 <strong>赛博朋克风格的番茄钟</strong>。</p>
<p>为了验证 K2.5 的真实实力，我给它定了个小目标：我全程不碰代码，只靠动嘴和截图，看这玩意儿到底能不能真落地。</p>
<h2 data-id="heading-0">Agent 集群初体验</h2>
<p>在开始大项目之前，我先拿 Kimi 试了个开胃菜 。</p>
<p>以前我们用 AI，都是一问一答模式。但 Kimi K2.5 的 Agent 集群打破了这个限制，<strong>它可以瞬间拆解任务，同时调度多个 Agent 协同工作</strong>。</p>
<p>我发了一条指令试水：</p>
<blockquote>
<p>帮我批量调研过去 10 年最奇葩的“搞笑诺贝尔奖”（Ig Nobel Prize），生成一个 Markdown 表格，列出年份、奖项、获奖者和搞笑理由。</p>
</blockquote>
<p>整个过程大约持续了8分钟，我看到它分配了10个Agent，然后每个人分别去查一年的资料，最后刷刷刷给我列出了一个表格！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40b7ed39f0fc43c28efe816060fab457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=vkreW16EVOeG1tlGAW2w6MNmvXk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30f21e5b9b6453ea8ddb4c19650aa18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=I9JWXTlB2NBooLU%2BL8zwbNWLdTw%3D" alt="" loading="lazy"/></p>
<p>以前这种活，我得自己搜完一个，再搜下一个，或者不停点 “继续生成”。</p>
<p>现在 Kimi 瞬间理解了批量意图，后台自动拆分任务去查资料，然后汇总给我。</p>
<p>这种高效率的爽感，让我对后面的项目充满了信心！</p>
<p>而且它的工作过程，让我看到，确实是一步步脚踏实地去做的，每一个 SubAgent 都真实的去做了调研，而不是随便找一个别人整理的不确定真实性的那种结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79b5b723128b45e0a9a879d622418d03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6ATvcYxYxTMyKIBHZS0fjw0ZVZQ%3D" alt="" loading="lazy"/></p>
<p>这种能力，对于做产品或者做科研来说，都是相当有用的。</p>
<p><strong>那么接下来，要开始做我们的番茄钟了！</strong></p>
<h2 data-id="heading-1">第一步：调研</h2>
<p>要开发产品，绝不能拍脑袋。以前做竞品调研、查文献，少说得花一下午。现在？交给 Agent 集群。</p>
<p>我直接给它下了这个任务：</p>
<blockquote>
<p>帮我调研 50 篇关于“番茄工作法与专注力提升”的心理学论文或高引用文章，总结出最科学的专注时间、休息间隔，以及什么样的白噪音最能提升效率。</p>
</blockquote>
<p>在 Kimi 的任务管理器里，瞬间爆出了几个子任务，这就好比你手下多了几个实习生，每个人领了几篇论文去读。</p>
<p>看着后台刷刷刷全是它干活的记录，而我只能在一旁摸鱼，这种 <strong>一人成军</strong> 的感觉太棒了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89c8ed865712406ba2b767360d8a446c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=7vW7%2FRz69Jgo2RGWyAoXlxQC1ww%3D" alt="" loading="lazy"/></p>
<p>几分钟后，一份深度报告出来了：</p>
<ul>
<li><strong>最佳节奏</strong>：25-30分钟专注+5分钟休息</li>
<li><strong>意外发现</strong>：<strong>粉红噪音/自然声音（45-55dB）</strong> 对提升专注力有显著效果</li>
</ul>
<p>而且还整理了很多的报告文档，以及它阅读了哪些论文，论文链接、摘要之类的都给整理出来了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcb2ca7714104d948c96c67442747db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=nUv87Yizkt3PNyhE%2BE75TvLBuCk%3D" alt="" loading="lazy"/></p>
<p>（右侧是它整理的文档内容）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb009058544a4d9d8faa5e279a720ee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=OEj5t%2BiDZAC%2BizKk4S2D%2BmAZbyw%3D" alt="" loading="lazy"/></p>
<p>这调研能力真的很强，普通人依靠它也完全可以做好一个初步的调研。</p>
<h2 data-id="heading-2">Visual Coding</h2>
<p>有了需求，接下来就是开发。</p>
<p>这次，我选择不碰代码，而是试试 K2.5 的新功能，<strong>Video-to-Code（视频生成代码）</strong> 。</p>
<h3 data-id="heading-3">视频复刻</h3>
<p>既然要做赛博朋克风，那种故障艺术（Glitch）的动效是灵魂。但这种效果很难用文字描述清楚，“滋滋啦啦的”、   “有点跳变”，AI 哪能听懂这个？</p>
<p>所以我直接去 CodePen 上找了一个 <strong>Glitch 文字效果的 Demo</strong>，录了段屏丢给了 Kimi：</p>
<blockquote>
<p>看这个视频里的文字效果。帮我做一个番茄钟网页：</p>
<ol>
<li>倒计时 25 分钟，支持开始、暂停、重置</li>
<li>倒计时数字要有这种故障抖动、颜色闪烁的效果</li>
<li>背景播放 45Hz 双耳节拍白噪音</li>
<li>整体风格要赛博朋克，霓虹配色</li>
</ol>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8c729010027465e8b9db4611e82453b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Eo6DN5m%2Bvcq0%2B3k5yhdNSwh9U%2BQ%3D" alt="" loading="lazy"/></p>
<p>（这是我找的效果）</p>
<p>很快啊，大概3分钟就做完了，结果让我有些惊讶。</p>
<p>仅仅凭借视觉信息，Kimi 就复刻出了几乎一模一样的 CSS 关键帧动画。倒计时数字开始随机抖动、变色，还原度相当高，非常有赛博朋克的感觉。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f533ea413d64fd58792ffce47172ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UPmFXNqmjyNOEPGdv%2FSRGHV%2F6U0%3D" alt="" loading="lazy"/></p>
<p>然后我又尝试了不同风格的番茄钟，科技风、毛玻璃风……我发现这种简单页面对它来说简直小儿科。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521b7f3e94fa4ec9ace88a8d83a91fbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=6vNWpCLreqDP5zt%2BrNBII7bPR8Y%3D" alt="" loading="lazy"/></p>
<p>既然这样，我决定给它上点难度，整点复杂度更高的东西试试。</p>
<h3 data-id="heading-4">复刻高端动效</h3>
<p>我找了一个觉得不错的交互效果，录了一段它的 Tab 切换动效，那种有层次的物理感交互。</p>
<p>然后<strong>我直接把视频丢给了 K2.5</strong>，让它参照视频给我复刻一个一样的。</p>
<p>结果 Kimi 不仅复刻了布局和画风，还捕捉到了很多细节：</p>
<ul>
<li>半透明毛玻璃卡片边框</li>
<li>三张卡片以不同的节奏上下浮动</li>
<li><strong>卡片内部元素的延迟加载和弹跳动画</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/077c36e966cb4539ae12902557b03af5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TvhPkUPPZRXyXPTKTYOnFXlE0YM%3D" alt="" loading="lazy"/></p>
<p>整体都还原得相当到位👍🏻。</p>
<h3 data-id="heading-5">完整 Landing Page</h3>
<p>既然单个组件没问题，那整页呢？我又找了一个设计感很强的 Landing Page，这次我直接把网站URL丢给了它，让它帮我复刻。</p>
<p>它首先打开并且查看了网站的内容，分析网站的设计风格，然后生成需要的素材图片，最后开始复刻网站。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22e568d93df04e219134e109e999c218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=TBysWlGWKHdlrJETThg5C%2Fy%2FUu4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645f107324a645688d1f8cf2e85a7af7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=Bbpqx2dsfqxBwGsHbS4BAFyBtbY%3D" alt="" loading="lazy"/></p>
<p>大概花了 10 分钟，生成了一个完整的 Landing Page。虽然细节上还需要微调，但整体框架和动效已经有模有样了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3638b200ce54763a8b04c99f668d168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=UcvmC6um6VaBnAQ8WE9MYGjnC9I%3D" alt="" loading="lazy"/></p>
<p>这让我想到，以前做一个这样的页面，光是切图加写样式就得半天。现在？录个屏或者丢个链接，剩下的交给 Kimi。</p>
<h2 data-id="heading-6">Visual Edit：哪里不爽圈哪里</h2>
<p>不管是番茄钟还是 Landing Page，生成的初版总会有些小瑕疵。</p>
<p>换做以前，改这种细节是比较麻烦的。我得去 F12 里找到对应元素，然后跟 AI 描述“把第三个 div 的 margin-top 改成 20px”之类的。</p>
<p>现在？Kimi 支持 <strong>Visual Edit（视觉调整）</strong> 。直接在预览界面用鼠标圈选不满意的地方，然后让它改就行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b8bd564c6e4445c85b989695d4c065b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5p2G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199794&amp;x-signature=cS5Q%2ByjNo80Z40pRM5Yr4eceTEo%3D" alt="" loading="lazy"/></p>
<p>Kimi 精准定位代码，很快就能修改完成。这种"圈哪里改哪里"的交互方式，用起来确实很爽。</p>
<p>而且代码可以直接下载，或者一键部署到 Kimi 的托管服务上。</p>
<h2 data-id="heading-7">尾声</h2>
<p>捣鼓了一上午，我用 Kimi K2.5 做出了赛博朋克番茄钟，还顺手复刻了几个高端网页动效。</p>
<p>整个过程，我连一行代码都没碰，只充当了产品经理和审美把关人的角色：</p>
<ul>
<li><strong>调研</strong>：交给 Agent 集群，50 篇论文分钟级消化</li>
<li><strong>开发</strong>：交给 Visual Coding，看视频直接生成代码</li>
<li><strong>调整</strong>：交给 Visual Edit，圈选即改</li>
</ul>
<p>除了这些，你还可以让它帮你批量生成图片，比如请 10 个风格截然不同的知名艺术家，每人为我设计一张马年主题微信表情包。也可以给它一张风景图让它识别地点，甚至丢一道行测图形推理题让它帮你分析。</p>
<p>整体体验下来，Kimi K2.5 这次的升级确实有看点：<strong>Agent 集群的并发效率、Visual Coding 的所见即所得、还有开源模型带来的想象空间</strong>。</p>
<p>尤其是 Visual Edit，对于开发者来说简直是福音。以前改个样式要翻代码半天，现在圈一下说句话就搞定。</p>
<p>当然，K2.5 的全部能力还需要更多场景来验证。比如生成的代码在复杂项目里能不能直接用、长期维护性如何，这些都有待观察。但作为一个快速验证想法、做 Demo 的工具，它已经相当能打了。</p>
<blockquote>
<p><strong>参考链接</strong></p>
<p>K2.5 开源模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmoonshotai%2FKimi-K2.5" target="_blank" title="https://huggingface.co/moonshotai/Kimi-K2.5" ref="nofollow noopener noreferrer">huggingface.co/moonshotai/…</a></p>
<p>K2.5 发布公告：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2Fblog%2Fkimi-k2-5.html" target="_blank" title="https://www.kimi.com/blog/kimi-k2-5.html" ref="nofollow noopener noreferrer">www.kimi.com/blog/kimi-k…</a></p>
<p>Kimi 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com%2F" target="_blank" title="https://www.kimi.com/" ref="nofollow noopener noreferrer">www.kimi.com/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Fiber 架构全方位梳理]]></title>    <link>https://juejin.cn/post/7600219080045756459</link>    <guid>https://juejin.cn/post/7600219080045756459</guid>    <pubDate>2026-01-28T10:00:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080045756459" data-draft-id="7599970244787879999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Fiber 架构全方位梳理"/> <meta itemprop="keywords" content="前端,React.js,前端框架"/> <meta itemprop="datePublished" content="2026-01-28T10:00:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sophie旭"/> <meta itemprop="url" content="https://juejin.cn/user/2559318799692952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Fiber 架构全方位梳理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318799692952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sophie旭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:00:41.000Z" title="Wed Jan 28 2026 10:00:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读43分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>作为 react 高频考点，React Fiber反复出现，为啥会成为高频考点，我觉得，很大程度上是因为 React Fiber架构真的解决了问题，并且巧妙的思想或许在未来可以给我们一些性能优化的启发，所以我们今天一起来走进 React Fiber，感受它的</p>
<h2 data-id="heading-1">一、先理解：为什么需要 Fiber 架构？</h2>
<p>React 15 及之前使用的是 <strong>Stack Reconciler（栈协调器）</strong>，它采用递归方式遍历虚拟 DOM 树，一旦开始渲染就无法中断。JS 线程是单线程的，如果渲染任务（比如复杂组件树的更新）耗时超过 16.6ms（浏览器 60fps 下每帧的时长），就会阻塞浏览器的渲染、布局、用户交互（如点击/输入），导致页面卡顿。</p>
<p>Fiber 架构的核心目标就是<strong>将同步的、不可中断的递归渲染，改成异步的、可中断的迭代渲染</strong>，彻底解决渲染阻塞问题。</p>
<h4 data-id="heading-2">一、先明确：Stack Reconciler 是什么？</h4>
<p>Stack Reconciler（栈协调器）是 React 15 及之前版本的核心渲染引擎，负责两大核心工作：</p>
<ol>
<li><strong>Reconciliation（协调）</strong>：对比新旧虚拟 DOM 树（Virtual DOM），找出需要更新的节点（即「差异（diff）」）；</li>
<li><strong>Commit（提交）</strong>：将找到的差异同步应用到真实 DOM 上。</li>
</ol>
<p>它的核心特征是：<strong>基于 JavaScript 调用栈的同步递归遍历</strong> —— 这也是「Stack（栈）」这个名字的由来（完全依赖 JS 函数调用栈完成遍历）。</p>
<h4 data-id="heading-3">二、Stack Reconciler 的递归执行流程</h4>
<p>虚拟 DOM 是树形结构，递归是最直观的遍历方式，但也埋下了「无法中断」的隐患。我们先通过一个简化的示例，还原它的执行逻辑：</p>
<h5 data-id="heading-4">1. 模拟 Stack Reconciler 的递归遍历代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟 React 15 的虚拟 DOM 节点</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, children = []</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children; <span class="hljs-comment">// 子节点</span>
  }
}

<span class="hljs-comment">// 模拟 Stack Reconciler 的核心递归遍历方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 对比当前节点：如果标签不同，直接标记为替换</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记替换节点: <span class="hljs-subst">${oldVNode.tag}</span> → <span class="hljs-subst">${newVNode.tag}</span>`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 2. 递归遍历子节点（核心：深度优先递归）</span>
  <span class="hljs-keyword">const</span> oldChildren = oldVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> newChildren = newVNode.<span class="hljs-property">children</span>;
  <span class="hljs-keyword">const</span> maxLen = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(oldChildren.<span class="hljs-property">length</span>, newChildren.<span class="hljs-property">length</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldChildren[i];
    <span class="hljs-keyword">const</span> newChild = newChildren[i];
    
    <span class="hljs-comment">// 递归处理每个子节点 —— 每递归一次，就向 JS 调用栈压入一层</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点存在，继续递归</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记新增节点: <span class="hljs-subst">${newChild.tag}</span>`</span>); <span class="hljs-comment">// 新节点，标记新增</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldChild) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`标记删除节点: <span class="hljs-subst">${oldChild.tag}</span>`</span>); <span class="hljs-comment">// 旧节点，标记删除</span>
    }
  }
}

<span class="hljs-comment">// 模拟一个复杂的组件树（多层嵌套）</span>
<span class="hljs-keyword">const</span> oldTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>)]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Ad'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-keyword">const</span> newTree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'App'</span>, [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Header'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Logo'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Nav'</span>)]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Content'</span>, [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Article'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Title'</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Text'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Span'</span>)])]),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Sidebar'</span>, [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Menu'</span>)])
  ]),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(<span class="hljs-string">'Footer'</span>)
]);

<span class="hljs-comment">// 触发渲染：一旦调用，必须执行完整个递归流程</span>
<span class="hljs-title function_">reconcile</span>(oldTree, newTree);
</code></pre>
<h5 data-id="heading-5">2. 递归执行的关键特点</h5>
<p>从代码中能看到，<code>reconcile</code> 函数的执行完全依赖 JS 调用栈：</p>
<ul>
<li>每递归处理一个子节点，就会向调用栈<strong>压入一层</strong> <code>reconcile</code> 函数；</li>
<li>只有当某个节点的所有子节点都处理完毕（递归返回），该层函数才会从调用栈<strong>弹出</strong>；</li>
<li><strong><code>整个遍历过程必须「一气呵成」—— 从根节点到最深层节点，再逐层返回，中间没有任何暂停的可能。</code></strong></li>
</ul>
<h4 data-id="heading-6">三、为什么递归遍历「无法中断」？</h4>
<p>核心原因是 <strong>JavaScript 单线程 + 调用栈的同步特性</strong>：</p>
<ol>
<li><strong>JS 单线程模型</strong>：浏览器中 JS 线程和渲染线程（布局、绘制）是互斥的 —— 只要 JS 线程在执行代码，渲染线程就会被阻塞；</li>
<li><strong>调用栈不可中断</strong>：<strong><code>JS 引擎的调用栈是「同步执行」的，一旦函数开始执行，必须等到函数体完全执行完毕、调用栈清空，才会释放主线程。</code></strong></li>
</ol>
<p>举个实际场景：如果你的组件树有 1000 个节点，<code>reconcile</code> 递归遍历需要 50ms 才能完成。这 50ms 内：</p>
<ul>
<li>JS 线程被完全占用，浏览器无法处理任何用户交互（点击、输入、滚动）；</li>
<li>渲染线程被阻塞，页面无法更新，用户会明显感觉到「卡顿」（60fps 下每帧只有 16.6ms，50ms 会丢失 3 帧）；</li>
<li>即使中途用户触发了更紧急的操作（比如点击按钮），也必须等这 50ms 的递归完成后才能响应 —— 因为调用栈没有「暂停」「插队」的机制。</li>
</ul>
<h4 data-id="heading-7">四、Stack Reconciler 的核心问题</h4>
<p>除了「无法中断」，递归遍历还带来两个关键问题：</p>
<ol>
<li><strong>无优先级调度</strong>：所有更新任务（比如用户输入的高优先级更新、数据请求的低优先级更新）都被同等对待，同步排队执行 —— 比如用户输入框打字（需要即时响应），却要等一个耗时的列表渲染完成，体验极差；</li>
<li><strong>调用栈溢出风险</strong>：如果组件树嵌套过深（比如 1000 层），递归遍历会导致调用栈层数过多，直接触发 <code>Maximum call stack size exceeded</code> 错误（栈溢出）。</li>
</ol>
<h4 data-id="heading-8">总结（核心关键点）</h4>
<ol>
<li>Stack Reconciler 依赖 <strong>JS 调用栈的同步递归</strong> 遍历虚拟 DOM 树，递归的特性决定了渲染过程「一旦开始就必须执行到底」；</li>
<li>无法中断的根源是 <strong>JS 单线程 + 调用栈不可中断</strong> —— 递归过程中主线程被完全占用，阻塞渲染和用户交互；</li>
<li>直接后果是 <strong>长任务导致页面卡顿</strong>，且无法区分任务优先级，无法优先响应用户交互等关键操作（这也是 Fiber 架构要解决的核心痛点）。</li>
</ol>
<p>简单来说，React 15 的 Stack Reconciler 就像「一口气跑完马拉松」，不管中途有没有突发情况，都不能停；而 Fiber 架构则是「分段跑马拉松」，跑一段歇一下，还能优先处理紧急的事（比如喝水、接电话），这也是两者最核心的区别。</p>
<h2 data-id="heading-9">二、核心原理拆解</h2>
<h3 data-id="heading-10">1. Fiber 解决渲染阻塞的核心逻辑</h3>
<p>Fiber 解决阻塞的核心是 <strong>“任务拆分 + 时间切片 + 优先级调度”</strong>，核心逻辑可总结为 3 点：</p>
<ul>
<li><strong>任务拆分</strong>：将原本一次性完成的“整棵组件树的渲染更新”拆成无数个小任务（每个小任务只处理一个 Fiber 节点）；</li>
<li><strong>时间切片（Time Slicing）</strong>：每次只执行一个小任务，且执行时长不超过浏览器预留的空闲时间，执行完就把控制权还给浏览器；</li>
<li><strong>中断与恢复</strong>：如果当前帧的空闲时间用完，就暂停渲染任务，记录当前执行到的 Fiber 节点，等浏览器下一次空闲时再从该节点继续执行。</li>
</ul>
<p>支撑这个逻辑的两个关键基础：</p>
<ul>
<li><strong>Fiber 数据结构</strong>：每个 Fiber 节点对应一个组件，除了保存组件的 props/state 外，还增加了 <code>return</code>（父节点）、<code>child</code>（子节点）、<code>sibling</code>（兄弟节点）等指针，形成链表结构——这是“中断后能恢复”的关键（递归栈无法记录中断点，链表可以）；</li>
<li><strong>Scheduler 调度器</strong>：React 自研的调度模块，负责给任务分配优先级、计算空闲时间、控制任务的执行/暂停。</li>
</ul>
<h4 data-id="heading-11">一、拆分的核心基础：Fiber 节点是「可独立处理的最小单元」</h4>
<p>要拆分任务，首先得有「可拆分的最小单元」—— Fiber 节点就是这个单元。
React 把每一个组件（无论是类组件、函数组件还是原生标签）都对应成一个 Fiber 节点，并且给每个节点设计了<strong>链表指针</strong>（<code>child</code>/<code>sibling</code>/<code>return</code>），替代了原来的递归树结构。</p>
<p>每个 Fiber 节点都包含了「处理该节点所需的全部信息」，比如：</p>
<ul>
<li>组件的 <code>props</code>/<code>state</code>；</li>
<li>对应的真实 DOM 节点；</li>
<li>要执行的操作（比如「更新」「新增」「删除」）；</li>
<li>链表指针（找到下一个要处理的节点）。</li>
</ul>
<p>这意味着：<strong>处理单个 Fiber 节点不需要依赖其他节点的执行结果</strong>，可以单独作为一个「小任务」来执行——这是任务能被拆分的核心前提。</p>
<h4 data-id="heading-12">二、任务拆分的核心逻辑：从「递归整树处理」→「迭代逐个节点处理」</h4>
<p>Stack Reconciler 是「一次性递归遍历整棵树」，而 Fiber 架构则是把「整树处理」拆成「处理单个节点」的小任务，通过<strong>迭代 + 链表遍历</strong>的方式逐个执行，具体拆分逻辑如下：</p>
<h5 data-id="heading-13">1. 拆分原则</h5>
<ul>
<li>大任务：整棵组件树的渲染更新（Reconciliation 阶段）；</li>
<li>小任务：处理<strong>一个 Fiber 节点</strong>（包括：对比新旧节点、标记副作用、确定下一个要处理的节点）；</li>
<li>拆分方式：按「深度优先 + 链表遍历」的顺序，把整树的处理拆成一个个独立的「单个节点处理任务」。</li>
</ul>
<h5 data-id="heading-14">2. 链表遍历的顺序（决定小任务的执行顺序）</h5>
<p>Fiber 链表的遍历遵循「深度优先」，但通过指针实现迭代（而非递归），顺序是：</p>
<ol>
<li>先处理当前节点（小任务 1）；</li>
<li>如果有子节点（<code>child</code>），下一个处理子节点（小任务 2）；</li>
<li>如果没有子节点，但有兄弟节点（<code>sibling</code>），下一个处理兄弟节点（小任务 3）；</li>
<li>如果既没有子节点也没有兄弟节点，回到父节点（<code>return</code>），再找父节点的兄弟节点（小任务 4）；</li>
<li>直到回到根节点，所有小任务执行完毕。</li>
</ol>
<p>这个过程就像「走迷宫」：先往深走（子节点），走到底就往旁边走（兄弟节点），旁边也走完就退回去（父节点），再往旁边走——每走一步，就是执行一个小任务。</p>
<h4 data-id="heading-15">三、代码模拟：直观看到任务是怎么拆分的</h4>
<p>下面用简化代码模拟 Fiber 的任务拆分和执行过程，你能清晰看到「整树任务」是如何被拆成「单个节点任务」的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 定义 Fiber 节点（最小任务单元）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, props</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件/标签名（如 App、Div）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = props; <span class="hljs-comment">// 组件 props</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一个子节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 下一个兄弟节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 父节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 要执行的操作（新增/更新/删除）</span>
  }
}

<span class="hljs-comment">// 2. 构建 Fiber 链表（模拟组件树）</span>
<span class="hljs-comment">// 结构：App → Header → Logo → Nav → Content → Article → Footer</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'App'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Header</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Header'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Logo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Logo'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Nav</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Nav'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Content</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Content'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Article</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Article'</span>, {});
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Footer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(<span class="hljs-string">'Footer'</span>, {});

<span class="hljs-comment">// 设置链表指针（构建依赖关系）</span>
<span class="hljs-title class_">App</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Logo</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Logo</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Nav</span>;
<span class="hljs-title class_">Nav</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Header</span>;
<span class="hljs-title class_">Header</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">child</span> = <span class="hljs-title class_">Article</span>;
<span class="hljs-title class_">Article</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">Content</span>;
<span class="hljs-title class_">Content</span>.<span class="hljs-property">sibling</span> = <span class="hljs-title class_">Footer</span>;
<span class="hljs-title class_">Footer</span>.<span class="hljs-property">return</span> = <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-16">总结（核心关键点）</h4>
<ol>
<li><strong>拆分基础</strong>：Fiber 节点是「可独立处理的最小单元」，链表指针（<code>child</code>/<code>sibling</code>/<code>return</code>）让节点能被逐个遍历，无需依赖递归栈；</li>
<li><strong>拆分方式</strong>：把「整棵组件树的渲染更新」拆成「处理单个 Fiber 节点」的原子小任务，按「深度优先 + 链表遍历」的顺序逐个执行；</li>
<li><strong>可中断核心</strong>：工作循环每次只执行一个小任务，执行前检查时间，不足则中断并记录断点，恢复时从断点继续——这也是拆分的最终目的：让长任务变可中断。</li>
</ol>
<p><strong><code>简单来说，Fiber 的任务拆分就像「把一本厚书拆成一页页来读」：原来的 Stack Reconciler 是「一口气读完整本书」，而 Fiber 是「读一页，看看有没有时间，有就继续读下一页，没有就合上书记下页码，下次从这页继续读」。</code></strong></p>
<h3 data-id="heading-17">为什么 Stack Reconciler 的「一次性递归遍历整棵树」做不到像 Fiber 那样把节点处理拆成独立小任务</h3>
<h4 data-id="heading-18">一、核心差异：递归遍历中「节点处理不具备独立性」</h4>
<p>Fiber 能拆分任务的关键是「单个节点的处理不依赖其他节点的执行上下文」，但 Stack Reconciler 的递归遍历中，<strong>处理子节点是父节点处理逻辑的「嵌套部分」，完全依赖父节点的调用上下文，无法单独拆分</strong>。</p>
<h5 data-id="heading-19">1. 先看 Stack Reconciler 的递归代码（核心片段）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Stack Reconciler 处理父节点的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 1. 处理当前父节点的逻辑</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">tag</span> !== newVNode.<span class="hljs-property">tag</span>) { <span class="hljs-comment">/* 标记替换 */</span> }

  <span class="hljs-comment">// 2. 遍历子节点 —— 这是父节点处理逻辑的「一部分」</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLen; i++) {
    <span class="hljs-keyword">const</span> oldChild = oldVNode.<span class="hljs-property">children</span>[i];
    <span class="hljs-keyword">const</span> newChild = newVNode.<span class="hljs-property">children</span>[i];
    
    <span class="hljs-comment">// 3. 递归处理子节点 —— 这个调用「嵌套在父节点的函数体中」</span>
    <span class="hljs-keyword">if</span> (oldChild &amp;&amp; newChild) {
      <span class="hljs-title function_">reconcile</span>(oldChild, newChild); <span class="hljs-comment">// 子节点处理依赖父节点的循环上下文</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-20">2. 递归模式下的「依赖陷阱」</h5>
<p>从代码能清晰看到：</p>
<ul>
<li>「处理子节点」不是一个「独立任务」，而是父节点 <code>reconcile</code> 函数执行过程中的<strong>嵌套步骤</strong>；</li>
<li>要处理子节点，必须先进入父节点的 <code>reconcile</code> 函数，且父节点的 <code>for</code> 循环必须执行到对应子节点的索引；</li>
<li><strong><code>子节点的递归调用「依附于父节点的调用栈」—— 父节点的函数没执行完，子节点的调用就无法独立存在；反过来，子节点的递归没返回，父节点的函数也无法结束。</code></strong></li>
</ul>
<p>举个通俗例子：</p>
<ul>
<li>Fiber 模式：每个节点是「独立的快递包裹」，处理一个包裹只需要包裹本身的信息，不用管其他包裹，能拆成一个个独立任务；</li>
<li>Stack 递归模式：所有节点是「一串连在一起的鞭炮」，要炸到第 5 个鞭炮，必须先点第 1 个，且中间不能停 —— 第 5 个的爆炸依赖前 4 个的传导，无法单独拆出第 5 个来炸。</li>
</ul>
<h4 data-id="heading-21">二、底层限制：JS 调用栈的「同步不可中断性」</h4>
<p>Stack Reconciler 依赖 JS 函数调用栈实现递归，而调用栈的特性决定了「一旦开始递归，必须执行到底」：</p>





















<table><thead><tr><th>Fiber 架构（迭代+链表）</th><th>Stack Reconciler（递归+调用栈）</th></tr></thead><tbody><tr><td>用「变量记录当前节点」（<code>workInProgress</code>），中断时只需保存这个变量</td><td>用「调用栈记录执行位置」，栈的层级和节点嵌套深度绑定</td></tr><tr><td>中断时：保存当前节点变量，直接退出循环，调用栈清空</td><td>中断时：无法退出——调用栈必须等嵌套的递归函数全部返回才能清空</td></tr><tr><td>恢复时：从保存的节点变量继续迭代，无需恢复调用栈</td><td>恢复时：无法实现——调用栈一旦弹出，无法还原之前的嵌套状态</td></tr></tbody></table>
<h5 data-id="heading-22">关键举例：递归调用栈的「不可回退性」</h5>
<p>假设组件树是 <code>App → Header → Logo</code>，递归处理时调用栈的变化是：</p>
<ol>
<li>调用 <code>reconcile(App)</code> → 栈：<code>[reconcile(App)]</code></li>
<li>遍历 App 的子节点，调用 <code>reconcile(Header)</code> → 栈：<code>[reconcile(App), reconcile(Header)]</code></li>
<li>遍历 Header 的子节点，调用 <code>reconcile(Logo)</code> → 栈：<code>[reconcile(App), reconcile(Header), reconcile(Logo)]</code></li>
</ol>
<p>此时如果想「中断处理 Logo，先处理其他任务」，不可能：</p>
<ul>
<li>要中断，必须让 <code>reconcile(Logo)</code> 执行完并返回 → 栈变成 <code>[reconcile(App), reconcile(Header)]</code>；</li>
<li>再让 <code>reconcile(Header)</code> 执行完并返回 → 栈变成 <code>[reconcile(App)]</code>；</li>
<li>最后让 <code>reconcile(App)</code> 执行完 → 栈清空。</li>
</ul>
<p><strong><code>整个过程中，你无法「暂停在 Logo 节点」，因为调用栈的层级和节点处理深度是强绑定的 —— 栈的状态就是执行位置，而栈无法被「冻结」或「保存」，只能按顺序弹出。 </code></strong></p>
<p>而 Fiber 架构中，执行位置是靠「变量（<code>workInProgress</code>）」记录的，不是调用栈：</p>
<ul>
<li>处理到 Logo 节点时，<code>workInProgress = Logo</code>；</li>
<li>想中断？直接退出循环，保存 <code>workInProgress = Logo</code> 即可，调用栈完全清空；</li>
<li>恢复时，把 <code>workInProgress</code> 设为 Logo，重新启动循环就能继续处理，无需依赖任何栈状态。</li>
</ul>
<h4 data-id="heading-23">三、处理单元的本质：「整树遍历」vs「单个节点处理」</h4>
<p>Stack Reconciler 的「最小处理单元」是「整棵树的遍历」，而 Fiber 的「最小处理单元」是「单个节点的处理」—— 这是能否拆分的根本：</p>
<ol>
<li>
<p><strong>Stack Reconciler</strong>：</p>
<ul>
<li>开发者调用 <code>setState</code> 后，React 启动的是「整棵树的 reconcile 任务」，这个任务是「不可分割的整体」；</li>
<li>即使你只想更新一个 Logo 节点，也必须从 App 根节点开始，递归遍历到 Logo，再逐层返回 —— 整个过程是一个「大任务」，没有更小的可执行单元。</li>
</ul>
</li>
<li>
<p><strong>Fiber 架构</strong>：</p>
<ul>
<li>启动的是「遍历链表的工作循环」，这个循环的「最小执行单元」是「处理单个 Fiber 节点」；</li>
<li>想更新 Logo 节点？工作循环可以只执行「处理 Logo 节点」这个小任务，时间不够就暂停，完全不影响其他节点的处理状态。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-24">总结（核心关键点）</h4>
<ol>
<li><strong>独立性差异</strong>：Stack 递归中，子节点处理是父节点逻辑的嵌套部分，依赖父节点的调用上下文，无法拆成独立任务；Fiber 节点包含全部处理信息，单个节点处理无需依赖其他节点；</li>
<li><strong>执行载体差异</strong>：Stack 依赖 JS 调用栈，栈的同步特性决定了递归必须执行到底，无法中断/保存状态；Fiber 依赖变量记录当前节点，迭代执行，可随时中断并保存执行位置；</li>
<li><strong>最小单元差异</strong>：Stack 的最小处理单元是「整树遍历」，Fiber 的最小处理单元是「单个节点处理」—— 这是能否拆分的核心。</li>
</ol>
<p>简单来说：Stack Reconciler 就像「用一根绳子串起所有珠子，要拿最后一颗必须把整串拉到底」；而 Fiber 是「每个珠子都有独立的标签和位置信息，想拿哪颗就拿哪颗，拿一半放下也能记住位置」。这就是递归遍历无法拆分，而 Fiber 能拆分的根本原因。</p>
<h3 data-id="heading-25">「中断后能恢复」的关键是<strong>能否精准记住「下一个该处理的节点」</strong></h3>
<p>本质上，「中断后能恢复」的关键是 <strong><code>能否精准记住「下一个该处理的节点」</code></strong> —— 递归栈的执行逻辑天然做不到这一点，而 Fiber 链表通过「显式的节点引用 + 独立变量记录」完美解决了这个问题。下面我用「通俗例子 + 逻辑拆解 + 对比」的方式讲透。</p>
<h4 data-id="heading-26">一、先明确：中断点需要记录什么？</h4>
<p>不管是递归还是 Fiber，想中断后恢复，必须记住一个核心信息：</p>
<blockquote>
<p><strong>中断时，下一个该处理的节点是谁？</strong>
比如处理到 <code>App → Header → Logo</code> 后中断，需要记住「接下来该处理 Logo 的兄弟节点 Nav」，恢复时直接从 Nav 开始，而不是从头重新处理 App。</p>
</blockquote>
<p>这是恢复的核心前提 —— 递归栈做不到记录这个信息，而链表可以。</p>
<h4 data-id="heading-27">二、递归栈为什么「无法记录中断点」？</h4>
<p><strong><code>递归栈的执行位置，是靠 **JS 调用栈的「层级」和「函数执行上下文」** 来隐式记录的，而非显式的节点引用 —— 这意味着一旦中断，这些上下文会全部丢失，无法还原。</code></strong></p>
<h5 data-id="heading-28">1. 递归栈的「执行位置」绑定调用栈层级</h5>
<p>举个具体例子：组件树是 <code>App → Header → Logo（子）/ Nav（兄弟）</code>，递归处理时的调用栈变化：</p>
<pre><code class="hljs language-css" lang="css">// 步骤<span class="hljs-number">1</span>：调用 reconcile(App) → 栈：<span class="hljs-selector-attr">[reconcile(App)]</span>
// 步骤<span class="hljs-number">2</span>：遍历 App 子节点，调用 reconcile(<span class="hljs-selector-tag">Header</span>) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header)]</span>
// 步骤<span class="hljs-number">3</span>：遍历 <span class="hljs-selector-tag">Header</span> 子节点，调用 reconcile(Logo) → 栈：<span class="hljs-selector-attr">[reconcile(App), reconcile(Header), reconcile(Logo)]</span>
</code></pre>
<p>此时想中断（比如时间不足），要处理的下一个节点是 <code>Nav</code>（Logo 的兄弟），但递归栈的问题来了：</p>
<ul>
<li>「下一个该处理 Nav」这个信息，只存在于 <code>reconcile(Header)</code> 函数的<strong>执行上下文</strong>中（比如循环变量 <code>i=1</code>，对应 Header 子节点的第二个元素）；</li>
<li>调用栈的层级只记录「当前正在执行 reconcile(Logo)」，但<strong>无法直接记录「下一个节点是 Nav」</strong>；</li>
<li>如果强行中断（比如退出函数），<code>reconcile(Logo)</code> 会返回，<code>reconcile(Header)</code> 的执行上下文（循环变量 <code>i</code>、Header 节点的引用）会被销毁，调用栈回到 <code>[reconcile(App)]</code>；</li>
<li>等恢复时，你只知道「之前执行到过 Logo」，但完全不知道「下一个该处理 Nav」—— 只能从头重新调用 <code>reconcile(App)</code>，相当于白执行了前面的步骤。</li>
</ul>
<h5 data-id="heading-29">2. 递归栈的「不可恢复性」核心</h5>





















<table><thead><tr><th>递归栈的特性</th><th>导致的问题</th></tr></thead><tbody><tr><td>执行位置靠「栈层级 + 函数上下文」隐式记录</td><td>中断时函数上下文销毁，无法记住「下一个节点」</td></tr><tr><td>调用栈只能「先进后出」，无法暂停/保存</td><td>要么执行完当前递归，要么全部退出，没有中间状态</td></tr><tr><td>没有独立变量记录「待处理节点」</td><td>恢复时只能从头开始，无法从中断点继续</td></tr></tbody></table>
<p>通俗比喻：递归栈就像「在纸上写作业，没写完就被擦掉」—— 你只知道写到了第3题，但不知道第3题写完后该写第4题，只能重新从第1题开始写。</p>
<h4 data-id="heading-30">三、Fiber 链表为什么「能记录中断点」？</h4>
<p>Fiber 架构放弃了递归栈，改用 <strong>「独立变量 + 链表指针」显式记录中断点</strong> —— 中断点的核心信息（下一个待处理节点）被保存在一个独立变量（<code>workInProgress</code>）中，和调用栈无关，就算中断也不会丢失。</p>
<h5 data-id="heading-31">1. 链表的「执行位置」绑定「节点引用」</h5>
<p>还是同一个例子：组件树 <code>App → Header → Logo / Nav</code>，Fiber 处理时的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化：待处理节点 = App</span>
<span class="hljs-keyword">let</span> workInProgress = <span class="hljs-title class_">App</span>;

<span class="hljs-comment">// 步骤1：处理 App → 找到下一个节点（App.child = Header）→ workInProgress = Header</span>
<span class="hljs-comment">// 步骤2：处理 Header → 找到下一个节点（Header.child = Logo）→ workInProgress = Logo</span>
<span class="hljs-comment">// 步骤3：处理 Logo → 找到下一个节点（Logo.sibling = Nav）→ workInProgress = Nav</span>
</code></pre>
<p>此时想中断：</p>
<ul>
<li>只需要保存 <code>workInProgress = Nav</code> 这个变量（记录「下一个该处理 Nav」），然后直接退出循环即可；</li>
<li>调用栈会被清空（因为是迭代而非递归），但 <code>workInProgress</code> 变量不会消失；</li>
<li>恢复时，直接把 <code>workInProgress</code> 设为 Nav，重新启动循环：<code>处理 Nav → 找到下一个节点（Nav.return = Header → Header.sibling = Content）→ workInProgress = Content</code>，完美继续。</li>
</ul>
<h5 data-id="heading-32">2. 链表指针让「中断点可追溯」</h5>
<p>Fiber 节点的 <code>child</code>/<code>sibling</code>/<code>return</code> 指针，让每个节点都能「找到自己的下一个节点」，无需依赖调用栈：</p>
<ul>
<li>就算中断时只记住了 <code>Nav</code>，通过 <code>Nav.return</code> 能找到 Header，通过 <code>Header.sibling</code> 能找到 Content，永远不会「迷路」；</li>
<li>而递归栈一旦丢失上下文，节点之间的关系就无从追溯。</li>
</ul>
<h5 data-id="heading-33">3. 链表的「可恢复性」核心</h5>





















<table><thead><tr><th>Fiber 链表的特性</th><th>解决的问题</th></tr></thead><tbody><tr><td>执行位置靠「workInProgress 变量」显式记录</td><td>中断时只需保存这个变量，上下文不丢失</td></tr><tr><td>节点关系靠指针（child/sibling/return）显式关联</td><td>从任意节点都能找到下一个待处理节点</td></tr><tr><td>迭代执行，调用栈随时可清空</td><td>中断时不依赖栈层级，恢复时直接用变量继续</td></tr></tbody></table>
<p>通俗比喻：Fiber 链表就像「在作业本上贴便利贴，写不完就贴在第4题上」—— 就算合上书，下次打开看到便利贴，直接从第4题开始写就行，不用重新写。</p>
<h4 data-id="heading-34">四、直观对比：递归栈 vs Fiber 链表（中断恢复）</h4>






























<table><thead><tr><th>场景</th><th>递归栈</th><th>Fiber 链表</th></tr></thead><tbody><tr><td>处理到 Logo 后中断</td><td>调用栈层级丢失，循环变量销毁，不知道下一个是 Nav</td><td>保存 workInProgress = Nav，变量不丢失</td></tr><tr><td>恢复执行</td><td>只能重新从 App 开始递归，重复处理 App/Header/Logo</td><td>直接从 workInProgress = Nav 开始，处理 Nav/Content/...</td></tr><tr><td>核心记录方式</td><td>隐式（栈层级 + 函数上下文）</td><td>显式（独立变量 + 节点引用）</td></tr><tr><td>能否恢复</td><td>❌ 不能，只能重跑</td><td>✅ 能，精准继续</td></tr></tbody></table>
<h4 data-id="heading-35">总结（核心关键点）</h4>
<ol>
<li><strong>中断点的核心是记录「下一个待处理节点」</strong>：<strong><code>递归栈靠「调用栈层级 + 函数上下文」隐式记录，中断后上下文销毁，无法还原；Fiber 靠 </code>workInProgress<code> 变量显式记录节点引用，中断后变量不丢失。</code></strong></li>
<li><strong>链表指针是恢复的基础</strong>：<code>child</code>/<code>sibling</code>/<code>return</code> 让每个节点都能找到下一个节点，无需依赖调用栈，从任意中断点都能继续遍历。</li>
<li><strong>递归栈的本质是「依赖栈状态」，链表的本质是「依赖节点引用」</strong>：栈状态不可保存，节点引用可保存 —— 这是「能否中断恢复」的根本区别。</li>
</ol>
<p>简单来说：递归栈是「靠记忆记位置」，中断后忘了就只能重来了；Fiber 链表是「靠笔记记位置」，中断后看笔记就能精准继续。这就是链表能记录中断点、递归栈做不到的核心原因。</p>
<h3 data-id="heading-36">2. Fiber 分片/中断的执行机制 -- Scheduler</h3>
<p>Fiber 的执行分为两个核心阶段，只有第一个阶段可中断：</p>























<table><thead><tr><th>阶段</th><th>名称</th><th>核心操作</th><th>是否可中断</th></tr></thead><tbody><tr><td>阶段1</td><td>Reconciliation（协调/渲染）</td><td>对比新旧 Fiber 树、标记 DOM 变更（副作用）</td><td>✅ 可中断、可暂停、可重启</td></tr><tr><td>阶段2</td><td>Commit（提交）</td><td>将标记的副作用应用到真实 DOM</td><td>❌ 不可中断（DOM 操作必须一次性完成，避免页面不完整）</td></tr></tbody></table>
<p><strong>分片/中断的具体执行流程</strong>：</p>
<ol>
<li><strong>任务调度</strong>：当组件触发更新（如 setState），Scheduler 会根据任务优先级（比如用户输入 &gt; 数据请求）将任务加入调度队列；</li>
<li><strong>启动迭代遍历</strong>：不再递归遍历组件树，而是基于 Fiber 链表做迭代式深度优先遍历：
<ul>
<li>先处理当前 Fiber 节点（比如计算 props、对比子节点）；</li>
<li>处理完后，检查“剩余空闲时间”：如果还有时间，就取下一个 Fiber 节点（child → sibling → return）继续处理；如果没有时间，就暂停遍历；</li>
</ul>
</li>
<li><strong>中断逻辑</strong>：暂停时，React 会记录当前“工作中的 Fiber 节点”（workInProgress），然后调用 <code>requestIdleCallback</code>（或 React 模拟的空闲回调），把控制权还给浏览器，让浏览器执行布局、绘制等操作；</li>
<li><strong>恢复逻辑</strong>：当浏览器进入下一次空闲期，Scheduler 会唤醒暂停的任务，从之前记录的 workInProgress 节点继续遍历，直到所有 Fiber 节点处理完毕；</li>
<li><strong>提交阶段</strong>：协调阶段完成后，React 会一次性执行所有标记的 DOM 变更，这个过程不可中断，保证 DOM 状态的一致性。</li>
</ol>
<h3 data-id="heading-37">Scheduler 调度器的具体实现原理</h3>
<p>Scheduler 本质是一个「智能任务调度中心」，核心目标是<strong>让高优先级任务优先执行，低优先级任务利用空闲时间执行，且所有任务都能被中断/恢复</strong>。下面我会从「优先级设计」「空闲时间计算」「任务执行/暂停控制」三个核心维度，拆解它的实现逻辑，还会附上简化代码模拟核心流程。</p>
<h4 data-id="heading-38">一、核心前置认知</h4>
<p>Scheduler 是独立于 React 核心的模块（甚至可以单独使用），它的实现不依赖 Fiber 架构，但为 Fiber 提供了「可中断渲染」的基础能力。其核心设计思路是：</p>
<ul>
<li><strong><code>用「过期时间」量化任务优先级，而非单纯的“高/中/低”标签；</code></strong></li>
<li><strong><code>用「requestAnimationFrame + postMessage」模拟高精度空闲回调，替代原生 </code>requestIdleCallback<code>；</code></strong></li>
<li><strong><code>用「工作循环 + 时间检查」实现任务的执行、中断与恢复。</code></strong></li>
</ul>
<h4 data-id="heading-39">二、模块1：任务优先级的实现</h4>
<p>Scheduler 不直接用“优先级等级”，而是用<strong>过期时间（expirationTime）</strong> 来定义优先级——优先级越高，任务的过期时间越短（越早需要执行）。</p>
<h5 data-id="heading-40">1. 优先级与过期时间的映射</h5>
<p>React 定义了 5 类核心优先级（对应不同的过期时间阈值），本质是「任务必须在多久内执行，否则用户会感知到卡顿」：</p>









































<table><thead><tr><th>优先级名称</th><th>过期时间（当前时间 + X）</th><th>适用场景</th><th>核心特点</th></tr></thead><tbody><tr><td>ImmediatePriority</td><td>0ms（立即过期）</td><td>同步执行的紧急任务（如报错）</td><td>阻塞渲染，必须立即执行</td></tr><tr><td>UserBlockingPriority</td><td>250ms</td><td>用户交互（点击/输入/滚动）</td><td>250ms内执行，否则感知卡顿</td></tr><tr><td>NormalPriority</td><td>5000ms</td><td>普通任务（如网络请求回调）</td><td>不紧急，可延迟</td></tr><tr><td>LowPriority</td><td>10000ms</td><td>低优先级任务（如非关键数据加载）</td><td>可大幅延迟</td></tr><tr><td>IdlePriority</td><td>Infinity（永不过期）</td><td>空闲任务（如日志/统计）</td><td>只有浏览器空闲时才执行</td></tr></tbody></table>
<h5 data-id="heading-41">2. 优先级队列的实现：最小堆（小顶堆）</h5>
<p>Scheduler 用<strong>最小堆</strong>管理所有待执行任务，<strong><code>堆的排序依据是「过期时间」——堆顶永远是「过期时间最早（优先级最高）」的任务，保证高优先级任务先执行。</code></strong></p>
<ul>
<li>为什么用最小堆？<strong><code>堆的「取顶（O(1)）」「插入（O(logn)）」效率远高于普通数组排序，适合频繁新增/取出任务的场景；</code></strong></li>
<li>核心操作：
<ul>
<li>新增任务：插入堆中，堆自动调整，保持堆顶是最高优先级任务；</li>
<li>执行任务：每次从堆顶取出任务执行，执行完后重新调整堆。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-42">三、模块2：空闲时间计算的实现</h4>
<p>原生 <code>requestIdleCallback</code> 有两个致命问题：① 兼容性差；② 触发时机不稳定（帧率低于 60fps 时可能不触发）。因此 Scheduler 用「requestAnimationFrame (rAF) + postMessage」模拟高精度的空闲时间计算。</p>
<h5 data-id="heading-43">1. 核心原理</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs">事件处理 → 宏任务 → 微任务 → rAF → 布局 → 绘制 → 空闲时间
</code></pre>
<p>Scheduler 利用 rAF 精准获取每帧的开始时间，再用 postMessage 触发宏任务，在宏任务中计算「当前帧剩余的空闲时间」。</p>
<h5 data-id="heading-44">2. 空闲时间计算的步骤（代码级逻辑）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 步骤1：用 rAF 获取每帧的开始时间</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;
<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  frameStartTime = timestamp; <span class="hljs-comment">// 记录当前帧的开始时间（ms）</span>
});

<span class="hljs-comment">// 步骤2：计算当前帧的剩余空闲时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 16.6ms = 1000ms / 60fps（每帧总时长）</span>
  <span class="hljs-keyword">const</span> frameDuration = <span class="hljs-number">16.6</span>;
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - frameStartTime; <span class="hljs-comment">// 已用时间</span>
  <span class="hljs-keyword">const</span> remainingTime = frameDuration - elapsedTime; <span class="hljs-comment">// 剩余空闲时间</span>
  <span class="hljs-comment">// 预留 5ms 安全阈值，避免占用渲染时间</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remainingTime - <span class="hljs-number">5</span>);
}

<span class="hljs-comment">// 步骤3：用 postMessage 触发空闲任务执行</span>
<span class="hljs-comment">// 原因：postMessage 的宏任务会在「绘制完成后、下一次 rAF 前」执行，正好对应空闲时间</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">calculateRemainingTime</span>();
  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 有空闲时间，执行调度任务</span>
    <span class="hljs-title function_">workLoop</span>(remainingTime);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 无空闲时间，等待下一次 rAF</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(channel.<span class="hljs-property">port1</span>.<span class="hljs-property">postMessage</span>.<span class="hljs-title function_">bind</span>(channel.<span class="hljs-property">port1</span>));
  }
};
</code></pre>
<h5 data-id="heading-45">3. 5ms 阈值的作用</h5>
<p>计算剩余时间时，会强制减去 5ms——这是为了预留足够时间给浏览器完成「布局/绘制」，避免任务执行超时导致丢帧。</p>
<h4 data-id="heading-46">四、模块3：任务执行/暂停的实现</h4>
<p>Scheduler 的核心是「工作循环（workLoop）」，它会逐次取出高优先级任务，执行“一小段”后检查剩余时间，不足则暂停，空闲时恢复。</p>
<h5 data-id="heading-47">1. 核心流程（简化代码模拟）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟：最小堆任务队列（简化版，仅示意）</span>
<span class="hljs-keyword">const</span> taskQueue = [];

<span class="hljs-comment">// 1. 新增任务（带优先级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleTask</span>(<span class="hljs-params">callback, priorityLevel</span>) {
  <span class="hljs-comment">// 步骤1：计算过期时间（当前时间 + 优先级对应的阈值）</span>
  <span class="hljs-keyword">const</span> expirationTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-title function_">getExpirationTimeByPriority</span>(priorityLevel);
  <span class="hljs-comment">// 步骤2：插入最小堆队列</span>
  taskQueue.<span class="hljs-title function_">push</span>({ callback, expirationTime, <span class="hljs-attr">isPending</span>: <span class="hljs-literal">true</span> });
  taskQueue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">expirationTime</span> - b.<span class="hljs-property">expirationTime</span>); <span class="hljs-comment">// 简化堆排序</span>
  <span class="hljs-comment">// 步骤3：触发调度（启动工作循环）</span>
  <span class="hljs-title function_">startWorkLoop</span>();
}

<span class="hljs-comment">// 2. 工作循环（核心：执行/中断/恢复）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">remainingTime</span>) {
  <span class="hljs-comment">// 取出堆顶任务（最高优先级）</span>
  <span class="hljs-keyword">let</span> currentTask = taskQueue[<span class="hljs-number">0</span>];
  
  <span class="hljs-keyword">while</span> (currentTask &amp;&amp; remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 检查任务是否过期/取消</span>
    <span class="hljs-keyword">if</span> (currentTask.<span class="hljs-property">expirationTime</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() || !currentTask.<span class="hljs-property">isPending</span>) {
      taskQueue.<span class="hljs-title function_">shift</span>(); <span class="hljs-comment">// 移除过期/取消的任务</span>
      currentTask = taskQueue[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-comment">// 执行任务的「一小段」（而非一次性执行完）</span>
    <span class="hljs-comment">// 关键点：callback 返回是否需要继续执行（true=未完成，false=完成）</span>
    <span class="hljs-keyword">const</span> needContinue = currentTask.<span class="hljs-title function_">callback</span>(remainingTime);
    
    <span class="hljs-keyword">if</span> (needContinue) {
      <span class="hljs-comment">// 任务未完成，计算剩余时间（模拟执行消耗）</span>
      remainingTime -= <span class="hljs-number">1</span>; <span class="hljs-comment">// 假设执行一小段消耗 1ms</span>
      <span class="hljs-comment">// 剩余时间不足 5ms，中断任务</span>
      <span class="hljs-keyword">if</span> (remainingTime &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'⚠️ 时间不足，暂停任务'</span>);
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 退出循环，任务留在队列中</span>
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 任务完成，移除队列</span>
      taskQueue.<span class="hljs-title function_">shift</span>();
      currentTask = taskQueue[<span class="hljs-number">0</span>];
    }
  }

  <span class="hljs-comment">// 任务未执行完，下次空闲时恢复</span>
  <span class="hljs-keyword">if</span> (currentTask) {
    <span class="hljs-comment">// 重新触发 postMessage，等待下一次空闲</span>
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'continue'</span>);
  }
}

<span class="hljs-comment">// 3. 启动工作循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startWorkLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    frameStartTime = timestamp;
    channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">'start'</span>); <span class="hljs-comment">// 触发 postMessage 回调</span>
  });
}

<span class="hljs-comment">// 辅助函数：根据优先级获取过期时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getExpirationTimeByPriority</span>(<span class="hljs-params">priority</span>) {
  <span class="hljs-keyword">const</span> priorities = {
    <span class="hljs-string">'immediate'</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">'user-blocking'</span>: <span class="hljs-number">250</span>,
    <span class="hljs-string">'normal'</span>: <span class="hljs-number">5000</span>,
    <span class="hljs-string">'low'</span>: <span class="hljs-number">10000</span>,
    <span class="hljs-string">'idle'</span>: <span class="hljs-title class_">Infinity</span>
  };
  <span class="hljs-keyword">return</span> priorities[priority] || <span class="hljs-number">5000</span>;
}

<span class="hljs-comment">// 测试：新增一个用户交互任务（高优先级）</span>
<span class="hljs-title function_">scheduleTask</span>(<span class="hljs-function">(<span class="hljs-params">remainingTime</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`执行任务，剩余时间：<span class="hljs-subst">${remainingTime}</span>ms`</span>);
  <span class="hljs-comment">// 模拟任务需要多次执行（返回 true 表示未完成）</span>
  <span class="hljs-keyword">return</span> remainingTime &gt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 剩余时间&gt;10ms 才继续，否则暂停</span>
}, <span class="hljs-string">'user-blocking'</span>);
</code></pre>
<h5 data-id="heading-48">2. 关键逻辑拆解</h5>
<ul>
<li><strong>任务可中断</strong>：任务的回调函数不是一次性执行完，而是返回「是否需要继续执行」——如果剩余时间不足，工作循环会退出，任务留在队列中；</li>
<li><strong>任务可恢复</strong>：中断后，Scheduler 会再次触发 <code>postMessage</code>，下一次空闲时重新启动工作循环，从队列中取出未完成的任务继续执行；</li>
<li><strong>任务取消</strong>：每个任务都有 <code>isPending</code> 标记，外部可通过修改该标记取消任务，工作循环会跳过已取消的任务。</li>
</ul>
<h4 data-id="heading-49">五、Scheduler 与 Fiber 的联动</h4>
<p>Scheduler 并不直接操作 Fiber 节点，而是给 Fiber 的「工作循环」提供“时间切片”能力：</p>
<ol>
<li>Fiber 把「处理单个节点」作为小任务，传给 Scheduler；</li>
<li>Scheduler 按优先级调度这个小任务，执行前检查空闲时间；</li>
<li>时间不足时，Scheduler 暂停执行，通知 Fiber 记录当前 <code>workInProgress</code> 节点；</li>
<li>下一次空闲时，Scheduler 恢复执行，Fiber 从 <code>workInProgress</code> 继续处理节点。</li>
</ol>
<h4 data-id="heading-50">总结（核心关键点）</h4>
<ol>
<li><strong>优先级实现</strong>：用「过期时间」量化优先级，结合「最小堆」保证高优先级任务先执行；</li>
<li><strong>空闲时间计算</strong>：基于 <code>rAF + postMessage</code> 模拟高精度空闲回调，替代原生 <code>requestIdleCallback</code>，并预留 5ms 安全阈值；</li>
<li><strong>执行/暂停控制</strong>：工作循环逐次执行任务的“小单元”，执行中持续检查剩余时间，不足则中断，下次空闲时从断点恢复。</li>
</ol>
<p>简单来说，Scheduler 就像「交通调度员」：给紧急车辆（高优先级任务）开绿灯，普通车辆（低优先级任务）错峰通行，且所有车辆都能临时靠边（中断），等道路空闲后再继续行驶（恢复）。</p>
<h3 data-id="heading-51">调度逻辑的核心底气：单个 Fiber 执行足够短</h3>
<p>React 这套调度逻辑的核心底气：<strong>从设计上把「单个 Fiber 执行足够短」做成「必然结果」，而非「偶然运气」</strong>，因此哪怕多执行一个，带来的耗时增量也只是微秒级，完全在浏览器的帧时间安全范围内，不会有任何“大碍”。</p>
<p>更准确地说，这个「坚信」不是凭空的设计自信，而是<strong>三层硬约束下的必然结论</strong>，让「单个 Fiber 执行短」成为不可打破的规则，这也是整个 Scheduler 敢放弃“精准预估”、采用“实时校验+容忍多执行一个”的底层前提：</p>
<h4 data-id="heading-52">1. 处理逻辑的硬约束：只做「纯内存原子操作」</h4>
<p>单个 Fiber 节点的处理被严格限定在<strong>无阻塞、无复杂计算、无IO</strong>的内存操作内：
props浅对比、副作用标记、链表指针读取，这些操作的耗时由 JS 引擎的内存访问速度决定，<strong>天然稳定在 0.1ms 以内</strong>，不会出现任何耗时突变。
不存在“一个 Fiber 处理突然花了 1ms”的可能，因为这类操作从根源上被排除在单个 Fiber 的处理逻辑之外。</p>
<h4 data-id="heading-53">2. 组件拆分的工程要求：复杂逻辑必须拆分为多个 Fiber - 对开发者，非强制</h4>
<p>React 的 Fiber 树构建规则强制要求：<strong>任何包含复杂计算/逻辑的组件，必须拆分为子组件</strong>，进而对应多个 Fiber 节点。
比如一个渲染时要做大量数据计算的组件，React 会要求开发者拆成「计算子组件+展示子组件」，让每个子组件对应一个 Fiber，单个 Fiber 只承担一部分简单逻辑，从拆分层面保证单个处理的轻量化。</p>
<h4 data-id="heading-54">3. 阶段隔离的硬约束：耗时操作被彻底排除在 Reconciliation 阶段</h4>
<p>React 把<strong>所有耗时操作</strong>（DOM 操作、样式计算、动画执行）都隔离到「Commit 阶段」，而 Reconciliation 阶段（Fiber 节点处理的阶段）只做纯内存的对比和标记。
Commit 阶段本身是不可中断的，但它的耗时操作是<strong>批量一次性执行</strong>的，且基于 Fiber 阶段的标记精准执行，不会有冗余操作，而 Fiber 阶段的轻量化则完全不受这些耗时操作的影响。</p>
<h4 data-id="heading-55">再补一层：“多执行一个也无碍”的实际体感</h4>
<p>假设剩余时间是 1.6ms，单个 Fiber 执行耗时 0.1ms，就算因为实时校验的时机问题，<strong>多执行了3个</strong>，总耗时也只是增加 0.3ms，达到 1.9ms，远低于浏览器 16.6ms 的帧时长，更低于 5ms 的安全阈值。
这个增量在浏览器层面属于「微秒级误差」，不会导致帧丢失，用户完全感知不到任何卡顿——这就是 React 敢“容忍多执行一个”的核心原因：<strong>增量耗时在人类感知和浏览器渲染的安全范围内</strong>。</p>
<h4 data-id="heading-56">最终结论</h4>
<p>你的判断切中了核心：<strong>React 所有的调度策略（执行前预估、执行后实时校验、可中断恢复），都是建立在「单个 Fiber 执行足够短」这个不可动摇的基础上的</strong>。
这个基础不是“坚信”出来的，而是通过「逻辑限定、组件拆分、阶段隔离」三层硬约束做出来的，正是因为这个基础的存在，Scheduler 才不用纠结于“精准预估耗时”，不用害怕“多执行一个”，只用做简单的实时时间校验，就能实现高效、不阻塞的调度。</p>
<p>简单说：<strong>先把单个任务的耗时压到极致，再谈调度的容错性</strong>——这是 React Fiber 架构最底层的设计哲学。</p>
<h3 data-id="heading-57">剩余空闲时间 的具体计算方法</h3>
<p>简单来说，剩余时间的计算核心是：<strong>以浏览器每帧的总时长（≈16.6ms）为基准，减去当前帧已消耗的时间，再预留 5ms 安全阈值，最终得到可用于执行 React 任务的空闲时间</strong>。下面我用「原理 + 代码 + 例子」的方式把计算逻辑拆透。</p>
<h4 data-id="heading-58">一、计算的核心前提</h4>
<p>浏览器要保证页面流畅（60fps），每帧的总时长必须控制在 <code>1000ms ÷ 60 ≈ 16.666ms</code>（以下简称 16.6ms）。每帧内浏览器需要依次完成：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局(Layout) → 绘制(Paint) → 空闲时间
</code></pre>
<p>Scheduler 计算的「剩余时间」，就是<strong>当前帧总时长 - 已消耗时长</strong>，代表浏览器完成核心工作（布局、绘制）后，还剩多少时间可以执行 React 的低优先级任务。</p>
<h4 data-id="heading-59">二、剩余时间的完整计算步骤（带代码模拟）</h4>
<p>Scheduler 对剩余时间的计算分为 4 步，核心依赖 <code>requestAnimationFrame (rAF)</code> 的高精度时间戳（而非 <code>Date.now()</code>），保证计算准确性：</p>
<h5 data-id="heading-60">步骤1：获取当前帧的「开始时间」（核心基准）</h5>
<p><code>rAF</code> 的回调函数会接收一个<strong>高精度时间戳（timestamp）</strong>，这个时间戳是浏览器给出的「当前帧开始执行的时间」，是计算的唯一基准（比 <code>Date.now()</code> 更准，避免系统时间偏差）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储当前帧的开始时间（全局变量）</span>
<span class="hljs-keyword">let</span> frameStartTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 注册 rAF，在每帧开始时记录帧起始时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">registerFrameStartTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
    <span class="hljs-comment">// timestamp：浏览器提供的高精度时间戳（单位：ms），代表当前帧的开始时间</span>
    frameStartTime = timestamp;
    <span class="hljs-comment">// 每帧都要重新注册，保证帧开始时间实时更新</span>
    <span class="hljs-title function_">registerFrameStartTime</span>();
  });
}

<span class="hljs-comment">// 启动帧时间监听</span>
<span class="hljs-title function_">registerFrameStartTime</span>();
</code></pre>
<h5 data-id="heading-61">步骤2：计算「当前帧已消耗的时间」</h5>
<p>从帧开始到「当前时刻」，已经用掉的时间，公式为：</p>
<pre><code class="hljs">已消耗时间 = 当前高精度时间 - 帧开始时间
</code></pre>
<p>代码实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取当前高精度时间（兼容浏览器）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// performance.now() 是高精度时间（微秒级），比 Date.now() 更适合计算短时间间隔</span>
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>();
}

<span class="hljs-comment">// 计算已消耗时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getElapsedTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getCurrentTime</span>() - frameStartTime;
}
</code></pre>
<h5 data-id="heading-62">步骤3：计算「原始剩余时间」</h5>
<p>原始剩余时间 = 每帧总时长（16.6ms） - 已消耗时间，代表当前帧理论上还剩的全部时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每帧总时长（60fps 下的标准值）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FRAME_DURATION</span> = <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>; <span class="hljs-comment">// ≈16.666ms</span>

<span class="hljs-comment">// 计算原始剩余时间</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRawRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-title function_">getElapsedTime</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FRAME_DURATION</span> - elapsedTime;
}
</code></pre>
<h5 data-id="heading-63">步骤4：应用「安全阈值」并处理边界情况</h5>
<p>为了避免 React 任务占用过多时间导致浏览器来不及完成「布局/绘制」，Scheduler 会预留 <strong>5ms 安全阈值</strong>，并保证剩余时间不会为负数（负数代表当前帧已超时）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 安全阈值：预留 5ms 给浏览器完成布局/绘制</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SAFE_THRESHOLD</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 最终可用的剩余时间（Scheduler 实际使用的）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getRemainingTime</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> rawRemaining = <span class="hljs-title function_">getRawRemainingTime</span>();
  <span class="hljs-comment">// 1. 减去安全阈值；2. 保证结果 ≥ 0（避免负数）</span>
  <span class="hljs-keyword">const</span> remaining = rawRemaining - <span class="hljs-variable constant_">SAFE_THRESHOLD</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, remaining);
}
</code></pre>
<h4 data-id="heading-64">三、关键细节解释（为什么要这么算？）</h4>
<h5 data-id="heading-65">1. 为什么用 <code>performance.now()</code> 而非 <code>Date.now()</code>？</h5>
<ul>
<li><code>Date.now()</code> 是「系统时间」，精度低（毫秒级），且可能被用户手动修改、时区同步等影响；</li>
<li><code>performance.now()</code> 是「相对时间」（从页面加载开始计时），精度高达微秒级（1ms = 1000μs），完全不受系统时间影响——适合计算「帧内短时间间隔」。</li>
</ul>
<h5 data-id="heading-66">2. 为什么要减 5ms 安全阈值？</h5>
<p>16.6ms 的帧时长中，浏览器需要至少 10ms 左右完成「布局 + 绘制」（这是实践验证的经验值）。如果 React 任务把剩余时间用完（比如剩 5ms 全占用），浏览器会来不及完成渲染，导致帧丢失、页面卡顿。
减 5ms 后，即使 React 用满剩余时间，浏览器仍有足够时间完成核心渲染工作。</p>
<h5 data-id="heading-67">3. 剩余时间为 0 意味着什么？</h5>
<p>如果 <code>getRemainingTime()</code> 返回 0，说明：</p>
<ul>
<li>当前帧已消耗的时间 ≥ 11.6ms（16.6 - 5）；</li>
<li>没有空闲时间执行 React 任务，Scheduler 会立即暂停任务，等待下一次帧的空闲时间。</li>
</ul>
<h4 data-id="heading-68">四、实际场景举例（直观理解）</h4>
<p>假设当前帧的执行情况如下：</p>
<ul>
<li>帧开始时间（frameStartTime）：1000.0ms；</li>
<li>当前时间（performance.now()）：1010.0ms；</li>
</ul>
<p>计算过程：</p>
<ol>
<li>已消耗时间 = 1010.0 - 1000.0 = 10ms；</li>
<li>原始剩余时间 = 16.6 - 10 = 6.6ms；</li>
<li>最终剩余时间 = 6.6 - 5 = 1.6ms（取正值）；</li>
</ol>
<p>结论：Scheduler 只会给 React 任务分配 1.6ms 的执行时间，超时就中断。</p>
<p>再举一个超时场景：</p>
<ul>
<li>已消耗时间 = 15ms；</li>
<li>原始剩余时间 = 16.6 - 15 = 1.6ms；</li>
<li>最终剩余时间 = 1.6 - 5 = -3.4ms → 取 0；</li>
</ul>
<p>结论：无空闲时间，暂停任务。</p>
<h4 data-id="heading-69">总结（核心关键点）</h4>
<ol>
<li><strong>计算基准</strong>：以 60fps 下每帧 16.6ms 为总时长，剩余时间 = 总时长 - 已消耗时间 - 5ms 安全阈值；</li>
<li><strong>时间精度</strong>：依赖 <code>rAF</code> 的高精度时间戳和 <code>performance.now()</code>，避免系统时间偏差；</li>
<li><strong>边界处理</strong>：剩余时间最小为 0，保证不会出现负数（超时则暂停任务）；</li>
<li><strong>核心目的</strong>：预留足够时间给浏览器完成渲染，避免 React 任务阻塞页面流畅性。</li>
</ol>
<p>简单来说，剩余时间的计算逻辑就是：<strong>先算当前帧还剩多少时间，再扣掉浏览器必须的渲染时间，剩下的才给 React 用</strong>——这是时间切片能「不阻塞渲染」的根本保障。</p>
<h3 data-id="heading-70">rAF 和 postMessage 的分工</h3>
<p>Scheduler 并不是「在 requestAnimationFrame (rAF) 里开启任务」，而是用 rAF 获取「帧开始时间」（作为计算剩余时间的基准），真正执行任务的时机是在 <code>postMessage</code> 的宏任务回调中；时间不足时暂停任务后，也不是直接由 postMessage 触发处理剩余任务，而是<strong>下一次帧周期重新走「rAF 记时间 → postMessage 执行任务」的流程</strong>。</p>
<p>下面我用「精准流程拆解 + 通俗比喻」把这个逻辑讲透，你就能清楚 rAF 和 postMessage 的分工，以及任务暂停/恢复的完整链路：</p>
<h4 data-id="heading-71">一、先纠正核心偏差：rAF 和 postMessage 的核心分工</h4>

























<table><thead><tr><th>角色</th><th>requestAnimationFrame (rAF)</th><th>postMessage 宏任务</th></tr></thead><tbody><tr><td>执行时机</td><td>每帧「布局/绘制前」（帧内核心工作前）</td><td>每帧「绘制完成后」（帧内空闲时间）</td></tr><tr><td>核心作用</td><td>记录「帧开始时间」（计算剩余时间的基准）</td><td>执行 React 任务（Fiber 处理）+ 检查剩余时间</td></tr><tr><td>是否直接执行任务</td><td>❌ 不执行，只记时间</td><td>✅ 是，真正的任务执行入口</td></tr></tbody></table>
<h4 data-id="heading-72">二、Scheduler 完整执行流程（纠正后的准确版本）</h4>
<p>用步骤拆解，你能清晰看到「记时间 → 算剩余 → 执行任务 → 暂停/恢复」的全链路：</p>
<h5 data-id="heading-73">步骤1：rAF 标记「帧开始时间」（准备工作）</h5>
<p>浏览器每帧启动时，先触发 rAF 回调：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">(<span class="hljs-params">timestamp</span>) =&gt;</span> {
  <span class="hljs-comment">// 记录当前帧的开始时间（高精度时间戳），作为后续计算剩余时间的基准</span>
  frameStartTime = timestamp;
});
</code></pre>
<p>👉 这一步<strong>不执行任何 React 任务</strong>，只做「时间基准标记」，为后续计算“这一帧还剩多少空闲时间”铺路。</p>
<h5 data-id="heading-74">步骤2：postMessage 触发「任务执行」（核心）</h5>
<p>rAF 执行后，浏览器会完成「布局/绘制」等核心工作，之后触发 postMessage 宏任务（这才是空闲时间）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
channel.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 先计算当前帧的剩余空闲时间（基于 rAF 记录的 frameStartTime）</span>
  <span class="hljs-keyword">const</span> remainingTime = <span class="hljs-title function_">getRemainingTime</span>(); <span class="hljs-comment">// 比如算出 1.6ms</span>

  <span class="hljs-keyword">if</span> (remainingTime &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 2. 有空闲时间 → 执行 React 任务（处理 Fiber 节点）</span>
    <span class="hljs-keyword">const</span> hasMoreWork = <span class="hljs-title function_">workLoop</span>(remainingTime); <span class="hljs-comment">// 执行任务，返回是否有剩余任务</span>
    
    <span class="hljs-keyword">if</span> (hasMoreWork) {
      <span class="hljs-comment">// 3. 任务没做完（时间不足暂停）→ 等待下一次帧周期</span>
      <span class="hljs-comment">// 不是直接触发 postMessage，而是等下一次 rAF 后再走流程</span>
      <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 4. 无空闲时间 → 直接等下一次帧周期</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> channel.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">''</span>));
  }
};
</code></pre>
<h5 data-id="heading-75">步骤3：workLoop 执行任务 + 时间不足则暂停</h5>
<p><code>workLoop</code> 里就是处理 Fiber 节点的核心逻辑：</p>
<ul>
<li>每处理一个 Fiber 节点，就检查「已用时间是否 ≥ 剩余时间」；</li>
<li>时间不足时，<code>workLoop</code> 返回 <code>true</code>（表示有剩余任务），Scheduler 就停止执行；</li>
<li>剩余任务不会立刻由 postMessage 触发，而是<strong>等下一个帧周期</strong>：先由 rAF 重新记录帧开始时间，再由 postMessage 回调执行剩余任务。</li>
</ul>
<h4 data-id="heading-76">三、通俗比喻：把「帧周期」比作「一节课」</h4>
<ul>
<li>rAF = 上课铃：打铃时记录“上课开始时间”（帧开始时间），只记时间，不讲课；</li>
<li>浏览器的布局/绘制 = 老师讲核心知识点：必须优先完成，不能打断；</li>
<li>postMessage = 课间休息：核心知识点讲完后，才有休息时间，此时才可以做“刷题（处理 Fiber 任务）”；</li>
<li>剩余时间不足 = 课间休息快结束了：刷不完题就暂停，把剩下的题留到「下一节课的课间休息」（下一次帧的 postMessage）再做；</li>
<li>下一次 rAF = 下一节课的上课铃：先记新的上课时间，再等新的课间休息（postMessage）刷题。</li>
</ul>
<h4 data-id="heading-77">总结（核心关键点）</h4>
<ol>
<li><strong><code>rAF 只记时间，不执行任务</code></strong>：<strong><code>它的作用是给剩余时间计算提供基准，不是任务执行入口；</code></strong></li>
<li><strong><code>postMessage 才是任务执行的核心时机</code></strong>：<strong><code>只有在绘制完成后的空闲时间（postMessage 回调），才会处理 Fiber 任务；</code></strong></li>
<li><strong><code>暂停后不是立即触发 postMessage</code></strong>：<strong><code>剩余任务会等「下一次帧周期」，重新走「rAF 记时间 → postMessage 执行任务」的流程，保证始终在空闲时间执行任务，不阻塞渲染。</code></strong></li>
</ol>
<p>简单来说：<strong><code>Scheduler 是「先靠 rAF 定时间基准，再靠 postMessage 找空闲时间执行任务，时间不够就等下一轮空闲时间继续」—— 而非“rAF 开任务，postMessage 收尾”。</code></strong></p>
<h3 data-id="heading-78"><code>requestIdleCallback</code>:想法很好，落地很拉垮</h3>
<h4 data-id="heading-79">一、先明确：requestIdleCallback 到底是干啥的？</h4>
<p><code>requestIdleCallback</code> 是<strong>浏览器原生提供的「空闲时间调度 API」</strong>，核心设计目标和 React Scheduler 一致——<strong>让开发者在浏览器“没活儿干”的时候执行低优先级任务</strong>，避免占用核心渲染时间导致卡顿。</p>
<h5 data-id="heading-80">1. 核心工作逻辑</h5>
<p>浏览器每帧（16.6ms）的执行顺序是：</p>
<pre><code class="hljs language-scss" lang="scss">事件处理 → 宏任务 → 微任务 → <span class="hljs-built_in">requestAnimationFrame</span>(rAF) → 布局 → 绘制 → 【空闲时间】→ requestIdleCallback 回调
</code></pre>
<p>只有当「布局+绘制」完成后，当前帧还有剩余时间（比如只用了 10ms，剩 6.6ms），浏览器才会触发 <code>requestIdleCallback</code> 的回调函数。</p>
<h5 data-id="heading-81">2. 核心能力</h5>
<p>回调函数会接收一个 <code>IdleDeadline</code> 对象，能拿到两个关键信息：</p>
<ul>
<li><code>timeRemaining()</code>：返回当前帧还剩多少空闲时间（比如 6.6ms）；</li>
<li><code>didTimeout</code>：标记任务是否过期（若浏览器长期无空闲，任务会强制触发）。</li>
</ul>
<h5 data-id="heading-82">3. 简单示例（原生用法）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 注册一个空闲任务</span>
<span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">(<span class="hljs-params">deadline</span>) =&gt;</span> {
  <span class="hljs-comment">// 只要还有空闲时间，就执行任务</span>
  <span class="hljs-keyword">while</span> (deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">doLowPriorityWork</span>(); <span class="hljs-comment">// 比如日志收集、非紧急数据处理</span>
  }
});
</code></pre>
<p>简单说：<code>requestIdleCallback</code> 就是浏览器给开发者的「空闲时间接口」，让你把不紧急的任务塞到帧的空闲期执行。</p>
<h4 data-id="heading-83">二、为什么 React 不用它？（核心还是那两个致命问题，展开讲透）</h4>
<p>虽然 <code>requestIdleCallback</code> 的设计初衷和 React Scheduler 一致，但它的两个硬伤让 React 完全无法用——咱们之前提过「兼容性差、触发时机不稳定」，这里结合实际场景展开：</p>

























<table><thead><tr><th>问题</th><th>具体表现</th><th>对 React 的致命影响</th></tr></thead><tbody><tr><td>兼容性极差</td><td>- IE 全版本不支持<br/>- iOS Safari 仅 14.5+ 支持<br/>- 安卓 WebView 大量不支持</td><td>React 要适配多端/多浏览器，依赖它会导致旧设备用户直接失去「可中断渲染」能力，退回卡顿状态</td></tr><tr><td>触发时机极不稳定</td><td>- 帧率 &lt; 60fps 时（页面卡顿），浏览器判定「无空闲时间」，回调<strong>完全不触发</strong><br/>- 浏览器为了“保核心渲染”，会刻意压缩触发机会</td><td>React 的低优先级任务（比如列表渲染）会无限积压，甚至永远不执行；中断后的任务也无法恢复</td></tr><tr><td>无优先级调度能力</td><td>所有注册的任务都是“同等优先级”，无法让用户交互（高优先级）插队</td><td>用户点击按钮后，低优先级任务还在占用空闲时间，导致交互响应卡顿</td></tr></tbody></table>
<h4 data-id="heading-84">三、关键补充：React 自研 Scheduler（rAF + postMessage）和 requestIdleCallback 的核心差异</h4>
<p>React 不是“不用空闲时间调度”，而是「抛弃原生的 requestIdleCallback，自己实现了一个更靠谱的版本」：</p>






























<table><thead><tr><th>特性</th><th>原生 requestIdleCallback</th><th>React Scheduler（rAF + postMessage）</th></tr></thead><tbody><tr><td>兼容性</td><td>差（仅新版浏览器支持）</td><td>好（rAF + postMessage 是基础 API，全浏览器兼容）</td></tr><tr><td>触发稳定性</td><td>帧率低时完全不触发</td><td>不管帧率多少，每帧都会尝试执行（剩余时间为0就等下一帧，不会积压）</td></tr><tr><td>优先级调度</td><td>无</td><td>支持5级优先级，高优先级任务（比如点击）可插队中断低优先级任务</td></tr><tr><td>时间控制精度</td><td>依赖浏览器内置计算，无法自定义 5ms 安全阈值</td><td>自研剩余时间计算，可精准预留 5ms 给浏览器渲染</td></tr></tbody></table>
<h4 data-id="heading-85">总结（核心关键点）</h4>
<ol>
<li><code>requestIdleCallback</code> 是浏览器原生的「空闲时间调度 API」，作用是在帧的空闲期执行低优先级任务；</li>
<li>React 不用它的核心原因：<strong>兼容性差（覆盖不全）、触发不稳定（帧率低时不执行）、无优先级调度</strong>，无法满足 Fiber 架构“可中断、高优先级优先”的核心需求；</li>
<li>React 转而用 <code>rAF + postMessage</code> 自研 Scheduler，本质是「重新实现了一个更稳定、更可控、带优先级的 requestIdleCallback」。</li>
</ol>
<p>简单来说：<code>requestIdleCallback</code> 是个“想法很好但落地拉胯”的原生 API，React 嫌它不好用，就自己造了个更强大的版本——这就是 Scheduler 的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 变形动画-打造花瓣绽放]]></title>    <link>https://juejin.cn/post/7600068892988653578</link>    <guid>https://juejin.cn/post/7600068892988653578</guid>    <pubDate>2026-01-28T10:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988653578" data-draft-id="7600234310964838438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 变形动画-打造花瓣绽放"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-28T10:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 变形动画-打造花瓣绽放
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:01:41.000Z" title="Wed Jan 28 2026 10:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>本文将详细介绍如何使用 Three.js 实现变形动画效果。我们将学习如何利用 Morph Targets（形态目标）技术，让 3D 模型在不同形状之间平滑过渡，创造出花瓣绽放等生动的动画效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/014543e98fbc4129bc37fe0992bc4393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770199625&amp;x-signature=GnMhv1W0tbYWAJyd45BlfEWXlxE%3D" alt="screenshot_2026-01-28_17-56-51.gif" loading="lazy"/></p>
<h2 data-id="heading-1">准备工作</h2>
<p>首先，我们需要引入必要的 Three.js 库和相关工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-comment">// 导入轨道控制器</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/controls/OrbitControls"</span>;
<span class="hljs-comment">// 导入动画库</span>
<span class="hljs-keyword">import</span> gsap <span class="hljs-keyword">from</span> <span class="hljs-string">"gsap"</span>;
<span class="hljs-comment">// 导入dat.gui</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> dat <span class="hljs-keyword">from</span> <span class="hljs-string">"dat.gui"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DRACOLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/DRACOLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GLTFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/GLTFLoader"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RGBELoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/examples/jsm/loaders/RGBELoader"</span>;
</code></pre>
<h2 data-id="heading-2">场景初始化</h2>
<p>首先，我们需要创建一个基本的 Three.js 场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> dat.<span class="hljs-title function_">GUI</span>();
<span class="hljs-comment">// 1、创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 2、创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">75</span>,
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
  <span class="hljs-number">0.1</span>,
  <span class="hljs-number">1000</span>
);
camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
<span class="hljs-comment">// 更新摄像机的投影矩阵</span>
camera.<span class="hljs-title function_">updateProjectionMatrix</span>();

<span class="hljs-comment">// 设置相机位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>);
scene.<span class="hljs-title function_">add</span>(camera);
</code></pre>
<h2 data-id="heading-3">环境设置</h2>
<p>添加 HDR 环境纹理，提升场景的真实感：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加hdr环境纹理</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RGBELoader</span>();
loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./textures/038.hdr"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">texture</span>) {
  texture.<span class="hljs-property">mapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">EquirectangularReflectionMapping</span>;
  scene.<span class="hljs-property">environment</span> = texture;
});
</code></pre>
<h2 data-id="heading-4">DRACO 压缩模型加载</h2>
<p>使用 DRACO 压缩技术加载 GLB 模型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加载压缩的glb模型</span>
<span class="hljs-keyword">const</span> gltfLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GLTFLoader</span>();
<span class="hljs-keyword">const</span> dracoLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DRACOLoader</span>();
dracoLoader.<span class="hljs-title function_">setDecoderPath</span>(<span class="hljs-string">"./draco/gltf/"</span>);
dracoLoader.<span class="hljs-title function_">setDecoderConfig</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"js"</span> });
dracoLoader.<span class="hljs-title function_">preload</span>();
gltfLoader.<span class="hljs-title function_">setDRACOLoader</span>(dracoLoader);
</code></pre>
<h2 data-id="heading-5">变形动画核心实现</h2>
<p>这是变形动画的关键部分，通过 Morph Targets 技术实现模型变形：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> params = {
  <span class="hljs-attr">value</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">value1</span>: <span class="hljs-number">0</span>,
};

<span class="hljs-keyword">let</span> mixer;
<span class="hljs-keyword">let</span> stem, petal, stem1, petal1, stem2, petal2;

<span class="hljs-comment">// 加载第一个模型（初始状态）</span>
gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f4.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf1</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gltf1);
  stem = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>];
  petal = gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">children</span>[<span class="hljs-number">1</span>];
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>;

  <span class="hljs-comment">// 遍历场景中的对象并处理材质</span>
  gltf1.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Water"</span>) {
      item.<span class="hljs-property">material</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({
        <span class="hljs-attr">color</span>: <span class="hljs-string">"skyblue"</span>,
        <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">depthTest</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span>,
      });
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
      stem = item;
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
      petal = item;
    }
  });

  <span class="hljs-comment">// 加载第二个模型（中间状态）</span>
  gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f2.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
    gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
        stem1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          stem1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        stem.<span class="hljs-title function_">updateMorphTargets</span>();
      }
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
        petal1 = item;
        <span class="hljs-comment">// 将第二个模型的几何体作为第一个形态目标添加到基础模型</span>
        petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span> = [
          petal1.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>,
        ];
        petal.<span class="hljs-title function_">updateMorphTargets</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
      }

      <span class="hljs-comment">// 加载第三个模型（最终状态）</span>
      gltfLoader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"./model/f1.glb"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf2</span>) {
        gltf2.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Stem"</span>) {
            stem2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            stem.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              stem2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            stem.<span class="hljs-title function_">updateMorphTargets</span>();
          }
          <span class="hljs-keyword">if</span> (item.<span class="hljs-property">material</span> &amp;&amp; item.<span class="hljs-property">material</span>.<span class="hljs-property">name</span> == <span class="hljs-string">"Petal"</span>) {
            petal2 = item;
            <span class="hljs-comment">// 将第三个模型的几何体作为第二个形态目标添加到基础模型</span>
            petal.<span class="hljs-property">geometry</span>.<span class="hljs-property">morphAttributes</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">push</span>(
              petal2.<span class="hljs-property">geometry</span>.<span class="hljs-property">attributes</span>.<span class="hljs-property">position</span>
            );
            petal.<span class="hljs-title function_">updateMorphTargets</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(petal.<span class="hljs-property">morphTargetInfluences</span>);
          }
        });
      });
    });
  });

  <span class="hljs-comment">// 使用 GSAP 创建变形动画</span>
  gsap.<span class="hljs-title function_">to</span>(params, {
    <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 控制第一个形态目标的影响程度</span>
      stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
      petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">0</span>] = params.<span class="hljs-property">value</span>;
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-comment">// 在第一个动画完成后，开始第二个变形动画</span>
      gsap.<span class="hljs-title function_">to</span>(params, {
        <span class="hljs-attr">value1</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">onUpdate</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
          <span class="hljs-comment">// 控制第二个形态目标的影响程度</span>
          stem.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
          petal.<span class="hljs-property">morphTargetInfluences</span>[<span class="hljs-number">1</span>] = params.<span class="hljs-property">value1</span>;
        },
      });
    },
  });

  scene.<span class="hljs-title function_">add</span>(gltf1.<span class="hljs-property">scene</span>);
});
</code></pre>
<h2 data-id="heading-6">渲染器设置</h2>
<p>配置 WebGL 渲染器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
  <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
});
<span class="hljs-comment">// 设置渲染的尺寸大小</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 开启场景中的阴影贴图</span>
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">physicallyCorrectLights</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-title function_">setClearColor</span>(<span class="hljs-number">0xcccccc</span>, <span class="hljs-number">1</span>);
renderer.<span class="hljs-property">autoClear</span> = <span class="hljs-literal">false</span>;
<span class="hljs-comment">// 设置电影渲染模式</span>
renderer.<span class="hljs-property">toneMapping</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ACESFilmicToneMapping</span>;
renderer.<span class="hljs-property">outputEncoding</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">sRGBEncoding</span>;
renderer.<span class="hljs-property">sortObjects</span> = <span class="hljs-literal">true</span>;
renderer.<span class="hljs-property">logarithmicDepthBuffer</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 将webgl渲染的canvas内容添加到body</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
</code></pre>
<h2 data-id="heading-7">控制器和动画循环</h2>
<p>设置轨道控制器和渲染循环：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
<span class="hljs-comment">// 设置控制器阻尼，让控制器更有真实效果,必须在动画循环里调用.update()。</span>
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 添加坐标轴辅助器</span>
<span class="hljs-keyword">const</span> axesHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AxesHelper</span>(<span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(axesHelper);

<span class="hljs-comment">// 设置时钟</span>
<span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> time = clock.<span class="hljs-title function_">getDelta</span>();
  <span class="hljs-keyword">if</span> (mixer) {
    mixer.<span class="hljs-title function_">update</span>(time);
  }
  controls.<span class="hljs-title function_">update</span>();

  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  <span class="hljs-comment">// 渲染下一帧的时候就会调用render函数</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">render</span>();
</code></pre>
<h2 data-id="heading-8">变形动画原理详解</h2>
<p>Morph Targets（形态目标）是一种在计算机图形学中用于实现网格变形的技术。其基本原理是：</p>
<ol>
<li><strong>基础几何体</strong>: 定义一个基础的网格几何体</li>
<li><strong>目标几何体</strong>: 定义一个或多个"目标"几何体，它们与基础几何体有相同的拓扑结构（相同的顶点数量和连接关系），但顶点位置不同</li>
<li><strong>权重控制</strong>: 通过权重值（0到1之间）来控制目标几何体对基础几何体的影响程度</li>
</ol>
<p>在代码中，我们使用 <code>morphTargetInfluences</code> 数组来控制每个形态目标的影响程度：</p>
<ul>
<li>当 <code>morphTargetInfluences[0] = 0</code> 时，模型呈现初始状态</li>
<li>当 <code>morphTargetInfluences[0] = 1</code> 时，模型完全变成第一个目标状态</li>
<li>当 <code>morphTargetInfluences[0] = 0.5</code> 时，模型是初始状态和目标状态的中间形态</li>
</ul>
<h2 data-id="heading-9">应用场景</h2>
<p>变形动画在 3D 应用中有广泛的应用：</p>
<ol>
<li><strong>角色面部表情</strong>: 实现人物的表情变化</li>
<li><strong>物体形态变化</strong>: 如花朵绽放、物体变形等</li>
<li><strong>动画过渡</strong>: 在不同模型状态之间平滑过渡</li>
<li><strong>程序化生成</strong>: 根据参数动态改变模型形状</li>
</ol>
<h2 data-id="heading-10">性能优化建议</h2>
<ol>
<li><strong>合理使用</strong>: Morph Targets 会增加内存消耗，只在必要时使用</li>
<li><strong>减少目标数量</strong>: 尽量减少形态目标的数量以提高性能</li>
<li><strong>压缩模型</strong>: 使用 DRACO 等压缩技术减少模型文件大小</li>
<li><strong>优化动画</strong>: 使用高效的动画库如 GSAP 来控制变形过程</li>
</ol>
<h2 data-id="heading-11">总结</h2>
<p>通过这个项目，我们学习了如何使用 Three.js 的 Morph Targets 技术：</p>
<ol>
<li>如何加载多个具有相同拓扑结构的模型</li>
<li>如何将目标模型的几何体作为形态目标添加到基础模型</li>
<li>如何通过控制权重来实现平滑的变形动画</li>
<li>如何使用 GSAP 等动画库来管理复杂的动画序列</li>
</ol>
<p>变形动画是一个强大而灵活的技术，能够为你的 3D 应用增添生动有趣的视觉效果，特别是在创建有机形态变化（如植物生长、花朵绽放等）方面特别有效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）]]></title>    <link>https://juejin.cn/post/7600234310964936742</link>    <guid>https://juejin.cn/post/7600234310964936742</guid>    <pubDate>2026-01-28T10:15:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310964936742" data-draft-id="7600068892988669962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-28T10:15:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS-面试必考：手动实现一个标准的 Ajax 请求（XMLHttpRequest）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:15:37.000Z" title="Wed Jan 28 2026 10:15:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>虽然 <code>fetch</code> API 在现代开发中非常流行，但 <strong>XMLHttpRequest (XHR)</strong> 依然是理解 Web 网络编程的基石。无论是底层的 Ajax 封装，还是需要细粒度监控<strong>上传/下载进度</strong>的场景，XHR 依然不可替代。</p>
<h2 data-id="heading-1">一、 什么是 Ajax？</h2>
<p><strong>Ajax（Asynchronous JavaScript And XML）</strong> 并不是一种单一的编程语言，而是一套技术的组合。其核心是在不重新加载整个网页的情况下，通过与服务器进行异步数据交换，实现页面的<strong>局部刷新</strong>。</p>
<ul>
<li><strong>核心优势</strong>：提升用户体验，减少网络带宽占用。</li>
<li><strong>实现基础</strong>：JavaScript 和浏览器原生的 <code>XMLHttpRequest</code> 对象。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 XHR 操作的“五步法”逻辑</h2>
<h3 data-id="heading-3">1. 创建对象</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
</code></pre>
<h3 data-id="heading-4">2. 注册回调函数 (事件驱动)</h3>
<p>XHR 是基于事件驱动的，我们需要在请求发送前定义好如何处理各种状态。</p>
<ul>
<li><strong><code>onreadystatechange</code></strong>：监控请求的生命周期（状态 0-4）。</li>
<li><strong><code>onerror</code></strong>：处理网络层面的错误（如断网或 DNS 解析失败）。</li>
<li><strong><code>ontimeout</code></strong>：处理响应超时，需配合 <code>xhr.timeout</code> 使用。</li>
<li><strong><code>onprogress</code></strong>：数据传输进度监控。</li>
</ul>
<h3 data-id="heading-5">3. 配置请求参数</h3>
<p>通过 <code>open()</code> 方法初始化请求：</p>
<ul>
<li><strong><code>method</code></strong>：请求方法（GET, POST, PUT 等）。</li>
<li><strong><code>url</code></strong>：请求地址。</li>
<li><strong><code>async</code></strong>：是否异步（默认 <code>true</code>）。<strong>注意：</strong> 设为 <code>false</code> 会阻塞浏览器主线程，导致页面假死。</li>
</ul>
<h3 data-id="heading-6">4. 设置属性与请求头</h3>
<ul>
<li><code>responseType</code>：设置期望的返回格式（如 <code>json</code>, <code>blob</code>）。</li>
<li><code>setRequestHeader()</code>：手动添加自定义请求头（必须在 <code>open</code> 之后，<code>send</code> 之前调用）。</li>
</ul>
<h3 data-id="heading-7">5. 发送请求</h3>
<ul>
<li><code>send(data)</code>：正式发起请求。如果是 GET 请求，传 <code>null</code>；如果是 POST，传具体数据。</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、 详解 readyState：五种状态的演变</h2>
<p><code>readyState</code> 是排查 Ajax 问题的关键，它记录了请求的每一步进展：</p>



































<table><thead><tr><th><strong>取值</strong></th><th><strong>状态名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>0</strong></td><td><strong>UNSENT</strong></td><td>初始化状态，对象已创建，尚未调用 <code>open()</code></td></tr><tr><td><strong>1</strong></td><td><strong>OPENED</strong></td><td>已调用 <code>open()</code>，尚未调用 <code>send()</code>，可设置 Header</td></tr><tr><td><strong>2</strong></td><td><strong>HEADERS_RECEIVED</strong></td><td>已调用 <code>send()</code>，接收到了响应头和状态码</td></tr><tr><td><strong>3</strong></td><td><strong>LOADING</strong></td><td>正在下载响应体，<code>responseText</code> 已包含部分数据</td></tr><tr><td><strong>4</strong></td><td><strong>DONE</strong></td><td><strong>数据接收完成</strong>，请求生命周期结束</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">四、 进度监控：如何实现进度条？</h2>
<p>XHR 相比 <code>fetch</code> 的一大优势就是对进度的原生支持。通过 <code>onprogress</code> 事件，我们可以计算出下载百分比：</p>
<ul>
<li><strong><code>lengthComputable</code></strong>：布尔值，表示服务器是否返回了 <code>Content-Length</code>。</li>
<li><strong><code>loaded</code></strong>：已接收的字节数。</li>
<li><strong><code>total</code></strong>：总字节数。</li>
</ul>
<hr/>
<h2 data-id="heading-10">五、 代码实现：封装一个标准的 Ajax 函数</h2>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">/**
 * 基于 XHR 封装的数据获取函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} URL 请求地址
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">GetWebData</span>(<span class="hljs-params">URL</span>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

  <span class="hljs-comment">// 1. 状态监控：只在 DONE 阶段处理逻辑</span>
  xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) { 
      <span class="hljs-comment">// 兼容性判断：2xx 范围和 304 缓存均认为成功</span>
      <span class="hljs-keyword">if</span> ((xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) || xhr.<span class="hljs-property">status</span> === <span class="hljs-number">304</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请求成功:"</span>, xhr.<span class="hljs-property">response</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求失败, 状态码:"</span>, xhr.<span class="hljs-property">status</span>);
      }
    }
  };

  <span class="hljs-comment">// 2. 进度监控</span>
  xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span>) {
      <span class="hljs-keyword">let</span> percent = (event.<span class="hljs-property">loaded</span> / event.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">${percent.toFixed(<span class="hljs-number">2</span>)}</span>%`</span>);
    }
  };

  <span class="hljs-comment">// 3. 异常与超时处理</span>
  xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>; 
  xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请求超时！"</span>);
  xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"网络异常或跨域错误"</span>);

  <span class="hljs-comment">// 4. 配置与发送</span>
  xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-variable constant_">URL</span>, <span class="hljs-literal">true</span>);
  xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">"json"</span>; <span class="hljs-comment">// 自动解析 JSON</span>
  xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">"X-Requested-With"</span>, <span class="hljs-string">"XMLHttpRequest"</span>);

  xhr.<span class="hljs-title function_">send</span>(<span class="hljs-literal">null</span>);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3自定义指令合集-单例v-tooltip]]></title>    <link>https://juejin.cn/post/7600224355294085147</link>    <guid>https://juejin.cn/post/7600224355294085147</guid>    <pubDate>2026-01-28T10:17:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600224355294085147" data-draft-id="7486444624815915045" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3自定义指令合集-单例v-tooltip"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T10:17:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fubobo"/> <meta itemprop="url" content="https://juejin.cn/user/3518911078999470"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3自定义指令合集-单例v-tooltip
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3518911078999470/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fubobo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:17:37.000Z" title="Wed Jan 28 2026 10:17:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在实际项目中，Tooltip 往往会遇到这些问题：</p>
<ul>
<li>大多数使用组件形式实现（有时候项目中对于tooltip没有过多要求，使用UI组件的话，需要包一层组件，有点臃肿）</li>
<li>每个元素一个 Tooltip，实例过多，性能差</li>
<li>页面滚动 / 容器滚动后，Tooltip 位置不更新</li>
<li>Tooltip 抖动、闪烁、频繁销毁重建</li>
<li>指令解绑不彻底，事件和监听器泄漏</li>
</ul>
<h3 data-id="heading-1">目标</h3>
<ul>
<li>全局只创建 <strong>一个 Tooltip 实例</strong></li>
<li>使用指令 <code>v-tooltip</code> 即插即用</li>
<li>支持 <code>top / right / bottom / left</code></li>
<li>自动跟随目标元素位置变化</li>
<li>无闪烁、无内存泄漏</li>
<li>TypeScript 类型安全</li>
</ul>
<p>造个轮子，代码放在仓库了，各位大佬自取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FGitfubobo%2Fvue-directives-kit" target="_blank" title="https://gitee.com/Gitfubobo/vue-directives-kit" ref="nofollow noopener noreferrer">gitee.com/Gitfubobo/v…</a></p>
<hr/>
<h2 data-id="heading-2">使用方式</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">v-tooltip</span>=<span class="hljs-string">"'删除后无法恢复'"</span>&gt;删除&lt;/button&gt;
&lt;button <span class="hljs-attr">v-tooltip.right</span>=<span class="hljs-string">"'更多操作'"</span>&gt;操作&lt;/button&gt;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4390516703954053aa41cdded74a5bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnVib2Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200257&amp;x-signature=DlV0L1k85tVu8%2FvIVj6QoFJugGU%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">整体设计思路</h2>
<blockquote>
<p><strong>Tooltip 用单例统一管理，指令只负责绑定 DOM，这里的单例是指DOM单例，页面上只存在一个DOM</strong></p>
</blockquote>
<h3 data-id="heading-4">核心拆分</h3>
<ul>
<li>
<p><strong>TooltipSingleton</strong></p>
<ul>
<li>负责 Tooltip 的创建、更新、销毁</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-keyword">import</span> tooltipV <span class="hljs-keyword">from</span> <span class="hljs-string">'./tooltip.vue'</span>;
  
  
  <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Author</span>: fubobo
     * <span class="hljs-doctag">@Description</span>: 单例
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">TooltipSingleton</span>}
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">TooltipSingleton</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span>) {
            <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooltipSingleton</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-property">instance</span>;
    }

    <span class="hljs-comment">// 创建dom挂载tooltip组件</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">createInstance</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tooltipInstance</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = <span class="hljs-title function_">createApp</span>(tooltipV);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">tooltipInstance</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
        }
    }
</code></pre>
<ul>
<li>
<p><strong>v-tooltip 指令</strong></p>
<ul>
<li>负责 DOM 事件绑定与生命周期</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 指令对象</span>
 <span class="hljs-keyword">const</span> <span class="hljs-attr">tooltipDirective</span>: <span class="hljs-title class_">Directive</span>&lt;<span class="hljs-title class_">HTMLElement</span>, <span class="hljs-built_in">string</span>&gt; = {
    <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">mount</span>(el, binding);
    },
    <span class="hljs-title function_">updated</span>(<span class="hljs-params">el, binding</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">updated</span>(el, binding);
    },
    <span class="hljs-title function_">unmounted</span>(<span class="hljs-params">el</span>) {
        <span class="hljs-title class_">TooltipSingleton</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">unmount</span>(el);
    },
};
</code></pre>
<ul>
<li>
<p><strong>位置监听工具</strong></p>
<ul>
<li>负责监听滚动 / resize / DOM 变化</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Author</span>: fubobo
     * <span class="hljs-doctag">@Description</span>: 根据目标元素和tooltip进行位置计算
     * <span class="hljs-doctag">@return</span> 坐标
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">targetEl</span>
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Placement</span>} <span class="hljs-variable">placement</span>
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">calculatePosition</span>(<span class="hljs-params">targetEl: HTMLElement, placement: Placement</span>) {
        ....
        <span class="hljs-keyword">return</span> { x, y };
    }

<span class="hljs-comment">/**
 * 监听元素距离窗口顶部的距离变化
 * <span class="hljs-doctag">@param</span> element 目标元素
 * <span class="hljs-doctag">@param</span> callback 距离变化回调
 * <span class="hljs-doctag">@param</span> options 配置项
 * <span class="hljs-doctag">@returns</span> 停止监听的函数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">observeElementViewportTop</span> = (<span class="hljs-params">
    element: HTMLElement,
    callback: PositionCallback,
    options?: {
        throttle?: <span class="hljs-built_in">number</span>; // 节流时间（默认 100ms）
        observeAncestors?: <span class="hljs-built_in">boolean</span>; // 是否监听祖先元素尺寸变化
    }
</span>) =&gt; {
    ....
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleWindowEvent);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowEvent);
        mutationObserver.<span class="hljs-title function_">disconnect</span>();
        resizeObserver.<span class="hljs-title function_">disconnect</span>();
    };
};
</code></pre>
<hr/>
<h2 data-id="heading-5">为什么一定要用「单例 Tooltip」</h2>
<p>如果每个 <code>v-tooltip</code> 都创建一个组件：</p>
<ul>
<li>DOM 数量指数级增长</li>
<li>每个 Tooltip 都监听 scroll / resize</li>
<li>事件难以统一管理</li>
</ul>
<h3 data-id="heading-6">带来的好处</h3>
<ul>
<li>整个应用 <strong>只存在一个 Tooltip</strong></li>
<li>hover 不同元素 → 只是更新内容和位置</li>
<li>性能稳定、结构清晰</li>
</ul>
<hr/>
<h2 data-id="heading-7">Tooltip 实例的创建与销毁</h2>
<h3 data-id="heading-8">创建（只会执行一次）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> createInstance() {
  <span class="hljs-keyword">this</span>.rootEl = document.createElement(<span class="hljs-string">'div'</span>);
  document.body.appendChild(<span class="hljs-keyword">this</span>.rootEl);
  <span class="hljs-keyword">this</span>.app = createApp(tooltipV);
  <span class="hljs-keyword">this</span>.tooltipInstance = <span class="hljs-keyword">this</span>.app.mount(<span class="hljs-keyword">this</span>.rootEl);
}
</code></pre>
<h3 data-id="heading-9">销毁（最后一个指令卸载时）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">destroyInstance</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">unmount</span>();
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootEl</span>);
}
</code></pre>
<h2 data-id="heading-10">Tooltip 定位计算逻辑</h2>
<p>核心思路：</p>
<blockquote>
<p><strong>使用目标元素位置 + Tooltip 自身尺寸计算最终坐标</strong></p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">tooltipRect</span> = tooltip.getBoundingClientRect()<span class="hljs-comment">;</span>
const <span class="hljs-attr">targetRect</span> = target.getBoundingClientRect()<span class="hljs-comment">;</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">switch</span> (placement) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">'top'</span>:
    x = targetRect.x + targetRect.width / <span class="hljs-number">2</span> - tooltipRect.width / <span class="hljs-number">2</span>;
    y = targetRect.y - tooltipRect.height - <span class="hljs-number">10</span>;
}
</code></pre>
<h2 data-id="heading-11">监听「元素位置变化」</h2>
<p>仅靠 <code>mouseenter</code> 是完全不够的：</p>
<ul>
<li>页面滚动</li>
<li>容器滚动</li>
<li>DOM transform</li>
<li>父级尺寸变化</li>
</ul>
<h3 data-id="heading-12">解决方案：多维度监听</h3>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">observeElementViewportTop</span>(el, callback, {
  <span class="hljs-attr">observeAncestors</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>监听来源包括：</p>





















<table><thead><tr><th>监听方式</th><th>解决问题</th></tr></thead><tbody><tr><td>scroll / resize</td><td>页面和窗口变化</td></tr><tr><td>MutationObserver</td><td>class / style 改变</td></tr><tr><td>ResizeObserver</td><td>元素或父级尺寸变化</td></tr></tbody></table>
<p>📌 Tooltip 始终贴着目标元素，不会错位</p>
<h3 data-id="heading-13">关键点</h3>
<ul>
<li>Tooltip 自身维护 hover 状态</li>
<li>延迟隐藏（100ms）</li>
<li>体验更自然</li>
</ul>
<h3 data-id="heading-14">使用 WeakMap 优化性能</h3>
<ul>
<li>不阻止 GC</li>
<li>DOM 销毁后自动释放</li>
<li>从根源避免内存泄漏</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TooltipSingleton</span> {
    ...
    <span class="hljs-keyword">private</span> eventHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;
        <span class="hljs-title class_">HTMLElement</span>,
        {
            <span class="hljs-attr">enter</span>: <span class="hljs-title class_">EventListener</span>;
            <span class="hljs-attr">leave</span>: <span class="hljs-title class_">EventListener</span>;
        }
    &gt;(); <span class="hljs-comment">// 存储元素的事件处理器（弱引用防止内存泄漏）</span>
    <span class="hljs-keyword">private</span> directiveInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;
        <span class="hljs-title class_">HTMLElement</span>,
        {
            <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">placement</span>: <span class="hljs-title class_">Placement</span>;
        }
    &gt;(); <span class="hljs-comment">// 存储元素关联的指令信息（弱引用）</span>
}
</code></pre>
<h2 data-id="heading-15">解决了哪些问题</h2>





































<table><thead><tr><th>问题</th><th>是否解决</th></tr></thead><tbody><tr><td>Tooltip 重复创建</td><td>✅</td></tr><tr><td>滚动后位置错乱</td><td>✅</td></tr><tr><td>hover 闪烁</td><td>✅</td></tr><tr><td>内存泄漏</td><td>✅</td></tr><tr><td>TypeScript 类型不安全</td><td>✅</td></tr><tr><td>指令更新无效</td><td>✅</td></tr><tr><td>支持DOM传值</td><td>✅</td></tr></tbody></table>
<h2 data-id="heading-16">代码仓库</h2>
<p>框框造个轮子，代码放在仓库了，各位大佬自取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FGitfubobo%2Fvue-directives-kit" target="_blank" title="https://gitee.com/Gitfubobo/vue-directives-kit" ref="nofollow noopener noreferrer">gitee.com/Gitfubobo/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？]]></title>    <link>https://juejin.cn/post/7600032104248934463</link>    <guid>https://juejin.cn/post/7600032104248934463</guid>    <pubDate>2026-01-28T10:25:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248934463" data-draft-id="7600032104248819775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-28T10:25:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:25:43.000Z" title="Wed Jan 28 2026 10:25:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：恰橙、席翁、濯光</p>
<blockquote>
<p>AgentScope 基于 A2A 协议与 Nacos Agent Registry，实现智能体的统一发现、治理与跨生态协作。</p>
</blockquote>
<p>随着企业逐步落地 AI 应用架构，从原来测试 POC workflow/简单 Agent 开始逐步构建生产级可用 Agent，真正解决线上问题，构建 Agent 在企业是面相全员提升效率的路径，不再是简单业务流程面临问题更加复杂，可能企业就会遇到如下挑战：</p>
<ul>
<li><strong>语言栈多样化</strong>：企业内核心业务团队可能是 Java/Golang，算法团队使用 Python，面临 Agent 架构选型多语言栈怎么做无缝协作？</li>
<li><strong>Agent 框架割裂</strong>：LangChain、AutoGPT、AgentScope 等不同框架以及 Agent 各自为政，如何实现跨框架调用？</li>
<li><strong>多团队Agent协同</strong>：Agent 如果有一个团队做，不懂业务做不深，Agent 分布在不同的服务、团队、项目中，内部选型会有 Dify、n8n 低代码和高代码平台选型，如何统一发现和管理？</li>
<li><strong>协议不统一</strong>：REST、gRPC、自定义协议...每个 Agent 都有自己的接口规范，集成成本高、维护困难。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376420a5e7234943a8b420a4c5ebc5a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=EtB756VezetQw0R%2FDPjke0NiyIY%3D" alt="图片" loading="lazy"/></p>
<p><strong>A2A（Agent-to-Agent）协议正是为解决这些问题而生。</strong> 它是 Google 提出一套面向分布式多 Agent 互联互通的开放标准，定义了统一的消息结构和能力描述，让不同语言、不同框架、不同运行时上的 Agent 都能被发现、被调用、被编排。基于 A2A，Agent 之间可以在不共享代码、不耦合底层实现的前提下，完成文本对话、thinking、多模态内容、工具调用等丰富交互，真正实现“一次定义，处处可用”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d6ffbdf9d84fc4ad46cff42863637b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=0eSFVMxugMlNgcY20hEK%2BzJcBcs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">Agent 跨语言、跨框架调用最佳实践</h2>
<p><strong>AgentScope</strong> 是阿里巴巴推出的一款以开发者为核心，专注于<strong>多智能体开发的开源框架</strong>。它的核心目标是解决智能体在构建、运行和管理中的难题，提供一套覆盖“开发、部署、监控”全生命周期的生产级解决方案。</p>
<p>在 <strong>AgentScope</strong> 最新版本中，我们<strong>全面支持 A2A 协议，并集成 Nacos 作为 A2A Registry 的默认实现</strong>，构建了一套从开发到部署的完整分布式多智能体协作体系，让智能体协作从“单打独斗”走向“开放互联”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657e92a0770a4995a8740d46b5d23798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=MbLAkSX5FeYd0o6CYydVBoSb0oY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>告别“Agent 孤岛”</strong>：通过 A2A 协议，AgentScope 的 Agent 可以与任何实现 A2A 的 Agent 无缝互操作，不论由谁开发、用何种技术栈构建，都能在统一的协作框架下高效协同，打破技术壁垒，共同构建跨语言、跨框架的开放生态。</li>
<li><strong>统一开发体验，告别适配烦恼</strong>：在 AgentScope 中，调用本地 Agent 和调用远端 A2A Agent 使用同一套 API。框架自动处理协议转换、错误重试和路由选择，我们可以专注业务，不必为适配不同 Agent 编写冗余代码，从而提升效率与可维护性。</li>
<li><strong>生产级治理，开箱即用</strong>：基于 Nacos 3.0 智能体注册中心，AgentScope 应用具备服务发现、健康检查、命名空间隔离等成熟能力。选择 Nacos 作为默认 A2A Registry，不仅因为它经过大规模生产验证，也因为它与企业现有运维体系兼容，让智能体治理无需重复造轮子，加速规模化落地。</li>
</ul>
<h2 data-id="heading-1">在 AgentScope 中使用 A2A</h2>
<h3 data-id="heading-2">1. AgentScope：连接外部 A2A 网络，像调用本地 Agent 一样简单</h3>
<p>AgentScope 提供统一的 A2A 对接能力，我们可以像调用本地工具一样自然地调用远端 A2A Agent，实现跨语言、跨框架的协同，告别繁琐的协议适配工作：</p>
<ul>
<li><strong>双向消息转换：</strong> 实现框架内部消息格式与 A2A <code>Message</code> 的双向转换，支持文本、thinking、多模态、工具调用等 Block 类型，保留必要元信息，确保语义一致。</li>
<li><strong>统一交互范式：</strong> 支持直接调用和 <code>observe()</code> 两种方式。直接调用 <code>agent(msg)</code> 可立即拿到结果；<code>observe()</code> 先累积上下文，后续再连同当前输入一起发送，适合长会话、多轮协作场景。</li>
<li><strong>任务与中断管理：</strong> 内建长任务状态管理与 Artifact 处理机制，支持长时间任务的平滑中断，覆盖超时与取消场景。</li>
<li><strong>统一的服务发现能力：</strong> 通过 <code>AgentCardResolver</code> 扩展点标准化“发现”能力，任何实现该接口的组件，例如：<code>FixedAgentCardResolver</code>、<code>FileAgentCardResolver</code>、<code>WellKnownAgentCardResolver</code>、<code>NacosAgentCardResolver</code> 等都可按需加载，轻松适配不同基础设施。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d8e0d47b294113bc3d963862ae4d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=bNZ2KwwXE0rwaadMaQ%2FHrtShx%2Fg%3D" alt="图片" loading="lazy"/></p>
<p>通过 <code>A2AAgent</code> 以及 <code>AgentCardResolver</code>，我们可以按名称、分组或标签从 A2A Registry 中发现并调用其他 Agent，实现跨团队、跨项目甚至跨语言的智能体复用。基于 A2A Registry，智能体拥有统一的服务发现与治理能力，可与现有配置中心、网关、熔断限流及安全体系协同，为大规模分布式智能体应用打好底座。</p>
<p>以下示例展示如何使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现并调用 Agent：</p>
<p><em>注意在对应版本以上使用 demo，</em> <em><strong>Python</strong></em> <em>（AgentScope</em> <em><strong>v1.0.11</strong></em> <em>、AgentScope Runtime</em> <em><strong>v1.0.4</strong></em> *）和 * <em><strong>Java</strong></em> <em>（AgentScope</em> <em><strong>v1.0.6</strong></em> <em>，AgentScope Runtime</em> <em><strong>v1.0.0</strong></em> <em>）</em></p>
<h4 data-id="heading-3">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Fzh_CN%2Ftutorial%2Ftask_a2a.html" target="_blank" title="https://doc.agentscope.io/zh_CN/tutorial/task_a2a.html" ref="nofollow noopener noreferrer">doc.agentscope.io/zh_CN/tutor…</a></strong></p>
<pre><code class="hljs language-ini" lang="ini">from agentscope.agent import A2AAgent
from agentscope.a2a import NacosAgentCardResolver
from agentscope.message import Msg
<span class="hljs-comment"># Python AgentScope v1.0.11以上</span>
<span class="hljs-comment"># 创建 Nacos AgentCard Resolver</span>
<span class="hljs-attr">nacos_resolver</span> = NacosAgentCardResolver(
    <span class="hljs-attr">remote_agent_name</span>=<span class="hljs-string">"my-remote-agent"</span>,  <span class="hljs-comment"># Nacos 中注册的智能体名称</span>
    <span class="hljs-attr">nacos_client_config</span>=ClientConfig(
        <span class="hljs-attr">server_addresses</span>=<span class="hljs-string">"http://localhost:8848"</span>,  <span class="hljs-comment"># Nacos 服务器地址</span>
        <span class="hljs-comment"># 其他可选配置项</span>
    ),
)
<span class="hljs-comment"># 使用 Resolver 创建 A2AAgent，通过名称从 Nacos 发现 Agent</span>
<span class="hljs-attr">agent</span> = A2AAgent(
    <span class="hljs-attr">agent_card</span>=await nacos_resolver.get_agent_card()
)
</code></pre>
<h4 data-id="heading-4">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现 Agent：</p>
<pre><code class="hljs language-ini" lang="ini">import io.agentscope.agent.A2AAgent<span class="hljs-comment">;</span>
import io.agentscope.extensions.a2a.nacos.NacosAgentCardResolver<span class="hljs-comment">;</span>
import java.util.Properties<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.PropertyKeyConst<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiFactory<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiService<span class="hljs-comment">;</span>
Properties <span class="hljs-attr">properties</span> = new Properties()<span class="hljs-comment">;</span>
properties.put(PropertyKeyConst.SERVER_ADDR, "localhost:8848")<span class="hljs-comment">;</span>
// 其他可选配置项
AiService <span class="hljs-attr">aiService</span> = AiFactory.createAiService(properties)<span class="hljs-comment">;</span>
NacosAgentCardResolver <span class="hljs-attr">agentCardResolver</span> = new NacosAgentCardResolver(aiService)<span class="hljs-comment">;</span>
A2AAgent <span class="hljs-attr">agent</span> = A2AAgent.builder()
        .name("MyAgent")
        .agentCardResolver(agentCardResolver)
        .build()<span class="hljs-comment">;</span>
</code></pre>
<p>Nacos 3.0 作为智能体注册中心，其在生产环境中久经验证的服务发现与配置管理能力，能够助力企业构建统一的智能体服务治理平台。</p>
<h3 data-id="heading-5">2. AgentScope Runtime：暴露 A2A Agent 服务，启动即注册</h3>
<p>AgentScope Runtime 提供统一的 A2A 服务暴露能力，帮助我们把本地 Agent 应用包装成符合 A2A 规范的服务端点。通过 A2A 协议适配器，应用在启动时会自动完成：</p>
<ul>
<li><strong>结构化配置体系</strong>：通过 A2A 扩展配置 <code>a2a_config</code> 灵活定义 AgentCard（name、description、version、skills、default_input_modes/default_output_modes 等）、传输层配置（host、port、path 等）、Registry 参数和任务超时等。</li>
<li><strong>自动服务包装</strong>：启动时由 A2A 协议适配器将 Agent 应用封装成符合 A2A 规范的服务端点，自动处理协议转换、消息路由等底层细节。</li>
<li><strong>生产级部署支持</strong>：与主流框架无缝集成，Python 侧支持 <code>AgentApp</code> 配置体系，Java 侧支持 <code>Spring Boot Starter</code>，让智能体服务自然融入现有基础设施。</li>
<li><strong>自动服务注册与治理</strong>：通过 <code>A2ARegistry</code> 抽象接口，Python 与 Java 都能开箱即用地集成 Nacos Agent Registry。Agent 能力描述（AgentCard）和网络端点会自动注册到 Registry，让其他 Agent 可发现、可调用。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55dd73181c2940148036fccb9ad74158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=42WC7sFaCCxRJDKPaI72ZBYy6qE%3D" alt="图片" loading="lazy"/></p>
<p>以下示例展示如何在 Runtime 层使用 Nacos Registry 进行服务注册：</p>
<h4 data-id="heading-6">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fzh%2Fa2a_registry.html" target="_blank" title="https://runtime.agentscope.io/zh/a2a_registry.html" ref="nofollow noopener noreferrer">runtime.agentscope.io/zh/a2a_regi…</a></strong></p>
<p><strong>方式一：参数配置</strong></p>
<p>在构造 AgentApp 时，通过 A2A 配置扩展字段 a2a_config 参数的 registry 字段指定 Registry 实例或列表：</p>
<pre><code class="hljs language-ini" lang="ini">from agentscope_runtime.engine.app import AgentApp
from agentscope_runtime.engine.deployers.adapter.a2a import (
    AgentCardWithRuntimeConfig,
)
from agentscope_runtime.engine.deployers.adapter.a2a.nacos_a2a_registry import (
    NacosRegistry,
)
from v2.nacos import ClientConfigBuilder
<span class="hljs-comment"># 创建 Nacos Registry 实例</span>
<span class="hljs-attr">registry</span> = NacosRegistry(
    <span class="hljs-attr">nacos_client_config</span>=ClientConfigBuilder()
        .server_address("nacos-server:8848")
        <span class="hljs-comment"># 其他可选配置项</span>
        .build()
)
<span class="hljs-attr">app</span> = AgentApp(
    <span class="hljs-attr">app_name</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-attr">app_description</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-comment"># 在 a2a_config 中配置 registry</span>
    <span class="hljs-attr">a2a_config</span>=AgentCardWithRuntimeConfig(registry=registry),
)
</code></pre>
<p><strong>方式二：使用环境变量配置</strong></p>
<p>环境变量可以通过 .env 文件或系统环境变量设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 文件示例</span>
<span class="hljs-attr">A2A_REGISTRY_ENABLED</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">A2A_REGISTRY_TYPE</span>=nacos
<span class="hljs-attr">NACOS_SERVER_ADDR</span>=localhost:<span class="hljs-number">8848</span>
<span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<h4 data-id="heading-7">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>在最新版本的 Java AgentScope 中，应用可以直接暴露 A2A 服务，只有在需要使用 Sandbox 时，才需要使用 Runtime。</p>
<p>对于非最新版本，Java 开发者可以将 AgentScope Agent 无缝融入现有的 Spring Boot 基础设施体系。通过引入 <code>spring-boot-starter-agentscope-runtime-a2a-nacos</code> 依赖，应用在启动时会自动暴露 A2A 服务并注册到 Nacos Registry。</p>
<p><strong>Maven 依赖配置</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-agentscope-runtime-a2a-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>application.yaml 配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">agentscope:</span>
  <span class="hljs-attr">a2a:</span>
    <span class="hljs-attr">server:</span>
      <span class="hljs-attr">card:</span>
        <span class="hljs-string">description:</span> <span class="hljs-string">"基于 A2A 协议的 Java 智能体"</span>
        <span class="hljs-attr">provider:</span>
          <span class="hljs-attr">organization:</span> <span class="hljs-string">您的组织名称</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">https://your-organization.com</span>
      <span class="hljs-attr">nacos:</span>
        <span class="hljs-string">server-addr:</span> <span class="hljs-string">${NACOS_SERVER_ADDRESS:127.0.0.1:8848}</span>
        <span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<p>通过上述配置，Spring Boot 应用在启动时会自动：</p>
<ul>
<li>暴露符合 A2A 规范的 JSONRPC 服务端点（默认路径：<code>/a2a/jsonrpc</code>）。</li>
<li>暴露 AgentCard 的 Well-Known 端点（默认路径：<code>/.well-known/agent-card.json</code>），用于其他 Agent 发现和了解当前 Agent 的能力。</li>
<li>自动处理 A2A 协议的消息转换和路由，将 A2A 消息格式转换为应用内部的消息处理逻辑。</li>
<li>支持任务超时、中断等 A2A 协议规定的运行时特性。</li>
<li>将 Agent 的能力描述（AgentCard）注册到 Nacos，基于 Nacos 3.0 智能体注册中心进行统一治理。</li>
</ul>
<p>得益于这一机制，AgentScope 应用启动即完成在 Nacos 的 A2A Agent 注册，为后续的发现、路由、灰度与监控奠定基础。对于已经大规模采用 Java 技术栈的团队，这意味着智能体服务能自然长在同一套基础设施上，大幅降低引入成本与运维负担。</p>
<h2 data-id="heading-8">总结</h2>
<p><strong>AgentScope 全面支持 A2A 协议和 Nacos Agent Registry</strong>，标志着智能体从“单点能力”迈向“开放互联生态”的关键一步，为企业构建统一的智能体管理平台，助力大规模 Agent 化落地：</p>
<ul>
<li><strong>AgentScope 层：借助</strong> A2AAgent 与 AgentCardResolver，我们提供统一的 A2A 对接能力和灵活的发现策略，默认集成 Nacos，支持动态 Agent 发现与调用。</li>
<li><strong>AgentScope Runtime 层：通过 A2A 协议适配器和</strong> A2ARegistry 抽象接口，提供统一的 A2A 服务暴露能力，支持自动服务注册与治理，与 Python AgentApp 和 Java Spring Boot Starter 无缝集成。</li>
</ul>
<p>未来，我们会继续围绕 A2A 与 Registry 深耕，在发现与路由、版本与灰度、安全与访问控制等方向迭代，让面向生产的智能体应用更稳、更易用。</p>
<p><strong>扩展链接</strong>：</p>
<p>AgentScope：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2F" target="_blank" title="https://doc.agentscope.io/" ref="nofollow noopener noreferrer">doc.agentscope.io/</a></p>
<p>AgentScope Python A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Ftutorial%2Ftask_a2a.htmlAgentScope" target="_blank" title="https://doc.agentscope.io/tutorial/task_a2a.htmlAgentScope" ref="nofollow noopener noreferrer">doc.agentscope.io/tutorial/ta…</a></p>
<p>Java：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2FAgentScope" target="_blank" title="https://java.agentscope.io/AgentScope" ref="nofollow noopener noreferrer">java.agentscope.io/AgentScope</a></p>
<p>Java A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fen%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/en/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/en/task/a2a…</a></p>
<p>Nacos：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2Fdocs%2Flatest%2Fmanual%2Fuser%2Fai%2Fagent-registry" target="_blank" title="https://nacos.io/docs/latest/manual/user/ai/agent-registry" ref="nofollow noopener noreferrer">nacos.io/docs/latest…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mri@1.2.0源码阅读]]></title>    <link>https://juejin.cn/post/7600234310965002278</link>    <guid>https://juejin.cn/post/7600234310965002278</guid>    <pubDate>2026-01-28T10:23:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965002278" data-draft-id="7599496293174345747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mri@1.2.0源码阅读"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T10:23:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米丘"/> <meta itemprop="url" content="https://juejin.cn/user/1611227736052074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mri@1.2.0源码阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1611227736052074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米丘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:23:50.000Z" title="Wed Jan 28 2026 10:23:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>mri</code>（全称 Minimalist CLI Argument Parser）的核心作用是<strong>解析命令行传入的参数</strong>，把用户在终端输入的命令行参数（比如 <code>--port 3000</code>、<code>-v</code>）转换成易于在代码中使用的 JavaScript 对象。</p>
<h2 data-id="heading-0">有什么特点？</h2>
<ol>
<li><strong>超轻量</strong>：体积只有几百 KB，无依赖，适合对包体积敏感的 Node.js/ 前端工具开发；</li>
<li><strong>易用性</strong>：API 极简，几行代码就能完成参数解析；</li>
<li><strong>常用场景</strong>：前端工程化工具（如自定义构建脚本、本地开发服务器、CLI 工具）中解析命令行参数。</li>
</ol>
<h2 data-id="heading-1">index文件</h2>
<p><code>mri-1.2.0/src/index.js</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">args, opts</span>) {
  args = args || []; <span class="hljs-comment">// 命令行参数数组（比如 process.argv.slice(2)）</span>
  opts = opts || {}; <span class="hljs-comment">// 解析配置（别名、默认值、类型等）</span>

  <span class="hljs-keyword">var</span> k, arr, arg, name, val, out={ <span class="hljs-attr">_</span>:[] }; <span class="hljs-comment">// out 解析结果对象</span>
  <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>, j=<span class="hljs-number">0</span>, idx=<span class="hljs-number">0</span>, len=args.<span class="hljs-property">length</span>;

  <span class="hljs-comment">// 标记是否配置了别名、严格模式、默认值</span>
  <span class="hljs-keyword">const</span> alibi = opts.<span class="hljs-property">alias</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> strict = opts.<span class="hljs-property">unknown</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> defaults = opts.<span class="hljs-property">default</span> !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;

  opts.<span class="hljs-property">alias</span> = opts.<span class="hljs-property">alias</span> || {};
  opts.<span class="hljs-property">string</span> = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">string</span>); <span class="hljs-comment">// 字符串类型的参数名数组</span>
  opts.<span class="hljs-property">boolean</span> = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">boolean</span>); <span class="hljs-comment">// 布尔类型的参数名数组</span>

  <span class="hljs-comment">// 别名双向绑定</span>
  <span class="hljs-keyword">if</span> (alibi) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">alias</span>) {
      arr = opts.<span class="hljs-property">alias</span>[k] = <span class="hljs-title function_">toArr</span>(opts.<span class="hljs-property">alias</span>[k]);
      <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
        (opts.<span class="hljs-property">alias</span>[arr[i]] = arr.<span class="hljs-title function_">concat</span>(k)).<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);
      }
    }
  }
  <span class="hljs-comment">// 布尔 / 字符串类型补全</span>
  <span class="hljs-comment">// 布尔类型：把别名也加入布尔列表</span>
  <span class="hljs-keyword">for</span> (i=opts.<span class="hljs-property">boolean</span>.<span class="hljs-property">length</span>; i-- &gt; <span class="hljs-number">0</span>;) {
    arr = opts.<span class="hljs-property">alias</span>[opts.<span class="hljs-property">boolean</span>[i]] || [];
    <span class="hljs-keyword">for</span> (j=arr.<span class="hljs-property">length</span>; j-- &gt; <span class="hljs-number">0</span>;) opts.<span class="hljs-property">boolean</span>.<span class="hljs-title function_">push</span>(arr[j]);
  }

  <span class="hljs-comment">// 字符串类型：同理，把别名也加入字符串列表</span>
  <span class="hljs-keyword">for</span> (i=opts.<span class="hljs-property">string</span>.<span class="hljs-property">length</span>; i-- &gt; <span class="hljs-number">0</span>;) {
    arr = opts.<span class="hljs-property">alias</span>[opts.<span class="hljs-property">string</span>[i]] || [];
    <span class="hljs-keyword">for</span> (j=arr.<span class="hljs-property">length</span>; j-- &gt; <span class="hljs-number">0</span>;) opts.<span class="hljs-property">string</span>.<span class="hljs-title function_">push</span>(arr[j]);
  }

  <span class="hljs-comment">// 默认值关联类型</span>
  <span class="hljs-keyword">if</span> (defaults) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">default</span>) {
      name = <span class="hljs-keyword">typeof</span> opts.<span class="hljs-property">default</span>[k];
      arr = opts.<span class="hljs-property">alias</span>[k] = opts.<span class="hljs-property">alias</span>[k] || [];
      <span class="hljs-keyword">if</span> (opts[name] !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
        opts[name].<span class="hljs-title function_">push</span>(k);
        <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
          opts[name].<span class="hljs-title function_">push</span>(arr[i]);
        }
      }
    }
  }

  <span class="hljs-comment">// 遍历解析命令行参数</span>
  <span class="hljs-keyword">const</span> keys = strict ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(opts.<span class="hljs-property">alias</span>) : [];

  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; len; i++) {
    arg = args[i]; <span class="hljs-comment">// 当前处理的参数（比如 '--port'、'-p=3000'）</span>

    <span class="hljs-comment">// 1. 遇到 "--" 终止解析，后续参数全部放入 out._</span>
    <span class="hljs-keyword">if</span> (arg === <span class="hljs-string">'--'</span>) {
      out.<span class="hljs-property">_</span> = out.<span class="hljs-property">_</span>.<span class="hljs-title function_">concat</span>(args.<span class="hljs-title function_">slice</span>(++i));
      <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-comment">// 2. 计算参数前的 "-" 数量（比如 --port 是 2 个，-p 是 1 个）</span>
    <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; j &lt; arg.<span class="hljs-property">length</span>; j++) {
      <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">charCodeAt</span>(j) !== <span class="hljs-number">45</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// "-"</span>
    }

    <span class="hljs-comment">// 3. 无 "-"：非选项参数，放入 out._</span>
    <span class="hljs-keyword">if</span> (j === <span class="hljs-number">0</span>) {
      out.<span class="hljs-property">_</span>.<span class="hljs-title function_">push</span>(arg);

      <span class="hljs-comment">// 4. 以 "no-" 开头（比如 --no-open）：布尔值取反</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">substring</span>(j, j + <span class="hljs-number">3</span>) === <span class="hljs-string">'no-'</span>) {
      name = arg.<span class="hljs-title function_">substring</span>(j + <span class="hljs-number">3</span>);
      <span class="hljs-keyword">if</span> (strict &amp;&amp; !~keys.<span class="hljs-title function_">indexOf</span>(name)) {
        <span class="hljs-keyword">return</span> opts.<span class="hljs-title function_">unknown</span>(arg);
      }
      out[name] = <span class="hljs-literal">false</span>;

      <span class="hljs-comment">// 5. 正常选项参数（比如 --port=3000、-p3000、-p 3000）</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 找到 "=" 的位置（分割参数名和值）</span>
      <span class="hljs-keyword">for</span> (idx=j+<span class="hljs-number">1</span>; idx &lt; arg.<span class="hljs-property">length</span>; idx++) {
        <span class="hljs-keyword">if</span> (arg.<span class="hljs-title function_">charCodeAt</span>(idx) === <span class="hljs-number">61</span>) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// "="</span>
      }

      <span class="hljs-comment">// 取值：有=则取=后的值；无=则取下一个参数（如果下一个不是-开头）</span>
      name = arg.<span class="hljs-title function_">substring</span>(j, idx);
      val = arg.<span class="hljs-title function_">substring</span>(++idx) || (i+<span class="hljs-number">1</span> === len || (<span class="hljs-string">''</span>+args[i+<span class="hljs-number">1</span>]).<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) === <span class="hljs-number">45</span> || args[++i]);
      arr = (j === <span class="hljs-number">2</span> ? [name] : name);

      <span class="hljs-comment">// 遍历解析（比如 -pv 会拆成 p 和 v 分别处理）</span>
      <span class="hljs-keyword">for</span> (idx=<span class="hljs-number">0</span>; idx &lt; arr.<span class="hljs-property">length</span>; idx++) {
        name = arr[idx];
        <span class="hljs-keyword">if</span> (strict &amp;&amp; !~keys.<span class="hljs-title function_">indexOf</span>(name)) <span class="hljs-keyword">return</span> opts.<span class="hljs-title function_">unknown</span>(<span class="hljs-string">'-'</span>.<span class="hljs-title function_">repeat</span>(j) + name);
        <span class="hljs-comment">// 把解析后的值存入 out（toVal 是核心工具函数）</span>
        <span class="hljs-title function_">toVal</span>(out, name, (idx + <span class="hljs-number">1</span> &lt; arr.<span class="hljs-property">length</span>) || val, opts);
      }
    }
  }

  <span class="hljs-comment">// 1. 补全默认值：如果参数未解析到，用默认值填充</span>
  <span class="hljs-keyword">if</span> (defaults) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> opts.<span class="hljs-property">default</span>) {
      <span class="hljs-keyword">if</span> (out[k] === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
        out[k] = opts.<span class="hljs-property">default</span>[k];
      }
    }
  }

  <span class="hljs-comment">// 2. 同步别名：比如解析到 -p=3000，自动给 out.port 也赋值 3000</span>
  <span class="hljs-keyword">if</span> (alibi) {
    <span class="hljs-keyword">for</span> (k <span class="hljs-keyword">in</span> out) {
      arr = opts.<span class="hljs-property">alias</span>[k] || [];
      <span class="hljs-keyword">while</span> (arr.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        out[arr.<span class="hljs-title function_">shift</span>()] = out[k];
      }
    }
  }

  <span class="hljs-keyword">return</span> out;
}

</code></pre>
<h3 data-id="heading-2">toArr</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">toArr</span>(<span class="hljs-params">any</span>) {
	<span class="hljs-keyword">return</span> any == <span class="hljs-literal">null</span> ? [] : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(any) ? any : [any];
}
</code></pre>
<h3 data-id="heading-3">toVal</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">toVal</span>(<span class="hljs-params">out, key, val, opts</span>) {
  <span class="hljs-keyword">var</span> x,
    old = out[key],
    nxt = !!~opts.<span class="hljs-property">string</span>.<span class="hljs-title function_">indexOf</span>(key)
      ? val == <span class="hljs-literal">null</span> || val === <span class="hljs-literal">true</span>
        ? <span class="hljs-string">''</span>
        : <span class="hljs-title class_">String</span>(val)
      : <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'boolean'</span>
        ? val
        : !!~opts.<span class="hljs-property">boolean</span>.<span class="hljs-title function_">indexOf</span>(key)
          ? val === <span class="hljs-string">'false'</span>
            ? <span class="hljs-literal">false</span>
            : val === <span class="hljs-string">'true'</span> ||
              (out.<span class="hljs-property">_</span>.<span class="hljs-title function_">push</span>(((x = +val), x * <span class="hljs-number">0</span> === <span class="hljs-number">0</span>) ? x : val), !!val)
          : ((x = +val), x * <span class="hljs-number">0</span> === <span class="hljs-number">0</span>)
            ? x
            : val;
  out[key] =
    old == <span class="hljs-literal">null</span> ? nxt : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(old) ? old.<span class="hljs-title function_">concat</span>(nxt) : [old, nxt];
}

</code></pre>
<h2 data-id="heading-4">示例</h2>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">const</span> mri = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mri'</span>);
<span class="hljs-keyword">const</span> args = <span class="hljs-title function_">mri</span>(process.<span class="hljs-property">argv</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7a88ff58c443adaf088a42016e276a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57Gz5LiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200633&amp;x-signature=Zl9eZc2JN7pY7zxjvtkz%2B1xSiuU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[蚂蚁出手VLA，就是开源超越Pi0.5的基座模型]]></title>    <link>https://juejin.cn/post/7600242248861401128</link>    <guid>https://juejin.cn/post/7600242248861401128</guid>    <pubDate>2026-01-28T10:31:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248861401128" data-draft-id="7600265780349190184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="蚂蚁出手VLA，就是开源超越Pi0.5的基座模型"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-28T10:31:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            蚂蚁出手VLA，就是开源超越Pi0.5的基座模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:31:24.000Z" title="Wed Jan 28 2026 10:31:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一个机器人到底需要多「聪明」，你才愿意把它请进家门？</p>
<p>前段时间，明星具身智能公司 1X 开始预售其人形机器人 Neo。演示视频中，它能从冰箱取水、叠衣服、把餐具放进洗碗机，俨然一个称职的家务助手。</p>
<p>但问题是，它当时真正能自主完成的，也只有这几件事。至于更多样的日常任务 —— 比如整理散落的玩具、擦拭台面、收纳杂物 —— 在现阶段，大多仍需要工程师远程教学。</p>
<p>这就多少有些令人迟疑：花费近 14 万元，迎来的不仅是一个「助手」，还可能是一双需要你授权进入家庭隐私空间的「眼睛」。社交网络上，不少人也对这种「半成品智能」表达了困惑甚至调侃。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5601059b0c504929aa1ff40cdee59efd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=%2FYNa0khG0jvojgylwfOKTc%2FJHcs%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1fe017de064cf4b7168da5c3b3349a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=%2FCOldV%2BYNywz4okirqNYcgdpsSk%3D" alt="图片" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98080019d86248f8bba78557b8e681a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=XBCYh7N%2Bgi4hbKI6SOAQt3iFaLA%3D" alt="图片" loading="lazy"/></p>
<p>这种「演示场景自主、真实任务依赖人工」的割裂状态，恰恰映射出当前具身智能落地的核心挑战：泛化能力不足。</p>
<p>要突破这一瓶颈，业界共识是：需要更大规模、更多样化的真实机器人数据来「喂养」模型，使其学习到更本质的任务理解与动作泛化能力。然而，高质量真机数据的采集成本极高，且不同构型机器人的数据难以复用，导致大多数模型仍只能在有限数据或仿真环境中训练，难以实现真正的跨任务、跨本体泛化。</p>
<p>在这一背景下，蚂蚁灵波开源发布的第一款具身智能基座模型 LingBot-VLA 带来了一个好消息：它基于约 20000 小时、覆盖 9 种主流双臂机器人构型的真实世界数据预训练而成，在涵盖 100 多项任务的统一真机评测基准下整体表现超越 Pi0.5，成为了能够跨本体、跨场景泛化的开源具身基座模型新标杆。</p>
<p>这一超越并非偶然，而是源于 LingBot-VLA 在模型架构、数据规模与训练效率上的系统性突破。在最新的技术报告中，我们可以看到相关细节。而且，蚂蚁灵波还开源了相应的模型权重、代码、后训练工具链，确保开发者不仅能拿到模型，还能把模型调得更好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23250a069c9a4880a7b8aad16b997f0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=9%2BvaonmKN3Hymgs5Qsf3%2Bn8cTq0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftechnology.robbyant.com%2Flingbot-vla" target="_blank" title="https://technology.robbyant.com/lingbot-vla" ref="nofollow noopener noreferrer">technology.robbyant.com/lingbot-vla</a></p>
</li>
<li>
<p>技术报告链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2601.18692" target="_blank" title="https://arxiv.org/pdf/2601.18692" ref="nofollow noopener noreferrer">arxiv.org/pdf/2601.18…</a></p>
</li>
<li>
<p>模型下载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fcollections%2Frobbyant%2Flingbot-vla" target="_blank" title="https://huggingface.co/collections/robbyant/lingbot-vla" ref="nofollow noopener noreferrer">huggingface.co/collections…</a></p>
</li>
<li>
<p>代码、后训练工具链链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frobbyant%2Flingbot-vla%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25C2%25A0%25E9%25AD%2594%25E6%2590%25AD%25E7%25A4%25BE%25E5%258C%25BA%25EF%25BC%259Ahttps%3A%2F%2Fwww.modelscope.cn%2Fcollections%2FRobbyant%2FLingBot-VLA" target="_blank" title="https://github.com/robbyant/lingbot-vla%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%E9%AD%94%E6%90%AD%E7%A4%BE%E5%8C%BA%EF%BC%9Ahttps://www.modelscope.cn/collections/Robbyant/LingBot-VLA" ref="nofollow noopener noreferrer">github.com/robbyant/li…</a></p>
</li>
</ul>
<p>看来，在具身智能这个领域，通过大规模扩展真实数据驱动模型泛化，已从技术愿景走向工程现实。</p>
<p>超越 Pi0.5，意味着什么？</p>
<p>在 LingBot-VLA 出现之前，Physical Intelligence 开源的 Pi0.5 几乎是行业内无法绕开的标杆。</p>
<p>为什么它有这么强的统治力？根本原因在于，Pi0.5 首次在开源世界里证明了：一个模型，不需要针对特定场景专门训练，就能在完全陌生的真实家庭环境中，完成长达 10-15 分钟的复杂操作链条。这件事让行业第一次清晰地看到，具身智能并非只能在「摆拍式」的单一任务中工作，而是有可能真正进入非结构化、充满不确定性的真实生活场景，完成从「实验室奇观」到「规模化产品」的过渡。</p>
<p>所以无论是学术论文里的对比实验，还是产业界的模型选型，Pi0.5 都是那个「必须要放进去比一比」的对象。也因为有这么一个「扛把子」的开源模型存在，很多机器人公司并不直接从零训练模型，而是选择在 Pi0.5 的基础上进行微调，再部署到自己的机器人本体上，这也进一步巩固了它在开源具身生态中的核心地位。</p>
<p>当然，也有不少团队选择正面硬刚，以自研模型对标 Pi0.5。但真正落到实际评测中，情况却要复杂得多。许多模型往往只能在某一个特定任务、某一种固定构型的机器人上取得更好的成绩，一旦换一个任务类型，或换一台不同本体的机器人，优势就会消失，甚至性能大幅退化。本质上，这仍然是专用模型在特定分布上的胜利，而不是泛化能力的提升。</p>
<p>这种局面很大程度上受制于底层的现实约束。我们知道，目前困扰具身模型的最大问题就是数据不够用，而数据与特定硬件的强绑定又加剧了这一问题。如果模型和训练范式无法高效吸收多源异构数据，那么简单地「多喂数据」这条路就跑不通。</p>
<p>也正是在这样的行业背景下，真正意义上的「整体超越 Pi0.5」，才显得格外稀缺。它不只是某个指标上的领先，还意味着模型在数据利用方式、训练效率以及跨本体、跨任务泛化能力上，已经迈过了一个新的台阶。LingBot-VLA 的出现，正是在这个时间点上，给出了一个不同于以往的答案。</p>
<p>三大平台，100 项真机任务</p>
<p>LingBot-VLA 经住了考验</p>
<p>LingBot-VLA 的强泛化能力，本质上来源于其对海量跨本体数据的有效利用。这个模型所用的 20000 小时真机数据，来自 9 个不同的机器人平台。传统上，由于不同机器人之间的传感器、控制接口、本体结构差异巨大，这些数据是很难被统一利用的，而 LingBot-VLA 打破了这一瓶颈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a283c529a3264b438e00afe38b13fc28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=iMA7F8qfDtmyegS4UjhxuoTNb0U%3D" alt="图片" loading="lazy"/></p>
<p>为了验证 LingBot-VLA 到底有多强，蚂蚁灵波在一个全新的具身智能基准 ——GM-100 上对其进行了测试。</p>
<p>这个基准总共包含 100 项真机任务，由上海交大牵头，蚂蚁灵波等多机构联合研发。我们打开它的官网看了一下，发现事情并不简单 —— 那些任务不是简单的「pick，hold，place（拿取，保持，放置）」操作，而是涉及了很多长序列任务和精细操作，比如串糖葫芦、拉软包拉链、叠衣服…… 一些看似简单的任务，比如按台灯开关、整理小物体，也会因为机械臂构型、物体材质、位置摆放、指令理解等因素而呈现出区分度。可以说，GM-100 通过精心设计复杂、长尾的多样化任务，为具身大模型设置了一张科学、严谨且难以取巧的「统考卷」。想在这样一个数据集上拿到好成绩，对于现阶段的模型来说是相当不容易的。</p>
<p>即使是这样，蚂蚁灵波还是选择继续上难度 —— 模型并非仅在单一机器人上验证，而是被部署在来自三大不同平台（AgileX、Agibot G1、Galaxea R1Pro）的 25 台机器人上统一执行任务。如此一来，整个测试就成了一个跨本体、跨任务能力的综合考验。</p>
<p>同时参与测试的还有 GR00T、WALL-OSS 以及 Pi0.5，这些都是开源具身模型里的优秀代表。</p>
<p>实验结果显示，无论在哪个平台上，LingBot-VLA 的成功率（SR）和部分成功率（PS，子步骤完成情况）都是最高的。尤其在融入基于深度的空间信息后，模型优势更加明显 —— 相比 Pi0.5 平均 SR 提高了 4.28%，PS 提高了 7.76%。这说明，无论是在复杂长序列任务的执行精度上，还是在面对新任务的适应能力上，LingBot-VLA 都展现出了更胜一筹的智能水平。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbefa0c223304f1abdab104737490c4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=2fHNzAmfHTS99OgdkPRZYm2n%2BgQ%3D" alt="图片" loading="lazy"/></p>
<p>另外，值得注意的是，LingBot-VLA 的数据利用效率和算力效率也更高。</p>
<p>实验显示，在 Agibot G1 平台上，仅使用 80 条示范数据进行后训练，LingBot-VLA 的表现就超越了使用 130 条完整数据训练的 Pi0.5 模型。而且，当数据量逐步增加时，LingBot-VLA 与 Pi0.5 的性能差距进一步拉大，这从侧面印证了其模型架构在学习潜能和泛化可扩展性上的设计优势。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d5a1d3b5c75478f87cb7b4deeaa3671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=kxj7jqARcmOi2iyiQN%2FUdxI4EF8%3D" alt="图片" loading="lazy"/></p>
<p>而在算力效率方面，LingBot-VLA 的训练框架也展现出明显优势。在相同数据集和标准化架构下，其训练吞吐量（samples/s）均显著高于 StarVLA、Dex Botic、OpenPI 等主流开源框架。更突出的是，随着 GPU 规模从 8 卡扩展至 256 卡，其训练效率仍能紧密跟随理论线性扩展上限，展现出卓越的大规模分布式训练可扩展性。这意味着企业能以更低算力成本、更短训练周期完成模型迭代，实现从实验到落地的高效转化。</p>
<p>架构揭秘</p>
<p>从「大脑」到「小脑」的智能耦合</p>
<p>刚才提到，LingBot-VLA 在模型架构、数据效率、训练效率等方面都经得起考验，那么，蚂蚁灵波是怎么做到的呢？在技术报告中，他们透露了一些细节。</p>
<p>首先，在架构层面，LingBot-VLA 选择了一个强大的预训练视觉语言模型作为理解世界的「大脑」，然后为其配上一个专门负责生成机器人动作的「动作专家」。两者并非简单拼接，而是通过一种名为 Mixture-of-Transformers (MoT) 的架构有机结合：视觉、语言和动作数据各自通过独立的处理通路，又在每一层通过共享的注意力机制进行交互。这样既保证了视觉语义知识能持续指导动作生成，又避免了不同模态信息间的相互干扰。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f941c98503b4306ac0d77a02f80d51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=NipDi7RKtQHjgP9D2C1Bm0Kgii8%3D" alt="图片" loading="lazy"/></p>
<p>在动作生成上，模型采用了 Flow Matching 方法来建模连续、平滑的动作轨迹，这有助于提升复杂操作的控制稳定性。</p>
<p>对于机器人操作至关重要的空间感知能力，LingBot-VLA 采用了一种基于视觉蒸馏的深度信息融合方法。其核心在于：模型并未直接将深度图作为原始输入，而是通过一套可学习的查询（Learnable Queries）机制，使其视觉语言主干（VLM）提取的特征，与专用深度模型 LingBot-Depth 所生成的空间表征进行对齐。这让模型在推理时无需深度图输入，就能具备对三维几何关系的隐式理解，从而实现了在抓取、放置等任务中精度的大幅提升。具体效果如视频所示。</p>
<p>在训练效率方面，研发团队还对其训练代码库进行了系统级优化。在分布式策略上，采用经过改进的 FSDP 策略，在内存占用与通信开销间取得了最佳平衡；在算子层面，利用 FlexAttention 和算子融合等技术，大幅提升了核心计算效率。最终，其训练吞吐量达到了每 GPU 每秒 261 个样本，相比主流开源代码库有 1.5 至 2.8 倍的加速，且扩展性极佳，能随着 GPU 数量增加近乎线性地提升训练速度。</p>
<p>LingBot-VLA——</p>
<p>开源具身基座模型新起点</p>
<p>总体而言，无论在模型泛化能力还是训练效率方面，LingBot-VLA 都已树立起一个新的行业标杆。然而，其真正的深远意义，不止于一次性能的超越，更在于它为「通过扩展真实数据实现更强泛化」提供了首个扎实的实证。 </p>
<p>蚂蚁灵波在技术报告中首次系统性地揭示了 VLA 模型在真实机器人数据上的 Scaling Law：随着预训练数据规模从 3000 小时逐步扩展至 20000 小时，模型在下游任务的成功率获得了持续且显著的提升。尤为关键的是，即使达到 20000 小时这一量级，模型性能曲线仍未显示饱和迹象。这一发现为行业点亮了一座灯塔，用数据证实了「大力出奇迹」的路径在真实机器人学习中依然有效，为后续的大规模数据开发指明了可预期的回报。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce525fba24744bb8922c46602eaa3c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201084&amp;x-signature=BfqanjF%2FEDwM33fOODGWpbZ3nH8%3D" alt="图片" loading="lazy"/></p>
<p>更进一步看，这类以真实交互数据为核心、兼顾规模与效率的成功实践，也为 VLA 模型未来与世界模型的深度融合奠定了现实基础。</p>
<p>不过，所有模型在 GM-100 上平均成功率都未超过 20% 的现实也在提醒我们，具身模型 —— 尤其是开源具身模型 —— 距离真正的跨本体、跨场景泛化还有很长的路要走。接下来，相关从业者可以在 LingBot-VLA 的基础上继续前进，而蚂蚁灵波的全链路开源（模型权重、代码、后训练工具链全部开源）也为这种持续迭代提供了土壤。</p>
<p>但如果把它放到更长周期里看，LingBot-VLA 可能还有另一层意义 —— 它也可以被理解为蚂蚁 AGI 版图里一次面向「真实世界交互」的落子：在基础大模型（百灵）与通用助手（灵光）等「通用智能」能力之外，通过具身智能把模型带入可验证、可复现的物理世界闭环。</p>
<p>这也解释了它为什么选择以开源方式发布，并同步建设 InclusionAI 这样的开源社区与技术体系：用更开放的协作与复现机制扩大验证面，让具身智能的迭代速度更接近 AGI 需要的「规模化试错」。</p>
<p>标杆的意义，在于被超越，更在于指明方向。LingBot-VLA 的发布，或许正是这样一个新方向的开始。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！]]></title>    <link>https://juejin.cn/post/7600245693996974090</link>    <guid>https://juejin.cn/post/7600245693996974090</guid>    <pubDate>2026-01-28T10:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600245693996974090" data-draft-id="7600234310965067814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-28T10:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:42:38.000Z" title="Wed Jan 28 2026 10:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！</h2>
<blockquote>
<p>一句话把 B 站视频合集变成教程网站，这是什么神仙操作 ？MiniMax Agent 的专家功能，值得一试！</p>
<hr/>
<p>万少：华为HDE、鸿蒙极客</p>
<p>个人主页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.zbztb.cn%2F" target="_blank" title="https://blog.zbztb.cn/" ref="nofollow noopener noreferrer">blog.zbztb.cn/</a></p>
<p><strong>2025年参与孵化了20+鸿蒙应用、技术文章300+、鸿蒙知识库用户500+、鸿蒙免费课程2套。</strong></p>
<p>如果你也喜欢交流AI和鸿蒙技术，欢迎扣我。</p>
</blockquote>
<p><strong>MiniMax Agent</strong> 最近上线的「专家 Agents」功能，支持创建包括自定义指令、模型和子代理等。</p>
<p>🔗 官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagent.minimaxi.com%2F" target="_blank" title="https://agent.minimaxi.com/" ref="nofollow noopener noreferrer">agent.minimaxi.com/</a></p>
<p>早上抽空下载体验了下，感觉这个「专家 Agents」功能确实能 <strong>听懂人话</strong> 和 <strong>做些人事</strong>！</p>
<hr/>
<h3 data-id="heading-1">下载安装</h3>
<p>首先下载桌面端的 <strong>MiniMax Agent</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9be8dfe48fcf432aadc5beb2467bf3a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=0m9TIAe1AdeyKYWbQZGJG7MZGwI%3D" alt="图片" loading="lazy"/></p>
<p>下载成功后，直接登录即可。新用户赠送 <strong>1000 积分</strong>，够玩几圈的了！🎁</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4a49ce18414fcfae05da2c77cd3010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=06teT4mJ%2BsOZQkxHWXmSeHN0rx4%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">体验效果</h3>
<p>我主要体验了它的「探索专家」功能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa81c16486043f3892a6ace30788ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=zOvWyJCQJiOq%2FFfjk93YwKc2kzo%3D" alt="图片" loading="lazy"/></p>
<p>你可以使用已有的专家功能，或者自己创建专家。</p>
<hr/>
<p>我创建了一个名为 <strong>《B 站视频合集文档生成专家》</strong> 的专家：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc80548af3247cf80be1a84a3013131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=xVOjBv0MMb6nRGNIvd%2BUiRi2SWM%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-3">提供需求</h4>
<p><strong>给一个 B 站视频链接，自动把视频所在的合集，生成一个 VitePress 的博客网站。</strong></p>
<p>这相当于给你的 B 站视频做了一个系列教程网站。</p>
<p><strong>一句话做一个教程网站，是不是很酷？</strong> 😎</p>
<hr/>
<h4 data-id="heading-4">实际效果</h4>
<p>先看我做到的效果：</p>
<p><strong>开始对话</strong> → 输入 B 站视频链接</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f783a9bef39456dbd3e2d1196e8b88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=ou1QOTVzBqcB3KEopT3mxIA%2Bohk%3D" alt="图片" loading="lazy"/></p>
<p><strong>得到结果</strong> → AI 自动分析并生成</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd171ffb1bb4a609e3de6b3fd97ad8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=2gT30ahHm1gZJEqdDMEvehDXfuM%3D" alt="图片" loading="lazy"/></p>
<p><strong>实际效果</strong> → 打开生成的博客网站</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f9e1f779d543fb8339e8c282824e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=uEFfzBE%2FWaAlZgZSortRhQHxsIE%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>看到了吗？内容完全对应上！</p>
</blockquote>
<hr/>
<p>我还有一个测试效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a5a2735b7b4824ab12bb1732881b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=xO3UZGVFSmXmiw%2FOav42ys9aQ8k%3D" alt="图片" loading="lazy"/></p>
<p>这个能力确实不俗，懂技术的同学应该知道，生成博客网站的过程可不简单！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b825039be354e55bbaaa0e9dbb5cc51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=zRdc8FDdMjx9AAB7VB3Yc6hstbw%3D" alt="图片" loading="lazy"/></p>
<p>这个专家能力确实很强大！</p>
<hr/>
<h3 data-id="heading-5">创建专家</h3>
<p>如果你也有一些想法，想创建自己的专家，这样操作：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df00aab239584e4eaf3796eef2f67563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=2Org8AaX4nauX%2BuSe3o3oNcacjU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f089a11d9e5e4d3283ae792b0b1ada47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201757&amp;x-signature=MXAiig06fXrW1XGibYMT5WhhAIk%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">📝 总结</h3>
<p>整个体验下来，MiniMax Agent 的专家功能确实值得一试！</p>
<p><strong>一句话总结</strong>：AI 真的能听懂你的需求，并且把复杂的事情做得简单。</p>
<p>如果你也想体验，赶紧去试试吧！</p>
<hr/>
<p><strong>互动一下</strong>你用过类似的 AI Agent 吗？欢迎在评论区分享你的体验！</p>
<p><strong>关注我</strong>，持续分享鸿蒙开发 + AI 提效的实战技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手]]></title>    <link>https://juejin.cn/post/7600238071038197769</link>    <guid>https://juejin.cn/post/7600238071038197769</guid>    <pubDate>2026-01-28T10:43:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600238071038197769" data-draft-id="7600224355294199835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T10:43:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:37.000Z" title="Wed Jan 28 2026 10:43:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</h2>
<blockquote>
<p>注意本教程在 Linux 系统下进行</p>
</blockquote>
<p>Clawdbot 由于 Claude 的版权问题，已更名为 Moltbot，因此本教程基于最新版本编写。下面进入安装流程</p>
<p>首先准备一台闲置的云服务器或 VPS（推荐使用香港或海外节点）。由于 Moltbot 运行时权限较大，出于安全考虑，不建议在本地或工作机上安装，推荐在一台独立的空服务器上部署。准备完成后，登录到服务器。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fclawedbot-install" target="_blank" title="https://catchadmin.com/post/2026-01/clawedbot-install" ref="nofollow noopener noreferrer">原文 Clawedbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a></p>
<h3 data-id="heading-1">安装</h3>
<p>第一步安装 Git</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 Git</span>
sudo apt update
sudo apt install git -y
</code></pre>
<p>第二步安装 Node.js</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">安装 NVM</span>
<span class="hljs-meta prompt_"># </span><span class="bash">国内使用 gitee 的镜像源</span>
curl -o- https://gitee.com/RubyMetric/nvm-cn/raw/main/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">国外使用</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
<span class="hljs-meta prompt_">
# </span><span class="bash">重新加载环境变量</span>
source ~/.bashrc
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 Node.js 22</span>
nvm install 22
<span class="hljs-meta prompt_">
# </span><span class="bash">查看 nodejs 版本</span>
node -v # 输出 v22 即可，版本只要 22 就行
</code></pre>
<h3 data-id="heading-2">安装 Moltbot (原 Clawdbot)</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">使用官方脚本安装</span>
curl -fsSL https://molt.bot/install.sh | bash
</code></pre>
<blockquote>
<p>服务器在国内，如果安装失败的话，可能需要解决网络问题</p>
</blockquote>
<p>其他平台安装方式请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.molt.bot%2Finstall%2Finstaller" target="_blank" title="https://docs.molt.bot/install/installer" ref="nofollow noopener noreferrer">Moltbot (原Clawdbot) 安装文档</a></p>
<p>你会看到如下图输出
<img src="https://image.catchadmin.com/202601280801125.png" alt="Clawedbot 安装过程 - AI 助手部署初始化" loading="lazy"/>
如果首次安装，时间会很长，需要耐心等待。
如果最后输出如下内容：</p>
<pre><code class="hljs language-shell" lang="shell">→ npm install failed; cleaning up and retrying...
</code></pre>
<p><code>ctrl+c</code> 退出，重新运行安装脚本然后继续等待下。</p>
<p>成功之后会输出如下图片
<img src="https://image.catchadmin.com/202601281349920.png" alt="Clawedbot 安装成功 - AI 机器人配置向导" loading="lazy"/>
第一个选项选择 <code>yes</code>, 就是询问你是否知道风险的。
第二步选择 <code>QuickStart</code>
<img src="https://image.catchadmin.com/202601281351166.png" alt="Clawedbot QuickStart 快速开始选项" loading="lazy"/>
第三步选择模型服务商，这里选择 <code>Qwen</code>，免费额度充足，适合入门使用
<img src="https://image.catchadmin.com/202601281352080.png" alt="Clawedbot 选择 AI 模型服务商 Qwen 千问" loading="lazy"/>
选择千问模型后，会提供一个链接，复制并在浏览器中打开，如下图
<img src="https://image.catchadmin.com/202601281355542.png" alt="Clawedbot 千问模型授权链接" loading="lazy"/>
打开浏览器后，会看到如下界面。由于我已登录过，所以显示账户信息；如果尚未登录，按照提示完成登录即可。
<img src="https://image.catchadmin.com/202601281356909.png" alt="Clawedbot 千问 AI 账户登录页面" loading="lazy"/>
登录完成后，会出现以下选项，提示选择对应的千问模型，如下图
<img src="https://image.catchadmin.com/202601281358170.png" alt="Clawedbot 选择千问 AI 模型版本" loading="lazy"/>
选择默认模型即可。接下来会提示选择 channel，这里先跳过，后续再添加
<img src="https://image.catchadmin.com/202601281359123.png" alt="Clawedbot channel 渠道配置选项" loading="lazy"/>
继续下面选择 skills，也是选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281359786.png" alt="Clawedbot skills 技能配置选项" loading="lazy"/>
继续下面选择 hooks，也是使用<code>空格</code>选择 <code>No</code>，如下图
<img src="https://image.catchadmin.com/202601281400483.png" alt="Clawedbot hooks 配置选项" loading="lazy"/>
然后等待安装完成，最后会出现以下选项，这里选择 <code>TUI</code>
<img src="https://image.catchadmin.com/202601281403169.png" alt="Clawedbot 选择 TUI 终端界面" loading="lazy"/>
如果看到 TUI 聊天界面，说明安装成功，可以尝试输入 <code>Hello</code> 进行测试。
<img src="https://image.catchadmin.com/202601281404354.png" alt="Clawedbot TUI 聊天界面 - AI 助手对话测试" loading="lazy"/>
然后直接使用 <code>ctrl+c</code> 先关闭，后面我们再来设置</p>
<h4 data-id="heading-3">查看服务</h4>
<p>可以使用下面的命令来查看</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot status
</code></pre>
<p>会看到如下图的结果就说明服务启动了
<img src="https://image.catchadmin.com/202601281449942.png" alt="Clawedbot 服务状态检查 - AI 助手运行中" loading="lazy"/></p>
<h4 data-id="heading-4">访问 Web UI 面板</h4>
<p>如何访问面板？服务监听在 <code>http://127.0.0.1:18789/</code> 端口上，我们现在通过 ssh 隧道来访问，输入下面的命令</p>
<pre><code class="hljs language-shell" lang="shell">ssh -N -L 18789:127.0.0.1:18789 用户名@服务器IP
<span class="hljs-meta prompt_"># </span><span class="bash">回车之后</span>
用户名@服务器IP's password: # 输入密码
</code></pre>
<p>然后在浏览器打开 <code>http://127.0.0.1:18789/</code>, 你会看到 Dashboard 了，如下图
<img src="https://image.catchadmin.com/202601281509102.png" alt="Clawedbot Web UI Dashboard 未授权页面" loading="lazy"/>
图中显示的是未授权状态，回到服务器，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot dashboard
</code></pre>
<p>会看到下面的面板数据
<img src="https://image.catchadmin.com/202601281530336.png" alt="Clawedbot Dashboard URL 获取命令" loading="lazy"/>
复制对应的 <code>Dashboard URL</code> 到浏览器打开，即可正常查看聊天记录。
<img src="https://image.catchadmin.com/202601281532427.png" alt="Clawedbot Web UI 管理面板 - AI 助手聊天记录" loading="lazy"/></p>
<p>至此 Moltbot 已安装完成，可以正常访问了。</p>
<h3 data-id="heading-5">对接飞书</h3>
<p>首先安装飞书插件，输入以下命令</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p>登录飞书开放平台 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%25EF%25BC%258C%25E7%2582%25B9%25E5%2587%25BB%25E3%2580%258C%25E5%25BC%2580%25E5%258F%2591%25E8%2580%2585%25E5%2590%258E%25E5%258F%25B0" target="_blank" title="https://open.feishu.cn%EF%BC%8C%E7%82%B9%E5%87%BB%E3%80%8C%E5%BC%80%E5%8F%91%E8%80%85%E5%90%8E%E5%8F%B0" ref="nofollow noopener noreferrer">open.feishu.cn，点击「开发者后台</a> -&gt; 创建企业自建应用」，如下图
<img src="https://image.catchadmin.com/202601281539117.png" alt="飞书开放平台创建企业自建应用 - Clawedbot 对接" loading="lazy"/>
然后点击创建应用，如下
<img src="https://image.catchadmin.com/202601281743642.png" alt="飞书创建应用 - Clawedbot AI 机器人" loading="lazy"/>
创建完成后，首先到凭据管理中获取 App ID 和 App Secret，注意保存，后续配置需要使用。
<img src="https://image.catchadmin.com/202601281757469.png" alt="飞书 App ID 和 App Secret 凭据管理" loading="lazy"/>
然后添加机器人，如下操作
<img src="https://image.catchadmin.com/202601281758607.png" alt="飞书添加机器人能力 - Clawedbot AI 助手" loading="lazy"/>
首先配置个名字
<img src="https://image.catchadmin.com/202601281758721.png" alt="飞书机器人名称配置 - Clawedbot" loading="lazy"/></p>
<p>飞书的其他配置先暂停，回到服务器配置 Moltbot 的飞书参数</p>
<h4 data-id="heading-6">添加飞书配置</h4>
<pre><code class="hljs language-shell" lang="shell">clawdbot config set channels.feishu.appId "飞书 app id"

clawdbot config set channels.feishu.appSecret "飞书 app secret"

clawdbot config set channels.feishu.enabled true
<span class="hljs-meta prompt_">
# </span><span class="bash">推荐使用 websocket</span>
clawdbot config set channels.feishu.connectionMode websocket

clawdbot config set channels.feishu.dmPolicy pairing

clawdbot config set channels.feishu.groupPolicy allowlist

clawdbot config set channels.feishu.requireMention true
</code></pre>
<p>配置完成之后，重启</p>
<pre><code class="hljs language-shell" lang="shell">clawdbot gateway restart
</code></pre>
<p>重启完成后回到飞书，找到「事件和回调」，选择长连接模式，如下图
<img src="https://image.catchadmin.com/202601281802128.png" alt="飞书事件和回调配置 - Clawedbot 长连接模式" loading="lazy"/>
如果配置成功，说明连接已建立。继续下面的配置，添加事件，选择「接收消息」事件
<img src="https://image.catchadmin.com/202601281811231.png" alt="飞书添加接收消息事件 - Clawedbot AI 助手" loading="lazy"/>
事件添加完成之后，还需要开通权限，有以下权限全部勾选</p>




















<table><thead><tr><th>权限</th><th>Scope（范围）</th><th>Description（说明）</th></tr></thead><tbody><tr><td>contact:user.base:readonly</td><td>用户信息</td><td>获取基础用户信息</td></tr><tr><td>im:message</td><td>消息 全部勾选</td><td>发送和接收消息</td></tr></tbody></table>
<p>如下图
<img src="https://image.catchadmin.com/202601281545906.png" alt="飞书权限配置 - Clawedbot 用户信息权限" loading="lazy"/></p>
<p><img src="https://image.catchadmin.com/202601281549559.png" alt="飞书消息权限配置 - Clawedbot AI 机器人" loading="lazy"/></p>
<p>以上步骤全部完成后，即可与机器人对话。但在此之前需要先创建一个版本
<img src="https://image.catchadmin.com/202601281814848.png" alt="飞书应用版本发布 - Clawedbot AI 助手上线" loading="lazy"/></p>
<blockquote>
<p>注意：每次修改配置后都需要重新发布版本，建议全部配置完成后再统一发布。</p>
</blockquote>
<p>发布完成后，回到飞书客户端，可以看到应用已上线，点击打开应用
<img src="https://image.catchadmin.com/202601281816608.png" alt="飞书应用发布成功 - Clawedbot AI 机器人" loading="lazy"/>
向机器人发送 <code>Hello</code>，即可收到 Moltbot 的回复
<img src="https://image.catchadmin.com/202601281817700.png" alt="飞书 Clawedbot AI 助手回复测试成功" loading="lazy"/></p>
<p>由于流程较长，如有勘误，还请指正</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架]]></title>    <link>https://juejin.cn/post/7600068892988866570</link>    <guid>https://juejin.cn/post/7600068892988866570</guid>    <pubDate>2026-01-28T10:43:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988866570" data-draft-id="7600234310965051430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-28T10:43:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:58.000Z" title="Wed Jan 28 2026 10:43:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商推荐系统中，推荐模型长期面临着两个核心矛盾：一方面，传统的多阶段级联推荐系统存在目标不一致和误差累积的问题；另一方面，直接引入大型语言模型LLM虽然能带来强大的推理能力，但其高昂的延迟和计算成本在工业级应用中难以承受。更重要的是，现有的生成式推荐方法在多场景扩展性上面临巨大瓶颈--每个场景都需要独立训练和部署，导致资源利用率低下、维护成本高昂。</p>
<p>京东零售OxygenREC团队在论文《OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation》中提出了一种全新的解决方案：OxygenREC。这是一个基于“快慢思考”的指令跟随生成式推荐框架，不仅解决了推理能力与延迟之间的矛盾，更实现了“一次训练，多处部署”的多场景统一高效解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df8c0078784d2cbbe21c6175c19f8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=two5r0QHfN4%2FFUGKXeu2hm4CgCA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、关键挑战</h2>
<p>OxygenREC 旨在解决当前推荐系统，特别是生成式推荐范式下的三大核心难题：</p>
<p>1.有限的演绎推理能力：现有的生成式推荐方法主要从用户海量行为中进行归纳学习，但在需要结合现实世界知识进行深度演绎推理的场景下表现不佳。比如下边两个例子：</p>
<p>当推荐的时空背景和用户画像是“成都冬至时的年轻宝妈”时，传统模型可能只是推荐“冬季外套”这样的商品，而无法深度推理出此时成都是“冷湿环境”，这位年轻母亲潜在的需求可能是“婴儿排汗睡衣”。</p>
<p>有个户外运动vlogger在购物行为中反复对比华为Mate 70和iPhone 16 Pro两款手机，传统系统因为用户频繁的交互历史，只会不断加强重复推荐这两款商品进行比价，而无法推理出其真正诉求可能是“高质量的移动影像”，从而模型未能精准推荐‘华为Pura’系列这一真正符合用户诉求的目标商品。</p>
<p>2.多场景适应与资源效率的矛盾：大部分推荐平台拥有首页、频道流、购物车、搜索等多种推荐场景。现有生成式推荐模型如果为每个场景训练独立模型，会带来巨大的运营和计算成本，而使用简单的统一模型又会面临“负迁移”问题--不同场景间的知识相互干扰，导致性能下降。</p>
<p>3.工业级部署的工程挑战：将LLM的深度推理能力与推荐系统的大规模稀疏特征、严格延迟要求相结合，是一个巨大的系统工程挑战。它需要同时处理推荐系统典型的TB级稀疏嵌入和LLM典型的十亿级稠密参数，这对训练框架和推理引擎都提出了极高要求。</p>
<h2 data-id="heading-1">二、核心贡献</h2>
<p>面对这些挑战，京东零售OxygenREC团队提出了一个基于指令跟随的生成式推荐框架-OxygenREC，首次把LLM中的“快慢思考”模式引入到生成式推荐中来。在OxygenREC框架中，通过基于Transformer 的Encoder-Decoder 作为骨干网络，能够根据特定指令生成语义化物品序列，来执行推荐场景的”快思考"方式。在“慢思考”模式中，引入上下文推理指令--由近线LLM pipeline 生成，将用户行为与上下文合成为可解释的指令。同时多场景对齐中，通过场景指令与基于强化学习的对齐机制，实现“一次训练，多场景部署”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa6943c39aa3452a9461937c41dd99dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=LmqwDZ2L1J1VK%2Bt5K2HP7NHVzh0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">1. “快慢思考”架构：知识注入与低延迟的平衡</h4>
<p>这是整个OxygenREC的基础，其核心思想是将复杂的推理过程“离线化”，保证在线服务的低延迟。</p>
<p>慢思考：一个近线的LLM pipeline，综合分析用户的时空上下文、个性化特征和历史行为，生成高质量的“上下文推理指令”。这个过程融合了世界知识，能进行深度演绎推理，但因其是近线批量处理，不增加在线请求的延迟。</p>
<p>快思考：一个高效的编码器-解码器骨干网络。它接收“慢思考”生成的指令，结合实时用户信号，在严格的延迟限制下生成推荐序列。该骨干网络本身轻量、高效，专为实时推理优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52361b6fcf74385b289ca2312ddf96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=bA49vQ0BcffsL8hXQ0E7YjbIW3c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 语义对齐的指令控制机制：让指令真正发挥作用</h4>
<p>仅仅生成指令是不够的，还必须确保模型能够准确理解并遵循指令。OxygenREC通过两项关键技术实现精准指令控制：</p>
<p>查询到物品的对齐损失：在训练阶段，通过一个辅助的Query-to-Item (Q2I) 损失函数，将指令嵌入与目标物品嵌入在同一个语义空间中对齐。这使得指令能够“理解”物品，并用于检索：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456be53a34c64881b332f3ca1234ea54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=EgBT2a2bhxSYsCifMziQZyH8olM%3D" alt="image.png" loading="lazy"/></p>
<p>指令引导检索(IGR)：在生成推荐时，利用对齐后的指令作为查询，从用户长期历史行为中检索出最相关的部分，过滤掉无关的噪声。这确保了模型生成时专注在与当前指令意图最相关的历史信息上，大大提升了可控性和准确性。</p>
<h4 data-id="heading-4">3. 基于指令与强化学习的多场景统一对齐：Train-Once-Deploy-Everywhere</h4>
<p>这是解决多场景扩展性的关键。OxygenREC摒弃了为每个场景独立建模的思路。</p>
<p>场景指令化：将不同的场景信息（如首页、购物车）和可选的触发物品（如用户点击的入口商品）统一编码为“场景指令”，作为模型的条件输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab5da81d461544c99f265ffc6ade2b3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=VslxIpTc5Wu94KlcDUmKJ6yaJPo%3D" alt="image.png" loading="lazy"/></p>
<p>统一奖励映射与策略优化：设计了一个统一的奖励映射服务，将不同场景、不同业务目标（如GMV，转化率，合法性，多样性）的奖励信号归一化。在此基础上，提出了Soft Adaptive Group Clip Policy Optimization (SA-GCPO)算法进行强化学习训练:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/691bbb2d3c5a41c2852e5fbb621b3974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=yY6qltu7fFGDbHF4fNPqt0K11xA%3D" alt="image.png" loading="lazy"/></p>
<p>该算法用自适应门控函数替代传统基于GRPO的硬截断方式(hard clip):</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7861e3ae0a14bb1a39f295b3d2a84db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2Fs27rs%2FTM4r9PTCMj%2Fp7qedGfwI%3D" alt="image.png" loading="lazy"/></p>
<p>并以基于用户真实反馈的奖励分数作为阈值区分正负advantage样本，显著提升了多任务、多场景下策略学习的稳定性和效率：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6df5ad12294ba9a15a4f7cea575b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2BSaOUEO6bJ44eb9RFxAu8lQvGoI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">4. 大规模生产级系统实现</h4>
<p>为了支撑以上创新，团队构建了完整的工程体系：</p>
<p>统一训练框架：基于PyTorch，深度融合了工业级稀疏嵌入引擎和LLM稠密训练引擎，在128张H800 GPU集群上实现了40%的模型FLOPs利用率。﻿</p>
<p>高性能推理引擎xLLM：针对生成式推荐长上下文、大候选集的特点，定制开发了xLLM推理框架，通过xSchedule（系统调度）、xAttention（算子优化）、xBeam（束搜索优化）三级优化，满足线上严格的服务级别目标。</p>
<p>近线指令服务：推理指令通过近线服务批量生成并存入KV数据库，线上推荐模型直接读取，实现了零在线LLM调用，兼顾了语义丰富性和低延迟。</p>
<h2 data-id="heading-6">三、实验成果</h2>
<p>OxygenREC在京东几个核心场景的大量离线实验和在线A/B测试中取得了显著效果，证明OxygenREC 基于生成式推荐的方法在大规模工业级推荐系统中的有效性。</p>
<h4 data-id="heading-7">1. 基于快慢思考的生成式框架有效性验证</h4>
<p>语义ID：通过多源对比学习（文本、图像、行为关联）构建的层次化语义ID，在保持高类别纯度（92.8%）的同时，实现了极低的ID碰撞，证明了其强大的表达和区分能力。</p>
<p>指令跟随：消融实验证明，在BOS右侧插入指令的方式为最佳；融合了场景ID和触发物品ID的指令效果显著优于单一组件；IGR和Q2I对齐机制共同作用带来了显著的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9dd59be950429da8a3a310fee5dd44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=k7XxVwhntSYUlnbyqc2KEKNeAp0%3D" alt="image.png" loading="lazy"/></p>
<p>统一模型 vs. 独立模型：在六个核心场景的对比中，统一的OxygenREC模型全面超越了为每个场景独立微调的基线模型，验证了OxygenREC框架在场景间正向迁移的有效性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b1466804884746b3ad44efb6446e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=5U4ZnhK%2BL0RXvSOAoBNetYjdpys%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">2. 基于SA-GCPO后训练的有效性验证</h4>
<p>在后续训练阶段，提出的SA-GCPO算法在合成数据比例变化时表现更稳定，且性能显著优于传统的GRPO及其变体GSPO。例如，在33%合成数据比例下，SA-GCPO在HR@1和HR@10上有显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0087405b804745ceb529b71b5855817f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=08vEU0crdzoLzVVmQvE5fvAen60%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">3. 电商场景在线A/B测试的商业效果</h4>
<p>OxygenREC已在京东App上形成覆盖用户购物全链路的部署闭环：首页导流（场景1、2）-&gt; 频道浏览（场景3、4）-&gt; 商品结算转化（场景5、6）。在线测试结果表明，该模型在所有关键业务指标上均带来显著提升：</p>
<p>首页场景：GMV提升4.52%-8.40%。</p>
<p>频道流场景：其中一个场景的订单量提升了8.03%，显示出模型精准匹配购买意图的能力。</p>
<p>结算路径场景：在用户强购买意图下，GMV提升高达11.80%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d67fbbf584e49edbe176cf9f1fc028f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=23bAzHEgiBYmFlb9avNIhDNPaPE%3D" alt="image.png" loading="lazy"/></p>
<p>与行业上其他生成式推荐方式对比:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/582dc6a123c741c381fd9891479fc4fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=oGNN%2BnJdtBnYTm1V4W1iZ9rLWnM%3D" alt="image.png" loading="lazy"/></p>
<p>OxygenREC 在几个关键维度上进行了生成式推荐的范式革新：</p>
<p>架构上，用“快慢思考”破解了推理与延迟的死结。</p>
<p>效率上，用“统一指令模型”破解了多场景训练的困局。</p>
<p>控制上，用“语义对齐与引导检索”构建了生成式推荐模型的指令跟随能力。</p>
<p>优化上，用“SA-GCPO”和全栈系统优化，确保了技术在工业巨量流量下的可行性、稳定性和卓越性能。</p>
<h2 data-id="heading-10">四、总结与展望</h2>
<p>OxygenREC的成功，标志着生成式推荐在工业落地上迈出了关键一步。它通过“快慢思考”巧妙平衡了深度推理与低延迟，通过“指令跟随”实现了对推荐过程的精准可控，并通过统一的奖励与策略学习破解了多场景扩展的难题，真正实现了“一次训练，多场景部署”的pipeline。</p>
<p>未来，京东零售OxygenREC团队计划从两个方向继续探索：</p>
<p>一是向基于语言扩散模型的非自回归生成范式演进，从根本上突破序列生成延迟与列表长度的线性关系，满足更高吞吐需求；</p>
<p>二是开展跨场景用户轨迹建模，从用户在首页、搜索、购物车、结算等多场景的连贯行为中挖掘更深层的用户意图，实现更长周期的价值推荐。</p>
<p>OxygenREC不仅是一个高效的推荐系统，更为工业级生成式AI应用的大模型设计提供了宝贵范式--如何将大模型的“脑”与小模型的“身手”结合，如何在复杂多目标任务中实现稳定高效的学习，这其中的思想值得广泛借鉴。</p>
<p>论文原文：OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation</p>
<p>训练框架： Oxygen 9N-LLM生成式推荐训练</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案]]></title>    <link>https://juejin.cn/post/7600223321041518598</link>    <guid>https://juejin.cn/post/7600223321041518598</guid>    <pubDate>2026-01-28T10:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041518598" data-draft-id="7600240045366247478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-28T10:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            断网、断电，不断数据——LoongCollector 极限边缘场景可靠采集方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:54:15.000Z" title="Wed Jan 28 2026 10:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：林润骑(太业)</p>
<h2 data-id="heading-0">背景</h2>
<p>在云计算和物联网快速发展的今天，越来越多的业务场景将计算和数据采集能力推向了边缘侧。从智能制造的产线设备、新能源汽车的车载系统，到遍布各地的零售终端和智能家居设备，这些终端设备产生的可观测数据（日志、指标、追踪）对于业务运营、故障诊断和用户体验优化至关重要。</p>
<p>然而，终端设备的环境极其复杂：</p>
<ul>
<li><strong>网络环境不稳定</strong>：终端设备常常运行在弱网、间歇性断网的环境中。移动网络信号波动、WiFi连接不稳定、跨地域网络延迟高等问题普遍存在。</li>
<li><strong>电源供应不保障</strong>：许多终端设备依赖电池供电或面临意外断电风险。</li>
<li><strong>资源极度受限</strong>：边缘设备的 CPU、内存、存储、网络带宽都极为有限。</li>
</ul>
<p>在这种极限条件下的可观测数据采集面临极大的挑战。比如车辆在偏远地区行驶时，长时间处于弱网或断网状态，网络信号时断时续，车辆熄火断电时，内存中缓存的监控数据全部丢失；在隧道、地下停车场等场景下，数据采集中断，关键的故障诊断数据无法回传。</p>
<p>本文将详细介绍 LoongCollector 如何针对弱网、断电等边缘场景，提供完整的可靠采集解决方案。</p>
<h2 data-id="heading-1">终端设备可观测数据采集的三大挑战</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4500185babb649c89df8e0336a3a3035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=zQazKPmFk4R2M5Gew%2BXnZoT16tM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">挑战一：复杂的网络环境</h3>
<p>终端设备运行环境的网络条件远比数据中心复杂：</p>
<ul>
<li><strong>弱网场景</strong>：移动网络信号不稳定、WiFi 信号弱、跨地域长链路等导致网络带宽低、延迟高、丢包率高。</li>
<li><strong>间歇性断网</strong>：设备移动、网络切换、临时性网络故障导致周期性网络中断。</li>
<li><strong>长时间离线</strong>：某些场景下设备需要长时间离线工作，积累大量待上传数据。</li>
</ul>
<p>比如车载终端设备在偏远地区运输途中，可能很长时间都处于弱网或断网状态，网络正常的状态很少；在车辆熄火或者维修的情况下，车载终端设备也会断电。</p>
<h3 data-id="heading-3">挑战二：可观测数据可靠交付</h3>
<p>在弱网、断电等不稳定环境下，保证数据的可靠交付和一致性是最大的挑战：</p>
<ul>
<li><strong>数据丢失风险</strong>：网络中断、设备断电、进程异常等都可能导致数据丢失。</li>
<li><strong>顺序性保障</strong>：时序数据（如指标、追踪）需要保持采集时的时间顺序。</li>
</ul>
<h3 data-id="heading-4">挑战三：网络带宽限制</h3>
<p>终端设备的网络带宽通常受到严格限制：</p>
<ul>
<li><strong>流量成本高</strong>：4G/5G 移动网络的流量费用远高于数据中心专线。</li>
<li><strong>带宽竞争</strong>：采集数据上传需要与业务数据传输竞争有限的带宽资源。</li>
<li><strong>上传速率限制</strong>：某些运营商或网络环境会对上传带宽进行限制。</li>
</ul>
<p>在这样的环境下，如何高效压缩数据、智能控制发送速率、避免带宽被采集流量占满，成为必须解决的问题。</p>
<h2 data-id="heading-5">LoongCollector：为边缘场景优化的可靠采集方案</h2>
<p>LoongCollector 是阿里云开源的高性能、高可靠可观测性数据采集器，在支撑阿里云内部千万级规模部署的同时，针对边缘场景进行了深度优化。</p>
<h3 data-id="heading-6">核心能力概览</h3>
<h4 data-id="heading-7">统一的可观测数据采集</h4>
<p>LoongCollector 提供了完整的可观测数据采集能力：</p>
<ul>
<li><strong>主机监控</strong>：实时采集 CPU、内存、磁盘、网络等系统指标，支持 100+ 系统指标项。</li>
<li><strong>Prometheus 协议</strong>：完全兼容 Prometheus 生态，可采集所有支持 Prometheus 采集的应用指标。</li>
<li><strong>日志采集</strong>：高效的文本日志采集能力，支持多种日志格式和解析方式。</li>
</ul>
<h4 data-id="heading-8">超低资源消耗</h4>
<p>针对资源受限的终端设备，LoongCollector 进行了极致的性能优化：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16a01dd3d2e54aca970f628f2af1b88a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=0fGEug5a4OYWgzUNYE10L8uvW3M%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9103fa522cf346928a97517877e24750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=oTLfxB1X3y0UOhV%2BlbPPLfQVwMo%3D" alt="图片" loading="lazy"/></p>
<p>这意味着在相同的硬件条件下，LoongCollector 可以支持更多的采集任务，或者在资源更受限的设备上稳定运行。</p>
<h4 data-id="heading-9">企业级稳定性保障</h4>
<ul>
<li><strong>生产级验证</strong>：支撑阿里云内部 1000 万+ 实例的可观测数据采集。</li>
<li><strong>高可用性</strong>：单实例高可用性，支持故障自恢复。</li>
<li><strong>久经考验</strong>：经历多年双11大促、突发流量等极端场景验证。</li>
</ul>
<h4 data-id="heading-10">解决方案架构：数据持久化 + 异步发送 + 智能重试</h4>
<p>针对弱网、断电、断网等边缘场景，LoongCollector 采用了“数据持久化 + 异步发送 + 智能重试”的核心架构设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24cbf89967834e54ad87b213785299dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=JpPdtpyccKtfy62dw7AznR%2FRXgU%3D" alt="图片" loading="lazy"/></p>
<p><strong>分离采集与发送</strong>：将数据采集和网络发送完全解耦，采集过程不受网络状态影响。</p>
<p><strong>本地持久化</strong>：日志数据天然具备本地持久化的能力。此处主要指指标等无持久化能力的数据，此方案会将所有采集到的指标，先写入本地文件，确保断电、重启也不丢失。</p>
<p><strong>异步消费</strong>：独立的发送线程从持久化文件中读取数据并发送，失败时自动重试。</p>
<p><strong>智能反压</strong>：网络异常时，自动控制数据读取速度，避免内存占用过高。</p>
<h4 data-id="heading-11">指标数据落盘持久化</h4>
<p>传统的指标采集方案（如 Telegraf、Prometheus Pushgateway）通常将采集到的指标数据直接发送到服务端。这种架构在稳定网络环境下工作良好，但在边缘场景下存在致命缺陷：</p>
<ul>
<li><strong>断网丢数据</strong>：网络中断时，新采集的指标数据无法发送，只能丢弃或缓存在内存中。</li>
<li><strong>断电丢数据</strong>：设备意外断电时，内存中缓存的数据全部丢失。</li>
<li><strong>内存压力大</strong>：长时间断网时，内存缓存会迅速膨胀，最终导致 OOM。</li>
</ul>
<p>LoongCollector 创新性地将主机监控指标和 Prometheus 指标进行本地文件持久化，实现了指标数据的可靠存储：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f45664199264cfbab2e63dbae3b6d60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=x0%2FCwDhsKmQVNplKfoFkw7GJpQY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>定时抓取主机和应用指标数据。</li>
<li>文本格式落盘到本地文件系统。</li>
<li>自动轮转机制，支持单文件大小和文件个数配置，保留最近固定格式的文件，自动删除过期文件，避免磁盘空间被历史数据占满。</li>
</ul>
<h4 data-id="heading-12">文件采集异步消费机制</h4>
<p>在持久化指标数据后，如何高效、可靠地将数据发送到服务端是下一个关键问题。传统方案面临的挑战包括：</p>
<ul>
<li><strong>发送阻塞采集</strong>：如果发送线程与采集线程耦合，网络慢会拖慢采集速度。</li>
<li><strong>顺序性保证</strong>：指标数据通常有时间顺序要求，需要确保按采集时间顺序发送。</li>
<li><strong>断点续传</strong>：网络恢复后，需要从断开位置继续发送，不能重复或遗漏。</li>
</ul>
<p>LoongCollector 采用了文件采集的方式来异步消费持久化的指标数据，<strong>关键技术点</strong>如下：</p>
<ul>
<li>Checkpoint 机制：LoongCollector 维护了细粒度的 checkpoint，记录每个文件的读取位置，这确保了即使在文件读取过程中进程崩溃或断电，重启后也能从断开位置继续读取，不会丢失数据。</li>
<li>文件顺序保证：通过文件轮转顺序，确保按采集时间顺序发送数据：
<ul>
<li>优先处理时间早的文件</li>
<li>同一时间段的文件按序号递增处理</li>
<li>支持使用原始数据中的时间，避免时间戳乱序导致的数据可视化问题</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">智能反压与流量控制</h4>
<p>在弱网环境下，如果不加控制地读取和发送数据，会导致：</p>
<ul>
<li><strong>内存占用激增</strong>：读取速度远大于发送速度，数据堆积在内存中。</li>
<li><strong>发送队列溢出</strong>：队列满后数据被丢弃或进程崩溃。</li>
<li><strong>带宽占满</strong>：采集流量占满带宽，影响业务正常通信。</li>
</ul>
<p>LoongCollector 实现了多层次的<strong>智能反压机制</strong>：</p>
<p>发送并发度自适应：借鉴 TCP 拥塞控制算法，LoongCollector 根据网络状态动态调整发送并发度，这种自适应机制确保了：</p>
<ul>
<li><strong>快速响应</strong>：网络正常时充分利用带宽，快速发送数据。</li>
<li><strong>快速收敛</strong>：网络异常时迅速降低发送频率，避免无效重试。</li>
<li><strong>自动恢复</strong>：网络恢复后自动增加并发，无需人工干预。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c61d8a6ba6f40479fded8125fce62a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=oElLrHvNGqRuTf%2BZGfPQ%2FSS7EyE%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>队列反压</strong>：当发送队列积压达到阈值时，LoongCollector 会暂停文件读取，这避免了内存无限制增长，确保系统在长时间弱网环境下也能稳定运行。</li>
<li><strong>流量限速</strong>：LoongCollector 支持配置最大发送速率，避免采集流量影响业务 ilogtail_config.json：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">{
  <span class="hljs-string">"max_bytes_per_sec"</span>: 1048576 <span class="hljs-comment"># 限制最大发送速率为 10MB/s</span>
}
</code></pre>
<h2 data-id="heading-14">LoongCollector 终端部署最佳实践</h2>
<p>这里以主机监控+一个应用的 Prometheus 采集为例。</p>
<h3 data-id="heading-15">LoongCollector 启动参数建议</h3>
<p>在 <code>/usr/local/ilogtail</code> 目录下修改 <code>ilogtail_config.json</code>。</p>
<p>a. 关闭丢弃旧数据 discard_old_data。</p>
<p>b. 调大与服务端断开连接重启的间隔 config_server_lost_connection_timeout，建议取 604800 秒，7 天。</p>
<p>c. 调大读取阻塞重启的间隔 force_quit_read_timeout，建议取 604800 秒，7 天。</p>
<p>d. 限制最大发送速率 max_bytes_per_sec。主机监控+一个 Java 应用的流量为 0.88KB/s，所以建议取 1MB/s，避免异常使用流量。</p>
<p>e. "working_ip", 在移动终端场景，IP 会不断变化，在机器上建议给固定 IP。</p>
<p><strong>ilogtail_config.json</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"discard_old_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config_server_lost_connection_timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"force_quit_read_timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">604800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"max_bytes_per_sec"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cpu_usage_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mem_usage_limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">384</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"working_ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">采集配置</h3>
<h4 data-id="heading-17">本地配置-主机监控采集配置</h4>
<p>在 /etc/ilogtail/config/local 目录下创建例如 input_host_monitor.yaml 文件，将主机指标首先采集到本地文件路径下，例如 /usr/local/ilogtail/metrics/host.log。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">enable:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">inputs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">input_host_monitor</span>
    <span class="hljs-attr">Interval:</span> <span class="hljs-number">15</span>
<span class="hljs-attr">flushers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">flusher_file</span>
    <span class="hljs-attr">MaxFileSize:</span> <span class="hljs-number">104857600</span>
    <span class="hljs-attr">MaxFiles:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">FilePath:</span> <span class="hljs-string">/usr/local/ilogtail/metrics/host.log</span>
</code></pre>
<h4 data-id="heading-18">本地配置-自定义指标采集配置</h4>
<p>在 /etc/ilogtail/config/local 目录下创建例如 input_prometheus.yaml 文件，将主机指标首先采集到本地文件路径下，例如 /usr/local/ilogtail/metrics/metric.log。</p>
<p>input_prometheus.yaml</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">enable:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">inputs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">input_prometheus</span>
    <span class="hljs-attr">ScrapeConfig:</span>
      <span class="hljs-attr">job_name:</span> <span class="hljs-string">node</span>
      <span class="hljs-string">host_only_mode:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
      <span class="hljs-attr">scrape_timeout:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">"localhost:12345"</span>]
<span class="hljs-attr">flushers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Type:</span> <span class="hljs-string">flusher_file</span>
    <span class="hljs-attr">MaxFileSize:</span> <span class="hljs-number">524288000</span>
    <span class="hljs-attr">MaxFiles:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">FilePath:</span> <span class="hljs-string">/usr/local/ilogtail/metrics/metric.log</span>
</code></pre>
<h4 data-id="heading-19">服务端管控配置-文件采集配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"aggregators"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"global"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"logSample"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"input_file"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"FilePaths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"/usr/local/ilogtail/metrics/*.log"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"MaxDirSearchDepth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"FileEncoding"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"utf8"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"EnableContainerDiscovery"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"processors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processor_parse_json_native"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"SourceKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"content"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"KeepingSourceWhenParseFail"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-20">注意事项</h3>
<ol>
<li>
<p>处理插件不要使用拓展插件，因为拓展插件会拉起 Golang 模块，导致内存占用升高。</p>
</li>
<li>
<p>移动终端场景，IP 会不断变化，机器组建议使用标识型机器组。</p>
</li>
</ol>
<h3 data-id="heading-21">LoongCollector 资源监控测试报告</h3>
<h4 data-id="heading-22">CPU：平均 0.02 核，峰值 0.028 核</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fd6dfb56ac54768ab916d4aebc6e0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=Lx3Mym79JCgwPRqwnoTIz5%2FKIWQ%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-23">内存：平均 31.5MB，峰值 35MB</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9830b54760584a12b994a6c72772a7e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=Q%2B9ZBMr%2F4t%2BYsFQCWfinHXk3WKA%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-24">网络：平均 1.07KB/s，峰值 1.10KB/s</h4>
<p>a. 压缩前：平均 12.99KB/s，峰值 13.13KB/s</p>
<p>b. 实际发送：平均 1.07KB/s，峰值 1.10KB/s</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d6fda1425243cfb68fea39c7ca1145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=vdAiMSfiaL8x3fkrH3GkGFQ1pcg%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-25">磁盘：平均 6.07KB/s，峰值 13.03KB/s</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42de10e48e164f249baa780d3f073431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770202455&amp;x-signature=8LS0dLHb9Xk4rmtcZvFmMtx5fY4%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-26">总结与展望</h2>
<p>边缘场景的可观测数据采集，是一个长期被低估的技术挑战。网络的不稳定性、电源的不可靠性、数据一致性的复杂性，让传统的采集方案在边缘环境下频繁失效。LoongCollector 通过“数据持久化 + 异步发送 + 智能重试”的创新架构，系统性地解决了这些问题：</p>
<ul>
<li>
<p>保证了可观测数据可靠交付</p>
<ul>
<li>本地持久化保证断网不丢数据</li>
<li>异步发送机制实现采集与发送解耦</li>
<li>智能重试和反压确保网络恢复后数据完整上传</li>
</ul>
</li>
<li>
<p>有效地进行了流量控制</p>
<ul>
<li>高效压缩减少传输数据量</li>
<li>智能流量控制避免带宽占满，影响业务</li>
</ul>
</li>
</ul>
<p>但是，LoongCollector 的采集方案还有更多的优化空间：</p>
<ol>
<li>
<p>当前的持久化采集方案需要配置两个 Pipeline（采集 Pipeline + 文件读取 Pipeline），虽然灵活但增加了用户的理解和配置成本。LoongCollector 正在进行流水线优化，支持单流水线内部持久化能力，方便用户配置。</p>
</li>
<li>
<p>终端设备对于 STS 鉴权是强需求，LoongCollector 正在适配阿里云 STS 动态鉴权，支持临时凭证自动刷新，避免终端 AccessKey 泄露风险。</p>
</li>
<li>
<p>在流量成本敏感的场景，每一个百分点的压缩率提升都意味着显著的成本节省，LoongCollector 也正在探索更加极致的压缩策略，进一步降低网络流量。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[热更新中的HMR和React Fast Refresh]]></title>    <link>https://juejin.cn/post/7600032104248606783</link>    <guid>https://juejin.cn/post/7600032104248606783</guid>    <pubDate>2026-01-28T09:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248606783" data-draft-id="7600032104248393791" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="热更新中的HMR和React Fast Refresh"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-28T09:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ximimimi"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174040238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            热更新中的HMR和React Fast Refresh
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174040238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ximimimi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:19:42.000Z" title="Wed Jan 28 2026 09:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HRM</h2>
<p>是一个通用概念，由构建工具（如webpack、vite)提供，允许在不刷新页面的情况下替换、添加、删除模块</p>
<h2 data-id="heading-1">React Fast Refresh</h2>
<p>专门为HMR开发的特定实现，集成了react渲染引擎，确保在代码更新时能保持组件状态，
它和传统HRM相比，可以保持组件状态，容错性强，当代码中写了错误，Fast Refresh会显示错误弹窗，修复错误后能自动恢复并继续运行，无需手动刷新页面</p>
<ul>
<li>对于保持页面状态这个点，有时候可能会出现页面修改了，但是网页上没有变化</li>
</ul>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>([])
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DATA</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>, <span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'xxx'</span>)
        <span class="hljs-title function_">setData</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">DATA</span>.<span class="hljs-title function_">map</span>(item)=&gt; {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: item, <span class="hljs-attr">content</span>: res[item]}
            }
        })
    }
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">getData</span>()
    },[])
 <span class="hljs-comment">// 在这个页面中修改DATA数据，网页状态也不会发生变化，因为要保持data这个useState状态不变</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码]]></title>    <link>https://juejin.cn/post/7600242248860631080</link>    <guid>https://juejin.cn/post/7600242248860631080</guid>    <pubDate>2026-01-28T09:15:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248860631080" data-draft-id="7600216277426176034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码"/> <meta itemprop="keywords" content="大数据,开源,数据库"/> <meta itemprop="datePublished" content="2026-01-28T09:15:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白鲸开源"/> <meta itemprop="url" content="https://juejin.cn/user/3870725052049454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            保姆级 SeaTunnel 入门！再学不会小编当场表演倒立敲代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3870725052049454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白鲸开源
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:15:52.000Z" title="Wed Jan 28 2026 09:15:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://openwrite-whaleops.oss-cn-zhangjiakou.aliyuncs.com/2026/01/27/seatunnel-xin-shou.png" alt="SeaTunnel 新手" loading="lazy"/></p>
<p>欢迎来到 Apache SeaTunnel 的世界！这份文档旨在帮助新手快速了解 SeaTunnel 的核心功能、基本架构，并完成第一个数据同步任务。</p>
<h2 data-id="heading-0">1. 什么是 Apache SeaTunnel？</h2>
<p>Apache SeaTunnel 是一个非常易于使用、高性能、支持实时流式和离线批处理的海量数据集成平台。它的目标是解决常见的数据集成问题，如数据源多样性、同步场景复杂性以及资源消耗高的问题。</p>
<h3 data-id="heading-1">核心特性</h3>
<ul>
<li><strong>丰富的数据源支持</strong>：支持 100+ 种 Connector，涵盖主流数据库、云存储、SaaS 服务等。</li>
<li><strong>批流一体</strong>：同一套 Connector 代码同时支持批处理（离线）和流处理（实时）。</li>
<li><strong>高性能</strong>：支持多引擎（Zeta, Flink, Spark），提供高吞吐、低延迟的数据同步能力。</li>
<li><strong>简单易用</strong>：通过简单的配置文件（Config）即可定义复杂的数据同步任务。</li>
</ul>
<h2 data-id="heading-2">2. 架构与环境</h2>
<h3 data-id="heading-3">2.1 架构图</h3>
<p>SeaTunnel 采用了解耦的设计架构，Source、Transform、Sink 插件与具体的执行引擎（Engine）是分离的。</p>
<p><img src="https://openwrite-whaleops.oss-cn-zhangjiakou.aliyuncs.com/2026/01/27/st-architecture.png" alt="ST architecture" loading="lazy"/></p>
<h3 data-id="heading-4">2.2 操作系统支持</h3>
<p>SeaTunnel 基于 Java 开发，理论上支持所有安装了 JDK 的操作系统。</p>




















<table><thead><tr><th align="left">操作系统</th><th align="left">适用场景</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>Linux</strong> (CentOS, Ubuntu, etc.)</td><td align="left"><strong>生产环境</strong> (推荐)</td><td align="left">稳定性高，适合长期运行服务。</td></tr><tr><td align="left"><strong>macOS</strong></td><td align="left">开发/测试</td><td align="left">适合开发者本地调试和编写 Config。</td></tr></tbody></table>
<h3 data-id="heading-5">2.3 环境准备</h3>
<p>在开始安装 SeaTunnel 之前，请确保你的环境满足以下要求：</p>
<ul>
<li><strong>JDK 版本</strong>：必须安装 <strong>Java 8</strong> 或 <strong>Java 11</strong>。
<ul>
<li>可以通过命令 <code>java -version</code> 检查。</li>
<li>确保设置了 <code>JAVA_HOME</code> 环境变量。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-6">3. 核心组件深度解析</h2>
<p>在使用 SeaTunnel 之前，深入理解其核心组件的内部机制有助于你更好地调优和排查问题。</p>
<h3 data-id="heading-7">3.1 Source (数据源)</h3>
<p>Source 负责从外部系统读取数据，并将其转换为 SeaTunnel 内部的行格式（SeaTunnelRow）。</p>
<ul>
<li><strong>Enumerator (枚举器)</strong>：运行在 Master 节点（Coordinator）。负责发现数据分片（Splits）。例如，在 JDBC Source 中，Enumerator 会根据 <code>partition_column</code> 的最大值和最小值计算出多个查询范围（Splits）。</li>
<li><strong>Reader (读取器)</strong>：运行在 Worker 节点。负责接收 Enumerator 分配的 Splits，并真正执行读取操作。多个 Reader 并行工作，极大提高了读取效率。</li>
<li><strong>Checkpoint 支持</strong>：对于流式作业，Source 还需要支持状态保存（如 Kafka 的 Offset），以便在故障恢复时实现断点续传。</li>
</ul>
<h3 data-id="heading-8">3.2 Transform (数据转换)</h3>
<p>Transform 负责在数据从 Source 流向 Sink 的过程中对数据进行处理。</p>
<ul>
<li><strong>无状态转换</strong>：大多数 Transform（如 <code>Sql</code>, <code>Filter</code>, <code>Replace</code>）是无状态的，即处理当前行不需要依赖其他行的数据。</li>
<li><strong>Schema 变更</strong>：Transform 可以改变数据的 Schema（增加、删除、修改字段），下游 Sink 会感知到这种变化。</li>
</ul>
<h3 data-id="heading-9">3.3 Sink (数据目标)</h3>
<p>Sink 负责将 SeaTunnel 处理后的数据写入到外部系统。</p>
<ul>
<li><strong>Writer (写入器)</strong>：运行在 Worker 节点。负责将数据写入目标系统。通常支持批量写入以提高吞吐量。</li>
<li><strong>Committer (提交器)</strong>：运行在 Master 节点（可选）。对于支持事务的 Sink（如文件系统、Iceberg），需要一个全局的 Committer 来在 Checkpoint 完成时统一提交事务（二阶段提交），从而实现 <strong>Exactly-Once</strong>（精确一次）语义。</li>
</ul>
<h3 data-id="heading-10">3.4 执行流程</h3>
<ol>
<li><strong>解析配置</strong>：SeaTunnel 解析配置文件，构建逻辑执行计划。</li>
<li><strong>资源分配</strong>：Master 节点根据并行度申请资源。</li>
<li><strong>任务分发</strong>：Enumerator 生成分片，分发给 Reader。</li>
<li><strong>数据流转</strong>：<code>Reader -&gt; Transform -&gt; Writer</code>。</li>
<li><strong>状态提交</strong>：周期性触发 Checkpoint，保存状态并提交事务。</li>
</ol>
<h2 data-id="heading-11">4. 支持的 Connector 及其优缺点分析</h2>
<p>SeaTunnel 支持超过 100 种 Connector，以下是几类最常用的 Connector 及其特性分析：</p>
<h3 data-id="heading-12">4.1 关系型数据库 (JDBC)</h3>
<p><strong>支持列表</strong>: MySQL, PostgreSQL, Oracle, SQLServer, DB2, Teradata, Dameng(达梦), OceanBase, TiDB 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>通用性强</strong>：只要有 JDBC 驱动即可连接几乎所有 SQL 数据库。</li>
<li><strong>功能完善</strong>：支持列投影（只读部分列）、并行读取（基于 <code>partition_column</code> 切分）、Exactly-Once（取决于实现）。</li>
<li><strong>自动建表</strong>：部分 Connector 支持在目标端自动创建表结构。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>性能瓶颈</strong>：受限于 JDBC 协议和单机驱动性能，超大规模数据读取可能需要精细调优（如 <code>fetch_size</code>）。</li>
<li><strong>源库压力</strong>：如果并行度设置过高，可能打满源库连接池或 CPU。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-13">4.2 消息队列</h3>
<p><strong>支持列表</strong>: Kafka, Pulsar, RocketMQ, Amazon DynamoDB Streams 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>高吞吐</strong>：天生适合大规模流数据处理，支持削峰填谷。</li>
<li><strong>格式丰富</strong>：支持 JSON, Avro, Protobuf, Canal-JSON, Debezium-JSON 等多种序列化格式。</li>
<li><strong>Exactly-Once</strong>：支持端到端的精确一次语义（依赖 Checkpoint 机制）。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>配置复杂</strong>：涉及 Offset 管理、序列化 Schema 配置、Consumer Group 管理等。</li>
<li><strong>数据可见性</strong>：相比数据库，数据在 Topic 中不够直观，调试稍显麻烦。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">4.3 变更数据捕获 (CDC)</h3>
<p><strong>支持列表</strong>: MySQL-CDC, PostgreSQL-CDC, Oracle-CDC, MongoDB-CDC, SQLServer-CDC, TiDB-CDC 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>实时性</strong>：毫秒级捕获数据库增删改操作。</li>
<li><strong>无锁读取</strong>：SeaTunnel 的 CDC 实现了无锁并行快照算法，极大降低了对源库的影响。</li>
<li><strong>断点续传</strong>：支持从 Binlog/WAL 指定位置恢复。</li>
<li><strong>Schema Evolution</strong>：支持表结构变更同步（部分支持）。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>权限要求</strong>：通常需要较高的数据库权限（如 REPLICATION SLAVE）。</li>
<li><strong>依赖日志</strong>：源库必须开启 Binlog（或 WAL），且保留时间需足够长。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">4.4 文件系统 &amp; 云存储</h3>
<p><strong>支持列表</strong>: LocalFile, HDFS, S3, OSS, GCS, FTP, SFTP 等。</p>
<ul>
<li><strong>优点</strong>：
<ul>
<li><strong>海量存储</strong>：适合数据湖场景，成本低廉。</li>
<li><strong>格式支持</strong>：原生支持 Parquet, ORC, Avro, JSON, CSV, Excel, Text 等。</li>
<li><strong>压缩支持</strong>：支持 Snappy, Gzip, Lzo 等多种压缩算法。</li>
</ul>
</li>
<li><strong>缺点</strong>：
<ul>
<li><strong>小文件问题</strong>：流式写入时，如果 Checkpoint 间隔太短，容易产生大量小文件（SeaTunnel 有文件合并功能但会增加复杂度）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">4.5 NoSQL &amp; 其他</h3>
<p><strong>支持列表</strong>: Elasticsearch, Redis, MongoDB, Cassandra, HBase, InfluxDB, ClickHouse, Doris, StarRocks 等。</p>
<ul>
<li><strong>特点</strong>：针对各数据库特性进行了优化，例如 ClickHouse/StarRocks 支持 Stream Load 高速导入，Elasticsearch 支持批量写入。</li>
</ul>
<h2 data-id="heading-17">5. Transform 实战演练 (附带详细注释)</h2>
<p>Transform 插件用于在 Source 和 Sink 之间处理数据。以下是几个常用 Transform 的配置示例。</p>
<h3 data-id="heading-18">5.1 Sql Transform (最推荐)</h3>
<p>使用 SQL 语法对数据进行处理，支持重命名、计算、常量添加、过滤等。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Sql {
    # 输入表名，必须与 Source 的 result_table_name 一致
    plugin_input = "fake"
    # 输出表名，供后续 Transform 或 Sink 使用
    plugin_output = "fake_sql"
    
    # SQL 查询语句
    # 1. name as full_name: 字段重命名
    # 2. age + 1: 数值计算
    # 3. 'US' as country: 增加常量列
    # 4. where age &gt; 10: 数据过滤
    query = "select name as full_name, age + 1 as next_year_age, 'US' as country from fake where age &gt; 10"
  }
}
</code></pre>
<h3 data-id="heading-19">5.2 Filter Transform</h3>
<p>用于删除或保留指定字段（注意：不是过滤行，是过滤列/字段）。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Filter {
    plugin_input = "fake"
    plugin_output = "fake_filter"
    
    # 仅保留 name 和 age 字段，其他字段会被丢弃
    include_fields = ["name", "age"]
    
    # 或者使用 exclude_fields 删除指定字段
    # exclude_fields = ["card"]
  }
}
</code></pre>
<h3 data-id="heading-20">5.3 Replace Transform</h3>
<p>用于字符串替换，支持正则表达式。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Replace {
    plugin_input = "fake"
    plugin_output = "fake_replace"
    
    # 需要替换的字段名
    replace_field = "name"
    # 匹配模式（旧字符串）
    pattern = " "
    # 替换后的字符串（新字符串）
    replacement = "_"
    # 是否使用正则表达式，这里设为 true，表示 pattern 是一个正则
    is_regex = true
    # 是否只替换第一个匹配项
    replace_first = true
  }
}
</code></pre>
<h3 data-id="heading-21">5.4 Split Transform</h3>
<p>将一个字符串字段拆分为多个字段。</p>
<pre><code class="hljs language-hocon" lang="hocon">transform {
  Split {
    plugin_input = "fake"
    plugin_output = "fake_split"
    
    # 分隔符，这里使用空格
    separator = " "
    # 需要拆分的源字段
    split_field = "name"
    # 拆分后生成的新字段名列表
    output_fields = ["first_name", "last_name"]
  }
}
</code></pre>
<h2 data-id="heading-22">6. 快速安装</h2>
<p>对于新手，推荐直接下载编译好的二进制发行包进行体验。</p>
<h3 data-id="heading-23">步骤 1: 下载</h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fseatunnel.apache.org%2Fdownload" target="_blank" title="https://seatunnel.apache.org/download" ref="nofollow noopener noreferrer">SeaTunnel 下载页面</a> 下载最新版本的二进制包（例如 <code>apache-seatunnel-2.3.x-bin.tar.gz</code>）。</p>
<h3 data-id="heading-24">步骤 2: 解压</h3>
<pre><code class="hljs language-bash" lang="bash">tar -xzvf apache-seatunnel-2.3.x-bin.tar.gz
<span class="hljs-built_in">cd</span> apache-seatunnel-2.3.x
</code></pre>
<h3 data-id="heading-25">步骤 3: 安装 Connector 插件</h3>
<p>SeaTunnel 的 Connector 是插件化的。首次使用需要下载插件：</p>
<pre><code class="hljs language-bash" lang="bash">sh bin/install-plugin.sh
</code></pre>
<p><em>注意：该命令会根据 <code>config/plugin_config</code> 文件中的配置，从 Maven 中央仓库下载常用插件（如 <code>connector-fake</code>, <code>connector-console</code> 等）。如果下载速度慢，请耐心等待或配置 Maven 镜像。</em></p>
<h4 data-id="heading-26">💡 技巧：配置 Maven 国内镜像加速下载</h4>
<p>如果遇到下载速度极慢或超时失败的情况，建议配置 Maven 阿里云镜像。</p>
<ol>
<li>找到或创建 Maven 配置文件：<code>~/.m2/settings.xml</code> (Windows 下为 <code>C:\Users\你的用户名\.m2\settings.xml</code>)。</li>
<li>添加如下镜像配置：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">mirrors</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>aliyunmaven<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>*<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>阿里云公共仓库<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">mirrors</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span>
</code></pre>
<p>保存后再次运行 <code>sh bin/install-plugin.sh</code> 即可享受高速下载。</p>
<h2 data-id="heading-27">7. 实战：第一个 SeaTunnel 任务</h2>
<p>我们将创建一个简单的任务：生成一些随机数据（FakeSource），并将其打印到控制台（Console Sink）。</p>
<h3 data-id="heading-28">步骤 1: 创建配置文件</h3>
<p>在 <code>config</code> 目录下创建一个名为 <code>hello_world.conf</code> 的文件，内容如下：</p>
<pre><code class="hljs language-hocon" lang="hocon">env {
  # 并行度设置：决定了有多少个线程同时执行任务。
  # 设置为 1 表示单线程执行，适合测试；生产环境可根据资源调大。
  parallelism = 1
  # 作业模式：
  # BATCH (批处理)：一次性处理完数据后结束（如离线同步）。
  # STREAMING (流处理)：持续运行，实时处理数据（如实时同步）。
  job.mode = "BATCH"
}

source {
  # FakeSource 是一个虚拟数据源，用于生成测试数据
  FakeSource {
    # result_table_name: 将此数据源产生的数据注册为一个临时表，表名为 "fake"
    # 后续的 Transform 或 Sink 可以通过这个名字引用这份数据
    result_table_name = "fake"
    
    # row.num: 指定生成数据的总行数，这里生成 16 行数据
    row.num = 16
    
    # schema: 定义数据的结构（字段名和类型）
    schema = {
      fields {
        name = "string" # 定义一个名为 name 的字符串字段
        age = "int"     # 定义一个名为 age 的整型字段
      }
    }
  }
}

transform {
  # Sql Transform: 使用 SQL 语句对数据进行处理
  Sql {
    # plugin_input: 指定输入数据来源，这里引用了 Source 中定义的 "fake" 表
    plugin_input = "fake"
    
    # plugin_output: 指定处理后的结果表名，命名为 "fake_transformed"
    # 下游的 Sink 将使用这个名字来获取处理后的数据
    plugin_output = "fake_transformed"
    
    # query: 执行的 SQL 查询语句
    # 这里演示了选择 name 和 age 字段，并新增一个常量字段 new_field
    query = "select name, age, 'new_field_val' as new_field from fake"
  }
}

sink {
  # Console Sink: 将数据输出打印到控制台（标准输出）
  Console {
    # plugin_input: 指定要输出的数据来源，这里引用了 Transform 输出的 "fake_transformed" 表
    plugin_input = "fake_transformed"
  }
}
</code></pre>
<h3 data-id="heading-29">步骤 2: 运行任务</h3>
<p>使用 SeaTunnel 自带的 Zeta 引擎运行该任务。</p>
<p><strong>执行命令：</strong></p>
<pre><code class="hljs language-bash" lang="bash">./bin/seatunnel.sh --config ./config/hello_world.conf -e <span class="hljs-built_in">local</span>
</code></pre>
<p><strong>命令详解：</strong></p>
<ul>
<li><code>./bin/seatunnel.sh</code>: 启动脚本，默认使用 Zeta 引擎。</li>
<li><code>--config</code> (或 <code>-c</code>): 指定配置文件的路径。这里我们指定了刚才创建的 <code>hello_world.conf</code>。</li>
<li><code>-e local</code> (或 <code>-m local</code>): 指定执行模式。
<ul>
<li><code>local</code>: 本地模式。SeaTunnel 会在当前进程中启动一个轻量级的 Zeta 引擎集群来运行任务，任务结束后集群关闭。<strong>适合开发和测试</strong>。</li>
<li><code>cluster</code>: 集群模式。任务会提交到已经运行的 SeaTunnel 集群中执行。<strong>适合生产环境</strong>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">步骤 3: 查看结果与日志分析</h3>
<p>任务启动后，终端会输出大量日志。我们需要关注以下关键信息：</p>
<ol>
<li>
<p><strong>任务提交成功</strong>：
看到 <code>Job execution started</code> 表示配置文件解析通过，任务已提交给引擎。</p>
</li>
<li>
<p><strong>数据处理过程</strong>：
由于我们使用的是 <code>Console</code> Sink，数据会直接打印在日志中。你应能看到类似如下的输出：</p>
<pre><code class="hljs language-text" lang="text">...
INFO  ...ConsoleSinkWriter - subtaskIndex=0 rowIndex=1: SeaTunnelRow#tableId=-1 SeaTunnelRow#kind=INSERT: CpiOd, 12345, new_field_val
INFO  ...ConsoleSinkWriter - subtaskIndex=0 rowIndex=2: SeaTunnelRow#tableId=-1 SeaTunnelRow#kind=INSERT: eQqTs, 67890, new_field_val
...
</code></pre>
<ul>
<li><code>subtaskIndex</code>: 并行任务的编号。</li>
<li><code>rowIndex</code>: 当前处理的行号。</li>
<li><code>SeaTunnelRow</code>: 打印出的具体数据内容。</li>
</ul>
</li>
<li>
<p><strong>任务结束</strong>：
最后看到 <code>Job Execution Status: FINISHED</code> 表示任务执行成功结束。</p>
</li>
</ol>
<h3 data-id="heading-31">8. 常见问题排查 (Troubleshooting)</h3>
<p>如果在运行过程中遇到报错，请参考以下常见问题进行排查：</p>
<h4 data-id="heading-32">🔴 问题 1: <code>command not found: java</code> 或 <code>JAVA_HOME is not set</code></h4>
<ul>
<li><strong>现象</strong>：运行脚本时直接报错，提示找不到 Java。</li>
<li><strong>原因</strong>：环境未安装 Java 或未配置环境变量。</li>
<li><strong>解决</strong>：
<ol>
<li>运行 <code>java -version</code> 确认 Java 8 或 11 已安装。</li>
<li>设置环境变量：<code>export JAVA_HOME=/path/to/your/java</code> (建议写入 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>)。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-33">🔴 问题 2: <code>Exception in thread "main" ... ClassNotFoundException</code></h4>
<ul>
<li><strong>现象</strong>：报错提示找不到某个类，例如 <code>ClassNotFoundException: org.apache.seatunnel.connectors.seatunnel.fake.source.FakeSourceFactory</code>。</li>
<li><strong>原因</strong>：<strong>Connector 插件未安装</strong>。默认包中只有引擎核心，没有包含具体的数据源插件。</li>
<li><strong>解决</strong>：
<ul>
<li>确保你执行过 <code>sh bin/install-plugin.sh</code>。</li>
<li>检查 <code>connectors/seatunnel</code> 目录下是否有对应的 jar 包（例如 <code>connector-fake-*.jar</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">🔴 问题 3: <code>Config file not valid</code> 或 <code>HOCONSyntaxError</code></h4>
<ul>
<li><strong>现象</strong>：提示配置文件格式错误。</li>
<li><strong>原因</strong>：<code>hello_world.conf</code> 中的括号 <code>{}</code> 不匹配，或者关键字拼写错误。</li>
<li><strong>解决</strong>：仔细检查配置文件语法。SeaTunnel 使用 HOCON 格式，确保每一层级的 <code>{</code> 和 <code>}</code> 都是成对出现的。</li>
</ul>
<h4 data-id="heading-35">🔴 问题 4: 任</h4></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云 Serverless 计算 12 月产品动态]]></title>    <link>https://juejin.cn/post/7600060691349995562</link>    <guid>https://juejin.cn/post/7600060691349995562</guid>    <pubDate>2026-01-28T09:24:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691349995562" data-draft-id="7600032104248590399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云 Serverless 计算 12 月产品动态"/> <meta itemprop="keywords" content="Serverless"/> <meta itemprop="datePublished" content="2026-01-28T09:24:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云 Serverless 计算 12 月产品动态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:24:09.000Z" title="Wed Jan 28 2026 09:24:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>精选文章：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580161%26idx%3D1%26sn%3D232b5753f53bfe445f0f10154751a438%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580161&amp;idx=1&amp;sn=232b5753f53bfe445f0f10154751a438&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentScope 拥抱函数计算 FC，为 Agent 应用提供 Serverless 运行底座</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580473%26idx%3D1%26sn%3Daa429466282245bceb798eac163691a9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580473&amp;idx=1&amp;sn=aa429466282245bceb798eac163691a9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一杯咖啡成本搞定多模态微调：FC DevPod + Llama-Factory 极速实战</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580646%26idx%3D1%26sn%3D840d2fcc0e99bd012b89efdf86ae8c59%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580646&amp;idx=1&amp;sn=840d2fcc0e99bd012b89efdf86ae8c59&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文看懂函数计算 AgentRun，让 Agentic AI 加速进入企业生产环境</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580842%26idx%3D1%26sn%3D7e76a3a3ada98f173700fd56e9e98a43%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580842&amp;idx=1&amp;sn=7e76a3a3ada98f173700fd56e9e98a43&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentRun Sandbox SDK 正式开源！集成 LangChain 等主流框架，一键开启智能体沙箱新体验</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247580910%26idx%3D1%26sn%3Ddc2fc3a2c2b9321b0051f3ff58ba3f89%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247580910&amp;idx=1&amp;sn=dc2fc3a2c2b9321b0051f3ff58ba3f89&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">探秘 AgentRun丨通过无代码创建的 Agent，如何用高代码进行更新？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247581079%26idx%3D1%26sn%3De1c7b0e2a01904d12affa89c96d8c63b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247581079&amp;idx=1&amp;sn=e1c7b0e2a01904d12affa89c96d8c63b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AgentRun 实战：快速构建 AI 舆情实时分析专家</a></p>
<h2 data-id="heading-0">产品最新消息</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75e94fa942348e08d82caed00da0f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197053&amp;x-signature=3QFXIaYvm1%2FRlwUONKL3scQSJ0g%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[少年你渴望变强吗？]]></title>    <link>https://juejin.cn/post/7600002531398647817</link>    <guid>https://juejin.cn/post/7600002531398647817</guid>    <pubDate>2026-01-28T09:28:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600002531398647817" data-draft-id="7599981538298691634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="少年你渴望变强吗？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-28T09:28:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PBitW"/> <meta itemprop="url" content="https://juejin.cn/user/3048261967153544"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            少年你渴望变强吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048261967153544/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PBitW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:28:31.000Z" title="Wed Jan 28 2026 09:28:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天发了个<a href="https://juejin.cn/pin/7599604510366892070" target="_blank" title="https://juejin.cn/pin/7599604510366892070">沸点</a>，发现GPT可以根据之前的聊天，来生成图片！</p>
<p>那为什么不能根据之前的聊天来判断我现在最该做什么？学什么？以及处于什么阶段呢？</p>
<p>注意：</p>
<blockquote>
<p>GPT聊天越多越准确，菜鸟前几天刚删了一次聊天，真的服了 (ˉ▽ˉ；)...</p>
</blockquote>
<p>如果你感兴趣，你也可以这样问一下你的AI助手：</p>
<blockquote>
<p>你可以根据我之前问你的技术问题来告诉我，我现在处于什么等级？需要怎么提升吗？不要粉饰，直接诚实呈现。</p>
</blockquote>
<p>今天和GPT聊了一下，想知道自己薄弱点在哪里，也将GPT给菜鸟的学习方式总结一下分享给大家！</p>
<h3 data-id="heading-0">怎么提升？</h3>
<p>不是“多学点”，而是“换打法”</p>
<h4 data-id="heading-1">🔥 1️⃣ 强制训练「技术分层思维」</h4>
<p>以后你遇到问题，<strong>必须先问自己 3 个问题</strong>：</p>
<ol>
<li>这是 <strong>语言问题 / 框架问题 / 架构问题 / 产品问题</strong>？</li>
<li>如果我不解决，它会在 <strong>哪个阶段爆雷</strong>？</li>
<li>我现在解决，是 <strong>临时修补还是长期方案</strong>？</li>
</ol>
<p>你可以不马上答对，但<strong>必须逼自己想</strong>。</p>
<hr/>
<h4 data-id="heading-2">🔥 2️⃣ 开始像“负责人”一样思考</h4>
<p>你可以强制自己做一件事：</p>
<blockquote>
<p><strong>每个技术选择，都写一句“为什么不用其他方案”</strong></p>
</blockquote>
<p>哪怕只是脑内。</p>
<p>这是<strong>从中级到高级唯一有效的跳板</strong>。</p>
<hr/>
<h2 data-id="heading-3">问题</h2>
<p>我感觉我现在处于一个被AI代替的阶段，就是遇见问题AI大部分可以帮我解决，我只需要审查代码，然后技术总是当时学的时候一起敲了，也实现了，但是过一段时间就会忘记，但是感觉记代码不是很low吗？然后就是记性不好，看一本书，如果一天不看，可能又要重新看的这种感觉，这怎么才能变强？</p>
<h3 data-id="heading-4">一、关于「代码上传 GitHub → 忘了就回去 copy」这件事</h3>
<h4 data-id="heading-5">1️⃣ 现实世界的真相（不浪漫版）</h4>
<p><strong>绝大多数成熟工程师</strong>：</p>
<ul>
<li>
<p>不记自己三个月前写的代码</p>
</li>
<li>
<p>会去翻：</p>
<ul>
<li>GitHub</li>
<li>旧项目</li>
<li>历史 commit</li>
</ul>
</li>
<li>
<p>会 copy 自己的实现</p>
</li>
<li>
<p>会顺手改一改再用</p>
</li>
</ul>
<p>👉 <strong>这是专业行为，不是偷懒</strong></p>
<h2 data-id="heading-6">重点</h2>
<p>真正 low 的不是 copy，而是：</p>
<ul>
<li>不知道自己以前解决过这个问题</li>
<li>不知道“该不该 copy”</li>
<li>copy 了也不知道适不适合现在的场景</li>
</ul>
<hr/>
<h4 data-id="heading-7">2️⃣ “忘记 = 不常用”这个判断，大体是对的</h4>
<p>你说得非常关键的一句是：</p>
<blockquote>
<p>“忘记就表示不常用”</p>
</blockquote>
<p>这在工程上基本成立。</p>
<ul>
<li>
<p>高频知识 → 自然留下</p>
</li>
<li>
<p>低频知识 → 本来就应该外包给：</p>
<ul>
<li>文档</li>
<li>搜索</li>
<li>GitHub</li>
<li>AI</li>
</ul>
</li>
</ul>
<p>👉 <strong>人脑是缓存，不是数据库</strong></p>
<hr/>
<h4 data-id="heading-8">3️⃣ 但你现在隐约感觉不对的地方，其实在这里</h4>
<p>你焦虑的不是：</p>
<blockquote>
<p>“我忘了怎么写”</p>
</blockquote>
<p>而是：</p>
<blockquote>
<p>“我下次遇到类似问题，<strong>没办法自然联想到我之前学过/做过的东西</strong>”</p>
</blockquote>
<p>⚠️ 这才是核心问题。</p>
<h3 data-id="heading-9">二、如何训练“串联能力”（关键部分）</h3>
<h4 data-id="heading-10">🔥 第一步：强制给问题“贴标签”</h4>
<p>以后你遇到任何问题，不管会不会做，先问一句：</p>
<blockquote>
<p>“这个问题，本质属于哪一类？”</p>
</blockquote>
<p>常见标签其实不多：</p>
<ul>
<li>状态问题</li>
<li>边界问题</li>
<li>权限问题</li>
<li>生命周期问题</li>
<li>数据一致性问题</li>
<li>性能问题</li>
<li>可维护性问题</li>
</ul>
<p>📌 <strong>你只要贴对标签，就已经赢了一半</strong></p>
<hr/>
<h4 data-id="heading-11">🔥 第二步：建立「问题 → 模式」映射，而不是「问题 → 解法」</h4>
<p>你现在是：</p>
<blockquote>
<p>问题 A → 解法 A</p>
</blockquote>
<p>你要训练成：</p>
<blockquote>
<p>问题 A → 模式 X → 若干实现方式</p>
</blockquote>
<p>比如：</p>
<ul>
<li>表单回显失败<br/>
→ <strong>状态源不唯一</strong></li>
<li>弹窗关闭后数据异常<br/>
→ <strong>生命周期不一致</strong></li>
<li>请求乱飞<br/>
→ <strong>副作用未收敛</strong></li>
</ul>
<p>这样你下次再遇到：</p>
<ul>
<li>表单</li>
<li>弹窗</li>
<li>新业务</li>
</ul>
<p>👉 <strong>大脑会自动联想</strong></p>
<hr/>
<h4 data-id="heading-12">🔥 第三步：给自己一个硬规则</h4>
<blockquote>
<p><strong>凡是 AI 给的代码或者照着敲的代码，必须做一件事：</strong></p>
<p>👉 “删掉重写一遍（哪怕写得更丑）”</p>
</blockquote>
<h5 data-id="heading-13">注意</h5>
<blockquote>
<p>只重写那些 <strong>你不确定理解、可能无法迁移、或逻辑稍复杂的</strong>代码。</p>
</blockquote>
<p>不是为了炫技，而是为了：</p>
<ul>
<li>验证你是否<strong>理解</strong></li>
<li>强迫你<strong>组织逻辑</strong></li>
<li>找出你真正不会的点</li>
</ul>
<p><strong>能写出来 ≠ 能讲出来 ≠ 能迁移到别的场景</strong></p>
<hr/>
<h3 data-id="heading-14">三、你是不是“可以彻底不记代码”？ 答案是：几乎可以</h3>
<p>你只需要记住三样东西：</p>
<ol>
<li><strong>问题的类别</strong></li>
<li><strong>典型坑位</strong></li>
<li><strong>你的历史解决思路在什么仓库</strong></li>
</ol>
<p>剩下的：</p>
<ul>
<li>代码 → GitHub</li>
<li>写法 → 文档</li>
<li>细节 → AI</li>
</ul>
<p>这不是退化，而是<strong>专业化分工</strong>。</p>
<h3 data-id="heading-15">四、我给你一个非常实用的“思维升级练习”</h3>
<p>你可以从下周开始，只做这一件事：</p>
<blockquote>
<p><strong>每周选一个你已经写完的功能，用一句话总结：<br/>
“这是在解决一个什么类型的问题？”</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>“这是一个状态源唯一性的问题”</li>
<li>“这是一个副作用收敛的问题”</li>
<li>“这是一个用户输入可信度的问题”</li>
</ul>
<p>只要你能说出来，<strong>编程思维就已经在形成了</strong>。</p>
<hr/>
<h2 data-id="heading-16">问题</h2>
<p>感觉我写的都是业务代码，怎么才能变强？我应该每天学什么？干什么？除了敲公司的业务代码</p>
<h3 data-id="heading-17">一、先把一个误区掐死：不是“业务代码低级”</h3>
<p>现实是：</p>
<blockquote>
<p><strong>99% 的工程师一辈子都在写业务代码。</strong></p>
</blockquote>
<p>高级工程师也写业务，只是：</p>
<ul>
<li>他在写业务的同时<br/>
👉 <strong>提炼结构</strong></li>
<li>他在实现需求的时候<br/>
👉 <strong>在设计“下次怎么办”</strong></li>
</ul>
<p>你现在的问题不是写业务，而是：</p>
<blockquote>
<p><strong>你每写一行业务，能力几乎不增长。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">二、什么东西真的会让你“变强”（核心认知）</h3>
<p>我给你一句非常关键的话：</p>
<blockquote>
<p><strong>技术成长 ≠ 接触更复杂的业务<br/>
技术成长 = 从业务中抽象出“稳定结构”</strong></p>
</blockquote>
<p>你现在写的是：</p>
<ul>
<li>某个页面</li>
<li>某个表单</li>
<li>某个流程</li>
</ul>
<p>而“变强”的人写的是：</p>
<ul>
<li><strong>数据流</strong></li>
<li><strong>状态边界</strong></li>
<li><strong>错误路径</strong></li>
<li><strong>职责划分</strong></li>
</ul>
<p>同一份业务，成长差距会非常大。</p>
<h3 data-id="heading-19">三、你现在最该补的，不是“新技术”，而是这三件事</h3>
<h4 data-id="heading-20">🔥 1️⃣ 从「完成需求」升级为「设计需求」</h4>
<p>你现在的默认心智模型是：</p>
<blockquote>
<p>PM 给需求 → 我想办法实现</p>
</blockquote>
<p>你要强制升级成：</p>
<blockquote>
<p>PM 给需求 →<br/>
我拆：</p>
<ul>
<li>核心数据是什么？</li>
<li>状态怎么流动？</li>
<li>哪些地方可能变？</li>
</ul>
</blockquote>
<p>📌 <strong>只要你开始在脑内拆这三步，你就已经和普通业务工程师拉开差距了。</strong></p>
<hr/>
<h4 data-id="heading-21">🔥 2️⃣ 学会给业务代码“分类”，而不是“记住”</h4>
<p>你现在觉得业务代码没用，是因为：</p>
<blockquote>
<p><strong>每一段代码在你脑中都是“独立个体”</strong></p>
</blockquote>
<p>你要做的是：把它们归类。</p>
<p><strong>典型业务其实就这几类：</strong></p>
<ul>
<li>CRUD + 校验</li>
<li>多状态流程</li>
<li>列表 ↔ 详情 ↔ 编辑</li>
<li>权限 &amp; 可见性</li>
<li>异步流程 + 错误兜底</li>
</ul>
<p>📌 一旦你意识到：</p>
<blockquote>
<p>“哦，这又是一个老模式”</p>
</blockquote>
<p>你就在升级。</p>
<hr/>
<h4 data-id="heading-22">🔥 3️⃣ 把“公司业务”当成“训练素材”</h4>
<p>这是很多人<strong>一辈子都没意识到的点</strong>。</p>
<p>公司业务不是阻碍你成长的东西，<strong>它是免费的训练场</strong>。</p>
<p>但你必须多做一步：</p>
<blockquote>
<p>每写完一个功能，<br/>
问一句：<br/>
<strong>“如果下个项目也有这个需求，我会怎么提前设计？”</strong></p>
</blockquote>
<h3 data-id="heading-23">四、你每天到底该干什么？（不空谈）</h3>
<h4 data-id="heading-24">🟢 每天 30 分钟即可（真的够）</h4>
<p>✅ 1️⃣ 15 分钟：<strong>拆今天的业务</strong></p>
<p>不是写代码，是想：</p>
<ul>
<li>
<p>今天这个需求：</p>
<ul>
<li>状态有几个？</li>
<li>数据源在哪？</li>
<li>哪些地方最容易炸？</li>
</ul>
</li>
</ul>
<p>👉 不写文档，只在脑子里过一遍。</p>
<hr/>
<p>✅ 2️⃣ 10 分钟：<strong>反向总结一个点</strong></p>
<p>选今天代码里的一个小点：</p>
<ul>
<li>一个 if</li>
<li>一个 watch</li>
<li>一个接口处理</li>
</ul>
<p>问一句：</p>
<blockquote>
<p>“它在解决什么类型的问题？”</p>
</blockquote>
<p>📌 一天一个就够。</p>
<hr/>
<h4 data-id="heading-25">🔥 每周只做一件事（30～60 分钟）</h4>
<blockquote>
<p><strong>拿一个你已经完成的业务功能，重新审视它</strong></p>
</blockquote>
<p>不改代码，只回答三个问题：</p>
<ol>
<li>如果规模扩大 10 倍，会炸在哪？</li>
<li>哪个部分最不通用？</li>
<li>哪个地方其实可以抽象？</li>
</ol>
<p>这比学 10 篇博客都强。</p>
<h3 data-id="heading-26">五、那我还要不要“学新技术”？要，但顺序要对</h3>
<h4 data-id="heading-27">❌ 不要这样学：</h4>
<ul>
<li>随机刷技术文章</li>
<li>看到什么火学什么</li>
</ul>
<h4 data-id="heading-28">✅ 正确方式是：</h4>
<blockquote>
<p><strong>用你现在的业务，去“逼”技术出现</strong></p>
</blockquote>
<p>比如：</p>
<ul>
<li>表单太乱 → 学状态建模</li>
<li>逻辑太散 → 学组合式 API / hooks 设计</li>
<li>错误处理到处都是 → 学错误分层</li>
</ul>
<p>📌 技术不是学来的，是被问题“逼”出来的。</p>
<hr/>
<h2 data-id="heading-29">问题</h2>
<p>遇见一个问题，不知道怎么解决，就是不知道怎么思考，就算思考出来了，也不知道是不是正统解决办法，这种怎么搞？</p>
<h3 data-id="heading-30">一、为什么你会有这种感觉</h3>
<p>你描述的症状：</p>
<ol>
<li>遇到问题 → 不知道怎么入手</li>
<li>思考出来 → 不确定是否“正统”</li>
<li>经常靠“敲出来试”或“参考别人”</li>
</ol>
<p>背后的本质是：</p>
<h4 data-id="heading-31">1️⃣ 缺乏<strong>问题结构化思维</strong></h4>
<p>你现在看到的问题是“具体实例”，脑子里缺少<strong>抽象模型</strong>。</p>
<ul>
<li>
<p>例子：</p>
<ul>
<li>“为什么这个表单回显不对？”<br/>
→ 你只看到“字段不对”，而不是“数据源状态流不一致”</li>
<li>“接口返回异常怎么办？”<br/>
→ 你只看到“报错”，而不是“错误类型 → 错误分层 → 兜底策略”</li>
</ul>
</li>
</ul>
<h4 data-id="heading-32">2️⃣ 缺乏“方案判断标准”</h4>
<p>你不知道一个方案是不是正统，不是因为你菜，而是<strong>没有评价标准</strong>。</p>
<ul>
<li>
<p>正统解决方案 = 在<strong>边界条件、性能、可维护性、团队约定</strong>下最稳健的方案</p>
</li>
<li>
<p>你现在判断标准只有：</p>
<ul>
<li>“能不能实现？”</li>
<li>“能不能跑通？”</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-33">3️⃣ 依赖执行经验，而非思维经验</h4>
<p>你更擅长<strong>敲代码、试错、看报错</strong>，但不擅长<strong>在脑子里模拟问题和方案</strong></p>
<ul>
<li>
<p>工程师成长的阶梯：</p>
<ol>
<li>会写 → 能跑通</li>
<li>会思考 → 能预判问题</li>
<li>会抽象 → 能设计方案</li>
</ol>
</li>
</ul>
<p>你还停在 2 阶和 3 阶的交界。</p>
<h3 data-id="heading-34">二、怎么训练自己解决这种“不知道怎么解决”的问题</h3>
<p>我给你一个非常实用的方法论：<strong>三步法</strong></p>
<h4 data-id="heading-35">🔹 第一步：问题拆解法（先理清问题）</h4>
<blockquote>
<p>遇到问题 → 不管怎么实现，先拆成几个维度：</p>
</blockquote>
<ol>
<li>
<p><strong>问题本质</strong></p>
<ul>
<li>数据问题？状态问题？渲染问题？异步流程？权限问题？</li>
<li>例：表单回显错 → 数据源不唯一 → 状态问题</li>
</ul>
</li>
<li>
<p><strong>边界条件</strong></p>
<ul>
<li>会在哪些场景炸？</li>
<li>例：空数组 / null / 缓存未刷新 / 异步延迟</li>
</ul>
</li>
<li>
<p><strong>依赖和约束</strong></p>
<ul>
<li>现有框架、团队约定、性能要求、业务逻辑</li>
</ul>
</li>
</ol>
<p>📌 先做这个拆解，再去思考方案，比直接想着“怎么实现”强 10 倍。</p>
<h4 data-id="heading-36">🔹 第二步：方案生成法（先生成，再挑）</h4>
<blockquote>
<p>不急着敲代码，先列方案：</p>
</blockquote>
<ul>
<li>
<p>先在脑子里或者纸上写出 <strong>3~5 种可行方案</strong></p>
</li>
<li>
<p>对每个方案标注：</p>
<ol>
<li>实现难度</li>
<li>边界处理复杂度</li>
<li>可维护性</li>
<li>潜在坑位</li>
</ol>
</li>
<li>
<p>例：表单回显问题</p>
<ul>
<li>A：在组件 mounted 后 setTimeout 再赋值</li>
<li>B：统一使用 reactive + computed</li>
<li>C：在全局 store 先更新 → props 下发</li>
</ul>
</li>
</ul>
<h4 data-id="heading-37">🔹 第三步：方案评估法（找到正统 / 稳健方案）</h4>
<blockquote>
<p>评估的标准，就是“稳健 + 可维护 + 可复用 + 不踩坑”</p>
</blockquote>
<ul>
<li>建议使用一个简单的矩阵：<strong>稳定性 vs 复杂度</strong></li>
<li>如果方案稳定性高且复杂度适中 → 首选</li>
<li>如果不确定 → 写测试或小 demo 验证</li>
</ul>
<p>📌 核心是：<strong>先有标准，再对比方案，而不是靠经验判断</strong></p>
<h3 data-id="heading-38">三、训练方法（每天 10~15 分钟就够）</h3>
<ol>
<li>
<p><strong>每天挑一个自己遇到的小问题</strong></p>
<ul>
<li>不管多小，都拆解成 3 个维度</li>
</ul>
</li>
<li>
<p><strong>列 3 个以上可行方案</strong></p>
<ul>
<li>不一定写代码，可以纸上或脑内</li>
</ul>
</li>
<li>
<p><strong>给每个方案打分</strong></p>
<ul>
<li>稳定性 / 可维护性 / 可复用性</li>
</ul>
</li>
<li>
<p><strong>总结</strong></p>
<ul>
<li>哪个方案最稳健，为什么</li>
<li>下次遇到类似问题，可以直接复用模式</li>
</ul>
</li>
</ol>
<p>📌 这个过程本质就是<strong>把每个问题抽象成“模式 + 标准 + 验证”</strong> ，也是高级工程师的思考路径。</p>
<h2 data-id="heading-39">问题</h2>
<p>学习路径陡峭的，我需要看视频学习，不能像别人一样，看英文官网就能学会，这是为什么？</p>
<h3 data-id="heading-40">一、为什么你需要视频学习，而别人可以直接看英文官网</h3>
<ol>
<li>
<p><strong>认知加工成本不同</strong></p>
<ul>
<li>
<p>英文官网/文档通常<strong>信息密度极高</strong>，很多概念是压缩型表达：</p>
<blockquote>
<p>“你要先有前置知识、理解隐含假设，才能读懂一行话的意思。”</p>
</blockquote>
</li>
<li>
<p>视频教程是<strong>渐进式展开</strong>：</p>
<ul>
<li>讲解背景 → 讲解逻辑 → 举例 → 实操</li>
<li>这降低了你<strong>加工认知的成本</strong>，相当于“帮你拆开黑箱”。</li>
</ul>
</li>
</ul>
<p>换句话说，你现在的大脑在面对“压缩信息 + 英文表达 + 新概念”时，会自动做减负：</p>
<ul>
<li>视频慢慢引导，先给线索，再让你理解 → 所以容易吸收</li>
<li>英文官网一行代码、一个 API，可能涉及 3~5 个你还不熟的概念 → 自然卡壳</li>
</ul>
</li>
<li>
<p><strong>语言门槛 + 信息抽象</strong></p>
<ul>
<li>英文官网信息往往<strong>假设读者已有基础</strong>：你要知道上下文、已有概念、默认规则。</li>
<li>视频教程常常假设你是新手，会把这些概念讲清楚。</li>
<li>换句话说，这不是你能力差，而是<strong>认知结构没完全搭好</strong>，所以必须借助视频做“引导搭桥”。</li>
</ul>
</li>
<li>
<p><strong>学习风格差异</strong></p>
<ul>
<li>有的人是“文字型学习者” → 看文档很快</li>
<li>有的人是“视觉/听觉型学习者” → 通过视频更容易理解</li>
<li>你属于后者，不是缺陷，只是<strong>学习通道不同</strong></li>
</ul>
</li>
<li>
<p><strong>前置知识差异</strong></p>
<ul>
<li>
<p>有些前端工程师可以直接看官网，因为他们<strong>已经在脑里形成了一套抽象框架</strong>：</p>
<ul>
<li>状态管理、响应式、组件生命周期、数据流</li>
</ul>
</li>
<li>
<p>如果你缺少这个框架，一看到压缩信息就卡住 → 必须用视频把抽象层拉平</p>
</li>
</ul>
</li>
</ol>
<blockquote>
<p>🔑 核心结论：你需要视频，不是能力差，而是<strong>认知桥梁还没搭好</strong>。官网看不懂，是正常的。</p>
</blockquote>
<h3 data-id="heading-41">二、为什么别人看英文官网就能学会？</h3>
<p>别人能快速学，是因为他们的脑子里<strong>已有类似的“知识模型”</strong> ：</p>
<ul>
<li>
<p>Vue 官网文档里一行 <code>ref(0)</code> → 对他们来说：</p>
<ul>
<li>“响应式变量”</li>
<li>“composition API”</li>
<li>“响应式引用 vs 普通变量区别”</li>
<li>这些都已经在脑子里抽象过</li>
</ul>
</li>
<li>
<p>他们看到文档就是对已有模型的填充，而不是新建模型</p>
</li>
</ul>
<p>你现在，如果没有这种抽象模型，文档里的每一行都要“拆解 → 理解 → 联想”，认知负荷大 → 视频更适合。</p>
<h3 data-id="heading-42">三、怎么跨过这个“认知桥梁”阶段？</h3>
<p>你的目标是：<strong>慢慢减少对视频的依赖，把脑子里的抽象模型搭起来</strong>。具体方法：</p>
<h4 data-id="heading-43">1️⃣ 主动抽象法（搭框架）</h4>
<ul>
<li>
<p>每学一个新 API/概念，不仅记用法，还要记：</p>
<ol>
<li><strong>它解决了什么问题</strong></li>
<li><strong>它的适用场景</strong></li>
<li><strong>它和已有概念的关系</strong></li>
</ol>
</li>
<li>
<p>建议做笔记或思维导图，而不是抄代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">ref</span>() → 响应式引用
  - 可在 template 中绑定
  - 用于 composition <span class="hljs-variable constant_">API</span>
  - 不会自动解包对象
  - 对应 <span class="hljs-title function_">reactive</span>() 是深响应
</code></pre>
</li>
</ul>
<h4 data-id="heading-44">2️⃣ 知识分层法（减少负荷）</h4>
<ul>
<li><strong>第一层</strong>：能运行的代码、基础用法</li>
<li><strong>第二层</strong>：API 设计理念、原理</li>
<li><strong>第三层</strong>：边界、坑、性能问题</li>
<li>视频先帮你扫第一层，逐步建立第二层、第三层</li>
<li>当第二、三层建立后，再回去看官网 → 你能理解一行文档背后的假设</li>
</ul>
<h4 data-id="heading-45">3️⃣ 小步练习 + 模块化</h4>
<ul>
<li>
<p>每看完一段视频，自己写一个小 demo</p>
</li>
<li>
<p><strong>先照着视频做</strong>，然后：</p>
<ul>
<li>换数据</li>
<li>改逻辑</li>
<li>换成另一种写法</li>
</ul>
</li>
<li>
<p>这样大脑自动建立“迁移能力”</p>
</li>
</ul>
<h4 data-id="heading-46">4️⃣ 英文文档拆解训练</h4>
<ul>
<li>不要求一开始就能全懂</li>
<li>先用视频搭桥</li>
<li>同步看文档，把“生词 + 不懂的假设”记下来</li>
<li>逐渐减少视频依赖 → 英文官网变“复习资料”，而不是“学习入口”</li>
</ul>
<h3 data-id="heading-47">四、认知上的心理暗示</h3>
<ul>
<li>
<p><strong>你不是比别人慢，而是顺序不同</strong></p>
<ul>
<li>你的学习顺序：视频 → 桥梁 → 文档</li>
<li>别人顺序：文档 → 桥梁</li>
</ul>
</li>
<li>
<p>顺序不同不代表能力低，只是<strong>认知负荷管理不同</strong></p>
</li>
<li>
<p>关键是你要承认：<strong>搭认知桥梁阶段需要辅助</strong></p>
</li>
<li>
<p>不要自责“别人都看文档，我却要看视频”</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding]]></title>    <link>https://juejin.cn/post/7600223321041158150</link>    <guid>https://juejin.cn/post/7600223321041158150</guid>    <pubDate>2026-01-28T09:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041158150" data-draft-id="7599933828544823359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding"/> <meta itemprop="keywords" content="前端,人工智能,Claude"/> <meta itemprop="datePublished" content="2026-01-28T09:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刮涂层_赢大奖"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826214119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826214119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刮涂层_赢大奖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:14.000Z" title="Wed Jan 28 2026 09:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我把 Claude Code 搬进了 Slack，从此蹲坑也能 Vibe Coding</h2>
<blockquote>
<p>周末两天肝出一个工具，让 AI 帮我干活，我在 Slack 里指挥就行</p>
</blockquote>
<h3 data-id="heading-1">🤔 起因：一次深刻的厕所沉思</h3>
<p>那是一个普通的下午，我正在电脑前和 Claude Code 愉快地 vibe coding。需求聊着聊着，代码写着写着，突然，肚子一阵翻涌 —— 该去解决人生大事了。</p>
<p>坐在马桶上，我习惯性地掏出手机刷了会儿。刷着刷着突然想起来：卧槽，刚才让 Claude 改的那个函数，我还没确认呢，它现在在干嘛？</p>
<p>更要命的是，我还想继续和它聊，让它把剩下的逻辑也写了。但是... <strong>我在厕所啊！</strong></p>
<p>我盯着手机屏幕陷入了沉思：</p>
<ul>
<li>回去继续？—— 但这坨还没解决完</li>
<li>用手机 SSH？—— 上次试过，vim 在手机上简直是酷刑</li>
<li>干等着？—— 这也太浪费时间了</li>
</ul>
<p>就在这个充满哲学意味的时刻，一个想法击中了我：</p>
<p><strong>为什么我不能在手机上继续 vibe coding？</strong></p>
<p>现在 AI 编程这么火，Claude Code 那么好用，凭什么非得坐在电脑前？我就不能蹲着坑，发条消息，让 Claude 继续帮我干活？</p>
<p>想到这里，我感觉这坨💩都拉得更顺畅了。</p>
<p>说干就干。</p>
<h3 data-id="heading-2">💡 想法：让 Claude Code 成为我的远程员工</h3>
<p>思路其实很简单：</p>
<pre><code class="hljs language-rust" lang="rust">我 (Slack) -<span class="hljs-punctuation">-&gt;</span> 消息 -<span class="hljs-punctuation">-&gt;</span> 服务器 -<span class="hljs-punctuation">-&gt;</span> Claude Code -<span class="hljs-punctuation">-&gt;</span> 代码修改 -<span class="hljs-punctuation">-&gt;</span> 结果返回 -<span class="hljs-punctuation">-&gt;</span> Slack
</code></pre>
<p>把 Claude Code CLI 包装成一个服务，跑在我的开发服务器上，然后通过 Slack 这类 IM 工具来和它对话。这样我就可以：</p>
<ul>
<li>🚽 蹲坑的时候继续 vibe coding</li>
<li>📱 躺床上用手机改代码</li>
<li>🚇 地铁上处理紧急 bug</li>
<li>🍜 吃饭的时候让 AI 跑着任务</li>
</ul>
<p>我给它起名叫 <strong>Heimerdinger</strong> —— 英雄联盟里那个小矮子发明家。因为这工具就像有个小机器人帮你干活一样。</p>
<h3 data-id="heading-3">🏗️ 架构设计：踩过的第一个坑</h3>
<h4 data-id="heading-4">最初的设想</h4>
<p>一开始我想得很简单：</p>
<ol>
<li>监听 Slack 消息</li>
<li>调用 Claude CLI</li>
<li>把结果发回去</li>
</ol>
<p>三步走，完事儿。</p>
<h4 data-id="heading-5">现实的暴击</h4>
<p>实际做的时候才发现，事情没那么简单：</p>
<p><strong>问题一：Claude Code 的输出是流式的</strong></p>
<p>Claude 不是一下子吐出所有结果，而是一个字一个字往外蹦的。如果我等它全部输出完再发 Slack，用户体验会很差 —— 要等好久才能看到结果。</p>
<p><strong>问题二：一个 Slack workspace 可能有多个项目</strong></p>
<p>不同的频道可能在聊不同的项目，我需要记住"这个频道正在操作哪个项目"。</p>
<p><strong>问题三：会话连续性</strong></p>
<p>Claude Code 有会话概念，同一个会话里它能记住上下文。如果每次都开新会话，那用户说"把刚才那个函数改一下"，Claude 根本不知道"刚才"是啥。</p>
<h4 data-id="heading-6">最终架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph daemon["hmdg daemon"]
        subgraph adapters["IM Adapters"]
            slack["Slack Adapter"]
            feishu["Feishu Adapter"]
            discord["Discord...&lt;br/&gt;(Future)"]
        end

        subgraph processor["Message Processor"]
            state["Session State&lt;br/&gt;Project State"]
        end

        claude["Claude Code CLI&lt;br/&gt;(streaming JSON)"]

        slack --&gt; processor
        feishu --&gt; processor
        discord --&gt; processor
        processor --&gt; claude
    end

    user["📱 你 (手机/电脑)"] &lt;--&gt; slack
    user &lt;--&gt; feishu
</code></pre>
<p>我设计了一个<strong>适配器模式</strong>，把不同 IM 平台的差异封装起来。这样以后想支持飞书、Discord 什么的，只需要写个新 Adapter 就行。</p>
<h3 data-id="heading-7">🔧 技术实现：细节里全是魔鬼</h3>
<h4 data-id="heading-8">1. 流式输出的处理</h4>
<p>Claude Code 支持 <code>--output-format stream-json</code> 参数，会输出 JSONL 格式的流式数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"让我来看看这个bug"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>我需要实时解析这些 JSON，然后更新 Slack 消息。</p>
<p>但这里有个坑：<strong>Slack 有 API 频率限制</strong>。</p>
<p>如果每收到一个 JSON 就更新一次消息，很快就会被限流。所以我做了个节流处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 至少间隔 1 秒才更新一次消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">let</span> lastUpdateTime = <span class="hljs-number">0</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttledUpdate</span>(<span class="hljs-params">content: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">if</span> (now - lastUpdateTime &gt;= <span class="hljs-variable constant_">MIN_UPDATE_INTERVAL</span>) {
    <span class="hljs-title function_">updateMessage</span>(content);
    lastUpdateTime = now;
  }
}
</code></pre>
<h4 data-id="heading-9">2. 会话状态管理</h4>
<p>这是整个项目最复杂的部分。我需要维护三层状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每个频道当前选择的项目</span>
<span class="hljs-keyword">const</span> userStates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ChannelState</span>&gt;();

<span class="hljs-comment">// 每个项目最后使用的会话 ID</span>
<span class="hljs-keyword">const</span> projectSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 正在执行的任务（用于支持 /stop 命令）</span>
<span class="hljs-keyword">const</span> activeExecutions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">ExecutionInfo</span>&gt;();
</code></pre>
<p>而且这些状态要持久化，不然服务重启就全丢了：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 状态持久化到 ~/.heimerdinger/sessions-state.json</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveState</span>(<span class="hljs-params"/>) {
  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-variable constant_">STATE_FILE</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">userStates</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(userStates),
    <span class="hljs-attr">projectSessions</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(projectSessions)
  }));
}
</code></pre>
<h4 data-id="heading-10">3. 项目发现机制</h4>
<p>Claude Code 会把项目信息存在 <code>~/.claude/projects/</code> 目录下，目录名是项目路径的编码形式：</p>
<pre><code class="hljs language-perl" lang="perl">~<span class="hljs-regexp">/.claude/pr</span>ojects/
├── home-dev-project-a/
├── home-dev-<span class="hljs-keyword">my</span>-project/
└── Users-test-<span class="hljs-keyword">my</span>-app/
</code></pre>
<p>编码规则很简单：把 <code>/</code> 替换成 <code>-</code>。但解码就头疼了。</p>
<p>比如 <code>home-dev-my-project</code>，它可能是：</p>
<ul>
<li><code>/home/dev/my/project</code> —— 4 层目录</li>
<li><code>/home/dev/my-project</code> —— 3 层目录，最后一层本身带连字符</li>
</ul>
<p><strong>没法直接区分哪个 <code>-</code> 是原来的 <code>/</code>，哪个是路径本身就有的。</strong></p>
<p>一开始我想简单处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 简单粗暴，但是错的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decodePath</span>(<span class="hljs-params">encoded: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">'/'</span> + encoded.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'/'</span>);
}
<span class="hljs-comment">// home-dev-my-project -&gt; /home/dev/my/project ❌ 错！</span>
</code></pre>
<p>后来想到一个办法：<strong>穷举所有可能的组合，看哪个路径在文件系统里真实存在</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeProjectPath</span>(<span class="hljs-params">encodedPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> parts = encodedPath.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// ['home', 'dev', 'my', 'project']</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(<span class="hljs-string">''</span>, parts, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> result || <span class="hljs-string">`/<span class="hljs-subst">${encodedPath.replace(/-/g, <span class="hljs-string">'/'</span>)}</span>`</span>;  <span class="hljs-comment">// fallback</span>
}

<span class="hljs-comment">// 递归 + 回溯，尝试所有可能的路径组合</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findValidPath</span>(<span class="hljs-params">current: <span class="hljs-built_in">string</span>, parts: <span class="hljs-built_in">string</span>[], index: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (index &gt;= parts.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">existsSync</span>(current) ? current : <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 从 index 开始，尝试把连续的 parts 拼成一个目录名</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = index; i &lt; parts.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> segment = parts.<span class="hljs-title function_">slice</span>(index, i + <span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>);  <span class="hljs-comment">// 'my' 或 'my-project'</span>
    <span class="hljs-keyword">const</span> newPath = <span class="hljs-string">`<span class="hljs-subst">${current}</span>/<span class="hljs-subst">${segment}</span>`</span>;

    <span class="hljs-keyword">if</span> (i === parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 最后一段了，检查路径是否存在</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">existsSync</span>(newPath)) <span class="hljs-keyword">return</span> newPath;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 继续递归</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findValidPath</span>(newPath, parts, i + <span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (result) <span class="hljs-keyword">return</span> result;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>举个例子，对于 <code>home-dev-my-project</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">尝试 /home/dev/my/project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">false</span> ❌
尝试 /home/dev/my-project  → <span class="hljs-built_in">existsSync</span>() = <span class="hljs-literal">true</span>  ✅ 找到了！
</code></pre>
<p>本质就是暴力搜索，但因为目录层级不会太深，性能完全可以接受。</p>
<p><strong>有时候最笨的办法就是最好的办法</strong></p>
<h4 data-id="heading-11">4. 权限系统</h4>
<p>Claude Code 有权限控制，执行某些操作需要用户确认。在 CLI 里是交互式的，但在 Slack 里怎么办？</p>
<p>我做了个<strong>交互式卡片</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 当 Claude 需要权限时，发送一个带按钮的卡片</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPermissionCard</span>(<span class="hljs-params">channel: <span class="hljs-built_in">string</span>, tool: <span class="hljs-built_in">string</span>, input: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">chat</span>.<span class="hljs-title function_">postMessage</span>({
    channel,
    <span class="hljs-attr">blocks</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'section'</span>,
        <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'mrkdwn'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">`🔐 *需要权限确认*\n工具: <span class="hljs-subst">${tool}</span>`</span> }
      },
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'actions'</span>,
        <span class="hljs-attr">elements</span>: [
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'✅ 允许'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'approve'</span> },
          { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">text</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'plain_text'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'❌ 拒绝'</span> }, <span class="hljs-attr">action_id</span>: <span class="hljs-string">'deny'</span> }
        ]
      }
    ]
  });
}
</code></pre>
<p>用户点击按钮后，我再用更高权限重新执行请求。</p>
<h4 data-id="heading-12">5. Slack 斜杠命令</h4>
<p>光发消息还不够，我还想要一些快捷操作。Slack 的斜杠命令（Slash Commands）正好派上用场：</p>
<ul>
<li><code>/project</code> —— 切换项目</li>
<li><code>/stop</code> —— 停止当前正在执行的任务</li>
<li><code>/clear</code> —— 清除会话，重新开始</li>
</ul>
<p>实现分两层：</p>
<p><strong>第一层：Slack Adapter 注册命令</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册 /project 命令</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">command</span>(<span class="hljs-string">'/project'</span>, <span class="hljs-keyword">async</span> ({ command, ack }) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">ack</span>();  <span class="hljs-comment">// 必须在 3 秒内响应，否则 Slack 会报错</span>

  <span class="hljs-keyword">const</span> context = {
    <span class="hljs-attr">channelId</span>: command.<span class="hljs-property">channel_id</span>,
    <span class="hljs-attr">userId</span>: command.<span class="hljs-property">user_id</span>,
  };

  <span class="hljs-comment">// 触发交互处理</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> handler <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interactionHandlers</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">handler</span>(<span class="hljs-string">'show_project_selector'</span>, <span class="hljs-string">''</span>, context);
  }
});
</code></pre>
<p><strong>第二层：Message Processor 处理交互</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">handleInteraction</span>(<span class="hljs-params">action: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span>, context: MessageContext</span>) {
  <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'show_project_selector'</span>) {
    <span class="hljs-comment">// 展示项目选择卡片</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showProjectSelector</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'stop_execution'</span>) {
    <span class="hljs-comment">// 停止当前任务</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleStopExecution</span>(adapter, context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'clear_session'</span>) {
    <span class="hljs-comment">// 清除会话</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClearSession</span>(adapter, context);
  }
}
</code></pre>
<p><code>/stop</code> 的实现有点意思 —— 需要能够中断正在运行的 Claude 进程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleStopExecution</span>(<span class="hljs-params">adapter: IMAdapter, context: MessageContext</span>) {
  <span class="hljs-keyword">const</span> execution = <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeExecutions</span>.<span class="hljs-title function_">get</span>(context.<span class="hljs-property">channelId</span>);

  <span class="hljs-keyword">if</span> (!execution) {
    <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">sendMessage</span>(context.<span class="hljs-property">channelId</span>, <span class="hljs-string">'没有正在运行的任务。'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 标记为已中止，防止后续消息更新</span>
  execution.<span class="hljs-property">aborted</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 触发 AbortController</span>
  execution.<span class="hljs-title function_">abort</span>();

  <span class="hljs-keyword">await</span> adapter.<span class="hljs-title function_">updateMessage</span>(context.<span class="hljs-property">channelId</span>, execution.<span class="hljs-property">messageTs</span>, <span class="hljs-string">'🛑 已停止'</span>);
}
</code></pre>
<p>这里用了 <code>AbortController</code>，它是 Node.js 原生支持的中止信号机制。在启动 Claude 进程时传入 <code>abortSignal</code>，调用 <code>abort()</code> 就能优雅地终止进程。</p>
<p><strong>一个小细节</strong>：Slack 要求斜杠命令必须在 3 秒内响应（<code>ack()</code>），否则会显示错误。所以我先 <code>ack()</code>，再异步处理实际逻辑。这样用户体验会好很多。</p>
<h3 data-id="heading-13">😱 踩坑实录：那些让我头秃的问题</h3>
<h4 data-id="heading-14">坑 1：Bun + Slack WebSocket = 💥</h4>
<p>我一开始用 Bun 来开发，build 也用 Bun。结果发现一个诡异的问题：Slack 的 Socket Mode 在 Bun 运行时下经常断连。</p>
<p>排查了半天，发现是 Bun 的 WebSocket 实现和 <code>@slack/bolt</code> 不太兼容。</p>
<p><strong>解决方案</strong>：开发时用 <code>tsx</code>（Node.js 运行时），生产构建用 Bun 打包但改成 Node.js 的 shebang：</p>
<pre><code class="hljs language-bash" lang="bash">bun build ./src/cli.ts --outdir ./dist --target node &amp;&amp; \
sed -i <span class="hljs-string">'1s|#!/usr/bin/env bun|#!/usr/bin/env node|'</span> ./dist/cli.js
</code></pre>
<p>是的，有点丑陋，但它能用。</p>
<h4 data-id="heading-15">坑 2：Slack 消息长度限制</h4>
<p>Slack 单条消息最大 40KB（实际建议 38KB 以内）。但 Claude 有时候会输出很长的内容，特别是它在解释代码的时候。</p>
<p>直接截断？不行，可能截到一半把 markdown 格式搞坏了。</p>
<p><strong>解决方案</strong>：按字节长度截断，并确保截断点不在多字节字符中间：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">truncateToByteLength</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span>, maxBytes: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
  <span class="hljs-keyword">const</span> encoded = encoder.<span class="hljs-title function_">encode</span>(str);

  <span class="hljs-keyword">if</span> (encoded.<span class="hljs-property">length</span> &lt;= maxBytes) <span class="hljs-keyword">return</span> str;

  <span class="hljs-comment">// 找到合适的截断点</span>
  <span class="hljs-keyword">let</span> truncated = encoded.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, maxBytes);
  <span class="hljs-comment">// 确保不截断 UTF-8 多字节字符</span>
  <span class="hljs-keyword">while</span> (truncated.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; (truncated[truncated.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xc0</span>) === <span class="hljs-number">0x80</span>) {
    truncated = truncated.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(truncated) + <span class="hljs-string">'\n\n... (内容过长，已截断)'</span>;
}
</code></pre>
<h4 data-id="heading-16">坑 3：Markdown 格式转换</h4>
<p>Claude 输出的是标准 Markdown，但 Slack 用的是自己的 <code>mrkdwn</code> 格式。两者语法不一样：</p>

























<table><thead><tr><th>Markdown</th><th>Slack mrkdwn</th></tr></thead><tbody><tr><td><code>**bold**</code></td><td><code>*bold*</code></td></tr><tr><td><code>*italic*</code></td><td><code>_italic_</code></td></tr><tr><td><code>[text](url)</code></td><td><code>&lt;url|text&gt;</code></td></tr><tr><td><code>`code`</code></td><td><code>`code`</code></td></tr></tbody></table>
<p>我写了个转换函数，处理这些差异。但最坑的是代码块 —— Slack 对代码块的渲染很奇怪，超过一定长度就会出问题。</p>
<p><strong>最终方案</strong>：长代码不放在消息里，而是上传成代码片段（Snippet）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (codeBlock.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2000</span>) {
  <span class="hljs-keyword">await</span> slack.<span class="hljs-property">files</span>.<span class="hljs-title function_">uploadV2</span>({
    <span class="hljs-attr">channel_id</span>: channel,
    <span class="hljs-attr">content</span>: codeBlock,
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'code.txt'</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Code Output'</span>
  });
}
</code></pre>
<h4 data-id="heading-17">坑 4：语音消息支持</h4>
<p>既然是在手机上用，那支持语音消息岂不是更方便？说一句话就能让 Claude 干活。</p>
<p>我集成了 <code>whisper.cpp</code> 做语音转文字：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transcribe</span>(<span class="hljs-params">audioPath: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-comment">// 先用 ffmpeg 转换成 whisper 需要的格式</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`ffmpeg -i <span class="hljs-subst">${audioPath}</span> -ar 16000 -ac 1 -f wav <span class="hljs-subst">${wavPath}</span>`</span>);

  <span class="hljs-comment">// 调用 whisper</span>
  <span class="hljs-keyword">const</span> { stdout } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">exec</span>(<span class="hljs-string">`whisper-cli -m <span class="hljs-subst">${modelPath}</span> -f <span class="hljs-subst">${wavPath}</span>`</span>);
  <span class="hljs-keyword">return</span> stdout.<span class="hljs-title function_">trim</span>();
}
</code></pre>
<p>但这里又有坑：Slack 发来的语音是 <code>.mp4</code> 格式，需要先下载再转换。而且 whisper 模型挺大的，第一次运行要下载...</p>
<h4 data-id="heading-18">坑 5：进程管理</h4>
<p>作为一个后台服务，进程管理是必须的：</p>
<ul>
<li>如何优雅地启动/停止？</li>
<li>如何检测服务是否在运行？</li>
<li>如何处理僵尸进程？</li>
</ul>
<p>我用 PID 文件 + 信号量来管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> pid = <span class="hljs-title function_">readPidFile</span>();
  <span class="hljs-keyword">if</span> (!pid) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 先尝试优雅退出</span>
  process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGTERM'</span>);

  <span class="hljs-comment">// 等待 5 秒</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);

  <span class="hljs-comment">// 如果还在运行，强制杀掉</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRunning</span>(pid)) {
    process.<span class="hljs-title function_">kill</span>(pid, <span class="hljs-string">'SIGKILL'</span>);
  }
}
</code></pre>
<h3 data-id="heading-19">✨ 最终效果</h3>
<p>折腾了两天，终于能用了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
npm install -g chat-heimerdinger

<span class="hljs-comment"># 初始化配置</span>
hmdg init

<span class="hljs-comment"># 启动服务</span>
hmdg start
</code></pre>
<p>然后在 Slack 里：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9bbf37e25a444669824261a7208d970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=6LgEiu2tVnnnd%2BhdBn0%2Bn9c4N5c%3D" alt="2db91133029cfc157e7dbbcea5630576.jpg" loading="lazy"/></p>
<p><strong>或者直接发语音</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac7f7df145434743a566bd802a638a7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=ixMQg9iJqc%2FEf3cGoLTtujlh7Zo%3D" alt="cae84620508677ae00533e3fc5d68573.jpg" loading="lazy"/></p>
<p>蹲在马桶上，动动手指，代码就改好了。Vibe coding，永不断档！</p>
<p>如果不确定Claude code的改动是否正确，每次对话的thread里还有本次修改的diff</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65803658919e4b7aac248bfe5cc51f09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yiu5raC5bGCX-i1ouWkp-Wllg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197474&amp;x-signature=h3YTO9ioCZIu0xzerH%2Fk7UMCPWo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-20">写在最后</h3>
<p><strong>工具的价值在于节省时间。</strong> 虽然开发这个工具花了我两个整天，但以后每次蹲坑时继续 vibe coding 省下的时间，迟早会赚回来的（大概）。</p>
<p>slack目前支持已经基本完善，但飞书我是盲调的（公司内网有防火墙，连不到飞书的socket，所以飞书的不保证可用，后续我还会继续调整）。后续我还会考虑支持上钉钉、企微、微信，<strong>让更多的IM工具都能实现马桶vibe coding</strong>。</p>
<hr/>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fa1245582339%2Fchat-heimerdinger" target="_blank" title="https://github.com/a1245582339/chat-heimerdinger" ref="nofollow noopener noreferrer">GitHub - chat-heimerdinger</a></p>
<p>如果觉得有用，欢迎 Star ⭐</p>
<p>有问题欢迎评论区交流，我会尽量回复（如果我不是在厕所里指挥 Claude 干活的话）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一]]></title>    <link>https://juejin.cn/post/7599852579066871823</link>    <guid>https://juejin.cn/post/7599852579066871823</guid>    <pubDate>2026-01-27T08:05:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599852579066871823" data-draft-id="7599852579066855439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-27T08:05:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="歪斯Wise"/> <meta itemprop="url" content="https://juejin.cn/user/3156074412913466"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里千问最强模型来了！性能比肩GPT-5.2-Thinking、Claude-Opus-4.5、Gemini 3 Pro，4项基准测试排名第一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3156074412913466/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    歪斯Wise
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T08:05:51.000Z" title="Tue Jan 27 2026 08:05:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a12665ba8b4200b0fd8a00acaf8217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=oYlyuk2xMrbkB%2Fw%2BNh8xOE10wY8%3D" alt="" loading="lazy"/></p>
<p>昨天晚上，阿里悄然发布了一款新模型，Qwen3-Max-Thinking。这个模型的参数规模超过了1万亿，预训练数据达到36T tokens。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9064009a6134b0a928469eee32ab4eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=Z4pdkUwC3oqsd%2FOHGUsxUVGd14g%3D" alt="" loading="lazy"/></p>
<p>在19项权威基准测试中，其性能可媲美GPT-5.2-Thinking、Claude-Opus-4.5 和Gemini 3 Pro等顶尖模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24c3d976a7de422b952170b0190c6ba0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=eUEe5Ja7Hnqjo9BsqxVaNWrq2MA%3D" alt="" loading="lazy"/></p>
<p>上图是我重制后的表格,我们可以看到在4项基准测试中，千问的表现超过了GPT-5.2、Claude Opus 4.5和Gemini 3 Pro等頂尖模型，刷新了全球的记录，获得了第一。</p>
<p>这4项测试分别是C-Eval、HMMT Nov 2025、HLE (w/ tools)、Arena-Hard v2。</p>
<p>C-Eval第一，说明模型在中文理解、知识检索以及表述更强，Qwen超越了国外顶级模型的表现。</p>
<p>它让模型在理解用户问题的时候更容易抓住重点，能够按照中文的语义拆解问题，结合Arena-Hard，它能让同样的输入能够获得更完整、更少废话更接近人类偏好的回答。</p>
<p>HMMT Nov 25是哈佛和麻省理工数学锦标赛，它用来测试模型的高强度数学推理/解题能力，排名第一说明模型在复杂推理、多条件推导的情况会变得更强，通过提示词写代码逻辑容错性更高了。</p>
<p>而HLE拿到第一，可能对我们的作用更大，它是一个更聪明的智能体，会更懂规划，更会使用工具。</p>
<h2 data-id="heading-0">Qwen3-Max-Thinking这一次的创新是什么？</h2>
<h2 data-id="heading-1">1、自适应工具调用的能力</h2>
<p>模型调用工具的概念其实不新鲜了，最早期就开始有了Function Call，让模型能够去自主调用工具。但以前更多的时候工具的开关是掌握在用户手里，而现在是掌握在模型手里。</p>
<p>如果说GPT的创新是教会了模型遵循人类的指令，那千问可能是教会了模型在什么时候选择什么工具，以及基于用得好不好做了定向的训练。</p>
<p>根据官方的说明，而在搜索工具以往的幻觉、失忆老问题也得到了解决。</p>
<h2 data-id="heading-2">2、测试时扩展技术</h2>
<p>这个技术简单的说，是让模型聚焦在没有解决的问题。如果它已经知道这件事就不会再重复推导了。</p>
<p>这件事的原因是，传统的做法是并行多个任务进行推理，然后选择最优的那一条，增加推理能力很多时候是增加推理任务，但这种问题是每条推理路径可能是相同的，那这时候就会造成了浪费。</p>
<p>而Qwen拒绝无休止的多开任务，它限制了任务的数量，用少量并行和多轮迭代把任务做得更深，省下来的计算预算，用来做经验提取和自我反思。</p>
<p>通过这种方式实现更高的上下文利用效率，前两周Deepseek 的Engma机制解决了通识查询的问题，这次Qwen解决了推理效率的问题</p>
<p>在相同Token的消耗下</p>
<pre><code class="hljs">GPQA（研究生级问答/高难知识推理）：90.3 → 92.8（+2.5）HLE（高难长程推理）：34.1 → 36.5（+2.4）LiveCodeBench v6（真实编码能力）：88.0 → 91.4（+3.4）IMO-AnswerBench（奥数风格推理/答案准确）：89.5 → 91.5（+2.0）HLE（w/ tools，带工具的高难推理）：55.8 → 58.3（+2.5）
</code></pre>
<p>长程推理的分值提升，避免了在长链路推理跑偏或者自相矛盾，真实编程能力让代码的效率更高了，而且还有了类似奥数式的精细推理，结合更好的工具使用能力帮助我们完成任务。</p>
<h2 data-id="heading-3">来一次实测吧</h2>
<p>在中文理解的部分</p>
<pre><code class="hljs">Prompt：帮我写一条回复给朋友的消息，拒绝他的借钱，要求：语气：真诚但坚定，不怯懦结构：3 段，每段不超过 2 句禁用词：不能出现“但是”“抱歉”“可能”“不方便”必须包含：给出一个替代帮助方式（非借钱）
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccfd3453ff7b42769f494c14e4d1810a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=HEc%2FrK9xg%2BOsVIiD%2BYz4mcj1jbs%3D" alt="" loading="lazy"/></p>
<p>我把国产的模型都测了1次，Qwen和Kimi的表现明显要更好，在借钱这种很难聊的场景，再顶尖的国外模型表现还是略差一些。</p>
<p>在联网查询+简单数学计算+中文理解部分</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Prompt：今天是</span> <span class="hljs-number">2026-01-27</span><span class="hljs-string">（背景时间）。请你使用搜索确认：2026</span> <span class="hljs-string">年中国下一个公共假期的名称和日期，并给出引用来源。然后计算：从</span> <span class="hljs-number">2026-01-27</span> <span class="hljs-string">到这个假期还有多少天（按自然日计算）。最后用</span> <span class="hljs-number">2</span> <span class="hljs-string">句话告诉我：这个假期适合做什么“低成本”活动（别写旅游攻略）。</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a16bbba5174d460dab07d44a44e70bb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2q5pavV2lzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770105951&amp;x-signature=ddVAfjOBpMhn%2F4p5AMwgG9aYY5Y%3D" alt="" loading="lazy"/></p>
<p>联网搜索和数据计算部分，二者表现相当，但GPT在怎么低成本过春节的部分，是让我去合照和年夜饭火锅，Qwen会更贴合中文语境，包饺子、贴春联还有视频拜年。</p>
<p>更多的案例可以看乔帮主的测试。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzAwODIyOTQ4Mw%3D%3D%26mid%3D2649446478%26idx%3D1%26sn%3D96ce658c531e79d329c89c3f481f8793%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzAwODIyOTQ4Mw==&amp;mid=2649446478&amp;idx=1&amp;sn=96ce658c531e79d329c89c3f481f8793&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我用阿里Qwen3 Max Thinking测了5个问题，彻底服气了</a></p>
<p>今天的分享就到这里了，文章没写完DeepseekOCR2，还有Kimi K2.5都来了，跟不上了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA 里终于能爽用 Claude Code了！]]></title>    <link>https://juejin.cn/post/7599975633478647846</link>    <guid>https://juejin.cn/post/7599975633478647846</guid>    <pubDate>2026-01-28T09:31:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599975633478647846" data-draft-id="7600068892988424202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA 里终于能爽用 Claude Code了！"/> <meta itemprop="keywords" content="Java,IntelliJ IDEA"/> <meta itemprop="datePublished" content="2026-01-28T09:31:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA 里终于能爽用 Claude Code了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:31:25.000Z" title="Wed Jan 28 2026 09:31:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是 JetBrains 家 IDE 的重度用户，大概率有过这样的体验：想用 Claude Code、Codex 这类终端 AI 工具时，只能在 Terminal 里跑着用。这些 CLI 工具虽强大，但缺少原生 UI 交互，体验上有些局限。虽然可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGYaq_HNo5mKh2WjWtuEMyg" target="_blank" title="https://mp.weixin.qq.com/s/GYaq_HNo5mKh2WjWtuEMyg" ref="nofollow noopener noreferrer">Claude Code UI 类开源项目</a>来缓解，如 vibe kanban、1Code，但在写代码这件事上，没有什么比“在熟悉的 IDE 面板里直接对话”更爽了。</p>
<p>2025 年底，JetBrains 给 AI Assistant 插件更新了一个重磅功能：<strong>支持自定义 ACP（Agent Client Protocol）配置</strong>。这意味着你现在可以把任何支持 ACP 的 Agent 接入到 AI Assistant 里，包括 Claude Code。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b21adaa0ed1472f9d1999a7dd3b10d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=5EWb%2BjUyPlFLZS672hu19jqWQNg%3D" alt="" loading="lazy"/></p>
<p>这篇文章 Guide 就来手把手带大家在 IDEA 里通过 ACP 爽用 Claude Code，希望能给喜欢 IDEA 的朋友提供一个不一样选择。</p>
<blockquote>
<p><strong>需要注意</strong>：目前 ACP 还是 Beta 版，体验上可能存在一些小问题，Guide 在周末用了之后整体感觉还是很不错的。</p>
</blockquote>
<h2 data-id="heading-0">ACP 是什么？</h2>
<p>ACP 全称 <strong>Agent Client Protocol</strong>，是一个开放协议，用来规范 AI Agent 与代码编辑器/IDE 之间的通信方式。它类似于 Language Server Protocol (LSP)，但专注于 AI 代理的集成，帮助开发者在不同编辑器中使用各种 AI 工具，而无需为每个组合构建自定义适配器。</p>
<p>简单理解，它就是一个让 AI Agent 和 IDE "即插即用"的通用接口——就像 USB-C 之于设备连接一样。</p>
<p>ACP 由 Zed Industries（Zed 编辑器的开发者）主导开发，与 Anthropic、Google 等合作，JetBrains 目前也加入了。</p>
<h3 data-id="heading-1">为什么需要 ACP？</h3>
<p>在没有 ACP 之前，每个 AI Agent 想接入某个 IDE，都需要单独开发适配器。Claude Code 要写一套，Cursor 要写一套，Windsurf 也要写一套——重复造轮子，而且一旦 Agent 更新，适配器还得跟着改。</p>
<p>ACP 的核心思路是：<strong>定义一套标准的通信协议，任何 Agent 只要实现了 ACP Server，任何 IDE 只要实现了 ACP Client，两者就能直接对接</strong>。</p>
<p>关于 ACP 更详细的介绍，可以查看官方文档：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentclientprotocol.com%2Foverview%2Fintroduction" target="_blank" title="https://agentclientprotocol.com/overview/introduction" ref="nofollow noopener noreferrer">agentclientprotocol.com/overview/in…</a></strong> 。</p>
<h3 data-id="heading-2">生态现状</h3>
<p>目前加入 ACP 生态的成员包括：</p>
<ul>
<li><strong>IDE 端</strong>：JetBrains 全家桶、Zed 等。</li>
<li><strong>Agent 端</strong>：Claude Code、Codex、Gemini CLI、Kimi CLI、Qoder CLI 等。</li>
</ul>
<p>就连 Docker 也在 2025 年 11 月 13 日宣布将其开源多代理运行时 cagent 内置到 Docker Desktop，并支持 Agent Client Protocol (ACP)，以实现 AI 代理与 IDE/编辑器（如 Zed、VS Code）的无缝集成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcdb19228b9d477fb28062cb87937e1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=4Q2bHBMysasvJxqvmj%2FzHrrwXCw%3D" alt="" loading="lazy"/></p>
<p>这意味着可以在容器化环境中运行 AI 代理，简化开发工作流，如代码生成、测试和重构，同时保持容器隔离性。</p>
<h3 data-id="heading-3">技术原理</h3>
<p>ACP 底层基于 <strong>JSON-RPC 2.0</strong> 协议（与 LSP 完全相同），Agent 作为 Server 运行一个独立的进程，IDE 通过 stdin/stdout 与之通信。好处是 Agent 不需要被打包进 IDE 插件里，保持独立性和可维护性。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph IDE["IDE (ACP Client)"]
        AIAI["AI Assistant&lt;br/&gt;Plugin"]
    end

    subgraph ACP_Agent["ACP Agent Process"]
        ACPServer["ACP Server&lt;br/&gt;JSON-RPC"]
        LLM["AI Backend&lt;br/&gt;(Claude/GPT/...)"]
        Tools["MCP Tools&lt;br/&gt;Filesystem/Git/..."]
    end

    AIAI &lt;--&gt;|"stdin/stdout&lt;br/&gt;JSON-RPC"| ACPServer
    ACPServer --&gt; LLM
    ACPServer --&gt; Tools
</code></pre>
<h2 data-id="heading-4">前置条件</h2>
<p>要在 IDEA 里用 ACP 接入 Claude Code，需要满足：</p>
<ol>
<li><strong>IDE 版本</strong>：IntelliJ IDEA 2024.2 到 2025.3.x 或更高版本。ACP 支持从 2025 年底开始逐步集成，确保你的 IDEA 已更新到支持 ACP 的构建。</li>
<li><strong>AI Assistant 插件</strong>：确保已安装并启用</li>
<li><strong>Claude Code</strong>：已安装并能正常运行</li>
<li><strong>claude-code-acp</strong>：Zed 提供的 ACP 适配器（下文会讲如何安装）</li>
</ol>
<p>你可以检查 AI Assistant 插件版本，在 <code>File &gt; Settings &gt; Plugins</code> 里搜索 "JetBrains AI Assistant"，确认版本号在 2025.12 之后。</p>
<h2 data-id="heading-5">配置 ACP</h2>
<h3 data-id="heading-6">第一步：找到配置入口</h3>
<p>打开 AI Assistant 的聊天面板，点击右上角选择下拉框，你会看到 <strong>「配置 ACP 智能体」</strong> 选项。</p>
<p>点击后，IDE 会自动打开一个 <code>acp.json</code> 配置文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366cba9af1444df9b10a3ea4a6022a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=XdD02417833414koz9HlgJMWhSY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">第二步：安装 claude-code-acp</h3>
<p>Zed 官方提供了一个 ACP 适配器 <code>@zed-industries/claude-code-acp</code>，用来桥接 Claude Code 和 ACP 协议。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm install -g @zed-industries/claude-code-acp
</code></pre>
<p>注意必须用 <code>-g</code> 全局安装，这样 ACP Server 才能作为独立命令被调用。</p>
<p>安装完成后，你会在全局 bin 目录里看到 <code>claude-code-acp</code> 命令。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global          store
</code></pre>
<h3 data-id="heading-8">第三步：编辑 acp.json</h3>
<p>在 <code>acp.json</code> 中添加 Claude Code 的配置：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>注意将路径替换为你本地的，或者将其添加到环境变量中。</p>
<p>保存文件后，回到 AI Assistant 的聊天面板，再次点击模型选择下拉框，你应该能看到 <strong>Claude Code</strong> 出现在列表里了。</p>
<h2 data-id="heading-9">爽用 Claude Code</h2>
<h3 data-id="heading-10">基础对话</h3>
<p>选择 Claude Code 作为 Agent 后，你就可以像用内置 Claude 一样进行对话：</p>
<ul>
<li>代码编写</li>
<li>代码解释</li>
<li>Bug 诊断</li>
<li>重构建议</li>
<li>生成单元测试</li>
</ul>
<p>这个周末，我就通过这种方式成功重构优化了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>这个项目：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/698b720bea144c17965a8323ca3f9443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=84ysSaJ5K4uwWlPAjH7pOyniYLE%3D" alt="" loading="lazy"/></p>
<p>这个项目的配套实战项目教程正在更新，涉及到 Prompt Engineering、大模型集成、RAG（检索增强生成）、高性能对象存储与向量数据库。后续的话，还会同步上Agent 项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da03c8521a574eb1a8e5f6c8f81b43b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=gSrToHuo58ck3OhKyIAQoRyCEKY%3D" alt="" loading="lazy"/></p>
<p>内容非常全面，非常适合想要实战 AI 项目或者准备 AI 大模型应用开发岗位面试的朋友，来一张刚写完的<strong>3.4w 字+35 道题目</strong>的 RAG 面试题总结，大家感受一下（点此链接了解： <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fabout-the-author%2Fzhishixingqiu-two-years.html" target="_blank" title="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html" ref="nofollow noopener noreferrer">星球</a>）：</p>
<h3 data-id="heading-11">模式和模型选择</h3>
<p>Claude Code 的 ACP 模式会识别你原本配置的所有设置，包括：</p>
<ol>
<li><strong>模式选择</strong>：Plan 模式、Code 模式等</li>
<li><strong>模型选择</strong>：claude-sonnet-4.5、claude-opus-4.5 等</li>
<li><strong>第三方中转站</strong>：如果你配置了自定义 API 地址，也会生效</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d34ba5ea908473a95f4dd44e604f8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=zO9ZIrJE7WJQMYu%2FRlrGyXGeDNE%3D" alt="" loading="lazy"/></p>
<p>可以看到我这里目前就成功对接了第三方 GLM 模型，这个在国内也是用的人比较多的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e775f898014550a526b502f13bcba8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770197598&amp;x-signature=2Qn%2By8xyQpDMOmJRQr3nlXOZcX0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">MCP 工具支持</h3>
<p>这是 ACP 方式相比内置 Agent 的最大优势——<strong>完整支持 MCP（Model Context Protocol）工具</strong>。</p>
<p>MCP 是 Anthropic 推出的另一个协议，用来让 LLM 接入外部工具和数据源。比如你可以配置：</p>
<ul>
<li><strong>文件系统工具</strong>：让 Agent 读写项目文件</li>
<li><strong>Git 工具</strong>：让 Agent 执行 commit、diff 操作</li>
<li><strong>数据库工具</strong>：让 Agent 查询生产环境数据</li>
<li><strong>自定义 API</strong>：接入公司内部服务</li>
</ul>
<p>用 ACP 接入 Claude Code 后，这些 MCP 工具都会被识别并可用。而 AI Assistant 内置的 Claude Agent 只能识别第三方 API 地址，MCP 工具是<strong>不支持</strong>的。</p>
<h2 data-id="heading-13">ACP vs 内置 Agent：如何选择？</h2>













































<table><thead><tr><th><strong>特性</strong></th><th><strong>ACP (Claude Code + Adapter)</strong></th><th><strong>IDEA 内置 Claude Agent (官方/三方插件)</strong></th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>终端驱动的任务型机器人 (Task-Oriented)</td><td>侧边栏对话型助手 (Chat-Oriented)</td></tr><tr><td><strong>MCP 工具支持</strong></td><td><strong>✅ 完整原生支持</strong> (可调用本地 Python/DB 等)</td><td><strong>❌ 支持有限</strong> (多局限于 IDE 内部 API)</td></tr><tr><td><strong>模型灵活性</strong></td><td><strong>✅ 极高</strong> (自由切换 3.5 Sonnet / 3.7 / Opus)</td><td><strong>⚠️ 受限</strong> (通常绑定插件商提供的特定版本)</td></tr><tr><td><strong>API 兼容性</strong></td><td><strong>✅ 支持</strong> 中转站 / OneAPI 等自定义 Endpoint</td><td><strong>⚠️ 部分支持</strong> (官方插件常强制要求官方 Key)</td></tr><tr><td><strong>工作模式</strong></td><td><strong>✅ 拥有 Plan / Act 独立模式</strong></td><td><strong>❌ 主要是单轮或多轮对话</strong></td></tr><tr><td><strong>环境上下文</strong></td><td><strong>✅ 强</strong> (通过 MCP 直接读取系统/库文档)</td><td><strong>✅ 强</strong> (深度集成 IDE 索引，理解代码库)</td></tr><tr><td><strong>配置门槛</strong></td><td><strong>较高</strong> (需要配置 Node 环境及 Proxy)</td><td><strong>极低</strong> (插件市场一键安装)</td></tr></tbody></table>
<p><strong>建议</strong>：</p>
<ul>
<li>如果你<strong>需要 MCP 工具</strong>，必须用 ACP 方式</li>
<li>如果你<strong>习惯 Claude Code 的 Plan 模式</strong>，用 ACP 更顺手</li>
<li>如果你<strong>想要开箱即用</strong>，内置 Agent 更省心</li>
</ul>
<h2 data-id="heading-14">接入其他 Agent</h2>
<p>除了 Claude Code，你也可以接入其他支持 ACP 的 Agent。比如 Gemini CLI (Google) 、 Cagent (Docker)：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agent_servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Claude Code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/guide/Library/pnpm/claude-code-acp"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Gemini CLI"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gemini-acp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--model"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"gemini-2.0-pro"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Docker Cagent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cagent"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"acp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"agent.yml"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-15">踩坑与排查</h2>
<h3 data-id="heading-16">ACP 初始化失败</h3>
<p>JetBrains AI Assistant 无法运行 "pnpm" 命令（<code>IOException: Cannot run program "pnpm", error=2, No such file or directory</code>）。</p>
<pre><code class="hljs language-bash" lang="bash">❯ pnpm bin -g
/Users/guide/Library/pnpm
❯ <span class="hljs-built_in">ls</span> /Users/guide/Library/pnpm
claude-code-acp global
</code></pre>
<p>注意将 command 路径替换为你本地的，或者将其添加到环境变量中。</p>
<h3 data-id="heading-17">Agent 无响应</h3>
<p>如果选择 Agent 后聊天没反应：</p>
<ol>
<li>检查 Agent 进程是否启动：<code>ps aux | grep claude-code-acp</code></li>
<li>查看 AI Assistant 的日志：<code>Help &gt; Show Log in Finder</code></li>
<li>确认 Claude Code 本身能正常在终端运行</li>
</ol>
<h2 data-id="heading-18">总结</h2>
<p>ACP 目前还处于快速发展阶段，2025 年底才正式进入 Beta。有几个值得期待的方向：</p>
<ol>
<li><strong>更多 Agent 支持</strong>：Cursor、Windsurf 等热门 AI 工具可能会推出 ACP Server</li>
<li><strong>Per-Project 配置</strong>：JetBrains 的 Issue 追踪显示，他们正在计划支持项目级别的 ACP 配置</li>
<li><strong>社区生态</strong>：随着协议开放，可能会出现更多第三方 Agent</li>
</ol>
<p>如果你是 JetBrains IDE 的重度用户，又不太喜欢在终端环境使用 Claude Code ，或者你需要 MCP 工具的强大能力，那么 ACP 就是目前的终极解决方案。</p>
<p>虽然配置稍微麻烦一点，但一旦搞定，你就能在熟悉的 IDE 环境里获得：</p>
<ul>
<li>稳定的 UI 体验</li>
<li>完整的 Claude Code 功能</li>
<li>MCP 工具的加持</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）]]></title>    <link>https://juejin.cn/post/7599579865609076778</link>    <guid>https://juejin.cn/post/7599579865609076778</guid>    <pubDate>2026-01-27T07:56:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599579865609076778" data-draft-id="7599579865608912938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）"/> <meta itemprop="keywords" content="Android,Kotlin,架构"/> <meta itemprop="datePublished" content="2026-01-27T07:56:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SystemUI 开发之 NSSL.addContainerView() 之后发生了什么（八）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T07:56:49.000Z" title="Tue Jan 27 2026 07:56:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前文的代码追踪中 <strong><code>NotificationViewHierarchyManager</code></strong> 将 <code>ExpandableNotificationRow</code> 通过<code>addContainerView</code> 方法传给了<code>NotificationStackScrollLayout</code> 并使用 <code>addView</code> 添加到子<code>View</code>中。接下来看看这一个过程。</p>
<h2 data-id="heading-0">0x00、<code>NSSL.addContainerView()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addContainerView</span><span class="hljs-params">(View v)</span> {
    Assert.isMainThread();
    addView(v);
}
</code></pre>
<h2 data-id="heading-1">0x01、<code>ViewGroup.addView()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View child)</span> {
    addView(child, -<span class="hljs-number">1</span>);
}

...

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> index, LayoutParams params)</span> {
    <span class="hljs-keyword">if</span> (DBG) {
        System.out.println(<span class="hljs-built_in">this</span> + <span class="hljs-string">" addView"</span>);
    }

    <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Cannot add a null child view to a ViewGroup"</span>);
    }

    <span class="hljs-comment">// addViewInner() will call child.requestLayout() when setting the new LayoutParams</span>
    <span class="hljs-comment">// therefore, we call requestLayout() on ourselves before, so that the child's request</span>
    <span class="hljs-comment">// will be blocked at our level</span>
    <span class="hljs-comment">// 1、执行了requstLayout</span>
    requestLayout();
    invalidate(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 2、执行 addView 操作</span>
    addViewInner(child, index, params, <span class="hljs-literal">false</span>);
}
</code></pre>
<p><code>ViewGroup.addView()</code> 会执行到 <code>requestLayout()</code> 中来</p>
<h3 data-id="heading-2">1、<code>View.requestLayout()</code></h3>
<p><code>requestLayout()</code> 会不停地向上查找直到 <code>ViewRootImpl</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mMeasureCache != <span class="hljs-literal">null</span>) mMeasureCache.clear();

    <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Only trigger request-during-layout logic if this is the view requesting it,</span>
        <span class="hljs-comment">// not the views in its parent hierarchy</span>
        <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">viewRoot</span> <span class="hljs-operator">=</span> getViewRootImpl();
        <span class="hljs-keyword">if</span> (viewRoot != <span class="hljs-literal">null</span> &amp;&amp; viewRoot.isInLayout()) {
            <span class="hljs-keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="hljs-built_in">this</span>)) {
                <span class="hljs-keyword">return</span>;
            }
        }
        mAttachInfo.mViewRequestingLayout = <span class="hljs-built_in">this</span>;
    }

    mPrivateFlags |= PFLAG_FORCE_LAYOUT;
    mPrivateFlags |= PFLAG_INVALIDATED;

    <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span> &amp;&amp; !mParent.isLayoutRequested()) {
		    <span class="hljs-comment">// 开始向上回溯</span>
        mParent.requestLayout();
    }
    <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-built_in">this</span>) {
        mAttachInfo.mViewRequestingLayout = <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-3">2、<code>ViewRootImpl.requestLayout()</code></h3>
<p>在 <code>ViewRootImpl</code> 中执行了 <code>scheduleTraversals()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) {
        checkThread();
        mLayoutRequested = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 又到了这个非常著名的方法了</span>
        scheduleTraversals();
    }
}

<span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// 发送同步屏障</span>
        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
        <span class="hljs-comment">// 注册 VSYNC 信号，监听回调触发UI渲染</span>
        mChoreographer.postCallback(
                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);
        notifyRendererOfFramePending();
        pokeDrawLockIfNeeded();
    }
}
</code></pre>
<p>在 <code>mTraversalRunnable</code> 回调中最后执行 <code>doTraversal()</code> ，在此方法中执行了 <code>performTraversals()</code> ，就在这个方法中触发<code>measure</code>、<code>layout</code> 和 <code>draw</code> 的操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">doTraversal</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mTraversalScheduled) {
        mTraversalScheduled = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 移除同步屏障</span>
        mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

        <span class="hljs-keyword">if</span> (mProfile) {
            Debug.startMethodTracing(<span class="hljs-string">"ViewAncestor"</span>);
        }
				<span class="hljs-comment">// 执行 measure、layout、draw 三大操作</span>
        performTraversals();

        <span class="hljs-keyword">if</span> (mProfile) {
            Debug.stopMethodTracing();
            mProfile = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p>这个过程可以简化如下：</p>
<p><code>addView</code>→ <code>requestLayout</code> → <code>scheduleTraversals</code> →监听<code>VSYNC</code>→ <code>doTraversal</code> → <code>performTraversals</code> → <code>measure</code> + <code>layout</code> + <code>draw</code></p>
<h3 data-id="heading-4">3、<code>ViewGroup.addViewInner()</code></h3>
<p>接下来在 <code>addViewInner</code> 方法中触发了 <code>dispatchViewAdded</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addViewInner</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> index, LayoutParams params,
        <span class="hljs-type">boolean</span> preventRequestLayout)</span> {

    ...
    addInArray(child, index);

    <span class="hljs-comment">// tell our children</span>
    <span class="hljs-keyword">if</span> (preventRequestLayout) {
        child.assignParent(<span class="hljs-built_in">this</span>);
    } <span class="hljs-keyword">else</span> {
        child.mParent = <span class="hljs-built_in">this</span>;
    }
    <span class="hljs-keyword">if</span> (child.hasUnhandledKeyListener()) {
        incrementChildUnhandledKeyListeners();
    }

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">childHasFocus</span> <span class="hljs-operator">=</span> child.hasFocus();
    <span class="hljs-keyword">if</span> (childHasFocus) {
        requestChildFocus(child, child.findFocus());
    }

    <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> mAttachInfo;
    <span class="hljs-keyword">if</span> (ai != <span class="hljs-literal">null</span> &amp;&amp; (mGroupFlags &amp; FLAG_PREVENT_DISPATCH_ATTACHED_TO_WINDOW) == <span class="hljs-number">0</span>) {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">lastKeepOn</span> <span class="hljs-operator">=</span> ai.mKeepScreenOn;
        ai.mKeepScreenOn = <span class="hljs-literal">false</span>;
        child.dispatchAttachedToWindow(mAttachInfo, (mViewFlags&amp;VISIBILITY_MASK));
        <span class="hljs-keyword">if</span> (ai.mKeepScreenOn) {
            needGlobalAttributesUpdate(<span class="hljs-literal">true</span>);
        }
        ai.mKeepScreenOn = lastKeepOn;
    }

    <span class="hljs-keyword">if</span> (child.isLayoutDirectionInherited()) {
        child.resetRtlProperties();
    }
		<span class="hljs-comment">// 分发添加</span>
    dispatchViewAdded(child);

    ...
}
</code></pre>
<p>进入了 <code>dispatchViewAdded()</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchViewAdded</span><span class="hljs-params">(View child)</span> {
    onViewAdded(child);
    <span class="hljs-keyword">if</span> (mOnHierarchyChangeListener != <span class="hljs-literal">null</span>) {
        mOnHierarchyChangeListener.onChildViewAdded(<span class="hljs-built_in">this</span>, child);
    }
}

<span class="hljs-comment">/**
 * Called when a new child is added to this ViewGroup. Overrides should always
 * call super.onViewAdded.
 *
 * <span class="hljs-doctag">@param</span> child the added child view
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAdded</span><span class="hljs-params">(View child)</span> {
	<span class="hljs-comment">// 这个方法给子类实现用的</span>
}
</code></pre>
<p>在这里又回调了子类实现的 <code>onViewAdded()</code></p>
<p>即当执行 <code>addView</code> 操作后除了触发 <code>ViewRootImpl</code> 的<code>VSYNC</code>信号订阅外，还回触发 <code>onViewAdded</code> 方法。</p>
<h2 data-id="heading-5">0x02、<code>NSSL.onViewAdded()</code></h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAdded</span><span class="hljs-params">(View child)</span> {
    <span class="hljs-built_in">super</span>.onViewAdded(child);
    onViewAddedInternal((ExpandableView) child);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onViewAddedInternal</span><span class="hljs-params">(ExpandableView child)</span> {
		<span class="hljs-comment">// 锁屏时自动隐藏敏感通知内容</span>
    updateHideSensitiveForChild(child);
    <span class="hljs-comment">// 监听通知项的展开/折叠，实现流畅的连锁动画和布局调整</span>
    child.setOnHeightChangedListener(<span class="hljs-built_in">this</span>);
    <span class="hljs-comment">//新通知滑入、淡入的动画效果，提供操作响应感</span>
    generateAddAnimation(child, <span class="hljs-literal">false</span> <span class="hljs-comment">/* fromMoreCard */</span>);
    <span class="hljs-comment">//确保新通知的动画与整个列表的展开/折叠状态同步</span>
    updateAnimationState(child);
    <span class="hljs-comment">//更新通知中的“时间戳”（如“刚刚”），确保信息准确</span>
    updateChronometerForChild(child);
    <span class="hljs-keyword">if</span> (child <span class="hljs-keyword">instanceof</span> ExpandableNotificationRow) {
        ((ExpandableNotificationRow) child).setDismissRtl(mDismissRtl);
    }
    <span class="hljs-keyword">if</span> (ANCHOR_SCROLLING) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> once we're recycling this will need to check the adapter position of the child</span>
        <span class="hljs-keyword">if</span> (child == getFirstChildNotGone() &amp;&amp; (isScrolledToTop() || !mIsExpanded)) {
            <span class="hljs-comment">// New child was added at the top while we're scrolled to the top;</span>
            <span class="hljs-comment">// make it the new anchor view so that we stay at the top.</span>
            mScrollAnchorView = child;
        }
    }
}
</code></pre>
<h3 data-id="heading-6"><strong>与 <code>requestLayout</code> 流程的关系</strong></h3>
<p>将这些逻辑置于 <code>onViewAdded</code> 中的时机选择非常精妙：</p>
<ol>
<li><strong>即刻配置（<code>onViewAdded</code> 中）</strong>：在新通知视图进入容器的<strong>第一时间</strong>，就完成所有状态同步和关系绑定。此时，视图尚未布局。</li>
<li><strong>动态响应（后续 <code>layout</code> 过程中）</strong>：由于提前设置了 <code>OnHeightChangedListener</code>，当通知在后续交互中展开/折叠（改变高度）时，NSSL 能在监听器回调中再次触发 <code>requestLayout()</code>。</li>
<li><strong>闭环形成</strong>：这就形成了一个 <code>addView</code> → 配置 → <code>layout</code> → 用户交互 → 高度变化 → 回调 → 再次 <code>requestLayout</code> → 重新 <code>layout</code> 的<strong>完美闭环</strong>，支撑起整个动态列表。</li>
</ol>
<p>简单来说，<code>onViewAdded</code> 中的代码为每个新通知装上了 <strong>“遥控器”</strong> 和 <strong>“定位器”</strong> ，让 NSSL 这个“总控台”能够实时感知并精确控制每一个成员，从而实现高度动态、流畅的通知列表效果。</p>
<p><strong>接下来看看 layout 过程。</strong></p>
<h2 data-id="heading-7">0x03、<code>NSSL.onLayout()</code></h2>
<h3 data-id="heading-8">1、首先所有子 View 居中置顶</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayout</span><span class="hljs-params">(<span class="hljs-type">boolean</span> changed, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span> {
    <span class="hljs-comment">// we layout all our children centered on the top</span>
    <span class="hljs-comment">// 计算中心点位置</span>
    <span class="hljs-type">float</span> <span class="hljs-variable">centerX</span> <span class="hljs-operator">=</span> getWidth() / <span class="hljs-number">2.0f</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; getChildCount(); i++) {
        <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getChildAt(i);
        <span class="hljs-comment">// We need to layout all children even the GONE ones, such that the heights are</span>
        <span class="hljs-comment">// calculated correctly as they are used to calculate how many we can fit on the screen</span>
        <span class="hljs-type">float</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> child.getMeasuredWidth();
        <span class="hljs-type">float</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> child.getMeasuredHeight();
        <span class="hljs-comment">// left = centerX - width / 2.0f </span>
        <span class="hljs-comment">// 目的让 child 居中，top 固定为 0</span>
        child.layout((<span class="hljs-type">int</span>) (centerX - width / <span class="hljs-number">2.0f</span>),
                <span class="hljs-number">0</span>,
                (<span class="hljs-type">int</span>) (centerX + width / <span class="hljs-number">2.0f</span>),
                (<span class="hljs-type">int</span>) height);
    }
    <span class="hljs-comment">// 锁定 NSSL 的最大可用高度，并将此高度传递给 mShelf（通知托盘）。</span>
    <span class="hljs-comment">// 这决定了通知在滚动到哪个位置时应该开始“收缩”进入底部托盘。</span>
    setMaxLayoutHeight(getHeight());
    <span class="hljs-comment">// 计算当前所有通知的总高度（Intrinsic Height），这个加上通知之间的间距（Padding）</span>
    <span class="hljs-comment">// 以及 Section 之间的间隔</span>
    updateContentHeight();
    <span class="hljs-comment">// 防止由于布局改变（例如某条通知消失）导致的“非法滚动”。</span>
    <span class="hljs-comment">// 如果当前滚动量超过了新的内容总高度，它会将滚动条强制回弹到合法范围内。</span>
    clampScrollPosition();
		<span class="hljs-comment">// 这个方法向 ViewTreeObserver 注册一个 onPreDraw 监听。</span>
		<span class="hljs-comment">// 在下一帧绘制前，**StackScrollAlgorithm** 会介入，</span>
		<span class="hljs-comment">// 根据当前状态计算出每个 View 真正应该存在的 TranslationY</span>
    requestChildrenUpdate();
    <span class="hljs-comment">// 更新背景，通知列表是一个整体，需要为有圆角和边界的Item确定效果，</span>
    updateFirstAndLastBackgroundViews();
    <span class="hljs-comment">// 更新算法所需的最小高度</span>
    updateAlgorithmLayoutMinHeight();
    <span class="hljs-comment">// 根据通知在堆栈中的位置（是否有悬浮、是否是第一条）动态调整 TranslationZ。</span>
    <span class="hljs-comment">// 这是渲染阴影的关键，确保上层的通知阴影能正确投射在下层通知上</span>
    updateOwnTranslationZ();
}
</code></pre>
<p><strong>为什么top是0？</strong> NSSL 是一个高度动态的列表，通知的 Y 轴坐标受到滚动、展开进度、阻尼回弹、分组折叠等几十个变量影响。如果在 <code>onLayout</code> 中硬编码 Y 坐标，会导致频繁的 <code>requestLayout</code>，性能极差。因此，NSSL 选择在 <code>onLayout</code> 中完成基础定位，而将复杂的 Y 轴偏移交给 <strong><code>setTranslationY()</code></strong></p>
<p>**这样做的好处是：**当用户滚动列表时，NSSL 只需要改变子 View 的 <code>TranslationY</code>，这由 GPU 处理，不需要触发代价昂贵的全局 <code>layout</code> 过程，从而保证了通知中心滑动的极致流畅。</p>
<h3 data-id="heading-9">2、设置容器大小</h3>
<p><code>setMaxLayoutHeight</code> 和 <code>updateContentHeight</code> 设置通知列表高度。</p>
<h3 data-id="heading-10">3、触发渲染</h3>
<p><code>requestChildrenUpdate</code>它会向 <code>ViewTreeObserver</code> 注册一个 <code>onPreDraw</code> 监听。在下一帧绘制前，<strong><code>StackScrollAlgorithm</code></strong> 会介入，根据当前状态计算出每个 <code>View</code> 真正应该存在的 <code>TranslationY</code>。</p>
<p><strong>总结</strong></p>
<ul>
<li>结构层面：<code>addView</code> 触发 <code>requestLayout</code>，一路到 <code>ViewRootImpl</code>，由 VSYNC 驱动一次完整的 <code>measure/layout/draw</code>。</li>
<li>控制层面：<code>onViewAdded()</code> 中完成新通知的状态绑定和监听器安装，使其之后的任何高度和状态变化，都能回流到 NSSL 的布局和动画系统。</li>
<li>布局与动画层面：<code>onLayout()</code> 做统一基准布局，<code>requestChildrenUpdate()</code> + <code>StackScrollAlgorithm</code> 在下一帧前计算并下发真正的 TranslationY 和 Z，从而构建出一个依赖 GPU 合成、性能友好的动态通知列表。</li>
</ul>
<p><strong><code>NSSL.addContainerView()</code> 不只是“把 View 插进列表”，而是通过 <code>requestLayout + VSYNC + onViewAdded + 算法驱动 TranslationY</code>，把这条通知完全纳入到 NSSL 的滚动、动画和可见性控制闭环中，既保证结构正确，又保证交互流畅。</strong></p>
<blockquote>
<p><code>StackScrollAlgorithm</code> 对于 <code>NSSL</code> 非常重要，它是通知列表的排序算法的逻辑计算模块</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redisson分布式锁：从入门到实战]]></title>    <link>https://juejin.cn/post/7599581687357947954</link>    <guid>https://juejin.cn/post/7599581687357947954</guid>    <pubDate>2026-01-27T01:09:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357947954" data-draft-id="7599514071104946191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redisson分布式锁：从入门到实战"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2026-01-27T01:09:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redisson分布式锁：从入门到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:09:35.000Z" title="Tue Jan 27 2026 01:09:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Redisson分布式锁：从入门到实战</h2>
<h3 data-id="heading-1">一、为什么需要分布式锁？</h3>
<p>在单体应用中，我们使用Java的synchronized或ReentrantLock就能解决并发问题。但在微服务架构下，多个实例同时运行，单机的锁机制就失效了。这时就需要分布式锁来保证跨JVM的互斥访问。</p>
<h4 data-id="heading-2">分布式锁的核心需求</h4>
<ol>
<li><strong>互斥性</strong>：同一时刻只能有一个客户端持有锁</li>
<li><strong>防止死锁</strong>：客户端崩溃后能自动释放锁</li>
<li><strong>容错性</strong>：Redis节点故障时仍能正常工作</li>
<li><strong>可重入性</strong>：同一个线程可以多次获取同一个锁</li>
</ol>
<h3 data-id="heading-3">二、Redis实现分布式锁的基础方案</h3>
<h4 data-id="heading-4">2.1 最简单的实现：SET NX</h4>
<p>最早期的实现方式是使用SET命令的NX选项：</p>
<pre><code class="hljs language-bash" lang="bash">SET key value NX PX 30000
</code></pre>
<ul>
<li>NX：只在key不存在时设置</li>
<li>PX：设置过期时间（毫秒）</li>
</ul>
<p>这种方式的缺点：</p>
<ul>
<li>无法实现可重入锁</li>
<li>无法获取锁的持有人信息</li>
<li>无法实现锁的自动续期</li>
</ul>
<h4 data-id="heading-5">2.2 完整实现方案</h4>
<p>一个相对完善的Redis分布式锁实现需要包含以下逻辑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36710f1f72a74b159d94a971215edebd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=RHisUCpuSPWs3zklvdtyQfftwKM%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>加锁</strong>：SET key value NX PX timeout</li>
<li><strong>解锁</strong>：Lua脚本保证原子性</li>
<li><strong>看门狗</strong>：定时续期防止业务执行时间超过锁过期时间</li>
</ol>
<h3 data-id="heading-6">三、Redisson分布式锁</h3>
<p>Redisson是Redis的Java客户端，它提供了完善的分布式锁实现，解决了原生Redis锁的各种问题。</p>
<h4 data-id="heading-7">3.1 核心特性</h4>
<ol>
<li><strong>可重入锁</strong>：同一个线程可多次获取锁</li>
<li><strong>公平锁</strong>：按请求顺序获取锁</li>
<li><strong>读写锁</strong>：允许多个读操作或单个写操作</li>
<li><strong>红锁</strong>：跨多个Redis节点的分布式锁</li>
<li><strong>自动续期</strong>：看门狗机制自动延长锁时间</li>
<li><strong>锁释放</strong>：Lua脚本保证原子性操作</li>
</ol>
<h4 data-id="heading-8">3.2 基本使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取锁对象</span>
<span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">"myLock"</span>);

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 加锁（支持等待时间和自动续期）</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">100</span>, <span class="hljs-number">30000</span>, TimeUnit.MILLISECONDS);
    <span class="hljs-keyword">if</span> (locked) {
        <span class="hljs-comment">// 执行业务逻辑</span>
        doBusiness();
    }
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 释放锁</span>
    <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
        lock.unlock();
    }
}
</code></pre>
<h3 data-id="heading-9">四、Redis实现 vs Redisson对比</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae00c47f604148e6a4006e0bae3d4cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=Qq5jyVZ3y4KFv6fIsSOvYt1aiHY%3D" alt="" loading="lazy"/></p>













































<table><thead><tr><th>特性</th><th>Redis原生实现</th><th>Redisson</th></tr></thead><tbody><tr><td>实现复杂度</td><td>高，需要处理多种边界情况</td><td>低，开箱即用</td></tr><tr><td>可重入锁</td><td>需要自己实现</td><td>原生支持</td></tr><tr><td>自动续期</td><td>需要后台线程续期</td><td>看门狗自动续期</td></tr><tr><td>公平锁</td><td>难以实现</td><td>开箱即用</td></tr><tr><td>读写锁</td><td>难以实现</td><td>开箱即用</td></tr><tr><td>红锁</td><td>需要自己协调</td><td>开箱即用</td></tr><tr><td>异常处理</td><td>需要仔细处理</td><td>完善的异常体系</td></tr></tbody></table>
<p><strong>结论</strong>：生产环境推荐使用Redisson，它已经处理了各种边界情况和异常场景。</p>
<h3 data-id="heading-10">五、Redisson核心原理解析</h3>
<h4 data-id="heading-11">5.1 加锁机制</h4>
<p>Redisson使用Lua脚本保证加锁的原子性：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6db4760a8ca34874b3d5029848f7c0b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=NHt9Yu2zVeFx0zVw4zP3zyK0%2FaM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 检查key是否存在</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'exists'</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- 不存在则设置，使用hash结构存储</span>
    redis.call(<span class="hljs-string">'hset'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>)
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- key已存在，检查是否是当前线程</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span>
    <span class="hljs-comment">-- 是当前线程，增加重入次数</span>
    redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">1</span>)
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'pttl'</span>, KEYS[<span class="hljs-number">1</span>])
</code></pre>
<p>锁的数据结构使用Hash类型：</p>
<ul>
<li>Key：锁名称</li>
<li>Field：线程标识（UUID:threadId）</li>
<li>Value：重入次数</li>
</ul>
<h4 data-id="heading-12">5.2 看门狗机制</h4>
<p>看门狗（Watchdog）是Redisson的核心特性，用于解决锁超时问题：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa290857b347461caa2c83f8f3808431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=pgDfxuK1gt4hgqT42KMG0Dxrh%2F4%3D" alt="" loading="lazy"/></p>
<ol>
<li>业务获得锁时，启动后台定时任务</li>
<li>每隔lockWatchdogTimeout/3时间检查锁是否还持有</li>
<li>如果还持有则重置过期时间</li>
<li>业务释放锁时停止看门狗</li>
</ol>
<p>默认情况下，看门狗每10秒续期一次，锁的过期时间为30秒。</p>
<h4 data-id="heading-13">5.3 解锁机制</h4>
<p>解锁同样使用Lua脚本保证原子性：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 检查锁是否是当前线程持有</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'hexists'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 减少重入次数</span>
<span class="hljs-keyword">local</span> counter = redis.call(<span class="hljs-string">'hincrby'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-number">-1</span>)

<span class="hljs-comment">-- 如果重入次数大于0，重置过期时间</span>
<span class="hljs-keyword">if</span> counter &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">'pexpire'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>])
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment">-- 重入次数为0，删除锁</span>
redis.call(<span class="hljs-string">'del'</span>, KEYS[<span class="hljs-number">1</span>])
<span class="hljs-comment">-- 发布解锁消息</span>
redis.call(<span class="hljs-string">'publish'</span>, KEYS[<span class="hljs-number">2</span>], ARGV[<span class="hljs-number">3</span>])
<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-14">六、生产环境实战案例</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b30e1e93811642378d9b2fe34cce8d18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=W0esadRxVnzvogk%2Be2mzMTPpWdo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">6.1 库存扣减</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(String productId, <span class="hljs-type">int</span> quantity)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(<span class="hljs-string">"stock:"</span> + productId);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 等待5秒，锁过期30秒</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">5</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 查询库存</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> getStock(productId);
                <span class="hljs-keyword">if</span> (stock &gt;= quantity) {
                    <span class="hljs-comment">// 扣减库存</span>
                    updateStock(productId, stock - quantity);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-16">6.2 订单幂等性控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:create:"</span> + request.getUserId();
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 检查是否已有未完成订单</span>
                <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> getUnfinishedOrder(request.getUserId());
                <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> existOrder;
                }

                <span class="hljs-comment">// 创建新订单</span>
                <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(request);
                saveOrder(order);
                <span class="hljs-keyword">return</span> order;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"操作频繁，请稍后重试"</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-17">6.3 定时任务防止重复执行</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSyncJob</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-meta">@Scheduled(cron = "0 */5 * * * *")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncData</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"job:data:sync"</span>;
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redisson.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试获取锁，不等待</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">0</span>, TimeUnit.SECONDS)) {
                <span class="hljs-comment">// 执行数据同步</span>
                doSync();
            } <span class="hljs-keyword">else</span> {
                log.info(<span class="hljs-string">"上次同步任务尚未完成，跳过本次执行"</span>);
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-18">七、高级特性：读写锁</h3>
<p>在读多写少的场景下，使用读写锁可以大幅提升并发性能：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4e4fafcea334003a242580e3dd039c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770080976&amp;x-signature=ERgnPFuN1pzSf2ilxz0vG0vVEpM%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redisson;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getConfig</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">"config:"</span> + key);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">readLock</span> <span class="hljs-operator">=</span> rwLock.readLock();

        <span class="hljs-keyword">try</span> {
            readLock.lock();
            <span class="hljs-comment">// 多个线程可以同时读取</span>
            <span class="hljs-keyword">return</span> queryFromDB(key);
        } <span class="hljs-keyword">finally</span> {
            readLock.unlock();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateConfig</span><span class="hljs-params">(String key, String value)</span> {
        <span class="hljs-type">RReadWriteLock</span> <span class="hljs-variable">rwLock</span> <span class="hljs-operator">=</span> redisson.getReadWriteLock(<span class="hljs-string">"config:"</span> + key);
        <span class="hljs-type">RLock</span> <span class="hljs-variable">writeLock</span> <span class="hljs-operator">=</span> rwLock.writeLock();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 写操作独占锁</span>
            writeLock.lock();
            updateDB(key, value);
            <span class="hljs-comment">// 清除缓存</span>
            clearCache(key);
        } <span class="hljs-keyword">finally</span> {
            writeLock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-19">八、最佳实践</h3>
<h4 data-id="heading-20">8.1 锁的粒度选择</h4>
<ol>
<li><strong>粗粒度</strong>：锁整个表或模块，简单但并发度低</li>
<li><strong>细粒度</strong>：锁单个记录，并发度高但实现复杂</li>
</ol>
<p><strong>推荐</strong>：根据业务场景选择合适的粒度，库存扣减用商品维度，订单创建用用户维度。</p>
<h4 data-id="heading-21">8.2 锁的过期时间设置</h4>
<ol>
<li>不要设置过短，避免业务未执行完就释放</li>
<li>不要设置过长，避免故障时长时间阻塞</li>
<li>Redisson的看门狗会自动续期，但要设置合理的初始时间</li>
</ol>
<p><strong>推荐</strong>：根据业务执行时间的P99值设置，预留50%余量。</p>
<h4 data-id="heading-22">8.3 异常处理</h4>
<ol>
<li>捕获中断异常，确保锁能被释放</li>
<li>使用tryLock而不是lock，避免无限等待</li>
<li>检查锁的持有状态，避免误释放</li>
</ol>
<h3 data-id="heading-23">九、常见问题</h3>
<h4 data-id="heading-24">Q1：Redisson锁会丢失吗？</h4>
<p>不会。Redisson使用看门狗机制，即使业务执行时间超过锁的过期时间，也会自动续期，直到业务主动释放锁。</p>
<h4 data-id="heading-25">Q2：Redis主从切换会影响锁吗？</h4>
<p>会。单节点Redis在主从切换时可能丢失锁。需要使用Redisson的红锁（RedLock）或Redis Cluster。</p>
<h4 data-id="heading-26">Q3：如何实现公平锁？</h4>
<p>Redisson提供了公平锁实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">RLock</span> <span class="hljs-variable">fairLock</span> <span class="hljs-operator">=</span> redisson.getFairLock(<span class="hljs-string">"myFairLock"</span>);
fairLock.lock();
</code></pre>
<h4 data-id="heading-27">Q4：性能如何？</h4>
<p>Redisson的分布式锁性能很好，单机QPS可达5万+，足以应对大多数场景。如有更高性能需求，可以考虑分段锁或本地锁+分布式锁的组合方案。</p>
<h3 data-id="heading-28">十、总结</h3>
<p>Redisson分布式锁是Java领域最成熟的Redis分布式锁解决方案：</p>
<ol>
<li><strong>使用简单</strong>：API友好，学习成本低</li>
<li><strong>功能完善</strong>：支持多种锁类型和场景</li>
<li><strong>稳定可靠</strong>：经过大量生产环境验证</li>
<li><strong>性能优异</strong>：看门狗机制和Lua脚本保证性能</li>
</ol>
<p>在实际项目中，建议优先使用Redisson，它已经帮你处理了各种复杂的边界情况，让你专注于业务逻辑的实现。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术]]></title>    <link>https://juejin.cn/post/7600219080045658155</link>    <guid>https://juejin.cn/post/7600219080045658155</guid>    <pubDate>2026-01-28T09:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600219080045658155" data-draft-id="7600068631360585734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-28T09:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给显卡按下“暂停键”：阿里云函数计算 GPU “浅休眠”背后的硬核技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:42:38.000Z" title="Wed Jan 28 2026 09:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：王骜</p>
<p>在 AGI（通用人工智能）爆发的今天，AI 应用如雨后春笋般涌现。对于开发者而言，这既是最好的时代，也是最“贵”的时代。</p>
<p>部署 LLM（大语言模型）、Stable Diffusion 等 AI 应用时，我们往往面临一个两难的选择：</p>
<ul>
<li><strong>要速度（预留模式）</strong>：为了毫秒级 - 秒级的响应，必须长期通过预留模式持有 GPU 实例，但昂贵的空置成本让人心痛。</li>
<li><strong>要省钱（按量模式）</strong>：为了节省成本选择按量付费，但 GPU 实例的创建和模型加载带来的漫长“冷启动”延迟，又严重伤害用户体验。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59d1299dc3854b5da113740c2aac6f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=6l6AxodDRNTDSLjoFCzyu1XjznA%3D" alt="图片" loading="lazy"/></p>
<p><strong>难道性能与成本真的不可兼得？</strong></p>
<p>阿里云函数计算（Function Compute）推出的 <strong>CPU 和 GPU 实例浅休眠功能</strong>，正是为了打破这一僵局而来。它让实例学会了“浅休眠”，在保留热启动能力的同时，<strong>极大降低了实例的闲置成本</strong>。</p>
<p>本文将带你深入技术后台，揭秘 GPU 实例浅休眠这一功能是如何从 0 到 1 实现的。</p>
<h2 data-id="heading-0">什么是 GPU 实例浅休眠？给显卡按下“暂停键”</h2>
<p>在开启浅休眠功能后，当没有请求时，GPU 实例并不会被销毁，而是进入一种 <strong>“休眠”</strong> 状态。</p>
<p>此时，实例依然存在，但 CPU 和 GPU 的计算资源被挂起，用户只需支付极低的休眠费用（约为活跃实例费用的 10%-20%，CPU 不计费，具体见计费文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fproduct-overview%2Fthe-idle-gpu-usage-billable-item-is-added-to-function-compute%25EF%25BC%2589" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/product-overview/the-idle-gpu-usage-billable-item-is-added-to-function-compute%EF%BC%89" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<p>当请求再次到来时，系统会瞬间“解冻”实例，毫秒-秒级恢复计算能力（视模型大小）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/029a8cf72b9046a49a1959514e52ac04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=ee1HnQ7WIKilT7Et%2FRhpWwiYxTI%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">技术揭秘：如何实现 GPU 的“浅休眠”？</h2>
<p>在容器技术中，实现 CPU 的暂停（Pause）相对成熟且容易，但要给正在显存中跑着几个 G 大模型的 GPU 做暂停，技术挑战极大。我们通过三项关键技术，实现了对 GPU 资源的精细化管理。</p>
<h3 data-id="heading-2">1. 显存状态的“迁移”</h3>
<p>传统释放 GPU 资源的方式意味着销毁实例，下次使用必须经历完整的冷启动（启动容器、加载模型）。为了解决这个问题，我们设计并实现了显存数据的<strong>迁移（Migration）机制</strong>：</p>
<ul>
<li><strong>休眠阶段</strong>：当实例空闲时，系统会将 GPU 显存中的所有数据（包括模型参数、中间状态等）完整迁移至外部存储保存。</li>
<li><strong>唤醒阶段</strong>：当新请求到达时，系统会迅速将存储中的数据回迁至 GPU 显存并重建状态，将实例恢复至休眠前的状态。</li>
</ul>
<p>这一过程避免了重复的模型加载，确保实例始终处于待命状态。</p>
<h3 data-id="heading-3">2. 驱动层的透明兼容</h3>
<p>为了让用户无需修改代码即可使用该功能，我们选择在底层进行技术突破。</p>
<p>FC GPU 实例做到了<strong>对框架无感</strong>。这意味着，无论是 PyTorch 还是 TensorFlow，现有的 AI 应用无需任何代码改造，即可直接具备浅休眠能力。</p>
<h3 data-id="heading-4">3. 基于请求的自动化调度</h3>
<p>有了“浅休眠”能力后，还需要解决“何时休眠、何时唤醒”的调度问题。依托函数计算<strong>以请求为中心</strong>的架构优势，我们实现了全自动化的资源管控。</p>
<p>平台天然感知每个请求的生命周期：</p>
<ul>
<li><strong>请求到达</strong>：系统自动触发解冻流程，毫秒级唤醒 GPU 执行任务。</li>
<li><strong>请求结束</strong>：系统自动触发冻结流程，释放 GPU 算力。</li>
</ul>
<p>整个过程由平台自动托管，用户无需配置复杂的伸缩策略，即可实现资源的按需分配与极致利用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be61a724918c4bc4b0f076d5f4ee61fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=FTDiujCAe4AVq%2BuX7qt7K0nSQ0Y%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">浅休眠唤醒性能</h2>
<p>性能是用户最关心的指标。我们以 <strong>ComfyUI + Flux</strong> 的文生图场景为例进行了实测：</p>
<p>GPU 实例从“浅休眠”唤醒的耗时仅约为 <strong>500 毫秒 - 2 秒</strong>（视模型大小不同而略有差异）。</p>
<p>考虑到整个文生图生成过程通常持续数十秒，这 1-2 秒的延迟对于用户体验的影响极为有限，不足以降低用户感知的流畅性，却能换来显著的成本下降。</p>
<h2 data-id="heading-6">真实案例：某 OCR 业务降本 70% 实录</h2>
<p>深圳某科技公司主要业务是从专利文本中提取信息，使用 OCR 模型。他们的业务痛点非常典型：</p>
<p><strong>1. 启动耗时长</strong>：容器启动+加载模型+私有数据 OCR 识图，全套下来要<strong>十几秒</strong>。</p>
<p><strong>2. 流量难以预测</strong>：请求来去无法预判，“按量模式”的冷启动耗时长无法满足业务延迟需求。如果使用预留实例，大部分时间 GPU 都在空转出现了浪费。</p>
<p>开启 GPU 实例浅休眠后：</p>
<ul>
<li>启动延迟明显减少，请求到达后能快速响应。</li>
<li>日常使用成本大幅下降。</li>
<li>服务稳定性不受影响，用户体验保持良好。</li>
</ul>
<p>整体成本节省接近 70%。</p>
<h2 data-id="heading-7">如何使用</h2>
<p>开启方式非常简单，<strong>函数计算产品控制台（<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Foverview%25EF%25BC%2589" target="_blank" title="https://fcnext.console.aliyun.com/overview%EF%BC%89" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/overview）</a></strong> 已默认支持该功能：</p>
<ol>
<li>
<p>进入函数的【弹性配置】页签。</p>
</li>
<li>
<p>设置【弹性实例】的数量。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11c08054e094bda922f71702adec951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=%2BSq%2FnskAKa2OW995aKESEMXrxMA%3D" alt="4d1f813cafb5be49b610eb7407973e1f.png" loading="lazy"/></p>
<ol start="3">
<li>系统将自动激活 GPU 实例的浅休眠功能。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8d58f22eade4f0cb45c8c996f7f0492~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=WZqxlbnA5pbSHZedrlA3Cn%2BVm0Y%3D" alt="6e817a0bd35ee6f935e18ed4e5a3dd75.png" loading="lazy"/></p>
<p><strong>计费逻辑</strong>：</p>
<ul>
<li><strong>请求执行时</strong>：全额收费。</li>
<li><strong>无请求执行时</strong>：自动切换至浅休眠计费（GPU 资源视卡型收取 10%-20% 的费用，<strong>CPU 不收费</strong>）。</li>
</ul>
<h2 data-id="heading-8">结语：Serverless AI 的新范式</h2>
<p>Serverless 的核心理念是“按需付费”，而 GPU 昂贵的持有成本一直是阻碍 AI 全面 Serverless 化的大山。</p>
<p><strong>函数计算 CPU 和 GPU 实例均全面支持浅休眠能力</strong>。无论是高算力的 AI 推理（GPU），还是通用的计算任务（CPU），函数计算全系实例均致力助您在 Serverless 的道路上实现极致的降本增效。</p>
<p><strong>想要降本？现在就是最好的时机。</strong></p>
<p><strong>了解更多：</strong></p>
<p><strong>FunctionAI</strong> 是阿里云推出的一站式 <strong>AI 原生应用开发平台</strong>，基于<strong>函数计算 FC</strong> 的 Serverless 架构，深度融合 AI 技术，为企业提供从模型训练、推理到部署的全生命周期支持。</p>
<p>通过 Serverless 架构的弹性特性与智能化资源管理，显著降低 AI 应用的开发复杂度与资源成本，助力企业快速实现 AI 落地。</p>
<ol>
<li><strong>开发效率提升</strong>：无需关注底层资源，开发者可专注于业务逻辑，模型一键转换为 Serverless API。</li>
<li><strong>弹性资源调度</strong>：按需付费 + N 分之一卡资源分配（如 1/16 卡），GPU 部署成本降低 90% 以上。</li>
<li><strong>免运维特性</strong>：实例闲置时自动缩容至 0，资源利用率优化 60%，实现业务运维转型。</li>
</ol>
<p>快速体验 <strong>FunctionAI：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcap.console.aliyun.com%2Fexplore" target="_blank" title="https://cap.console.aliyun.com/explore" ref="nofollow noopener noreferrer">cap.console.aliyun.com/explore</a></strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b448c8d6638491a8a2767b11d79da75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198161&amp;x-signature=B2dVrevySZ9YNKiudUwWebCB3S0%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Code的完美平替：OpenCode + GitHub Copilot]]></title>    <link>https://juejin.cn/post/7600242248861024296</link>    <guid>https://juejin.cn/post/7600242248861024296</guid>    <pubDate>2026-01-28T09:47:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600242248861024296" data-draft-id="7600225000851521571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Code的完美平替：OpenCode + GitHub Copilot"/> <meta itemprop="keywords" content="VibeCoding,Claude,Github Copilot"/> <meta itemprop="datePublished" content="2026-01-28T09:47:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Code的完美平替：OpenCode + GitHub Copilot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:47:01.000Z" title="Wed Jan 28 2026 09:47:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Claude 虽好，但你真的能用上吗？</h2>
<p>在当前席卷全球的“Vibe Coding”浪潮中，Anthropic 推出的 Claude 系列模型 + 终端工具 Claude Code，凭借极强的逻辑推理能力，成为了开发者眼中的“白月光”。但现实是残酷的：对于中国开发者而言，账号随时被封、海外信用卡支付遭拒、API 额度受限以及复杂的网络环境，构成了一道难以逾越的门槛。</p>
<p>虽然最近国产编程模型不断发力，Claude Code + GLM-4.7的表现非常出色，但面对复杂问题，Claude系列模型依然完胜。难道我们只能眼馋Claude全家桶的编程体验吗？</p>
<p>作为一名追求极致生产力的开发者，我发现了一个绝佳的完美替代方案：OpenCode + GitHub Copilot。这个组合不仅能让你享受如 GLM-4.7 一样的性价比，还能更方便的使用 Claude 的顶级模型。</p>
<h2 data-id="heading-1">Claude Code 的开源免费平替：OpenCode</h2>
<p>想要复刻 Claude Code 的体验，核心在于拥有一个强大的“AI 编程代理（Coding Agent）”。OpenCode 正是目前社区中最接近、甚至在某些维度超越 Claude Code 的工具。</p>
<p><img src="https://static.didispace.com/images4/ecb289e9e92977960fa4d92d07434696.png" alt="OpenCode" loading="lazy"/></p>
<p>OpenCode 的强大源于其深厚的社区根基，其核心数据足以证明其统治力：</p>
<ul>
<li>高社区认可度： 在 GitHub 上拥有超过 90,000 Stars、由 600 多名贡献者共同维护，并积累了超过 7,500 次 commits。</li>
<li>庞大的用户基数： 每月有超过 150 万名开发者活跃在该工具链中。</li>
<li>全场景覆盖： 不同于仅限终端的工具，OpenCode 提供了 Terminal、IDE 插件以及支持 macOS/Windows/Linux 的 Desktop（桌面端）应用。</li>
</ul>
<p>更硬核的是，OpenCode 秉持隐私优先理念，不存储任何代码或上下文数据，且能自动加载适配 LLM 的 LSP（语言服务协议）。这种自动化的环境感知，让它在执行复杂重构任务时，比手动配置的工具更具“专家感”。</p>
<h2 data-id="heading-2">隐藏的顶级模型分发器：GitHub Copilot</h2>
<p>很多开发者忽略了一个事实：GitHub Copilot 已不再仅仅是一个补全插件，它正进化为一个聚合顶级模型的低成本分发平台。</p>
<p>通过 OpenCode 提供的 “Log in with GitHub” 桥接功能，开发者可以直接调用 Copilot 账户下的模型能力。这意味着你不需要折腾海外信用卡去充值 Anthropic API，只需一个 GitHub 账号，就能实现对顶级模型的“一键接入”。</p>
<p>在 Copilot 计划中，你可以访问到的顶级模型矩阵（严格遵循来源名称）包括：</p>
<ul>
<li>Anthropic 系列： Claude Sonnet 4.5/4、Claude Opus 4.1/4.5、Claude Haiku 4.5。</li>
<li>OpenAI 系列： GPT-5、GPT-5 mini、GPT-5.1/5.2、GPT-4.1 以及多款 GPT-5-Codex 预览版。</li>
<li>Google 系列： Gemini 2.5 Pro、Gemini 3 Pro/Flash (Preview)。</li>
<li>新锐力量： xAI Grok Code Fast 1 以及 Raptor mini (Preview)。</li>
</ul>
<h2 data-id="heading-3">性价比之王：每月 $10 搞定顶级模型访问</h2>
<p>这套方案最具杀伤力的地方在于其经济逻辑。直接订阅 ChatGPT Plus 或直接使用 Claude API 的成本极高，而 GitHub Copilot Pro 的定价策略对独立开发者极其友好。</p>
<p><img src="https://static.didispace.com/images4/7db458cf156b6b8838103f4dd2a939a3.png" alt="GitHub Copilot" loading="lazy"/></p>
<ul>
<li>月费仅需 $10： 即可享受针对 GPT-5 mini 的无限量聊天与 Agent 模式请求，以及无限量的代码补全。</li>
<li>高级请求配额： Copilot Pro 计划每月提供 300 次 Premium requests（高级请求），用于调用 Claude Opus 4.5 或 GPT-5 等昂贵的旗舰模型；如果你是重度用户，升级至 Pro+ 计划，该配额将飙升至 1500 次。</li>
<li>完全免费通道： 针对经认证的学生、教师及流行开源项目维护者，上述所有能力均为 $0/月。</li>
</ul>
<p><img src="https://static.didispace.com/images4/f961dc001a453bd58fb0ded9dbb0c955.png" alt="GitHub Copilot" loading="lazy"/></p>
<p>这种“小钱办大事”的模式，完美解决了“复杂场景下 Opus 模型最有效”但“直接接入成本高”的矛盾。</p>
<h2 data-id="heading-4">总结</h2>
<p>OpenCode + GitHub Copilot 的组合比起其他平替方案而言，从工具、模型、价格等多个维度都是最优选择。所以，强烈推荐尝试一下这个编码组合。下面是这两个工具的官方地址，想要试试的可以直接前往：</p>
<ul>
<li>OpenCode：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2F" target="_blank" title="https://opencode.ai/" ref="nofollow noopener noreferrer">opencode.ai/</a></li>
<li>GitHub Copilot：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffeatures%2Fcopilot" target="_blank" title="https://github.com/features/copilot" ref="nofollow noopener noreferrer">github.com/features/co…</a></li>
</ul>
<p>最后，做个小调研，目前你正在用什么工具和模型套件呢？留言区聊一聊吧。更多关于Vibe Coding的内容分享也可以关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com%2F" target="_blank" title="https://didispace.com/" ref="nofollow noopener noreferrer">我的博客: 程序猿DD</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式]]></title>    <link>https://juejin.cn/post/7600227607978786868</link>    <guid>https://juejin.cn/post/7600227607978786868</guid>    <pubDate>2026-01-28T09:51:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600227607978786868" data-draft-id="7600216277426405410" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-28T09:51:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aloudata大应科技"/> <meta itemprop="url" content="https://juejin.cn/user/1579340474099927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            根治监管报送“对不准”：从列级血缘到算子级血缘的数据治理新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1579340474099927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aloudata大应科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T09:51:36.000Z" title="Wed Jan 28 2026 09:51:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文首发于 Aloudata 官方技术博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" ref="nofollow noopener noreferrer">《列级血缘为何在 EAST 报送中“对不准”？算子级解析的降维打击》</a>转载请注明出处。</p>
</blockquote>
<p><strong>摘要</strong>：在金融监管报送（如 EAST）场景中，传统列级血缘因 SQL 解析精度低（&lt;80%）、无法处理复杂逻辑，导致指标口径追溯不全、人工盘点耗时数月。本文深入剖析了列级血缘的技术局限，并介绍了以算子级血缘为核心的新范式。通过 AST 深度解析、行级裁剪和白盒化口径提取等技术，算子级血缘将解析准确率提升至 &gt;99%，实现监管指标“一键溯源”与自动化盘点，为数据治理和 DataOps 流程提供精准的溯源基座。</p>
<p>在金融监管报送（如 EAST、1104）领域，数据血缘的准确性直接关系到合规风险与运营效率。传统列级血缘技术因解析精度不足，已成为指标口径“对不准”、人工盘点“盘不动”的症结所在。本文将对比分析列级血缘的固有缺陷，并深入解读以算子级血缘（Operator-level Lineage） 为核心的技术新范式，如何通过 &gt;99% 的解析准确率与行级裁剪能力，为监管报送构建可靠的自动化数据溯源基座。</p>
<h2 data-id="heading-0">一、核心痛点：EAST 报送中的数据溯源困局</h2>
<p>金融监管指标背后是跨越数仓多层（ODS、明细层、汇总层、报表层）的复杂加工链路，涉及大量 SQL 转换、存储过程及临时表处理。传统数据血缘（表级/列级）在此场景下普遍失效，具体表现为：</p>
<ol>
<li>盘点效率低下：面对成千上万的监管指标，数据团队需投入数周至数月进行人工“扒代码”和访谈，成本高昂。</li>
<li>追溯结果不可靠：行业反馈显示，开源列级血缘工具对 Hive SQL 的解析准确率通常低于 70%，近三分之一的依赖关系错误或缺失，为合规埋下隐患。</li>
<li>变更风险失控：无法精准评估上游字段或逻辑变更对下游报送指标的影响，导致“牵一发而动全身”，易引发数据错误或报送延误。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14360e4cec6f472db0ad5d1449261f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQWxvdWRhdGHlpKflupTnp5HmioA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770198698&amp;x-signature=%2FozJE%2B3919mL0ZYaXz1pdBky%2B80%3D" alt="血缘对比.png" loading="lazy"/></p>
<h2 data-id="heading-1">二、技术剖析：列级血缘为何“力不从心”？</h2>
<p>列级血缘的局限源于其技术原理，它通常基于正则匹配或浅层语法分析，只能识别“A 表的 X 列出现在 B 表 Y 列的 SELECT 语句中”，但无法理解其间的计算逻辑。这导致三大硬伤：</p>
<ul>
<li>解析精度天花板低：对包含 <code>CASE WHEN</code>、窗口函数、多层嵌套子查询的复杂 SQL 解析能力弱，准确率普遍低于 80%。</li>
<li>无法穿透黑盒逻辑：对 DB2、Oracle 的 PL/SQL 存储过程、动态 SQL、临时表加工等场景几乎无法解析，造成血缘链路断点。</li>
<li>影响分析过度泛化：缺乏对 <code>WHERE</code>、<code>JOIN ON</code> 等过滤条件的识别。例如，一个仅影响特定分行的源数据变更，会触发所有相关下游任务的告警，噪音率可超过 80%。</li>
</ul>



































<table><thead><tr><th>对比维度</th><th>传统列级血缘</th><th>算子级血缘 (如 Aloudata BIG)</th></tr></thead><tbody><tr><td>解析粒度</td><td>列级，仅知“从哪列到哪列”</td><td>算子级，可知“经过怎样的计算（过滤、连接、聚合）从哪列到哪列”</td></tr><tr><td>解析准确率</td><td>通常 &lt; 80%，复杂 SQL 下更低</td><td>&gt; 99%，基于 AST 深度解析</td></tr><tr><td>复杂场景支持</td><td>弱，难以处理存储过程、动态 SQL、临时表</td><td>强，深度支持 DB2、GaussDB 等 PL/SQL，穿透临时表</td></tr><tr><td>影响分析精度</td><td>粗粒度，易泛化，噪音大</td><td>行级裁剪，精准识别过滤条件，聚焦真实影响范围</td></tr><tr><td>口径提取</td><td>需人工拼接多层代码</td><td>白盒化口径提取，自动生成可读、可验证的最终加工逻辑</td></tr></tbody></table>
<h2 data-id="heading-2">三、新范式：算子级血缘的核心原理与“降维打击”</h2>
<p>算子级血缘实现了技术范式的跃迁。它深入 SQL 内部，将数据加工过程解析为最细粒度的算子（Operator）序列，如 <code>Filter</code>（过滤）、<code>Join</code>（连接）、<code>Aggregation</code>（聚合）等。结合以下核心技术，实现对传统方法的“降维打击”：</p>
<ol>
<li>行级裁剪 (Row-level Pruning)：精准识别 SQL 中的过滤条件（<code>WHERE</code>, <code>JOIN ON</code>）。当上游数据变更时，系统能自动判断变更是否落入下游任务所关心的数据子集内，从而剔除无关的上游分支，使影响评估范围平均降低 80% 以上，实现精准风险预警。</li>
<li>复杂场景全覆盖：基于对多 SQL 方言（Hive, Spark, Oracle, DB2 等）及 PL/SQL 的深度解析能力，可穿透存储过程、动态 SQL、临时表等传统黑盒，构建端到端的完整血缘链路。</li>
<li>白盒化口径提取：针对跨多层加工的监管指标，系统能自动将沿途的所有 <code>SELECT</code>、<code>CASE WHEN</code>、函数调用等逻辑，“压缩”成一段从最终指标反向追溯到源字段的、可读性极高的“加工口径”，直接替代人工“扒代码”。</li>
</ol>
<h2 data-id="heading-3">四、实践验证：算子级血缘在金融场景的落地成效</h2>
<p>该技术已在多家金融机构的 EAST 报送场景中得到验证：</p>
<p>浙江农商联合银行：通过部署具备算子级血缘能力的 Aloudata BIG 平台，实现了监管指标溯源人效提升 20 倍，全量指标口径盘点从数月缩短至 8 小时；对核心 DB2 存储过程的解析准确率达到 99%，攻克技术难关；自动生成符合监管要求的指标加工口径报告。</p>
<p>共性价值：算子级血缘实现的“一键溯源”能力，不仅大幅提升合规效率，更将管理动作从事后补救转向事前防控与事中协同，精准管控上游变更对下游报送指标的影响。</p>
<h2 data-id="heading-4">五、实施路径：构建 EAST 报送的数据溯源基座</h2>
<p>企业可遵循以下三步，系统性构建高可靠的数据溯源能力：</p>
<p>1、基座先行：优先接入核心数仓（Hive, Oracle）、ETL/ELT 平台（DataStage, Kettle）及 BI 系统，快速构建覆盖“入仓-&gt;加工-&gt;服务”全链路的算子级血缘图谱。</p>
<p>2、场景驱动：选择 EAST、1104 等具体监管报表作为首场景，利用“一键溯源”快速验证价值，赢得业务与合规部门支持。</p>
<p>3、流程嵌入：将血缘能力深度嵌入 DataOps 与合规流程：</p>
<ul>
<li>研发侧：代码提交前自动进行变更影响分析，识别波及的报送指标。</li>
<li>运维侧：发生数据异常时，利用血缘图谱快速定位根因。</li>
<li>合规侧：建立基于血缘的自动化口径报告与审计机制。</li>
</ul>
<h2 data-id="heading-5">六、常见问题（FAQ）</h2>
<h4 data-id="heading-6">Q1: 列级血缘和算子级血缘的核心区别是什么？</h4>
<p>最本质的区别是解析粒度。列级血缘仅知道字段的流向，而算子级血缘能还原完整的计算逻辑，例如“A.X 列经过 WHERE 过滤后，与 C 表 Z 列 LEFT JOIN，再 GROUP BY 生成 B.Y 列”，实现加工过程的白盒化。</p>
<h4 data-id="heading-7">Q2: 对复杂的存储过程和嵌套查询，算子级血缘解析效果如何？</h4>
<p>这是算子级血缘的核心优势。它针对 DB2、Oracle 等 PL/SQL 存储过程、动态 SQL 及多层嵌套查询进行了深度优化，解析准确率可超过 99%，能有效穿透这些传统血缘工具的解析盲区。</p>
<h4 data-id="heading-8">Q3: 引入算子级血缘对 EAST 报送的具体价值是什么？</h4>
<p>主要体现在三方面：效率提升（盘点从数月缩短到几小时）、准确性保障（&gt;99% 解析准确率确保口径完整正确）、风险防控（精准评估上游变更影响，实现主动预警）。</p>
<h2 data-id="heading-9">核心要点</h2>
<ol>
<li>精度是核心：传统列级血缘低解析精度（&lt;80%）是 EAST 报送“对不准”的根源。</li>
<li>算子级是解药：算子级血缘通过 AST 深度解析 Filter、Join 等算子，实现 &gt;99% 的解析准确率。</li>
<li>行级裁剪提效：行级裁剪技术能精准识别数据子集，将变更影响分析范围平均降低 80% 以上。</li>
<li>案例验证价值：在标杆案例中，算子级血缘已将监管指标盘点从数月缩短至 8 小时，人效提升 20 倍。</li>
<li>构建溯源基座：企业应优先建设全链路算子级血缘，并以此驱动 DataOps 与自动化合规流程。</li>
</ol>
<hr/>
<p>再次提醒：本文更详细的图表与案例细节，请访问Aloudata官方技术博客阅读原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.noetl.cn%2Fknowledge-base%2Fwhy-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" target="_blank" title="https://ai.noetl.cn/knowledge-base/why-column-level-lineage-mismatch-in-east-reporting-operator-level-analysis" ref="nofollow noopener noreferrer">ai.noetl.cn/knowledge-b…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>