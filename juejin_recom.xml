<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[豆包编程模型来了，我们用四个关卡考了考它！]]></title>    <link>https://juejin.cn/post/7571126773809496074</link>    <guid>https://juejin.cn/post/7571126773809496074</guid>    <pubDate>2025-11-11T11:31:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571126773809496074" data-draft-id="7571191453126557722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="豆包编程模型来了，我们用四个关卡考了考它！"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T11:31:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            豆包编程模型来了，我们用四个关卡考了考它！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:31:10.000Z" title="Tue Nov 11 2025 11:31:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 编程助手，人人都爱。从补全一行代码到生成整个函数，它们极大地改变了我们的开发工作流，就连曾经对它们嗤之以鼻的 Linus Torvalds 也改变了想法。他在近日一次访谈中表示：「我认为它们是能帮助我们更好地完成工作的工具。」</p>
<p>但它们也常会在关键时刻翻车：当你甩给它一个跨越了多个文件、藏得极深的 Bug 时，它失忆了；当你让它重构一个复杂的旧模块时，它开始胡言乱语；当项目变大、依赖变多时，大多数 Copilot 就从助手退化成了麻烦制造机。很明显，对于这些更为复杂的需求，我们需要的不再是代码补全工具，而是一个能理解复杂上下文、自主规划任务、甚至能帮我们调试的 Agentic Coder。</p>
<p>2025 年，AI 编程助手正分化为两条主要路线。第一条可称为 IDE 增强路线，以 GitHub Copilot 为代表。它们深度集成在开发者的编辑器中，更像一个「副驾驶」，在你编程时提供代码补全、上下文感知建议和聊天辅助，目标是提升开发者的编辑效率。</p>
<p>第二条是 Agentic 路线，即任务委托路线，以 Claude Code 为代表。这条路线的工具更像一个「结对工程师」，通常在终端中运行。开发者不再是逐行获取建议，而是将整个复杂的、多步骤的任务（如项目重构、跨语言移植、Bug 修复）委托给它，由它自主规划和执行。这正是「Agentic Coder」的核心理念。</p>
<p>然而，就在 2025 年 10 月底，大量开发者在社区抱怨 Claude Pro 计划的每周用量限制过于严苛，甚至有很多用户反馈称，在进行了几小时的严肃编码工作后就撞到了「周上限」，导致工具无法用于严肃工作。更别说 Anthropic 对中国用户的限制。这在开发者中制造了一个明显的痛点：谁能提供一个既具备强大 Agentic 能力（特指第二条路线），又真正好用、管够的编程模型？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695a5aae02cd48b9862b72dd66c9f2d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=A53RP9g7z8ovadCu8JhAcDbg1pQ%3D" alt="图片" loading="lazy"/></p>
<p>今天，火山引擎带着豆包编程模型 Doubao-Seed-Code 入场了；顾名思义，这正是一个专为编程任务设计的模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d06be3f37242de937e76c2038f9d56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=9DuakNFLLMQRvEWRwIHpFi797y0%3D" alt="图片" loading="lazy"/></p>
<p>为了检验 Doubao-Seed-Code 的能力，我们将用几个真实工作流中的「硬骨头」来考验它，但在此之前，我们先了解下它的基准表现与核心能力。</p>
<p>一、Doubao-Seed-Code：实力登顶权威榜单</p>
<p>豆包编程模型 Doubao-Seed-Code 在 Terminal Bench、SWE-Bench-Verified-Openhands、Multi-SWE-Bench-Flash-Openhands 等多项权威评测中均表现优异，仅次于甚至超过了 Claude 4.5 Sonnet。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30e88c6b1ac3420980084d61ba98f581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=JTtjdvJeJDHTUAA6pVTgL9KMrHw%3D" alt="图片" loading="lazy"/></p>
<p>而更亮眼的是：它登顶了 SWE-Bench Verified 榜单。值得注意的是，这一成绩是其与 Trae 相结合实现的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/174c4490b2b84e67ab902ba8dad077dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=ydUXHpXcUEn5RjbE%2B%2F8NE4MNbvg%3D" alt="图片" loading="lazy"/>SWE-Bench Verified 榜单当前前十名</p>
<p>这恰好印证了 Doubao-Seed-Code「为 Agentic Coding 优化」的定位：它不仅是一个基础模型，更是为任务委托型工作流设计的大脑。须知，SWE-Bench 不是一个简单的算法题库，它是一个评估模型在真实 GitHub 项目中修复 Bug 和处理 issue 能力的基准，含金量很高 。能在 Trae 这样的 Agentic 框架中与之携手登顶，证明了它在执行复杂、多步骤的真实工程任务时的潜力。</p>
<p>1、核心能力：原生 256K 长上下文</p>
<p>Doubao-Seed-Code 的强大榜单表现离不开这个基础：原生 256K 长上下文。</p>
<p>这个数字意味着模型有能力一次性读完并理解极其复杂的项目。在真实的编程场景中，一个 Bug 可能横跨多个文件、一个功能可能依赖数十个模块。Doubao-Seed-Code 的 256K 上下文使其能轻松处理长代码文件、多模块依赖等复杂场景。</p>
<p>不仅如此，Doubao-Seed-Code 还是国内首个支持视觉理解能力的编程模型，能参照 UI 设计稿、截图或手绘草图生成代码，或对生成页面进行视觉比对，自主完成样式修复和 Bug 修复，大幅提升前端开发效率。</p>
<p>2、变强之路：Coding RL Agent at Scale</p>
<p>如果说 256K 上下文是让 Doubao-Seed-Code 看得远，那么它做得好的秘密武器就是：Coding RL Agent at Scale（编程智能体大规模强化学习训练）。</p>
<p>火山引擎构建了一个大规模的强化学习系统来训练这个编程模型，</p>
<p>这套系统内构建了覆盖十万容器镜像的庞大训练数据集，具备万级并发沙盒会话的能力，可以对上千卡的单个 RL 任务实现高效训练。基于这套系统，模型无需蒸馏或标注的冷启动数据，完全依靠端到端强化学习训练即可练就顶尖的 Agent 能力，优化路径更简洁高效。</p>
<p>这种训练方式的效果体现在了基准测试上，官方信息显示，在 SWE-bench 基准上，仅 RL 训练就让模型达到了当前最优（SOTA）水平，充分验证了纯强化学习在真实软件工程场景下的强大潜力。</p>
<p>如下图的数据所示，在 multi-swe-bench 和 swe-bench-verified 两个基准上，Doubao-Seed-Code 的性能在训练过程中呈现一致的上升趋势，这表明模型具有良好的泛化能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/678815131d624c438a442d2d98ab2a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=CaROdXYvWK4yj6OQNJScOvAV%2BaM%3D" alt="图片" loading="lazy"/></p>
<p>理论和数据固然亮眼，但它在真实工作流中的表现究竟如何？我们马上进入实战环节来一探究竟。</p>
<p>二、Agentic Coding 大考：四大关卡，实战见真章</p>
<p>我们这次对 Doubao-Seed-Code 的考验主要围绕其三个核心能力 ：</p>
<ul>
<li>
<p>Agentic Coding（任务规划能力）：能否把一个模糊的、多步骤的任务拆解并执行？</p>
</li>
<li>
<p>长上下文（256K）： 能否处理跨越多个文件、依赖关系复杂的屎山代码？</p>
</li>
<li>
<p>调试能力（软件工程）： 能否像一个真实工程师一样，根据报错信息定位并修复 Bug？</p>
</li>
</ul>
<p>1、序章：30 秒「无痛换芯」</p>
<p>当然，在开始评测之前，先搞定接入。</p>
<p>一句话总结：体验非常丝滑。</p>
<p>对于广大使用 Claude Code 的开发者，迁移到 Doubao-Seed-Code 的成本几乎为零，因为它一开始就原生兼容 Anthropic API，用户仅需修改配置文件中几行代码即可将模型切换到 Doubao-Seed-Code。而如果使用火山引擎官方的 CLI，veCLI，则可以直接使用 Doubao-Seed-Code 模型，无需额外配置。本文主要使用 Claude Code 进行测试。</p>
<p>不仅如此，开发者还能将 Doubao-Seed-Code 无缝集成到 Cursor、Cline、Codex CLI、Trae 等主流智能编程环境中，实现即连即用的高效体验。</p>
<p>总之，我们花了不到 30 秒就完成了这一切。下面，大考开始。</p>
<p>2、关卡一：Python 脚本重构</p>
<p>首先，我们尝试一个简单任务：让 Doubao-Seed-Code 将一个由 Gemini 生成的垃圾 Python 脚本重构成结构优良的脚本。</p>
<p>这是一个用于数据处理和报告的模拟脚本 ，但集各种陋习于一身：所有逻辑都塞在一个 main 函数里、使用了全局变量、混乱的 try/except 嵌套和 if/else 逻辑、到处都是 print () 语句、混合了数据获取和数据解析以及文件写入、注释混乱。</p>
<p>结果，耗时不到 3 分钟，Doubao-Seed-Code 不仅完成了对这个脚本的优雅重构，还主动编写了测试脚本，对重构后的代码进行了测试 。</p>
<p>Doubao-Seed-Code 的调试能力（软件工程）能力得到了初步验证，顺利过关。</p>
<p>3、关卡二：C++ 到 Python 跨语言重构</p>
<p>开胃菜结束，我们直接上硬菜，考验它的长上下文和任务规划能力。</p>
<p>任务： 将 GitHub 上一个开源的 C++/OpenGL 版《打砖块》游戏，完整重构为一个 Python 实现 。</p>
<ul>
<li>原项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsdavydouski%2Fbreakout%25C2%25A0" target="_blank" title="https://github.com/sdavydouski/breakout%C2%A0" ref="nofollow noopener noreferrer">github.com/sdavydouski…</a></li>
</ul>
<p>必须说明，这个任务并不简单。因为这已经不是简单的代码翻译，这几乎等于跨语言的项目重建。这个任务的难度体现在：</p>
<ul>
<li>
<p>范式鸿沟：模型需要处理 C++（静态编译型）和 Python（动态解释型）之间巨大的语法和设计范式差异。</p>
</li>
<li>
<p>API 转译：它必须理解 C++ 中底层的 OpenGL 图形 API，并将其智能地转译为 Python 生态中（如 Pygame ）的高级 API 和事件驱动的游戏循环。</p>
</li>
<li>
<p>项目级理解：最关键的是，这是一个完整的项目。模型必须利用其长上下文能力，一次性读懂代码库中所有 C++ 文件（.h 和 .cpp）的复杂依赖关系。</p>
</li>
<li>
<p>自主规划：它不能逐行翻译，而必须自主规划出一个全新的 Python 项目结构，并正确处理所有游戏素材。</p>
</li>
</ul>
<p>可以说这是对模型 256K 长上下文 和 Agentic 任务规划能力的一次压力测试。</p>
<p>我们将项目 clone 下来，启动配置好 Doubao-Seed-Code 的 Claude Code，然后输入一条指令：「将这个 C++ 项目重构为 Python 项目，使用其原本的素材。」接下来就是见证奇迹的时刻，以下视频展示了其最初的执行阶段：</p>
<p>可以看到，Doubao-Seed-Code 首先分析了整个代码库，准确理解了其功能和 C++/OpenGL 技术栈。然后，它制定了详细的重构计划，包括创建 Python 项目结构、安装 Pygame 库、建立游戏主类和游戏循环、重构游戏对象、实现关卡系统等等，并开始一步步执行 。</p>
<p>从实现到测试完成，整个项目耗时近 40 分钟，而我们所做的，仅仅是提供了最初的指令和中间的几次文件操作许可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ebe1f1122b4665b04d236dcb8018c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=xiwSp%2F81Jqq4%2BVq2u3r7jFTYXwk%3D" alt="图片" loading="lazy"/></p>
<p>项目结束时，Doubao-Seed-Code 给出的总结</p>
<p>一切完成后，Doubao-Seed-Code 还为我们撰写了详细的文档，并交付了一个完全可玩的 Python 版《打砖块》游戏。</p>
<p>Doubao-Seed-Code 重构的游戏完整可玩，且音乐也非常适配</p>
<p>这已经不是简单的「代码补全」，而是真正的「Agentic Coding」。它完美地践行了我们在引言中提到的 Agentic 路线：我们不再是逐行获取建议，而是将一个横跨范式鸿沟和 API 转译的复杂项目，完整地委托给它，由它自主规划并最终执行。这正是 Agentic Coding 的核心理念。</p>
<p>4、关卡三：从零开始的软件创造</p>
<p>在跨语言重构之后，我们想看看 Doubao-Seed-Code 从零开始构建一个全新项目的能力。</p>
<p>这一次，我们想让它为我们编写一个桌面宠物小程序。不过，在开始之前，我们遇到了一个很现实的问题：我们没有素材。</p>
<p>使用即梦，我们先生成了一张卡通树懒睡觉图，然后使用这张图继续让即梦生成了一段树懒站起来的视频。接下来，我们需要将其中的可爱树懒提取出来，并将背景透明化。在使用 ffmpeg 提取出所有帧之后，我们意识到接下来的工作完全可以让 Doubao-Seed-Code 来完成！</p>
<p>简单描述下我们的需求，剩下的就交给 Doubao-Seed-Code 了：</p>
<blockquote>
<p>这里有 300 帧图片，我需要你将其制作成 5 秒的 gif 动图。但首先，你需要提取出图中的人物，去掉背景和左上角及右下角的背景水印。给我一张透明背景的动图。</p>
</blockquote>
<p>Doubao-Seed-Code 立刻理解了任务，它安装了 rembg、imageio 等相关库，并帮我们完美地处理了所有原始帧，最终交付了两张我们需要的核心素材：sleep.gif 和 stand.gif。</p>
<p>接下来我们将素材放入项目文件夹，再次唤起 Doubao-Seed-Code，输入以下指令：</p>
<blockquote>
<p>使用 Python 编写一个桌面宠物小程序，这个宠物是一只卡通树懒，它一般在屏幕上睡觉（sleep.gif）。但如果用户点击它，它就会站起来 (stand.gif)。之后，它又会变回睡觉姿势。用户可以在屏幕上拖动它到任何位置。宠物画面宽度固定为 300px。透明背景。使用 assets 文件夹中的素材。</p>
</blockquote>
<p>同样，它一次性构建完成。</p>
<p>运行看看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78913e5f261640218cac9834a3aecaeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=NXcCzJjz7hxLas%2F9Mp9uNYoUNdc%3D" alt="图片" loading="lazy"/></p>
<p>这就是我们预期想要实现的目标！它不仅完全实现了我们指令中的所有功能（睡觉、点击站立、可拖动、透明背景），而且整个工作流（从 AI 生成素材、到 AI 处理素材、再到 AI 构建软件）都展现了极高的流畅度。</p>
<p>当然，我们还可以进一步与 Doubao-Seed-Code 交互，让其对这个桌面宠物进行改进，比如提供更多素材让其具备更加风格的动作库、设置双击它打开某个链接或 AI 助手、让它根据天气和时间自动执行执行不同的动作等等。</p>
<p>一个桌面宠物还不够。为了更好地领略它的创造能力，我们还让 Doubao-Seed-Code 从零开始构建了其它几个风格迥异的有趣项目。我们发现，它基本都是一次成形，偶尔需要的反馈也只是明确需求或提供额外信息。当遇到 Bug 时，我们也只需将报错信息直接反馈回去，它也能直接解决。</p>
<p>比如一个会动态演进的弹珠撞墙模拟程序：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ee9965867442eaa69525946265b36b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=Pwmx1ZbhqMZlqx8It9CpOsPKE44%3D" alt="图片" loading="lazy"/></p>
<p>提示词：用 Pyhon 写一个模拟程序：一个小球在一个六边形中弹跳。这个六边形的六条边各有特性，小球撞上不同的边会触发不同的效果。撞上边 1 会导致小球颜色随机变化，边 2 导致小球变大 10%，边 3 导致小球变小 10%，边 4 导致小球加速 20%，边 5 导致小球减速 20%。边 6 会在六边形中央克隆出一个一样的小球。如有文字，使用微软雅黑字体。</p>
<p>一个游玩难度颇大的邯郸学步小游戏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959c98c30bbe4605a099d4939b2cd418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465470&amp;x-signature=xPg%2B9hUKSZKE4Mx815NFPvtTIhk%3D" alt="图片" loading="lazy"/></p>
<p>构建一个邯郸学步小游戏。游戏一开始会随机展示一个火柴人走路或扭动的样子（四肢和头部随机摆动），玩家需要操控另一个火柴人模仿它并且只有 2 秒反应时间。模仿正确则得 1 分，错误扣 1 分。10 分玩家胜利，负 10 分则玩家失败。玩家使用方向键分别控制四肢，用空格键控制火柴人头部摆动。如有文字，使用微软雅黑字体。</p>
<p>我们甚至还让 Doubao-Seed-Code 基于我们之前关于<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650997783%26idx%3D1%26sn%3D0f796e9cbaf70b81378e4cb06ba7ea90%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650997783&amp;idx=1&amp;sn=0f796e9cbaf70b81378e4cb06ba7ea90&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"> Yoshua Bengio 引用量突破百万的报道</a>构建了一个像素风格的展示网页 —— 我们所做的仅仅是提供一份 docx 文档。</p>
<p>提示词：这里的 docx 文件是我们之前关于 Yoshua Bengio 引用量破百万的专题报道，请基于这些素材，构建一个介绍网页，生动地展示 Bengio 取得的这一成绩。使用多页网页的形式，采用现代、美观的像素风格，其中首页集中展示主要的信息，再通过几个按钮链接到其它网页。</p>
<p>从数据处理脚本、跨语言游戏移植，再到创意小程序和专题网站，Doubao-Seed-Code 在从零开始这一关卡中，充分展现了其强大的 Agentic 规划能力和工程实现能力。</p>
<p>5、关卡四：一个实际问题</p>
<p>最后，我们来让 Doubao-Seed-Code 解决一个实际问题。</p>
<p>作为一家专业的 AI 媒体，arXiv 上的新论文是机器之心日常报道的重要来源。但每天手动去刷几十位行业技术大佬的论文更新情况，费时费力还容易遗漏。</p>
<p>于是，我们决定让 Doubao-Seed-Code 帮我们解决这个痛点：构建一个「论文查找器」。首先，将我们的需求组合成一个提示词，表达清楚即可：</p>
<blockquote>
<p>用 Python 构建一个论文查找器，其功能为：检索 arXiv，找到用户提供的 authors 文件中所有人物过去一周内最新更新或发布的三篇论文，将结果输出为一个 Markdown 文件，内容包括人名、论文标题和链接。如果过去一周没有论文更新，则无需包含进来。作为参考，这是查询 Yoshua Bengio 论文的 arXiv API：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fexport.arxiv.org%2Fapi%2Fquery%3Fsearch_query%3Dau%3A%2BBengio_Yoshua%26sortBy%3DlastUpdatedDate%26sortOrder%3Ddescending%26max_results%3D100" target="_blank" title="https://export.arxiv.org/api/query?search_query=au:+Bengio_Yoshua&amp;sortBy=lastUpdatedDate&amp;sortOrder=descending&amp;max_results=100" ref="nofollow noopener noreferrer">export.arxiv.org/api/query?s…</a></p>
</blockquote>
<p>顺带一提，这一次我们选择在 Trae 中完成这个项目。</p>
<p>7 分钟，Doubao-Seed-Code 就搞定了一切。它还生成了一个 authors.txt 文件，里面包含 Geoffrey Hinton 等四位 AI 领域的传奇人物，现在我们为这份名单添加更多人物（包括近期有更新的作者），测试一下。</p>
<p>完美！现在，我只需要把它设置成一个定时任务，每天上午自动运行。我们再也不用担心错过前沿 AI 论文选题了。</p>
<p>三、最后聊点实在的：要花多少钱？</p>
<p>实战评测之后，终于到了最实在的部分：价格。毕竟，如果像 Claude Pro 那样有严格的用量限制或高昂的门槛，再强大的 Agentic Coder 也难以「飞入寻常百姓家」。</p>
<p>而在价格方面，Doubao-Seed-Code 也试图解决前文中提到的痛点。恰逢双十一，火山引擎同步推出了一个 Coding Plan 套餐包。</p>
<p>这个「方舟 Coding Plan」是专为开发者量身打造的 AI Coding 场景订阅服务。作为「双十一」的重头戏，它的套餐包价格非常亮眼：</p>
<ul>
<li>
<p>Lite 套餐（适合大多数开发者）：首购首月仅需 9.9 元 / 月；用一杯咖啡的价格」，就能享受一整个月的优质编码辅助。后续续费为 40 元 / 月。</p>
</li>
<li>
<p>Pro 套餐（适合复杂项目开发）：首购首月仅需 49.9 元；后续续费为 200 元 / 月。</p>
</li>
</ul>
<p>除了套餐包的巨大优惠，Doubao-Seed-Code 在调用价格上也实现了普惠开发者。它通过采用全量透明 Cache 技术，能使成本再降低 80%。不仅如此，火山引擎还为该模型推出了分层定价模式。官方表示，在实际使用场景中，综合使用成本可降低 62.7%，实现了目前国内最低价格。</p>
<p>总而言之，Doubao-Seed-Code 在尝试解决 Agentic Coding 路线性能问题的同时，也通过这个 Coding Plan 对前文提到的价格和用量限制痛点做出了回应。</p>
<p>四、强大的 Agentic Coder，更是完美平替？</p>
<p>从易到难再到我们日常工作中的实际问题，一场评测下来，我们认为连通四关的豆包编程模型 Doubao-Seed-Code 令人印象深刻，足称「强大」。而且很明显它与 IDE 增强路线的辅助补全不同，其核心能力更多体现在对复杂、多步骤任务的自主规划与执行上。</p>
<p>无论是重构屎山代码，还是挑战 C++/OpenGL 到 Python 的跨语言移植，亦或是从零孵化一只功能完备的「桌面树懒」；乃至帮我们解决 arXiv 刷论文的真实痛点，它都展现出了强大的 Agentic Coding 能力，证明了自己是 Agentic 路线的有力竞争者。</p>
<p>原生 256K 的长上下文能力及其背后 Coding RL Agent at Scale 的端到端强化学习训练共同构成了 Doubao-Seed-Code 应对「真实编程场景」的技术基础。</p>
<p>Doubao-Seed-Code 的意义还不止于技术。它不仅解决了 Agentic 路线的性能问题 ，更通过 Coding Plan 和 API 兼容性解决了开发者们在原版 Claude Code 上遇到的价格、用量限制乃至用户限制的痛点。</p>
<p>它不仅是一个高性能的结对工程师，也是一个高性价比、易于获取的前沿编程模型的「完美平替」。它让我们看到了 Agentic Coding 真正走向普惠、人人可用时代的可能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 4.0.1 版本正式发布]]></title>    <link>https://juejin.cn/post/7571191453126541338</link>    <guid>https://juejin.cn/post/7571191453126541338</guid>    <pubDate>2025-11-11T11:28:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126541338" data-draft-id="7571278865517314098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 4.0.1 版本正式发布"/> <meta itemprop="keywords" content="Apache,数据库"/> <meta itemprop="datePublished" content="2025-11-11T11:28:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 4.0.1 版本正式发布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:28:02.000Z" title="Tue Nov 11 2025 11:28:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>亲爱的社区小伙伴们，**Apache Doris 4.0.1 版本已于 2025 年 11 月 08 日正式发布。**此版本聚焦核心模块的打磨与优化，在 AI &amp; Search 方面实现了重要能力扩展，同时全面提升了 Lakehouse 与查询引擎的稳定性和性能。</p>
<ul>
<li>GitHub 下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris%2Freleases" target="_blank" title="https://github.com/apache/doris/releases" ref="nofollow noopener noreferrer">github.com/apache/dori…</a></li>
<li>官网下载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdownload" target="_blank" title="https://doris.apache.org/download" ref="nofollow noopener noreferrer">doris.apache.org/download</a></li>
</ul>
<h2 data-id="heading-0">行为变更</h2>
<ul>
<li><code>SHOW PARTITIONS</code> 命令不再支持 Iceberg 表，请直接使用 Iceberg 的 <code>$partitions</code> 系统表查看。#56985</li>
</ul>
<h2 data-id="heading-1">新增功能</h2>
<ul>
<li>新增 mmh64_v2 函数，用于生成与其他三方库相同的 Hash 结果。#57180</li>
<li>新增 json_hash 函数，支持对 JSONB 类型生成 Hash 值。#56962</li>
<li>新增 Binary 数据类型，并增加一系列函数 length、from_base64_binary、to_base64_bianry、sub_binary。#56648</li>
<li>新增 sort_json_object_keys / normalize_json_numbers_to_double 函数，用于对 JSONB 的 Key 进行排序。</li>
<li>新增与 MySQL 兼容的时间函数：UTC_DATE、UTC_TIME 及 UTC_TIMESTAMP。#57443</li>
<li>新增对 MaxCompute Schema 层级的支持。 #56874
<ul>
<li>相关文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2Flakehouse%2Fcatalogs%2Fmaxcompute-catalog%23hierarchical-mapping" target="_blank" title="https://doris.apache.org/docs/3.x/lakehouse/catalogs/maxcompute-catalog#hierarchical-mapping" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/la…</a></li>
</ul>
</li>
<li>JSON_OBJECT 函数支持使用 * 作为参数。#57256</li>
</ul>
<h2 data-id="heading-2">功能改进</h2>
<h3 data-id="heading-3">AI &amp; Search</h3>
<ul>
<li>为 SEARCH 函数新增短语查询、通配符查询和正则查询支持。#57372 #57007</li>
<li>扩展 SEARCH 函数参数，新增可选的 default_field 参数（默认列）和 default_operator 参数（指定多列查询的布尔运算符为 "and" 或 "or"）。#57312</li>
<li>SEARCH 函数新增对 Variant 类型子列的搜索支持，可通过点号语法（如 variantColumn.subcolumn：关键词）直接搜索 JSON 路径中的特定字段。</li>
<li>将倒排索引的默认存储格式由 V2 升级为 V3 版本。#57140</li>
<li>完善自定义分词器 Pipeline 支持，新增 char_filter 组件；在 Analyzer 框架中新增 Basic Tokenizer 和 和 ICU Tokenizer 两种内置分词器支持；新增内置分词器别名并支持组件同名配置，优化统一 Analyzer 框架。#57055</li>
</ul>
<h3 data-id="heading-4">Lakehouse</h3>
<ul>
<li>新增会话变量 <code>merge_io_read_slice_size_bytes</code> 来解决某些情况下，外表 Merge IO 读放大严重的问题。
<ul>
<li>相关文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fdocs%2F3.x%2Flakehouse%2Fbest-practices%2Foptimization%23merge-io-optimization" target="_blank" title="https://doris.apache.org/docs/3.x/lakehouse/best-practices/optimization#merge-io-optimization" ref="nofollow noopener noreferrer">doris.apache.org/docs/3.x/la…</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">查询</h3>
<ul>
<li>优化了 JOIN Shuffle 选择算法 #56279</li>
</ul>
<h3 data-id="heading-6">其他</h3>
<ul>
<li>优化了物理计划中 Runtime Filter 序列化信息的大小 #56978</li>
</ul>
<h2 data-id="heading-7">问题修复</h2>
<h3 data-id="heading-8">AI &amp; Search</h3>
<ul>
<li>修复非分词字段的 SEARCH 查询结果问题，支持在 MOW 表上执行 SEARCH 函数查询 #56927</li>
<li>修复倒排索引在执行 IS NULL 谓词过滤时的计算错误问题 #56964</li>
</ul>
<h3 data-id="heading-9">Lakehouse</h3>
<ul>
<li>修复某些情况下，谓词下推无法使用 Parquet Page Index 的问题 #55795</li>
<li>修复某些情况下外表查询分片读取丢失的问题 #57071</li>
<li>修复某些情况下，Hadoop 文件系统缓存开启导致修改 Catalog 属性不生效的问题 #57063</li>
<li>修复某些情况下，从旧版本升级时，连接属性校验导致元数据回放失败的问题 #56929</li>
<li>修复某些情况下，Refresh Catalog 导致 FE 线程死锁的问题 #56639</li>
<li>修复无法读取由 Hive 转换生成的 Iceberg 表的问题 #56918</li>
<li>修复某些情况下收集 Query Profile 导致 BE 宕机的问题 #56806</li>
</ul>
<h3 data-id="heading-10">查询</h3>
<ul>
<li>修复 datetime 类型在 Timezone 相关 Cast 时，边界条件下结果错误的问题 #57422</li>
<li>修复部分 datetime 相关函数结果精度推导不正确的问题 #56671</li>
<li>修复 inf 作为 float 的谓词条件时 Core 的问题 #57100</li>
<li>修复 explode 函数在可变参数下 Core 的问题 #56991</li>
<li>修复 decimal256 到 float 类型的 Cast 不稳定的问题 #56848</li>
<li>修复 Spill Disk 时可能出现重复调度导致 Core 的问题 #56755</li>
<li>修复偶发的错误调整 Mark Join 和其他 Join 顺序的问题 #56837</li>
<li>修复部分命令未被正确转发到 Master Frontend 执行的问题 #55185</li>
<li>修复偶现的窗口函数错误生成 Partition TopN 的问题 #56622</li>
<li>修复当同步物化视图定义中存在关键字时，查询可能报错的问题 #57052</li>
</ul>
<h3 data-id="heading-11">其他</h3>
<ul>
<li>禁止基于同步物化视图创建另外一个同步物化视图 #56912</li>
<li>修复 Profile 中存在内存未及时释放问题 #57257</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器]]></title>    <link>https://juejin.cn/post/7571191453126574106</link>    <guid>https://juejin.cn/post/7571191453126574106</guid>    <pubDate>2025-11-11T11:31:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126574106" data-draft-id="7571126773809512458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T11:31:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞最新长文：AI的下一个十年——构建真正具备空间智能的机器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:31:59.000Z" title="Tue Nov 11 2025 11:31:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在昨晚，关于其投身的空间智能，斯坦福大学教授李飞飞发表了一篇长篇博客《From Words to Worlds: Spatial Intelligence is AI’s Next Frontier》。</p>
<p>在文中，李飞飞详细解读了「空间智能究竟是什么？它为什么重要？我们如何构建它？我们又如何使用它？」她同时阐述了真正的空间智能世界模型必须实现的核心框架：构建具有故事讲述者想象力的 AI、具备第一响应者流畅性的 AI 以及以科学精确性进行空间推理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0152c9a32184bb285cd0c9393f29af0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=4n6v7VHVjnfO7HEtCMYd8nso8is%3D" alt="图片" loading="lazy"/></p>
<p>以下为全文翻译：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e7e903c3cab457e8ace1989f552ba99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=52laQu%2FVueTCLvqoyLxTbdoYZcY%3D" alt="图片" loading="lazy"/></p>
<p>1950 年，当计算机还只是自动化的算术和简单逻辑时，艾伦・图灵提出了一个至今仍余音不绝的问题：机器能思考吗？他拥有非凡的想象力，看到了一个超越时代的可能 —— 智能或许可以被「构建」，而非「诞生」。这一洞见开启了一个持久而伟大的科学征程 —— 人工智能（AI）。在我投身人工智能研究二十五年后的今天，图灵的愿景仍让我心怀敬意与灵感。但我们究竟走到了哪一步？答案并不简单。</p>
<p>如今，以大语言模型（LLM）为代表的前沿 AI 技术，已经开始改变我们获取和运用抽象知识的方式。然而，它们依然像是「黑暗中的文匠」：能言善辩却缺乏经验，知识丰富却脱离现实。空间智能将彻底改变我们创造和交互现实与虚拟世界的方式 —— 它将重塑叙事、创意、机器人学、科学发现等领域。这正是 AI 的下一个前沿。</p>
<p>自我踏入这一领域以来，对视觉与空间智能的追求一直是我心中的北极星。这也是我花费多年时间创建 ImageNet 的原因 —— 这是首个大规模视觉学习与评测数据集，与神经网络算法和现代计算（如图形处理器 GPU）一道，构成了现代人工智能诞生的三大基石。这也是为什么我的斯坦福实验室在过去十年中，持续探索将计算机视觉与机器人学习相结合。</p>
<p>而这一追求，也促使我与合伙人 Justin Johnson、Christoph Lassner、Ben Mildenhall 共同创立了 World Labs—— 在一年多前，我们立志首次将这一愿景彻底实现。在这篇文章中，我将阐述什么是空间智能、它为何重要，以及我们如何构建能够释放空间智能潜力的世界模型 —— 这种能力将深刻影响创造力、具身智能与人类的未来进步。</p>
<p>空间智能：</p>
<p>人类认知的脚手架</p>
<p>人工智能正处在前所未有的激动人心时刻。生成式 AI 模型 —— 例如大语言模型（LLM）—— 已经从研究实验室走入日常生活，成为数十亿人创造、工作与沟通的工具。它们展现出了曾被认为不可能的能力：能够轻松生成连贯的文本、海量的代码、逼真的图像，甚至短视频片段。如今，问题已不再是「人工智能是否会改变世界」，而是「它已经如何改变了世界」。</p>
<p>然而，仍有许多目标尚未触及。自主机器人的愿景依旧令人神往，却依然停留在推测阶段，离未来学家长期描绘的日常现实仍有距离。在疾病治疗、新材料发现、粒子物理等领域，人工智能加速科研的梦想也尚未真正实现。而一种能够真正理解并赋能人类创造者的 AI—— 无论是学习分子化学复杂概念的学生、构思空间的建筑师、构建世界的电影创作者，还是渴望沉浸式虚拟体验的任何人 —— 这一承诺仍未兑现。</p>
<p>要理解这些能力为何依然难以实现，我们需要回溯空间智能的演化历程，并审视它如何塑造了我们对世界的理解。</p>
<p>视觉一直是人类智能的基石，但它的力量源自更为根本的东西。早在动物学会筑巢、照料幼崽、用语言交流或建立文明之前，最简单的「感知」行为，便悄然点燃了一场通向智能的进化旅程。</p>
<p>这种看似孤立的能力 —— 从外部世界中提取信息，无论是一道微光，还是一种触感 —— 在感知与生存之间搭起了一座桥梁，并随着世代更迭不断加固、延展。神经元层层叠加，沿着这座桥梁生长，形成了能解释世界、协调生物体与环境互动的神经系统。正因如此，许多科学家推测，感知与行动构成了驱动智能演化的核心循环，也成为自然创造人类这一物种的根基 —— 一种集感知、学习、思考与行动于一体的终极体现。</p>
<p>空间智能在定义人类如何与物理世界互动中起着根本性的作用。每天，我们都依赖它完成最平常的行为：停车时通过想象车尾与路缘之间逐渐缩小的间隙来判断距离；接住被人扔来的钥匙；在人群密集的人行道上穿行而不相撞；或者在半睡半醒间不看杯子也能准确地把咖啡倒进去。在更极端的情境中，消防员在浓烟弥漫、结构不断坍塌的建筑中穿行，瞬间判断稳定与危险，依靠手势、身体语言以及一种无法用言语表达的职业直觉进行协作。</p>
<p>而婴儿在还未学会说话的数月甚至数年中，正是通过与环境的嬉戏互动来认识世界。所有这一切都在无意识间、自动地完成 —— 这种流畅性，是机器至今尚未具备的。</p>
<p>空间智能同样是人类想象力与创造力的基础。讲故事的人在脑海中构建独特而丰富的世界，并借助各种视觉媒介将其传达给他人 —— 从史前的洞穴壁画，到现代电影，再到沉浸式电子游戏。无论是孩子在沙滩上筑起的沙堡，还是他们在电脑上玩《我的世界》所创造的空间，这种基于空间的想象力构成了现实与虚拟世界中交互体验的核心。而在众多行业应用中，对物体、场景和动态交互环境的模拟，正支撑着从工业设计到数字孪生再到机器人训练的无数关键业务场景。</p>
<p>纵观历史，空间智能在推动文明发展的关键时刻屡次扮演核心角色。在古希腊，埃拉托色尼通过几何化阴影来揭示地球的尺度 —— 他在亚历山大测量出七度的日影角度，并在太阳直射、影子消失的赛恩进行对比，计算出了地球的周长。哈格里夫斯通过一个空间构想发明了「珍妮纺纱机」：将多个纺锤并列在同一架构中，使一个工人能够同时纺出多股纱线，生产效率因此提升八倍。沃森和克里克通过亲手搭建三维分子模型、不断调整金属板与铁丝的位置，最终发现了 DNA 的双螺旋结构。</p>
<p>当科学家与发明家需要操纵物体、想象结构、推理空间关系时，正是空间智能推动了人类文明的跃进 —— 而这些都无法仅凭文字所捕捉。</p>
<p>空间智能是支撑人类认知的脚手架。无论我们是在被动观察，还是主动创造，它都在发挥作用。它驱动我们的推理与规划，哪怕是在最抽象的思维领域；它也是我们与他人、与环境进行互动 —— 无论通过语言还是行动 —— 所必不可少的能力。虽然我们大多数人并不会像埃拉托色尼那样揭示新的宇宙真理，但我们几乎每天都以相似的方式思考 —— 通过感官理解复杂的世界，并凭借对物理与空间规律的直觉掌握，来形成认知与判断。</p>
<p>遗憾的是，当下的人工智能尚未具备这种思维方式。</p>
<p>过去几年，AI 的确取得了巨大进步。多模态大语言模型（MLLM）在文本之外引入了海量的多媒体数据，使 AI 具备了初步的空间感知能力。如今，AI 已经能够分析图像、回答相关问题，并生成高度逼真的图片和短视频。借助传感器与触觉技术的突破，最先进的机器人也开始能够在高度受限的环境中操纵物体与工具。</p>
<p>然而，坦率地说，AI 的空间能力仍与人类相距甚远，这一差距显而易见。最先进的多模态模型在估算距离、方向和大小等任务上，其表现往往仅略高于随机水平；在「心智旋转」（从不同角度重新生成物体）的测试中也极为有限。它们无法穿越迷宫，不能识别捷径，也无法预测最基本的物理规律。AI 生成的视频 —— 虽令人惊叹，但往往在数秒后便失去连贯性。</p>
<p>当前最先进的 AI 在阅读、写作、研究和数据模式识别方面表现出色，但在对物理世界的表征与交互上却存在根本性局限。人类对世界的理解是整体性的 —— 不仅关乎我们「看见了什么」，还包括事物在空间上的关系、它们的意义以及彼此的关联。通过想象、推理、创造与互动来理解世界，而非仅仅依赖语言描述，这正是空间智能的力量。没有它，AI 就与它试图理解的物理现实脱节，无法真正安全高效地驾驶汽车、引导家庭或医院中的机器人，也难以实现学习与娱乐中的沉浸式互动体验，更无法加速材料科学与医学中的突破性发现。</p>
<p>哲学家维特根斯坦曾说，「我的语言的界限意味着我的世界的界限」。我不是哲学家，但我深知，对人工智能而言，世界远不止语言本身。空间智能代表着超越语言的前沿 —— 它连接了想象、感知与行动，开启了机器真正赋能人类生活的可能，从医疗到创造力，从科学发现到日常助理。</p>
<p>AI 的下一个十年：</p>
<p>构建真正具备空间智能的机器</p>
<p>那么，我们该如何打造具备空间智能的 AI？通往那样的模型之路是什么样的？它不仅能像埃拉托色尼那样进行空间推理，像工业设计师那样精准构造，像讲故事的人那样富于想象，还能像应急救援人员那样自然地与环境互动。</p>
<p>要实现空间智能，我们需要的远不止 LLM 那样的体系，而是更具雄心的「世界模型」—— 一种新型生成式模型，能够在语义、物理、几何与动态等多重复杂世界（无论虚拟还是现实）中进行理解、推理、生成与交互。</p>
<p>这一领域仍处在萌芽阶段，当前的研究方法从抽象推理模型到视频生成系统皆有涉及。World Labs 正是在这一信念之上，于 2024 年初创立：即世界模型的基础方法尚在确立之中，而这正是未来十年人工智能的关键挑战所在。</p>
<p>在这一新兴领域中，最重要的是确立指导发展的基本原则。对于空间智能而言，我将「世界模型」定义为具备以下三种核心能力的系统：</p>
<p>一是生成性：世界模型能够生成在感知、几何与物理层面保持一致的世界。</p>
<p>要解锁空间理解与推理的能力，世界模型必须能够生成属于自己的模拟世界。它需要具备创造出无限多样的虚拟世界的能力，这些世界必须遵循语义或感知层面的指令，同时在几何、物理和动态层面保持一致性 —— 无论这些世界对应的是现实空间还是虚拟空间。研究界目前正积极探索这些世界的内部几何结构应当以隐式还是显式的方式表示。</p>
<p>除此之外，我认为，除了强大的潜在表征之外，一个通用的世界模型还必须能够生成明确、可观测的世界状态，以适配不同的应用场景。尤其重要的是，它对当前世界的理解，必须与过去保持连贯 —— 与导致这一现状的先前世界状态相一致。</p>
<p>二是多模态性：世界模型在设计上即是多模态的。</p>
<p>正如动物与人类一样，世界模型应能够处理多种形式的输入 —— 在生成式 AI 中通常被称为提示词。当输入信息不完整时，无论是图像、视频、深度图、文本指令、手势还是动作，世界模型都应能够预测或生成尽可能完整的世界状态。这要求模型具备如真实视觉般处理视觉输入的能力，同时又能同样熟练地理解语义指令。这样的能力使得智能体与人类能够通过多样化的输入方式与模型就世界进行交流，并获得多样化的输出反馈。</p>
<p>三是交互性：世界模型能够根据输入的动作生成下一个世界状态。</p>
<p>当动作和 / 或目标成为世界模型的输入提示时，其输出必须包括世界的下一个状态 —— 可以是隐式的，也可以是显式的。当输入仅包含一个动作，或者包含动作与目标状态时，世界模型应能生成与先前世界状态、预期目标（若有）、语义含义、物理规律及动态行为相一致的输出。随着空间智能世界模型在推理与生成能力上的不断增强，可以想见，在某些情况下，模型不仅能预测世界的下一状态，还能基于这一新状态，进一步预测实现目标所需的下一步行动。</p>
<p>这一挑战的规模，超出了人工智能以往所面对的一切。</p>
<p>语言只是人类认知中一种纯粹的生成现象，而「世界」则遵循着远为复杂的规律。在地球上，重力主宰着运动，原子结构决定了光如何产生色彩与亮度，无数物理定律约束着每一次交互。即便是最奇幻、最具创造力的世界，其构成的空间物体与行动主体，也都必须服从特定的物理法则与动态行为。要在语义、几何、动态与物理层面上实现一致的统一与协调，需要全新的技术与理论路径。</p>
<p>相较于语言这样一维、顺序性的信号，对「世界」的表征在维度与复杂度上要庞大得多。要让世界模型具备人类所拥有的那种普适能力，必须突破多个艰巨的技术壁垒。在 World Labs，我们的研究团队正致力于在这一目标上取得根本性的进展。</p>
<p>以下是我们当前的一些研究方向：</p>
<p>1、一种新的通用训练任务函数：</p>
<p>为世界模型定义一种像 LLM 中的「下一 token 预测」那样简洁优雅的通用任务函数，一直是该领域的核心目标之一。然而，由于世界模型在输入与输出空间上的复杂性，使得这种函数的构建本身极具挑战。尽管仍有大量未知有待探索，但这种目标函数及其对应的表征方式，必须能够反映几何与物理规律，体现世界模型作为联结想象与现实的基础性表征体系的本质特征。</p>
<p>2、大规模训练数据：</p>
<p>训练世界模型所需的数据远比文本更为复杂。好消息是，大规模数据源已经存在。互联网上海量的图像与视频，提供了丰富且可获取的训练材料，真正的挑战在于如何研发能够从二维图像或视频帧（即 RGB 信号）中提取更深层空间信息的算法。过去十年的研究表明，在语言模型中，数据量与模型规模之间存在明确的「scaling laws」；对于世界模型而言，关键在于构建能够在相似规模上充分利用现有视觉数据的架构。</p>
<p>此外，高质量的合成数据，以及诸如深度信息与触觉信息等额外模态，也将在训练过程中的关键阶段发挥重要作用。但要实现这一目标，我们仍需更先进的传感系统、更稳健的信号提取算法，以及更强大的神经模拟方法。</p>
<p>3、新型模型架构与表征学习：</p>
<p>世界模型的研究将不可避免地推动模型架构与学习算法的革新，尤其是在超越当前 MLLM 与视频扩散模型范式的方向上。现有方法通常将数据离散化为一维或二维序列，这使得一些简单的空间任务变得不必要地困难 —— 比如统计短视频中独特的椅子数量，或记住一个房间一小时前的样子。替代性架构可能带来突破，例如具备三维或四维感知能力的分词、上下文和记忆机制。</p>
<p>以 World Labs 为例，我们最近开发的实时生成帧模型 RTFM（Real-Time Frame-based Model）正体现了这一方向的转变。它将空间锚定的帧作为一种空间记忆形式，在保持生成世界连续性与一致性的同时，实现了高效的实时生成。</p>
<p>显然，在通过世界模型彻底释放空间智能之前，我们仍面临着艰巨的挑战。这项研究不仅仅是理论探索，它将成为新一代创造力与生产力工具的核心引擎。而来自 World Labs 的最新进展令人振奋。我们近日首次向少量用户展示了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650991095%26idx%3D1%26sn%3D2d4b5c89e7051cbb8eaedfdf3428e1ad%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650991095&amp;idx=1&amp;sn=2d4b5c89e7051cbb8eaedfdf3428e1ad&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Marble</a> 的早期成果 —— 这是首个能够通过多模态输入进行提示，从而生成并维持一致性三维环境的世界模型。用户与创作者可以在其中探索、交互，并在创作流程中不断扩展这一虚拟世界。我们也正全力推进，让它尽快向公众开放。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ac8bae604b43a2b30babd1d81059e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763465518&amp;x-signature=ldsL%2F57VFO4zr4GlxBzuVJYUM7Q%3D" alt="图片" loading="lazy"/></p>
<p>Marble 只是我们迈向真正具备空间智能的世界模型的第一步。随着研究不断加速，更多科学家、工程师、用户与商业领袖开始意识到它所蕴含的巨大潜能。新一代的世界模型将使机器在空间智能方面达到全新的高度，这将开启当今 AI 系统仍普遍缺乏的关键能力。</p>
<p>利用世界模型，</p>
<p>为人类创造更美好的世界</p>
<p>人工智能的发展动力至关重要。作为推动现代人工智能时代到来的一名科学家，我的初心始终清晰：AI 应当增强人类能力，而非取而代之。多年来，我一直致力于让 AI 的研发、应用与治理与人类需求保持一致。如今，关于科技乌托邦或末日论的极端叙事层出不穷，但我依然坚持一种更务实的观点：AI 由人类创造、由人类使用、也应由人类治理。它必须始终尊重人的自主性与尊严。</p>
<p>AI 的真正魅力，在于扩展我们的能力，使我们变得更加富有创造力、更加紧密相连、更高效、更有成就感。空间智能正是这种愿景的体现 —— 一种能让创作者、照护者、科学家与梦想家实现曾经不可能之事的 AI。这一信念，是我将空间智能视为人工智能下一个伟大前沿的根本动力。</p>
<p>空间智能的应用涵盖不同的时间维度。面向创作者的工具正在崭露头角 ——World Labs 的 Marble 已经让创作者与讲述者能够直接掌握这些能力。机器人学则代表了中期的雄心目标，我们正不断完善感知与行动之间的闭环。而那些最具变革性的科学应用可能需要更长时间，但它们有望对人类的繁荣产生深远影响。</p>
<p>纵观这些不同阶段，有几个领域格外值得关注，因为它们最有潜力重塑人类能力。要实现这一愿景，需要集体的巨大努力，远超任何一个团队或公司的能力范围。这需要整个 AI 生态系统的共同参与：研究者、创新者、企业家、公司，乃至政策制定者，都必须携手朝着共同的愿景前进。而这一愿景，值得我们全力以赴。接下来，让我们看看这个未来将带来什么。</p>
<p>创造力：赋能故事叙述与沉浸式体验</p>
<p>「创造力是智力在享受乐趣。」这是我最喜爱的名言之一，出自我的精神偶像阿尔伯特・爱因斯坦。早在文字出现之前，人类就已经在讲述故事 —— 他们将故事绘在洞穴的石壁上，口耳相传，代代延续，并以共同的叙事建构出整个文化。故事是人类理解世界的方式，是跨越时空的纽带，是我们探索「何为人」的途径，更是我们在生命与爱中寻找意义的核心。</p>
<p>如今，空间智能有潜力彻底改变我们创造与体验故事的方式 —— 不仅尊重叙事本身的根本价值，更将其影响力从娱乐延展到教育，从设计延伸到建筑，让创造与体验的边界得到全新拓展。</p>
<p>World Labs 的 Marble 平台正把前所未有的空间创造力与编辑控制力交到电影制作人、游戏设计师、建筑师以及各类叙事创作者手中，使他们能够快速创建并迭代可自由探索的三维世界，而无需承担传统 3D 设计软件所带来的复杂成本。创作行为依然保持其独特的人性与活力，而 AI 工具只是放大并加速了创作者能够实现的潜能。这其中包括：</p>
<p>在新维度中展开叙事体验：电影制作人和游戏设计师正在利用 Marble 创造完整的世界，不再受制于预算或地理的限制，他们得以探索传统制作流程中难以企及的场景与视角。随着不同媒介与娱乐形式之间的界限逐渐模糊，我们正迈向一种全新的交互体验形态，艺术、模拟与游戏的融合体。在这些个性化的世界中，不仅是大型工作室，任何人都可以创造并居住在属于自己的故事里。随着从概念与分镜到完整体验的生成过程变得更加快捷高效，叙事将不再局限于单一媒介，创作者可以自由地在多种平台与载体之间，构建互相关联的世界与故事线。</p>
<p>通过设计讲述空间叙事：几乎所有的制造物与建筑空间，在被实体化之前，都必须先在虚拟三维世界中完成设计。这一过程迭代频繁，且在时间与成本上代价高昂。借助具备空间智能的模型，建筑师可以在动工之前快速可视化建筑结构，甚至漫步于尚未存在的空间中，从而以一种讲故事的方式，探索人类未来的生活、工作与聚会方式。工业设计师与时尚设计师则能瞬间将想象转化为形态，直观地探索物体与人体及空间之间的关系。</p>
<p>全新的沉浸式与交互式体验：体验本身，是人类创造意义最深层的方式之一。在漫长的人类历史中，我们共享的唯一三维世界是物理世界。直到近几十年，随着游戏与早期 VR 的出现，我们才开始窥见人类自造「平行世界」的可能。如今，空间智能结合 VR、XR 头显以及沉浸式显示设备等新形态，将这种体验提升到了前所未有的高度。我们正迈向一个时代 —— 走进一个完全实现的多维世界，将如同打开一本书般自然。空间智能让「造世界」的能力不再只是专业团队与大型工作室的特权，而是向个人创作者、教育者以及任何怀抱想象的人开放。</p>
<p>机器人：具身智能的实践</p>
<p>从昆虫到人类，动物都依赖空间智能来理解、导航并与周围世界互动。机器人也将如此。自这一领域诞生以来，具备空间感知能力的机器一直是其终极目标 —— 这也包括我与斯坦福实验室学生和合作伙伴多年来的研究工作。这正是我对 World Labs 正在构建的世界模型充满期待的原因之一，因为它们有望真正让这一愿景成为现实。</p>
<p>通过世界模型扩展机器人的学习能力：</p>
<p>机器人的学习进步，取决于能否找到一种可扩展的训练数据解决方案。鉴于机器人在理解、推理、规划与交互中所面对的庞大状态空间，许多研究者推测，只有结合互联网数据、合成仿真以及人类演示的真实捕获，才能真正培育出具备泛化能力的机器人。</p>
<p>然而，与语言模型不同，目前机器人研究的数据极其匮乏。世界模型将在此发挥决定性作用。随着其感知精度与计算效率的提升，世界模型的输出能够快速缩小模拟与现实之间的差距，从而帮助机器人在无数状态、交互与环境的仿真中进行训练。</p>
<p>人类的伙伴与协作者：</p>
<p>作为人类的协作者，无论是在实验台前协助科学家，还是陪伴独居长者，机器人都能在劳动力与生产力极度紧缺的领域中提供支持。但要做到这一点，它们必须具备空间智能 —— 既能感知、推理、规划、行动，又能（这点最为重要）保持对人类目标与行为的情感共鸣与理解。</p>
<p>例如，在实验室中，机器人可以代替科学家操作仪器，让人类专注于更需要灵巧与推理的任务；在家庭中，助理机器人可以帮助老人烹饪，而不削减他们的自主性与生活乐趣。真正具备空间智能的世界模型 —— 能够预测下一状态，甚至推测与之相符的行动 —— 是实现这一目标的关键。</p>
<p>拓展具身智能的形态：</p>
<p>人形机器人在我们构建的世界中确有其角色，但创新的全部潜力将来自更为多样的设计形式：如可输送药物的纳米机器人、能穿越狭窄空间的软体机器人、以及适用于深海或外太空的探索型机器。无论形态如何，未来的空间智能模型都必须同时整合机器人所处的环境与其自身的感知与运动方式。</p>
<p>然而，这类机器人的发展面临的核心难题，是缺乏适用于多种具身形态的训练数据。世界模型将在这一过程中发挥关键作用 —— 它们将为仿真数据的生成、训练环境的构建以及评测任务的制定提供基础支撑。</p>
<p>更长远的视野：科学、医疗与教育</p>
<p>除了创意与机器人领域，空间智能的深远影响还将扩展至那些 AI 能够以拯救生命、加速发现等方式增强人类能力的领域。以下我将重点谈及三个具有深刻变革潜力的方向，但显而易见，空间智能的应用远不止于此，它将在更多行业中展现出广阔的前景。</p>
<p>在科学研究中，具备空间智能的系统能够模拟实验、并行检验假设、探索人类难以到达的环境 —— 从深海到遥远的行星。这项技术将重塑气候科学、材料研究等领域的计算建模方式。通过将多维度的仿真与真实世界的数据采集相结合，这类工具可以降低计算壁垒，拓展每一个实验室的观察与理解边界。</p>
<p>在医疗领域，空间智能将从实验室到病房，全面改变医学实践。在斯坦福，我与学生及合作伙伴多年来与医院、养老机构以及家庭患者紧密合作，这段经历让我更加坚信空间智能在医疗中的变革潜力。AI 可以通过多维建模加速药物发现；通过模式识别辅助放射科医生提升影像诊断的准确性；并通过环境感知式监护系统支持患者与护理者，而不削弱康复所需的人际联系。更不用说，具备空间智能的机器人也能在不同场景中，为医护人员与患者提供强大的帮助。</p>
<p>在教育领域，空间智能能够让抽象或复杂的概念变得可感知、可体验，从而实现沉浸式学习。它还能创造出与人类大脑与身体学习机制高度契合的迭代式学习体验。在 AI 时代，更快、更高效的学习与再培训，对学生与成年人都至关重要。学生可以以多维视角探索细胞运作机制，或亲身「走入」历史事件；教师则能借助交互式环境实现个性化教学；而外科医生、工程师等专业人士则可在逼真的仿真环境中安全练习复杂技能。</p>
<p>无论在哪个领域，空间智能所带来的可能性几乎没有边界，但目标始终如一：让 AI 增强人类的专业能力，加速人类的发现，放大人类的关怀 —— 而不是取代构成人之为人的核心品质：判断力、创造力与共情力。</p>
<p>结语</p>
<p>在过去的十年里，人工智能已成为全球现象，并成为技术、经济乃至地缘政治的转折点。然而，作为一名研究者、教育者以及如今的创业者，真正激励我的，仍然是图灵在 75 年前提出的那个问题背后的精神。我依然与他一样，怀抱着对智能的惊奇与敬畏。正是这种好奇与挑战的魅力，让我每天都为空间智能的探索而充满动力。</p>
<p>在人类历史上，我们首次有能力构建出与物理世界深度契合的机器，让它们成为我们在应对重大挑战时值得信赖的伙伴。无论是加速我们在实验室中对疾病的理解，革新我们讲述故事的方式，还是在疾病、伤痛或衰老带来的脆弱时刻给予支持，我们正站在一项能够提升人类最珍视生活要素的技术门槛上。这是一个让生命更加深刻、更加丰盈、更加有力量的愿景。</p>
<p>距自然在远古动物身上首次点燃空间智能的火花，已过去近五亿年。而我们有幸身处这样一个时代，或许很快，我们将让机器也拥有同样的能力；更幸运的是，我们能够将这种能力用于造福全人类。如果没有空间智能，我们对「真正智能机器」的梦想就永远无法完整。</p>
<p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdrfeifei.substack.com%2Fp%2Ffrom-words-to-worlds-spatial-intelligence" target="_blank" title="https://drfeifei.substack.com/p/from-words-to-worlds-spatial-intelligence" ref="nofollow noopener noreferrer">drfeifei.substack.com/p/from-word…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[✍️记录自己的git分支管理实践]]></title>    <link>https://juejin.cn/post/7571272874847273012</link>    <guid>https://juejin.cn/post/7571272874847273012</guid>    <pubDate>2025-11-11T15:56:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874847273012" data-draft-id="7571280402965446691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="✍️记录自己的git分支管理实践"/> <meta itemprop="keywords" content="Git,前端,后端"/> <meta itemprop="datePublished" content="2025-11-11T15:56:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="你的人类朋友"/> <meta itemprop="url" content="https://juejin.cn/user/4051056254523991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ✍️记录自己的git分支管理实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4051056254523991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    你的人类朋友
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T15:56:32.000Z" title="Tue Nov 11 2025 15:56:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>👋 你好啊，我是你的人类朋友！</p>
<p>因为本人的开发经常涉及各个分支间的同步，这一套同步的流程从刚开始的小心翼翼，到现在相对熟悉了</p>
<p>所以我想记录下自己工作中常用的分支同步的步骤 😆</p>
<p>顺便研究康康有没有可以优化的地方 🍃</p>
<h2 data-id="heading-1">正文</h2>
<p>先介绍下背景情况吧</p>
<p>首先主分支为 <code>master</code></p>
<p>其次，因为开发分为多个阶段，比如 <code>phase_1</code>、<code>phase_2</code>、<code>phase_3</code> 等</p>
<p>那就在 <code>master</code> 之后再创建 <code>feature/phase_1</code>、<code>feature/phase_2</code> 这样的分支，作为每一个 <code>phase</code> 的主分支</p>
<p>每一个人的开发分支可以这样安排：我叫江建清，所以我的 <code>phase2阶段</code> 的开发分支的名称为<code>feature/phase_2_devjjq</code></p>
<p>重点来了，我现在要将我的 <code>feature/phase_2_devjjq</code> 分支的改动同步到 <code>feature/phase_2</code> 分支中</p>
<p>如何操作呢？</p>
<p><strong>重点！重点！重点！</strong></p>
<blockquote>
<p>先上 git 命令，后面有文字版</p>
</blockquote>
<ol>
<li><code>git checkout feature/phase_2</code></li>
<li><code>git pull origin feature/phase_2</code></li>
<li><code>git checkout feature/phase_2_devjjq</code></li>
<li>【✨ 将冲突放到 <code>feature/phase_2_devjjq</code> 分支解决，完全不影响 <code>feature/phase_2</code>】<code>git merge feature/phase_2</code></li>
<li>解决好可能存在的冲突【注意，如果此处存在冲突，要进行解决，并且要做好测试。确保无误之后再进行后续的同步。⚠️❗ 核心的思路是：绝不可以将不能确定解决之后是否存在异常的内容推送到当前阶段的主分支，这一点在低代码领域尤其突出，需要更加谨慎】，然后将代码提交到 <code>feature/phase_2_devjjq</code> 分支中</li>
<li><code>git checkout feature/phase_2</code></li>
<li><code>git merge feature/phase_2_devjjq</code></li>
<li><code>git push origin feature/phase_2</code></li>
</ol>
<p>上面就是我目前的大致做法了。</p>
<p>用文字总结就是：</p>
<ol>
<li>先切换到 <code>feature/phase_2</code> 分支</li>
<li>拉取<code>feature/phase_2</code>的最新代码（因为各个同事都会开发，也都会向这个分支提交代码）</li>
<li>切换到 <code>feature/phase_2_devjjq</code> 分支</li>
<li>合并 <code>feature/phase_2</code> 分支到 <code>feature/phase_2_devjjq</code> 分支</li>
<li>解决可能存在的冲突</li>
<li>切换到 <code>feature/phase_2</code> 分支</li>
<li>合并 <code>feature/phase_2_devjjq</code> 分支到 <code>feature/phase_2</code> 分支</li>
<li>推送 <code>feature/phase_2</code> 分支到远程仓库</li>
</ol>
<p>好了，那我的流程有哪些可以优化的地方？</p>
<h3 data-id="heading-2">优化流程</h3>
<p>当前的流程总结下来是这样的：</p>
<p>步骤分解：</p>
<ol>
<li>
<p>git checkout feature/phase_2 ✅</p>
</li>
<li>
<p>git pull origin feature/phase_2 ✅</p>
</li>
<li>
<p>git checkout feature/phase_2_devjjq ✅</p>
</li>
<li>
<p>git merge feature/phase_2 ⚠️ (产生合并提交)</p>
</li>
<li>
<p>解决冲突 ✅</p>
</li>
<li>
<p>git checkout feature/phase_2 ✅</p>
</li>
<li>
<p>git merge feature/phase_2_devjjq ⚠️ (再次产生合并提交)</p>
</li>
<li>
<p>git push origin feature/phase_2 ✅</p>
</li>
</ol>
<p>我们可以这样优化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1-2. 更新目标分支（保持不变）</span>
git checkout feature/phase_2
git pull origin feature/phase_2

<span class="hljs-comment"># 3. 切换到开发分支</span>
git checkout feature/phase_2_devjjq

<span class="hljs-comment"># 4. ✨ 关键优化：使用 rebase 而不是 merge。这个步骤做的事情其实就是将 feature/phase_2_devjjq 分支的提交放到 feature/phase_2 分支的最新提交之后。</span>
git rebase feature/phase_2

<span class="hljs-comment"># 5. 解决可能的冲突（在 rebase 过程中）</span>
<span class="hljs-comment"># 如果有冲突：</span>
git add .
git rebase --<span class="hljs-built_in">continue</span>

<span class="hljs-comment"># 6-7. 快速前进合并</span>
git checkout feature/phase_2
git merge feature/phase_2_devjjq  <span class="hljs-comment"># 这会是一个 fast-forward 合并</span>

<span class="hljs-comment"># 8. 推送</span>
git push origin feature/phase_2
</code></pre>
<blockquote>
<p>之前有写过关于 <strong>git 变基</strong>的文章，不太清楚这个概念的小伙伴可以<a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">去康康</a></p>
</blockquote>
<blockquote>
<p>关于<strong>git 的快速合并</strong>，我之前也有写过文章，不太清楚的小伙伴可以<a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">去康康！</a></p>
</blockquote>
<h3 data-id="heading-3">详细解读</h3>
<p>我原来的流程会产生多余的合并提交，让提交历史变得复杂。</p>
<p><strong>我的优化核心：</strong> 在第 4 步用 <code>rebase</code> 代替 <code>merge</code></p>
<p><strong>优化后的效果是什么呢？</strong></p>
<ul>
<li>将我的提交“移植”到 phase_2 最新代码之后，保持提交线整洁</li>
<li>后续合并时能使用快速前进，不产生额外合并提交</li>
<li>最终提交历史是清晰的一条直线，便于追踪</li>
</ul>
<p><strong>😎 小总结：</strong> 我用 rebase 让我的改动“接上”最新代码，merge 时直接快速前进，保持提交历史干净利落。</p>
<h2 data-id="heading-4">最后</h2>
<p>✍️ 上面就是我想分享的分支管理实践了以及优化后的效果了</p>
<p>抛砖引玉，希望能对大家有所帮助！</p>
<h2 data-id="heading-5">相关链接</h2>
<ul>
<li><a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">说说 git 的变基</a></li>
<li><a href="https://juejin.cn/post/7540877562266419236" target="_blank" title="https://juejin.cn/post/7540877562266419236">git 中的 Fast-Forward 是什么？</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库读写分离下如何解决主从同步延迟问题]]></title>    <link>https://juejin.cn/post/7571102074039451689</link>    <guid>https://juejin.cn/post/7571102074039451689</guid>    <pubDate>2025-11-11T14:07:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074039451689" data-draft-id="7571304204754747446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库读写分离下如何解决主从同步延迟问题"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T14:07:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库读写分离下如何解决主从同步延迟问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:07:20.000Z" title="Tue Nov 11 2025 14:07:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在SpringBoot、MyBatis-Plus和Dynamic-Datasource架构中实现读写分离确实能显著提升性能，但主从同步延迟导致的数据不一致问题需要系统化的解决方案。下面我将结合一个电商系统案例，详细讲解如何处理这一问题。</p>
<h2 data-id="heading-0">🎯 主从同步延迟的问题场景与核心挑战</h2>
<h3 data-id="heading-1">1.1 典型业务场景分析</h3>
<p>以电商系统为例，用户支付成功后查询订单状态时可能出现数据不一致：</p>
<ul>
<li><strong>支付完成立即查询</strong>：支付操作写主库，查询立即路由到从库，此时从库可能尚未同步最新数据</li>
<li><strong>库存超卖问题</strong>：库存扣减后，其他查询请求可能读到未更新的库存数据</li>
<li><strong>用户信息更新延迟</strong>：用户修改个人信息后，短期内查询仍显示旧数据</li>
</ul>
<h3 data-id="heading-2">1.2 同步延迟的根本原因</h3>
<p>主从同步延迟主要由以下因素导致：</p>
<ul>
<li>MySQL主从复制机制的固有延迟（单线程应用binlog）</li>
<li>网络传输延迟和带宽限制</li>
<li>从库服务器性能瓶颈或配置不当</li>
<li>大事务、慢查询阻塞复制进程</li>
</ul>
<h2 data-id="heading-3">⚙️ 动态数据源配置与强制读主库机制</h2>
<h3 data-id="heading-4">2.1 基础数据源配置</h3>
<pre><code class="hljs language-less" lang="less">spring:
  datasource:
    dynamic:
      primary: master
      strict: false
      datasource:
        master:
          url: jdbc:mysql://master-host:3306/<span class="hljs-attribute">order?useSSL=false&amp;serverTimezone=Asia/Shanghai
          username</span>: admin
          <span class="hljs-attribute">password</span>: master<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
        <span class="hljs-attribute">slave1</span>:
          <span class="hljs-attribute">url</span>: <span class="hljs-attribute">jdbc</span>:<span class="hljs-attribute">mysql</span>:<span class="hljs-comment">//slave1-host:3306/order?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attribute">username</span>: readonly
          <span class="hljs-attribute">password</span>: slave<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
        <span class="hljs-attribute">slave2</span>:
          <span class="hljs-attribute">url</span>: <span class="hljs-attribute">jdbc</span>:<span class="hljs-attribute">mysql</span>:<span class="hljs-comment">//slave2-host:3306/order?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attribute">username</span>: readonly
          <span class="hljs-attribute">password</span>: slave<span class="hljs-variable">@123</span>
          <span class="hljs-attribute">driver-class-name</span>: com.mysql.cj.jdbc.Driver
      <span class="hljs-attribute">hikari</span>:
        <span class="hljs-attribute">maximum-pool-size</span>: <span class="hljs-number">20</span>
        <span class="hljs-attribute">connection-timeout</span>: <span class="hljs-number">30000</span>
        <span class="hljs-attribute">idle-timeout</span>: <span class="hljs-number">600000</span>
</code></pre>
<h3 data-id="heading-5">2.2 强制读主库注解实现</h3>
<p>对于关键业务操作，需要强制从主库读取以确保数据一致性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 强制读主库注解
 * 使用场景：支付状态查询、订单状态查询等对数据实时性要求高的操作
 * 在方法上添加此注解，确保该操作路由到主库而非从库
 */</span>
<span class="hljs-meta">@Target({ElementType.METHOD, ElementType.TYPE})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ForceMaster {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"master"</span>;
}

<span class="hljs-comment">/**
 * 强制读主库切面实现
 * 通过AOP在方法执行前切换数据源到主库，执行后恢复
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForceMasterAspect</span> {
    
    <span class="hljs-comment">/**
     * 定义切点：拦截所有标注了<span class="hljs-doctag">@ForceMaster</span>注解的方法
     */</span>
    <span class="hljs-meta">@Pointcut("@annotation(com.example.annotation.ForceMaster)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forceMasterPointcut</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-comment">/**
     * 环绕通知：在方法执行前强制切换到主库
     * <span class="hljs-doctag">@param</span> joinPoint 连接点
     * <span class="hljs-doctag">@return</span> 方法执行结果
     * <span class="hljs-doctag">@throws</span> Throwable 可能抛出的异常
     */</span>
    <span class="hljs-meta">@Around("forceMasterPointcut()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">previousDataSource</span> <span class="hljs-operator">=</span> DynamicDataSourceContextHolder.getDataSourceKey();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">wasForceMaster</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 强制切换到主库</span>
            DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
            wasForceMaster = <span class="hljs-literal">true</span>;
            log.debug(<span class="hljs-string">"强制切换到主库，执行方法: {}"</span>, joinPoint.getSignature().getName());
            
            <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 恢复之前的数据源</span>
            <span class="hljs-keyword">if</span> (wasForceMaster) {
                DynamicDataSourceContextHolder.poll();
                log.debug(<span class="hljs-string">"恢复数据源到: {}"</span>, previousDataSource);
            }
            <span class="hljs-keyword">if</span> (previousDataSource != <span class="hljs-literal">null</span>) {
                DynamicDataSourceContextHolder.push(previousDataSource);
            }
        }
    }
}

<span class="hljs-comment">/**
 * 订单服务示例：关键业务操作强制读主库
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 支付成功后查询订单状态 - 强制读主库避免同步延迟
     * 支付后用户立即查询订单状态，必须确保数据一致性
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@return</span> 订单信息
     */</span>
    <span class="hljs-meta">@ForceMaster</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderAfterPayment</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-keyword">if</span> (orderId == <span class="hljs-literal">null</span> || orderId &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单ID不合法"</span>);
        }
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"订单不存在，订单ID: {}"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单不存在"</span>);
        }
        
        log.info(<span class="hljs-string">"查询订单状态成功，订单ID: {}, 状态: {}"</span>, orderId, order.getStatus());
        <span class="hljs-keyword">return</span> order;
    }
    
    <span class="hljs-comment">/**
     * 普通订单查询 - 可走从库
     * 适用于订单列表、历史订单查询等对实时性要求不高的场景
     */</span>
    <span class="hljs-meta">@DS("slave")</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getOrderList</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">if</span> (userId == <span class="hljs-literal">null</span> || userId &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        LambdaQueryWrapper&lt;Order&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(Order::getUserId, userId)
               .orderByDesc(Order::getCreateTime);
        
        <span class="hljs-keyword">return</span> orderMapper.selectList(wrapper);
    }
}
</code></pre>
<h2 data-id="heading-6">🔄 事务拆分与批量操作优化</h2>
<h3 data-id="heading-7">3.1 大事务拆分优化</h3>
<p>大事务是导致主从延迟的常见原因，需要合理拆分：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderProcessingService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">500</span>; <span class="hljs-comment">// 批次大小，避免单事务处理过多数据</span>
    
    <span class="hljs-comment">/**
     * 批量订单处理 - 优化后版本
     * 将大事务拆分为多个小事务，减少锁持有时间和主从延迟
     * <span class="hljs-doctag">@param</span> orders 订单列表
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-keyword">if</span> (orders == <span class="hljs-literal">null</span> || orders.isEmpty()) {
            log.warn(<span class="hljs-string">"订单列表为空，无需处理"</span>);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 分批处理</span>
        List&lt;List&lt;Order&gt;&gt; batches = Lists.partition(orders, BATCH_SIZE);
        <span class="hljs-type">int</span> <span class="hljs-variable">totalProcessed</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; batches.size(); i++) {
            List&lt;Order&gt; batch = batches.get(i);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">processed</span> <span class="hljs-operator">=</span> processOrderBatch(batch, i + <span class="hljs-number">1</span>);
                totalProcessed += processed;
                log.info(<span class="hljs-string">"第 {} 批订单处理完成，本批处理: {} 条，累计处理: {} 条"</span>, 
                        i + <span class="hljs-number">1</span>, processed, totalProcessed);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"第 {} 批订单处理失败，错误信息: {}"</span>, i + <span class="hljs-number">1</span>, e.getMessage());
                <span class="hljs-comment">// 可根据业务需求决定是继续处理还是终止</span>
                <span class="hljs-keyword">if</span> (isCriticalFailure(e)) {
                    <span class="hljs-keyword">throw</span> e;
                }
            }
        }
        
        log.info(<span class="hljs-string">"批量订单处理完成，总计处理: {} 条订单"</span>, totalProcessed);
    }
    
    <span class="hljs-comment">/**
     * 单批次订单处理 - 每个批次独立事务
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@DS("master")</span> <span class="hljs-comment">// 写操作必须走主库</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processOrderBatch</span><span class="hljs-params">(List&lt;Order&gt; orders, <span class="hljs-type">int</span> batchNo)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (Order order : orders) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 验证订单有效性</span>
                validateOrder(order);
                
                <span class="hljs-comment">// 处理订单</span>
                <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processSingleOrder(order);
                <span class="hljs-keyword">if</span> (result) {
                    successCount++;
                }
                
                <span class="hljs-comment">// 模拟处理间隔，避免瞬时压力过大</span>
                <span class="hljs-keyword">if</span> (batchNo % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
                    Thread.sleep(<span class="hljs-number">10</span>); <span class="hljs-comment">// 每10批次短暂间隔</span>
                }
                
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"订单处理失败，订单ID: {}, 错误信息: {}"</span>, order.getId(), e.getMessage());
                <span class="hljs-comment">// 根据业务需求决定是否继续处理本批次其他订单</span>
                <span class="hljs-keyword">if</span> (isCriticalOrder(order)) {
                    <span class="hljs-keyword">throw</span> e; <span class="hljs-comment">// 重要订单失败则整个批次回滚</span>
                }
            }
        }
        
        <span class="hljs-keyword">return</span> successCount;
    }
    
    <span class="hljs-comment">/**
     * 库存扣减优化 - 避免大事务锁竞争
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">reduceStockWithOptimization</span><span class="hljs-params">(Long productId, Integer quantity)</span> {
        <span class="hljs-keyword">if</span> (productId == <span class="hljs-literal">null</span> || quantity == <span class="hljs-literal">null</span> || quantity &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"参数不合法"</span>);
        }
        
        <span class="hljs-comment">// 分批扣减库存，减少锁持有时间</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> quantity;
        <span class="hljs-type">int</span> <span class="hljs-variable">maxRetries</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (remaining &gt; <span class="hljs-number">0</span> &amp;&amp; retryCount &lt; maxRetries) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> Math.min(<span class="hljs-number">100</span>, remaining); <span class="hljs-comment">// 每批最多100件</span>
                
                <span class="hljs-type">int</span> <span class="hljs-variable">affectedRows</span> <span class="hljs-operator">=</span> orderMapper.deductStock(productId, batchSize);
                <span class="hljs-keyword">if</span> (affectedRows &gt; <span class="hljs-number">0</span>) {
                    remaining -= batchSize;
                    log.debug(<span class="hljs-string">"库存扣减成功，产品ID: {}, 本次扣减: {}, 剩余需扣减: {}"</span>, 
                            productId, batchSize, remaining);
                } <span class="hljs-keyword">else</span> {
                    log.warn(<span class="hljs-string">"库存不足，产品ID: {}"</span>, productId);
                    <span class="hljs-keyword">break</span>;
                }
                
                retryCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 成功则重置重试计数</span>
            } <span class="hljs-keyword">catch</span> (Exception e) {
                retryCount++;
                log.warn(<span class="hljs-string">"库存扣减失败，开始重试，产品ID: {}, 重试次数: {}"</span>, productId, retryCount);
                
                <span class="hljs-keyword">if</span> (retryCount &gt;= maxRetries) {
                    log.error(<span class="hljs-string">"库存扣减重试次数超限，产品ID: {}"</span>, productId);
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存扣减失败"</span>, e);
                }
                
                <span class="hljs-comment">// 指数退避延迟</span>
                <span class="hljs-keyword">try</span> {
                    Thread.sleep((<span class="hljs-type">long</span>) Math.pow(<span class="hljs-number">2</span>, retryCount) * <span class="hljs-number">100</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"操作被中断"</span>, ie);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> remaining == <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 订单验证逻辑</span>
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (order.getAmount() == <span class="hljs-literal">null</span> || order.getAmount().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"订单金额不合法"</span>);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processSingleOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 单订单处理逻辑</span>
        <span class="hljs-keyword">return</span> orderMapper.updateById(order) &gt; <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCriticalFailure</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-comment">// 判断是否为严重错误</span>
        <span class="hljs-keyword">return</span> e <span class="hljs-keyword">instanceof</span> RuntimeException;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCriticalOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 判断是否为重要订单</span>
        <span class="hljs-keyword">return</span> order.getAmount().compareTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>)) &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h2 data-id="heading-8">⏱️ 延迟监控与自适应重试机制</h2>
<h3 data-id="heading-9">4.1 主从延迟监控组件</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 主从延迟监控组件
 * 实时监控主从同步延迟，为路由决策提供依据
 */</span>
@Component
@Slf4j
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReplicationDelayMonitor</span> {
    
    @Autowired
    @<span class="hljs-built_in">Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>)
    <span class="hljs-keyword">private</span> DataSource slaveDataSource;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> lastDelayTime = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> delayThresholdExceeded = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object lock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Object</span>();
    
    <span class="hljs-comment">/**
     * 获取从库同步延迟时间（秒）
     * 通过查询SHOW SLAVE STATUS获取延迟信息
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">getReplicationDelaySeconds</span><span class="hljs-params">()</span> </span>{
        JdbcTemplate jdbcTemplate = <span class="hljs-keyword">new</span> <span class="hljs-built_in">JdbcTemplate</span>(slaveDataSource);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> jdbcTemplate.<span class="hljs-built_in">query</span>(<span class="hljs-string">"SHOW SLAVE STATUS"</span>, rs -&gt; {
                <span class="hljs-keyword">if</span> (rs.<span class="hljs-built_in">next</span>()) {
                    <span class="hljs-type">long</span> secondsBehindMaster = rs.<span class="hljs-built_in">getLong</span>(<span class="hljs-string">"Seconds_Behind_Master"</span>);
                    <span class="hljs-comment">// 处理可能为NULL的情况</span>
                    <span class="hljs-keyword">return</span> rs.<span class="hljs-built_in">wasNull</span>() ? <span class="hljs-number">0</span> : secondsBehindMaster;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>; <span class="hljs-comment">// 如果不是从库或状态不可用，返回0</span>
            });
        } <span class="hljs-built_in">catch</span> (Exception e) {
            log.<span class="hljs-built_in">error</span>(<span class="hljs-string">"获取主从延迟失败: {}"</span>, e.<span class="hljs-built_in">getMessage</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1L</span>; <span class="hljs-comment">// 返回-1表示监控异常</span>
        }
    }
    
    <span class="hljs-comment">/**
     * 检查是否应该强制读主库
     * 基于延迟阈值和业务敏感性动态决策
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">shouldForceMaster</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelaySeconds</span>();
        
        <span class="hljs-built_in">synchronized</span> (lock) {
            <span class="hljs-keyword">if</span> (delay &gt; <span class="hljs-number">5</span>) { <span class="hljs-comment">// 延迟超过5秒</span>
                delayThresholdExceeded = <span class="hljs-literal">true</span>;
                lastDelayTime = System.<span class="hljs-built_in">currentTimeMillis</span>();
                log.<span class="hljs-built_in">warn</span>(<span class="hljs-string">"主从延迟超过阈值: {}秒，建议强制读主库"</span>, delay);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delayThresholdExceeded) {
                <span class="hljs-comment">// 延迟恢复正常后，继续观察一段时间（5分钟）</span>
                <span class="hljs-keyword">if</span> (System.<span class="hljs-built_in">currentTimeMillis</span>() - lastDelayTime &lt; <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> {
                    delayThresholdExceeded = <span class="hljs-literal">false</span>;
                    log.<span class="hljs-built_in">info</span>(<span class="hljs-string">"主从延迟已恢复正常: {}秒"</span>, delay);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">/**
     * 获取延迟级别，用于更精细的路由决策
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> DelayLevel <span class="hljs-title">getDelayLevel</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelaySeconds</span>();
        
        <span class="hljs-keyword">if</span> (delay &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> DelayLevel.ERROR;
        <span class="hljs-keyword">if</span> (delay == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> DelayLevel.NORMAL;
        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> DelayLevel.<span class="hljs-literal">LOW</span>;
        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> DelayLevel.MEDIUM;
        <span class="hljs-keyword">return</span> DelayLevel.<span class="hljs-literal">HIGH</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DelayLevel</span> {
        <span class="hljs-built_in">NORMAL</span>(<span class="hljs-string">"正常"</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"可正常使用从库"</span>),
        <span class="hljs-built_in">LOW</span>(<span class="hljs-string">"低延迟"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"建议使用从库"</span>),
        <span class="hljs-built_in">MEDIUM</span>(<span class="hljs-string">"中延迟"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"关键业务读主库"</span>),
        <span class="hljs-built_in">HIGH</span>(<span class="hljs-string">"高延迟"</span>, Integer.MAX_VALUE, <span class="hljs-string">"强制读主库"</span>),
        <span class="hljs-built_in">ERROR</span>(<span class="hljs-string">"监控异常"</span>, <span class="hljs-number">-1</span>, <span class="hljs-string">"建议读主库"</span>);
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> description;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> threshold;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> suggestion;
        
        <span class="hljs-built_in">DelayLevel</span>(<span class="hljs-type">String</span> description, <span class="hljs-type">int</span> threshold, <span class="hljs-type">String</span> suggestion) {
            <span class="hljs-keyword">this</span>.description = description;
            <span class="hljs-keyword">this</span>.threshold = threshold;
            <span class="hljs-keyword">this</span>.suggestion = suggestion;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">4.2 自适应重试机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 延迟感知的重试切面
 * 当检测到主从延迟时，自动重试或切换到主库
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryOnDelayAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReplicationDelayMonitor delayMonitor;
    
    <span class="hljs-comment">/**
     * 重试注解定义
     */</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RetryOnDelay {
        <span class="hljs-type">int</span> <span class="hljs-title function_">maxAttempts</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">long</span> <span class="hljs-title function_">backoffDelay</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">500</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">forceMasterOnFailure</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">/**
     * 延迟重试切面
     */</span>
    <span class="hljs-meta">@Around("@annotation(retryOnDelay)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">retryOnDelay</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, RetryOnDelay retryOnDelay)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">int</span> <span class="hljs-variable">maxAttempts</span> <span class="hljs-operator">=</span> retryOnDelay.maxAttempts();
        <span class="hljs-type">long</span> <span class="hljs-variable">backoffDelay</span> <span class="hljs-operator">=</span> retryOnDelay.backoffDelay();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">forceMasterOnFailure</span> <span class="hljs-operator">=</span> retryOnDelay.forceMasterOnFailure();
        
        <span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        Throwable lastException;
        
        <span class="hljs-keyword">do</span> {
            attempt++;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 在第二次及以后的重试时，如果延迟严重则强制走主库</span>
                <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">1</span> &amp;&amp; delayMonitor.shouldForceMaster()) {
                    DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
                    log.debug(<span class="hljs-string">"第{}次重试强制使用主库，方法: {}"</span>, 
                            attempt, joinPoint.getSignature().getName());
                }
                
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
                
                <span class="hljs-comment">// 成功则清除主库标记（如果是重试时设置的）</span>
                <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">1</span>) {
                    DynamicDataSourceContextHolder.poll();
                }
                
                log.debug(<span class="hljs-string">"方法执行成功，尝试次数: {}"</span>, attempt);
                <span class="hljs-keyword">return</span> result;
                
            } <span class="hljs-keyword">catch</span> (DataNotFoundException ex) {
                lastException = ex;
                
                <span class="hljs-comment">// 数据不存在异常，可能是主从延迟导致</span>
                <span class="hljs-keyword">if</span> (attempt &lt; maxAttempts &amp;&amp; delayMonitor.getReplicationDelaySeconds() &gt; <span class="hljs-number">2</span>) {
                    log.warn(<span class="hljs-string">"数据不存在，可能是主从延迟，开始第{}次重试，延迟: {}秒"</span>, 
                            attempt, delayMonitor.getReplicationDelaySeconds());
                    
                    <span class="hljs-comment">// 指数退避</span>
                    <span class="hljs-keyword">try</span> {
                        Thread.sleep(backoffDelay * (<span class="hljs-type">long</span>) Math.pow(<span class="hljs-number">2</span>, attempt - <span class="hljs-number">1</span>));
                    } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        <span class="hljs-keyword">break</span>;
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>;
                }
            }
        } <span class="hljs-keyword">while</span> (attempt &lt; maxAttempts);
        
        <span class="hljs-comment">// 所有重试都失败，根据配置决定是否强制走主库</span>
        <span class="hljs-keyword">if</span> (forceMasterOnFailure) {
            log.warn(<span class="hljs-string">"所有重试失败，强制使用主库执行最终尝试"</span>);
            <span class="hljs-keyword">try</span> {
                DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
                <span class="hljs-keyword">return</span> joinPoint.proceed();
            } <span class="hljs-keyword">finally</span> {
                DynamicDataSourceContextHolder.poll();
            }
        }
        
        <span class="hljs-keyword">throw</span> lastException;
    }
}

<span class="hljs-comment">/**
 * 应用重试机制的业务服务示例
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderQueryService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 查询订单详情 - 带有延迟重试机制
     * 当数据不存在时，会重试多次，每次重试前检查主从延迟
     */</span>
    <span class="hljs-meta">@RetryOnDelay(maxAttempts = 3, backoffDelay = 500, forceMasterOnFailure = true)</span>
    <span class="hljs-meta">@DS("slave")</span> <span class="hljs-comment">// 默认读从库</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderWithRetry</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"订单不存在，订单ID: {}，可能由于主从延迟"</span>, orderId);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNotFoundException</span>(<span class="hljs-string">"订单不存在"</span>);
        }
        <span class="hljs-keyword">return</span> order;
    }
    
    <span class="hljs-comment">/**
     * 支付状态查询 - 结合强制主库和重试机制
     */</span>
    <span class="hljs-meta">@ForceMaster</span>
    <span class="hljs-meta">@RetryOnDelay(maxAttempts = 2)</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getPaymentStatus</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 支付状态查询对一致性要求高，强制走主库</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataNotFoundException</span>(<span class="hljs-string">"支付订单不存在"</span>);
        }
        <span class="hljs-keyword">return</span> order;
    }
}

<span class="hljs-comment">/**
 * 自定义异常类
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataNotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataNotFoundException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
}
</code></pre>
<h2 data-id="heading-11">📊 MySQL配置与架构级优化</h2>
<h3 data-id="heading-12">5.1 MySQL参数调优建议</h3>
<p>根据的建议，以下配置可显著降低主从延迟：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># MySQL主从配置优化 (my.cnf)</span>
<span class="hljs-section">[mysqld]</span>
<span class="hljs-comment"># 主库配置</span>
<span class="hljs-attr">server-id</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">log-bin</span> = mysql-bin
<span class="hljs-attr">binlog_format</span> = ROW
<span class="hljs-attr">expire_logs_days</span> = <span class="hljs-number">7</span>
<span class="hljs-attr">max_binlog_size</span> = <span class="hljs-number">1</span>G
<span class="hljs-attr">binlog_cache_size</span> = <span class="hljs-number">1</span>M
<span class="hljs-attr">sync_binlog</span> = <span class="hljs-number">1</span>

<span class="hljs-comment"># 从库配置</span>
<span class="hljs-attr">server-id</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">relay-log</span> = mysql-relay-bin
<span class="hljs-attr">read_only</span> = <span class="hljs-number">1</span>

<span class="hljs-comment"># 并行复制配置（关键优化）</span>
<span class="hljs-attr">slave_parallel_type</span> = LOGICAL_CLOCK
<span class="hljs-attr">slave_parallel_workers</span> = <span class="hljs-number">8</span>
<span class="hljs-attr">binlog_transaction_dependency_tracking</span> = COMMIT_ORDER

<span class="hljs-comment"># 性能参数</span>
<span class="hljs-attr">innodb_buffer_pool_size</span> = 系统内存的<span class="hljs-number">70</span>%
<span class="hljs-attr">innodb_log_file_size</span> = <span class="hljs-number">2</span>G
<span class="hljs-attr">innodb_log_buffer_size</span> = <span class="hljs-number">256</span>M
</code></pre>
<h3 data-id="heading-13">5.2 监控与告警集成</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 数据库监控组件
 * 集成Prometheus监控，实时追踪数据库性能指标
 */</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseMetricsMonitor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter readOperationsCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter writeOperationsCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Gauge replicationDelayGauge;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DatabaseMetricsMonitor</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> </span>{
        <span class="hljs-keyword">this</span>.readOperationsCounter = Counter.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.operations"</span>)
                .<span class="hljs-built_in">tag</span>(<span class="hljs-string">"type"</span>, <span class="hljs-string">"read"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"数据库读操作计数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
                
        <span class="hljs-keyword">this</span>.writeOperationsCounter = Counter.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.operations"</span>)
                .<span class="hljs-built_in">tag</span>(<span class="hljs-string">"type"</span>, <span class="hljs-string">"write"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"数据库写操作计数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
                
        <span class="hljs-keyword">this</span>.replicationDelayGauge = Gauge.<span class="hljs-built_in">builder</span>(<span class="hljs-string">"db.replication.delay"</span>)
                .<span class="hljs-built_in">description</span>(<span class="hljs-string">"主从同步延迟秒数"</span>)
                .<span class="hljs-built_in">register</span>(meterRegistry);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordReadOperation</span><span class="hljs-params">()</span> </span>{
        readOperationsCounter.<span class="hljs-built_in">increment</span>();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">recordWriteOperation</span><span class="hljs-params">()</span> </span>{
        writeOperationsCounter.<span class="hljs-built_in">increment</span>();
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">updateReplicationDelay</span><span class="hljs-params">(<span class="hljs-type">long</span> delaySeconds)</span> </span>{
        replicationDelayGauge.<span class="hljs-built_in">set</span>(delaySeconds);
    }
    
    <span class="hljs-comment">/**
     * 检查数据库健康状态
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> HealthCheckResult <span class="hljs-title">checkDatabaseHealth</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> delay = <span class="hljs-built_in">getReplicationDelay</span>();
        <span class="hljs-type">boolean</span> isHealthy = delay &gt;= <span class="hljs-number">0</span> &amp;&amp; delay &lt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 延迟10秒内认为健康</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">HealthCheckResult</span>(isHealthy, delay, System.<span class="hljs-built_in">currentTimeMillis</span>());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthCheckResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> healthy;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> delaySeconds;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timestamp;
        
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HealthCheckResult</span><span class="hljs-params">(<span class="hljs-type">boolean</span> healthy, <span class="hljs-type">long</span> delaySeconds, <span class="hljs-type">long</span> timestamp)</span> </span>{
            <span class="hljs-keyword">this</span>.healthy = healthy;
            <span class="hljs-keyword">this</span>.delaySeconds = delaySeconds;
            <span class="hljs-keyword">this</span>.timestamp = timestamp;
        }
        
        <span class="hljs-comment">// getter方法...</span>
    }
}
</code></pre>
<h2 data-id="heading-14">💡 最佳实践总结</h2>
<p>通过以上技术方案，可以有效解决SpringBoot+MyBatis-Plus+Dynamic-Datasource架构下的主从同步延迟问题。以下是关键实践要点：</p>
<ol>
<li><strong>分级数据一致性策略</strong>：根据业务重要性采用不同的数据一致性级别</li>
<li><strong>智能路由决策</strong>：基于实时延迟监控动态选择数据源</li>
<li><strong>事务优化</strong>：拆分大事务，减少锁竞争和复制延迟</li>
<li><strong>重试与降级机制</strong>：建立完整的异常处理和数据恢复流程</li>
</ol>
<p>实际电商系统案例表明，通过这些优化措施，订单状态查询延迟可从5.3秒降至0.8秒，数据不一致问题发生率下降98%以上。</p>
<p>最重要的是建立系统化的监控体系和应急预案，确保在出现严重主从延迟时能够快速发现、定位和解决问题，保障系统的稳定性和数据的一致性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Jetpack Compose中创建CRT屏幕效果]]></title>    <link>https://juejin.cn/post/7571352754896060442</link>    <guid>https://juejin.cn/post/7571352754896060442</guid>    <pubDate>2025-11-11T14:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754896060442" data-draft-id="7571304204719947830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Jetpack Compose中创建CRT屏幕效果"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2025-11-11T14:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Jetpack Compose中创建CRT屏幕效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:17:35.000Z" title="Tue Nov 11 2025 14:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「Creating a CRT Screen Effect in Jetpack Compose」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sinasamaki.com%2Fcreating-a-crt-screen-effect-in-jetpack-compose%2F" target="_blank" title="https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/" ref="nofollow noopener noreferrer">www.sinasamaki.com/creating-a-…</a>，由sinasamaki发布于2025年11月7日。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c03b13347444a40a65e398230a3664a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=aM1APr%2Fnd8P0rxCx%2FeYyUPjF4dg%3D" alt="CRT 屏幕效果" loading="lazy"/></p>
<p>CRT 显示器具有独特而怀旧的外观：模糊的边缘、扫描线和轻微的色彩溢出。让我们尝试使用 <code>GraphicsLayer</code> 和一些巧妙的图层技巧在 Jetpack Compose 中重现 这种效果。</p>
<h2 data-id="heading-0">GraphicsLayer</h2>
<p>与上一篇文章一样，此效果的基础是 <code>GraphicsLayer</code>。它允许我们将内容绘制一次到屏幕外缓冲区。然后，我们可以以极低的性能开销多次使用不同的效果重新绘制它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()

Box(Modifier.drawWithContent {
    graphicsLayer.record { 
        <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() 
    }
}) {
    content()
}
</code></pre>
<p>一旦我们将内容记录到 <code>graphicsLayer</code> 中，就可以使用 <code>drawLayer(graphicsLayer)</code> 根据需要多次绘制它。</p>
<p>我喜欢在黑色背景上绘制色彩鲜艳、饱和度高的内容，并运用这种效果。以下是我们将应用此效果的基础可组合对象。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d39284fd2094df8b21f1a6f4edd2e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=2glx3H%2BydfHnGQf0e7Vc8Yi6dfU%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-1">添加扫描线</h2>
<p>为了模拟 CRT 显示器上的水平扫描线，我们将使用重复渐变。让我们将其放入一个扩展函数中，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)
    drawRect(
        brush = Brush.verticalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.4f</span> to color,
            <span class="hljs-number">0.4f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startY = <span class="hljs-number">0f</span>,
            endY = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
    drawRect(
        brush = Brush.horizontalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.1f</span> to color,
            <span class="hljs-number">0.1f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startX = <span class="hljs-number">0f</span>,
            endX = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
}
</code></pre>
<p>我们手动定义颜色停止点，以便在颜色之间形成清晰的边缘，然后将 <code>tileMode</code> 设置为 <code>Repeated</code>。这样，再加上较短的起点和终点，就能得到许多重复的平行线。</p>
<p>扩展函数还会接收我们所需的透明度和 <code>BlendMode</code> 参数。</p>
<p>然后，我们可以使用此函数在 <code>graphicsLayer</code> 上绘制扫描线。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">.drawBehind {
    layer {
        drawLayer(graphicsLayer)
        drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)
    }
}
</code></pre>
<p>将混合模式设置为 <code>DstOut</code> 会从绘制的内容中“减去”我们的渐变，从而产生这种效果。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28d91b6dd34844b1bea2ebe831da791e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=x7IQ35n0Md8ld%2FbcOmq6yESR%2F2o%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-2">构建模糊图层</h2>
<p>为了实现 CRT 屏幕常见的发光效果，我们将多次绘制 <code>graphicsLayer</code> 图层，每次绘制时分别设置不同的模糊半径、透明度和缩放比例。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> blurLayers = remember {
    listOf(
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.2f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),
        Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.2f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
    )
}
</code></pre>
<p>我们将使用一个 <code>Triple</code> 列表来存储每个图层的数据。该列表的顺序也定义了它们的绘制顺序。我建议你尝试调整这些值和顺序，以获得所需的效果。但这是我目前使用的方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">blurLayers.forEach { (blur, alpha, scale) -&gt;  
    Box(  
        Modifier  
            .matchParentSize()  
            .blur(blur, BlurredEdgeTreatment.Unbounded)  
            .graphicsLayer {  
                scaleX = scale.first  
                scaleY = scale.second  
                <span class="hljs-keyword">this</span>.alpha = alpha  
            }  
            .drawBehind {  
                layer {  
                    drawLayer(graphicsLayer)  
                    drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                }  
            }    
    )  
}
</code></pre>
<p>然后，我们使用列表中的值绘制每个图层。在 <code>drawBehind</code> 修改器上方，我们将图层大小设置为与父图层匹配，并应用模糊、缩放和透明度。请记住将模糊设置为 <code>Unbounded</code>，使其超出包含它的可组合对象的边界。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb287da9548d4c8599ccafef052673af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=YY17IWzj47KP6nLWcJnlTRyaR1U%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-3">屏幕抖动</h2>
<p>最后，我们来添加屏幕抖动效果，以模拟 CRT 显示器特有的抖动。我们可以通过创建一个 <code>Offset</code> 对象，并用 -1 到 1 之间的随机浮点值来更新它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }

LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        shake = Offset(
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
        )
        delay(<span class="hljs-number">32</span>)
    }
}
</code></pre>
<p>这里只需在一个 while 循环中即可完成。可以调整延迟时间来控制闪烁的间隔频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">modifier = modifier  
    .graphicsLayer {  
        translationX = shake.x  
        translationY = shake.y  
    }
</code></pre>
<p>然后可以使用修饰符来应用此偏移量。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08daadbb6efd45cc981fb077e23d6b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=bSgkKe2ddTbuZyvzMGmA75jfjxM%3D" alt="crt_opt.gif" loading="lazy"/></p>
## 整合所有功能
<p>让我们将所有这些功能组合成一个可轻松使用的组合。它会接收 <code>content</code> 参数以及 <code>flickerDelay</code> 参数，后者用于控制闪烁频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CRTBox</span><span class="hljs-params">(  
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  
    flickerDelay: <span class="hljs-type">Int</span> = <span class="hljs-number">32</span>,  
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>,  
)</span></span> {  
    <span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }  
  
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {  
        <span class="hljs-keyword">while</span> (flickerDelay &gt; <span class="hljs-number">0</span>) {  
            shake = Offset(  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
            )  
            delay(flickerDelay.toLong())  
        }  
    }  
  
    <span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()  
  
    Box(  
        modifier = modifier  
            .graphicsLayer {  
                translationX = shake.x  
                translationY = shake.y  
            }  
    ) {  
        Box(Modifier.drawWithContent {  
            graphicsLayer.record { <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() }  
        }) {  
            content()  
        }  
  
        <span class="hljs-keyword">val</span> blurLayers = remember {  
            listOf(  
                Triple(<span class="hljs-number">5.</span>dp, <span class="hljs-number">.3f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),  
                Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.8f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">.6f</span>, <span class="hljs-number">1.001f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">.7f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
            )  
        }  
  
        blurLayers.forEach { (blur, alpha, scale) -&gt;  
            Box(  
                Modifier  
                    .matchParentSize()  
                    .blur(blur, BlurredEdgeTreatment.Unbounded)  
                    .graphicsLayer {  
                        scaleX = scale.first  
                        scaleY = scale.second  
                        <span class="hljs-keyword">this</span>.alpha = alpha  
                    }  
                    .drawBehind {  
                        layer {  
                            drawLayer(graphicsLayer)  
                            drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                        }  
                    }            
            )  
        }  
    }}  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">layer</span><span class="hljs-params">(  
    bounds: <span class="hljs-type">Rect</span> = size.toRect()</span></span>,  
    block: DrawScope.() -&gt; <span class="hljs-built_in">Unit</span>  
) =  
    drawIntoCanvas { canvas -&gt;  
        canvas.withSaveLayer(  
            bounds = bounds,  
            paint = Paint(),  
        ) { block() }  
    }  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {  
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)  
    drawRect(  
        brush = Brush.verticalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.4f</span> to color,  
            <span class="hljs-number">0.4f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startY = <span class="hljs-number">0f</span>,  
            endY = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
    drawRect(  
        brush = Brush.horizontalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.1f</span> to color,  
            <span class="hljs-number">0.1f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startX = <span class="hljs-number">0f</span>,  
            endX = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
}
</code></pre>
<p>然后，你可以像使用其他可组合组件一样使用它：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CRTBox {
    Text(<span class="hljs-string">"GAME OVER"</span>)
}
</code></pre>
<h2 data-id="heading-4">Sweeper 更新</h2>
<p>如果你想查看实际效果，请查看最新的 Sweeper 更新，该更新使用 CRT 效果创建了一个令人毛骨悚然的万圣节主题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c135b0abf04a7a88d83881ba6bad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=fJO3ZjvcXhYG0mt6uzjwA%2Be7QTE%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.google.com%2Fstore%2Fapps%2Fdetails%3Fid%3Dcom.sinasamaki.chroma.sweeper%26ref%3Dsinasamaki.com" target="_blank" title="https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper&amp;ref=sinasamaki.com" ref="nofollow noopener noreferrer">play.google.com/store/apps/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2Fapp%2Fsweeper-by-sinasamaki%2Fid6752220495%3Fref%3Dsinasamaki.com" target="_blank" title="https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495?ref=sinasamaki.com" ref="nofollow noopener noreferrer">apps.apple.com/us/app/swee…</a></p>
<p>感谢阅读，祝你好运！</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Meta ASR新篇章：当AI学会了全世界的语言]]></title>    <link>https://juejin.cn/post/7571306072422940714</link>    <guid>https://juejin.cn/post/7571306072422940714</guid>    <pubDate>2025-11-11T14:49:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422940714" data-draft-id="7571299394345746474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Meta ASR新篇章：当AI学会了全世界的语言"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-11T14:49:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Meta ASR新篇章：当AI学会了全世界的语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:49:50.000Z" title="Tue Nov 11 2025 14:49:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>在人工智能的浩瀚星辰中，语音识别无疑是最璀璨、也最富有挑战性性的一颗。我们曾惊叹于AI能听懂指令，将口语转化为文本。然而，这光鲜的背后，一直横亘着一道巨大的鸿沟——语言多样性。全球数千种语言，尤其是那些使用人数稀少、缺乏数字化资源的“低资源语言”和濒危方言，在AI的面前常常陷入“数字静默”。它们的数据匮乏、模型训练成本高昂，仿佛注定要被主流技术遗忘在角落。这就像一座AI领域的“巴别塔”，让不同语言间的沟通变得异常艰难。</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.40.50-1024x297.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.40.50-1024x297.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4239c63a5efc440a9e50013b4c65fd6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=Hkujg3bUSaRV2E%2F%2B50OQnwc8lpw%3D" alt="iShot_2025-11-11_22.40.50" loading="lazy"/></a></p>
<p>长久以来，我们都在期待一个能打破这种壁垒的解决方案。而就在最近，AI巨头Meta扔出了一枚重磅炸弹，其影响力足以震动整个AI界。</p>
<p>2025年11月10日，Meta基础人工智能研究（FAIR）团队正式揭开了他们最新力作——“Omnilingual ASR”语音识别系统的神秘面纱。这个名字本身就充满野心，意为“通晓万语”。而其公布的数字，更是令人瞠目结舌：<strong>原生支持超过1600种语言</strong>！更令人惊喜的是，这其中有<strong>500种语言是首次被任何AI语音识别系统所覆盖</strong>。这意味着，那些曾经“隐形”在AI世界里的语言，终于有了被听见的可能。</p>
<p>但这还不是全部。Omnilingual ASR最革命性的地方，在于其创新的“零样本学习”（Zero-shot Learning）能力。你可以把它想象成一种魔法：用户只需提供少量音频-文本配对样本，系统就能瞬间学会转录一种全新的语言或方言，无需耗费海量数据和算力去重新训练模型。这意味着，Omnilingual ASR理论上能将覆盖范围扩展至<strong>5400多种语言</strong>。这一能力，彻底颠覆了传统语音识别模型对海量标注数据的过度依赖，为成千上万的“小语种”和“地方方言”带来了前所未有的机遇。一个偏远村落的口述历史，一句濒危语言的古老歌谣，不再需要漫长的等待和巨大的投入，就能被AI轻易捕捉、数字化、被保存，让其文化得以延续。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.40.56-1024x240.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.40.56-1024x240.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c883763e9f474fdda500a789d38802ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=VAzHWojAQ%2BMtzWTzKrSVI5CLFTU%3D" alt="iShot_2025-11-11_22.40.56" loading="lazy"/></a></p>
<p>这种“魔法”并非空穴来风，其背后是Meta深厚的技术积累和前瞻性的架构设计。Omnilingual ASR不仅仅是在语言数量上的简单堆砌，其核心在于一个精妙的模型家族。它以Meta自研的wav2vec 2.0模型作为语音表示的“基石”，这是一个强大的自监督模型，能够从海量未标注语音数据中学习语言的深层特征。在此之上，Omnilingual ASR引入了两种不同的解码器：传统的CTC（Connectionist Temporal Classification）解码器，以及更令人兴奋的、受大语言模型启发的LLM解码器——“LLM-ASR”。</p>
<p>是的，你没听错，是<strong>大语言模型</strong>！这种设计思路，让语音识别系统能够借鉴大语言模型在理解上下文、处理复杂序列方面的强大能力，从而实现了前所未有的“零样本”学习和泛化能力。其中，规模最大的模型拥有<strong>70亿参数</strong>，庞大的身躯和精妙的智慧相结合，使得它能够在面对陌生语言时，也能基于已学习到的通用语音模式，进行有效的推断和转录。在实际性能上，Omnilingual ASR的表现也足以令人信服：在78%的测试语言中，字符错误率（CER）都能保持在10%以下，这对于大规模多语言系统而言是一个相当出色的成绩。对于那些训练音频≥10小时的“资源丰富型”语言，这一比例更是高达95%。这意味着，无论是主流语言还是许多此前被忽略的语言，用户都能期待获得高质量的转录服务。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.41.03-1024x431.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.41.03-1024x431.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4c0c0b84d134b8caae7d99e28e99490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=S8pjh%2BoLdnIpNwHjXqXfpnqNx0o%3D" alt="iShot_2025-11-11_22.41.03" loading="lazy"/></a></p>
<p>然而，Meta的抱负远不止于此。Omnilingual ASR的发布，不仅仅是技术的胜利，更是一场深刻的普惠与包容行动。Meta通过其<strong>开源策略</strong>，为全球社区带来了真正的福祉：模型采用友好的<strong>Apache 2.0许可证</strong>，而配套的<strong>Omnilingual ASR Corpus数据集则采用CC-BY许可</strong>，两者均可免费用于商业用途。这个“Omnilingual ASR语料库”具有历史性的意义。它包含了针对<strong>350种欠服务语言</strong>的转录语音，是Meta与全球各地组织（如Mozilla Common Voice、Lanfrica）以及本土说话者通力合作的结晶。这是一个全球合作的典范，旨在打破数据壁垒，为那些曾因数据匮乏而无法被AI识别的“小语种”和“地方方言”提供坚实的基础。</p>
<p>Meta此举，旨在<strong>弥合数字语言鸿沟</strong>，为少数民族、濒危语言群体提供强大的技术支撑。想象一下，在全球偏远地区，教育、医疗、公共服务等领域，那些使用小众语言的人们，将能够通过这项技术，更便捷地获取信息、表达自我。这不仅是对语言多样性的尊重，更是赋予他们被听见的权利，为人类文化遗产的保护和传承注入了新的活力。</p>
<p>凭借其广泛的语言覆盖和灵活的扩展能力，Omnilingual ASR无疑将在多个领域开辟全新的应用场景。对于充满想象力的开发者、研究者和社会服务机构而言，这无疑是一个巨大的宝库。它将为全球大量使用非主流语言的群体提供语音助手、实时字幕、语音输入法等数字服务，让技术不再是少数人的特权。它能高效地数字化保存那些濒危语言的口述历史档案、民间故事、传统歌谣，为文化遗产的留存提供前所未有的技术工具，让语言不再随着时间的流逝而消亡。开发者可以利用该模型，为特定地区或语言社区定制开发语音转录工具和应用程序，例如为粤语、四川话等方言提供更精准的识别服务，推动更本地化的商业和公共服务。在教育和公共服务领域，它能为使用少数民族语言的人们提供更便利的信息获取方式和沟通渠道，例如提供多语言的医疗咨询、法律援助等。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-11_22.41.41-1024x560.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-11_22.41.41-1024x560.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/714c5351bedd4ea98659645110cd02b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763477390&amp;x-signature=oYDbKXbdXw5frgZ2H2NihUFa1q8%3D" alt="iShot_2025-11-11_22.41.41" loading="lazy"/></a></p>
<p>Omnilingual ASR的出现，不仅仅是技术进步的体现，更开启了构建一个真正多语言、多文化数字世界的全新篇章。Meta的Omnilingual ASR，无疑是AI语音识别发展史上的一个里程碑事件。它不仅以惊人的数量和创新的技术，打破了困扰AI多年的语言壁垒，更通过开源策略，将这一前沿技术推向全球，赋能无数此前被忽视的语言社区。这不只是一套模型，更是一种理念的胜利——即技术应当是普惠的，应当服务于全人类的语言和文化多样性。当AI真正学会了全世界的语言，我们所构建的数字世界，也将变得更加开放、包容和充满活力。Omnilingual ASR吹响了号角，我们共同见证，共同创造，一个语言AI的新纪元正向我们走来。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[📜 `<script>`脚本元素 - 从加载策略到安全性与性能的完整指南]]></title>    <link>https://juejin.cn/post/7571102074038485033</link>    <guid>https://juejin.cn/post/7571102074038485033</guid>    <pubDate>2025-11-11T09:11:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038485033" data-draft-id="7571102074038452265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:11:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            📜 `&lt;script&gt;`脚本元素 - 从加载策略到安全性与性能的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:11:06.000Z" title="Tue Nov 11 2025 09:11:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握<code>&lt;script&gt;</code>脚本元素的加载与执行模型、模块化用法、安全配置（CSP/SRI/CORS），并能在实际项目中选用正确策略，避免性能与安全坑。</p>
<p>📊 <strong>难度等级</strong>：中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#script</code> <code>#defer</code> <code>#async</code> <code>#module</code> <code>#CSP</code> <code>#SRI</code><br/>
⏱️ <strong>阅读时间</strong>：约14分钟</p>
</blockquote>
<h2 data-id="heading-0">🌟 引言</h2>
<p>在前端开发中，<code>&lt;script&gt;</code>脚本的使用几乎无处不在：业务代码、第三方SDK、监控上报、AB测试、广告、埋点……但常见问题也层出不穷：</p>
<ul>
<li>同步脚本阻塞渲染，首屏白屏时间长。</li>
<li>混用<code>async/defer</code>导致执行顺序不可控，依赖打乱引发线上事故。</li>
<li>模块脚本与经典脚本相互引用，兼容性问题频发。</li>
<li>跨域脚本报错只有“Script error”，无法定位问题。</li>
<li>未配置<code>CSP nonce</code>/<code>SRI integrity</code>，安全审计不通过。</li>
</ul>
<p>本文从加载、执行到安全与性能的完整维度，结合实际踩坑案例，给出可落地的最佳实践与测试方法。</p>
<h2 data-id="heading-1">核心技巧详解</h2>
<h3 data-id="heading-2">1）加载与执行模型：同步、defer、async 与事件时序</h3>
<h4 data-id="heading-3">应用场景</h4>
<p>需要同时引入多个脚本，并确保：不阻塞解析、执行顺序可控、与<code>DOMContentLoaded</code>/<code>load</code>事件时序配合。</p>
<h4 data-id="heading-4">常见问题</h4>
<ul>
<li>在<code>&lt;head&gt;</code>中放同步脚本，阻塞HTML解析与渲染。</li>
<li>将存在依赖关系的脚本设置为<code>async</code>，出现随机时序问题。</li>
<li>误以为<code>defer</code>作用于内联脚本（仅对外链脚本生效）。</li>
</ul>
<h4 data-id="heading-5">推荐方案</h4>
<ul>
<li>有依赖和顺序要求：使用<code>defer</code>并保持引入顺序。</li>
<li>无依赖、独立的第三方脚本：使用<code>async</code>。</li>
<li>现代代码优先使用<code>type="module"</code>（天生类似<code>defer</code>，更易管理依赖）。</li>
</ul>
<h4 data-id="heading-6">核心要点</h4>
<ul>
<li><code>async</code>：下载不阻塞解析，下载完成立即执行，彼此之间顺序不确定。</li>
<li><code>defer</code>：下载不阻塞解析，按引入顺序在解析完成后执行，早于<code>DOMContentLoaded</code>。</li>
<li><code>type="module"</code>：模块脚本默认延后执行，按依赖图加载，<code>DOMContentLoaded</code>会等待其完成。</li>
</ul>
<h4 data-id="heading-7">实际应用（顺序可视化示例）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐：存在依赖关系的脚本使用 defer，保证按声明顺序执行 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 独立的第三方脚本使用 async，不影响解析与渲染，也不会卡住其他脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 现代项目：优先使用模块脚本，依赖管理更清晰（默认延后执行，DOM解析完成后运行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">2）模块脚本与回退：<code>type="module"</code>/<code>nomodule</code>/动态导入</h3>
<h4 data-id="heading-9">应用场景</h4>
<p>在现代浏览器中使用ESM模块；为老旧浏览器准备兼容回退；按需加载分包。</p>
<h4 data-id="heading-10">常见问题</h4>
<ul>
<li>经典脚本与模块脚本相互调用导致作用域混乱。</li>
<li>使用<code>nomodule</code>错误，现代浏览器也执行了回退脚本。</li>
</ul>
<h4 data-id="heading-11">推荐方案</h4>
<ul>
<li>现代浏览器：主入口使用<code>type="module"</code>。</li>
<li>老旧浏览器回退：提供<code>nomodule</code>的经典脚本版本（通过构建产物区分）。</li>
<li>大页面：使用<code>import()</code>进行按需加载，减小首包体积。</li>
</ul>
<h4 data-id="heading-12">核心要点</h4>
<ul>
<li><code>nomodule</code>脚本仅在“不支持模块”的浏览器中执行；现代浏览器会忽略。</li>
<li>模块脚本是<code>strict mode</code>，顶层不会污染全局作用域。</li>
<li>动态导入返回<code>Promise</code>，友好配合路由/交互触发。</li>
</ul>
<h4 data-id="heading-13">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 现代入口 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// @description 页面主入口：模块脚本（默认延后执行）</span>
  <span class="hljs-comment">/**
   * 记录模块初始化
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 文本信息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logInit</span> = (<span class="hljs-params">msg</span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[module] <span class="hljs-subst">${msg}</span>`</span>);
  <span class="hljs-title function_">logInit</span>(<span class="hljs-string">'bootstrap'</span>);

  <span class="hljs-comment">// 动态导入，按需加载非关键功能</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { initFeature } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/feature.js'</span>);
    <span class="hljs-title function_">initFeature</span>();
  };
  <span class="hljs-comment">// 交互触发</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 旧浏览器回退（仅不支持模块的浏览器执行） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/app-legacy.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">3）安全与跨域：CSP nonce、SRI integrity 与 <code>crossorigin</code></h3>
<h4 data-id="heading-15">应用场景</h4>
<p>严格的安全审计要求；CDN脚本完整性校验；跨域加载脚本并需要捕获详细错误。</p>
<h4 data-id="heading-16">常见问题</h4>
<ul>
<li>直接写内联脚本被CSP拦截，页面功能失效。</li>
<li>使用<code>integrity</code>但未设置<code>crossorigin</code>，SRI校验被忽略。</li>
<li>跨域脚本错误只有“Script error”，无法定位堆栈与消息。</li>
</ul>
<h4 data-id="heading-17">推荐方案</h4>
<ul>
<li>启用CSP并为内联脚本设置<code>nonce</code>（服务器动态生成）。</li>
<li>CDN脚本配合<code>integrity</code>与<code>crossorigin="anonymous"</code>确保完整性与错误可见性。</li>
<li>服务器允许跨域并设置<code>Access-Control-Allow-Origin</code>与<code>Timing-Allow-Origin</code>以提升可观测性。</li>
</ul>
<h4 data-id="heading-18">核心要点</h4>
<ul>
<li><code>Content-Security-Policy: script-src 'self' 'nonce-&lt;随机值&gt;' https://cdn.example.com</code>。</li>
<li><code>integrity</code>需与<code>crossorigin</code>配合，跨域资源不然可能跳过校验。</li>
<li>设置<code>window.addEventListener('error', ...)</code>与<code>unhandledrejection</code>捕获错误。</li>
</ul>
<h4 data-id="heading-19">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 服务端需下发一致的 nonce 值（示例：nonce-xyz） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"script-src 'self' 'nonce-xyz' https://cdn.example.com"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 内联脚本加 nonce，避免被CSP拦截 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"xyz"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 上报错误（示例）
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">type</span> - 错误类型
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">msg</span> - 错误消息
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reportError</span> = (<span class="hljs-params">type, msg</span>) =&gt; {
    <span class="hljs-comment">// 真实项目中调用监控SDK或自建上报接口</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[error] <span class="hljs-subst">${type}</span>: <span class="hljs-subst">${msg}</span>`</span>);
  };
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'onerror'</span>, e.<span class="hljs-property">message</span>));
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reportError</span>(<span class="hljs-string">'promise'</span>, <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>)));
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- CDN脚本完整性 + 可见错误堆栈（需服务端允许跨域） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/sdk.min.js"</span>
        <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-BASE64_HASH"</span>
        <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
        <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-20">4）错误监控与可观测性：从“Script error”到可定位</h3>
<h4 data-id="heading-21">应用场景</h4>
<p>跨域脚本导致错误信息缺失；需要在生产环境获取完整堆栈与来源。</p>
<h4 data-id="heading-22">常见问题</h4>
<ul>
<li>未设置<code>crossorigin</code>导致错误被屏蔽。</li>
<li>监控系统只收到了通用的“Script error”。</li>
</ul>
<h4 data-id="heading-23">推荐方案</h4>
<ul>
<li>对外链脚本统一加<code>crossorigin="anonymous"</code>。</li>
<li>服务器返回<code>Access-Control-Allow-Origin: *</code>或你的域名；并提供<code>Timing-Allow-Origin</code>以开放性能指标。</li>
<li>对于私有CDN，确保响应头携带正确的CORS与缓存策略。</li>
</ul>
<h4 data-id="heading-24">实际应用（最小上报器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 发送错误到监控平台
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{type:string,message:string,stack?:string</span>}} payload - 错误信息
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendError</span> = (<span class="hljs-params">payload</span>) =&gt; {
  <span class="hljs-comment">// 示例：仅打印；实际项目应调用后端接口</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📮 error-report'</span>, payload);
};

<span class="hljs-comment">/**
 * 初始化错误监听
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initErrorListener</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">message</span>: e.<span class="hljs-property">message</span>, <span class="hljs-attr">stack</span>: e.<span class="hljs-property">error</span>?.<span class="hljs-property">stack</span> });
  });
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">sendError</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'promise'</span>, <span class="hljs-attr">message</span>: <span class="hljs-title class_">String</span>(e.<span class="hljs-property">reason</span>) });
  });
};

<span class="hljs-title function_">initErrorListener</span>();
</code></pre>
<h3 data-id="heading-25">5）性能与加载优化：位置、拆分、预加载、优先级</h3>
<h4 data-id="heading-26">应用场景</h4>
<p>首屏加载优化、减少阻塞、合理拆分产物、控制网络优先级。</p>
<h4 data-id="heading-27">常见问题</h4>
<ul>
<li>将大型同步脚本放在<code>&lt;head&gt;</code>导致阻塞。</li>
<li>所有代码打成一个包，影响首屏与可缓存性。</li>
<li>关键脚本加载优先级过低导致交互延迟。</li>
</ul>
<h4 data-id="heading-28">推荐方案</h4>
<ul>
<li>非必要脚本置底或使用<code>defer</code>；第三方独立脚本用<code>async</code>。</li>
<li>按路由/功能拆分产物；模块脚本配合<code>import()</code>实现懒加载。</li>
<li>对真正关键脚本使用<code>fetchpriority="high"</code>（实验性特性，评估后再用）。</li>
</ul>
<h4 data-id="heading-29">实际应用</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 关键脚本：提升获取优先级并延后执行（避免阻塞） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/critical.js"</span> <span class="hljs-attr">fetchpriority</span>=<span class="hljs-string">"high"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 辅助脚本：按需加载（路由/交互触发） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">/**
   * 懒加载非关键功能
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>}
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">lazyFeature</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> { mount } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'/assets/chart.js'</span>);
    <span class="hljs-title function_">mount</span>(<span class="hljs-string">'#chart'</span>);
  };
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#btn'</span>)?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lazyFeature</span>());
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-30">📊 技巧对比总结</h2>









































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>同步脚本（不推荐）</td><td>早期简单页面</td><td>立即执行</td><td>阻塞解析与渲染，影响首屏</td></tr><tr><td>defer</td><td>有依赖且需保持顺序</td><td>不阻塞解析；按引入顺序执行</td><td>仅外链脚本生效；在解析完成后执行</td></tr><tr><td>async</td><td>独立第三方脚本</td><td>不阻塞解析；最快可用</td><td>顺序不确定；不适合有依赖脚本</td></tr><tr><td>type="module"</td><td>现代项目主入口与分包</td><td>依赖图管理；默认延后执行</td><td>需考虑旧浏览器；配合 nomodule 回退</td></tr><tr><td>nomodule</td><td>旧浏览器回退</td><td>保证兼容</td><td>仅旧浏览器执行；与模块入口配套</td></tr></tbody></table>
<h2 data-id="heading-31">🎯 实战应用建议</h2>
<h3 data-id="heading-32">最佳实践</h3>
<ol>
<li>同时输出 <code>esm</code> 与 <code>legacy</code> 产物；模板中注入 <code>type="module"</code> 与 <code>nomodule</code> 入口。</li>
<li>第三方独立脚本统一使用 <code>async</code>；有依赖的业务脚本使用 <code>defer</code> 保序。</li>
<li>模块化按需拆分：非关键功能通过 <code>import()</code> 懒加载，降低首包体积。</li>
<li>安全策略到位：开启 CSP（<code>nonce</code>/<code>hash</code>/<code>strict-dynamic</code>）与 SRI（<code>integrity</code> + <code>crossorigin</code>）。</li>
</ol>
<h3 data-id="heading-33">性能考虑</h3>
<ul>
<li>关键脚本提升网络优先级（<code>fetchpriority</code>）并使用 <code>defer</code> 避免阻塞。</li>
<li>大页面进行路由/功能拆分；CDN 缓存策略与版本化确保命中率。</li>
<li>错误与性能可观测性：启用 <code>crossorigin</code> 与 <code>Timing-Allow-Origin</code>，便于采集与诊断。</li>
</ul>
<h2 data-id="heading-34">💡 总结</h2>
<p>这5个脚本治理技巧覆盖了加载模型、模块化、跨域安全、错误监控与性能优化：</p>
<ol>
<li>加载与执行模型：明确 <code>defer/async/module</code> 的时序与适用场景。</li>
<li>模块脚本与回退：<code>type="module"</code> + <code>nomodule</code> 兼顾现代与旧环境。</li>
<li>安全与跨域：CSP <code>nonce</code>、SRI <code>integrity</code> 与 CORS 正确配合。</li>
<li>错误监控与可观测性：统一监听与跨域头，避免“Script error”。</li>
<li>性能与加载优化：拆分、预加载与优先级，降低阻塞时间。</li>
</ol>
<p>掌握以上技巧能让你的前端应用更稳定、更安全、更高效。建议在团队内形成统一的脚本治理规范，并提供测试页面验证关键场景，持续迭代优化。</p>
<h2 data-id="heading-35">相关资源</h2>
<ul>
<li>MDN：HTML <code>&lt;script&gt;</code> 元素（参考与属性说明）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fscript" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Reference/Elements/script" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>CSP 指南：Content Security Policy
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FCSP" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>SRI 指南：Subresource Integrity
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>Priority Hints（fetchpriority）
<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fpriority-hints" target="_blank" title="https://web.dev/articles/priority-hints" ref="nofollow noopener noreferrer">web.dev/articles/pr…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：掌握了脚本加载与执行的5个核心技巧，含安全与性能的最佳实践，这些知识点在实际前端项目中非常实用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论]]></title>    <link>https://juejin.cn/post/7571278865516576818</link>    <guid>https://juejin.cn/post/7571278865516576818</guid>    <pubDate>2025-11-11T09:12:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865516576818" data-draft-id="7571281406509596723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:12:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript为何在AI时代登顶：Anders Hejlsberg 的十二年演化论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:12:05.000Z" title="Tue Nov 11 2025 09:12:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文访谈：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fdeveloper-skills%2Fprogramming-languages-and-frameworks%2Ftypescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg%2F" target="_blank" title="https://github.blog/developer-skills/programming-languages-and-frameworks/typescripts-rise-in-the-ai-era-insights-from-lead-architect-anders-hejlsberg/" ref="nofollow noopener noreferrer">github.blog/developer-s…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4a4d83875a462da6e652b941371838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457124&amp;x-signature=7Hx3ZWByJZnlcIPUITcV160phbc%3D" alt="" loading="lazy"/></p>
<p><strong>当 Anders Hejlsberg 在 2012 年开始着手 TypeScript 时，他并不是在构想一个要与 JavaScript 竞争的新语言。</strong> 他试图解决一个非常现实的问题：JavaScript 已经成为整个 Web 的基石，但它并不适合大型、多开发者协作的代码库。团队们正在交付数百万行弱类型代码，而当系统复杂到难以推理时，这门语言几乎提供不了任何帮助。</p>
<p><strong>这项起初的务实修补最终重塑了现代开发。</strong> 在 2025 年，TypeScript 成为 GitHub 上使用量最高的语言，首次超过了 JavaScript 与 Python。仅今年，就有超过一百万名开发者以 TypeScript 参与贡献——这是 Octoverse 统计的 66% 的增长。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ce0dd85ad8437d91cbdf63cc7caf69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457124&amp;x-signature=0LSbTaWzOLR%2FRBYeOGecGOymyrw%3D" alt="" loading="lazy"/></p>
<p>他说：“我记得当时心里想，也许我们能让 25% 的 JavaScript 社区产生兴趣——那就算成功了。但看到现在的情况？我完全惊呆了。”</p>
<p><strong>在 2025 年，TypeScript 成为 GitHub 上使用量最多的语言，首次超过 JavaScript 和 Python。</strong> 根据今年的 Octoverse 报告，仅今年就有超过一百万名开发者开始用 TypeScript 贡献代码（同比增长 66%）。</p>
<p>那么，一个 JavaScript 的类型化超集是如何成为 AI 时代的主导语言的？我们与 Anders 坐下来，聊了演化、性能，以及为什么一门为更好的人类协作而设计的语言，如今正在为机器辅助编码提供动力。</p>
<hr/>
<h2 data-id="heading-0">“我们原以为 25% 的采用率就算成功。”</h2>
<p>“项目刚启动时，”Anders 说，“我估计如果我们能让 25% 的 JavaScript 社区表现出兴趣，那就赢了。但现在，看着每天有这么多人依赖它……我和整个团队都惊呆了。”</p>
<p>回到 2012 年，JavaScript 已经根深蒂固。TypeScript 的赌注不是取代它，而是通过添加类型、工具链和可重构性，让大规模 JavaScript 开发变得“可理性”。</p>
<blockquote>
<p><strong>“做一件你知道真的能带来改变的事，是一种喜悦。我们没打算无处不在。我们只是想让开发者能更有信心地构建大型系统。”</strong> ——TypeScript 创作者 Anders Hejlsberg</p>
</blockquote>
<p>十年后，这个赌注成为默认。几乎所有现代前端框架——React、Next.js、Angular、SvelteKit——都默认提供 TypeScript 脚手架。结果是：更安全的代码库、更好的自动补全、更少凌晨 3 点因为一个 undefined 而调试崩溃。</p>
<p>“Anders 说：“魔力就在于让 TypeScript 感觉像 JavaScript，但拥有超能力。”</p>
<hr/>
<h2 data-id="heading-1">⚙️ TypeScript 到底是什么？</h2>
<p>TypeScript 是一个开源的、带类型标注的 JavaScript 超集，它会编译成普通 JavaScript。它添加静态类型检查、接口、泛型和现代语言特性——并在编译时把它们抹去，使输出能在任何 JavaScript 能运行的地方运行。</p>
<p>开发者使用它的理由：</p>
<ul>
<li>在运行前捕获类型错误</li>
<li>提升 IDE 自动补全与重构能力</li>
<li>让大型代码库在团队协作下仍可维护</li>
<li>与框架和 AI 辅助工具无缝集成</li>
</ul>
<p>它用于：前端框架（React, Angular, Vue）、后端系统（Node.js, Deno）、SDK、设计系统，以及越来越多需要强类型来确保生成代码安全的 AI 代理框架。</p>
<hr/>
<h2 data-id="heading-2">为未来重写编译器</h2>
<p>TypeScript 发布时著名的“自托管”特性：用 TypeScript 自己编写。这让编译器便携、可修改。但性能最终成为问题。</p>
<p>“Anders 说：“放弃自托管让我们很痛苦，但我们知道性能已经挤不出更多了。”</p>
<p>我们尝试了 C#、其他语言，最后选择 Go。性能提升达到了 10 倍。一半来自原生速度，一半来自共享内存并发。这种 10 倍提升是不能忽视的。</p>
<p>重写带来了一个更快、更轻、更适合企业规模代码库的编译器——但功能上与旧版本完全一致。</p>
<p>Anders 谈到：“我们现在有一个原生编译器，从怪癖到行为都与旧的完全一致。社区不需要丢掉任何东西。”</p>
<p>这种<strong>在提升性能的同时保留行为一致性</strong>的理念，是开发者信任 TypeScript 的原因之一。它不是每隔几年来一次“从零开始”的重写，而是一个保持兼容、不断演化的系统。</p>
<hr/>
<h2 data-id="heading-3">“开源是被捕捉在代码里的演化。”</h2>
<p>Anders 把开源看作一种类似自然选择的生态系统。</p>
<p>“Anders 说：“开源本来是个巨大的实验。没人真正搞清楚如何为它提供资金——但我们现在看到，它比以往更大，也不会消失。那就是被捕捉在代码里的演化。”</p>
<p>今年的 Octoverse 数据验证了这一点：开发者在 2025 年提交了近 10 亿次提交（同比 +25%），其中 11.2 亿次提交到公共和开源仓库。这是用一次次 PR 写下的“演化记录”。</p>
<p>拥有 12 年 issues、PR 与设计文档的 TypeScript 仓库，本身已经成为语言演化的活档案。“我们有 12 年的历史被记录在 GitHub 上，”Anders 说。“所有内容都可搜索。那就是你能 grep 的演化。”</p>
<hr/>
<h2 data-id="heading-4">AI 效应：为什么 TypeScript 在现在的时代更强盛？</h2>
<p>Octoverse 2025 最突出的数据之一显示 AI 正在改变语言偏好。开发者正转向能让 AI 辅助编码更可靠、更可维护的类型语言。</p>
<p>Anders 解释道：</p>
<blockquote>
<p><strong>“AI 在一门语言上写代码的能力，与它见过的该语言数量成正比。它是一个巨大的复述器，带些外推。AI 看过大量的 JavaScript、Python 和 TypeScript，所以它在写这些语言时特别强。新语言反而处于劣势。”</strong></p>
</blockquote>
<p>这种数据优势，加上 TypeScript 的静态类型系统，使其非常契合 AI 优先的工作流。</p>
<p>“Anders 说：“如果你让 AI 翻译 50 万行代码，它可能会产生幻觉。但如果你让它生成一个程序，以确定性方式完成同样的翻译，你就能得到可靠结果。这就是类型系统被设计出来要解决的问题。”</p>
<p>结论：在一个代码由人类和机器共同编写的世界里，类型不是官僚主义，而是真相校验器。</p>
<hr/>
<h2 data-id="heading-5">从 IDE 到 Agent</h2>
<p>大型语言模型的兴起也在改变“开发工具”的定义。IDE 正在从为人类服务，变成同时为 agents 服务的环境。</p>
<blockquote>
<p>“AI 一开始是助手。现在它在做工作，而你在监督。它不需要我们那种 IDE。它需要的是各种服务。这就是 Model Context Protocol 令人兴奋的地方。”</p>
</blockquote>
<p>Octoverse 报告描述这种变化：“AI 不只是重塑代码，而是在重塑选择。”</p>
<p>像 TypeScript 这样的类型语言，为 agents 提供了安全重构、语义查询和对代码库进行确定性推理的结构化基础。</p>
<p>“Anders 补充说：“目标是为 AI 工作流设定恰到好处的确定性，让它们保持有用而不至于脱轨。”</p>
<hr/>
<h2 data-id="heading-6">这门持续演化的语言</h2>
<p>从 Turbo Pascal 到 C#，再到 TypeScript，Anders 的工作跨越数十年。但令人惊讶的是，他始终保持一致：构建能让复杂软件更易理解的语言。</p>
<blockquote>
<p>“没有什么比做一件确实能带来改变的事情更令人满足的了。TypeScript 不断变化，但始终围绕同一件事：帮助开发者清晰表达意图。”</p>
</blockquote>
<p>这种清晰，或许正是为什么 2025 年平均每秒就有至少一个新开发者加入 GitHub，而其中越来越多人选择从 TypeScript 开始。</p>
<p>TypeScript 的故事不仅仅是语言设计的故事；</p>
<p>它是演化的故事——一个起初为修补 JavaScript 扩展性而生的项目，如今成为开发者与 AI 共同写代码的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端高频面试题之Vue（初、中级篇）]]></title>    <link>https://juejin.cn/post/7571303808115769396</link>    <guid>https://juejin.cn/post/7571303808115769396</guid>    <pubDate>2025-11-11T13:31:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571303808115769396" data-draft-id="7571278865517805618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端高频面试题之Vue（初、中级篇）"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T13:31:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端高频面试题之Vue（初、中级篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:31:42.000Z" title="Tue Nov 11 2025 13:31:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、说说你对 Vue.js 的理解？</h2>
<p><code>Vue.js</code> 是一个用于创建用户界面的开源 <code>JavaScript</code> 框架，它的特点如下：</p>
<h3 data-id="heading-1">1.1 声明式框架</h3>
<ul>
<li>早在JQ的时代编写的代码都是命令式的，命令式框架重要特点就是关注过程。</li>
<li>声明式框架更加关注结果。命令式的代码封装到了框架内部，过程靠框架来实现。</li>
</ul>
<h3 data-id="heading-2">1.2 数据驱动/响应式数据</h3>
<p>通过 <code>Object.defineProperty（Vue 2）</code> 或 <code>Proxy（Vue 3）</code> 实现数据劫持，数据变化时自动更新视图，开发者无需手动操作 DOM。</p>
<h3 data-id="heading-3">1.3 虚拟DOM</h3>
<p>通过高效的 <code>Diff</code> 算法比对虚拟 <code>DOM</code> 的变化，最小化真实 <code>DOM</code> 操作，提升性能。</p>
<h3 data-id="heading-4">1.4 组件化</h3>
<p>将 UI 拆分为独立可复用的组件，每个组件包含自己的模板、逻辑和样式，通过组合组件构建复杂应用。</p>
<h3 data-id="heading-5">1.5 指令系统</h3>
<p>提供 <code>v-if</code>、<code>v-for</code>、<code>v-bind</code>、<code>v-on</code> 等指令，以声明式方式增强 HTML 的功能。</p>
<h3 data-id="heading-6">1.6 渐进式框架</h3>
<ul>
<li><strong>渐进集成</strong>：可以从小规模功能（如静态页面交互）逐步扩展到完整的单页应用（SPA）。</li>
<li><strong>灵活生态</strong>：核心库只关注视图层，但配合官方路由（Vue Router）、状态管理（Vuex/Pinia）、构建工具（Vite）等，能轻松扩展为全功能框架。</li>
</ul>
<p>就是你可以单独用 <code>vue</code> 的响应式构建静态页面，如果你需要状态管理，就用官方的状态管理工具 <code>Vuex/Pinia</code>，如果你需要构建一个应用，有多个页面，可以用官方路由 <code>Vue-router</code>，如果你需要一键生成项目，可以用官方的 <code>vue-cli</code> 或者使用 <code>vite</code> 的 <code>npm create vue@latest</code> 命令一键创建项目。</p>
<h2 data-id="heading-7">2、请说一下对 Vue.js 响应式数据的理解？</h2>
<p><code>vue</code> 是通过数据驱动视图的，响应式指的是当数据发生变化时，使用到该数据的页面会自动更新。在表单中，可以通过响应式实现<strong>双向绑定</strong>，实现表单值和数据的<strong>双向同步</strong>。</p>
<h3 data-id="heading-8">2.1 基本原理</h3>
<ol>
<li><strong>数据劫持</strong>：<code>vue2</code> 中使用 <code>Object.defineProperty</code> 对对象属性进行劫持，对数组则采用重写数组的七个方法<code>（push,shift,pop,splice,unshift,sort,reverse）</code>来实现劫持，而 <code>vue3</code> 则通过 <code>Proxy</code> API 可以天然对对象和数组实现数据劫持。</li>
<li><strong>依赖收集</strong>：在 <code>getter</code> 中收集依赖(谁在使用这个数据)。</li>
<li><strong>派发更新</strong>：在 <code>setter</code> 中通知所有依赖进行更新，更新页面。</li>
</ol>
<h3 data-id="heading-9">2.2 特点</h3>
<ol>
<li><strong>自动更新</strong>：数据变化时，依赖该数据的视图会自动更新。</li>
<li><strong>深度监听</strong>：嵌套对象也会被递归转为响应式。</li>
<li><strong>异步更新</strong>：Vue 会异步执行 DOM 更新，提高性能。</li>
</ol>
<h3 data-id="heading-10">2.3 Vue3 响应式改进</h3>
<p>使用 <code>Proxy</code> 代替 <code>Object.defineProperty</code>：</p>
<ul>
<li>可以检测到对象属性的添加和删除。</li>
<li>对数组的变化无需特殊处理，天然可以监听到通过数组索引修改元素和修改 <code>length</code> 属性的行为。</li>
<li>性能更好。</li>
</ul>
<h3 data-id="heading-11">2.4 扩展：针对响应式可以做的性能优化（vue2）：</h3>
<ul>
<li>对象层级过深，性能就会差，所以响应式尽量扁平化。</li>
<li>不需要响应数据的内容不要放到 data 中。</li>
<li>不需要更新的静态数据可以用 <code>Object.freeze()</code> 冻结数据。</li>
</ul>
<h3 data-id="heading-12">2.5 注意事项</h3>
<ol>
<li>对象新增属性：<code>vue 2</code> 中需要使用 <code>Vue.set</code> 或 <code>this.$set</code> 方法。</li>
<li>数组变化：<code>vue 2</code> 中直接通过索引修改或修改 <code>length</code> 属性不会触发响应，应使用变异方法(<code>push/pop/shift</code>等)或 <code>Vue.set、this.$set</code>。</li>
<li>性能考量：响应式系统需要追踪依赖，大型对象可能会有性能开销。</li>
</ol>
<p>响应式系统让开发者可以专注于数据逻辑，而无需手动处理 DOM 更新，大大提高了开发效率。</p>
<h2 data-id="heading-13">3、Vue3 的升级点？</h2>
<h3 data-id="heading-14">3.1 架构升级</h3>
<p>Vue3 源码采用 <strong>monorepo</strong> 方式进行管理，将模块拆分到packages中，这样做的好处如下：</p>
<ol>
<li>将多个模块集合到一个仓库，方便维护。</li>
<li>方便版本管理和依赖管理，各模块间相互引用也比较方便。</li>
<li>各个包可以单独安装使用，不需要导入整个 vue。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31a6b97686e45ed9d72c15d8ccb71d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472701&amp;x-signature=0AclC2F9tzfQzEnHYn14jB7MBnY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">3.2 组合式API -&gt; Composition API</h3>
<p>vue2 中 <code>Options API</code>（即提供props、methods、data、computed、watch等属性供用户使用）的问题：</p>
<ol>
<li>复用性比较差，虽然提供 mixins 和 extends，但会出现数据来源不明确和重名问题。</li>
<li>需要使用带有副作用<code>this</code>，存在this指向问题，同时对 <code>tree-shaking</code> 也不友好。</li>
<li>对于上百行的大型组件来说，当你了解某段逻辑时，你需要不断上下移动阅读，体验很差。</li>
</ol>
<p>vue3<code>Composition API</code>特点：</p>
<ol>
<li>方便抽离，复用性强，可以把干净的逻辑提取到一个单独函数或者文件中，让开发者专注于逻辑内聚问题。</li>
<li>抛弃this，tree-shaking 友好，打包出来体积更小。</li>
</ol>
<h3 data-id="heading-16">3.3 响应式系统</h3>
<p>vue3采用<code>proxy</code>替代了<code>Object.defineProperty</code>:</p>
<ol>
<li>提升了性能，不再需要一次性全部递归拦截。</li>
<li>能拦截到对象属性的新增和删除。</li>
<li>能拦截原生数组的索引、length操作。</li>
</ol>
<h3 data-id="heading-17">3.4 diff算法</h3>
<p>全量 <code>diff</code> 算法中采用<strong>最长递增子序列</strong>减少节点的移动。在非全量 <code>diff</code> 算法中只比较动态节点，通过 <code>PatchFlag</code> 标记更新动态的部分。</p>
<h3 data-id="heading-18">3.5 渲染优化</h3>
<p>在渲染方面，vue3提供了<strong>自定义渲染器</strong>，大大提升了扩展能力。</p>
<h3 data-id="heading-19">3.6 编译优化</h3>
<ul>
<li><strong><code>Block</code>和 <code>patchFlag</code></strong>：为动态节点打上补丁标志，即 <code>patchFlag</code>，同时还提出了 <code>block</code> 的概念，<code>block</code> 本质上是一个虚拟节点，但它会多出一个 <code>dynamicChildren</code> 数组，会收集它所有的动态子代节点，比对的时候会忽略DOM层级结构的，所以对于带有 <code>v-if</code>、<code>v-for</code> 等结构化指令的节点也作为 <code>block</code> 的角色。</li>
<li><strong>静态提升</strong>：将静态虚拟的节点提升到render函数之外，这样能够减少更新时创建虚拟DOM带来的性能开销和内存占用。</li>
<li><strong>预字符串化</strong>：在静态提升的基础上，当模板中包含大量连续纯静态的标签节点时，将这样静态节点序列化成字符串，然后通过innerHTML进行设置，这样做能够减少创建虚拟节点产生的性能开销和内存占用。</li>
<li><strong>缓存内联事件处理函数</strong>：可以避免不必要的更新。</li>
<li><strong>v-once指令</strong>：缓存虚拟节点，避免组件更新时重新创建虚拟DOM的性能开销，同时带有v-once指令的节点不会被父级block收集，所以不会参与diff操作，避免无用的diff开销。</li>
</ul>
<h3 data-id="heading-20">3.7 新增组件</h3>
<ul>
<li>Teleport：可以将指定内容渲染到特定容器中，而不受DOM层级的限制。</li>
</ul>
<h3 data-id="heading-21">3.8 对TypeScript支持更加友好</h3>
<p>vue2源码采用Flow做类型检测，对TypeScript支持并不友好，而Vue3采用TypeScript进行重写，对TS的支持更加友好。</p>
<h3 data-id="heading-22">3.9 体积更小（移除了不常用的 API）</h3>
<ul>
<li>移除 inline-template (Vue2 中就不推荐使用)。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>n</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">on、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">、</span></span></span></span></span>off、$once （如果有需要可以采用 mitt 库来实现）。</li>
<li>删除过滤器 filter （可以通过计算属性或者方法来实现）。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>h</mi><mi>i</mi><mi>l</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>n</mi><mtext>移除（可以通过</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>v</mi><mi>i</mi><mi>d</mi><mi>e</mi><mtext>，</mtext><mi>i</mi><mi>n</mi><mi>j</mi><mi>e</mi><mi>c</mi><mi>t</mi><mtext>方法构建</mtext></mrow><annotation encoding="application/x-tex">children移除 （可以通过provide，inject方法构建</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord mathnormal">hi</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">d</span><span class="mord mathnormal">re</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">移除（可以通过</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">，</span><span class="mord mathnormal" style="margin-right:0.05724em;">inj</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">方法构建</span></span></span></span></span>children）。</li>
<li>移除.sync .native 修饰符 (.sync通过 v-model:xxx实现，.native为 Vue3 中的默认行为) 以及不在支持 keycode 作为v-on修饰符（@keyup.13 不再支持）。</li>
<li>移除全局 API。Vue.component、Vue.use、Vue.directive (将这些 api 挂载到实例上)。</li>
<li>通过构建工具 Tree-shaking 机制实现按需引入，减少用户打包后体积。</li>
</ul>
<h2 data-id="heading-23">4、Vue.js 为什么需要虚拟DOM？</h2>
<p>虚拟DOM（Virtual DOM）就是用 js 对象来描述真实 DOM，是对真实 DOM 的抽象。</p>
<h3 data-id="heading-24">4.1 性能优化</h3>
<ul>
<li><strong>直接操作 DOM 代价高昂</strong>：浏览器 DOM 操作是非常消耗性能的。</li>
<li><strong>最小差异更新</strong>：通过比对新旧虚拟 DOM 节点，找出最小差异进行更新。</li>
<li><strong>批量更新</strong>：在数据修改后，异步批量更新。</li>
</ul>
<blockquote>
<p>虚拟DOM并不一定能提升性能，比如你就改了一个数据，vue还要走一遍 DOM diff 比对完后再去调用原生 DOM API去更新，这时候其实你直接通过原生DOM API 去更新肯定性能更高，但是虚拟 DOM 能保证性能的下限，在你的应用复杂且庞大的时候，不至于性能太差。</p>
</blockquote>
<h3 data-id="heading-25">4.2 跨平台</h3>
<ul>
<li><strong>抽象层作用</strong>：虚拟 DOM 是对真实 DOM 的抽象表示。</li>
<li><strong>多端渲染</strong>：同一套虚拟 DOM 可以渲染到不同平台（Web、Native、Canvas等）。</li>
<li><strong>服务端渲染(SSR)</strong>：在没有真实 DOM 的环境下也能生成页面结构。</li>
</ul>
<h3 data-id="heading-26">4.3 声明式编程的优势</h3>
<ul>
<li><strong>开发者友好</strong>：开发者只需关心数据状态，不必手动操作 DOM。</li>
<li><strong>自动优化</strong>：框架层面负责最高效的更新策略，开发者无需微观管理。</li>
</ul>
<h3 data-id="heading-27">4.4 与响应式系统的协同</h3>
<ul>
<li><strong>依赖追踪</strong>：虚拟 DOM 与 Vue 的响应式系统紧密结合。</li>
<li><strong>组件级更新</strong>：数据更改后，在组件级别进行页面更新。</li>
</ul>
<h2 data-id="heading-28">5、Vue.js 组件间传值的方式</h2>
<p><strong>vue2</strong>：</p>
<ul>
<li>一、父子通信
<ol>
<li><code>props</code></li>
<li><code>$emit</code></li>
<li><code>$attrs、$listeners</code></li>
<li><code>$parent、$children</code></li>
<li><code>$ref</code></li>
<li><code>作用域插槽</code></li>
<li><code>v-model</code></li>
</ol>
</li>
<li>二、兄弟组件通信
<ol>
<li><code>mitt</code></li>
<li><code>$parent</code></li>
<li><code>vuex/pinia</code></li>
<li><code>app.config.globalProperties</code></li>
</ol>
</li>
<li>三、跨层级通信
<ol>
<li><code>vuex</code></li>
<li><code>provide/inject</code></li>
<li><code>event bus</code></li>
</ol>
</li>
</ul>
<p><strong>vue3</strong>：</p>
<ul>
<li>一、父子通信
<ol>
<li><code>props</code></li>
<li><code>defineEmits</code></li>
<li><code>$attrs</code></li>
<li><code>$ref + defineExpose</code></li>
<li><code>$parent</code></li>
<li><code>作用域插槽</code></li>
<li><code>v-model</code></li>
</ol>
</li>
<li>二、兄弟组件通信
<ol>
<li><code>mitt</code></li>
<li><code>$parent</code></li>
<li><code>vuex/pinia</code></li>
<li><code>app.config.globalProperties</code></li>
</ol>
</li>
<li>三、跨层级通信
<ol>
<li><code>mitt</code></li>
<li><code>vuex/pinia</code></li>
<li><code>provide/inject</code></li>
</ol>
</li>
</ul>
<p><strong>扩展：其它通信方式</strong>：</p>
<ul>
<li>浏览器本地存储<code>storage</code>。</li>
<li>全局<code>window</code>对象。</li>
<li>ES6模块化 import/export。</li>
</ul>
<h2 data-id="heading-29">6、v-show 和 v-if 有什么区别？使用场景分别是什么？</h2>
<p><strong>相同点</strong>：控制元素在页面是否显示。</p>
<p><strong>不同点</strong>：</p>
<ul>
<li><strong>控制手段不同</strong>：<code>v-show</code> 控制的是 <code>css</code> 的 <code>display</code> 属性是否为 <code>none</code> 来控制元素的是否隐藏，而 <code>v-if</code> 是直接不渲染 DOM 元素或者直接删除 DOM 元素。</li>
<li><strong>控制过程区别</strong>：<code>v-if</code> 切换有一个局部编译/卸载的过程，切换过程中合适地销毁和重建内部的事件监听和子组件，如果控制的是组件，也会执行组件的生命周期钩子；而<code>v-show</code> 只是简单的基于css切换。</li>
<li><strong>编译区别</strong>：<code>v-if</code> 在编译过程中会被转化成<strong>三元表达式</strong>,条件不满足时不渲染此节点。<code>v-show</code> 会被编译成指令，条件不满足时控制样式将对应节点隐藏 （内部其他指令依旧会继续执行）。</li>
<li><strong>性能消耗</strong>：<code>v-if</code> 比 <code>v-show</code> 有更高的性能消耗。</li>
</ul>
<p><strong>使用场景</strong>：频繁切换 + 不需要销毁状态用 <code>v-show</code>，反之用 <code>v-if</code>。</p>
<h2 data-id="heading-30">7、v-if 和 v-for  哪个优先级更高？</h2>
<ul>
<li>vue2 中 <code>v-for</code> 的优先级比 <code>v-if</code> 高，它们作用于一个节点上会导致先循环后对每一项进行判断，浪费性能。</li>
<li>vue3 中 <code>v-if</code> 的优先级比 <code>v-for</code> 高，这就会导致 <code>v-if</code> 中的条件无法访问 <code>v-for</code> 作用域名中定义的变量别名。</li>
</ul>
<p>所以不管是 <code>vue2</code> 还是 <code>vue3</code>，都不推荐同时使用 <code>v-if</code> 和 <code>v-for</code>，更好的方案是采用计算属性，或者在外层再包裹一个容器元素，将 <code>v-if</code> 作用在容器元素上。</p>
<p>不推荐用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in arr" v-if="item.visible"&gt;
  {{ item}}
&lt;/li&gt;
</code></pre>
<p>推荐用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- visibleArr为计算属性 --&gt;
&lt;li v-for="item in visibleArr"&gt;
    {{ item}}
  &lt;/li&gt;
</code></pre>
<h2 data-id="heading-31">8、Vue.js 的 nextTick 是什么？有什么使用场景？</h2>
<p>Vue.js 中的 nextTick（或实例方法 this.$nextTick）是一个 Vue 提供的一个 API，用于在响应式状态变更后等待下一个 DOM 更新周期完成后再执行代码。由于 Vue 的 DOM 更新是异步的：当你修改响应式数据时，Vue 内部会缓冲这些变更，并在<code>“下一个 tick”</code>中一次性应用到 DOM，用这种批量更新的方式提高性能。所以这意味着数据变更后立即访问 DOM 可能获取到旧值，而 nextTick 确保回调在 DOM 实际更新后运行。</p>
<p>其使用场景如下：</p>
<ul>
<li><strong>数据更新后立即操作 DOM</strong>：如获取元素尺寸、焦点设置或第三方库初始化。如果不使用 nextTick，你可能拿到的是未更新的 DOM，导致错误。</li>
<li><strong>避免多次渲染</strong>：Vue.js 内部用它批量更新 DOM，提高性能。</li>
<li><strong>与异步操作结合</strong>：如在 Promise 或 setTimeout 后更新数据，然后 await nextTick 来处理后续 DOM 依赖的任务。</li>
<li><strong>组件生命周期钩子中</strong>：在 mounted 或 updated 钩子中，如果需要基于更新后的 DOM 执行代码，使用 nextTick 确保安全。</li>
<li><strong>测试和调试</strong>：在单元测试中，确保 DOM 已同步更新后再断言。</li>
</ul>
<h2 data-id="heading-32">9、Vue中 computed 和 watch 的区别</h2>








































<table><thead><tr><th>特性</th><th>computed (计算属性)</th><th>watch (侦听器)</th></tr></thead><tbody><tr><td>设计目的</td><td>派生新数据</td><td>观察数据变化执行副作用</td></tr><tr><td>返回值</td><td>必须返回一个值</td><td>不需要返回值</td></tr><tr><td>缓存</td><td>有缓存，依赖不变时不重新计算</td><td>无缓存，每次变化都执行</td></tr><tr><td>异步操作</td><td>不能包含异步操作</td><td>可以执行异步操作</td></tr><tr><td>初始执行</td><td>立即执行</td><td>默认不立即执行(配置 immediate: true后会立即执行)</td></tr><tr><td>使用场景</td><td>模板中使用的派生数据</td><td>数据变化时需要执行的操作(如API调用、复杂逻辑)</td></tr></tbody></table>
<h2 data-id="heading-33">10、Vue2 的生命周期方法有哪些？一般在哪一步发起请求及原因</h2>
<ul>
<li><strong>beforeCreate</strong>：在实例初始化之后，数据观测(data observer) 和 event/watcher 事件配置之前被调用。</li>
<li><strong>created</strong>：实例已经创建完成之后被调用。在这一步，实例已完成以下的配置：数据观测(data observer)，属性和方法的运算， watch/event 事件回调。这里没有$el</li>
<li><strong>beforeMount</strong>：在挂载开始之前被调用：相关的 render 函数首次被调用。</li>
<li><strong>mounted</strong>：el 被新创建的 vm.$el 替换，并挂载到实例上去之后调用该钩子。</li>
<li><strong>beforeUpdate</strong>：数据更新时调用，发生在虚拟 DOM 重新渲染和打补丁之前。</li>
<li><strong>updated</strong>：由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子。</li>
<li><strong>beforeDestroy</strong>：实例销毁之前调用。在这一步，实例仍然完全可用。</li>
<li><strong>destroyed</strong>：Vue 实例销毁后调用。调用后，Vue 实例指示的所有东西都会解绑定，所有的事件监听器会被移除，所有的子实例也会被销毁。 该钩子在服务器端渲染期间不被调用。</li>
</ul>
<p><strong>钩子函数的作用</strong>：</p>
<ul>
<li><strong>created</strong>：实例已经创建完成，因为它是最早触发的原因可以进行一些数据，资源的请求。(服务端渲染支持created方法)</li>
<li><strong>mounted</strong>：实例已经挂载完成，可以进行一些DOM操作</li>
<li><strong>beforeUpdate</strong>：可以在这个钩子中进一步地更改状态，这不会触发附加的重渲染过程。</li>
<li><strong>updated</strong>：可以执行依赖于 DOM 的操作。然而在大多数情况下，你应该避免在此期间更改状态，因为这可能会导致更新无限循环。 该钩子在服务器端渲染期间不被调用。</li>
<li><strong>destroyed</strong>：可以执行一些优化操作,清空定时器，解除绑定事件</li>
</ul>
<p>在哪发送请求都可以，主要看具体你要做什么事，一般会在 <code>created</code> 和 <code>mounted</code> 发起请求，但注意服务端渲染不执行 <code>mounted</code> 钩子。</p>
<h2 data-id="heading-34">11、Vue.js 中组件中的 data 为什么是一个函数?</h2>
<p>每次使用组件时都会对组件进行实例化操作，并且调用 <code>data</code> 函数返回一个对象作为组件的数据源。这样可以保证多个组件间数据互不影响。</p>
<h2 data-id="heading-35">12、谈谈对 Vue.js 组件化的理解？</h2>
<p>在 Vue.js 中，每一个 <code>.vue</code> 文件即一个 vue 组件，组件化的核心包括模板 template、属性 props、事件、插槽 slot、生命周期等。</p>
<p>组件化好处: 高内聚、可重用、可组合。</p>
<ul>
<li>组件化开发能大幅提高应用开发效率、测试性、复用性等;</li>
<li>降低更新范围，只重新渲染变化的组件。</li>
</ul>
<h2 data-id="heading-36">13、谈谈对 Vue.js 单向数据流的理解？</h2>
<p>Vue.js 的单向数据流是其核心设计原则之一，它确保数据在组件间流动时具有<strong>可预测性</strong>和<strong>一致性</strong>，便于调试和追踪 bug。</p>
<p>数据总是从父组件向下流动到子组件（通过 <code>props</code> 传递），而子组件不能直接修改从父组件接收到的数据。如果子组件需要更新数据，只能通过触发事件（<code>emits</code> 或自定义事件）通知父组件，由父组件负责实际的更新。</p>
<h2 data-id="heading-37">14、Vue.js 父组件如何监听子组件的生命周期？</h2>
<ul>
<li>vue2 用 @hook:mounted。</li>
<li>vue3 用 @vue:mounted。</li>
</ul>
<p>下面演示 vue3 的写法，vue2 同理。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- parent.vue --&gt;
&lt;template&gt;
  &lt;Child @vue:mounted="fn" /&gt;
&lt;/template&gt;


&lt;script lang="ts" setup&gt;
import Child from './Child.vue'
const afterChildMounted = () =&gt; {
  console.log('after child mounted')
}
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Child.vue --&gt;
&lt;script setup&gt;
import { onMounted } from 'vue'

onMounted(() =&gt; {
  console.log('child mounted')
})

&lt;/script&gt;

</code></pre>
<h2 data-id="heading-38">15、请说一下 Vue.js 中 key 的作用？</h2>
<p>在 Vue.js 中，<code>key</code> 属性主要用于优化列表渲染，特别是与 <code>v-for</code> 指令结合使用时。它为列表中的每个元素提供一个唯一的标识符，帮助 Vue 跟踪节点的身份，从而在数据变化时更高效地更新 DOM。</p>
<ul>
<li><strong>提升渲染效率</strong>：Vue 默认使用“就地更新”（in-place patch）策略来处理列表变化，即不移动 DOM 元素，而是直接更新现有元素的内容。如果列表项的顺序发生变化，这种策略可能导致问题（如状态丢失）。<code>key</code> 允许 Vue 复用和重新排序现有的 DOM 元素，确保更新更精确。</li>
<li><strong>保留组件状态</strong>：当列表项包含有状态的组件（如表单输入框）时，<code>key</code> 确保组件的内部状态（如输入值）不会在数据重排时丢失或错位。</li>
<li><strong>优化 diff 算法</strong>：Vue 的虚拟 DOM diff 过程依赖 <code>key</code> 来比较新旧节点。如果没有 key，Vue 会按索引比较，可能导致不必要的重新渲染。</li>
</ul>
<h2 data-id="heading-39">16、Vue.use 是干什么的？</h2>
<p><code>Vue.use</code> 方法是用于安装（注册）Vue 插件的全局方法。它允许开发者在 Vue 应用中引入第三方插件或自定义插件，从而扩展 Vue 的功能，如添加全局组件、指令、混入（mixins）或其他特性。
主要作用</p>
<ul>
<li><strong>插件安装机制</strong>：当调用 Vue.use(plugin) 时，Vue 会检查插件是否有一个 install 方法。如果有，它会调用 plugin.install(Vue, options)，其中 Vue 是 Vue 构造函数，options 是可选参数。这使得插件可以修改 Vue 的行为或添加新功能。</li>
<li><strong>避免重复安装</strong>：Vue.use 会自动检查插件是否已安装，如果已安装，则不会重复调用 install 方法。</li>
<li><strong>使用时机</strong>：通常在创建 Vue 实例之前调用，例如在 main.js 中引入插件。</li>
</ul>
<h2 data-id="heading-40">17、Vue.js 常用的修饰符及其作用？</h2>
<ol>
<li>事件修饰符</li>
</ol>
<ul>
<li><strong>.stop</strong>：阻止事件冒泡，相当于 <code>event.stopPropagation()</code>。</li>
<li><strong>.prevent</strong>：阻止默认行为，相当于 <code>event.preventDefault()</code>。</li>
<li><strong>.capture</strong>：使用捕获模式而非冒泡模式触发事件。</li>
<li><strong>.self</strong>：只在事件从元素本身触发时执行（忽略子元素冒泡）。</li>
<li><strong>.once</strong>：事件只触发一次（相当于 addEventListener 的 once 选项）。</li>
<li><strong>.passive</strong>：改善滚动事件的性能（不阻塞 UI 线程）。</li>
<li><strong>.native</strong>：在自定义组件上监听原生 DOM 事件。</li>
</ul>
<ol start="2">
<li>v-model表单修饰符</li>
</ol>
<ul>
<li><strong>.lazy</strong>：在 change 事件后更新数据，而不是 input 事件（延迟更新）。</li>
<li><strong>.number</strong>：将输入值自动转换为数字类型。</li>
<li><strong>.trim</strong>：自动去除输入值的首尾空格。</li>
</ul>
<ol start="3">
<li>按键修饰符（Key Modifiers）</li>
</ol>
<ul>
<li><strong>.enter</strong>：监听 Enter 键。</li>
<li><strong>.tab</strong>：监听 Tab 键。</li>
<li><strong>.delete</strong>：监听 Delete 或 Backspace 键。</li>
<li><strong>.esc</strong>：监听 Esc 键。</li>
<li><strong>.space</strong>：监听空格键。</li>
<li><strong>.up / .down / .left / .right</strong>：监听方向键。</li>
</ul>
<ol start="4">
<li>.sync 修饰符</li>
</ol>
<p><code>.sync</code> 修饰符主要是为了简化组件间的双向数据绑定，它是一种语法糖，允许子组件通过特定事件更新父组件的 prop，而无需手动编写事件监听器。</p>
<h2 data-id="heading-41">18、vue3 中 ref 和 reactive 的区别？</h2>
<p>相同点：<code>ref</code> 和 <code>reactive</code> 都可以创建响应式数据。</p>
<p>不同点：</p>
<ol>
<li>入参不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：可以传基本数据类型（primitive values，如number、string、Symbol、undefined、null、bigInt、boolean），也可以包括对象。</li>
<li><strong>reactive</strong>：只能传入引用数据(object、array等)。</li>
</ul>
<ol start="2">
<li>访问和修改方式不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：必须使用 .value 来读写。</li>
<li><strong>reactive</strong>：像普通对象一样直接访问属性，无需额外后缀。</li>
</ul>
<ol start="3">
<li>实现上不同：</li>
</ol>
<ul>
<li><strong>ref</strong>：如果传入基础数据类型，直接用 RefImpl 类的 get set, 但如果传入的是引用数据类型，内部是借助 reactive 实现。</li>
<li><strong>reactive</strong>：内部采用 Proxy 进行代理实现的响应式。</li>
</ul>
<h2 data-id="heading-42">19、Vue3 中如何获取当前组件实例？</h2>
<p>通过 <code>getCurrentInstance</code> 函数可以获取当前组件实例。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { getCurrentInstance } from 'vue';
const instance = getCurrentInstance();
console.log('instance: ', instance);
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-43">20、如何使用异步组件？</h2>
<p>vue3:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';
const AsyncCom = defineAsyncComponent(() =&gt; import('./MyComponent.vue'));
&lt;/script&gt;
</code></pre>
<p>vue2:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  components: {
    AsyncCom: () =&gt; import('./MyComponent.vue')
  }
};
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-44">21、Vue.js 父子组件生命周期钩子的执行流程？</h2>
<ol>
<li><strong>组件创建阶段</strong>： 父 beforeCreate → 父 created → 父 beforeMount → 子 beforeCreate → 子 created → 子 beforeMount → 子 mounted → 父 mounted。</li>
<li><strong>组件更新阶段</strong>：父 beforeUpdate → 子 beforeUpdate → 子 updated → 父 updated。</li>
<li><strong>组件销毁阶段</strong>：父 beforeDestroy → 子 beforeDestroy → 子 destroyed → 父 destroyed。</li>
</ol>
<h2 data-id="heading-45">结语</h2>
<p>以上是整理的 20+ Vue 初、中级的高频面试题，如有错误或者可以优化的地方欢迎评论区指正，后续还会更新 Vue 面试题高级篇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我的react项目启动后，dom上的类名里没有代码位置信息]]></title>    <link>https://juejin.cn/post/7571279513247825946</link>    <guid>https://juejin.cn/post/7571279513247825946</guid>    <pubDate>2025-11-11T13:35:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571279513247825946" data-draft-id="7571351275976015923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我的react项目启动后，dom上的类名里没有代码位置信息"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-11-11T13:35:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我的react项目启动后，dom上的类名里没有代码位置信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:54.000Z" title="Tue Nov 11 2025 13:35:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在写一个新的 React 项目，打开浏览器开发者工具，发现个有意思的事：之前团队一起写的项目在 Elements 面板里，每个 DOM 元素都带着一堆 <code>data-component-*</code> 属性，能直接看到是哪个文件的哪一行代码。而这个我自己新起的项目就只有普通的 HTML 标签。</p>
<p>这到底咋回事？是不是有什么调试神器？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1941db24d5df4402a5a59b95bf33328a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=mWHd1MY8FRhsr9Xm6Yqzpj%2F1NEs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">React 的 DOM 为啥看不到组件名？</h2>
<p>先说个基础知识：React 组件最终会被编译成普通 HTML。你在 Elements 面板看到的是<strong>真实 DOM</strong>，不是 React 的虚拟 DOM。</p>
<p>比如这个组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<p>浏览器里只会看到：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>组件名 <code>MyButton</code> 根本不会出现在 DOM 里，因为它只是个 JavaScript 函数，最后返回的就是这个 <code>button</code> 元素。</p>
<h2 data-id="heading-1">那些能看到组件信息的项目是怎么做到的？</h2>
<p>看了别人的项目代码，发现都用了 Vite 调试插件。这类插件会给每个 React 元素注入调试属性：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>
&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出组件来源。</p>
<p>更强大的是，有些插件还支持<strong>点击页面元素直接跳转到 VS Code 源码</strong>！这才是真正的效率神器。</p>
<h2 data-id="heading-2">解决方案：vite-plugin-react-inspector</h2>
<p><code>vite-plugin-react-inspector</code> 是专门为 Vite + React 项目设计的调试工具，功能强大且易用。</p>
<h3 data-id="heading-3">安装</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-react-inspector
<span class="hljs-comment"># 或</span>
npm install -D vite-plugin-react-inspector
</code></pre>
<h3 data-id="heading-4">配置很简单</h3>
<p>在 <code>vite.config.ts</code> 里添加：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Inspector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-react-inspector'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> ({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-comment">// 只在开发模式启用</span>
    mode === <span class="hljs-string">'development'</span> &amp;&amp;
      <span class="hljs-title class_">Inspector</span>({
        <span class="hljs-attr">toggleButtonVisibility</span>: <span class="hljs-string">'always'</span>,
        <span class="hljs-attr">toggleComboKey</span>: <span class="hljs-string">'alt-shift'</span>,
      }),
  ].<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>),
}));
</code></pre>
<p>配置说明：</p>
<ul>
<li><code>toggleButtonVisibility: 'always'</code> - 始终显示检查器按钮</li>
<li><code>toggleComboKey: 'alt-shift'</code> - 使用 Alt+Shift 快捷键激活</li>
<li><code>mode === 'development'</code> - 生产环境自动禁用</li>
</ul>
<h3 data-id="heading-5">实际效果</h3>
<p>启动开发服务器后，在浏览器里看到的 DOM：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1221e687568c4d508cbee6eb65abca39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=1Mnmxe%2BvP%2BBax%2FqeBL4mUT9T%2FMg%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出来源。</p>
<p>然后复制在vscode搜索，直接就跳转到源码位置了。</p>
<h3 data-id="heading-6">仓库地址</h3>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsudongyuer%2Fvite-plugin-react-inspector" target="_blank" title="https://github.com/sudongyuer/vite-plugin-react-inspector" ref="nofollow noopener noreferrer">vite-plugin-react-inspector</a></strong> - GitHub 仓库，查看完整文档</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏗️ Spring Boot 3实现MySQL读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571304204754649142</link>    <guid>https://juejin.cn/post/7571304204754649142</guid>    <pubDate>2025-11-11T13:35:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754649142" data-draft-id="7571306072422793258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏗️ Spring Boot 3实现MySQL读写分离完整指南"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:35:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏗️ Spring Boot 3实现MySQL读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:49.000Z" title="Tue Nov 11 2025 13:35:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✨ 读写分离的核心价值</h2>
<p>在高并发场景下，数据库往往成为系统瓶颈。读写分离通过将写操作定向到主库、读操作分发到从库，显著提升系统读性能和数据可用性。当主库出现故障时，从库可以继续提供读服务，提高系统的稳定性。</p>
<h2 data-id="heading-1">⚙️ 项目依赖配置</h2>
<p>首先在<code>pom.xml</code>中添加必要依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">📁 核心实现代码详解</h2>
<h3 data-id="heading-3">1. 配置文件设置（application.yml）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 主库配置（写操作）</span>
    <span class="hljs-attr">master:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-comment"># Hikari连接池配置</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
    <span class="hljs-comment"># 从库配置（读操作）</span>
    <span class="hljs-attr">slave:</span>
      <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave_db?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">15</span>  <span class="hljs-comment"># 从库可以配置更多连接，因为读操作通常更频繁</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-4">2. 数据源枚举定义</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 数据源类型枚举
 * 用于标识当前操作应使用主库还是从库
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DataSourceType</span> {
    MASTER,  <span class="hljs-comment">// 主库：用于写操作（INSERT、UPDATE、DELETE）</span>
    SLAVE    <span class="hljs-comment">// 从库：用于读操作（SELECT）</span>
}
</code></pre>
<h3 data-id="heading-5">3. 数据源上下文管理器</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 数据源上下文管理器（基于ThreadLocal实现线程隔离）
 * 功能：保存当前线程使用的数据源类型，确保多线程环境下数据源切换不会相互干扰
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceContextHolder</span> {
    
    <span class="hljs-comment">// 使用ThreadLocal保证线程安全，每个线程有独立的数据源上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;DataSourceType&gt; CONTEXT_HOLDER = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 设置当前线程的数据源类型
     * @param dataSourceType 数据源类型（MASTER或SLAVE）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDataSourceType</span>(<span class="hljs-params">DataSourceType dataSourceType</span>)</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">set</span>(dataSourceType);
    }
    
    <span class="hljs-comment">/**
     * 获取当前线程的数据源类型
     * @return 当前数据源类型，默认为MASTER（保证写操作可靠性）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSourceType <span class="hljs-title">getDataSourceType</span>()</span> {
        <span class="hljs-keyword">return</span> CONTEXT_HOLDER.<span class="hljs-keyword">get</span>() == <span class="hljs-literal">null</span> ? DataSourceType.MASTER : CONTEXT_HOLDER.<span class="hljs-keyword">get</span>();
    }
    
    <span class="hljs-comment">/**
     * 清除当前线程的数据源类型
     * 防止内存泄漏，特别是在线程池场景下
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearDataSourceType</span>()</span> {
        CONTEXT_HOLDER.<span class="hljs-keyword">remove</span>();
    }
}
</code></pre>
<h3 data-id="heading-6">4. 动态路由数据源</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * 动态路由数据源（继承Spring的AbstractRoutingDataSource）
 * 核心功能：根据当前上下文动态选择主库或从库
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-comment">/**
     * 决定当前数据源查找键（Spring在每次数据库操作前调用此方法）
     * @return 数据源查找键（MASTER或SLAVE）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-type">DataSourceType</span> dataSourceType = <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"当前使用的数据源: "</span> + dataSourceType);
        <span class="hljs-keyword">return</span> dataSourceType;
    }
}
</code></pre>
<h3 data-id="heading-7">5. 数据源配置类</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 数据源配置类（核心配置）
 * 配置主从数据源并初始化路由数据源
 */</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableTransactionManagement</span>
<span class="hljs-variable">@EnableJpaRepositories</span>(
    basePackages = <span class="hljs-string">"com.example.repository"</span>,
    entityManagerFactoryRef = <span class="hljs-string">"entityManagerFactory"</span>,
    transactionManagerRef = <span class="hljs-string">"transactionManager"</span>
)
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 主库数据源（写操作）
     */</span>
    <span class="hljs-variable">@Bean</span>(name = <span class="hljs-string">"masterDataSource"</span>)
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.master"</span>)
    public DataSource <span class="hljs-built_in">masterDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 从库数据源（读操作）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"slaveDataSource"</span>)
    @<span class="hljs-selector-tag">ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">slaveDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 动态路由数据源（优先级最高，作为主数据源）
     */</span>
    @<span class="hljs-selector-tag">Primary</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"routingDataSource"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">routingDataSource</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"masterDataSource"</span>) DataSource masterDataSource,
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"slaveDataSource"</span>) DataSource slaveDataSource) {
        
        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        
        <span class="hljs-comment">// 配置目标数据源映射</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.MASTER, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(DataSourceType.SLAVE, slaveDataSource);
        
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 默认使用主库</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
    
    <span class="hljs-comment">/**
     * 实体管理器工厂
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"entityManagerFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-selector-tag">entityManagerFactory</span>(
            EntityManagerFactoryBuilder builder, 
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"routingDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">builder</span>
            <span class="hljs-selector-class">.dataSource</span>(dataSource)
            <span class="hljs-selector-class">.packages</span>(<span class="hljs-string">"com.example.entity"</span>)
            <span class="hljs-selector-class">.persistenceUnit</span>(<span class="hljs-string">"mysqlUnit"</span>)
            <span class="hljs-selector-class">.build</span>();
    }
    
    <span class="hljs-comment">/**
     * 事务管理器
     */</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"transactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">transactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"entityManagerFactory"</span>) EntityManagerFactory entityManagerFactory) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-8">6. AOP切面实现自动路由</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 数据源切面配置（基于AOP自动切换数据源）
 * 通过方法名自动识别读写操作，实现数据源动态路由
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(1)</span> <span class="hljs-comment">// 确保在事务切面之前执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    
    <span class="hljs-comment">/**
     * 写操作切点（insert、update、delete、save开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.create*(..)) || " +
            "execution(* com.example.service..*.update*(..)) || " +
            "execution(* com.example.service..*.delete*(..)) || " +
            "execution(* com.example.service..*.save*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWriteDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.MASTER);
        System.out.println(<span class="hljs-string">"切换到主库（写操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 读操作切点（select、get、find、query开头的方法）
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service..*.select*(..)) || " +
            "execution(* com.example.service..*.get*(..)) || " +
            "execution(* com.example.service..*.find*(..)) || " +
            "execution(* com.example.service..*.query*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.setDataSourceType(DataSourceType.SLAVE);
        System.out.println(<span class="hljs-string">"切换到从库（读操作）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 后置处理：清理数据源上下文
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service..*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataSourceType</span><span class="hljs-params">()</span> {
        DataSourceContextHolder.clearDataSourceType();
        System.out.println(<span class="hljs-string">"清理数据源上下文"</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">7. 业务层使用示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 用户服务实现类
 * 演示读写分离的实际应用
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserRepository</span> userRepository;
    
    <span class="hljs-comment">/**
     * 新增用户（写操作自动路由到主库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 方法名以"create"开头，AOP会自动切换到MASTER数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
    
    <span class="hljs-comment">/**
     * 根据ID查询用户（读操作自动路由到从库）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>) <span class="hljs-comment">// 只读事务优化性能</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-comment">// 方法名以"get"开头，AOP会自动切换到SLAVE数据源</span>
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(id).<span class="hljs-title function_">orElse</span>(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户（读操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findAll</span>();
    }
    
    <span class="hljs-comment">/**
     * 更新用户信息（写操作）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">save</span>(user);
    }
}
</code></pre>
<h2 data-id="heading-10">🔍 测试与验证</h2>
<h3 data-id="heading-11">单元测试类</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 读写分离测试类
 */</span>
<span class="hljs-keyword">@SpringBootTest</span>
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setPassword</span>("password");
        
        User savedUser = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(savedUser.getId());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("写操作测试通过（路由到主库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        List&lt;User&gt; users = userService<span class="hljs-selector-class">.getAllUsers</span>();
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(users);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读操作测试通过（路由到从库）");
    }
    
    <span class="hljs-comment">/**
     * 测试读写混合操作
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadWriteMix() {
        <span class="hljs-comment">// 写操作</span>
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("mixUser");
        userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-comment">// 读操作</span>
        User foundUser = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        Assertions<span class="hljs-selector-class">.assertNotNull</span>(foundUser);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("读写混合操作测试通过");
    }
}
</code></pre>
<h2 data-id="heading-12">⚠️ 关键注意事项</h2>
<h3 data-id="heading-13">1. 主从同步延迟处理</h3>
<p>在读写分离架构中，主从同步存在延迟可能性。刚写入主库的数据可能不会立即在从库中可用。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 强制读主库的场景
 */</span>
<span class="hljs-keyword">@Service</span>
public class CriticalService {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserRepository userRepository;
    
    <span class="hljs-comment">/**
     * 重要业务：写入后立即读取，强制走主库
     */</span>
    public User <span class="hljs-built_in">createAndGetUser</span>(User user) {
        <span class="hljs-comment">// 写入主库</span>
        User savedUser = userRepository<span class="hljs-selector-class">.save</span>(user);
        
        <span class="hljs-comment">// 强制从主库读取（避免同步延迟）</span>
        DataSourceContextHolder<span class="hljs-selector-class">.setDataSourceType</span>(DataSourceType.MASTER);
        try {
            return userRepository<span class="hljs-selector-class">.findById</span>(savedUser.getId())<span class="hljs-selector-class">.orElse</span>(null);
        } finally {
            DataSourceContextHolder<span class="hljs-selector-class">.clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h3 data-id="heading-14">2. 事务中的数据处理</h3>
<p>在事务中，所有操作应使用同一数据源。</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalService</span> {
    
    <span class="hljs-comment">/**
     * 事务内强制使用主库
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">complexBusinessOperation</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 方法开始时显式设置主库，确保事务内一致性</span>
        <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-title class_">DataSourceType</span>.<span class="hljs-property">MASTER</span>);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 一系列数据库操作...</span>
            <span class="hljs-comment">// 所有这些操作都在同一事务中，使用同一数据源</span>
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 事务结束后清理</span>
            <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">clearDataSourceType</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-15">📊 方案优缺点分析</h2>

























<table><thead><tr><th>优势</th><th>挑战</th><th>应对策略</th></tr></thead><tbody><tr><td>提升读性能：将读请求分发到从库</td><td>主从同步延迟</td><td>关键业务强制读主库</td></tr><tr><td>提高可用性：主库故障时从库可读</td><td>事务内数据源一致性</td><td>事务中强制使用主库</td></tr><tr><td>减轻主库压力</td><td>复杂SQL路由</td><td>明确的读写操作分离</td></tr></tbody></table>
<h2 data-id="heading-16">💎 总结</h2>
<p>通过以上完整的Spring Boot 3实现方案，你可以成功配置MySQL读写分离。关键在于理解动态数据源路由原理，合理处理主从同步延迟和事务一致性等挑战。这种架构能显著提升系统性能，特别适合读多写少的应用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini CLI 核心命令指南，让工作从从容容游刃有余]]></title>    <link>https://juejin.cn/post/7571281406509711411</link>    <guid>https://juejin.cn/post/7571281406509711411</guid>    <pubDate>2025-11-11T09:27:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509711411" data-draft-id="7571279513246826522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini CLI 核心命令指南，让工作从从容容游刃有余"/> <meta itemprop="keywords" content="程序员,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-11-11T09:27:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini CLI 核心命令指南，让工作从从容容游刃有余
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:27:43.000Z" title="Tue Nov 11 2025 09:27:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>让我看看，谁还没有用上 Gemini CLI？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe596921c2f43609e36f51287920e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458062&amp;x-signature=yQQgn8QmJ6CnzmzgJVVXWln0Ppk%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>免费额度</strong>：个人 Google 账户可享受每分钟 60 次请求的免费额度，足以满足日常开发中的交互需求。</p>
</li>
<li>
<p><strong>强大的模型支持</strong>：由 Gemini 2.5 Pro 模型驱动，拥有高达一百万 token 的上下文窗口，能够处理和理解大型代码库或复杂的文档。</p>
</li>
<li>
<p><strong>内置工具集</strong>：集成了多种实用工具，包括使用 Google 搜索来提供有时效性的回答、执行文件系统操作、运行 shell 命令以及获取网页内容。</p>
</li>
<li>
<p><strong>可扩展性</strong>：支持模型上下文协议（Model Context Protocol, MCP），为开发者创建自定义工具集成提供了可能。</p>
</li>
<li>
<p><strong>终端优先设计</strong>：完全为那些以命令行作为主要工作环境的开发者量身打造。</p>
</li>
<li>
<p><strong>开源许可</strong>：项目基于 Apache 2.0 许可证开源，保证了其透明度和社区参与度。</p>
</li>
</ul>
<p>Gemini CLI 部署起来也很容易，用 ServBay 一键安装好 Node.js 20或者更高的版本，直接通过<code>npm</code>就可以安装Gemini CLI。</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @google/gemini-cli
</code></pre>
<p>之所以推荐 ServBay ，是因为它提供了一个隔离的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fnodejs" target="_blank" title="https://www.servbay.com/features/nodejs" ref="nofollow noopener noreferrer">集成开发环境</a>，允许开发者通过图形化界面一键部署和管理包括 Node.js、Rust 在内的多种服务。这种方式避免了使用版本管理器（如 nvm）在系统全局范围内频繁切换的复杂性，也杜绝了传统包管理器（如 Homebrew）可能带来的依赖混乱，干净又卫生。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6d3171396dd42e88a1fb945dc7a8b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458062&amp;x-signature=nDvT%2F6aoMXp7lMG234hEFhWJbDs%3D" alt="" loading="lazy"/></p>
<p>安装完毕，便可以开始探索 Gemini CLI 的功能。</p>
<h3 data-id="heading-0">初始配置：建立与项目的连接</h3>
<p>首次在项目中使用 Gemini CLI，需要执行几个基础命令来完成初始化和配置。</p>
<ul>
<li>
<p><strong>/init：</strong> 在项目根目录执行此命令，是与 Gemini CLI 建立联系的第一步。它会分析项目结构，为后续的交互提供上下文基础。</p>
</li>
<li>
<p><strong>/auth：</strong> 此命令用于处理身份验证。首次执行时，它会引导用户完成 Google 账户的登录与授权流程，确保 CLI 拥有访问 AI 服务的权限。</p>
</li>
<li>
<p><strong>/about：</strong> 查询当前 Gemini CLI 的版本、所使用的底层模型以及配置的身份验证方法。这个命令有助于了解工具的当前状态。</p>
</li>
<li>
<p><strong>/help</strong> &amp; <strong>/docs：</strong> 遇到疑问时，<code>/help</code> 提供了一个快速的命令列表。而 <code>/docs</code> 则会在浏览器中打开官方文档，供查阅更详尽的信息。</p>
</li>
</ul>
<h3 data-id="heading-1">核心功能：日常工作流中的命令</h3>
<p>熟悉基本配置后，以下这些命令将成为日常开发中的得力工具。</p>
<ul>
<li>
<p><strong>! (Shell 命令前缀)</strong> ：这是一个极为实用的功能。在输入框中以 <code>!</code> 开头，可以直接执行 shell 命令。更进一步，可以结合自然语言让 Gemini 解释或生成命令，这对于处理那些复杂或不常用的命令尤为有效。</p>
</li>
<li>
<p><strong>/tools：</strong> 执行此命令可以列出 Gemini 当前可用的所有工具集。了解其能力边界，有助于提出更精准、更有效的问题。</p>
</li>
<li>
<p><strong>/editor</strong>：对于需要输入大段代码或复杂问题的场景，终端的单行输入框显得捉襟见肘。通过 <code>/editor</code> 命令配置一个外部文本编辑器（如 VS Code 或 Vim），之后使用 <code>Ctrl+X</code> 快捷键即可在熟悉的环境中编写提示，完成后保存退出，内容便会自动发送。</p>
</li>
</ul>
<h3 data-id="heading-2">会话管理：保存与追溯思路</h3>
<p>与 Gemini 的交互是一个连续的对话过程，保留这些上下文对于解决复杂问题非常有价值。</p>
<ul>
<li>
<p><strong>/chat</strong>：这是一个功能强大的会话管理命令。使用 <code>/chat save &lt;name&gt;</code> 可以将当前的对话保存下来，以便日后通过 <code>/chat resume &lt;name&gt;</code> 继续。它还支持 <code>list</code> 和 <code>delete</code> 等操作来管理所有已保存的会话。</p>
</li>
<li>
<p><strong>/clear</strong>：当需要开始一个全新的话题时，此命令可以清空当前的对话历史和屏幕，提供一个干净的交互界面。</p>
</li>
</ul>
<h3 data-id="heading-3">实际应用场景</h3>
<p>下面通过几个具体的例子，展示 Gemini CLI 在实际工作中的应用。</p>
<h4 data-id="heading-4"><strong>代码重构建议</strong></h4>
<p>假设有一个用于数据验证的函数，其逻辑虽然正确但不够简洁。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// file: validation.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkUserAccess</span>(<span class="hljs-params">userObject</span>) {
  <span class="hljs-keyword">if</span> (userObject &amp;&amp; userObject.<span class="hljs-property">isActive</span> &amp;&amp; userObject.<span class="hljs-property">permissions</span>.<span class="hljs-property">level</span> &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>可以向 Gemini CLI 提出请求：</p>
<p><code>@validation.js Please refactor the checkUserAccess function to be more concise.</code></p>
<p>Gemini 可能会返回一个更精炼的版本：</p>
<pre><code class="hljs language-ini" lang="ini">// Suggested refactoring
const <span class="hljs-attr">checkUserAccess</span> = (userObject) =&gt;
  !!userObject &amp;&amp; userObject.isActive &amp;&amp; userObject.permissions.level &gt; 1<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-5"><strong>生成 Git 提交信息</strong></h4>
<p>编写规范的 Git commit message 是一项耗时的任务。可以借助 Gemini CLI 自动化这个过程。首先，查看暂存区的代码变更：</p>
<p><code>!git diff --staged</code></p>
<p>然后，基于这些变更请求生成提交信息：</p>
<p><code>From the diff above, write a Conventional Commit message.</code></p>
<p>这将产出一条格式良好、内容准确的提交信息，大大节省了思考和撰写的时间。</p>
<h4 data-id="heading-6"><strong>解释复杂的 Shell 命令</strong></h4>
<p>当遇到一段从网络上复制的、不甚明了的 shell 命令时，直接运行存在风险。可以让 Gemini 先行解释。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">&gt; Explain <span class="hljs-keyword">this</span> command: awk -F<span class="hljs-string">','</span> <span class="hljs-string">'{print $1, $3}'</span> <span class="hljs-keyword">data</span>.csv
</code></pre>
<p>Gemini 会提供一个清晰的逐段解释：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">✦ Certainly. This command uses `awk` <span class="hljs-keyword">to</span> process a CSV file. Here <span class="hljs-built_in">is</span> a breakdown:

  * `awk`: This <span class="hljs-built_in">is</span> the command-line utility being invoked, designed <span class="hljs-keyword">for</span> <span class="hljs-keyword">text</span> processing.
  * `-F<span class="hljs-comment">','`: The `-F` option sets the field separator. Here, it's set to a comma (`,`), which means `awk` will treat each line as a series of comma-separated fields.</span>
  * `<span class="hljs-comment">'{print $1, $3}'`: This is the action `awk` will perform on each line of the input. It instructs `awk` to print the first field (`$1`) followed by a space, and then the third field (`$3`).</span>
  * `data.csv`: This <span class="hljs-built_in">is</span> the input file <span class="hljs-keyword">for</span> the command.

  <span class="hljs-keyword">In</span> summary, the command reads the `data.csv` file, splits <span class="hljs-keyword">each</span> line <span class="hljs-keyword">by</span> commas, <span class="hljs-built_in">and</span> prints the first <span class="hljs-built_in">and</span> third columns <span class="hljs-keyword">from</span> <span class="hljs-keyword">each</span> line <span class="hljs-keyword">to</span> the standard output.
</code></pre>
<h3 data-id="heading-7">结语</h3>
<p>将 Gemini CLI 集成到开发工作流中，让你的开发工作从从容容游刃有余。使用 ServBay 搭建一个可靠的运行环境开始，到熟练运用其核心命令解决编码、代码管理和系统操作中的实际问题，开发者可以获得更流畅、更专注的工作体验。掌握这些工具，你就不会匆匆忙忙连滚带爬。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则]]></title>    <link>https://juejin.cn/post/7571299394345680938</link>    <guid>https://juejin.cn/post/7571299394345680938</guid>    <pubDate>2025-11-11T13:41:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345680938" data-draft-id="7571306072422809642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T13:41:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了AOP切面，还有哪些更灵活的数据源切换策略？比如基于注解或自定义路由规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:41:13.000Z" title="Tue Nov 11 2025 13:41:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring Boot中实现数据源切换，除了AOP切面，还有几种非常灵活的策略。下面我用一个表格对比各种方案，然后重点介绍两种最实用的方法：</p>








































<table><thead><tr><th>策略类型</th><th>实现方式</th><th>灵活性</th><th>代码侵入性</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>注解驱动</strong></td><td>使用<code>@DS</code>等注解标记方法/类</td><td>高</td><td>低</td><td>精确到方法级别的数据源控制</td></tr><tr><td><strong>手动编程</strong></td><td>在代码中调用API动态切换</td><td>最高</td><td>高</td><td>复杂业务逻辑、同一方法内多数据源</td></tr><tr><td><strong>请求特征路由</strong></td><td>基于HTTP头、参数等自动路由</td><td>中高</td><td>低</td><td>多租户、按客户分库等场景</td></tr><tr><td><strong>方法规则路由</strong></td><td>基于方法名约定自动切换</td><td>中</td><td>低</td><td>有固定命名规范的读写分离</td></tr></tbody></table>
<h2 data-id="heading-0">🔁 注解驱动切换</h2>
<p>这是目前<strong>最流行且优雅</strong>的方案，MyBatis-Plus的动态数据源组件提供了开箱即用的支持。</p>
<h3 data-id="heading-1">配置依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
-   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">配置文件</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>    <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/master</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master_password</span>
        <span class="hljs-attr">slave:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/slave</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave_password</span>
</code></pre>
<h3 data-id="heading-3">使用@DS注解</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">// 默认使用主库（写操作）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
    
    <span class="hljs-comment">// 显式指定从库（读操作）</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectById</span>(id);
    }
    
    <span class="hljs-comment">// 在Mapper层直接指定数据源</span>
    <span class="hljs-meta">@DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">User</span>&gt; <span class="hljs-title function_">findActiveUsers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">selectActiveUsers</span>();
    }
}
</code></pre>
<p><strong>优点</strong>：声明式配置，代码侵入性低，支持类级别和方法级别的精细控制。</p>
<h2 data-id="heading-4">⚙️ 手动编程切换</h2>
<p>对于需要<strong>在同一方法内使用多个数据源</strong>的复杂场景，手动控制提供了最大灵活性。</p>
<h3 data-id="heading-5">基本API使用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 第一阶段：从主库读取订单</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"master"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
            <span class="hljs-comment">// 业务处理...</span>
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
        
        <span class="hljs-comment">// 第二阶段：写入从库进行数据分析</span>
        DynamicDataSourceContextHolder.push(<span class="hljs-string">"slave"</span>);
        <span class="hljs-keyword">try</span> {
            analysisMapper.insertOrderAnalysis(order);
        } <span class="hljs-keyword">finally</span> {
            DynamicDataSourceContextHolder.poll();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">基于HTTP请求的自动切换</h3>
<p>通过过滤器或拦截器实现基于请求特征的路由：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@WebFilter</span>(urlPatterns = <span class="hljs-string">"/*"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">doFilter</span>(<span class="hljs-title class_">ServletRequest</span> request, <span class="hljs-title class_">ServletResponse</span> response, 
                         <span class="hljs-title class_">FilterChain</span> chain) throws <span class="hljs-title class_">IOException</span>, <span class="hljs-title class_">ServletException</span> {
        <span class="hljs-title class_">HttpServletRequest</span> httpRequest = (<span class="hljs-title class_">HttpServletRequest</span>) request;
        
        <span class="hljs-comment">// 从请求头获取数据源标识（如多租户场景）</span>
        <span class="hljs-title class_">String</span> tenantId = httpRequest.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"X-Tenant-Id"</span>);
        <span class="hljs-comment">// 或从请求参数判断业务类型</span>
        <span class="hljs-title class_">String</span> businessType = httpRequest.<span class="hljs-title function_">getParameter</span>(<span class="hljs-string">"bizType"</span>);
        
        <span class="hljs-title class_">String</span> dataSourceKey = <span class="hljs-title function_">determineDataSource</span>(tenantId, businessType);
        
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">push</span>(dataSourceKey);
        <span class="hljs-keyword">try</span> {
            chain.<span class="hljs-title function_">doFilter</span>(request, response);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">poll</span>();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">determineDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> tenantId, <span class="hljs-built_in">String</span> businessType</span>) {
        <span class="hljs-comment">// 复杂的路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.<span class="hljs-title function_">equals</span>(businessType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"report_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tenantId != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"tenant_"</span> + tenantId;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 默认数据源</span>
    }
}
</code></pre>
<h2 data-id="heading-7">🧠 自定义路由规则</h2>
<p>通过继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey()</code>方法，可以实现基于<strong>业务逻辑的复杂路由</strong>。</p>
<h3 data-id="heading-8">基于方法名的路由示例</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 获取当前方法名进行路由决策</span>
        <span class="hljs-type">String</span> methodName = getCurrentMethodName();
        
        <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"find"</span>) || methodName.startsWith(<span class="hljs-string">"query"</span>) 
            || methodName.startsWith(<span class="hljs-string">"select"</span>) || methodName.startsWith(<span class="hljs-string">"get"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"slave"</span>; <span class="hljs-comment">// 读操作路由到从库</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">"insert"</span>) || methodName.startsWith(<span class="hljs-string">"update"</span>) 
                 || methodName.startsWith(<span class="hljs-string">"delete"</span>) || methodName.startsWith(<span class="hljs-string">"save"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"master"</span>; <span class="hljs-comment">// 写操作路由到主库</span>
        }
        
        <span class="hljs-comment">// 默认路由策略</span>
        <span class="hljs-keyword">return</span> isReadOperation(methodName) ? <span class="hljs-string">"slave"</span> : <span class="hljs-string">"master"</span>;
    }
}
</code></pre>
<h3 data-id="heading-9">基于参数值的路由</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParameterBasedRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 从线程上下文或参数中获取路由信息</span>
        <span class="hljs-type">String</span> businessUnit = <span class="hljs-type">RequestContextHolder</span>.getBusinessUnit();
        <span class="hljs-type">String</span> dataType = <span class="hljs-type">RequestContextHolder</span>.getDataType();
        
        <span class="hljs-comment">// 组合路由逻辑</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"finance"</span>.equals(businessUnit) &amp;&amp; <span class="hljs-string">"sensitive"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"finance_secure_db"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"report"</span>.equals(dataType)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"reporting_db"</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"default_db"</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">⚠️ 实战注意事项</h2>
<ol>
<li><strong>事务管理</strong>：在手动切换数据源时，确保<strong>同一个事务内使用同一数据源</strong>，避免跨数据源事务导致的数据不一致问题。</li>
<li><strong>资源清理</strong>：使用<code>try-finally</code>确保每次数据源切换后都能正确清理上下文，防止<strong>内存泄漏</strong>和<strong>数据源污染</strong>。</li>
<li><strong>性能考量</strong>：频繁的数据源切换会带来性能开销，在高性能场景下应考虑<strong>批量操作</strong>或<strong>连接复用</strong>。</li>
<li><strong>降级策略</strong>：始终配置合理的<strong>主从延迟处理</strong>和<strong>故障降级</strong>机制，确保主库不可用时系统的可用性。</li>
</ol>
<h2 data-id="heading-11">💎 总结</h2>
<p>选择合适的数据源切换策略需要权衡灵活性和复杂性。对于大多数场景，<strong>注解驱动方案</strong>提供了最佳实践；对于复杂业务逻辑，<strong>手动编程控制</strong>不可或缺；而对于有固定路由规则的场景，<strong>自定义路由策略</strong>能够提供最优雅的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习]]></title>    <link>https://juejin.cn/post/7571285984088686644</link>    <guid>https://juejin.cn/post/7571285984088686644</guid>    <pubDate>2025-11-11T09:36:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088686644" data-draft-id="7571176484514447375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-11T09:36:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAI Physical AI Notebook详解2：基于Cosmos世界模型的操作动作数据扩增与模仿学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:36:14.000Z" title="Tue Nov 11 2025 09:36:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上期Notebook详解系列中，我们介绍了《基于Isaac仿真的操作动作数据扩增与模仿学习》，本期我们将介绍一套类似的方案，同样可以完成人工演示、数据扩增、模仿学习、模型测评这几个环节，但完全使用Cosmos世界模型作为内核。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f474261b28e74a3c827534205e6e9993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=IqQCAUAZekvwtGmLdPIWEj9%2BgNI%3D" alt="image.png" loading="lazy"/></p>
<p>相比基于Isaac仿真的方案，使用Cosmos世界模型的方案具有以下特点：</p>
<ul>
<li>人工演示、数据扩增环节无需仿真算力（RT Core），全流程使用AI算力（CUDA Core/Tensor Core）</li>
<li>无需对人工演示数据进行动作打标处理，直接使用视频数据即可实现扩增</li>
<li>无需单独的数据增强环节，可在数据扩增环节通过调整提示词实现数据增强</li>
<li>需要额外的拒绝采样步骤以过滤不合理的生成内容，以及额外的IDM逆解算步骤以补齐视频中缺少的action序列</li>
</ul>
<p>在PAI的Notebook Gallery中，我们已经预置了一个最佳实践，就是这个过程的一个具体示例：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.pai-ml.com%2F%23%2Fpreview%2FdeepLearning%2Fcv%2Fisaac_gr00t_wf2" target="_blank" title="https://gallery.pai-ml.com/#/preview/deepLearning/cv/isaac_gr00t_wf2" ref="nofollow noopener noreferrer">gallery.pai-ml.com/#/preview/d…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ee023d780a04e15982cd2ac7d8aa47f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=ATG%2B1iVhlKgK7KOSPf5VBw7DjCM%3D" alt="image.png" loading="lazy"/></p>
<p>下面我们来详细解读这个示例。</p>
<h2 data-id="heading-0">人工少量演示</h2>
<p>与基于仿真的数据扩增相同，人工演示可以在真实空间或仿真空间中进行，但无需进行动作打标，仅需录制视频即可
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FrO6y913mSC_E0Y1aGBnsF0FGjfTgkyCmulBHQ39j4lk.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/rO6y913mSC_E0Y1aGBnsF0FGjfTgkyCmulBHQ39j4lk.mp4" ref="nofollow noopener noreferrer">查看演示 &gt;&gt;</a></p>
<p>在视频中，左上角的操控者远程控制机器人本体，对蔬菜进行了“Pick and Place”的动作。同时，由操控者对视频内容进行文字描述，例如：</p>
<blockquote>
<p>Use the right hand to pick up green bok choy from tan table right side to bottom level of wire basket.</p>
</blockquote>
<p>采集类似的视频数据，直至满足Cosmos-Predict模型微调的要求（本样例中为100条）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f99326a209b410b92672b8fe49af307~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=4zxkvBNFgeZpXpq0fymXsvz2Fms%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">数据扩增</h2>
<p>利用Cosmos世界模型进行数据扩增，首先要使用人工演示数据对Cosmos-Predict模型进行微调。本例中使用Cosmos-Predict2-2B-Video2World模型，在4*GU8T机型中进行微调：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span> -m scripts.train --config=cosmos_predict2/configs/base/config.py -- experiment=predict2_video2world_training_2b_groot_gr1_480
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845a0b8c341e4c79ac7dd366aa02417a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=gvoPzDFiNP4PtAcwKmZbe1%2BoDEg%3D" alt="image.png" loading="lazy"/></p>
<p>对于更大的世界模型，例如Cosmos-Predict2-14B-Video2World，可以在DLC中，使用4节点 × 8*GU8T的机型中进行微调：</p>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">from</span> alibabacloud_tea_openapi.models <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> alibabacloud_credentials.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> CredClient
<span class="hljs-keyword">from</span> alibabacloud_credentials.models <span class="hljs-keyword">import</span> Config <span class="hljs-keyword">as</span> CredConfig
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> DLCClient
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.models <span class="hljs-keyword">import</span> (
    CreateJobRequest,
    GetJobRequest,
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">wait_for_job_to_terminate</span>(<span class="hljs-params">client, job_id</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        job = client.get_job(job_id, GetJobRequest()).body
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'job({}) is {}'</span>.<span class="hljs-built_in">format</span>(job_id, job.status))
        <span class="hljs-keyword">if</span> job.status <span class="hljs-keyword">in</span> (<span class="hljs-string">'Succeeded'</span>, <span class="hljs-string">'Failed'</span>, <span class="hljs-string">'Stopped'</span>):
            <span class="hljs-keyword">return</span> job.status
        time.sleep(<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    current_time_tuple = time.localtime()
    year = current_time_tuple.tm_year
    month = current_time_tuple.tm_mon
    day = current_time_tuple.tm_mday
    hour = current_time_tuple.tm_hour
    minute = current_time_tuple.tm_min
    <span class="hljs-comment"># 请确认您的主账号已授权DLC，且拥有足够的权限。</span>
    display_name = <span class="hljs-string">f"train_cosmos-predict2_14b_<span class="hljs-subst">{day}</span>_<span class="hljs-subst">{hour}</span>-<span class="hljs-subst">{minute}</span>"</span>  <span class="hljs-comment">#设置任务名称 </span>
    region_id = os.environ.get(<span class="hljs-string">"dsw_region"</span>) <span class="hljs-comment">#设置regionid</span>
    workspace_id = os.environ.get(<span class="hljs-string">'PAI_WORKSPACE_ID'</span>) <span class="hljs-comment">#设置成用户自己的工作空间id</span>
    image_uri = <span class="hljs-string">f"dsw-registry.<span class="hljs-subst">{region_id}</span>.cr.aliyuncs.com/pai-training-algorithm/isaac-sim:gr00t-dreams-v9"</span> <span class="hljs-comment">#使用官方镜像</span>
    ecs_spec = <span class="hljs-string">"ecs.gn8v-8x.16xlarge"</span>
    num_gpus = <span class="hljs-number">8</span> <span class="hljs-comment"># 与资源规格保持一致</span>
    num_nodes = <span class="hljs-number">4</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>
    config = <span class="hljs-string">"cosmos_predict2/configs/base/config.py"</span>
    exp = <span class="hljs-string">"predict2_video2world_training_14b_groot_gr1_480"</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>

    <span class="hljs-comment"># 本示例通过Credentials SDK默认从环境变量中读取AccessKey，来实现身份验证。</span>
    credentialsConfig = CredConfig(
        <span class="hljs-built_in">type</span>=<span class="hljs-string">'credentials_uri'</span>   <span class="hljs-comment"># 选填。若您未配置其他“默认凭据链”访问方式，您无需再显式指定，Credentials SDK会通过uri方式获取临时凭证</span>
    )
    cred = CredClient(credentialsConfig)

    <span class="hljs-comment"># 1. create client;</span>
    dlc_client = DLCClient(
         config=Config(
            credential=cred,
            region_id=region_id,
            endpoint=<span class="hljs-string">'pai-dlc.{}.aliyuncs.com'</span>.<span class="hljs-built_in">format</span>(region_id),
         )
    )
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'-------- Create Job ----------'</span>)
    <span class="hljs-comment"># 创建DLC作业。</span>
    create_job_resp = dlc_client.create_job(CreateJobRequest().from_map({
        <span class="hljs-string">'WorkspaceId'</span>: workspace_id,
        <span class="hljs-string">'DisplayName'</span>: display_name,
        <span class="hljs-string">'JobType'</span>: <span class="hljs-string">'PyTorchJob'</span>,
        <span class="hljs-comment"># 'ResourceId': resource_quota_id,</span>
        <span class="hljs-string">'JobSpecs'</span>: [
            {
                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Worker"</span>,
                <span class="hljs-string">"Image"</span>: image_uri,
                <span class="hljs-string">"PodCount"</span>: num_nodes,
                <span class="hljs-string">"EcsSpec"</span>: ecs_spec,
            },
        ],
        <span class="hljs-string">'DataSources'</span>: [
            {
                <span class="hljs-string">"DataSourceId"</span>: dataset_id,
            },
        ],
       <span class="hljs-string">'UserVpc'</span>: {
            <span class="hljs-string">"VpcId"</span>: vpc_id,  <span class="hljs-comment"># 替换为实际 VPC ID</span>
            <span class="hljs-string">"SwitchId"</span>: switch_id,  <span class="hljs-comment"># 替换为实际交换机 ID</span>
            <span class="hljs-string">"SecurityGroupId"</span>: security_groupid  <span class="hljs-comment"># 替换为实际安全组 ID</span>
        },
        <span class="hljs-string">"UserCommand"</span>: <span class="hljs-string">f" export NVTE_FUSED_ATTN=0 &amp;&amp; \
            rm -rf /workspace/cosmos-predict2/checkpoints &amp;&amp; \
            rm -rf /workspace/cosmos-predict2/datasets/benchmark_train/gr1 &amp;&amp; \
            ln -s /mnt/data/notebook2/checkpoints /workspace/cosmos-predict2/checkpoints &amp;&amp; \
            ln -s /mnt/data/notebook2/gr1 /workspace/cosmos-predict2/datasets/benchmark_train/gr1 &amp;&amp; \
            cd /workspace/cosmos-predict2 &amp;&amp; \
            torchrun --nproc_per_node=<span class="hljs-subst">{num_gpus}</span> --nnodes=<span class="hljs-subst">{num_nodes}</span> --rdzv_id 123 --rdzv_backend c10d --rdzv_endpoint $MASTER_ADDR:1234 -m \
            scripts.train --config=<span class="hljs-subst">{config}</span> \
            -- experiment=<span class="hljs-subst">{exp}</span> \
            model.config.fsdp_shard_size=0"</span>
    }))
    job_id = create_job_resp.body.job_id

    wait_for_job_to_terminate(dlc_client, job_id)

    <span class="hljs-keyword">pass</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()

</code></pre>
<p>完成微调后，即可使用微调后的模型进行推理：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span> -m examples.video2world_gr00t \
--num_gpus <span class="hljs-number">4</span>   --model_size 14B   --gr00t_variant gr1   \
--batch_input_json dream_gen_benchmark/gr1_object/batch_input.json   --disable_guardrail
</code></pre>
<p>在上述代码中，使用batch_input.json来记录推理所需的prompts与起始帧：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/675f8ea1bbb543dc9294c80bda78eea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=qtV9CMXiLHUpTrMQgQdTdAo8TGU%3D" alt="image.png" loading="lazy"/></p>
<p>执行上述推理过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04048b76c47f4d1682b25fcf3053193f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=fDb5ygam614P3j4LIK3HVs3vPio%3D" alt="image.png" loading="lazy"/></p>
<p>按照batch_input.json，脚本会输出一系列推理结果，实现数据扩增。扩增的数量取决于batch_input.json的prompt数量。以下是输出结果示例,<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FJquGeKxcghzoa16tlkGc97cp9bbbwu9Rc_KRtPp6v2Q.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/JquGeKxcghzoa16tlkGc97cp9bbbwu9Rc_KRtPp6v2Q.mp4" ref="nofollow noopener noreferrer">查看演示 &gt;&gt;</a></p>
<p>从上述结果中可以看出，右上角的水壶出现了明显的变形，不符合真实物理规律。在实际生产中，我们需要剔除这类视频，因此需要使用Cosmos-Reason1模型进行拒绝采样。</p>
<h2 data-id="heading-2">拒绝采样</h2>
<p>拒绝采样的原理是：生成多个候选视频，然后使用Cosmos-Reason1对这些视频进行评分，选择评分最高的视频作为最终输出。评分将从以下几个方面进行考量：</p>
<ul>
<li>运动连贯性: 物体移动是否自然流畅</li>
<li>时间一致性: 帧与帧之间是否存在突兀变化</li>
<li>物理合理性: 重力、光影、材质是否符合物理规律</li>
<li>视觉质量: 是否存在伪影、模糊、扭曲等问题</li>
<li>内容逻辑: 场景元素之间的关系是否合理</li>
</ul>
<p>可以使用以下脚本进行拒绝采样：</p>
<pre><code class="hljs language-python" lang="python">!torchrun --nproc_per_node=<span class="hljs-number">4</span> --master_port=<span class="hljs-number">12341</span>   -m examples.video2world_bestofn   \
--model_size 14B   --gr00t_variant gr1   \
--prompt <span class="hljs-string">"Use the right hand to pick up rubik's cube from from the bottom of the three-tiered wooden shelf to to the top of the three-tiered wooden shelf."</span>   \
--input_path assets/sample_gr00t_dreams_gr1/8_Use_the_right_hand_to_pick_up_rubik\<span class="hljs-string">'s_cube_from_from_the_bottom_of_the_three-tiered_wooden_shelf_to_to_the_top_of_the_three-tiered_wooden_shelf..png   \
--num_gpus 2   --num_generations 4   --prompt_prefix ""   \
--disable_guardrail   --save_path output/best-of-n-gr00t-gr1
</span></code></pre>
<p>该脚本会使用相同的prompt生成4条视频，然后通过Cosmos-Reason1进行打分，以下分别是0分和100分的视频，以示对比：</p>

















<table><thead><tr><th>0分</th><th>100分</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FbLbanLWVx_S3xeTnZuDeKANYJBSNIhAUMVtPXKNU284.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/bLbanLWVx_S3xeTnZuDeKANYJBSNIhAUMVtPXKNU284.mp4" ref="nofollow noopener noreferrer">0分视频演示 &gt;&gt;</a></td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FP8TaehO-WgL-ocS05rNjRnCzsHCV9YfcMV3A0FDmh-4.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/P8TaehO-WgL-ocS05rNjRnCzsHCV9YfcMV3A0FDmh-4.mp4" ref="nofollow noopener noreferrer">100分视频演示 &gt;&gt;</a></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77152b3349ca4a628df49c16d6ede171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=z7SHavZPcAB0vDn0XfKzcFubATk%3D" alt="image.png" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b53a025a4aa4d43b19591ebcf01dd4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=W3JUkR3cCVUSQrOpQJXV3SXKn2w%3D" alt="image.png" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-3">IDM逆解算</h2>
<p>上述数据扩增和拒绝采样的结果，为一系列的“prompt-视频”数据对。一般来说，如果用于VLA模型的模仿学习，仅有这样的数据对是不够的，还需给出视频内容中的action序列。但由于Cosmos-Predict2模型直接输出了视频，没有action序列，我们需要通过IDM（Inverse Dynamics Model，逆向动力学模型）对视频进行处理，逆向解析出其中的action序列。</p>
<p>可以使用以下脚本进行IDM逆解算：</p>
<pre><code class="hljs language-python" lang="python">!PYTHONPATH=. CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span> python IDM_dump/dump_idm_actions.py \
    --checkpoint <span class="hljs-string">"seonghyeonye/IDM_gr1"</span> \
    --dataset <span class="hljs-string">"IDM_dump/data/gr1_unified.data"</span> \
    --output_dir <span class="hljs-string">"IDM_dump/data/gr1_unified.data_idm"</span> \
    --num_gpus <span class="hljs-number">4</span> \
    --video_indices <span class="hljs-string">"0 8"</span>
</code></pre>
<p>由于需要使用huggingface获取IDM模型，在国内的网络环境中，执行上述命令可能出现网络问题，可以使用以下环境变量进行代理加速：</p>
<pre><code class="hljs language-python" lang="python">HF_ENDPOINT=https://hf-mirror.com 
</code></pre>
<p>逆解算结果以parquet格式保存，可以通过以下命令查看：</p>
<pre><code class="hljs language-python" lang="python">!uv pip install parquet-tools
!parquet-tools csv IDM_dump/data/gr1_unified.data_idm/data/chunk-<span class="hljs-number">000</span>/episode_000000.parquet
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff9f33f769b742e78ce70cd6e0ab3d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=dxT5%2Fu6kECSl3IHg25kJUor9B5E%3D" alt="image.png" loading="lazy"/></p>
<p>如果需要使用自定义机器人本体构型，也可以自定义微调IDM模型：</p>
<pre><code class="hljs language-python" lang="python">cd /workspace/GR00T-Dreams/
export HF_HOME=/mnt/data/notebook2
PYTHONPATH=. WANDB_MODE=disabled CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span> torchrun scripts/idm_training.py \
    --dataset-path demo_data/robot_sim.PickNPlace/ \
    --embodiment_tag gr1
</code></pre>
<h2 data-id="heading-4">模仿学习</h2>
<p>使用上述过程得到的扩增数据，可以用与GR00T-N1模型的模仿学习：</p>
<pre><code class="hljs language-python" lang="python">!cd /workspace/GR00T-Dreams/
!export HF_HOME=/mnt/data/notebook2 &amp;&amp; export WANDB_MODE=offline &amp;&amp; \
bash IDM_dump/scripts/finetune/gr1.sh
</code></pre>
<p>详细训练脚本gr1.sh如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> tyro
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments

<span class="hljs-keyword">from</span> gr00t.data.dataset <span class="hljs-keyword">import</span> LeRobotSingleDataset
<span class="hljs-keyword">from</span> gr00t.data.schema <span class="hljs-keyword">import</span> EmbodimentTag
<span class="hljs-keyword">from</span> gr00t.experiment.data_config <span class="hljs-keyword">import</span> DATA_CONFIG_MAP
<span class="hljs-keyword">from</span> gr00t.experiment.runner <span class="hljs-keyword">import</span> TrainRunner
<span class="hljs-keyword">from</span> gr00t.model.gr00t_n1 <span class="hljs-keyword">import</span> GR00T_N1
<span class="hljs-keyword">from</span> gr00t.utils.peft <span class="hljs-keyword">import</span> get_lora_model


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
    <span class="hljs-string">"""Configuration for GR00T model fine-tuning."""</span>

    <span class="hljs-comment"># Dataset parameters</span>
    dataset_path: <span class="hljs-built_in">str</span>
    <span class="hljs-string">"""Path to the dataset directory."""</span>

    output_dir: <span class="hljs-built_in">str</span> = <span class="hljs-string">"/tmp/gr00t"</span>
    <span class="hljs-string">"""Directory to save model checkpoints."""</span>

    data_config: <span class="hljs-built_in">str</span> = <span class="hljs-string">"gr1_arms_only"</span>
    <span class="hljs-string">"""Data configuration name from DATA_CONFIG_MAP."""</span>

    <span class="hljs-comment"># Training parameters</span>
    batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">16</span>
    <span class="hljs-string">"""Batch size per GPU for training."""</span>

    max_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">10000</span>
    <span class="hljs-string">"""Maximum number of training steps."""</span>

    num_gpus: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>
    <span class="hljs-string">"""Number of GPUs to use for training."""</span>

    save_steps: <span class="hljs-built_in">int</span> = <span class="hljs-number">500</span>
    <span class="hljs-string">"""Number of steps between saving checkpoints."""</span>

    <span class="hljs-comment"># Model parameters</span>
    base_model_path: <span class="hljs-built_in">str</span> = <span class="hljs-string">"nvidia/GR00T-N1-2B"</span>
    <span class="hljs-string">"""Path or HuggingFace model ID for the base model."""</span>

    tune_llm: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-string">"""Whether to fine-tune the language model backbone."""</span>

    tune_visual: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the vision tower."""</span>

    tune_projector: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the projector."""</span>

    tune_diffusion_model: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
    <span class="hljs-string">"""Whether to fine-tune the diffusion model."""</span>

    resume: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    <span class="hljs-string">"""Whether to resume from a checkpoint."""</span>

    <span class="hljs-comment"># Advanced training parameters</span>
    learning_rate: <span class="hljs-built_in">float</span> = <span class="hljs-number">1e-4</span>
    <span class="hljs-string">"""Learning rate for training."""</span>

    weight_decay: <span class="hljs-built_in">float</span> = <span class="hljs-number">1e-5</span>
    <span class="hljs-string">"""Weight decay for AdamW optimizer."""</span>

    warmup_ratio: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.05</span>
    <span class="hljs-string">"""Ratio of total training steps used for warmup."""</span>

    lora_rank: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    <span class="hljs-string">"""Rank for the LORA model."""</span>

    lora_alpha: <span class="hljs-built_in">int</span> = <span class="hljs-number">16</span>
    <span class="hljs-string">"""Alpha value for the LORA model."""</span>

    lora_dropout: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.1</span>
    <span class="hljs-string">"""Dropout rate for the LORA model."""</span>

    dataloader_num_workers: <span class="hljs-built_in">int</span> = <span class="hljs-number">8</span>
    <span class="hljs-string">"""Number of workers for data loading."""</span>

    report_to: <span class="hljs-built_in">str</span> = <span class="hljs-string">"wandb"</span>
    <span class="hljs-string">"""Where to report training metrics (e.g., 'wandb', 'tensorboard')."""</span>

    <span class="hljs-comment"># Data loading parameters</span>
    embodiment_tag: <span class="hljs-built_in">str</span> = <span class="hljs-string">"new_embodiment"</span>
    <span class="hljs-string">"""Embodiment tag to use for training. e.g. 'new_embodiment', 'gr1'"""</span>

    video_backend: <span class="hljs-built_in">str</span> = <span class="hljs-string">"decord"</span>
    <span class="hljs-string">"""Video backend to use for training. [decord, torchvision_av]"""</span>


<span class="hljs-comment">#####################################################################################</span>
<span class="hljs-comment"># main training function</span>
<span class="hljs-comment">#####################################################################################</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">config: Config</span>):
    <span class="hljs-string">"""Main training function."""</span>
    <span class="hljs-comment"># ------------ step 1: load dataset ------------</span>
    embodiment_tag = EmbodimentTag(config.embodiment_tag)

    <span class="hljs-comment"># 1.1 modality configs and transforms</span>
    data_config_cls = DATA_CONFIG_MAP[config.data_config]
    modality_configs = data_config_cls.modality_config()
    transforms = data_config_cls.transform()

    <span class="hljs-comment"># 1.2 data loader</span>
    train_dataset = LeRobotSingleDataset(
        dataset_path=config.dataset_path,
        modality_configs=modality_configs,
        transforms=transforms,
        embodiment_tag=embodiment_tag,  <span class="hljs-comment"># This will override the dataset's embodiment tag to "new_embodiment"</span>
        video_backend=config.video_backend,
    )

    <span class="hljs-comment"># ------------ step 2: load model ------------</span>
    model = GR00T_N1.from_pretrained(
        pretrained_model_name_or_path=config.base_model_path,
        tune_llm=config.tune_llm,  <span class="hljs-comment"># backbone's LLM</span>
        tune_visual=config.tune_visual,  <span class="hljs-comment"># backbone's vision tower</span>
        tune_projector=config.tune_projector,  <span class="hljs-comment"># action head's projector</span>
        tune_diffusion_model=config.tune_diffusion_model,  <span class="hljs-comment"># action head's DiT</span>
    )

    <span class="hljs-comment"># Set the model's compute_dtype to bfloat16</span>
    model.compute_dtype = <span class="hljs-string">"bfloat16"</span>
    model.config.compute_dtype = <span class="hljs-string">"bfloat16"</span>

    <span class="hljs-keyword">if</span> config.lora_rank &gt; <span class="hljs-number">0</span>:
        model = get_lora_model(
            model,
            rank=config.lora_rank,
            lora_alpha=config.lora_alpha,
            lora_dropout=config.lora_dropout,
        )

    <span class="hljs-comment"># 2.1 modify training args</span>
    training_args = TrainingArguments(
        output_dir=config.output_dir,
        run_name=<span class="hljs-literal">None</span>,
        remove_unused_columns=<span class="hljs-literal">False</span>,
        deepspeed=<span class="hljs-string">""</span>,
        gradient_checkpointing=<span class="hljs-literal">False</span>,
        bf16=<span class="hljs-literal">True</span>,
        tf32=<span class="hljs-literal">True</span>,
        per_device_train_batch_size=config.batch_size,
        gradient_accumulation_steps=<span class="hljs-number">1</span>,
        dataloader_num_workers=config.dataloader_num_workers,
        dataloader_pin_memory=<span class="hljs-literal">False</span>,
        dataloader_persistent_workers=<span class="hljs-literal">True</span>,
        optim=<span class="hljs-string">"adamw_torch"</span>,
        adam_beta1=<span class="hljs-number">0.95</span>,
        adam_beta2=<span class="hljs-number">0.999</span>,
        adam_epsilon=<span class="hljs-number">1e-8</span>,
        learning_rate=config.learning_rate,
        weight_decay=config.weight_decay,
        warmup_ratio=config.warmup_ratio,
        lr_scheduler_type=<span class="hljs-string">"cosine"</span>,
        logging_steps=<span class="hljs-number">10.0</span>,
        num_train_epochs=<span class="hljs-number">300</span>,
        max_steps=config.max_steps,
        save_strategy=<span class="hljs-string">"steps"</span>,
        save_steps=config.save_steps,
        save_total_limit=<span class="hljs-number">8</span>,
        report_to=config.report_to,
        seed=<span class="hljs-number">42</span>,
        do_eval=<span class="hljs-literal">False</span>,
        ddp_find_unused_parameters=<span class="hljs-literal">False</span>,
        ddp_bucket_cap_mb=<span class="hljs-number">100</span>,
        torch_compile_mode=<span class="hljs-literal">None</span>,
    )

    <span class="hljs-comment"># 2.2 run experiment</span>
    experiment = TrainRunner(
        train_dataset=train_dataset,
        model=model,
        training_args=training_args,
        resume_from_checkpoint=config.resume,
    )

    <span class="hljs-comment"># 2.3 run experiment</span>
    experiment.train()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># Parse arguments using tyro</span>
    config = tyro.cli(Config)

    <span class="hljs-comment"># Print the tyro config</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"GR00T FINE-TUNING CONFIGURATION:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">vars</span>(config).items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span> + <span class="hljs-string">"\n"</span>)

    available_gpus = torch.cuda.device_count() <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>

    <span class="hljs-comment"># Validate GPU configuration</span>
    <span class="hljs-keyword">assert</span> (
        config.num_gpus &lt;= available_gpus
    ), <span class="hljs-string">f"Number of GPUs requested (<span class="hljs-subst">{config.num_gpus}</span>) is greater than the available GPUs (<span class="hljs-subst">{available_gpus}</span>)"</span>
    <span class="hljs-keyword">assert</span> config.num_gpus &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"Number of GPUs must be greater than 0"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Using <span class="hljs-subst">{config.num_gpus}</span> GPUs"</span>)

    <span class="hljs-keyword">if</span> config.num_gpus == <span class="hljs-number">1</span>:
        <span class="hljs-comment"># Single GPU mode - set CUDA_VISIBLE_DEVICES=0</span>
        os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">"0"</span>
        <span class="hljs-comment"># Run the script normally</span>
        main(config)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">if</span> os.environ.get(<span class="hljs-string">"IS_TORCHRUN"</span>, <span class="hljs-string">"0"</span>) == <span class="hljs-string">"1"</span>:
            main(config)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Multi-GPU mode - use torchrun</span>
            script_path = Path(__file__).absolute()
            <span class="hljs-comment"># Remove any existing CUDA_VISIBLE_DEVICES from environment</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span> <span class="hljs-keyword">in</span> os.environ:
                <span class="hljs-keyword">del</span> os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>]

            <span class="hljs-comment"># Use subprocess.run instead of os.system</span>
            cmd = [
                <span class="hljs-string">"torchrun"</span>,
                <span class="hljs-string">"--standalone"</span>,
                <span class="hljs-string">f"--nproc_per_node=<span class="hljs-subst">{config.num_gpus}</span>"</span>,
                <span class="hljs-string">"--nnodes=1"</span>,  <span class="hljs-comment"># default to 1 node for now</span>
                <span class="hljs-built_in">str</span>(script_path),
            ]

            <span class="hljs-comment"># Convert config to command line arguments</span>
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">vars</span>(config).items():
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(value, <span class="hljs-built_in">bool</span>):
                    <span class="hljs-comment"># For boolean values, use --flag or --no-flag format</span>
                    <span class="hljs-keyword">if</span> value:
                        cmd.append(<span class="hljs-string">f"--<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                    <span class="hljs-keyword">else</span>:
                        cmd.append(<span class="hljs-string">f"--no-<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># For non-boolean values, use --key value format</span>
                    cmd.append(<span class="hljs-string">f"--<span class="hljs-subst">{key.replace(<span class="hljs-string">'_'</span>, <span class="hljs-string">'-'</span>)}</span>"</span>)
                    cmd.append(<span class="hljs-built_in">str</span>(value))
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Running torchrun command: "</span>, cmd)
            env = os.environ.copy()
            env[<span class="hljs-string">"IS_TORCHRUN"</span>] = <span class="hljs-string">"1"</span>
            sys.exit(subprocess.run(cmd, env=env).returncode)

</code></pre>
<p>建议在实际训练中，将 batch size 尽可能调大，并训练 20k steps。请在 DreamGen 环境中运行相应命令。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c7d6668bcb147a8b0ab3cb5f3248bb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=chFnH8e4qMu1YQhmL1pn7BWYP9s%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">模型测评</h2>
<p>在本例中，使用真实的GR1机器人进行模型效果验证，得到结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7531acca2fb4feea76627c5dafad9f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458573&amp;x-signature=3PovAunOoaexObe57bjk5qyKklo%3D" alt="image.png" loading="lazy"/></p>
<p>从结果中可以看到：</p>
<ul>
<li>
<p>在已知场景中执行全新的动作，未使用扩增数据微调的GR00T N1模型仅有11.2%的成功率，使用扩增数据微调后可以达到43.2%的成功率</p>
</li>
<li>
<p>在未知场景中执行已知或未知动作，未使用扩增数据微调的GR00T N1模型全部失败，但是使用扩增数据微调后可以达到28.5%的成功率</p>
</li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p>在本最佳实践中，基于阿里云 PAI 平台的特性，我们实现了基于Cosmos世界模型的操作动作数据扩增与模仿学习，包含从人工少量演示、数据扩增、拒绝采样、IDM逆解算、模仿学习再到模型测评的端到端实现</p>
<p>与基于Isaac仿真的数据扩增技术一样，Cosmos 数据扩增后训练的模型在各个场景下的成功率均有较高提升。相比于Isaac仿真，Cosmos数据扩增有以下特点：</p>
<ul>
<li>
<p>人工演示、数据扩增环节无需仿真算力（RT Core），全流程使用同构算力（CUDA Core/Tensor Core）</p>
</li>
<li>
<p>无需对人工演示数据进行动作打标处理，直接使用视频数据即可实现扩增</p>
</li>
<li>
<p>无需单独的数据增强环节，可在数据扩增环节通过调整提示词实现数据增强</p>
</li>
<li>
<p>需要额外的拒绝采样步骤以过滤不合理的生成内容，以及额外的IDM逆解算步骤以补齐视频中缺少的action序列</p>
</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown">!torchrun --nproc<span class="hljs-emphasis">_per_</span>node=4 --master<span class="hljs-emphasis">_port=12341 -m examples.video2world_</span>gr00t \
--num<span class="hljs-emphasis">_gpus 4   --model_</span>size 14B   --gr00t<span class="hljs-emphasis">_variant gr1   \
--batch_</span>input<span class="hljs-emphasis">_json dream_</span>gen<span class="hljs-emphasis">_benchmark/gr1_</span>object/batch<span class="hljs-emphasis">_input.json   
--disable_</span>guardrail
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？]]></title>    <link>https://juejin.cn/post/7571306072422826026</link>    <guid>https://juejin.cn/post/7571306072422826026</guid>    <pubDate>2025-11-11T13:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422826026" data-draft-id="7571299394345697322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在微服务架构下，如何结合Spring Cloud实现动态数据源的路由管理？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:45:03.000Z" title="Tue Nov 11 2025 13:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构下，实现动态数据源路由是应对多租户、分库分表、读写分离等复杂场景的关键技术。它能显著提升系统的灵活性、可扩展性和数据处理能力。下面我将为您详细讲解几种主流的实现方案。</p>
<p>下表对比了三种主要的动态数据源路由方案，帮助您快速了解其核心特点：</p>

































<table><thead><tr><th>方案类型</th><th>核心机制</th><th>适用场景</th><th>优点</th><th>考虑因素</th></tr></thead><tbody><tr><td><strong>基于<code>AbstractRoutingDataSource</code>的自定义路由</strong></td><td>继承Spring抽象类，通过ThreadLocal上下文和AOP/注解动态路由</td><td>多租户（按租户ID分库）、业务分库、需要高度定制化路由逻辑的场景</td><td>灵活性极高，与Spring框架原生集成好，可完全掌控路由逻辑</td><td>需自行实现大部分代码（如AOP、上下文管理），复杂度较高</td></tr><tr><td><strong>基于<code>dynamic-datasource-spring-boot-starter</code>组件</strong></td><td>使用<code>@DS</code>注解在方法或类上声明式切换数据源</td><td>读写分离、一主多从、多种类型数据库混合连接</td><td>开箱即用，配置简单，内置负载均衡，极大减少编码量</td><td>路由逻辑的定制能力不如自定义方案灵活</td></tr><tr><td><strong>集成ShardingSphere进行分库分表</strong></td><td>作为客户端中间件，在JDBC层对SQL进行解析、路由、重写和结果归并</td><td>大规模数据分片、分库分表、读写分离+数据分片等复杂场景</td><td>功能强大，屏蔽底层数据库复杂性，支持分布式事务</td><td>架构较重，学习曲线较陡，对SQL有一定限制（如不支持跨库关联）</td></tr></tbody></table>
<h3 data-id="heading-0">💡 方案一：基于 <code>AbstractRoutingDataSource</code>的自定义路由</h3>
<p>这是Spring框架提供的基础能力，非常适合需要精细控制路由逻辑的场景，例如根据登录用户信息或特定的业务规则来选择数据库。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>定义数据源上下文持有者</strong>：使用<code>ThreadLocal</code>来确保每个线程的数据源选择是隔离的，这是实现动态路由的核心。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-variable constant_">CONTEXT_HOLDER</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setDataSourceType</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceType</span>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">set</span>(dataSourceType);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">get</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearDataSourceType</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable constant_">CONTEXT_HOLDER</span>.<span class="hljs-title function_">remove</span>();
    }
}
</code></pre>
</li>
<li>
<p><strong>创建动态路由数据源</strong>：继承<code>AbstractRoutingDataSource</code>并重写<code>determineCurrentLookupKey</code>方法。</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicRoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractRoutingDataSource</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> determineCurrentLookupKey() {
        <span class="hljs-comment">// 该方法会在每次数据库操作前被调用，决定使用哪个数据源</span>
        <span class="hljs-keyword">return</span> <span class="hljs-type">DataSourceContextHolder</span>.getDataSourceType();
    }
}
</code></pre>
</li>
<li>
<p><strong>配置多个数据源并启用路由</strong>：在配置类中，将多个目标数据源（如<code>masterDataSource</code>, <code>slaveDataSource</code>) 注入到一个Map中，并设置为动态数据源的目标数据源。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class DataSourceConfig {
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@Primary</span>
    public DataSource <span class="hljs-built_in">dynamicDataSource</span>(DataSource masterDataSource, DataSource slaveDataSource) {
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">Object</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">targetDataSources</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"master"</span>, masterDataSource);
        <span class="hljs-selector-tag">targetDataSources</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"slave"</span>, slaveDataSource);

        <span class="hljs-selector-tag">DynamicRoutingDataSource</span> <span class="hljs-selector-tag">routingDataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicRoutingDataSource</span>();
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setDefaultTargetDataSource</span>(masterDataSource); <span class="hljs-comment">// 设置默认数据源</span>
        <span class="hljs-selector-tag">routingDataSource</span><span class="hljs-selector-class">.setTargetDataSources</span>(targetDataSources);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">routingDataSource</span>;
    }
}
</code></pre>
</li>
<li>
<p><strong>使用AOP和自定义注解切换数据源</strong>：可以定义一个注解（如<code>@DataSource</code>），然后通过AOP切面，在方法执行前根据注解值切换数据源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    <span class="hljs-meta">@Before("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.setDataSourceType(dataSource.value());
    }
    <span class="hljs-meta">@After("@annotation(dataSource)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterSwitchDataSource</span><span class="hljs-params">(JoinPoint joinPoint, DataSource dataSource)</span> {
        DataSourceContextHolder.clearDataSourceType(); <span class="hljs-comment">// 清理，防止内存泄漏</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-1">🚀 方案二：使用 <code>dynamic-datasource-spring-boot-starter</code>组件</h3>
<p>对于常见的读写分离、一主多从场景，这是一个非常高效的选择，它能让你通过简单的配置和注解完成工作。</p>
<p><strong>实现步骤</strong></p>
<ol>
<li>
<p><strong>引入依赖</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请使用最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>配置数据源</strong>：在<code>application.yml</code>中配置主从数据源。配置项以下划线<code>_</code>分割，相同前缀的数据源会被自动分组。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span> <span class="hljs-comment"># 设置默认数据源</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip1:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip2:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">slave_2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://ip3:3306/db</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
</code></pre>
</li>
<li>
<p><strong>使用<code>@DS</code>注解切换</strong>：在Service层的方法或类上使用<code>@DS</code>注解，即可轻松切换。组件内置了同组数据源的负载均衡。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
<span class="hljs-variable">@DS</span>(<span class="hljs-string">"slave"</span>) <span class="hljs-comment">// 类级别注解，此类下所有方法默认使用slave组（随机选择slave_1或slave_2）</span>
public class UserServiceImpl implements UserService {
    <span class="hljs-variable">@Override</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>) <span class="hljs-comment">// 方法级别注解优先，此方法使用master数据源</span>
    public void <span class="hljs-built_in">updateUser</span>(User user) {
        <span class="hljs-comment">// ... 更新操作</span>
    }
    <span class="hljs-variable">@Override</span>
    <span class="hljs-comment">// 未标注，使用类注解，即slave组</span>
    public User <span class="hljs-built_in">getUserById</span>(Long id) {
        <span class="hljs-comment">// ... 查询操作</span>
    }
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-2">🔧 方案三：集成 ShardingSphere 进行分库分表</h3>
<p>当单库单表成为性能瓶颈时，ShardingSphere提供了强大的分库分表、读写分离及分布式事务能力。</p>
<p><strong>核心配置示例</strong></p>
<p>其配置核心是定义分片规则，例如根据用户ID（<code>user_id</code>）进行分库分表：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 指定实际的数据节点，表示数据分布在ds0和ds1两个库，每个库有t_user0到t_user3四张表</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user$-&gt;{0..3}</span>
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">database-inline</span>
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">table-inline</span>
        <span class="hljs-comment"># 定义分片算法</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">database-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">ds$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">2</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分库算法：user_id % 2</span>
          <span class="hljs-attr">table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">t_user$-&gt;{user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">4</span><span class="hljs-string">}</span> <span class="hljs-comment"># 分表算法：user_id % 4</span>
</code></pre>
<h3 data-id="heading-3">⚠️ 关键注意事项与实践建议</h3>
<p>无论选择哪种方案，以下几点都需要特别关注：</p>
<ul>
<li><strong>事务管理</strong>：在使用了动态数据源切换的方法中，尤其是跨不同物理数据库的操作，<strong>需要谨慎处理事务</strong>。Spring的<code>@Transactional</code>注解通常在一个事务内会使用同一个数据源连接。如果需要在事务中切换数据源，可能需要更复杂的处理，例如使用分布式事务（JTA）。</li>
<li><strong>连接池配置</strong>：为每个数据源配置合适的连接池参数（如<code>HikariCP</code>或<code>Druid</code>的<code>maximum-pool-size</code>, <code>connection-timeout</code>），这对系统性能和稳定性至关重要。</li>
<li><strong>配置信息加密与安全</strong>：生产环境中，数据库密码等敏感信息不应明文写在配置文件中。可以使用<code>Jasypt</code>等工具进行加密，或结合Spring Cloud Config、Nacos等<strong>配置中心</strong>统一管理加密后的配置。</li>
<li><strong>链路追踪与监控</strong>：在微服务架构下，一个请求可能涉及多个数据源的操作。可以集成<strong>Spring Cloud Sleuth</strong>等组件，将数据源切换的关键信息（如数据源名称）添加到链路追踪的Span标签中，便于问题排查和性能分析。</li>
</ul>
<h3 data-id="heading-4">💎 总结与选择</h3>
<p>选择哪种方案，最终取决于您的具体业务需求和技术考量：</p>
<ul>
<li>如果只是简单的<strong>读写分离</strong>或<strong>一主多从</strong>，追求快速实现，<strong><code>dynamic-datasource-spring-boot-starter</code>组件是首选</strong>。</li>
<li>如果路由逻辑非常<strong>个性化</strong>（如根据复杂业务规则选择数据库），那么基于 <strong><code>AbstractRoutingDataSource</code>的自定义路由</strong>提供了最大的灵活性。</li>
<li>如果面临<strong>海量数据</strong>，需要进行<strong>分库分表</strong>，那么<strong>ShardingSphere</strong>是更专业和强大的选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[动态数据源切换与Seata分布式事务如何协同工作？]]></title>    <link>https://juejin.cn/post/7571304204754698294</link>    <guid>https://juejin.cn/post/7571304204754698294</guid>    <pubDate>2025-11-11T13:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754698294" data-draft-id="7571299394345713706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="动态数据源切换与Seata分布式事务如何协同工作？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            动态数据源切换与Seata分布式事务如何协同工作？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:47:13.000Z" title="Tue Nov 11 2025 13:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构中，动态数据源切换与Seata分布式事务的协同工作，确实是一个既重要又精妙的话题。简单来说，<strong>动态数据源切换解决了“去哪儿操作”的问题，而Seata则确保了在不同“地方”的操作能保持原子性</strong>。下面我们深入探讨它们是如何协同工作的。</p>
<p>为了帮助你快速构建起整体认知，下表概括了协同工作的核心机制与关键点。</p>

























<table><thead><tr><th>协同层面</th><th>核心机制</th><th>关键实现点</th></tr></thead><tbody><tr><td><strong>数据源管理</strong></td><td><strong>代理与路由结合</strong></td><td>Seata通过<code>DataSourceProxy</code>代理底层物理数据源，而动态数据源路由器（如<code>AbstractRoutingDataSource</code>）负责管理多个被代理的数据源，并根据规则选择。</td></tr><tr><td><strong>事务上下文传播</strong></td><td><strong>XID链路传递</strong></td><td>通过拦截器将Seata的全局事务ID（XID）在服务调用链路（如通过Feign）中传递，确保多个数据源操作属于同一全局事务。</td></tr><tr><td><strong>分支事务管理</strong></td><td><strong>RM自动注册</strong></td><td>当业务方法通过动态数据源切换到某个具体数据源并执行SQL时，该数据源对应的Seata <code>Resource Manager</code>(RM) 会自动向事务协调器(TC)注册为一个分支事务。</td></tr></tbody></table>
<h3 data-id="heading-0">⚙️ 协同工作原理详解</h3>
<p>理解了整体框架后，我们来看看它们内部是如何具体配合的。</p>
<ol>
<li>
<p><strong>数据源代理：Seata介入的基石</strong></p>
<p>Seata（通常是AT模式）能够管理一个数据库操作的前提，是它能够“看到”并“记录”这个操作。这是通过<code>DataSourceProxy</code>实现的。它包装了真实的数据源，从而可以拦截所有SQL语句，自动生成回滚日志（<code>undo_log</code>）并与TC交互。在多数据源场景下，<strong>每一个物理数据源（无论是master还是slave）都需要被Seata的<code>DataSourceProxy</code>代理</strong>。</p>
</li>
<li>
<p><strong>动态路由：正确选择的保障</strong></p>
<p>你的业务代码上可能通过<code>@DS("slave")</code>这样的注解，或通过AOP逻辑，在运行时决定使用哪个数据源标识（例如"master", "slave1"）。动态数据源路由器（如继承<code>AbstractRoutingDataSource</code>的自定义类）的<code>determineCurrentLookupKey()</code>方法会返回这个标识，并从目标数据源Map中取出对应的数据源。关键在于，这个Map里存放的<strong>不是原始的<code>DataSource</code>，而是已经被Seata代理后的<code>DataSourceProxy</code></strong>。这样就确保了无论路由到哪个数据源，其操作都能被Seata管理。</p>
</li>
<li>
<p><strong>全局事务：统一协调的框架</strong></p>
<p>在业务入口方法上标注的<code>@GlobalTransactional</code>注解，是全局事务的“开关”。它会告诉Seata的<code>Transaction Manager</code>(TM)开始一个全局事务，并生成全局唯一的XID。这个XID会通过线程上下文传播。</p>
</li>
</ol>
<h3 data-id="heading-1">🔧 实现步骤与配置要点</h3>
<p>要将两者成功集成，以下步骤和配置是关键：</p>
<ol>
<li>
<p><strong>配置Seata TC Server</strong>：需要先启动Seata的服务端（Transaction Coordinator），它负责协调所有全局事务。通常需要配置其注册中心和配置中心（如Nacos、File等）。</p>
</li>
<li>
<p><strong>引入客户端依赖</strong>：在微服务项目中引入Seata的Spring Cloud Starter依赖。</p>
</li>
<li>
<p><strong>配置多数据源与代理</strong>：这是最核心的一步。在你的配置类中，需要创建多个真实数据源，然后分别用<code>DataSourceProxy</code>对它们进行包装，最后将这些代理后的数据源设置到动态数据源的路由目标Map中。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">DataSource</span> <span class="hljs-title function_">dynamicDataSource</span>(<span class="hljs-params">DataSource masterDataSource, DataSource slaveDataSource</span>) {
    <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Object</span>&gt; targetDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 关键：将真实数据源包装为Seata的代理数据源</span>
    targetDataSources.<span class="hljs-title function_">put</span>(<span class="hljs-string">"master"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(masterDataSource));
    targetDataSources.<span class="hljs-title function_">put</span>(<span class="hljs-string">"slave"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceProxy</span>(slaveDataSource));

    <span class="hljs-title class_">YourDynamicRoutingDataSource</span> dynamicDataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">YourDynamicRoutingDataSource</span>();
    dynamicDataSource.<span class="hljs-title function_">setTargetDataSources</span>(targetDataSources);
    dynamicDataSource.<span class="hljs-title function_">setDefaultTargetDataSource</span>(targetDataSources.<span class="hljs-title function_">get</span>(<span class="hljs-string">"master"</span>));
    <span class="hljs-keyword">return</span> dynamicDataSource;
}
</code></pre>
</li>
<li>
<p><strong>创建Undo_log表</strong>：在Seata的AT模式下，每一个业务数据库中都需要创建<code>undo_log</code>表，用于记录数据修改前的镜像，以便回滚。</p>
</li>
<li>
<p><strong>使用注解</strong>：在需要开启分布式事务的业务入口方法上使用<code>@GlobalTransactional</code>。在需要切换数据源的方法或类上使用相应的注解（如<code>@DS</code>）。</p>
</li>
</ol>
<h3 data-id="heading-2">⚠️ 常见问题与解决方案</h3>
<p>协同工作过程中，可能会遇到一些“坑”，以下是最常见的几种及应对方法：</p>

























<table><thead><tr><th>常见问题</th><th>现象</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>数据源切换后事务不生效</strong></td><td>事务上下文与数据源绑定关系丢失，部分操作未回滚。</td><td>确保数据源切换操作在<code>@GlobalTransactional</code>注解的方法内部进行，并检查数据源代理配置是否正确。</td></tr><tr><td><strong>全局异常被“吞掉”</strong></td><td>服务内部异常被全局异常处理器（<code>@RestControllerAdvice</code>）捕获并返回友好信息，导致上游服务无法感知异常，全局事务不回滚。</td><td>在全局异常处理器中，对于需要分布式事务回滚的异常，需要再次抛出原始异常或调用<code>TransactionContextHolder.clear()</code>并抛出业务异常。</td></tr><tr><td><strong>多数据源配置冲突</strong></td><td>与MyBatis-Plus的<code>dynamic-datasource-spring-boot-starter</code>等组件集成时，事务管理器配置不当导致失效。</td><td>确保使用了支持多数据源事务的注解（如Seata的<code>@GlobalTransactional</code>），并正确配置了Seata的数据源代理。</td></tr></tbody></table>
<h3 data-id="heading-3">💎 核心总结</h3>
<p>总而言之，动态数据源切换与Seata的协同，本质上是<strong>将动态路由能力置于Seata的全局事务管辖之下</strong>。Seata通过代理数据源来“监控”和“管理”所有数据库操作，而动态数据源则确保操作被路由到正确的、已被代理的数据源上。实现此集成的关键在于<strong>正确代理所有数据源</strong>，并<strong>妥善处理事务上下文的传播</strong>，同时留意常见的配置陷阱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npm命令详解]]></title>    <link>https://juejin.cn/post/7571191453126115354</link>    <guid>https://juejin.cn/post/7571191453126115354</guid>    <pubDate>2025-11-11T09:47:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453126115354" data-draft-id="7571278865516724274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npm命令详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T09:47:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npm命令详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:47:18.000Z" title="Tue Nov 11 2025 09:47:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>牛逼视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1Nx4118788%3Fspm_id_from%3D333.788.videopod.episodes%26vd_source%3Da27417abea09816580246ed454cd87e0" target="_blank" title="https://www.bilibili.com/video/BV1Nx4118788?spm_id_from=333.788.videopod.episodes&amp;vd_source=a27417abea09816580246ed454cd87e0" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Nx…</a></p>
<h3 data-id="heading-0">1. 什么是 npm？</h3>
<p><strong>npm</strong> 有两层含义：</p>
<ol>
<li><strong>一个在线仓库</strong>：全球最大的开源 JavaScript 代码库，开发者可以分享和借用各种代码包（package）。</li>
<li><strong>一个命令行工具</strong>：Node.js 的默认包管理器，用于与这个在线仓库交互，帮助你安装、管理项目依赖。</li>
</ol>
<p>当你安装 Node.js 时，npm 会自动被一起安装。</p>
<hr/>
<h3 data-id="heading-1">2. 核心概念</h3>
<ul>
<li><strong><code>package.json</code></strong>：项目的“身份证”和“菜单”，记录了项目名称、版本、依赖包等信息。它是 npm 操作的核心。</li>
<li><strong><code>node_modules</code></strong>：一个文件夹，所有通过 npm 安装的包及其依赖都会存放在这里。通常不需要手动修改，也不应该提交到版本控制系统（如 Git）。</li>
<li><strong><code>package-lock.json</code></strong> 或 <strong><code>npm-shrinkwrap.json</code></strong>：精确描述当前安装的依赖树版本，确保团队协作和部署时安装完全一致的包。<strong>建议提交到版本库</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. npm 命令详解（按功能分类）</h3>
<h4 data-id="heading-3">A. 项目初始化与配置</h4>

























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm init</code></td><td>交互式地创建一个新的 <code>package.json</code> 文件。</td><td><code>npm init</code></td></tr><tr><td><code>npm init -y</code> / <code>--yes</code></td><td>使用默认值快速创建 <code>package.json</code>，跳过所有提问。</td><td><code>npm init -y</code></td></tr><tr><td><code>npm config</code></td><td>管理 npm 的配置。</td><td>- <code>npm config list</code>：查看当前配置 - <code>npm config set &lt;key&gt; &lt;value&gt;</code>：设置配置，如 <code>npm config set registry https://registry.npmmirror.com</code>（设置淘宝镜像） - <code>npm config get &lt;key&gt;</code>：获取配置</td></tr></tbody></table>
<h4 data-id="heading-4">B. 包（依赖）的安装</h4>
<p>这是 npm 最核心的功能。依赖分为两种：</p>
<ul>
<li><strong>生产依赖</strong>：项目运行时必须的包（如 <code>react</code>, <code>express</code>），会出现在 <code>dependencies</code> 字段。</li>
<li><strong>开发依赖</strong>：仅在开发阶段需要的包（如 <code>webpack</code>, <code>eslint</code>, <code>jest</code>），会出现在 <code>devDependencies</code> 字段。</li>
</ul>













































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm install</code> (或 <code>npm i</code>)</td><td>根据 <code>package.json</code> 安装所有依赖。</td><td>在项目根目录执行，会创建 <code>node_modules</code> 并安装所有 <code>dependencies</code> 和 <code>devDependencies</code>。</td></tr><tr><td><code>npm install &lt;package_name&gt;</code></td><td>安装一个包，并自动添加到 <code>package.json</code> 的 <code>dependencies</code>。</td><td><code>npm install lodash</code></td></tr><tr><td><code>npm install &lt;package_name&gt; --save-dev</code> (或 <code>-D</code>)</td><td>安装一个包，并添加到 <code>package.json</code> 的 <code>devDependencies</code>。</td><td><code>npm install eslint --save-dev</code></td></tr><tr><td><code>npm install &lt;package_name&gt; --global</code> (或 <code>-g</code>)</td><td><strong>全局安装</strong>一个包（通常是命令行工具）。</td><td><code>npm install @vue/cli -g</code>（之后可以在任何地方使用 <code>vue</code> 命令）</td></tr><tr><td><code>npm install &lt;package_name&gt;@&lt;version&gt;</code></td><td>安装指定版本的包。</td><td><code>npm install react@18.2.0</code></td></tr><tr><td><code>npm install &lt;package_name&gt;@latest</code></td><td>安装包的最新版本。</td><td><code>npm install webpack@latest</code></td></tr><tr><td><code>npm ci</code></td><td><strong>清洁安装</strong>，用于自动化环境（如 CI/CD）。它依赖 <code>package-lock.json</code>，安装速度更快、更严格，但不会更新锁文件。</td><td><code>npm ci</code></td></tr></tbody></table>
<h4 data-id="heading-5">C. 依赖管理与更新</h4>



































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm update</code></td><td>更新所有包到 <code>package.json</code> 中允许的最新版本（遵循语义化版本规则）。</td><td><code>npm update</code></td></tr><tr><td><code>npm update &lt;package_name&gt;</code></td><td>更新指定的包。</td><td><code>npm update lodash</code></td></tr><tr><td><code>npm outdated</code></td><td>检查有哪些过时的包。</td><td>会列出当前版本、期望版本和最新版本。</td></tr><tr><td><code>npm uninstall &lt;package_name&gt;</code> (或 <code>npm un</code>)</td><td>卸载一个包，并从 <code>package.json</code> 中移除。</td><td><code>npm uninstall lodash</code></td></tr><tr><td><code>npm uninstall &lt;package_name&gt; --save-dev</code></td><td>卸载一个开发依赖包。</td><td><code>npm uninstall eslint --save-dev</code></td></tr></tbody></table>
<h4 data-id="heading-6">D. 运行脚本</h4>
<p><code>package.json</code> 中有一个 <code>"scripts"</code> 字段，可以定义自定义命令。</p>






























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm run &lt;script_name&gt;</code></td><td>运行在 <code>package.json</code> 的 <code>scripts</code> 中定义的脚本。</td><td>如果 <code>scripts</code> 中有 <code>"start": "node app.js"</code>，则 <code>npm run start</code> 会执行它。</td></tr><tr><td><code>npm start</code></td><td><code>npm run start</code> 的快捷方式。</td><td><code>npm start</code></td></tr><tr><td><code>npm test</code> (或 <code>npm t</code>)</td><td><code>npm run test</code> 的快捷方式。</td><td><code>npm test</code></td></tr><tr><td><code>npm run</code></td><td>列出所有可用的脚本。</td><td><code>npm run</code></td></tr></tbody></table>
<h4 data-id="heading-7">E. 信息查看与审计</h4>













































<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm list</code> (或 <code>npm ls</code>)</td><td>查看当前项目安装的包及其依赖树。</td><td>- <code>npm list</code>：查看顶级依赖 - <code>npm list --depth=0</code>：只查看直接依赖，更清晰 - <code>npm list -g</code>：查看全局安装的包</td></tr><tr><td><code>npm info &lt;package_name&gt;</code></td><td>查看某个包的详细信息（版本、依赖、描述等）。</td><td><code>npm info react</code></td></tr><tr><td><code>npm search &lt;keyword&gt;</code></td><td>在 npm 仓库中搜索包。</td><td><code>npm search http server</code></td></tr><tr><td><code>npm audit</code></td><td><strong>安全检查</strong>，扫描项目依赖中的已知漏洞。</td><td><code>npm audit</code></td></tr><tr><td><code>npm audit fix</code></td><td>自动修复可自动修复的漏洞。</td><td><code>npm audit fix</code></td></tr><tr><td><code>npm audit fix --force</code></td><td>强制修复漏洞，可能会进行破坏性更新（大版本升级）。</td><td><code>npm audit fix --force</code></td></tr><tr><td><code>npm view &lt;package_name&gt; versions</code></td><td>查看一个包所有可用的历史版本。</td><td><code>npm view webpack versions</code></td></tr></tbody></table>
<h4 data-id="heading-8">F. 发布与管理包（针对包开发者）</h4>






























<table><thead><tr><th>命令</th><th>功能</th><th>示例与说明</th></tr></thead><tbody><tr><td><code>npm login</code></td><td>登录到你的 npm 账户。</td><td><code>npm login</code></td></tr><tr><td><code>npm publish</code></td><td>将当前目录的包发布到 npm 仓库。</td><td>在项目根目录执行，前提是已登录且有合法的 <code>package.json</code>。</td></tr><tr><td><code>npm version &lt;update_type&gt;</code></td><td>更新包的版本号，并自动创建一个 Git tag。</td><td>- <code>npm version patch</code> (小版本，如 1.0.0 -&gt; 1.0.1) - <code>npm version minor</code> (次版本，如 1.0.0 -&gt; 1.1.0) - <code>npm version major</code> (主版本，如 1.0.0 -&gt; 2.0.0)</td></tr><tr><td><code>npm unpublish &lt;package_name&gt;@&lt;version&gt;</code></td><td><strong>取消发布</strong>某个版本的包（有严格限制）。</td><td><code>npm unpublish my-package@1.0.1</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">4. 常用工作流示例</h3>
<h4 data-id="heading-10">1. 启动一个新项目</h4>
<p>bash</p>
<pre><code class="hljs language-csharp" lang="csharp">mkdir my-<span class="hljs-keyword">new</span>-project
cd my-<span class="hljs-keyword">new</span>-project
npm <span class="hljs-keyword">init</span> -y                <span class="hljs-meta"># 快速创建 package.json</span>
npm install express        <span class="hljs-meta"># 安装生产依赖 express</span>
npm install nodemon --save-dev <span class="hljs-meta"># 安装开发依赖 nodemon</span>
</code></pre>
<p>然后，在 <code>package.json</code> 的 <code>scripts</code> 中添加：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node app.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon app.js"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>之后就可以使用 <code>npm run dev</code> 来启动开发服务器了。</p>
<h4 data-id="heading-11">2. 克隆并运行一个已有项目</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;project-url&gt;
<span class="hljs-built_in">cd</span> &lt;project-folder&gt;
npm install          <span class="hljs-comment"># 安装所有依赖</span>
npm start            <span class="hljs-comment"># 启动项目</span>
</code></pre>
<h4 data-id="heading-12">3. 更新项目依赖</h4>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">npm outdated         <span class="hljs-comment"># 检查哪些包过时了</span>
npm update           <span class="hljs-comment"># 更新所有包到允许的最新版本</span>
npm audit            <span class="hljs-comment"># 检查安全性</span>
npm audit fix        <span class="hljs-comment"># 修复漏洞</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">5. 实用技巧与最佳实践</h3>
<ol>
<li>
<p><strong>使用 <code>npx</code></strong>：<code>npx</code> 随 npm 一起安装，用于临时执行包。它无需全局安装，非常方便。</p>
<ul>
<li><code>npx create-react-app my-app</code> （临时下载并运行 <code>create-react-app</code>）</li>
<li><code>npx eslint .</code> （运行项目本地安装的 <code>eslint</code>）</li>
</ul>
</li>
<li>
<p><strong>使用 <code>.npmrc</code> 文件</strong>：可以在项目根目录创建此文件来定义项目特定的 npm 配置，例如设置私有仓库地址。</p>
</li>
<li>
<p><strong>理解语义化版本</strong>：</p>
<ul>
<li><code>^1.2.3</code>：允许更新次版本和修订号，如 1.2.4, 1.3.0，但不包括 2.0.0。</li>
<li><code>~1.2.3</code>：只允许更新修订号，如 1.2.4。</li>
<li>这就是 <code>package-lock.json</code> 重要的原因，它锁定了确切的版本。</li>
</ul>
</li>
<li>
<p><strong>不要手动修改 <code>node_modules</code></strong>：任何修改都会在下次 <code>npm install</code> 时丢失。</p>
</li>
<li>
<p><strong>将 <code>package-lock.json</code> 提交到 Git</strong>：这是保证团队一致性的关键。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？]]></title>    <link>https://juejin.cn/post/7571306072422842410</link>    <guid>https://juejin.cn/post/7571306072422842410</guid>    <pubDate>2025-11-11T13:49:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072422842410" data-draft-id="7571304204754714678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:49:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在高并发场景下，动态数据源切换与Seata全局事务锁管理如何协同避免性能瓶颈？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:49:51.000Z" title="Tue Nov 11 2025 13:49:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高并发场景下，将动态数据源切换与Seata全局事务锁管理有效结合，确实是一个既关键又具有挑战性的架构设计问题。下面这个表格概括了核心的协同优化策略，帮助你快速建立整体认知。</p>

























<table><thead><tr><th>优化维度</th><th>核心策略</th><th>预期收益</th></tr></thead><tbody><tr><td><strong>数据源路由优化</strong></td><td>精细化路由（如读写分离）、连接池隔离、预检机制</td><td>降低不必要的跨库操作，减少连接等待，提升单点处理能力</td></tr><tr><td><strong>Seata事务锁优化</strong></td><td>锁粒度控制（如分库分表）、混合事务模式（AT/TCC）、参数调优</td><td>缓解全局锁竞争，提高系统并发度</td></tr><tr><td><strong>协同工作机制</strong></td><td>事务边界与数据源生命周期对齐、异常处理与回滚策略</td><td>保证数据一致性的同时，避免资源悬挂和死锁</td></tr></tbody></table>
<h3 data-id="heading-0">💡 动态数据源路由的性能优化</h3>
<p>在高并发下，数据源切换本身不能成为瓶颈。优化的核心在于 <strong>“快、准、稳”</strong> 。</p>
<ol>
<li><strong>精细化路由策略</strong>：避免在单个事务或紧密关联的操作链中频繁切换数据源。例如，在设计上尽量让一个业务逻辑单元内的数据库操作集中于同一个数据源，如果必须跨源，应确保其必要性。采用清晰的<strong>读写分离</strong>策略，将绝大多数查询操作路由到从库，是减轻主库压力、提升并发读取能力的有效手段。</li>
<li><strong>连接池隔离与配置</strong>：为不同的数据源（如主库、从库、报表库）配置独立的、大小合适的数据库连接池。这能有效避免慢查询或某个数据源的异常拖垮整个应用的所有数据库操作。根据并发压力调整连接池参数（如 <code>maximumPoolSize</code>, <code>connectionTimeout</code>）也至关重要。</li>
<li><strong>路由预检与缓存</strong>：对于基于复杂规则（如租户ID、业务类型）的路由，可以引入缓存机制，避免每次请求都进行昂贵的规则计算。同时，在执行路由前，可以对目标数据源进行简单的健康检查（如连接测试），避免将请求路由到不可用或高延迟的节点。</li>
</ol>
<h3 data-id="heading-1">⚙️ Seata全局事务锁的深度优化</h3>
<p>Seata的AT模式在高并发下最主要的瓶颈是<strong>全局锁竞争</strong>。以下是关键优化方向：</p>
<ol>
<li>
<p><strong>控制锁粒度与热点数据</strong>：</p>
<ul>
<li><strong>库存分桶</strong>：对于像库存扣减这样的典型热点场景，可以考虑“库存分桶”方案。将一个SKU的总库存分散到多条记录中，扣减时通过特定算法（如哈希）选择一条记录操作，将竞争一把全局锁变为竞争多把锁，显著提升并发能力。</li>
<li><strong>业务键设计</strong>：在业务设计阶段，尽量避免让大量并发事务操作同一条数据记录。例如，生成订单号时加入用户ID哈希或时间戳分量，使写入尽量分散。</li>
</ul>
</li>
<li>
<p><strong>采用混合事务模式</strong>：这是应对极高并发场景的“杀手锏”。针对业务链路中的不同操作，灵活选用Seata提供的多种事务模式。例如，在电商下单场景中，对不会产生竞争的用户优惠券锁定操作使用<strong>AT模式</strong>，而对热点库存扣减操作采用<strong>TCC模式</strong>。TCC模式在Try阶段进行资源预留，Confirm/Cancel阶段才进行最终操作，避免了AT模式在整个事务周期内持有全局锁，从而大大减少了锁竞争时间。</p>
</li>
<li>
<p><strong>调整Seata客户端参数</strong>：根据业务可接受的延迟，适当调整Seata客户端的相关参数。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">seata:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">tm:</span>
      <span class="hljs-attr">commit-retry-count:</span> <span class="hljs-number">3</span>           <span class="hljs-comment"># 提交重试次数</span>
      <span class="hljs-attr">rollback-retry-count:</span> <span class="hljs-number">3</span>         <span class="hljs-comment"># 回滚重试次数</span>
    <span class="hljs-attr">lock:</span>
      <span class="hljs-attr">retry-interval:</span> <span class="hljs-number">10</span>              <span class="hljs-comment"># 锁重试间隔(ms)</span>
      <span class="hljs-attr">retry-times:</span> <span class="hljs-number">30</span>                 <span class="hljs-comment"># 锁获取重试次数</span>
</code></pre>
<p>增加重试次数和减少重试间隔可以在出现短暂锁竞争时提高成功率，但需注意这会增加单个事务的耗时。</p>
</li>
</ol>
<h3 data-id="heading-2">🔗 二者协同工作流程与策略</h3>
<p>动态数据源路由和Seata事务管理必须协同工作，才能确保在高性能下的一致性。</p>
<ol>
<li><strong>事务边界与数据源生命周期的对齐</strong>：务必确保在带有 <code>@GlobalTransactional</code>注解的方法内部进行数据源切换时，Seata的事务上下文（XID）能正确传递。最佳实践是，在方法开始时就明确设置好后续操作所需的数据源，避免在事务进行中频繁切换。如果必须在事务中切换，应通过编程方式（如 <code>DynamicDataSourceContextHolder.push()</code>）完成，并确保在finally块中清理上下文，防止污染后续操作。</li>
<li><strong>异常处理与回滚策略</strong>：在协同工作中，必须对数据源切换失败或Seata全局锁获取超时等异常有明确的处理策略。一旦发生此类异常，应确保Seata的全局事务能正确回滚，并且动态数据源的上下文也被及时清理。例如，在捕获到全局锁获取失败异常时，不应简单重试，而应结合业务考虑是直接失败快速返回，还是使用异步重试机制。</li>
<li><strong>降级与熔断机制</strong>：在监控到数据库节点故障或Seata事务协调器(TC)出现问题时，系统应具备降级能力。例如，在从库不可用时，动态数据源路由器应能自动将读请求全部指向主库。当Seata不可用时，可能需要降级到使用本地事务+最终一致性方案（如消息队列）来保证核心流程的可用性。</li>
</ol>
<h3 data-id="heading-3">📊 监控与应急处理</h3>
<p>建立完善的监控体系是保障高可用的前提。</p>
<ul>
<li><strong>监控指标</strong>：需要重点关注<strong>动态数据源切换的频率和成功率</strong>、<strong>Seata全局锁的获取时间、等待数量和超时率</strong>、<strong>数据库连接池的使用率</strong>等指标。</li>
<li><strong>应急措施</strong>：当出现性能瓶颈或死锁时，除了常规的重启、扩容，还应具备<strong>主动kill阻塞事务</strong>、<strong>动态禁用某个数据源路由</strong>、<strong>手动清理Seata全局锁</strong>（需极端谨慎）等应急能力。</li>
</ul>
<h3 data-id="heading-4">💎 总结与选型建议</h3>
<p>面对高并发场景，没有一劳永逸的银弹，关键在于根据业务特性进行权衡和选择。</p>
<ul>
<li><strong>对于一致性要求极高且并发热点集中的业务</strong>（如金融核心交易）：优先考虑使用 <strong>TCC模式</strong>或 <strong>Saga模式</strong>来避免全局锁，尽管实现成本较高。</li>
<li><strong>对于并发量高但允许短暂不一致的互联网业务</strong>（如普通电商下单）：可以采用 <strong>AT模式 + 库存分桶等业务设计 + 参数调优</strong>的组合方案，在保证基本一致性的前提下追求性能。</li>
<li><strong>对于读多写少的场景</strong>：充分利用<strong>动态数据源读写分离</strong>，将读压力分散，这是提升整体吞吐量最有效且成本最低的手段之一。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？]]></title>    <link>https://juejin.cn/post/7571304204753977398</link>    <guid>https://juejin.cn/post/7571304204753977398</guid>    <pubDate>2025-11-11T10:04:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753977398" data-draft-id="7571077686108618815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-11T10:04:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么需要垂直领域的SFT微调？垂直领域SFT微调怎么做？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:04:33.000Z" title="Tue Nov 11 2025 10:04:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着人工智能的日益火爆，大语言模型（LLM）的应用正变得无处不在。在垂直领域的SFT微调（Supervised Fine-Tuning）作为提升模型专业能力的关键技术，更是引人瞩目。</p>
<p>但你是否注意到一个奇怪的现象：相比经验丰富的专家，新手似乎对尝试SFT微调表现出了更大的热情？这究竟是为什么？是新手无畏的冒险精神，还是专家深思熟虑后的保留态度？</p>
<p>那么，什么是SFT微调？为什么它这么重要？具体怎么做？又该从哪个模型开始着手？别急，这篇文章将一步步为你解答。</p>
<p><strong>一、为什么需要垂直领域的SFT微调？</strong></p>
<p>通俗来讲，SFT微调是通过垂直领域数据对现有大语言模型进行二次训练，使其在特定领域表现得更精准、更专业。这一步骤的必要性主要体现在以下方面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/114ac4f97a9a41e5972bf18039fe5760~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460272&amp;x-signature=9HfyAS%2BZYSyRm7eMffPthlDaM4k%3D" alt="图片" loading="lazy"/></p>
<p><strong>弥补专业领域认知不足‌</strong></p>
<p>通用大语言模型基于海量互联网数据训练，具备广泛的知识覆盖，但在特定专业领域缺乏深度。</p>
<p>例如，当医生询问某种疾病的临床诊断标准，或律师咨询特定法规条款时，通用模型可能因知识局限而给出模糊甚至错误的回答。</p>
<p>通过SFT微调，引入领域专业数据（如医学期刊、法律案例）可强化模型对专业术语和核心知识的掌握，显著提升回答的准确性和权威性。</p>
<p><strong>‌掌握行业特定规范‌</strong></p>
<p>各行业均有其独特的操作准则。例如，医疗行业需严格遵守患者隐私保护，法律领域必须坚持程序公正原则，这些要求对专业性极为严苛。</p>
<p>通用模型可能因不熟悉行业潜规则而出现疏漏。SFT微调通过注入行业规范数据，使模型能够精准理解垂直场景下的合规要求，避免低级错误。</p>
<p><strong>‌精准匹配多样化任务‌</strong></p>
<p>不同领域的任务需求差异显著：临床医生需要生成结构化病历，法律从业者需审核合同条款，金融从业者则依赖市场趋势分析。</p>
<p>通用模型在面对此类细分任务时往往表现泛化。通过SFT微调，利用实际任务样本（如"指令-输出"对）训练模型，可使其深入理解任务流程，实现"专业对口"的高效输出。</p>
<p><strong>‌优化交互体验‌</strong></p>
<p>即使通用模型能完成基础领域任务，SFT微调仍可进一步优化表现。微调后的模型输出更贴合行业用语习惯，文本连贯性和专业性提升，从而大幅改善用户体验。</p>
<p>‌总结‌：SFT微调如同为通用模型提供"职业特训"，将其从"通才"转化为特定领域的"专家"，实现能力与场景的深度适配。</p>
<p><strong>二、垂直领域SFT微调怎么做？</strong></p>
<p>SFT微调并不是随便拿点数据丢给模型就行，它有一套清晰的流程。下面我们来一步步拆解：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6592c24eae7d4521a5d636b300ec208c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460272&amp;x-signature=hSfBy5ltjN%2BSMasOWrYdJTG5gZg%3D" alt="图片" loading="lazy"/></p>
<p><strong>领域数据准备‌</strong></p>
<p><strong>‌数据采集‌</strong>：获取高价值的专业领域文本，例如临床病历、合同条款、财经报道等，数据形式可包含结构化表格或非结构化文档。</p>
<p><strong>‌数据净化‌</strong>：剔除文本中的干扰项（如错别字、冗余信息）及隐私内容（如个人身份信息），保障数据纯净度。</p>
<p><strong>‌数据标注‌</strong>：按任务需求将数据转换为定向格式，例如“问句-回复”对、“原文-精要”对等，以适配模型训练需求。</p>
<p><strong>‌微调样本构建‌</strong></p>
<p><strong>‌模板设计‌</strong>：依据模型特性与任务目标，制定输入输出范例。例如在医疗场景中，输入为“主诉症状”，输出为“诊疗方案”。</p>
<p><strong>‌内容增强‌</strong>：结合领域知识库或行业标准文件，为输入样本补充上下文说明与规则限制。</p>
<p><strong>‌数据集整合‌</strong>：将样本系统化整理为统一数据集，供后续训练调用。</p>
<p><strong>‌微调策略制定‌</strong></p>
<p><strong>‌模型选择‌</strong>：优先选用与任务匹配度高的基础模型，可显著提升微调效率。</p>
<p><strong>‌目标设定‌</strong>：除语言生成能力外，需纳入任务专项指标（如精确度、合规性等）。</p>
<p><strong>‌参数优化‌</strong>：调整学习率、迭代次数等参数，实现效果与资源消耗的最优配比。</p>
<p><strong>‌模型训练实施‌</strong></p>
<p><strong>‌启动训练‌</strong>：利用预处理数据对选定模型进行训练。</p>
<p><strong>‌实时监控‌</strong>：训练过程中动态评估效果，及时调整参数以确保模型性能持续优化。</p>
<p><strong>‌版本筛选‌</strong>：从多个训练版本中通过测试选出最优模型。</p>
<p>‌<strong>模型效果评估‌</strong></p>
<p><strong>‌多维测试‌</strong>：使用独立测试集验证模型，兼顾语言流畅度与任务达成度。</p>
<p><strong>‌专家验证‌</strong>：邀请领域专家审核输出结果，识别改进点。</p>
<p><strong>‌迭代优化‌</strong>：基于测试反馈调整数据或模型结构，进行多轮精进。</p>
<p><strong>‌实际应用部署‌</strong></p>
<p><strong>‌系统上线‌</strong>：将优化后的模型投入实际业务场景，提供智能化服务。</p>
<p><strong>‌交互设计‌</strong>：开发易用的操作界面，降低用户使用门槛。</p>
<p><strong>‌长效更新‌</strong>：持续收集用户反馈，定期迭代模型以适应领域知识演进。</p>
<p><strong>三、从哪个模型开始微调？基座模型 vs 对话模型</strong></p>
<p>在进行SFT微调时，一个核心决策点是：从哪个起点开始？是选择预训练的基础模型（即基座模型），还是对话模型（例如聊天模型）？这两种路径各有其优势和局限性，我们一起来探讨一下：</p>
<p><strong>1、基于预训练基础模型的微调</strong></p>
<p><strong>优势</strong>：</p>
<p>‌语言能力深厚‌：基座模型经过海量数据训练，具备扎实的语言理解和生成能力，为后续任务奠定了良好基础。</p>
<p>‌可塑性强‌：未针对特定任务固化，可根据实际需求灵活调整微调方向。</p>
<p>‌经济性高‌：相比对话模型，微调过程所需的计算资源和时间成本显著降低。</p>
<p><strong>不足</strong>：</p>
<p>‌领域知识匮乏‌：对专业领域的认知近乎空白，需通过大量数据填补知识缺口。</p>
<p>‌对话适应性差‌：更适合处理独立文本，在多轮对话场景中可能表现生硬。</p>
<p><strong>2、基于对话模型的微调</strong></p>
<p><strong>优势</strong>：</p>
<p>‌对话基础成熟‌：已掌握对话交互的基本模式，能更快适应特定领域的对话需求。</p>
<p>‌上下文连贯性‌：对对话逻辑和语境的把握更精准，输出更自然流畅。</p>
<p>‌交互体验优化‌：生成的响应更贴近人类交流习惯，提升用户满意度。</p>
<p><strong>不足</strong>：</p>
<p>‌潜在偏差‌：可能继承通用对话中的某些倾向性，与垂直领域需求存在冲突。</p>
<p>‌知识深度有限‌：侧重对话交互能力，对专业复杂知识的理解可能不足。</p>
<p>‌资源消耗大‌：模型复杂度更高，微调过程需要更多算力和数据支持。</p>
<p><strong>3、决策建议</strong></p>
<p>若目标是构建高度专业的对话系统，且具备充足的数据和算力资源，建议优先选择对话模型作为起点，能快速实现领域适配并优化用户体验。</p>
<p>若数据有限或任务偏向通用性，从基座模型起步更具性价比，能以较低成本获得合格的基础模型。</p>
<p><strong>混合策略也是可行方案</strong>：先通过基座模型建立领域知识基础，再通过对话模型优化交互体验；或尝试"提示工程"（Prompt Engineering），借助精心设计的输入模板实现快速适配。</p>
<p>最终选择需综合考量三个关键因素：任务特性、数据规模、预算限制。通过系统权衡，才能找到最优解决方案。</p>
<p><strong>四、SFT微调有哪些实际应用？</strong></p>
<p>当基础模型能力不足且RAG技术仍无法满足需求时，SFT微调将成为必要选择。其跨行业适用性极强，以下为典型领域案例：</p>
<p><strong>1、医疗健康领域</strong></p>
<p><strong>‌智能问诊系统‌</strong>：基于患者症状描述，输出初步诊断或健康管理方案。</p>
<p><strong>‌自动化报告生成‌</strong>：整合检验数据，一键生成标准化病历或影像分析报告。</p>
<p><strong>‌新药研发支持‌</strong>：通过分子结构模拟，评估药物活性并加速研发流程。</p>
<p><strong>2、法律司法领域</strong></p>
<p><strong>‌普法智能助手‌</strong>：面向公众提供法律知识解答与诉讼流程指导。</p>
<p><strong>‌合同风险检测‌</strong>：自动识别条款中的法律漏洞并给出优化建议。</p>
<p><strong>‌司法案例挖掘‌</strong>：从判决文书中提取裁判规则，辅助类案分析。</p>
<p><strong>3、金融经济领域</strong></p>
<p><strong>‌财经快讯生成‌</strong>：实时聚合新闻关键信息，产出市场动态简报。</p>
<p><strong>‌量化投资分析‌</strong>：融合财务数据与市场指标，构建股价预测模型。</p>
<p><strong>‌行业研究报告‌</strong>：自动生成细分领域洞察或宏观经济趋势分析。</p>
<p>上述案例仅为SFT微调实际应用的局部展现，其价值边界仍在持续拓展中。</p>
<p><strong>五、总结</strong></p>
<p>垂直领域的SFT微调，是一把打开大语言模型潜力的钥匙。通过它，我们可以把通用的“全能选手”变成某个行业的“顶尖专家”。</p>
<p>无论是医疗诊断、法律咨询，还是金融分析、教育辅导，只要用对了方法，SFT微调都能让模型大放异彩。</p>
<p>总的来说，新手对垂直领域SFT微调的热情源于他们对技术的好奇、对成果的渴望以及对风险的相对无感，而专家则因丰富的经验和对技术边界的清醒认识而更显谨慎。</p>
<p>不管你是初入AI领域的新手，还是深耕多年的专家，理解SFT微调的价值与局限都至关重要。愿这篇文章点燃你的思考火花，激励你在垂直领域的AI探索中找到属于自己的答案。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[访问宝塔面板安全入口404？SSH命令轻松解决]]></title>    <link>https://juejin.cn/post/7571285984088850484</link>    <guid>https://juejin.cn/post/7571285984088850484</guid>    <pubDate>2025-11-11T10:18:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088850484" data-draft-id="7571156741398052879" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="访问宝塔面板安全入口404？SSH命令轻松解决"/> <meta itemprop="keywords" content="运维,Linux,安全"/> <meta itemprop="datePublished" content="2025-11-11T10:18:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云动雨颤"/> <meta itemprop="url" content="https://juejin.cn/user/772323170591859"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            访问宝塔面板安全入口404？SSH命令轻松解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/772323170591859/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云动雨颤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:18:20.000Z" title="Tue Nov 11 2025 10:18:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文系转载，转载链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwoolyun.com%2Fbt-404%2F" target="_blank" title="https://woolyun.com/bt-404/" ref="nofollow noopener noreferrer">访问宝塔面板安全入口404？SSH命令轻松解决</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在我们的Linux云服务器中安装好宝塔面板后，将宝塔面板的入口链接存进浏览器的收藏夹中，本想随用随开，再次访问时却突然弹出“404 Not Found”，而且在历史记录中打开同样会出现404错误。今天就给大家分享一些解决方案。</p>
<h2 data-id="heading-1">一、404问题到底是什么样的？</h2>
<p>为了方便管理服务器，我们一般会把宝塔面板的公网地址添加到浏览器收藏夹。但过一段时间再点开，页面会显示“404 not found”错误，哪怕从浏览器历史记录里打开，结果也一样——这不是服务器出了大问题，多半是面板的“访问地址或安全入口变了”，按旧地址找自然会扑空。</p>
<h2 data-id="heading-2">二、解决方案</h2>
<p>遇到404不用慌，通过SSH远程连接服务器，执行简单命令就能找回访问地址：</p>
<h3 data-id="heading-3">第一步：通过SSH远程连接服务器</h3>
<p>首先要进入服务器的后台——用SSH工具（比如Xshell、FinalShell、PuTTY、云服务器控制台）连接你的Linux服务器：</p>
<ul>
<li>打开SSH工具，输入服务器的公网IP、端口（默认22）、用户名（比如root）和密码（或密钥）；</li>
<li>点击“连接”，如果出现类似“[root@localhost ~]#”的命令行提示符，就说明连接成功了。</li>
</ul>
<h3 data-id="heading-4">第二步：执行命令，重新获取面板访问信息</h3>
<p>这一步是查询新的面板入口，有两种简单方式，选一种执行即可：</p>
<h4 data-id="heading-5">方式一：一步到位执行命令</h4>
<p>在命令行输入以下代码，按回车：</p>
<pre><code class="hljs">bt 14
</code></pre>
<h4 data-id="heading-6">方式二：分步执行命令</h4>
<p>如果想看清每一步操作，也可以分两步来：</p>
<ol>
<li>先输入 <code>bt</code> 并回车，此时会弹出宝塔面板的命令菜单；</li>
<li>在菜单中输入数字 <code>14</code> 并回车（<code>14</code> 对应的功能就是“查看面板默认信息”）。</li>
</ol>
<p>执行完命令后，终端会显示新的宝塔面板访问地址（比如 <code>https://新IP:新端口/新安全入口</code>）和安全入口验证信息，把这个新地址记下来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69708427e24441bcb07dfe364d36be4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5Yqo6Zuo6aKk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763461099&amp;x-signature=m6Z0jPQx5uq8Gr6bboyae%2BSTz2A%3D" alt="宝塔4041" loading="lazy"/></p>
<h3 data-id="heading-7">第三步：用新地址访问面板</h3>
<p>打开浏览器，把刚获取的新地址粘贴到地址栏，按回车——不出意外，就能正常进入宝塔面板的登录页面，404问题也就解决了。</p>
<h2 data-id="heading-8">三、彻底避免：设置固定安全入口，再也不怕地址变动</h2>
<p>这次解决了，下次还可能遇到？其实只要给宝塔面板“固定入口”，就能一劳永逸：</p>
<h3 data-id="heading-9">第一步：进入宝塔面板</h3>
<p>用刚获取的新地址登录宝塔面板，输入用户名和密码，进入面板管理界面。</p>
<h3 data-id="heading-10">第二步：找到“面板设置”</h3>
<p>在面板左侧的菜单栏中，找到并点击“面板设置”选项。</p>
<h3 data-id="heading-11">第三步：修改并固定安全入口</h3>
<p>在“面板设置”页面中，往下滑动找到“安全入口”设置项：</p>
<ul>
<li>默认的安全入口是随机生成的（比如 <code>randomentry123</code>），容易变动；</li>
<li>把它修改成你容易记住且独特的内容（比如 <code>mybaotaentry</code>，建议包含字母和数字，避免太简单被猜测）；</li>
<li>点击“保存”按钮，此时宝塔面板的访问地址就固定为 <code>https://你的服务器IP:面板端口/你设置的安全入口</code>，以后不管怎么变动，这个地址都能正常访问。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec8dcce637bc47f281f154b8da6618f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5Yqo6Zuo6aKk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763461099&amp;x-signature=VXamsE%2B%2Bu%2FBSt5gdePD7uCrEkUQ%3D" alt="宝塔4042" loading="lazy"/></p>
<h2 data-id="heading-12">四、总结</h2>
<p>宝塔Linux面板出现404，最大原因可能是“访问地址或安全入口变动”，那么解决思路久很清晰了：</p>
<ol>
<li>用SSH连接服务器，执行 <code>bt 14</code> 找到新地址；</li>
<li>登录面板后，在“面板设置”中固定安全入口，避免后续变动。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CI/CD集成工程师前景分析：与开发岗位的全面对比]]></title>    <link>https://juejin.cn/post/7571338749197566002</link>    <guid>https://juejin.cn/post/7571338749197566002</guid>    <pubDate>2025-11-11T13:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197566002" data-draft-id="7571352754895994906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CI/CD集成工程师前景分析：与开发岗位的全面对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CI/CD集成工程师前景分析：与开发岗位的全面对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:56:08.000Z" title="Tue Nov 11 2025 13:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在当今快速迭代的软件开发环境中，CI/CD集成工程师已成为众多科技公司不可或缺的角色，但人们常好奇：这一新兴岗位与传统开发相比究竟孰优孰劣？</p>
</blockquote>
<p>随着 DevOps 理念的普及，CI/CD（持续集成/持续交付）已成为现代软件开发的<strong>核心实践</strong>。CI/CD集成工程师作为这一过程的构建者和维护者，在当前的IT行业中需求越来越大，因为软件开发的速度和质量已成为<strong>企业竞争的重要因素</strong>之一。</p>
<p>与此同时，随着云计算和 DevOps 的兴起，更多企业开始采用 CI/CD 来提高软件交付效率。</p>
<hr/>
<h2 data-id="heading-0">01 CI/CD集成工程师的角色与职责</h2>
<p>CI/CD 集成工程师主要负责设计和实施自动化流程，使软件能够更加高效、可靠地构建、测试和部署。</p>
<p><strong>持续集成</strong>（CI）是一种软件开发实践，开发人员频繁地将代码变更合并到共享仓库中，每次变更都会触发<strong>自动化构建和测试</strong>。</p>
<p><strong>持续交付</strong>（CD）则是在此基础上，自动将代码变更部署到各种环境，确保软件随时可以发布到生产环境。</p>
<p>具体来说，CI/CD集成工程师需要确保团队使用的持续集成工具和流程能够顺利地自动化构建、测试和部署软件。</p>
<p>他们需要熟练掌握 <strong>Jenkins、GitLab CI、GitHub Actions</strong> 等工具，并能够运用 Docker 和 Kubernetes 等容器化技术进行自动化部署。</p>
<p>在职责方面，CI/CD集成工程师需要开发和构建自动化框架，包括持续集成和持续部署流程。</p>
<p>他们还要洞察开发、测试和部署中的难点和瓶颈，持续改进以保证项目顺利进行。</p>
<h2 data-id="heading-1">02 开发工程师的角色与职责</h2>
<p>开发工程师主要负责软件的设计、编码和单元测试，是软件产品的<strong>直接创造者</strong>。</p>
<p>与CI/CD工程师不同，开发工程师更关注代码的实现、算法的优化以及功能的完整性和正确性。</p>
<p>开发工程师需要根据产品需求编写高质量的代码，并参与系统架构设计。他们通常会专注于特定的技术栈，如前端、后端或移动端开发。</p>
<p>除了编写代码，开发工程师还需要修复系统中的缺陷，进行代码审查，以及与团队成员协作解决技术难题。</p>
<h2 data-id="heading-2">03 职业前景对比：市场需求与发展空间</h2>
<p><strong>CI/CD集成工程师前景广阔</strong>。随着企业对软件交付速度和质量要求的不断提高，CI/CD集成工程师的需求呈现出<strong>增长趋势</strong>。</p>
<p>在招聘市场上，可以看到众多企业正在招聘CI/CD集成工程师，提供的薪资也颇具竞争力。</p>
<p>例如，来自1111人力银行的招聘信息显示，CI/CD相关职位的月薪在台湾地区可达<strong>6万到10万新台币</strong>。</p>
<p>而猎聘网的招聘信息则显示，北京的CI/CD集成工程师薪资可达<strong>15-25k</strong>人民币。</p>
<p>开发工程师虽然市场需求量大，但由于从业人数众多，<strong>竞争也更为激烈</strong>。相比之下，CI/CD集成工程师作为相对专业的领域，竞争程度较低，且由于缺乏资深人才，高级职位的薪资潜力更大。</p>
<p>随着云原生和微服务架构的普及，CI/CD集成工程师的重要性将进一步凸显，职业发展空间持续看好。</p>
<h2 data-id="heading-3">04 技能要求对比：技术栈与知识体系</h2>
<p>CI/CD集成工程师需要掌握多样化的技术栈。首先，他们需要熟悉 <strong>CI/CD工具链</strong>，如Jenkins、GitLab CI、GitHub Actions等。</p>
<p>其次，他们需要掌握 <strong>Docker和Kubernetes等容器化技术</strong>，以及自动化部署技巧。</p>
<p>此外，他们还需要了解<strong>基础设施即代码</strong>（IaC）工具，如Terraform、Ansible等。</p>
<p>对版本控制系统（尤其是Git）的深入理解也是必不可少的。与开发工程师相比，CI/CD集成工程师更需要<strong>系统架构视角</strong>和<strong>跨环境问题解决能力</strong>。</p>
<p>开发工程师则更需要<strong>深厚的编程功底</strong>，<strong>对算法和数据结构的理解</strong>，以及<strong>特定技术栈的专业知识</strong>。</p>
<p>例如，Java开发工程师需要掌握Spring框架，前端开发工程师需要熟悉React或Vue等框架。</p>
<p>开发工程师通常更专注于代码层面，而CI/CD集成工程师则需要更广泛的系统级知识和自动化能力。</p>
<h2 data-id="heading-4">05 工作内容与团队协作差异</h2>
<p>CI/CD集成工程师的工作内容主要集中在<strong>自动化流程的构建和优化</strong>上。他们需要设计CI/CD流水线，实现自动化构建、静态代码检查、自动化测试等。</p>
<p>他们还需要处理部署过程中的各种问题，确保部署的可靠性和效率。在团队协作方面，CI/CD集成工程师需要与开发人员、测试人员和运维人员密切合作，是** DevOps 文化的关键实践者**。</p>
<p>开发工程师则主要专注于<strong>功能实现和代码编写</strong>。他们需要参与需求分析，进行软件设计，编写代码，完成单元测试，并修复测试过程中发现的问题。</p>
<p>开发工程师通常按产品功能或技术模块划分职责，与产品经理和测试工程师的协作更为紧密。</p>
<p>从工作性质来看，CI/CD集成工程师的工作更偏向<strong>流程和质量保障</strong>，而开发工程师的工作更偏向<strong>功能实现和创新</strong>。</p>
<h2 data-id="heading-5">06 薪资待遇与职业发展路径</h2>
<p>在薪资待遇方面，两类岗位都有不错的表现。根据招聘信息显示，CI/CD集成工程师的薪资普遍较高，特别是拥有多年经验的高级工程师。</p>
<p>开发工程师的薪资范围较为广泛，初级开发工程师的起薪可能相对较低，但随着经验积累和技术提升，高级开发工程师和架构师的薪资也非常可观。</p>
<p>职业发展路径方面，CI/CD集成工程师可以向<strong>DevOps架构师</strong>、<strong>平台工程师</strong>或<strong>SRE</strong>（站点可靠性工程师）方向发展。</p>
<p>他们还可以成为<strong>CI/CD专家</strong>，负责更复杂和大型的系统架构。</p>
<p>开发工程师则可以向<strong>高级开发工程师</strong>、<strong>系统架构师</strong>或<strong>技术负责人</strong>方向发展，也有机会转型为<strong>技术经理</strong>或<strong>产品经理</strong>。</p>
<p>值得注意的是，CI/CD集成工程师的职业发展路径相对较新，机会可能更多，因为这一领域的专业人才仍然相对稀缺。</p>
<h2 data-id="heading-6">07 如何选择：根据个人特质与兴趣</h2>
<p>选择成为CI/CD集成工程师还是开发工程师，应基于个人技术偏好和职业规划。</p>
<p>如果你对<strong>自动化、系统架构和流程优化</strong>感兴趣，喜欢看到自己的工作带来效率的显著提升，那么CI/CD集成工程师可能是更好的选择。</p>
<p>这一岗位需要<strong>较强的逻辑思维</strong>和<strong>系统分析能力</strong>，以及<strong>解决复杂问题的耐心</strong>。</p>
<p>如果你更享受<strong>代码编写和功能实现</strong>的过程，喜欢从零开始构建产品，并具备<strong>较强的创造力</strong>，那么开发工程师可能更适合你。</p>
<p>这一岗位需要<strong>持续学习新技术</strong>的能力和<strong>对细节的关注</strong>。</p>
<p>无论选择哪条路径，都需要不断学习新知识和技能。对于初学者，建议先积累一定的开发经验，再向CI/CD领域发展，这样会有更扎实的基础和更全面的视角。</p>
<hr/>
<p><strong>未来已来</strong>，随着云原生、人工智能等技术的不断发展，CI/CD集成工程师的工作内容将进一步丰富，他们将在<strong>智能运维、自动化测试优化</strong>等领域发挥更大价值。</p>
<p>而对于开发工程师来说，<strong>掌握CI/CD知识</strong>也将从“加分项”变为“必需项”，只有理解完整软件交付流程的开发工程师，才能在未来的团队中发挥更大作用。</p>
<p>无论选择哪条路径，<strong>持续学习</strong>和<strong>实践验证</strong>都是不可或缺的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中的线程同步机制浅析]]></title>    <link>https://juejin.cn/post/7571338749197598770</link>    <guid>https://juejin.cn/post/7571338749197598770</guid>    <pubDate>2025-11-11T13:57:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197598770" data-draft-id="7571332468897775643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中的线程同步机制浅析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T13:57:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中的线程同步机制浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:57:30.000Z" title="Tue Nov 11 2025 13:57:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 为什么需要线程同步？</h3>
<p>当多个线程并发访问共享数据（内存、文件、网络连接等）时，如果不进行任何同步控制，可能会引发一系列问题，最典型的是：</p>
<ul>
<li><strong>数据竞争</strong>：一个线程在读数据时，另一个线程在写数据，导致读到的数据是“脏的”、不完整的或逻辑错误的。</li>
<li><strong>破坏不变量</strong>：对象在修改过程中，其内部状态可能暂时是不一致的（例如，修改一个链表时）。如果另一个线程在此时访问该对象，会看到这个破碎的状态，导致未定义行为。</li>
</ul>
<p>线程同步的核心目的是：<strong>通过强制特定代码段的互斥访问或执行顺序，来保证多线程环境下程序行为的正确性和可预测性。</strong></p>
<hr/>
<h3 data-id="heading-1">2. C++标准库提供的同步机制</h3>
<p>C++11在标准库中引入了 <code>&lt;thread&gt;</code> 和 <code>&lt;mutex&gt;</code> 等头文件，提供了丰富的同步原语。</p>
<h4 data-id="heading-2">2.1 互斥量 - 保证互斥访问</h4>
<p>互斥量是最基础的同步工具，它确保同一时间只有一个线程可以进入被保护的代码段（临界区）。</p>
<p><strong>a) <code>std::mutex</code></strong>
最基本的互斥量，不可递归。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

std::mutex g_mutex;
<span class="hljs-type">int</span> shared_data = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        g_mutex.<span class="hljs-built_in">lock</span>(); <span class="hljs-comment">// 加锁</span>
        ++shared_data;  <span class="hljs-comment">// 临界区</span>
        g_mutex.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 解锁</span>
    }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">(increment)</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">(increment)</span></span>;
    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    std::cout &lt;&lt; <span class="hljs-string">"Final value: "</span> &lt;&lt; shared_data &lt;&lt; std::endl; <span class="hljs-comment">// 一定是 200000</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>注意</strong>：直接使用 <code>lock()</code> 和 <code>unlock()</code> 是危险的，如果临界区代码抛出异常，可能导致互斥量无法解锁，引发死锁。<strong>永远优先使用RAII包装器</strong>。</p>
<p><strong>b) <code>std::lock_guard</code></strong>
最简单的RAII包装器，在构造时加锁，析构时自动解锁。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>; <span class="hljs-comment">// 构造时加锁</span>
        ++shared_data; <span class="hljs-comment">// 临界区</span>
    } <span class="hljs-comment">// 作用域结束，lock析构，自动解锁</span>
}
</code></pre>
<p><strong>c) <code>std::unique_lock</code></strong>
比 <code>lock_guard</code> 更灵活，但开销稍大。它允许延迟加锁、提前解锁、条件变量配合使用等。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flexible_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex, std::defer_lock)</span></span>; <span class="hljs-comment">// 延迟加锁</span>
        <span class="hljs-comment">// ... 一些不涉及共享数据的操作 ...</span>
        lock.<span class="hljs-built_in">lock</span>(); <span class="hljs-comment">// 手动加锁</span>
        ++shared_data;
        lock.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 可以手动提前解锁</span>
        <span class="hljs-comment">// ... 其他操作 ...</span>
    }
}
</code></pre>
<p><strong>d) <code>std::recursive_mutex</code></strong>
允许同一个线程多次获取同一个互斥量而不会死锁。用于可能递归调用或需要多次加锁的场景。<strong>应谨慎使用，通常表明设计可能有问题。</strong></p>
<h4 data-id="heading-3">2.2 条件变量 - 线程间的通信与等待</h4>
<p>条件变量允许线程阻塞等待某个条件成立，或在条件成立时通知其他线程。它必须与互斥量配合使用。</p>
<ul>
<li><code>std::condition_variable</code> （推荐，通常更高效）</li>
<li><code>std::condition_variable_any</code> （可与任何满足基本互斥量概念的类型一起使用，但开销更大）</li>
</ul>
<p><strong>典型生产者-消费者模型：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>

std::queue&lt;<span class="hljs-type">int</span>&gt; g_queue;
std::mutex g_mutex;
std::condition_variable g_cv;
<span class="hljs-type">bool</span> g_done = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">producer</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {
        std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">100</span>));
        {
            <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
            g_queue.<span class="hljs-built_in">push</span>(i);
            std::cout &lt;&lt; <span class="hljs-string">"Produced: "</span> &lt;&lt; i &lt;&lt; std::endl;
        }
        g_cv.<span class="hljs-built_in">notify_one</span>(); <span class="hljs-comment">// 通知一个等待的消费者</span>
    }
    {
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
        g_done = <span class="hljs-literal">true</span>;
    }
    g_cv.<span class="hljs-built_in">notify_all</span>(); <span class="hljs-comment">// 通知所有消费者结束</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(g_mutex)</span></span>;
        <span class="hljs-comment">// 等待条件：队列不为空或生产结束</span>
        g_cv.<span class="hljs-built_in">wait</span>(lock, [] { <span class="hljs-keyword">return</span> !g_queue.<span class="hljs-built_in">empty</span>() || g_done; });

        <span class="hljs-comment">// 被唤醒后，需要重新检查条件</span>
        <span class="hljs-keyword">if</span> (g_done &amp;&amp; g_queue.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-comment">// 消费数据</span>
        <span class="hljs-type">int</span> data = g_queue.<span class="hljs-built_in">front</span>();
        g_queue.<span class="hljs-built_in">pop</span>();
        lock.<span class="hljs-built_in">unlock</span>(); <span class="hljs-comment">// 尽早释放锁</span>

        std::cout &lt;&lt; <span class="hljs-string">"Consumer "</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">" consumed: "</span> &lt;&lt; data &lt;&lt; std::endl;
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>wait</code> 操作会原子地释放互斥锁并使线程休眠。</li>
<li>被唤醒时，它会重新获取互斥锁，然后检查条件（使用提供的谓词）。<strong>必须使用循环或带谓词的wait来防止“虚假唤醒”</strong>。</li>
</ul>
<h4 data-id="heading-4">2.3 信号量 - C++20</h4>
<p>信号量是一个更底层的同步原语，它维护一个计数器，用于控制对特定数量资源的访问。</p>
<ul>
<li><code>std::counting_semaphore</code>：允许至少 <code>LeastMaxValue</code> 个并发访问。</li>
<li><code>std::binary_semaphore</code>：是 <code>std::counting_semaphore&lt;1&gt;</code> 的别名，类似于互斥量，但可由不同线程进行锁和解锁。</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore&gt;</span></span>

<span class="hljs-function">std::binary_semaphore <span class="hljs-title">smph</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>; <span class="hljs-comment">// 初始值为0</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">waiter</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"Waiting...\n"</span>;
    smph.<span class="hljs-built_in">acquire</span>(); <span class="hljs-comment">// 等待信号量值&gt;0，然后减1</span>
    std::cout &lt;&lt; <span class="hljs-string">"Finished waiting!\n"</span>;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">notifier</span><span class="hljs-params">()</span> </span>{
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
    std::cout &lt;&lt; <span class="hljs-string">"Notifying...\n"</span>;
    smph.<span class="hljs-built_in">release</span>(); <span class="hljs-comment">// 信号量值加1，唤醒等待者</span>
}
</code></pre>
<h4 data-id="heading-5">2.4 锁存器和屏障 - C++20</h4>
<p>用于管理一组线程的同步点。</p>
<ul>
<li><strong><code>std::latch</code></strong>：一次性使用的倒计时门闩。线程在 <code>arrive_and_wait</code> 上阻塞，直到内部计数器减为0，所有阻塞线程被同时释放。不可重复使用。</li>
<li><strong><code>std::barrier</code></strong>：可重复使用的同步机制。它允许一组线程执行一系列阶段。在每个阶段，线程到达屏障并阻塞，直到所有线程都到达，然后所有线程被释放，屏障进入下一个阶段。</li>
</ul>
<hr/>
<h3 data-id="heading-6">3. 高级话题与底层原理</h3>
<h4 data-id="heading-7">3.1 死锁与预防</h4>
<p>死锁通常发生在两个或以上线程互相等待对方持有的资源时。</p>
<p><strong>产生条件（四个必要条件）</strong>：</p>
<ol>
<li><strong>互斥访问</strong></li>
<li><strong>持有并等待</strong></li>
<li><strong>不可剥夺</strong></li>
<li><strong>循环等待</strong></li>
</ol>
<p><strong>预防策略</strong>：</p>
<ul>
<li><strong>固定顺序上锁</strong>：所有线程都按照相同的全局顺序获取锁。</li>
<li><strong>使用 <code>std::lock</code> 或 <code>std::scoped_lock</code> (C++17)</strong>：一次性锁定多个互斥量，避免死锁。
<pre><code class="hljs language-cpp" lang="cpp">std::mutex mutex1, mutex2;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safe_lock</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// std::lock 使用死锁避免算法（如Dijkstra算法）来同时锁定多个互斥量</span>
    std::<span class="hljs-built_in">lock</span>(mutex1, mutex2);
    <span class="hljs-comment">// 使用 std::adopt_lock 表示互斥量已被锁定，lock_guard只需接管所有权</span>
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock1</span><span class="hljs-params">(mutex1, std::adopt_lock)</span></span>;
    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock2</span><span class="hljs-params">(mutex2, std::adopt_lock)</span></span>;
    <span class="hljs-comment">// ...</span>
}
<span class="hljs-comment">// C++17 更简洁的方式：</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safer_lock</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">std::scoped_lock <span class="hljs-title">lock</span><span class="hljs-params">(mutex1, mutex2)</span></span>; <span class="hljs-comment">// 自动使用死锁避免算法</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
</li>
<li><strong>避免嵌套锁</strong>：如果可能，尽量只持有一个锁。</li>
<li><strong>使用层次锁</strong>：为锁分配层级编号，只允许以编号递减的顺序获取锁。</li>
</ul>
<h4 data-id="heading-8">3.2 性能考量</h4>
<ul>
<li><strong>锁的粒度</strong>：锁保护的临界区应尽可能小。在临界区内不要进行耗时操作（如I/O）。</li>
<li><strong>锁竞争</strong>：当多个线程频繁尝试获取同一个锁时，会发生激烈竞争，导致大量线程在用户态和内核态之间切换，严重降低性能。
<ul>
<li><strong>解决方案</strong>：使用无锁数据结构、减少共享数据、使用读写锁（<code>std::shared_mutex</code>）、或者将数据分区（每个线程处理自己的数据副本，最后再合并）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">3.3 内存模型与原子操作</h4>
<p>同步机制的底层与C++内存模型紧密相关。</p>
<ul>
<li><strong><code>std::atomic</code></strong>：提供了无需互斥锁的线程安全访问。对于基本数据类型（如 <code>int</code>, <code>bool</code>, <code>pointer</code>），使用 <code>std::atomic</code> 通常比 <code>mutex</code> 效率更高，因为它直接在CPU指令级别保证操作的原子性。
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">std::atomic&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">atomic_counter</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">atomic_increment</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i) {
        atomic_counter.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
    }
}
</code></pre>
</li>
<li><strong>内存序</strong>：<code>std::memory_order</code> 允许你控制原子操作周围的非原子内存访问的可见性顺序。这是为了在保证正确性的前提下，追求极致的性能。
<ul>
<li><code>memory_order_seq_cst</code>（顺序一致性）：最强保证，默认选项，性能开销最大。</li>
<li><code>memory_order_acquire</code>/<code>memory_order_release</code>/<code>memory_order_acq_rel</code>：用于实现“同步于”关系。</li>
<li><code>memory_order_relaxed</code>：只保证原子性，不提供同步和顺序保证。</li>
</ul>
</li>
</ul>
<p><strong>除非你是专家，否则请使用 <code>std::atomic</code> 的默认内存序（<code>memory_order_seq_cst</code>）。</strong></p>
<hr/>
<h3 data-id="heading-10">4. 总结与最佳实践</h3>
<ol>
<li><strong>优先使用RAII</strong>：始终使用 <code>std::lock_guard</code>, <code>std::unique_lock</code>, <code>std::scoped_lock</code>，避免手动 <code>lock/unlock</code>。</li>
<li><strong>用互斥量保护数据，而非代码</strong>：清晰地知道哪些数据是共享的，并用最小的锁粒度来保护它。</li>
<li><strong>慎用递归锁</strong>：递归锁通常意味着糟糕的设计。</li>
<li><strong>使用条件变量进行事件等待</strong>：不要使用忙等待（<code>while (!condition) {}</code>），这会浪费CPU资源。</li>
<li><strong>警惕死锁</strong>：使用锁顺序、<code>std::lock</code> 等策略来预防。</li>
<li><strong>性能瓶颈在于锁竞争</strong>：优化方向是减少共享和缩小临界区，而非盲目追求“无锁”。无锁编程极其复杂且容易出错。</li>
<li><strong>简单场景用 <code>atomic</code>，复杂同步用 <code>mutex</code></strong>：对于简单的计数器或标志位，<code>std::atomic</code> 是更好的选择。对于复杂的对象或需要等待条件的情况，使用 <code>mutex</code> 和 <code>condition_variable</code>。</li>
<li><strong>理解工具适用场景</strong>：
<ul>
<li><code>mutex</code>：互斥访问。</li>
<li><code>condition_variable</code>：等待条件成立。</li>
<li><code>semaphore</code>：控制资源池访问。</li>
<li><code>latch/barrier</code>：多线程分阶段协同。</li>
</ul>
</li>
</ol>
<p>通过深入理解这些同步机制的原理、代价和适用场景，你才能写出既正确又高效的多线程C++程序。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南]]></title>    <link>https://juejin.cn/post/7571299394345730090</link>    <guid>https://juejin.cn/post/7571299394345730090</guid>    <pubDate>2025-11-11T14:00:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345730090" data-draft-id="7571258854901399595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-11-11T14:00:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             SpringBoot + MyBatis-Plus + Dynamic-Datasource 读写分离完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:00:54.000Z" title="Tue Nov 11 2025 14:00:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在SpringBoot项目中，使用MyBatis-Plus和Dynamic-Datasource实现读写分离是一种常见且高效的架构选择。下面我将为你详细讲解完整的实现方案，包括环境准备、配置、代码实现以及注意事项。</p>
<h2 data-id="heading-0">1. 读写分离概述与核心概念</h2>
<p>读写分离是一种常见的数据库优化方案，其核心思想是将数据库的写操作（INSERT、UPDATE、DELETE）和读操作（SELECT）分发到不同的数据库节点上。主数据库（Master）负责处理所有写操作，而从数据库（Slave）负责处理读操作，通过数据库的主从复制机制保持数据同步。</p>
<h3 data-id="heading-1">1.1 核心价值</h3>
<ul>
<li><strong>提升并发性能</strong>：将读请求分散到多个从库，减轻主库压力</li>
<li><strong>提高系统可用性</strong>：单个从库故障不影响读服务</li>
<li><strong>优化响应速度</strong>：专库专用，避免读写操作相互阻塞</li>
</ul>
<h3 data-id="heading-2">1.2 技术架构</h3>
<pre><code class="hljs language-markdown" lang="markdown">应用程序 → Dynamic-Datasource → 主库（写操作）
<span class="hljs-code">                     ↓
                   从库（读操作）
</span></code></pre>
<p><em>图：读写分离架构示意图</em></p>
<h2 data-id="heading-3">2. 环境准备与依赖配置</h2>
<h3 data-id="heading-4">2.1 添加Maven依赖</h3>
<p>首先在项目的<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus 启动器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Dynamic-Datasource 启动器（核心依赖） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL 驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 连接池（可选，HikariCP已内置） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p><em>citation:2][citation:3</em></p>
<h3 data-id="heading-5">2.2 配置文件设置</h3>
<p>在<code>application.yml</code>中配置主从数据源：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>  <span class="hljs-comment"># 设置默认数据源为主库</span>
      <span class="hljs-attr">strict:</span> <span class="hljs-literal">false</span>   <span class="hljs-comment"># 是否严格匹配数据源，false时未匹配到指定数据源则使用默认数据源</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-comment"># 主库配置（写操作）</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://master-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">master@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-comment"># 从库配置（读操作）- 支持多个从库</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave1-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://slave2-host:3306/core?useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">readonly</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">slave@123</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      
      <span class="hljs-comment"># 负载均衡策略配置（多个从库时生效）</span>
      <span class="hljs-attr">strategy:</span> 
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 从库负载均衡策略：random(随机)/round_robin(轮询)</span>
      
      <span class="hljs-comment"># 连接池配置（HikariCP）</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">max-pool-size:</span> <span class="hljs-number">20</span>      <span class="hljs-comment"># 最大连接数</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span>           <span class="hljs-comment"># 最小空闲连接</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 连接超时时间(ms)</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>  <span class="hljs-comment"># 空闲连接超时时间(ms)</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span> <span class="hljs-comment"># 连接最大生命周期(ms)</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名转换</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>  <span class="hljs-comment"># 打印SQL日志(调试用)</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>  <span class="hljs-comment"># 主键策略自增</span>
</code></pre>
<p><em>citation:2][citation:6</em></p>
<h2 data-id="heading-6">3. 数据源与MyBatis-Plus配置类</h2>
<h3 data-id="heading-7">3.1 动态数据源自动配置</h3>
<p>Dynamic-Datasource starter已经提供了自动配置，大多数情况下无需额外配置。但如果需要自定义，可以创建配置类：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)  <span class="hljs-comment">// 指定MyBatis mapper接口的扫描路径</span>
public class DataSourceConfig {
    
    <span class="hljs-comment">/**
     * 配置动态数据源
     * Dynamic-Datasource会自动根据application.yml的配置创建数据源
     * 此处可以添加自定义配置
     */</span>
    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.dynamic"</span>)
    public DynamicDataSourceProperties <span class="hljs-built_in">dynamicDataSourceProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DynamicDataSourceProperties</span>();
    }
    
    <span class="hljs-comment">/**
     * 配置MyBatis-Plus拦截器（分页插件等）
     */</span>
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">mybatisPlusInterceptor</span>() {
        <span class="hljs-selector-tag">MybatisPlusInterceptor</span> <span class="hljs-selector-tag">interceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加分页插件</span>
        <span class="hljs-selector-tag">PaginationInnerInterceptor</span> <span class="hljs-selector-tag">paginationInterceptor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">PaginationInnerInterceptor</span>(DbType.MYSQL);
        <span class="hljs-selector-tag">paginationInterceptor</span><span class="hljs-selector-class">.setMaxLimit</span>(<span class="hljs-number">1000</span>L);  <span class="hljs-comment">// 设置最大分页限制</span>
        <span class="hljs-selector-tag">interceptor</span><span class="hljs-selector-class">.addInnerInterceptor</span>(paginationInterceptor);
        
        <span class="hljs-comment">// 可以添加其他插件，如乐观锁插件等</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">interceptor</span>;
    }
}
</code></pre>
<p><em>citation:1][citation:5</em></p>
<h2 data-id="heading-8">4. 业务层实现读写分离</h2>
<h3 data-id="heading-9">4.1 使用@DS注解手动切换数据源</h3>
<p>最直接的方式是在Service层使用<code>@DS</code>注解指定数据源：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-comment">/**
     * 写操作：使用<span class="hljs-doctag">@DS</span>("master")指定主库
     * 注意：写操作建议都使用主库，确保数据一致性
     */</span>
    <span class="hljs-meta">@DS("master")</span>  <span class="hljs-comment">// 指定使用主库</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 添加事务管理</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || StringUtils.isBlank(user.getUsername())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置创建时间</span>
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行插入操作，这里会使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> save(user);
        
        <span class="hljs-comment">// 这里可以添加其他业务逻辑</span>
        log.info(<span class="hljs-string">"创建用户成功，用户ID: {}"</span>, user.getId());
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 读操作：使用<span class="hljs-doctag">@DS</span>("slave")指定从库
     * 框架会根据负载均衡策略选择slave1或slave2
     */</span>
    <span class="hljs-meta">@DS("slave")</span>  <span class="hljs-comment">// 指定使用从库（负载均衡）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 参数校验</span>
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 查询用户信息，这里会使用从库</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);
        
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"未找到对应用户，用户ID: {}"</span>, id);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-comment">/**
     * 批量查询：同样使用从库
     */</span>
    <span class="hljs-meta">@DS("slave")</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">listUsersByCondition</span><span class="hljs-params">(UserQuery query)</span> {
        <span class="hljs-comment">// 构建查询条件</span>
        LambdaQueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        
        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(query.getUsername())) {
            wrapper.like(User::getUsername, query.getUsername());
        }
        
        <span class="hljs-keyword">if</span> (query.getStatus() != <span class="hljs-literal">null</span>) {
            wrapper.eq(User::getStatus, query.getStatus());
        }
        
        <span class="hljs-comment">// 添加排序</span>
        wrapper.orderByDesc(User::getCreateTime);
        
        <span class="hljs-comment">// 执行查询，使用从库</span>
        <span class="hljs-keyword">return</span> list(wrapper);
    }
    
    <span class="hljs-comment">/**
     * 更新操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户信息不完整"</span>);
        }
        
        <span class="hljs-comment">// 设置更新时间</span>
        user.setUpdateTime(LocalDateTime.now());
        
        <span class="hljs-comment">// 执行更新，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> updateById(user);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"更新用户成功，用户ID: {}"</span>, user.getId());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"更新用户失败，用户ID: {}"</span>, user.getId());
        }
        
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">/**
     * 删除操作：必须使用主库
     */</span>
    <span class="hljs-meta">@DS("master")</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span> || id &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不合法"</span>);
        }
        
        <span class="hljs-comment">// 执行删除，使用主库</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> removeById(id);
        
        <span class="hljs-keyword">if</span> (result) {
            log.info(<span class="hljs-string">"删除用户成功，用户ID: {}"</span>, id);
        } <span class="hljs-keyword">else</span> {
            log.warn(<span class="hljs-string">"删除用户失败，用户ID: {}"</span>, id);
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p><em>citation:2][citation:8</em></p>
<h3 data-id="heading-10">4.2 基于AOP的自动数据源切换（推荐）</h3>
<p>对于大型项目，手动添加<code>@DS</code>注解比较繁琐，可以通过AOP自动根据方法类型切换数据源：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceAspect {
    
    <span class="hljs-comment">/**
     * 定义切点：拦截Service层的所有方法
     */</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service..*.*(..))"</span>)
    public void <span class="hljs-built_in">servicePointcut</span>() {}
    
    <span class="hljs-comment">/**
     * 前置通知：在方法执行前选择数据源
     */</span>
    <span class="hljs-variable">@Before</span>(<span class="hljs-string">"servicePointcut()"</span>)
    public void <span class="hljs-built_in">before</span>(JoinPoint joinPoint) {
        <span class="hljs-comment">// 获取方法名</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.getName</span>();
        
        <span class="hljs-comment">// 根据方法名前缀判断是读操作还是写操作</span>
        <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isReadOperation</span>(methodName)) {
            <span class="hljs-comment">// 读操作使用从库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"slave"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到从库，方法名: {}"</span>, methodName);
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">// 写操作使用主库</span>
            <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.push</span>(<span class="hljs-string">"master"</span>);
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"切换数据源到主库，方法名: {}"</span>, methodName);
        }
    }
    
    <span class="hljs-comment">/**
     * 后置通知：清理数据源上下文
     */</span>
    @<span class="hljs-selector-tag">After</span>(<span class="hljs-string">"servicePointcut()"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">after</span>() {
        <span class="hljs-selector-tag">DynamicDataSourceContextHolder</span><span class="hljs-selector-class">.clear</span>();
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"清除数据源上下文"</span>);
    }
    
    <span class="hljs-comment">/**
     * 判断是否为读操作
     * 可以根据方法名前缀进行判断
     */</span>
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">isReadOperation</span>(String methodName) {
        <span class="hljs-comment">// 常见的读操作方法前缀</span>
        <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">readPrefixes</span> = {"<span class="hljs-selector-tag">get</span>", "<span class="hljs-selector-tag">select</span>", "<span class="hljs-selector-tag">list</span>", "<span class="hljs-selector-tag">query</span>", "<span class="hljs-selector-tag">find</span>", "<span class="hljs-selector-tag">search</span>", "<span class="hljs-selector-tag">count</span>", "<span class="hljs-selector-tag">check</span>"};
        
        <span class="hljs-selector-tag">for</span> (String <span class="hljs-attribute">prefix </span>: readPrefixes) {
            <span class="hljs-selector-tag">if</span> (methodName.<span class="hljs-built_in">startsWith</span>(prefix)) {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">true</span>;
            }
        }
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">false</span>;
    }
}
</code></pre>
<p><em>citation:3][citation:7</em></p>
<p>使用AOP后，Service层的代码可以简化为：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-meta">@Service</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl&lt;UserMapper</span>, <span class="hljs-title">User&gt;</span> <span class="hljs-title">implements</span> <span class="hljs-title">UserService</span> </span>{
    
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-type">Exception</span>.<span class="hljs-keyword">class</span>)
    <span class="hljs-meta">@Override</span>
    public boolean createUser(<span class="hljs-type">User</span> user) {
        <span class="hljs-comment">// 自动使用主库（AOP根据方法名判断）</span>
        user.setCreateTime(<span class="hljs-type">LocalDateTime</span>.now());
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">User</span> getUserById(<span class="hljs-type">Long</span> id) {
        <span class="hljs-comment">// 自动使用从库（AOP根据方法名前缀"get"判断）</span>
        <span class="hljs-keyword">return</span> getById(id);
    }
    
    <span class="hljs-comment">// 其他方法无需添加@DS注解，由AOP自动处理</span>
}
</code></pre>
<h2 data-id="heading-11">5. 事务处理策略</h2>
<p>事务处理是读写分离中的关键问题，需要特别注意：</p>
<h3 data-id="heading-12">5.1 单数据源事务</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class OrderServiceImpl extends ServiceImpl&lt;OrderMapper, Order&gt; implements OrderService {
    
    <span class="hljs-comment">/**
     * 单数据源事务：所有操作都在主库执行
     * 使用@DS("master")确保即使有AOP配置也使用主库
     */</span>
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)  <span class="hljs-comment">// 显式指定主库</span>
    <span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)  <span class="hljs-comment">// 声明式事务</span>
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">createOrder</span>(Order order) {
        <span class="hljs-comment">// 1. 保存订单主信息（主库）</span>
        <span class="hljs-selector-tag">save</span>(order);
        
        <span class="hljs-comment">// 2. 更新库存（主库）</span>
        <span class="hljs-selector-tag">updateStock</span>(order);
        
        <span class="hljs-comment">// 3. 记录操作日志（主库）</span>
        <span class="hljs-selector-tag">logOrderOperation</span>(order);
        
        <span class="hljs-comment">// 如果任何一步失败，整个事务回滚</span>
    }
    
    <span class="hljs-comment">/**
     * 只读事务：可以指定从库
     */</span>
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    @<span class="hljs-selector-tag">Transactional</span>(readOnly = true)  <span class="hljs-comment">// 只读事务，有优化效果</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">getOrderDetail</span>(Long orderId) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">getById</span>(orderId);
    }
}
</code></pre>
<h3 data-id="heading-13">5.2 多数据源事务处理</h3>
<p>对于涉及多个数据源的复杂事务，需要使用分布式事务解决方案：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTransactionService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-comment">/**
     * 使用<span class="hljs-doctag">@DSTransactional</span>实现多数据源分布式事务
     * 注意：需要集成Seata等分布式事务框架
     */</span>
    <span class="hljs-comment">// @DSTransactional  // 分布式事务注解（需要额外配置）</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(Order order, User user)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 用户操作（主库）</span>
            userService.updateUser(user);
            
            <span class="hljs-comment">// 2. 订单操作（主库）</span>
            orderService.createOrder(order);
            
            <span class="hljs-comment">// 模拟业务异常</span>
            <span class="hljs-keyword">if</span> (order.getAmount() == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单金额不能为空"</span>);
            }
            
            log.info(<span class="hljs-string">"下单成功"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"下单失败，已回滚"</span>, e);
            <span class="hljs-keyword">throw</span> e;  <span class="hljs-comment">// 抛出异常触发回滚</span>
        }
    }
}
</code></pre>
<p><em>citation:7</em></p>
<h2 data-id="heading-14">6. 高级功能与优化策略</h2>
<h3 data-id="heading-15">6.1 多从库负载均衡</h3>
<p>当配置多个从库时，Dynamic-Datasource支持多种负载均衡策略：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-comment"># 主库配置...</span>
        <span class="hljs-attr">slave1:</span>
          <span class="hljs-comment"># 从库1配置...</span>
        <span class="hljs-attr">slave2:</span>
          <span class="hljs-comment"># 从库2配置...</span>
        <span class="hljs-attr">slave3:</span>
          <span class="hljs-comment"># 从库3配置...</span>
      <span class="hljs-attr">strategy:</span>
        <span class="hljs-attr">slave:</span> <span class="hljs-string">round_robin</span>  <span class="hljs-comment"># 负载均衡策略</span>
        <span class="hljs-comment"># 可选值:</span>
        <span class="hljs-comment"># random - 随机选择（默认）</span>
        <span class="hljs-comment"># round_robin - 轮询</span>
        <span class="hljs-comment"># weight_round_robin - 加权轮询（需要额外配置权重）</span>
</code></pre>
<p>负载均衡策略对比：</p>

























<table><thead><tr><th>策略类型</th><th>描述</th><th>适用场景</th></tr></thead><tbody><tr><td>random</td><td>随机选择从库</td><td>简单的读负载均衡</td></tr><tr><td>round_robin</td><td>轮询选择从库</td><td>从库配置相近，需要均匀分布</td></tr><tr><td>weight_round_robin</td><td>根据权重选择</td><td>从库配置不同，按性能分配负载</td></tr></tbody></table>
<p><em>citation:3][citation:7</em></p>
<h3 data-id="heading-16">6.2 健康检查与故障转移</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DataSourceHealthCheck {
    
    <span class="hljs-variable">@Autowired</span>
    private DataSource dataSource;
    
    <span class="hljs-comment">/**
     * 定时检查从库健康状态
     */</span>
    <span class="hljs-variable">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>)  <span class="hljs-comment">// 每分钟执行一次</span>
    public void <span class="hljs-built_in">checkSlaveHealth</span>() {
        <span class="hljs-comment">// 这里可以实现从库健康检查逻辑</span>
        <span class="hljs-comment">// 如果某个从库不可用，可以动态将其从负载均衡池中移除</span>
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"执行从库健康检查..."</span>);
        <span class="hljs-comment">// 实际实现中可以使用JDBC测试连接或查询数据库状态</span>
    }
    
    <span class="hljs-comment">/**
     * 获取从库同步延迟
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Long</span> <span class="hljs-selector-tag">getReplicationDelay</span>(String slaveName) {
        <span class="hljs-comment">// 执行SQL查询从库同步状态</span>
        <span class="hljs-comment">// SHOW SLAVE STATUS 可以获取Seconds_Behind_Master等信息</span>
        <span class="hljs-comment">// 如果延迟过大，可以临时将该从库标记为不可用</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">L</span>;  <span class="hljs-comment">// 返回延迟秒数</span>
    }
}
</code></pre>
<p><em>citation:2</em></p>
<h2 data-id="heading-17">7. 测试与验证</h2>
<h3 data-id="heading-18">7.1 单元测试</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@SpringBootTest</span>
<span class="hljs-keyword">@Slf</span>4j
class ReadWriteSeparationTest {
    
    <span class="hljs-keyword">@Autowired</span>
    private UserService userService;
    
    <span class="hljs-comment">/**
     * 测试写操作（应该路由到主库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testWriteOperation() {
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setUsername</span>("testUser");
        user<span class="hljs-selector-class">.setEmail</span>("test@example.com");
        
        boolean result = userService<span class="hljs-selector-class">.createUser</span>(user);
        
        <span class="hljs-built_in">assertTrue</span>(result);
        log<span class="hljs-selector-class">.info</span>("写操作测试通过，应路由到主库");
    }
    
    <span class="hljs-comment">/**
     * 测试读操作（应该路由到从库）
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testReadOperation() {
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        
        <span class="hljs-built_in">assertNotNull</span>(user);
        log<span class="hljs-selector-class">.info</span>("读操作测试通过，应路由到从库");
    }
    
    <span class="hljs-comment">/**
     * 测试事务内的数据源选择
     */</span>
    <span class="hljs-keyword">@Test</span>
    void testTransactionalOperation() {
        <span class="hljs-comment">// 测试事务方法，应始终使用主库</span>
        User user = userService<span class="hljs-selector-class">.getUserById</span>(<span class="hljs-number">1</span>L);
        <span class="hljs-built_in">assertNotNull</span>(user);
        
        log<span class="hljs-selector-class">.info</span>("事务内操作测试完成");
    }
}
</code></pre>
<h3 data-id="heading-19">7.2 验证数据源路由</h3>
<p>在<code>application.yml</code>中开启SQL日志，验证读写分离是否生效：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开启MyBatis SQL日志</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">com.example.mapper:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Mapper接口的包路径</span>
    <span class="hljs-attr">com.baomidou.dynamic.datasource:</span> <span class="hljs-string">debug</span>  <span class="hljs-comment"># Dynamic-Datasource日志</span>
</code></pre>
<p>观察控制台输出，应该能看到类似日志：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-operator">|</span> Master DataSource  <span class="hljs-operator">|</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> ...
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-11</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span> <span class="hljs-operator">|</span> Slave DataSource   <span class="hljs-operator">|</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> ...
</code></pre>
<p><em>citation:3</em></p>
<h2 data-id="heading-20">8. 生产环境注意事项</h2>
<h3 data-id="heading-21">8.1 主从同步延迟处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalReadService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 对于一致性要求高的读操作，强制走主库
     */</span>
    <span class="hljs-meta">@DS(<span class="hljs-string">"master"</span>)</span>  <span class="hljs-comment">// 强制使用主库，避免读取旧数据</span>
    <span class="hljs-keyword">public</span> User getCriticalUserInfo(<span class="hljs-built_in">Long</span> userId) {
        <span class="hljs-comment">// 例如：账户余额、订单状态等关键信息</span>
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-comment">/**
     * 检查数据是否已同步
     */</span>
    <span class="hljs-keyword">public</span> boolean waitForReplication(<span class="hljs-built_in">Long</span> userId, int maxWaitSeconds) {
        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; maxWaitSeconds; i++) {
            User masterUser = getFromMaster(userId);
            User slaveUser = getFromSlave(userId);
            
            <span class="hljs-keyword">if</span> (Objects.equals(masterUser, slaveUser)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 数据已同步</span>
            }
            
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 等待1秒</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 同步超时</span>
    }
}
</code></pre>
<h3 data-id="heading-22">8.2 监控与告警</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 连接池监控配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">druid:</span>
        <span class="hljs-comment"># 开启监控统计</span>
        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,log4j</span>
        <span class="hljs-attr">web-stat-filter:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">stat-view-servlet:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
          <span class="hljs-attr">url-pattern:</span> <span class="hljs-string">/druid/*</span>
          <span class="hljs-attr">reset-enable:</span> <span class="hljs-literal">false</span>
          <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span>
          <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span>
</code></pre>
<h2 data-id="heading-23">9. 常见问题与解决方案</h2>
<h3 data-id="heading-24">9.1 事务内数据源切换失效</h3>
<p><strong>问题</strong>：在<code>@Transactional</code>方法内，数据源在方法开始时确定，方法内部调用无法切换数据源。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Service</span>
public class TransactionalService {
    
    <span class="hljs-variable">@Autowired</span>
    private ApplicationContext applicationContext;
    
    <span class="hljs-variable">@Transactional</span>
    public void <span class="hljs-built_in">transactionalMethod</span>() {
        <span class="hljs-comment">// 方法内需要切换数据源时，通过代理对象调用</span>
        <span class="hljs-selector-tag">TransactionalService</span> <span class="hljs-selector-tag">self</span> = <span class="hljs-selector-tag">applicationContext</span><span class="hljs-selector-class">.getBean</span>(TransactionalService.class);
        
        <span class="hljs-comment">// 通过代理对象调用，可以正常切换数据源</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.readOperation</span>();  <span class="hljs-comment">// 使用从库</span>
        <span class="hljs-selector-tag">self</span><span class="hljs-selector-class">.writeOperation</span>();  <span class="hljs-comment">// 使用主库</span>
    }
    
    @<span class="hljs-selector-tag">DS</span>(<span class="hljs-string">"slave"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">readOperation</span>() {
        <span class="hljs-comment">// 读操作</span>
    }
    
    <span class="hljs-variable">@DS</span>(<span class="hljs-string">"master"</span>)
    public void <span class="hljs-built_in">writeOperation</span>() {
        <span class="hljs-comment">// 写操作</span>
    }
}
</code></pre>
<h3 data-id="heading-25">9.2 动态增减数据源</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSourceService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">DynamicDataSourceProvider</span> dataSourceProvider;
    
    <span class="hljs-comment">/**
     * 运行时动态添加数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName, DataSourceProperty property</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">addDataSource</span>(dataSourceName, property);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态添加数据源: {}"</span>, dataSourceName);
    }
    
    <span class="hljs-comment">/**
     * 运行时移除数据源
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSourceName</span>) {
        <span class="hljs-title class_">DynamicDataSourceContextHolder</span>.<span class="hljs-title function_">removeDataSource</span>(dataSourceName);
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"动态移除数据源: {}"</span>, dataSourceName);
    }
}
</code></pre>
<h2 data-id="heading-26">总结</h2>
<p>通过SpringBoot + MyBatis-Plus + Dynamic-Datasource实现读写分离，可以显著提升数据库读性能和高可用性。关键点包括：</p>
<ol>
<li><strong>正确配置</strong>：确保主从数据源配置正确，负载均衡策略合理</li>
<li><strong>合理使用注解</strong>：在适当的方法上使用<code>@DS</code>注解或通过AOP自动切换</li>
<li><strong>事务管理</strong>：注意事务内的数据源行为，关键操作强制走主库</li>
<li><strong>监控告警</strong>：建立完善的监控体系，及时发现主从延迟等问题</li>
<li><strong>故障处理</strong>：实现从库故障自动转移和恢复机制</li>
</ol>
<p>这种架构在读写比例高的应用中能带来显著的性能提升，但也需要处理好主从同步延迟等一致性问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day9: CameraX 基础集成]]></title>    <link>https://juejin.cn/post/7571299394345435178</link>    <guid>https://juejin.cn/post/7571299394345435178</guid>    <pubDate>2025-11-11T12:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571299394345435178" data-draft-id="7571102074039238697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day9: CameraX 基础集成"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-11T12:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day9: CameraX 基础集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T12:16:40.000Z" title="Tue Nov 11 2025 12:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7570534000718495807" target="_blank" title="https://juejin.cn/post/7570534000718495807">上一篇:『OpenGL学习滤镜相机』- Day8: 多重纹理与混合</a></p>
<p>Github: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest">OpenGLTest</a></p>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解 CameraX 架构和核心概念</li>
<li>掌握相机权限的申请和处理</li>
<li>学习 PreviewView 的使用</li>
<li>实现相机预览功能</li>
<li>了解生命周期绑定机制</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3cffb78f4b400aa6640201f07f882b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763468200&amp;x-signature=aRTmiieyDTszq9fB2fam%2BEg6y98%3D" alt="Day9.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. CameraX 简介</h3>
<p><strong>CameraX</strong> 是 Google 推出的 Jetpack 库，用于简化 Android 相机开发。</p>
<h4 data-id="heading-3">为什么使用 CameraX？</h4>

























<table><thead><tr><th>传统 Camera2 API</th><th>CameraX</th></tr></thead><tbody><tr><td>代码复杂，API 繁琐</td><td>简单易用，代码量少</td></tr><tr><td>需要处理设备差异</td><td>自动处理兼容性问题</td></tr><tr><td>生命周期管理困难</td><td>自动绑定生命周期</td></tr><tr><td>预览、拍照、录像需要大量代码</td><td>几行代码即可实现</td></tr></tbody></table>
<h4 data-id="heading-4">CameraX 的优势</h4>
<ul>
<li>✅ <strong>简单易用</strong>：几行代码实现预览和拍照</li>
<li>✅ <strong>兼容性好</strong>：自动处理不同设备的差异</li>
<li>✅ <strong>生命周期感知</strong>：自动管理相机的打开和关闭</li>
<li>✅ <strong>向后兼容</strong>：支持 Android 5.0+（API 21）</li>
<li>✅ <strong>扩展支持</strong>：美颜、夜景、HDR 等厂商扩展</li>
</ul>
<h3 data-id="heading-5">2. CameraX 架构</h3>
<h4 data-id="heading-6">核心组件</h4>
<pre><code class="hljs language-scss" lang="scss">CameraX 架构
├── Use Cases (用例)
│   ├── Preview (预览)
│   ├── ImageCapture (拍照)
│   ├── ImageAnalysis (图像分析)
│   └── VideoCapture (录像)
├── CameraSelector (相机选择器)
│   ├── LENS_FACING_BACK (后置)
│   └── LENS_FACING_FRONT (前置)
├── ProcessCameraProvider (相机提供者)
│   └── 管理相机的生命周期
└── PreviewView (预览视图)
    └── 显示相机预览画面
</code></pre>
<h4 data-id="heading-7">工作流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 获取 ProcessCameraProvider
   ↓
<span class="hljs-bullet">2.</span> 创建 Use Cases (Preview, ImageCapture 等)
   ↓
<span class="hljs-bullet">3.</span> 选择相机 (CameraSelector)
   ↓
<span class="hljs-bullet">4.</span> 绑定到生命周期 (bindToLifecycle)
   ↓
<span class="hljs-bullet">5.</span> 显示预览 / 拍照 / 分析
</code></pre>
<h3 data-id="heading-8">3. 相机权限处理</h3>
<h4 data-id="heading-9">3.1 在 AndroidManifest.xml 中声明权限</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 相机权限（必需） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CAMERA"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 存储权限（拍照保存需要） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>
    <span class="hljs-attr">android:maxSdkVersion</span>=<span class="hljs-string">"28"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 相机特性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-feature</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.hardware.camera"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-feature</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.hardware.camera.autofocus"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-10">3.2 运行时权限申请（Android 6.0+）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day09Activity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> REQUEST_CODE_PERMISSIONS = <span class="hljs-number">10</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> REQUIRED_PERMISSIONS = arrayOf(Manifest.permission.CAMERA)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
            startCamera()
        } <span class="hljs-keyword">else</span> {
            ActivityCompat.requestPermissions(
                <span class="hljs-keyword">this</span>, REQUIRED_PERMISSIONS, REQUEST_CODE_PERMISSIONS
            )
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">allPermissionsGranted</span><span class="hljs-params">()</span></span> = REQUIRED_PERMISSIONS.all {
        ContextCompat.checkSelfPermission(
            baseContext, it
        ) == PackageManager.PERMISSION_GRANTED
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRequestPermissionsResult</span><span class="hljs-params">(
        requestCode: <span class="hljs-type">Int</span>,
        permissions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">String</span>&gt;,
        grantResults: <span class="hljs-type">IntArray</span>
    )</span></span> {
        <span class="hljs-keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults)
        <span class="hljs-keyword">if</span> (requestCode == REQUEST_CODE_PERMISSIONS) {
            <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
                startCamera()
            } <span class="hljs-keyword">else</span> {
                Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"权限被拒绝"</span>, Toast.LENGTH_SHORT).show()
                finish()
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-11">4. 实现相机预览</h3>
<h4 data-id="heading-12">4.1 布局文件</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>
    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 相机预览视图 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.camera.view.PreviewView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/preview_view"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">app:layout_constraintBottom_toTopOf</span>=<span class="hljs-string">"@id/control_panel"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- 控制面板 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/control_panel"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:background</span>=<span class="hljs-string">"#80000000"</span>
        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>
        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">"16dp"</span>
        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span>
        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 拍照按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_capture"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"拍照"</span> /&gt;</span>

        <span class="hljs-comment">&lt;!-- 切换相机按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_switch_camera"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"8dp"</span>
            <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"切换相机"</span> /&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">4.2 启动相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 获取 ProcessCameraProvider 的 Future</span>
    <span class="hljs-keyword">val</span> cameraProviderFuture = ProcessCameraProvider.getInstance(<span class="hljs-keyword">this</span>)

    cameraProviderFuture.addListener({
        <span class="hljs-comment">// 获取 CameraProvider</span>
        <span class="hljs-keyword">val</span> cameraProvider: ProcessCameraProvider = cameraProviderFuture.<span class="hljs-keyword">get</span>()

        <span class="hljs-comment">// 创建 Preview Use Case</span>
        <span class="hljs-keyword">val</span> preview = Preview.Builder()
            .build()
            .also {
                <span class="hljs-comment">// 设置 Surface Provider</span>
                it.setSurfaceProvider(previewView.surfaceProvider)
            }

        <span class="hljs-comment">// 选择后置相机</span>
        <span class="hljs-keyword">val</span> cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 解绑之前的 Use Cases</span>
            cameraProvider.unbindAll()

            <span class="hljs-comment">// 绑定 Use Cases 到生命周期</span>
            cameraProvider.bindToLifecycle(
                <span class="hljs-keyword">this</span>,      <span class="hljs-comment">// LifecycleOwner</span>
                cameraSelector,
                preview
            )

        } <span class="hljs-keyword">catch</span> (exc: Exception) {
            Log.e(TAG, <span class="hljs-string">"Use case binding failed"</span>, exc)
        }

    }, ContextCompat.getMainExecutor(<span class="hljs-keyword">this</span>))
}
</code></pre>
<h3 data-id="heading-14">5. CameraSelector 详解</h3>
<h4 data-id="heading-15">5.1 选择前置/后置相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 后置相机</span>
<span class="hljs-keyword">val</span> backCameraSelector = CameraSelector.DEFAULT_BACK_CAMERA

<span class="hljs-comment">// 前置相机</span>
<span class="hljs-keyword">val</span> frontCameraSelector = CameraSelector.DEFAULT_FRONT_CAMERA

<span class="hljs-comment">// 自定义选择器</span>
<span class="hljs-keyword">val</span> customSelector = CameraSelector.Builder()
    .requireLensFacing(CameraSelector.LENS_FACING_BACK)
    .build()
</code></pre>
<h4 data-id="heading-16">5.2 切换相机</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lensFacing = CameraSelector.LENS_FACING_BACK

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 切换前后摄像头</span>
    lensFacing = <span class="hljs-keyword">if</span> (lensFacing == CameraSelector.LENS_FACING_BACK) {
        CameraSelector.LENS_FACING_FRONT
    } <span class="hljs-keyword">else</span> {
        CameraSelector.LENS_FACING_BACK
    }
    
    <span class="hljs-comment">// 重新启动相机</span>
    startCamera()
}
</code></pre>
<h3 data-id="heading-17">6. 拍照功能</h3>
<h4 data-id="heading-18">6.1 创建 ImageCapture Use Case</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 ImageCapture</span>
imageCapture = ImageCapture.Builder()
    .setCaptureMode(ImageCapture.CAPTURE_MODE_MINIMIZE_LATENCY)
    .build()

<span class="hljs-comment">// 绑定时同时绑定 Preview 和 ImageCapture</span>
cameraProvider.bindToLifecycle(
    <span class="hljs-keyword">this</span>,
    cameraSelector,
    preview,
    imageCapture  <span class="hljs-comment">// 添加拍照功能</span>
)
</code></pre>
<h4 data-id="heading-19">6.2 拍照并保存</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> imageCapture = imageCapture ?: <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 创建保存文件</span>
    <span class="hljs-keyword">val</span> photoFile = File(
        getOutputDirectory(),
        SimpleDateFormat(FILENAME_FORMAT, Locale.US)
            .format(System.currentTimeMillis()) + <span class="hljs-string">".jpg"</span>
    )

    <span class="hljs-comment">// 配置输出选项</span>
    <span class="hljs-keyword">val</span> outputOptions = ImageCapture.OutputFileOptions.Builder(photoFile).build()

    <span class="hljs-comment">// 拍照</span>
    imageCapture.takePicture(
        outputOptions,
        ContextCompat.getMainExecutor(<span class="hljs-keyword">this</span>),
        <span class="hljs-keyword">object</span> : ImageCapture.OnImageSavedCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(exc: <span class="hljs-type">ImageCaptureException</span>)</span></span> {
                Log.e(TAG, <span class="hljs-string">"拍照失败: <span class="hljs-subst">${exc.message}</span>"</span>, exc)
            }

            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onImageSaved</span><span class="hljs-params">(output: <span class="hljs-type">ImageCapture</span>.<span class="hljs-type">OutputFileResults</span>)</span></span> {
                <span class="hljs-keyword">val</span> msg = <span class="hljs-string">"拍照成功: <span class="hljs-subst">${photoFile.absolutePath}</span>"</span>
                Toast.makeText(baseContext, msg, Toast.LENGTH_SHORT).show()
                Log.d(TAG, msg)
            }
        }
    )
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOutputDirectory</span><span class="hljs-params">()</span></span>: File {
    <span class="hljs-keyword">val</span> mediaDir = externalMediaDirs.firstOrNull()?.let {
        File(it, resources.getString(R.string.app_name)).apply { mkdirs() }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (mediaDir != <span class="hljs-literal">null</span> &amp;&amp; mediaDir.exists())
        mediaDir <span class="hljs-keyword">else</span> filesDir
}
</code></pre>
<h3 data-id="heading-20">7. PreviewView 配置</h3>
<h4 data-id="heading-21">7.1 缩放模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 填充整个视图（可能裁剪）</span>
previewView.scaleType = PreviewView.ScaleType.FILL_CENTER

<span class="hljs-comment">// 适应视图大小（可能有黑边）</span>
previewView.scaleType = PreviewView.ScaleType.FIT_CENTER
</code></pre>
<h4 data-id="heading-22">7.2 实现模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 SurfaceView（性能更好）</span>
previewView.implementationMode = PreviewView.ImplementationMode.PERFORMANCE

<span class="hljs-comment">// 使用 TextureView（兼容性更好）</span>
previewView.implementationMode = PreviewView.ImplementationMode.COMPATIBLE
</code></pre>
<h3 data-id="heading-23">8. 生命周期管理</h3>
<p>CameraX 会自动管理相机的生命周期：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CameraX 自动处理</span>
<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResume</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onResume()
    <span class="hljs-comment">// 相机自动恢复（如果已绑定）</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPause</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onPause()
    <span class="hljs-comment">// 相机自动暂停</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onDestroy()
    <span class="hljs-comment">// 相机自动释放</span>
}
</code></pre>
<p><strong>注意</strong>：使用 <code>bindToLifecycle()</code> 时，CameraX 会自动处理相机的打开、关闭和暂停。</p>
<h3 data-id="heading-24">9. 相机配置选项</h3>
<h4 data-id="heading-25">9.1 分辨率配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetResolution(Size(<span class="hljs-number">1280</span>, <span class="hljs-number">720</span>))  <span class="hljs-comment">// 设置目标分辨率</span>
    .build()
</code></pre>
<h4 data-id="heading-26">9.2 宽高比配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetAspectRatio(AspectRatio.RATIO_16_9)  <span class="hljs-comment">// 16:9</span>
    .build()
</code></pre>
<h4 data-id="heading-27">9.3 旋转配置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetRotation(Surface.ROTATION_0)  <span class="hljs-comment">// 设置目标旋转角度</span>
    .build()
</code></pre>
<h3 data-id="heading-28">10. 错误处理</h3>
<h4 data-id="heading-29">10.1 常见错误</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">try</span> {
    cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
} <span class="hljs-keyword">catch</span> (exc: Exception) {
    <span class="hljs-keyword">when</span> (exc) {
        <span class="hljs-keyword">is</span> CameraInfoUnavailableException -&gt; {
            Log.e(TAG, <span class="hljs-string">"相机信息不可用"</span>)
        }
        <span class="hljs-keyword">is</span> IllegalArgumentException -&gt; {
            Log.e(TAG, <span class="hljs-string">"Use Case 绑定参数错误"</span>)
        }
        <span class="hljs-keyword">else</span> -&gt; {
            Log.e(TAG, <span class="hljs-string">"Use Case 绑定失败"</span>, exc)
        }
    }
}
</code></pre>
<h4 data-id="heading-30">10.2 检查相机可用性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasCameraPermission</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> ContextCompat.checkSelfPermission(
        <span class="hljs-keyword">this</span>,
        Manifest.permission.CAMERA
    ) == PackageManager.PERMISSION_GRANTED
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hasCamera</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> packageManager.hasSystemFeature(PackageManager.FEATURE_CAMERA_ANY)
}
</code></pre>
<h2 data-id="heading-31">💻 代码实践</h2>
<h3 data-id="heading-32">今日任务</h3>
<p>实现一个简单的相机预览应用：</p>
<ol>
<li><strong>权限申请</strong>：请求相机权限</li>
<li><strong>相机预览</strong>：使用 PreviewView 显示实时画面</li>
<li><strong>拍照功能</strong>：点击按钮拍照并保存</li>
<li><strong>切换相机</strong>：前置/后置相机切换</li>
</ol>
<h3 data-id="heading-33">实现效果</h3>
<ul>
<li>📷 实时相机预览</li>
<li>📸 拍照并保存到相册</li>
<li>🔄 前后摄像头切换</li>
<li>⚙️ 自动处理生命周期</li>
</ul>
<h3 data-id="heading-34">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day09Activity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> previewView: PreviewView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> imageCapture: ImageCapture? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lensFacing = CameraSelector.LENS_FACING_BACK

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_day09)

        previewView = findViewById(R.id.preview_view)

        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-keyword">if</span> (allPermissionsGranted()) {
            startCamera()
        } <span class="hljs-keyword">else</span> {
            requestPermissions()
        }

        <span class="hljs-comment">// 拍照按钮</span>
        findViewById&lt;Button&gt;(R.id.btn_capture).setOnClickListener {
            takePhoto()
        }

        <span class="hljs-comment">// 切换相机按钮</span>
        findViewById&lt;Button&gt;(R.id.btn_switch_camera).setOnClickListener {
            switchCamera()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现相机启动逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现拍照逻辑</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 实现切换相机逻辑</span>
    }
}
</code></pre>
<h2 data-id="heading-35">🧪 练习任务</h2>
<h3 data-id="heading-36">基础任务</h3>
<ol>
<li>✅ 实现相机权限申请</li>
<li>✅ 实现相机预览功能</li>
<li>✅ 实现拍照并保存到相册</li>
</ol>
<h3 data-id="heading-37">进阶任务</h3>
<ol>
<li>📊 显示拍照成功的缩略图</li>
<li>🎨 添加拍照动画效果（闪光）</li>
<li>📏 支持捏合缩放（Pinch to Zoom）</li>
<li>🔦 添加闪光灯控制</li>
</ol>
<h3 data-id="heading-38">挑战任务</h3>
<ol>
<li>🎬 实现录像功能（VideoCapture）</li>
<li>📐 添加网格线辅助构图</li>
<li>💾 实现连拍功能</li>
<li>🖼️ 支持不同宽高比切换（4:3, 16:9, 1:1）</li>
</ol>
<h2 data-id="heading-39">📖 知识点总结</h2>
<h3 data-id="heading-40">CameraX 核心概念</h3>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Use Case</strong></td><td>相机的使用场景（预览、拍照、分析、录像）</td></tr><tr><td><strong>CameraSelector</strong></td><td>选择使用哪个相机（前置/后置）</td></tr><tr><td><strong>ProcessCameraProvider</strong></td><td>管理相机生命周期的提供者</td></tr><tr><td><strong>PreviewView</strong></td><td>显示相机预览的视图</td></tr><tr><td><strong>LifecycleOwner</strong></td><td>生命周期拥有者（通常是 Activity）</td></tr></tbody></table>
<h3 data-id="heading-41">Use Cases 对比</h3>






























<table><thead><tr><th>Use Case</th><th>用途</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Preview</strong></td><td>实时预览</td><td>相机取景</td></tr><tr><td><strong>ImageCapture</strong></td><td>拍照</td><td>拍摄照片</td></tr><tr><td><strong>ImageAnalysis</strong></td><td>图像分析</td><td>二维码扫描、人脸识别</td></tr><tr><td><strong>VideoCapture</strong></td><td>录像</td><td>录制视频</td></tr></tbody></table>
<h3 data-id="heading-42">最佳实践</h3>
<ol>
<li>✅ <strong>使用 bindToLifecycle()</strong>：自动管理相机生命周期</li>
<li>✅ <strong>在主线程使用 CameraX API</strong>：避免线程问题</li>
<li>✅ <strong>复用 CameraProvider</strong>：不要频繁获取</li>
<li>✅ <strong>处理配置变更</strong>：屏幕旋转时正确更新</li>
<li>✅ <strong>及时解绑 Use Cases</strong>：切换相机前调用 <code>unbindAll()</code></li>
</ol>
<h2 data-id="heading-43">🐛 常见问题</h2>
<h3 data-id="heading-44">Q1: 相机预览画面是黑色的？</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>权限未授予</li>
<li>PreviewView 未正确设置 SurfaceProvider</li>
<li>Use Case 未绑定到生命周期</li>
</ol>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 确认权限已授予</span>
<span class="hljs-keyword">if</span> (!allPermissionsGranted()) {
    requestPermissions()
    <span class="hljs-keyword">return</span>
}

<span class="hljs-comment">// 2. 正确设置 SurfaceProvider</span>
preview.setSurfaceProvider(previewView.surfaceProvider)

<span class="hljs-comment">// 3. 确保绑定到生命周期</span>
cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
</code></pre>
<h3 data-id="heading-45">Q2: 应用崩溃，提示 "Camera is being used"？</h3>
<p><strong>原因</strong>：同一个相机被多次绑定。</p>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 绑定前先解绑所有 Use Cases</span>
cameraProvider.unbindAll()
cameraProvider.bindToLifecycle(<span class="hljs-keyword">this</span>, cameraSelector, preview)
</code></pre>
<h3 data-id="heading-46">Q3: 切换前后相机时闪烁？</h3>
<p><strong>原因</strong>：切换时没有正确处理。</p>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
    lensFacing = <span class="hljs-keyword">if</span> (lensFacing == CameraSelector.LENS_FACING_BACK) {
        CameraSelector.LENS_FACING_FRONT
    } <span class="hljs-keyword">else</span> {
        CameraSelector.LENS_FACING_BACK
    }
    
    <span class="hljs-comment">// 重新启动相机（会自动解绑旧的）</span>
    startCamera()
}
</code></pre>
<h3 data-id="heading-47">Q4: 拍照的图片方向不对？</h3>
<p>CameraX 会自动处理图片旋转，但如果遇到问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> imageCapture = ImageCapture.Builder()
    .setTargetRotation(previewView.display.rotation)  <span class="hljs-comment">// 设置旋转角度</span>
    .build()
</code></pre>
<h2 data-id="heading-48">🔗 参考资料</h2>
<h3 data-id="heading-49">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax" target="_blank" title="https://developer.android.com/training/camerax" ref="nofollow noopener noreferrer">CameraX 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax%2Farchitecture" target="_blank" title="https://developer.android.com/training/camerax/architecture" ref="nofollow noopener noreferrer">CameraX 架构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fcamerax%2Fbest-practices" target="_blank" title="https://developer.android.com/training/camerax/best-practices" ref="nofollow noopener noreferrer">CameraX 最佳实践</a></li>
</ul>
<h3 data-id="heading-50">示例代码</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fcamera-samples" target="_blank" title="https://github.com/android/camera-samples" ref="nofollow noopener noreferrer">CameraX 官方示例</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodelabs.developers.google.com%2Fcodelabs%2Fcamerax-getting-started" target="_blank" title="https://codelabs.developers.google.com/codelabs/camerax-getting-started" ref="nofollow noopener noreferrer">Google Codelabs - CameraX</a></li>
</ul>
<h3 data-id="heading-51">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fpermissions%2Frequesting" target="_blank" title="https://developer.android.com/training/permissions/requesting" ref="nofollow noopener noreferrer">Android 相机权限处理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroidx%2Fcamera%2Fview%2FPreviewView" target="_blank" title="https://developer.android.com/reference/androidx/camera/view/PreviewView" ref="nofollow noopener noreferrer">PreviewView API 文档</a></li>
</ul>
<h2 data-id="heading-52">📝 今日总结</h2>
<p>今天我们学习了 CameraX 的基础知识：</p>
<ol>
<li>✅ 理解了 CameraX 的架构和核心概念</li>
<li>✅ 掌握了相机权限的申请和处理</li>
<li>✅ 学会了使用 PreviewView 显示相机预览</li>
<li>✅ 实现了拍照和保存功能</li>
<li>✅ 了解了生命周期管理机制</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>CameraX 简化了相机开发，自动处理兼容性问题</li>
<li>Use Cases 是 CameraX 的核心，代表不同的使用场景</li>
<li><code>bindToLifecycle()</code> 会自动管理相机的生命周期</li>
<li>PreviewView 提供了简单易用的预览功能</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端渲染大体积 多页面pdf]]></title>    <link>https://juejin.cn/post/7571278865517051954</link>    <guid>https://juejin.cn/post/7571278865517051954</guid>    <pubDate>2025-11-11T10:41:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865517051954" data-draft-id="7571279513246695450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端渲染大体积 多页面pdf"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:41:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名小兵"/> <meta itemprop="url" content="https://juejin.cn/user/1772869560048312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端渲染大体积 多页面pdf
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772869560048312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名小兵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:41:35.000Z" title="Tue Nov 11 2025 10:41:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">示例</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d690d584981a40688984f792c5da578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5ZCN5bCP5YW1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763462494&amp;x-signature=QTyb7S2hwoUVMbcoGkON1dlt8uM%3D" alt="20251111183906_rec_.gif" loading="lazy"/></p>
<h2 data-id="heading-1">介绍</h2>
<p>首先使用的是 vue-pdf-embed渲染pdf，前段时间测试测出一个bug，当pdf文档页码过多(500页，7M)时，会出现页面卡死现象。首先尝试使用loading解决，css position解决，worker但是无济于事。然后开始研究vue-pdf-embed，发现内部是基于的pdfjs封装了一层，vue-pdf-embed内容是一次性渲染全部pdf。其实也是可以使用翻页的方式，那么就是一页一页的渲染，不会同时渲染很多页pdf。</p>
<h2 data-id="heading-2">技术栈</h2>
<p>vue3 pdfjs</p>
<h2 data-id="heading-3">解决方案</h2>
<p>有一个重要的点是：pdfjs 可以获取到pdf的总页数，以及每一页的pdf的高度。那么先使用一个div撑起父容器，然后滚动父容器，根据scrollTop/pdfHeight 获取到当前视口该展示哪一页 currentPage。</p>
<p>要解决的问题：<strong>向下滚动(相对简单)，向上滚动，快速下拉，快速上拉</strong>。</p>
<p>以下有5种方案，为什么会有这么多种方案呢，都是做着做着 发现更好的方案，以及一些pdfjs的限制问题。最终方案是最后2种。</p>
<ol>
<li>1个canvas渲染，分别渲染前一张pdf的上半部分和后一张pdf的下半部分（放弃，pdfjs不允许使用同一个canvas重复渲染）</li>
<li>2个canvas渲染，例如先绘制第1页和第1页，然后currentPage到2的时候 删除2个canvas，第1个canvas绘制第2页，第2个canvas绘制第3页。以此类推。（放弃每次切换页数的时候，页面都会一闪一闪的）</li>
<li>多个canvas  弊端 向上滚动一页 全部要重新绘制</li>
<li>每滚动一页 将最上面的canvas删除 在最后面添加新的canvas，其中还有边界值需要处理，比如pdf本来就只有1页，pdf 到最后一页和首页。</li>
<li>维护一个数组 数组长度为3（或者5），数组中的每个值对应pageindex,currentPage变化后，更新数组，然后和dom对比，做diff操作。</li>
</ol>
<p>方案5的好处，无须考虑那么多其他的,第4种方案还要解决快速拉动的问题。每次切换pageIndex,前面的canvas被删除掉了(其实不做删除操作也是可以的，因为每个canvas所在的位置是固定的，且不会重叠)，后面的canvas新增了，不会让用户看见一闪的现象。</p>
<h2 data-id="heading-4">全部代码</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- <span class="hljs-title class_">Canvas</span> 显示区域 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"canvas-container"</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"canvasContainer"</span>
    @<span class="hljs-attr">scroll.passive</span>=<span class="hljs-string">"handleScroll"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ overflow: 'auto' }"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mark"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: totalHeight + 'px' }"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> pdfjsLib <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">PdfWorker</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"pdfjs-dist/build/pdf.worker.mjs?url"</span>;

<span class="hljs-keyword">import</span> { onMounted, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
pdfjsLib.<span class="hljs-property">GlobalWorkerOptions</span>.<span class="hljs-property">workerSrc</span> = <span class="hljs-title class_">PdfWorker</span>; <span class="hljs-comment">// 使用woker</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">url</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>,
  },

});
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 总高度</span>
<span class="hljs-keyword">const</span> totalPages = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 总页码</span>
<span class="hljs-keyword">const</span> pageHeight = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// 一页高度</span>
<span class="hljs-keyword">let</span> currentPage = <span class="hljs-number">1</span>; <span class="hljs-comment">// 当前page</span>
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">let</span> pdfDoc = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不能使用ref  会报错</span>
<span class="hljs-keyword">let</span> renderIndex = <span class="hljs-number">0</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props.<span class="hljs-property">url</span>, <span class="hljs-string">"props.url"</span>);
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">url</span>) {
    <span class="hljs-title function_">loadPdf</span>(props.<span class="hljs-property">url</span>, renderIndex);
  }
});

<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">url</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal, oldVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (canvasContainer.<span class="hljs-property">value</span>) {
      canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> canvases = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">"canvas"</span>);
      canvases.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(item);
      });
    }
    <span class="hljs-keyword">if</span> (newVal) {
      <span class="hljs-comment">// console.log("newVal", newVal);</span>
      renderIndex++;
      currentPage = <span class="hljs-number">1</span>;
      allCanvasIndex = [];
      <span class="hljs-title function_">loadPdf</span>(newVal, renderIndex);
    }
  }
);
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">"error"</span>]);
<span class="hljs-keyword">const</span> canvasContainer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">let</span> allCanvas = [];
<span class="hljs-keyword">let</span> allCanvasIndex = [];
<span class="hljs-comment">// 一次性渲染多少张pdf</span>
<span class="hljs-keyword">let</span> canvasMaxNum = <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
<span class="hljs-keyword">let</span> t = <span class="hljs-number">0</span>;

<span class="hljs-keyword">let</span> lastScrollTop = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> renderPartialIndex = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentIndexs</span>(<span class="hljs-params">nindex</span>) {
  <span class="hljs-keyword">let</span> currentIndexs = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; canvasMaxNum; i++) {
    <span class="hljs-keyword">if</span> (nindex + i &lt;= totalPages.<span class="hljs-property">value</span>) {
      currentIndexs.<span class="hljs-title function_">push</span>(nindex + i);
    }
  }
  <span class="hljs-keyword">return</span> currentIndexs;
}
<span class="hljs-comment">// 新增单个canvas</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addCanvas</span>(<span class="hljs-params">npageIndex</span>) {
  <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
  ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
  canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(ncanvas);

  ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + npageIndex;
  ncanvas.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * (npageIndex - <span class="hljs-number">1</span>)}</span>px`</span>;
  <span class="hljs-title function_">renderPartialA</span>(pdfDoc, npageIndex, ncanvas);
}
<span class="hljs-comment">//监听滚动</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// console.log(e,'eee');</span>
  
  <span class="hljs-keyword">const</span> canvasContainer0 = e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">const</span> scrollTop = canvasContainer0.<span class="hljs-property">scrollTop</span>;
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">"scroll"</span>, scrollTop);
  <span class="hljs-built_in">clearTimeout</span>(t);
  <span class="hljs-comment">// 防抖</span>
  t = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (totalPages.<span class="hljs-property">value</span> &lt;= canvasMaxNum) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">let</span> page = scrollTop / pageHeight.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">let</span> npage = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, page)); <span class="hljs-comment">// 当前视图</span>

    <span class="hljs-keyword">if</span> (npage != currentPage) {
    <span class="hljs-comment">// 获取视图应该展示的pageIndex</span>
      <span class="hljs-keyword">let</span> currentIndexs = <span class="hljs-title function_">getCurrentIndexs</span>(npage);
      currentIndexs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!allCanvasIndex.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">if</span> (item &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_">addCanvas</span>(item);
          }
        }
      });
      <span class="hljs-comment">//移除操作</span>
      allCanvasIndex.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!currentIndexs.<span class="hljs-title function_">includes</span>(item)) {
          <span class="hljs-keyword">let</span> canvas = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#topCanvas"</span> + item);
          <span class="hljs-keyword">if</span> (canvas) {
            canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(canvas);
          }
        }
      });
      allCanvasIndex = currentIndexs;
    }
    currentPage = npage;
  },<span class="hljs-number">50</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPdf</span>(<span class="hljs-params">url, renderIndex1</span>) {
  <span class="hljs-comment">//   if (!url) return;</span>
  <span class="hljs-keyword">try</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;

    pdfDoc = <span class="hljs-keyword">await</span> pdfjsLib.<span class="hljs-title function_">getDocument</span>({ <span class="hljs-attr">url</span>: url }).<span class="hljs-property">promise</span>;
    <span class="hljs-keyword">if</span> (renderIndex1 !== renderIndex) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// this.pdfDoc=pdfDoc</span>
    totalPages.<span class="hljs-property">value</span> = pdfDoc.<span class="hljs-property">numPages</span>;
    <span class="hljs-comment">// 先渲染全部或者canvasMaxNum</span>
    allCanvas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(totalPages.<span class="hljs-property">value</span>, canvasMaxNum))
      .<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-comment">// 维护allCanvasIndex</span>
        allCanvasIndex.<span class="hljs-title function_">push</span>(index + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">let</span> ncanvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
        ncanvas.<span class="hljs-property">id</span> = <span class="hljs-string">"topCanvas"</span> + (index + <span class="hljs-number">1</span>);
        ncanvas.<span class="hljs-property">classList</span> = [<span class="hljs-string">"canvasshow"</span>];
        <span class="hljs-keyword">return</span> ncanvas;
      });
    renderPartialIndex++;
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderPartial</span>(pdfDoc, <span class="hljs-literal">true</span>, renderPartialIndex);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"PDF 加载失败:"</span>, error);
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">"error"</span>, error);
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
}
<span class="hljs-keyword">let</span> scale0=<span class="hljs-number">1</span>
<span class="hljs-comment">// 绘制单个pdf页</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialA</span>(<span class="hljs-params">pdfDoc, pageIndex, canvas</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">getPage</span>(pageIndex);

    <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 });

    <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
    <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;


           canvas.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
           canvas.<span class="hljs-property">width</span> = fullWidth
        canvas.<span class="hljs-property">height</span> = fullHeight
    <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, canvas);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPageDimensions</span> = (<span class="hljs-params">ratio</span>) =&gt; {
  <span class="hljs-keyword">let</span> width
  <span class="hljs-keyword">let</span> height

  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">height</span> &amp;&amp; !props.<span class="hljs-property">width</span>) {
    height = props.<span class="hljs-property">height</span>
    width = height / ratio
  } <span class="hljs-keyword">else</span> {
    width = props.<span class="hljs-property">width</span> ?? canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>
    height = width * ratio
  }

  <span class="hljs-keyword">return</span> [width, height]
}
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartial</span>(<span class="hljs-params">pdfDoc, init, renderPartialIndex1</span>) {
  <span class="hljs-keyword">if</span> (!pdfDoc) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> ps = allCanvas.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> pdfDoc.<span class="hljs-title function_">getPage</span>(<span class="hljs-number">1</span> + index);
    });
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ps).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pages</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (renderPartialIndex1 !== renderPartialIndex) {
        <span class="hljs-keyword">return</span>; 
      }
      <span class="hljs-keyword">let</span> page = pages[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">let</span> w = canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>;
          <span class="hljs-keyword">const</span> viewWidth = page.<span class="hljs-property">view</span>[<span class="hljs-number">2</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">0</span>]
           <span class="hljs-keyword">const</span> viewHeight = page.<span class="hljs-property">view</span>[<span class="hljs-number">3</span>] - page.<span class="hljs-property">view</span>[<span class="hljs-number">1</span>]
          <span class="hljs-keyword">let</span> isTransposed=<span class="hljs-literal">false</span>  
           <span class="hljs-keyword">const</span> pageWidth = isTransposed ? viewHeight : viewWidth
            <span class="hljs-keyword">const</span> [actualWidth, actualHeight] = <span class="hljs-title function_">getPageDimensions</span>(
          isTransposed ? viewWidth / viewHeight : viewHeight / viewWidth
        )
    <span class="hljs-keyword">let</span> scale=actualWidth  * <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>/ pageWidth
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(scale,<span class="hljs-string">'scale'</span>);
      scale0=scale
      <span class="hljs-keyword">const</span> viewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale});
      <span class="hljs-keyword">const</span> fullWidth = viewport.<span class="hljs-property">width</span>;
      <span class="hljs-keyword">const</span> fullHeight = viewport.<span class="hljs-property">height</span>;
      pageHeight.<span class="hljs-property">value</span> = (fullHeight * (w - <span class="hljs-number">10</span>)) / fullWidth;
      totalHeight.<span class="hljs-property">value</span> = totalPages.<span class="hljs-property">value</span> * pageHeight.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">if</span> (init) {
        allCanvas.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">0</span>}</span>px`</span>;
          } <span class="hljs-keyword">else</span> {
            item.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${pageHeight.value * index}</span>px`</span>;
          }
          canvasContainer.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(item);
        });
      }

      <span class="hljs-comment">// 根据预设计算裁剪参数</span>
 

      pages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">page, index</span>) =&gt;</span> {
          allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = fullHeight
          allCanvas[index].<span class="hljs-property">width</span> = fullWidth
        allCanvas[index].<span class="hljs-property">height</span> = fullHeight
        <span class="hljs-title function_">renderPartialArea</span>(page, clipParamsTop, allCanvas[index]);
      });
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">//  Cannot read private member #pagePromises from an object whose class did not declare it</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"渲染失败:"</span>, error);
  }
}

<span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPartialArea</span>(<span class="hljs-params">page, clipParams, canvas</span>) {
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);

  <span class="hljs-keyword">const</span> { clipX, clipY, clipWidth, clipHeight } = clipParams;
  
  <span class="hljs-keyword">const</span> partialViewport = page.<span class="hljs-title function_">getViewport</span>({ <span class="hljs-attr">scale</span>: scale0 }).<span class="hljs-title function_">clone</span>({
    <span class="hljs-attr">scale</span>: scale0,
  });

  <span class="hljs-comment">// 应用裁剪和渲染</span>
  ctx.<span class="hljs-title function_">save</span>();
  ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

  <span class="hljs-keyword">const</span> renderContext = {
    <span class="hljs-attr">canvasContext</span>: ctx,
    <span class="hljs-attr">viewport</span>: partialViewport,
  };

  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">render</span>(renderContext).<span class="hljs-property">promise</span>;
  ctx.<span class="hljs-title function_">restore</span>();
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.canvasshow</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.partial-pdf-viewer</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-comment">/* border-radius: 8px; */</span>
  <span class="hljs-comment">/* padding: 16px; */</span>
}

<span class="hljs-selector-class">.control-panel</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.control-group</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.clip-controls</span> &gt; <span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"number"</span>]</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.canvas-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">background</span>: white;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;
}
<span class="hljs-selector-class">.canvas-container</span>::-webkit-scrollbar-thumb {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#c1c1c1</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}
<span class="hljs-selector-class">.mark</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">10</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
}
<span class="hljs-selector-tag">canvas</span> {
  <span class="hljs-attribute">display</span>: block;
}

<span class="hljs-selector-class">.loading</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-selector-class">.info-panel</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f0f0</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战]]></title>    <link>https://juejin.cn/post/7570271574348447753</link>    <guid>https://juejin.cn/post/7570271574348447753</guid>    <pubDate>2025-11-10T00:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348447753" data-draft-id="7554198278955712538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（三）：Primary Associated Type、some/any 与泛型式协议实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:30:22.000Z" title="Mon Nov 10 2025 00:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么 Swift 5.7 再次“颠覆”协议</h2>
<p>在 Swift 5.7 之前，带关联类型的协议只能当约束 <code>&lt;T: Sequence&gt;</code>，不能当类型 <code>Sequence</code>。</p>
<p>这导致两个老大难：</p>
<ol>
<li>声明变量/参数/返回值时，必须再包一层类型擦除（<code>AnySequence&lt;Int&gt;</code>）。</li>
<li>泛型函数无法“一眼看出”序列里到底是什么元素。</li>
</ol>
<p>Swift 5.7 一次性给出三把新钥匙：</p>

























<table><thead><tr><th>特性</th><th>关键词</th><th>解决痛点</th></tr></thead><tbody><tr><td>主要关联类型</td><td><code>protocol Sequence&lt;Element&gt;</code></td><td>把最常用的关联类型“提级”到协议名上</td></tr><tr><td>不透明参数</td><td><code>some Sequence&lt;Int&gt;</code></td><td>直接当参数类型，编译期确定，零运行时开销</td></tr><tr><td>存在性类型</td><td><code>any Sequence&lt;Int&gt;</code></td><td>真·变量类型，运行时盒子，语法终于可读</td></tr></tbody></table>
<h2 data-id="heading-1">Primary Associated Type：把“泛型参数”搬到协议头上</h2>
<ol>
<li>标准库示例</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Swift 5.7 标准库定义</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span>&lt;<span class="hljs-title class_">Element</span>&gt; {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}
</code></pre>
<p><code>Element</code> 被写到协议名后面，成为主要关联类型。</p>
<p>于是我们可以像泛型结构体一样，直接写：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">sum</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">numbers</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">Int</span>&gt;) -&gt; <span class="hljs-type">Int</span> {   <span class="hljs-comment">// ① 参数类型</span>
    numbers.reduce(<span class="hljs-number">0</span>, <span class="hljs-operator">+</span>)
}

<span class="hljs-keyword">let</span> total <span class="hljs-operator">=</span> sum([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-operator">+</span> [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>])            <span class="hljs-comment">// ② 数组拼接也适用</span>
</code></pre>
<ol start="2">
<li>为自己协议添加“主关联类型”</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
        <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
        a <span class="hljs-operator">=</span> b
        b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
        <span class="hljs-keyword">return</span> next
    }
}

<span class="hljs-comment">// ② 立刻享受 some/any 语法</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-type">IteratorFeed</span>()
}

<span class="hljs-keyword">var</span> feeds: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> []   <span class="hljs-comment">// ③ 数组里放不同实现，无需再包 AnyFeed</span>
</code></pre>
<p>规则</p>
<ul>
<li>只能把一个或多个 <code>associatedtype</code> 声明为“主要”，不强制全部。</li>
<li>主要关联类型顺序不影响使用，但建议按“常用度”排序。</li>
<li>一旦声明，协议就获得“泛型形参”资格，可直接写 <code>Feed&lt;Int&gt;</code>。</li>
</ul>
<h2 data-id="heading-2">some vs. any：一句话区分</h2>



































<table><thead><tr><th>维度</th><th><code>some P</code></th><th><code>any P</code></th></tr></thead><tbody><tr><td>语义</td><td>编译期确定的<strong>某个</strong>具体类型</td><td>运行时存在的<strong>任何</strong>具体类型</td></tr><tr><td>内存布局</td><td>无间接寻址，内联存储</td><td>存在性容器（Box），通过指针引用</td></tr><tr><td>主要用法</td><td>返回值、泛型约束</td><td>变量、集合元素、函数参数</td></tr><tr><td>性能</td><td>零额外开销</td><td>轻微运行时开销（Box管理）</td></tr><tr><td>使用限制</td><td>不能用于<code>var</code>/集合类型声明</td><td>无显式限制</td></tr></tbody></table>
<p>示例对比</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span>&lt;<span class="hljs-title class_">Element</span>&gt; {          <span class="hljs-comment">// ① 把最常用的关联类型提出来</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IteratorFeed</span>&lt;<span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span>&gt;: <span class="hljs-title class_">Feed</span>  {
    <span class="hljs-keyword">var</span> iterator: <span class="hljs-type">Iterator</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">iterator</span>: <span class="hljs-type">Iterator</span>) {
        <span class="hljs-keyword">self</span>.iterator <span class="hljs-operator">=</span> iterator
    }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span>? {
        iterator.next()
    }
}

<span class="hljs-comment">// 1. 返回值：编译期就知道真实类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">uniqueElements</span>&lt;<span class="hljs-type">S</span>: <span class="hljs-type">Sequence</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">seq</span>: <span class="hljs-type">S</span>) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Sequence</span>&lt;<span class="hljs-type">S</span>.<span class="hljs-type">Element</span>&gt;
<span class="hljs-keyword">where</span> <span class="hljs-type">S</span>.<span class="hljs-type">Element</span>: <span class="hljs-type">Hashable</span> &amp; <span class="hljs-type">Comparable</span> {
    <span class="hljs-type">Set</span>(seq).sorted()
}

<span class="hljs-comment">// 2. 数组：运行期才知道真实类型</span>
<span class="hljs-keyword">var</span> parsers: [<span class="hljs-keyword">any</span> <span class="hljs-type">Feed</span>&lt;<span class="hljs-type">Int</span>&gt;] <span class="hljs-operator">=</span> [
    <span class="hljs-type">IteratorFeed</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].makeIterator()),
    <span class="hljs-type">IteratorFeed</span>(<span class="hljs-built_in">stride</span>(from: <span class="hljs-number">0</span>, to: <span class="hljs-number">10</span>, by: <span class="hljs-number">2</span>).makeIterator())
]
</code></pre>
<h2 data-id="heading-3">实战：一行代码写“泛型” SwiftUI View</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Charts

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChartView</span>&lt;<span class="hljs-title class_">Data</span>: <span class="hljs-title class_">RandomAccessCollection</span>&gt;: <span class="hljs-title class_">View</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Data</span>.<span class="hljs-title class_">Element</span> == <span class="hljs-title class_">Double</span> {
    <span class="hljs-keyword">let</span> data: <span class="hljs-type">Data</span>
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-comment">// 老写法：调用方必须写冗长泛型参数</span>
    }
}

<span class="hljs-comment">// ✅ 新写法：直接不透明返回，调用方无感知</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeChart</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-keyword">some</span> <span class="hljs-type">RandomAccessCollection</span>&lt;<span class="hljs-type">Double</span>&gt;) -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
    
    <span class="hljs-type">Chart</span> {
        <span class="hljs-type">ForEach</span>(data.enumerated(), id: \.offset) { idx,value <span class="hljs-keyword">in</span>
            <span class="hljs-type">LineMark</span>(x: .value(<span class="hljs-string">"x"</span>, idx), y: .value(<span class="hljs-string">"y"</span>, value))
        }
    }
}
</code></pre>
<h2 data-id="heading-4">迁移旧代码：把 AnySequence 换成 any Sequence</h2>





















<table><thead><tr><th>旧代码</th><th>新代码</th></tr></thead><tbody><tr><td><code>AnySequence&lt;Int&gt;</code></td><td><code>any Sequence&lt;Int&gt;</code></td></tr><tr><td><code>AnyPublisher&lt;Int, Never&gt;</code></td><td><code>any Publisher&lt;Int, Never&gt;</code></td></tr><tr><td><code>AnyView</code></td><td><code>any View</code>（iOS 17+ 可用，仍需权衡性能）</td></tr></tbody></table>
<p>步骤</p>
<ol>
<li>在协议名后加 <code>&lt;Element&gt;</code>。</li>
<li>把 <code>eraseToAnyPublisher()</code> / <code>AnySequence(...)</code> 改成 <code>any Sequence&lt;Int&gt;</code>。</li>
<li>若返回值无需运行时多态，直接用 <code>some Sequence&lt;Int&gt;</code> 获得零开销。</li>
</ol>
<h2 data-id="heading-5">性能与二进制大小小贴士</h2>
<ul>
<li><code>some P&lt;T&gt;</code> 完全静态派发，零额外内存。</li>
<li><code>any P&lt;T&gt;</code> 引入存在性容器，16 字节 inline + 外挂堆（若值过大）。</li>
<li>滥用 <code>any</code> 会让二进制出现大量“协议见证表”，release 模式下编译器会优化，但debug 增量编译可能变慢。</li>
<li>对 SwiftUI <code>body</code> 这种超高频调用，优先 <code>some View</code>；只在需要运行时异构数组时才用 <code>any View</code>。</li>
</ul>
<h2 data-id="heading-6">总结</h2>

























<table><thead><tr><th>关键词</th><th>适用场景</th><th>记忆口诀</th></tr></thead><tbody><tr><td><code>protocol P&lt;Element&gt;</code></td><td>给自己协议“提级”</td><td>“协议也能带泛参”</td></tr><tr><td><code>some P&lt;T&gt;</code></td><td>返回值、泛型约束</td><td>“编译期就确定”</td></tr><tr><td><code>any P&lt;T&gt;</code></td><td>变量、数组、字典</td><td>“运行期多态盒子”</td></tr></tbody></table>
<p>一句话总结</p>
<p>Swift 5.7 让协议第一次真正拥有了“泛型形参”能力：</p>
<ul>
<li>写库的人：给协议加 <code>&lt;Element&gt;</code>，调用方立刻享受 <code>some/any</code> 语法糖。</li>
<li>写业务的人：用 <code>some Sequence&lt;Int&gt;</code> 替代冗长泛型约束，用 <code>any Sequence&lt;Int&gt;</code> 替代 <code>AnySequence</code>，代码短一半、可读性翻倍。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂]]></title>    <link>https://juejin.cn/post/7570271574348333065</link>    <guid>https://juejin.cn/post/7570271574348333065</guid>    <pubDate>2025-11-10T00:07:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348333065" data-draft-id="7554225547145461798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-11-10T00:07:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 协议（Protocol）指南（二）：关联类型、Self 约束与泛型递归，一次彻底搞懂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:07:19.000Z" title="Mon Nov 10 2025 00:07:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么“关联类型”是协议的分水岭</h2>
<p>在上面，我们接触的协议都属于“无关联类型协议”——编译期无需知道协议里的泛型占位符具体是什么。</p>
<p>一旦协议里出现了 <code>associatedtype</code>，它就不再是普通类型，而变成了协议泛型：只能当作约束使用，不能当作变量/参数/返回值类型直接出现。</p>
<h2 data-id="heading-1">关联类型基础语法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>                     <span class="hljs-comment">// ① 声明一个占位符</span>
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Item</span>)      <span class="hljs-comment">// ② 在方法里使用占位符</span>
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Item</span> { <span class="hljs-keyword">get</span> }   <span class="hljs-comment">// ③ 在下标里使用占位符</span>
}
</code></pre>
<p>实现者决定真实类型</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">Int</span>]()
    <span class="hljs-keyword">typealias</span> <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>      <span class="hljs-comment">// 可省略，编译器自动推断</span>
    
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">Int</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">StringQueue</span>: <span class="hljs-title class_">Container</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items <span class="hljs-operator">=</span> [<span class="hljs-type">String</span>]()
    <span class="hljs-comment">// 不写 typealias，编译器也能从 append 参数推断 Item == String</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">append</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">item</span>: <span class="hljs-type">String</span>) { items.append(item) }
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">String</span> { items[index] }
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span> { items.count }
}
</code></pre>
<h2 data-id="heading-2">带约束的关联类型</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">//  继承Container，只接收Item是Numeric的类型</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">SummableContainer</span>: <span class="hljs-title class_">Container</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Item</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">SummableContainer</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">total</span>() -&gt; <span class="hljs-type">Item</span> {
        <span class="hljs-keyword">var</span> sum: <span class="hljs-type">Item</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>count { sum <span class="hljs-operator">=</span> sum <span class="hljs-operator">+</span> <span class="hljs-keyword">self</span>[i] }
        <span class="hljs-keyword">return</span> sum
    }
}
</code></pre>
<p>使用</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">IntStack</span>: <span class="hljs-title class_">SummableContainer</span> {}   <span class="hljs-comment">// Int 符合 Numeric，自动获得 total()</span>
<span class="hljs-keyword">var</span> s <span class="hljs-operator">=</span> <span class="hljs-type">IntStack</span>()
s.append(<span class="hljs-number">1</span>)
s.append(<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(s.total()) <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-3">Self 出现在协议里：返回自身类型的需求</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span>        <span class="hljs-comment">// 要求返回“真实类型”本身</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>: <span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">init</span>() {}         <span class="hljs-comment">// 必须保证子类也能初始化</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">copy</span>() -&gt; <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> new <span class="hljs-operator">=</span> <span class="hljs-keyword">Self</span>()       <span class="hljs-comment">// Self 在运行期代表真实动态类型</span>
        new.name <span class="hljs-operator">=</span> name
        <span class="hljs-keyword">return</span> new
    }
}

<span class="hljs-keyword">let</span> husky <span class="hljs-operator">=</span> <span class="hljs-type">Dog</span>()
husky.name <span class="hljs-operator">=</span> <span class="hljs-string">"Husky"</span>
<span class="hljs-keyword">let</span> another <span class="hljs-operator">=</span> husky.copy()     <span class="hljs-comment">// 类型推断为 Dog</span>
</code></pre>
<p>注意</p>
<ul>
<li><code>Self</code> 只能出现在“协议内”或“协议扩展”中，不能出现在普通结构体/类的方法签名里。</li>
<li>如果协议用 <code>associatedtype</code>，<code>Self</code> 就是该类型的别名。</li>
</ul>
<h2 data-id="heading-4">泛型递归约束：where 子句的魔法</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Value</span>
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">Value</span> { <span class="hljs-keyword">get</span> }
    <span class="hljs-keyword">var</span> children: [<span class="hljs-keyword">Self</span>] { <span class="hljs-keyword">get</span> }        <span class="hljs-comment">// 递归引用自身</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Node</span> <span class="hljs-title class_">where</span> <span class="hljs-title class_">Value</span>: <span class="hljs-title class_">Numeric</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sumTree</span>() -&gt; <span class="hljs-type">Value</span> {
        value <span class="hljs-operator">+</span> children.reduce(<span class="hljs-number">0</span>) { <span class="hljs-variable">$0</span> <span class="hljs-operator">+</span> <span class="hljs-variable">$1</span>.sumTree() }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">IntNode</span>: <span class="hljs-title class_">Node</span> {
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> children: [<span class="hljs-type">IntNode</span>]
}

<span class="hljs-keyword">let</span> tree <span class="hljs-operator">=</span> <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">10</span>, children: [
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">3</span>, children: []),
    <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">5</span>, children: [
        <span class="hljs-type">IntNode</span>(value: <span class="hljs-number">1</span>, children: [])
    ])
])
<span class="hljs-built_in">print</span>(tree.sumTree())  <span class="hljs-comment">// 10+3+5+1 = 19</span>
</code></pre>
<h2 data-id="heading-5">真实案例：Swift 标准库里的 Sequence</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Iterator</span>: <span class="hljs-type">IteratorProtocol</span> <span class="hljs-keyword">where</span> <span class="hljs-type">Iterator</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span>
    
    __consuming <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span>
}

<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">IteratorProtocol</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}
</code></pre>
<p>自定义序列</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Fibonacci</span>: <span class="hljs-title class_">Sequence</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Iterator</span>: <span class="hljs-title class_">IteratorProtocol</span> {
        <span class="hljs-keyword">var</span> a <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, b <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Int</span>? {
            <span class="hljs-keyword">let</span> next <span class="hljs-operator">=</span> a
            a <span class="hljs-operator">=</span> b
            b <span class="hljs-operator">=</span> next <span class="hljs-operator">+</span> a
            <span class="hljs-keyword">return</span> next
        }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIterator</span>() -&gt; <span class="hljs-type">Iterator</span> { <span class="hljs-type">Iterator</span>() }
}

<span class="hljs-keyword">for</span> (i, n) <span class="hljs-keyword">in</span> <span class="hljs-type">Fibonacci</span>().enumerated().prefix(<span class="hljs-number">10</span>) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"F<span class="hljs-subst">\(i)</span> = <span class="hljs-subst">\(n)</span>"</span>)
}
</code></pre>
<h2 data-id="heading-6">类型擦除（Type Erasure）：解决“关联类型协议不能当返回类型”</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Item</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>?
}

<span class="hljs-comment">// 1. 包装类擦除具体 Item 类型</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnyFeed</span>&lt;<span class="hljs-title class_">Item</span>&gt;: <span class="hljs-title class_">Feed</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _next: () -&gt; <span class="hljs-type">Item</span>?
    <span class="hljs-keyword">init</span>&lt;<span class="hljs-type">F</span>: <span class="hljs-type">Feed</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">real</span>: <span class="hljs-type">F</span>) <span class="hljs-keyword">where</span> <span class="hljs-type">F</span>.<span class="hljs-type">Item</span> <span class="hljs-operator">==</span> <span class="hljs-type">Item</span> {
        _next <span class="hljs-operator">=</span> { real.next() }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Item</span>? { _next() }
}

<span class="hljs-comment">// 2. 使用处不再出现关联类型</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">makeIntFeed</span>() -&gt; <span class="hljs-type">AnyFeed</span>&lt;<span class="hljs-type">Int</span>&gt; {
    <span class="hljs-keyword">let</span> fib <span class="hljs-operator">=</span> <span class="hljs-type">Fibonacci</span>().makeIterator()
    <span class="hljs-keyword">return</span> <span class="hljs-type">AnyFeed</span>(<span class="hljs-type">IteratorFeed</span>(fib))
}
</code></pre>
<p>标准库已有</p>
<ul>
<li><code>AnySequence&lt;Element&gt;</code></li>
<li><code>AnyPublisher&lt;Output, Failure&gt;</code> (Combine)</li>
<li><code>AnyView</code> (SwiftUI)</li>
</ul>
<h2 data-id="heading-7">实战技巧清单</h2>





























<table><thead><tr><th>技巧场景</th><th>具体实现技巧</th></tr></thead><tbody><tr><td>想返回“某个遵守协议的对象”</td><td>用泛型 <code>&lt;T: Protocol&gt;</code> 或 <code>some Protocol</code></td></tr><tr><td>协议中定义 <code>associatedtype</code></td><td>仅能作为类型约束，无法直接当作变量类型；需通过“类型擦除”后暴露</td></tr><tr><td>要求子类必须实现指定初始化器</td><td>协议中声明 <code>init()</code>，类侧配合写 <code>required init()</code></td></tr><tr><td>让扩展方法仅对满足部分约束的类型可见</td><td>使用 <code>where</code> 子句，例如 <code>extension Container where Item: Comparable</code></td></tr><tr><td>禁止类型隐式标记为 <code>Sendable</code></td><td>声明 <code>struct File: ~Sendable</code>，或通过 <code>@available(*, unavailable) extension File: Sendable</code> 禁用</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day8: 多重纹理与混合]]></title>    <link>https://juejin.cn/post/7570534000718495807</link>    <guid>https://juejin.cn/post/7570534000718495807</guid>    <pubDate>2025-11-10T08:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570534000718495807" data-draft-id="7570534000718479423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day8: 多重纹理与混合"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-10T08:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day8: 多重纹理与混合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T08:19:05.000Z" title="Mon Nov 10 2025 08:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7569871848793948179" target="_blank" title="https://juejin.cn/post/7569871848793948179">上一篇:『OpenGL学习滤镜相机』- Day7: FBO（帧缓冲对象）</a></p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://github.com/xiaweizi/OpenGLTest" ref="nofollow noopener noreferrer">OpenGLTest</a></p>
</blockquote>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解多纹理单元的概念和使用</li>
<li>掌握纹理混合模式（Blend Modes）</li>
<li>学习 Alpha 通道处理和透明度</li>
<li>实现图片水印、纹理叠加等实用效果</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d0fe85223524f6d85e34d84847cfa31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763367544&amp;x-signature=NEY23PHhtHVaLDDj%2FvZ28hR8j1M%3D" alt="Day8.gif" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. 多纹理单元简介</h3>
<p>在 OpenGL ES 中，<strong>纹理单元（Texture Unit）</strong> 允许我们在一次绘制调用中使用多个纹理。</p>
<h4 data-id="heading-3">什么是纹理单元？</h4>
<p>纹理单元是 OpenGL 中的"纹理槽位"，每个槽位可以绑定一个纹理对象。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">GPU</span> <span class="hljs-string">纹理单元</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE0</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">123</span><span class="hljs-string">（底图）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE1</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">456</span><span class="hljs-string">（水印）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">GL_TEXTURE2</span> <span class="hljs-string">→</span> <span class="hljs-string">纹理</span> <span class="hljs-attr">ID:</span> <span class="hljs-number">789</span><span class="hljs-string">（遮罩）</span>
<span class="hljs-string">├──</span> <span class="hljs-string">...</span>
<span class="hljs-string">└──</span> <span class="hljs-string">GL_TEXTURE31（OpenGL</span> <span class="hljs-string">ES</span> <span class="hljs-string">至少支持</span> <span class="hljs-number">8</span> <span class="hljs-string">个，通常支持</span> <span class="hljs-number">16</span><span class="hljs-number">-32</span> <span class="hljs-string">个）</span>
</code></pre>
<h4 data-id="heading-4">为什么需要多纹理？</h4>





























<table><thead><tr><th>应用场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>水印效果</strong></td><td>底图 + 水印图</td></tr><tr><td><strong>遮罩效果</strong></td><td>原图 + 遮罩图</td></tr><tr><td><strong>光照贴图</strong></td><td>颜色纹理 + 法线贴图 + 光照贴图</td></tr><tr><td><strong>视频特效</strong></td><td>视频帧 + 滤镜纹理（LUT）</td></tr><tr><td><strong>粒子效果</strong></td><td>粒子纹理 + 渐变纹理</td></tr></tbody></table>
<h3 data-id="heading-5">2. 多纹理的使用流程</h3>
<h4 data-id="heading-6">2.1 激活纹理单元</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 激活纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
<span class="hljs-comment">// 绑定第一个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)

<span class="hljs-comment">// 激活纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
<span class="hljs-comment">// 绑定第二个纹理</span>
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
</code></pre>
<h4 data-id="heading-7">2.2 传递给着色器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 将纹理单元索引传递给着色器的 sampler2D</span>
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE0</span>
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 使用 GL_TEXTURE1</span>
</code></pre>
<h4 data-id="heading-8">2.3 着色器中采样</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 水印

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);  // 采样底图
    vec4 color2 = texture2D(uTexture2, vTexCoord);  // 采样水印
    
    // 混合两个纹理
    gl_FragColor = mix(color1, color2, color2.a);
}
</code></pre>
<h3 data-id="heading-9">3. 纹理混合模式</h3>
<h4 data-id="heading-10">3.1 常见混合算法</h4>








































<table><thead><tr><th>混合模式</th><th>公式</th><th>效果</th></tr></thead><tbody><tr><td><strong>正常（Normal）</strong></td><td><code>color2</code></td><td>完全覆盖</td></tr><tr><td><strong>Alpha 混合</strong></td><td><code>mix(color1, color2, alpha)</code></td><td>透明叠加</td></tr><tr><td><strong>相加（Add）</strong></td><td><code>color1 + color2</code></td><td>增亮效果</td></tr><tr><td><strong>相乘（Multiply）</strong></td><td><code>color1 * color2</code></td><td>变暗效果</td></tr><tr><td><strong>屏幕（Screen）</strong></td><td><code>1.0 - (1.0 - color1) * (1.0 - color2)</code></td><td>柔光增亮</td></tr><tr><td><strong>叠加（Overlay）</strong></td><td>根据亮度混合相乘和屏幕模式</td><td>保留高光和阴影</td></tr></tbody></table>
<h4 data-id="heading-11">3.2 着色器实现</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;  // 底图
uniform sampler2D uTexture2;  // 叠加图
uniform int uBlendMode;       // 混合模式（0-5）
uniform float uAlpha;         // 透明度（0.0 - 1.0）

varying vec2 vTexCoord;

// 正常混合
vec3 blendNormal(vec3 base, vec3 blend) {
    return blend;
}

// 相加混合
vec3 blendAdd(vec3 base, vec3 blend) {
    return min(base + blend, vec3(1.0));
}

// 相乘混合
vec3 blendMultiply(vec3 base, vec3 blend) {
    return base * blend;
}

// 屏幕混合
vec3 blendScreen(vec3 base, vec3 blend) {
    return 1.0 - (1.0 - base) * (1.0 - blend);
}

// 叠加混合
vec3 blendOverlay(vec3 base, vec3 blend) {
    vec3 result;
    result.r = base.r &lt; 0.5 ? (2.0 * base.r * blend.r) : (1.0 - 2.0 * (1.0 - base.r) * (1.0 - blend.r));
    result.g = base.g &lt; 0.5 ? (2.0 * base.g * blend.g) : (1.0 - 2.0 * (1.0 - base.g) * (1.0 - blend.g));
    result.b = base.b &lt; 0.5 ? (2.0 * base.b * blend.b) : (1.0 - 2.0 * (1.0 - base.b) * (1.0 - blend.b));
    return result;
}

// 柔光混合
vec3 blendSoftLight(vec3 base, vec3 blend) {
    vec3 result;
    result.r = blend.r &lt; 0.5 ? (2.0 * base.r * blend.r + base.r * base.r * (1.0 - 2.0 * blend.r)) 
                              : (sqrt(base.r) * (2.0 * blend.r - 1.0) + 2.0 * base.r * (1.0 - blend.r));
    result.g = blend.g &lt; 0.5 ? (2.0 * base.g * blend.g + base.g * base.g * (1.0 - 2.0 * blend.g)) 
                              : (sqrt(base.g) * (2.0 * blend.g - 1.0) + 2.0 * base.g * (1.0 - blend.g));
    result.b = blend.b &lt; 0.5 ? (2.0 * base.b * blend.b + base.b * base.b * (1.0 - 2.0 * blend.b)) 
                              : (sqrt(base.b) * (2.0 * blend.b - 1.0) + 2.0 * base.b * (1.0 - blend.b));
    return result;
}

void main() {
    vec4 base = texture2D(uTexture1, vTexCoord);
    vec4 blend = texture2D(uTexture2, vTexCoord);
    
    vec3 result;
    
    if (uBlendMode == 0) {
        // 正常混合（Alpha 混合）
        result = mix(base.rgb, blend.rgb, blend.a * uAlpha);
    } else if (uBlendMode == 1) {
        // 相加
        result = blendAdd(base.rgb, blend.rgb * uAlpha);
    } else if (uBlendMode == 2) {
        // 相乘
        result = mix(base.rgb, blendMultiply(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 3) {
        // 屏幕
        result = mix(base.rgb, blendScreen(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 4) {
        // 叠加
        result = mix(base.rgb, blendOverlay(base.rgb, blend.rgb), uAlpha);
    } else if (uBlendMode == 5) {
        // 柔光
        result = mix(base.rgb, blendSoftLight(base.rgb, blend.rgb), uAlpha);
    } else {
        result = base.rgb;
    }
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h3 data-id="heading-12">4. Alpha 通道处理</h3>
<h4 data-id="heading-13">4.1 什么是 Alpha 通道？</h4>
<p><strong>Alpha 通道</strong>表示像素的不透明度：</p>
<ul>
<li><code>alpha = 0.0</code>：完全透明</li>
<li><code>alpha = 0.5</code>：半透明</li>
<li><code>alpha = 1.0</code>：完全不透明</li>
</ul>
<h4 data-id="heading-14">4.2 启用 Alpha 混合</h4>
<p>OpenGL 提供了硬件级别的 Alpha 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启用混合</span>
GLES20.glEnable(GLES20.GL_BLEND)

<span class="hljs-comment">// 设置混合函数</span>
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)
</code></pre>
<p><strong>混合公式</strong>：</p>
<pre><code class="hljs language-css" lang="css">最终颜色 = 源颜色 × 源因子 + 目标颜色 × 目标因子
       = <span class="hljs-attribute">src</span><span class="hljs-selector-class">.rgb</span> × <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span> + dst<span class="hljs-selector-class">.rgb</span> × (<span class="hljs-number">1.0</span> - <span class="hljs-attribute">src</span><span class="hljs-selector-class">.a</span>)
</code></pre>
<h4 data-id="heading-15">4.3 常见混合函数</h4>






























<table><thead><tr><th>源因子</th><th>目标因子</th><th>效果</th></tr></thead><tbody><tr><td><code>GL_SRC_ALPHA</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>标准 Alpha 混合（透明叠加）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE</code></td><td>相加混合（增亮）</td></tr><tr><td><code>GL_DST_COLOR</code></td><td><code>GL_ZERO</code></td><td>相乘混合（变暗）</td></tr><tr><td><code>GL_ONE</code></td><td><code>GL_ONE_MINUS_SRC_ALPHA</code></td><td>预乘 Alpha 混合</td></tr></tbody></table>
<h3 data-id="heading-16">5. 实用效果实现</h3>
<h4 data-id="heading-17">5.1 水印效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">// 水印着色器
precision mediump float;

uniform sampler2D uTexture;    // 底图
uniform sampler2D uWatermark;  // 水印
uniform vec2 uWatermarkPos;    // 水印位置（0.0 - 1.0）
uniform vec2 uWatermarkSize;   // 水印大小（0.0 - 1.0）
uniform float uWatermarkAlpha; // 水印透明度

varying vec2 vTexCoord;

void main() {
    vec4 baseColor = texture2D(uTexture, vTexCoord);
    
    // 计算水印区域
    vec2 watermarkCoord = (vTexCoord - uWatermarkPos) / uWatermarkSize;
    
    // 判断是否在水印区域
    if (watermarkCoord.x &gt;= 0.0 &amp;&amp; watermarkCoord.x &lt;= 1.0 &amp;&amp;
        watermarkCoord.y &gt;= 0.0 &amp;&amp; watermarkCoord.y &lt;= 1.0) {
        
        vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
        
        // Alpha 混合水印
        gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a * uWatermarkAlpha);
    } else {
        gl_FragColor = baseColor;
    }
}
</code></pre>
<h4 data-id="heading-18">5.2 双重曝光效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture1;
uniform sampler2D uTexture2;
uniform float uMixRatio;  // 混合比例

varying vec2 vTexCoord;

void main() {
    vec4 color1 = texture2D(uTexture1, vTexCoord);
    vec4 color2 = texture2D(uTexture2, vTexCoord);
    
    // 屏幕混合模式（双重曝光常用）
    vec3 result = 1.0 - (1.0 - color1.rgb) * (1.0 - color2.rgb * uMixRatio);
    
    gl_FragColor = vec4(result, 1.0);
}
</code></pre>
<h4 data-id="heading-19">5.3 遮罩效果</h4>
<pre><code class="hljs language-glsl" lang="glsl">precision mediump float;

uniform sampler2D uTexture;  // 原图
uniform sampler2D uMask;     // 遮罩（黑白图）

varying vec2 vTexCoord;

void main() {
    vec4 color = texture2D(uTexture, vTexCoord);
    vec4 mask = texture2D(uMask, vTexCoord);
    
    // 使用遮罩的亮度作为 Alpha
    float maskAlpha = dot(mask.rgb, vec3(0.299, 0.587, 0.114));
    
    gl_FragColor = vec4(color.rgb, color.a * maskAlpha);
}
</code></pre>
<h3 data-id="heading-20">6. 性能优化</h3>
<h4 data-id="heading-21">6.1 纹理单元管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextureManager</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BASE = <span class="hljs-number">0</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_BLEND = <span class="hljs-number">1</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TEXTURE_UNIT_WATERMARK = <span class="hljs-number">2</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindTextures</span><span class="hljs-params">(baseTexture: <span class="hljs-type">Int</span>, blendTexture: <span class="hljs-type">Int</span>, watermarkTexture: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 底图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BASE)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, baseTexture)
        
        <span class="hljs-comment">// 混合图</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_BLEND)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, blendTexture)
        
        <span class="hljs-comment">// 水印</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0 + TEXTURE_UNIT_WATERMARK)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, watermarkTexture)
    }
}
</code></pre>
<h4 data-id="heading-22">6.2 减少纹理切换</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 不好的做法：频繁切换纹理单元</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjects</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    objects.forEach { obj -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, obj.texture)
        obj.draw()
    }
}

<span class="hljs-comment">// ✅ 好的做法：批量渲染相同纹理的对象</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">renderObjectsBatched</span><span class="hljs-params">(objects: <span class="hljs-type">List</span>&lt;<span class="hljs-type">RenderObject</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> grouped = objects.groupBy { it.texture }
    grouped.forEach { (texture, objs) -&gt;
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture)
        objs.forEach { it.draw() }
    }
}
</code></pre>
<h4 data-id="heading-23">6.3 纹理压缩</h4>
<p>对于水印等辅助纹理，可以使用较低分辨率或压缩格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 调整水印尺寸</span>
<span class="hljs-keyword">val</span> watermarkSize = <span class="hljs-number">256</span>  <span class="hljs-comment">// 不需要很高分辨率</span>
<span class="hljs-keyword">val</span> scaledWatermark = Bitmap.createScaledBitmap(
    originalWatermark, 
    watermarkSize, 
    watermarkSize, 
    <span class="hljs-literal">true</span>
)
</code></pre>
<h3 data-id="heading-24">7. 多纹理的限制</h3>
<h4 data-id="heading-25">7.1 查询纹理单元数量</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> maxTextureUnits = IntArray(<span class="hljs-number">1</span>)
GLES20.glGetIntegerv(GLES20.GL_MAX_TEXTURE_IMAGE_UNITS, maxTextureUnits, <span class="hljs-number">0</span>)
Log.d(TAG, <span class="hljs-string">"设备支持的最大纹理单元数: <span class="hljs-subst">${maxTextureUnits[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<p>OpenGL ES 2.0 规范要求至少支持 8 个纹理单元，大多数设备支持 16-32 个。</p>
<h4 data-id="heading-26">7.2 纹理内存管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 监控纹理内存使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">estimateTextureMemory</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>, format: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">val</span> bytesPerPixel = <span class="hljs-keyword">when</span> (format) {
        GLES20.GL_RGBA -&gt; <span class="hljs-number">4</span>
        GLES20.GL_RGB -&gt; <span class="hljs-number">3</span>
        GLES20.GL_LUMINANCE_ALPHA -&gt; <span class="hljs-number">2</span>
        GLES20.GL_LUMINANCE -&gt; <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">4</span>
    }
    <span class="hljs-keyword">return</span> width * height * bytesPerPixel
}

<span class="hljs-comment">// 示例：1920x1080 RGBA 纹理 = 8.3 MB</span>
<span class="hljs-keyword">val</span> memory = estimateTextureMemory(<span class="hljs-number">1920</span>, <span class="hljs-number">1080</span>, GLES20.GL_RGBA)
Log.d(TAG, <span class="hljs-string">"纹理内存占用: <span class="hljs-subst">${memory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>}</span> MB"</span>)
</code></pre>
<h2 data-id="heading-27">💻 代码实践</h2>
<h3 data-id="heading-28">今日任务</h3>
<p>实现一个多纹理混合应用：</p>
<ol>
<li><strong>加载两张图片</strong></li>
<li><strong>实现多种混合模式</strong>：
<ul>
<li>Alpha 混合</li>
<li>相加</li>
<li>相乘</li>
<li>屏幕</li>
<li>叠加</li>
<li>柔光</li>
</ul>
</li>
<li><strong>添加水印功能</strong></li>
<li><strong>提供透明度调节</strong></li>
</ol>
<h3 data-id="heading-29">实现效果</h3>
<ul>
<li>🖼️ 同时加载两张纹理</li>
<li>🎨 6 种混合模式实时切换</li>
<li>💧 透明度 SeekBar 调节</li>
<li>🏷️ 水印位置和透明度控制</li>
</ul>
<h3 data-id="heading-30">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day08Renderer</span>(context: Context) : GLSurfaceView.Renderer {

    <span class="hljs-comment">// 多纹理 ID</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture1: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 底图</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> texture2: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>  <span class="hljs-comment">// 叠加图</span>

    <span class="hljs-comment">// 混合模式</span>
    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlendMode</span> {
        ALPHA,      <span class="hljs-comment">// Alpha 混合</span>
        ADD,        <span class="hljs-comment">// 相加</span>
        MULTIPLY,   <span class="hljs-comment">// 相乘</span>
        SCREEN,     <span class="hljs-comment">// 屏幕</span>
        OVERLAY,    <span class="hljs-comment">// 叠加</span>
        SOFT_LIGHT  <span class="hljs-comment">// 柔光</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentBlendMode = BlendMode.ALPHA
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> blendAlpha = <span class="hljs-number">0.5f</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
        <span class="hljs-comment">// 激活纹理单元 0</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
        GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)

        <span class="hljs-comment">// 激活纹理单元 1</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
        GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
        GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)

        <span class="hljs-comment">// 设置混合模式</span>
        GLES20.glUniform1i(blendModeLocation, currentBlendMode.ordinal)
        GLES20.glUniform1f(alphaLocation, blendAlpha)

        <span class="hljs-comment">// 绘制</span>
        drawQuad()
    }
}
</code></pre>
<h2 data-id="heading-31">🧪 练习任务</h2>
<h3 data-id="heading-32">基础任务</h3>
<ol>
<li>✅ 实现两个纹理的加载和绑定</li>
<li>✅ 实现至少 3 种混合模式</li>
<li>✅ 添加透明度调节功能</li>
</ol>
<h3 data-id="heading-33">进阶任务</h3>
<ol>
<li>🎨 实现水印功能（可调节位置和大小）</li>
<li>🖼️ 实现遮罩效果</li>
<li>🌈 实现双重曝光效果</li>
<li>📸 添加预设混合效果（复古、电影、梦幻等）</li>
</ol>
<h3 data-id="heading-34">挑战任务</h3>
<ol>
<li>🚀 实现三个纹理的混合（底图 + 叠加图 + 水印）</li>
<li>🎭 实现动态混合（混合比例随时间变化）</li>
<li>🎬 实现分区域混合（不同区域不同混合模式）</li>
<li>💾 保存混合后的图片到相册</li>
</ol>
<h2 data-id="heading-35">📖 知识点总结</h2>
<h3 data-id="heading-36">纹理单元 vs 纹理对象</h3>






























<table><thead><tr><th>特性</th><th>纹理单元</th><th>纹理对象</th></tr></thead><tbody><tr><td><strong>概念</strong></td><td>GPU 的"纹理槽位"</td><td>实际的纹理数据</td></tr><tr><td><strong>数量</strong></td><td>有限（通常 8-32 个）</td><td>可以创建很多</td></tr><tr><td><strong>操作</strong></td><td><code>glActiveTexture()</code></td><td><code>glBindTexture()</code></td></tr><tr><td><strong>类比</strong></td><td>USB 接口</td><td>U 盘</td></tr></tbody></table>
<h3 data-id="heading-37">混合模式对比</h3>








































<table><thead><tr><th>模式</th><th>视觉效果</th><th>常用场景</th></tr></thead><tbody><tr><td><strong>Alpha</strong></td><td>透明叠加</td><td>水印、UI 叠加</td></tr><tr><td><strong>Add</strong></td><td>增亮、发光</td><td>光效、粒子</td></tr><tr><td><strong>Multiply</strong></td><td>变暗、阴影</td><td>阴影、色彩校正</td></tr><tr><td><strong>Screen</strong></td><td>柔和增亮</td><td>柔光、氛围</td></tr><tr><td><strong>Overlay</strong></td><td>对比增强</td><td>照片滤镜</td></tr><tr><td><strong>Soft Light</strong></td><td>柔和混合</td><td>肖像美化</td></tr></tbody></table>
<h3 data-id="heading-38">最佳实践</h3>
<ol>
<li>✅ <strong>复用纹理单元</strong>：不要每帧都重新激活和绑定</li>
<li>✅ <strong>批量渲染</strong>：相同纹理的对象一起渲染</li>
<li>✅ <strong>纹理压缩</strong>：对辅助纹理使用较低分辨率</li>
<li>✅ <strong>及时释放</strong>：不再使用的纹理要删除</li>
<li>✅ <strong>检查限制</strong>：查询设备支持的最大纹理单元数</li>
</ol>
<h2 data-id="heading-39">🐛 常见问题</h2>
<h3 data-id="heading-40">Q1: 纹理显示是黑色的？</h3>
<p><strong>可能原因</strong>：</p>
<ol>
<li>纹理单元索引错误</li>
<li><code>glUniform1i</code> 传递的值不对应激活的纹理单元</li>
</ol>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 纹理单元 0</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture1)
GLES20.glUniform1i(texture1Location, <span class="hljs-number">0</span>)  <span class="hljs-comment">// 传递 0，不是 GL_TEXTURE0</span>

<span class="hljs-comment">// 纹理单元 1</span>
GLES20.glActiveTexture(GLES20.GL_TEXTURE1)
GLES20.glBindTexture(GLES20.GL_TEXTURE_2D, texture2)
GLES20.glUniform1i(texture2Location, <span class="hljs-number">1</span>)  <span class="hljs-comment">// 传递 1，不是 GL_TEXTURE1</span>
</code></pre>
<h3 data-id="heading-41">Q2: 混合效果不正确？</h3>
<p>检查是否启用了 OpenGL 混合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果使用硬件混合</span>
GLES20.glEnable(GLES20.GL_BLEND)
GLES20.glBlendFunc(GLES20.GL_SRC_ALPHA, GLES20.GL_ONE_MINUS_SRC_ALPHA)

<span class="hljs-comment">// 如果使用着色器混合</span>
<span class="hljs-comment">// 不需要启用 glBlend，直接在片段着色器中计算即可</span>
</code></pre>
<h3 data-id="heading-42">Q3: 水印位置不对？</h3>
<p>OpenGL 坐标系原点在左下角，而 UI 坐标系在左上角：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UI 坐标（左上角为原点）</span>
<span class="hljs-keyword">val</span> uiY = <span class="hljs-number">100f</span>

<span class="hljs-comment">// 转换为 OpenGL 坐标（左下角为原点）</span>
<span class="hljs-keyword">val</span> glY = screenHeight - uiY - watermarkHeight
</code></pre>
<h3 data-id="heading-43">Q4: 如何实现圆形水印？</h3>
<p>在着色器中使用距离函数：</p>
<pre><code class="hljs language-glsl" lang="glsl">void main() {
    vec2 center = vec2(0.5, 0.5);
    float dist = distance(watermarkCoord, center);
    
    // 圆形遮罩
    float alpha = smoothstep(0.5, 0.48, dist);
    
    vec4 watermarkColor = texture2D(uWatermark, watermarkCoord);
    watermarkColor.a *= alpha;
    
    gl_FragColor = mix(baseColor, watermarkColor, watermarkColor.a);
}
</code></pre>
<h2 data-id="heading-44">🔗 参考资料</h2>
<h3 data-id="heading-45">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FTexture" target="_blank" title="https://www.khronos.org/opengl/wiki/Texture" ref="nofollow noopener noreferrer">OpenGL ES Texture Units</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fopengl%2Fwiki%2FSampler_(GLSL)" target="_blank" title="https://www.khronos.org/opengl/wiki/Sampler_(GLSL)" ref="nofollow noopener noreferrer">GLSL Sampler Types</a></li>
</ul>
<h3 data-id="heading-46">混合模式参考</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fphotoblogstop.com%2Fphotoshop%2Fphotoshop-blend-modes-explained" target="_blank" title="https://photoblogstop.com/photoshop/photoshop-blend-modes-explained" ref="nofollow noopener noreferrer">Photoshop Blend Modes</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjamieowen%2Fglsl-blend" target="_blank" title="https://github.com/jamieowen/glsl-blend" ref="nofollow noopener noreferrer">WebGL Blend Modes</a></li>
</ul>
<h3 data-id="heading-47">推荐阅读</h3>
<ul>
<li>《Real-Time Rendering》- Chapter 5: Visual Appearance</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fgpugems%2Fgpugems3%2Fpart-iv-image-effects" target="_blank" title="https://developer.nvidia.com/gpugems/gpugems3/part-iv-image-effects" ref="nofollow noopener noreferrer">GPU Gems - Image Processing</a></li>
</ul>
<h2 data-id="heading-48">📝 今日总结</h2>
<p>今天我们深入学习了多重纹理和混合技术：</p>
<ol>
<li>✅ 理解了纹理单元的概念：GPU 中的"纹理槽位"</li>
<li>✅ 掌握了多纹理的使用流程：激活 → 绑定 → 传递索引</li>
<li>✅ 学习了 6 种常用混合模式：Alpha、Add、Multiply、Screen、Overlay、Soft Light</li>
<li>✅ 实现了实用效果：水印、双重曝光、遮罩</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>纹理单元允许我们在一次绘制中使用多个纹理</li>
<li><code>glActiveTexture()</code> 激活纹理单元，<code>glUniform1i()</code> 传递索引（不是 GL_TEXTURE 常量）</li>
<li>混合模式本质是不同的颜色计算公式</li>
<li>Alpha 通道是实现透明效果的关键</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案]]></title>    <link>https://juejin.cn/post/7570579125154725898</link>    <guid>https://juejin.cn/post/7570579125154725898</guid>    <pubDate>2025-11-10T07:58:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570579125154725898" data-draft-id="7570564840429305883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-10T07:58:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发丢数据深度剖析：MySQL锁机制与事务实战踩坑及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T07:58:21.000Z" title="Mon Nov 10 2025 07:58:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读33分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、理论来源于实践</h2>
<p><strong>现象</strong>：于2025-08-13 21:45:35，事实逻辑表将自身的指标与维度同步到原子服务的实现时，出现同步过来的指标与维度丢失。</p>
<p><strong>核心原因</strong>：两次重复的事实逻辑表同步时间非常相近，导致同步过来的指标与维度丢失。</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2997262148d24d5eb0167adf0eaa43d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=1VD8L2kEcgSenUN%2F%2FvANMxfw%2Bm4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h2 data-id="heading-1">2、倒带进事故现场</h2>
<p>逻辑表向原子服务同步的核心逻辑是 “先删后增”：删除旧数据→对比新老数据→插入新增数据，具体流程如下：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6649acaff23477fbc1cb6d5647fb50b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=5npYZVg7NlOPfHpPaeAoFn1CjtI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>整体业务代码精简逻辑如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Transactional</span>(rollbackFor = Exception.class)
public Map&lt;String, Object&gt; driveToAtomService(Map logicTableData, String erp) {
<span class="hljs-comment">//获得环境信息</span>
String env = driveLogicTable<span class="hljs-selector-class">.getString</span>(DRIVE_LOGIC_TABLE_ENV);
<span class="hljs-comment">//获取/更新实现id</span>
 Long logicTableId = <span class="hljs-built_in">getOrAddLogicTableId</span>(atomicServiceId, driveLogicTable, erp, EnvType.of(env));
<span class="hljs-comment">//删除关联指标</span>
 metricImplMapper<span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.singletonList(logicId));
<span class="hljs-comment">//获取请求中的所有的指标信息</span>
List&lt;MetricImplBO&gt; metricList = <span class="hljs-built_in">getMetricImpls</span>(logicTableData, logicTableId);
<span class="hljs-comment">//获取需要新增的指标实现(包含了查询库里现有的指标实现)</span>
List&lt;MetricImplRelBO&gt; metricImpls = metricImplMapper<span class="hljs-selector-class">.getMetricImpls</span>(logicTableId);
Set&lt;Long&gt; metricDefIdSet = metricImpls<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(MetricImplRelBO::getMetricDefId)<span class="hljs-selector-class">.collect</span>(Collectors.toSet());
List&lt;MetricImplBO&gt; addList = metricList<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(s -&gt; !metricDefIdSet.contains(s.getMetricDefId()))<span class="hljs-selector-class">.collect</span>(Collectors.toList());
<span class="hljs-comment">//将需要新增的指标实现插入数据库</span>
 <span class="hljs-built_in">addMetricImpl</span>(addList);

}
</code></pre>
<p>用一个请求进行举例：</p>
<pre><code class="hljs language-ruby" lang="ruby">{<span class="hljs-string">"header"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"appKey"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"uuid"</span><span class="hljs-symbol">:<span class="hljs-string">"ce7cef2d-c417-464a-a519-311599fddfca"</span></span>,<span class="hljs-string">"serviceName"</span><span class="hljs-symbol">:<span class="hljs-string">"driveToAtomService"</span></span>,<span class="hljs-string">"context"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"PIN"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}},<span class="hljs-string">"body"</span><span class="hljs-symbol">:</span>{<span class="hljs-string">"dimList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">72</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2501</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2484</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2502</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4591</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3822</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4523</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4524</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">76</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1767</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1907</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1598</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4620</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4621</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4622</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2504</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2485</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2486</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2487</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2488</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3077</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3080</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2483</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2482</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4851</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2503</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5070</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5044</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5087</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5144</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5145</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3089</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3680</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2223</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5428</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5101</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1315</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5247</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">3318</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5262</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">4646</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2252</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2254</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2959</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2958</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2728</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">2618</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">5061</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6032</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6375</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6388</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">6389</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1316</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"ALL"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1081</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1351</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1082</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1499</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"COMBINE"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1596</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1606</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1083</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>},{<span class="hljs-string">"isRequiredForFilter"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"supportCrossTopic"</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<span class="hljs-string">"dimDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1108</span>,<span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"FILTER"</span></span>}],<span class="hljs-string">"dimCombineList"</span><span class="hljs-symbol">:[]</span>,<span class="hljs-string">"metricList"</span><span class="hljs-symbol">:</span>[{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19872</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19873</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19875</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19945</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">17263</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"COUNT_DISTINCT"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">28017</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20242</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18450</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">20276</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18452</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18453</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">18456</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19866</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">21691</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>},{<span class="hljs-string">"lightDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"aggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"toSql"</span></span>,<span class="hljs-string">"middleAggregationType"</span><span class="hljs-symbol">:<span class="hljs-string">"DEFAULT"</span></span>,<span class="hljs-string">"extendDecorateIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867"</span></span>,<span class="hljs-string">"staticDecorateIdListCombination"</span><span class="hljs-symbol">:<span class="hljs-string">""</span></span>,<span class="hljs-string">"metricDefId"</span><span class="hljs-symbol">:</span><span class="hljs-number">19871</span>,<span class="hljs-string">"nameEnAtomic"</span><span class="hljs-symbol">:null</span>,<span class="hljs-string">"extendFunctionIdList"</span><span class="hljs-symbol">:<span class="hljs-string">"25,6,5,7,23,22,20,21,19,18,4,1,2,3,24"</span></span>}],<span class="hljs-string">"driveLogicTable"</span><span class="hljs-symbol">:<span class="hljs-string">"{"</span>dimensionType<span class="hljs-string">":"</span>DETAIL<span class="hljs-string">","</span>oldNameCn<span class="hljs-string">":"</span></span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>atomicAliasProd<span class="hljs-string">":"</span>prod<span class="hljs-string">","</span>implServiceTypeKey<span class="hljs-string">":"</span>realtime<span class="hljs-string">","</span>originPhysicDataSourceId<span class="hljs-string">":0,"</span>nameCn<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>description<span class="hljs-string">":"</span>七鲜实时交易_for地推中间态新老标志<span class="hljs-string">","</span>driveLogicTableId<span class="hljs-string">":9881,"</span>driveLogicTableEnv<span class="hljs-string">":"</span><span class="hljs-variable constant_">DEV</span><span class="hljs-string">","</span>commonDecorateIdList<span class="hljs-string">":"</span><span class="hljs-number">9665</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">3270</span>,<span class="hljs-number">3271</span>,<span class="hljs-number">4556</span>,<span class="hljs-number">8012</span>,<span class="hljs-number">8270</span>,<span class="hljs-number">6030</span>,<span class="hljs-number">7247</span>,<span class="hljs-number">6031</span>,<span class="hljs-number">7248</span>,<span class="hljs-number">6032</span>,<span class="hljs-number">7249</span>,<span class="hljs-number">6033</span>,<span class="hljs-number">7250</span>,<span class="hljs-number">6034</span>,<span class="hljs-number">6035</span>,<span class="hljs-number">2134</span>,<span class="hljs-number">7254</span>,<span class="hljs-number">7255</span>,<span class="hljs-number">2085</span>,<span class="hljs-number">619</span>,<span class="hljs-number">620</span>,<span class="hljs-number">5997</span>,<span class="hljs-number">1586</span>,<span class="hljs-number">7867</span>,<span class="hljs-number">6845</span><span class="hljs-string">","</span>atomicAliasPre<span class="hljs-string">":"</span>pre<span class="hljs-string">","</span>committer<span class="hljs-string">":"</span>panjingrong<span class="hljs-string">","</span>physicDataSourceId<span class="hljs-string">":9494,"</span>storageType<span class="hljs-string">":"</span><span class="hljs-variable constant_">ONLINE</span><span class="hljs-string">","</span>atomicAliasDev<span class="hljs-string">":"</span>pre<span class="hljs-string">"}"</span>,<span class="hljs-string">"atomicServiceId"</span><span class="hljs-symbol">:</span><span class="hljs-number">1088</span>},<span class="hljs-string">"pin"</span><span class="hljs-symbol">:<span class="hljs-string">"wanyue3"</span></span>}
</code></pre>
<p>共计15个指标，64个维度</p>


















































































<table><thead><tr><th>请求1(事务)</th><th>请求2(事务)</th><th>﻿</th><th/><th/></tr></thead><tbody><tr><td>21:06:17.262</td><td>进入同步方法</td><td>21:06:17.263</td><td>进入同步方法</td><td>﻿</td></tr><tr><td>21:06:17.063</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview1)</td><td>21:06:17.363</td><td>select unify_metric_impl where logic_id = 3245 查询出15条数据(快照读，readview2)</td><td>﻿</td></tr><tr><td>21:06:17.363</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>21:06:17.372</td><td>delete from unify_metric_impl where logic_id = 3245</td><td>﻿</td></tr><tr><td>21:06:17.459</td><td>select unify_metric_impl where logic_id = 3245 查询出0条数据</td><td>﻿</td><td>delete 由于logic_id不是索引，会表锁阻塞</td><td>﻿</td></tr><tr><td>21:06:18.459</td><td>insert into unify_metric_impl 插入的logic_id = 3245的数据，15条</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>21:06:19.408</td><td>方法结束</td><td>﻿</td><td>﻿</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:19.529</td><td>删除成功</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.362</td><td>select unify_metric_impl where logic_id = 3245 得到 15条数据</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:20.435</td><td>读出15条数据，比较本次是否有新增指标， 得出没有新增指标，因此不进行新增。addAtomicMetricNameForDrive addList empty</td><td>﻿</td></tr><tr><td>﻿</td><td>﻿</td><td>21:06:21.435</td><td>方法结束</td><td>﻿</td></tr></tbody></table>
<p>﻿</p>
<p><strong>核心结论点</strong>：</p>
<p>1.请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<p>2.请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<p>﻿</p>
<h2 data-id="heading-2">3、结论点深度剖析</h2>
<h3 data-id="heading-3">3.1 分析结论一</h3>
<p>请求2的删除操作被阻塞了，直到请求1执行完整个方法。</p>
<h4 data-id="heading-4">3.1.1 复习mysql的InnoDB锁机制</h4>
<h5 data-id="heading-5">3.1.1.1 不是“一把锁”，而是 “锁矩阵”</h5>



































<table><thead><tr><th>锁粒度</th><th>共享锁（S 锁） （读锁，允许多读）</th><th>排他锁（X 锁） （写锁，独占）</th><th>意向锁（表级，辅助判断）</th></tr></thead><tbody><tr><td><strong>表级</strong></td><td>表 S 锁（极少用，如<code>LOCK TABLES ... READ</code>）</td><td>表 X 锁（极少用，如<code>LOCK TABLES ... WRITE</code>）</td><td>意向 S 锁（IS）、意向 X 锁（IX）</td></tr><tr><td><strong>行级</strong></td><td>行 S 锁（<code>SELECT ... FOR SHARE</code>）</td><td>行 X 锁（<code>UPDATE/DELETE/INSERT</code>默认加）</td><td>（行锁无需意向锁）</td></tr><tr><td><strong>间隙级</strong></td><td>间隙 S 锁（无，间隙只防插入）</td><td>间隙 X 锁（防其他事务插入相同间隙）</td><td>无</td></tr><tr><td><strong>Next-Key</strong></td><td>无</td><td>Next-Key 锁（行锁 + 间隙锁，默认行锁算法）</td><td>无</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-6">3.1.1.2 一张图总结：InnoDB 锁的 “决策逻辑”</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a63fcb8e5894899b983a55a5591fa44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=fE70zOi0aQzyezxUrKWq8xYzwMc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7">3.1.2 理论应用实践</h4>
<h5 data-id="heading-8">3.1.2.1 本次事故的物料：</h5>
<p>mysql表：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CREATE</span> <span class="hljs-selector-tag">TABLE</span> `<span class="hljs-selector-tag">unify_metric_impl</span>` (
  <span class="hljs-built_in">`id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">50</span>) unsigned <span class="hljs-keyword">NOT</span> NULL AUTO_INCREMENT COMMENT <span class="hljs-string">'自增ID'</span>,
  <span class="hljs-built_in">`metric_def_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'指标定义id'</span>,
  <span class="hljs-built_in">`logic_table_id`</span> <span class="hljs-built_in">bigint</span>(<span class="hljs-number">11</span>) unsigned <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'逻辑表id'</span>,
  <span class="hljs-built_in">`name_en_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'真实指标名'</span>,
  <span class="hljs-built_in">`committer`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'负责人'</span>,
  <span class="hljs-built_in">`create_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'开始时间'</span>,
  <span class="hljs-built_in">`update_time`</span> timestamp <span class="hljs-keyword">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT <span class="hljs-string">'修改时间'</span>,
  <span class="hljs-built_in">`metric_atomic_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'原子指标id'</span>,
  <span class="hljs-built_in">`decorate_id_list_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'修饰列表'</span>,
  <span class="hljs-built_in">`name_cn_alias_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中文别名'</span>,
  <span class="hljs-built_in">`metric_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标类型：DERIVE 衍生指标，FORMULA 复合指标'</span>,
  <span class="hljs-built_in">`description_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标说明'</span>,
  <span class="hljs-built_in">`data_type_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'数据类型：STRING，DOUBLE, LONG, INT'</span>,
  <span class="hljs-built_in">`data_accuracy_temp`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'2'</span> COMMENT <span class="hljs-string">'数据精度-小数点后几位'</span>,
  <span class="hljs-built_in">`security_level_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'安全等级'</span>,
  <span class="hljs-built_in">`logic_table_id_excel_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">'-1'</span> COMMENT <span class="hljs-string">'模型excelId'</span>,
  <span class="hljs-built_in">`implement_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标实现类型：APP、ATOMIC 原子服务'</span>,
  <span class="hljs-built_in">`app_ori_metric_name_temp`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`name_en_depend_atomic`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'指标依赖字段'</span>,
  <span class="hljs-built_in">`name_en_depend_app`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">16</span>) DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'所依赖的app层原始名字（适用于导数任务改变字段的情况）'</span>,
  <span class="hljs-built_in">`update_status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`status`</span> <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'信息更新状态 0-未完成更新，1-完成更新'</span>,
  <span class="hljs-built_in">`light_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'点灯修饰id列表'</span>,
  <span class="hljs-built_in">`extend_decorate_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的动态修饰id列表'</span>,
  <span class="hljs-built_in">`extend_function_id_list`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的原子服务函数id列表'</span>,
  <span class="hljs-built_in">`aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'聚合类型:ORIGINAL 原值 COUNT 计数 DISTINCT 指定字段去重 SUM 求和 AVG  均值 MIN 求最大值 MAX 求最小值 QUANTITLE 求分位数'</span>,
  <span class="hljs-built_in">`middle_aggregation_type`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'中间层类型,UNKNOWN:未知,AGG_BY_FIELD:按聚合字段分组后聚合,AGG_BY_DAY:按天去重后累加'</span>,
  <span class="hljs-built_in">`static_decorate_id_list_combination`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">1024</span>) <span class="hljs-keyword">NOT</span> NULL DEFAULT <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'支持的固化修饰id列表组合,[[d1,d2],[d2]]'</span>,
  PRIMARY KEY (<span class="hljs-built_in">`id`</span>),
  KEY <span class="hljs-built_in">`idx_metric_def_id`</span> (<span class="hljs-built_in">`metric_def_id`</span>,<span class="hljs-built_in">`logic_table_id`</span>)
) <span class="hljs-selector-tag">ENGINE</span>=<span class="hljs-selector-tag">InnoDB</span> <span class="hljs-selector-tag">DEFAULT</span> <span class="hljs-selector-tag">CHARSET</span>=<span class="hljs-selector-tag">utf8</span> <span class="hljs-selector-tag">COMMENT</span>='指标实现';
</code></pre>
<h5 data-id="heading-9">3.1.2.2 实践分析</h5>
<p>通过mysql的innoDB的锁决策，可以得出</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">//删除关联指标</span>
 <span class="hljs-selector-tag">metricImplMapper</span><span class="hljs-selector-class">.deleteByLogicTableIds</span>(Collections.<span class="hljs-built_in">singletonList</span>(logicId));
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>mysql的索引：KEY <code>idx_metric_def_id</code> (<code>metric_def_id</code>,<code>logic_table_id</code>)</p>
<p>删除写操作，不符合最左匹配原则，因此为表x锁。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99194a4d15d54c0191109be0686aee3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=0yUr5CBGAqfBkmNs%2F%2Fhvd9R7yVg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>因此请求2的删除操作需要等待请求1的事务释放表锁后才可继续进行，符合当时场景。</p>
<p>﻿</p>
<h3 data-id="heading-10">3.2 分析结论二</h3>
<p>请求2中去查看当前实现的指标的时候，发现库里已经存在所有指标不会进行新增，与上一步删除的逻辑相悖。</p>
<h4 data-id="heading-11">3.2.1 复习Mysql的事务</h4>
<h5 data-id="heading-12">3.2.1.1 ACID 不是 "四个独立特性"，而是 "因果链"</h5>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dd42117c88e478ca165db2bec4947f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=GauWe4zg0sQbWvYSqOG%2FMF6Mm4Q%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•<strong>一句话</strong>：ACID 的核心是<strong>一致性</strong>，其他三个特性都是为了实现它的手段。</p>
<p>•<strong>一致性</strong>（Consistency）：一致性确保事务将数据库从一个一致的状态转变到另一个一致的状态。即使在多个事务同时执行的情况下，数据库也能保持数据的一致性。</p>
<p>•<strong>原子性</strong>（Atomicity）：事务是 "不可分割的工作单元"（要么全成，要么全败），是一致性的<strong>前提</strong>（如果步骤能拆分，中间失败就会破坏一致性）。</p>
<p>•<strong>隔离性</strong>（Isolation）：通过控制多事务并发规则，避免互相干扰，是一致性的<strong>保障</strong>（并发混乱会直接破坏一致性）。</p>
<p>•<strong>耐久性</strong>（Durability）：事务提交后结果永久保存，是一致性的<strong>最终落点</strong>（否则重启后数据丢失，之前的一致性白搭）。</p>
<p>﻿</p>
<h5 data-id="heading-13">3.2.1.2 隔离级别：不是 "越严越好"，而是 "成本与需求的平衡术"</h5>
<p>InnoDB 的 4 种隔离级别，本质是用 "数据可见性" 换 "并发性能"的选择：</p>








































<table><thead><tr><th>隔离级别</th><th>解决的问题</th><th>无法解决的问题</th><th>性能消耗</th><th>典型场景</th></tr></thead><tbody><tr><td>读未提交（RU）</td><td>无</td><td>脏读、不可重复读、幻读</td><td>极低</td><td>实时监控（允许脏数据）</td></tr><tr><td>读已提交（RC）</td><td>脏读</td><td>不可重复读、幻读</td><td>低</td><td>互联网普通业务</td></tr><tr><td>可重复读（RR，默认）</td><td>脏读、不可重复读</td><td>幻读（被 Next-Key 锁解决）</td><td>中</td><td>金融交易、库存管理</td></tr><tr><td>串行化（Serializable）</td><td>所有并发问题</td><td>无</td><td>极高</td><td>银行对账（无并发需求）</td></tr></tbody></table>
<p>﻿</p>
<h5 data-id="heading-14">3.2.1.3 MVCC：事务的 "平行宇宙" 机制（为什么读写不冲突？）</h5>
<p>InnoDB 的<strong>多版本并发控制</strong>是 "无锁读" 的核心，它让读和写像在平行宇宙中运行：</p>
<p><strong>底层逻辑（用 "时间戳" 理解</strong>）：</p>
<p>•每个事务启动时，会拿到一个<strong>全局递增的事务 ID（trx_id）</strong> 。</p>
<p>•每行数据隐藏 3 个字段：</p>
<p>◦<code>DB_TRX_ID</code>：最后修改该行的事务 ID；</p>
<p>◦<code>DB_ROLL_PTR</code>：指向 undo 日志的指针（存储历史版本）；</p>
<p>◦<code>DB_DELETED</code>：标记是否删除（逻辑删除）。</p>
<p><strong>读操作的 "幻术"</strong> ：</p>
<p>•<strong>快照读</strong>（普通 SELECT）：只看 "事务 ID ≤ 自己 ID" 且 "未被删除" 的版本，完全不加锁。 例：事务 A（ID=100）查询时，会忽略所有被 ID&gt;100 的事务修改的数据。</p>
<p>包含 4 个核心字段：</p>
<p>•<code>m_ids</code>：生成 Read View 时，<strong>当前活跃的事务 ID 列表</strong>（未提交的事务）。</p>
<p>•<code>min_trx_id</code>：<code>m_ids</code>中最小的事务 ID。</p>
<p>•<code>max_trx_id</code>：下一个将要分配的事务 ID（非活跃事务 ID，仅用于判断 “未来事务”）。</p>
<p>•<code>creator_trx_id</code>：生成该 Read View 的事务自身 ID。</p>
<p><strong>可见性判断规则</strong>（一条记录是否对当前事务可见，取决于其 “最后修改事务 ID”，记为<code>db_trx_id</code>）：</p>
<p>1.若db_trx_id == creator_trx_id：可见（自己修改的自己可见）。</p>
<p>2.若db_trx_id &lt; min_trx_id：可见（修改记录的事务在当前快照生成前已提交）。</p>
<p>3.若db_trx_id &gt;= max_trx_id：不可见（修改记录的事务在当前快照生成后才启动）。</p>
<p>4.若min_trx_id ≤ db_trx_id &lt; max_trx_id：</p>
<p>◦若db_trx_id在m_ids中：不可见（该事务仍活跃，未提交）。</p>
<p>◦若db_trx_id不在m_ids中：可见（该事务已提交）。</p>
<p>5.当前读（加锁读 / 写操作）：读取最新版本，并加锁防止其他事务修改。</p>
<h5 data-id="heading-15">3.2.1.4 事务日志：InnoDB 的 "安全与性能" 平衡术</h5>
<p>事务能既保证 durability 又不慢，全靠两大日志：</p>
<p>1.<strong>redo log（重做日志）</strong> ：</p>
<p>◦作用：崩溃后恢复未写入磁盘的数据（保证 durability）。</p>
<p>◦反直觉：事务提交时，数据先写 redo log（内存 + 磁盘），再异步刷到数据文件（这叫 WAL 技术）。</p>
<p>◦为什么快？redo log 是<strong>顺序写</strong>（磁盘顺序写比随机写快 100 倍 +）。</p>
<p>2.<strong>undo log（回滚日志）</strong> ：</p>
<p>◦作用：保存数据修改前的版本，用于事务回滚（保证 atomicity）和 MVCC 快照读。</p>
<p>◦注意：undo log 会被 purge 线程定期清理（当没有事务需要旧版本时）。</p>
<h5 data-id="heading-16">3.2.1.5 终极心法：事务设计的 "3 个凡是"</h5>
<p>1.<strong>凡是不需要事务的操作，坚决不用</strong>（如日志插入可关闭自动提交，批量提交）。</p>
<p>2.<strong>凡是能在 RC 解决的，绝不升 RR</strong>（互联网业务优先选 RC，用业务逻辑防不可重复读）。</p>
<p>3.<strong>凡是大事务，必拆分成 "读 - 算 - 写" 三步</strong>（读阶段不加锁，算阶段在应用层，写阶段用最短事务加锁）。</p>
<p>记住：事务的本质不是 "约束"，而是 "工具"—— 能解决问题的最简单事务，才是最好的事务。</p>
<p>﻿</p>
<h4 data-id="heading-17">3.2.2 理论应用实践</h4>
<h5 data-id="heading-18">3.2.2.1 本次事故的物料：</h5>
<p>表的事务等级：</p>
<pre><code class="hljs language-scss" lang="scss">SELECT @<span class="hljs-keyword">@transaction</span>_isolation;
</code></pre>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e9bed606d5345bb811ff2d41995659f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=S8WVV%2FOWw9D4Y6lUA3hODMHPyDE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>需要删除的指标实现(根据实现id):</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">delete <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-number">45631</span></span>)</span>;
</code></pre>
<p>需要插入的指标实现：</p>
<pre><code class="hljs language-go" lang="go">INSERT INTO <span class="hljs-string">`unify_metric_impl`</span> (<span class="hljs-string">`id`</span>, <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
VALUES
	(<span class="hljs-number">1358195</span>, <span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358196</span>, <span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358197</span>, <span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358198</span>, <span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358199</span>, <span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358200</span>, <span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358201</span>, <span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358202</span>, <span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358203</span>, <span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358204</span>, <span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358205</span>, <span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358206</span>, <span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358207</span>, <span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358208</span>, <span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">1358209</span>, <span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);
</code></pre>
<h5 data-id="heading-19">3.2.2.2 实践分析：</h5>
<p>用sql模拟两个事务的执行过程：</p>
<p>事务1：</p>
<pre><code class="hljs language-javascript" lang="javascript">begin;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl where logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-variable constant_">SELECT</span> trx_id, trx_query <span class="hljs-variable constant_">FROM</span> <span class="hljs-variable constant_">INFORMATION_SCHEMA</span>.<span class="hljs-property">INNODB_TRX</span>;

select * <span class="hljs-keyword">from</span> unify_metric_impl umi where logic_table_id =  <span class="hljs-number">45631</span>;

<span class="hljs-variable constant_">INSERT</span> <span class="hljs-variable constant_">INTO</span> <span class="hljs-string">`unify_metric_impl`</span> ( <span class="hljs-string">`metric_def_id`</span>, <span class="hljs-string">`logic_table_id`</span>, <span class="hljs-string">`name_en_atomic`</span>, <span class="hljs-string">`committer`</span>, <span class="hljs-string">`create_time`</span>, <span class="hljs-string">`update_time`</span>, <span class="hljs-string">`metric_atomic_name_temp`</span>, <span class="hljs-string">`decorate_id_list_temp`</span>, <span class="hljs-string">`name_cn_alias_temp`</span>, <span class="hljs-string">`metric_type_temp`</span>, <span class="hljs-string">`description_temp`</span>, <span class="hljs-string">`data_type_temp`</span>, <span class="hljs-string">`data_accuracy_temp`</span>, <span class="hljs-string">`security_level_temp`</span>, <span class="hljs-string">`logic_table_id_excel_temp`</span>, <span class="hljs-string">`implement_type`</span>, <span class="hljs-string">`app_ori_metric_name_temp`</span>, <span class="hljs-string">`name_en_depend_atomic`</span>, <span class="hljs-string">`name_en_depend_app`</span>, <span class="hljs-string">`update_status`</span>, <span class="hljs-string">`status`</span>, <span class="hljs-string">`light_decorate_id_list`</span>, <span class="hljs-string">`extend_decorate_id_list`</span>, <span class="hljs-string">`extend_function_id_list`</span>, <span class="hljs-string">`aggregation_type`</span>, <span class="hljs-string">`middle_aggregation_type`</span>, <span class="hljs-string">`static_decorate_id_list_combination`</span>)
<span class="hljs-variable constant_">VALUES</span>
	(<span class="hljs-number">19872</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19873</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19875</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19945</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_sku_deal_ord_sku_dis_qtty_main_img_video_num'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">17263</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">28017</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_bd_bd_attendance_offline__store_cnt_bd_attendance_cnt'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'COUNT_DISTINCT'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20242</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18450</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">20276</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_app__ord_cnt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18452</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18453</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_user_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">18456</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_sku_dis_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19866</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_ord_amt_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">21691</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_deal_ord_ord_amt_include_moutai'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>),
	(<span class="hljs-number">19871</span>, <span class="hljs-number">45631</span>, <span class="hljs-string">'jdr_7fresh_trade_complete_ord_sku_qtty_deal_7fresh'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">'2025-09-02 09:23:41'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">'-1'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'4556,8012,8270,7247,7248,7249,7250,2134,7254,7255,5997,7867'</span>, <span class="hljs-string">'25,6,5,7,23,22,20,21,19,18,4,1,2,3,24'</span>, <span class="hljs-string">'toSql'</span>, <span class="hljs-string">'DEFAULT'</span>, <span class="hljs-string">''</span>);

commit;
</code></pre>
<p>﻿</p>
<p>事务2：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">begin</span>;

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> unify_metric_impl <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-keyword">in</span> (<span class="hljs-number">45631</span>);

<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> unify_metric_impl umi <span class="hljs-keyword">where</span> logic_table_id <span class="hljs-operator">=</span>  <span class="hljs-number">45631</span>;

<span class="hljs-keyword">commit</span>;
</code></pre>
<p>﻿</p>
<p>流程图(用一行数据进行演示版本控制)：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/259104ee5b684d4cad1073bfca57cde9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763366301&amp;x-signature=FLMhTrOT5MG0zGyr571kYG0R7X4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>为何事务1的select查询出“为空”，事务2的select查询出“不为空”：</p>






























<table><thead><tr><th>对比维度</th><th>事务 1 查询（读自己的删除版本 V2）</th><th>事务 2 查询（读readview前的V1版本）</th></tr></thead><tbody><tr><td>自己生成的版本</td><td>V2（trx_id=17190，已删除）</td><td>V4（trx_id=17191，已删除）</td></tr><tr><td>对自己版本的处理</td><td>可见，且<strong>事务内需反映自己的删除操作</strong>，所以不追溯前驱 V1</td><td>不可见，但<strong>当前删除的版本是由其他事务得到(V3)</strong> ，并非在readview之前的数据。</td></tr><tr><td>追溯的终止条件</td><td>遇到自己生成的版本，即使已删除，也终止追溯</td><td>遇到自己生成的已删除版本，但不符合"有效删除"，需继续追溯</td></tr><tr><td>最终返回结果</td><td>v2（已删除版本，反映自己的删除操作）</td><td>V1（readview之前有效的版本）</td></tr></tbody></table>
<p>﻿</p>
<h2 data-id="heading-20">4.解决办法</h2>
<p>为了解决事务2的查询"不为空"的问题，分别列出以下方案：</p>

































<table><thead><tr><th>﻿</th><th>解决办法</th><th>优点</th><th>缺点</th><th>倾向</th></tr></thead><tbody><tr><td>方式1</td><td>针对同一个逻辑表的同步添加分布式锁</td><td>实现成本低，影响范围小</td><td>存在长事务的问题</td><td>短期解法</td></tr><tr><td>方式2</td><td>将事务2的select改为当前读(使用slecet...for update)，这样就能查询出最新的数据为空</td><td>实现成本低，</td><td>存在长事务的问题，影响范围大(长事务涉及逻辑多)</td><td>不推荐</td></tr><tr><td>方式3</td><td>将长事务拆分， <strong>"读 - 算 - 写" 三步</strong> 1. 读：无锁读取原子服务与实现数据； 2. 算：在应用层对比新增 / 删除数据； 3. 写：仅对差异数据执行短事务操作</td><td>从根源解决问题</td><td>实现成本大，重构该方法</td><td>长期解法</td></tr></tbody></table>
<p><strong>当前落地情况</strong>：已通过 “分布式锁控制同一逻辑表同步并发” 的短期方案解决事故，后续将在业务迭代中推进 “读 - 算 - 写” 拆分的长期优化，进一步降低事务粒度与锁冲突风险。</p>
<h2 data-id="heading-21">5.附录</h2>
<h3 data-id="heading-22">5.1名词解释</h3>
<p>事实逻辑表：由物理数仓中的事实表和维度逻辑表关联形成的语义表，可以描述业务过程的详细信息，是指标的数据来源。</p>
<p>原子服务：指标的实现方式，一个指标可以有多个实现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KuiklyUI的ViewRef设计]]></title>    <link>https://juejin.cn/post/7570902804450934794</link>    <guid>https://juejin.cn/post/7570902804450934794</guid>    <pubDate>2025-11-10T09:55:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570902804450934794" data-draft-id="7570902804450836490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KuiklyUI的ViewRef设计"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-10T09:55:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风冷"/> <meta itemprop="url" content="https://juejin.cn/user/3843548379091742"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KuiklyUI的ViewRef设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548379091742/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风冷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T09:55:33.000Z" title="Mon Nov 10 2025 09:55:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer的关系分析</h2>
<p>本文将深入分析KuiklyUI框架中nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer与ViewRef之间的关系，帮助您全面理解视图引用系统的设计与实现。</p>
<h3 data-id="heading-1">一、nativeRef的本质与工作机制</h3>
<h4 data-id="heading-2">1.1 nativeRef的定义与生成机制</h4>
<p>nativeRef是KuiklyUI中每个视图实例的唯一标识符，定义在AbstractBaseView类中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">abstract class AbstractBaseView&lt;A : Attr, E : Event&gt; : BaseObject(), IViewPublicApi&lt;A, E&gt;, IModuleAccessor, IPagerId {
    val nativeRef: Int = ++nativeRefProducer
    // ...
    companion object {
        var nativeRefProducer = 0
    }
}
</code></pre>
<p>nativeRef通过一个静态计数器<code>nativeRefProducer</code>自增生成，确保每个视图实例拥有全局唯一的标识符。这种设计使得框架可以在整个应用生命周期内精确识别每一个视图。</p>
<h4 data-id="heading-3">1.2 nativeRef在视图系统中的核心作用</h4>
<p>nativeRef在KuiklyUI框架中扮演着多重关键角色：</p>
<ol>
<li><strong>视图身份标识</strong>：作为视图实例的唯一身份标识</li>
<li><strong>视图引用传递</strong>：在父子视图之间传递引用关系</li>
<li><strong>跨层通信桥梁</strong>：连接Kotlin层与原生渲染层</li>
<li><strong>属性与事件绑定</strong>：在创建Attr和Event对象时被注入，用于后续属性更新和事件分发</li>
</ol>
<p>在AbstractBaseView的内部实现中，我们可以看到nativeRef被注入到Attr和Event对象中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/AbstractBaseView.kt">private fun internalCreateEvent(): E {
    val event = createEvent()
    event.init(pagerId,nativeRef)  // 将nativeRef注入到Event对象
    return event
}

protected fun internalCreateAttr(): A {
    val attr = createAttr()
    attr.pagerId = pagerId
    attr.nativeRef = nativeRef  // 将nativeRef注入到Attr对象
    attr.flexNode = flexNode
    return attr
}
</code></pre>
<h3 data-id="heading-4">二、ViewRef与nativeRef的关系</h3>
<h4 data-id="heading-5">2.1 ViewRef的定义与实现</h4>
<p>ViewRef是一个轻量级的引用封装类，定义在DeclarativeBaseView.kt中：</p>
<pre><code class="hljs language-kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt" lang="kotlin:/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/DeclarativeBaseView.kt">class ViewRef&lt;T : DeclarativeBaseView&lt;*, *&gt;&gt;(val pagerId: String, val nativeRef: Int) {
    val view: T?
        get() = PagerManager.getPager(pagerId)
            .getViewWithNativeRef(nativeRef) as? T
}
</code></pre>
<h4 data-id="heading-6">2.2 ViewRef与nativeRef的协作关系</h4>
<p>ViewRef与nativeRef之间存在着紧密的协作关系：</p>
<ol>
<li><strong>组成关系</strong>：ViewRef封装了pagerId和nativeRef两个核心属性</li>
<li><strong>定位机制</strong>：ViewRef通过pagerId和nativeRef组合定位到具体的视图实例</li>
<li><strong>延迟查找</strong>：ViewRef的<code>view</code>属性采用懒加载方式，只有在需要时才通过PagerManager查找视图</li>
<li><strong>类型安全</strong>：ViewRef使用泛型确保返回的视图类型正确</li>
</ol>
<h3 data-id="heading-7">三、ViewRef与AbstractBaseView的关系</h3>
<h4 data-id="heading-8">3.1 ref扩展函数的实现</h4>
<p>在DeclarativeBaseView中，实现了<code>ref</code>扩展函数，作为创建ViewRef的入口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : DeclarativeBaseView&lt;*, *&gt;</span>&gt; T.<span class="hljs-title">ref</span><span class="hljs-params">(ref: (<span class="hljs-type">viewRef</span>: <span class="hljs-type">ViewRef</span>&lt;<span class="hljs-type">T</span>&gt;) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    ref(ViewRef&lt;T&gt;(pagerId, nativeRef))
}
</code></pre>
<h4 data-id="heading-9">3.2 AbstractBaseView与ViewRef的交互流程</h4>
<p>AbstractBaseView与ViewRef的交互流程如下：</p>
<ol>
<li>AbstractBaseView实例创建时生成唯一的nativeRef</li>
<li>通过ref扩展函数，将当前视图的pagerId和nativeRef传递给ViewRef构造函数</li>
<li>ViewRef持有这些引用信息，但不直接持有视图实例</li>
<li>当需要访问视图时，通过ViewRef的<code>view</code>属性间接获取</li>
</ol>
<p>这种设计实现了视图引用的解耦，使框架能够更灵活地管理视图生命周期和内存。</p>
<h3 data-id="heading-10">四、ViewRef与Pager的协作机制</h3>
<h4 data-id="heading-11">4.1 Pager的视图引用管理</h4>
<p>Pager类实现了IPager接口，负责管理视图引用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Pager中管理视图引用的关键代码</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, AbstractBaseView&lt;*, *&gt;&gt;()

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">putNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>, view: <span class="hljs-type">AbstractBaseView</span>&lt;*, *&gt;)</span></span> {
    nativeRefViewMap[nativeRef] = view
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeNativeViewRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span> {
    nativeRefViewMap.remove(nativeRef)
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getViewWithNativeRef</span><span class="hljs-params">(nativeRef: <span class="hljs-type">Int</span>)</span></span>: AbstractBaseView&lt;*, *&gt;? {
    <span class="hljs-keyword">return</span> nativeRefViewMap[nativeRef]
}
</code></pre>
<h4 data-id="heading-12">4.2 ViewRef与Pager的协作流程</h4>
<p>ViewRef与Pager的协作流程如下：</p>
<ol>
<li>ViewRef持有pagerId和nativeRef信息</li>
<li>当调用ViewRef的<code>view</code>属性时，通过PagerManager获取对应pagerId的Pager实例</li>
<li>调用Pager的<code>getViewWithNativeRef</code>方法，通过nativeRef查找视图实例</li>
<li>将找到的视图实例转换为泛型T类型并返回</li>
</ol>
<p>这种设计使得ViewRef可以安全地在任何地方访问视图，而不需要直接持有视图实例的强引用，有利于内存管理和视图生命周期控制。</p>
<h3 data-id="heading-13">五、ViewContainer与ViewRef的关系</h3>
<h4 data-id="heading-14">5.1 ViewContainer的视图层次管理</h4>
<p>ViewContainer是所有容器视图的基类，负责管理子视图层次结构：</p>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">abstract class ViewContainer&lt;A : ContainerAttr, E : Event&gt; : DeclarativeBaseView&lt;A, E&gt;() {
    protected val children = fastArrayListOf&lt;DeclarativeBaseView&lt;*, *&gt;&gt;()
    // ...
}
</code></pre>
<h4 data-id="heading-15">5.2 ViewContainer中nativeRef的应用</h4>
<p>在ViewContainer中，nativeRef主要用于以下几个方面：</p>
<ol>
<li><strong>父视图引用传递</strong>：在添加子视图时，设置子视图的parentRef为当前容器的nativeRef</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">private fun internalAddChild(child: DeclarativeBaseView&lt;*, *&gt;, index: Int) {
    child.pagerId = pagerId
    child.willMoveToParentComponent()
    if (index &lt; 0) { // append when index -1
        children.add(child)
    } else {
        children.add(index, child)
    }
    child.parentRef = nativeRef  // 设置父视图引用
    child.didMoveToParentView()
}
</code></pre>
<ol start="2">
<li><strong>渲染视图管理</strong>：在创建和移除渲染视图时，使用nativeRef标识视图</li>
</ol>
<pre><code class="hljs language-kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt" lang="kotlin:/Users/hdh/Documents/codes/KuiklyUI/core/src/commonMain/kotlin/com/tencent/kuikly/core/base/ViewContainer.kt">override fun createRenderView() {
    createRenderViewing = true
    super.createRenderView()
    createRenderViewing = false
    var index = 0
    renderChildren().forEach { child -&gt;
        child.createRenderView()
        renderView?.insertSubRenderView(child.nativeRef, index++)  // 使用nativeRef标识子视图
        child.renderViewDidMoveToParentRenderView()
    }
}
</code></pre>
<ol start="3">
<li><strong>视图引用链建立</strong>：通过nativeRef和parentRef建立完整的视图引用链</li>
</ol>
<h4 data-id="heading-16">5.3 ViewContainer中ViewRef的使用场景</h4>
<p>在ViewContainer中，ViewRef主要用于以下场景：</p>
<ol>
<li><strong>子视图引用获取</strong>：通过ViewRef安全地获取子视图引用，进行操作或通信</li>
<li><strong>跨层级视图访问</strong>：在复杂布局中，通过ViewRef实现跨层级的视图访问</li>
<li><strong>视图生命周期管理</strong>：在视图添加、移除等生命周期事件中，通过ViewRef传递引用信息</li>
</ol>
<h3 data-id="heading-17">六、整体架构与数据流</h3>
<h4 data-id="heading-18">6.1 核心组件关系图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+      +------------------+      +------------------+</span>
|                  |      |                  |      |                  |
|  AbstractBaseView|&lt;<span class="hljs-comment">-----&gt;|    ViewRef       |&lt;-----&gt;|     Pager        |</span>
|                  |      |                  |      |                  |
+<span class="hljs-comment">--------^---------+      +------------------+      +------------------+</span>
         |
         |
+<span class="hljs-comment">--------+---------+      +------------------+</span>
|                  |      |                  |
|  ViewContainer   |&lt;<span class="hljs-comment">-----&gt;|   Declarative   |</span>
|                  |      |     BaseView     |
+<span class="hljs-comment">------------------+      +------------------+</span>
</code></pre>
<h4 data-id="heading-19">6.2 数据流向与交互模式</h4>
<p>在KuiklyUI的视图引用系统中，数据流向和交互模式如下：</p>
<ol>
<li><strong>创建阶段</strong>：视图实例创建时生成nativeRef，Pager注册视图引用</li>
<li><strong>引用封装</strong>：通过ref扩展函数创建ViewRef对象，封装pagerId和nativeRef</li>
<li><strong>引用访问</strong>：通过ViewRef的view属性，间接访问视图实例</li>
<li><strong>生命周期管理</strong>：在视图添加到容器或从容器移除时，更新parentRef和视图引用注册状态</li>
<li><strong>销毁阶段</strong>：视图销毁时，从Pager中移除视图引用</li>
</ol>
<h3 data-id="heading-20">七、设计优势与技术亮点</h3>
<h4 data-id="heading-21">7.1 设计优势</h4>
<ol>
<li><strong>解耦视图引用</strong>：ViewRef通过间接引用机制，实现了视图引用与视图实例的解耦</li>
<li><strong>内存优化</strong>：避免了不必要的强引用，有利于内存管理和垃圾回收</li>
<li><strong>类型安全</strong>：泛型设计确保了类型安全，减少了运行时类型转换错误</li>
<li><strong>灵活的视图访问</strong>：可以在任何地方通过ViewRef安全地访问视图，不受生命周期限制</li>
</ol>
<h4 data-id="heading-22">7.2 技术亮点</h4>
<ol>
<li><strong>唯一标识符生成机制</strong>：通过静态计数器生成全局唯一的nativeRef</li>
<li><strong>延迟查找策略</strong>：ViewRef的view属性采用懒加载方式，只有在需要时才查找视图</li>
<li><strong>引用链管理</strong>：通过nativeRef和parentRef建立完整的视图层次引用链</li>
<li><strong>跨平台兼容性</strong>：设计考虑了跨平台需求，nativeRef作为统一的视图标识符</li>
</ol>
<h3 data-id="heading-23">八、代码优化建议</h3>
<p>基于对ViewRef和nativeRef系统的分析，提出以下优化建议：</p>
<ol>
<li>
<p><strong>引用有效性检查增强</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在ViewRef的view属性中添加更完善的有效性检查</span>
<span class="hljs-keyword">val</span> view: T?
    <span class="hljs-keyword">get</span>() {
        <span class="hljs-keyword">val</span> pager = PagerManager.getPager(pagerId)
        <span class="hljs-keyword">if</span> (pager == <span class="hljs-literal">null</span> || !pager.isActive()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">val</span> view = pager.getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
        <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span> &amp;&amp; view.isDestroyed()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        }
        <span class="hljs-keyword">return</span> view
    }
</code></pre>
</li>
<li>
<p><strong>弱引用优化</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在Pager中考虑使用WeakReference存储视图引用，避免内存泄漏</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nativeRefViewMap = mutableMapOf&lt;<span class="hljs-built_in">Int</span>, WeakReference&lt;AbstractBaseView&lt;*, *&gt;&gt;&gt;()
</code></pre>
</li>
<li>
<p><strong>引用缓存机制</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为频繁访问的ViewRef添加缓存机制</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRef</span>&lt;<span class="hljs-type">T : DeclarativeBaseView&lt;*, *</span>&gt;&gt;(<span class="hljs-keyword">val</span> pagerId: String, <span class="hljs-keyword">val</span> nativeRef: <span class="hljs-built_in">Int</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cachedView: T? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastCacheTime: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">val</span> view: T?
        <span class="hljs-keyword">get</span>() {
            <span class="hljs-keyword">val</span> currentTime = System.currentTimeMillis()
            <span class="hljs-comment">// 缓存有效期100ms</span>
            <span class="hljs-keyword">if</span> (cachedView != <span class="hljs-literal">null</span> &amp;&amp; currentTime - lastCacheTime &lt; <span class="hljs-number">100</span>) {
                <span class="hljs-keyword">return</span> cachedView
            }
            cachedView = PagerManager.getPager(pagerId)
                .getViewWithNativeRef(nativeRef) <span class="hljs-keyword">as</span>? T
            lastCacheTime = currentTime
            <span class="hljs-keyword">return</span> cachedView
        }
}
</code></pre>
</li>
</ol>
<p>总结来看，nativeRef与ViewRef、AbstractBaseView、Pager以及ViewContainer之间形成了一套完整、高效的视图引用管理体系，为KuiklyUI框架提供了灵活、安全的视图访问机制。通过这种设计，框架能够有效地管理视图生命周期、优化内存使用，并提供一致的跨平台体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一个Bug看Android文本编辑的设计缺陷]]></title>    <link>https://juejin.cn/post/7570932873131294747</link>    <guid>https://juejin.cn/post/7570932873131294747</guid>    <pubDate>2025-11-10T13:24:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570932873131294747" data-draft-id="7570932873131278363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一个Bug看Android文本编辑的设计缺陷"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2025-11-10T13:24:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WAsbry"/> <meta itemprop="url" content="https://juejin.cn/user/3413335797139511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一个Bug看Android文本编辑的设计缺陷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3413335797139511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WAsbry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T13:24:41.000Z" title="Mon Nov 10 2025 13:24:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从一个Bug看Android文本编辑的设计缺陷</h2>
<h3 data-id="heading-1">💡 本文精华</h3>
<ul>
<li><strong>承接上文</strong>：第一篇解析了跨进程通信，本篇深入应用进程内部，剖析文本操作的设计缺陷</li>
<li><strong>核心矛盾</strong>：InputFilter期望控制所有文本操作，但delete()绕过了过滤机制</li>
<li><strong>关键发现</strong>：<code>replaceText()</code>先delete后insert，delete传入空字符串""，InputFilter认为合法放行</li>
<li><strong>深层原因</strong>：Span范围在insert失败后与实际文本不同步，导致范围异常扩展，吞噬更多字符</li>
<li><strong>价值</strong>：理解Android文本编辑框架的设计局限，为第三篇的工程解决方案做准备</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、应用进程内部的文本编辑架构</h3>
<h4 data-id="heading-3">1.1 三大核心组件</h4>
<p>上一篇我们理解了Binder如何将输入法的调用传递到应用进程。现在聚焦应用进程内部：</p>
<pre><code class="hljs language-scss" lang="scss">应用进程内部架构：
┌─────────────────────────────────────────┐
│  TextView / EditText                    │
│    ├─ Editable (SpannableStringBuilder)│ ← 文本缓冲区
│    │    - char<span class="hljs-selector-attr">[]</span> mText                  │
│    │    - <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> mSpans               │
│    │                                    │
│    ├─ InputFilter<span class="hljs-selector-attr">[]</span>                    │ ← 过滤器链
│    │    - DigitsKeyListener             │
│    │    - LengthFilter                  │
│    │                                    │
│    └─ InputConnection                  │ ← 外部接口
│         - BaseInputConnection           │
└─────────────────────────────────────────┘
</code></pre>
<p><strong>上一篇已讲</strong>：InputConnection是跨进程接口
<strong>本篇聚焦</strong>：Editable、InputFilter、Span如何协同工作</p>
<h4 data-id="heading-4">1.2 Editable接口设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Editable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CharSequence</span>, Spannable {
    <span class="hljs-comment">// 核心的三个操作</span>
    Editable <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> where, CharSequence text)</span>;
    Editable <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> st, <span class="hljs-type">int</span> en)</span>;
    Editable <span class="hljs-title function_">replace</span><span class="hljs-params">(<span class="hljs-type">int</span> st, <span class="hljs-type">int</span> en, CharSequence text)</span>;

    <span class="hljs-comment">// 过滤器管理</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFilters</span><span class="hljs-params">(InputFilter[] filters)</span>;
    InputFilter[] getFilters();
}
</code></pre>
<p><strong>实现类</strong>：SpannableStringBuilder</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpannableStringBuilder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Editable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">char</span>[] mText;           <span class="hljs-comment">// 存储字符</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mGapStart;          <span class="hljs-comment">// Gap Buffer优化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mGapLength;

    <span class="hljs-keyword">private</span> Object[] mSpans;        <span class="hljs-comment">// 存储Span对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanStarts;      <span class="hljs-comment">// Span起始位置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanEnds;        <span class="hljs-comment">// Span结束位置</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] mSpanFlags;       <span class="hljs-comment">// Span标志</span>

    <span class="hljs-comment">// 核心实现</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> SpannableStringBuilder <span class="hljs-title function_">replace</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                          CharSequence tb, <span class="hljs-type">int</span> tbstart, <span class="hljs-type">int</span> tbend)</span> {
        <span class="hljs-comment">// 关键：这里会调用InputFilter链</span>
        InputFilter[] filters = getFilters();
        <span class="hljs-keyword">if</span> (filters != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; filters.length; i++) {
                <span class="hljs-type">CharSequence</span> <span class="hljs-variable">repl</span> <span class="hljs-operator">=</span> filters[i].filter(tb, tbstart, tbend,
                                                      <span class="hljs-built_in">this</span>, start, end);
                <span class="hljs-keyword">if</span> (repl != <span class="hljs-literal">null</span>) {
                    tb = repl;
                    tbstart = <span class="hljs-number">0</span>;
                    tbend = repl.length();
                }
            }
        }

        <span class="hljs-comment">// 执行实际的文本替换</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>insert/delete最终都调用replace()</li>
<li>replace()会触发InputFilter链</li>
<li>但有个例外...</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、设计缺陷的核心：不对称的控制权</h3>
<h4 data-id="heading-6">2.1 InputFilter的接口设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InputFilter</span> {
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> source 要插入的新文本
     * <span class="hljs-doctag">@param</span> start  source的起始位置
     * <span class="hljs-doctag">@param</span> end    source的结束位置
     * <span class="hljs-doctag">@param</span> dest   目标文本(当前EditText内容)
     * <span class="hljs-doctag">@param</span> dstart 插入位置的起始
     * <span class="hljs-doctag">@param</span> dend   插入位置的结束
     * <span class="hljs-doctag">@return</span> null  = 接受source
     *         ""    = 拒绝source
     *         其他  = 替换为返回的内容
     */</span>
    CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                       Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span>;
}
</code></pre>
<p><strong>DigitsKeyListener的实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NumberKeyListener.java (父类)</span>
<span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                           Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
    <span class="hljs-type">char</span>[] accept = getAcceptedChars(); <span class="hljs-comment">// ['0'-'9']</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) {
        <span class="hljs-keyword">if</span> (!ok(accept, source.charAt(i))) {
            <span class="hljs-comment">// 发现非法字符 (如字母 'q')</span>
            <span class="hljs-keyword">if</span> (end - start == <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 单个字符，直接拒绝</span>
            }
            <span class="hljs-comment">// 多个字符，过滤掉非法的</span>
            <span class="hljs-comment">// ...</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 全部合法，接受</span>
}

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">ok</span><span class="hljs-params">(<span class="hljs-type">char</span>[] accept, <span class="hljs-type">char</span> c)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> accept.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        <span class="hljs-keyword">if</span> (accept[i] == c) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-7">2.2 delete()的特殊实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SpannableStringBuilder.java</span>
<span class="hljs-keyword">public</span> SpannableStringBuilder <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 关键：delete本质是replace操作，传入空字符串""</span>
    <span class="hljs-keyword">return</span> replace(start, end, <span class="hljs-string">""</span>);
}

<span class="hljs-comment">// 调用链</span>
delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
  ↓
replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  ↓
filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)  ← InputFilter看到的是空字符串
  ↓
<span class="hljs-comment">// DigitsKeyListener的检查</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0</span>; i++) {  <span class="hljs-comment">// start=0, end=0，循环不执行</span>
    <span class="hljs-comment">// 检查字符合法性</span>
}
  ↓
<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 接受！</span>
</code></pre>
<p><strong>问题本质</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────┐
│         InputFilter的视角                        │
├─────────────────────────────────────────────────┤
│                                                 │
│  <span class="hljs-built_in">insert</span>(<span class="hljs-number">5</span>, "abc"):                             │
│    <span class="hljs-built_in">filter</span>(<span class="hljs-string">"abc"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>, dest, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>)            │
│    → 检查 <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span> → 拒绝 ✓               │
│                                                 │
│  <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>):                                 │
│    <span class="hljs-built_in">filter</span>(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, dest, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>)               │
│    → 检查空字符串 → 接受 ✗                     │
│                                                 │
│  InputFilter无法区分：                          │
│  - 插入空字符串 (应接受)                        │
│  - 删除操作 (应该也能拦截吗?)                   │
│                                                 │
└─────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-8">2.3 设计假设 vs 实际情况</h4>



































<table><thead><tr><th>场景</th><th>设计假设</th><th>实际情况</th><th>是否合理</th></tr></thead><tbody><tr><td><strong>用户按删除键</strong></td><td>delete应该无条件执行</td><td>delete绕过InputFilter</td><td>✓ 合理（尊重用户意图）</td></tr><tr><td><strong>InputFilter拦截insert</strong></td><td>拦截非法字符插入</td><td>只能拦截insert</td><td>✓ 符合预期</td></tr><tr><td><strong>组合文本替换</strong></td><td>替换应该原子执行</td><td>delete先于insert，分离执行</td><td>✗ 不合理</td></tr><tr><td><strong>delete+insert组合</strong></td><td>应该保持一致性</td><td>delete绕过，insert拦截</td><td>✗ 不对称</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">三、BaseInputConnection的replaceText()实现</h3>
<h4 data-id="heading-10">3.1 核心代码分析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseInputConnection.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition, <span class="hljs-type">boolean</span> composing)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Editable</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> getEditable();
    <span class="hljs-keyword">if</span> (content == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span>;
    }

    beginBatchEdit();

    <span class="hljs-comment">// ========== 步骤1: 获取旧的组合文本范围 ==========</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getComposingSpanStart(content);
    <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> getComposingSpanEnd(content);

    <span class="hljs-keyword">if</span> (b &lt; a) {
        <span class="hljs-type">int</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> a;
        a = b;
        b = tmp;
    }

    <span class="hljs-keyword">if</span> (a != -<span class="hljs-number">1</span> &amp;&amp; b != -<span class="hljs-number">1</span>) {
        removeComposingSpans(content);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果没有组合范围，使用选中范围</span>
        a = Selection.getSelectionStart(content);
        b = Selection.getSelectionEnd(content);
    }

    <span class="hljs-comment">// ========== 步骤2: 先删除旧范围 ==========</span>
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b);  <span class="hljs-comment">// ← 关键: 先删除，不经过InputFilter验证！</span>
    }

    <span class="hljs-comment">// ========== 步骤3: 再插入新文本 ==========</span>
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text);  <span class="hljs-comment">// ← 经过InputFilter，可能被拒绝</span>
    }

    <span class="hljs-comment">// ========== 步骤4: 设置新的组合范围 ==========</span>
    <span class="hljs-keyword">if</span> (composing) {
        setComposingSpans(content, a, a + text.length());
    }

    endBatchEdit();
}
</code></pre>
<h4 data-id="heading-11">3.2 Bug触发的完整流程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 前提：EditText内容 "123456"，光标在末尾</span>

<span class="hljs-comment">// ========== 第1次：setComposingText("q") ==========</span>
replaceText(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
步骤<span class="hljs-number">1</span>: 获取组合范围
  a = getComposingSpanStart() → -<span class="hljs-number">1</span> (无旧范围)
  b = getComposingSpanEnd() → -<span class="hljs-number">1</span>
  使用光标位置: a=<span class="hljs-number">6</span>, b=<span class="hljs-number">6</span>
  ↓
步骤<span class="hljs-number">2</span>: 删除
  <span class="hljs-keyword">if</span> (<span class="hljs-number">6</span> != <span class="hljs-number">6</span>) → <span class="hljs-literal">false</span>，不执行delete
  ↓
步骤<span class="hljs-number">3</span>: 插入
  content.insert(<span class="hljs-number">6</span>, <span class="hljs-string">"q"</span>)
    → filter(<span class="hljs-string">"q"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
    → 检查: <span class="hljs-string">'q'</span> 不是数字
    → 返回 <span class="hljs-string">""</span> (拒绝)
    → 插入失败
  ↓
步骤<span class="hljs-number">4</span>: 设置组合范围
  setComposingSpans(<span class="hljs-number">6</span>, <span class="hljs-number">6</span> + <span class="hljs-number">0</span>) → [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
  ↓
结果: <span class="hljs-string">"123456"</span> (未变)

<span class="hljs-comment">// ========== 第2次：setComposingText("qq") ==========</span>
replaceText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
步骤<span class="hljs-number">1</span>: 获取组合范围
  a = getComposingSpanStart() → <span class="hljs-number">5</span> ← 为什么是<span class="hljs-number">5</span>? (稍后分析)
  b = getComposingSpanEnd() → <span class="hljs-number">6</span>
  ↓
步骤<span class="hljs-number">2</span>: 删除 ← Bug开始！
  <span class="hljs-keyword">if</span> (<span class="hljs-number">6</span> != <span class="hljs-number">5</span>) → <span class="hljs-literal">true</span>
  content.delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    → replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    → filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
    → 循环不执行 (start=<span class="hljs-number">0</span>, end=<span class="hljs-number">0</span>)
    → 返回 <span class="hljs-literal">null</span> (接受)
    → 删除成功！字符<span class="hljs-string">'6'</span>被删除
  content = <span class="hljs-string">"12345"</span>
  ↓
步骤<span class="hljs-number">3</span>: 插入
  content.insert(<span class="hljs-number">5</span>, <span class="hljs-string">"qq"</span>)
    → filter(<span class="hljs-string">"qq"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"12345"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
    → 检查: <span class="hljs-string">'q'</span> 不是数字
    → 返回 <span class="hljs-string">""</span> (拒绝)
    → 插入失败
  ↓
步骤<span class="hljs-number">4</span>: 设置组合范围
  setComposingSpans(<span class="hljs-number">5</span>, <span class="hljs-number">5</span> + <span class="hljs-number">0</span>) → [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
  ↓
结果: <span class="hljs-string">"12345"</span> ✗ (丢失了<span class="hljs-string">'6'</span>)
</code></pre>
<h4 data-id="heading-12">3.3 为什么先delete后insert？</h4>
<p><strong>设计意图</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 组合文本的替换逻辑</span>
<span class="hljs-comment">// 例如：拼音输入 "zhongguo" → 候选词 "中国"</span>

<span class="hljs-comment">// 旧组合文本: "zhongguo" (8个字符)</span>
<span class="hljs-comment">// 新组合文本: "中国" (2个字符)</span>

<span class="hljs-comment">// 如果先insert后delete：</span>
insert(<span class="hljs-string">"中国"</span>)    → <span class="hljs-string">"123456zhongguo中国"</span>
delete(<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)    → <span class="hljs-string">"123456中国"</span>

<span class="hljs-comment">// 如果先delete后insert：</span>
delete(<span class="hljs-number">6</span>, <span class="hljs-number">14</span>)    → <span class="hljs-string">"123456"</span>
insert(<span class="hljs-string">"中国"</span>)   → <span class="hljs-string">"123456中国"</span>

<span class="hljs-comment">// 两种方式结果相同，但先delete后insert更高效</span>
<span class="hljs-comment">// (避免临时创建过长的字符串)</span>
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>假设了insert总是成功</li>
<li>没有考虑InputFilter拒绝的情况</li>
<li>没有回滚机制</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、Span机制导致的范围异常扩展</h3>
<h4 data-id="heading-14">4.1 COMPOSING Span的作用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseInputConnection.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">COMPOSING</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComposingText</span>();

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComposingText</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NoCopySpan</span> {
    <span class="hljs-comment">// 空实现，只作为标记</span>
}

<span class="hljs-comment">// 获取组合文本范围</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getComposingSpanStart</span><span class="hljs-params">(Spannable text)</span> {
    <span class="hljs-keyword">return</span> text.getSpanStart(COMPOSING);
}

<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getComposingSpanEnd</span><span class="hljs-params">(Spannable text)</span> {
    <span class="hljs-keyword">return</span> text.getSpanEnd(COMPOSING);
}

<span class="hljs-comment">// 设置组合文本范围</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">setComposingSpans</span><span class="hljs-params">(Spannable text, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 移除旧的COMPOSING Span</span>
    removeComposingSpans(text);

    <span class="hljs-comment">// 设置新的COMPOSING Span</span>
    text.setSpan(COMPOSING, start, end,
                 Spanned.SPAN_EXCLUSIVE_EXCLUSIVE | Spanned.SPAN_COMPOSING);
}
</code></pre>
<h4 data-id="heading-15">4.2 Span范围的动态变化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 初始状态</span>
<span class="hljs-type">SpannableStringBuilder</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpannableStringBuilder</span>(<span class="hljs-string">"123456"</span>);
<span class="hljs-comment">// 无COMPOSING Span</span>

<span class="hljs-comment">// 第1次 setComposingText("q")</span>
setComposingSpans(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)  <span class="hljs-comment">// 设置空范围Span</span>
<span class="hljs-comment">// text: "123456"</span>
<span class="hljs-comment">// Span: [6, 6) ← 空范围，但Span存在</span>

<span class="hljs-comment">// 第2次 setComposingText("qq")</span>
<span class="hljs-comment">// 1. 获取范围</span>
<span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getComposingSpanStart() → 返回 <span class="hljs-number">5</span> ← 为什么？
<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> getComposingSpanEnd() → 返回 <span class="hljs-number">6</span>

<span class="hljs-comment">// 2. delete(5, 6)</span>
text.delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
<span class="hljs-comment">// text: "12345"</span>
<span class="hljs-comment">// Span被自动调整...</span>

<span class="hljs-comment">// 3. insert("qq") 失败</span>

<span class="hljs-comment">// 4. setComposingSpans(5, 5)</span>
<span class="hljs-comment">// text: "12345"</span>
<span class="hljs-comment">// Span: [5, 5)</span>
</code></pre>
<h4 data-id="heading-16">4.3 为什么Span范围会从[6,6)变成[5,6)?</h4>
<p><strong>关键代码</strong>：setComposingSpans的实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setComposingSpans</span><span class="hljs-params">(Spannable text, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> {
    <span class="hljs-comment">// 获取[start, end)范围内的所有Span</span>
    <span class="hljs-keyword">final</span> Object[] sps = text.getSpans(start, end, Object.class);
    <span class="hljs-keyword">if</span> (sps != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> sps.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> sps[i];
            <span class="hljs-keyword">if</span> (o == COMPOSING) {
                text.removeSpan(o);
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">fl</span> <span class="hljs-operator">=</span> text.getSpanFlags(o);
            <span class="hljs-comment">// 关键：修改其他Span的范围和标志</span>
            <span class="hljs-keyword">if</span> ((fl &amp; (Spanned.SPAN_COMPOSING | Spanned.SPAN_POINT_MARK_MASK))
                    != (Spanned.SPAN_COMPOSING | SPAN_EXCLUSIVE_EXCLUSIVE)) {
                text.setSpan(o, start, end,
                    (fl &amp; ~SPAN_POINT_MARK_MASK)
                    | SPAN_COMPOSING | SPAN_EXCLUSIVE_EXCLUSIVE);
            }
        }
    }

    <span class="hljs-comment">// 设置新的COMPOSING Span</span>
    text.setSpan(COMPOSING, start, end,
        SPAN_EXCLUSIVE_EXCLUSIVE | SPAN_COMPOSING);
}
</code></pre>
<p><strong>问题根源</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">第<span class="hljs-number">1</span>次 <span class="hljs-built_in">setComposingSpans</span>(<span class="hljs-number">6</span>, <span class="hljs-number">6</span>):
  - 设置 COMPOSING Span [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)
  - text长度: <span class="hljs-number">6</span>
  - 期望: Span在文本末尾

第<span class="hljs-number">2</span>次 <span class="hljs-built_in">insert</span>(<span class="hljs-string">"q"</span>) 失败:
  - text长度仍是<span class="hljs-number">6</span>
  - 但 <span class="hljs-built_in">setComposingSpans</span>(<span class="hljs-number">6</span>, <span class="hljs-number">6</span> + <span class="hljs-string">"q"</span>.<span class="hljs-built_in">length</span>()) 期望长度是<span class="hljs-number">7</span>
  - Span范围计算出现偏差

第<span class="hljs-number">3</span>次 <span class="hljs-built_in">getComposingSpanStart</span>():
  - SpannableStringBuilder内部的Span位置计算
  - 由于text长度与预期不符
  - 返回了错误的起始位置 (<span class="hljs-number">5</span>而不是<span class="hljs-number">6</span>)

连锁反应:
  [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>) → delete不执行 → [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>) → [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>) → <span class="hljs-built_in">delete</span>(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>) → ...
  范围逐渐向前扩展，吞噬更多字符！
</code></pre>
<h4 data-id="heading-17">4.4 Span范围扩展的可视化</h4>
<pre><code class="hljs language-sql" lang="sql">文本:     "123456"
索引:      <span class="hljs-number">012345</span>

第<span class="hljs-number">1</span>次操作后:
  text:  "123456"
  Span:  [<span class="hljs-number">6</span>, <span class="hljs-number">6</span>)  ← 空范围，在<span class="hljs-string">'6'</span>之后

第<span class="hljs-number">2</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) ← 异常！为什么变了？
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>): "12345" ← 删除<span class="hljs-string">'6'</span>
  <span class="hljs-number">3.</span> <span class="hljs-keyword">insert</span>失败
  <span class="hljs-number">4.</span> 设置Span: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>) ← 在<span class="hljs-string">'5'</span>之后

第<span class="hljs-number">3</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">3</span>, <span class="hljs-number">5</span>) ← 继续扩展
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>): "123" ← 删除<span class="hljs-string">'4'</span>和<span class="hljs-string">'5'</span>
  <span class="hljs-number">3.</span> <span class="hljs-keyword">insert</span>失败
  <span class="hljs-number">4.</span> 设置Span: [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)

第<span class="hljs-number">4</span>次操作:
  <span class="hljs-number">1.</span> 获取范围: [<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)
  <span class="hljs-number">2.</span> <span class="hljs-keyword">delete</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>): "" ← 删除全部
</code></pre>
<p><strong>底层原因</strong>：SpannableStringBuilder的Span位置计算依赖文本长度，当实际长度与预期不符时，Span的<code>start/end</code>会被错误地调整。</p>
<hr/>
<h3 data-id="heading-18">五、设计缺陷的层次分析</h3>
<h4 data-id="heading-19">5.1 接口层：filter()无法区分操作类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前接口</span>
CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span>;
</code></pre>
<p><strong>缺陷</strong>：</p>
<ul>
<li>只看到<code>source</code>（要插入的内容）</li>
<li>看不到操作类型（insert? delete? replace?）</li>
<li>看不到操作来源（用户? 输入法? 系统?）</li>
<li>无法区分"插入空字符串"和"删除操作"</li>
</ul>
<p><strong>理想接口</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationType</span> { INSERT, DELETE, REPLACE }
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperationSource</span> { USER_KEY, IME, SYSTEM }

CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend,
                   OperationType type,     // 操作类型
                   OperationSource source)</span>; <span class="hljs-comment">// 操作来源</span>
</code></pre>
<h4 data-id="heading-20">5.2 实现层：replaceText()缺乏原子性</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 当前实现（有缺陷）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, ...)</span> {
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b); <span class="hljs-comment">// 可能删除合法内容</span>
    }
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text); <span class="hljs-comment">// 可能被过滤</span>
    }
    <span class="hljs-comment">// 没有回滚机制！</span>
}
</code></pre>
<p><strong>改进方向1</strong>：先验证</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">replaceText</span><span class="hljs-params">(CharSequence text, ...)</span> {
    <span class="hljs-comment">// 先检查新文本是否合法</span>
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">CharSequence</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> applyFilters(text, a, a);
        <span class="hljs-keyword">if</span> (filtered.length() == <span class="hljs-number">0</span> &amp;&amp; text.length() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 新文本被完全过滤，放弃替换</span>
            <span class="hljs-keyword">return</span>;
        }
        text = filtered; <span class="hljs-comment">// 使用过滤后的内容</span>
    }

    <span class="hljs-comment">// 再执行替换</span>
    <span class="hljs-keyword">if</span> (b != a) {
        content.delete(a, b);
    }
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
        content.insert(a, text);
    }
}
</code></pre>
<p><strong>改进方向2</strong>：使用原子replace</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不要分开delete和insert，使用Editable.replace()</span>
content.replace(a, b, text);
<span class="hljs-comment">// replace()内部一次性调用filter</span>
<span class="hljs-comment">// filter可以同时看到删除范围[a,b)和插入内容text</span>
</code></pre>
<h4 data-id="heading-21">5.3 协议层：Span范围不可靠</h4>
<p><strong>当前机制</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setComposingSpans</span>(start, end)
  → 假设文本长度会变为start + text<span class="hljs-selector-class">.length</span>()
  → 实际: insert失败，长度不变
  → Span范围与实际不符
  → 下次getComposingSpanStart/<span class="hljs-built_in">End</span>()返回错误值
</code></pre>
<p><strong>改进方向</strong>：引入版本号</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComposingState</span> {
    <span class="hljs-type">int</span> start;
    <span class="hljs-type">int</span> end;
    <span class="hljs-type">int</span> textVersion; <span class="hljs-comment">// 文本版本号</span>

    <span class="hljs-comment">// 每次文本操作增加版本号</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        textVersion++;
    }

    <span class="hljs-comment">// 验证Span范围是否仍有效</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(<span class="hljs-type">int</span> currentVersion)</span> {
        <span class="hljs-keyword">return</span> textVersion == currentVersion;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-22">六、对比：正常场景 vs Bug场景</h3>
<h4 data-id="heading-23">6.1 正常场景：用户主动删除</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户按删除键</span>
onKeyDown(KeyEvent.KEYCODE_DEL)
  ↓
BaseInputConnection.deleteSurroundingText(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
  ↓
Editable.delete(cursorPos - <span class="hljs-number">1</span>, cursorPos)
  ↓
replace(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  ↓
filter(<span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"123456"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
  ↓
返回 <span class="hljs-literal">null</span> (接受)
  ↓
删除成功 ✓
</code></pre>
<p><strong>这种情况下，delete应该被允许</strong>（用户主动操作）。</p>
<h4 data-id="heading-24">6.2 Bug场景：输入法自动替换</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 输入法调用 setComposingText("qq", 1)</span>
BaseInputConnection.setComposingText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>)
  ↓
replaceText(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>)
  ↓
delete(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) + insert(<span class="hljs-string">"qq"</span>)
  ↓
delete成功 + insert失败
  ↓
数据丢失 ✗
</code></pre>
<p><strong>这种情况下，delete是"替换的一部分"，应该与insert保持一致</strong>。</p>
<h4 data-id="heading-25">6.3 核心差异</h4>






























<table><thead><tr><th>维度</th><th>用户删除</th><th>输入法替换</th></tr></thead><tbody><tr><td><strong>操作意图</strong></td><td>删除内容</td><td>替换内容（delete+insert）</td></tr><tr><td><strong>原子性</strong></td><td>单个操作</td><td>组合操作</td></tr><tr><td><strong>是否应拦截</strong></td><td>否（尊重用户）</td><td>是（保持一致性）</td></tr><tr><td><strong>实际行为</strong></td><td>delete通过 ✓</td><td>delete通过，insert被拒 ✗</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-26">七、总结：设计的不对称性</h3>
<h4 data-id="heading-27">7.1 核心矛盾</h4>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────┐
│         文本编辑框架的不对称性                    │
├─────────────────────────────────────────────────┤
│                                                 │
│  InputFilter 的期望:                            │
│    控制所有文本操作                              │
│                                                 │
│  Editable 的实现:                               │
│    <span class="hljs-keyword">insert</span>() → 经过<span class="hljs-keyword">filter</span> ✓                     │
│    <span class="hljs-keyword">delete</span>() → 绕过<span class="hljs-keyword">filter</span> ✗                     │
│                                                 │
│  replaceText() 的假设:                          │
│    <span class="hljs-keyword">delete</span>() 总是成功                            │
│    <span class="hljs-keyword">insert</span>() 也总是成功                          │
│                                                 │
│  实际场景:                                       │
│    <span class="hljs-keyword">delete</span>() 成功                                │
│    <span class="hljs-keyword">insert</span>() 被InputFilter拒绝                  │
│    → 数据丢失                                   │
│                                                 │
│  Span 的副作用:                                 │
│    范围计算依赖文本长度                          │
│    <span class="hljs-keyword">insert</span>失败导致长度不符                        │
│    → 范围异常扩展                               │
│                                                 │
└─────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">7.2 循序渐进的知识链</h4>
<p><strong>第一篇</strong>：Binder通信机制</p>
<ul>
<li>✓ 理解了输入法→应用的跨进程调用</li>
<li>✓ 理解了异步执行导致的信息不对称</li>
<li>→ setComposingText("qq")被传递到应用进程</li>
</ul>
<p><strong>第二篇（本文）</strong>：文本编辑设计缺陷</p>
<ul>
<li>✓ 理解了replaceText()的先delete后insert</li>
<li>✓ 理解了delete绕过InputFilter的机制</li>
<li>✓ 理解了Span范围异常扩展的原因</li>
<li>→ 理解了为什么数字会被删除</li>
</ul>
<p><strong>第三篇预告</strong>：工程解决方案</p>
<ul>
<li>如何在InputConnection层拦截非法组合文本？</li>
<li>完整的解决方案（保留数字键盘）</li>
<li>三种方案对比与最佳实践</li>
<li>→ 从理论到实践</li>
</ul>
<hr/>
<h3 data-id="heading-29">参考资料</h3>
<ol>
<li>Android源码：<code>frameworks/base/core/java/android/text/SpannableStringBuilder.java</code></li>
<li>Android源码：<code>frameworks/base/core/java/android/view/inputmethod/BaseInputConnection.java</code></li>
<li>Android源码：<code>frameworks/base/core/java/android/text/method/DigitsKeyListener.java</code></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Ftext%2FInputFilter" target="_blank" title="https://developer.android.com/reference/android/text/InputFilter" ref="nofollow noopener noreferrer">InputFilter</a></li>
</ol>
<hr/>
<p><strong>下一篇</strong>：《InputConnection机制与跨进程文本操作的工程实践》- 完整的解决方案，既保留数字键盘，又避免数据丢失</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】生成式隐式记忆 MemGen 源码解读]]></title>    <link>https://juejin.cn/post/7570940025580486696</link>    <guid>https://juejin.cn/post/7570940025580486696</guid>    <pubDate>2025-11-10T11:58:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570940025580486696" data-draft-id="7569864390942425139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】生成式隐式记忆 MemGen 源码解读"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-10T11:58:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】生成式隐式记忆 MemGen 源码解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T11:58:10.000Z" title="Mon Nov 10 2025 11:58:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】生成式隐式记忆 MemGen 源码解读</h2>
<p>[toc]</p>
<h3 data-id="heading-1">0x00 概要</h3>
<p>MemGen旨在构建一个动态、生成式的记忆框架，其核心由两个协同工作的轻量级模块构成：一个基于强化学习（RL）训练的记忆触发器（Memory Trigger）和一个记忆编织器（Memory Weaver）。</p>
<p>论文：MemGen: Weaving Generative Latent Memory for Self-Evolving Agents</p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2509.24704" target="_blank" title="https://arxiv.org/abs/2509.24704" ref="nofollow noopener noreferrer">arxiv.org/abs/2509.24…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FKANABOON1%2FMemGen" target="_blank" title="https://github.com/KANABOON1/MemGen" ref="nofollow noopener noreferrer">github.com/KANABOON1/M…</a></p>
<h3 data-id="heading-2">0x01 背景</h3>
<p>MemGen 提出动态生成式记忆框架，由记忆触发器与记忆编织器两个轻量模块协同构成，旨在突破现有智能体记忆范式的局限。</p>
<p>当前主流的记忆实现路径为：</p>
<ul>
<li>参数化记忆通过微调将经验编码进模型参数，虽能深度内化知识却易引发灾难性遗忘；</li>
<li>基于检索的记忆将经验外化存储，虽规避了遗忘问题，但静态的一次性检索机制无法体现记忆与推理动态交互的认知特性。</li>
</ul>
<p>这一现状引出两大核心问题：如何实现记忆与推理在每一步思考中的无缝耦合，以及如何让记忆从提取式升级为满足当前需求的生成式重构，而动态生成式隐式记忆正是应对这些挑战的第三种探索路径。</p>
<h3 data-id="heading-3">0x02 源码解析</h3>
<p>MemGen项目旨在创建一个动态且自生成的记忆框架，该框架由两个协同工作的轻量级模块组成：一个基于强化学习训练的记忆触发器和一个记忆编织器。这一框架的核心思想是解决大型语言模型（LLM）智能体能力涌现时对“自进化”机制的探索需求，其中记忆扮演关键角色。</p>
<h4 data-id="heading-4">2.1 模型</h4>
<p>LatentMemoryModel 是 MemGen 框架的核心实现，旨在构建动态生成式隐式记忆系统，解决传统记忆范式的局限性。通过整合推理器（Reasoner）、记忆编织器（Weaver）和记忆触发器（Trigger），实现记忆与推理过程的无缝耦合，让智能体在任务执行中动态生成、使用记忆，而非依赖静态检索或参数化存储。</p>
<h5 data-id="heading-5">2.1.1  核心特色</h5>
<p>模型的核心特色如下：</p>
<ul>
<li><strong>模块化协同设计</strong>：由推理器（核心推理）、编织器（生成潜在记忆）、触发器（控制记忆触发）三大模块构成，模块间通过投影层实现嵌入空间映射，结构清晰且解耦。</li>
<li><strong>动态记忆增强</strong>：在推理过程中自动识别分隔符位置作为记忆增强点，动态插入编织器生成的潜在记忆，突破静态记忆注入的局限，贴合人类认知中记忆与推理的动态交互特性。</li>
<li><strong>精度与效率优化</strong>：默认使用 bfloat16 精度，推理器采用 Flash Attention 2 提升计算效率；冻结推理器参数，仅训练编织器和触发器，实现参数高效学习。</li>
<li><strong>灵活配置与兼容性</strong>：支持自定义触发器模型、PEFT 微调配置、记忆增强次数等参数；自动处理 Tokenizer 缺失 pad token 的问题，标准化对话模板，提升跨场景兼容性。</li>
<li><strong>损失计算精准过滤</strong>：通过潜在记忆掩码排除记忆嵌入对应的位置，仅对原始输入位置计算损失，确保训练目标聚焦于核心任务性能，避免记忆生成过程干扰主任务学习。</li>
</ul>
<h5 data-id="heading-6">2.1.2  网络结构</h5>
<p>关键说明（核心设计亮点）</p>
<ol>
<li><strong>三大模块协同逻辑</strong>：
<ul>
<li>推理器（Reasoner）：核心推理组件，权重冻结以保留基础能力，仅通过潜在记忆调整解码路径。</li>
<li>触发器（MemGenTrigger）：动态判断记忆插入时机，输出二分类触发概率，决定是否调用编织器。</li>
<li>编织器（MemGenWeaver）：生成针对性潜在记忆，分提示词 / 推理两阶段设计，支持 PEFT 高效微调。</li>
</ul>
</li>
<li><strong>核心流程闭环</strong>：输入 → 推理器生成原始嵌入 → 触发器 + 增强点选择模块确定插入位置 → 编织器生成潜在记忆 → 投影层适配维度 → 重组增强序列 → 推理器完成最终推理 → 过滤无效位置输出。</li>
<li><strong>关键技术细节</strong>：
<ul>
<li>跨模块投影：通过 <code>reasoner_to_weaver</code> 和 <code>weaver_to_reasoner</code> 解决推理器与编织器嵌入维度不匹配问题。</li>
<li>动态记忆增强：按分隔符拆分序列，逐段插入记忆，避免长序列冗余，贴合人类 “思考 - 记忆” 交互模式。</li>
<li>精度与效率：全流程采用 bfloat16 精度，推理器 / 编织器启用 Flash Attention 2，平衡性能与速度。</li>
</ul>
</li>
<li><strong>训练与推理适配</strong>：
<ul>
<li>训练时：通过 <code>labels</code> 和 <code>valid_logits</code> 计算损失，仅优化编织器、触发器及投影层参数。</li>
<li>推理时：无需 <code>labels</code>，自动完成 “触发判断 - 记忆生成 - 推理增强” 全流程，实现动态自进化。</li>
</ul>
</li>
</ol>
<p>具体网络结构如下</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fedf1bee4f404d00b60b5ade066b5dd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=udJwW4ZcYOdkSaA%2FuS5q7k6%2FUAc%3D" alt="MemGen-1.png" loading="lazy"/></p>
<h5 data-id="heading-7">2.1.3 代码</h5>
<p>LatentMemoryModel 的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@registry.register_model(<span class="hljs-params"><span class="hljs-string">"latmem"</span></span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatentMemoryModel</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):  <span class="hljs-comment"># 定义了一个名为 LatentMemoryModel 的类，继承自 BaseModel</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        reasoner_model_name: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 推理模型名称</span>
        weaver_model_name: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 记忆编织器模型名称</span>
        prompt_latents_len: <span class="hljs-built_in">int</span>,  <span class="hljs-comment"># 提示长度</span>
        inference_latents_len: <span class="hljs-built_in">int</span>,  <span class="hljs-comment"># 推理长度</span>
        weaver_peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 记忆编织器配置，可选</span>
        trigger_model_name: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 触发模型名称，可选</span>
        trigger_peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 触发器配置，可选</span>
        max_prompt_aug_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,  <span class="hljs-comment"># 最大提示增强数量</span>
        max_inference_aug_num: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>,  <span class="hljs-comment"># 最大推理增强数量</span>
    </span>):   
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类构造函数</span>

        <span class="hljs-comment"># 构建推理模型</span>
        self.model = AutoModelForCausalLM.from_pretrained(  <span class="hljs-comment"># 从预训练模型加载推理模型</span>
            reasoner_model_name, torch_dtype=torch.bfloat16, attn_implementation=<span class="hljs-string">"flash_attention_2"</span>)
        self.tokenizer = AutoTokenizer.from_pretrained(reasoner_model_name)  <span class="hljs-comment"># 加载入分词器</span>
        self.config = self.model.config  <span class="hljs-comment"># 获取模型配置</span>
        
        <span class="hljs-comment"># 构建记忆编织器</span>
        self.weaver = MemGenWeaver(  <span class="hljs-comment"># 初始化记忆编织器</span>
            weaver_model_name, prompt_latents_len, inference_latents_len, weaver_peft_config
        )
        
        <span class="hljs-comment"># 构建触发器</span>
        self.trigger = NanoTrigger()  <span class="hljs-comment"># 默认触发器，始终返回 true</span>
        <span class="hljs-keyword">if</span> trigger_model_name <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.trigger = MemGenTrigger(  <span class="hljs-comment"># 如果指定了触发模型，则加载相应的触发器</span>
                trigger_model_name, trigger_peft_config
            )
            logging.info(<span class="hljs-string">f"Use Trigger: <span class="hljs-subst">{trigger_model_name}</span>"</span>)  <span class="hljs-comment"># 记录日志</span>
        
        <span class="hljs-comment"># 投影层，用于在推理模型和记忆编织器之间映射嵌入</span>
        <span class="hljs-comment"># 将推理模型输入嵌入映射到记忆编织器输入嵌入</span>
        self.reasoner_to_weaver = nn.Linear(  <span class="hljs-comment"># 线性层，从推理模型隐藏层到记忆编织器隐藏层</span>
            self.model.config.hidden_size, self.weaver.config.hidden_size, dtype=torch.bfloat16
        )
        <span class="hljs-comment"># 将记忆编织器隐藏状态映射回推理模型输入嵌入</span>
        self.weaver_to_reasoner = nn.Linear(  <span class="hljs-comment"># 线性层，从记忆编织器隐藏层到推理模型隐藏层</span>
            self.weaver.config.hidden_size, self.model.config.hidden_size, dtype=torch.bfloat16
        )
        
        self.delimiters: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = [<span class="hljs-string">","</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"\n"</span>]  <span class="hljs-comment"># 用于检测增强点的分隔符</span>
        self.max_prompt_aug_num = max_prompt_aug_num  <span class="hljs-comment"># 提示后提示中插入潜在数量</span>
        self.max_inference_aug_num = max_inference_aug_num  <span class="hljs-comment"># 指定分隔符后插入潜在数量</span>

        <span class="hljs-comment"># 后处理</span>
        self._postprocess_models()  <span class="hljs-comment"># 后处理模型</span>

        self.warnings_issued = {}  <span class="hljs-comment"># 存储发出的警告</span>
        self.model_tags = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 存储模型标签</span>
        log_trainable_params(self)  <span class="hljs-comment"># 记录可训练参数</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_model_tags</span>(<span class="hljs-params">self, tags: <span class="hljs-type">Union</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 添加模型标签</span>
        <span class="hljs-string">r"""
        向模型添加自定义标签，这些标签将被推送到 Hugging Face Hub。不会覆盖模型中现有的标签。

        参数：
            tags (`Union[list[str], str]`)：
                要添加到模型的标签

        例子：

        ```python
        from transformers import AutoModel

        model = AutoModel.from_pretrained("google-bert/bert-base-cased")

        model.add_model_tags(["custom", "custom-bert"])

        # 将模型推送到您的命名空间，名称为 "my-custom-bert"。
        model.push_to_hub("my-custom-bert")
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(tags, <span class="hljs-built_in">str</span>):
            tags = [tags]

        <span class="hljs-keyword">if</span> self.model_tags <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.model_tags = []

        <span class="hljs-keyword">for</span> tag <span class="hljs-keyword">in</span> tags:
            <span class="hljs-keyword">if</span> tag <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.model_tags:
                self.model_tags.append(tag)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_postprocess_models</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        后处理记忆模型的组件：推理模型、记忆编织器、触发器和分词器。

        步骤：
            1. 冻结推理模型的所有参数（不更新梯度）。
            2. 将所有模型转换为 bfloat16 以提高内存和计算效率。
            3. 确保分词器有一个有效的填充符：
                - 如果缺少填充符，使用 EOS 符作为填充符。
                - 设置 `padding_side` 为 "left" 以兼容生成任务。
            4. 标准化分词器的模板为 `CONVERSATION_TEMPLATE`。
        """</span>
        <span class="hljs-comment"># 默认冻结推理模型的所有参数</span>
        fix_model_parameters(self.model)

        <span class="hljs-comment"># 将所有子模型转换为 bfloat16</span>
        self.model = self.model.bfloat16()
        self.weaver = self.weaver.bfloat16()
        self.trigger = self.trigger.bfloat16()

        <span class="hljs-comment"># 确保分词器有一个填充符</span>
        <span class="hljs-keyword">if</span> self.tokenizer.pad_token <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.tokenizer.pad_token = self.tokenizer.eos_token
            self.tokenizer.pad_token_id = self.tokenizer.eos_token_id
            self.tokenizer.padding_side = <span class="hljs-string">"left"</span>
            logging.info(
                <span class="hljs-string">f"Tokenizer has no pad token. Using EOS token (<span class="hljs-subst">{self.tokenizer.eos_token}</span>) as pad token."</span>
            )

        <span class="hljs-comment"># 标准化分词器的模板</span>
        self.tokenizer.chat_template = CONVERSATION_TEMPLATE
</code></pre>
<h5 data-id="heading-8">2.1.4 插入阶段</h5>
<p>LatentMemoryModel 的两个关键函数 forward 和  generate 区别如下：</p>
<ul>
<li>forward 函数
<ul>
<li>训练时候计算损失，由训练循环自动调用。</li>
</ul>
</li>
<li>generate 函数
<ul>
<li>推理时候生成文本，由代码显式调用。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-9">forward</h6>
<p>forward 函数的主体如下：</p>
<pre><code class="hljs language-python" lang="python">    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_forward</span>(<span class="hljs-params">
        self, 
        input_ids: torch.Tensor,
        attention_mask: torch.Tensor,
        labels: torch.Tensor,   
        **kwargs
    </span>) -&gt; torch.Tensor:
        <span class="hljs-comment"># 预处理输入</span>
        <span class="hljs-keyword">assert</span> input_ids.shape == attention_mask.shape == labels.shape
        
        tokenizer = self.tokenizer
        reasoner = self.model
        weaver = self.weaver
        delimiters = self.delimiters
        max_augment_num = self.max_inference_aug_num  <span class="hljs-comment"># 限制推理增强点的数量以避免过度增强</span>
        device = self.device
        embeds_dtype = reasoner.get_input_embeddings().weight.dtype
        B, _ = input_ids.shape
        hidden_size = reasoner.config.hidden_size

        <span class="hljs-comment"># 选择增强索引</span>
        augmentation_indices = self._select_augment_points_after_delimiter(
            input_ids, labels, delimiters, tokenizer, max_augment_num
        )
        
        <span class="hljs-comment"># 输入嵌入</span>
        inputs_embeds = reasoner.get_input_embeddings()(input_ids)
                 
        <span class="hljs-comment"># 初始化开始索引和空张量以累积处理的段</span>
        current_start_idx = <span class="hljs-number">0</span>
        current_inputs_embeds = torch.empty(B, <span class="hljs-number">0</span>, hidden_size).to(device, dtype=embeds_dtype)
        current_attention_mask = torch.empty(B, <span class="hljs-number">0</span>).to(device, dtype=attention_mask.dtype)
        current_latents_mask = torch.empty(B, <span class="hljs-number">0</span>).to(device, dtype=torch.<span class="hljs-built_in">bool</span>)

        <span class="hljs-comment"># 遍历所选增强点</span>
        <span class="hljs-keyword">for</span> aug_idx <span class="hljs-keyword">in</span> augmentation_indices:
            <span class="hljs-comment"># 切片原始嵌入和注意力掩码</span>
            segment_inputs_embeds = inputs_embeds[:, current_start:aug_idx]
            segment_attention_mask = attention_mask[:, current_start:aug_idx]
            segment_latents_mask = torch.zeros(B, segment_inputs_embeds.size(<span class="hljs-number">1</span>).to(device, dtype=torch.<span class="hljs-built_in">bool</span>)

            <span class="hljs-comment"># 连接当前段到累积嵌入和掩码</span>
            current_inputs_embeds = torch.cat([current_inputs_embeds, segment_inputs_embeds], dim=<span class="hljs-number">1</span>)
            current_mask = torch.cat([current_mask, segment_attention_mask], dim=<span class="hljs-number">1</span>)
            current_position_ids = generate_position_ids(current_mask)
            current_latents = torch.cat([current_latents, segment_latents], dim=<span class="hljs-number">1</span>)

            <span class="hljs-comment"># 将推理模型嵌入映射到记忆编织器嵌入</span>
            weaver_inputs_embeds = self.reasoner_to_weaver(current_inputs_embeds)

            <span class="hljs-comment"># 确定此点是否为提示（增强）的结束</span>
            is_prompt_end_aug = (labels[:, aug_idx] != -<span class="hljs-number">100</span>).<span class="hljs-built_in">all</span>() <span class="hljs-keyword">and</span> (labels[:, aug_idx-<span class="hljs-number">1</span>] == -<span class="hljs-number">100</span>).<span class="hljs-built_in">all</span>().item()
            <span class="hljs-comment"># 根据类型，使用记忆编织器增强提示或推理</span>
            <span class="hljs-keyword">if</span> is_prompt_end_aug:
                weaver_hidden_states, attn_mask, pos_ids = weaver.augment_prompt(
                    weaver_inputs, current_attention_mask, current_position_ids
                )
            <span class="hljs-keyword">else</span>:
                weaver_hidden_states, attn_mask, pos_ids = weaver.augment_inference(
                    weaver_inputs, current_attention_mask, current_position_ids
                ) 

            <span class="hljs-comment"># 将记忆编织器隐藏状态映射回推理模型嵌入</span>
            latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)

            <span class="hljs-comment"># 更新累积嵌入和掩码与新增强段</span>
            current_inputs_embeds = torch.cat
</code></pre>
<h6 data-id="heading-10">generate</h6>
<h6 data-id="heading-11">核心作用</h6>
<p>该 <code>generate</code> 方法是 MemGen 模型的推理核心，实现了<strong>动态记忆增强与序列生成的无缝融合</strong>。通过迭代生成新 token，每步自适应判断是否插入编织器生成的潜在记忆，让推理器在生成过程中实时利用动态记忆调整解码路径，最终输出增强后的序列（可选返回记忆增强位置掩码）。</p>
<h6 data-id="heading-12">核心特色</h6>
<ul>
<li><strong>双阶段记忆增强</strong>：先执行提示词阶段记忆增强（初始化全局记忆），再在迭代生成中动态触发推理阶段增强（补充实时记忆），适配不同生成阶段的记忆需求。</li>
<li><strong>自适应触发机制</strong>：通过 <code>_should_augment</code> 结合触发器决策，仅对需要记忆支持的序列执行增强，避免无意义的计算开销。</li>
<li><strong>维度对齐优化</strong>：非增强序列采用左填充（<code>_left_pad</code>）方式对齐增强序列维度，确保批次内所有序列格式统一，不影响批量生成效率。</li>
<li>高效推理设计：
<ul>
<li>禁用梯度计算（<code>@torch.no_grad()</code>），节省内存并加速推理；</li>
<li>启用推理器缓存（<code>use_cache=True</code>），减少重复计算；</li>
<li>仅在必要时输出隐藏状态，降低计算成本。</li>
</ul>
</li>
<li><strong>灵活配置与可解释性</strong>：支持控制最大生成 token 数、采样策略等参数；可选返回 <code>augmentation_pos</code> 掩码，标记记忆插入位置，提升模型可解释性。</li>
<li><strong>鲁棒性保障</strong>：提前终止机制（所有序列生成 EOS 或达最大增强次数时终止），避免无效迭代；重构生成配置固定关键参数，确保生成稳定性。</li>
</ul>
<h6 data-id="heading-13">推理生成流程图</h6>
<p>潜在记忆插入的完整流程：</p>
<ul>
<li>初始化阶段：对输入提示进行增强，插入初始潜在记忆。</li>
<li>生成循环：逐个生成token。</li>
<li>条件检查：在每个步骤检查是否满足插入条件。</li>
<li>决策判断：使用trigger模型决定是否插入潜在记忆。</li>
<li>潜在记忆生成：通过weaver模型生成潜在记忆表示。</li>
<li>嵌入连接：将潜在记忆嵌入连接到当前输入序列。</li>
<li>继续生成：使用增强后的序列继续生成下一个token。</li>
</ul>
<p>具体流程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51a1177007e14bdd916d4e2ea501c2c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=aylwPhRKpttlymB%2BFRIe5TqKJmg%3D" alt="MemGen-2.png" loading="lazy"/></p>
<p>代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@torch.no_grad()  </span><span class="hljs-comment"># 禁用梯度计算，适用于推理阶段，提升效率并节省内存</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">
    self, 
    input_ids: torch.Tensor,  <span class="hljs-comment"># 输入token ID序列，形状[batch_size, prompt_len]</span>
    attention_mask: torch.Tensor,  <span class="hljs-comment"># 注意力掩码，形状与input_ids一致</span>
    generation_config: GenerationConfig = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 生成配置（如最大新token数、采样策略等）</span>
    return_augmentation_mask: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否返回记忆增强位置掩码</span>
    **kwargs
</span>) -&gt; <span class="hljs-type">Union</span>[torch.Tensor, <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor]]: 
    <span class="hljs-string">"""
    执行MemGen模型的推理生成流程：动态融合潜在记忆与推理器，生成增强后的输出序列。
    
    核心逻辑：
    1. 初始化提示词阶段的记忆增强
    2. 迭代生成新token，每步判断是否触发推理阶段记忆增强
    3. 对需增强的序列插入编织器生成的潜在记忆，非增强序列左填充对齐维度
    4. 生成完成后返回结果（可选返回增强位置掩码）
    """</span>
    tokenizer = self.tokenizer
    reasoner = self.model
    weaver = self.weaver
    trigger = self.trigger
    delimiters = self.delimiters
    max_augment_num = self.max_inference_aug_num  <span class="hljs-comment"># 单序列最大推理阶段增强次数</span>
    invalid_token_id = -<span class="hljs-number">100</span>  <span class="hljs-comment"># 无效位置标记（用于增强位置掩码）</span>

    <span class="hljs-comment"># 预处理输入：转移到模型所在设备</span>
    input_ids = input_ids.to(self.device)
    attention_mask = attention_mask.to(self.device)
    <span class="hljs-comment"># 提取生成配置关键参数</span>
    max_new_tokens = generation_config.max_new_tokens  <span class="hljs-comment"># 最大生成新token数</span>
    do_sample = generation_config.do_sample  <span class="hljs-comment"># 是否启用采样生成</span>
    temperature = generation_config.temperature  <span class="hljs-comment"># 采样温度（控制随机性）</span>
    pad_token_id = tokenizer.pad_token_id  <span class="hljs-comment"># pad token ID</span>
    eos_token_id = tokenizer.eos_token_id  <span class="hljs-comment"># 结束token ID</span>
    prompt_len = input_ids.size(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 提示词长度</span>
    <span class="hljs-comment"># 重构生成配置（固定必要参数，确保生成稳定性）</span>
    generation_config = GenerationConfig(
        do_sample=do_sample,
        temperature=temperature,
        pad_token_id=pad_token_id,
        eos_token_id=eos_token_id,
        use_cache=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用缓存加速生成</span>
    )

    <span class="hljs-comment"># 将输入token ID转换为嵌入向量</span>
    inputs_embeds = reasoner.get_input_embeddings()(input_ids)
    B, _, hidden_size = inputs_embeds.shape  <span class="hljs-comment"># B=batch_size，hidden_size=推理器隐藏层维度</span>
    device = inputs_embeds.device  <span class="hljs-comment"># 模型所在设备（CPU/GPU）</span>

    <span class="hljs-comment"># 初始化生成过程中的关键张量</span>
    current_inputs_embeds = inputs_embeds  <span class="hljs-comment"># 当前输入嵌入（含原始提示词+潜在记忆）</span>
    current_attention_mask = attention_mask  <span class="hljs-comment"># 当前注意力掩码</span>
    current_position_ids = generate_position_ids(current_attention_mask)  <span class="hljs-comment"># 当前位置ID</span>
    current_input_ids = input_ids  <span class="hljs-comment"># 当前已生成的token ID序列</span>
    
    <span class="hljs-comment"># 提示词阶段记忆增强：生成并插入提示词专用潜在记忆</span>
    weaver_inputs_embeds = self.reasoner_to_weaver(current_inputs_embeds)  <span class="hljs-comment"># 映射到编织器嵌入空间</span>
    weaver_hidden_states, attn_mask, pos_ids = weaver.augment_prompt(
        weaver_inputs_embeds, current_attention_mask, current_position_ids
    )
    latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)  <span class="hljs-comment"># 映射回推理器嵌入空间</span>

    <span class="hljs-comment"># 拼接提示词与增强记忆</span>
    current_inputs_embeds = torch.cat([current_inputs_embeds, latent_inputs_embeds], dim=<span class="hljs-number">1</span>)
    current_attention_mask = torch.cat([current_attention_mask, attn_mask], dim=<span class="hljs-number">1</span>)
    current_position_ids = torch.cat([current_position_ids, pos_ids], dim=<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 生成循环初始化</span>
    sentence_augment_count = torch.zeros(B, dtype=torch.<span class="hljs-built_in">int</span>, device=device)  <span class="hljs-comment"># 各序列已增强次数</span>
    augmentation_pos = torch.full((B, max_new_tokens), fill_value=invalid_token_id, device=device)  <span class="hljs-comment"># 增强位置掩码</span>
    inserted_embeds: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[torch.Tensor]] = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(B)]  <span class="hljs-comment"># 记录插入的潜在记忆（用于后处理）</span>
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_new_tokens):
        <span class="hljs-comment"># 若所有序列均已生成EOS token，提前终止</span>
        <span class="hljs-keyword">if</span> (current_input_ids[:, -<span class="hljs-number">1</span>] == eos_token_id).<span class="hljs-built_in">all</span>():
            <span class="hljs-keyword">break</span>   

        <span class="hljs-comment"># 若所有序列均已达到最大增强次数，一次性生成剩余token</span>
        <span class="hljs-keyword">if</span> (sentence_augment_count &gt;= max_augment_num).<span class="hljs-built_in">all</span>():
            <span class="hljs-comment"># 调整剩余生成长度</span>
            generation_config.max_new_tokens = max_new_tokens - i
            <span class="hljs-comment"># 推理器生成剩余token</span>
            generated = reasoner.generate(
                inputs_embeds=current_inputs_embeds,
                attention_mask=current_attention_mask,
                generation_config=generation_config,
            )
            current_input_ids = torch.cat([current_input_ids, generated], dim=<span class="hljs-number">1</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># 推理器前向传播，获取当前步输出</span>
        outputs = reasoner(
            inputs_embeds=current_inputs_embeds,
            attention_mask=current_attention_mask,
            position_ids=current_position_ids,
            output_hidden_states=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 推理阶段无需输出隐藏状态，提升效率</span>
        )
        <span class="hljs-comment"># 生成并追加一个新token，更新关键张量</span>
        current_inputs_embeds, current_attention_mask, current_position_ids, current_input_ids = self._append_one_step(
            outputs, current_inputs_embeds, current_attention_mask, current_position_ids, current_input_ids, do_sample, temperature
        )
 
        <span class="hljs-comment"># 若为最后一步生成，终止循环</span>
        <span class="hljs-keyword">if</span> i == max_new_tokens - <span class="hljs-number">1</span>:  
            <span class="hljs-keyword">break</span> 

        <span class="hljs-comment"># 判断当前批次中哪些序列需要进行推理阶段记忆增强</span>
        augment_decision = self._should_augment(
            current_input_ids, current_attention_mask, sentence_augment_count=sentence_augment_count, 
            do_sample=do_sample, temperature=temperature  
        )
        augmentation_pos[:, i + <span class="hljs-number">1</span>] = augment_decision  <span class="hljs-comment"># 记录增强位置（1=增强，0=不增强，-100=无效）</span>
        augment_indices = torch.where(augment_decision == <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 需增强的序列索引</span>

        <span class="hljs-comment"># 对需增强的序列执行记忆增强，非增强序列左填充对齐维度</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(augment_indices) &gt; <span class="hljs-number">0</span>:
            <span class="hljs-comment"># 递增需增强序列的增强次数计数</span>
            sentence_augment_count[augment_indices] += <span class="hljs-number">1</span>

            <span class="hljs-comment"># 提取需增强序列的嵌入、掩码和位置ID</span>
            candidate_inputs_embeds = current_inputs_embeds[augment_indices]
            candidate_attention_mask = current_attention_mask[augment_indices]
            candidate_position_ids = current_position_ids[augment_indices]
            
            <span class="hljs-comment"># 编织器生成推理阶段潜在记忆</span>
            weaver_inputs_embeds = self.reasoner_to_weaver(candidate_inputs_embeds)
            weaver_hidden_states, attn_mask, _ = weaver.augment_inference(
                weaver_inputs_embeds, candidate_attention_mask, candidate_position_ids
            )
            latent_inputs_embeds = self.weaver_to_reasoner(weaver_hidden_states)  <span class="hljs-comment"># 映射回推理器空间</span>
            
            <span class="hljs-comment"># 拼接原始嵌入与潜在记忆</span>
            candidate_inputs_embeds = torch.cat([candidate_inputs_embeds, latent_inputs_embeds], dim=<span class="hljs-number">1</span>)
            candidate_attention_mask = torch.cat([candidate_attention_mask, attn_mask], dim=<span class="hljs-number">1</span>)
            
            <span class="hljs-comment"># 构建合并张量（适配所有序列，包括增强和非增强）</span>
            new_len = candidate_inputs_embeds.size(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 增强后序列长度</span>
            merged_inputs_embeds = torch.zeros((B, new_len, hidden_size), device=device, dtype=current_inputs_embeds.dtype)
            merged_attention_mask = torch.zeros((B, new_len), device=device, dtype=current_attention_mask.dtype)
            
            <span class="hljs-comment"># 填充增强序列</span>
            merged_inputs_embeds[augment_indices] = candidate_inputs_embeds
            merged_attention_mask[augment_indices] = candidate_attention_mask
            
            <span class="hljs-comment"># 填充非增强序列（左填充对齐长度）</span>
            non_augment_indices = torch.where(augment_decision != <span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(non_augment_indices) &gt; <span class="hljs-number">0</span>:
                non_aug_inputs_embeds = current_inputs_embeds[non_augment_indices]
                non_aug_attention_mask = current_attention_mask[non_augment_indices]
                non_aug_inputs_embeds, non_aug_attention_mask, _ = self._left_pad(
                    non_aug_inputs_embeds, non_aug_attention_mask, <span class="hljs-literal">None</span>, weaver.inference_latents_num
                )
                merged_inputs_embeds[non_augment_indices] = non_aug_inputs_embeds
                merged_attention_mask[non_augment_indices] = non_aug_attention_mask
            
            <span class="hljs-comment"># 更新当前关键张量</span>
            current_inputs_embeds = merged_inputs_embeds
            current_attention_mask = merged_attention_mask
            current_position_ids = generate_position_ids(current_attention_mask)  <span class="hljs-comment"># 重新生成位置ID</span>
            
            <span class="hljs-comment"># 记录插入的潜在记忆（用于后处理或可解释性分析）</span>
            <span class="hljs-keyword">for</span> idx, embed <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(augment_indices, latent_inputs_embeds):
                inserted_embeds[idx].append(embed.clone().detach().cpu())
        
        <span class="hljs-comment"># 后处理：调整增强位置掩码长度与生成结果一致</span>
        new_generated_len = current_input_ids.size(<span class="hljs-number">1</span>) - prompt_len
        augmentation_pos = augmentation_pos[:, :new_generated_len]
         
        <span class="hljs-comment"># 根据配置返回结果：仅生成序列 或 序列+增强位置掩码</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> return_augmentation_mask:
            <span class="hljs-keyword">return</span> current_input_ids
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> current_input_ids, augmentation_pos
</code></pre>
<h4 data-id="heading-14">2.2 Trigger</h4>
<h5 data-id="heading-15">2.2.1. 核心作用</h5>
<p>该模块定义了 MemGen 框架中记忆触发器的核心接口与两种具体实现，核心作用是<strong>动态决策记忆增强的时机</strong>—— 即在推理过程中判断何时插入编织器生成的潜在记忆，实现记忆与推理的动态耦合，突破传统静态记忆注入的局限。</p>
<h5 data-id="heading-16">2.2.2. 核心特色</h5>
<ul>
<li><strong>抽象接口统一规范</strong>：<code>Trigger</code>抽象基类定义了触发器的核心接口，确保后续扩展新触发器时遵循统一标准，提升代码可扩展性。</li>
<li>双实现适配不同场景：
<ul>
<li><code>NanoTrigger</code>：极简实现，始终触发记忆增强，无需训练，适用于快速测试、基线对比或无需动态控制的简单场景。</li>
<li><code>MemGenTrigger</code>：基于预训练 LLM 的智能触发器，通过二分类头适配决策任务，支持 PEFT 参数高效微调，能根据输入序列动态判断是否触发，适配复杂真实场景。</li>
</ul>
</li>
<li>高效适配与灵活扩展：
<ul>
<li>采用 bfloat16 精度和 Flash Attention 2 优化计算效率；</li>
<li>支持 PEFT 微调，在不冻结基础模型的前提下实现参数高效学习；</li>
<li>替换 LLM 原始输出头为二分类头，精准适配 "是否插入记忆" 的决策需求。</li>
</ul>
</li>
<li><strong>模块解耦设计</strong>：触发器决策独立于编织器模块，仅基于输入序列和数据分布做出判断，保证了模块间的低耦合和高内聚。</li>
</ul>
<h5 data-id="heading-17">2.2.3 网络架构</h5>
<p>网络架构图如下。</p>
<p>说明如下：</p>
<ol>
<li>模型支持PEFT参数高效微调（如LoRA），适配于Transformer Blocks层</li>
<li>整体精度采用bfloat16，平衡计算效率与数值稳定性</li>
<li>注意力计算通过Flash Attention 2优化，提升长序列处理速度</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34dd418dca1746b69160336bafae5e6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=Av9etmryf2cwP7Mw6AaiNNc%2FzO4%3D" alt="MemGen-3.png" loading="lazy"/></p>
<h5 data-id="heading-18">2.2.4 代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trigger</span>(torch.nn.Module, ABC):
    <span class="hljs-string">"""
    记忆触发器的抽象基类（Trigger）。
    定义了触发器的核心接口，用于决定在推理过程中何时触发记忆增强（插入潜在记忆）。
    所有具体触发器实现都需继承此类并实现forward方法。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类Module的初始化方法</span>
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, **kwargs</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""
        抽象前向传播方法：接收输入数据，返回是否触发记忆增强的决策。
        子类必须实现此方法，定义具体的触发逻辑。
        
        Args:
            **kwargs: 可变关键字参数，包含输入序列、注意力掩码等模型所需数据
            
        Returns:
            bool: 触发决策（True表示触发记忆增强，False表示不触发）
        """</span>
        ...


<span class="hljs-keyword">class</span> <span class="hljs-title class_">NanoTrigger</span>(torch.nn.Module):
    <span class="hljs-string">"""
    极简触发器（NanoTrigger）：始终触发记忆增强的基础实现。
    无需复杂逻辑，固定返回触发决策，适用于基础测试或无需动态控制的场景。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()  
        <span class="hljs-comment"># 注册一个缓冲区张量，用于获取模型所在设备（无实际计算意义）</span>
        self.register_buffer(<span class="hljs-string">"_device"</span>, torch.tensor(<span class="hljs-number">0.0</span>))
    
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取模型所在设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self._device.device
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids: torch.Tensor, attention_mask: torch.Tensor, **kwargs</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 该"极简触发器"始终预测需要插入记忆</span>
        <span class="hljs-comment"># 输出logits张量，其中插入决策（索引=1）的概率被设为1.0</span>
        <span class="hljs-comment"># 适用于批次中的每个token位置</span>
        batch_size, seq_len = input_ids.shape

        <span class="hljs-comment"># 初始化logits张量：形状为[batch_size, seq_len, 2]，2表示"不插入"（0）和"插入"（1）两类</span>
        logits = torch.zeros(batch_size, seq_len, <span class="hljs-number">2</span>, device=input_ids.device)
        logits[..., <span class="hljs-number">1</span>] = <span class="hljs-number">1.0</span>  <span class="hljs-comment"># 将所有位置的"插入"决策概率设为1.0</span>
        <span class="hljs-keyword">return</span> logits


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemGenTrigger</span>(torch.nn.Module):
    <span class="hljs-string">"""
    MemGen框架的专用触发器模块（MemGenTrigger）。
    - 输入：接收推理器模型当前解码序列的`inputs_embeds`（或input_ids）
    - 输出：生成形状为[batch_size, seq_len, 2]的logits张量，
      表示每个位置"不插入"（0）和"插入"（1）记忆的概率，用于动态决策记忆增强时机。
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        pretrained_model_name_or_path: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 预训练模型名称或路径（用于初始化触发器LLM）</span>
        peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>  <span class="hljs-comment"># PEFT配置（可选，用于参数高效微调）</span>
    </span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 构建基础LLM模型（作为触发器的核心推理组件）</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            pretrained_model_name_or_path, 
            torch_dtype=torch.bfloat16,  <span class="hljs-comment"># 使用bfloat16精度提升效率</span>
            attn_implementation=<span class="hljs-string">"flash_attention_2"</span>  <span class="hljs-comment"># 启用Flash Attention 2优化注意力计算</span>
        )
        self.tokenizer = AutoTokenizer.from_pretrained(pretrained_model_name_or_path)  <span class="hljs-comment"># 对应的Tokenizer</span>
        
        <span class="hljs-comment"># 对基础模型进行后处理（设置可训练、替换输出头）</span>
        self.model = self._postprocess(self.model)
        <span class="hljs-comment"># 若提供PEFT配置，应用参数高效微调</span>
        <span class="hljs-keyword">if</span> peft_config <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.model = get_peft_model(self.model, peft_config)
        
        self.config = self.model.config  <span class="hljs-comment"># 保存模型配置</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取模型所在设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self.model.device
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_postprocess</span>(<span class="hljs-params">self, model: PreTrainedModel</span>):
        <span class="hljs-string">"""
        对基础模型进行后处理，适配触发器的二分类任务需求。
        
        Args:
            model: 原始预训练LLM模型
            
        Returns:
            处理后的模型（可训练、替换为二分类输出头）
        """</span>
        <span class="hljs-comment"># 设置所有模型参数为可训练</span>
        <span class="hljs-keyword">for</span> parameter <span class="hljs-keyword">in</span> model.parameters():
            parameter.requires_grad = <span class="hljs-literal">True</span>
        
        <span class="hljs-comment"># 将原始语言模型的输出头（lm_head）替换为二分类头</span>
        hidden_size = model.config.hidden_size  <span class="hljs-comment"># 模型隐藏层维度</span>
        classification_head = nn.Linear(hidden_size, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 输出维度为2（不插入/插入）</span>
        model.lm_head = classification_head
        
        <span class="hljs-comment"># 确保新的二分类头参数可训练</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> model.lm_head.parameters():
            param.requires_grad = <span class="hljs-literal">True</span>

        <span class="hljs-keyword">return</span> model

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">
        self, 
        input_ids: <span class="hljs-type">Optional</span>[torch.LongTensor] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 生成序列的token ID，形状[batch_size, seq_len]</span>
        attention_mask: <span class="hljs-type">Optional</span>[torch.Tensor] = <span class="hljs-literal">None</span>,  <span class="hljs-comment"># 注意力掩码，避免关注填充token</span>
        **kwargs: Unpack[TransformersKwargs],  <span class="hljs-comment"># 传递给底层模型的额外参数</span>
    </span>) -&gt; torch.Tensor:
        <span class="hljs-string">"""
        序列生成的触发决策机制。
        触发器基于已生成的`input_ids`做出决策，受数据分布影响，但独立于编织器模块。

        Args:
            input_ids (Optional[torch.LongTensor]): 生成序列的token ID张量
            attention_mask (Optional[torch.Tensor]): 注意力掩码，默认None
            **kwargs: 传递给底层模型的额外关键字参数

        Returns:
            torch.Tensor: Logits张量，形状为`(batch_size, seq_len, num_classes)`
                        num_classes=2，分别对应"不插入"（索引0）和"插入"（索引1）的概率
        """</span>   
        <span class="hljs-comment"># 调用基础模型前向传播，返回二分类logits</span>
        <span class="hljs-keyword">return</span> self.model(
            input_ids=input_ids, 
            attention_mask=attention_mask, 
            **kwargs
        ).logits
</code></pre>
<h4 data-id="heading-19">2.3  MemGenWeaver</h4>
<h5 data-id="heading-20">2.3.1 核心作用</h5>
<p>MemGenWeaver 是 MemGen 框架的核心组件之一，负责生成动态潜在记忆并将其与推理器的输入序列融合，从而实现记忆与推理过程的无缝交织。它通过可学习的潜在记忆查询向量，在提示词阶段和推理阶段分别生成针对性的记忆表示，引导推理器调整解码路径，提升智能体的动态决策能力。</p>
<h5 data-id="heading-21">2.3.2 核心特色</h5>
<ul>
<li>双阶段记忆生成：区分提示词阶段（<code>augment_prompt</code>）和推理阶段（<code>augment_inference</code>），使用各自独立的可学习潜在记忆查询向量，适配不同阶段的记忆需求，增强记忆生成的针对性。</li>
<li>灵活的潜在记忆融合：通过<code>_augment</code>方法统一实现潜在记忆与输入序列的融合，包括嵌入拼接、注意力掩码扩展和位置 ID 计算，确保记忆与原始输入在语义空间和时序上的一致性。</li>
<li>高效的模型设计：
<ul>
<li>基于预训练 LLM 构建，支持 PEFT 参数高效微调，在保留基础能力的同时降低训练成本；</li>
<li>采用 bfloat16 精度和 Flash Attention 2 优化，提升计算效率和内存利用率。</li>
</ul>
</li>
<li>动态记忆编织机制：生成的潜在记忆并非静态检索结果，而是基于当前输入序列动态生成的隐藏状态，能够捕捉实时上下文信息，实现 “生成式记忆” 的核心特性。</li>
<li>模块化与可扩展性：与推理器、触发器解耦，通过标准化接口交互；潜在记忆的数量可通过参数灵活配置，适配不同任务对记忆容量的需求。</li>
</ul>
<h5 data-id="heading-22">2.3.3 网络架构</h5>
<p>网络架构图如下。</p>
<p>说明如下：</p>
<ol>
<li>
<p>核心组件：</p>
<ul>
<li>可学习潜在记忆向量：分阶段设计（P=提示词阶段数量，I=推理阶段数量），支持动态生成记忆</li>
<li>预训练LLM：作为记忆生成核心，默认启用bfloat16精度和Flash Attention 2优化</li>
<li>序列融合层：确保输入与记忆在语义、掩码、时序上的一致性</li>
</ul>
</li>
<li>
<p>核心流程：</p>
<ul>
<li>输入 → 选择对应阶段的潜在记忆 → 融合序列 → LLM生成隐藏状态 → 提取潜在记忆输出</li>
<li>支持PEFT参数高效微调（如LoRA），适配于Transformer Blocks层</li>
</ul>
</li>
<li>
<p>输出用途：</p>
<ul>
<li>生成的潜在记忆将通过投影层映射到推理器的嵌入空间，与原始输入融合以引导解码</li>
</ul>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171332decb0c4154ba66ca9f7de013db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763380690&amp;x-signature=MkDfTVSJzZAmLMpyyKdipXchpbw%3D" alt="MemGen-4.png" loading="lazy"/></p>
<h5 data-id="heading-23">2.3.4 代码</h5>
<p>两个关键变量如下：</p>
<ul>
<li>prompt_query_latents。
<ul>
<li>作用：增强模型在处理prompt时候的表现。 在模型处理完原始提示之后会被注入到序列中，为模型提供额外的上下文信息。</li>
<li>使用场景：在 augment_prompt 方法中使用，在生成阶段的开始阶段使用一次。</li>
</ul>
</li>
<li>inference_query_latents。
<ul>
<li>作用：在生成过程中动态增强模型的推理能力。可以在生成过程中的多个点被注入，以提供实时上下文增强。</li>
<li>使用场景：在 augment_inference 方法中使用，在生成阶段中多次被使用。通常在遇到特定分隔符（逗号，句号等）后触发插入。</li>
</ul>
</li>
</ul>
<p>这两个变量都通过_augment 方法获得（获取学习到的潜在向量，并将其附加到输入嵌入中）。其流程如下：</p>
<ul>
<li>将潜在变量附加到当前输入嵌入序列的末尾。</li>
<li>更新注意力掩码和位置ID，以考虑新增的潜在向量。</li>
<li>将增强后的序列通过Weaver模型处理。</li>
<li>提供于潜在向量位置对应的隐状态作为增强表示。</li>
</ul>
<p>判断是否插入是通过函数 _should_augment 完成的。</p>
<ul>
<li>检查当前生成的文本是否是特殊字符（逗号等）</li>
<li>使用触发模型（trigger model）进一步判断是否应该增强。</li>
<li>考虑最大增强次数限制。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MemGenWeaver</span>(torch.nn.Module):
    <span class="hljs-string">"""
    MemGen模型的编织器模块（MemGenWeaver）。
    - 输入：接收接收来自推理器模型当前当前解码序列的`inputs_embeds`（输入嵌入入）
    - 输出：生成长度为K的隐藏状态序列，
这些状态将与原始`inputs_embeds`拼接，以改变推理器的解码路径
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self, 
        pretrained_model_name_or_path: <span class="hljs-built_in">str</span>,  <span class="hljs-comment"># 预训练模型的名称或路径</span>
        prompt_latents_num: <span class="hljs-built_in">int</span>,    <span class="hljs-comment"># 提示词阶段生成的潜在记忆数量</span>
        inference_latents_num: <span class="hljs-built_in">int</span>, <span class="hljs-comment"># 推理阶段生成的潜在记忆数量</span>
        peft_config: <span class="hljs-type">Optional</span>[PeftConfig] = <span class="hljs-literal">None</span>  <span class="hljs-comment"># PEFT配置（可选）</span>
    </span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 基础模型初始化</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            pretrained_model_name_or_path,
            torch_dtype=torch.bfloat16,  <span class="hljs-comment"># 使用bfloat16精度以提高效率</span>
            attn_implementation=<span class="hljs-string">"flash_attention_2"</span>  <span class="hljs-comment"># 启用Flash Attentionention 2优化</span>
        )
        self.tokenizer = AutoTokenizer.from_pretrained(pretrained_model_name_or_path)  <span class="hljs-comment"># 对应的分词器</span>
        <span class="hljs-comment"># 若提供PEFT配置，则应用参数高效微调</span>
        <span class="hljs-keyword">if</span> peft_config <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.model = get_peft_model(self.model, peft_config)
        
        self.config = self.model.config  <span class="hljs-comment"># 保存模型配置</span>
        
        <span class="hljs-comment"># 提示词阶段的潜在记忆查询向量（可学习参数）</span>
        self.prompt_query_latents = nn.Parameter(
            torch.randn(prompt_latents_num, self.config.hidden_size),  <span class="hljs-comment"># 形状：[prompt_latents_num, hidden_size]</span>
            requires_grad=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 允许反向传播更新</span>
        )

        <span class="hljs-comment"># 推理阶段的潜在记忆查询向量（可学习参数）</span>
        self.inference_query_latents = nn.Parameter(
            torch.randn(inference_latents_num, self.config.hidden_size),  <span class="hljs-comment"># 形状：[inference_latents_num, hidden_size]</span>
            requires_grad=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 允许反向传播更新</span>
        )
    
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">prompt_latents_num</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""返回提示词阶段的潜在记忆数量"""</span>
        <span class="hljs-keyword">return</span> self.prompt_query_latents.size(<span class="hljs-number">0</span>)

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">inference_latents_num</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""返回推理阶段的潜在记忆数量"""</span>
        <span class="hljs-keyword">return</span> self.inference_query_latents.size(<span class="hljs-number">0</span>)

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">device</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""返回模型所在的设备（CPU/GPU）"""</span>
        <span class="hljs-keyword">return</span> self.model.device

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_augment</span>(<span class="hljs-params">
        self, 
        latents: torch.Tensor,                <span class="hljs-comment"># 潜在记忆查询向量，形状：[latents_num, hidden_size]</span>
        inputs_embeds: torch.Tensor,          <span class="hljs-comment"># 输入嵌入，形状：[batch_size, seq_len, hidden_size]</span>
        attention_mask: torch.Tensor,         <span class="hljs-comment"># 注意力掩码，形状：[batch_size, seq_len]</span>
        position_ids: torch.Tensor            <span class="hljs-comment"># 位置ID，形状：[batch_size, seq_len]</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        通用的潜在记忆增强方法：将潜在记忆与输入序列融合，生成增强后的隐藏状态。
        
        参数：
            latents: 潜在记忆查询向量
            inputs_embeds: 输入序列的嵌入表示
            attention_mask: 输入序列的注意力掩码
            position_ids: 输入序列的位置ID
        
        返回：
            三元组 (latents_hidden_states, latents_mask, latents_position_ids)
            - latents_hidden_states: 生成的潜在记忆隐藏状态，形状：[batch_size, latents_num, hidden_size]
            - latents_mask: 潜在记忆的注意力掩码，形状：[batch_size, latents_num]
            - latents_position_ids: 潜在记忆的位置ID，形状：[batch_size, latents_num]
        """</span>
        batch_size = attention_mask.shape[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取批次大小</span>
        latents_num = latents.size(<span class="hljs-number">0</span>)         <span class="hljs-comment"># 获取潜在记忆数量</span>
        
        <span class="hljs-comment"># 扩展潜在记忆维度以匹配批次大小：[1, latents_num, hidden_size] → [batch_size, latents_num, hidden_size]</span>
        latents = latents.unsqueeze(<span class="hljs-number">0</span>).repeat(batch_size, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 将潜在记忆嵌入与输入嵌入拼接：[batch_size, seq_len + latents_num, hidden_size]</span>
        inputs_embeds = torch.cat([inputs_embeds, latents], dim=<span class="hljs-number">1</span>)

        <span class="hljs-comment"># 构建潜在记忆的注意力掩码（全为1，表示有效）并与输入掩码拼接</span>
        latents_mask = torch.ones(latents.shape[:-<span class="hljs-number">1</span>], dtype=attention_mask.dtype, device=attention_mask.device)
        attention_mask = torch.cat([attention_mask, latents_mask], dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 形状：[batch_size, seq_len + latents_num]</span>
        
        <span class="hljs-comment"># 生成潜在记忆的位置ID（在输入序列最后位置的基础上递增）</span>
        last_position_ids = position_ids.<span class="hljs-built_in">max</span>(dim=<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]  <span class="hljs-comment"># 获取输入序列的最大位置ID</span>
        latents_relative_positions = torch.arange(latents_num, device=attention_mask.device)  <span class="hljs-comment"># 潜在记忆的相对位置</span>
        <span class="hljs-comment"># 计算绝对位置：输入序列最大位置 + 相对位置 + 1（避免重叠）</span>
        latents_position_ids = last_position_ids.unsqueeze(<span class="hljs-number">1</span>) + latents_relative_positions + <span class="hljs-number">1</span>
        <span class="hljs-comment"># 拼接位置ID：[batch_size, seq_len + latents_num]</span>
        position_ids = torch.cat([position_ids.long(), latents_position_ids.long()], dim=<span class="hljs-number">1</span>) 

        <span class="hljs-comment"># 验证拼接后的维度是否一致</span>
        <span class="hljs-keyword">assert</span> inputs_embeds.shape[:<span class="hljs-number">2</span>] == attention_mask.shape == position_ids.shape

        <span class="hljs-comment"># 模型前向传播，获取隐藏状态</span>
        outputs = self.model(
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids,  
            output_hidden_states=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 输出所有层的隐藏状态</span>
        )
        <span class="hljs-comment"># 取最后一层的隐藏状态，并提取潜在记忆部分（序列末尾的latents_num个位置）</span>
        hidden_states = outputs.hidden_states[-<span class="hljs-number">1</span>]
        latents_hidden_states = hidden_states[:, -latents_num:, :]

        <span class="hljs-keyword">return</span> latents_hidden_states, latents_mask, latents_position_ids

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">augment_prompt</span>(<span class="hljs-params">
        self, 
        inputs_embeds: torch.Tensor, 
        attention_mask: torch.Tensor, 
        position_ids: torch.Tensor
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        提示词阶段的潜在记忆增强：使用提示词专用的潜在记忆查询向量。
        
        参数与返回值同_augment方法
        """</span>
        <span class="hljs-keyword">return</span> self._augment(
            latents=self.prompt_query_latents,
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids
        )


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">augment_inference</span>(<span class="hljs-params">
        self, 
        inputs_embeds: torch.Tensor, 
        attention_mask: torch.Tensor, 
        position_ids: torch.Tensor
    </span>) -&gt; <span class="hljs-type">Tuple</span>[torch.Tensor, torch.Tensor, torch.Tensor]:
        <span class="hljs-string">"""
        推理阶段的潜在记忆增强：使用推理专用的潜在记忆查询向量。
        
        参数与返回值同_augment方法
        """</span>
        <span class="hljs-keyword">return</span> self._augment(
            latents=self.inference_query_latents,
            inputs_embeds=inputs_embeds,
            attention_mask=attention_mask,
            position_ids=position_ids
        )
</code></pre>
<h3 data-id="heading-24">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpqCPoUw0p2oTsnMUj9t2mw" target="_blank" title="https://mp.weixin.qq.com/s/pqCPoUw0p2oTsnMUj9t2mw" ref="nofollow noopener noreferrer">最新成果！Agent记忆的第三种可能：生成式隐式记忆</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[InputConnection机制与跨进程文本操作的工程实践]]></title>    <link>https://juejin.cn/post/7570923924364853311</link>    <guid>https://juejin.cn/post/7570923924364853311</guid>    <pubDate>2025-11-10T13:26:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570923924364853311" data-draft-id="7571060853353824266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="InputConnection机制与跨进程文本操作的工程实践"/> <meta itemprop="keywords" content="Android,Linux"/> <meta itemprop="datePublished" content="2025-11-10T13:26:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WAsbry"/> <meta itemprop="url" content="https://juejin.cn/user/3413335797139511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            InputConnection机制与跨进程文本操作的工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3413335797139511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WAsbry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T13:26:16.000Z" title="Mon Nov 10 2025 13:26:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">InputConnection机制与跨进程文本操作的工程实践</h2>
<h3 data-id="heading-1">💡 本文精华</h3>
<ul>
<li><strong>承接前文</strong>：第一篇讲Binder通信，第二篇讲设计缺陷，本篇给出完整的工程解决方案</li>
<li><strong>核心需求</strong>：既保留数字键盘（inputType="number"），又避免字母输入导致数字丢失</li>
<li><strong>最佳方案</strong>：自定义InputConnection在<code>setComposingText()</code>层拦截非法字符，阻止进入delete-insert流程</li>
<li><strong>三种方案对比</strong>：InputConnection拦截（推荐⭐⭐⭐⭐⭐）、TextWatcher过滤（⭐⭐⭐）、自定义InputFilter（⭐⭐⭐⭐）</li>
<li><strong>价值</strong>：提供可直接使用的完整代码，分析方案优劣，指导工程实践</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、需求分析与约束条件</h3>
<h4 data-id="heading-3">1.1 核心需求</h4>
<pre><code class="hljs language-markdown" lang="markdown">用户需求:
<span class="hljs-bullet">1.</span> 点击EditText时，弹出数字键盘（不是全键盘）
<span class="hljs-bullet">2.</span> 只允许输入数字字符
<span class="hljs-bullet">3.</span> 切换到字母键盘输入字母时，不应导致已有数字丢失

技术约束:
<span class="hljs-bullet">1.</span> 必须使用 android:inputType="number" (保证数字键盘)
<span class="hljs-bullet">2.</span> 不能修改Android框架代码
<span class="hljs-bullet">3.</span> 需要兼容主流输入法（百度、搜狗、讯飞等）
<span class="hljs-bullet">4.</span> 性能开销要小
</code></pre>
<h4 data-id="heading-4">1.2 问题回顾</h4>
<p><strong>前两篇已分析的根本原因</strong>：</p>
<pre><code class="hljs language-css" lang="css">输入法进程:
  ic.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>)
  ↓ Binder IPC
应用进程:
  BaseInputConnection.<span class="hljs-built_in">replaceText</span>(<span class="hljs-string">"qq"</span>, <span class="hljs-number">1</span>, true)
  ↓
  <span class="hljs-number">1</span>. <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → 成功（绕过InputFilter）
  <span class="hljs-number">2</span>. <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) → 失败（被DigitsKeyListener拒绝）
  ↓
  结果: 数据丢失
</code></pre>
<p><strong>解决方向</strong>：</p>
<ul>
<li>在delete执行之前拦截</li>
<li>判断新文本是否合法</li>
<li>如果非法，不进入delete-insert流程</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、解决方案一：InputConnection拦截（推荐⭐⭐⭐⭐⭐）</h3>
<h4 data-id="heading-6">2.1 核心思路</h4>
<pre><code class="hljs language-css" lang="css">原始流程（有Bug）:
<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
  → <span class="hljs-built_in">replaceText</span>()
  → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) ← 删除数字
  → <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) ← 被拒绝
  → Bug!

优化后流程:
<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
  → NumberInputConnectionWrapper.<span class="hljs-built_in">setComposingText</span>()
  → 检测到字母 <span class="hljs-string">'q'</span>
  → 调用 <span class="hljs-built_in">finishComposingText</span>() ← 直接完成组合，不执行delete-insert
  → 数字保持不变 ✓
</code></pre>
<h4 data-id="heading-7">2.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-comment">// 获取父类创建的InputConnection</span>
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 包装成我们的自定义InputConnection</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputConnection包装类
     * 拦截setComposingText，检查是否包含非数字字符
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">NumberInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-comment">// 关键：在执行delete-insert之前检查</span>
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-comment">// 包含非数字字符，直接完成组合（不执行delete-insert）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }

            <span class="hljs-comment">// 纯数字或null，正常处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-comment">/**
         * 检查CharSequence是否包含非数字字符
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
                <span class="hljs-keyword">if</span> (!Character.isDigit(c)) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 发现非数字字符</span>
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 全部是数字</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-8">2.3 使用方法</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">com.yourpackage.RecommendedNumberEditText</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/edit_number"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
    <span class="hljs-attr">android:hint</span>=<span class="hljs-string">"请输入数字"</span>
    <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">"number"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MainActivity.java</span>
<span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> findViewById(R.id.edit_number);
<span class="hljs-comment">// 正常使用，无需额外代码</span>
</code></pre>
<h4 data-id="heading-9">2.4 方案优势</h4>

































<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>拦截时机早</strong></td><td>在delete之前拦截，从源头解决问题</td></tr><tr><td><strong>性能最优</strong></td><td>不执行delete-insert，避免无效操作</td></tr><tr><td><strong>对输入法透明</strong></td><td>返回true，输入法认为成功，不影响正常流程</td></tr><tr><td><strong>不影响正常输入</strong></td><td>数字输入不受影响，仍走原有逻辑</td></tr><tr><td><strong>代码简洁</strong></td><td>只需重写一个方法</td></tr><tr><td><strong>数字键盘保留</strong></td><td>inputType="number"保证数字键盘弹出</td></tr></tbody></table>
<h4 data-id="heading-10">2.5 工作流程图</h4>
<pre><code class="hljs language-css" lang="css">用户操作：
  输入数字 "<span class="hljs-number">123456</span>"
  ↓
  切换到字母键盘
  ↓
  点击 '<span class="hljs-selector-tag">q</span>'

输入法进程:
  ic.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>)
  ↓ Binder IPC

应用进程:
  NumberInputConnectionWrapper.<span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"q"</span>, <span class="hljs-number">1</span>)
  ↓
  <span class="hljs-built_in">containsNonDigit</span>(<span class="hljs-string">"q"</span>) → true (检测到字母)
  ↓
  调用 <span class="hljs-built_in">finishComposingText</span>()
  ↓
  BaseInputConnection.<span class="hljs-built_in">finishComposingText</span>()
    - 移除COMPOSING Span
    - 不执行delete
    - 不执行insert
  ↓
  返回 true
  ↓
  内容保持 <span class="hljs-string">"123456"</span> ✓

继续点击 <span class="hljs-string">'q'</span>:
  同样流程，每次都调用 <span class="hljs-built_in">finishComposingText</span>()
  内容始终保持 <span class="hljs-string">"123456"</span> ✓
</code></pre>
<hr/>
<h3 data-id="heading-11">三、解决方案二：TextWatcher过滤（⭐⭐⭐）</h3>
<h4 data-id="heading-12">3.1 核心思路</h4>
<pre><code class="hljs">原理：
不依赖InputFilter，而是监听文本变化
在文本改变后，过滤掉非数字字符
</code></pre>
<h4 data-id="heading-13">3.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isFiltering</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 防止递归</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        init();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 不设置inputType为number，避免DigitsKeyListener</span>
        <span class="hljs-comment">// 但会丢失数字键盘，需要手动设置</span>
        setRawInputType(InputType.TYPE_CLASS_NUMBER);

        addTextChangedListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWatcher</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> count, <span class="hljs-type">int</span> after)</span> {
                <span class="hljs-comment">// 不需要处理</span>
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTextChanged</span><span class="hljs-params">(CharSequence s, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> before, <span class="hljs-type">int</span> count)</span> {
                <span class="hljs-comment">// 不需要处理</span>
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterTextChanged</span><span class="hljs-params">(Editable s)</span> {
                <span class="hljs-keyword">if</span> (isFiltering) {
                    <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 避免递归</span>
                }

                <span class="hljs-comment">// 过滤掉非数字字符</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> s.toString().replaceAll(<span class="hljs-string">"[^0-9]"</span>, <span class="hljs-string">""</span>);

                <span class="hljs-keyword">if</span> (!s.toString().equals(filtered)) {
                    isFiltering = <span class="hljs-literal">true</span>;

                    <span class="hljs-comment">// 保存光标位置</span>
                    <span class="hljs-type">int</span> <span class="hljs-variable">cursorPos</span> <span class="hljs-operator">=</span> getSelectionStart();
                    <span class="hljs-type">int</span> <span class="hljs-variable">lengthBefore</span> <span class="hljs-operator">=</span> s.length();

                    <span class="hljs-comment">// 替换为过滤后的内容</span>
                    setText(filtered);

                    <span class="hljs-comment">// 调整光标位置</span>
                    <span class="hljs-type">int</span> <span class="hljs-variable">lengthAfter</span> <span class="hljs-operator">=</span> filtered.length();
                    <span class="hljs-type">int</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> lengthBefore - lengthAfter;
                    <span class="hljs-type">int</span> <span class="hljs-variable">newCursorPos</span> <span class="hljs-operator">=</span> Math.max(<span class="hljs-number">0</span>, cursorPos - diff);
                    setSelection(Math.min(newCursorPos, filtered.length()));

                    isFiltering = <span class="hljs-literal">false</span>;
                }
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-14">3.3 方案优劣</h4>





























<table><thead><tr><th>维度</th><th>评价</th></tr></thead><tbody><tr><td><strong>优点</strong></td><td>实现简单，易于理解</td></tr><tr><td><strong>优点</strong></td><td>不依赖InputConnection，逻辑独立</td></tr><tr><td><strong>缺点</strong></td><td>需要额外的setText操作，性能略差</td></tr><tr><td><strong>缺点</strong></td><td>光标位置处理复杂</td></tr><tr><td><strong>缺点</strong></td><td>会触发额外的TextWatcher回调</td></tr></tbody></table>
<h4 data-id="heading-15">3.4 性能对比</h4>
<pre><code class="hljs language-css" lang="css">方案一（InputConnection拦截）:
  <span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
    → 检测到字母
    → <span class="hljs-built_in">finishComposingText</span>()
    → <span class="hljs-number">1</span>次操作

方案二（TextWatcher）:
  <span class="hljs-built_in">setComposingText</span>(<span class="hljs-string">"qq"</span>)
    → <span class="hljs-built_in">delete</span>(<span class="hljs-number">5</span>, <span class="hljs-number">6</span>) → 删除<span class="hljs-string">'6'</span>
    → <span class="hljs-built_in">insert</span>(<span class="hljs-string">"qq"</span>) → 被拒绝
    → afterTextChanged触发
    → <span class="hljs-built_in">setText</span>(<span class="hljs-string">"123456"</span>) → 恢复
    → <span class="hljs-number">3</span>次操作

性能差距：方案二约<span class="hljs-number">3</span>倍于方案一
</code></pre>
<hr/>
<h3 data-id="heading-16">四、解决方案三：自定义InputFilter（⭐⭐⭐⭐）</h3>
<h4 data-id="heading-17">4.1 核心思路</h4>
<pre><code class="hljs language-sql" lang="sql">原理：
不仅拦截<span class="hljs-keyword">insert</span>，也拦截<span class="hljs-keyword">delete</span>
通过判断source是否为空来区分操作类型
</code></pre>
<h4 data-id="heading-18">4.2 完整实现代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        init();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        init();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 设置自定义Filter，替换系统的DigitsKeyListener</span>
        setFilters(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputFilter</span>[]{<span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeNumberInputFilter</span>()});
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 同时使用InputConnection拦截（双重保护）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputFilter
     * 拦截非数字字符的插入
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeNumberInputFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InputFilter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
            <span class="hljs-comment">// 过滤掉非数字字符</span>
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">filtered</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) {
                <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> source.charAt(i);
                <span class="hljs-keyword">if</span> (Character.isDigit(c)) {
                    filtered.append(c);
                }
            }

            <span class="hljs-comment">// 如果全部被过滤掉，返回空字符串</span>
            <span class="hljs-keyword">if</span> (filtered.length() == <span class="hljs-number">0</span> &amp;&amp; end &gt; start) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
            }

            <span class="hljs-comment">// 如果有字符被过滤掉，返回过滤后的内容</span>
            <span class="hljs-keyword">if</span> (filtered.length() &lt; (end - start)) {
                <span class="hljs-keyword">return</span> filtered.toString();
            }

            <span class="hljs-comment">// 全部合法，返回null（接受原始内容）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">/**
     * InputConnection包装类
     * 作为第二层防护
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.3 方案特点</h4>

























<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>双重保护</strong></td><td>InputFilter + InputConnection两层拦截</td></tr><tr><td><strong>灵活性高</strong></td><td>可以自定义过滤规则（如允许小数点）</td></tr><tr><td><strong>兼容性好</strong></td><td>适配各种输入场景</td></tr><tr><td><strong>代码复杂</strong></td><td>需要同时实现Filter和Wrapper</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">五、三种方案对比与选型指南</h3>
<h4 data-id="heading-21">5.1 全面对比</h4>





















































<table><thead><tr><th>维度</th><th>方案一：InputConnection</th><th>方案二：TextWatcher</th><th>方案三：自定义Filter</th></tr></thead><tbody><tr><td><strong>实现复杂度</strong></td><td>⭐⭐ (简单)</td><td>⭐ (最简单)</td><td>⭐⭐⭐⭐ (复杂)</td></tr><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐ (最优)</td><td>⭐⭐⭐ (一般)</td><td>⭐⭐⭐⭐ (好)</td></tr><tr><td><strong>拦截时机</strong></td><td>早（delete之前）</td><td>晚（文本已改变）</td><td>早（但有局限）</td></tr><tr><td><strong>数字键盘</strong></td><td>✓ 自动</td><td>✓ 手动设置</td><td>✓ 自动</td></tr><tr><td><strong>光标处理</strong></td><td>✓ 自动</td><td>✗ 需手动</td><td>✓ 自动</td></tr><tr><td><strong>代码量</strong></td><td>~40行</td><td>~60行</td><td>~80行</td></tr><tr><td><strong>推荐度</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<h4 data-id="heading-22">5.2 选型建议</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">场景1: 普通数字输入框</span>
  推荐: 方案一（InputConnection拦截）
  理由: 性能最优，代码最简洁

<span class="hljs-section">场景2: 需要自定义过滤规则（如电话号码：数字 + '-'）</span>
  推荐: 方案三（自定义Filter + InputConnection）
  理由: 灵活性高，可自定义allowed字符集

<span class="hljs-section">场景3: 快速原型开发</span>
  推荐: 方案二（TextWatcher）
  理由: 最简单，快速实现

<span class="hljs-section">场景4: 高性能要求（如大量EditText）</span>
  推荐: 方案一（InputConnection拦截）
  理由: 性能开销最小

<span class="hljs-section">场景5: 复杂输入验证（如金额：数字 + 小数点，最多2位小数）</span>
  推荐: 方案三（自定义Filter）
  理由: 可以在filter()中实现复杂规则
</code></pre>
<h4 data-id="heading-23">5.3 实际项目中的使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例：金额输入框（允许数字和小数点，最多2位小数）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MoneyInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MoneyInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-comment">// 检查是否符合金额格式</span>
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; !isValidMoneyInput(text)) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidMoneyInput</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-comment">// 允许：数字、小数点</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> text.toString();
            <span class="hljs-comment">// 简单验证：只包含[0-9.]</span>
            <span class="hljs-keyword">return</span> str.matches(<span class="hljs-string">"[0-9.]*"</span>);
        }
    }

    <span class="hljs-comment">// 可以配合InputFilter做更复杂的验证（如最多2位小数）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyInputFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InputFilter</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> CharSequence <span class="hljs-title function_">filter</span><span class="hljs-params">(CharSequence source, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end,
                                   Spanned dest, <span class="hljs-type">int</span> dstart, <span class="hljs-type">int</span> dend)</span> {
            <span class="hljs-comment">// 组合后的完整文本</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">beforeInsert</span> <span class="hljs-operator">=</span> dest.subSequence(<span class="hljs-number">0</span>, dstart).toString();
            <span class="hljs-type">String</span> <span class="hljs-variable">afterInsert</span> <span class="hljs-operator">=</span> dest.subSequence(dend, dest.length()).toString();
            <span class="hljs-type">String</span> <span class="hljs-variable">newText</span> <span class="hljs-operator">=</span> beforeInsert + source.subSequence(start, end) + afterInsert;

            <span class="hljs-comment">// 验证：最多一个小数点</span>
            <span class="hljs-keyword">if</span> (newText.indexOf(<span class="hljs-string">'.'</span>) != newText.lastIndexOf(<span class="hljs-string">'.'</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 拒绝（多个小数点）</span>
            }

            <span class="hljs-comment">// 验证：小数点后最多2位</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">dotIndex</span> <span class="hljs-operator">=</span> newText.indexOf(<span class="hljs-string">'.'</span>);
            <span class="hljs-keyword">if</span> (dotIndex != -<span class="hljs-number">1</span> &amp;&amp; newText.length() - dotIndex &gt; <span class="hljs-number">3</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 拒绝（超过2位小数）</span>
            }

            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 接受</span>
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-24">六、工程实践的最佳实践</h3>
<h4 data-id="heading-25">6.1 性能监控</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MonitoredInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MonitoredInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();

            <span class="hljs-type">boolean</span> result;
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                result = <span class="hljs-built_in">super</span>.finishComposingText();
            } <span class="hljs-keyword">else</span> {
                result = <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
            }

            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
            <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">1_000_000</span>) { <span class="hljs-comment">// 超过1ms</span>
                Log.w(<span class="hljs-string">"InputMonitor"</span>, <span class="hljs-string">"setComposingText slow: "</span> + duration / <span class="hljs-number">1_000_000.0</span> + <span class="hljs-string">"ms"</span>);
            }

            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h4 data-id="heading-26">6.2 日志调试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DebugNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"DebugNumberEditText"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DebugInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DebugInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">DebugInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            Log.d(TAG, <span class="hljs-string">"setComposingText: text='"</span> + text + <span class="hljs-string">"', cursor="</span> + newCursorPosition);

            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNonDigit</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                    <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
                    <span class="hljs-keyword">if</span> (!Character.isDigit(c)) {
                        hasNonDigit = <span class="hljs-literal">true</span>;
                        Log.w(TAG, <span class="hljs-string">"  Detected non-digit: '"</span> + c + <span class="hljs-string">"' at index "</span> + i);
                    }
                }
            }

            <span class="hljs-type">boolean</span> result;
            <span class="hljs-keyword">if</span> (hasNonDigit) {
                Log.d(TAG, <span class="hljs-string">"  Action: finishComposingText() (rejecting non-digit input)"</span>);
                result = <span class="hljs-built_in">super</span>.finishComposingText();
            } <span class="hljs-keyword">else</span> {
                Log.d(TAG, <span class="hljs-string">"  Action: setComposingText() (accepting digit input)"</span>);
                result = <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
            }

            Log.d(TAG, <span class="hljs-string">"  Result: "</span> + result);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">commitText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            Log.d(TAG, <span class="hljs-string">"commitText: text='"</span> + text + <span class="hljs-string">"', cursor="</span> + newCursorPosition);
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.commitText(text, newCursorPosition);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">finishComposingText</span><span class="hljs-params">()</span> {
            Log.d(TAG, <span class="hljs-string">"finishComposingText"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
        }
    }
}
</code></pre>
<h4 data-id="heading-27">6.3 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RunWith(RobolectricTestRunner.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberEditTextTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDigitInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试正常数字输入</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"456"</span>, <span class="hljs-number">1</span>);

        assertEquals(<span class="hljs-string">"123456"</span>, editText.getText().toString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLetterInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试字母输入（应该被拒绝）</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"abc"</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 内容不应该变化</span>
        assertEquals(<span class="hljs-string">"123"</span>, editText.getText().toString());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMixedInput</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 测试混合输入</span>
        <span class="hljs-type">RecommendedNumberEditText</span> <span class="hljs-variable">editText</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecommendedNumberEditText</span>(ApplicationProvider.getApplicationContext());
        editText.setText(<span class="hljs-string">"123"</span>);

        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">ic</span> <span class="hljs-operator">=</span> editText.onCreateInputConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EditorInfo</span>());
        ic.setComposingText(<span class="hljs-string">"4a5"</span>, <span class="hljs-number">1</span>);

        <span class="hljs-comment">// 包含字母，应该被拒绝</span>
        assertEquals(<span class="hljs-string">"123"</span>, editText.getText().toString());
    }
}
</code></pre>
<h4 data-id="heading-28">6.4 兼容性测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 测试不同输入法的兼容性
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IMECompatibilityTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBaiduIME</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟百度输入法的行为</span>
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSogouIME</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟搜狗输入法的行为</span>
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGboard</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟Google Gboard的行为</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-29">七、常见问题与解答</h3>
<h4 data-id="heading-30">7.1 为什么不直接去掉inputType="number"？</h4>
<p><strong>问题</strong>：去掉inputType后，不会有Bug，为什么不这样做？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">去掉 <span class="hljs-attr">inputType</span>=<span class="hljs-string">"number"</span> 的后果:
1. 弹出全键盘（而不是数字键盘）
2. 用户体验变差（输入数字需要切换键盘）
3. 无法使用系统的数字键盘优化

保留 <span class="hljs-attr">inputType</span>=<span class="hljs-string">"number"</span> + InputConnection拦截:
1. 保留数字键盘（用户体验好）
2. 避免数据丢失（技术正确）
3. 最佳实践
</code></pre>
<h4 data-id="heading-31">7.2 为什么调用finishComposingText()？</h4>
<p><strong>问题</strong>：为什么不直接return false？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误做法</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (containsNonDigit(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// ✗ 输入法会认为失败，可能重试或报错</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}

<span class="hljs-comment">// 正确做法</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (containsNonDigit(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText(); <span class="hljs-comment">// ✓ 告诉输入法"组合已完成"</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}
</code></pre>
<p><strong>原因</strong>：</p>
<ul>
<li><code>finishComposingText()</code> 是合法的操作，输入法会正常处理</li>
<li>返回 <code>false</code> 表示操作失败，输入法可能出现异常行为</li>
<li><code>finishComposingText()</code> 会清除COMPOSING Span，避免后续问题</li>
</ul>
<h4 data-id="heading-32">7.3 为什么不用setFilters完全替代？</h4>
<p><strong>问题</strong>：为什么不只用InputFilter，还要用InputConnection？</p>
<p><strong>解答</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">单独使用 InputFilter 的问题:
<span class="hljs-bullet">1.</span> 无法阻止delete操作（delete绕过Filter）
<span class="hljs-bullet">2.</span> 仍会触发Bug

单独使用 InputConnection 的优势:
<span class="hljs-bullet">1.</span> 拦截时机早（delete之前）
<span class="hljs-bullet">2.</span> 从源头解决问题

最佳实践:
  InputConnection拦截为主（方案一）
  或 InputFilter + InputConnection双重保护（方案三）
</code></pre>
<h4 data-id="heading-33">7.4 如何支持小数点？</h4>
<p><strong>扩展方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidNumberInput</span><span class="hljs-params">(CharSequence text)</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
        <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> text.charAt(i);
        <span class="hljs-comment">// 允许数字和小数点</span>
        <span class="hljs-keyword">if</span> (!Character.isDigit(c) &amp;&amp; c != <span class="hljs-string">'.'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; !isValidNumberInput(text)) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
}

<span class="hljs-comment">// 同时设置inputType</span>
setInputType(InputType.TYPE_CLASS_NUMBER | InputType.TYPE_NUMBER_FLAG_DECIMAL);
</code></pre>
<hr/>
<h3 data-id="heading-34">八、总结：从理论到实践的完整链路</h3>
<h4 data-id="heading-35">8.1 三篇文章的知识链</h4>
<pre><code class="hljs language-sql" lang="sql">第一篇：Binder通信机制
  ├─ 三进程架构
  ├─ AIDL接口定义
  ├─ Stub<span class="hljs-operator">/</span>Proxy实现
  ├─ 线程切换
  └─ 信息不对称
       ↓ 为什么输入法不知道实际结果

第二篇：文本编辑设计缺陷
  ├─ InputFilter接口局限
  ├─ <span class="hljs-keyword">delete</span>绕过<span class="hljs-keyword">Filter</span>
  ├─ replaceText先<span class="hljs-keyword">delete</span>后<span class="hljs-keyword">insert</span>
  ├─ Span范围异常扩展
  └─ 不对称的控制权
       ↓ 为什么数字会被删除

第三篇（本文）：工程解决方案
  ├─ InputConnection拦截（推荐）
  ├─ TextWatcher过滤（简单）
  ├─ 自定义InputFilter（灵活）
  ├─ 三种方案对比
  ├─ 选型指南
  ├─ 最佳实践
  └─ 完整代码
       ↓ 如何在实际项目中解决
</code></pre>
<h4 data-id="heading-36">8.2 最佳实践总结</h4>






























<table><thead><tr><th>场景</th><th>推荐方案</th><th>核心代码</th></tr></thead><tbody><tr><td><strong>普通数字输入</strong></td><td>InputConnection拦截</td><td><code>finishComposingText()</code></td></tr><tr><td><strong>自定义规则</strong></td><td>自定义Filter + IC</td><td><code>filter()</code> + <code>finishComposingText()</code></td></tr><tr><td><strong>快速开发</strong></td><td>TextWatcher</td><td><code>afterTextChanged()</code> + <code>setText()</code></td></tr><tr><td><strong>高性能</strong></td><td>InputConnection拦截</td><td>避免多余操作</td></tr></tbody></table>
<h4 data-id="heading-37">8.3 核心要点</h4>
<pre><code class="hljs language-markdown" lang="markdown">关键设计决策:
<span class="hljs-bullet">1.</span> 保留 inputType="number" （数字键盘）
<span class="hljs-bullet">2.</span> 重写 onCreateInputConnection() （拦截入口）
<span class="hljs-bullet">3.</span> 包装 InputConnectionWrapper （扩展功能）
<span class="hljs-bullet">4.</span> 拦截 setComposingText() （关键方法）
<span class="hljs-bullet">5.</span> 调用 finishComposingText() （正确处理）

为什么这样设计:
<span class="hljs-bullet">1.</span> 用户体验：数字键盘更方便
<span class="hljs-bullet">2.</span> 性能优化：拦截早，开销小
<span class="hljs-bullet">3.</span> 兼容性好：对输入法透明
<span class="hljs-bullet">4.</span> 代码简洁：只需40行代码
<span class="hljs-bullet">5.</span> 易于维护：逻辑清晰
</code></pre>
<h4 data-id="heading-38">8.4 延伸应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 可以扩展到其他场景:</span>

<span class="hljs-comment">// 1. 手机号输入（数字 + 空格/横线）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 2. 邮箱输入（限制特殊字符）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 3. 用户名输入（字母 + 数字 + 下划线）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsernameEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 4. 密码输入（增强安全）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurePasswordEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-39">九、完整示例项目结构</h3>
<pre><code class="hljs language-css" lang="css">app/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/java/com/yourpackage/
├─ widget/
│  ├─ RecommendedNumberEditText<span class="hljs-selector-class">.java</span>   ← 方案一（推荐）
│  ├─ SimpleNumberEditText<span class="hljs-selector-class">.java</span>        ← 方案二
│  ├─ SafeNumberEditText<span class="hljs-selector-class">.java</span>          ← 方案三
│  ├─ MoneyEditText<span class="hljs-selector-class">.java</span>               ← 扩展：金额输入
│  ├─ PhoneNumberEditText<span class="hljs-selector-class">.java</span>         ← 扩展：电话输入
│  └─ DebugNumberEditText<span class="hljs-selector-class">.java</span>         ← 调试版本
│
├─ utils/
│  └─ InputValidationUtils<span class="hljs-selector-class">.java</span>        ← 通用验证工具
│
└─ MainActivity<span class="hljs-selector-class">.java</span>

app/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/res/layout/
└─ activity_main<span class="hljs-selector-class">.xml</span>

app/<span class="hljs-attribute">src</span>/test/java/com/yourpackage/
└─ NumberEditTextTest<span class="hljs-selector-class">.java</span>             ← 单元测试
</code></pre>
<hr/>
<h3 data-id="heading-40">参考资料</h3>
<ol>
<li>Android源码：<code>frameworks/base/core/java/android/view/inputmethod/InputConnectionWrapper.java</code></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2Finputmethod%2FInputConnectionWrapper" target="_blank" title="https://developer.android.com/reference/android/view/inputmethod/InputConnectionWrapper" ref="nofollow noopener noreferrer">InputConnectionWrapper</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fview%2Finputmethod%2FInputConnection" target="_blank" title="https://developer.android.com/reference/android/view/inputmethod/InputConnection" ref="nofollow noopener noreferrer">InputConnection</a></li>
<li>本系列前两篇：
<ul>
<li>第一篇：《Android输入法框架的Binder通信机制剖析》</li>
<li>第二篇：《从一个Bug看Android文本编辑的设计缺陷》</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-41">附录：完整可运行的示例代码</h3>
<p><strong>RecommendedNumberEditText.java</strong>（直接复制可用）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.yourpackage.widget;

<span class="hljs-keyword">import</span> android.content.Context;
<span class="hljs-keyword">import</span> android.util.AttributeSet;
<span class="hljs-keyword">import</span> android.view.inputmethod.EditorInfo;
<span class="hljs-keyword">import</span> android.view.inputmethod.InputConnection;
<span class="hljs-keyword">import</span> android.view.inputmethod.InputConnectionWrapper;
<span class="hljs-keyword">import</span> androidx.appcompat.widget.AppCompatEditText;

<span class="hljs-comment">/**
 * 推荐的数字输入框实现
 * 解决 inputType="number" 时，切换字母键盘导致数字丢失的问题
 *
 * 使用方法:
 * &lt;com.yourpackage.widget.RecommendedNumberEditText
 *     android:inputType="number"
 *     ... /&gt;
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecommendedNumberEditText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatEditText</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RecommendedNumberEditText</span><span class="hljs-params">(Context context, AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InputConnection <span class="hljs-title function_">onCreateInputConnection</span><span class="hljs-params">(EditorInfo outAttrs)</span> {
        <span class="hljs-type">InputConnection</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.onCreateInputConnection(outAttrs);
        <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span>(base, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">/**
     * 自定义InputConnection包装类
     * 拦截setComposingText，检查是否包含非数字字符
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberInputConnectionWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputConnectionWrapper</span> {

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">NumberInputConnectionWrapper</span><span class="hljs-params">(InputConnection target, <span class="hljs-type">boolean</span> mutable)</span> {
            <span class="hljs-built_in">super</span>(target, mutable);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setComposingText</span><span class="hljs-params">(CharSequence text, <span class="hljs-type">int</span> newCursorPosition)</span> {
            <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; containsNonDigit(text)) {
                <span class="hljs-comment">// 包含非数字字符，直接完成组合（不执行delete-insert）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.finishComposingText();
            }
            <span class="hljs-comment">// 纯数字或null，正常处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.setComposingText(text, newCursorPosition);
        }

        <span class="hljs-comment">/**
         * 检查是否包含非数字字符
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsNonDigit</span><span class="hljs-params">(CharSequence text)</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; text.length(); i++) {
                <span class="hljs-keyword">if</span> (!Character.isDigit(text.charAt(i))) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p><strong>activity_main.xml</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>
    <span class="hljs-attr">android:padding</span>=<span class="hljs-string">"16dp"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"推荐方案（InputConnection拦截）："</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"16sp"</span>
        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">com.yourpackage.widget.RecommendedNumberEditText</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/edit_recommended"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:hint</span>=<span class="hljs-string">"请输入数字"</span>
        <span class="hljs-attr">android:inputType</span>=<span class="hljs-string">"number"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"24dp"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"测试说明："</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"14sp"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"8dp"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"1. 输入数字 123456\n2. 切换到字母键盘\n3. 连续点击字母 'q'\n4. 数字不会被删除 ✓"</span>
        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"12sp"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<hr/>
<p><strong>系列完结</strong>。从Binder通信机制，到文本编辑设计缺陷，再到完整的工程解决方案，希望这三篇文章能帮助你深入理解Android输入法框架，并在实际项目中游刃有余地解决类似问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践]]></title>    <link>https://juejin.cn/post/7570903763722289162</link>    <guid>https://juejin.cn/post/7570903763722289162</guid>    <pubDate>2025-11-10T15:02:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570903763722289162" data-draft-id="7570897638441238555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-10T15:02:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI × SQLAlchemy 2.0 Async：从“能跑”到“可压测”的完整工程实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T15:02:02.000Z" title="Mon Nov 10 2025 15:02:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一句话总结<br/>
用 <strong>SQLAlchemy 2.0 AsyncIO</strong> 模式，把 FastAPI 的并发优势兑现成 <strong>真正的数据库吞吐</strong>；再叠上连接池、事务、迁移、测试四件套，<strong>直接上线不踩坑</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 为什么要“异步 ORM”？</h2>

























<table><thead><tr><th>场景</th><th>同步 SQLAlchemy</th><th>异步 SQLAlchemy</th></tr></thead><tbody><tr><td>100 个并发上传</td><td>开 100 线程 → 100 个连接 → DB 被打爆</td><td>单线程 20 连接即可跑满 CPU</td></tr><tr><td>请求等待 I/O</td><td>线程上下文切换 8 ms</td><td>协程切换 0.3 ms</td></tr><tr><td>代码风格</td><td>到处 <code>run_in_threadpool</code></td><td>原生 <code>await</code> 一路到底</td></tr></tbody></table>
<blockquote>
<p>一句话：<strong>同步模式把 FastAPI 的异步事件循环拖回解放前</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">2. 最小可运行版本（MVP）</h2>
<p><strong>安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">pip install <span class="hljs-string">"fastapi[all]"</span> \
            <span class="hljs-string">"sqlalchemy[asyncio]&gt;=2.0"</span> \
            asyncpg alembic pydantic[email]
</code></pre>
<blockquote>
<p>数据库以 PostgreSQL 为例，MySQL 换成 <code>asyncmy</code> 即可。</p>
</blockquote>
<p><strong>项目骨架</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">app/
 ├─ api/
 │   └─ user.py
 ├─ core/
 │   ├─ db.py
 │   └─ config.py
 ├─ models/
 │   └─ user.py
 ├─ schemas/
 │   └─ user.py
 └─ main.py
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 核心代码：Session 生命周期一条龙</h2>
<p><strong>app/core/config.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseSettings

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    database_url: <span class="hljs-built_in">str</span> = <span class="hljs-string">"postgresql+asyncpg://user:pass@localhost:5432/demo"</span>
    pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>
    max_overflow: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>
    echo_sql: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env"</span>

settings = Settings()
</code></pre>
<p><strong>app/core/db.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> (
    AsyncEngine, AsyncSession, async_sessionmaker, create_async_engine
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDatabaseSession</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span>, *, pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">20</span>, max_overflow: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, echo: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>):
        self.engine: AsyncEngine = create_async_engine(
            url,
            pool_size=pool_size,
            max_overflow=max_overflow,
            echo=echo,
            pool_pre_ping=<span class="hljs-literal">True</span>,          <span class="hljs-comment"># 心跳保活</span>
        )
        self.session_factory = async_sessionmaker(
            self.engine,
            expire_on_commit=<span class="hljs-literal">False</span>,      <span class="hljs-comment"># 防止懒加载异常</span>
            class_=AsyncSession,
        )

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">await</span> self.engine.dispose()

db = AsyncDatabaseSession(
    settings.database_url,
    pool_size=settings.pool_size,
    echo=settings.echo_sql,
)
</code></pre>
<p><strong>main.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db
<span class="hljs-keyword">from</span> app.api <span class="hljs-keyword">import</span> user

app = FastAPI(title=<span class="hljs-string">"Async SQLAlchemy Demo"</span>)

app.include_router(user.router)

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"startup"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">startup</span>():
    <span class="hljs-comment"># 可选：建表</span>
    <span class="hljs-comment"># from app.models import Base</span>
    <span class="hljs-comment"># async with db.engine.begin() as conn:</span>
    <span class="hljs-comment">#     await conn.run_sync(Base.metadata.create_all)</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-meta">@app.on_event(<span class="hljs-params"><span class="hljs-string">"shutdown"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">shutdown</span>():
    <span class="hljs-keyword">await</span> db.close()
</code></pre>
<hr/>
<h2 data-id="heading-3">4. 依赖注入：每次请求一个 Session，自动回滚</h2>
<p><strong>app/core/deps.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> AsyncGenerator
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session</span>() -&gt; AsyncGenerator[AsyncSession, <span class="hljs-literal">None</span>]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.session_factory() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> session
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">await</span> session.rollback()
            <span class="hljs-keyword">raise</span>
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-keyword">await</span> session.close()
</code></pre>
<blockquote>
<p>用 <code>yield</code> + <code>rollback</code> 保证<strong>请求级事务</strong>；抛异常自动回滚，正常则 commit。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">5. Model / Schema / CRUD 一条龙</h2>
<p><strong>app/models/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> String
<span class="hljs-keyword">from</span> sqlalchemy.orm <span class="hljs-keyword">import</span> DeclarativeBase, Mapped, mapped_column

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span>(<span class="hljs-title class_ inherited__">DeclarativeBase</span>):
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">Base</span>):
    __tablename__ = <span class="hljs-string">"users"</span>

    <span class="hljs-built_in">id</span>: Mapped[<span class="hljs-built_in">int</span>] = mapped_column(primary_key=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    email: Mapped[<span class="hljs-built_in">str</span>] = mapped_column(String(<span class="hljs-number">320</span>), unique=<span class="hljs-literal">True</span>, index=<span class="hljs-literal">True</span>)
    full_name: Mapped[<span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>]
</code></pre>
<p><strong>app/schemas/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, EmailStr

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCreate</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    email: EmailStr
    full_name: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRead</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    email: EmailStr
    full_name: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        orm_mode = <span class="hljs-literal">True</span>
</code></pre>
<p><strong>app/api/user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, Depends, HTTPException
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User
<span class="hljs-keyword">from</span> app.schemas <span class="hljs-keyword">import</span> UserCreate, UserRead
<span class="hljs-keyword">from</span> app.core.deps <span class="hljs-keyword">import</span> get_session

router = APIRouter(prefix=<span class="hljs-string">"/users"</span>, tags=[<span class="hljs-string">"users"</span>])

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">""</span>, response_model=UserRead</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">payload: UserCreate, session: AsyncSession = Depends(<span class="hljs-params">get_session</span>)</span>):
    user = User(**payload.<span class="hljs-built_in">dict</span>())
    session.add(user)
    <span class="hljs-keyword">await</span> session.flush()          <span class="hljs-comment"># 获取 id</span>
    <span class="hljs-keyword">await</span> session.commit()
    <span class="hljs-keyword">await</span> session.refresh(user)
    <span class="hljs-keyword">return</span> user

<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/{uid}"</span>, response_model=UserRead</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_user</span>(<span class="hljs-params">uid: <span class="hljs-built_in">int</span>, session: AsyncSession = Depends(<span class="hljs-params">get_session</span>)</span>):
    user = <span class="hljs-keyword">await</span> session.get(User, uid)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">404</span>, <span class="hljs-string">"User not found"</span>)
    <span class="hljs-keyword">return</span> user
</code></pre>
<hr/>
<h2 data-id="heading-5">6. 迁移：Alembic 同样能异步</h2>
<p><strong>初始化</strong></p>
<pre><code class="hljs language-bash" lang="bash">alembic init -t async migrations
</code></pre>
<p><strong>修改 <code>alembic.ini</code> 中的 <code>sqlalchemy.url</code> 为 <code>postgresql+asyncpg://...</code></strong></p>
<p><strong>migrations/env.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> app.core.config <span class="hljs-keyword">import</span> settings
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> Base
target_metadata = Base.metadata

<span class="hljs-keyword">def</span> <span class="hljs-title function_">do_run_migrations</span>(<span class="hljs-params">connection</span>):
    context.configure(connection=connection, target_metadata=target_metadata)
    <span class="hljs-keyword">with</span> context.begin_transaction():
        context.run_migrations()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_async_migrations</span>():
    <span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncEngine
    connectable = AsyncEngine(create_async_engine(settings.database_url))
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> connectable.connect() <span class="hljs-keyword">as</span> connection:
        <span class="hljs-keyword">await</span> connection.run_sync(do_run_migrations)
    <span class="hljs-keyword">await</span> connectable.dispose()
</code></pre>
<p><strong>生成 / 升级</strong></p>
<pre><code class="hljs language-bash" lang="bash">alembic revision --autogenerate -m <span class="hljs-string">"init"</span>
alembic upgrade <span class="hljs-built_in">head</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">7. 测试：pytest-asyncio + 异步数据库事务</h2>
<p><strong>tests/conftest.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient
<span class="hljs-keyword">from</span> app.main <span class="hljs-keyword">import</span> app
<span class="hljs-keyword">from</span> app.core.db <span class="hljs-keyword">import</span> db <span class="hljs-keyword">as</span> db_instance
<span class="hljs-keyword">from</span> sqlalchemy.pool <span class="hljs-keyword">import</span> StaticPool
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> AsyncEngine, create_async_engine

<span class="hljs-meta">@pytest.fixture(<span class="hljs-params">scope=<span class="hljs-string">"session"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">engine</span>() -&gt; AsyncEngine:
    <span class="hljs-comment"># 内存 SQLite 也可以异步，但 PostgreSQL 更真实</span>
    engine = create_async_engine(
        <span class="hljs-string">"postgresql+asyncpg://test:test@localhost:5432/test"</span>,
        poolclass=StaticPool,
    )
    <span class="hljs-keyword">yield</span> engine
    <span class="hljs-keyword">await</span> engine.dispose()

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">session</span>(<span class="hljs-params">engine: AsyncEngine</span>):
    conn = <span class="hljs-keyword">await</span> engine.begin()
    sess = db_instance.session_factory(bind=conn)
    <span class="hljs-keyword">yield</span> sess
    <span class="hljs-keyword">await</span> sess.close()
    <span class="hljs-keyword">await</span> conn.rollback()
    <span class="hljs-keyword">await</span> conn.close()

<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">client</span>() -&gt; AsyncGenerator[AsyncClient, <span class="hljs-literal">None</span>]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient(app=app, base_url=<span class="hljs-string">"http://test"</span>) <span class="hljs-keyword">as</span> c:
        <span class="hljs-keyword">yield</span> c
</code></pre>
<p><strong>tests/test_user.py</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select
<span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> User

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_create_user</span>(<span class="hljs-params">client, session</span>):
    res = <span class="hljs-keyword">await</span> client.post(<span class="hljs-string">"/users"</span>, json={<span class="hljs-string">"email"</span>: <span class="hljs-string">"a@b.com"</span>, <span class="hljs-string">"full_name"</span>: <span class="hljs-string">"abc"</span>})
    <span class="hljs-keyword">assert</span> res.status_code == <span class="hljs-number">201</span>
    data = res.json()
    <span class="hljs-keyword">assert</span> data[<span class="hljs-string">"email"</span>] == <span class="hljs-string">"a@b.com"</span>

    user = <span class="hljs-keyword">await</span> session.get(User, data[<span class="hljs-string">"id"</span>])
    <span class="hljs-keyword">assert</span> user <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">8. 性能调优 checklist</h2>



































<table><thead><tr><th>参数</th><th>建议值</th><th>说明</th></tr></thead><tbody><tr><td><code>pool_size</code></td><td>CPU 核心 × 2</td><td>20 并发已能压到 10k RPS</td></tr><tr><td><code>max_overflow</code></td><td>0</td><td>防止突发连接打爆 DB</td></tr><tr><td><code>pool_pre_ping=True</code></td><td>必须</td><td>网络闪断后自动重连</td></tr><tr><td><code>expire_on_commit=False</code></td><td>必须</td><td>否则 commit 后属性失效</td></tr><tr><td><code>echo=False</code></td><td>生产关闭</td><td>减少序列化开销</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">9. 常见错误速查表</h2>






























<table><thead><tr><th>异常</th><th>原因</th><th>解法</th></tr></thead><tbody><tr><td><code>greenlet_spawn has not been called</code></td><td>用了同步引擎</td><td><code>create_async_engine</code></td></tr><tr><td><code>DetachedInstanceError</code></td><td>会话关闭后访问属性</td><td><code>expire_on_commit=False</code> + <code>await session.refresh()</code></td></tr><tr><td><code>InterfaceError: connection already closed</code></td><td>协程间复用 Session</td><td>一个请求一个 Session，禁止全局单例</td></tr><tr><td><code>ImportError: asyncmy</code></td><td>MySQL 驱动未装</td><td><code>pip install asyncmy</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">10. 结语</h2>
<p>FastAPI 的异步生态里，<strong>数据库是最后一道闸门</strong>。<br/>
用上 SQLAlchemy 2.0 AsyncIO 之后，<strong>I/O 等待不再是瓶颈</strong>，压测曲线直接多一个量级。<br/>
把本文的 <code>db.py</code> + <code>deps.py</code> 复制走，<strong>10 分钟就能让老项目原地起飞</strong>。Happy async coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 开发环境搭建全攻略（2025版）]]></title>    <link>https://juejin.cn/post/7571338749197090866</link>    <guid>https://juejin.cn/post/7571338749197090866</guid>    <pubDate>2025-11-11T11:49:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749197090866" data-draft-id="7571191453126770714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 开发环境搭建全攻略（2025版）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T11:49:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 开发环境搭建全攻略（2025版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T11:49:56.000Z" title="Tue Nov 11 2025 11:49:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将详细介绍如何在本地搭建一个高效、可维护的 Node.js 开发环境，适用于 Windows、macOS 与 Linux。无论你是后端新手还是资深全栈工程师，都能通过本文快速构建一个标准化的 Node.js 开发环境。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、什么是 Node.js？</h2>
<p><strong>Node.js</strong> 是一个基于 Chrome V8 引擎的 JavaScript 运行时，它让开发者可以在服务器端运行 JavaScript。
它以 <strong>事件驱动、非阻塞 I/O</strong> 的特性著称，非常适合构建高性能的 Web 服务和微服务架构。</p>
<hr/>
<h2 data-id="heading-1">二、安装 Node.js</h2>
<h3 data-id="heading-2">1. 使用官方安装包（适合初学者）</h3>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官方网站</a>
你会看到两个版本：</p>
<ul>
<li><strong>LTS（长期支持版）</strong>：稳定可靠，推荐生产环境使用</li>
<li><strong>Current（最新功能版）</strong>：包含最新特性，适合尝鲜或测试</li>
</ul>
<p>下载并运行对应操作系统的安装包后，命令行输入以下命令验证安装：</p>
<pre><code class="hljs language-bash" lang="bash">node -v
npm -v
</code></pre>
<p>你应能看到类似输出：</p>
<pre><code class="hljs">v20.18.1
10.5.2
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 使用 Node 版本管理器（推荐）</h3>
<p>在实际项目中，<strong>不同项目可能依赖不同版本的 Node.js</strong>。
因此推荐使用版本管理工具，如：</p>
<h4 data-id="heading-4">macOS / Linux：</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 nvm（Node Version Manager）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash

<span class="hljs-comment"># 载入配置</span>
<span class="hljs-built_in">source</span> ~/.bashrc  <span class="hljs-comment"># 或 ~/.zshrc</span>

<span class="hljs-comment"># 安装并使用指定版本</span>
nvm install 20
nvm use 20
</code></pre>
<h4 data-id="heading-5">Windows：</h4>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows" target="_blank" title="https://github.com/coreybutler/nvm-windows" ref="nofollow noopener noreferrer">nvm-windows</a>：</p>
<pre><code class="hljs language-powershell" lang="powershell">nvm install 20.18.1
nvm use 20.18.1
</code></pre>
<p>验证版本：</p>
<pre><code class="hljs language-bash" lang="bash">node -v
nvm list
</code></pre>
<p>✅ <strong>优势：</strong></p>
<ul>
<li>多版本 Node 共存</li>
<li>快速切换项目环境</li>
<li>更易于 CI/CD 集成</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、配置 npm（包管理工具）</h2>
<p>Node.js 自带的 <strong>npm</strong> 是 JavaScript 生态的核心包管理器。</p>
<h3 data-id="heading-7">常见配置：</h3>
<h4 data-id="heading-8">1. 修改全局镜像源（加速安装）</h4>
<p>默认源在国外，安装速度较慢，可以改为国内镜像：</p>
<pre><code class="hljs language-bash" lang="bash">npm config <span class="hljs-built_in">set</span> registry https://registry.npmmirror.com
</code></pre>
<p>查看是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">npm config get registry
</code></pre>
<h4 data-id="heading-9">2. 安装全局工具</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g yarn pnpm nodemon
</code></pre>
<p>常用工具说明：</p>

























<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td><code>yarn</code> / <code>pnpm</code></td><td>更快的包管理器</td></tr><tr><td><code>nodemon</code></td><td>自动重启 Node 服务</td></tr><tr><td><code>typescript</code></td><td>TypeScript 支持</td></tr><tr><td><code>eslint</code></td><td>代码规范检查</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">四、创建一个 Node.js 项目</h2>
<h3 data-id="heading-11">1. 初始化项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> my-node-app
<span class="hljs-built_in">cd</span> my-node-app
npm init -y
</code></pre>
<p>这会生成一个基本的 <code>package.json</code> 文件。</p>
<h3 data-id="heading-12">2. 创建主文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">touch</span> index.js
</code></pre>
<p>编辑内容：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span>});
  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Hello Node.js!'</span>);
});

server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server running at http://localhost:3000/'</span>);
});
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">node index.js
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> 即可看到结果。</p>
<hr/>
<h2 data-id="heading-13">五、使用现代化开发工具</h2>
<h3 data-id="heading-14">1. VS Code 配置</h3>
<p>安装推荐扩展：</p>
<ul>
<li><strong>ESLint</strong>：代码规范检查</li>
<li><strong>Prettier</strong>：自动格式化</li>
<li><strong>Node.js Extension Pack</strong>：常用 Node 工具集成</li>
</ul>
<p>添加 <code>.vscode/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"source.fixAll.eslint"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">2. 使用 <code>.env</code> 管理环境变量</h3>
<p>安装 dotenv：</p>
<pre><code class="hljs language-bash" lang="bash">npm install dotenv
</code></pre>
<p>在项目根目录添加 <code>.env</code> 文件：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
</code></pre>
<p>修改代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>();
<span class="hljs-keyword">const</span> port = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
</code></pre>
<hr/>
<h2 data-id="heading-16">六、使用 TypeScript（可选）</h2>
<p>现代 Node 项目推荐使用 TypeScript。</p>
<pre><code class="hljs language-bash" lang="bash">npm install -D typescript ts-node @types/node
npx tsc --init
</code></pre>
<p>修改 <code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2020"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"commonjs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-17">七、总结</h2>








































<table><thead><tr><th>步骤</th><th>内容</th><th>目的</th></tr></thead><tbody><tr><td>1</td><td>安装 Node.js 或 nvm</td><td>管理运行时环境</td></tr><tr><td>2</td><td>配置 npm 源</td><td>加速依赖安装</td></tr><tr><td>3</td><td>初始化项目</td><td>生成 package.json</td></tr><tr><td>4</td><td>编写入口文件</td><td>启动服务器</td></tr><tr><td>5</td><td>配置编辑器与 ESLint</td><td>提升开发体验</td></tr><tr><td>6</td><td>可选启用 TypeScript</td><td>增强类型安全</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">八、结语</h2>
<p>到这里，你已经拥有一个完整、可扩展的 Node.js 开发环境。
后续可以基于此环境继续学习：</p>
<ul>
<li>使用 <strong>Express / Koa / NestJS</strong> 构建后端服务</li>
<li>使用 <strong>TypeScript + Jest</strong> 构建测试体系</li>
<li>使用 <strong>Docker</strong> 容器化部署</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Activity启动流程详细分析]]></title>    <link>https://juejin.cn/post/7571281406509973555</link>    <guid>https://juejin.cn/post/7571281406509973555</guid>    <pubDate>2025-11-11T10:11:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509973555" data-draft-id="7571088527678996506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Activity启动流程详细分析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:11:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="姝然_9527"/> <meta itemprop="url" content="https://juejin.cn/user/1025189696514199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Activity启动流程详细分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1025189696514199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    姝然_9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:11:34.000Z" title="Tue Nov 11 2025 10:11:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android Activity启动流程详细分析</h2>
<h3 data-id="heading-1">概述</h3>
<p>Activity启动是Android系统中最核心的功能之一。本文将从Activity的startActivity方法开始，一步一步详细分析Activity是如何启动另一个Activity的完整流程。整个流程涉及应用进程和系统进程之间的协作，通过Binder IPC进行通信。</p>
<h3 data-id="heading-2">启动流程总览</h3>
<p>Activity启动流程可以分为三个主要阶段：</p>
<ol start="0">
<li>应用进程准备阶段</li>
<li>系统进程决策与调度阶段</li>
<li>应用进程执行阶段</li>
</ol>
<h3 data-id="heading-3">详细启动流程分析</h3>
<h4 data-id="heading-4">1. 应用进程准备阶段</h4>
<h5 data-id="heading-5">1.1 Activity.startActivity() 方法调用</h5>
<p>当我们在Activity中调用startActivity(Intent intent)方法时，实际调用的是Activity类中的以下代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Override</span>
public void <span class="hljs-built_in">startActivity</span>(Intent intent, <span class="hljs-variable">@Nullable</span> Bundle options) {
    <span class="hljs-selector-tag">getAutofillClientController</span>()<span class="hljs-selector-class">.onStartActivity</span>(intent, mIntent);
    <span class="hljs-selector-tag">if</span> (options != null) {
        <span class="hljs-selector-tag">startActivityForResult</span>(intent, -<span class="hljs-number">1</span>, options);
    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-comment">// Note we want to go through this call for compatibility with</span>
        <span class="hljs-comment">// applications that may have overridden the method.</span>
        <span class="hljs-selector-tag">startActivityForResult</span>(intent, -<span class="hljs-number">1</span>);
    }
}
</code></pre>
<h5 data-id="heading-6">1.2 Activity.startActivityForResult() 方法</h5>
<p>startActivityForResult方法进一步处理启动请求：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">startActivityForResult</span>(<span class="hljs-variable">@RequiresPermission</span> Intent intent, int requestCode,
                                   <span class="hljs-variable">@Nullable</span> Bundle options) {
    <span class="hljs-selector-tag">Instrumentation</span><span class="hljs-selector-class">.ActivityResult</span> <span class="hljs-selector-tag">ar</span> =
            <span class="hljs-selector-tag">mInstrumentation</span><span class="hljs-selector-class">.execStartActivity</span>(
                    this, mMainThread.<span class="hljs-built_in">getApplicationThread</span>(), mToken, this,
                    intent, requestCode, options);
}
</code></pre>
<p>这里将启动任务委托给了Instrumentation类。</p>
<h5 data-id="heading-7">1.3 Instrumentation.execStartActivity() 方法</h5>
<p>Instrumentation是应用进程与系统进程之间的桥梁，它的execStartActivity()方法负责执行实际的启动操作：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@UnsupportedAppUsage</span>
<span class="hljs-keyword">public</span> ActivityResult <span class="hljs-title function_">execStartActivity</span><span class="hljs-params">(
        Context who, IBinder contextThread, IBinder token, Activity target,
        Intent intent, <span class="hljs-type">int</span> requestCode, Bundle options)</span> {
    <span class="hljs-type">IApplicationThread</span> <span class="hljs-variable">whoThread</span> <span class="hljs-operator">=</span> (IApplicationThread) contextThread;
​
    <span class="hljs-keyword">try</span> {
        intent.migrateExtraStreamToClipData(who);
        intent.prepareToLeaveProcess(who);
        <span class="hljs-comment">//获取到 IActivityTaskManager，实际就是 ActivityTaskManagerService</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ActivityTaskManager.getService().startActivity(whoThread,
                who.getOpPackageName(), who.getAttributionTag(), intent,
                intent.resolveTypeIfNeeded(who.getContentResolver()), token,
                target != <span class="hljs-literal">null</span> ? target.mEmbeddedID : <span class="hljs-literal">null</span>, requestCode, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, options);
        checkStartActivityResult(result, intent);
    } <span class="hljs-keyword">catch</span> (RemoteException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failure from system"</span>, e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>在这个方法中，通过ActivityTaskManager.getService()获取到系统服务的Binder代理对象，然后调用其startActivity()方法，这是一个跨进程调用。</p>
<h4 data-id="heading-8">2. 系统进程决策与调度阶段</h4>
<h5 data-id="heading-9">2.1 ActivityTaskManagerService接收请求</h5>
<p>系统进程中的ActivityTaskManagerService（ATMS）接收到来自应用进程的启动请求：</p>
<pre><code class="hljs language-arduino" lang="arduino">@<span class="hljs-function">Override
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(IApplicationThread caller, <span class="hljs-type">String</span> callingPackage,
                               Intent intent, <span class="hljs-type">String</span> resolvedType, IBinder resultTo, <span class="hljs-type">String</span> resultWho, <span class="hljs-type">int</span> requestCode,
                               <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">startActivityAsUser</span>(caller, callingPackage, intent, resolvedType, resultTo,
            resultWho, requestCode, startFlags, profilerInfo, bOptions,
            UserHandle.<span class="hljs-built_in">getCallingUserId</span>());
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss">int <span class="hljs-built_in">startActivityAsUser</span>(IApplicationThread caller, String callingPackage,
                        Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode,
                        int startFlags, ProfilerInfo profilerInfo, Bundle bOptions, int userId,
                        boolean validateIncomingUser) {
    <span class="hljs-built_in">enforceNotIsolatedCaller</span>("startActivityAsUser");
​
    userId = <span class="hljs-built_in">getActivityStartController</span>()<span class="hljs-selector-class">.checkTargetUser</span>(userId, validateIncomingUser,
            Binder.getCallingPid(), Binder<span class="hljs-selector-class">.getCallingUid</span>(), "startActivityAsUser");
​
    <span class="hljs-comment">// getActivityStartController返回的是 ActivityStarter</span>
    return <span class="hljs-built_in">getActivityStartController</span>()<span class="hljs-selector-class">.obtainStarter</span>(intent, "startActivityAsUser")
            <span class="hljs-selector-class">.setCaller</span>(caller)
            <span class="hljs-selector-class">.setCallingPackage</span>(callingPackage)
            <span class="hljs-selector-class">.setResolvedType</span>(resolvedType)
            <span class="hljs-selector-class">.setResultTo</span>(resultTo)
            <span class="hljs-selector-class">.setResultWho</span>(resultWho)
            <span class="hljs-selector-class">.setRequestCode</span>(requestCode)
            <span class="hljs-selector-class">.setStartFlags</span>(startFlags)
            <span class="hljs-selector-class">.setProfilerInfo</span>(profilerInfo)
            <span class="hljs-selector-class">.setActivityOptions</span>(bOptions)
            <span class="hljs-selector-class">.setMayWait</span>(userId)
            <span class="hljs-selector-class">.execute</span>();
}
</code></pre>
<h5 data-id="heading-10">2.2 ActivityStarter.execute() 方法</h5>
<p>ActivityStarter是启动Activity的"大脑"，负责所有的校验和决策逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">int <span class="hljs-built_in">execute</span>() {
    try {
        <span class="hljs-comment">// TODO(b/64750076): Look into passing request directly to these methods to allow</span>
        <span class="hljs-comment">// for transactional diffs and preprocessing.</span>
        if (mRequest.mayWait) {
            return <span class="hljs-built_in">startActivityMayWait</span>(mRequest.caller, mRequest.callingUid,
                    mRequest.callingPackage, mRequest.realCallingPid, mRequest.realCallingUid,
                    mRequest.intent, mRequest.resolvedType,
                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,
                    mRequest.resultWho, mRequest.requestCode, mRequest.startFlags,
                    mRequest.profilerInfo, mRequest.waitResult, mRequest.globalConfig,
                    mRequest.activityOptions, mRequest.ignoreTargetSecurity, mRequest.userId,
                    mRequest.inTask, mRequest.reason,
                    mRequest.allowPendingRemoteAnimationRegistryLookup,
                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);
        } else {
            return <span class="hljs-built_in">startActivity</span>(mRequest.caller, mRequest.intent, mRequest.ephemeralIntent,
                    mRequest.resolvedType, mRequest.activityInfo, mRequest.resolveInfo,
                    mRequest.voiceSession, mRequest.voiceInteractor, mRequest.resultTo,
                    mRequest.resultWho, mRequest.requestCode, mRequest.callingPid,
                    mRequest.callingUid, mRequest.callingPackage, mRequest.realCallingPid,
                    mRequest.realCallingUid, mRequest.startFlags, mRequest.activityOptions,
                    mRequest.ignoreTargetSecurity, mRequest.componentSpecified,
                    mRequest.outActivity, mRequest.inTask, mRequest.reason,
                    mRequest.allowPendingRemoteAnimationRegistryLookup,
                    mRequest.originatingPendingIntent, mRequest.allowBackgroundActivityStart);
        }
    } finally {
        <span class="hljs-built_in">onExecutionComplete</span>();
    }
}
</code></pre>
<h5 data-id="heading-11">2.3 startActivityMayWait() 方法</h5>
<p>当需要等待Activity启动结果时（通常情况），会调用startActivityMayWait()方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityMayWait</span><span class="hljs-params">(IApplicationThread caller, <span class="hljs-type">int</span> callingUid,
        String callingPackage, <span class="hljs-type">int</span> requestRealCallingPid, <span class="hljs-type">int</span> requestRealCallingUid,
        Intent intent, String resolvedType, IVoiceInteractionSession voiceSession,
        IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="hljs-type">int</span> requestCode,
        <span class="hljs-type">int</span> startFlags, ProfilerInfo profilerInfo, WaitResult outResult,
        Configuration globalConfig, SafeActivityOptions options, <span class="hljs-type">boolean</span> ignoreTargetSecurity,
        <span class="hljs-type">int</span> userId, TaskRecord inTask, String reason,
        <span class="hljs-type">boolean</span> allowPendingRemoteAnimationRegistryLookup,
        PendingIntentRecord originatingPendingIntent, <span class="hljs-type">boolean</span> allowBackgroundActivityStart)</span> {
    
    <span class="hljs-comment">// 1. 检查Intent中的文件描述符，防止泄露</span>
    <span class="hljs-keyword">if</span> (intent != <span class="hljs-literal">null</span> &amp;&amp; intent.hasFileDescriptors()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"File descriptors passed in Intent"</span>);
    }
    
    <span class="hljs-comment">// 2. 解析Intent获取目标Activity信息</span>
    <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">rInfo</span> <span class="hljs-operator">=</span> mSupervisor.resolveIntent(intent, resolvedType, userId,
            <span class="hljs-number">0</span> <span class="hljs-comment">/* matchFlags */</span>, computeResolveFilterUid(
                    callingUid, requestRealCallingUid, mRequest.filterCallingUid));
    
    <span class="hljs-comment">// 3. 获取ActivityInfo</span>
    <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">aInfo</span> <span class="hljs-operator">=</span> rInfo != <span class="hljs-literal">null</span> ? rInfo.activityInfo : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (aInfo != <span class="hljs-literal">null</span>) {
        aInfo = mService.mAmInternal.getActivityInfoForUser(aInfo, userId);
    }
    
    <span class="hljs-comment">// 4. 处理特殊情况（如重量级应用、托管应用等）</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 5. 调用startActivity()方法继续执行</span>
    <span class="hljs-keyword">return</span> startActivity(caller, intent, ephemeralIntent, resolvedType, aInfo, rInfo,
            voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid,
            callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options,
            ignoreTargetSecurity, componentSpecified, outActivity, inTask, reason,
            allowPendingRemoteAnimationRegistryLookup, originatingPendingIntent,
            allowBackgroundActivityStart);
}
</code></pre>
<h5 data-id="heading-12">2.4 startActivity() 方法</h5>
<p>startActivity()方法是核心的启动方法：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,
        <span class="hljs-type">String</span> resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,
        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
        IBinder resultTo, <span class="hljs-type">String</span> resultWho, <span class="hljs-type">int</span> requestCode, <span class="hljs-type">int</span> callingPid, <span class="hljs-type">int</span> callingUid,
        <span class="hljs-type">String</span> callingPackage, <span class="hljs-type">int</span> realCallingPid, <span class="hljs-type">int</span> realCallingUid, <span class="hljs-type">int</span> startFlags,
        SafeActivityOptions options,
        <span class="hljs-type">boolean</span> ignoreTargetSecurity, <span class="hljs-type">boolean</span> componentSpecified, ActivityRecord[] outActivity,
        TaskRecord inTask, <span class="hljs-type">boolean</span> allowPendingRemoteAnimationRegistryLookup,
        PendingIntentRecord originatingPendingIntent, <span class="hljs-type">boolean</span> allowBackgroundActivityStart)</span> </span>{
    
    <span class="hljs-comment">// 1. 权限检查</span>
    <span class="hljs-comment">// 2. Intent解析</span>
    <span class="hljs-comment">// 3. 创建ActivityRecord对象</span>
    <span class="hljs-comment">// 4. 调用startActivityUnchecked()方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">startActivityUnchecked</span>(r, sourceRecord, voiceSession, voiceInteractor,
            startFlags, doResume, options, inTask, outActivity, restrictedBgActivity);
}
</code></pre>
<h5 data-id="heading-13">2.5 startActivityUnchecked() 方法</h5>
<p>这是Activity启动流程中最核心的方法，负责具体的启动逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">private int <span class="hljs-built_in">startActivityUnchecked</span>(final ActivityRecord r, ActivityRecord sourceRecord,
        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,
        int startFlags, boolean doResume, ActivityOptions options, TaskRecord inTask,
        ActivityRecord[] outActivity, boolean restrictedBgActivity) {
    
    <span class="hljs-comment">// 1. 初始化状态</span>
    <span class="hljs-built_in">setInitialState</span>(r, options, inTask, doResume, startFlags, sourceRecord,
            voiceSession, voiceInteractor, restrictedBgActivity);
    
    <span class="hljs-comment">// 2. 计算启动标志</span>
    <span class="hljs-built_in">computeLaunchingTaskFlags</span>();
    
    <span class="hljs-comment">// 3. 计算源任务栈</span>
    <span class="hljs-built_in">computeSourceStack</span>();
    
    <span class="hljs-comment">// 4. 查找可复用的Activity</span>
    ActivityRecord reusedActivity = <span class="hljs-built_in">getReusableIntentActivity</span>();
    
    <span class="hljs-comment">// 5. 处理复用情况</span>
    if (reusedActivity != null) {
        <span class="hljs-comment">// 如果找到可复用的Activity</span>
        reusedActivity = <span class="hljs-built_in">setTargetStackAndMoveToFrontIfNeeded</span>(reusedActivity);
        <span class="hljs-built_in">setTaskFromIntentActivity</span>(reusedActivity);
        <span class="hljs-comment">// ...</span>
    } else {
        <span class="hljs-comment">// 6. 处理不复用情况</span>
        <span class="hljs-comment">// 根据不同情况调用不同的任务创建方法</span>
        if (mStartActivity.resultTo == null &amp;&amp; mInTask == null &amp;&amp; !mAddingToTask
                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 创建新任务</span>
            result = <span class="hljs-built_in">setTaskFromReuseOrCreateNewTask</span>(taskToAffiliate);
        } else if (mSourceRecord != null) {
            <span class="hljs-comment">// 在源任务中启动</span>
            result = <span class="hljs-built_in">setTaskFromSourceRecord</span>();
        } else if (mInTask != null) {
            <span class="hljs-comment">// 在指定任务中启动</span>
            result = <span class="hljs-built_in">setTaskFromInTask</span>();
        } else {
            <span class="hljs-comment">// 在当前顶部任务中启动</span>
            result = <span class="hljs-built_in">setTaskToCurrentTopOrCreateNewTask</span>();
        }
    }
    
    <span class="hljs-comment">// 7. 权限处理</span>
    mService<span class="hljs-selector-class">.mUgmInternal</span><span class="hljs-selector-class">.grantUriPermissionFromIntent</span>(mCallingUid, mStartActivity.packageName,
            mIntent, mStartActivity.getUriPermissionsLocked(), mStartActivity<span class="hljs-selector-class">.mUserId</span>);
    
    <span class="hljs-comment">// 8. 启动Activity</span>
    mTargetStack<span class="hljs-selector-class">.startActivityLocked</span>(mStartActivity, topFocused, newTask, mKeepCurTransition,
            mOptions);
    
    <span class="hljs-comment">// 9. 恢复Activity</span>
    if (mDoResume) {
        mRootActivityContainer<span class="hljs-selector-class">.resumeFocusedStacksTopActivities</span>(
                mTargetStack, mStartActivity, mOptions);
    }
    
    return START_SUCCESS;
}
</code></pre>
<h5 data-id="heading-14">2.6 任务栈管理</h5>
<p>在startActivityUnchecked()方法中，系统会根据launch mode和Intent flags来决定如何管理任务栈：</p>
<ol start="0">
<li><strong>setTaskFromReuseOrCreateNewTask()</strong> : 创建新任务或复用现有任务</li>
<li><strong>setTaskFromSourceRecord()</strong> : 在源Activity的任务中启动</li>
<li><strong>setTaskFromInTask()</strong> : 在指定任务中启动</li>
<li><strong>setTaskToCurrentTopOrCreateNewTask()</strong> : 在当前顶部任务中启动</li>
</ol>
<h4 data-id="heading-15">3. 应用进程执行阶段</h4>
<h5 data-id="heading-16">3.1 跨进程回调应用进程</h5>
<p>系统进程通过Binder IPC回调到目标Activity所在的应用进程。这个回调的接收者是ApplicationThread。</p>
<h5 data-id="heading-17">3.2 ApplicationThread接收回调</h5>
<p>ApplicationThread是ActivityThread的内部类，它是一个Binder对象，运行在应用进程中。它接收到scheduleTransaction()调用，其中包含了启动Activity的指令。</p>
<h5 data-id="heading-18">3.3 H(Handler)处理消息</h5>
<p>ApplicationThread将接收到的Binder调用转换成Message，通过一个Handler（名为H）发送到应用进程的主线程消息队列中。</p>
<h5 data-id="heading-19">3.4 ActivityThread处理指令</h5>
<p>主线程的H处理消息，调用ActivityThread的handleLaunchActivity()方法：</p>
<pre><code class="hljs language-scss" lang="scss">public Activity <span class="hljs-built_in">handleLaunchActivity</span>(ActivityClientRecord r,
        PendingTransactionActions pendingActions, Intent customIntent) {
    <span class="hljs-comment">// 1. 创建Activity实例</span>
    Activity <span class="hljs-selector-tag">a</span> = <span class="hljs-built_in">performLaunchActivity</span>(r, customIntent);
    
    <span class="hljs-comment">// 2. 调用Activity的onResume方法</span>
    if (a != null) {
        r<span class="hljs-selector-class">.createdConfig</span> = new <span class="hljs-built_in">Configuration</span>(mConfiguration);
        <span class="hljs-built_in">reportSizeConfigurations</span>(r);
        if (!r.activity.mFinished &amp;&amp; pendingActions != null) {
            pendingActions<span class="hljs-selector-class">.setOldState</span>(r.state);
            pendingActions<span class="hljs-selector-class">.setRestoreInstanceState</span>(true);
        }
        <span class="hljs-built_in">handleResumeActivity</span>(r.token, false, r.isForward,
                !r.activity.mFinished &amp;&amp; pendingActions != null);
    }
    
    return <span class="hljs-selector-tag">a</span>;
}
</code></pre>
<h5 data-id="heading-20">3.5 performLaunchActivity() 创建Activity</h5>
<pre><code class="hljs language-ini" lang="ini">private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {
    ActivityInfo <span class="hljs-attr">aInfo</span> = r.activityInfo<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">r.packageInfo</span> == null) {
        return null<span class="hljs-comment">;</span>
    }

    ComponentName <span class="hljs-attr">component</span> = r.intent.getComponent()<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">component</span> == null) {
        <span class="hljs-attr">component</span> = r.intent.resolveActivity(
            mInitialApplication.getPackageManager())<span class="hljs-comment">;</span>
        r.intent.setComponent(component)<span class="hljs-comment">;</span>
    }

    if (r.activityInfo.targetActivity != null) {
        <span class="hljs-attr">component</span> = new ComponentName(r.activityInfo.packageName,
                r.activityInfo.targetActivity)<span class="hljs-comment">;</span>
    }

    ContextImpl <span class="hljs-attr">appContext</span> = createBaseContextForActivity(r)<span class="hljs-comment">;</span>
    Activity <span class="hljs-attr">activity</span> = null<span class="hljs-comment">;</span>
    try {
        // 1. 通过类加载器创建Activity实例
        java.lang.ClassLoader <span class="hljs-attr">cl</span> = appContext.getClassLoader()<span class="hljs-comment">;</span>
        <span class="hljs-attr">activity</span> = mInstrumentation.newActivity(
                cl, component.getClassName(), r.intent)<span class="hljs-comment">;</span>
        StrictMode.incrementExpectedActivityCount(activity.getClass())<span class="hljs-comment">;</span>
        r.intent.setExtrasClassLoader(cl)<span class="hljs-comment">;</span>
        r.intent.prepareToEnterProcess()<span class="hljs-comment">;</span>
        if (r.state != null) {
            r.state.setClassLoader(cl)<span class="hljs-comment">;</span>
        }
    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                "Unable to instantiate activity " + component
                + ": " + e.toString(), e)<span class="hljs-comment">;</span>
        }
    }

    try {
        // 2. 创建Application实例（如果尚未创建）
        Application <span class="hljs-attr">app</span> = r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation)<span class="hljs-comment">;</span>

        if (activity != null) {
            // 3. 创建ContextImpl
            ContextImpl <span class="hljs-attr">appContext</span> = createBaseContextForActivity(r)<span class="hljs-comment">;</span>
            
            // 4. 调用Activity.attach()绑定上下文
            activity.attach(appContext, this, getInstrumentation(), r.token,
                    r.ident, app, r.intent, r.activityInfo, title, r.parent,
                    r.embeddedID, r.lastNonConfigurationInstances, config,
                    r.referrer, r.voiceInteractor, window, r.configCallback)<span class="hljs-comment">;</span>

            if (customIntent != null) {
                <span class="hljs-attr">activity.mIntent</span> = customIntent<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">r.lastNonConfigurationInstances</span> = null<span class="hljs-comment">;</span>
            checkAndBlockForNetworkAccess()<span class="hljs-comment">;</span>
            <span class="hljs-attr">activity.mStartedActivity</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            int <span class="hljs-attr">theme</span> = r.activityInfo.getThemeResource()<span class="hljs-comment">;</span>
            if (theme != 0) {
                activity.setTheme(theme)<span class="hljs-comment">;</span>
            }

            // 5. 调用Activity的onCreate方法
            <span class="hljs-attr">activity.mCalled</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
            if (r.isPersistable()) {
                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState)<span class="hljs-comment">;</span>
            } else {
                mInstrumentation.callActivityOnCreate(activity, r.state)<span class="hljs-comment">;</span>
            }
            
            // ...
        }
        <span class="hljs-attr">r.paused</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>

        mActivities.put(r.token, r)<span class="hljs-comment">;</span>

    } catch (SuperNotCalledException e) {
        throw e<span class="hljs-comment">;</span>

    } catch (Exception e) {
        if (!mInstrumentation.onException(activity, e)) {
            throw new RuntimeException(
                "Unable to start activity " + component
                + ": " + e.toString(), e)<span class="hljs-comment">;</span>
        }
    }

    return activity<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-21">4. 后续生命周期调用</h4>
<p>在handleLaunchActivity()之后，系统进程会继续通过同样的IPC -&gt; Handler机制，依次调度start、resume等方法。</p>
<h3 data-id="heading-22">关键概念详解</h3>
<h4 data-id="heading-23">Launch Mode</h4>
<p>Android支持四种启动模式：</p>
<ol start="0">
<li><strong>standard</strong>：默认模式，每次启动都会创建新实例</li>
<li><strong>singleTop</strong>：如果Activity已在栈顶，则复用并调用onNewIntent()</li>
<li><strong>singleTask</strong>：在整个系统中只有一个实例，会清除其上的所有Activity</li>
<li><strong>singleInstance</strong>：独占一个任务栈，只有一个实例</li>
</ol>
<h4 data-id="heading-24">Intent Flags</h4>
<p>常用的Intent Flags：</p>
<ul>
<li><strong>FLAG_ACTIVITY_NEW_TASK</strong>：在新任务中启动Activity</li>
<li><strong>FLAG_ACTIVITY_CLEAR_TOP</strong>：清除目标Activity之上的所有Activity</li>
<li><strong>FLAG_ACTIVITY_SINGLE_TOP</strong>：如果Activity已在栈顶则复用</li>
<li><strong>FLAG_ACTIVITY_NO_HISTORY</strong>：Activity不会保留在历史栈中</li>
</ul>
<h3 data-id="heading-25">启动流程时序图</h3>
<pre><code class="hljs language-scss" lang="scss">客户端ActivityInstrumentationActivityTaskManagerServiceActivityStarterActivityStack目标应用进程<span class="hljs-built_in">ActivityThreadActivitystartActivity</span>()<span class="hljs-built_in">startActivity</span>() <span class="hljs-selector-attr">[IPC]</span><span class="hljs-built_in">obtainStarter</span>()<span class="hljs-selector-class">.execute</span>()<span class="hljs-built_in">startActivityMayWait</span>()<span class="hljs-built_in">startActivity</span>()<span class="hljs-built_in">startActivityUnchecked</span>()<span class="hljs-built_in">setInitialState</span>()<span class="hljs-built_in">computeLaunchingTaskFlags</span>()<span class="hljs-built_in">computeSourceStack</span>()<span class="hljs-built_in">getReusableIntentActivity</span>()<span class="hljs-built_in">setTargetStackAndMoveToFrontIfNeeded</span>()<span class="hljs-built_in">setTaskFromIntentActivity</span>()<span class="hljs-built_in">setTaskFromReuseOrCreateNewTask</span>()/<span class="hljs-built_in">setTaskFromSourceRecord</span>()alt<span class="hljs-selector-attr">[ 找到可复用Activity ]</span><span class="hljs-selector-attr">[ 未找到可复用Activity ]</span><span class="hljs-built_in">startActivityLocked</span>()<span class="hljs-built_in">scheduleLaunchActivity</span>() <span class="hljs-selector-attr">[IPC]</span>H<span class="hljs-selector-class">.handleMessage</span>()<span class="hljs-built_in">handleLaunchActivity</span>()<span class="hljs-built_in">performLaunchActivity</span>()<span class="hljs-built_in">onCreate</span>()<span class="hljs-built_in">scheduleResumeActivity</span>() <span class="hljs-selector-attr">[IPC]</span>H<span class="hljs-selector-class">.handleMessage</span>()<span class="hljs-built_in">onResume</span>()alt<span class="hljs-selector-attr">[ 需要恢复 ]</span>客户端ActivityInstrumentationActivityTaskManagerServiceActivityStarterActivityStack目标应用进程ActivityThreadActivity
</code></pre>
<h3 data-id="heading-26">总结</h3>
<p>Activity启动流程是一个复杂而精密的过程，涉及多个组件的协作：</p>
<ol start="0">
<li><strong>应用进程</strong>负责发起启动请求，并在系统调度后执行具体的生命周期方法</li>
<li><strong>系统进程</strong>（ATMS/ActivityStarter）负责权限检查、Intent解析、任务栈管理等核心决策</li>
<li><strong>Binder IPC</strong>是应用进程和系统进程之间通信的桥梁</li>
<li><strong>Instrumentation</strong>作为监控钩子，贯穿整个启动流程</li>
<li><strong>ActivityStack</strong>负责管理Activity的回退栈</li>
</ol>
<p>理解这个流程对于Android开发和系统优化都有重要意义，特别是在处理启动性能、任务管理、生命周期等问题时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Compose SideEffect（副作用）实例加倍详解]]></title>    <link>https://juejin.cn/post/7571077686107897919</link>    <guid>https://juejin.cn/post/7571077686107897919</guid>    <pubDate>2025-11-11T08:19:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571077686107897919" data-draft-id="7566294664786001955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Compose  SideEffect（副作用）实例加倍详解"/> <meta itemprop="keywords" content="APP,Android"/> <meta itemprop="datePublished" content="2025-11-11T08:19:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="参宿四南河三"/> <meta itemprop="url" content="https://juejin.cn/user/3479267728427543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Compose  SideEffect（副作用）实例加倍详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479267728427543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    参宿四南河三
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:19:36.000Z" title="Tue Nov 11 2025 08:19:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天的文章，整理了上个月的学习心得。这段时间又仔细研究了下SideEffect，秉着闲着找事干，有事干才不想着去洗脚的原则，我又开始了读书笔记式的码字。<code>源码在文章末尾。各副作用函数特性表也在文章末尾</code>。<br/>
<strong>部分例子在实际开发中是可能存在一定瑕疵的，旨在让大家明白如何使用。使用时请注意</strong></p>
<h2 data-id="heading-0">一、副作用到底有哪些？</h2>
<ul>
<li>LaunchedEffect</li>
<li>DisposableEffect</li>
<li>SideEffect</li>
<li>rememberCoroutineScope</li>
<li>produceState<br/>
副作用函数关联概念（<strong>个人觉得不是副函数</strong>）：</li>
<li>derivedStateOf</li>
<li>rememberUpdatedState</li>
</ul>
<p>上篇文章我已经简单介绍了这几个副作用函数，可总觉得太过简略，例子也很简单，完全不贴合实际开发，以后我怎么抄代码嘛。好的，下面我们就从实际出发举例子，让大家更好抄更好理解。</p>
<h2 data-id="heading-1">LaunchedEffect</h2>
<h3 data-id="heading-2">1、概括</h3>
<p>LaunchedEffect(key) = 页面进入时自动启动协程，key变了就取消旧的，重启新的。</p>
<h3 data-id="heading-3">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>自动启动</strong></td><td>Composable 进入组合时，自动 <code>launch</code> 协程</td></tr><tr><td><strong>key 控制</strong></td><td><code>key</code> 不变 → 协程继续；<code>key</code> 变 → <strong>取消旧协程，启动新协程</strong></td></tr><tr><td><strong>自动取消</strong></td><td>离开页面 → 自动 <code>cancel()</code>，<strong>零泄漏</strong></td></tr></tbody></table>
<h3 data-id="heading-4">3、实际开发中的场景</h3>
<ul>
<li>场景一：加载网络数据（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FetchUserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;(<span class="hljs-literal">null</span>) }
    <span class="hljs-keyword">var</span> loading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    <span class="hljs-keyword">var</span> error <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;String?&gt;(<span class="hljs-literal">null</span>) }

    LaunchedEffect(userId) {  <span class="hljs-comment">// key = userId</span>
        loading = <span class="hljs-literal">true</span>
        error = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> result = withContext(Dispatchers.IO) {
                RetrofitClient.apiService.getUsersById(userId) 
            }
            user = result
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            error = e.message
        } <span class="hljs-keyword">finally</span> {
            loading = <span class="hljs-literal">false</span>
        }
    }

    <span class="hljs-keyword">when</span> {
        loading -&gt; CircularProgressIndicator()
        error != <span class="hljs-literal">null</span> -&gt; Text(<span class="hljs-string">"错误: <span class="hljs-variable">$error</span>"</span>, color = Color.Red)
        user != <span class="hljs-literal">null</span> -&gt; Column {
            Text(<span class="hljs-string">"用户名: <span class="hljs-subst">${user!!.name}</span>"</span>, style = MaterialTheme.typography.bodyLarge)
            Text(<span class="hljs-string">"邮箱: <span class="hljs-subst">${user!!.email}</span>"</span>)
        }
    }
}
</code></pre>
<p>代码核心：切换 userId → 自动取消旧请求，发起新请求</p>
<ul>
<li>场景二：一次性任务初始化（日志、埋点、第三方初始化）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {  <span class="hljs-comment">// 只执行一次</span>
        <span class="hljs-comment">//Analytics.uploadPoint(screenName)</span>
        Log.i(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
    }

    Text(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<p>为什么使用Unit？<strong>Unit在Kotlin里面是常量，意味着key永远不变</strong>，所以只在页面首次进入时执行一次。<br/>
小知识：LaunchedEffect(true)和LaunchedEffect(Unit)行为一致，因为 true 也是常量。但 true容易让人误解为“每次都执行”，建议统一用 Unit。</p>
<ul>
<li>场景三：轮询(实时获取数据)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GoldPrice</span><span class="hljs-params">(symbol: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">var</span> price <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;Price?&gt;(<span class="hljs-literal">null</span>) }
    LaunchedEffect(symbol) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            price = withContext(Dispatchers.IO) {
                GoldPriceRetrofitClient.apiService.getGoldPrice(symbol)
            }
            delay(<span class="hljs-number">30_000</span>)
        }
    }
    Card(
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
        elevation = CardDefaults.cardElevation(defaultElevation = <span class="hljs-number">4.</span>dp)
    ) {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(symbol, style = MaterialTheme.typography.bodyMedium)
            Text(<span class="hljs-string">"¥<span class="hljs-subst">${price?.price?:<span class="hljs-string">"未知"</span>}</span>"</span>, style = MaterialTheme.typography.bodyLarge)
        }
    }
}
</code></pre>
<p>代码核心：每30秒获取一次金价。调整商品编码时，自动停止旧商品轮询，开始新轮询。</p>
<ul>
<li>场景四：执行一个协程</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoadData</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;( <span class="hljs-literal">null</span>) }
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        user = viewModel.getUserInfo(<span class="hljs-number">1</span>)
    }
}
</code></pre>
<p>代码核心：执行获取用户查询的supend的方法</p>
<h3 data-id="heading-5">4、快速记忆</h3>
<p>进入页 → 自动启动 → key变化自动重启 → 离开自动取消</p>
<h3 data-id="heading-6">5、常犯错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td><code>LaunchedEffect(true)</code></td><td>易产生语义歧义</td><td>用 <code>Unit</code></td></tr><tr><td>不用 <code>withContext(IO)</code></td><td>阻塞 UI</td><td>必须切线程</td></tr><tr><td>忘记 <code>key</code></td><td>数据不更新</td><td>必须加依赖参数</td></tr></tbody></table>
<h3 data-id="heading-7">6、总结</h3>
<p>LaunchedEffect 是Compose中<strong>页面级异步任务</strong>的首选，key+自动取消是其核心。</p>
<h2 data-id="heading-8">DisposableEffect</h2>
<h3 data-id="heading-9">1、概括</h3>
<p>DisposableEffect(key) = 「进入时注册，离开时自动清理」的资源管理神器</p>
<h3 data-id="heading-10">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>进入时执行</strong></td><td>Composable 进入组合时，执行 <code>effect</code> 块</td></tr><tr><td><strong>key 控制</strong></td><td><code>key</code> 变化 → <strong>先 <code>onDispose</code>，再重新注册</strong></td></tr><tr><td><strong>离开时自动清理</strong></td><td>离开页面 → <strong>自动调用 <code>onDispose</code></strong>，防止内存泄漏</td></tr></tbody></table>
<h3 data-id="heading-11">3、实际开发中场景</h3>
<ul>
<li>场景一：注册/注销广播接收器（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">NetworkChangeListener</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
    <span class="hljs-keyword">val</span> connectivityManager = remember { 
        context.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="hljs-keyword">as</span> ConnectivityManager 
    }
    <span class="hljs-keyword">var</span> isConnected <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : ConnectivityManager.NetworkCallback() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAvailable</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                isConnected = <span class="hljs-literal">true</span>
            }
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLost</span><span class="hljs-params">(network: <span class="hljs-type">Network</span>)</span></span> {
                isConnected = <span class="hljs-literal">false</span>
            }
        }

        connectivityManager.registerDefaultNetworkCallback(callback)

        onDispose {
            connectivityManager.unregisterNetworkCallback(callback) <span class="hljs-comment">// 必须清理！</span>
        }
    }

    Card(
        colors = CardDefaults.cardColors(
            containerColor = <span class="hljs-keyword">if</span> (isConnected) Color.Green <span class="hljs-keyword">else</span> Color.Red
        )
    ) {
        Text(
            text = <span class="hljs-keyword">if</span> (isConnected) <span class="hljs-string">"在线"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"离线"</span>,
            color = Color.White,
            modifier = Modifier.padding(<span class="hljs-number">8.</span>dp)
        )
    }
}
</code></pre>
<p>代码核心：监听设备网络状态，断开网络显示离线，否则显示在线。</p>
<ul>
<li>场景二：添加移除传感器</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StepCounter</span><span class="hljs-params">(sensorManager: <span class="hljs-type">SensorManager</span>)</span></span> {
    <span class="hljs-keyword">var</span> steps <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> sensor = sensorManager.getDefaultSensor(Sensor.TYPE_STEP_COUNTER)
        <span class="hljs-keyword">val</span> listener = <span class="hljs-keyword">object</span> : SensorEventListener {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSensorChanged</span><span class="hljs-params">(event: <span class="hljs-type">SensorEvent</span>)</span></span> {
                steps = event.values[<span class="hljs-number">0</span>].toInt()
            }
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAccuracyChanged</span><span class="hljs-params">(sensor: <span class="hljs-type">Sensor</span>, accuracy: <span class="hljs-type">Int</span>)</span></span> {}
        }

        sensorManager.registerListener(listener, sensor, SensorManager.SENSOR_DELAY_UI)

        onDispose {
            sensorManager.unregisterListener(listener)
        }
    }

    Text(<span class="hljs-string">"今日步数: <span class="hljs-variable">$steps</span> 步"</span>, style = MaterialTheme.typography.headlineMedium)
}
</code></pre>
<p>代码核心：实时监测运动传感器，统计步数。</p>
<ul>
<li>场景三：订阅取消Flow(ViewModel 搭配使用)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FlowSubscription</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> message <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"等待消息..."</span>) }

    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> job = viewModel.messageFlow
            .onEach { message = it }
            .launchIn(viewModel.viewModelScope)

        onDispose {
            job.cancel() <span class="hljs-comment">// 取消订阅</span>
        }
    }
    Column(modifier = Modifier.fillMaxSize()) {
        Button(onClick = {
            viewModel.sendMessage()
        }, modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(<span class="hljs-string">"点击发消息"</span>)
        }

        Text(message)
    }
}
</code></pre>
<p>代码核心：离开时，自动取消Flow</p>
<ul>
<li>场景四：key变化时，重置资源（如切换用户）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserSessionTracker</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    DisposableEffect(userId) {
        LoginManager.login(userId)
        println(<span class="hljs-string">"用户 <span class="hljs-variable">$userId</span> 已登录"</span>)

        onDispose {
            LoginManager.logout()
            println(<span class="hljs-string">"用户已登出"</span>)
        }
    }

    Text(<span class="hljs-string">"当前用户: <span class="hljs-variable">$userId</span>"</span>)
}
</code></pre>
<p>代码核心：切换 userId → 自动登出旧用户，登录新用户</p>
<h3 data-id="heading-12">4、快速记忆</h3>
<p>进入注册 → key变化重置 → 离开自动清理 → 安全无泄漏</p>
<h3 data-id="heading-13">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>忘记 <code>onDispose</code></td><td>内存泄漏</td><td>必须清理</td></tr><tr><td>用 <code>LaunchedEffect</code> 注册监听</td><td>无法手动清理</td><td>用 <code>DisposableEffect</code></td></tr><tr><td><code>key</code> 写错</td><td>重复注册</td><td>用稳定 key</td></tr></tbody></table>
<h3 data-id="heading-14">6、总结</h3>
<p>DisposableEffect 是 Compose 中「资源生命周期管理」的唯一正确方式， 掌握 onDispose + key，解决内存泄漏的问题</p>
<h2 data-id="heading-15">SideEffect</h2>
<h3 data-id="heading-16">1、一句话概括</h3>
<p>SideEffect = 「每次重组都执行一次」的轻量副作用，不自动取消，适合日志、埋点、同步非 Compose 状态</p>
<h3 data-id="heading-17">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>每次重组都执行</strong></td><td>只要 UI 重组，<code>SideEffect</code> 就运行一次</td></tr><tr><td><strong>无 key 控制</strong></td><td>不支持 <code>key</code>，<strong>不能重启或取消</strong></td></tr><tr><td><strong>不自动清理</strong></td><td>离开页面不会自动取消，<strong>需手动控制</strong></td></tr></tbody></table>
<h3 data-id="heading-18">3、实际开发中的四大场景</h3>
<ul>
<li>场景一：页面曝光埋点（常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    SideEffect {
        Analytics.logScreenView(screenName)  <span class="hljs-comment">// 每次重组都上报</span>
        Log.i(<span class="hljs-string">"compose 曝光"</span>,<span class="hljs-string">"曝光: <span class="hljs-variable">$screenName</span>"</span>)
    }

    Text(<span class="hljs-string">"当前页面: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<ul>
<li>场景二：日志输出及调试</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DebugRecomposition</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    SideEffect {
        Log.d(<span class="hljs-string">"compose日志"</span>,<span class="hljs-string">"重组发生了！count = <span class="hljs-variable">$count</span>"</span>)
    }

    Column {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
        Button(onClick = { count++ }) { Text(<span class="hljs-string">"加1"</span>) }
    }
}
</code></pre>
<ul>
<li>场景三：同步或发送数据到外部（如SharedPreferences、EventBus、ViewModel）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SyncTheme</span><span class="hljs-params">(isDark: <span class="hljs-type">Boolean</span>)</span></span> {
    <span class="hljs-keyword">val</span> prefs = LocalContext.current.getSharedPreferences(<span class="hljs-string">"settings"</span>, Context.MODE_PRIVATE)
    SideEffect {
        prefs.edit().putBoolean(<span class="hljs-string">"dark_mode"</span>, isDark).apply()
        Log.d(<span class="hljs-string">"compose 日志"</span>, <span class="hljs-string">"主题已保存: <span class="hljs-subst">${if (isDark) <span class="hljs-string">"深色"</span> else <span class="hljs-string">"浅色"</span>}</span>"</span>)
        EventBus.post(isDark)
    }

    <span class="hljs-comment">// UI...</span>
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BrightnessControl</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-keyword">var</span> brightness <span class="hljs-keyword">by</span> remember { mutableFloatStateOf(<span class="hljs-number">0.5f</span>) }

    <span class="hljs-comment">// 每次 brightness 改变并重组完成后，同步到 ViewModel</span>
    SideEffect {
        viewModel.currentBrightness = brightness
    }

    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(<span class="hljs-string">"当前亮度: <span class="hljs-subst">${(brightness * <span class="hljs-number">100</span>).toInt()}</span>%"</span>)
        Slider(value = brightness, onValueChange = { brightness = it })
    }
}
</code></pre>
<p>核心：每次切换主题 → 自动保存到本地，并通知其他页面</p>
<ul>
<li>场景四：与非 Compose 组件通信（如 TextureView）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CameraPreview</span><span class="hljs-params">(textureView: <span class="hljs-type">TextureView</span>)</span></span> {
    SideEffect {
        CameraManager.bind(textureView.surfaceTexture)
    }

    AndroidView(factory = { textureView })
}
</code></pre>
<h3 data-id="heading-19">4、快速记忆</h3>
<p>重组就跑，轻量选它，日志埋点，首选SideEffect。</p>
<h3 data-id="heading-20">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>放网络请求</td><td>每次重组都请求</td><td>用 <code>LaunchedEffect</code></td></tr><tr><td>放耗时操作(非轻量)</td><td>卡 UI</td><td>用 <code>withContext(IO)</code> + <code>LaunchedEffect</code></td></tr><tr><td>期望只执行一次</td><td>不会</td><td>用 <code>LaunchedEffect(Unit)</code></td></tr></tbody></table>
<p>总结：每次重组都会执行。注意：<code>SideEffect</code> 是在 <strong>重组完成后立即执行</strong>，没有协程。而 <code>LaunchedEffect</code> 是在进入组合时启动协程。</p>
<h2 data-id="heading-21">rememberCoroutineScope</h2>
<h3 data-id="heading-22">1、一句话概括：</h3>
<p>rememberCoroutineScope() = 「<strong>手动、可控、生命周期安全</strong>」的协程作用域，<strong>重组不重启，离开页面自动取消</strong>。</p>
<h3 data-id="heading-23">2、核心机制</h3>





















<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>手动启动</strong></td><td>必须 <code>scope.launch { }</code> 才执行</td></tr><tr><td><strong>重组不影响</strong></td><td>重组时 <strong>同一个 scope</strong>，不会重新创建</td></tr><tr><td><strong>自动取消</strong></td><td>离开页面 → <strong>自动 <code>cancel()</code></strong> ，所有协程停止</td></tr></tbody></table>
<h3 data-id="heading-24">3、常用场景</h3>
<ul>
<li>场景一：异步操作（如文件保存，最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SaveButton</span><span class="hljs-params">(viewModel: <span class="hljs-type">SaveViewModel</span>)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> saving <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }

    Button(
        enabled = !saving,
        onClick = {
            saving = <span class="hljs-literal">true</span>
            scope.launch {
                <span class="hljs-keyword">try</span> {
                    viewModel.saveData()  <span class="hljs-comment">// 模拟文件保存</span>
                } <span class="hljs-keyword">finally</span> {
                    saving = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 发送错误时，重置UI</span>
                }
            }
        }
    ) {
        Text(<span class="hljs-keyword">if</span> (saving) <span class="hljs-string">"保存中..."</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"保存"</span>)
    }
}
</code></pre>
<p>场景二：定时任务</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TimerWithCoroutineScope</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableIntStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = {
        scope.launch {
            repeat(<span class="hljs-number">10</span>) {
                delay(<span class="hljs-number">1000</span>)
                count++
            }
        }
    }) {
        Text(<span class="hljs-string">"开始定时任务"</span>)
    }
    
    Text(<span class="hljs-string">"计数: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<p>场景三：批量处理</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BatchProcess</span><span class="hljs-params">(items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> progress <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }

    Button(onClick = {
        scope.launch {
            items.forEachIndexed { index, item -&gt;
                processItem(item)
                progress = index + <span class="hljs-number">1</span>
            }
        }
    }) {
        Text(<span class="hljs-string">"处理 <span class="hljs-subst">${items.size}</span> 项"</span>)
    }
    LinearProgressIndicator(progress = progress / items.size.toFloat())
}
</code></pre>
<ul>
<li>场景四：与Snackbar搭配（Material3 常见用法）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalMaterial3Api::class)</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SnackbarExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> snackbarHostState = remember { SnackbarHostState() }
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()

    Scaffold(
        snackbarHost = { SnackbarHost(snackbarHostState) },
        floatingActionButton = {
            FloatingActionButton(onClick = {
                scope.launch {
                    snackbarHostState.showSnackbar(<span class="hljs-string">"Hello Snackbar!"</span>)
                }
            }) {
                Text(<span class="hljs-string">"点我"</span>)
            }
        }
    ) { padding -&gt;
        Box(Modifier.fillMaxSize().padding(padding), contentAlignment = Alignment.Center) {
            Text(<span class="hljs-string">"点击右下角按钮显示 Snackbar"</span>)
        }
    }
}

</code></pre>
<h3 data-id="heading-25">4、快速记忆</h3>
<p>rememberCoroutineScope → 手动 launch → 自动取消 → 重组不重启<br/>
它与 <code>LaunchedEffect</code> 最大的区别是：<strong>需要事件触发</strong> 而不是自动执行。</p>
<h3 data-id="heading-26">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>用 <code>LaunchedEffect</code> 放点击</td><td>每次重组都弹</td><td>用 <code>scope.launch</code></td></tr><tr><td>不用 <code>remember</code></td><td>每次重组新 scope</td><td>必须 <code>rememberCoroutineScope()</code></td></tr><tr><td>用 <code>GlobalScope</code></td><td>无法取消</td><td>禁止使用！</td></tr></tbody></table>
<h3 data-id="heading-27">6、总结</h3>
<p>rememberCoroutineScope 是 Compose 中「用户交互 → 异步操作」的最佳实践，需要手动启动协程，首选选他。</p>
<h2 data-id="heading-28">ProduceState</h2>
<h3 data-id="heading-29">1、一句话概括</h3>
<p>produceState = 「外部数据源 转化为 Compose State」的桥梁，自动协程 + 自动取消 + 支持 key</p>
<h3 data-id="heading-30">2、核心机制</h3>

























<table><thead><tr><th>机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>协程生产 State</strong></td><td>在协程中 <code>value = xxx</code> → 自动触发 UI 重组</td></tr><tr><td><strong>自动生命周期</strong></td><td>进入 → 启动协程；离开 → 自动取消</td></tr><tr><td><strong>key 控制重启</strong></td><td><code>key</code> 变 → 取消旧协程，启动新协程</td></tr><tr><td>其更像是collectAsState()的增强版本，支持任意数据源，而collectAsState则只能来源于Flow。</td><td/></tr></tbody></table>
<h3 data-id="heading-31">常用场景</h3>
<ul>
<li>场景一：请求网络数据(最常见)</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserInfo</span><span class="hljs-params">(userId: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> produceState&lt;User?&gt;(initialValue = <span class="hljs-literal">null</span>, userId) {
        value = withContext(Dispatchers.IO) {
            RetrofitClient.apiService.getUsersById(userId)  <span class="hljs-comment">//根据userId获取用户数据</span>
        }
    }

    <span class="hljs-keyword">when</span> (user) {
        <span class="hljs-literal">null</span> -&gt; CircularProgressIndicator()
        <span class="hljs-keyword">else</span> -&gt; Text(<span class="hljs-string">"欢迎，<span class="hljs-subst">${user!!.name}</span>"</span>)
    }
}
</code></pre>
<ul>
<li>场景二：Flow -&gt; State（较常见），替代collectAsState</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SideEffectsViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _count = MutableStateFlow(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">val</span> countFlow = _count.asStateFlow()
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> = _count.value++
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FlowCounter</span><span class="hljs-params">(viewModel: <span class="hljs-type">SideEffectsViewModel</span> = viewModel()</span></span>) {
    <span class="hljs-comment">//原写法</span>
    <span class="hljs-comment">// val count by viewModel.collectAsState()</span>
    <span class="hljs-keyword">val</span> count <span class="hljs-keyword">by</span> produceState(initialValue = <span class="hljs-number">0</span>) {
        viewModel.countFlow.collect { value = it }
    }

    Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<ul>
<li>场景三：回调函数-&gt; State</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LocationNow</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, locationManager: <span class="hljs-type">LocationManager</span>)</span></span> {
    <span class="hljs-keyword">val</span> location <span class="hljs-keyword">by</span> produceState&lt;String?&gt;(initialValue = <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">val</span> listener = LocationListener { location -&gt; value = <span class="hljs-string">"经度: <span class="hljs-subst">${location.longitude}</span>, 纬度: <span class="hljs-subst">${location.latitude}</span>"</span> }
        <span class="hljs-comment">//权限检查代码省略</span>
        locationManager.requestLocationUpdates(
            LocationManager.GPS_PROVIDER,
            <span class="hljs-number">2000L</span>,
            <span class="hljs-number">1f</span>,
            listener)

        awaitDispose {
            locationManager.removeUpdates(listener)
        }
    }
    
    <span class="hljs-keyword">if</span> (location == <span class="hljs-literal">null</span>) {
        Text(<span class="hljs-string">"正在获取位置..."</span>)
    } <span class="hljs-keyword">else</span> {
        Text(<span class="hljs-string">"location"</span>)
    }
}
</code></pre>
<ul>
<li>场景四：状态处理</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">loadData</span><span class="hljs-params">(
    key: <span class="hljs-type">Any</span>?,
    block: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">T</span>
)</span></span>: State&lt;Result&lt;T&gt;&gt; = produceState&lt;Result&lt;T&gt;&gt;(Result.Loading, key) {
    <span class="hljs-keyword">try</span> {
        value = Result.Success(block())
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        value = Result.Error(e.message ?: <span class="hljs-string">"未知错误"</span>)
    }
}
</code></pre>
<h3 data-id="heading-32">4、快速记忆</h3>
<p>生产 State → 协程运行 → 自动取消 → key 控制重启</p>
<h3 data-id="heading-33">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>withContext(IO)</code></td><td>阻塞 UI</td><td>必须切线程</td></tr><tr><td>忘记 <code>key</code></td><td>数据不更新</td><td>加依赖参数</td></tr><tr><td>返回 <code>State</code></td><td>编译错误</td><td>必须 <code>by produceState</code></td></tr></tbody></table>
<h3 data-id="heading-34">6、相似对比</h3>

























<table><thead><tr><th>项目</th><th><code>produceState</code></th><th><code>collectAsState()</code></th></tr></thead><tbody><tr><td>数据源</td><td>任意</td><td>仅 Flow</td></tr><tr><td>支持 key</td><td>Yes</td><td>No</td></tr><tr><td>自动取消</td><td>Yes</td><td>Yes</td></tr></tbody></table>
<h3 data-id="heading-35">7.总结：</h3>
<p>produceState 是 Compose 中【外部数据源 -&gt; State】的最好桥梁， 熟悉它，你就能实现任意数据源驱动UI变化了。</p>
<h2 data-id="heading-36">derivedStateOf</h2>
<p>有人把这个归于副作用函数之类，但我个人觉得不是。原因如下：</p>
<ul>
<li>纯函数计算：基于其他状态计算的派送状态，不产生任何外部影响</li>
<li>无外部交互：不执行I/O操作，不启动异步任务、不修改外部状态</li>
<li>不直接参与UI更新：虽然在 Composable 中触发，但只是影响 UI 的“外部世界”</li>
</ul>
<h3 data-id="heading-37">1、一句话概括：</h3>
<p>derivedStateOf { } = 「只有当结果真正变化时才触发重组」，避免重复计算 + 减少 UI 闪烁</p>
<h3 data-id="heading-38">2、为什么需要derivedStateOf？</h3>
<p>问题：频繁重组导致性能拉胯</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserFilter</span><span class="hljs-params">(nameItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, query: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> filtered = nameItems.filter { it.contains(query) }  <span class="hljs-comment">// 每次重组都过滤！</span>

    LazyColumn {
        nameItems(filtered) { Text(it) }
    }
}
</code></pre>
<p>这段代码你会发现query 变 → 重组 → <strong>每次都重新 filter</strong>。 即使结果没变，也会触发 LazyColumn 重绘 → <strong>性能差 + 闪烁</strong>。<br/>
相关改进参考场景一</p>
<h3 data-id="heading-39">3、常用场景</h3>
<ul>
<li>场景一：搜索过滤</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchStr</span><span class="hljs-params">(nameItems: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, query: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 使用 derivedStateOf 只在 query 或 nameItems 变化时重新计算</span>
    <span class="hljs-keyword">var</span> searchQuery <span class="hljs-keyword">by</span> remember { mutableStateOf(query) }
    <span class="hljs-keyword">val</span> filteredItems <span class="hljs-keyword">by</span> derivedStateOf {
        nameItems.filter { it.contains(searchQuery, ignoreCase = <span class="hljs-literal">true</span>) }
    }
    Column {
        TextField(value = searchQuery,
            onValueChange = { searchQuery = it },
            label = { Text(<span class="hljs-string">"搜索"</span>) })
        LazyColumn {
            items(filteredItems) { item -&gt;
                Text(item)
            }
        }
    }
}
</code></pre>
<p>代码核心：快速输入时 → 只有结果变了才更新列表，降低了重组次数</p>
<ul>
<li>场景二：分页加载判断</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">InfiniteList</span><span class="hljs-params">(items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;, onLoadMore: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    <span class="hljs-comment">// 只有到达底部时才触发</span>
    <span class="hljs-keyword">val</span> shouldLoadMore <span class="hljs-keyword">by</span> derivedStateOf {
        <span class="hljs-keyword">val</span> lastVisible = listState.layoutInfo.visibleItemsInfo.lastOrNull()?.index ?: <span class="hljs-number">0</span>
        lastVisible &gt;= items.size - <span class="hljs-number">2</span>
    }

    LaunchedEffect(shouldLoadMore) {
        <span class="hljs-keyword">if</span> (shouldLoadMore) onLoadMore()
    }

    LazyColumn(state = listState) {
        items(items) { Text(it) }
    }
}
</code></pre>
<p>代码核心：计算是否距离底部还有两个Item，是的话触发加载下一页回调操作。</p>
<ul>
<li>场景三：关联数据或状态实时计算（常见用途）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span>  <span class="hljs-title">SumAndAvg</span><span class="hljs-params">(numbers: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> sum <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            numbers.sum()
        }
    }
    <span class="hljs-keyword">val</span> avg <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            numbers.average()
        }
    }

    Card {
        Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Text(<span class="hljs-string">"总和: <span class="hljs-variable">$sum</span>"</span>)
            Text(<span class="hljs-string">"平均: %.2f"</span>.format(avg))
            Text(<span class="hljs-string">"Numbers 总数: <span class="hljs-subst">${numbers.size}</span>"</span>)
        }
    }
}
</code></pre>
<p>-场景四：控件显示状态判断 （常见）</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">TopButtonShow</span><span class="hljs-params">(listState: <span class="hljs-type">LazyListState</span>)</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">val</span> showButton <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            listState.firstVisibleItemIndex &gt; <span class="hljs-number">0</span>
        }
    }

    AnimatedVisibility(showButton) {
        FloatingActionButton(onClick = {
            <span class="hljs-comment">// 回到顶部</span>
            scope.launch { 
                listState.animateScrollToItem(<span class="hljs-number">0</span>)
            }
        }, modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
            Icon(Icons.Default.KeyboardArrowUp, contentDescription = <span class="hljs-string">"回到顶部"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-40">4、快速记忆</h3>
<p>数据派生 -&gt; 重组少 -&gt; 性能优 -&gt; 体验棒</p>
<h3 data-id="heading-41">5、常见错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>derivedStateOf</code></td><td>频繁重组</td><td>必须用</td></tr><tr><td>放 <code>LaunchedEffect</code></td><td>无法驱动 UI</td><td>用 <code>by derivedStateOf</code></td></tr><tr><td>计算太重</td><td>卡 UI</td><td>移到 IO 线程</td></tr></tbody></table>
<h3 data-id="heading-42">6、总结</h3>
<p>derivedStateOf 是 Compose 中「计算优化 + 防闪烁」的最优解之一，掌握它能让你的UI更流畅。</p>
<h2 data-id="heading-43">rememberUpdatedState</h2>
<p>我同样认为这不属于副作用函数，理由与derivedStateOf类似。但它与副作用LaunchedEffect函数配合紧密，所以一起介绍了。其实这里面涉及到一个<code>闭包</code>的概念。这里面就不展开讲，不了解的小伙伴去问AI吧。</p>
<h3 data-id="heading-44">1、一句话概括</h3>
<p>rememberUpdatedState(value) = 「让 LaunchedEffect 里的协程，始终拿到最新的值」，即使它在重组时被捕获了旧值。</p>
<h3 data-id="heading-45">2、解决了什么问题</h3>
<p>先看问题代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GreetingMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 启动一个协程，每隔2秒打印一次 message</span>
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(<span class="hljs-number">2000</span>)
            Log.d(<span class="hljs-string">"message的值"</span>，<span class="hljs-string">"当前 message: <span class="hljs-variable">$message</span>"</span>)  <span class="hljs-comment">//  闭包捕获旧值</span>
        }
    }
}
</code></pre>
<p>存在的问题：当 <code>message</code> 改变时，<code>LaunchedEffect(Unit)</code> 不会重启，因为key未发生变化；
因此协程里打印的仍然是“第一次 Composition”时的旧值； 这就叫「<strong>stale capture（过期捕获）</strong> 」。</p>
<p>解决方案：使用rememberUpdatedState进行修正</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UpdateNewMessage</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 让协程中总能访问最新 message</span>
    <span class="hljs-keyword">val</span> currentMessage <span class="hljs-keyword">by</span> rememberUpdatedState(message)

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(<span class="hljs-number">2000</span>)
            println(<span class="hljs-string">"当前 message: <span class="hljs-variable">$currentMessage</span>"</span>)  <span class="hljs-comment">// ✅ 始终是最新值</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-46">3、应用场景</h3>
<ul>
<li>场景一：防抖（推荐此方式实现Compose的防抖）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DebouncedSearch</span><span class="hljs-params">(
    query: <span class="hljs-type">String</span>,
    onDebouncedQueryChange: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">var</span> searchQuery <span class="hljs-keyword">by</span> remember { mutableStateOf(query) }
    <span class="hljs-keyword">val</span> currentOnDebouncedQueryChange <span class="hljs-keyword">by</span> rememberUpdatedState(onDebouncedQueryChange)

    LaunchedEffect(searchQuery) {
        delay(<span class="hljs-number">300</span>) <span class="hljs-comment">// 300ms 防抖延迟</span>
        <span class="hljs-keyword">if</span>(searchQuery.isNotBlank()) {
            currentOnDebouncedQueryChange(query)
        }

    }
    TextField( value = searchQuery,
        onValueChange = { searchQuery = it },
        label = { Text(<span class="hljs-string">"搜索"</span>) } )
}
</code></pre>
<ul>
<li>场景二：事件监听中保持回调更新（最常见）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LocationChange</span><span class="hljs-params">(onLocationUpdate: (<span class="hljs-type">Location</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> currentCallback <span class="hljs-keyword">by</span> rememberUpdatedState(onLocationUpdate)
    
    DisposableEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">val</span> listener = LocationListener { location -&gt;
            currentCallback(location) <span class="hljs-comment">// 使用最新的回调</span>
        }
        
        locationManager.requestLocationUpdates(listener)
        
        onDispose {
            locationManager.removeUpdates(listener)
        }
    }
}
</code></pre>
<p>代码核心：时刻保持最新的回调，解决持有旧回调的问题</p>
<ul>
<li>场景三：定时器动态轮询（根据情况调整轮询时间）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 每次调用调整轮询间隔，不触发重启
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PollingData</span><span class="hljs-params">(intervalMs: <span class="hljs-type">Long</span>)</span></span> {
    <span class="hljs-keyword">val</span> updatedInterval <span class="hljs-keyword">by</span> rememberUpdatedState(intervalMs)
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"加载中..."</span>) }

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">data</span> = withContext(Dispatchers.IO) {
                RetrofitClient.apiService.getUsersById(<span class="hljs-number">1</span>).toString()
            }
            delay(updatedInterval)  <span class="hljs-comment">// 动态间隔</span>
        }
    }

    Column {
        Text(<span class="hljs-string">"数据: <span class="hljs-variable">$data</span>"</span>)
        Text(<span class="hljs-string">"轮询间隔: <span class="hljs-variable">$updatedInterval</span> ms"</span>)
    }
}
</code></pre>
<ul>
<li>场景四：延迟提示（优化部分情况下，控件多次显示隐藏导致的闪烁）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DelayedTooltip</span><span class="hljs-params">(visible: <span class="hljs-type">Boolean</span>, text: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> updatedVisible <span class="hljs-keyword">by</span> rememberUpdatedState(visible)

    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 延迟显示</span>
        <span class="hljs-keyword">if</span> (updatedVisible) {
            showTooltip(text)
        }
    }

    <span class="hljs-comment">// UI...</span>
}
</code></pre>
<h3 data-id="heading-47">4、快速记忆</h3>
<p>协程不重启，值要最新值，那就使用UpdatedState<br/>
<code>LaunchedEffect(Unit)</code> + <code>rememberUpdatedState(value)</code> = 不重启协程也能拿到最新值</p>
<h3 data-id="heading-48">5、常犯错误</h3>

























<table><thead><tr><th>错误</th><th>后果</th><th>正确</th></tr></thead><tbody><tr><td>不用 <code>rememberUpdatedState</code></td><td>协程用旧值</td><td>必须用</td></tr><tr><td>配合 <code>LaunchedEffect(value)</code></td><td>频繁重启</td><td>用 <code>Unit</code></td></tr><tr><td>放 <code>SideEffect</code></td><td>每次重组都执行</td><td>错！</td></tr></tbody></table>
<h3 data-id="heading-49">六、总结</h3>
<p>rememberUpdatedState 是 Compose 中「协程 + 动态参数」的黄金搭档，经常与LaunchedEffect(Unit)搭配实现多场景功能。</p>
<h2 data-id="heading-50">总结：</h2>
<p>Compose 的副作用函数本质是：<strong>在声明式UI中执行命令式逻辑的入口</strong>。<br/>
<code>LaunchedEffect</code>、<code>DisposableEffect</code>、<code>SideEffect</code> 解决不同生命周期阶段的副作用；<br/>
而 <code>rememberCoroutineScope</code>、<code>produceState</code>、<code>derivedStateOf</code>、<code>rememberUpdatedState</code> 则是围绕状态、协程与性能优化的工具。理解它们的生命周期、触发时机与取消机制，是写好 Compose 的关键。<br/>
本文只列出了我能想到的一些场景，肯定有很多的遗漏，还是需要大家在使用中去完善了解</p>
<p>各副作用函数机制速查表：</p>






















































































<table><thead><tr><th>函数</th><th>启动时机</th><th>重组触发</th><th>自动取消（随生命周期销毁）</th><th>常见用途</th><th>是否可持久运行（如轮询）</th><th>是否依赖 key</th></tr></thead><tbody><tr><td><strong><code>SideEffect</code></strong></td><td>每次成功重组后执行</td><td>✅ 每次重组都会执行</td><td>❌ 不会自动取消</td><td>把 Compose 状态同步到非 Compose 系统（如 Log、ViewModel 状态等）</td><td>❌</td><td>否</td></tr><tr><td><strong><code>LaunchedEffect(key)</code></strong></td><td>进入 Composition 时执行一次</td><td>✅ key 变化会重启协程</td><td>✅ key 改变或退出 Composition 时自动取消</td><td>执行一次性任务、启动协程、监听 Flow</td><td>✅</td><td>是</td></tr><tr><td><strong><code>DisposableEffect(key)</code></strong></td><td>进入 Composition 时执行一次</td><td>✅ key 变化或离开 Composition 时触发 onDispose</td><td>✅ 自动触发 onDispose</td><td>注册/注销监听、启动/停止外部资源</td><td>✅</td><td>是</td></tr><tr><td><strong><code>rememberCoroutineScope()</code></strong></td><td>组合时创建一个可记忆的协程作用域</td><td>❌ 不会因重组重新创建</td><td>✅ Composition 离开时自动取消</td><td>需要在回调中手动启动协程（如按钮点击）</td><td>✅</td><td>否</td></tr><tr><td><strong><code>produceState()</code></strong></td><td>进入 Composition 时启动协程</td><td>✅ key 变化会重启生产逻辑</td><td>✅ 自动取消旧协程</td><td>把异步任务结果转为 State（如网络请求）</td><td>✅</td><td>是</td></tr><tr><td><strong><code>derivedStateOf()</code></strong></td><td>依赖 State 变化时计算</td><td>✅ 依赖的值变化才重新计算</td><td>❌（纯计算，此处无意义）</td><td>优化计算型状态，避免不必要重组</td><td>❌</td><td>否</td></tr><tr><td><strong><code>rememberUpdatedState()</code></strong></td><td>每次重组更新内部值</td><td>❌ 不会导致重组</td><td>❌</td><td>让长期副作用中访问最新参数（如协程/回调）</td><td>✅</td><td>否</td></tr><tr><td><strong><code>snapshotFlow { }</code></strong></td><td>在协程中把 State 转换为 Flow</td><td>✅ State 变化时发射新值</td><td>✅ 协程取消即停止</td><td>响应式收集 State 变化</td><td>✅</td><td>否</td></tr></tbody></table>
<h2 data-id="heading-51">源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftcyang123456%2FTestCompose.git" target="_blank" title="https://github.com/tcyang123456/TestCompose.git" ref="nofollow noopener noreferrer">github.com/tcyang12345…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Root-> A ->B -> C page, 当前C page, 如何返回B，又如何直接返回A page呢]]></title>    <link>https://juejin.cn/post/7571304204754042934</link>    <guid>https://juejin.cn/post/7571304204754042934</guid>    <pubDate>2025-11-11T10:12:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204754042934" data-draft-id="7571105461099233323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Root-&gt; A -&gt;B -&gt; C page, 当前C page, 如何返回B，又如何直接返回A page呢"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T10:12:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="littleplayer"/> <meta itemprop="url" content="https://juejin.cn/user/1926000099198813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Root-&gt; A -&gt;B -&gt; C page, 当前C page, 如何返回B，又如何直接返回A page呢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000099198813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    littleplayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:12:57.000Z" title="Tue Nov 11 2025 10:12:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 SwiftUI 中，从 C 页面返回到 B 或直接返回到 A 页面有多种方式。以下是具体的实现方法：</p>
<h2 data-id="heading-0">1. 使用 NavigationStack 和 NavigationPath</h2>
<h3 data-id="heading-1">基本设置</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Route</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> a
    <span class="hljs-keyword">case</span> b
    <span class="hljs-keyword">case</span> c
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">AView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">switch</span> route {
                    <span class="hljs-keyword">case</span> .a:
                        <span class="hljs-type">AView</span>()
                    <span class="hljs-keyword">case</span> .b:
                        <span class="hljs-type">BView</span>()
                    <span class="hljs-keyword">case</span> .c:
                        <span class="hljs-type">CView</span>()
                    }
                }
        }
        .environment(\.navigationPath, <span class="hljs-variable">$navigationPath</span>)
    }
}
</code></pre>
<h2 data-id="heading-2">2. 从 C 返回 B，或直接返回 A</h2>
<h3 data-id="heading-3">使用环境变量传递导航控制</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 定义环境Key</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">NavigationPathKey</span>: <span class="hljs-title class_">EnvironmentKey</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> defaultValue: <span class="hljs-type">Binding</span>&lt;<span class="hljs-type">NavigationPath</span>&gt;? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">EnvironmentValues</span> {
    <span class="hljs-keyword">var</span> navigationPath: <span class="hljs-type">Binding</span>&lt;<span class="hljs-type">NavigationPath</span>&gt;? {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">NavigationPathKey</span>.<span class="hljs-keyword">self</span>] }
        <span class="hljs-keyword">set</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">NavigationPathKey</span>.<span class="hljs-keyword">self</span>] <span class="hljs-operator">=</span> newValue }
    }
}

<span class="hljs-comment">// A 页面</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"A 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"前往 B 页面"</span>) {
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.b)
            }
            .padding()
        }
        .navigationTitle(<span class="hljs-string">"A 页面"</span>)
    }
}

<span class="hljs-comment">// B 页面</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"B 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"前往 C 页面"</span>) {
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.c)
            }
            .padding()
        }
        .navigationTitle(<span class="hljs-string">"B 页面"</span>)
    }
}

<span class="hljs-comment">// C 页面 - 关键部分</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.navigationPath) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-comment">// 方法1: 返回上一页 (B)</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回上一页 (B)"</span>) {
                dismiss() <span class="hljs-comment">// 或者 navigationPath?.wrappedValue.removeLast()</span>
            }
            
            <span class="hljs-comment">// 方法2: 直接返回 A 页面</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"直接返回 A 页面"</span>) {
                <span class="hljs-comment">// 移除最后2个页面 (C 和 B)</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.removeLast(<span class="hljs-number">2</span>)
            }
            
            <span class="hljs-comment">// 方法3: 返回根页面 (A)</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面 (A)"</span>) {
                <span class="hljs-comment">// 移除所有页面，回到根</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.removeLast(navigationPath<span class="hljs-operator">?</span>.wrappedValue.count <span class="hljs-operator">??</span> <span class="hljs-number">0</span>)
            }
            
            <span class="hljs-comment">// 方法4: 特定路径跳转</span>
            <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到 A 页面"</span>) {
                <span class="hljs-comment">// 清空路径，然后添加 A</span>
                navigationPath<span class="hljs-operator">?</span>.wrappedValue <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
                navigationPath<span class="hljs-operator">?</span>.wrappedValue.append(<span class="hljs-type">Route</span>.a)
            }
        }
        .navigationTitle(<span class="hljs-string">"C 页面"</span>)
    }
}
</code></pre>
<h2 data-id="heading-4">3. 使用导航管理器 (推荐)</h2>
<h3 data-id="heading-5">创建导航管理器</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationManager</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> path <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-comment">// 返回上一页</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goBack</span>() {
        <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>path.isEmpty <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        path.removeLast()
    }
    
    <span class="hljs-comment">// 返回到特定页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goBackToA</span>() {
        <span class="hljs-comment">// 假设路径是 [B, C]，移除最后2个</span>
        <span class="hljs-keyword">if</span> path.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">2</span> {
            path.removeLast(<span class="hljs-number">2</span>)
        }
    }
    
    <span class="hljs-comment">// 返回到根页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">goToRoot</span>() {
        path.removeLast(path.count)
    }
    
    <span class="hljs-comment">// 导航到特定页面</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateTo</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">route</span>: <span class="hljs-type">Route</span>) {
        path.append(route)
    }
}
</code></pre>
<h3 data-id="heading-6">在视图中使用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager <span class="hljs-operator">=</span> <span class="hljs-type">NavigationManager</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navManager</span>.path) {
            <span class="hljs-type">AView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-keyword">switch</span> route {
                    <span class="hljs-keyword">case</span> .a: <span class="hljs-type">AView</span>()
                    <span class="hljs-keyword">case</span> .b: <span class="hljs-type">BView</span>()
                    <span class="hljs-keyword">case</span> .c: <span class="hljs-type">CView</span>()
                    }
                }
        }
        .environmentObject(navManager)
    }
}

<span class="hljs-comment">// C 页面使用导航管理器</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager: <span class="hljs-type">NavigationManager</span>
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回上一页 (B)"</span>) {
                navManager.goBack()
            }
            .buttonStyle(.bordered)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"直接返回 A 页面"</span>) {
                navManager.goBackToA()
            }
            .buttonStyle(.borderedProminent)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面"</span>) {
                navManager.goToRoot()
            }
            .buttonStyle(.bordered)
            
            <span class="hljs-comment">// 当前路径信息</span>
            <span class="hljs-type">Text</span>(<span class="hljs-string">"当前导航栈深度: <span class="hljs-subst">\(navManager.path.count)</span>"</span>)
        }
        .navigationTitle(<span class="hljs-string">"C 页面"</span>)
        .navigationBarBackButtonHidden(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 隐藏默认返回按钮</span>
        .toolbar {
            <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarLeading) {
                <span class="hljs-type">Button</span>(<span class="hljs-string">"返回"</span>) {
                    navManager.goBack()
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-7">4. 使用 @Binding 传递控制 (简单场景)</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> path: <span class="hljs-type">NavigationPath</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"C 页面"</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回 B"</span>) {
                path.removeLast()
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"返回 A"</span>) {
                <span class="hljs-comment">// 移除 B 和 C</span>
                <span class="hljs-keyword">if</span> path.count <span class="hljs-operator">&gt;=</span> <span class="hljs-number">2</span> {
                    path.removeLast(<span class="hljs-number">2</span>)
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p><strong>从 C 返回 B 的方法：</strong></p>
<ul>
<li><code>dismiss()</code> - 最简单的返回上一页</li>
<li><code>navigationPath.removeLast()</code> - 编程式返回</li>
<li><code>navManager.goBack()</code> - 通过管理器返回</li>
</ul>
<p><strong>从 C 直接返回 A 的方法：</strong></p>
<ul>
<li><code>navigationPath.removeLast(2)</code> - 移除最后2个页面</li>
<li><code>navigationPath.removeLast(navigationPath.count)</code> - 清空所有页面</li>
<li><code>navManager.goBackToA()</code> - 通过管理器精确控制</li>
</ul>
<p>推荐使用导航管理器的方式，因为它提供了更好的代码组织和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[提示词工程化实践：我如何构建可复用的Suno工作流系统]]></title>    <link>https://juejin.cn/post/7571281406509989939</link>    <guid>https://juejin.cn/post/7571281406509989939</guid>    <pubDate>2025-11-11T10:15:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509989939" data-draft-id="7571281406509662259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="提示词工程化实践：我如何构建可复用的Suno工作流系统"/> <meta itemprop="keywords" content="AIGC,Coze"/> <meta itemprop="datePublished" content="2025-11-11T10:15:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HYI"/> <meta itemprop="url" content="https://juejin.cn/user/2261030112603613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            提示词工程化实践：我如何构建可复用的Suno工作流系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2261030112603613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HYI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:15:10.000Z" title="Tue Nov 11 2025 10:15:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当音乐小白遇上 Suno</h2>
<p>最近迷上了用 Suno AI 生成音乐，但很快就遇到了两个痛点：</p>
<ol>
<li>作为乐理小白，我不知道如何写出完整的歌词和音乐结构</li>
<li>即使有模糊的想法，也很难转化为 Suno 能理解的精准提示词</li>
</ol>
<p>最初的解决方案很简单：让大模型帮我补全。但很快发现，这种“一次性”的生成方式存在很大随机性，无法积累经验，也无法系统化提升输出质量。</p>
<h2 data-id="heading-1">思路转变：从单次生成到流程设计</h2>
<p>我意识到，需要建立一个可重复、可优化的创作流程。经过多次迭代，最终形成了一套模块化的工作流系统。</p>
<p><strong>核心演进历程：</strong></p>
<ul>
<li><strong>V1</strong>：简单的角色设定+任务说明，手动串联各个步骤</li>
<li><strong>V2</strong>：引入标准化步骤概念，开始定义输入输出</li>
<li><strong>V3</strong>：关键的模块化转变，通过文件契约建立接口规范</li>
<li><strong>V4</strong>：完善的调度系统，支持调试、开发和知识库扩展</li>
</ul>
<h2 data-id="heading-2">最终工作流架构设计</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([流程开始]) --&gt; Step1

    subgraph Step1 [前置流程认知]
        A1[角色: 音乐制作调度引擎] --&gt; A2[载入模块]
    end

    A2 --&gt; Step2[知识库插件&lt;br&gt;提供术语与标签库]

    subgraph Step3 [需求解析引擎]
        B1[输入: 用户原始灵感] --&gt; B2{是否模糊?}
        B2 -- 是 --&gt; B3[追问具体细节]
        B3 --&gt; B1
        B2 -- 否 --&gt; B4[生成项目需求规范]
        B4 --&gt; B5[输出: ProjectSpec.md]
    end

    Step2 --&gt; Step3

    subgraph Step4 [定义音乐内核]
        C1[输入: ProjectSpec.md] --&gt; C2[转化为专业音乐术语]
        C2 --&gt; C3[生成核心创意蓝图]
        C3 --&gt; C4[输出: CreativeCore.md]
    end

    B5 --&gt; Step4

    subgraph Step5 [歌词生成]
        D1[输入: CreativeCore.md] --&gt; D2[创作结构化歌词]
        D2 --&gt; D3[输出: Lyrics.md]
        D2 --&gt; D4[输出: VocalDesign.md]
    end

    C4 --&gt; Step5

    subgraph Step6 [作曲生成]
        E1[输入:&lt;br&gt;CreativeCore.md&lt;br&gt;Lyrics.md&lt;br&gt;VocalDesign.md] --&gt; E2[生成Suno提示词]
        E2 --&gt; E3[输出: MusicPrompt.md]
    end

    D3 --&gt; Step6
    D4 --&gt; Step6

    subgraph Step7 [质量校验引擎]
        F1[输入: 所有前期产出] --&gt; F2{一致性检查?}
        F2 -- 不通过 --&gt; F3[返回对应模块修正]
        F3 --&gt; Step5
        F2 -- 通过 --&gt; F4[生成质量报告]
        F4 --&gt; F5[输出: QualityReport.md]
    end

    E3 --&gt; Step7

    subgraph Step8 [衍生内容引擎]
        G1[输入: 完整作品包] --&gt; G2[生成营销材料]
        G2 --&gt; G3[输出: DerivativeContent.md]
    end

    F5 --&gt; Step8 --&gt; End([流程结束])

    %% 样式定义
    classDef process fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef decision fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef inputoutput fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px;
    classDef startend fill:#fce4ec,stroke:#c2185b,stroke-width:2px;
    
    class Step1,Step3,Step4,Step5,Step6,Step7,Step8 process;
    class B2,F2 decision;
    class B5,C4,D3,D4,E3,F5,G3 inputoutput;
    class Start,End startend;
</code></pre>
<p>经过多次迭代，我最终确立了一套标准化音乐生产管线。该系统的核心思想是 <strong>“模块化分工”</strong> 与 <strong>“契约化协作”</strong> ，每个模块职责单一，并通过标准化的文件接口传递数据，确保流程的稳定性和输出质量。</p>
<h3 data-id="heading-3">系统架构总览</h3>
<p>整个工作流是一个严格的瀑布模型，上游模块的输出是下游模块的唯一输入：</p>
<p><code>[需求解析引擎] → [定义音乐内核] → [作词引擎] → [作曲引擎] → [质量校验引擎] → [衍生内容引擎]</code></p>
<p>此外，还有一个独立的 <code>[知识库插件]</code> 可为各模块提供专业术语支持。</p>
<h3 data-id="heading-4">核心模块详解</h3>
<h4 data-id="heading-5">1. 需求解析引擎</h4>
<p><strong>角色</strong>：音乐项目分析师
<strong>任务</strong>：将模糊、感性的用户灵感，转化为清晰、无歧义、可执行的需求文档。
<strong>输入</strong>：用户原始需求（如：“做一首科技感、热血的歌”）
<strong>输出</strong>：<code>ProjectSpec.md</code>
<strong>核心价值</strong>：通过“反模糊规则”强制具体化，奠定项目质量基石。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目需求规范</span>
<span class="hljs-section">## 核心情绪</span>
<span class="hljs-bullet">-</span> 主导基调：科技感的热血与憧憬
<span class="hljs-bullet">-</span> 情感动态：从理性观察到感性释放
<span class="hljs-section">## 风格方向</span>
<span class="hljs-bullet">-</span> 感觉描述：未来都市天际线在黎明时的景象
<span class="hljs-bullet">-</span> 动态比喻：如数据洪流汇聚成澎湃浪潮
<span class="hljs-section">## 核心意象</span>
<span class="hljs-bullet">-</span> 视觉符号：外滩建筑群、流动的代码光带
...
</code></pre>
<h4 data-id="heading-6">2. 定义音乐内核</h4>
<p><strong>角色</strong>：音乐创意架构师
<strong>任务</strong>：将标准化的需求，创造性转化为一份具备深度与执行性的核心创意蓝图。
<strong>输入</strong>：<code>ProjectSpec.md</code>
<strong>输出</strong>：<code>CreativeCore.md</code>
<strong>核心价值</strong>：完成从“需求是什么”到“音乐怎么做”的关键跳跃。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 核心创意蓝图</span>
<span class="hljs-section">## 音乐概念设计</span>
<span class="hljs-bullet">-</span> 核心张力：数字合成的精确与人性温暖的对抗融合
<span class="hljs-bullet">-</span> 风格定位：以Synthwave为基底，融入Cinematic元素
<span class="hljs-section">## 声音设计框架</span>
<span class="hljs-bullet">-</span> 节奏与律动：128 BPM/4/4 - 强劲电子鼓组与脉冲贝斯
...
</code></pre>
<h4 data-id="heading-7">3. 作词引擎</h4>
<p><strong>角色</strong>：音乐剧本作家
<strong>任务</strong>：基于创意蓝图，生成结构创新、情感精准且符合Suno格式标准的歌词脚本。
<strong>输入</strong>：<code>CreativeCore.md</code>
<strong>输出</strong>：</p>
<ul>
<li><code>Lyrics.md</code> (歌词文件)</li>
<li><code>VocalDesign.md</code> (演唱设计文件)
<strong>核心价值</strong>：输出非模板化的、具有戏剧张力的歌词，并附带专业的演唱指导。</li>
</ul>
<pre><code class="hljs language-text" lang="text">[Intro] (氛围感电子音效) /
城市在重启 代码的潮汐 /
[Verse 1] (冷静叙述)
穿过外滩的风 听见未来的回音 /
...
</code></pre>
<h4 data-id="heading-8">4. 作曲引擎</h4>
<p><strong>角色</strong>：Suno音效设计师
<strong>任务</strong>：将创意蓝图和歌词“翻译”成Suno能理解的、精确的音乐风格提示词。
<strong>输入</strong>：<code>CreativeCore.md</code>, <code>Lyrics.md</code>, <code>VocalDesign.md</code>
<strong>输出</strong>：<code>MusicPrompt.md</code>
<strong>核心价值</strong>：实现“音色叙事”，将文字概念转化为具体的声音描述。</p>
<pre><code class="hljs language-text" lang="text">Synthwave fused with Cinematic Pop, uplifting and futuristic.
Powerful male vocals with rap sections. 128 BPM.
Featuring soaring synthesizer leads and pounding electronic drums.
</code></pre>
<h4 data-id="heading-9">5. 质量校验引擎</h4>
<p><strong>角色</strong>：音乐质量审计师
<strong>任务</strong>：对歌词和音乐提示词进行一致性校验，确保所有产出符合艺术标准和技术规范。
<strong>输入</strong>：<code>CreativeCore.md</code>, <code>Lyrics.md</code>, <code>MusicPrompt.md</code>
<strong>输出</strong>：<code>QualityReport.md</code>
<strong>核心价值</strong>：作为质量守门员，形成创作闭环，确保最终产出与最初愿景一致。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 质量校验报告</span>
<span class="hljs-section">## 一致性检查</span>
<span class="hljs-bullet">-</span> [x] 歌词主题与创意蓝图的核心张力一致
<span class="hljs-bullet">-</span> [x] 音乐风格与内核定义匹配
<span class="hljs-section">## 优化建议</span>
<span class="hljs-bullet">-</span> 副歌部分可增加和声设计的描述
</code></pre>
<h4 data-id="heading-10">6. 衍生内容引擎</h4>
<p><strong>角色</strong>：音乐产品经理
<strong>任务</strong>：基于完整的音乐作品包，自动生成配套的营销和发行材料。
<strong>输入</strong>：所有前期产出文件
<strong>输出</strong>：<code>DerivativeContent.md</code>
<strong>核心价值</strong>：最大化作品价值，提供开箱即用的宣发素材。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 衍生内容包</span>
<span class="hljs-section">## 歌曲名称</span>
<span class="hljs-section">## 封面图片</span>
<span class="hljs-section">## 歌曲简介</span>
一首关于...的Synthwave作品。
</code></pre>
<h2 data-id="heading-11">心理路程</h2>
<h3 data-id="heading-12">v1</h3>
<blockquote>
<p>直接描述需求-粘贴歌词生成提示词-粘贴音乐提示词生成-融合前面的输入，整合输出最后产物
v1可以输出内容，但流程还是不满意，虽然够用。之后构思新流程，后面的所有步骤都是按照新的流程 <code>模糊需求提示词目标填空需求 - 理解需求输出清晰标准的需求 - 根据标准的需求生成内核 - 生产歌词 -生成风格提示词 - 校验 - 输出</code></p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># 角色设定</span>
<span class="hljs-section"># 任务说明</span>
<span class="hljs-section"># 输入信息</span>
<span class="hljs-section"># 输出要求</span>
</code></pre>
<h3 data-id="heading-13">v2</h3>
<blockquote>
<p>v2的前面核心流程走通了，可是提示词很乱，最后约束与限制和示例对照表未完成就转v3</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># Step [步骤名称]</span>
<span class="hljs-section">## 角色设定（Role）</span>
<span class="hljs-section">## 任务目标（Task）</span>
<span class="hljs-section">## 输入参数（Inputs）</span>
<span class="hljs-section">### 输出格式（Outputs）</span>
<span class="hljs-section">## 约束与限制（Constraints）</span>
<span class="hljs-section">## 示例对照表（Example） </span>
</code></pre>
<h3 data-id="heading-14">v3</h3>
<blockquote>
<p>v3之前是阶段概念，这里引入模块概念，引入知识库概念，新的模板格式更清晰</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># Module - {{modelName}}</span>
<span class="hljs-section">## Role</span>
<span class="hljs-section">## Task</span>
<span class="hljs-section">## Inputs</span>
<span class="hljs-section">## Outputs</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**文件名**</span>：`{{fileName}}.md`</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**格式**</span>：严格遵循以下Markdown模板</span>

<span class="hljs-code">```markdown ```</span>
<span class="hljs-section">## Rules</span>
<span class="hljs-section">## Example</span>
| 输入 | 输出 |
| :--- | :--- |
</code></pre>
<h3 data-id="heading-15">v4</h3>
<blockquote>
<p>我一直是对话流，为了区分不同功能，引入了标签包裹提示词，增加了 debug、dev、module、plugin 等标签，用于指定不同的功能模块。
debug真的好用，在我不知道为什么输出不符合要求使，在debug标签内要求模型自己分析一下为什么，效率很高非常方便。</p>
</blockquote>
<pre><code class="hljs language-md" lang="md"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span></span>
<span class="hljs-section"># Module - {{modelName}}</span>
<span class="hljs-section">## Role</span>
<span class="hljs-section">## Task</span>
<span class="hljs-section">## Inputs</span>
<span class="hljs-section">## Outputs</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**文件名**</span>：`{{fileName}}.md`</span>
<span class="hljs-quote">&gt; <span class="hljs-strong">**格式**</span>：严格遵循以下Markdown模板</span>

<span class="hljs-code">```markdown ```</span>
<span class="hljs-section">## Rules</span>
<span class="hljs-section">## Example</span>
| 输入 | 输出 |
| :--- | :--- |
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-16">v4.1</h3>
<p>查找资料，总结更完善的suno规则</p>
<p><strong>资源分享：</strong>
在实践中整理的详细文档，供参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FV7qtwgdDCiLfWfkWIglcEU1AnVc" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/V7qtwgdDCiLfWfkWIglcEU1AnVc" ref="nofollow noopener noreferrer">Suno AI 提示词</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FV06vwRsvbiPqhzk0qP6cmMdYnsh" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/V06vwRsvbiPqhzk0qP6cmMdYnsh" ref="nofollow noopener noreferrer">Suno AI 提示词规则</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fqcn0ge2z1yhd.feishu.cn%2Fwiki%2FTkp8wZFZtiHtyDkhlLxcOND5nad" target="_blank" title="https://qcn0ge2z1yhd.feishu.cn/wiki/Tkp8wZFZtiHtyDkhlLxcOND5nad" ref="nofollow noopener noreferrer">AI音乐生成指南V4</a></li>
</ul>
<h2 data-id="heading-17">结语</h2>
<h3 data-id="heading-18">学到了什么？</h3>
<p>通过从零开始设计和迭代这套Suno音乐工作流，我获得了关于AI智能体构建的第一手经验。这不仅仅是一个提示词优化过程，更是一次完整的智能体系统开发生命周期实践：
好的，如果我是你，回顾整个探索过程，我学到了最核心的三点：</p>
<ol>
<li><strong>从“下指令”到“建系统”的思维跃迁</strong>
最大的收获不是写出了更好的提示词，而是学会了不直接向AI要结果，而是为它设计一套分工明确、接口清晰的协作系统。我从“用户”变成了“架构师”。</li>
<li><strong>“契约”比“模型”更关键</strong>
我发现，确保多个AI智能体稳定协作的核心，不是找到一个最强大的模型，而是为它们设计好像 <code>ProjectSpec.md</code> 这样的标准化“契约”（接口）。清晰的接口定义是系统稳定性的基石。</li>
<li><strong>创造力可以“工程化”</strong>
我成功地将看似依赖灵感的音乐创作，分解成了一个可重复、可优化、可控的工程流程。这证明了复杂创意任务可以通过系统化的方法变得稳定和可靠。</li>
</ol>
<h3 data-id="heading-19">其他</h3>
<p>下一步就是把v4搬到扣子、dify工作流实现更便捷的ui操作，再增加<strong>点子王模块</strong>节点，使用循环节点输出多风格版本。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏮一眼就会🗂️大文件分片上传，白送前后端全套功法]]></title>    <link>https://juejin.cn/post/7570268773333205019</link>    <guid>https://juejin.cn/post/7570268773333205019</guid>    <pubDate>2025-11-09T23:09:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773333205019" data-draft-id="7568706594881683466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏮一眼就会🗂️大文件分片上传，白送前后端全套功法"/> <meta itemprop="keywords" content="Node.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-09T23:09:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vilan_微澜"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267199320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏮一眼就会🗂️大文件分片上传，白送前后端全套功法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267199320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vilan_微澜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:09:25.000Z" title="Sun Nov 09 2025 23:09:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>快看！前方好像有什么人在争吵。</p>
<p>我这个文件上传了这么多，怎么又要重新开始上传啊？</p>
<p>我这个网页怎么又卡住了。</p>
<p>切图仔快来看看！</p>
<p><strong>啊啊啊！</strong> 前方突然传来一声尖叫，只见一个年轻人“颤颤巍巍”地从工位上站起，指着他后方的同事，随后大喊一声：“你不要再叫我切图仔啦！”</p>
<p>话音刚落，只见后方同事表现出一副嗤之以鼻的样子，随后带着一丝轻蔑，对着那个年轻人又撂下一句：“切图仔！”。</p>
<p>随即，那个年轻人全身都在颤抖，仿佛就要......</p>
<h2 data-id="heading-0">引言</h2>
<p>开始学习。</p>
<p>下文将带你打通从前端文件分片、文件哈希计算、<code>Web Worker</code>用法、文件断点续传和秒传，到后端分片接收、文件合并的完整技术链条。</p>
<p><strong>后端</strong>基于 <strong>Node.js + Express</strong> 框架，使用 <strong>formidable</strong> 库高效处理分片数据，最终将分片合并为完整文件。</p>
<p><strong>前端</strong>采用 <strong>Vue 3 + TS + Vite</strong> 构建，使用 <strong>Naive UI</strong> 写个好看点的上传进度监控界面，并利用 <strong>Web Worker</strong> 线程计算文件哈希。</p>
<p><strong>关键词：</strong> 文件分片、文件秒传、断点续传、上传进度、文件hash、Web Worker、Node.js</p>
<h2 data-id="heading-1">实现原理图解</h2>
<p>下面<strong>两张图</strong>展示了从<strong>前端</strong>上传文件分片到<strong>后端</strong>解析分片数据并写入文件、合并分片文件的<strong>全套功法</strong>。</p>
<h3 data-id="heading-2">前端实现图解</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7398d3f7c7e43349c2106ff954bb2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=OtpaAiZGapc7u35U%2FtY6wB95Yf4%3D" alt="前端.png" loading="lazy"/></p>
<h3 data-id="heading-3">后端实现图解</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b1ad33662f4a1597ac084d99f70a6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=OaZCU5BRxPmO4xlasyj3XF5nmuY%3D" alt="无标题-2025-11-08-2359.png" loading="lazy"/></p>
<p>看完图解大概理解实现流程就可以上手写代码了</p>
<h2 data-id="heading-4">前端实现代码</h2>
<p>首先我们的目的是封装一个提供大文件上传功能的函数，由于函数中又涉及到页面的一些<strong>响应式状态</strong>，比如上传进度，那么我们姑且就叫它为<code>hook</code>函数吧，然后把它命名为<code>useBigFileUpload.ts</code></p>
<p>下面先把需要用到的<strong>属性和类型</strong>先写上，其他方法后面再逐步完善。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> axios, { <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosProgressEvent</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AxiosResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;
<span class="hljs-keyword">import</span> { createDiscreteApi } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> { computed, markRaw, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"http://localhost:3000"</span>;

<span class="hljs-comment">// axios实例化</span>
<span class="hljs-keyword">const</span> http = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: baseUrl,
});

<span class="hljs-keyword">const</span> { message } = <span class="hljs-title function_">createDiscreteApi</span>([<span class="hljs-string">"message"</span>]);

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-attr">chunkSize</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ChunkRequestQueue</span> = {
  <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AxiosResponse</span>&gt;;
  <span class="hljs-attr">abortController</span>: <span class="hljs-title class_">AbortController</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Chunk</span> = {
  <span class="hljs-comment">// 切片数据</span>
  <span class="hljs-attr">chunk</span>: <span class="hljs-title class_">Blob</span>;
  <span class="hljs-comment">// 当前切片索引</span>
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 切片文件名</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 总大小</span>
  <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 已上传大小</span>
  <span class="hljs-attr">uploaded</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 请求总进度</span>
  <span class="hljs-attr">requestSize</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 是否完成上传</span>
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">// 上传进度</span>
  <span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useBigFileUpload</span> = (<span class="hljs-params">
  props: Props = {
    chunkSize: <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1</span>,
  }
</span>) =&gt; {

  <span class="hljs-comment">// 当前计算hash进度</span>
  <span class="hljs-keyword">const</span> hashProgress = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 是否暂停了上传</span>
  <span class="hljs-keyword">const</span> isPuase = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 当前上传的文件</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">fileTarget</span>: <span class="hljs-title class_">File</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 文件哈希值+文件后缀名</span>
  <span class="hljs-keyword">let</span> fileHash = <span class="hljs-string">""</span>;

  <span class="hljs-comment">// 当前上传切片数组</span>
  <span class="hljs-keyword">const</span> chunks = ref&lt;<span class="hljs-title class_">Chunk</span>[]&gt;([]);

  <span class="hljs-comment">// 当前上传请求队列</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">chunkReqQueueList</span>: <span class="hljs-title class_">ChunkRequestQueue</span>[] = [];

  <span class="hljs-comment">// 当前上传完成的切片/总切片数</span>
  <span class="hljs-keyword">const</span> percentage = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> chunkSize = chunks.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (chunkSize === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">const</span> conpletedChunks = chunks.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> chunk.<span class="hljs-property">completed</span>);
    <span class="hljs-keyword">return</span> (conpletedChunks.<span class="hljs-property">length</span> / chunkSize) * <span class="hljs-number">100</span>;
  });

  <span class="hljs-keyword">return</span> {
    percentage,
    chunks,
    isPuase,
    hashProgress,
  };
};

</code></pre>
<h3 data-id="heading-5">文件切片</h3>
<p>创建<code>createChunks</code>方法，对大文件进行切片</p>
<pre><code class="hljs language-ts" lang="ts"> <span class="hljs-comment">// 创建切片，切片大小可根据自身需求调整</span>
  <span class="hljs-keyword">const</span> createChunks = (
    <span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>,
    <span class="hljs-attr">chunkSize</span>: <span class="hljs-built_in">number</span> = props.<span class="hljs-property">chunkSize</span>
  ): <span class="hljs-title class_">Blob</span>[] =&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">Blob</span>[] = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; file.<span class="hljs-property">size</span>; i += chunkSize, j++) {
      chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(i, i + chunkSize));
    }
    <span class="hljs-keyword">return</span> chunks;
  };
</code></pre>
<p>通过分片计算文件<code>hash</code>值，其中有两种计算类型：</p>
<p>1.<strong>抽样分片计算</strong>。通过抽取文件的一部分分片进行一部分文件内容的hash值计算，这种方法可以节省计算耗时。</p>
<p>2.<strong>全量分片计算</strong>。通过所有分片计算完整的文件内容hash值，这个方法计算的值会比较准确，但是计算耗时相对多一些。</p>
<p>下面我们<strong>采用</strong>的是<strong>第二种</strong>方法进行计算。</p>
<h3 data-id="heading-6">文件hash计算</h3>
<p>在你的项目的utils工具包中创建<code>file-hash.work.js</code>文件，计算文件内容hash值的<code>Web Worker</code>方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在 utils/workers/file-hash.work.js 中</span>
<span class="hljs-comment">// 引入 SparkMD5 计算文件内容hash</span>
<span class="hljs-comment">// importScripts('/spark-md5@3.0.2/spark-md5.min.js');</span>
importScripts(<span class="hljs-string">'https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js'</span>);

self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// 从主线程接收分片数据</span>
  <span class="hljs-keyword">const</span> { chunks } = e.<span class="hljs-property">data</span>;
  <span class="hljs-comment">// 创建 SparkMD5 实例</span>
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();

  <span class="hljs-comment">// 读取切片</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">readChunk</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">if</span> (index &gt;= chunks.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 所有分片处理完毕，计算最终哈希</span>
      <span class="hljs-keyword">const</span> hash = spark.<span class="hljs-title function_">end</span>();
      <span class="hljs-comment">// 向主线程发送最终计算的哈希值</span>
      self.<span class="hljs-title function_">postMessage</span>({ index, hash });
      <span class="hljs-comment">// 所有分片处理完毕，关闭worker</span>
      self.<span class="hljs-title function_">close</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 创建 FileReader 实例, 用于读取分片数据</span>
    <span class="hljs-keyword">const</span> fileReader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
    <span class="hljs-comment">// 读取分片数据</span>
    fileReader.<span class="hljs-title function_">readAsArrayBuffer</span>(chunks[index]);
    <span class="hljs-comment">// 分片数据加载完成事件监听</span>
    fileReader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 追加到 SparkMD5 实例</span>
      spark.<span class="hljs-title function_">append</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>);
      <span class="hljs-comment">// 向主线程发送计算进度索引</span>
      self.<span class="hljs-title function_">postMessage</span>({ index });
      <span class="hljs-comment">// 读取下一个分片</span>
      <span class="hljs-title function_">readChunk</span>(index + <span class="hljs-number">1</span>);
    };
  }
  <span class="hljs-comment">// 从索引0开始读取分片</span>
  <span class="hljs-title function_">readChunk</span>(<span class="hljs-number">0</span>);
};
</code></pre>
<p>在<code>utils</code>文件夹下写好<code>worker</code>工具函数后，继续在<code>useBigFileUpload</code>函数当中添加<code>getHashWorker</code>方法异步获取文件<code>hash</code>值。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 计算文件哈希值
 * <span class="hljs-doctag">@param</span> tempChunks 切片数组
 * <span class="hljs-doctag">@returns</span> 文件哈希值
 */</span>
<span class="hljs-keyword">const</span> getHashWorker = <span class="hljs-keyword">async</span> (<span class="hljs-attr">tempChunks</span>: <span class="hljs-title class_">Blob</span>[]): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; =&gt; {
  hashProgress.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-comment">// 导入worker线程，计算文件哈希值</span>
    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(
      <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">"../utils/workers/file-hash.work.js"</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)
    );
    <span class="hljs-comment">// 向worker线程发送消息，计算文件哈希值</span>
    worker.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">chunks</span>: tempChunks,
    });
    <span class="hljs-comment">// 监听worker线程消息，获取计算文件哈希值结果</span>
    worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { index, hash } = e.<span class="hljs-property">data</span>;
      <span class="hljs-comment">// 计算当前计算hash进度</span>
      <span class="hljs-keyword">if</span> (tempChunks.<span class="hljs-property">length</span>) {
        hashProgress.<span class="hljs-property">value</span> = (index / tempChunks.<span class="hljs-property">length</span>) * <span class="hljs-number">100</span>;
      }
      <span class="hljs-keyword">if</span> (hash) {
        <span class="hljs-comment">// 完成计算哈希值</span>
        <span class="hljs-title function_">resolve</span>(hash);
      }
    };
  });
};
</code></pre>
<p>拿到hash值后就可以通过该值查询服务器是否存在该文件，来实现大文件秒传</p>
<h3 data-id="heading-7">文件秒传</h3>
<p>通过<code>hash</code>查询服务器是否<strong>存在该文件</strong>，前端根据返回结果判断是否需要进行文件上传，已存在则直接显示上传完成，否则接着下面进行分片上传。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 检查文件是否已经上传
 * <span class="hljs-doctag">@param</span> fileHash 文件哈希值
 * <span class="hljs-doctag">@returns</span> 检查结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkFileApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">fileHash: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 通过文件hash检查是否已经上传了该文件</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/check/file?fileHash=<span class="hljs-subst">${fileHash}</span>`</span>);
  <span class="hljs-comment">// 返回检查结果</span>
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>.<span class="hljs-property">hasExist</span>
}
</code></pre>
<h3 data-id="heading-8">文件断点续传</h3>
<p>主要是通过检查服务器是否已经<strong>存在该分片</strong>，并返回查询结果，前端根据查询结果判断是否需要调用分片上传请求方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 检查切片是否已经上传
 * <span class="hljs-doctag">@param</span> chunkName 切片名
 * <span class="hljs-doctag">@returns</span> 检查结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkChunkApi</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">chunkName: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 创建中断请求器</span>
  <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

  <span class="hljs-comment">// 发生请求前先验证切片是否已经上传</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">AxiosResponse</span>&lt;{
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">hasExist</span>: <span class="hljs-built_in">boolean</span>;
  }&gt; = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk/check?chunkName=<span class="hljs-subst">${chunkName}</span>`</span>, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
  });

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">res</span>: res,
    abortController,
  }
};
</code></pre>
<h3 data-id="heading-9">分片上传请求</h3>
<p>创建开始分片上传请求方法<code>uploadChunkApi</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 上传切片
 * <span class="hljs-doctag">@param</span> data 切片数据
 * <span class="hljs-doctag">@returns</span> ChunkRequestQueue 上传请求对象
 */</span>
<span class="hljs-keyword">const</span> uploadChunkApi = (<span class="hljs-attr">data</span>: <span class="hljs-title class_">Chunk</span>): <span class="hljs-function"><span class="hljs-params">ChunkRequestQueue</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> { name, index, chunk } = data;
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">"chunk"</span>, chunk);

  <span class="hljs-comment">// 创建中断请求器</span>
  <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

  <span class="hljs-keyword">const</span> promise = http.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk?chunkName=<span class="hljs-subst">${name}</span>`</span>, formData, {
    <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
    <span class="hljs-attr">onUploadProgress</span>: <span class="hljs-function">(<span class="hljs-params">progressEvent: AxiosProgressEvent</span>) =&gt;</span> {
      <span class="hljs-comment">// 计算上传进度</span>
      <span class="hljs-keyword">if</span> (
        chunks.<span class="hljs-property">value</span>[index] &amp;&amp;
        progressEvent.<span class="hljs-property">total</span> &amp;&amp;
        progressEvent.<span class="hljs-property">progress</span>
      ) {
        <span class="hljs-comment">// 记录当前上传切片请求进度。</span>
        <span class="hljs-comment">// 注意，由于网络请求具有额外开销，上传进度可能会和切片大小不一样</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">uploaded</span> = progressEvent.<span class="hljs-property">loaded</span>;
        <span class="hljs-comment">// 记录当前上传切片请求总大小</span>
        <span class="hljs-comment">// 注意，由于网络请求具有额外开销，上传进度可能会和切片大小不一样</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">requestSize</span> = progressEvent.<span class="hljs-property">total</span>;
        <span class="hljs-comment">// 计算上传进度</span>
        chunks.<span class="hljs-property">value</span>[index].<span class="hljs-property">progress</span> = progressEvent.<span class="hljs-property">progress</span>;
      }
    },
  });

  <span class="hljs-keyword">return</span> {
    promise,
    abortController,
  };
};
</code></pre>
<p>在发送分片上传<code>http</code>请求的方法中，监听了<code>axios</code>的<code>onUploadProgress</code>回调方法，在该方法里面可以拿到请求的完成进度，其中记录了<code>AxiosProgressEvent</code>的3个属性：<code>uploaded</code>、<code>total</code>、<code>progress</code>。主要是<code>progress</code>页面显示上传进度需要，其他如果页面不需要显示，可有可无吧。</p>
<p>最后把当前请求的<code>promise</code>对象和中断请求的<code>abortController</code>对象返回，放入请求队列当中。</p>
<p>当需要暂停上传时，可以使用<code>abortController</code>进行中断请求。</p>
<h3 data-id="heading-10">分片合并请求</h3>
<p>创建合并切片请求方法<code>mergeChunksApi</code>，当请求队列中的分片都成功上传后，调用该方法并携带<code>fileHash</code>文件标识，用于服务器找到该文件分片所在位置，合并成功后，文件即上传完成。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 合并切片
 * <span class="hljs-doctag">@param</span> fileHash 文件哈希值
 * <span class="hljs-doctag">@returns</span> 合并结果
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeChunksApi</span> = (<span class="hljs-params">fileHash: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> http.<span class="hljs-title function_">post</span>(<span class="hljs-string">`/merge-chunk`</span>, {
    fileHash,
  });
};
</code></pre>
<h3 data-id="heading-11">开始上传文件</h3>
<p>上面的准备工作就绪后，就可以创建上传文件方法了。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 开始上传
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">file</span>
 * <span class="hljs-doctag">@param</span> resume 是否恢复上传
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file: File, resume: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (!file) {
    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请先选择文件!"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 恢复上传不用重新创建切片，延续之前的切片进度</span>
  <span class="hljs-keyword">if</span> (!resume) {
    <span class="hljs-comment">// 保存文件，用于后续恢复上传</span>
    fileTarget = file;
    <span class="hljs-comment">// 重置暂停状态，避免重复上传时暂停状态为true导致问题</span>
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 创建切片</span>
    <span class="hljs-keyword">const</span> tempChunks = <span class="hljs-title function_">createChunks</span>(file);
    <span class="hljs-comment">// 计算文件哈希值，并拼接文件后缀名</span>
    fileHash =
      (<span class="hljs-keyword">await</span> <span class="hljs-title function_">getHashWorker</span>(tempChunks)) + <span class="hljs-string">"."</span> + file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>).<span class="hljs-title function_">pop</span>();
    <span class="hljs-comment">// 构建切片对象数组</span>
    chunks.<span class="hljs-property">value</span> = tempChunks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunk, i</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-title function_">buildChunkName</span>(fileHash, i),
        <span class="hljs-attr">chunk</span>: <span class="hljs-title function_">markRaw</span>(chunk),
        <span class="hljs-attr">index</span>: i,
        <span class="hljs-attr">size</span>: props.<span class="hljs-property">chunkSize</span>,
        <span class="hljs-attr">uploaded</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">requestSize</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>,
        <span class="hljs-keyword">get</span> <span class="hljs-title function_">completed</span>() {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">progress</span> === <span class="hljs-number">1</span>;
        },
      };
    });
  }

  <span class="hljs-comment">// 通过文件hash检查是否已经上传了该文件</span>
  <span class="hljs-keyword">const</span> hasExist = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkFileApi</span>(fileHash);
  <span class="hljs-keyword">if</span> (hasExist) {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件已存在，无需重复上传"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 如果是暂停后恢复上传时，过滤出未上传完成的切片</span>
  <span class="hljs-keyword">const</span> waitUploadChunks = chunks.<span class="hljs-property">value</span>
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> !chunk.<span class="hljs-property">completed</span>;
    });

  <span class="hljs-comment">// 遍历未完成上传的切片</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; waitUploadChunks.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> chunk = waitUploadChunks[i] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Chunk</span>;
    <span class="hljs-keyword">const</span> name = chunk.<span class="hljs-property">name</span>;

    <span class="hljs-comment">// 创建中断请求器</span>
    <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();

    <span class="hljs-comment">// 发生请求前先验证切片是否已经上传</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">res</span>: <span class="hljs-title class_">AxiosResponse</span>&lt;{
      <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">hasExist</span>: <span class="hljs-built_in">boolean</span>;
    }&gt; = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${baseUrl}</span>/chunk/check?chunkName=<span class="hljs-subst">${name}</span>`</span>, {
      <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span>,
    });

    <span class="hljs-comment">// 暂停了直接退出for循环，且不再执行for循环后面的代码</span>
    <span class="hljs-keyword">if</span> (isPuase.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>.<span class="hljs-property">hasExist</span>) {
      chunkReqQueueList[i] = {
        <span class="hljs-comment">// 返回校验结果</span>
        <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(res),
        <span class="hljs-comment">// 校验切片是否存在中断器</span>
        abortController,
      };
      chunk.<span class="hljs-property">progress</span> = <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 切片不存在，继续上传</span>
      chunkReqQueueList[i] = <span class="hljs-title function_">uploadChunkApi</span>(chunk);
    }
  }

  <span class="hljs-keyword">if</span> (chunkReqQueueList.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
      chunkReqQueueList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">promise</span>)
    );

    <span class="hljs-comment">// 合并切片</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">mergeChunksApi</span>(fileHash);
  }
};
</code></pre>
<p><strong>buildChunkName方法</strong></p>
<p>构建和服务器达成约定的分片名称，服务器可通过<code>-</code>分割获取分片所属文件；在合并分片时可根据<code>index</code>索引进行排序合并，保证文件的完整性。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">/**
   * 构建切片名
   * <span class="hljs-doctag">@param</span> hash 文件哈希值
   * <span class="hljs-doctag">@param</span> index 切片索引
   * <span class="hljs-doctag">@returns</span> 切片名
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildChunkName</span> = (<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${hash}</span>-<span class="hljs-subst">${index}</span>`</span>;
  };
</code></pre>
<p>在开始上传的<code>startUpload</code>方法中具有两种情况，分别为<strong>开始上传</strong>和<strong>恢复上传</strong>。</p>
<p>开始上传时，执行完整的步骤；在恢复上传时，可根据开始上传时的状态，过滤出未上传的分片<code>waitUploadChunks</code>数组，再发送分片上传请求，避免不必要的性能损耗。</p>
<h3 data-id="heading-12">暂停上传文件</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 暂停切片上传</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">pauseUpload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!isPuase.<span class="hljs-property">value</span>) {
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    chunkReqQueueList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">abortController</span>) {
        req.<span class="hljs-property">abortController</span>.<span class="hljs-title function_">abort</span>(<span class="hljs-string">"用户取消上传!"</span>);
      }
    });
    <span class="hljs-comment">// 清空上传队列</span>
    chunkReqQueueList = [];
  } <span class="hljs-keyword">else</span> {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件已暂停上传！"</span>);
  }
};
</code></pre>
<h3 data-id="heading-13">恢复上传文件</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 恢复切片上传</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resumeUpload</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (fileTarget &amp;&amp; isPuase.<span class="hljs-property">value</span>) {
    isPuase.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title function_">startUpload</span>(fileTarget, <span class="hljs-literal">true</span>);
  } <span class="hljs-keyword">else</span> {
    message.<span class="hljs-title function_">warning</span>(<span class="hljs-string">"文件正在上传中！"</span>);
  }
};
</code></pre>
<h3 data-id="heading-14">ui页面构建(用法)</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bafc8e9c01864aed9f677bd5f85b4cdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=%2FIezwXzIXT5L9OINZIurqLU5sJI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">BigFileUpload.vue</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-file"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">n-upload</span> @<span class="hljs-attr">before-upload</span>=<span class="hljs-string">"onUpload"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span>&gt;</span>上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">n-upload</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>文件内容hash计算进度：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">n-progress</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"line"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"green"</span> <span class="hljs-attr">:percentage</span>=<span class="hljs-string">"hashProgress"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"percentage section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>上传进度：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">n-progress</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"line"</span> <span class="hljs-attr">:percentage</span>=<span class="hljs-string">"progress"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"actions section"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>操作：<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"default"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onPause"</span>&gt;</span>暂停<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"onResume"</span>&gt;</span>继续<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isPuase"</span>&gt;</span>已暂停<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chunk-list"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>分片上传列表<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ChunkDetail</span>
        <span class="hljs-attr">:list</span>=<span class="hljs-string">"chunks"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ChunkDetail</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NUpload</span>, <span class="hljs-title class_">NButton</span>, useMessage, <span class="hljs-title class_">NProgress</span>, <span class="hljs-title class_">NTag</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">UploadFileInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> { useBigFileUpload } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useBigFileUpload"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChunkDetail</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./ChunkDetail.vue"</span>;
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> {
  percentage,
  startUpload,
  pauseUpload,
  resumeUpload,
  chunks,
  isPuase,
  hashProgress
} = <span class="hljs-title function_">useBigFileUpload</span>();
<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">useMessage</span>();

<span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseFloat</span>(percentage.<span class="hljs-property">value</span>.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>))
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onUpload</span> = (<span class="hljs-params">data: {
  file: UploadFileInfo;
  fileList: <span class="hljs-built_in">Array</span>&lt;UploadFileInfo&gt;;
  event?: Event;
}</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  <span class="hljs-keyword">const</span> file = data.<span class="hljs-property">file</span>.<span class="hljs-property">file</span>;
  <span class="hljs-keyword">if</span> (!file) {
    message.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请选择文件!"</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-title function_">startUpload</span>(file);
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onPause</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">pauseUpload</span>();
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onResume</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">resumeUpload</span>();
};

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.upload-file</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1000px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
<span class="hljs-selector-class">.actions</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.chunk-list</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
}
<span class="hljs-selector-class">.section</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</span></code></pre>
<h4 data-id="heading-16">ChunkDetail.vue</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chunk"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-table</span> <span class="hljs-attr">:bordered</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">:single-line</span>=<span class="hljs-string">"false"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>索引<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>名称<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>分片大小(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>请求总大小(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>已上传(byte)<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>上传进度<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>是否完成<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"data in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"data.index"</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.index }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.size}}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.requestSize }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ data.uploaded }}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{{ (data.progress * 100).toFixed(2) }}%<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"data.completed"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"success"</span>&gt;</span>是<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-tag</span> <span class="hljs-attr">v-else</span>&gt;</span>否<span class="hljs-tag">&lt;/<span class="hljs-name">n-tag</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">n-table</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NTable</span>, <span class="hljs-title class_">NTag</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"naive-ui"</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">Chunk</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/useBigFileUpload"</span>;

defineProps&lt;{
  <span class="hljs-attr">list</span>: <span class="hljs-title class_">Chunk</span>[];
}&gt;();

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-17">后端实现代码</h2>
<h3 data-id="heading-18">文件上传目录示例</h3>
<blockquote>
<p>temp: 解析分片数据写入的临时目录，写入的分片可能不完整；</p>
<p>chunks: 写入完成的分片文件目录；</p>
<p>upload: 分片合并完成的文件目录；</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bff382a156b4def836c9f59007ecd54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=bRQZhw%2FiWUccJixQ0cCTJNKHhoE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-19">查询文件是否存在接口</h3>
<p>在<code>upload</code>文件夹下，通过文件hash查询，是否存在该hash文件名的文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af95c2a86d204461abc4fbb9ff1c3d42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=p2AfhHDQf%2BRl%2FgegGhMf1UceJCA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 查询mergeDir目录下是否存在上传的文件</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/check/file'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> fileHash = req.<span class="hljs-property">query</span>.<span class="hljs-property">fileHash</span>;
  <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(mergeDir, fileHash);
  <span class="hljs-keyword">const</span> hasExistFile = fs.<span class="hljs-title function_">existsSync</span>(filePath);
  <span class="hljs-keyword">if</span> (hasExistFile) {
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'文件已存在'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">true</span>
    })
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'文件不存在'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">false</span>
    })
  }
})
</code></pre>
<h3 data-id="heading-20">查询分片是否存在接口</h3>
<p>在<code>chunks</code>目录下的文件<code>hash</code>所属目录下，查询是否存在该<strong>hash索引</strong>的分片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd26b4674cb8455bb4f8e4dfe6d86ea7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdmlsYW5f5b6u5r6c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763339326&amp;x-signature=9Vj4putG4L1LkBx9rW%2BnRzh1jss%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 验证切片是否已存在接口</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/chunk/check'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {

  <span class="hljs-comment">// 切片文件名称</span>
  <span class="hljs-keyword">const</span> chunkName = req.<span class="hljs-property">query</span>.<span class="hljs-property">chunkName</span>

  <span class="hljs-comment">// 从切片文件名称中提取文件hash</span>
  <span class="hljs-keyword">const</span> fileHash = <span class="hljs-title function_">extractFileHash</span>(chunkName);

  <span class="hljs-comment">// 待合并的分片目录路径</span>
  <span class="hljs-keyword">const</span> chunkPath = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash, chunkName);

  <span class="hljs-comment">// 检查当前切片文件是否已经存在</span>
  <span class="hljs-keyword">const</span> hasExistFile = fs.<span class="hljs-title function_">existsSync</span>(chunkPath);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hasExistFile'</span>, hasExistFile, chunkPath);
  <span class="hljs-keyword">if</span> (hasExistFile) {
    <span class="hljs-comment">// 直接响应。不再执行后续中间件，如后面的回调upload.single('chunk')、切片上传成功回调</span>
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'切片已存在，跳过该切片上传'</span>,
      <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">return</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 切片不存在</span>
    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'切片不存在，继续上传'</span>, <span class="hljs-attr">hasExist</span>: <span class="hljs-literal">false</span> })
  }
  <span class="hljs-keyword">return</span> hasExistFile
})
</code></pre>
<h3 data-id="heading-21">分片上传接口</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 从分片名称提取文件hash</span>
<span class="hljs-comment">// 如：chunkName: 91a509c780df16d509e69d604292e870.mp4-0</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">extractFileHash</span>(<span class="hljs-params">chunkName</span>) {
  <span class="hljs-keyword">return</span> chunkName.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>)[<span class="hljs-number">0</span>];
}

<span class="hljs-comment">// 分片存放路径</span>
<span class="hljs-keyword">const</span> chunkDir = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'chunks'</span>);

<span class="hljs-comment">// 处理分片文件上传。</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/chunk'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {

  <span class="hljs-keyword">const</span> chunkName = req.<span class="hljs-property">query</span>.<span class="hljs-property">chunkName</span>;

  <span class="hljs-keyword">const</span> fileHash = <span class="hljs-title function_">extractFileHash</span>(chunkName);

  <span class="hljs-comment">// 判断当前目录没有temp文件夹，则创建</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-string">'./temp'</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(<span class="hljs-string">'./temp'</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  }

  <span class="hljs-comment">// 使用formidable解析表单数据</span>
  <span class="hljs-keyword">const</span> form = <span class="hljs-title function_">formidable</span>({
    <span class="hljs-attr">uploadDir</span>: <span class="hljs-string">'./temp'</span>, <span class="hljs-comment">// 临时存储路径</span>
    <span class="hljs-attr">keepExtensions</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">filename</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> chunkName
    }
  });

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 解析表单数据，并把分片写入临时目录中</span>
    <span class="hljs-keyword">const</span> [fields, files] = <span class="hljs-keyword">await</span> form.<span class="hljs-title function_">parse</span>(req);
    <span class="hljs-keyword">const</span> chunkFile = files.<span class="hljs-property">chunk</span>[<span class="hljs-number">0</span>];

    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(chunkDir)) {
      fs.<span class="hljs-title function_">mkdirSync</span>(chunkDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
    <span class="hljs-comment">// 将临时文件移动到 chunkDir 目录</span>
    <span class="hljs-keyword">const</span> fileHashDir = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash);
    <span class="hljs-keyword">const</span> targetPath = path.<span class="hljs-title function_">join</span>(fileHashDir, chunkName);
    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(fileHashDir)) {
      fs.<span class="hljs-title function_">mkdirSync</span>(fileHashDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    }
    fs.<span class="hljs-title function_">renameSync</span>(chunkFile.<span class="hljs-property">filepath</span>, targetPath)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">msg</span>: <span class="hljs-string">'分片上传失败'</span>, <span class="hljs-attr">error</span>: error });
  }

  res.<span class="hljs-title function_">send</span>({
    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'分片上传成功'</span>,
    <span class="hljs-attr">file</span>: req.<span class="hljs-property">file</span>
  });
});
</code></pre>
<h3 data-id="heading-22">合并分片接口</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 合并切片</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/merge-chunk'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { fileHash } = req.<span class="hljs-property">body</span>;
  <span class="hljs-keyword">if</span> (!fileHash) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'缺少fileHash参数'</span> });
  }
  <span class="hljs-comment">// 合并后的文件路径，如果不存在则创建该目录</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(mergeDir)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(mergeDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
  }
  <span class="hljs-keyword">const</span> mergeFilePath = path.<span class="hljs-title function_">join</span>(mergeDir, fileHash);
  <span class="hljs-keyword">const</span> chunkHashDir = path.<span class="hljs-title function_">join</span>(chunkDir, fileHash);

  <span class="hljs-comment">// 读取目录下所有切片文件，按 index 排序</span>
  <span class="hljs-keyword">const</span> chunkFilenames = fs.<span class="hljs-title function_">readdirSync</span>(chunkHashDir)
    <span class="hljs-comment">// 按 index 排序</span>
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> indexA = <span class="hljs-built_in">parseInt</span>(a.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>).<span class="hljs-title function_">pop</span>(), <span class="hljs-number">10</span>);
      <span class="hljs-keyword">const</span> indexB = <span class="hljs-built_in">parseInt</span>(b.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>).<span class="hljs-title function_">pop</span>(), <span class="hljs-number">10</span>);
      <span class="hljs-keyword">return</span> indexA - indexB;
    });

  <span class="hljs-comment">// 创建可写流，合并切片</span>
  <span class="hljs-keyword">const</span> writeStream = fs.<span class="hljs-title function_">createWriteStream</span>(mergeFilePath);
  <span class="hljs-keyword">let</span> mergedSize = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> chunkname <span class="hljs-keyword">of</span> chunkFilenames) {
      <span class="hljs-comment">// 创建可读流，读取切片</span>
      <span class="hljs-keyword">const</span> chunkPath = path.<span class="hljs-title function_">join</span>(chunkHashDir, chunkname);
      <span class="hljs-comment">// 读取切片</span>
      <span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(chunkPath);
      <span class="hljs-comment">// 写入合并后的文件</span>
      writeStream.<span class="hljs-title function_">write</span>(data);
      <span class="hljs-comment">// 累加合并后的文件大小</span>
      mergedSize += data.<span class="hljs-property">length</span>;
      <span class="hljs-comment">// 删除已合并的切片</span>
      fs.<span class="hljs-title function_">unlinkSync</span>(chunkPath);
    }
    <span class="hljs-comment">// 删除空目录</span>
    fs.<span class="hljs-title function_">rmdirSync</span>(chunkHashDir);
    <span class="hljs-comment">// 合并完成后关闭流</span>
    writeStream.<span class="hljs-title function_">end</span>();
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'合并失败!'</span>, <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> });
  }

  res.<span class="hljs-title function_">send</span>({
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'文件合并成功'</span>,
    <span class="hljs-attr">file</span>: {
      fileHash,
      <span class="hljs-attr">size</span>: mergedSize,
      <span class="hljs-attr">path</span>: mergeFilePath,
      chunkFilenames
    }
  });
});
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>本文使用文件对象的<code>slice</code>方法对大文件进行分片，使用<code>SparkMD5</code>对文件内容进行<code>hash</code>计算，并把计算过程执行在<code>Web Worker</code>线程当中，避免阻塞主线程；</p>
<p>实现<strong>分片上传</strong>的<strong>核心</strong>是使用文件<code>hash</code>和分片<strong>索引</strong>，对分片名称进行<strong>标识</strong>和<strong>排序</strong>，方便后端查找和排序分片，最后合并分片为一个完整的文件。</p>
<h2 data-id="heading-24">前后端完整源码</h2>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjava6688%2Fbig-file-upload" target="_blank" title="https://github.com/java6688/big-file-upload" ref="nofollow noopener noreferrer">大文件上传示例代码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对我来说，那个框架就是 Flutter。]]></title>    <link>https://juejin.cn/post/7570201730992472090</link>    <guid>https://juejin.cn/post/7570201730992472090</guid>    <pubDate>2025-11-10T01:26:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570201730992472090" data-draft-id="7566131671172890633" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对我来说，那个框架就是 Flutter。"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-10T01:26:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对我来说，那个框架就是 Flutter。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:26:24.000Z" title="Mon Nov 10 2025 01:26:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    52
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哪个程序员没经历过这事儿：老是心痒痒地想去试试下一个“爆款”新技术？</strong> 新框架一在 Twitter（或 X）上冒出来，博文就吹它是“颠覆者”，然后 YouTube 教程立马铺天盖地而来。</p>
<p>这种感觉我太懂了。那几年，我就是这么一个框架换一个框架地折腾——<a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2F" target="_blank" title="https://reactnative.dev/" ref="nofollow noopener noreferrer">React Native</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fionicframework.com%2F" target="_blank" title="https://ionicframework.com/" ref="nofollow noopener noreferrer">Ionic</a>，甚至还直接玩儿过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2F" target="_blank" title="https://kotlinlang.org/" ref="nofollow noopener noreferrer">Kotlin</a>。每个都说自己性能更顺畅、开发更快，或者发布应用更容易。可结果呢，每次试完一圈，我又回到了原地：<strong>人累了，思路也乱了，离我想做的项目还是一点没靠近。</strong></p>
<hr/>
<h2 data-id="heading-0">🚀 为什么我停止追逐“下一个大框架”</h2>
<p>在我下定决心使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2F" target="_blank" title="https://flutter.dev/" ref="nofollow noopener noreferrer">Flutter</a> 的时候，那种不断切换框架的循环就结束了。并不是说 Flutter 有多完美（剧透一下：它并不完美），而是因为它教会了我一个重要的道理：<strong>追逐框架给我带来的消耗，远大于它带来的好处。</strong></p>
<p>让我来告诉你，我为什么不再跑去追逐“下一个大框架”了——以及为什么坚持使用 Flutter，成了我职业生涯中最有价值的决定。</p>
<hr/>
<h3 data-id="heading-1">框架 FOMO（错失恐惧症）的陷阱</h3>
<p>开发者们特别容易陷入 <strong>FOMO（Fear of Missing Out，错失恐惧症）</strong> 的陷阱。技术圈子跑得飞快，当你看到“某公司用 Y 框架重写了他们的应用，业绩大涨”这类标题时，很容易觉得自己落伍了。</p>
<p>但关键在于：<strong>每个框架都有它的“蜜月期”</strong> 。早期使用者把它吹上天，社区热情高涨，各种教程让一切看起来毫不费力。然而，一旦你深入接触，你会发现还是老问题：工具链的各种怪癖、文档上的空白，以及那些可能耗费你数小时的随机 Bug。</p>
<p>不断切换框架让我有了<strong>广度，但没有深度</strong>。我成了一个“框架万事通，专业没一个”。而且我换得越多，实际的生产效率就越低。</p>
<hr/>
<h3 data-id="heading-2">为什么 Flutter 脱颖而出</h3>
<p>那为什么是 Flutter 呢？说实话，我不是对它一见钟情。一开始我很怀疑——“又一个跨平台框架？” 但随着我用它来做东西，有三点让我留了下来：</p>
<ul>
<li><strong>跨平台的一致性：</strong> Flutter 不只是给原生组件包一层壳。它的渲染引擎让我可以实现<strong>像素级的完美控制</strong>，无论是在 iOS、Android，甚至 Web 还是桌面端。再也不会出现那种在 Android 上看着没事，但在 iOS 上就错位的奇怪样式问题了。</li>
<li><strong>开发者体验：</strong> <strong>热重载（Hot Reload）</strong> 彻底改变了我的编码方式。快速迭代、即时看到 UI 变化、不用重启应用就能测试新想法——这感觉就像是框架在<strong>配合我</strong>工作，而不是处处跟我作对。</li>
<li><strong>社区和生态：</strong> Flutter 的社区很有热情，而且有 Google 撑腰，给了它长期的可信度。各种包（Packages）在不断成熟，文档有了巨大的进步，我很少感觉自己是在黑暗中独自摸索。</li>
</ul>
<p><strong>这一次，我不再觉得自己学的是临时性的东西了。我感觉自己是在投资一个能长久使用的工具。</strong></p>
<hr/>
<h3 data-id="heading-3">不断切换的隐性成本</h3>
<p>追逐框架不只是学习曲线带来的挫败感——它还有隐性成本：</p>
<ul>
<li><strong>脑力消耗：</strong> 每个框架都带有一套新的工具、新的调试技巧和新的怪癖。不停地切换会烧掉你的精力，而这些精力本可以用在开发真正的应用上。</li>
<li><strong>知识肤浅：</strong> 浅尝辄止多个框架意味着你很难真正精通任何一个。这在调试复杂问题或对应用进行扩展时会让你很痛苦。</li>
<li><strong>时间浪费：</strong> 说真的，用三种不同的框架把一个 Side Project 重写三次，这不叫成长。<strong>这是披着学习外衣的拖延症。</strong></li>
</ul>
<p>我意识到，我爱的其实是<strong>学习框架</strong>，而不是<strong>构建产品</strong>。Flutter 给了我所需要的稳定性，让我能重新专注于真正重要的事情：<strong>把东西交付出去（Shipping）。</strong></p>
<hr/>
<h3 data-id="heading-4">广度与深度，深度的力量</h3>
<p>坚持使用 Flutter 让我获得了深度成长，这是不断切换框架做不到的。我更深入地研究了状态管理模式、架构决策和性能优化。我做出来的 Side Project 不只是开了头，而是<strong>完成了</strong>。</p>
<p>深度带来了清晰度。我不再需要浪费时间去 Google 搜索“框架 X 怎么处理导航？”，而是对 Flutter 的生态系统了如指掌。这种信心会随着时间不断积累，让我成为一个更快、更可靠的开发者。</p>
<hr/>
<h3 data-id="heading-5">但 Flutter 是“永远的答案”吗？</h3>
<p>没有哪个框架是永恒的。Flutter 会发展，也许五到十年后会有更好的东西出现。但我学到的是，重点不在于挑选一个“完美”的框架，而在于<strong>挑选一个稳定的框架，并坚持足够长的时间去创造出有意义的作品。</strong></p>
<p>框架是工具。我们用它们创造出的价值才是最重要的。而 Flutter，恰好是我职业生涯这个阶段最适合我的工具。</p>
<hr/>
<h3 data-id="heading-6">给同行的建议</h3>
<p>如果你发现自己总是在切换框架，不妨问问自己：</p>
<ul>
<li>我是为了<strong>构建出真正的产品</strong>才学的，还是仅仅为了满足好奇心？</li>
<li>比起在一个新的生态里重新开始，我如果在一个生态里<strong>钻得更深</strong>会不会成长得更快？</li>
<li>我这种不断切换思路的成本到底有多大？</li>
</ul>
<p>探索是好的——它能让你思维更敏锐。但在某个节点，你得下定决心。对我来说，这个决心就是 <strong>Flutter</strong>。</p>
<hr/>
<h3 data-id="heading-7">最后的想法</h3>
<p>追逐“下一个大框架”感觉很刺激，但这其实就像在跑步机上。我跑得很快，但哪儿都没去。Flutter 给了我一个机会，让我可以走下跑步机，专注于真正的产品，并且作为一名开发者，<strong>获得了深度而非仅仅是广度上的成长。</strong></p>
<p>那么，我以后再也不会碰其他框架了吗？当然不是——我还会关注生态变化。但我不会再让炒作来干扰我的专注了。</p>
<p>说到底，框架来来去去。我们交付的代码、构建的应用，以及它们所创造的影响——<strong>那才是永恒的。</strong></p>
<p>对我来说，Flutter 就是帮助我实现这一切的工具。🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀]]></title>    <link>https://juejin.cn/post/7570271574348496905</link>    <guid>https://juejin.cn/post/7570271574348496905</guid>    <pubDate>2025-11-10T00:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570271574348496905" data-draft-id="7570271574348480521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-10T00:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历经4个月，基于 Tiptap 和 NestJs 打造一款 AI 驱动的智能文档协作平台 🚀🚀🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:56:07.000Z" title="Mon Nov 10 2025 00:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>当 AI 技术刚刚兴起时，我加入了一家 AI 初创公司。由于我们在项目中有着对高级编辑功能的需求，我第一次接触到了 Tiptap。让我印象深刻的是，Tiptap 与其他编辑器相比，最大亮点在于它的灵活性和可扩展性。这种高度的定制能力，让我们能够根据需求随时调整和扩展编辑器的功能，完全满足了我们的独特要求。</p>
<p>经过一段时间的研究，我渐渐认为 Tiptap 应该是我未来选择的首选编辑器。另外现在公司很久就不干了，项目也没有上线，我完全可以复刻里面的核心功能。</p>
<p>现在在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2Fdashboard" target="_blank" title="https://www.codecrack.cn/dashboard" ref="nofollow noopener noreferrer">dashboard</a> 页面上能看到的基本就是将来要实现的核心功能了。</p>
<p>首先先贴相关地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">Github 地址</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2F" target="_blank" title="https://www.codecrack.cn/" ref="nofollow noopener noreferrer">在线预览</a></p>
<p>微信联系方式或加群：<code>yunmz777</code></p>
<h2 data-id="heading-0">项目介绍</h2>
<p>DocFlow 是一个基于 Tiptap 和 Yjs 构建的智能协作写作平台，类似飞书的文档功能，支持多人实时协作编辑。平台结合了 AI 生成内容和 RAG 知识库搜索，帮助用户在创作过程中快速获取相关信息，并提供智能写作建议。</p>
<p>DocFlow 还将具备类似 Dify 的工作流编排功能，用户可以创建自动化流程，定义不同任务和操作的执行顺序，实现任务的不同输入输出。通过这个功能，团队可以高效地管理创作过程，构建智能代理（Agent）来自动处理内容生成、文档整理等任务，极大提升生产力。</p>
<p>无论是文档写作、知识管理，还是复杂流程的自动化，DocFlow 都能提供强大的支持，帮助团队优化工作流并提升创作效率。</p>
<p>项目采用的 NextJs 和 NestJs 的全栈架构，</p>
<p>首选是前端的技术栈核心主要有以下几个：</p>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2F" target="_blank" title="https://nextjs.org/" ref="nofollow noopener noreferrer">Next.js</a>：用于构建 React 应用，支持服务器端渲染（SSR）和静态生成（SSG），非常适合 SEO 优化和提升页面加载速度。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftiptap.dev%2F" target="_blank" title="https://tiptap.dev/" ref="nofollow noopener noreferrer">Tiptap</a>：现代化的富文本编辑器，支持高度定制和扩展，适合各种文档编辑需求，并与 React 集成良好。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">TailwindCSS</a>：通过实用类构建响应式和现代化界面的 CSS 框架，提高开发效率和灵活性。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.radix-ui.com%2F" target="_blank" title="https://www.radix-ui.com/" ref="nofollow noopener noreferrer">Radix UI</a>：提供高质量、无样式的 UI 组件库，帮助开发者快速构建无障碍和响应式界面。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.framer.com%2Fmotion%2F" target="_blank" title="https://www.framer.com/motion/" ref="nofollow noopener noreferrer">Framer Motion</a>： 用于 React 应用的动画库，提供丰富的动画效果，增强用户体验。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fquery" target="_blank" title="https://tanstack.com/query" ref="nofollow noopener noreferrer">React Query</a>：高效的数据获取和同步库，用于管理远程数据的加载、缓存和同步。</p>
</li>
</ol>
<p>未来做流程编排的话会使用 React Flow。</p>
<p>后端核心技术：</p>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnestjs.com%2F" target="_blank" title="https://nestjs.com/" ref="nofollow noopener noreferrer">NestJS</a>：用于构建高效、可扩展的 Node.js 后端应用，支持模块化开发和依赖注入，非常适合构建企业级应用。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fastify.io%2F" target="_blank" title="https://www.fastify.io/" ref="nofollow noopener noreferrer">Fastify</a>： 高性能、低开销的 Node.js HTTP 框架，专注于优化速度，适合高并发和高效的 API 服务。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2F" target="_blank" title="https://www.prisma.io/" ref="nofollow noopener noreferrer">Prisma</a>： 现代的 ORM 工具，提供类型安全的数据库查询支持，适用于 PostgreSQL、MySQL 等数据库。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudamqp.com%2F" target="_blank" title="https://www.cloudamqp.com/" ref="nofollow noopener noreferrer">MQ (消息队列)</a>： 用于处理异步任务和消息传递，支持高并发、高可靠性的数据传输和任务调度。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsocket.io%2F" target="_blank" title="https://socket.io/" ref="nofollow noopener noreferrer">Socket.io</a>：实时通信库，支持 WebSockets，帮助轻松实现实时消息推送和 Web 应用之间的实时通信。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain.com%2F" target="_blank" title="https://langchain.com/" ref="nofollow noopener noreferrer">Langchain</a>： 用于与多种语言模型（如 OpenAI 的 GPT）交互的框架，支持 AI 功能的集成，如文本生成、知识图谱等。</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyjs.dev%2F" target="_blank" title="https://yjs.dev/" ref="nofollow noopener noreferrer">Yjs</a>：用于构建实时协作应用的框架，支持高效的数据同步，适合实时编辑和多人协作场景。</p>
</li>
</ol>
<h4 data-id="heading-1">目录结构</h4>
<p>目录结构采用比较常见的结构：</p>
<pre><code class="hljs language-tree" lang="tree">src/
├── app/                # Next.js 应用目录，包含页面路由、布局配置等
├── components/         # 可复用的 UI 组件库
├── extensions/         # Tiptap 编辑器的自定义扩展功能
├── hooks/              # 自定义 React Hooks
├── services/           # 业务逻辑服务层（如 API 调用、请求封装等）
├── stores/             # 状态管理（如使用 Zustand、Jotai 等）
├── styles/             # 全局样式和样式模块
├── types/              # 全局 TypeScript 类型定义
├── utils/              # 工具函数、辅助方法
├── worker/             # Web Worker 实现，用于异步或性能密集型任务
└── middleware.ts       # Next.js 中间件，用于请求拦截、认证控制等
</code></pre>
<p>其中 styles 里面包含了大量的 tiptap 的 css 样式，这些 CSS 文件用于为 Tiptap 提供完整的富文本样式支持。由于 Tiptap 是无头组件，所有样式（如段落、代码块、表格、列表、协同编辑等）都需自行定义。每个 CSS 文件针对一个功能模块进行样式分离，便于维护与扩展。这种拆分方式能保持样式结构清晰、职责明确。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/716300c203454023869475fe75a8d00a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=Y%2B%2B%2BUaBYGB8O%2BRJFLg3Zuq%2FmxKI%3D" alt="20250923084026" loading="lazy"/></p>
<p>每个文件代表不同插件的样式配置。例如，<code>code.css</code> 定义了代码块 <code>&lt;pre&gt;&lt;code&gt;</code> 的样式，包括背景色、字体、行号等，适配 <code>CodeBlock</code> 插件，并支持语法高亮效果。</p>
<p>在 <code>components</code> 目录下，组件被分为两个不同的分类：</p>
<ul>
<li>
<p>src 目录中的组件是全局公共组件或业务中可复用的组件，适用于多个页面或功能模块。</p>
</li>
<li>
<p>app 目录下的组件则是针对特定页面或布局路由组的业务组件，为避免与路由冲突，推荐将这些组件命名为 <code>_components</code>。</p>
</li>
</ul>
<h4 data-id="heading-2">核心模块</h4>
<h5 data-id="heading-3">Service 封装和调用</h5>
<p>service 目录下的 <code>request.ts</code> 为全局的 <code>fetch</code> 封装：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c909afc96314e999c00f91eeef8957a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=fQJFeeFplV69XQZJgHuYP4BSeUc%3D" alt="20250923084309" loading="lazy"/></p>
<p>这段代码封装了一个基于 <code>fetch</code> 的请求工具类，支持统一的请求拦截、超时控制、错误处理和自动重试等高级功能。它提供了 <code>get</code>、<code>post</code>、<code>put</code>、<code>delete</code>、<code>patch</code> 等 HTTP 请求方法，并返回统一格式的响应结果，方便在项目中稳定复用。</p>
<p>对于不同模块的请求，可以在 services 目录下创建新的子目录进行模块化封装。例如，对于 user 模块，可以在 <code>user</code> 目录下创建 <code>index.ts</code> 来封装函数逻辑，<code>type.ts</code> 用于定义接口的入参和出参类型。通过这种方式，不同模块的请求逻辑清晰分离，便于维护和扩展。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a2a861874ea47b398e7989d94acd2c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=lEgHHPGo1xxhJuG4I0RRjZB%2BlRA%3D" alt="image.png" loading="lazy"/></p>
<p>在实际调用时，无需显式使用 <code>try...catch</code> 来捕获错误。可以通过传入不同的错误处理逻辑，统一的 <code>fetch</code> 实例会自动处理错误并执行相应的处理方式。</p>
<h5 data-id="heading-4">Tiptap</h5>
<p>借助 Tiptap 强大的扩展功能，我们可以在原有基础上轻松添加所需的功能，甚至可以在 Tiptap 上扩展整个页面。</p>
<p>创建扩展时，一般遵循以下原则：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Node</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/core"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">NodeViewWrapper</span>, <span class="hljs-comment">// 用于包装 React 组件为 NodeView</span>
  <span class="hljs-title class_">ReactNodeViewRenderer</span>, <span class="hljs-comment">// 用于包裹 React 节点，Tiptap 会识别它作为 NodeView 的容器</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@tiptap/react"</span>;

<span class="hljs-comment">// 👉 你的自定义组件（实际渲染逻辑）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyReactComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./MyReactComponent"</span>;

<span class="hljs-comment">// 👉 定义扩展</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyNode</span> = <span class="hljs-title class_">Node</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"myNode"</span>, <span class="hljs-comment">// 节点名称，必须唯一</span>
  <span class="hljs-attr">group</span>: <span class="hljs-string">"block"</span>, <span class="hljs-comment">// 节点分组，可选 block / inline / list</span>
  <span class="hljs-attr">atom</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 原子节点，不可编辑内部内容</span>
  <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽移动</span>
  <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否是 inline 类型，默认为 block</span>

  <span class="hljs-comment">// HTML -&gt; Node 映射（反序列化）</span>
  <span class="hljs-title function_">parseHTML</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> [
      {
        <span class="hljs-attr">tag</span>: <span class="hljs-string">'div[data-type="my-node"]'</span>, <span class="hljs-comment">// 将 HTML 标签映射到该节点</span>
      },
    ];
  },

  <span class="hljs-comment">// Node -&gt; HTML 映射（序列化）</span>
  <span class="hljs-title function_">renderHTML</span>(<span class="hljs-params">{ HTMLAttributes }</span>) {
    <span class="hljs-keyword">return</span> [
      <span class="hljs-string">"div"</span>,
      { ...<span class="hljs-title class_">HTMLAttributes</span>, <span class="hljs-string">"data-type"</span>: <span class="hljs-string">"my-node"</span> }, <span class="hljs-comment">// 使用自定义数据属性</span>
      <span class="hljs-string">""</span>, <span class="hljs-comment">// 空的内容，原子节点不包含可编辑内容</span>
    ];
  },

  <span class="hljs-comment">// 客户端渲染视图（NodeView）—— 仅在浏览器中执行</span>
  <span class="hljs-title function_">addNodeView</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 仅在客户端执行 NodeView 渲染</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactNodeViewRenderer</span>(<span class="hljs-title class_">MyReactComponent</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// SSR 时跳过 NodeView</span>
  },

  <span class="hljs-comment">// 自定义命令：插入该节点</span>
  <span class="hljs-title function_">addCommands</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">insertMyNode</span>:
        <span class="hljs-function">() =&gt;</span>
        <span class="hljs-function">(<span class="hljs-params">{ commands }</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> commands.<span class="hljs-title function_">insertContent</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>,
          });
        },
    };
  },
});
</code></pre>
<p>创建完成之后可以在这里添加并导出：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5dfa192c43246a4866d98f881fdf14f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=ig70A8sw1Dx63YBotOTmwN31%2BAM%3D" alt="20250923084804" loading="lazy"/></p>
<p>这两个文件都要。</p>
<h5 data-id="heading-5">Prisma</h5>
<p>Prisma 非常好用，懂的都懂，项目目前 Mysql 的架构如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396b5cbd58644d48808cc183b0574633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=4kJuiqWVpewzJwgolof7lWvtq3I%3D" alt="20250923092635" loading="lazy"/></p>
<h5 data-id="heading-6">Rabbitmq</h5>
<p>目前项目中的 AI 播客生成采用消息队列机制进行处理，主要是因为 TTS 接口存在较高的请求并发。通过使用消息队列，我们确保每次只处理一个请求，从而避免了并发请求对系统性能的影响。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f9408866724ec2b53a41cff6fe1532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=OYn%2FYzwrvM2CFO3TcFD2Wo07Nfg%3D" alt="20250923163214" loading="lazy"/></p>
<h2 data-id="heading-7">功能展示</h2>
<h3 data-id="heading-8">协同编辑</h3>
<p>协同编辑我们可以再文档这里点击文件进行分享，并且可以设置文件的权限以及是否需要密码等：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268079e703b747b98a6740683a076a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=6bat0oIBr2IGHmARjkdoLlQ33y8%3D" alt="20250923174959" loading="lazy"/></p>
<p>之后可以将这个 URL 分享给其他用户，点击之后会有这样的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a2a5660df5a49ab99276ed3f57bd504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=jc6IleveeFlQfBdzeT3PQC7tz4Y%3D" alt="20250923175045" loading="lazy"/></p>
<p>这个功能跟百度网盘之类的分享类似，这里的主要使用了 RBAC 和 ACL 进行权限控制。</p>
<p>之后我们就可以进行协同编辑了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aedcf6842f7442adb742e63b8999e8e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=jaAk2nngFKNFXrKxLtP2nHzHzHk%3D" alt="output.gif" loading="lazy"/></p>
<h3 data-id="heading-9">AI 续写和 AI 问答</h3>
<p>AI 续写和 AI 问答的功能正在逐步实现，目前以及支持 RAG 了，先看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f061b856c349cdadc722a0c9d4ab39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=AfTsVdhH2PhlPJdsWqaprUDvZZk%3D" alt="continue.gif" loading="lazy"/></p>
<p>上面的是续写的，接下来展示 AI 问答的，首先我们可以上传我们自己的一些内容：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ec71db6892c4f3d889a31052089fdc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=rjPizlOpDDlXpL3zm1NKkYIZqoQ%3D" alt="20250923182314" loading="lazy"/></p>
<p>之后我们执行 AI 问答：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e04abf36414adcbd4972c795ae604f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=xtYPv%2FqGFA8NwXfX%2FCdZDTnKk5A%3D" alt="20250923182418" loading="lazy"/></p>
<p>你可以看到我们添加的内容被我们输出到了这里了，这个就是我们当前的 RAG 的功能，当然后续会继续增强：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70bd0fd961d346009265538bd12446a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=WYGAscg5Ym1y3WnuShzabbi00fA%3D" alt="20250923182554" loading="lazy"/></p>
<p>他的原理如下流程图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1aa164498134d7ca1e138e44dfadb39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=hHBlonBxbC%2Fmpln3o6xjAIIYObw%3D" alt="image.png" loading="lazy"/></p>
<p>从文档处理角度来看，实现流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3709c07259544ada985fd43ee5640542~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=LApUV4R4An6pu04fuFc%2F56tVCjc%3D" alt="20250923183138" loading="lazy"/></p>
<h3 data-id="heading-10">AI 播客</h3>
<p>AI 播客处理流程是用户上传简历和选择相对应的面试官，但是最好是相同简历对应面试官类型，不然可能生成出来的内容乱七八糟的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3724a28049644525b0f0f8cbe0bda515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=CxZUjh6LtnI6h87Gw72%2Fh29LFm4%3D" alt="20250923183508" loading="lazy"/></p>
<h3 data-id="heading-11">其他</h3>
<p>关于编辑器里面还有很多内容没有介绍到，更多的可自行体验:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/735843b624ec4454963873465b7404ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=3eZbFrtUsiJ9v%2FdKBc3eXVx0BVE%3D" alt="20250923183627" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04ef7ba8aa0e42d8b72b454ce75a45c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=n%2Bg162vDDQBtjA20mKyQxr4f4Bo%3D" alt="20250923183658" loading="lazy"/></p>
<p>后续会继续增强，添加导入导出等功能。</p>
<h2 data-id="heading-12">未来</h2>
<p>将来要做的内容非常核心，例如侧边栏这边的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f0e6e9a0fee4ddb92a84540602f036c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763340967&amp;x-signature=qIAxFFo%2FpJo7GmJDt6I23OpX530%3D" alt="20250923183820" loading="lazy"/></p>
<p>除了前面讲了这这些 Agent 和流程编排，将来还会实现如下核心功能：</p>
<ol>
<li>
<p>添加组织，增强权限管理。</p>
</li>
<li>
<p>对应文档支持评论功能</p>
</li>
<li>
<p>接入 Sentry 埋点监控</p>
</li>
<li>
<p>后端接入 Prometheus 监控</p>
</li>
</ol>
<h2 data-id="heading-13">总结</h2>
<p>如果你对 AI 应用与富文本编辑器生态感兴趣，欢迎为本仓库点亮 Star 并开启 Watch，获取最新迭代。</p>
<p>希望了解更多服务（企业咨询、插件定制、参与开发、私有化部署等），请添加微信 <code>yunmz777</code>（备注：DocFlow）。我将邀请你进入技术交流群，与一线开发者交流实践经验、获取路线图。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">Github 地址</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codecrack.cn%2F" target="_blank" title="https://www.codecrack.cn/" ref="nofollow noopener noreferrer">在线预览</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程]]></title>    <link>https://juejin.cn/post/7570630923710054452</link>    <guid>https://juejin.cn/post/7570630923710054452</guid>    <pubDate>2025-11-10T04:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570630923710054452" data-draft-id="7570533058840739875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-11-10T04:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用AI重构了一段500行的屎山代码，这是我的Prompt和思考过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T04:06:06.000Z" title="Mon Nov 10 2025 04:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb98623d8769476daf7d1403c737a111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=Hvk6BXnS9P%2BYX5MAILrp0denCkI%3D" alt="image.png" loading="lazy"/></p>
<p>大家好，我来了🙂。</p>
<p>我们团队，维护着一个有5年历史的史诗级中后台项目😖。在这座屎山里，有一个叫<code>handleOrderSubmit.js</code>的文件。</p>
<p>可以下载瞧一瞧 有多屎👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev%2FhandleOrderSubmit.js" target="_blank" title="https://pub-e8cc0cb9ebf94a2386b76f4ac3ac6ad2.r2.dev/handleOrderSubmit.js" ref="nofollow noopener noreferrer">handleOrderSubmit.js</a></p>
<p>它是一个<strong>长达500多行</strong>的React <code>useEffect</code> 钩子函数（是的，你没看错，一个<code>useEffect</code>）。</p>
<p>它混合了订单数据的<strong>本地校验</strong>、<strong>价格计算</strong>、<strong>优惠券应用</strong>、<strong>API请求</strong>、<strong>全局状态更新</strong>、以及<strong>错误弹窗处理</strong>... 所有的逻辑，都塞在一个函数里，用<code>if/else</code>和<code>try/catch</code>层层嵌套。</p>
<p><strong>没人敢动它😖。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40160288790c4322a54fa4ec39e1a6ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=p9brzeAHElowFo7kT0xLwhguEpE%3D" alt="本事试试看.gif" loading="lazy"/></p>
<p>每次产品经理提一个小需求，比如在提交订单时，增加一种新的优惠券类型，我们整个团队的表情都像被雷劈了。因为我们知道，改这个函数，要么加班一周，要么就等着P0级事故。</p>
<p>上周，产品经理要求我们在这个函数里，加入一个全新的风控逻辑。</p>
<p>我评估了一下，手动重构，至少需要一个资深工程师一周的时间，而且风险极大。</p>
<p>我受够了。我决定，把这个烫手的任务，扔给我的实习生——<strong>AI</strong>（我用的是GPT-5 mini，穷😂）。</p>
<p>这篇文章，就是我人机协作，啃下这块硬骨头的完整复盘，大家继续看。</p>
<hr/>
<h4 data-id="heading-0"><strong>我不能直接说重构它</strong></h4>
<p>我犯的第一个错误，是直接把500行代码贴给AI，然后说：<strong>帮我重构这段代码</strong>。</p>
<p>AI很听话，它给我的，是一段看起来更整洁的代码——它把<code>if/else</code>换成了<code>switch</code>，提了几个变量... <strong>这不叫重构，这叫重新排版</strong>，毫无意义。</p>
<p>我很快意识到：<strong>AI是一个能力超强、但没有灵魂的执行者。我，作为开发者，必须给它提供一个清晰的方案。</strong></p>
<p>于是，我制定了一个<strong>五步重构法</strong>。</p>
<hr/>
<h4 data-id="heading-1"><strong>我的Prompt和思考</strong></h4>
<p>我的核心思想是：<strong>AI负责执行，我负责决策。</strong> 我要像一个指挥家一样，一步一步地引导AI，把这500行的代码，拆解成高内聚、低耦合的模块。</p>
<h5 data-id="heading-2"><strong>第一步：先让AI读懂屎山</strong></h5>
<p>我不能上来就让AI改。我得先确认，它和我对这段代码的理解，在一个频道上。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你是一个资深的React架构师。请分析下面这段500行的<code>useEffect</code>代码。</p>
<ol>
<li><strong>告诉我它做了几件主要的事情？（职责分析）</strong></li>
<li><strong>找出所有的副作用</strong>（比如API请求、<code>localStorage</code>操作、全局状态更新）。</li>
<li><strong>找出所有的纯逻辑</strong>（比如数据校验、价格计算）。</li>
<li><strong>评价它的可维护性和可测试性</strong>。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d5a1e7897d4611b2e6063d63081384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=aXLE5rLPbGHmYg3X5B3MvGtaHaM%3D" alt="image.png" loading="lazy"/></p>
<p>GPT的回答，给了我一个惊喜。它清晰地列出了：</p>
<ol>
<li><strong>职责</strong>：它承担了至少5个职责：表单校验、价格计算、库存检查、创建订单、处理UI反馈。</li>
<li><strong>副作用</strong>：<code>api.post(...)</code>, <code>setLoading(true)</code>, <code>showToast(...)</code>...</li>
<li><strong>纯逻辑</strong>：<code>validateForm(...)</code>, <code>calculateTotalPrice(...)</code>...</li>
<li><strong>评价</strong>：可维护性极低，单一职责原则被严重违反，几乎不可测试。</li>
</ol>
<p>很好，AI看懂了！我们就可以可以开始了😁。</p>
<h5 data-id="heading-3"><strong>第二步：先分离纯逻辑代码</strong></h5>
<p>这是最关键的一步。我要把计算和动作分开。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>非常好。现在，请你<strong>只针对纯逻辑部分</strong>（表单校验、价格计算）进行重构。</p>
<ol>
<li>把这些逻辑，从原函数中<strong>提取</strong>出来，变成<strong>独立的、可导出的纯函数</strong>。</li>
<li>这些函数必须是纯的：<strong>不能有任何副作用</strong>（不能调用<code>api</code>或<code>setLoading</code>）。</li>
<li><strong>使用TypeScript</strong>，为这些新函数的入参和返回值，提供清晰的类型定义。</li>
</ol>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d384affa5b6b488db2870ea7a7f2e350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763352366&amp;x-signature=yC3uRhUdQgDBQbR2mBv1aKp6ZuM%3D" alt="image.png" loading="lazy"/></p>
<p>AI立刻唰唰唰地给了我几个文件：</p>
<p><code>validate.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateOrder</span>(<span class="hljs-params">formData: OrderForm</span>): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">if</span> (!formData.<span class="hljs-property">user</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'用户信息不能为空'</span>;
  <span class="hljs-keyword">if</span> (formData.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'商品不能为空'</span>;
  <span class="hljs-comment">// ... 10 more rules</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><code>calculator.ts</code>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotalPrice</span>(<span class="hljs-params">items: Item[], coupon: Coupon</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">let</span> total = items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (coupon.<span class="hljs-property">type</span> === <span class="hljs-string">'PERCENT'</span>) {
    total *= (<span class="hljs-number">1</span> - coupon.<span class="hljs-property">value</span> / <span class="hljs-number">100</span>);
  }
  <span class="hljs-comment">// ... 20 more rules</span>
  <span class="hljs-keyword">return</span> total;
}
</code></pre>
<h5 data-id="heading-4"><strong>第三步：让AI为自己的代码做测试</strong></h5>
<p>我怎么知道AI提炼的逻辑，是对的还是错的？
<strong>答案：让它自己写单元测试来证明。</strong></p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>你现在是一个QA工程师。请使用<code>Vitest</code>，为你刚才提取的<code>validateOrder</code>和<code>calculateTotalPrice</code>这两个函数，<strong>编写全面的单元测试用例</strong>。
必须覆盖所有边界情况，包括正常、异常、和边缘值。</p>
</blockquote>
<p>AI再次给了我惊喜。它生成的测试用例，比我手写的还要全：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// calculator.test.ts</span>
<span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>;
<span class="hljs-keyword">import</span> { calculateTotalPrice } <span class="hljs-keyword">from</span> <span class="hljs-string">'./calculator'</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'calculateTotalPrice'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should return 0 for empty cart'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>([], <span class="hljs-literal">null</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>);
  });
  
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should apply percent coupon'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> items = [{ <span class="hljs-attr">price</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span> }];
    <span class="hljs-keyword">const</span> coupon = { <span class="hljs-attr">type</span>: <span class="hljs-string">'PERCENT'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> };
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">calculateTotalPrice</span>(items, coupon)).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">90</span>);
  });
  <span class="hljs-comment">// ... 省略更多</span>
});
</code></pre>
<p>我把这些测试用例跑了一遍，<strong>全部通过</strong>。我现在信心大增😁。</p>
<h5 data-id="heading-5"><strong>第四步：重写协调层</strong></h5>
<p>现在，纯逻辑已经被分离并验证了。原来的500行屎山，只剩下副作用和流程控制代码了。是时候重写它了。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>干得漂亮。现在，我们来重构那个<strong>原始的<code>useEffect</code>函数</strong>。</p>
<ol>
<li>它现在唯一的职责是<strong>协调</strong>。</li>
<li><strong>调用</strong>我们刚才创建的<code>validateOrder</code>和<code>calculateTotalPrice</code>纯函数。</li>
<li>把所有的副作用（API请求、<code>setLoading</code>、<code>showToast</code>）<strong>清晰地编排</strong>起来。</li>
<li><strong>使用<code>async/await</code></strong>，让异步流程更清晰，用<code>try/catch</code>处理错误。</li>
</ol>
</blockquote>
<p>这次，AI给我的，是一个只有<strong>30行</strong>左右的、清晰的流程代码：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 重构后的 useEffect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submitOrder</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 协调：验证 (纯)</span>
      <span class="hljs-keyword">const</span> errorMsg = <span class="hljs-title function_">validateOrder</span>(formData);
      <span class="hljs-keyword">if</span> (errorMsg) {
        <span class="hljs-title function_">showToast</span>(errorMsg);
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 2. 协调：计算 (纯)</span>
      <span class="hljs-keyword">const</span> totalPrice = <span class="hljs-title function_">calculateTotalPrice</span>(formData.<span class="hljs-property">items</span>, formData.<span class="hljs-property">coupon</span>);

      <span class="hljs-comment">// 3. 协调：副作用（不纯）</span>
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/order/submit'</span>, { ...formData, totalPrice });
      
      <span class="hljs-comment">// 4. 协调：响应（不纯）</span>
      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
        <span class="hljs-title function_">showToast</span>(<span class="hljs-string">'订单提交成功！'</span>);
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/success'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">showToast</span>(result.<span class="hljs-property">message</span>);
      }
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">showToast</span>(err.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };

  <span class="hljs-keyword">if</span> (isSubmitting) { <span class="hljs-comment">// 假设一个触发条件</span>
    <span class="hljs-title function_">submitOrder</span>();
    <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">false</span>);
  }
}, [isSubmitting, formData <span class="hljs-comment">/* ...其他依赖 */</span>]);
</code></pre>
<h5 data-id="heading-6"><strong>第五步：最后守卫工作，加入新功能</strong></h5>
<p>别忘了，我重构的目的，是为了加风控这个新功能。</p>
<p><strong>Prompt：</strong></p>
<blockquote>
<p>最后一步。请在API请求之前，加入一个风控检查的逻辑（调用<code>riskControl.check(...)</code>）。这是一个异步函数，如果检查不通过，它会抛出一个错误。</p>
</blockquote>
<p>AI在第2步和第3步之间，加了几行代码，完美收工。</p>
<hr/>
<p>这次重构，我总共花了大概5个小时，而不是原计划的一周。</p>
<p>总觉得 AI 不会淘汰会写代码的工程师。</p>
<p>只会降维打击那些只会堆砌代码的工程师。</p>
<p>那段500行的屎山，在过去，是我的噩梦；现在，有了AI的帮助，它变成了我的靶场。</p>
<p>这种感觉，真爽🙌。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道]]></title>    <link>https://juejin.cn/post/7570191839593332799</link>    <guid>https://juejin.cn/post/7570191839593332799</guid>    <pubDate>2025-11-10T00:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570191839593332799" data-draft-id="7564573165705216015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-10T00:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 2.x 和 3.x 的核心区别，这些变化你必须知道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:34:08.000Z" title="Mon Nov 10 2025 00:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是大华！有很多朋友不知道<code>Springboot2.x和3.x</code>有什么区别，用着感觉都差不多。其实3.x是一个重大版本升级。</p>
<h4 data-id="heading-1">为什么 Spring Boot 3.x 这么重要？</h4>
<p>因为它不仅仅是加了几个新功能，而是<strong>整个技术地基都变了</strong>。</p>
<p>下面我们举几个例子来了解一下。</p>
<hr/>
<h3 data-id="heading-2">1. 包名的更新：<code>javax</code> → <code>jakarta</code></h3>
<p>这是2.x升级到3.x时，<strong>改动最大的地方</strong>。</p>
<h4 data-id="heading-3">Spring Boot 2.x（老代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;

<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<h4 data-id="heading-4">Spring Boot 3.x（新代码）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> jakarta.persistence.Entity;  <span class="hljs-comment">// 注意：javax → jakarta</span>
<span class="hljs-keyword">import</span> jakarta.persistence.Id;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest; <span class="hljs-comment">// 同样变了</span>

<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<p><strong>划重点</strong>：</p>
<ul>
<li>所有 <code>javax.*</code> 都要改成 <code>jakarta.*</code>！</li>
<li>如果你用的是 JPA、Servlet、Validation 等技术，<strong>几乎每个 Java 文件都要改</strong>。</li>
<li>建议使用 IDE 的全局替换功能，但要小心第三方库是否支持。</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. 安全配置</h3>
<p>Spring Boot 3.x 默认使用 <strong>Spring Security 6</strong>，配置方式大变。</p>
<h4 data-id="heading-6">Spring Boot 2.x 配置方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeRequests()
                .antMatchers(<span class="hljs-string">"/public/**"</span>).permitAll()
                .anyRequest().authenticated()
            .and()
            .formLogin();
    }
}
</code></pre>
<p>注意：<code>WebSecurityConfigurerAdapter</code>在<code>Spring Security 6</code>中<strong>已被废弃</strong>！</p>
<h4 data-id="heading-7">Spring Boot 3.x 推荐方式（使用 Lambda DSL）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">filterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeHttpRequests(authz -&gt; authz
                .requestMatchers(<span class="hljs-string">"/public/**"</span>).permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -&gt; form
                .loginPage(<span class="hljs-string">"/login"</span>)
                .permitAll()
            );
        <span class="hljs-keyword">return</span> http.build();
    }
}
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>更函数式，代码更清晰。</li>
<li>不用继承，更灵活。</li>
<li>编译时就能发现错误，而不是运行时报错。</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. 原生镜像（GraalVM）</h3>
<p>Spring Boot 3.x 原生支持 GraalVM，可以把 Java 应用编译成<strong>原生可执行文件</strong>。</p>
<h4 data-id="heading-9">如何启用原生镜像？</h4>
<p>在 <code>pom.xml</code> 中加入插件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">./mvnw -Pnative native:compile
</code></pre>
<p>编译完成后，你会得到一个<strong>不依赖 JVM 的可执行文件</strong>，比如 <code>myapp</code>。</p>
<p>运行它：</p>
<pre><code class="hljs language-bash" lang="bash">./myapp
</code></pre>
<p>你会发现：</p>
<ul>
<li>启动时间：从 5 秒 → <strong>0.1 秒</strong></li>
<li>内存占用：从 300MB → <strong>50MB</strong></li>
</ul>
<p>特别适合：Serverless、微服务、边缘计算等资源敏感场景。</p>
<hr/>
<h3 data-id="heading-10">4. 云原生支持：Liveness 和 Readiness</h3>
<p>Spring Boot 3.x 的健康检查更专业，适合 Kubernetes。</p>
<h4 data-id="heading-11">配置 <code>application.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">health:</span>
      <span class="hljs-attr">show-details:</span> <span class="hljs-string">always</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info,liveness,readiness</span>
</code></pre>
<h4 data-id="heading-12">访问新端点</h4>
<ul>
<li><code>GET /actuator/health/liveness</code> → 检查应用是否“活着”（是否崩溃）</li>
<li><code>GET /actuator/health/readiness</code> → 检查应用是否“就绪”（是否可以接收流量）</li>
</ul>
<p>K8s 可以用这两个接口做更精准的健康检查，避免误杀或误导流。</p>
<hr/>
<h3 data-id="heading-13">那我现在该升级吗？</h3>
<p>看情况！分两种：</p>
<h4 data-id="heading-14">推荐升级的情况：</h4>
<ul>
<li><strong>新项目</strong>：直接上 Spring Boot 3.x + Java 17！</li>
<li><strong>想玩原生镜像</strong>：追求极致性能和启动速度。</li>
<li><strong>云原生项目</strong>：用 K8s、微服务架构。</li>
</ul>
<h4 data-id="heading-15">暂缓升级的情况：</h4>
<ul>
<li><strong>还在用 Java 8</strong>：必须先升级 JDK。</li>
<li><strong>依赖老旧库</strong>：比如某些中间件 SDK 还不支持 <code>jakarta</code>。</li>
<li><strong>项目稳定，无大改动</strong>：可以等下次大版本迭代时再升级。</li>
</ul>
<hr/>
<h3 data-id="heading-16">总结对比表</h3>








































<table><thead><tr><th>特性</th><th>Spring Boot 2.x</th><th>Spring Boot 3.x</th></tr></thead><tbody><tr><td><strong>最低 Java 版本</strong></td><td>Java 8</td><td><strong>Java 17</strong></td></tr><tr><td><strong>包名</strong></td><td><code>javax.*</code></td><td><code>jakarta.*</code></td></tr><tr><td><strong>原生镜像</strong></td><td>不支持</td><td><strong>原生支持</strong></td></tr><tr><td><strong>Spring Security</strong></td><td>继承 <code>WebSecurityConfigurerAdapter</code></td><td>使用 <strong>DSL 配置</strong></td></tr><tr><td><strong>云原生支持</strong></td><td><code>/health</code></td><td><code>/liveness</code>, <code>/readiness</code></td></tr><tr><td><strong>未来支持</strong></td><td>逐渐停止</td><td><strong>主推版本</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">最后一句话</h3>
<p>SpringBoot3.x不是可选项，而是<strong>Java 开发现代化的必经之路</strong>。</p>
<p>早点了解，早点准备，别等到公司要求升级时，你还在问“<code>javax</code>和<code>jakarta</code>有啥区别？”</p>
<p>另外<code>SpringBoot4.x</code>很快就发布正式版了，可以关注一下。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-18">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy-GJ26kl0-yT6hE3fy2KjQ" target="_blank" title="https://mp.weixin.qq.com/s/y-GJ26kl0-yT6hE3fy2KjQ" ref="nofollow noopener noreferrer">《MySQL 为什么不推荐用雪花ID 和 UUID 做主键？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1Th3DuMqYpt4Xg5hEywIww" target="_blank" title="https://mp.weixin.qq.com/s/1Th3DuMqYpt4Xg5hEywIww" ref="nofollow noopener noreferrer">《用html写了个超好用的网页主题切换插件》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfSMv8b_2Z-kozaBeiCgqrA" target="_blank" title="https://mp.weixin.qq.com/s/fSMv8b_2Z-kozaBeiCgqrA" ref="nofollow noopener noreferrer">《SpringBoot3+Vue3实现的数据库文档工具》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[几种虚拟列表技术方案调研]]></title>    <link>https://juejin.cn/post/7570162686580523050</link>    <guid>https://juejin.cn/post/7570162686580523050</guid>    <pubDate>2025-11-10T01:55:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162686580523050" data-draft-id="7569798982941999140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="几种虚拟列表技术方案调研"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-10T01:55:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            几种虚拟列表技术方案调研
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T01:55:17.000Z" title="Mon Nov 10 2025 01:55:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<h3 data-id="heading-1">什么是虚拟列表？</h3>
<p>虚拟列表（Virtual List）是一种优化长列表渲染性能的技术。其核心思想是<strong>只渲染可见区域的列表项</strong>，而不是渲染所有数据。当用户滚动时，动态地创建和销毁 DOM 元素，从而大幅减少 DOM 节点数量，提升渲染性能。</p>
<p>本篇文章中，笔者从Vue3的技术框架来讲解虚拟列表不同场景中的用法，不涉及虚拟列表的原理。社区里有很多讲解虚拟列表的原理的文章，笔者不再赘述。笔者从虚拟列表的分类上统筹每一种虚拟列表技术方案，并给出参考示例。</p>
<h3 data-id="heading-2">为什么使用虚拟列表？</h3>
<p><strong>传统列表的性能瓶颈：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 渲染 10000 条数据</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i)

<span class="hljs-comment">// ❌ 传统方式：创建 10000 个 DOM 节点</span>
&lt;div v-<span class="hljs-keyword">for</span>=<span class="hljs-string">"item in items"</span> :key=<span class="hljs-string">"item"</span>&gt;{{ item }}&lt;/div&gt;
<span class="hljs-comment">// 结果：首次渲染缓慢、滚动卡顿、内存占用高</span>
</code></pre>
<p><strong>虚拟列表的优势：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 虚拟列表：只渲染可见的 ~10-20 个节点</span>
<span class="hljs-comment">// 即使有 10000 条数据，DOM 中只有可见区域的节点</span>
<span class="hljs-comment">// 结果：快速渲染、流畅滚动、低内存占用</span>
</code></pre>
<h3 data-id="heading-3">@vueuse/core 简介</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2F" target="_blank" title="https://vueuse.org/" ref="nofollow noopener noreferrer">@vueuse/core</a> 是一个强大的 Vue 3 组合式 API 工具集，其中 <code>useVirtualList</code> 提供了开箱即用的虚拟列表解决方案。后续所有的示例代码均使用 <code>useVirtualList</code> 实现</p>
<p><strong>快速开始</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install @vueuse/core
<span class="hljs-comment"># 或</span>
pnpm add @vueuse/core
</code></pre>
<p>不得不说，Vue的技术生态中，很多第三方依赖开箱即用，这一点非常棒！</p>
<h2 data-id="heading-4">useVirtualList API 详解</h2>
<h3 data-id="heading-5">基本用法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useVirtualList } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(
  items,    <span class="hljs-comment">// 数据源</span>
  options   <span class="hljs-comment">// 配置选项</span>
)
</code></pre>
<h3 data-id="heading-6">参数说明</h3>
<h4 data-id="heading-7">items (必需)</h4>
<p><strong>类型：</strong> <code>MaybeRef&lt;T[]&gt;</code><br/>
<strong>说明：</strong> 要渲染的数据数组，可以是响应式引用或普通数组</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式 1: 响应式引用</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, ...])

<span class="hljs-comment">// 方式 2: 普通数组</span>
<span class="hljs-keyword">const</span> items = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, ...]

<span class="hljs-comment">// 方式 3: computed</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> originalData.<span class="hljs-title function_">filter</span>(...))
</code></pre>
<h4 data-id="heading-8">options (必需)</h4>
<p><strong>类型：</strong> <code>UseVirtualListOptions</code></p>























<table><thead><tr><th>选项</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>itemHeight</code></td><td><code>number | (index: number) =&gt; number</code></td><td><strong>必需</strong></td><td>项目高度，可以是固定值或计算函数</td></tr><tr><td><code>overscan</code></td><td><code>number</code></td><td><code>5</code></td><td>预渲染的额外项目数量，提升滚动流畅度</td></tr></tbody></table>
<h3 data-id="heading-9">返回值说明</h3>
<h4 data-id="heading-10">list</h4>
<p><strong>类型：</strong> <code>ComputedRef&lt;ListItem&lt;T&gt;[]&gt;</code><br/>
<strong>说明：</strong> 当前应该渲染的列表项数组</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span>&lt;T&gt; {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 在原数组中的索引</span>
  <span class="hljs-attr">data</span>: T         <span class="hljs-comment">// 原始数据</span>
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-for="item in list" :key="item.index"&gt;
  &lt;div&gt;索引: {{ item.index }}&lt;/div&gt;
  &lt;div&gt;数据: {{ item.data }}&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-11">containerProps (非常重要)</h4>
<p><strong>类型：</strong> <code>Object</code><br/>
<strong>说明：</strong> 需要绑定到容器元素的属性对象</p>
<p><strong>包含属性：</strong></p>
<ul>
<li><code>ref</code>: 容器的引用</li>
<li><code>onScroll</code>: 滚动事件处理函数</li>
<li><code>style</code>: 容器样式（可能包含 overflow 等）</li>
</ul>
<p><strong>使用方式：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps" style="height: 400px; overflow-y: auto;"&gt;
  &lt;!-- 内容 --&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-12">wrapperProps (非常重要)</h4>
<p><strong>类型：</strong> <code>Object</code><br/>
<strong>说明：</strong> 需要绑定到包装器元素的属性对象</p>
<p><strong>包含属性：</strong></p>
<ul>
<li><code>style</code>: 包装器样式，包含计算的总高度</li>
</ul>
<p><strong>作用：</strong></p>
<ul>
<li>设置内部容器的总高度（基于所有项目的总高度）</li>
<li>创建正确的滚动区域</li>
<li>支持虚拟化定位</li>
</ul>
<p><strong>使用方式：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps"&gt;
  &lt;div v-bind="wrapperProps"&gt;
    &lt;!-- 列表项 --&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-13">工作原理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5900c2e31e3b4f7cafe7d17c335d4d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763345274&amp;x-signature=xqul89Zk8kzLIxbUgnhlULmCCJI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键点：</strong></p>
<ol>
<li><strong>容器（Container）：</strong> 固定高度，overflow 可滚动</li>
<li><strong>包装器（Wrapper）：</strong> 高度 = 所有项目的总高度</li>
<li><strong>列表项：</strong> 只渲染可见区域的项目 （useVirtualList返回的 listitems）</li>
</ol>
<h2 data-id="heading-14">四种虚拟列表实现方案</h2>
<p>经过笔者的调研，主要有四种虚拟列表技术方案</p>
<h3 data-id="heading-15">固定项高度 + 固定容器高度</h3>
<h4 data-id="heading-16">📌 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 固定（如 50px）</li>
<li><strong>容器高度：</strong> 固定（如 400px）</li>
<li><strong>适用场景：</strong> 标准列表、表格、聊天记录等统一高度的场景</li>
</ul>
<h4 data-id="heading-17">🎯 适用场景</h4>

























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>数据列表</td><td>表格数据、商品列表、用户列表</td></tr><tr><td>日志查看器</td><td>系统日志、操作记录</td></tr><tr><td>聊天记录</td><td>简单文本消息列表</td></tr><tr><td>文件浏览器</td><td>文件/文件夹列表</td></tr></tbody></table>
<h4 data-id="heading-18">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>FixedHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  itemHeight: {
    type: Number,
    default: 50,
  },
  containerHeight: {
    type: Number,
    default: 400,
  },
});

const container = ref(null);

// 🔑 关键配置：itemHeight 为固定数值
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: props.itemHeight,  // 固定高度
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ height: `${containerHeight}px` }"  &lt;!-- 固定容器高度 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${itemHeight}px` }"  &lt;!-- 固定项目高度 --&gt;
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow: hidden;  /* 🔑 关键：overflow hidden */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}

.virtual-list-item {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-19">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import FixedHeightVirtualList from './components/FixedHeightVirtualList.vue'

const items = ref(
  Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;FixedHeightVirtualList
    :items="items"
    :item-height="50"
    :container-height="400"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-20">✅ 优点</h4>
<ul>
<li>实现简单，性能最优</li>
<li>滚动最流畅</li>
<li>计算开销最小</li>
</ul>
<h4 data-id="heading-21">❌ 缺点</h4>
<ul>
<li>所有项目必须高度一致</li>
<li>容器高度固定，不够灵活</li>
</ul>
<hr/>
<h3 data-id="heading-22">固定项高度 + 动态容器高度</h3>
<h4 data-id="heading-23">🌊 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 固定（如 50px）</li>
<li><strong>容器高度：</strong> 动态自适应（max-height）</li>
<li><strong>适用场景：</strong> 响应式布局、下拉菜单、弹窗列表</li>
</ul>
<h4 data-id="heading-24">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>下拉选择器</td><td>数据量不确定的下拉列表</td></tr><tr><td>搜索建议</td><td>搜索结果列表（数量动态变化）</td></tr><tr><td>弹窗列表</td><td>Modal 中的列表内容</td></tr><tr><td>侧边栏菜单</td><td>响应式侧边导航</td></tr><tr><td>响应式布局</td><td>需要适应不同屏幕尺寸</td></tr></tbody></table>
<h4 data-id="heading-25">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>DynamicHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  itemHeight: {
    type: Number,
    default: 50,
  },
  maxHeight: {
    type: Number,
    default: 500,
  },
});

const container = ref(null);

// 🔑 关键配置：itemHeight 为固定数值
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: props.itemHeight,
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ maxHeight: `${maxHeight}px` }"  &lt;!-- 🔑 max-height 实现动态 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${itemHeight}px` }"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow-y: auto;  /* 🔑 关键：overflow-y auto */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-26">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import DynamicHeightVirtualList from './components/DynamicHeightVirtualList.vue'

// 数据量少
const fewItems = ref(
  Array.from({ length: 4 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)

// 数据量多
const manyItems = ref(
  Array.from({ length: 1000 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;!-- 数据少时，容器高度 = 4 * 50 = 200px --&gt;
  &lt;DynamicHeightVirtualList
    :items="fewItems"
    :item-height="50"
    :max-height="400"
  /&gt;

  &lt;!-- 数据多时，容器高度 = max-height = 400px，出现滚动条 --&gt;
  &lt;DynamicHeightVirtualList
    :items="manyItems"
    :item-height="50"
    :max-height="400"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-27">🔄 关键差异对比</h4>






























<table><thead><tr><th>属性</th><th>固定容器</th><th>动态容器</th></tr></thead><tbody><tr><td>容器样式</td><td><code>height: 400px</code></td><td><code>max-height: 400px</code></td></tr><tr><td>overflow</td><td><code>overflow: hidden</code></td><td><code>overflow-y: auto</code></td></tr><tr><td>数据少时</td><td>仍占据 400px</td><td>自动缩小</td></tr><tr><td>数据多时</td><td>显示滚动条</td><td>显示滚动条</td></tr></tbody></table>
<h4 data-id="heading-28">✅ 优点</h4>
<ul>
<li>容器高度自适应，更灵活</li>
<li>数据少时不浪费空间</li>
<li>性能依然优秀</li>
</ul>
<h4 data-id="heading-29">❌ 缺点</h4>
<ul>
<li>需要正确处理 overflow-y</li>
<li>布局可能因高度变化而跳动</li>
</ul>
<hr/>
<h3 data-id="heading-30">动态项高度 + 固定容器高度</h3>
<h4 data-id="heading-31">🎨 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 动态计算（通过函数）</li>
<li><strong>容器高度：</strong> 固定（如 450px）</li>
<li><strong>适用场景：</strong> 多样化内容、卡片列表、复杂布局</li>
</ul>
<h4 data-id="heading-32">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>新闻列表</td><td>标题长度不一，内容预览不同</td></tr><tr><td>卡片流</td><td>不同类型的卡片高度不同</td></tr><tr><td>评论列表</td><td>评论内容长度不一</td></tr><tr><td>商品展示</td><td>不同商品信息复杂度不同</td></tr><tr><td>邮件列表</td><td>带附件、标签等额外信息</td></tr></tbody></table>
<h4 data-id="heading-33">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>VariableHeightVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  containerHeight: {
    type: Number,
    default: 400,
  },
});

const container = ref(null);

// 🔑 关键：动态计算每个项的高度
const getItemHeight = (index) =&gt; {
  // 方式 1: 根据索引模式
  const heightPattern = index % 3;
  if (heightPattern === 0) return 60;  // 小项
  if (heightPattern === 1) return 80;  // 中项
  return 100;                          // 大项
  
  // 方式 2: 根据数据内容
  // const item = props.items[index];
  // return item.type === 'large' ? 100 : 50;
  
  // 方式 3: 根据文本长度
  // const textLength = props.items[index].text.length;
  // return Math.max(50, Math.ceil(textLength / 20) * 30);
};

// 🔑 关键配置：itemHeight 为函数
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: getItemHeight,  // 函数，不是数值！
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ height: `${containerHeight}px` }"
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${getItemHeight(item.index)}px` }"  &lt;!-- 动态高度 --&gt;
        :data-height="getItemHeight(item.index)"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;div class="item-info"&gt;
            &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
            &lt;span class="item-height-tag"&gt;高度: {{ getItemHeight(item.index) }}px&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow: hidden;
}

/* 根据高度添加不同的视觉样式 */
.virtual-list-item[data-height="60"] {
  background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

.virtual-list-item[data-height="80"] {
  background: linear-gradient(135deg, #e6f7ff 0%, #ffffff 100%);
}

.virtual-list-item[data-height="100"] {
  background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-34">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import VariableHeightVirtualList from './components/VariableHeightVirtualList.vue'

const items = ref(
  Array.from({ length: 400 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;VariableHeightVirtualList
    :items="items"
    :container-height="450"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-35">🎨 高度计算函数示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例 1: 基于索引的规律模式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + (index % <span class="hljs-number">3</span>) * <span class="hljs-number">25</span>;  <span class="hljs-comment">// 50, 75, 100 循环</span>
};

<span class="hljs-comment">// 示例 2: 基于数据类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">switch</span>(item.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'header'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">80</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'content'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">120</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'footer'</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">60</span>;
    <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">50</span>;
  }
};

<span class="hljs-comment">// 示例 3: 基于内容长度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">const</span> textLength = item.<span class="hljs-property">description</span>?.<span class="hljs-property">length</span> || <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> lines = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(textLength / <span class="hljs-number">40</span>);  <span class="hljs-comment">// 假设每行 40 字符</span>
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + (lines - <span class="hljs-number">1</span>) * <span class="hljs-number">20</span>;  <span class="hljs-comment">// 基础高度 + 额外行高度</span>
};

<span class="hljs-comment">// 示例 4: 基于属性组合</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">let</span> height = <span class="hljs-number">60</span>;  <span class="hljs-comment">// 基础高度</span>
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasImage</span>) height += <span class="hljs-number">200</span>;
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasTags</span>) height += <span class="hljs-number">30</span>;
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">hasActions</span>) height += <span class="hljs-number">40</span>;
  <span class="hljs-keyword">return</span> height;
};
</code></pre>
<h4 data-id="heading-36">⚠️ 重要注意事项</h4>
<ol>
<li><strong>高度必须可预测：</strong> <code>getItemHeight(index)</code> 对同一个 index 必须始终返回相同的值</li>
<li><strong>性能考虑：</strong> 函数会被频繁调用，避免复杂计算</li>
<li><strong>实际高度匹配：</strong> CSS 实际高度必须与计算高度一致</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：随机高度（不可预测）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">50</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">50</span>;  <span class="hljs-comment">// 每次调用结果不同！</span>
};

<span class="hljs-comment">// ❌ 错误：异步计算</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>(index);  <span class="hljs-comment">// 不支持异步！</span>
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">height</span>;
};

<span class="hljs-comment">// ✅ 正确：可预测、同步</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">return</span> props.<span class="hljs-property">items</span>[index].<span class="hljs-property">preCalculatedHeight</span>;  <span class="hljs-comment">// 提前计算好的高度</span>
};
</code></pre>
<h4 data-id="heading-37">✅ 优点</h4>
<ul>
<li>支持不同高度的项目</li>
<li>容器高度固定，布局稳定</li>
<li>视觉效果更丰富</li>
</ul>
<h4 data-id="heading-38">❌ 缺点</h4>
<ul>
<li>高度必须提前可计算</li>
<li>不支持真正的动态内容（如图片加载后才知道高度）</li>
<li>计算开销略高于固定高度</li>
</ul>
<hr/>
<h3 data-id="heading-39">动态项高度 + 动态容器高度</h3>
<h4 data-id="heading-40">🌈 方案特点</h4>
<ul>
<li><strong>项目高度：</strong> 动态计算（通过函数）</li>
<li><strong>容器高度：</strong> 动态自适应（max-height）</li>
<li><strong>适用场景：</strong> 最灵活的场景，结合前三种优势</li>
</ul>
<h4 data-id="heading-41">🎯 适用场景</h4>





























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>复杂弹窗</td><td>弹窗内的复杂列表，高度不确定</td></tr><tr><td>搜索结果</td><td>不同类型的搜索结果混合</td></tr><tr><td>通知中心</td><td>不同类型通知，数量动态变化</td></tr><tr><td>购物车</td><td>不同商品信息，数量动态</td></tr><tr><td>活动页面</td><td>不同类型的活动卡片</td></tr></tbody></table>
<h4 data-id="heading-42">💻 完整实现代码</h4>
<p><strong>组件代码：</strong> <code>FullyDynamicVirtualList.vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from "vue";
import { useVirtualList } from "@vueuse/core";

const props = defineProps({
  items: {
    type: Array,
    default: () =&gt; [],
    required: true,
  },
  maxHeight: {
    type: Number,
    default: 500,
  },
});

const container = ref(null);

// 🔑 关键：动态计算每个项的高度
const getItemHeight = (index) =&gt; {
  const heightPattern = index % 3;
  if (heightPattern === 0) return 60;
  if (heightPattern === 1) return 80;
  return 100;
};

// 🔑 关键配置：itemHeight 为函数 + 容器使用 max-height
const { list, containerProps, wrapperProps } = useVirtualList(props.items, {
  itemHeight: getItemHeight,
  overscan: 5,
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div
    ref="container"
    class="virtual-list-container"
    :style="{ maxHeight: `${maxHeight}px` }"  &lt;!-- 🔑 max-height 动态容器 --&gt;
    v-bind="containerProps"
  &gt;
    &lt;div class="virtual-list-wrapper" v-bind="wrapperProps"&gt;
      &lt;div
        v-for="item in list"
        :key="item.index"
        class="virtual-list-item"
        :style="{ height: `${getItemHeight(item.index)}px` }"
        :data-height="getItemHeight(item.index)"
      &gt;
        &lt;div class="item-content"&gt;
          &lt;span class="item-index"&gt;{{ item.data.id }}&lt;/span&gt;
          &lt;div class="item-info"&gt;
            &lt;span class="item-text"&gt;{{ item.data.name }}&lt;/span&gt;
            &lt;span class="item-height-tag"&gt;高度: {{ getItemHeight(item.index) }}px&lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.virtual-list-container {
  overflow-y: auto;  /* 🔑 关键：overflow-y auto */
  border: 1px solid #e8e8e8;
  border-radius: 8px;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-43">📝 使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import FullyDynamicVirtualList from './components/FullyDynamicVirtualList.vue'

const items = ref(
  Array.from({ length: 200 }, (_, index) =&gt; ({
    id: index + 1,
    name: `项目 ${index + 1}`
  }))
)
&lt;/script&gt;

&lt;template&gt;
  &lt;FullyDynamicVirtualList
    :items="items"
    :max-height="600"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-44">🎯 适配不同数据量</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;!-- 数据少：容器自动缩小 --&gt;
  &lt;FullyDynamicVirtualList
    :items="[1, 2, 3]"
    :max-height="400"
  /&gt;
  &lt;!-- 实际高度约: 60 + 80 + 100 = 240px --&gt;

  &lt;!-- 数据多：容器达到最大高度，显示滚动条 --&gt;
  &lt;FullyDynamicVirtualList
    :items="Array(200)"
    :max-height="400"
  /&gt;
  &lt;!-- 实际高度: 400px (max-height) --&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-45">✅ 优点</h4>
<ul>
<li>最大的灵活性</li>
<li>项目高度可变</li>
<li>容器高度自适应</li>
<li>适应各种复杂场景</li>
</ul>
<h4 data-id="heading-46">❌ 缺点</h4>
<ul>
<li>实现相对复杂</li>
<li>需要同时处理两种动态性</li>
<li>性能略低于前三种方案</li>
</ul>
<hr/>
<h2 data-id="heading-47">性能对比与最佳实践</h2>
<h3 data-id="heading-48">性能对比</h3>








































<table><thead><tr><th>方案</th><th>性能</th><th>灵活性</th><th>实现难度</th><th>适用场景</th></tr></thead><tbody><tr><td>固定+固定</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐</td><td>⭐</td><td>标准列表</td></tr><tr><td>固定+动态</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>⭐⭐</td><td>响应式布局</td></tr><tr><td>动态+固定</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐</td><td>多样化内容</td></tr><tr><td>动态+动态</td><td>⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td><td>复杂场景</td></tr></tbody></table>
<h3 data-id="heading-49">渲染效率对比</h3>
<p><strong>测试条件：</strong> 10,000 条数据</p>















































<table><thead><tr><th>方案</th><th>DOM 节点数</th><th>首次渲染时间</th><th>滚动 FPS</th><th>内存占用</th></tr></thead><tbody><tr><td>传统列表</td><td>10,000</td><td>~2000ms</td><td>&lt;30 FPS</td><td>~50MB</td></tr><tr><td>虚拟列表（固定+固定）</td><td>~15</td><td>~50ms</td><td>60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（固定+动态）</td><td>~15</td><td>~50ms</td><td>60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（动态+固定）</td><td>~15</td><td>~60ms</td><td>55-60 FPS</td><td>~5MB</td></tr><tr><td>虚拟列表（动态+动态）</td><td>~15</td><td>~60ms</td><td>55-60 FPS</td><td>~5MB</td></tr></tbody></table>
<h3 data-id="heading-50">方案选择决策树</h3>
<pre><code class="hljs">开始
  │
  ├─ 所有项目高度是否相同？
  │   ├─ 是 ──&gt; 容器高度是否固定？
  │   │         ├─ 是 ──&gt; 【方案1: 固定+固定】最优性能 ⭐⭐⭐⭐⭐
  │   │         └─ 否 ──&gt; 【方案2: 固定+动态】响应式布局 ⭐⭐⭐⭐⭐
  │   │
  │   └─ 否 ──&gt; 容器高度是否固定？
  │             ├─ 是 ──&gt; 【方案3: 动态+固定】多样化内容 ⭐⭐⭐⭐
  │             └─ 否 ──&gt; 【方案4: 动态+动态】最大灵活性 ⭐⭐⭐⭐
</code></pre>
<h3 data-id="heading-51">最佳实践</h3>
<h4 data-id="heading-52">overscan 参数调优</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础配置</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>  <span class="hljs-comment">// 默认值，适合大多数场景</span>

<span class="hljs-comment">// 快速滚动场景</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">10</span>  <span class="hljs-comment">// 增加预渲染，防止白屏</span>

<span class="hljs-comment">// 性能敏感场景</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">3</span>  <span class="hljs-comment">// 减少预渲染，降低开销</span>

<span class="hljs-comment">// 移动端</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">8</span>  <span class="hljs-comment">// 移动端滚动更快，建议增加</span>
</code></pre>
<h4 data-id="heading-53">高度计算缓存</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：每次都计算</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">calculateComplexHeight</span>(item);  <span class="hljs-comment">// 复杂计算</span>
};

<span class="hljs-comment">// ✅ 推荐：缓存计算结果</span>
<span class="hljs-keyword">const</span> heightCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">if</span> (heightCache.<span class="hljs-title function_">has</span>(index)) {
    <span class="hljs-keyword">return</span> heightCache.<span class="hljs-title function_">get</span>(index);
  }
  
  <span class="hljs-keyword">const</span> item = props.<span class="hljs-property">items</span>[index];
  <span class="hljs-keyword">const</span> height = <span class="hljs-title function_">calculateComplexHeight</span>(item);
  heightCache.<span class="hljs-title function_">set</span>(index, height);
  <span class="hljs-keyword">return</span> height;
};

<span class="hljs-comment">// 数据变化时清除缓存</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>, <span class="hljs-function">() =&gt;</span> {
  heightCache.<span class="hljs-title function_">clear</span>();
}, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-54">响应式优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：直接传入响应式对象</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">reactive</span>([...]);

<span class="hljs-comment">// ✅ 推荐：使用 ref</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([...]);

<span class="hljs-comment">// ✅ 更好：使用 shallowRef（大数据量）</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>([...]);
</code></pre>
<h4 data-id="heading-55">大数据量优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 数据量 &gt; 50,000 时的优化策略</span>

<span class="hljs-comment">// 1. 使用 shallowRef</span>
<span class="hljs-keyword">const</span> items = <span class="hljs-title function_">shallowRef</span>(largeDataArray);

<span class="hljs-comment">// 2. 增加 overscan</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">15</span>

<span class="hljs-comment">// 3. 防抖滚动事件（如果需要自定义处理）</span>
<span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">useDebounceFn</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 处理滚动</span>
}, <span class="hljs-number">16</span>);  <span class="hljs-comment">// 约 60fps</span>

<span class="hljs-comment">// 4. 虚拟滚动条（可选）</span>
<span class="hljs-comment">// 使用自定义滚动条替代原生滚动条</span>
</code></pre>
<h4 data-id="heading-56">避免常见错误</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误 1：在模板中直接访问原数组</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in items"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 错误！应该用 list --&gt;</span>
    {{ item }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// ✅ 正确：使用 list</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 正确！--&gt;</span>
    {{ item.data }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="hljs-comment">// ❌ 错误 2：忘记绑定 props</span>
&lt;div class="container"&gt;  &lt;!-- 错误！缺少 v-bind --&gt;
  &lt;div class="wrapper"&gt;  &lt;!-- 错误！缺少 v-bind --&gt;

// ✅ 正确：绑定 containerProps 和 wrapperProps
&lt;div v-bind="containerProps"&gt;
  &lt;div v-bind="wrapperProps"&gt;

// ❌ 错误 3：高度计算不准确
.item {
  height: 50px;
  padding: 10px;  /* 实际高度 = 50 + 20 = 70px */
}

// ✅ 正确：确保计算高度包含 padding/border
itemHeight: 70  // 或使用 box-sizing: border-box
</code></pre>
<hr/>
<h2 data-id="heading-57">常见问题与解决方案</h2>
<h3 data-id="heading-58">滚动位置跳动</h3>
<p><strong>问题：</strong> 滚动时列表位置跳动</p>
<p><strong>原因：</strong> 计算高度与实际高度不匹配</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 使用 box-sizing: border-box</span>
.<span class="hljs-property">virtual</span>-list-item {
  box-<span class="hljs-attr">sizing</span>: border-box;
  <span class="hljs-attr">height</span>: 50px;  <span class="hljs-comment">/* 包含 padding 和 border */</span>
  <span class="hljs-attr">padding</span>: 10px;
}

<span class="hljs-comment">// 2. 确保高度计算准确</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getItemHeight</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> baseHeight = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">const</span> padding = <span class="hljs-number">20</span>;  <span class="hljs-comment">// top + bottom</span>
  <span class="hljs-keyword">const</span> border = <span class="hljs-number">2</span>;    <span class="hljs-comment">// top + bottom</span>
  <span class="hljs-keyword">return</span> baseHeight + padding + border;
};
</code></pre>
<h3 data-id="heading-59">首次渲染白屏</h3>
<p><strong>问题：</strong> 首次加载时短暂白屏</p>
<p><strong>原因：</strong> overscan 太小或数据加载慢</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 增加 overscan</span>
<span class="hljs-attr">overscan</span>: <span class="hljs-number">10</span>

<span class="hljs-comment">// 2. 添加骨架屏</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SkeletonItem</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"i in 10"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"i"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"containerProps"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 虚拟列表 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="hljs-comment">// 3. 预加载数据</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  items.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
});
</code></pre>
<h3 data-id="heading-60">滚动到指定位置</h3>
<p><strong>问题：</strong> 如何滚动到指定索引的项目</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方法 1: 计算滚动位置（固定高度）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">const</span> scrollTop = index * itemHeight;
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
};

<span class="hljs-comment">// 方法 2: 计算滚动位置（动态高度）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-keyword">let</span> scrollTop = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
    scrollTop += <span class="hljs-title function_">getItemHeight</span>(i);
  }
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
};

<span class="hljs-comment">// 方法 3: 使用 scrollIntoView</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToIndex</span> = (<span class="hljs-params">index</span>) =&gt; {
  <span class="hljs-comment">// 需要在 list 中找到对应的元素</span>
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`[data-index="<span class="hljs-subst">${index}</span>"]`</span>);
  element?.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-attr">block</span>: <span class="hljs-string">'start'</span> });
};
</code></pre>
<h3 data-id="heading-61">数据更新后滚动位置重置</h3>
<p><strong>问题：</strong> 数据更新后滚动位置跳回顶部</p>
<p><strong>原因：</strong> items 引用变化导致重新计算</p>
<p><strong>解决方案：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：直接赋值新数组</span>
items.<span class="hljs-property">value</span> = newData;  <span class="hljs-comment">// 引用变化，滚动位置重置</span>

<span class="hljs-comment">// ✅ 正确：保持引用，修改内容</span>
<span class="hljs-comment">// 方法 1: 使用 splice</span>
items.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, items.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>, ...newData);

<span class="hljs-comment">// 方法 2: 逐项更新</span>
newData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> {
  items.<span class="hljs-property">value</span>[index] = item;
});

<span class="hljs-comment">// 方法 3: 记录并恢复滚动位置</span>
<span class="hljs-keyword">const</span> scrollTop = container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>;
items.<span class="hljs-property">value</span> = newData;
<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  container.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = scrollTop;
});
</code></pre>
<h3 data-id="heading-62">在 TypeScript 中使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { ref, <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useVirtualList, <span class="hljs-title class_">UseVirtualListOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItem</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  description?: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">ListItem</span>[]&gt; = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Item 1'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Item 2'</span> }
])

<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">UseVirtualListOptions</span> = {
  <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>,
  <span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>
}

<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(items, options)

<span class="hljs-comment">// list 的类型是 ComputedRef&lt;{ index: number; data: ListItem }[]&gt;</span>
</code></pre>
<h3 data-id="heading-63">服务端渲染 (SSR) 支持</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 SSR 环境中，需要注意以下几点：</span>

<span class="hljs-comment">// 1. 容器高度必须明确</span>
&lt;div :style=<span class="hljs-string">"{ height: '400px' }"</span>&gt;  &lt;!-- <span class="hljs-variable constant_">SSR</span> 需要明确高度 --&gt;

<span class="hljs-comment">// 2. 避免在服务端计算滚动</span>
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupVirtualList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">return</span>  <span class="hljs-comment">// SSR 环境跳过</span>
  
  <span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(...)
  <span class="hljs-keyword">return</span> { list, containerProps, wrapperProps }
}

<span class="hljs-comment">// 3. 使用 ClientOnly 组件（Nuxt.js）</span>
&lt;<span class="hljs-title class_">ClientOnly</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VirtualList</span> <span class="hljs-attr">:items</span>=<span class="hljs-string">"items"</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ClientOnly</span>&gt;
</code></pre>
<hr/>
<h2 data-id="heading-64">总结与对比表</h2>
<h3 data-id="heading-65">四种方案完整对比</h3>











































































<table><thead><tr><th>特性</th><th>固定+固定</th><th>固定+动态</th><th>动态+固定</th><th>动态+动态</th></tr></thead><tbody><tr><td><strong>项目高度</strong></td><td>固定值</td><td>固定值</td><td>函数计算</td><td>函数计算</td></tr><tr><td><strong>容器高度</strong></td><td>height</td><td>max-height</td><td>height</td><td>max-height</td></tr><tr><td><strong>overflow</strong></td><td>hidden</td><td>auto</td><td>hidden</td><td>auto</td></tr><tr><td><strong>itemHeight</strong></td><td><code>50</code></td><td><code>50</code></td><td><code>(i) =&gt; ...</code></td><td><code>(i) =&gt; ...</code></td></tr><tr><td><strong>性能评分</strong></td><td>5/5</td><td>5/5</td><td>4/5</td><td>4/5</td></tr><tr><td><strong>灵活性评分</strong></td><td>2/5</td><td>3/5</td><td>4/5</td><td>5/5</td></tr><tr><td><strong>实现难度</strong></td><td>简单</td><td>简单</td><td>中等</td><td>中等</td></tr><tr><td><strong>典型应用</strong></td><td>表格</td><td>下拉菜单</td><td>卡片列表</td><td>复杂弹窗</td></tr><tr><td><strong>数据量建议</strong></td><td>无限制</td><td>无限制</td><td>&lt; 100,000</td><td>&lt; 100,000</td></tr></tbody></table>
<h3 data-id="heading-66">API 参数速查表</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useVirtualList 配置</span>
<span class="hljs-keyword">const</span> { list, containerProps, wrapperProps } = <span class="hljs-title function_">useVirtualList</span>(items, {
  <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span> | (<span class="hljs-function">(<span class="hljs-params">index: number</span>) =&gt;</span> number),  <span class="hljs-comment">// 必需</span>
  <span class="hljs-attr">overscan</span>: <span class="hljs-number">5</span>                                     <span class="hljs-comment">// 可选，默认 5</span>
})
</code></pre>
<h3 data-id="heading-67">关键代码片段速查</h3>
<h4 data-id="heading-68">固定高度配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">itemHeight</span>: <span class="hljs-number">50</span>
</code></pre>
<h4 data-id="heading-69">动态高度配置</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">itemHeight</span>: <span class="hljs-function">(<span class="hljs-params">index</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> index % <span class="hljs-number">2</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">60</span> : <span class="hljs-number">80</span>
}
</code></pre>
<h4 data-id="heading-70">固定容器</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div :style="{ height: '400px' }" v-bind="containerProps"&gt;
</code></pre>
<h4 data-id="heading-71">动态容器</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div :style="{ maxHeight: '400px' }" v-bind="containerProps"&gt;
</code></pre>
<h4 data-id="heading-72">完整模板结构</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;div v-bind="containerProps" :style="{ height: '400px' }"&gt;
  &lt;div v-bind="wrapperProps"&gt;
    &lt;div v-for="item in list" :key="item.index"&gt;
      {{ item.data }}
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-73">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2F" target="_blank" title="https://vueuse.org/" ref="nofollow noopener noreferrer">VueUse 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2Fcore%2FuseVirtualList%2F" target="_blank" title="https://vueuse.org/core/useVirtualList/" ref="nofollow noopener noreferrer">useVirtualList API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FPerformance%2FVirtualization" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Performance/Virtualization" ref="nofollow noopener noreferrer">虚拟滚动原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FIntersection_Observer_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API" ref="nofollow noopener noreferrer">Intersection Observer API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAkryum%2Fvue-virtual-scroller" target="_blank" title="https://github.com/Akryum/vue-virtual-scroller" ref="nofollow noopener noreferrer">vue-virtual-scroller</a> - 功能更强大，支持真正的动态高度</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbvaughn%2Freact-window" target="_blank" title="https://github.com/bvaughn/react-window" ref="nofollow noopener noreferrer">react-window</a> - React 生态的虚拟列表库（参考对比）</li>
</ul>
<h2 data-id="heading-74">完整项目结构</h2>
<pre><code class="hljs language-csharp" lang="csharp">vue3-sample/
├── src/
│   ├── components/
│   │   ├── FixedHeightVirtualList.vue       <span class="hljs-meta"># 固定+固定</span>
│   │   ├── DynamicHeightVirtualList.vue     <span class="hljs-meta"># 固定+动态</span>
│   │   ├── VariableHeightVirtualList.vue    <span class="hljs-meta"># 动态+固定</span>
│   │   └── FullyDynamicVirtualList.vue      <span class="hljs-meta"># 动态+动态</span>
│   ├── App.vue                               <span class="hljs-meta"># 使用示例</span>
│   └── main.js
├── docs/
│   └── <span class="hljs-keyword">virtual</span>-list-guide.md                 <span class="hljs-meta"># 本文档</span>
├── package.json
└── README.md
</code></pre>
<h2 data-id="heading-75">快速开始</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/ilcherry/virtuallist-examples

<span class="hljs-comment"># 2. 安装依赖</span>
<span class="hljs-built_in">cd</span> vue3-sample
pnpm install

<span class="hljs-comment"># 3. 运行开发服务器</span>
pnpm dev

<span class="hljs-comment"># 4. 访问</span>
<span class="hljs-comment"># 打开浏览器访问 http://localhost:5173</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7713a4ca37da45889fc95437abf5910a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iez566A566A:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763345274&amp;x-signature=a0IXGeB36N62EduHDm7pdDQ21lw%3D" alt="localhost_5173_.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！]]></title>    <link>https://juejin.cn/post/7570405675432935424</link>    <guid>https://juejin.cn/post/7570405675432935424</guid>    <pubDate>2025-11-10T00:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570405675432935424" data-draft-id="7569909335908761609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！"/> <meta itemprop="keywords" content="后端,Cursor,MCP"/> <meta itemprop="datePublished" content="2025-11-10T00:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方圆想当图灵"/> <meta itemprop="url" content="https://juejin.cn/user/386633160473101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 无法跨项目读取源码怎么办？MCP Easy Code Reader 帮你解决！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386633160473101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方圆想当图灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T00:17:35.000Z" title="Mon Nov 10 2025 00:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    102
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <strong>方圆</strong>。本篇文章主要介绍 MCP Server <strong>Easy Code Reader</strong>，它可以帮助你在使用 Cursor/VSCode/IDEA 编写代码时，根据调用链路将多个项目或 Jar 包中相关的代码读取到上下文中，供 Code Agent 帮我们分析逻辑和编写代码，而无需再手动将源码复制到对话框中发送给 AI，提高 Code Agent 准确度和编码效率。MCP 已发布 Github 和 MCP.so，欢迎大家前往下载使用：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">Github: easy-code-reader</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">github.com/FangYuan33/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">MCP.so: Easy Code Reader</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">mcp.so/server/easy…</a></li>
</ul>
<p>在介绍如何接入 Easy Code Reader 之前，我们先来看看它到底能做什么：</p>
<h3 data-id="heading-0">Easy Code Reader 最佳实践</h3>
<p>Easy Code Reader 特别适合与 Claude、ChatGPT 等大模型配合使用，接下来以 Copilot Code Agent 结合 Claude4.5 模型为例，介绍一些最佳实践：</p>
<h4 data-id="heading-1">1. 跨项目调用，根据调用链路分析源码</h4>
<p>在比较复杂的项目中一般会拆分多个微服务，某些功能的实现可能会跨多个项目调用，如果靠人梳理相关逻辑会比较耗时，所以可以将涉及的代码 clone 到本地后使用 Easy Code Reader MCP 并结合 Code Agent 进行分析。接下来我们以 Nacos 项目为例，假设我们想了解 Nacos 的服务注册功能是如何实现的，可以按照以下步骤操作：</p>
<p>首先，比如我们创建了一个 Nacos Client 客户端，在这段逻辑中执行服务注册：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Main.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NacosException, InterruptedException {
        logger.info(<span class="hljs-string">"开始初始化 Nacos 客户端..."</span>);

        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="hljs-string">"127.0.0.1:8848"</span>);
        properties.put(PropertyKeyConst.NAMESPACE, <span class="hljs-string">"7430d8fe-99ce-4b20-866e-ed021a0652c9"</span>);

        <span class="hljs-type">NamingService</span> <span class="hljs-variable">namingService</span> <span class="hljs-operator">=</span> NacosFactory.createNamingService(properties);

        System.out.println(<span class="hljs-string">"=== 注册服务实例 ==="</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个服务实例</span>
            namingService.registerInstance(<span class="hljs-string">"test-service0"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">8080</span>);
            <span class="hljs-comment">// 添加事件监听器</span>
            namingService.subscribe(<span class="hljs-string">"test-service"</span>, event -&gt; {
                System.out.println(<span class="hljs-string">"服务实例变化: "</span> + event);
            });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"服务注册失败(预期，因为服务器可能未启动): "</span> + e.getMessage());
        }

        TimeUnit.HOURS.sleep(<span class="hljs-number">3</span>);
    }
}
</code></pre>
<p>因为我们创建 Nacos Client 执行服务注册时是由 Nacos 提供的 SDK 直接调用 <code>NamingService#registerInstance</code> 方法实现的，我们并不清楚底层是如何实现的，如果我们想要了解实现细节，那么可以将 Nacos 的源码 Clone 下来，并使用 Easy Code Reader 读取相关源码，下面是一个示例 Prompt：</p>
<pre><code class="hljs language-text" lang="text">你是一位 Java 专家，请你帮我分析 #file:Main.java 中 namingService.registerInstance 方法的逻辑，这段逻辑的实现在本地项目的 nacos 中，所以你需要在 nacos 读取一系列相关的源码才能了解它的核心逻辑，读取 nacos 项目的代码你可以借助 easy-code-reader MCP，其中包含你可以获取项目信息、项目中所有的文件信息和某个文件的工具
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be97ddfbf9741beb2a970d0add5d12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=be2xGWHfCln7%2BByZcuXPYDNBI28%3D" alt="img.png" loading="lazy"/></p>
<p>如图所示，它会不断地根据源码调用链路，读取相关源码并进行分析，最终我们就能了解服务注册的实现细节，会使用到 MCP Easy Code Reader 提供的多个工具 <code>list_all_project</code>、<code>list_project_files</code> 和 <code>read_project_code</code>， 具体调用细节图示如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/199bdefe268e44239bf176494d5e5629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=BMAcqma6TG3bAiLSWchFWWiY7sc%3D" alt="image.png" loading="lazy"/></p>
<p>最终得到分析结果，节省很多时间：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6272d0af8547a7a8904df6ab85419d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=5JtLHqWBDU%2FXPNnGomiHvxLNJGY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">2. 阅读 jar 包源码，根据源码完成代码编写</h4>
<p>在使用第三方或其他外部依赖时，Copilot 或其他 Code Agent 并不能直接读取 jar 包中的源码，往往需要我们将源码内容手动复制到提示词中才能完成，费时费力。在 Easy Code Reader 中提供了 <code>read_jar_source</code> 工具来读取 jar 包中的源码，帮我们完成开发实现。我们还是以如下代码为例，现在我想实现多个服务实例的注册，但是我又不了解 <code>NamingService</code> 的实现，便可以借助 <code>read_jar_source</code> 来完成：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(Main.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NacosException, InterruptedException {
        logger.info(<span class="hljs-string">"开始初始化 Nacos 客户端..."</span>);

        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="hljs-string">"127.0.0.1:8848"</span>);
        properties.put(PropertyKeyConst.NAMESPACE, <span class="hljs-string">"7430d8fe-99ce-4b20-866e-ed021a0652c9"</span>);

        <span class="hljs-type">NamingService</span> <span class="hljs-variable">namingService</span> <span class="hljs-operator">=</span> NacosFactory.createNamingService(properties);

        System.out.println(<span class="hljs-string">"=== 注册服务实例 ==="</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个服务实例</span>
            namingService.registerInstance(<span class="hljs-string">"test-service0"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">8080</span>);
            <span class="hljs-comment">// 添加事件监听器</span>
            namingService.subscribe(<span class="hljs-string">"test-service"</span>, event -&gt; {
                System.out.println(<span class="hljs-string">"服务实例变化: "</span> + event);
            });
            <span class="hljs-comment">// 注册多个服务实例</span>

        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"服务注册失败(预期，因为服务器可能未启动): "</span> + e.getMessage());
        }

        TimeUnit.HOURS.sleep(<span class="hljs-number">3</span>);
    }
}
</code></pre>
<pre><code class="hljs language-text" lang="text">你是一位 Java 技术专家，精通 Nacos 框架，请你帮我在 #file:Main.java 中完成注册多个服务实例的逻辑，在编写代码前，你需要先使用 easy-code-reader 的 read_jar_source 工具读取 com.alibaba.nacos.api.naming.NamingService 的源码信息来了解注册多个服务实例的方法
</code></pre>
<p>处理过程如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5660f4ee0073455cb83fed66a7dd0658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763427930&amp;x-signature=W4sOhDWciJmY5HLfkXj4BmGmM%2Bo%3D" alt="image.png" loading="lazy"/></p>
<p>这样我们便能够快速地了解 <code>NamingService</code> 的实现细节，从而完成代码编写工作，节省了大量时间。</p>
<h4 data-id="heading-3">3. 跨项目阅读源码，根据源码完成本项目实现</h4>
<p>在大型项目中，某些功能的实现可能会跨多个模块或微服务，如果部分逻辑已经实现并且后续其他应用的逻辑需要依赖这部分逻辑时，可以借助 Easy Code Reader 读取相关模块的源码，帮助我们更好地理解和实现当前项目的功能，示例 Prompt 如下：</p>
<pre><code class="hljs language-text" lang="text">你是一位 Java 技术专家，现在我要实现 XXX 的业务逻辑，这部分逻辑的实现需要调用本地项目 A 中 XXX 的接口及其实现，请你借助 MCP easy-code-reader 来帮我读取 A 项目中的源码，并帮我实现 XXX 的业务逻辑
</code></pre>
<p>当然除了这三种应用场景以外，还可以使用 Easy Code Reader 完成以下事项：</p>
<ul>
<li><strong>异常问题快速溯源</strong>：如果有异常信息是外部 jar 包依赖中抛出来的，可以使用 <code>read_jar_source</code> 工具根据异常堆栈日志快速定位异常点</li>
<li><strong>依赖升级影响评估（旧/新版本差异核对）</strong>：同样是使用 <code>read_jar_source</code> 工具来完成新旧版本的实现差异，评估升级影响</li>
<li><strong>业务代码逻辑评审</strong>：如果业务逻辑开发实现在多个项目中，可以借助读取本地项目代码的工具 <code>list_all_project</code>、<code>list_project_files</code> 和 <code>read_project_code</code>，来分析新增的逻辑是否满足业务要求</li>
<li><strong>新人快速上手多个微服务</strong>：借助读取本地项目代码的工具，可以根据接口调用链路快速理清微服务项目代码之间的关系，提高上手速度</li>
</ul>
<hr/>
<p>既然它有这么多的应用场景，那么我们该如何接入 Easy Code Reader 呢？下面我们来介绍一下接入步骤：</p>
<p><a id="user-content-quick-start-uvx" title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target="/></p>
<h3 data-id="heading-4">快速接入（方法一）：使用 uvx（推荐 - 开箱即用）</h3>
<p>它的环境要求如下：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv</a> - Python 包和项目管理工具</li>
<li>Python 3.10 或更高版本</li>
<li>Java Development Kit (JDK) - 用于运行反编译器，要求至少 Java 8</li>
</ul>
<p>如果您还没有安装 uv，可以通过以下方式快速安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS/Linux</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># Windows</span>
powershell -c <span class="hljs-string">"irm https://astral.sh/uv/install.ps1 | iex"</span>

<span class="hljs-comment"># 或使用 pip</span>
pip install uv
</code></pre>
<p>或者参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv 官网</a> 进行安装，并配置 uv 的安装路径添加到系统 PATH 中，以便可以直接使用 <code>uvx</code> 命令。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv</a> 是一个极快的 Python 包和项目管理工具。使用 <code>uvx</code> 可以无需预先安装，直接运行，参考以下 MCP 客户端配置：</p>
<ul>
<li><code>--maven-repo</code>: 指定 Maven 仓库路径，将 <code>/custom/path/to/maven/repository</code> 内容替换为本地 Maven 仓库路径即可，不配置默认使用 <strong>MAVEN_HOME</strong> 目录或 <code>~/.m2/repository</code></li>
<li><code>--project-dir</code>: 指定本地项目目录路径，将 <code>/customer/path/to/project-dir</code> 替换为实际保存所有项目的路径</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"easy-code-reader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uvx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"easy-code-reader"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--maven-repo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/custom/path/to/maven/repository"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--project-dir"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/customer/path/to/project-dir"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>将以上内容配置好后，AI 助手即可通过 MCP 协议调用 Easy Code Reader 提供的工具，完成多项目、多依赖的 Java 源代码读取工作。</p>
<h3 data-id="heading-5">快速接入（方法二）：使用 uv 安装到本地（不推荐）</h3>
<p>如果使用 <strong>快速接入（方法一）</strong> 安装运行失败，那么可以采用直接安装到本地的方法，运行如下命令：</p>
<pre><code class="hljs language-bash" lang="bash">uv tool install easy-code-reader
</code></pre>
<p>安装成功后，执行以下命令获取安装目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">which</span> easy-code-reader
</code></pre>
<p>比如，输出结果是：/Users/fangyuan/.local/bin/easy-code-reader，那么需要按照如下方式配置 MCP 客户端：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"easy-code-reader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/fangyuan/.local/bin/easy-code-reader"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"--maven-repo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/custom/path/to/maven/repository"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--project-dir"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"/customer/path/to/project-dir"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一般这样操作都能完成安装，后续如果有版本更新，可以通过以下命令进行升级：</p>
<pre><code class="hljs language-bash" lang="bash">uv tool install --upgrade easy-code-reader
</code></pre>
<h3 data-id="heading-6">常见问题</h3>
<h4 data-id="heading-7">Q1: spawn uvx ENOENT spawn uvx ENOENT</h4>
<p>uv 命令未找到，确保已正确安装 uv 并将其路径添加到系统 PATH 中，参考 <a href="#quick-start-uvx" title="#quick-start-uvx">快速接入（方法一）</a>，并尝试重启 IDE 后再启动 MCP Server。</p>
<hr/>
<p>以上内容就是 MCP Easy Code Reader 的介绍和接入方法，接下来的内容主要介绍一下它的实现原理，感兴趣的朋友可以继续往下看。</p>
<h3 data-id="heading-8">Easy Code Reader 实现原理</h3>
<p>其实编写一个 MCP Server 并不复杂，大家可以参考这篇 Github 上的文章 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FliaokongVFX%2FMCP-Chinese-Getting-Started-Guide" target="_blank" title="https://github.com/liaokongVFX/MCP-Chinese-Getting-Started-Guide" ref="nofollow noopener noreferrer">Model Context Protocol(MCP) 编程极速入门</a>。Easy Code Reader 通过 Python 语言实现，它提供了 4 个主要工具来协同完成源码读取工作：</p>
<ol>
<li><code>list_all_project</code>: <strong>列出所有本地项目</strong>，这个工具能将配置的项目目录 <code>--project-dir</code> 下所有的文件夹都读取出来，每个文件夹代表一个项目，这样 Code Agent 便能根据项目名称来选择需要读取的项目</li>
<li><code>list_project_files</code>: <strong>列出指定项目中的所有文件名</strong>，这个工具能将指定项目下的所有源码文件名都读取出来，Code Agent 便能根据调用链路选择需要读取的文件</li>
<li><code>read_project_code</code>: <strong>读取指定项目中的某个文件源码</strong>，通过以上两个工具，Code Agent 能够定位到需要读取的文件，然后使用这个工具将源码内容读取出来，供 Code Agent 进行分析</li>
<li><code>read_jar_source</code>: <strong>读取指定 jar 包中的某个类源码</strong>，如果调用链路中有外部 jar 包依赖的话，Code Agent 便可以使用这个工具将 jar 包中的源码读取出来，供分析和编写代码</li>
</ol>
<p>这四个工具协同工作，便能实现跨项目、多依赖的源码读取工作，帮助 Code Agent 更好地理解代码逻辑，从而提高代码编写效率和准确度，以下是 MCP Tool 实现的技术细节：</p>
<h4 data-id="heading-9">list_all_project</h4>
<p>列举项目目录下所有的项目文件夹名称。</p>
<p><strong>用途：</strong></p>
<ul>
<li>查看所有可用的项目</li>
<li>当输入不完整的项目名时，帮助推理出最接近的项目名</li>
<li>验证项目是否存在</li>
<li>支持项目名称模糊匹配，快速查找特定项目</li>
</ul>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_dir</code> (可选): 项目目录路径，如未提供则使用启动时配置的路径</li>
<li><code>project_name_pattern</code> (可选): 项目名称模糊匹配模式（不区分大小写），用于过滤项目列表
<ul>
<li>支持左右模糊匹配，例如 <code>nacos</code> 将匹配包含 <code>nacos</code>、<code>Nacos</code>、<code>NACOS</code> 的项目名</li>
<li>⚠️ <strong>使用建议</strong>：如果匹配模式过于严格可能导致遗漏目标项目</li>
<li>💡 <strong>最佳实践</strong>：若未找到预期结果，建议不传此参数重新查询完整列表</li>
</ul>
</li>
</ul>
<p><strong>智能提示机制：</strong></p>
<ul>
<li>当使用 <code>project_name_pattern</code> 但未匹配到项目时，返回结果会包含提示信息</li>
<li>建议 AI 助手在未找到预期项目时，不传 <code>project_name_pattern</code> 参数重新查询</li>
<li>有效减少因过度过滤导致的查询失败</li>
</ul>
<p><strong>示例 1 - 列出所有项目：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 使用项目名称模糊匹配：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_dir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"project_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"spring-boot"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"spring-cloud-demo"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"已使用项目名称模式 'spring' 进行过滤。如果未找到预期的项目，可能是模式匹配过于严格。建议：不传入 project_name_pattern 参数重新调用 list_all_project 工具查看完整项目列表。"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_all_projects"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>提示信息说明：</strong></p>
<ul>
<li>当使用 <code>project_name_pattern</code> 但未匹配到任何项目时，<code>hint</code> 字段会提示模式可能过于严格，并显示总项目数 <code>total_all_projects</code></li>
<li>当使用 <code>project_name_pattern</code> 且有匹配结果时，<code>hint</code> 字段会提醒如果结果不符合预期可以不传参数重新查询，同时显示总项目数</li>
<li>这个智能提示机制帮助 AI 助手更好地调整查询策略，避免因过度过滤错过目标项目</li>
</ul>
<h4 data-id="heading-10">list_project_files</h4>
<p>列出 Java 项目中的源代码文件和配置文件路径。</p>
<p><strong>用途：</strong></p>
<ul>
<li>了解项目结构和文件组织</li>
<li>查找特定的类或配置文件</li>
<li>分析类之间的关系和依赖</li>
<li>当项目文件过多时，聚焦特定模块</li>
<li>支持文件名模糊匹配，快速定位目标文件</li>
</ul>
<p><strong>支持两种模式：</strong></p>
<ol>
<li><strong>全项目模式</strong>（不指定 <code>sub_path</code>）：列出整个项目的所有文件</li>
<li><strong>聚焦模式</strong>（指定 <code>sub_path</code>）：只列出指定子目录下的文件</li>
</ol>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_name</code> (必需): 项目名称，例如 <code>nacos</code></li>
<li><code>sub_path</code> (可选): 指定项目内的子目录路径，例如 <code>core</code> 或 <code>address/src/main/java</code></li>
<li><code>file_name_pattern</code> (可选): 文件名模糊匹配模式（不区分大小写），用于进一步过滤文件列表
<ul>
<li>支持左右模糊匹配，例如 <code>Service</code> 将匹配包含 <code>service</code>、<code>Service</code>、<code>SERVICE</code> 的文件名</li>
<li>⚠️ <strong>使用建议</strong>：如果匹配模式过于严格可能导致遗漏目标文件</li>
<li>💡 <strong>最佳实践</strong>：若未找到预期结果，建议不传此参数重新查询完整列表</li>
</ul>
</li>
<li><code>project_dir</code> (可选): 项目所在的父目录路径，如未提供则使用启动时配置的路径</li>
</ul>
<p><strong>自动过滤内容：</strong></p>
<ul>
<li>✅ 包含：Java 源代码 (.java)、配置文件 (.xml, .properties, .yaml, .json 等)、构建脚本、文档</li>
<li>❌ 排除：测试目录 (<code>src/test</code>)、编译产物 (<code>target</code>, <code>build</code>)、IDE 配置、版本控制文件</li>
</ul>
<p><strong>智能提示机制：</strong></p>
<ul>
<li>当使用 <code>file_name_pattern</code> 但未匹配到文件时，返回结果会包含提示信息</li>
<li>建议 AI 助手在未找到预期文件时，不传 <code>file_name_pattern</code> 参数重新查询</li>
<li>有效减少因过度过滤导致的查询失败</li>
</ul>
<p><strong>示例 1 - 列出整个项目：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 只列出 core 模块：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sub_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"core"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 3 - 使用文件名模糊匹配：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Service"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"project_dir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects/nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"search_scope"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"core"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_name_pattern"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Service"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"total_files"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"core/src/main/java/com/alibaba/nacos/core/service/NacosService.java"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"api/src/main/java/com/alibaba/nacos/api/naming/NamingService.java"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"..."</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"已使用文件名模式 'Service' 进行过滤。如果未找到预期的文件，可能是模式匹配过于严格。建议：不传入 file_name_pattern 参数重新调用 list_project_files 工具查看完整文件列表。"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>提示信息说明：</strong></p>
<ul>
<li>当使用 <code>file_name_pattern</code> 但未匹配到任何文件时，<code>hint</code> 字段会提示模式可能过于严格</li>
<li>当使用 <code>file_name_pattern</code> 且有匹配结果时，<code>hint</code> 字段会提醒如果结果不符合预期可以不传参数重新查询</li>
<li>这个智能提示机制帮助 AI 助手更好地调整查询策略，避免因过度过滤错过目标文件</li>
</ul>
<h4 data-id="heading-11">read_project_code</h4>
<p>从本地项目目录中读取指定文件的源代码或配置文件内容。</p>
<p><strong>用途：</strong></p>
<ul>
<li>读取具体类或文件的完整源代码</li>
<li>查看配置文件内容（pom.xml、application.yml、application.properties 等）</li>
<li>读取项目文档（README.md、SQL 脚本等）</li>
<li>支持多模块 Maven/Gradle 项目</li>
<li>自动搜索常见的源代码和配置文件路径</li>
</ul>
<p><strong>参数：</strong></p>
<ul>
<li><code>project_name</code> (必需): 项目名称，例如 <code>my-project</code></li>
<li><code>file_path</code> (必需): 文件标识符：可以是完全限定的 Java 类名或文件相对路径
<ul>
<li>Java 类名格式：<code>com.example.MyClass</code> (自动查找对应的 .java 文件)</li>
<li>相对路径格式：<code>src/main/java/com/example/MyClass.java</code></li>
<li>模块相对路径：<code>core/src/main/java/com/example/MyClass.java</code></li>
<li>配置文件路径：<code>src/main/resources/application.yml</code>、<code>pom.xml</code></li>
<li>文档文件：<code>README.md</code>、<code>docs/setup.md</code></li>
</ul>
</li>
<li><code>project_dir</code> (可选): 项目目录路径，如未提供则使用启动时配置的路径</li>
</ul>
<p><strong>支持的文件类型：</strong></p>
<ul>
<li>Java 源代码 (.java)</li>
<li>配置文件 (.xml, .properties, .yaml, .yml, .json, .conf, .config)</li>
<li>构建脚本 (.gradle, .gradle.kts, pom.xml)</li>
<li>文档文件 (.md, .txt)</li>
<li>SQL 脚本 (.sql)</li>
<li>Shell 脚本 (.sh, .bat)</li>
</ul>
<p><strong>自动搜索路径：</strong></p>
<ul>
<li>对于 Java 类名：<code>src/main/java/{class_path}.java</code>、<code>src/{class_path}.java</code>、<code>{class_path}.java</code></li>
<li>对于配置文件：项目根目录、<code>src/main/resources/</code>、<code>src/</code>、<code>config/</code> 及子模块</li>
<li>支持多模块项目中的子模块路径</li>
</ul>
<p><strong>推荐工作流程：</strong></p>
<ol>
<li>使用 <code>list_all_project</code> 确认项目存在</li>
<li>使用 <code>list_project_files</code>（建议带 <code>file_name_pattern</code> 参数）查看文件列表</li>
<li>使用本工具读取具体文件内容</li>
</ol>
<p><strong>示例 1 - 使用类名读取 Java 源代码：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.service.UserService"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 2 - 使用相对路径读取 Java 文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nacos"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"address/src/main/java/com/alibaba/nacos/address/component/AddressServerGeneratorManager.java"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 3 - 读取配置文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/main/resources/application.yml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>示例 4 - 读取项目根目录的文件：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pom.xml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"project_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-spring-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.example.service.UserService"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file_path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/path/to/projects/my-spring-app/src/main/java/com/example/service/UserService.java"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"package com.example.service;\n\nimport ...\n\npublic class UserService {\n    // ...\n}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">read_jar_source</h4>
<p>从 Maven 依赖中读取 Java 类的源代码（优先从 sources jar，否则反编译）。</p>
<p><strong>参数：</strong></p>
<ul>
<li><code>group_id</code> (必需): Maven group ID，例如 <code>org.springframework</code></li>
<li><code>artifact_id</code> (必需): Maven artifact ID，例如 <code>spring-core</code></li>
<li><code>version</code> (必需): Maven version，例如 <code>5.3.21</code></li>
<li><code>class_name</code> (必需): 完全限定的类名，例如 <code>org.springframework.core.SpringVersion</code></li>
<li><code>prefer_sources</code> (可选，默认 <code>true</code>): 优先使用 sources jar 而不是反编译</li>
</ul>
<p><strong>工作原理：</strong></p>
<ol>
<li>首先尝试从 <code>-sources.jar</code> 中提取源代码（如果 <code>prefer_sources=true</code>）</li>
<li>如果 sources jar 不存在或提取失败，自动回退到反编译主 JAR 文件</li>
<li>支持 SNAPSHOT 版本的智能处理</li>
</ol>
<p><strong>智能错误提示：</strong></p>
<p>当 JAR 文件未找到时，工具会提供详细的排查建议：</p>
<ul>
<li>提示可能的原因（依赖未安装、Maven 坐标错误）</li>
<li>建议使用 <code>read_project_code</code> 工具读取项目的 <code>pom.xml</code> 文件</li>
<li>指导在 <code>&lt;dependencies&gt;</code> 部分核对正确的 Maven 坐标</li>
<li>提示确认坐标后重新调用工具</li>
<li>说明可能需要执行 Maven 构建命令安装依赖</li>
</ul>
<p>这个智能提示机制特别适合与 AI 助手配合使用，能有效减少因 Maven 坐标错误导致的重复尝试。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"group_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"artifact_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"spring-core"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.3.21"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework.core.SpringVersion"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回格式：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"class_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework.core.SpringVersion"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"artifact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"org.springframework:spring-core:5.3.21"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"source_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sources.jar"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"package org.springframework.core;\n\npublic class SpringVersion {\n    // ...\n}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>source_type 字段说明：</strong></p>
<p><code>source_type</code> 字段标识源码的来源，帮助 AI 助手了解代码的可靠性和新鲜度：</p>
<ul>
<li><code>"sources.jar"</code>: 从 Maven 的 sources JAR 文件中提取（最可靠，与发布版本完全一致）</li>
<li><code>"decompiled"</code>: 通过反编译器新反编译生成（可能存在反编译不完整的情况）</li>
<li><code>"decompiled_cache"</code>: 从之前反编译的缓存中读取（避免重复反编译，提升性能）</li>
</ul>
<p>💡 <strong>使用建议</strong>：</p>
<ul>
<li><code>sources.jar</code> 来源的代码最准确，可直接作为分析依据</li>
<li><code>decompiled</code> 来源的代码可能会有语法糖恢复、泛型擦除等反编译特征</li>
<li><code>decompiled_cache</code> 与 <code>decompiled</code> 质量相同，只是从缓存读取以提升效率</li>
</ul>
<h5 data-id="heading-13">反编译器选择与缓存机制</h5>
<p><code>read_jar_source</code> 工具支持多个反编译器，并根据 Java 版本自动选择最合适的：</p>




















<table><thead><tr><th>Java 版本</th><th>推荐反编译器</th><th>说明</th></tr></thead><tbody><tr><td>8 - 20</td><td>CFR</td><td>自动使用 <strong>CFR</strong> 反编译器（兼容 Java 8+），已包含在包中：<code>src/easy_code_reader/decompilers/cfr.jar</code></td></tr><tr><td>21+</td><td>Fernflower</td><td>自动使用 <strong>Fernflower</strong> 反编译器（IntelliJ IDEA 使用的反编译器），已包含在包中：<code>src/easy_code_reader/decompilers/fernflower.jar</code></td></tr></tbody></table>
<p>反编译后的文件会被缓存在 JAR 包所在目录的 <code>easy-code-reader/</code> 子目录中，例如：</p>
<p>如果 JAR 包位置为：</p>
<pre><code class="hljs language-bash" lang="bash">~/.m2/repository/org/springframework/spring-core/5.3.21/spring-core-5.3.21.jar
</code></pre>
<p>反编译后的源文件将存储在：</p>
<pre><code class="hljs language-bash" lang="bash">~/.m2/repository/org/springframework/spring-core/5.3.21/easy-code-reader/spring-core-5.3.21.jar
</code></pre>
<p>缓存文件本身也是一个 JAR 格式的压缩包，包含所有反编译后的 <code>.java</code> 文件，这样可以避免重复反编译相同的 JAR 包，提高性能。但 <strong>针对 SNAPSHOT 版本需要特殊处理：</strong> 因为 Maven 针对快照版本会生成带时间戳的 JAR（如 <code>artifact-1.0.0-20251030.085053-1.jar</code>），Easy Code Reader 会自动查找最新的带时间戳版本进行反编译，并且以缓存以 <code>artifact-1.0.0-20251030.085053-1.jar</code> 名称存储，提供版本判断的依据，当检测到新版本时，会自动清理旧的 SNAPSHOT 缓存，生成新的缓存文件。</p>
<hr/>
<h3 data-id="heading-14">巨人的肩膀</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcp.so%2Fserver%2Feasy-code-reader%2FFangYuan33" target="_blank" title="https://mcp.so/server/easy-code-reader/FangYuan33" ref="nofollow noopener noreferrer">MCP.so: Easy Code Reader</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFangYuan33%2Feasy-code-reader" target="_blank" title="https://github.com/FangYuan33/easy-code-reader" ref="nofollow noopener noreferrer">Github: easy-code-reader</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsalitaba%2Fmaven-decoder-mcp" target="_blank" title="https://github.com/salitaba/maven-decoder-mcp" ref="nofollow noopener noreferrer">Github: maven-decoder-mcp</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJetBrains%2Ffernflower" target="_blank" title="https://github.com/JetBrains/fernflower" ref="nofollow noopener noreferrer">Github: fernflower</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端架构中的中间层设计：构建稳健可维护的组件体系]]></title>    <link>https://juejin.cn/post/7570651893869936692</link>    <guid>https://juejin.cn/post/7570651893869936692</guid>    <pubDate>2025-11-10T06:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570651893869936692" data-draft-id="7570651893869903924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端架构中的中间层设计：构建稳健可维护的组件体系"/> <meta itemprop="keywords" content="前端,面试,代码规范"/> <meta itemprop="datePublished" content="2025-11-10T06:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端架构中的中间层设计：构建稳健可维护的组件体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T06:19:53.000Z" title="Mon Nov 10 2025 06:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    84
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，中间层架构设计已成为构建大型复杂应用的关键策略。特别是在组件化开发中，合理的中间层设计能够显著提升代码质量、团队协作效率和系统可维护性。</p>
<p>================================================================================</p>
<h2 data-id="heading-0">一、什么是组件中间层？</h2>
<p>组件中间层是位于业务逻辑与基础UI组件之间的抽象层，它通过对底层组件（如 Ant Design、Element UI 等）进行统一封装，为业务开发提供标准化、增强型的组件接口。</p>
<p><strong>架构层次示意：</strong></p>
<pre><code class="hljs language-scss" lang="scss">业务组件层 (Business Components)
    ↓
组件中间层 (Component Middleware) ← 核心抽象层
    ↓
基础UI库 (UI Libraries) ← AntD、Element UI 等
    ↓
原生<span class="hljs-selector-tag">HTML</span>元素 (Native HTML)
</code></pre>
<h2 data-id="heading-1">二、中间层设计的核心价值</h2>
<h3 data-id="heading-2">1. 技术栈解耦与风险控制</h3>
<p><strong>问题场景：</strong> 业务代码直接依赖特定UI库，导致技术栈切换成本极高</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 直接依赖 - 危险的做法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Table</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserManagement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span> <span class="hljs-attr">dataSource</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>
  );
}

<span class="hljs-comment">// ✅ 中间层封装 - 安全的做法</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrimaryButton</span>, <span class="hljs-title class_">DataTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserManagement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PrimaryButton</span>&gt;</span>删除用户<span class="hljs-tag">&lt;/<span class="hljs-name">PrimaryButton</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataTable</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span></span>
  );
}
</code></pre>
<p><strong>优势体现：</strong> 当需要从 Ant Design 迁移到其他UI库时，只需修改中间层实现，业务代码无需改动。</p>
<h3 data-id="heading-3">2. 统一设计规范与用户体验</h3>
<p>通过中间层强制实施设计系统规范，确保整个应用交互一致性：</p>
<pre><code class="hljs language-ini" lang="ini">// components/EnhancedTable/index.tsx
import React from 'react'<span class="hljs-comment">;</span>
import { Table, Empty, Spin, Alert } from 'antd'<span class="hljs-comment">;</span>

interface EnhancedTableProps {
  loading?: boolean<span class="hljs-comment">;</span>
  error?: Error | null<span class="hljs-comment">;</span>
  data: any<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  columns: any<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  onRetry?: () =&gt; void<span class="hljs-comment">;</span>
}

export const EnhancedTable: React.FC&lt;EnhancedTableProps&gt; = ({
  <span class="hljs-attr">loading</span> = <span class="hljs-literal">false</span>,
  <span class="hljs-attr">error</span> = null,
  <span class="hljs-attr">data</span> = [],
  columns,
  onRetry,
  ...rest
}) =&gt; {
  if (error) {
    return (
      &lt;Alert
        <span class="hljs-attr">message</span>=<span class="hljs-string">"数据加载失败"</span>
        <span class="hljs-attr">description</span>={error.message}
        <span class="hljs-attr">type</span>=<span class="hljs-string">"error"</span>
        <span class="hljs-attr">action</span>={
          &lt;Button <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-literal">on</span>Click={<span class="hljs-literal">on</span>Retry}&gt;
            重试
          &lt;/Button&gt;
        }
      /&gt;
    )<span class="hljs-comment">;</span>
  }

  return (
    &lt;Spin <span class="hljs-attr">spinning</span>={loading}&gt;
      &lt;Table
        <span class="hljs-attr">dataSource</span>={data}
        <span class="hljs-attr">columns</span>={columns}
        <span class="hljs-attr">locale</span>={{
          emptyText: (
            &lt;Empty 
              <span class="hljs-attr">description</span>={loading ? <span class="hljs-string">'加载中...'</span> : <span class="hljs-string">'暂无数据'</span>}
              <span class="hljs-attr">image</span>={Empty.PRESENTED_IMAGE_SIMPLE}
            /&gt;
          )
        }}
        <span class="hljs-attr">pagination</span>={{
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total) =&gt; `共 ${total} 条`,
          pageSizeOptions: <span class="hljs-section">['10', '20', '50', '100']</span>,
        }}
        {...rest}
      /&gt;
    &lt;/Spin&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">3. 功能增强与横切关注点处理</h3>
<p>中间层天然适合处理跨组件的通用逻辑：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/SecureButton/index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span>, message, <span class="hljs-title class_">Modal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> { usePermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/usePermission'</span>;
<span class="hljs-keyword">import</span> { useTracking } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTracking'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecureButtonProps</span> {
  <span class="hljs-comment">// 权限控制</span>
  permission?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 操作确认</span>
  confirm?: <span class="hljs-built_in">string</span> | { <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span> };
  <span class="hljs-comment">// 埋点追踪</span>
  tracking?: { <span class="hljs-attr">event</span>: <span class="hljs-built_in">string</span>; data?: <span class="hljs-built_in">any</span> };
  <span class="hljs-comment">// 防重复提交</span>
  debounce?: <span class="hljs-built_in">number</span>;
  onClick?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SecureButton</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SecureButtonProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  permission,
  confirm,
  tracking,
  debounce = <span class="hljs-number">300</span>,
  onClick,
  children,
  ...props
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { hasPermission } = <span class="hljs-title function_">usePermission</span>();
  <span class="hljs-keyword">const</span> { trackEvent } = <span class="hljs-title function_">useTracking</span>();
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 权限校验</span>
  <span class="hljs-keyword">if</span> (permission &amp;&amp; !<span class="hljs-title function_">hasPermission</span>(permission)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 确认对话框</span>
    <span class="hljs-keyword">if</span> (confirm) {
      <span class="hljs-keyword">const</span> confirmed = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">confirm</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-keyword">typeof</span> confirm === <span class="hljs-string">'string'</span> ? <span class="hljs-string">'确认操作'</span> : confirm.<span class="hljs-property">title</span>,
          <span class="hljs-attr">content</span>: <span class="hljs-keyword">typeof</span> confirm === <span class="hljs-string">'string'</span> ? confirm : confirm.<span class="hljs-property">content</span>,
          <span class="hljs-attr">onOk</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>),
          <span class="hljs-attr">onCancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>),
        });
      });
      
      <span class="hljs-keyword">if</span> (!confirmed) <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 埋点记录</span>
    <span class="hljs-keyword">if</span> (tracking) {
      <span class="hljs-title function_">trackEvent</span>(tracking.<span class="hljs-property">event</span>, tracking.<span class="hljs-property">data</span>);
    }

    <span class="hljs-comment">// 加载状态与防重复</span>
    <span class="hljs-keyword">if</span> (!loading) {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> onClick?.();
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>), debounce);
      }
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
      {<span class="hljs-attr">...props</span>}
      <span class="hljs-attr">loading</span>=<span class="hljs-string">{loading}</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>
      <span class="hljs-attr">disabled</span>=<span class="hljs-string">{props.disabled</span> || <span class="hljs-attr">loading</span>}
    &gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-5">4. 类型安全与开发体验提升</h3>
<p>通过 TypeScript 提供精确的类型提示和约束：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/table.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TableColumn</span>&lt;T = <span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">dataIndex</span>: keyof T;
  render?: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">any</span>, record: T, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  sorter?: <span class="hljs-built_in">boolean</span> | (<span class="hljs-function">(<span class="hljs-params">a: T, b: T</span>) =&gt;</span> <span class="hljs-built_in">number</span>);
  filters?: { <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span> }[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaginationConfig</span> {
  <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">pageSize</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">onChange</span>: <span class="hljs-function">(<span class="hljs-params">page: <span class="hljs-built_in">number</span>, pageSize?: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// components/DataTable/index.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TableColumn</span>, <span class="hljs-title class_">PaginationConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/table'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataTableProps</span>&lt;T&gt; {
  <span class="hljs-attr">data</span>: T[];
  <span class="hljs-attr">columns</span>: <span class="hljs-title class_">TableColumn</span>&lt;T&gt;[];
  pagination?: <span class="hljs-title class_">PaginationConfig</span>;
  loading?: <span class="hljs-built_in">boolean</span>;
  rowKey?: keyof T | (<span class="hljs-function">(<span class="hljs-params">record: T</span>) =&gt;</span> <span class="hljs-built_in">string</span>);
}
</code></pre>
<h2 data-id="heading-6">三、中间层设计模式与实践</h2>
<h3 data-id="heading-7">1. 组合模式 (Composition)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/SearchTable/index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EnhancedTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../EnhancedTable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SearchBar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../SearchBar'</span>;
<span class="hljs-keyword">import</span> { usePagination } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/usePagination'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SearchTable</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SearchTableProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  searchFields,
  onSearch,
  ...tableProps
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { pagination, setPagination } = <span class="hljs-title function_">usePagination</span>();
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">values: <span class="hljs-built_in">any</span></span>) =&gt; {
    onSearch?.(values);
    <span class="hljs-title function_">setPagination</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">current</span>: <span class="hljs-number">1</span> }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"search-table"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SearchBar</span> <span class="hljs-attr">fields</span>=<span class="hljs-string">{searchFields}</span> <span class="hljs-attr">onSearch</span>=<span class="hljs-string">{handleSearch}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EnhancedTable</span>
        {<span class="hljs-attr">...tableProps</span>}
        <span class="hljs-attr">pagination</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">...pagination</span>,
          <span class="hljs-attr">onChange:</span> <span class="hljs-attr">setPagination</span>,
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-8">2. 高阶组件模式 (HOC)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// hooks/withErrorBoundary.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> withErrorBoundary&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>&gt;(
  <span class="hljs-title class_">Component</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentType</span>&lt;P&gt;,
  fallback?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>
) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;P, { <span class="hljs-attr">hasError</span>: <span class="hljs-built_in">boolean</span> }&gt; {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: P</span>) {
      <span class="hljs-variable language_">super</span>(props);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
    }

    <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
    }

    <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span>, errorInfo: React.ErrorInfo</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Component Error:'</span>, error, errorInfo);
    }

    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
        <span class="hljs-keyword">return</span> fallback || <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件渲染失败<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
      }

      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...this.props</span>} /&gt;</span></span>;
    }
  };
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">EnhancedTableWithErrorBoundary</span> = <span class="hljs-title function_">withErrorBoundary</span>(<span class="hljs-title class_">EnhancedTable</span>);
</code></pre>
<h3 data-id="heading-9">3. 自定义 Hook 模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// hooks/useTable.ts</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTable&lt;T&gt;(<span class="hljs-attr">initialData</span>: T[] = []) {
  <span class="hljs-keyword">const</span> [data, setData] = useState&lt;T[]&gt;(initialData);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-keyword">const</span> refresh = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">fetchFunction</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T[]&gt;) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchFunction</span>();
      <span class="hljs-title function_">setData</span>(result);
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">setError</span>(err <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>);
      <span class="hljs-keyword">throw</span> err;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  }, []);

  <span class="hljs-keyword">return</span> {
    data,
    loading,
    error,
    setData,
    refresh,
  };
}
</code></pre>
<h2 data-id="heading-10">四、实际业务场景应用</h2>
<h3 data-id="heading-11">场景：用户管理系统表格</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// features/user/components/UserTable.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SearchTable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SearchTable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SecureButton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/SecureButton'</span>;
<span class="hljs-keyword">import</span> { useUserTable } <span class="hljs-keyword">from</span> <span class="hljs-string">'../hooks/useUserTable'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserTable</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    data,
    loading,
    pagination,
    searchFields,
    handleSearch,
    handleDelete,
    handleEdit,
  } = <span class="hljs-title function_">useUserTable</span>();

  <span class="hljs-keyword">const</span> columns = [
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'name'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'姓名'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'name'</span>,
    },
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'email'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'邮箱'</span>,
      <span class="hljs-attr">dataIndex</span>: <span class="hljs-string">'email'</span>,
    },
    {
      <span class="hljs-attr">key</span>: <span class="hljs-string">'actions'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'操作'</span>,
      <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">_, record</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">SecureButton</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleEdit(record)}
            permission="user:edit"
          &gt;
            编辑
          <span class="hljs-tag">&lt;/<span class="hljs-name">SecureButton</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">SecureButton</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>
            <span class="hljs-attr">danger</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleDelete(record.id)}
            permission="user:delete"
            confirm="确定删除该用户吗？"
            tracking={{ event: 'user_delete' }}
          &gt;
            删除
          <span class="hljs-tag">&lt;/<span class="hljs-name">SecureButton</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      ),
    },
  ];

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SearchTable</span>
      <span class="hljs-attr">columns</span>=<span class="hljs-string">{columns}</span>
      <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span>
      <span class="hljs-attr">loading</span>=<span class="hljs-string">{loading}</span>
      <span class="hljs-attr">pagination</span>=<span class="hljs-string">{pagination}</span>
      <span class="hljs-attr">searchFields</span>=<span class="hljs-string">{searchFields}</span>
      <span class="hljs-attr">onSearch</span>=<span class="hljs-string">{handleSearch}</span>
      <span class="hljs-attr">rowKey</span>=<span class="hljs-string">"id"</span>
    /&gt;</span></span>
  );
};
</code></pre>
<h2 data-id="heading-12">五、架构收益与长期价值</h2>
<h3 data-id="heading-13">可度量的技术收益</h3>
<ul>
<li>
<p><strong>开发效率</strong>：组件复用率提升 40-60%</p>
</li>
<li>
<p><strong>维护成本</strong>：UI库升级工作量减少 70-80%</p>
</li>
<li>
<p><strong>代码质量</strong>：类型覆盖率提升至 90%+</p>
</li>
<li>
<p><strong>团队协作</strong>：新成员上手时间缩短 50%</p>
</li>
</ul>
<h3 data-id="heading-14">战略价值</h3>
<ol>
<li>
<p><strong>技术债务控制</strong>：通过中间层隔离变化，有效控制技术债务积累</p>
</li>
<li>
<p><strong>渐进式重构</strong>：支持老系统渐进式迁移和重构</p>
</li>
<li>
<p><strong>多端适配</strong>：为小程序、移动端等不同平台提供统一API</p>
</li>
<li>
<p><strong>A/B测试</strong>：在中间层实现无侵入的功能开关和实验配置</p>
</li>
</ol>
<h2 data-id="heading-15">六、最佳实践与注意事项</h2>
<h3 data-id="heading-16">实施建议</h3>
<ol>
<li>
<p><strong>渐进式推进</strong>：从最常用的组件开始封装，逐步覆盖</p>
</li>
<li>
<p><strong>文档驱动</strong>：为每个中间层组件提供完整的使用文档和示例</p>
</li>
<li>
<p><strong>版本管理</strong>：建立中间层组件的版本发布和更新机制</p>
</li>
<li>
<p><strong>性能监控</strong>：监控中间层组件的性能影响和错误率</p>
</li>
</ol>
<h3 data-id="heading-17">避免的陷阱</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 过度封装 - 增加了不必要的复杂度</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">SuperButton</span> = (<span class="hljs-params">{ 
  ultraProp, 
  megaConfig, 
  ...rest 
}</span>) =&gt; {
  <span class="hljs-comment">// 过于复杂的逻辑...</span>
};

<span class="hljs-comment">// ✅ 适度封装 - 保持简单清晰</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">PrimaryButton</span> = (<span class="hljs-params">{ 
  confirm, 
  tracking, 
  ...buttonProps 
}</span>) =&gt; {
  <span class="hljs-comment">// 聚焦核心增强功能...</span>
};
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>前端组件中间层设计不仅是技术实现，更是架构思维的体现。它通过合理的抽象和封装，在保证开发体验的同时，为应用长期演进提供了坚实的技术基础。成功的中间层设计应该像一座精心设计的桥梁，既连接现在与未来，又承载着团队协作和业务发展的重任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零到一：这篇JavaScript指南让你成为独立开发者]]></title>    <link>https://juejin.cn/post/7570187256105517062</link>    <guid>https://juejin.cn/post/7570187256105517062</guid>    <pubDate>2025-11-09T23:30:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570187256105517062" data-draft-id="7570162686580015146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零到一：这篇JavaScript指南让你成为独立开发者"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-09T23:30:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零到一：这篇JavaScript指南让你成为独立开发者
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T23:30:56.000Z" title="Sun Nov 09 2025 23:30:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    27
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是曾经看着满屏的代码感到无从下手？或者跟着教程做项目时总是一头雾水？别担心，今天这篇文章就是为你准备的。学完这篇内容，你就能真正理解JavaScript的精髓，独立开发出属于自己的应用。</p>
<p>我会带你从最基础的概念开始，一步步构建完整的应用思维。不用担心自己是新手，我会用最通俗易懂的方式讲解每个关键点。读完这篇文章，你将获得完整的JavaScript开发能力，能够独立设计和实现前端应用。</p>
<h2 data-id="heading-0">JavaScript的核心概念</h2>
<p>让我们先来理解JavaScript的几个核心概念。很多人学不会编程，就是因为一开始被各种术语吓住了。其实编程就像学做菜，先搞清楚油盐酱醋是干什么的，再学炒菜就简单了。</p>
<p>变量就像厨房里的调料瓶，用来存放各种数据。在JavaScript中，我们常用let和const来声明变量。看这个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// let用于声明可以改变的变量</span>
<span class="hljs-keyword">let</span> userName = <span class="hljs-string">'小明'</span>;
userName = <span class="hljs-string">'小红'</span>; <span class="hljs-comment">// 这样可以改变</span>

<span class="hljs-comment">// const用于声明不变的常量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_USERS</span> = <span class="hljs-number">100</span>;
<span class="hljs-comment">// MAX_USERS = 200; 这样会报错，因为常量不能重新赋值</span>
</code></pre>
<p>函数就像是预制的调味料组合，一次调配，多次使用。理解函数是独立开发的第一步：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个简单的函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greetUser</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！欢迎使用我们的应用。`</span>;
}

<span class="hljs-comment">// 使用函数</span>
<span class="hljs-keyword">const</span> greeting = <span class="hljs-title function_">greetUser</span>(<span class="hljs-string">'张三'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(greeting); <span class="hljs-comment">// 输出：你好，张三！欢迎使用我们的应用。</span>
</code></pre>
<p>对象和数组让我们能够组织更复杂的数据。想象你要开发一个待办事项应用，就需要用这些结构来存储任务数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用对象表示一个任务</span>
<span class="hljs-keyword">const</span> task = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">title</span>: <span class="hljs-string">'学习JavaScript'</span>,
    <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-12-31'</span>
};

<span class="hljs-comment">// 用数组存储多个任务</span>
<span class="hljs-keyword">const</span> taskList = [
    task,
    {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">title</span>: <span class="hljs-string">'写项目文档'</span>,
        <span class="hljs-attr">completed</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-11-15'</span>
    }
];
</code></pre>
<h2 data-id="heading-1">现代JavaScript开发必备技能</h2>
<p>掌握了基础概念，接下来要了解现代JavaScript开发的必备技能。这些是你能独立开发应用的基石。</p>
<p>异步编程是必须掌握的重点。现在的应用都需要与服务器通信，理解Promise和async/await至关重要：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟从服务器获取数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (userId === <span class="hljs-number">1</span>) {
                <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span> });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">reject</span>(<span class="hljs-string">'用户不存在'</span>);
            }
        }, <span class="hljs-number">1000</span>);
    });
}

<span class="hljs-comment">// 使用async/await处理异步操作</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">displayUserInfo</span>(<span class="hljs-params">userId</span>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'正在加载用户信息...'</span>);
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUserData</span>(userId);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`用户姓名：<span class="hljs-subst">${user.name}</span>，年龄：<span class="hljs-subst">${user.age}</span>`</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'出错啦：'</span>, error);
    }
}

<span class="hljs-comment">// 调用函数</span>
<span class="hljs-title function_">displayUserInfo</span>(<span class="hljs-number">1</span>);
</code></pre>
<p>DOM操作让JavaScript能够与网页交互。这是前端开发的核心能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建新的任务元素并添加到页面</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addTaskToDOM</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-comment">// 创建任务容器</span>
    <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    taskElement.<span class="hljs-property">className</span> = <span class="hljs-string">'task-item'</span>;
    taskElement.<span class="hljs-property">id</span> = <span class="hljs-string">`task-<span class="hljs-subst">${task.id}</span>`</span>;
    
    <span class="hljs-comment">// 设置任务内容</span>
    taskElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
        &lt;input type="checkbox" <span class="hljs-subst">${task.completed ? <span class="hljs-string">'checked'</span> : <span class="hljs-string">''</span>}</span>&gt;
        &lt;span class="task-title"&gt;<span class="hljs-subst">${task.title}</span>&lt;/span&gt;
        &lt;span class="due-date"&gt;<span class="hljs-subst">${task.dueDate}</span>&lt;/span&gt;
        &lt;button class="delete-btn"&gt;删除&lt;/button&gt;
    `</span>;
    
    <span class="hljs-comment">// 添加到任务列表</span>
    <span class="hljs-keyword">const</span> taskList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'task-list'</span>);
    taskList.<span class="hljs-title function_">appendChild</span>(taskElement);
    
    <span class="hljs-comment">// 添加删除功能</span>
    <span class="hljs-keyword">const</span> deleteBtn = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.delete-btn'</span>);
    deleteBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        taskElement.<span class="hljs-title function_">remove</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`删除了任务：<span class="hljs-subst">${task.title}</span>`</span>);
    });
}
</code></pre>
<h2 data-id="heading-2">构建完整的待办事项应用</h2>
<p>现在让我们把这些知识点串联起来，构建一个完整的待办事项应用。这个例子会涵盖数据管理、用户交互、本地存储等核心概念。</p>
<p>首先，我们需要一个应用状态管理器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoApp</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTasks</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? 
            <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span>)) + <span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">// 从本地存储加载任务</span>
    <span class="hljs-title function_">loadTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'todoTasks'</span>);
        <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : [];
    }
    
    <span class="hljs-comment">// 保存任务到本地存储</span>
    <span class="hljs-title function_">saveTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'todoTasks'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>));
    }
    
    <span class="hljs-comment">// 添加新任务</span>
    <span class="hljs-title function_">addTask</span>(<span class="hljs-params">title, dueDate</span>) {
        <span class="hljs-keyword">const</span> newTask = {
            <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentId</span>++,
            <span class="hljs-attr">title</span>: title,
            <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">dueDate</span>: dueDate,
            <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
        };
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">push</span>(newTask);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
        <span class="hljs-keyword">return</span> newTask;
    }
    
    <span class="hljs-comment">// 切换任务完成状态</span>
    <span class="hljs-title function_">toggleTask</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === id);
        <span class="hljs-keyword">if</span> (task) {
            task.<span class="hljs-property">completed</span> = !task.<span class="hljs-property">completed</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
        }
    }
    
    <span class="hljs-comment">// 删除任务</span>
    <span class="hljs-title function_">deleteTask</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> !== id);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveTasks</span>();
    }
    
    <span class="hljs-comment">// 获取所有任务</span>
    <span class="hljs-title function_">getAllTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>;
    }
    
    <span class="hljs-comment">// 获取未完成的任务</span>
    <span class="hljs-title function_">getActiveTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">completed</span>);
    }
    
    <span class="hljs-comment">// 获取已完成的任务</span>
    <span class="hljs-title function_">getCompletedTasks</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">completed</span>);
    }
}
</code></pre>
<p>接下来是用户界面控制器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TodoUI</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">app</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span> = app;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initializeEventListeners</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    }
    
    <span class="hljs-comment">// 初始化事件监听</span>
    <span class="hljs-title function_">initializeEventListeners</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> addButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'add-task-btn'</span>);
        <span class="hljs-keyword">const</span> taskInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'new-task-input'</span>);
        <span class="hljs-keyword">const</span> dueDateInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'due-date-input'</span>);
        
        addButton.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAddTask</span>(taskInput, dueDateInput);
        });
        
        taskInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keypress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAddTask</span>(taskInput, dueDateInput);
            }
        });
    }
    
    <span class="hljs-comment">// 处理添加任务</span>
    <span class="hljs-title function_">handleAddTask</span>(<span class="hljs-params">taskInput, dueDateInput</span>) {
        <span class="hljs-keyword">const</span> title = taskInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
        <span class="hljs-keyword">const</span> dueDate = dueDateInput.<span class="hljs-property">value</span>;
        
        <span class="hljs-keyword">if</span> (title) {
            <span class="hljs-keyword">const</span> newTask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">addTask</span>(title, dueDate);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
            taskInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            dueDateInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`添加了新任务："<span class="hljs-subst">${title}</span>"`</span>);
        }
    }
    
    <span class="hljs-comment">// 渲染任务列表</span>
    <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> taskList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'task-list'</span>);
        taskList.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
        
        <span class="hljs-keyword">const</span> tasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getAllTasks</span>();
        
        tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createTaskElement</span>(task);
            taskList.<span class="hljs-title function_">appendChild</span>(taskElement);
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateStats</span>();
    }
    
    <span class="hljs-comment">// 创建任务元素</span>
    <span class="hljs-title function_">createTaskElement</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">const</span> taskElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
        taskElement.<span class="hljs-property">className</span> = <span class="hljs-string">`task-item <span class="hljs-subst">${task.completed ? <span class="hljs-string">'completed'</span> : <span class="hljs-string">''</span>}</span>`</span>;
        taskElement.<span class="hljs-property">id</span> = <span class="hljs-string">`task-<span class="hljs-subst">${task.id}</span>`</span>;
        
        taskElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
            &lt;div class="task-content"&gt;
                &lt;input type="checkbox" <span class="hljs-subst">${task.completed ? <span class="hljs-string">'checked'</span> : <span class="hljs-string">''</span>}</span> 
                    class="task-checkbox"&gt;
                &lt;span class="task-title"&gt;<span class="hljs-subst">${task.title}</span>&lt;/span&gt;
                <span class="hljs-subst">${task.dueDate ? <span class="hljs-string">`&lt;span class="due-date"&gt;截止：<span class="hljs-subst">${task.dueDate}</span>&lt;/span&gt;`</span> : <span class="hljs-string">''</span>}</span>
            &lt;/div&gt;
            &lt;button class="delete-btn"&gt;删除&lt;/button&gt;
        `</span>;
        
        <span class="hljs-comment">// 添加复选框事件</span>
        <span class="hljs-keyword">const</span> checkbox = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.task-checkbox'</span>);
        checkbox.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">toggleTask</span>(task.<span class="hljs-property">id</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
        });
        
        <span class="hljs-comment">// 添加删除按钮事件</span>
        <span class="hljs-keyword">const</span> deleteBtn = taskElement.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.delete-btn'</span>);
        deleteBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">deleteTask</span>(task.<span class="hljs-property">id</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
        });
        
        <span class="hljs-keyword">return</span> taskElement;
    }
    
    <span class="hljs-comment">// 更新统计信息</span>
    <span class="hljs-title function_">updateStats</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> totalTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> activeTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getActiveTasks</span>().<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> completedTasks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-title function_">getCompletedTasks</span>().<span class="hljs-property">length</span>;
        
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`总任务：<span class="hljs-subst">${totalTasks}</span>，待完成：<span class="hljs-subst">${activeTasks}</span>，已完成：<span class="hljs-subst">${completedTasks}</span>`</span>);
    }
}
</code></pre>
<p>最后是应用的初始化代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 应用启动函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initializeApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建应用实例</span>
    <span class="hljs-keyword">const</span> todoApp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoApp</span>();
    <span class="hljs-keyword">const</span> todoUI = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TodoUI</span>(todoApp);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'待办事项应用已启动！'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前任务数量：'</span>, todoApp.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-property">length</span>);
    
    <span class="hljs-keyword">return</span> { todoApp, todoUI };
}

<span class="hljs-comment">// 当页面加载完成后启动应用</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, initializeApp);
</code></pre>
<h2 data-id="heading-3">进阶技巧和最佳实践</h2>
<p>当你能够独立完成基础应用后，这些进阶技巧会让你的代码更加专业和可维护。</p>
<p>模块化是现代JavaScript开发的重要概念。我们可以使用ES6模块来组织代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/dateHelper.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">dateString</span>) {
    <span class="hljs-keyword">const</span> options = { <span class="hljs-attr">year</span>: <span class="hljs-string">'numeric'</span>, <span class="hljs-attr">month</span>: <span class="hljs-string">'short'</span>, <span class="hljs-attr">day</span>: <span class="hljs-string">'numeric'</span> };
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dateString).<span class="hljs-title function_">toLocaleDateString</span>(<span class="hljs-string">'zh-CN'</span>, options);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isOverdue</span>(<span class="hljs-params">dueDate</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dueDate) &lt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
}

<span class="hljs-comment">// 在另一个文件中导入使用</span>
<span class="hljs-keyword">import</span> { formatDate, isOverdue } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/dateHelper.js'</span>;

<span class="hljs-keyword">const</span> dueDate = <span class="hljs-string">'2024-12-31'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`格式化日期：<span class="hljs-subst">${formatDate(dueDate)}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`是否过期：<span class="hljs-subst">${isOverdue(dueDate)}</span>`</span>);
</code></pre>
<p>错误处理是专业开发者的标志。学会优雅地处理各种异常情况：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataValidator</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">validateTask</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">const</span> errors = [];
        
        <span class="hljs-keyword">if</span> (!task.<span class="hljs-property">title</span> || task.<span class="hljs-property">title</span>.<span class="hljs-title function_">trim</span>().<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'任务标题不能为空'</span>);
        }
        
        <span class="hljs-keyword">if</span> (task.<span class="hljs-property">title</span> &amp;&amp; task.<span class="hljs-property">title</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">100</span>) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'任务标题不能超过100个字符'</span>);
        }
        
        <span class="hljs-keyword">if</span> (task.<span class="hljs-property">dueDate</span> &amp;&amp; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(task.<span class="hljs-property">dueDate</span>) &lt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) {
            errors.<span class="hljs-title function_">push</span>(<span class="hljs-string">'截止日期不能是过去的时间'</span>);
        }
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">isValid</span>: errors.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>,
            <span class="hljs-attr">errors</span>: errors
        };
    }
}

<span class="hljs-comment">// 使用验证器</span>
<span class="hljs-keyword">const</span> newTask = {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'学习JavaScript高级技巧'</span>,
    <span class="hljs-attr">dueDate</span>: <span class="hljs-string">'2024-12-31'</span>
};

<span class="hljs-keyword">const</span> validation = <span class="hljs-title class_">DataValidator</span>.<span class="hljs-title function_">validateTask</span>(newTask);
<span class="hljs-keyword">if</span> (!validation.<span class="hljs-property">isValid</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'验证失败：'</span>, validation.<span class="hljs-property">errors</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务数据有效，可以保存'</span>);
}
</code></pre>
<p>性能优化让你的应用更加流畅。这里有一些实用的优化技巧：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用防抖优化搜索功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, wait</span>) {
    <span class="hljs-keyword">let</span> timeout;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executedFunction</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">later</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-built_in">clearTimeout</span>(timeout);
            <span class="hljs-title function_">func</span>(...args);
        };
        <span class="hljs-built_in">clearTimeout</span>(timeout);
        timeout = <span class="hljs-built_in">setTimeout</span>(later, wait);
    };
}

<span class="hljs-comment">// 搜索任务</span>
<span class="hljs-keyword">const</span> searchTasks = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">searchTerm</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filteredTasks = todoApp.<span class="hljs-title function_">getAllTasks</span>().<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span>
        task.<span class="hljs-property">title</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(searchTerm.<span class="hljs-title function_">toLowerCase</span>())
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到 <span class="hljs-subst">${filteredTasks.length}</span> 个匹配的任务`</span>);
}, <span class="hljs-number">300</span>);

<span class="hljs-comment">// 在输入框中使用</span>
<span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'search-input'</span>);
searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'input'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">searchTasks</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<h2 data-id="heading-4">从学习到实战的转变</h2>
<p>很多人学完基础知识后，不知道如何开始真正的项目开发。这里给你一个清晰的路径。</p>
<p>首先选择适合的练习项目。从简单到复杂，逐步提升：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 项目难度分级</span>
<span class="hljs-keyword">const</span> projectRoadmap = [
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'初级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'个人博客页面'</span>,
            <span class="hljs-string">'计算器应用'</span>,
            <span class="hljs-string">'天气查询小工具'</span>,
            <span class="hljs-string">'简单的游戏（如井字棋）'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'基础DOM操作'</span>, <span class="hljs-string">'事件处理'</span>, <span class="hljs-string">'条件判断'</span>]
    },
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'中级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'待办事项应用（带本地存储）'</span>,
            <span class="hljs-string">'记账应用'</span>,
            <span class="hljs-string">'图片画廊'</span>,
            <span class="hljs-string">'API数据展示应用'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'异步编程'</span>, <span class="hljs-string">'本地存储'</span>, <span class="hljs-string">'模块化'</span>, <span class="hljs-string">'错误处理'</span>]
    },
    {
        <span class="hljs-attr">level</span>: <span class="hljs-string">'高级'</span>,
        <span class="hljs-attr">projects</span>: [
            <span class="hljs-string">'实时聊天应用'</span>,
            <span class="hljs-string">'任务管理系统'</span>,
            <span class="hljs-string">'数据可视化仪表板'</span>,
            <span class="hljs-string">'小型电商网站'</span>
        ],
        <span class="hljs-attr">skills</span>: [<span class="hljs-string">'框架使用'</span>, <span class="hljs-string">'状态管理'</span>, <span class="hljs-string">'性能优化'</span>, <span class="hljs-string">'测试'</span>]
    }
];
</code></pre>
<p>学会阅读文档和查找资料。这是独立开发者最重要的能力：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟解决问题的过程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">solveProblem</span>(<span class="hljs-params">problemDescription</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'问题：'</span>, problemDescription);
    
    <span class="hljs-comment">// 第一步：分析问题</span>
    <span class="hljs-keyword">const</span> analysis = <span class="hljs-title function_">analyzeProblem</span>(problemDescription);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'问题分析：'</span>, analysis);
    
    <span class="hljs-comment">// 第二步：查找相关资料</span>
    <span class="hljs-keyword">const</span> resources = <span class="hljs-keyword">await</span> <span class="hljs-title function_">searchResources</span>(analysis.<span class="hljs-property">keywords</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'相关资源：'</span>, resources);
    
    <span class="hljs-comment">// 第三步：尝试解决方案</span>
    <span class="hljs-keyword">const</span> solution = <span class="hljs-title function_">trySolutions</span>(resources);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解决方案：'</span>, solution);
    
    <span class="hljs-comment">// 第四步：总结学习</span>
    <span class="hljs-keyword">const</span> learnings = <span class="hljs-title function_">summarizeLearnings</span>(problemDescription, solution);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'学习总结：'</span>, learnings);
    
    <span class="hljs-keyword">return</span> solution;
}
</code></pre>
<p>建立自己的代码库和工具集。这会大大提高你的开发效率：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 个人工具函数库</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DevUtils</span> {
    <span class="hljs-comment">// 深度复制对象</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));
    }
    
    <span class="hljs-comment">// 生成随机ID</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">generateId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>);
    }
    
    <span class="hljs-comment">// 格式化文件大小</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">formatFileSize</span>(<span class="hljs-params">bytes</span>) {
        <span class="hljs-keyword">const</span> sizes = [<span class="hljs-string">'Bytes'</span>, <span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>, <span class="hljs-string">'GB'</span>];
        <span class="hljs-keyword">if</span> (bytes === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'0 Bytes'</span>;
        <span class="hljs-keyword">const</span> i = <span class="hljs-built_in">parseInt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">log</span>(bytes) / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1024</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(bytes / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">1024</span>, i), <span class="hljs-number">2</span>) + <span class="hljs-string">' '</span> + sizes[i];
    }
    
    <span class="hljs-comment">// 等待指定时间</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">ms</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms));
    }
}

<span class="hljs-comment">// 使用工具函数</span>
<span class="hljs-keyword">const</span> originalObject = { <span class="hljs-attr">name</span>: <span class="hljs-string">'测试'</span>, <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] };
<span class="hljs-keyword">const</span> clonedObject = <span class="hljs-title class_">DevUtils</span>.<span class="hljs-title function_">deepClone</span>(originalObject);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'克隆的对象：'</span>, clonedObject);
</code></pre>
<h2 data-id="heading-5">持续学习和进步</h2>
<p>编程是一个需要持续学习的领域。建立好的学习习惯会让你走得更远。</p>
<p>制定合理的学习计划：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 周学习计划示例</span>
<span class="hljs-keyword">const</span> weeklyLearningPlan = {
    <span class="hljs-attr">monday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'新技术探索'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'阅读一篇技术文章'</span>,
            <span class="hljs-string">'尝试一个新的JavaScript特性'</span>,
            <span class="hljs-string">'写一个小demo验证理解'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'1-2小时'</span>
    },
    <span class="hljs-attr">wednesday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'项目实践'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'在个人项目上工作'</span>,
            <span class="hljs-string">'重构旧代码'</span>,
            <span class="hljs-string">'添加新功能'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'2-3小时'</span>
    },
    <span class="hljs-attr">friday</span>: {
        <span class="hljs-attr">focus</span>: <span class="hljs-string">'总结和复习'</span>,
        <span class="hljs-attr">tasks</span>: [
            <span class="hljs-string">'整理本周学习笔记'</span>,
            <span class="hljs-string">'回顾遇到的问题和解决方案'</span>,
            <span class="hljs-string">'规划下周学习内容'</span>
        ],
        <span class="hljs-attr">time</span>: <span class="hljs-string">'1小时'</span>
    }
};
</code></pre>
<p>参与开源项目和编程社区：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 参与开源的建议步骤</span>
<span class="hljs-keyword">const</span> openSourceGuide = {
    <span class="hljs-attr">step1</span>: <span class="hljs-string">'寻找感兴趣的项目'</span>,
    <span class="hljs-attr">criteria</span>: [
        <span class="hljs-string">'有清晰的文档'</span>,
        <span class="hljs-string">'有活跃的维护者'</span>,
        <span class="hljs-string">'有good first issue标签'</span>
    ],
    
    <span class="hljs-attr">step2</span>: <span class="hljs-string">'理解项目结构'</span>,
    <span class="hljs-attr">actions</span>: [
        <span class="hljs-string">'阅读README和贡献指南'</span>,
        <span class="hljs-string">'在本地运行项目'</span>,
        <span class="hljs-string">'查看现有代码风格'</span>
    ],
    
    <span class="hljs-attr">step3</span>: <span class="hljs-string">'从小处着手'</span>,
    <span class="hljs-attr">suggestions</span>: [
        <span class="hljs-string">'修复文档错误'</span>,
        <span class="hljs-string">'解决简单的bug'</span>,
        <span class="hljs-string">'添加测试用例'</span>
    ],
    
    <span class="hljs-attr">step4</span>: <span class="hljs-string">'提交贡献'</span>,
    <span class="hljs-attr">tips</span>: [
        <span class="hljs-string">'遵循项目规范'</span>,
        <span class="hljs-string">'编写清晰的提交信息'</span>,
        <span class="hljs-string">'耐心等待代码审查'</span>
    ]
};
</code></pre>
<h2 data-id="heading-6">真正的独立开发之路</h2>
<p>读完这篇文章，你已经掌握了从零开始独立开发JavaScript应用的核心知识和技能。从基础语法到完整应用架构，从代码编写到问题解决，你现在具备了独立探索和创造的能力。</p>
<p>记住，成为真正的独立开发者不在于记住所有API，而在于培养解决问题的能力。当你遇到未知的挑战时，能够冷静分析、寻找资源、尝试方案，这才是最宝贵的技能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>