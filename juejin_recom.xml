<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[用 Vite + Vue 3 快速搭建现代前端项目：从零到多页面路由实战]]></title>    <link>https://juejin.cn/post/7584287969215135763</link>    <guid>https://juejin.cn/post/7584287969215135763</guid>    <pubDate>2025-12-16T16:09:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584287969215135763" data-draft-id="7584287969215053843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Vite + Vue 3 快速搭建现代前端项目：从零到多页面路由实战"/> <meta itemprop="keywords" content="前端,Vue.js,Vite"/> <meta itemprop="datePublished" content="2025-12-16T16:09:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会js"/> <meta itemprop="url" content="https://juejin.cn/user/2517262684662348"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Vite + Vue 3 快速搭建现代前端项目：从零到多页面路由实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517262684662348/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会js
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T16:09:59.000Z" title="Tue Dec 16 2025 16:09:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 Vite + Vue 3 快速搭建现代前端项目：从零到多页面路由实战</h2>
<p>大家好，今天来分享一篇实战向的教程：<strong>基于 Vite 搭建 Vue 3 项目，并集成 Vue Router 实现多页面切换</strong>。在 2025 年底的今天，Vite 已经彻底取代了 Vue CLI 成为 Vue 生态的标配构建工具。它启动快、热更新丝滑、配置简洁，完美契合 Vue 3 的现代开发体验。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/291bfa16c83e4ee09a16bd12d8f298e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766506199&amp;x-signature=Yk9l4C%2BweNKRBGlWuffDKPRX2G8%3D" alt="5609728adb9d921c5649719c8cbf0517.jpg" loading="lazy"/>
如果你还在用老旧的 Webpack 脚手架，那真的该升级了！这篇文章将手把手带你从项目初始化到路由配置，全程代码可复制，逻辑清晰。预计阅读完后，你能独立搭建一个规范的 Vue 3 + Vite 项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b3a5290f254a9db947a90f75ea88a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766506199&amp;x-signature=8is8OCVoKCJfza999kmp2e7NZCQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-1">一、为什么选择 Vite + Vue 3？</h4>
<p>先说说底层逻辑，为什么这对组合这么香？</p>
<ul>
<li>
<p><strong>Vite 的核心优势</strong>：传统工具如 Webpack 在开发时需要先打包整个项目，启动慢、热更新卡顿。Vite 不同，它利用浏览器原生 ES Modules（ESM）支持，按需加载模块。开发服务器启动时几乎不需要预打包，冷启动只需几百毫秒！</p>
</li>
<li>
<p><strong>热模块替换（HMR）原理</strong>：当你修改文件，Vite 通过文件监听器（chokidar）检测变化，只更新受影响的模块，并 via WebSocket 推送给浏览器。浏览器只需替换局部模块，而非整页刷新。这就是为什么 Vite 的热更新能达到毫秒级，甚至大项目也丝滑如 butter。</p>
</li>
<li>
<p><strong>Vue 3 的革新</strong>：更小的体积（减少 41%）、更快的运行时、Composition API + &lt; script setup&gt; 语法糖，让代码更简洁、可复用性更高。</p>
</li>
</ul>
<p>总之，这套栈是当前最高效的现代前端工程化方案。</p>
<h4 data-id="heading-2">二、项目初始化：一步到位</h4>
<p>推荐使用官方脚手架 npm init  vite。</p>
<pre><code class="hljs language-bash" lang="bash">npm init vite
<span class="hljs-built_in">cd</span> my-vue-app
npm install
npm run dev
</code></pre>
<p>交互过程中：</p>
<ul>
<li>选择 <code>vue</code> 模板（默认就是 Vue 3）。</li>
<li>其他选项根据需要（JSX、路由等现在不选，后续手动加）。</li>
</ul>
<p>启动后访问 <code>http://localhost:5173</code>，看到欢迎页就成功了！</p>
<p><strong>易错提醒</strong>：如果端口被占用，Vite 会自动切换端口，但你可以手动在 <code>vite.config.js</code> 配置 <code>server.port</code>。</p>
<h4 data-id="heading-3">三、项目结构剖析：标准模版长啥样？</h4>
<p>一个典型的 Vite + Vue 3 项目结构如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb92d0c6fa5b4e83ab6a00b8b38d10dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766506199&amp;x-signature=SzbWLv4nQ%2BShNkmJfU07%2BXL62%2Fw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06f80da2c6d245dcbfabf39cefbadfde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766506199&amp;x-signature=QZyQ3y76mJNhu%2BzP7GpkmMf0zzE%3D" alt="image.png" loading="lazy"/></p>
<p>关键文件解释：</p>
<ul>
<li>
<p><strong>index.html</strong>：入口 HTML，Vite 以它为根。注意 <code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>，这就是利用 ESM 的关键！浏览器直接导入模块，按需加载。</p>
</li>
<li>
<p><strong>src/main.js</strong>（或 main.ts）：应用入口，创建 Vue App 并挂载到 <code>#app</code>。</p>
</li>
<li>
<p><strong>src/App.vue</strong>：根组件，通常放布局和路由占位。</p>
</li>
<li>
<p><strong>src/assets</strong>：图片等资源。</p>
</li>
<li>
<p><strong>src/components</strong>：公共组件。</p>
</li>
<li>
<p><strong>public</strong>：静态资源，直接复制到 dist。</p>
</li>
</ul>
<p><strong>底层逻辑</strong>：Vite 在开发模式下不打包，而是让浏览器直接请求 ESM 模块。生产构建时才用 Rollup 打包，体积小、Tree-shaking 完美。</p>
<p><strong>开发工具推荐</strong>：</p>
<ul>
<li>VSCode 插件：<strong>Volar</strong>（Vue 官方，取代 Vetur），提供智能提示、类型检查。</li>
<li>Chrome 插件：<strong>Vue Devtools</strong>，调试神器。</li>
</ul>
<h4 data-id="heading-4">四、集成 Vue Router：实现多页面切换</h4>
<p>单页应用（SPA）的核心就是路由。Vue Router 4 是 Vue 3 的官方路由。</p>
<h5 data-id="heading-5">1. 安装</h5>
<pre><code class="hljs language-bash" lang="bash">npm install router
</code></pre>
<h5 data-id="heading-6">2. 创建路由配置（src/router/index.js）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router 模块 定义路由</span>

<span class="hljs-keyword">import</span> {
createRouter,<span class="hljs-comment">//路由实例</span>
createWebHashHistory<span class="hljs-comment">//路由模式</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>;
<span class="hljs-keyword">const</span> routes=[
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/'</span>,
        <span class="hljs-attr">name</span>:<span class="hljs-string">'Home'</span>,
        <span class="hljs-attr">component</span>:<span class="hljs-title class_">Home</span>
    },
    {
        <span class="hljs-attr">path</span>:<span class="hljs-string">'/about'</span>,
        <span class="hljs-attr">name</span>:<span class="hljs-string">'About'</span>,
        <span class="hljs-attr">component</span>:<span class="hljs-title class_">About</span>
    }
];
<span class="hljs-comment">//实例化 负责前端路由</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
    <span class="hljs-comment">//访问历史 hash 路由 #/about</span>
    <span class="hljs-attr">history</span>:<span class="hljs-title function_">createWebHashHistory</span>(),
    <span class="hljs-comment">//路由配置数组</span>
    routes
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<h5 data-id="heading-7">3. 创建视图页面（src/views/Home.vue &amp; About.vue）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Home.vue --&gt;
&lt;template&gt;
  &lt;div class="home"&gt;
    &lt;h1&gt;欢迎来到 Home 页面！&lt;/h1&gt;
    &lt;p&gt;这里是首页内容。&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>About.vue 同理，改成 About 内容。</p>
<h5 data-id="heading-8">4. 在 main.js 注册路由</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h5 data-id="heading-9">5. 在 App.vue 使用路由</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 无需额外导入，&lt;script setup&gt; 下直接可用
&lt;/script&gt;

&lt;template&gt;
  &lt;header&gt;
    &lt;nav&gt;
      &lt;ul&gt;
        &lt;li&gt;&lt;router-link to="/"&gt;Home&lt;/router-link&gt;&lt;/li&gt;
        &lt;li&gt;&lt;router-link to="/about"&gt;About&lt;/router-link&gt;&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/nav&gt;
  &lt;/header&gt;
  &lt;main&gt;
    &lt;router-view /&gt;  &lt;!-- 这里渲染匹配的页面组件 --&gt;
  &lt;/main&gt;
&lt;/template&gt;

&lt;style scoped&gt;
nav ul { display: flex; list-style: none; gap: 20px; }
router-link { text-decoration: none; font-weight: bold; }
&lt;/style&gt;
</code></pre>
<p>运行 <code>npm run dev</code>，点击导航，就能无缝切换页面了！</p>
<h5 data-id="heading-10">路由模式详解：Hash vs History</h5>
<ul>
<li>
<p><strong>createWebHashHistory()</strong>（带 #）：URL 如 <code>/ '#/about</code>。优点：无需服务器配置，兼容性好（静态托管如 GitHub Pages 直接可用）。缺点：URL 不美观，不利于 SEO。</p>
</li>
<li>
<p><strong>createWebHistory()</strong>（推荐生产用）：URL 如 <code>/about</code>。干净美观，支持 SEO。但需要服务器配置 fallback（所有路径指向 index.html），否则刷新 404。</p>
</li>
</ul>
<p><strong>易错提醒</strong>：</p>
<ul>
<li>切换到 History 模式后，本地开发正常，但部署到 Nginx/Apache 时必须配置重写规则。</li>
<li>示例 Nginx 配置：
location / {
try_files <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>r</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">uri </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span></span></span></span></span>uri/ /index.html;
}</li>
<li>如果项目是纯静态部署，建议先用 Hash 模式，避免坑。</li>
</ul>
<h4 data-id="heading-11">五、几个细节知识点</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fbc0cb4dd1f4fac8243273448f6150b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LyaanM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766506199&amp;x-signature=QF5vZP2yy1WHmPm5F1LZWgj9PBY%3D" alt="fc962ce0cd306c49bc54248e80437e81.jpg" loading="lazy"/></p>
<h5 data-id="heading-12">1、<code>&lt;script type="module" src="/src/main.js"&gt;&lt;/script&gt;</code>，这就是利用 ESM 的关键！浏览器直接导入模块，按需加载。</h5>
<p>这是 Vite 极速开发的<strong>核心秘密</strong>！</p>
<ul>
<li>
<p><strong>导入的是什么模块？</strong> 浏览器直接把 /src/main.js 当作一个 <strong>ES Module（原生 JS 模块）</strong> 来导入。 main.js 里面有各种 import 语句，比如：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
</code></pre>
<p>所以，浏览器加载 main.js 后，会解析这些 import，继续去请求 'vue'、'./App.vue'、'./router/index.js' 等模块。</p>
</li>
<li>
<p><strong>按什么“需”加载？</strong> → <strong>按需加载（On-Demand Loading）</strong> 传统工具（如 Webpack + Vue CLI）在开发模式下，会先把所有代码打包成一个大 bundle.js，然后浏览器才加载这个大文件。项目一大，启动就卡几秒甚至十几秒。</p>
<p>Vite 完全不一样（开发模式下）：</p>
<ul>
<li>
<p>Vite 的 dev server 启动后，<strong>不预打包</strong>任何东西。</p>
</li>
<li>
<p>浏览器先加载 index.html → 执行 
</p></li>
<li>
<p>Vite server 收到请求 main.js 时，会实时转化代码（比如把 .vue 单文件组件转成 JS），然后返回。</p>
</li>
<li>
<p>main.js 执行时遇到 import，浏览器又会立刻去请求那些被导入的模块（Vite 帮忙预处理 .vue、CSS 等）。</p>
</li>
<li>
<p><strong>只有当前路径依赖到的模块才会被加载</strong>，没用到的根本不请求！</p>
</li>
</ul>
</li>
</ul>
<p>这就是“按需加载”：浏览器像蜘蛛网一样，一层一层按实际依赖和路由需求去拉取模块，而不是一次性全拉下来。</p>
<p>左边传统方式要等打包完，Vite 直接<strong>边用边加载</strong>，启动快得飞起！</p>
<h5 data-id="heading-13">2、index.html 里的 #app 挂载点</h5>
<p>这是单页应用（SPA）的精髓！很多人以为“多页面”就要多个 HTML 文件，其实完全不是。</p>
<ul>
<li>
<p><strong>只有一个挂载点</strong>：Vue 应用整个挂载在 #app 这个 div 上。</p>
<p>HTML</p>
<pre><code class="hljs language-bash" lang="bash">&lt;div <span class="hljs-built_in">id</span>=<span class="hljs-string">"app"</span>&gt;&lt;/div&gt;
</code></pre>
<p>main.js 里 createApp(App).mount('#app') 就是把根组件 App.vue 的内容渲染到这个 div 里。</p>
</li>
<li>
<p><strong>其他“页面”内容挂载在哪儿？</strong> 它们根本不是独立的 HTML 页面，而是 <strong>Vue 组件</strong>，通过 <strong>Vue Router 的 </strong> 动态插入到 App.vue 的模板里！</p>
<p>看你的 App.vue：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>导航...<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-view</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 关键就在这里！ --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<ul>
<li> 是一个占位符（Outlet）。</li>
<li>当你访问 / 时，Vue Router 会把 Home.vue 组件渲染到这个  位置。</li>
<li>访问 /about 时，就把 About.vue 渲染到同一个位置。</li>
<li>整个过程：<strong>页面不刷新</strong>，只有  里面的内容被替换，导航栏、footer 等公共部分保持不动。</li>
</ul>
<p>所以，整个应用永远只有一个 HTML（index.html），所有“页面切换”其实是组件的动态替换。URL 变了（hash 或 history 模式），但浏览器没重新加载整个页面。</p>
</li>
</ul>
<h5 data-id="heading-14">3、拆解 routes 数组，彻底搞清楚它在干啥：</h5>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> routes = [
  {
    path: <span class="hljs-string">'/'</span>,          <span class="hljs-comment">// 1. URL 路径</span>
    name: <span class="hljs-string">'Home'</span>,       <span class="hljs-comment">// 2. 路由名称（可选，但强烈推荐）</span>
    component: Home     <span class="hljs-comment">// 3. 当路径匹配时，要渲染的组件</span>
  },
  {
    path: <span class="hljs-string">'/about'</span>,
    name: <span class="hljs-string">'About'</span>,
    component: About
  }
];
</code></pre>
<h5 data-id="heading-15">每个字段的具体含义</h5>
<ol>
<li>
<p><strong>path: '/' 或 path: '/about' （去哪）</strong></p>
<ul>
<li>这就是浏览器地址栏里的<strong>路径</strong>。</li>
<li>当用户在浏览器输入或点击链接访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2F" target="_blank" title="http://localhost:5173/" ref="nofollow noopener noreferrer">http://localhost:5173/</a> 时，会匹配第一个路由（path: '/'）。</li>
<li>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2Fabout" target="_blank" title="http://localhost:5173/about" ref="nofollow noopener noreferrer">http://localhost:5173/about</a> 时，会匹配第二个路由。</li>
<li>如果用 Hash 模式，会是 #/ 和 #/about；用 History 模式就是干净的 / 和 /about。</li>
</ul>
<p><strong>简单说：path 决定了“用户访问什么地址时触发这个路由”</strong> 。</p>
</li>
<li>
<p><strong>name: 'Home' 或 name: 'About'（叫啥）</strong></p>
<ul>
<li>给这个路由起一个<strong>名字</strong>，方便在代码里引用。</li>
<li>比如用  跳转，或者在 JS 里 router.push({ name: 'Home' })。</li>
<li>虽然不是必须的，但大项目里用 name 跳转比写死 path 更安全（路径改了也不用到处改）。</li>
</ul>
</li>
<li>
<p><strong>component: Home 或 component: About（看啥）</strong></p>
<ul>
<li>
<p>这里就是<strong>引用前面 import 进来的组件</strong>。</p>
</li>
<li>
<p>Home 和 About 是你在文件顶部通过下面代码导入的变量：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>;
</code></pre>
</li>
<li>
<p>当路径匹配成功后，Vue Router 就会把这个组件渲染到 App.vue 里的  位置。</p>
</li>
</ul>
<p><strong>简单说：component 决定了“访问这个路径时，显示哪个页面内容”</strong> 。</p>
</li>
</ol>
<h4 data-id="heading-16">用大白话总结整个过程</h4>
<p>想象 Vue Router 是一个前台接待：</p>
<ul>
<li>用户来了，说：“我要去首页！”（浏览器地址变成 /）</li>
<li>前台（Vue Router）一看 routes 配置表：哦，path: '/' 对应 component: Home</li>
<li>然后把 Home.vue 这个“房间”（组件）打开，放到  这个展示柜里让你看</li>
<li>用户又说：“我要去关于页面！”（地址变成 /about）</li>
<li>前台再查表：path: '/about' 对应 component: About</li>
<li>就把 About.vue 放进去展示</li>
</ul>
<p>整个过程页面不刷新，只有展示柜里的内容换了。</p>
<h4 data-id="heading-17">六、总结与展望</h4>
<p>通过这篇文章，我们从 Vite 的极速原理出发，完整搭建了一个带路由的 Vue 3 项目。核心是理解 ESM + HMR（热模块替换） 的现代逻辑，让开发体验飞起。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 路由配置全解析：从多页应用到单页应用]]></title>    <link>https://juejin.cn/post/7584307643000602667</link>    <guid>https://juejin.cn/post/7584307643000602667</guid>    <pubDate>2025-12-16T18:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307643000602667" data-draft-id="7584273076646789126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 路由配置全解析：从多页应用到单页应用"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-16T18:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鸡腿大王"/> <meta itemprop="url" content="https://juejin.cn/user/4361104734828352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 路由配置全解析：从多页应用到单页应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4361104734828352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鸡腿大王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T18:49:40.000Z" title="Tue Dec 16 2025 18:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，路由管理是实现页面切换和导航的重要部分。React 作为流行的前端框架，使用 React Router 来处理单页应用（SPA）中的路由管理。本文将结合实际代码示例，讲解如何在 React 中配置和使用路由。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35f6bd84acd24ef38a75f1d866681d37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=mk5gkfAqeSMS92nR24TCSfenLr8%3D" alt="0341DB58.gif" loading="lazy"/></p>
<h2 data-id="heading-0">1. 多页应用 VS 单页应用</h2>
<p>传统的多页应用（MPA）每次用户请求一个新页面时，浏览器会重新加载整个页面。而在单页应用（SPA）中，整个应用只加载一次 HTML，页面内容的切换是通过 JavaScript 动态加载的。SPA 通过 React Router 来实现 URL 和页面组件的映射，只有在 URL 改变时，React Router 才会加载不同的组件，避免了页面的重加载。</p>
<p>例如，当用户访问以下 URL：</p>
<ul>
<li><code>http://localhost:5173/home</code> —— 显示首页组件</li>
<li><code>http://localhost:5173/about</code> —— 显示关于页面组件</li>
</ul>
<p>React Router 会根据 URL 改变，加载并渲染对应的组件，而无需刷新整个页面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a80c0cc2c15845d8826748bdc8ef7923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=%2Bu7R2dXW7g88RPkWc2SIs2HrmXM%3D" alt="03423976.gif" loading="lazy"/></p>
<h2 data-id="heading-1">2. React Router 路由配置详解</h2>
<p>React Router 提供了一些核心组件来帮助我们配置和管理路由，下面详细介绍这些组件及其使用方式。</p>
<h3 data-id="heading-2">2.1 BrowserRouter：路由模式</h3>
<p>在 React 中，<code>BrowserRouter</code> 是一个容器组件，它通过 HTML5 的 History API 实现路由的无刷新跳转。<code>BrowserRouter</code> 需要包裹整个应用，这样 React Router 才能识别和响应 URL 变化。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
        {/* 配置路由 */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span>
  );
}

</code></pre>
<h3 data-id="heading-3">2.2 Routes：路由配置容器</h3>
<p><code>Routes</code> 组件是一个路由配置的容器，它包含了多个 <code>Route</code> 配置项。每个 <code>Route</code> 都对应一个 URL 路径和一个组件，当 URL 路径匹配时，React Router 会渲染对应的组件。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/home"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span>
  );
}

</code></pre>
<h3 data-id="heading-4">2.3 Route：路由配置项</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ab77893c0243d19fe056e4d5facf72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=1nhNGxHknH1%2Frac9OnMrckRtoFk%3D" alt="03427DE2.gif" loading="lazy"/>
<code>Route</code> 组件是最基本的路由配置项。它通过 <code>path</code> 属性指定 URL 路径，通过 <code>element</code> 属性指定匹配路径时要渲染的组件。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/home"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span>} /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;</span>

</code></pre>
<h3 data-id="heading-5">2.4 Outlet：二级路由出口</h3>
<p>当我们有嵌套路由时，<code>Outlet</code> 组件用于渲染嵌套的子路由组件。父路由匹配时，<code>Outlet</code> 会渲染子路由组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8cd3551471742a6b55b64608df47cbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=ENgNibQ4WL3W1cDU%2BHXpztmCsDg%3D" alt="0342D5A6.gif" loading="lazy"/>
例如，我们有一个包含多个子页面的“用户”页面：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">"/user"</span> element={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">User</span> /&gt;</span></span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"profile"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Profile</span> /&gt;</span>} /&gt;</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"settings"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Settings</span> /&gt;</span>} /&gt;</span>
&lt;/<span class="hljs-title class_">Route</span>&gt;

</code></pre>
<p>在 <code>User</code> 组件中，我们使用 <code>Outlet</code> 来渲染 <code>Profile</code> 和 <code>Settings</code>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>User Page<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>  {/* 子路由渲染位置 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

</code></pre>
<h3 data-id="heading-6">2.5 Link：导航链接</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6a6920e0f234d57ba3fc7c447a1e858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=j0eKdPaUi3p%2Bdaw6XWVIoLpf1GE%3D" alt="03433683.gif" loading="lazy"/>
在单页应用中，我们使用 <code>Link</code> 组件来实现页面跳转，而不是传统的 <code>&lt;a&gt;</code> 标签。<code>Link</code> 组件会通过 React Router 来进行路由跳转，从而避免页面刷新。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Navbar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/home"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
  );
}

</code></pre>
<h3 data-id="heading-7">2.6 useNavigate：路由跳转</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c796ee9dfa5d4d6e97645378a0050e0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=5jy04DTHygrnOMFpNn5Si4d1aOc%3D" alt="03435AA5.gif" loading="lazy"/>
<code>useNavigate</code> 是 React Router 提供的 hook，可以在组件中编程式地跳转到指定的路由。通过 <code>useNavigate</code>，我们可以通过 JavaScript 动态控制路由跳转。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useNavigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">RedirectButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/about'</span>);  <span class="hljs-comment">// 编程式跳转到 "about" 页面</span>
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>Go to About<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}

</code></pre>
<h2 data-id="heading-8">3. 页面与组件的关系</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d055cbd68a944a59bddae498fc0ad825~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=i5bspxkmIxRT5482reUA2LIFt%2BI%3D" alt="0343B057.gif" loading="lazy"/>
在 React 项目中，<strong>页面</strong>和<strong>组件</strong>是两个不同的概念：</p>
<ul>
<li><strong>页面（Page）</strong> ：配置路由的组件被称为页面。每个页面通常对应一个独立的 URL 路径。</li>
<li><strong>组件（Component）</strong> ：没有直接配路由的组件，通常作为页面的子组件进行展示。</li>
</ul>
<p>例如，<code>Home</code> 和 <code>About</code> 是页面组件，而 <code>Navbar</code>、<code>Footer</code> 等则是一般的组件。</p>
<h2 data-id="heading-9">4. 完整代码示例</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022d98b2c1754cd9a93842b3606e5434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=%2Be92vsa1a0dXl0mxUgHWoa85rqo%3D" alt="0343FFCE.gif" loading="lazy"/>
以下是基于上述概念和 React Router 配置的实际代码示例，写了一个简单的后台管理系统，展示了如何在项目中配置和使用 React Router。</p>
<h3 data-id="heading-10">4.1 App.jsx</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41b9364e35384b4a8d2d7d1f5c16a4ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=pYB6z0tPren2bxLWwVo2w6YjXGs%3D" alt="03442E60.gif" loading="lazy"/></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span>, <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>, <span class="hljs-title class_">Navigate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/login/Login'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/Home/Home'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Class</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/class/Class'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Leetcode</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./views/leetcode/Leetcode'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/login"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Login</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/home"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/home"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/home/class"</span> /&gt;</span>} /&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/home/leetcode"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Leetcode</span> /&gt;</span>} /&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/home/class"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Class</span> /&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"*"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">h2</span>&gt;</span>404 Not Found<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span>
  );
}

</code></pre>
<p>4.2 Home.jsx</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54259bcef2bd4d9fab774a193217da01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=%2B8PQHSVzOVJy8V4tKe9u7%2B1xYRc%3D" alt="03446649.gif" loading="lazy"/></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Home.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./home.css'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Outlet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>后台管理系统<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"body"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"aside"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/home/class"</span>&gt;</span>课程<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/home/leetcode"</span>&gt;</span>算法<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"container"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

</code></pre>
<p>4.3 登录页面 (Login.jsx)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99d1e4a131464c01b80e8a9abd7b6616~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=ZLs9BMrzqR0sN5ZCG%2BRvo%2FsWbMU%3D" alt="0344A97C.gif" loading="lazy"/></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// Login.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./login.css'</span>;
<span class="hljs-keyword">import</span> { useNavigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Login</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/home?id=123'</span>);  <span class="hljs-comment">// 登录成功后跳转到首页</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"login"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"login-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>后台管理系统<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>账号:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入账号"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>密码:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"item"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{login}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

</code></pre>
<h2 data-id="heading-11">5. 总结</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c35bd7abee94725a3ef5c2bc8b952bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bih6IW_5aSn546L:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766515780&amp;x-signature=o9c2M9zGnDVsmS50p1NRavEHyjY%3D" alt="03451D54.gif" loading="lazy"/>
React Router 是管理 React 单页应用中路由和页面切换的重要工具。通过 <code>BrowserRouter</code>、<code>Routes</code>、<code>Route</code>、<code>Link</code> 等组件，你可以轻松地配置和管理页面跳转。而通过 <code>useNavigate</code> 等 API，你可以更加灵活地控制路由跳转。</p>
<p>希望这篇文章能帮助你更好地理解 React 路由的工作原理。如果你有任何问题，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Vue项目初识：从零开始搭建你的第一个现代前端工程化Vue3项目]]></title>    <link>https://juejin.cn/post/7584297353419997184</link>    <guid>https://juejin.cn/post/7584297353419997184</guid>    <pubDate>2025-12-16T17:37:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584297353419997184" data-draft-id="7584286241488502824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Vue项目初识：从零开始搭建你的第一个现代前端工程化Vue3项目"/> <meta itemprop="keywords" content="Vue.js,面试,前端"/> <meta itemprop="datePublished" content="2025-12-16T17:37:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Vue项目初识：从零开始搭建你的第一个现代前端工程化Vue3项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T17:37:01.000Z" title="Tue Dec 16 2025 17:37:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你正准备踏入 Vue 的世界，恭喜你选对了方向！Vue 是目前最受欢迎的前端框架之一，以其<strong>简洁优雅的语法、强大的响应式系统和极佳的开发体验</strong>，深受开发者喜爱。而今天我们要一起做的，就是<strong>亲手搭建一个标准的 Vue3 项目</strong>，并深入理解它背后的“现代前端工程化”思想。</p>
<p>别担心，这篇文章专为 <strong>零基础或刚入门的小白设计</strong>，我会用轻松欢快但不失专业的语言，带你一步步走进 Vue3 的世界，搞懂 <code>Vite</code>、<code>Vue Router</code>、<code>index.html</code>、<code>main.js</code> 等核心文件之间的关系，并告诉你——为什么现在的前端开发这么快、这么爽！</p>
<hr/>
<h2 data-id="heading-0">🚀 第一步：创建你的第一个 Vue3 项目</h2>
<p>我们使用的工具是 <strong>Vite</strong> —— 一个由 Vue 作者尤雨溪（Evan You）亲自打造的现代前端构建工具。它的口号是：“<strong>极速冷启动 + 极速热更新 = 开发幸福感爆棚！</strong>”</p>
<h3 data-id="heading-1">1. 使用命令初始化项目</h3>
<p>打开终端，输入以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm init vite
</code></pre>
<p>这会引导你完成项目的初始化过程：</p>
<ul>
<li>输入项目名称（比如 <code>my-vue-app</code>）</li>
<li>选择框架：<code>Vue</code></li>
<li>选择变体：<code>JavaScript</code> 或 <code>TypeScript</code>（新手建议选 JS）</li>
</ul>
<p>完成后进入项目目录并安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> my-vue-app
npm install
</code></pre>
<p>然后启动开发服务器：</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>几秒钟后，你会看到类似这样的输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">  VITE v4.x.x  ready in <span class="hljs-number">200</span>ms

  ➜  Local:   http:<span class="hljs-comment">//localhost:5173/</span>
  ➜  Network: use --host to expose
</code></pre>
<p>浏览器自动打开，显示 Vite 的欢迎页面 👏 —— 恭喜你，项目跑起来了！</p>
<blockquote>
<p>✅ 小贴士：Vite 能做到“秒开”，是因为它利用了浏览器原生支持的 <strong>ES Module (ESM)</strong>。传统打包工具如 Webpack 需要先打包整个应用才能运行，而 Vite 只在需要时动态加载模块，所以“冷启动”特别快！</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🧱 第二步：认识项目结构 —— 优秀架构长什么样？</h2>
<p>Vite 帮我们生成了一个非常标准且现代化的项目模板，这就是所谓的“<strong>工程化脚手架</strong>”。让我们来看看这个“家”里都有哪些重要成员：</p>
<pre><code class="hljs language-css" lang="css">my-vue-app/
├── index<span class="hljs-selector-class">.html</span>              ← 入口 <span class="hljs-selector-tag">HTML</span> 文件
├── package<span class="hljs-selector-class">.json</span>            ← 项目配置 &amp; 依赖管理
├── public/                 ← 静态资源（不会被处理）
├── <span class="hljs-attribute">src</span>/
│   ├── App<span class="hljs-selector-class">.vue</span>             ← 根组件
│   ├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.js</span>             ← 应用入口 JS
│   ├── components/         ← 可复用组件目录
│   └── views/              ← 页面级组件目录（待添加）
├── vite<span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.js</span>          ← Vite 配置文件（可选）
└── ...
</code></pre>
<p>是不是看起来井井有条？这种清晰的分层结构正是现代前端工程化的体现：<strong>分工明确、职责单一、易于维护</strong>。</p>
<p>接下来，我们重点剖析三个核心文件：<code>index.html</code>、<code>main.js</code> 和 <code>App.vue</code>。</p>
<hr/>
<h2 data-id="heading-3">🔗 第三步：打通任督二脉 —— index.html、main.js、App.vue 如何协作？</h2>
<h3 data-id="heading-4">📄 1. <code>index.html</code>：一切的起点</h3>
<p>这是整个应用的“门面”，也是浏览器最先加载的文件。虽然它看起来只是一个普通的 HTML，但它承载着至关重要的使命。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/vite.svg"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>all-vue<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 组件的挂载点 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 构建工作，前端界面开发的分水岭 
         Vue 很快，因为基于最新的 ESM（type="module"）
         只需要解析需要的文件，如果其他那就要解析更多文件，慢 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>🔍 <strong>关键点解析：</strong></p>
<ul>
<li><code>&lt;div id="app"&gt;</code>：这是 Vue 应用的“容器”，所有组件最终都会渲染到这里。</li>
<li><code>&lt;script type="module"&gt;</code>：使用了原生 ES 模块机制，意味着浏览器可以直接 import/export JS 模块，无需预先打包。</li>
<li><code>src="/src/main.js"</code>：告诉浏览器，“去执行 <code>/src/main.js</code> 这个模块”。</li>
</ul>
<p>💡 <strong>为什么快？</strong><br/>
因为 Vite 在开发环境下不进行完整打包，而是通过 HTTP Server 提供按需编译服务。当你访问 <code>/src/main.js</code> 时，Vite 才实时将其转换为浏览器可执行的代码。这就像是“按需点餐”，而不是“提前做好一整桌菜”。</p>
<hr/>
<h3 data-id="heading-5">⚙️ 2. <code>main.js</code>：应用的启动引擎</h3>
<p>这是 Vue 应用的“心脏”，负责创建实例、注册插件、挂载根组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue createApp 创建一个App</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-comment">// 引入路由模块</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-comment">// 现代前端应用</span>
<span class="hljs-comment">// 组件化，响应式....</span>
<span class="hljs-comment">// 跟DOM编程say byebye</span>
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  .<span class="hljs-title function_">use</span>(router) <span class="hljs-comment">// 启用路由</span>
  .<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>) <span class="hljs-comment">// 挂载在 #app 上</span>
</code></pre>
<p>🔍 <strong>逐行详解：</strong></p>





























<table><thead><tr><th>行数</th><th>说明</th></tr></thead><tbody><tr><td><code>import { createApp } from 'vue'</code></td><td>导入 Vue 提供的 <code>createApp</code> 工厂函数，用于创建应用实例</td></tr><tr><td><code>import App from './App.vue'</code></td><td>加载根组件 <code>App.vue</code></td></tr><tr><td><code>createApp(App)</code></td><td>创建一个 Vue 应用实例，传入根组件</td></tr><tr><td><code>.use(router)</code></td><td>安装 Vue Router 插件，启用路由功能</td></tr><tr><td><code>.mount('#app')</code></td><td>将应用挂载到 DOM 中的 <code>#app</code> 元素上</td></tr></tbody></table>
<p>🎯 <strong>划重点：</strong>
<code>.use()</code> 是 Vue 插件系统的入口。你可以用它来集成 Vuex（状态管理）、Pinia、UI库等。只要一个 <code>.use()</code>，就能让整个应用拥有新能力！</p>
<hr/>
<h3 data-id="heading-6">💖 3. <code>App.vue</code>：根组件，全家福舞台</h3>
<p><code>.vue</code> 文件是一种特殊的单文件组件（Single File Component, SFC），将模板、逻辑、样式封装在一起。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;&lt;/script&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;header&gt;
      &lt;nav&gt;
        &lt;ul&gt;
          &lt;!-- app.use(router)之后 vue-router 带给我们的全局组件 --&gt;
          &lt;li&gt;&lt;Router-link to="/"&gt;Home&lt;/Router-link&gt;&lt;/li&gt;
          &lt;li&gt;&lt;Router-link to="/about"&gt;About&lt;/Router-link&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/nav&gt;
    &lt;/header&gt;
    &lt;main&gt;
      &lt;!-- 多个页面的占位符 --&gt;
      &lt;router-view&gt;&lt;/router-view&gt;
    &lt;/main&gt;
    &lt;footer&gt;&lt;/footer&gt;
  &lt;/div&gt;
&lt;/template&gt;
&lt;style scoped&gt;
&lt;/style&gt;
</code></pre>
<p>🔍 <strong>三大块解析：</strong></p>
<h4 data-id="heading-7">✅ <code>&lt;template&gt;</code>：视图模板</h4>
<ul>
<li>写的是 HTML-like 结构，但支持 Vue 指令（如 <code>v-if</code>, <code>v-for</code>）。</li>
<li><code>&lt;Router-link&gt;</code> 是 Vue Router 提供的<strong>声明式导航组件</strong>，点击不会刷新页面，而是通过 JS 改变 URL 并切换视图。</li>
<li><code>&lt;router-view&gt;</code> 是一个“插座”，用来动态插入当前匹配的页面组件（比如 Home 或 About）。</li>
</ul>
<h4 data-id="heading-8">✅ <code>&lt;script&gt;</code>：业务逻辑</h4>
<ul>
<li>目前为空，后续可以写数据、方法、生命周期钩子等。</li>
<li>注意：在 Vue3 中推荐使用 <code>&lt;script setup&gt;</code> 语法糖，更简洁。</li>
</ul>
<h4 data-id="heading-9">✅ <code>&lt;style scoped&gt;</code>：局部样式</h4>
<ul>
<li><code>scoped</code> 表示这些 CSS 只作用于当前组件，避免全局污染。</li>
<li>编译后，Vite 会自动给元素添加唯一属性（如 <code>data-v-f3f3eg9</code>）实现样式隔离。</li>
</ul>
<hr/>
<h2 data-id="heading-10">🛣️ 第四步：多页面导航 —— 使用 Vue Router 实现 SPA</h2>
<p>现在我们的 App 只是一个静态页面。如何让它变成“多页应用”？答案是：<strong>前端路由（Frontend Routing）</strong>。</p>
<p>Vue 官方提供了 <code>vue-router</code> 来实现这一功能，让你无需刷新页面就能切换内容，打造真正的 SPA（Single Page Application）。</p>
<h3 data-id="heading-11">1. 安装 Vue Router</h3>
<pre><code class="hljs language-bash" lang="bash">npm install vue-router@4
</code></pre>
<blockquote>
<p>注：Vue3 对应的是 vue-router v4，不要装错版本哦！</p>
</blockquote>
<h3 data-id="heading-12">2. 创建路由配置文件：<code>src/router/index.js</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router 模块 定义路由</span>
<span class="hljs-comment">// https://juejin.cn/post/7046222222402390046</span>
<span class="hljs-keyword">import</span> {
    createRouter,           <span class="hljs-comment">// 创建前端路由实例</span>
    createWebHashHistory    <span class="hljs-comment">// 定义路由模式</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>;

<span class="hljs-keyword">const</span> routes = [
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span>
    },
    {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span>
    }
];

<span class="hljs-comment">// 实例化，负责前端路由</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
    <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),  <span class="hljs-comment">// 使用 hash 模式：#/about</span>
    routes                           <span class="hljs-comment">// 路由映射表</span>
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router;
</code></pre>
<p>🔍 <strong>核心概念讲解：</strong></p>





























<table><thead><tr><th>概念</th><th>解释</th></tr></thead><tbody><tr><td><code>createRouter()</code></td><td>创建路由实例的核心函数</td></tr><tr><td><code>createWebHashHistory()</code></td><td>使用 URL 的 hash 部分（即 <code>#</code> 后的内容）来管理路由。例如：<code>http://localhost:5173/#/about</code>。<br/>优点：不需要服务器配置，适合静态部署。</td></tr><tr><td><code>routes</code> 数组</td><td>定义路径与组件的映射关系。每个对象包含 <code>path</code>、<code>name</code>、<code>component</code>。</td></tr><tr><td><code>router-view</code></td><td>动态出口，根据当前 URL 自动渲染对应的组件。</td></tr><tr><td><code>Router-link</code></td><td>替代原生 <code>&lt;a&gt;</code> 标签，实现无刷新跳转。</td></tr></tbody></table>
<p>🎯 <strong>Hash vs History 模式对比：</strong></p>























<table><thead><tr><th>模式</th><th>示例 URL</th><th>是否需要后端配合</th><th>SEO 友好度</th></tr></thead><tbody><tr><td>Hash (<code>#</code>)</td><td><code>example.com/#/about</code></td><td>❌ 不需要</td><td>⚠️ 较差</td></tr><tr><td>History</td><td><code>example.com/about</code></td><td>✅ 需要重定向配置</td><td>✅ 更好</td></tr></tbody></table>
<p>新手推荐先用 <strong>Hash 模式</strong>，简单稳定，上线即用！</p>
<hr/>
<h3 data-id="heading-13">3. 创建页面组件：<code>src/views/Home.vue</code> 和 <code>About.vue</code></h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/Home.vue --&gt;
&lt;template&gt;
  &lt;div&gt;Home&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/views/About.vue --&gt;
&lt;template&gt;
  &lt;div&gt;About&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>👉 把它们放进 <code>views/</code> 目录，表示这是“页面级”组件，区别于 <code>components/</code> 中的通用小组件（如按钮、弹窗等）。</p>
<hr/>
<h2 data-id="heading-14">🔁 第五步：热更新 —— 修改即生效的魔法</h2>
<p>还记得我们运行 <code>npm run dev</code> 后打开的页面吗？</p>
<p>现在试着修改一下 <code>Home.vue</code> 的内容：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;Welcome to My First Vue App! 🎉&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>保存文件……看！浏览器瞬间刷新了！✨</p>
<p>这就是 Vite 的 <strong>Hot Module Replacement (HMR)</strong>，也就是“热更新”。</p>
<p>✅ <strong>它有多强？</strong></p>
<ul>
<li>修改 <code>.vue</code> 文件 → 组件局部更新，状态保留</li>
<li>修改 <code>.css</code> → 样式即时生效，无需刷新</li>
<li>修改 <code>.js</code> → 模块热替换，提升调试效率</li>
</ul>
<p>再也不用手动 Ctrl+R 刷新啦！简直是开发者福音 ❤️</p>
<hr/>
<h2 data-id="heading-15">🛠️ 第六步：提升开发体验 —— 必备工具推荐</h2>
<h3 data-id="heading-16">1. Volar：VS Code 官方插件</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3DVue.volar" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=Vue.volar" ref="nofollow noopener noreferrer">Volar</a> 是 Vue 团队推出的 VS Code 插件，取代旧版 Vetur，专为 Vue3 设计。</p>
<p>✅ 功能包括：</p>
<ul>
<li>✅ 智能提示（IntelliSense）</li>
<li>✅ 语法高亮</li>
<li>✅ 错误检查</li>
<li>✅ TypeScript 支持</li>
<li>✅ <code>&lt;script setup&gt;</code> 语法支持</li>
</ul>
<p>📌 安装方法：在 VS Code 扩展商店搜索 “Volar” 并安装即可。</p>
<blockquote>
<p>⚠️ 注意：如果你之前装过 Vetur，请禁用它，避免冲突！</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">2. Vue Devtools：Chrome 浏览器调试神器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevtools.vuejs.org%2F" target="_blank" title="https://devtools.vuejs.org/" ref="nofollow noopener noreferrer">Vue Devtools</a> 是专为 Vue 应用设计的浏览器扩展，让你可以：</p>
<ul>
<li>查看组件树结构</li>
<li>监听事件和 props</li>
<li>调试响应式数据</li>
<li>时间旅行调试（搭配 Pinia/Vuex）</li>
</ul>
<p>📌 安装方法：Chrome 商店搜索 “Vue Devtools” 安装，重启浏览器即可使用。</p>
<hr/>
<h2 data-id="heading-18">🤔 总结回顾：Vue 项目是如何运作的？</h2>
<p>让我们再梳理一遍整个流程，把碎片知识串联成体系：</p>
<ol>
<li>
<p><strong>用户访问 <code>index.html</code></strong></p>
<ul>
<li>浏览器加载 HTML</li>
<li>发现 <code>&lt;script type="module" src="/src/main.js"&gt;</code></li>
<li>向 Vite Server 请求该模块</li>
</ul>
</li>
<li>
<p><strong>Vite 处理模块请求</strong></p>
<ul>
<li>实时编译 <code>.vue</code> 文件为 JavaScript</li>
<li>返回给浏览器执行</li>
</ul>
</li>
<li>
<p><strong><code>main.js</code> 执行</strong></p>
<ul>
<li><code>createApp(App)</code> 创建 Vue 实例</li>
<li><code>.use(router)</code> 注册路由插件</li>
<li><code>.mount('#app')</code> 挂载到 DOM</li>
</ul>
</li>
<li>
<p><strong><code>App.vue</code> 渲染</strong></p>
<ul>
<li>显示导航菜单 <code>&lt;Router-link&gt;</code></li>
<li><code>&lt;router-view&gt;</code> 等待插入页面</li>
</ul>
</li>
<li>
<p><strong>用户点击“About”链接</strong></p>
<ul>
<li>URL 变为 <code>#/about</code></li>
<li>Vue Router 匹配路由规则</li>
<li>将 <code>About.vue</code> 渲染进 <code>&lt;router-view&gt;</code></li>
</ul>
</li>
<li>
<p><strong>任意文件修改</strong></p>
<ul>
<li>Vite 监听到变化</li>
<li>触发热更新（HMR）</li>
<li>浏览器局部刷新，用户体验丝滑</li>
</ul>
</li>
</ol>
<p>🎯 <strong>一句话总结：</strong></p>
<blockquote>
<p><strong>Vite 是现代前端工程化的基石，Vue 是构建用户界面的利器，Vue Router 让单页应用变得灵活，三者协同工作，打造出高效、快速、可维护的前端项目。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-19">🎉 结语：你已经迈出了最重要的一步！</h2>
<p>看到这里，你已经不再是“只会写 HTML 的小白”了。你掌握了：</p>
<ul>
<li>如何使用 Vite 快速搭建 Vue3 项目</li>
<li>理解了 <code>index.html</code>、<code>main.js</code>、<code>App.vue</code> 的协作机制</li>
<li>学会了用 <code>vue-router</code> 实现多页面导航</li>
<li>了解了热更新、组件化、工程化等现代前端核心理念</li>
</ul>
<p>前端的世界很大，Vue 只是其中一扇门。愿你在探索的路上，始终保持好奇与热情！</p>
<p>🎉 最后送你一句尤雨溪的话共勉：</p>
<blockquote>
<p>“<strong>The best way to learn is to build.</strong>”<br/>
（最好的学习方式，就是去创造。）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代前端开发工程化：从 Vite 到 Vue 3 路由实战]]></title>    <link>https://juejin.cn/post/7584345932943081523</link>    <guid>https://juejin.cn/post/7584345932943081523</guid>    <pubDate>2025-12-16T16:22:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584345932943081523" data-draft-id="7584276176671309851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代前端开发工程化：从 Vite 到 Vue 3 路由实战"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T16:22:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玉宇夕落"/> <meta itemprop="url" content="https://juejin.cn/user/3323164053734988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代前端开发工程化：从 Vite 到 Vue 3 路由实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323164053734988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玉宇夕落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T16:22:15.000Z" title="Tue Dec 16 2025 16:22:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 开发中，“工程化”已成为提升开发效率、保障项目质量的关键。本文将围绕 <strong>Vite 构建工具</strong>、<strong>Vue 3 路由系统（vue-router）</strong> 以及 <strong>项目入口机制</strong>，带你快速搭建一个结构清晰、可维护性强的前端项目，并深入解析其背后的工程化思想。</p>
<hr/>
<h2 data-id="heading-0">结论先行：<code>#</code> 在 Hash 路由中的真实作用</h2>
<blockquote>
<p><strong><code>#</code> 的核心作用并非 “唯一性”，而是作为「URL 锚点标识符」，实现前端路由的核心逻辑：隔离哈希值与服务器请求、前端独立控制路由。</strong></p>
</blockquote>
<h3 data-id="heading-1">一、<code>#</code> 的本质：URL 中的「哈希 / 锚点」</h3>
<p>在 URL 中，<code>#</code> 是官方定义的 <strong>片段标识符（Fragment Identifier）</strong> ，具有以下特性：</p>
<ul>
<li><strong>浏览器行为</strong>：<code>#</code> 及其后的内容（哈希值）<strong>不会被发送到服务器</strong>，仅在浏览器端生效；</li>
<li><strong>锚点原生作用</strong>：原本用于定位页面内的锚点（如 <code>&lt;a href="#top"&gt;</code> 跳转到页面顶部）；</li>
<li><strong>Hash 路由的复用</strong>：前端路由框架（Vue Router、React Router）<strong>复用这一特性</strong>，将 <code>#</code> 后的内容作为 “前端路由路径”，实现无刷新页面跳转。</li>
</ul>
<h3 data-id="heading-2">二、<code>#</code> 的核心作用（与 “唯一性” 无关）</h3>
<h4 data-id="heading-3">1. 隔离前端路由与服务器请求（核心价值）</h4>
<p>例如 URL：<code>http://localhost:5173/#/about</code></p>
<ul>
<li>浏览器向服务器发送请求时，<strong>只传递 <code>http://localhost:5173/</code></strong> ，<code>#/about</code> 被忽略；</li>
<li>服务器只需处理根路径，<strong>无需关心前端路由</strong>；</li>
<li>这解决了 <strong>单页应用（SPA）刷新 404</strong> 的问题——这是 Hash 路由最核心的价值，<strong>与“唯一性”完全无关</strong>。</li>
</ul>
<h4 data-id="heading-4">2. 前端独立控制路由状态</h4>
<ul>
<li><code>#</code> 后的哈希值变化会触发浏览器的 <code>hashchange</code> 事件（<strong>不会刷新页面</strong>）；</li>
<li>框架监听该事件，根据哈希值匹配路由规则，渲染不同组件（如 <code>/about</code> → 渲染 <code>About</code> 组件）；</li>
<li>哈希值可自由修改（如 <code>location.hash = '/home'</code>），是前端路由的  <strong>“载体”</strong> ，而非 “唯一标识”。</li>
</ul>
<h4 data-id="heading-5">3. 附带：可作为页面状态标识（非唯一性）</h4>
<ul>
<li>哈希值可用于标记业务状态（如 <code>#/article/123</code> 标识文章 ID）；</li>
<li>但这属于 <strong>业务层面的标识</strong>，<code>#</code> 本身只是承载容器；</li>
<li><strong>哈希值可重复</strong>（比如不同页面手动设为相同 <code>#/test</code>），浏览器不限制。</li>
</ul>
<h3 data-id="heading-6">三、为什么 “唯一性” 是错误认知？</h3>
<ul>
<li><code>#</code> 是 URL 的<strong>固定语法符号</strong>，不是“唯一标识符”：所有 Hash 路由都包含 <code>#</code>，它是统一的分隔符；</li>
<li><strong>哈希值本身也不保证唯一</strong>：你可以手动设置多个页面为相同哈希；</li>
<li><strong>唯一性需业务层面保证</strong>：通过路由规则配置（如 <code>/about</code>、<code>/home</code> 不重复）实现，与 <code>#</code> 无关。</li>
</ul>
<h3 data-id="heading-7">四、Hash 路由 vs History 路由（对比理解 <code>#</code> 的作用）</h3>






























<table><thead><tr><th>特性</th><th>Hash 模式（带 <code>#</code>）</th><th>History 模式（无 <code>#</code>）</th></tr></thead><tbody><tr><td>服务器请求</td><td>仅发送 <code>#</code> 前的路径</td><td>发送完整路径</td></tr><tr><td>刷新 404 问题</td><td><strong>无</strong>（服务器只需处理根路径）</td><td><strong>需服务器配置</strong>（重定向到 <code>index.html</code>）</td></tr><tr><td>兼容性</td><td>更好（支持低版本浏览器）</td><td>依赖 HTML5 History API</td></tr><tr><td>URL 美观性</td><td>带 <code>#</code>，相对不美观</td><td>无 <code>#</code>，更接近原生 URL</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>总结</strong>：<code>#</code> 在 Hash 路由中的核心价值是——<strong>利用浏览器对 URL 哈希的原生处理规则，实现前端无刷新路由，同时避免前端路由路径被发送到服务器</strong>。它是 <strong>“分隔符 / 载体”</strong> ，而非用于保证唯一性的标识。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">一、为什么选择 Vite？</h2>
<blockquote>
<p><strong>Vite</strong> 是由 Vue 作者尤雨溪开发的新一代前端构建工具，核心优势在于 <strong>极速冷启动</strong> 和 <strong>即时热更新（HMR）</strong> 。</p>
</blockquote>
<h3 data-id="heading-9">✨ 核心原理</h3>
<ul>
<li>利用现代浏览器原生支持的 <strong>ES 模块（ESM）</strong> ，无需打包即可直接加载模块。</li>
<li>开发阶段：按需编译，只处理当前请求的文件，启动速度极快。</li>
<li>生产环境：使用 Rollup 打包，兼顾性能与兼容性。</li>
</ul>
<h3 data-id="heading-10">🚀 快速初始化项目</h3>
<pre><code class="hljs language-perl" lang="perl">bash
编辑
npm create vite@latest <span class="hljs-keyword">my</span>-vue-app -- --template vue
cd <span class="hljs-keyword">my</span>-vue-app
npm install
npm run dev
</code></pre>
<p>此时，Vite 会：</p>
<ul>
<li>自动打开浏览器（如 <code>http://localhost:5173</code>）</li>
<li>监听 <code>src/</code> 下所有文件变更，实现 <strong>毫秒级热更新</strong></li>
<li>以 <code>index.html</code> 为入口，挂载到 <code>&lt;div id="app"&gt;&lt;/div&gt;</code></li>
</ul>
<hr/>
<h2 data-id="heading-11">二、标准项目结构解析</h2>
<p>Vite + Vue 3 提供了高度规范化的目录结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">text
编辑
my-vue-app/
├── index.html               <span class="hljs-meta"># 应用入口 HTML</span>
├── src/
│   ├── main.js              <span class="hljs-meta"># 应用入口 JS</span>
│   ├── App.vue              <span class="hljs-meta"># 根组件</span>
│   ├── style.css            <span class="hljs-meta"># 全局样式</span>
│   ├── components/          <span class="hljs-meta"># 可复用组件</span>
│   └── views/               <span class="hljs-meta"># 页面级组件（路由页面）</span>
├── <span class="hljs-keyword">public</span>/                  <span class="hljs-meta"># 静态资源（不参与构建）</span>
└── package.json             <span class="hljs-meta"># 依赖与脚本管理</span>
</code></pre>
<blockquote>
<p>💡 <strong>关键点</strong>：<code>main.js</code> 中通过 <code>createApp(App).mount('#app')</code> 将 Vue 应用挂载到 DOM。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">三、多页面应用：集成 Vue Router</h2>
<p>单页应用（SPA）需要路由来切换不同“页面”。Vue 官方推荐使用 <strong>vue-router</strong>。</p>
<h3 data-id="heading-13">第一步：先看整体结构（总览）</h3>
<p>这段代码是 Vue 项目中「路由配置文件」（<code>src/router/index.js</code>），核心分为 <strong>4 个部分</strong>：</p>
<ol>
<li><strong>导入 Vue Router 核心方法 + 页面组件</strong>；</li>
<li><strong>定义「路由规则数组」</strong>（URL 对应哪个组件）；</li>
<li><strong>创建「路由实例」</strong>（把规则和路由模式结合）；</li>
<li><strong>导出路由实例</strong>（让项目入口文件 <code>main.js</code> 能使用）。</li>
</ol>
<p>下面先看完整代码标注：</p>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-comment">// 1. 导入依赖：从 vue-router 库中拿需要的工具函数</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 2. 导入页面组件：从 views 目录导入 Home/About 组件（就是你要显示的页面）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>

<span class="hljs-comment">// 3. 定义路由规则：数组里每一个对象就是一条「URL → 组件」的规则</span>
<span class="hljs-keyword">const</span> routes = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span> }, <span class="hljs-comment">// 访问根路径 → 显示 Home 组件</span>
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">About</span> } <span class="hljs-comment">// 访问 /about → 显示 About 组件</span>
]

<span class="hljs-comment">// 4. 创建路由实例：把规则和路由模式（# 模式）结合，生成可使用的路由对象</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(), <span class="hljs-comment">// 路由模式：Hash 模式（URL 带 #）</span>
  routes <span class="hljs-comment">// 把上面定义的规则数组传给路由实例</span>
})

<span class="hljs-comment">// 5. 导出路由实例：让 main.js 能导入并挂载到 Vue 应用上</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<hr/>
<h3 data-id="heading-14">第二步：逐行拆解（零基础也能懂）</h3>
<h4 data-id="heading-15">1. 导入部分：拿工具 + 拿组件</h4>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-comment">// 从 vue-router 库中导入两个核心函数：createRouter、createWebHashHistory</span>
<span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
</code></pre>
<ul>
<li><code>createRouter</code>：创建路由实例的 “工厂函数” —— 你可以理解为 “造路由的模具”，调用它就能生成一个能工作的路由对象；</li>
<li><code>createWebHashHistory</code>：路由模式的 “生成器” —— 专门生成「Hash 模式」的路由历史（URL 带 <code>#</code>，比如 <code>http://localhost:5173/#/about</code>）；</li>
</ul>
<blockquote>
<p>🔍 <strong>补充</strong>：Vue Router 还有另一种模式 <code>createWebHistory()</code>（History 模式，URL 不带 <code>#</code>，比如 <code>http://localhost:5173/about</code>），但需要后端配置，新手建议先用 Hash 模式。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-comment">// 导入页面组件：../ 表示“上一级目录”，即从 router 目录回到 src 目录，再进 views 目录拿组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/Home.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../views/About.vue'</span>
</code></pre>
<ul>
<li>
<p><code>../views/Home.vue</code> 路径含义（新手重点）：</p>
<ul>
<li>当前文件在 <code>src/router/index.js</code>，<code>../</code> 是 “跳出 router 目录”，回到 <code>src</code> 目录；</li>
<li>然后进入 <code>views</code> 目录，找到 <code>Home.vue</code> 文件（就是你写的首页组件）；</li>
</ul>
</li>
<li>
<p><strong>作用</strong>：把页面组件 “拿进来”，让路由规则能关联到它。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-16">2. 定义路由规则数组：<code>const routes = [...]</code></h4>
<pre><code class="hljs language-ini" lang="ini">js
编辑
const <span class="hljs-attr">routes</span> = [
  { path: <span class="hljs-string">'/'</span>, name: <span class="hljs-string">'Home'</span>, component: Home },
  { path: <span class="hljs-string">'/about'</span>, name: <span class="hljs-string">'About'</span>, component: About }
]
</code></pre>
<p>这是核心规则：数组里的每个对象对应「一个 URL 路径 → 一个页面组件」，每个对象的 3 个核心属性：</p>





















<table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td><code>path</code></td><td><strong>访问的 URL 路径（必填）</strong> ： – <code>/</code> 表示 “根路径”（如 <code>http://localhost:5173/#/</code>） – <code>/about</code> 表示 “/about 路径”（如 <code>http://localhost:5173/#/about</code>）</td></tr><tr><td><code>name</code></td><td><strong>路由的 “别名”（可选，但推荐加）</strong> ： 后续可以用 <code>router.push({ name: 'About' })</code> 跳转，比写路径更灵活，便于后期维护</td></tr><tr><td><code>component</code></td><td><strong>路径对应的页面组件（必填）</strong> ： 就是你前面导入的 <code>Home</code>/<code>About</code> 组件，访问该路径时，页面就会渲染这个组件</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-17">3. 创建路由实例：<code>const router = createRouter({...})</code></h4>
<pre><code class="hljs language-scss" lang="scss">js
编辑
const router = <span class="hljs-built_in">createRouter</span>({
  history: createWebHashHistory(), <span class="hljs-comment">// 路由模式</span>
  routes <span class="hljs-comment">// 等价于 routes: routes（ES6 简写）</span>
})
</code></pre>
<ul>
<li>
<p><code>createRouter()</code>：调用第一步导入的 “造路由模具”，传入配置对象，生成一个「路由实例」（可以理解为 “能工作的路由器”）；</p>
</li>
<li>
<p><code>history: createWebHashHistory()</code>：指定路由的「历史模式」为 <strong>Hash 模式</strong>，核心特点：</p>
<ul>
<li>URL 中会带 <code>#</code>（比如 <code>#/about</code>），<code>#</code> 后面的内容不会发送到后端；</li>
<li>所以不需要后端配置（<strong>新手友好</strong>）；</li>
<li>例如访问 <code>http://localhost:5173/#/about</code>，浏览器只会把 <code>http://localhost:5173/</code> 发给服务器，<code>#/about</code> 由前端路由处理；</li>
</ul>
</li>
<li>
<p><code>routes</code>：把前面定义的规则数组传给路由实例，告诉路由器 “该怎么匹配 URL 和组件”。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-18">4. 导出路由实例：<code>export default router</code></h4>
<pre><code class="hljs language-arduino" lang="arduino">js
编辑
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<ul>
<li><strong>作用</strong>：把创建好的路由实例 “暴露出去”，让项目的入口文件（<code>src/main.js</code>）能导入并挂载到 Vue 应用上；</li>
<li><strong>类比</strong>：就像你造好了一个 “路由器”，现在把它拿出来，让整个 Vue 项目能使用这个路由器。</li>
</ul>
<hr/>
<h3 data-id="heading-19">第三步：这个文件的 “配套操作”（必须知道，否则路由不生效）</h3>
<p>光写路由配置文件还不够！必须完成以下两步，路由才能真正工作：</p>
<h4 data-id="heading-20">1. 在 <code>main.js</code> 中挂载路由</h4>
<blockquote>
<p><strong><code>main.js</code> 是 Vue 3 项目的入口文件（程序启动的第一个文件）</strong> ，负责创建 Vue 应用实例、配置插件、挂载到页面。</p>
</blockquote>
<p>逐行拆解如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-comment">// 1. import { createApp } from 'vue'</span>
<span class="hljs-comment">// 从 Vue 核心库导入 createApp 函数（创建应用的“工厂”）</span>
<span class="hljs-comment">// Vue 3 不再用 new Vue()，而是用 createApp 创建独立实例（支持多应用）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 2. import App from './App.vue'</span>
<span class="hljs-comment">// 导入根组件 App.vue —— 整个应用的“容器”</span>
<span class="hljs-comment">// 所有页面/组件最终都嵌套在 App.vue 内</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-comment">// 3. import router from './router'</span>
<span class="hljs-comment">// 导入路由实例（来自 src/router/index.js）</span>
<span class="hljs-comment">// ./router 会被自动识别为 ./router/index.js</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-comment">// 4. import './style.css'</span>
<span class="hljs-comment">// 导入全局样式，作用于整个应用</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>

<span class="hljs-comment">// 5. 链式调用：创建 → 注册 → 挂载</span>
<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
  .<span class="hljs-title function_">use</span>(router)     <span class="hljs-comment">// 注册路由插件（启用 &lt;router-link&gt;、&lt;router-view&gt; 等功能）</span>
  .<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)   <span class="hljs-comment">// 挂载到 HTML 中的 &lt;div id="app"&gt;&lt;/div&gt;</span>
</code></pre>
<blockquote>
<p>💡 <strong>链式调用等价写法（更易理解）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">js
编辑
const app = <span class="hljs-built_in">createApp</span>(App)
app<span class="hljs-selector-class">.use</span>(router)
app<span class="hljs-selector-class">.mount</span>('#app')
</code></pre>
</blockquote>
<h5 data-id="heading-21">关键概念补充：</h5>
<ul>
<li><strong>为什么是 <code>main.js</code>？</strong><br/>
Vite/Vue CLI 默认将其作为打包入口，最先执行。</li>
<li><strong>模块化（import/export）</strong><br/>
<code>router/index.js</code> 中 <code>export default router</code>，所以这里能 <code>import router</code>。</li>
<li><strong>单页应用（SPA）</strong><br/>
整个项目只有一个 HTML 文件（<code>public/index.html</code>），页面跳转靠路由实现，不刷新。</li>
</ul>
<blockquote>
<p>✅ <strong>一句话总结 <code>main.js</code> 的作用</strong>：<br/>
<strong>导入 Vue 核心工具、根组件、路由和全局样式 → 创建 Vue 应用实例 → 注册路由插件 → 把应用挂载到页面的 <code>#app</code> 元素上，最终启动整个 Vue 应用。</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-22">2. 在 <code>App.vue</code> 中添加路由出口</h4>
<blockquote>
<p><strong><code>.vue</code> 文件是 Vue 特有的单文件组件格式</strong>，一个文件就是一个独立组件，包含三部分：</p>
<ul>
<li><code>&lt;template&gt;</code>：结构</li>
<li><code>&lt;script&gt;</code>：逻辑</li>
<li><code>&lt;style&gt;</code>：样式</li>
</ul>
</blockquote>
<pre><code class="hljs language-xml" lang="xml">vue
编辑
<span class="hljs-comment">&lt;!-- src/App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 头部导航 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- Vue 路由链接：点击不刷新页面 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 主内容区 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 路由出口：页面组件在此动态渲染 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* scoped 样式仅作用于当前组件 */</span>
<span class="hljs-selector-tag">ul</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>; <span class="hljs-attribute">list-style</span>: none; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h5 data-id="heading-23">核心标签解释：</h5>

















<table><thead><tr><th>标签</th><th>作用</th></tr></thead><tbody><tr><td><code>&lt;router-link to="..."&gt;</code></td><td><strong>替代 <code>&lt;a&gt;</code> 的路由导航组件</strong> 点击不刷新页面，仅替换 <code>&lt;router-view&gt;</code> 内容</td></tr><tr><td><code>&lt;router-view /&gt;</code></td><td><strong>路由出口（占位符）</strong> 访问 <code>/</code> 时显示 <code>Home</code> 组件，访问 <code>/about</code> 时显示 <code>About</code> 组件</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>运行逻辑</strong>：</p>
<ol>
<li>访问 <code>http://localhost:5173/#/</code> → 匹配 <code>path: '/'</code> → 渲染 <code>Home</code> 到 <code>&lt;router-view&gt;</code></li>
<li>点击 “About” → URL 变为 <code>#/about</code> → 触发 <code>hashchange</code> → 渲染 <code>About</code> 组件<br/>
<strong>全程无刷新</strong>，因为 <code>#</code> 后内容由前端处理。</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-24">第四步：运行逻辑（新手必懂）</h3>
<p>当你启动项目（<code>npm run dev</code>）后，整个路由的工作流程如下：</p>
<ol>
<li>浏览器访问 <code>http://localhost:5173/#/</code><br/>
→ 路由实例匹配到 <code>path: '/'</code> 的规则<br/>
→ 把 <code>Home</code> 组件渲染到 <code>App.vue</code> 的 <code>&lt;router-view&gt;</code> 位置<br/>
→ 页面显示首页；</li>
<li>点击 <code>&lt;router-link to="/about"&gt;</code><br/>
→ URL 变成 <code>http://localhost:5173/#/about</code><br/>
→ 路由实例匹配到 <code>path: '/about'</code> 的规则<br/>
→ 把 <code>About</code> 组件渲染到 <code>&lt;router-view&gt;</code><br/>
→ 页面切换为关于页；</li>
</ol>
<p>✅ <strong>全程页面不会刷新</strong>（前端路由的核心优势），因为 <code>#</code> 后面的路径由前端处理，不请求后端。</p>
<hr/>
<h3 data-id="heading-25">第五步：新手常见疑问解答</h3>
<h4 data-id="heading-26">❓ 为什么用 <code>createWebHashHistory()</code> 而不是 <code>createWebHistory()</code>？</h4>

























<table><thead><tr><th>对比项</th><th>Hash 模式（<code>#</code>）</th><th>History 模式（无 <code>#</code>）</th></tr></thead><tbody><tr><td>URL 美观度</td><td>❌ 有 <code>#</code></td><td>✅ 干净路径</td></tr><tr><td>部署复杂度</td><td>✅ 任意静态服务器</td><td>❌ 需配置 fallback（如 Nginx 重定向到 <code>index.html</code>）</td></tr><tr><td>兼容性</td><td>✅ 所有浏览器</td><td>✅ 现代浏览器（IE 不支持）</td></tr></tbody></table>
<blockquote>
<p>📌 <strong>建议</strong>：初学者或静态站点用 <strong>Hash 模式</strong>；生产级 SPA 推荐 <strong>History 模式 + 服务端支持</strong>。</p>
</blockquote>
<h4 data-id="heading-27">❓ <code>name: 'Home'</code> 有什么用？</h4>
<p>除了通过路径跳转（<code>router.push('/about')</code>），还能通过名称跳转：</p>
<pre><code class="hljs language-php" lang="php">js
编辑
<span class="hljs-comment">// 更灵活！后续如果修改 path（比如把 /about 改成 /about-us），</span>
<span class="hljs-comment">// 只需改路由规则里的 path，不用改所有跳转代码</span>
router.<span class="hljs-title function_ invoke__">push</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'About'</span> })
</code></pre>
<h4 data-id="heading-28">❓ 组件必须放在 <code>views</code> 目录吗？</h4>
<p><strong>不是强制的</strong>！<code>views</code> 是约定俗成的 “页面级组件” 目录（区别于 <code>components/</code> 中的功能组件），你也可以用 <code>pages/</code>，只要导入路径对应即可。</p>
<hr/>
<h2 data-id="heading-29">四、开发体验增强工具</h2>

















<table><thead><tr><th>工具</th><th>作用</th></tr></thead><tbody><tr><td><strong>Volar</strong>（VS Code 插件）</td><td>提供 Vue 3 的语法高亮、智能提示、类型检查</td></tr><tr><td><strong>Vue DevTools</strong>（浏览器插件）</td><td>调试组件状态、路由、Pinia/Vuex 等</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：禁用旧版 <strong>Vetur</strong>，避免与 Volar 冲突。</p>
</blockquote>
<hr/>
<h2 data-id="heading-30">五、总结要点</h2>

































<table><thead><tr><th>模块</th><th>关键知识点</th></tr></thead><tbody><tr><td><strong>Vite</strong></td><td>基于 ESM 的极速开发服务器，无需打包即可运行</td></tr><tr><td><strong><code>#</code> 的作用</strong></td><td>URL 哈希标识符，隔离前端路由与服务器请求，实现无刷新跳转</td></tr><tr><td><strong>路由配置</strong></td><td>定义 <code>path → component</code> 规则，创建 Hash 模式路由实例</td></tr><tr><td><strong><code>main.js</code></strong></td><td>创建应用 → 注册路由 → 挂载到 <code>#app</code>，启动整个 SPA</td></tr><tr><td><strong><code>App.vue</code></strong></td><td>使用 <code>&lt;router-link&gt;</code> 导航 + <code>&lt;router-view&gt;</code> 渲染页面</td></tr><tr><td><strong>工程化思维</strong></td><td>组件化、模块化、关注点分离（页面 vs 功能组件）</td></tr></tbody></table>
<h3 data-id="heading-31">💬 一句话记住路由核心</h3>
<blockquote>
<p>这段代码的作用是：创建一个 “Hash 模式” 的路由实例，定义了「根路径显示 Home 组件、/about 路径显示 About 组件」的规则，最后导出这个实例，让整个 Vue 应用能根据 URL 切换页面组件。</p>
</blockquote>
<hr/>
<h2 data-id="heading-32">六、注意事项</h2>
<ol>
<li>
<p><strong>路径别名</strong>：Vite 默认不支持 <code>@</code> 别名，需手动配置 <code>vite.config.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> { resolve } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>)
    }
  }
})
</code></pre>
</li>
<li>
<p><strong>热更新失效？</strong>  检查是否修改了非 <code>.vue</code>/<code>.js</code> 文件（如 <code>vite.config.js</code> 需重启）。</p>
</li>
<li>
<p><strong>TypeScript 支持</strong>：Vite 原生支持，初始化时选择 <code>vue-ts</code> 模板即可。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-33">结语</h2>
<p>从前端“写页面”到“构建工程”，Vite + Vue 3 + vue-router 的组合提供了<strong>开箱即用的现代化开发体验</strong>。掌握这套工具链，不仅能提升开发效率，更是迈向专业前端工程师的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[隐式类型转换：哈基米 == 猫 ？ true ：false]]></title>    <link>https://juejin.cn/post/7584307643000569899</link>    <guid>https://juejin.cn/post/7584307643000569899</guid>    <pubDate>2025-12-16T17:55:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307643000569899" data-draft-id="7583591656176762916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="隐式类型转换：哈基米 == 猫  ？ true ：false"/> <meta itemprop="keywords" content="JavaScript,面试,前端"/> <meta itemprop="datePublished" content="2025-12-16T17:55:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若倾"/> <meta itemprop="url" content="https://juejin.cn/user/3270387091383163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            隐式类型转换：哈基米 == 猫  ？ true ：false
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3270387091383163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若倾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T17:55:58.000Z" title="Tue Dec 16 2025 17:55:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">何意味？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e527774524478599b728245c646ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5YC-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766512558&amp;x-signature=3lscOVuTPNIYpoK5nRMgjyUsbv8%3D" alt="1765769833188_B34E5E5A-2929-45d0-9379-AFA04B8AD318.png" loading="lazy"/></p>
<p>如果我们以往只接触过一门强类型的编程语言，估计早已经皱起眉头，大呼一声“何意味？”。但是在js的世界中，一切是自由的。你甚至可以直接写一份 数字+引用数据类型 的代码而不报错。使得上段代码不报错的原因，其实是js在执行过程中发生了隐式类型转换。</p>
<h2 data-id="heading-1">类型转换的规则</h2>
<h3 data-id="heading-2">原始类型之间的转换</h3>
<ul>
<li>String =&gt;Number: 字符串内部只能包含"-""+"符号,否则转换值为NaN</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-string">"-123"</span>))<span class="hljs-comment">//只允许开头字符为“-+”，其它都为数字，则转换为数字</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-string">"123a"</span>)) <span class="hljs-comment">// 字符串内部包含非数字字符，则转换为NaN</span>
</code></pre>
<ul>
<li>Boolean =&gt;Number：true =&gt;1 | flase =&gt;0</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-literal">true</span>))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Number</span>(<span class="hljs-literal">false</span>))
</code></pre>
<ul>
<li>Number，Boolean =&gt;String : 直接加上“”变成字符串</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">String</span>(<span class="hljs-number">123</span>),<span class="hljs-title function_">typeof</span>(<span class="hljs-title class_">String</span>(<span class="hljs-number">123</span>)))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">String</span>(<span class="hljs-literal">true</span>),<span class="hljs-title function_">typeof</span>(<span class="hljs-title class_">String</span>(<span class="hljs-literal">true</span>)))
</code></pre>
<ul>
<li>String =&gt; Boolean: 非空则为true，否则为false</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(<span class="hljs-string">""</span>))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(<span class="hljs-string">"adadaw"</span>))
</code></pre>
<ul>
<li>Number =&gt; Boolean: 0则为false，否则为true</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(<span class="hljs-number">0</span>))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Boolean</span>(-<span class="hljs-number">1</span>))
</code></pre>
<h3 data-id="heading-3">引用类型  =&gt;  原始类型的转换</h3>
<ol>
<li>Toprimitive(obj)
这是js引擎内置的函数，功能是将引用类型转换为原始类型，我们没有办法直接调用，但是我们可以模拟一下它的内部实现</li>
</ol>
<pre><code class="hljs language-js" lang="js">其内部实现
<span class="hljs-title function_">toprimitive</span>(<span class="hljs-params">obj</span>)
{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> (obj.<span class="hljs-title function_">valueOf</span>())!=<span class="hljs-string">'object'</span>)
    {
        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">valueOf</span>();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> (obj.<span class="hljs-title function_">toString</span>())!=<span class="hljs-string">'object'</span>)
    {
        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">toString</span>();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"报错：未知类型错误"</span>;
}
</code></pre>
<ul>
<li>关于valueOf( )： 某些特殊的类型在设计之初已经设置好了，当该类型参与运算时，应当返回哪些类型的值，如果返回的是一个原始类型值，我们可以将其抛出，作为引用类型对象 =&gt; 原始类型 的值</li>
<li>关于toString（），几乎所有类型的对象都内置了toString方法，以字符串的形式展示数据，我们可以将其抛出，作为引用类型对象 =&gt; 原始类型 的值。</li>
<li>综上所述：引用类型 =&gt; 原始类型 的结果是可以预期的， 如果内置的valueOf（）函数定义了，使用原始类型展示本对象数据的方式，则直接抛出，否则抛出大概率是执行toString（）后抛出的字符串，不然就是报错了。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d24bbcdc6ea34a239a211b90e36d7ed1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5YC-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766512558&amp;x-signature=%2B2PNWgaUG5JgB4qEWHuIMnswVbU%3D" alt="未命名文件.png" loading="lazy"/></p>
<h2 data-id="heading-4">隐式类型转换</h2>
<h3 data-id="heading-5">何时发生？</h3>
<p>当运算符两端数据类型不同时就会发生。</p>
<ol>
<li>四则运算</li>
</ol>
<ul>
<li>在我们使用“+-x%”进行四则运算时</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 会隐藏式的将引用类型转换为原始类型</span>

<span class="hljs-comment">// 除”+“以外的运算时</span>
<span class="hljs-comment">//  原始类型 - 原始类型  =&gt;  number - number</span>
<span class="hljs-comment">//  引用类型 - 引用类型  =&gt;  toprimitive() - toprimitive() =&gt; number -number</span>
<span class="hljs-comment">//  原始类型 - 引用类型  =&gt;  number - toprimitive()  =&gt; number -number</span>


<span class="hljs-comment">// 执行”+“法运算时</span>
<span class="hljs-comment">// 原始类型（除string外） + 原始类型（除去string 外） =&gt; number + number</span>
<span class="hljs-comment">// string +  原始类型  =&gt;  string + string</span>
<span class="hljs-comment">// string +  引用类型  =&gt;  string + 引用类型.toString() </span>
<span class="hljs-comment">// 引用类型 + 原始类型=&gt;  引用类型.toString()  +  string </span>

<span class="hljs-comment">//例子</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([<span class="hljs-number">12</span>]+<span class="hljs-number">3</span>)
<span class="hljs-comment">// [12].toString =&gt;'12' </span>
<span class="hljs-comment">//'12'+ 3 =&gt; '12' + '3' = '123' </span>


<span class="hljs-comment">//例子</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()-<span class="hljs-number">3</span>) 
<span class="hljs-comment">//  toprimitiev(new Date()) =&gt; 1765874339393 </span>
<span class="hljs-comment">//  1765874339393 -3 =&gt;1765874339390</span>
</code></pre>
<ol start="2">
<li>关系运算</li>
</ol>
<ul>
<li>在我们使用“&gt;,&gt;=,&lt;,&lt;=”进行关系运算时</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 原始类型 &gt;= 原始类型（除string外）   =&gt;  number &gt;= number</span>
<span class="hljs-comment">// stirng  &gt;= string   =&gt;  按位比较Unicode码</span>

<span class="hljs-comment">// 关系运算时，会先将引用类型隐式转换为原始类型</span>
<span class="hljs-comment">// string  &gt;= 引用类型  =&gt;  string &gt;= toprimitive() </span>
<span class="hljs-comment">// boolean &gt;= 引用类型  =&gt;  number &gt;= toprimitiev() </span>
<span class="hljs-comment">// number  &gt;= 引用类型  =&gt;  number &gt;= toprimitive() </span>
<span class="hljs-comment">// 引用类型 &gt;= 引用类型  =&gt;  toprimitive() &gt;= toprimitive()  </span>

<span class="hljs-comment">// 例子</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([<span class="hljs-number">11</span>]&gt; <span class="hljs-number">10</span>)
<span class="hljs-comment">//  toprimitiev([11])=&gt; '11' ,Number('11') =&gt; 11</span>
<span class="hljs-comment">//  11 &gt; 10 =&gt; true</span>
</code></pre>
<ol start="3">
<li>条件判断</li>
</ol>
<ul>
<li>在我们使用“if,while,do while,!,? ”条件判断时，会尝试将引用类型转换为boolean型，虽然会尝试将引用类型转换为原始类型，但是不改变最终结果为true</li>
</ul>
<pre><code class="hljs language-js" lang="js">条件判断时，不会将引用类型转换为原始类型
<span class="hljs-comment">//在进行条件判断时</span>
<span class="hljs-comment">// 原始类型  =&gt; boolean</span>
<span class="hljs-comment">// 引用类型  =&gt; boolean  且必为true </span>

<span class="hljs-comment">// "!" 的使用,布尔值取反</span>
<span class="hljs-comment">// !true  =&gt; false</span>
<span class="hljs-comment">// !false =&gt; true</span>


<span class="hljs-comment">//例子</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(![]) <span class="hljs-comment">// false</span>

<span class="hljs-comment">//  ![] 向boolean转换。 </span>
<span class="hljs-comment">//  Boolean([]) =&gt; true</span>
<span class="hljs-comment">//  !true =&gt; false </span>

</code></pre>
<p>4.相等运算</p>
<ul>
<li>在我们使用“==”进行判断运算时</li>
</ul>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">// 原始类型 == 原始类型（除去string） =&gt;  number == number</span>
<span class="hljs-comment">// string == string     =&gt;  按位比较Uicode码</span>
<span class="hljs-comment">// stirng  == 引用类型   =&gt;  string == 引用类型.toString() =&gt; string == string</span>
<span class="hljs-comment">// number == 引用类型    =&gt;  number == toprimitive() =&gt; number &gt;= number</span>
<span class="hljs-comment">// boolean == 引用类型   =&gt;  number == toprimitive() =&gt; number &gt;= number</span>
<span class="hljs-comment">// 引用类型 == 引用类型   =&gt;  直接比较地址，不进行隐式转换</span>




<span class="hljs-comment">//例子</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([]==![]) <span class="hljs-comment">// true</span>

<span class="hljs-comment">// ![] 先向boolean转换，再转为数字。</span>
<span class="hljs-comment">// Boolean([]) =&gt; true , !true =&gt; false</span>

<span class="hljs-comment">// [] == flase (引用类型 == 布尔类型) </span>
<span class="hljs-comment">//Number(false) =&gt; 0</span>
<span class="hljs-comment">//toprimitive([])=&gt;'', Number('') =&gt; 0 </span>
<span class="hljs-comment">// 0 == 0 =&gt; true</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([]==[]) <span class="hljs-comment">// false</span>


</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React状态提升：为什么它是你项目架构的救星？]]></title>    <link>https://juejin.cn/post/7584320417307099187</link>    <guid>https://juejin.cn/post/7584320417307099187</guid>    <pubDate>2025-12-17T00:21:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417307099187" data-draft-id="7584279552433995814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" React状态提升：为什么它是你项目架构的救星？"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-17T00:21:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             React状态提升：为什么它是你项目架构的救星？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:21:18.000Z" title="Wed Dec 17 2025 00:21:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是状态提升？</h2>
<p>简单来说，<strong>状态提升就是将多个组件需要共享的状态，移动到它们最近的共同父组件中</strong>。这样，状态就“提升”到了更高的层级，然后通过props传递给需要它的子组件。</p>
<p>让我们从一个生动的例子开始理解：</p>
<p>想象一下，你正在开发一个温度转换器。有两个输入框：一个输入摄氏温度，一个输入华氏温度。当你在一个输入框中输入数值时，另一个输入框应该自动显示转换后的温度。</p>
<h3 data-id="heading-1">错误做法：各自为政</h3>
<pre><code class="hljs language-ini" lang="ini">// 错误示范：两个组件各自管理自己的状态
function CelsiusInput() {
  const <span class="hljs-section">[celsius, setCelsius]</span> = useState('')<span class="hljs-comment">;</span>
  
  return (
    &lt;input
      <span class="hljs-attr">value</span>={celsius}
      <span class="hljs-attr">onChange</span>={(e) =&gt; setCelsius(e.target.value)}
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"摄氏温度"</span>
    /&gt;
  )<span class="hljs-comment">;</span>
}

function FahrenheitInput() {
  const <span class="hljs-section">[fahrenheit, setFahrenheit]</span> = useState('')<span class="hljs-comment">;</span>
  
  return (
    &lt;input
      <span class="hljs-attr">value</span>={fahrenheit}
      <span class="hljs-attr">onChange</span>={(e) =&gt; setFahrenheit(e.target.value)}
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"华氏温度"</span>
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>这样写，两个输入框之间<strong>完全无法通信</strong>！改了一个，另一个根本不知道。</p>
<h3 data-id="heading-2">正确做法：状态提升</h3>
<pre><code class="hljs language-ini" lang="ini">// 正确做法：状态提升到父组件
function TemperatureConverter() {
  // 状态提升到这里！
  const <span class="hljs-section">[temperature, setTemperature]</span> = useState('')<span class="hljs-comment">;</span>
  const <span class="hljs-section">[scale, setScale]</span> = useState('c')<span class="hljs-comment">;</span>
  
  // 转换函数
  const <span class="hljs-attr">celsius</span> = scale === <span class="hljs-string">'f'</span> ? tryConvert(temperature, toCelsius) : temperature<span class="hljs-comment">;</span>
  const <span class="hljs-attr">fahrenheit</span> = scale === <span class="hljs-string">'c'</span> ? tryConvert(temperature, toFahrenheit) : temperature<span class="hljs-comment">;</span>
  
  return (
    &lt;div&gt;
      &lt;CelsiusInput
        <span class="hljs-attr">temperature</span>={celsius}
        <span class="hljs-attr">onTemperatureChange</span>={(value) =&gt; {
          setTemperature(value)<span class="hljs-comment">;</span>
          setScale('c')<span class="hljs-comment">;</span>
        }}
      /&gt;
      &lt;FahrenheitInput
        <span class="hljs-attr">temperature</span>={fahrenheit}
        <span class="hljs-attr">onTemperatureChange</span>={(value) =&gt; {
          setTemperature(value)<span class="hljs-comment">;</span>
          setScale('f')<span class="hljs-comment">;</span>
        }}
      /&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}

// 子组件变得非常简单
function CelsiusInput({ temperature, onTemperatureChange }) {
  return (
    &lt;input
      <span class="hljs-attr">value</span>={temperature}
      <span class="hljs-attr">onChange</span>={(e) =&gt; <span class="hljs-literal">on</span>TemperatureChange(e.target.value)}
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"摄氏温度"</span>
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>看到了吗？通过将状态提升到父组件，我们实现了：</p>
<ol>
<li>1. <strong>单一数据源</strong>：温度数据只有一个来源</li>
<li>2. <strong>双向同步</strong>：一个输入框变化，另一个自动更新</li>
<li>3. <strong>逻辑集中</strong>：所有转换逻辑都在父组件中</li>
</ol>
<h2 data-id="heading-3">为什么状态提升如此重要？</h2>
<h3 data-id="heading-4">1. 保持数据同步</h3>
<p>当多个组件需要反映相同的变化时，状态提升确保它们都基于同一数据源。这是避免数据不一致的最佳实践。</p>
<h3 data-id="heading-5">2. 简化组件</h3>
<p>子组件可以保持为“受控组件”，只负责渲染和事件触发，逻辑处理交给父组件。</p>
<h3 data-id="heading-6">3. 便于调试</h3>
<p>数据流变得清晰可追踪。你只需要在一个地方检查状态，而不是在多个组件中跳来跳去。</p>
<h3 data-id="heading-7">4. 促进代码复用</h3>
<p>逻辑集中的父组件可以更容易地被复用或重构。</p>
<h2 data-id="heading-8">状态提升的五大使用场景</h2>
<h3 data-id="heading-9">场景一：表单控件组</h3>
<p>表单中多个输入字段需要相互影响或联合验证。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">RegistrationForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">confirmPassword</span>: <span class="hljs-string">''</span>
  });
  
  <span class="hljs-comment">// 密码一致性检查</span>
  <span class="hljs-keyword">const</span> passwordsMatch = formData.<span class="hljs-property">password</span> === formData.<span class="hljs-property">confirmPassword</span>;
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.username}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{/*</span> <span class="hljs-attr">...</span> */} /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.email}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{/*</span> <span class="hljs-attr">...</span> */} /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.password}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{/*</span> <span class="hljs-attr">...</span> */} /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.confirmPassword}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{/*</span> <span class="hljs-attr">...</span> */} /&gt;</span>
      {!passwordsMatch &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>密码不匹配！<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">场景二：数据筛选和搜索</h3>
<p>列表组件和筛选器组件需要紧密协作。</p>
<pre><code class="hljs language-ini" lang="ini">function ProductPage() {
  const <span class="hljs-section">[products]</span> = useState(<span class="hljs-section">[/* 产品列表 */]</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[filter, setFilter]</span> = useState({
    category: 'all',
    priceRange: <span class="hljs-section">[0, 1000]</span>,
    inStockOnly: false
  })<span class="hljs-comment">;</span>
  
  // 筛选逻辑集中在父组件
  const <span class="hljs-attr">filteredProducts</span> = products.filter(product =&gt; {
    return (
      (<span class="hljs-attr">filter.category</span> === <span class="hljs-string">'all'</span> || product.category === filter.category) &amp;&amp;
      product.price &gt;= filter.priceRange<span class="hljs-section">[0]</span> &amp;&amp;
      product.price &lt;= filter.priceRange<span class="hljs-section">[1]</span> &amp;&amp;
      (!filter.inStockOnly || product.inStock)
    )<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
  
  return (
    &lt;&gt;
      &lt;FilterControls <span class="hljs-attr">filter</span>={filter} <span class="hljs-literal">on</span>FilterChange={setFilter} /&gt;
      &lt;ProductList <span class="hljs-attr">products</span>={filteredProducts} /&gt;
    &lt;/&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-11">场景三：多步骤向导</h3>
<p>多个步骤共享表单数据。</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">SignupWizard</span>() {
  const <span class="hljs-selector-attr">[userData, setUserData]</span> = <span class="hljs-built_in">useState</span>({
    personalInfo: {},
    preferences: {},
    paymentInfo: {}
  });
  
  const <span class="hljs-selector-attr">[currentStep, setCurrentStep]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
  
  return (
    &lt;div&gt;
      {currentStep === <span class="hljs-number">0</span> &amp;&amp; (
        &lt;PersonalInfoStep
          data={userData.personalInfo}
          onChange={(info) =&gt; <span class="hljs-built_in">setUserData</span>({...userData, personalInfo: info})}
          onNext={() =&gt; <span class="hljs-built_in">setCurrentStep</span>(<span class="hljs-number">1</span>)}
        /&gt;
      )}
      {currentStep === <span class="hljs-number">1</span> &amp;&amp; (
        &lt;PreferencesStep
          data={userData.preferences}
          onChange={(prefs) =&gt; <span class="hljs-built_in">setUserData</span>({...userData, preferences: prefs})}
          onBack={() =&gt; <span class="hljs-built_in">setCurrentStep</span>(<span class="hljs-number">0</span>)}
          onNext={() =&gt; <span class="hljs-built_in">setCurrentStep</span>(<span class="hljs-number">2</span>)}
        /&gt;
      )}
      {<span class="hljs-comment">/* 更多步骤 */</span>}
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
}
</code></pre>
<h3 data-id="heading-12">场景四：实时协作功能</h3>
<p>多个用户界面元素需要实时同步。</p>
<pre><code class="hljs language-ini" lang="ini">function CollaborativeWhiteboard() {
  const <span class="hljs-section">[drawingData, setDrawingData]</span> = useState({
    elements: <span class="hljs-section">[]</span>,
    selectedTool: 'pen',
    color: '<span class="hljs-comment">#000000',</span>
    users: <span class="hljs-section">[]</span>
  })<span class="hljs-comment">;</span>
  
  // 通过WebSocket同步数据
  useEffect(() =&gt; {
    socket.on('drawing-update', (data) =&gt; {
      setDrawingData(data)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
  
  return (
    &lt;&gt;
      &lt;Toolbar
        <span class="hljs-attr">selectedTool</span>={drawingData.selectedTool}
        <span class="hljs-attr">color</span>={drawingData.color}
        <span class="hljs-attr">onToolChange</span>={(tool) =&gt; setDrawingData({...drawingData, selectedTool: tool})}
      /&gt;
      &lt;Canvas
        <span class="hljs-attr">elements</span>={drawingData.elements}
        <span class="hljs-attr">onDraw</span>={(element) =&gt; {
          const <span class="hljs-attr">newElements</span> = [...drawingData.elements, element]<span class="hljs-comment">;</span>
          setDrawingData({...drawingData, elements: newElements})<span class="hljs-comment">;</span>
          socket.emit('draw', newElements)<span class="hljs-comment">;</span>
        }}
      /&gt;
      &lt;UserList <span class="hljs-attr">users</span>={drawingData.users} /&gt;
    &lt;/&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-13">场景五：购物车和电商功能</h3>
<p>购物车状态需要在多个组件间共享。</p>
<pre><code class="hljs language-ini" lang="ini">function ECommerceApp() {
  const <span class="hljs-section">[cart, setCart]</span> = useState(<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[cartTotal, setCartTotal]</span> = useState(0)<span class="hljs-comment">;</span>
  
  // 计算总价
  useEffect(() =&gt; {
    const <span class="hljs-attr">total</span> = cart.reduce((sum, item) =&gt; sum + item.price * item.quantity, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    setCartTotal(total)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[cart]</span>)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">addToCart</span> = (product) =&gt; {
    setCart(<span class="hljs-section">[...cart, {...product, quantity: 1}]</span>)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">updateQuantity</span> = (productId, quantity) =&gt; {
    setCart(cart.map(<span class="hljs-attr">item</span> =&gt; 
      <span class="hljs-attr">item.id</span> === productId ? {...item, quantity} : item
    ))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  return (
    &lt;&gt;
      &lt;ProductList <span class="hljs-attr">onAddToCart</span>={addToCart} /&gt;
      &lt;CartSummary <span class="hljs-attr">cart</span>={cart} total={cartTotal} /&gt;
      &lt;CheckoutButton <span class="hljs-attr">cart</span>={cart} total={cartTotal} /&gt;
    &lt;/&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-14">状态提升的最佳实践</h2>
<h3 data-id="heading-15">1. 找到合适的提升层级</h3>
<p>不要盲目提升到最高层级的组件。提升到<strong>最近的共同祖先</strong>即可。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果只有ComponentA和ComponentB需要共享状态</span>
<span class="hljs-comment">// 提升到它们的父组件，而不是App组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [sharedState, setSharedState] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{sharedState}</span> <span class="hljs-attr">setState</span>=<span class="hljs-string">{setSharedState}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{sharedState}</span> <span class="hljs-attr">setState</span>=<span class="hljs-string">{setSharedState}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-16">2. 使用自定义Hook简化复杂状态</h3>
<p>当提升的状态变得复杂时，考虑使用自定义Hook。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义Hook处理复杂状态逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useForm</span>(<span class="hljs-params">initialValues</span>) {
  <span class="hljs-keyword">const</span> [values, setValues] = <span class="hljs-title function_">useState</span>(initialValues);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">name, value</span>) =&gt; {
    <span class="hljs-title function_">setValues</span>({...values, [name]: value});
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetForm</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setValues</span>(initialValues);
  };
  
  <span class="hljs-keyword">return</span> { values, handleChange, resetForm };
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { values, handleChange } = <span class="hljs-title function_">useForm</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
  });
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{values.username}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleChange('username', e.target.value)}
      /&gt;
      {/* 更多字段 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-17">3. 避免过度提升</h3>
<p>不是所有状态都需要提升。如果状态只在一个组件内部使用，就让它留在那里。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不需要提升的例子</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">DropdownMenu</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 这个状态不需要提升，只在当前组件使用</span>
  <span class="hljs-keyword">const</span> [isOpen, setIsOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsOpen(!isOpen)}&gt;菜单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {isOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"dropdown"</span>&gt;</span>
          {/* 菜单内容 */}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-18">常见陷阱与解决方案</h2>
<h3 data-id="heading-19">陷阱一：Props drilling（属性钻取）</h3>
<p>当状态提升过多层级时，会导致中间组件传递它们不关心的props。</p>
<p><strong>解决方案：使用Context API</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>();

<span class="hljs-comment">// 在顶层提供值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">user</span>, <span class="hljs-attr">setUser</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MainContent</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Footer</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在深层子组件中直接使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-20">陷阱二：过度渲染</h3>
<p>状态提升可能导致不必要的重新渲染。</p>
<p><strong>解决方案：使用React.memo和useCallback</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用React.memo防止不必要的重新渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ExpensiveComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-comment">// 复杂渲染逻辑</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{/* 渲染内容 */}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});

<span class="hljs-comment">// 使用useCallback保持函数引用稳定</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>({});
  
  <span class="hljs-keyword">const</span> handleChange = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
    <span class="hljs-title function_">setState</span>(newValue);
  }, []);
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span></span>;
}
</code></pre>
<h2 data-id="heading-21">总结</h2>
<p>状态提升是React开发中的<strong>基石概念</strong>，它解决了组件间数据共享和同步的核心问题。掌握状态提升，意味着你：</p>
<ol>
<li>1. <strong>理解了React的单向数据流哲学</strong></li>
<li>2. <strong>能够设计出可维护的组件架构</strong></li>
<li>3. <strong>避免了组件间数据不一致的噩梦</strong></li>
<li>4. <strong>为后续学习Redux、MobX等状态管理库打下坚实基础</strong></li>
</ol>
<p>记住这个简单的原则：<strong>当多个组件需要反映相同的变化时，将共享的状态提升到它们最近的共同祖先中。</strong></p>
<p>实践出真知。在你的下一个React项目中，有意识地应用状态提升模式，你会发现代码的可维护性和可预测性显著提升。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3插槽的本质]]></title>    <link>https://juejin.cn/post/7584298069610381312</link>    <guid>https://juejin.cn/post/7584298069610381312</guid>    <pubDate>2025-12-17T00:35:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584298069610381312" data-draft-id="7584297353420095488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3插槽的本质"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-17T00:35:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微芒不朽"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894153592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3插槽的本质
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894153592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微芒不朽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:35:56.000Z" title="Wed Dec 17 2025 00:35:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>插槽（Slots）是 Vue 组件系统中一个强大而灵活的特性，它允许我们在组件之间传递模板内容。在 Vue3 中，插槽机制得到了进一步的优化和完善。本文将深入探讨 Vue3 插槽的本质，帮助开发者更好地理解和使用这一重要特性。</p>
<h2 data-id="heading-1">什么是插槽？</h2>
<p>插槽本质上是一种<strong>内容分发机制</strong>。它允许父组件向子组件传递任意的模板片段，这些片段可以在子组件内部被渲染到指定的位置。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 父组件 --&gt;
&lt;template&gt;
  &lt;MyButton&gt;
    &lt;span&gt;点击我&lt;/span&gt;
  &lt;/MyButton&gt;
&lt;/template&gt;

&lt;!-- 子组件 MyButton.vue --&gt;
&lt;template&gt;
  &lt;button class="my-button"&gt;
    &lt;slot&gt;&lt;/slot&gt; &lt;!-- 这里会渲染父组件传递的内容 --&gt;
  &lt;/button&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-2">插槽的底层实现原理</h2>
<h3 data-id="heading-3">编译时转换</h3>
<p>Vue 的编译器会将带有插槽的模板转换为函数调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模板编译前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">MyButton</span>, <span class="hljs-literal">null</span>, {
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'span'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'点击我'</span>)
  })
}

<span class="hljs-comment">// 子组件内部</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">props, { slots }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'button'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'my-button'</span> }, slots.<span class="hljs-property">default</span>?.())
}
</code></pre>
<h3 data-id="heading-4">插槽作为函数</h3>
<p>在 Vue3 中，插槽实际上是一个<strong>返回 VNode 数组的函数</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 插槽对象的结构</span>
<span class="hljs-keyword">const</span> slots = {
  <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [<span class="hljs-comment">/* VNode 数组 */</span>],
  <span class="hljs-attr">header</span>: <span class="hljs-function">() =&gt;</span> [<span class="hljs-comment">/* VNode 数组 */</span>],
  <span class="hljs-attr">footer</span>: <span class="hljs-function">() =&gt;</span> [<span class="hljs-comment">/* VNode 数组 */</span>]
}
</code></pre>
<h2 data-id="heading-5">不同类型的插槽</h2>
<h3 data-id="heading-6">1. 默认插槽</h3>
<p>最基础的插槽形式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件 --&gt;
&lt;template&gt;
  &lt;div class="card"&gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;!-- 父组件 --&gt;
&lt;template&gt;
  &lt;Card&gt;
    &lt;p&gt;这是卡片内容&lt;/p&gt;
  &lt;/Card&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-7">2. 具名插槽</h3>
<p>通过 <code>name</code> 属性区分不同的插槽位置：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件 --&gt;
&lt;template&gt;
  &lt;div class="layout"&gt;
    &lt;header&gt;
      &lt;slot name="header"&gt;&lt;/slot&gt;
    &lt;/header&gt;
    &lt;main&gt;
      &lt;slot&gt;&lt;/slot&gt; &lt;!-- 默认插槽 --&gt;
    &lt;/main&gt;
    &lt;footer&gt;
      &lt;slot name="footer"&gt;&lt;/slot&gt;
    &lt;/footer&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;!-- 父组件 --&gt;
&lt;template&gt;
  &lt;Layout&gt;
    &lt;template #header&gt;
      &lt;h1&gt;页面标题&lt;/h1&gt;
    &lt;/template&gt;
  
    &lt;p&gt;主要内容&lt;/p&gt;
  
    &lt;template #footer&gt;
      &lt;p&gt;版权信息&lt;/p&gt;
    &lt;/template&gt;
  &lt;/Layout&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-8">3. 作用域插槽</h3>
<p>子组件可以向插槽传递数据：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 子组件 --&gt;
&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in items" :key="item.id"&gt;
      &lt;slot :item="item" :index="index"&gt;&lt;/slot&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;

&lt;script setup&gt;
const items = [
  { id: 1, name: '苹果' },
  { id: 2, name: '香蕉' }
]
&lt;/script&gt;

&lt;!-- 父组件 --&gt;
&lt;template&gt;
  &lt;ItemList&gt;
    &lt;template #default="{ item, index }"&gt;
      &lt;span&gt;{{ index + 1 }}. {{ item.name }}&lt;/span&gt;
    &lt;/template&gt;
  &lt;/ItemList&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-9">插槽的高级应用</h2>
<h3 data-id="heading-10">动态插槽名</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;BaseLayout&gt;
    &lt;template #[slotName]&gt;
      &lt;p&gt;动态内容&lt;/p&gt;
    &lt;/template&gt;
  &lt;/BaseLayout&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
const slotName = ref('header')
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-11">条件渲染插槽</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;Modal&gt;
    &lt;template #header v-if="showHeader"&gt;
      &lt;h2&gt;模态框标题&lt;/h2&gt;
    &lt;/template&gt;
  
    &lt;p&gt;模态框内容&lt;/p&gt;
  
    &lt;template #footer v-if="showFooter"&gt;
      &lt;button @click="close"&gt;关闭&lt;/button&gt;
    &lt;/template&gt;
  &lt;/Modal&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-12">插槽的默认内容</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="button-group"&gt;
    &lt;slot&gt;
      &lt;!-- 当没有提供插槽内容时显示默认内容 --&gt;
      &lt;button&gt;默认按钮&lt;/button&gt;
    &lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-13">性能考虑</h2>
<h3 data-id="heading-14">插槽的懒执行</h3>
<p>插槽函数只有在被调用时才会执行，这提供了很好的性能优化机会：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!-- 只有当 visible 为 true 时，插槽函数才会被执行 --&gt;
    &lt;slot v-if="visible"&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
defineProps({
  visible: Boolean
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-15">避免不必要的重新渲染</h3>
<p>合理使用 <code>v-memo</code> 和 <code>shouldComponentUpdate</code> 等优化手段：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;slot :data="memoizedData"&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { computed } from 'vue'

const props = defineProps(['items'])
const memoizedData = computed(() =&gt; {
  // 只有当 items 真正改变时才重新计算
  return processItems(props.items)
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-16">最佳实践</h2>
<h3 data-id="heading-17">1. 合理设计插槽 API</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 好的设计：清晰的插槽命名 --&gt;
&lt;template&gt;
  &lt;div class="data-table"&gt;
    &lt;slot name="header"&gt;&lt;/slot&gt;
    &lt;slot name="body" :rows="data"&gt;&lt;/slot&gt;
    &lt;slot name="footer"&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;!-- 不好的设计：插槽职责不清 --&gt;
&lt;template&gt;
  &lt;div class="data-table"&gt;
    &lt;slot name="content"&gt;&lt;/slot&gt;
    &lt;slot name="extra"&gt;&lt;/slot&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-18">2. 提供合理的默认行为</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button class="btn" :class="type"&gt;
    &lt;slot&gt;
      &lt;span&gt;{{ defaultText }}&lt;/span&gt;
    &lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
const props = defineProps({
  type: {
    type: String,
    default: 'primary'
  }
})

const defaultText = computed(() =&gt; {
  const texts = {
    primary: '确定',
    secondary: '取消',
    danger: '删除'
  }
  return texts[props.type] || '按钮'
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-19">3. 文档化插槽接口</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
/**
 * 卡片组件
 * 
 * @slot header - 卡片头部内容
 * @slot default - 卡片主体内容
 * @slot footer - 卡片底部内容
 * @slot actions - 卡片操作区域
 */
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-20">调试和开发工具支持</h2>
<p>Vue DevTools 提供了对插槽的良好支持，可以帮助我们：</p>
<ul>
<li>查看组件的插槽结构</li>
<li>检查插槽传递的数据</li>
<li>调试插槽相关的性能问题</li>
</ul>
<h2 data-id="heading-21">总结</h2>
<p>Vue3 的插槽本质上是一个强大的内容分发机制，它通过将插槽内容编译为函数来实现灵活性和性能的平衡。理解插槽的本质有助于我们：</p>
<ol>
<li><strong>更好地设计组件 API</strong> - 明确哪些部分应该开放给使用者自定义</li>
<li><strong>优化组件性能</strong> - 利用插槽的懒执行特性</li>
<li><strong>创建更灵活的组件</strong> - 通过作用域插槽传递数据，增强组件的可复用性</li>
</ol>
<p>掌握插槽的本质不仅能够帮助我们写出更好的 Vue 代码，还能让我们在遇到复杂场景时找到最优的解决方案。在实际开发中，我们应该根据具体需求选择合适的插槽类型，并遵循最佳实践来确保代码的可维护性和性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hello World，我的第一个TypeScript代码]]></title>    <link>https://juejin.cn/post/7584320417307476019</link>    <guid>https://juejin.cn/post/7584320417307476019</guid>    <pubDate>2025-12-17T01:30:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417307476019" data-draft-id="7584320417307426867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hello World，我的第一个TypeScript代码"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-17T01:30:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="常铭"/> <meta itemprop="url" content="https://juejin.cn/user/3826757754684648"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hello World，我的第一个TypeScript代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3826757754684648/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    常铭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:30:03.000Z" title="Wed Dec 17 2025 01:30:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 VS Code 中创建并运行一个 TypeScript 的 “Hello World” 程序，主要分为安装环境、创建文件和运行代码三个步骤。下面是为你梳理的具体操作流程。</p>
<h3 data-id="heading-0"><strong>第一步：准备工作（安装必要环境）</strong></h3>
<p>在开始之前，请确保你的电脑上已安装好以下两个基础工具：</p>
<ol>
<li>
<p><strong>Node.js</strong>：这是运行 JavaScript 和安装包管理工具 <code>npm</code> 的基础。请前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官网</a> 下载并安装 LTS（长期支持）版本。</p>
</li>
<li>
<p><strong>TypeScript 编译器</strong>：打开系统的终端（或 VS Code 的内置终端），输入以下命令进行全局安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetails%2F2925872" target="_blank" title="https://developer.baidu.com/article/details/2925872" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetail.html%3Fid%3D2822946%23%3A~%3Atext%3D%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E5%25AE%2589%25E8%25A3%2585TypeScript%25E6%258F%2592%25E4%25BB%25B6%25E6%259D%25A5%25E6%2594%25AF%25E6%258C%2581TypeScript%25E7%259A%2584%25E8%25AF%25AD%25E6%25B3%2595%25E9%25AB%2598%25E4%25BA%25AE%25E3%2580%2581%25E6%2599%25BA%25E8%2583%25BD%25E6%258F%2590%25E7%25A4%25BA%25E5%2592%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25A1%25A5%25E5%2585%25A8%25E7%25AD%2589%25E5%258A%259F%25E8%2583%25BD%25E3%2580%2582%2520%25E6%2589%2593%25E5%25BC%2580VSCode%25EF%25BC%258C%25E6%258C%2589%25E4%25B8%258B%2520Ctrl%252BShift%252BX%2C%25EF%25BC%2588Windows%252FLinux%25EF%25BC%2589%25E6%2588%2596%2520Cmd%252BShift%252BX%2520%25EF%25BC%2588Mac%25EF%25BC%2589%25E6%2589%2593%25E5%25BC%2580%25E6%2589%25A9%25E5%25B1%2595%25E9%259D%25A2%25E6%259D%25BF%25EF%25BC%258C%25E6%2590%259C%25E7%25B4%25A2%25E2%2580%259CTypeScript%25E2%2580%259D%25EF%25BC%258C%25E7%2584%25B6%25E5%2590%258E%25E9%2580%2589%25E6%258B%25A9%25E5%25AE%2598%25E6%2596%25B9%25E6%258F%2590%25E4%25BE%259B%25E7%259A%2584%25E6%258F%2592%25E4%25BB%25B6%25E8%25BF%259B%25E8%25A1%258C%25E5%25AE%2589%25E8%25A3%2585%25E3%2580%2582%2520%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E5%258F%25AF%25E4%25BB%25A5%25E9%2580%259A%25E8%25BF%2587%25E8%25AE%25BE%25E7%25BD%25AE%25E6%259D%25A5%25E9%2585%258D%25E7%25BD%25AETypeScript%25E7%259A%2584%25E7%25BC%2596%25E8%25AF%2591%25E9%2580%2589%25E9%25A1%25B9%25E3%2580%2582" target="_blank" title="https://developer.baidu.com/article/detail.html?id=2822946#:~:text=%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85TypeScript%E6%8F%92%E4%BB%B6%E6%9D%A5%E6%94%AF%E6%8C%81TypeScript%E7%9A%84%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E3%80%81%E6%99%BA%E8%83%BD%E6%8F%90%E7%A4%BA%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%A8%E7%AD%89%E5%8A%9F%E8%83%BD%E3%80%82%20%E6%89%93%E5%BC%80VSCode%EF%BC%8C%E6%8C%89%E4%B8%8B%20Ctrl%2BShift%2BX,%EF%BC%88Windows%2FLinux%EF%BC%89%E6%88%96%20Cmd%2BShift%2BX%20%EF%BC%88Mac%EF%BC%89%E6%89%93%E5%BC%80%E6%89%A9%E5%B1%95%E9%9D%A2%E6%9D%BF%EF%BC%8C%E6%90%9C%E7%B4%A2%E2%80%9CTypeScript%E2%80%9D%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%89%E6%8B%A9%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8F%92%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%E3%80%82%20%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AE%E6%9D%A5%E9%85%8D%E7%BD%AETypeScript%E7%9A%84%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E3%80%82" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.cn%2Fdeveloper%2Finformation%2F%25e5%25a6%2582%25e4%25bd%2595%25e5%259c%25a8VScode%25e4%25b8%25ad%25e8%25ae%25be%25e7%25bd%25aetypescript%25ef%25bc%259f-salon" target="_blank" title="https://cloud.tencent.cn/developer/information/%e5%a6%82%e4%bd%95%e5%9c%a8VScode%e4%b8%ad%e8%ae%be%e7%bd%aetypescript%ef%bc%9f-salon" ref="nofollow noopener noreferrer"/>：</p>
<p>bash</p>
<pre><code class="hljs">npm install -g typescript
</code></pre>
<p>安装完成后，可以通过输入 <code>tsc --version</code> 来验证是否成功，如果显示出版本号则说明安装正确<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.yisu.com%2Fjc%2F375511.html" target="_blank" title="https://m.yisu.com/jc/375511.html" ref="nofollow noopener noreferrer"/>。</p>
</li>
</ol>
<h3 data-id="heading-1"><strong>第二步：创建项目与文件</strong></h3>
<ol>
<li>
<p><strong>新建项目文件夹</strong>：在你的电脑上创建一个专门用于此项目的文件夹，例如 <code>my_ts_project</code>。</p>
</li>
<li>
<p><strong>用 VS Code 打开文件夹</strong>：启动 VS Code，通过菜单栏的 <code>文件</code> -&gt; <code>打开文件夹...</code> 选择你刚创建的文件夹。</p>
</li>
<li>
<p><strong>初始化 TypeScript 配置</strong>：在 VS Code 中，使用快捷键 <strong>Ctrl + `</strong> （反引号键）打开终端，然后运行命令生成配置文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetails%2F2925872" target="_blank" title="https://developer.baidu.com/article/details/2925872" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetails%2F3235433" target="_blank" title="https://developer.baidu.com/article/details/3235433" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.cn%2Fdeveloper%2Farticle%2F2385358" target="_blank" title="https://cloud.tencent.cn/developer/article/2385358" ref="nofollow noopener noreferrer"/>：</p>
<p>bash</p>
<pre><code class="hljs language-csharp" lang="csharp">tsc --<span class="hljs-keyword">init</span>
</code></pre>
<p>这会在你的文件夹中创建一个 <code>tsconfig.json</code> 文件，它定义了 TypeScript 如何编译。</p>
</li>
<li>
<p><strong>创建并编写 <code>.ts</code> 文件</strong>：在 VS Code 左侧的资源管理器中，右键点击空白处，选择“新建文件”。将文件命名为 <code>hello.ts</code>。然后，输入以下代码<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetail.html%3Fid%3D2822946%23%3A~%3Atext%3D%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E5%25AE%2589%25E8%25A3%2585TypeScript%25E6%258F%2592%25E4%25BB%25B6%25E6%259D%25A5%25E6%2594%25AF%25E6%258C%2581TypeScript%25E7%259A%2584%25E8%25AF%25AD%25E6%25B3%2595%25E9%25AB%2598%25E4%25BA%25AE%25E3%2580%2581%25E6%2599%25BA%25E8%2583%25BD%25E6%258F%2590%25E7%25A4%25BA%25E5%2592%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25A1%25A5%25E5%2585%25A8%25E7%25AD%2589%25E5%258A%259F%25E8%2583%25BD%25E3%2580%2582%2520%25E6%2589%2593%25E5%25BC%2580VSCode%25EF%25BC%258C%25E6%258C%2589%25E4%25B8%258B%2520Ctrl%252BShift%252BX%2C%25EF%25BC%2588Windows%252FLinux%25EF%25BC%2589%25E6%2588%2596%2520Cmd%252BShift%252BX%2520%25EF%25BC%2588Mac%25EF%25BC%2589%25E6%2589%2593%25E5%25BC%2580%25E6%2589%25A9%25E5%25B1%2595%25E9%259D%25A2%25E6%259D%25BF%25EF%25BC%258C%25E6%2590%259C%25E7%25B4%25A2%25E2%2580%259CTypeScript%25E2%2580%259D%25EF%25BC%258C%25E7%2584%25B6%25E5%2590%258E%25E9%2580%2589%25E6%258B%25A9%25E5%25AE%2598%25E6%2596%25B9%25E6%258F%2590%25E4%25BE%259B%25E7%259A%2584%25E6%258F%2592%25E4%25BB%25B6%25E8%25BF%259B%25E8%25A1%258C%25E5%25AE%2589%25E8%25A3%2585%25E3%2580%2582%2520%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E5%258F%25AF%25E4%25BB%25A5%25E9%2580%259A%25E8%25BF%2587%25E8%25AE%25BE%25E7%25BD%25AE%25E6%259D%25A5%25E9%2585%258D%25E7%25BD%25AETypeScript%25E7%259A%2584%25E7%25BC%2596%25E8%25AF%2591%25E9%2580%2589%25E9%25A1%25B9%25E3%2580%2582" target="_blank" title="https://developer.baidu.com/article/detail.html?id=2822946#:~:text=%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85TypeScript%E6%8F%92%E4%BB%B6%E6%9D%A5%E6%94%AF%E6%8C%81TypeScript%E7%9A%84%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E3%80%81%E6%99%BA%E8%83%BD%E6%8F%90%E7%A4%BA%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%A8%E7%AD%89%E5%8A%9F%E8%83%BD%E3%80%82%20%E6%89%93%E5%BC%80VSCode%EF%BC%8C%E6%8C%89%E4%B8%8B%20Ctrl%2BShift%2BX,%EF%BC%88Windows%2FLinux%EF%BC%89%E6%88%96%20Cmd%2BShift%2BX%20%EF%BC%88Mac%EF%BC%89%E6%89%93%E5%BC%80%E6%89%A9%E5%B1%95%E9%9D%A2%E6%9D%BF%EF%BC%8C%E6%90%9C%E7%B4%A2%E2%80%9CTypeScript%E2%80%9D%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%89%E6%8B%A9%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8F%92%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%E3%80%82%20%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AE%E6%9D%A5%E9%85%8D%E7%BD%AETypeScript%E7%9A%84%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E3%80%82" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaoshuo.qq.com%2Fread%2F1035433566%2F26" target="_blank" title="https://xiaoshuo.qq.com/read/1035433566/26" ref="nofollow noopener noreferrer"/>：</p>
<p>typescript</p>
<pre><code class="hljs language-ini" lang="ini">const greeting: <span class="hljs-attr">string</span> = <span class="hljs-string">'Hello, World!'</span><span class="hljs-comment">;</span>
console.log(greeting)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>操作提示</strong>：当你在 <code>.ts</code> 文件中输入代码时，VS Code 会自动提供语法高亮和智能提示，这是因为它内置了对 TypeScript 的基本支持。</p>
</li>
</ol>
<h3 data-id="heading-2"><strong>第三步：编译并运行代码</strong></h3>
<p>你有两种简单的方法来运行这个程序：</p>
<h4 data-id="heading-3"><strong>方法一：手动编译运行（推荐初学者理解过程）</strong></h4>
<p>这是最基础的方法，能让你清楚看到 TypeScript 被编译成 JavaScript 的过程。</p>
<ol>
<li>
<p><strong>编译</strong>：在终端中，运行以下命令，将 <code>.ts</code> 文件编译为 <code>.js</code> 文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetail.html%3Fid%3D2822946%23%3A~%3Atext%3D%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E5%25AE%2589%25E8%25A3%2585TypeScript%25E6%258F%2592%25E4%25BB%25B6%25E6%259D%25A5%25E6%2594%25AF%25E6%258C%2581TypeScript%25E7%259A%2584%25E8%25AF%25AD%25E6%25B3%2595%25E9%25AB%2598%25E4%25BA%25AE%25E3%2580%2581%25E6%2599%25BA%25E8%2583%25BD%25E6%258F%2590%25E7%25A4%25BA%25E5%2592%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25A1%25A5%25E5%2585%25A8%25E7%25AD%2589%25E5%258A%259F%25E8%2583%25BD%25E3%2580%2582%2520%25E6%2589%2593%25E5%25BC%2580VSCode%25EF%25BC%258C%25E6%258C%2589%25E4%25B8%258B%2520Ctrl%252BShift%252BX%2C%25EF%25BC%2588Windows%252FLinux%25EF%25BC%2589%25E6%2588%2596%2520Cmd%252BShift%252BX%2520%25EF%25BC%2588Mac%25EF%25BC%2589%25E6%2589%2593%25E5%25BC%2580%25E6%2589%25A9%25E5%25B1%2595%25E9%259D%25A2%25E6%259D%25BF%25EF%25BC%258C%25E6%2590%259C%25E7%25B4%25A2%25E2%2580%259CTypeScript%25E2%2580%259D%25EF%25BC%258C%25E7%2584%25B6%25E5%2590%258E%25E9%2580%2589%25E6%258B%25A9%25E5%25AE%2598%25E6%2596%25B9%25E6%258F%2590%25E4%25BE%259B%25E7%259A%2584%25E6%258F%2592%25E4%25BB%25B6%25E8%25BF%259B%25E8%25A1%258C%25E5%25AE%2589%25E8%25A3%2585%25E3%2580%2582%2520%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E5%258F%25AF%25E4%25BB%25A5%25E9%2580%259A%25E8%25BF%2587%25E8%25AE%25BE%25E7%25BD%25AE%25E6%259D%25A5%25E9%2585%258D%25E7%25BD%25AETypeScript%25E7%259A%2584%25E7%25BC%2596%25E8%25AF%2591%25E9%2580%2589%25E9%25A1%25B9%25E3%2580%2582" target="_blank" title="https://developer.baidu.com/article/detail.html?id=2822946#:~:text=%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85TypeScript%E6%8F%92%E4%BB%B6%E6%9D%A5%E6%94%AF%E6%8C%81TypeScript%E7%9A%84%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E3%80%81%E6%99%BA%E8%83%BD%E6%8F%90%E7%A4%BA%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%A8%E7%AD%89%E5%8A%9F%E8%83%BD%E3%80%82%20%E6%89%93%E5%BC%80VSCode%EF%BC%8C%E6%8C%89%E4%B8%8B%20Ctrl%2BShift%2BX,%EF%BC%88Windows%2FLinux%EF%BC%89%E6%88%96%20Cmd%2BShift%2BX%20%EF%BC%88Mac%EF%BC%89%E6%89%93%E5%BC%80%E6%89%A9%E5%B1%95%E9%9D%A2%E6%9D%BF%EF%BC%8C%E6%90%9C%E7%B4%A2%E2%80%9CTypeScript%E2%80%9D%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%89%E6%8B%A9%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8F%92%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%E3%80%82%20%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AE%E6%9D%A5%E9%85%8D%E7%BD%AETypeScript%E7%9A%84%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E3%80%82" ref="nofollow noopener noreferrer"/>：</p>
<p>bash</p>
<pre><code class="hljs">tsc hello.ts
</code></pre>
<p>成功后，你会在文件夹中看到一个新生成的 <code>hello.js</code> 文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaoshuo.qq.com%2Fread%2F1035433566%2F27%3Fsource%3Dm_jump" target="_blank" title="https://xiaoshuo.qq.com/read/1035433566/27?source=m_jump" ref="nofollow noopener noreferrer"/>。</p>
</li>
<li>
<p><strong>运行</strong>：接着，在终端中输入以下命令来执行生成的 JavaScript 文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.baidu.com%2Farticle%2Fdetail.html%3Fid%3D2822946%23%3A~%3Atext%3D%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E5%25AE%2589%25E8%25A3%2585TypeScript%25E6%258F%2592%25E4%25BB%25B6%25E6%259D%25A5%25E6%2594%25AF%25E6%258C%2581TypeScript%25E7%259A%2584%25E8%25AF%25AD%25E6%25B3%2595%25E9%25AB%2598%25E4%25BA%25AE%25E3%2580%2581%25E6%2599%25BA%25E8%2583%25BD%25E6%258F%2590%25E7%25A4%25BA%25E5%2592%258C%25E4%25BB%25A3%25E7%25A0%2581%25E8%25A1%25A5%25E5%2585%25A8%25E7%25AD%2589%25E5%258A%259F%25E8%2583%25BD%25E3%2580%2582%2520%25E6%2589%2593%25E5%25BC%2580VSCode%25EF%25BC%258C%25E6%258C%2589%25E4%25B8%258B%2520Ctrl%252BShift%252BX%2C%25EF%25BC%2588Windows%252FLinux%25EF%25BC%2589%25E6%2588%2596%2520Cmd%252BShift%252BX%2520%25EF%25BC%2588Mac%25EF%25BC%2589%25E6%2589%2593%25E5%25BC%2580%25E6%2589%25A9%25E5%25B1%2595%25E9%259D%25A2%25E6%259D%25BF%25EF%25BC%258C%25E6%2590%259C%25E7%25B4%25A2%25E2%2580%259CTypeScript%25E2%2580%259D%25EF%25BC%258C%25E7%2584%25B6%25E5%2590%258E%25E9%2580%2589%25E6%258B%25A9%25E5%25AE%2598%25E6%2596%25B9%25E6%258F%2590%25E4%25BE%259B%25E7%259A%2584%25E6%258F%2592%25E4%25BB%25B6%25E8%25BF%259B%25E8%25A1%258C%25E5%25AE%2589%25E8%25A3%2585%25E3%2580%2582%2520%25E5%259C%25A8VSCode%25E4%25B8%25AD%25EF%25BC%258C%25E4%25BD%25A0%25E5%258F%25AF%25E4%25BB%25A5%25E9%2580%259A%25E8%25BF%2587%25E8%25AE%25BE%25E7%25BD%25AE%25E6%259D%25A5%25E9%2585%258D%25E7%25BD%25AETypeScript%25E7%259A%2584%25E7%25BC%2596%25E8%25AF%2591%25E9%2580%2589%25E9%25A1%25B9%25E3%2580%2582" target="_blank" title="https://developer.baidu.com/article/detail.html?id=2822946#:~:text=%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E9%9C%80%E8%A6%81%E5%AE%89%E8%A3%85TypeScript%E6%8F%92%E4%BB%B6%E6%9D%A5%E6%94%AF%E6%8C%81TypeScript%E7%9A%84%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE%E3%80%81%E6%99%BA%E8%83%BD%E6%8F%90%E7%A4%BA%E5%92%8C%E4%BB%A3%E7%A0%81%E8%A1%A5%E5%85%A8%E7%AD%89%E5%8A%9F%E8%83%BD%E3%80%82%20%E6%89%93%E5%BC%80VSCode%EF%BC%8C%E6%8C%89%E4%B8%8B%20Ctrl%2BShift%2BX,%EF%BC%88Windows%2FLinux%EF%BC%89%E6%88%96%20Cmd%2BShift%2BX%20%EF%BC%88Mac%EF%BC%89%E6%89%93%E5%BC%80%E6%89%A9%E5%B1%95%E9%9D%A2%E6%9D%BF%EF%BC%8C%E6%90%9C%E7%B4%A2%E2%80%9CTypeScript%E2%80%9D%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%89%E6%8B%A9%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84%E6%8F%92%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%E3%80%82%20%E5%9C%A8VSCode%E4%B8%AD%EF%BC%8C%E4%BD%A0%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%AE%BE%E7%BD%AE%E6%9D%A5%E9%85%8D%E7%BD%AETypeScript%E7%9A%84%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9%E3%80%82" ref="nofollow noopener noreferrer"/>：</p>
<p>bash</p>
<pre><code class="hljs">node hello.js
</code></pre>
<p>如果一切顺利，终端就会打印出 <strong>Hello, World!</strong> 。</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d62d49a8ec746a58545bb586d9c1a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bi46ZOt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766540487&amp;x-signature=Z39PdrJU7qKyG1ZyNmtfVRPqTqo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4"><strong>方法二：使用工具直接运行（更便捷）</strong></h4>
<p>如果你想跳过手动编译的步骤，可以使用 <code>ts-node</code> 工具，它可以直接运行 TypeScript 文件。</p>
<ol>
<li>
<p><strong>安装 ts-node</strong>：在终端中运行以下命令<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.zhangyue.com%2Freadbook%2F13052334%2F27.html%3FshowDownload%3D1" target="_blank" title="https://m.zhangyue.com/readbook/13052334/27.html?showDownload=1" ref="nofollow noopener noreferrer"/>：</p>
<p>bash</p>
<pre><code class="hljs">npm install -g ts-node
</code></pre>
</li>
<li>
<p><strong>直接运行</strong>：安装完成后，你就可以在终端中直接运行 <code>.ts</code> 文件了：</p>
<p>bash</p>
<pre><code class="hljs">ts-node hello.ts
</code></pre>
<p>终端同样会输出 <strong>Hello, World!</strong> 。</p>
</li>
</ol>
<blockquote>
<p>注：熟悉基本流程后，你可以通过配置 <code>tsconfig.json</code> 文件（例如设置 <code>outDir</code> 来指定编译输出目录<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.cn%2Fdeveloper%2Farticle%2F2385358" target="_blank" title="https://cloud.tencent.cn/developer/article/2385358" ref="nofollow noopener noreferrer"/>），或使用 VS Code 的“任务”功能<a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaoshuo.qq.com%2Fread%2F1035433566%2F27%3Fsource%3Dm_jump" target="_blank" title="https://xiaoshuo.qq.com/read/1035433566/27?source=m_jump" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fm.yisu.com%2Fjc%2F375511.html" target="_blank" title="https://m.yisu.com/jc/375511.html" ref="nofollow noopener noreferrer"/>来实现更自动化的编译流程。</p>
</blockquote>
<h4 data-id="heading-5"><strong>方法三：使用npx esno 命令</strong></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d54f7c72174bd6ba4dcb81e0de778a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bi46ZOt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766540487&amp;x-signature=JyX5o0bj2F2vFU%2FI%2F3%2Blw0UNy5I%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>简单地说，esno 也是先编译再执行的过程，只不过它底层使用的是快如闪电的 ESBuild 进行编译，所以使用它来执行 TS 文件，我们几乎感觉不到编译的过程。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现流式输出？一篇文章手把手教你]]></title>    <link>https://juejin.cn/post/7584286241488666664</link>    <guid>https://juejin.cn/post/7584286241488666664</guid>    <pubDate>2025-12-17T00:37:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584286241488666664" data-draft-id="7584286241488650280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现流式输出？一篇文章手把手教你"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-17T00:37:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微芒不朽"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894153592"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现流式输出？一篇文章手把手教你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894153592/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微芒不朽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:37:32.000Z" title="Wed Dec 17 2025 00:37:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body ::selection{color:#fff;background-color:#ed7373}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:.6em;margin-top:1.5em;padding-bottom:4px;color:#ed7373}.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px}.markdown-body h4{font-size:16px}.markdown-body h5,.markdown-body h6{font-size:14px}.markdown-body p{line-height:inherit;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border-top:1px solid #dfe1e6;margin:33px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:rgba(239,198,221,.2666666667);color:#7b164f;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==") 10px 10px no-repeat;background-size:40px;background-color:#fdf8f8}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#fdf8f8}.markdown-body a{position:relative;text-decoration:underline;text-decoration-color:#ffd4d4;color:#ed7373;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAD1lJREFUeF7tnV122zgShQHJG5gT9/OkV2J7JR3voI/U707eI5/eQeyVRFlJa56nc2YDFjkHEulWHP3g5xZYAK5eku6QYOFWfSwUAJLW8EcFqMBJBSy1oQJU4LQCBITRQQXOKEBAGB5UgIAwBqhAnALMIHG68axGFCAgjTia3YxTgIDE6cazGlGAgDTiaHYzTgECEqcbz2pEAQLSiKPZzTgFCEicbjyrEQUISCOOZjfjFCAgcbrxrEYUICCNOJrdjFOAgMTpxrMaUYCANOJodjNOAQISpxvPakQBAtKIo9nNOAUISJxuPKsRBQhII45GdfN/v//+/l9//rlBtae9HQKi3UOZ7ft7sfhgjfm3sfa9u3RvzHtrjPv77r8PfpvemB0o1v3Z95tuNvt29fKyqQkgApI5ADVebgeFtTfGmA8I+3pj1rbv17Ouey4dFgKCiIgC2/i+WDwYax0QbzMDtDcjLC67/PL58xraeIbGCEgGkTVd4vty+QWVKUL75WCZb7f3JWUVAhLq5UKPHzLGRyXmP822208lgEJAlESMlBlDfeGyhsafelAIiMawAdjkpmO38/kXa8wtoDnRJvq+v79+fHwSvUhk4wQkUjjNp/33jz9uZ33/VbONP9nW9x/fPT5+0mYzAdHmkUR7lNUaob1RN+QiIKEuVHz838vl1xKGVOck1DbTRUAUB7yvaSXVG5592sy22zsNs1wExNNjWg+rEI5XqWfb7a9TQ0JAtEa+h101wzF0f/JMQkA8AlHjIQ3AMco+KSQERGP0X7CpITj2Skw4BUxACgOkOThG/0wECQEpCJBm4Rh81Fl7l3tHMAEpBJCJ4Hjq+/7bvOt229THGSVny8vV1W6b/Kzrbnprb088VAVXN/fMFgGBuxDfYE443L4oB0TM9OqwxcVtjJR7xiTzUIuA4OMZ2mI2OICBN+wgfpACJWcWISDQcMY2lgMOt7XjerW6w1q+b03sqUUgzJf6TUAuKTTRv+eAI8f0qdSwK1cWISATAXDusjngyDkj5PrTzedu+z2uNsmURQiIMkBqg2OUVwKSHFmEgCgCpFY4xCDJkEUIiBJAaodjlBlZuEtOMIz2EhAFgLQCxxtIIG9YkR5mEZCJAWkNjldIlsu/EEW79AsfCMiEgLQKx8EaCSKLPL1bre6l3EhApJS90G7LcKCziOQwi4BMAAjh+GGlPTmLSK7pEJDMgBCOfwRHvb9Lsg4hIBkBIRw/i/0dUawLrocQkEyAEI7jQoPeNi9WqBOQDIAQjtMig16uTUAyxLHIJQjHeVkRdYjkijoziAgW+0YJx2VxEYAYYzbvVqtfL18t/AgCEq6Z1xmEw0um3U2km8/dqnrS791qJRLLIo0m9bSCkwmHvxNBgDCD+Es+7ZGEI0x/DrHC9Cr6aMIR7j7ELBaL9HDds59BOOIkB33wh9O8cfLnOYtwxOsM+egPV9LjHSB9JuFIU/j7ctmntSD7cmvOYiV6B3IHPGOD5E7VxK4nnw4q0A03Kya7QqYBwpGmK6j+MFJrIK53zCCRPgZtsjt59Zozh+s0aP3DNSW2BkJAIuFATE2eu3TtcLi+w24wggU6AYkABDVuPnXpFuAAZg8jrReHWAGQIB177LLSzg7oqtih4Dcsig6vmEECw0CyKG8BDic3VEPh4RUBCQAENePSaubY1R2LxYOxNvklDa8aEpCACBY+FLKgdcTGZjLHYvHBWuu+PoX6iQ+vmEE8XQW/8w3XJRyeDjhymOTi4OHlWKRf8JFUYU444uGQXvsgIAG+kcgesXAM6y83/fAhGtv36242+5b708i+8kmtF+XKHhxiTZA9YuDwCLSn2Xb7KebLtL7BHnqch82hTY7HZ6k9xotxiHXGTejsEQXHcvnVGnPrEU2b2XZ7pwESQTjEFwbf6kxAzgGCeOvf2H7ElGQMoDmHH8ekk4RD8snBU2FAQE4oAy7Og594S7p+BIweGeriIZJw5CzMWaRfdDV0UStqzByTPX7oVt9/nHXdc64hV41wsEjPMLyKqTucWZAtGZkyiTAc2esOZpBMs1cpY2bIW89dP4UhkYZj6pqKNcgRWFBb2lO+fAQDxBiTYse5e4k0HMaY4NrNY/QcdAgBOSJX8vjf3biNWV+vVndB3jg4GPZA0b5N+BSwNByp+sXqzmleD+UQgMTWHqN5AgEIg0TAtrdemTxzjAYxgxzLIMul23X6wYOlU4dEzVy9bQw5zNq1DahHpOGYuuZgBvGI+uQZJEAgOjOHWsjB+t7DbK9DUgIQkVnPGZmadb0ECDyIGeR4Bkl6mRnS0WhIYsf2LcLhQoOACACCfk8T+Dnu4BetJa3qe9yxkTcUj8sFHUJAjgPiPugSO6yB1B9vzUJCEppFBLPHprP2Xut2fWaQE/eSxOJYBJDR1ETbXnscUosk12THdVYPBwE5AUhiQIgCAswk3tO+As/ji2oUNIa6cDCHWOBp3tDhS4wzUZD4ZhEkIDn0idH01DkEBAyIaw5dpB9zHqgu8FqQgw3rEncXIAPft60qAXF32JRt3qnBJ7X36a1TUwPX926O2Pbiey3fwM11XBWADGsFv5n9o6m72SfnkJ2Iff98/fj4FCJo6mpxrmnLVJCdJj4wp+pRKhxVFOmeBXXwSw2S7s6glXQfqJPs3N0/+nufG0jCdbyGcT59neKYYjNIxKfPvGdtnCM8wTvpM587M8LhgOGPVwDHTAz4wofQQaqNIgGJgGOvX8CdPXVYEXKtFOcm2+k5zHI2hmx7yTXMTNHO59ziAEne9uAJCeChqaCM5eOsY8cA7PSqQw6vPWSt13rvjV1PnbXPmlfHQ7QuChBEMIQUjAnj7uCMFeI09GxW7N1+54+uuxkmRf4z77p1yuxhigZS5xYDCAKOUUTfdQrELFGOoVZqvRQLiFRQamq3CECQcPhObY5OSs4iATNFsYGRamMNxXSsdpfOUw8IGg4nSMgdE5JFhCEhIJfCPP7fVQOCmKE5Ik3wRrnUABxtkLpTJ9vnOXERH2blnqkWECE4ot42gsoiodnLN6wAmwm91kJ87anpOJWAABa/Tvso8m6ZfJf+xyLo9G/ytPduCqr/+O7x8VNNgY3qizpAROEwJnh4NQodskh20TnAgITUaEB7Lva9sANUAZI6XXlB++Q7N3KohdqKgrApZNKisPhONlcNIMJwBM1cnVMVEZDIWgShGwrW5GhU2IAKQBBOPqct+g4JqUcAwxpI/ZHpAS+Fse9l0qSARG869Ora/iA0HK7NmJ2tP5kMAASUzaLrsgA3FHvopICUljkOvZwKCQJcRCYL2ZtWbJQnGD4ZICXDMeo93MHdO3yD36Hlux/slG8hs1ec4r2IziSAgIYGJzuHuDtfVG44IGr6FzG8An1gNKdWvppqOi47ILA73wkVp3B4ICTJY37gDSbZFk3BLGFLVkBQsy6nhJgCjtEWn5oEMd6HagjIZBJBqanNbIBAHXtEwSnhODRn2EP2MPy/sTaBPWWHrN20aKYJiLe2ZANEcguJVkenvp/rrbOQcEz13XHNMByzLQsgktlDKxzoQADWHXvTOLzyclEWQMB3vteOtQKHxNZ/bi/x4kP+AzpS2YNw+Dn46FHMHt7iiWcQiexBOLz9e+xATu0GyCcKiMSaB+EI8O6xQ5k9ggQUBQSxV+iwN4QjyLfMHslyCX7EE157NHLnkyjIxziRemkEIA7VNiGWQcDTkk28VEAUjgI/XqOBGjFAgMV5E0WlJBxcFIxHTQQQ5PCqhbpDGo7ZdntX2ztz40M+7EwRQICzV9VnD2E4RJ6oDAuxso8WAQRVf9S+2isNB4vydDhlAFku+3TT4t9hBbi2eBPScBhjmpjYkHaUXkAqntaVhgPx3Il04JXSPhwQVIFe6/CKcJSCxt5OrYBUWZwTjrLgEAEEMYNV4xCBcJQHhwggoECoqsAEaXIywmq8oWjBCT7EgkzxVlSgEw4toR5nBwGJ083rLMLhJZPqg/CALJdfjDHubYPxvwoyCOGId7+mM+GAgAKj6BoEpAFrDgWkqASk5KKTcCiIaqAJcEBanuYlHMDIVNIUHJBWV9IJh5KIBpsBB8TZB/gssSlpJyrhAEelouakAPkr5psZb3QpolAnHIqiWcAUEUBQj9tq37BIOAQiUlmTMoAsFh+stW49JO2neD2EcKS5tpSzRQBBzGSNAmrMIoSjlPBOt1MEkKFQR9Qh6t5CTjjSg66kFiQBSd9yMiqpZKhFOEoKbYytYoAgh1muq1MPtQgHJuBKa0UMEOgwa6/qZqr3OxGO0sIaZ68sIIvFg7H2I87c/JBAnm85I0DJ+86AflXblCggAlkkayZBreec8j7hUMvFq2HygOCzyM54ya0obj/Zdj7/Yo25lXIh4ZBSFtuuOCBCWWQPiTHr+XZ7j3zvrHS9Mdp9vVrdYV3J1iQUyAOIUBY5EORptt1+SgFlAMN933z8trmE3juoCYeItCKNZgFEMoscquKCz/b9etZ1zz6wDFDcmP1QShQMZg6R+BVvNBsgw7qIWzwUD8RBtU1vzMb93Q5/DkH63u5tyGXH63CQmUM8nuEXyAbILovID7XgAiEa5LAKoeI0bWQFpEVICMc0gY26anZActUjKIFS2iEcKerpOHcSQIbn1r/mrgNySk44cqotd61JAHHdqRkSwiEXsLlbngwQ19EJZrbE9SUc4hJnvcCkgFQHiZLnVrJGUOUXmxyQUV/pjYHSfmzhc9XSGmpsXw0gBU8Bbzpr73/5/Hmt0cG0KU0BVYAcQOLeDp91pTtGRtYbMaqVdY46QMa6xPb9g+R282Q3sd5IlrCEBlQCMgqndJariDc+lhB8JdioGpDXAn7/IjrxregXHJa8pb6EgKCNPypQBCATg0IwGqamKEB+GHp13U1v7a3Q1vWnvu+/XT8+PjUcG+z6/lGJ8n+uVhmK+nHmK2QGzD0zsnZAzLtu7fOgVfmKsQe+ClQByLHOur1eL1dXO1Bs170C089mm6uXl92DVITBN0zaPa5aQNp1KXuOVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFSAgCDVZFvVKUBAqnMpO4RUgIAg1WRb1SlAQKpzKTuEVICAINVkW9UpQECqcyk7hFTg//8JNVC78ovQAAAAAElFTkSuQmCC");background-size:100%}.markdown-body a:active,.markdown-body a:hover{opacity:.66}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #ed7373;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#ed7373}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#fdf2f2}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #ed7373;background-color:#fdf2f2}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ed7373}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]{appearance:none;-webkit-appearance:none;-moz-appearance:none;outline:none;width:16px;height:16px;border-radius:2px;background-color:transparent;box-shadow:inset 0 0 0 1px rgba(28,31,35,.3490196078);vertical-align:middle;margin:0;transform:translateY(-2px)}.markdown-body input[type=checkbox]:checked{background-color:#ed7373;background-image:url("data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjFlbSIgaGVpZ2h0PSIxZW0iIGFyaWEtaGlkZGVuPSJ0cnVlIj48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTE3LjQxMSA3LjMwOGExLjUgMS41IDAgMDEuMjggMi4xMDNsLTYuNSA4LjVhMS41IDEuNSAwIDAxLTIuMzc1LjAxbC0zLjUtNC41YTEuNSAxLjUgMCAxMTIuMzY4LTEuODQybDIuMzA2IDIuOTY1IDUuMzE4LTYuOTU1YTEuNSAxLjUgMCAwMTIuMTAzLS4yOHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=");box-shadow:inset 0 0 0 1px #ed7373}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c410444a54f8462e8f89d1c22650d00e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u6IqS5LiN5py9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766536652&amp;x-signature=wkU85x1WnBauQQmjNT4MEYCSlqA%3D" alt="" loading="lazy"/></p>
<p>在现代Web应用中，流式输出（Streaming Output）是一种非常重要的技术，它能够实现实时数据传输和渐进式渲染，为用户提供更好的交互体验。本文将详细介绍流式输出的原理和多种实现方式。</p>
<h2 data-id="heading-0">什么是流式输出？</h2>
<p>流式输出是指数据不是一次性返回给客户端，而是分批次、连续地发送给客户端。这种方式特别适用于：</p>
<ul>
<li>实时聊天应用</li>
<li>大文件下载</li>
<li>AI生成内容展示</li>
<li>日志实时监控</li>
<li>数据报表逐步加载</li>
</ul>
<h2 data-id="heading-1">流式输出的优势</h2>
<ol>
<li><strong>降低延迟</strong>：用户无需等待所有数据准备完成</li>
<li><strong>节省内存</strong>：避免一次性加载大量数据到内存</li>
<li><strong>提升用户体验</strong>：内容可以逐步显示，感知更快</li>
<li><strong>提高性能</strong>：减少服务器压力，提高并发处理能力</li>
</ol>
<h2 data-id="heading-2">前端实现方案</h2>
<h3 data-id="heading-3">1. 使用 Fetch API + ReadableStream</h3>
<p>这是现代浏览器中最推荐的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础流式请求示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
  
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;
  
    <span class="hljs-comment">// 解码并处理接收到的数据块</span>
    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received chunk:'</span>, chunk);
  
    <span class="hljs-comment">// 更新UI或进行其他处理</span>
    <span class="hljs-title function_">updateUI</span>(chunk);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUI</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-keyword">const</span> outputElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>);
  outputElement.<span class="hljs-property">innerHTML</span> += content;
}
</code></pre>
<h3 data-id="heading-4">2. Vue组件中的流式输出实现</h3>
<p>创建一个支持流式输出的Vue组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="stream-output"&gt;
    &lt;div class="controls"&gt;
      &lt;button @click="startStreaming" :disabled="isStreaming"&gt;
        开始流式输出
      &lt;/button&gt;
      &lt;button @click="stopStreaming" :disabled="!isStreaming"&gt;
        停止流式输出
      &lt;/button&gt;
    &lt;/div&gt;
  
    &lt;div class="output-container"&gt;
      &lt;pre ref="outputRef" class="output"&gt;{{ streamingContent }}&lt;/pre&gt;
    &lt;/div&gt;
  
    &lt;div v-if="isLoading" class="loading"&gt;正在接收数据...&lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onUnmounted } from 'vue'

const isStreaming = ref(false)
const streamingContent = ref('')
const isLoading = ref(false)
const abortController = ref(null)
const outputRef = ref(null)

// 模拟API端点
const API_ENDPOINT = '/api/stream-data'

async function startStreaming() {
  try {
    isStreaming.value = true
    streamingContent.value = ''
    isLoading.value = true
  
    // 创建AbortController用于取消请求
    abortController.value = new AbortController()
  
    const response = await fetch(API_ENDPOINT, {
      signal: abortController.value.signal
    })
  
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
  
    const reader = response.body.getReader()
    const decoder = new TextDecoder('utf-8')
  
    // 逐块读取数据
    while (true) {
      const { done, value } = await reader.read()
    
      if (done) {
        break
      }
    
      // 解码数据块
      const chunk = decoder.decode(value, { stream: true })
    
      // 更新内容
      streamingContent.value += chunk
    
      // 自动滚动到底部
      scrollToBottom()
    }
  
  } catch (error) {
    if (error.name !== 'AbortError') {
      console.error('流式输出错误:', error)
    }
  } finally {
    isStreaming.value = false
    isLoading.value = false
  }
}

function stopStreaming() {
  if (abortController.value) {
    abortController.value.abort()
  }
  isStreaming.value = false
  isLoading.value = false
}

function scrollToBottom() {
  nextTick(() =&gt; {
    if (outputRef.value) {
      outputRef.value.scrollTop = outputRef.value.scrollHeight
    }
  })
}

onUnmounted(() =&gt; {
  stopStreaming()
})
&lt;/script&gt;

&lt;style scoped&gt;
.stream-output {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.controls {
  margin-bottom: 20px;
}

.controls button {
  margin-right: 10px;
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.controls button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
}

.output-container {
  border: 1px solid #ddd;
  border-radius: 4px;
  height: 400px;
  overflow-y: auto;
  background-color: #f8f9fa;
}

.output {
  margin: 0;
  padding: 15px;
  font-family: 'Courier New', monospace;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.loading {
  text-align: center;
  color: #666;
  margin-top: 10px;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-5">3. Server-Sent Events (SSE) 实现</h3>
<p>SSE是另一种常用的流式通信方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// SSE客户端实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = []
  }

  <span class="hljs-title function_">connect</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">disconnect</span>()
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(url)
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyListeners</span>(event.<span class="hljs-property">data</span>)
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'SSE连接错误:'</span>, error)
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SSE连接已建立'</span>)
    }
  }

  <span class="hljs-title function_">disconnect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span>.<span class="hljs-title function_">close</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventSource</span> = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-title function_">addListener</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">push</span>(callback)
  }

  <span class="hljs-title function_">removeListener</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">indexOf</span>(callback)
    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    }
  }

  <span class="hljs-title function_">notifyListeners</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(data))
  }
}

<span class="hljs-comment">// 在Vue组件中使用SSE</span>
<span class="hljs-keyword">const</span> streamService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamService</span>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">messages</span>: [],
      <span class="hljs-attr">isConnected</span>: <span class="hljs-literal">false</span>
    }
  },

  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    streamService.<span class="hljs-title function_">addListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleNewMessage</span>)
  },

  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) {
    streamService.<span class="hljs-title function_">removeListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleNewMessage</span>)
    streamService.<span class="hljs-title function_">disconnect</span>()
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">connectToStream</span>(<span class="hljs-params"/>) {
      streamService.<span class="hljs-title function_">connect</span>(<span class="hljs-string">'/api/events'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isConnected</span> = <span class="hljs-literal">true</span>
    },
  
    <span class="hljs-title function_">disconnectFromStream</span>(<span class="hljs-params"/>) {
      streamService.<span class="hljs-title function_">disconnect</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isConnected</span> = <span class="hljs-literal">false</span>
    },
  
    <span class="hljs-title function_">handleNewMessage</span>(<span class="hljs-params">data</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">content</span>: data,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleTimeString</span>()
      })
    }
  }
}
</code></pre>
<h3 data-id="heading-6">4. WebSocket 实现实时双向通信</h3>
<p>对于需要双向通信的场景：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// WebSocket服务类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketStream</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span> = url
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> = <span class="hljs-number">0</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxReconnectAttempts</span> = <span class="hljs-number">5</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageListeners</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusListeners</span> = []
  }

  <span class="hljs-title function_">connect</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>)
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接已建立'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> = <span class="hljs-number">0</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyStatus</span>(<span class="hljs-string">'connected'</span>)
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyMessage</span>(data)
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'WebSocket连接已关闭'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyStatus</span>(<span class="hljs-string">'disconnected'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attemptReconnect</span>()
    }
  
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket错误:'</span>, error)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyStatus</span>(<span class="hljs-string">'error'</span>)
    }
  }

  <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(message))
    }
  }

  <span class="hljs-title function_">close</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">websocket</span>.<span class="hljs-title function_">close</span>()
    }
  }

  <span class="hljs-title function_">attemptReconnect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxReconnectAttempts</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span>++
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`尝试重连 (<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.reconnectAttempts}</span>/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.maxReconnectAttempts}</span>)`</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">connect</span>()
      }, <span class="hljs-number">1000</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span>)
    }
  }

  <span class="hljs-title function_">addMessageListener</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageListeners</span>.<span class="hljs-title function_">push</span>(callback)
  }

  <span class="hljs-title function_">addStatusListener</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusListeners</span>.<span class="hljs-title function_">push</span>(callback)
  }

  <span class="hljs-title function_">notifyMessage</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageListeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(data))
  }

  <span class="hljs-title function_">notifyStatus</span>(<span class="hljs-params">status</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusListeners</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(status))
  }
}

<span class="hljs-comment">// Vue组件中使用WebSocket</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">wsStream</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">messages</span>: [],
      <span class="hljs-attr">connectionStatus</span>: <span class="hljs-string">'disconnected'</span>
    }
  },

  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketStream</span>(<span class="hljs-string">'ws://localhost:8080/ws'</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>.<span class="hljs-title function_">addMessageListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleMessage</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>.<span class="hljs-title function_">addStatusListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">handleStatusChange</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>.<span class="hljs-title function_">connect</span>()
  },

  <span class="hljs-title function_">beforeUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>.<span class="hljs-title function_">close</span>()
    }
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">data</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">messages</span>.<span class="hljs-title function_">push</span>({
        ...data,
        <span class="hljs-attr">receivedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
      })
    },
  
    <span class="hljs-title function_">handleStatusChange</span>(<span class="hljs-params">status</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">connectionStatus</span> = status
    },
  
    <span class="hljs-title function_">sendUserMessage</span>(<span class="hljs-params">content</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">wsStream</span>.<span class="hljs-title function_">sendMessage</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'user_message'</span>,
        <span class="hljs-attr">content</span>: content,
        <span class="hljs-attr">sentAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
      })
    }
  }
}
</code></pre>
<h2 data-id="heading-7">后端实现示例</h2>
<h3 data-id="heading-8">Node.js Express 实现流式响应</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()

<span class="hljs-comment">// 模拟流式数据生成</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/stream-data'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// 设置响应头以支持流式传输</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/plain; charset=utf-8'</span>)
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Transfer-Encoding'</span>, <span class="hljs-string">'chunked'</span>)

  <span class="hljs-comment">// 发送初始数据</span>
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'开始流式传输...\n'</span>)

  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    count++
    <span class="hljs-keyword">const</span> data = <span class="hljs-string">`数据块 <span class="hljs-subst">${count}</span>: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n`</span>
    res.<span class="hljs-title function_">write</span>(data)
  
    <span class="hljs-comment">// 结束流式传输</span>
    <span class="hljs-keyword">if</span> (count &gt;= <span class="hljs-number">10</span>) {
      <span class="hljs-built_in">clearInterval</span>(interval)
      res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'流式传输结束\n'</span>)
      res.<span class="hljs-title function_">end</span>()
    }
  }, <span class="hljs-number">1000</span>)

  <span class="hljs-comment">// 处理客户端断开连接</span>
  req.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(interval)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'客户端断开了连接'</span>)
  })
})

<span class="hljs-comment">// SSE端点</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/events'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/event-stream'</span>,
    <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span>,
    <span class="hljs-string">'Connection'</span>: <span class="hljs-string">'keep-alive'</span>,
    <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>
  })

  <span class="hljs-comment">// 发送初始事件</span>
  res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'data: 连接已建立\n\n'</span>)

  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    count++
    <span class="hljs-keyword">const</span> data = <span class="hljs-string">`data: 事件 <span class="hljs-subst">${count}</span> - <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n\n`</span>
    res.<span class="hljs-title function_">write</span>(data)
  }, <span class="hljs-number">2000</span>)

  <span class="hljs-comment">// 处理客户端断开连接</span>
  req.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(interval)
    res.<span class="hljs-title function_">end</span>()
  })
})

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'服务器运行在 http://localhost:3000'</span>)
})
</code></pre>
<h2 data-id="heading-9">性能优化建议</h2>
<h3 data-id="heading-10">1. 内存管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 限制缓存大小</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LimitedBuffer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxSize = <span class="hljs-number">1000</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = maxSize
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">push</span>(item)
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>.<span class="hljs-title function_">shift</span>() <span class="hljs-comment">// 移除最旧的项</span>
    }
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>
  }
}
</code></pre>
<h3 data-id="heading-11">2. 节流更新</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 节流函数防止频繁更新DOM</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, limit</span>) {
  <span class="hljs-keyword">let</span> inThrottle
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> args = <span class="hljs-variable language_">arguments</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-variable language_">this</span>
    <span class="hljs-keyword">if</span> (!inThrottle) {
      func.<span class="hljs-title function_">apply</span>(context, args)
      inThrottle = <span class="hljs-literal">true</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> inThrottle = <span class="hljs-literal">false</span>, limit)
    }
  }
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">const</span> throttledUpdate = <span class="hljs-title function_">throttle</span>(<span class="hljs-function">(<span class="hljs-params">content</span>) =&gt;</span> {
  streamingContent.<span class="hljs-property">value</span> += content
}, <span class="hljs-number">100</span>) <span class="hljs-comment">// 每100ms最多更新一次</span>
</code></pre>
<h3 data-id="heading-12">3. 错误处理和重试机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 带重试机制的流式请求</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamWithRetry</span>(<span class="hljs-params">url, maxRetries = <span class="hljs-number">3</span></span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= maxRetries; i++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">streamFetch</span>(url)
      <span class="hljs-keyword">return</span> <span class="hljs-comment">// 成功后退出</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`流式请求失败，第<span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>次重试`</span>, error)
    
      <span class="hljs-keyword">if</span> (i === maxRetries) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'达到最大重试次数'</span>)
      }
    
      <span class="hljs-comment">// 等待后重试</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, i)))
    }
  }
}
</code></pre>
<h2 data-id="heading-13">完整的示例</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c984e6a7b774beca54edca693e6e4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u6IqS5LiN5py9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766536652&amp;x-signature=6L2X%2F1gMv8E6ZaYVG2GzdWb%2FpzY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2db6cd6bcb454617a81afaf34d92eada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u6IqS5LiN5py9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766536652&amp;x-signature=dw4RzaKIoAssIiMQUDb%2B0H0SOtE%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>流式输出示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    * {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">box-sizing</span>: border-box;
    }

    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Segoe UI'</span>, Tahoma, Geneva, Verdana, sans-serif;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f5f5f5</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
    }

    <span class="hljs-selector-class">.container</span> {
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1200px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
    }

    <span class="hljs-selector-tag">header</span> {
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
    }

    <span class="hljs-selector-tag">h1</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2.5em</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-class">.subtitle</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.2em</span>;
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.9</span>;
    }

    <span class="hljs-selector-class">.tabs</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">flex-wrap</span>: wrap;
    }

    <span class="hljs-selector-class">.tab-button</span> {
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">24px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e0e0e0</span>;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">25px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
      <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
    }

    <span class="hljs-selector-class">.tab-button</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#d5d5d5</span>;
    }

    <span class="hljs-selector-class">.tab-button</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#667eea</span>;
      <span class="hljs-attribute">color</span>: white;
    }

    <span class="hljs-selector-class">.tab-content</span> {
      <span class="hljs-attribute">display</span>: none;
      <span class="hljs-attribute">background</span>: white;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">25px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
    }

    <span class="hljs-selector-class">.tab-content</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">display</span>: block;
      <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.5s</span> ease;
    }

    <span class="hljs-keyword">@keyframes</span> fadeIn {
      <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">10px</span>); }
      <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>); }
    }

    <span class="hljs-selector-class">.controls</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">flex-wrap</span>: wrap;
    }

    <span class="hljs-selector-class">.btn</span> {
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
      <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
    }

    <span class="hljs-selector-class">.btn-primary</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#667eea</span>;
      <span class="hljs-attribute">color</span>: white;
    }

    <span class="hljs-selector-class">.btn-secondary</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#6c757d</span>;
      <span class="hljs-attribute">color</span>: white;
    }

    <span class="hljs-selector-class">.btn-success</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#28a745</span>;
      <span class="hljs-attribute">color</span>: white;
    }

    <span class="hljs-selector-class">.btn-danger</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#dc3545</span>;
      <span class="hljs-attribute">color</span>: white;
    }

    <span class="hljs-selector-class">.btn</span><span class="hljs-selector-pseudo">:disabled</span> {
      <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>;
      <span class="hljs-attribute">cursor</span>: not-allowed;
    }

    <span class="hljs-selector-class">.btn</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-pseudo">:disabled</span>) {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
    }

    <span class="hljs-selector-class">.output-container</span> {
      <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#e9ecef</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">overflow-y</span>: auto;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Courier New'</span>, monospace;
      <span class="hljs-attribute">white-space</span>: pre-wrap;
      <span class="hljs-attribute">word-wrap</span>: break-word;
    }

    <span class="hljs-selector-class">.status-bar</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: space-between;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e9ecef</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-class">.status-indicator</span> {
      <span class="hljs-attribute">display</span>: inline-block;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;
    }

    <span class="hljs-selector-class">.status-connected</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#28a745</span>;
    }

    <span class="hljs-selector-class">.status-disconnected</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#dc3545</span>;
    }

    <span class="hljs-selector-class">.status-loading</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffc107</span>;
    }

    <span class="hljs-selector-class">.progress-bar</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e9ecef</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
      <span class="hljs-attribute">overflow</span>: hidden;
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-class">.progress-fill</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#667eea</span>, <span class="hljs-number">#764ba2</span>);
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
      <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> ease;
    }

    <span class="hljs-selector-class">.chat-messages</span> {
      <span class="hljs-attribute">height</span>: <span class="hljs-number">350px</span>;
      <span class="hljs-attribute">overflow-y</span>: auto;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">background-color</span>: white;
    }

    <span class="hljs-selector-class">.message</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">80%</span>;
    }

    <span class="hljs-selector-class">.message-user</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#667eea</span>;
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">margin-left</span>: auto;
      <span class="hljs-attribute">text-align</span>: right;
    }

    <span class="hljs-selector-class">.message-bot</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f1f3f4</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    }

    <span class="hljs-selector-class">.input-group</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-class">.input-group</span> <span class="hljs-selector-tag">input</span> {
      <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }

    <span class="hljs-selector-class">.features</span> {
      <span class="hljs-attribute">display</span>: grid;
      <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">1</span>fr));
      <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
    }

    <span class="hljs-selector-class">.feature-card</span> {
      <span class="hljs-attribute">background</span>: white;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
      <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
    }

    <span class="hljs-selector-class">.feature-card</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
    }

    <span class="hljs-selector-class">.feature-card</span> <span class="hljs-selector-tag">h3</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#667eea</span>;
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
    }

    <span class="hljs-selector-tag">footer</span> {
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">40px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#6c757d</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
    }

    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
      <span class="hljs-selector-class">.container</span> {
        <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      }
      
      <span class="hljs-selector-tag">h1</span> {
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2em</span>;
      }
      
      <span class="hljs-selector-class">.controls</span> {
        <span class="hljs-attribute">flex-direction</span>: column;
      }
      
      <span class="hljs-selector-class">.btn</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      }
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>流式输出技术演示<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subtitle"</span>&gt;</span>Fetch API + ReadableStream | Server-Sent Events | WebSocket<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tabs"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-button active"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"switchTab('fetch')"</span>&gt;</span>Fetch Stream<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"switchTab('sse')"</span>&gt;</span>Server-Sent Events<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-button"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"switchTab('websocket')"</span>&gt;</span>WebSocket Chat<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Fetch Stream Tab --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetch"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-content active"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Fetch API 流式输出<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用现代浏览器的 Fetch API 和 ReadableStream 实现流式数据传输<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startFetchBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"startFetchStream()"</span>&gt;</span>
          开始流式输出
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"stopFetchBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-danger"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"stopFetchStream()"</span> <span class="hljs-attr">disabled</span>&gt;</span>
          停止流式输出
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-secondary"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"clearFetchOutput()"</span>&gt;</span>
          清空输出
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchOutput"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"output-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-bar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchStatusIndicator"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchStatusText"</span>&gt;</span>未开始<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>接收字节: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchByteCount"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-fill"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchProgress"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 0%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- SSE Tab --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sse"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Server-Sent Events (SSE)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用 SSE 实现服务器推送的实时数据流<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"connectSSEBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-success"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"connectSSE()"</span>&gt;</span>
          连接SSE
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"disconnectSSEBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-danger"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"disconnectSSE()"</span> <span class="hljs-attr">disabled</span>&gt;</span>
          断开连接
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-secondary"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"clearSSEOutput()"</span>&gt;</span>
          清空输出
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sseOutput"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"output-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-bar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sseStatusIndicator"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sseStatusText"</span>&gt;</span>未连接<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>接收事件: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sseEventCount"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- WebSocket Tab --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"websocket"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab-content"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>WebSocket 实时聊天<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用 WebSocket 实现双向实时通信<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-messages"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chatMessages"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-group"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息..."</span> <span class="hljs-attr">onkeypress</span>=<span class="hljs-string">"handleKeyPress(event)"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sendBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendMessage()"</span> <span class="hljs-attr">disabled</span>&gt;</span>
          发送
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"connectWSBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-success"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"connectWebSocket()"</span>&gt;</span>
          连接
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"disconnectWSBtn"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-danger"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"disconnectWebSocket()"</span> <span class="hljs-attr">disabled</span>&gt;</span>
          断开
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-bar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wsStatusIndicator"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wsStatusText"</span>&gt;</span>未连接<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>消息数量: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"messageCount"</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"features"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>🚀 高性能<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>流式输出减少等待时间，提升用户体验，避免长时间白屏。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>💾 内存友好<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>逐块处理数据，避免一次性加载大量数据到内存中。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>🔄 实时性强<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>数据即时传输，适用于聊天、通知、实时监控等场景。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>流式输出技术演示 | 基于现代Web标准实现<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 全局变量</span>
    <span class="hljs-keyword">let</span> fetchController = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> sseConnection = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> wsConnection = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> fetchByteCount = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> sseEventCount = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> messageCount = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 标签页切换</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">switchTab</span>(<span class="hljs-params">tabId</span>) {
      <span class="hljs-comment">// 隐藏所有标签内容</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.tab-content'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">tab</span> =&gt;</span> {
        tab.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
      });
      
      <span class="hljs-comment">// 移除所有激活按钮样式</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.tab-button'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">btn</span> =&gt;</span> {
        btn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
      });
      
      <span class="hljs-comment">// 显示选中的标签内容</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(tabId).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
      
      <span class="hljs-comment">// 激活对应的按钮</span>
      event.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
      
      <span class="hljs-comment">// 停止所有正在进行的操作</span>
      <span class="hljs-title function_">stopFetchStream</span>();
      <span class="hljs-title function_">disconnectSSE</span>();
      <span class="hljs-title function_">disconnectWebSocket</span>();
    }

    <span class="hljs-comment">// ==================== Fetch Stream Implementation ====================</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startFetchStream</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchOutput'</span>);
      <span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startFetchBtn'</span>);
      <span class="hljs-keyword">const</span> stopBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'stopFetchBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchStatusText'</span>);
      <span class="hljs-keyword">const</span> byteCount = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchByteCount'</span>);
      <span class="hljs-keyword">const</span> progressBar = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchProgress'</span>);
      
      <span class="hljs-comment">// 重置状态</span>
      output.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
      fetchByteCount = <span class="hljs-number">0</span>;
      byteCount.<span class="hljs-property">textContent</span> = <span class="hljs-string">'0'</span>;
      progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'0%'</span>;
      
      <span class="hljs-comment">// 更新UI状态</span>
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      stopBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-loading'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'流式传输中...'</span>;
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 创建AbortController用于取消请求</span>
        fetchController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
        
        <span class="hljs-comment">// 模拟流式响应 - 在实际应用中这会是一个真实的API端点</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">simulateFetchStream</span>(fetchController.<span class="hljs-property">signal</span>);
        
        <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
        <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
        
        <span class="hljs-keyword">let</span> progress = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> totalChunks = <span class="hljs-number">20</span>; <span class="hljs-comment">// 模拟总块数</span>
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
          <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
          
          <span class="hljs-keyword">if</span> (done) {
            <span class="hljs-keyword">break</span>;
          }
          
          <span class="hljs-comment">// 解码数据块</span>
          <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
          
          <span class="hljs-comment">// 更新输出</span>
          output.<span class="hljs-property">innerHTML</span> += chunk;
          output.<span class="hljs-property">scrollTop</span> = output.<span class="hljs-property">scrollHeight</span>;
          
          <span class="hljs-comment">// 更新统计信息</span>
          fetchByteCount += value.<span class="hljs-property">byteLength</span>;
          byteCount.<span class="hljs-property">textContent</span> = fetchByteCount;
          
          <span class="hljs-comment">// 更新进度条</span>
          progress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(progress + <span class="hljs-number">1</span>, totalChunks);
          <span class="hljs-keyword">const</span> percentage = (progress / totalChunks) * <span class="hljs-number">100</span>;
          progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = percentage + <span class="hljs-string">'%'</span>;
        }
        
        <span class="hljs-comment">// 完成后更新状态</span>
        statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-connected'</span>;
        statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'传输完成'</span>;
        
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Fetch流式错误:'</span>, error);
          statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'传输错误: '</span> + error.<span class="hljs-property">message</span>;
        } <span class="hljs-keyword">else</span> {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'传输已停止'</span>;
        }
      } <span class="hljs-keyword">finally</span> {
        startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
        stopBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> !== <span class="hljs-string">'100%'</span>) {
          progressBar.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'100%'</span>;
        }
      }
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">stopFetchStream</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (fetchController) {
        fetchController.<span class="hljs-title function_">abort</span>();
        fetchController = <span class="hljs-literal">null</span>;
      }
      
      <span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startFetchBtn'</span>);
      <span class="hljs-keyword">const</span> stopBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'stopFetchBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchStatusText'</span>);
      
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      stopBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'传输已停止'</span>;
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">clearFetchOutput</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchOutput'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchByteCount'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'0'</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchProgress'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">'0%'</span>;
    }
    
    <span class="hljs-comment">// 模拟Fetch流式响应</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">simulateFetchStream</span>(<span class="hljs-params">signal</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-comment">// 创建一个ReadableStream来模拟服务器响应</span>
        <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadableStream</span>({
          <span class="hljs-title function_">start</span>(<span class="hljs-params">controller</span>) {
            <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">const</span> maxChunks = <span class="hljs-number">20</span>;
            
            <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendChunk</span> = (<span class="hljs-params"/>) =&gt; {
              <span class="hljs-keyword">if</span> (count &gt;= maxChunks || signal.<span class="hljs-property">aborted</span>) {
                controller.<span class="hljs-title function_">close</span>();
                <span class="hljs-keyword">return</span>;
              }
              
              count++;
              <span class="hljs-keyword">const</span> chunkData = <span class="hljs-string">`数据块 <span class="hljs-subst">${count}</span>: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>\n`</span> +
                               <span class="hljs-string">`随机内容: <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substring(<span class="hljs-number">7</span>)}</span>\n`</span> +
                               <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-string">'='</span>.repeat(<span class="hljs-number">50</span>)}</span>\n`</span>;
              
              controller.<span class="hljs-title function_">enqueue</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(chunkData));
              
              <span class="hljs-comment">// 随机间隔发送下一个块</span>
              <span class="hljs-built_in">setTimeout</span>(sendChunk, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">800</span> + <span class="hljs-number">200</span>);
            };
            
            <span class="hljs-title function_">sendChunk</span>();
          }
        });
        
        <span class="hljs-comment">// 模拟响应对象</span>
        <span class="hljs-title function_">resolve</span>({
          <span class="hljs-attr">body</span>: stream
        });
      });
    }

    <span class="hljs-comment">// ==================== SSE Implementation ====================</span>
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectSSE</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseOutput'</span>);
      <span class="hljs-keyword">const</span> connectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connectSSEBtn'</span>);
      <span class="hljs-keyword">const</span> disconnectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'disconnectSSEBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusText'</span>);
      <span class="hljs-keyword">const</span> eventCount = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseEventCount'</span>);
      
      <span class="hljs-comment">// 重置状态</span>
      output.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
      sseEventCount = <span class="hljs-number">0</span>;
      eventCount.<span class="hljs-property">textContent</span> = <span class="hljs-string">'0'</span>;
      
      <span class="hljs-comment">// 更新UI状态</span>
      connectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      disconnectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-loading'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'连接中...'</span>;
      
      <span class="hljs-comment">// 模拟SSE连接</span>
      <span class="hljs-title function_">simulateSSEConnection</span>();
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnectSSE</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (sseConnection) {
        <span class="hljs-built_in">clearInterval</span>(sseConnection);
        sseConnection = <span class="hljs-literal">null</span>;
      }
      
      <span class="hljs-keyword">const</span> connectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connectSSEBtn'</span>);
      <span class="hljs-keyword">const</span> disconnectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'disconnectSSEBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusText'</span>);
      
      connectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      disconnectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'连接已断开'</span>;
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">clearSSEOutput</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseOutput'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseEventCount'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'0'</span>;
    }
    
    <span class="hljs-comment">// 模拟SSE连接</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">simulateSSEConnection</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseOutput'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusText'</span>);
      <span class="hljs-keyword">const</span> eventCount = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseEventCount'</span>);
      
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-connected'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'已连接'</span>;
      
      <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
      sseConnection = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        count++;
        sseEventCount++;
        eventCount.<span class="hljs-property">textContent</span> = sseEventCount;
        
        <span class="hljs-keyword">const</span> eventData = <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>] 服务器事件 #<span class="hljs-subst">${count}</span>\n`</span> +
                         <span class="hljs-string">`事件类型: 系统通知\n`</span> +
                         <span class="hljs-string">`内容: 这是第<span class="hljs-subst">${count}</span>个模拟事件\n`</span> +
                         <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-string">'-'</span>.repeat(<span class="hljs-number">40</span>)}</span>\n`</span>;
        
        output.<span class="hljs-property">innerHTML</span> += eventData;
        output.<span class="hljs-property">scrollTop</span> = output.<span class="hljs-property">scrollHeight</span>;
        
        <span class="hljs-comment">// 模拟连接断开</span>
        <span class="hljs-keyword">if</span> (count === <span class="hljs-number">15</span>) {
          <span class="hljs-built_in">clearInterval</span>(sseConnection);
          sseConnection = <span class="hljs-literal">null</span>;
          <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusIndicator'</span>);
          <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusText'</span>);
          statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'连接已断开'</span>;
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connectSSEBtn'</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'disconnectSSEBtn'</span>).<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
        }
      }, <span class="hljs-number">1000</span>);
    }

    <span class="hljs-comment">// ==================== WebSocket Implementation ====================</span>
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectWebSocket</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> connectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connectWSBtn'</span>);
      <span class="hljs-keyword">const</span> disconnectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'disconnectWSBtn'</span>);
      <span class="hljs-keyword">const</span> sendBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sendBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusText'</span>);
      <span class="hljs-keyword">const</span> chatMessages = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chatMessages'</span>);
      
      <span class="hljs-comment">// 重置状态</span>
      chatMessages.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
      messageCount = <span class="hljs-number">0</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messageCount'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'0'</span>;
      
      <span class="hljs-comment">// 更新UI状态</span>
      connectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      disconnectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      sendBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-loading'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'连接中...'</span>;
      
      <span class="hljs-comment">// 模拟WebSocket连接</span>
      <span class="hljs-title function_">simulateWebSocketConnection</span>();
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">disconnectWebSocket</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (wsConnection) {
        <span class="hljs-built_in">clearInterval</span>(wsConnection);
        wsConnection = <span class="hljs-literal">null</span>;
      }
      
      <span class="hljs-keyword">const</span> connectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connectWSBtn'</span>);
      <span class="hljs-keyword">const</span> disconnectBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'disconnectWSBtn'</span>);
      <span class="hljs-keyword">const</span> sendBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sendBtn'</span>);
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusText'</span>);
      
      connectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      disconnectBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      sendBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'连接已断开'</span>;
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messageInput'</span>);
      <span class="hljs-keyword">const</span> message = input.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
      
      <span class="hljs-keyword">if</span> (message) {
        <span class="hljs-title function_">addMessage</span>(message, <span class="hljs-string">'user'</span>);
        input.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
        
        <span class="hljs-comment">// 模拟机器人回复</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> replies = [
            <span class="hljs-string">'你好！我收到了你的消息。'</span>,
            <span class="hljs-string">'这是一个很好的问题！'</span>,
            <span class="hljs-string">'让我想想如何回答...'</span>,
            <span class="hljs-string">'感谢你的分享！'</span>,
            <span class="hljs-string">'我理解你的观点。'</span>,
            <span class="hljs-string">'这很有趣！告诉我更多。'</span>
          ];
          <span class="hljs-keyword">const</span> randomReply = replies[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * replies.<span class="hljs-property">length</span>)];
          <span class="hljs-title function_">addMessage</span>(randomReply, <span class="hljs-string">'bot'</span>);
        }, <span class="hljs-number">1000</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2000</span>);
      }
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleKeyPress</span>(<span class="hljs-params">event</span>) {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
        <span class="hljs-title function_">sendMessage</span>();
      }
    }
    
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">addMessage</span>(<span class="hljs-params">content, sender</span>) {
      <span class="hljs-keyword">const</span> chatMessages = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chatMessages'</span>);
      <span class="hljs-keyword">const</span> messageCountEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'messageCount'</span>);
      
      <span class="hljs-keyword">const</span> messageDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      messageDiv.<span class="hljs-property">className</span> = <span class="hljs-string">`message message-<span class="hljs-subst">${sender}</span>`</span>;
      
      <span class="hljs-keyword">const</span> timeString = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleTimeString</span>();
      messageDiv.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
        &lt;div&gt;<span class="hljs-subst">${content}</span>&lt;/div&gt;
        &lt;small style="opacity: 0.7; font-size: 0.8em;"&gt;<span class="hljs-subst">${timeString}</span>&lt;/small&gt;
      `</span>;
      
      chatMessages.<span class="hljs-title function_">appendChild</span>(messageDiv);
      chatMessages.<span class="hljs-property">scrollTop</span> = chatMessages.<span class="hljs-property">scrollHeight</span>;
      
      messageCount++;
      messageCountEl.<span class="hljs-property">textContent</span> = messageCount;
    }
    
    <span class="hljs-comment">// 模拟WebSocket连接</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">simulateWebSocketConnection</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> statusIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusIndicator'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusText'</span>);
      
      statusIndicator.<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-connected'</span>;
      statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'已连接'</span>;
      
      <span class="hljs-comment">// 模拟系统消息</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">'欢迎来到实时聊天室！'</span>, <span class="hljs-string">'bot'</span>);
      }, <span class="hljs-number">500</span>);
      
      <span class="hljs-comment">// 模拟定期系统通知</span>
      <span class="hljs-keyword">let</span> notificationCount = <span class="hljs-number">0</span>;
      wsConnection = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        notificationCount++;
        <span class="hljs-keyword">if</span> (notificationCount &lt;= <span class="hljs-number">5</span>) {
          <span class="hljs-title function_">addMessage</span>(<span class="hljs-string">`系统通知: 用户在线数 <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>)}</span>`</span>, <span class="hljs-string">'bot'</span>);
        }
      }, <span class="hljs-number">5000</span>);
    }

    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 设置初始状态指示器</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'fetchStatusIndicator'</span>).<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sseStatusIndicator'</span>).<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'wsStatusIndicator'</span>).<span class="hljs-property">className</span> = <span class="hljs-string">'status-indicator status-disconnected'</span>;
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>

</code></pre>
<h2 data-id="heading-14">最佳实践总结</h2>
<ol>
<li>
<p><strong>选择合适的传输协议</strong>：</p>
<ul>
<li>单向流式输出：Fetch + ReadableStream 或 SSE</li>
<li>双向实时通信：WebSocket</li>
</ul>
</li>
<li>
<p><strong>合理设置缓冲区大小</strong>：避免内存溢出</p>
</li>
<li>
<p><strong>实现优雅降级</strong>：当流式不支持时提供备选方案</p>
</li>
<li>
<p><strong>添加适当的错误处理</strong>：网络中断、解析错误等</p>
</li>
<li>
<p><strong>考虑用户体验</strong>：加载状态提示、自动滚动等</p>
</li>
<li>
<p><strong>性能监控</strong>：记录传输速度、错误率等指标</p>
</li>
</ol>
<p>通过以上实现方式和最佳实践，你可以轻松在项目中集成流式输出功能，为用户提供更加流畅和实时的交互体验。记住根据具体需求选择最适合的技术方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter官方正在搞热更新（动态化）？硬核，干货，有证据，有代码]]></title>    <link>https://juejin.cn/post/7584362317001834523</link>    <guid>https://juejin.cn/post/7584362317001834523</guid>    <pubDate>2025-12-17T01:19:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584362317001834523" data-draft-id="7584110439933657134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter官方正在搞热更新（动态化）？硬核，干货，有证据，有代码"/> <meta itemprop="keywords" content="Flutter,开源"/> <meta itemprop="datePublished" content="2025-12-17T01:19:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孤鸿玉"/> <meta itemprop="url" content="https://juejin.cn/user/3738794874900295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter官方正在搞热更新（动态化）？硬核，干货，有证据，有代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3738794874900295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孤鸿玉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:19:23.000Z" title="Wed Dec 17 2025 01:19:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Flutter官方正在搞热更新（动态化）？或许会有人被这个标题吸引过来的吧。一定会有人抱着批判的态度来打脸了吧：</p>
<ul>
<li>Flutter官方不可能去搞热更新（动态化）,在很早之前，官方已经声明不会去搞这一块了，怎么可能突然变卦？且根本一点消息也没有！</li>
<li>就算搞了热更新，但绕不过苹果AppStore审核，搞了等于白搞啊！</li>
<li>你说的不会是shorebird吧，这个不是官方的！</li>
</ul>
<p>我到底是不是标题党？各位看官别着急，且听我狡辩，不对，是解释（抱头）。</p>
<p>早在一年多前，我就研究过Flutter动态化的，为此我还开源过一个动态化的实验方案：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flancexin%2Fmicro_dart" target="_blank" title="https://github.com/lancexin/micro_dart" ref="nofollow noopener noreferrer">MicroDart</a> 但这个项目并不完整，一直在实验阶段，且它有一些十分致命的缺点，比如编译速度慢，且编译后包太大等，桥接层难写等，让我感觉这个思路错了。所以就没有再继续更新。（实际上是因为我研究生毕业论文写的这个，毕业后就懒得管了（捂脸））</p>
<p>在接触shorebird后，让我更加肯定自己的想法，如果要真实现Flutter动态化，shorebird的思路在性能上才是最佳的。但shorebird的实现成本很高，它需要修改DartVM虚拟机的代码，让它能够以混合的方式去运行 AOT代码和Kernel代码。且shorebird不开源，又不免费，在国内还有网络影响。这让我对shorebird在国内发展不看好。</p>
<p>个人对shorebird的实现原理非常好奇，但个人能力有限且刚换新工作，新的工作也没有热更新的需求，就一直拖延着没有再继续研究下去。</p>
<p>终于最近又有了时间，准备研究一下DartVM的运行与实现原理。却无意中让我找到了一些蛛丝马迹：</p>
<ul>
<li>首先，Dart Sdk的编译项中发现了DART_DYNAMIC_MODULES 这个特殊的项，查找发现这个项出现的次数非常频繁。</li>
<li>其次，在pkg目录下面发现了dynamic_modules 这个包，查看创建时间是2024年。</li>
<li>再次，在pkg目录下面还发现了 dart2bytecode这个包，可以将dart编译成字节码。</li>
<li>再再次，我在dart:_internal 包中发现了 loadDynamicModule 这么个函数。</li>
</ul>
<p>让我们再看看loadDynamicModule函数的说明：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/// Load a dynamic module and execute its entry point method.</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// Only one of the two arguments must be provided, depending on the delivery</span>
<span class="hljs-comment">/// mechanism and the underlying platform.</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// Entry point method is a no-argument method annotated with</span>
<span class="hljs-comment">/// `@pragma('dyn-module:entry-point')`.</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// Returns a future containing the result of the entry point method.</span>
external Future&lt;<span class="hljs-selector-tag">Object</span>?&gt; <span class="hljs-built_in">loadDynamicModule</span>({Uri?uri, Uint8List?bytes});
</code></pre>
<p>第一句话就让我虎躯一震：“加载一个动态化模块并执行它的入口函数”，这难道就是传说中的？？？？</p>
<p>在研究dart2bytecode是让我的猜想的到证实， 这个包实际上就是将需要动态化部分的代码编译成字节码的包，在它的README中可以看到：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Dart Bytecode File Format</span>

<span class="hljs-section">## Overview</span>

This file describes the binary format of Dart bytecode files.

Dart bytecode is a binary representation of dynamic modules
on the VM/AOT. It is generated by dart2bytecode tools and
can be executed by the VM and AOT runtime (built with dynamic modules support).
</code></pre>
<p>从上方的说明中也可以发现通过dart2bytecode生成的字节码不仅能运行在VM模式下，也能运行在AOT模式下。这他妈不就是shorebird的运行原理吗？我的虎躯再震。</p>
<p>dynamic_modules 这个包实际上就是对loadDynamicModule函数做的一个封装，它还写了丰富的测试用例。在编译dart sdk源码后可以通过输入下方命令执行 dynamic_modules中的测试用例：</p>
<pre><code class="hljs language-shell" lang="shell">./xcodebuild/DebugARM64/dart-sdk/bin/dart run 
./pkg/dynamic_modules/test/runner/main.dart -r aot -v
</code></pre>
<p>但是第一次执行我失败了，后来才发现是sdk的编译参数中没有开启DART_DYNAMIC_MODULES，我再次对sdk进行编译：</p>
<pre><code class="hljs language-shell" lang="shell">./tools/build.py --mode debug create_sdk --dart-dynamic-modules
</code></pre>
<p>再次编译后发现dynamic_modules的测试用例可以正常跑起来了。</p>
<p>dynamic_modules包里的测试用例涵盖面非常广，大家可以在dynamic_modules/test/data目录下找到。</p>
<p>特别建议大家看一下 dynamic_modules/test/data/README.md里的内容，可以让我们充分理解dynamic_modules的代码结构，由于篇幅原因，我这边不过赘述，有兴趣的同学可以自行查看。</p>
<p>经过上面的测试与研究，我开始兴奋起来。有搞头啊，真的有搞头啊，这是Dart官方实现的AOT+字节码混合运行的方式，且看上去已经能够运用到实际生产环境中了！！！</p>
<p>但接下来我冷静了，光在PC上通过Dart Sdk上验证可行性并不代表在Flutter环境里以能用啊，也不能表示在android和ios里也能用啊，于是我又马不停蹄的去下载了Flutter Engine源码，继续开始了研究。</p>
<hr/>
<p>如何能够让dynamic_modules在Flutter中也能运行呢？我总结一下需要突破以下难题：</p>
<ol>
<li>loadDynamicModule函数是dart:_internal里的包，是不对开发者开放的，我们的项目如何调用这个函数呢？</li>
<li>Flutter SDK默认并没有开放dynamic_modules特性，如何编译出支持dynamic_modules特性的Flutter SDK呢？</li>
<li>我们的Flutter项目都是通过flutter_tools进行编译的flutter_tools如何支持dynamic_modules特性呢？</li>
<li>我们的Fluter项目如何编译出符合动态化运行的字节码呢？</li>
</ol>
<p>经过研究，发现以上难题都是能解决的：</p>
<ol>
<li>首先是loadDynamicModule的调用问题，我们可以在kernal/target/targets.dart中找到如下代码：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">Whether a library is allowed to import the platform private library</span></span>
 <span class="hljs-comment">/// <span class="markdown">[imported] from library [importer].</span></span>
 <span class="hljs-comment">///</span>
 <span class="hljs-comment">/// <span class="markdown">By default only <span class="hljs-code">`dart:*`</span> libraries are allowed. May be overridden for</span></span>
 <span class="hljs-comment">/// <span class="markdown">testing purposes.</span></span>
boolallowPlatformPrivateLibraryAccess(<span class="hljs-built_in">Uri</span> importer, <span class="hljs-built_in">Uri</span> imported) =&gt;
 importer.isScheme(<span class="hljs-string">"dart"</span>) ||
 (importer.isScheme(<span class="hljs-string">"package"</span>) &amp;&amp;
 (importer.path.startsWith(<span class="hljs-string">"dart_internal/"</span>) ||
 importer.path.startsWith(<span class="hljs-string">"dynamic_modules/"</span>)));
</code></pre>
<p>从上面代码中我们可以得知，如果库的名称是dart_internal或者 dynamic_modules则没有dart:_internal包的调用限制。那就很简单了，我们只需要创建一个名称为dynamic_modules的包,在里面调用dart:_internal的方法，编译器就不会报错。</p>
<p>其次是IDE的报错，例如VS Code，我们可以在dynamic_modules包下面的analysis_options.yaml中添加如下代码，报错提示就会消失：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">include:</span> <span class="hljs-string">package:lints/recommended.yaml</span>

<span class="hljs-attr">analyzer:</span>
  <span class="hljs-attr">errors:</span>
    <span class="hljs-attr">import_internal_library:</span> <span class="hljs-string">ignore</span>
</code></pre>
<ol>
<li>Flutter SDK编译问题：</li>
</ol>
<blockquote>
<p>注： Flutter Engine 源码建议通过depot_tools下载，可能还需要科学上网，不然第三方库不全，是没办法编译通过的，建议大家看一下官方仓库的说明。</p>
</blockquote>
<p>Flutter Engine可以通过et命令进行编译，下载Flutter Engine源码后可以将 et命令加入环境变量，如果你和我一样是通过VS Code和Mac调试代码，可以在.vscode/settings.json中加入如下设置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal.integrated.env.osx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"PATH"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-path-to-flutter-sdk/flutter/engine/src/flutter/bin:$PATH"</span>
   <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>我们可以通过下面命令编译有dynamic-modules特性的host环境（因为我是apple M4 这里选了arm64）：</p>
<pre><code class="hljs language-shell" lang="shell">et build --config host_release_arm64 --gn-args="--dart-dynamic-modules" --verbose
</code></pre>
<p>host环境表示你的Flutter所属PC运行环境，可以是linux，windows或macos</p>
<ol>
<li>flutter_tools 支持dynamic-modules问题：</li>
</ol>
<p>Flutter 源码的编译是通过flutter_tools中转，最终还是通过 frontend_server 进行编译的，frontend_server源代码可以在 dart sdk源码的 pkg/frontend_server中找到，在frontend_server中我们可以找到 --dynamic-interface 选项，因此如果我们可以通过flutter_tools将-dynamic-interface 选项透传过去，就能够编译出可混合运行字节码的包，而flutter_tools中刚刚有--extra-front-end-options这么个参数项可以透传到frontend_server中。以下命令可以参考：</p>
<pre><code class="hljs language-shell" lang="shell">flutter run -d macos 
--local-engine-host=your-path-to-flutter-sdk/flutter/engine/src/out/host_release_arm64 
--local-engine=your-path-to-flutter-sdk/flutter/engine/src/out/host_release_arm64 
--release --extra-front-end-options=--dynamic-interface=dynamic_interface.yaml
</code></pre>
<p>上面的代码可以让我们运行在Flutter Engine源码编译出运行环境中，且加上 --dynamic-interface参数。</p>
<ol>
<li>编译动态化运行的字节码：</li>
</ol>
<p>如何编译可动态化运行的字节码，早在dynamic_modules库中的测试用例的实现代码中就能够找到，这里简单说明一下dynamic_modules是如何测试的：</p>
<ul>
<li>a. 通过 gen_kernel_aot.dart.snapshot 编译出kernal文件,编译需要添加--dynamic-interface dynamic_interface.yaml 用来描述动态化的范围dynamic_interface.yaml 如何编写在dynamic_modules的README中有叙述，这里不在重复。</li>
<li>b.调用createTrimmedCopy函数对kernel文件进行压缩（这个是可选项，不进行压缩也可以运行）</li>
<li>c. 通过 dart2bytecode.dart.snapshot 编译出字节码，编译过程中需要用到上面编译出的kernal文件以及dynamic_interface.yaml 文件。</li>
<li>d. gen_kernel_aot.dart.snapshot 编译出aot文件（这个是验证项，验证kernal能正常编译出aot产物）</li>
</ul>
<blockquote>
<p>注：步骤 a和步骤c是生成字节码的必须过程。</p>
</blockquote>
<hr/>
<p>OK 准备工作已经做完，下面是重头戏：写一个Flutter程序用来验证这个动态化方案是否能跑通了。</p>
<p>测试程序已经开源： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flancexin%2Fdemo_dynamic_feature_modules" target="_blank" title="https://github.com/lancexin/demo_dynamic_feature_modules" ref="nofollow noopener noreferrer">下载地址</a></p>
<p>现在让我说一下这个测试程序的代码结构：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">demo_dynamic_feature_modules</span> <span class="hljs-comment"># 测试程序（非动态化母包）</span>
  <span class="hljs-string">-assets</span> <span class="hljs-comment"># 资源</span>
    <span class="hljs-string">-modules</span>
      <span class="hljs-string">dynamic_module_1.bytecode</span> <span class="hljs-comment"># 动态化字节码1</span>
      <span class="hljs-string">dynamic_module_2.bytecode</span> <span class="hljs-comment"># 动态化字节码2</span>
  <span class="hljs-string">-bin</span>
    <span class="hljs-string">build_modules.dart</span> <span class="hljs-comment"># 执行编译字节码操作</span>
    <span class="hljs-string">env.dart</span> <span class="hljs-comment"># 编译环境初始化</span>
  <span class="hljs-string">-pacakges</span>
    <span class="hljs-string">-dynamic_modules</span> <span class="hljs-comment"># 动态化调用库</span>
    <span class="hljs-string">-dynamic_modules_1</span> <span class="hljs-comment"># 动态化代码库1 会编译成字节码：dynamic_module_1.bytecode</span>
    <span class="hljs-string">-dynamic_modules_2</span> <span class="hljs-comment"># 动态化代码库2 会编译成字节码：dynamic_module_2.bytecode</span>
  <span class="hljs-string">-lib</span>
    <span class="hljs-string">home.dart</span> <span class="hljs-comment"># 首页面</span>
    <span class="hljs-string">main.dart</span> 
    <span class="hljs-string">router.dart</span> <span class="hljs-comment"># 路由以及懒加载动态化字节码实现逻辑</span>
    <span class="hljs-string">shared.dart</span> <span class="hljs-comment"># 动态化字节码可公用的代码部分</span>
  <span class="hljs-string">dynamic_interface.yaml</span> <span class="hljs-comment">#动态化描述文件</span>
  <span class="hljs-string">pubspec.yaml</span>
</code></pre>
<p>一些代码的补充说明：</p>
<ol>
<li>非动态化母包 <em><strong>demo_dynamic_feature_modules</strong></em> 是不依赖 <em><strong>dynamic_modules_1</strong></em>和 <em><strong>dynamic_modules_2</strong></em>的，这样我们可以保证在编译<em><strong>demo_dynamic_feature_modules</strong></em>时不会将动态化部分的代码编译进去。</li>
<li><em><strong>dynamic_modules_1</strong></em> 和 <em><strong>dynamic_modules_2</strong></em>是依赖 <em><strong>demo_dynamic_feature_modules</strong></em>的，这能保证 <em><strong>dynamic_modules_1</strong></em>和<em><strong>dynamic_modules_2</strong></em>中的动态化代码可以调用非动态化母包中的代码。</li>
<li><em><strong>dynamic_modules_1</strong></em>和 <em><strong>dynamic_modules_2</strong></em>编译成字节码后会打包成资源放在assets里，但在实际过程中我们可以将这些字节码文件通过网络方式下载并加载执行，达到热更新的目的。</li>
<li>如果是为了热修复，我们可以将<em><strong>dynamic_modules_1</strong></em> <strong>和</strong> <em><strong>dynamic_modules_2</strong></em>的代码打包进母程序里的，我们只需要将动态化部分的代码里的包名称修改一下，就能够实现与原有逻辑不冲突的前提下执行动态下发的逻辑，这个程序只是为了验证字节码是否能够在AOT模式下执行，并没有做这方面的实现。</li>
</ol>
<p>一些代码段与注释：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># &lt;dynamic_interface.yaml&gt;</span>
<span class="hljs-comment"># Copyright (c) 2024, the Dart project authors. Please see the AUTHORS file</span>
<span class="hljs-comment"># for details. All rights reserved. Use of this source code is governed by a</span>
<span class="hljs-comment"># BSD-style license that can be found in the LICENSE file.</span>


<span class="hljs-attr">extendable:</span>
  <span class="hljs-comment"># 动态化代码里继承了StatefulWidget这部分是必须的</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">library:</span> <span class="hljs-string">'package:flutter/material.dart'</span>


<span class="hljs-attr">can-be-overridden:</span>
 <span class="hljs-comment"># 动态化代码里继承了StatefulWidget这部分是必须的</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">library:</span> <span class="hljs-string">'package:flutter/material.dart'</span>


<span class="hljs-attr">callable:</span>
  <span class="hljs-comment"># core一般是必须倒入的，不然基本变量都没法调用</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">library:</span> <span class="hljs-string">'dart:core'</span>
  <span class="hljs-comment"># 动态化代码里继承了 StatefulWidget这部分是必须的</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">library:</span> <span class="hljs-string">'package:flutter/material.dart'</span>
  <span class="hljs-comment"># 这部分描述了母程序里可以调用的代码入口</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">library:</span> <span class="hljs-string">'package:demo_dynamic_feature_modules/demo_dynamic_feature_modules.dart'</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;bin/build_modules.dart&gt;</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'env.dart'</span>;

<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">//非aot模式编译kernal</span>
  <span class="hljs-keyword">await</span> compileFlutterKernel(
    repoName: <span class="hljs-string">"demo_dynamic_feature_modules"</span>,
    enterPoint: <span class="hljs-string">"lib/main.dart"</span>,
    isAot: <span class="hljs-keyword">false</span>,
  );
  <span class="hljs-comment">//非aot模式编译kernal，并验证编译成aot文件</span>
  <span class="hljs-keyword">await</span> compileFlutterKernel(
    repoName: <span class="hljs-string">"demo_dynamic_feature_modules"</span>,
    enterPoint: <span class="hljs-string">"lib/main.dart"</span>,
    isAot: <span class="hljs-keyword">true</span>,
  );
  <span class="hljs-comment">//编译dynamic_module_1字节码</span>
  <span class="hljs-keyword">await</span> compileDynamicModule(
    repoName: <span class="hljs-string">"demo_dynamic_feature_modules"</span>,
    enterPoint: <span class="hljs-string">"lib/dynamic_module_1.dart"</span>,
    name: <span class="hljs-string">'dynamic_module_1'</span>,
    out: <span class="hljs-string">'assets/modules/dynamic_module_1.bytecode'</span>,
    isAot: <span class="hljs-keyword">false</span>,
  );
  <span class="hljs-comment">//编译dynamic_module_2字节码</span>
  <span class="hljs-keyword">await</span> compileDynamicModule(
    repoName: <span class="hljs-string">"demo_dynamic_feature_modules"</span>,
    enterPoint: <span class="hljs-string">"lib/dynamic_module_2.dart"</span>,
    name: <span class="hljs-string">'dynamic_module_2'</span>,
    out: <span class="hljs-string">'assets/modules/dynamic_module_2.bytecode'</span>,
    isAot: <span class="hljs-keyword">false</span>,
  );
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;main.dart&gt;</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:demo_dynamic_feature_modules/demo_dynamic_feature_modules.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(<span class="hljs-keyword">const</span> MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Dynamic Module Demo'</span>,
      theme: ThemeData(colorScheme: .fromSeed(seedColor: Colors.deepPurple)),
      onGenerateRoute: MyRouter.onGenerateRoute,
    );
  }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;home.dart&gt;</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-comment">//首页</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Home</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Home({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Home&gt; createState() =&gt; _HomeState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_HomeState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Home</span>&gt; </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">"Dynamic Feature Modules Test"</span>)),
      body: SingleChildScrollView(
        child: Column(
          children: [
            TextButton(
              onPressed: () {
                <span class="hljs-comment">//点击跳转到动态化模块1</span>
                Navigator.of(context).pushNamed(<span class="hljs-string">"/dynamic_module_1"</span>);
              },
              child: Text(<span class="hljs-string">"dynamic_module_1"</span>),
            ),
            TextButton(
              onPressed: () {
                <span class="hljs-comment">//点击跳转到动态化模块2</span>
                Navigator.of(context).pushNamed(<span class="hljs-string">"/dynamic_module_2"</span>);
              },
              child: Text(<span class="hljs-string">"dynamic_module_2"</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;shared.dart&gt;</span>
<span class="hljs-comment">// 全局共用的参数，在母包中会被编译成aot代码</span>
<span class="hljs-built_in">int</span> _refreshCount = <span class="hljs-number">0</span>;

<span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> refreshCount =&gt; _refreshCount;

<span class="hljs-keyword">set</span> refreshCount(<span class="hljs-built_in">int</span> c) {
  _refreshCount = c;
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;router.dart&gt;</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:demo_dynamic_feature_modules/home.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dynamic_modules/dynamic_modules.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span> <span class="hljs-keyword">show</span> rootBundle;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyRouter</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> home = <span class="hljs-string">"/home"</span>;

  <span class="hljs-comment">//路由表</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, Widget <span class="hljs-built_in">Function</span>(BuildContext)&gt; routes = {
    <span class="hljs-string">"/home"</span>: (BuildContext context) =&gt; <span class="hljs-keyword">const</span> Home(),
    <span class="hljs-string">"/"</span>: (BuildContext context) =&gt; <span class="hljs-keyword">const</span> Home(), <span class="hljs-comment">//home入口</span>
  };

  <span class="hljs-comment">//路由入口</span>
  <span class="hljs-keyword">static</span> Route&lt;<span class="hljs-built_in">dynamic</span>&gt;? onGenerateRoute(RouteSettings settings) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"onGenerateRoute <span class="hljs-subst">${settings.name}</span>"</span>);
    <span class="hljs-comment">//查找路由表回调方法</span>
    <span class="hljs-keyword">var</span> routerFun = routes[settings.name];
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"routerFun is  <span class="hljs-subst">${routerFun}</span>"</span>);

    <span class="hljs-comment">//如果没有找到则调用动态化加载器进行加载</span>
    <span class="hljs-keyword">if</span> (routerFun == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> MaterialPageRoute(
        builder: (context) =&gt; DynamicModuleLoader(name: settings.name!),
      );
    }
    <span class="hljs-comment">//否则直接返回</span>
    <span class="hljs-keyword">return</span> MaterialPageRoute(builder: (context) =&gt; routerFun.call(context));
  }
}

<span class="hljs-comment">//动态化代码加载器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicModuleLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">const</span> DynamicModuleLoader({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name});

  <span class="hljs-meta">@override</span>
  State&lt;DynamicModuleLoader&gt; createState() =&gt; _DynamicModuleLoaderState();

  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> <span class="hljs-keyword">library</span> =&gt; <span class="hljs-string">"package:<span class="hljs-subst">$name</span><span class="hljs-subst">$name</span>.dart"</span>;
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> module =&gt; <span class="hljs-string">"assets/modules<span class="hljs-subst">$name</span>.bytecode"</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DynamicModuleLoaderState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">DynamicModuleLoader</span>&gt; </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
  }

  Widget _widgetError(<span class="hljs-built_in">String</span> error) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(),
      body: Center(child: Text(error)),
    );
  }

  Future createLoadFuture() {
    <span class="hljs-keyword">var</span> uri = <span class="hljs-built_in">Uri</span>.parse(widget.<span class="hljs-keyword">library</span>);

    <span class="hljs-comment">//判断该动态化包是否已经加载过</span>
    <span class="hljs-keyword">if</span> (isModuleLoaded(uri)) {
      <span class="hljs-comment">//如果有以uri的方式加载</span>
      <span class="hljs-comment">//测试发现dart底层代码并没有实现loadModuleFromUri，调用不会生效</span>
      <span class="hljs-keyword">return</span> loadModuleFromUri(uri);
    }
    <span class="hljs-comment">//加载资源中的字节码资源</span>
    <span class="hljs-keyword">return</span> rootBundle.load(widget.module).then((value) {
      <span class="hljs-keyword">return</span> loadModuleFromBytes(
        <span class="hljs-built_in">Uri</span>.parse(widget.<span class="hljs-keyword">library</span>),
        value.buffer.asUint8List(),
      );
    });
  }

  Future&lt;<span class="hljs-built_in">Object?</span>&gt; <span class="hljs-keyword">get</span> loadFuture {
    <span class="hljs-keyword">return</span> createLoadFuture()
        .then((r) <span class="hljs-keyword">async</span> {
          <span class="hljs-comment">//模拟字节码下载过程，延时2秒</span>
          <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
          <span class="hljs-keyword">return</span> r;
        })
        .onError((error, stackTrace) {
          FlutterError.dumpErrorToConsole(
            FlutterErrorDetails(exception: error!, stack: stackTrace),
            forceReport: <span class="hljs-keyword">true</span>,
          );
          <span class="hljs-keyword">throw</span> error;
        });
  }

  Widget _widgetLoading() {
    <span class="hljs-keyword">return</span> Scaffold(body: Center(child: <span class="hljs-keyword">const</span> CircularProgressIndicator()));
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> FutureBuilder&lt;<span class="hljs-built_in">Object?</span>&gt;(
      future: loadFuture,
      builder: (context, snapshot) {
         <span class="hljs-comment">//加载完成</span>
        <span class="hljs-keyword">if</span> (snapshot.connectionState == ConnectionState.done) {
          <span class="hljs-keyword">if</span> (snapshot.hasError) {  <span class="hljs-comment">//加载报错</span>
            <span class="hljs-keyword">return</span> _widgetError(<span class="hljs-string">'Error: <span class="hljs-subst">${snapshot.error}</span>'</span>);
          }
          <span class="hljs-comment">//检测是否已经注入了新路由</span>
          <span class="hljs-keyword">var</span> routeFun = MyRouter.routes[widget.name];
          <span class="hljs-comment">//如果已经有新路由直接调用</span>
          <span class="hljs-keyword">return</span> routeFun?.call(context) ??
              _widgetError(<span class="hljs-string">'Error: Router <span class="hljs-subst">${widget.name}</span> not found'</span>);
        }
        <span class="hljs-comment">//加载中</span>
        <span class="hljs-keyword">return</span> _widgetLoading();
      },
    );
  }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// &lt;pacakges/dynamic_module_1/lib/dynamic_module_1.dart&gt;</span>
<span class="hljs-comment">// 动态化代码</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:demo_dynamic_feature_modules/demo_dynamic_feature_modules.dart'</span>;

<span class="hljs-comment">//动态化代码执行入口，相当于母程序里的main函数</span>
<span class="hljs-meta">@pragma</span>(<span class="hljs-string">'dyn-module:entry-point'</span>)
<span class="hljs-built_in">Object?</span> dynamicModuleEntrypoint() {
  <span class="hljs-comment">//添加母程序里的路由</span>
  MyRouter.routes[<span class="hljs-string">"/dynamic_module_1"</span>] = (BuildContext context) =&gt;
      <span class="hljs-keyword">const</span> DynamicModule1();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}

<span class="hljs-comment">//动态化页面，继承 StatefulWidget</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicModule1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> DynamicModule1({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;DynamicModule1&gt; createState() =&gt; _DynamicModule1State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DynamicModule1State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">DynamicModule1</span>&gt; </span>{

  <span class="hljs-comment">//将母程序里的 refreshCount 赋值给动态化变量</span>
  <span class="hljs-built_in">int</span> _counter = refreshCount;

  <span class="hljs-keyword">void</span> _incrementCounter() {
    setState(() {
      <span class="hljs-comment">//修改母程序里的refreshCount</span>
      refreshCount += <span class="hljs-number">1</span>;
      _counter = refreshCount;
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
        title: Text(<span class="hljs-string">"DynamicModule1"</span>),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: .center,
          children: [
            <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'You have pushed the button this many times:'</span>),
            Text(
              <span class="hljs-string">'<span class="hljs-subst">$_counter</span>'</span>,
              style: Theme.of(context).textTheme.headlineMedium,
            ),
          ],
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _incrementCounter,
        tooltip: <span class="hljs-string">'Increment'</span>,
        child: <span class="hljs-keyword">const</span> Icon(Icons.add),
      ),
    );
  }
}
</code></pre>
<p><em><strong>目前的测试结果是：在mac debug，mac profile，mac release,android debug ,android profile , android release ,ios debug，ios profile，ios release中已经跑通</strong></em></p>
<p><em><strong>发现一个bug：不知道是不是我测试姿势不对，如果加载了 dynamic_module_1 再加载dynamic_module_2会报错，提示package:demo_dynamic_feature_modules/demo_dynamic_feature_modules.dart重复加载，猜测可能是分包的原因。但在dynamic_modules有加载多个字节码文件的例子，可能还需要再研究一下</strong></em></p>
<p><em><strong>发现另外一个bug：貌似相同字节码只能加载一次，不能覆盖操作，暂时也没找到卸载的办法，为此我添加了 isModuleLoaded函数去判断。原本动态化入口函数 <strong>dynamicModuleEntrypoint</strong>原本是返回一个Widget的，现在改成操作母程序里的路由了。</strong></em></p>
<p><em><strong>又发现一个的bug：虽然dart:_internal 包里 loadDynamicModule函数有两个参数 uri和bytes，但查找native的调用并没有实现通过uri加载的实现，坑爹噢。</strong></em></p>
<hr/>
<p>不过，不过，不过，未来可期啊！！！，就像做一个汽车，最难的发动机已经有了，其他配件都是小菜一碟了。有能力的厂甚至已经能基于现状实现自己的动态化方案了。</p>
<p>所以不吹不黑， Flutter官方的动态化方案在不久的将来或许真的要来了。</p>
<p>不过我这也只是初步测试，性能方面的测试还比较欠缺的，希望能有大牛补上吧。</p>
<p>可能有同学问，这么搞到底AppStore能不能过审啊？我的看法是能过，因为下发的字节码是依赖Dart虚拟机执行的，且这些字节码的执行并没有用到jit，仍然是解释执行的范畴。下发的字节码也并不是可执行文件。是符合AppStore审核标准的，Google Play更不用说了。因为IOS这块的实现原理可以说跟shorebird是一般无二的。shorebird都符合审核，想来这个也是可以的。</p>
<p>可能还有同学问，性能到底怎么样啊？我没测试过，但是想来应该至少跟shorebird是一个档次吧，因为实现原理是相同的。肯定比不过纯aot运行的，但是肯定是好于Fair的用JsCore或一些Lua方案的，也肯定比我以前实现的MicroDart强。毕竟动态化代码是小部分的，大部分代码还是aot运行的（定量的话猜测有个10%左右的差距）。</p>
<p>例外多一嘴，如果Flutter官方真推出动态化解决方案，shorebird应该如何自处呢？哈哈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[捉虫日记] 给 useImperativeHandle 加个空依赖，竟让我 debug n 小时]]></title>    <link>https://juejin.cn/post/7584340871413039131</link>    <guid>https://juejin.cn/post/7584340871413039131</guid>    <pubDate>2025-12-17T01:51:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584340871413039131" data-draft-id="7584383352448155686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[捉虫日记] 给 useImperativeHandle 加个空依赖，竟让我 debug n 小时"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-17T01:51:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="siroi"/> <meta itemprop="url" content="https://juejin.cn/user/215976573153598"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [捉虫日记] 给 useImperativeHandle 加个空依赖，竟让我 debug n 小时
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/215976573153598/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    siroi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:51:06.000Z" title="Wed Dec 17 2025 01:51:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>历史项目的 “小需求” 从来都是埋雷重灾区 —— 上周随手给一个一年前的组件加了行依赖项，本以为是优化，结果周一被测试大哥的反馈暴击，一中午深陷 [闭包陷阱 + EventLoop] 迷局，差点没扛住。</p>
</blockquote>
<h2 data-id="heading-0">需求背景</h2>
<p>先看涉及到这次变更的流程和相关作用： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9f17a6515bf43c3b7ed5d4cdf9c9e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyb2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766541066&amp;x-signature=v1o3%2FfGd4cXey9qU%2Fyqk2NYhIys%3D" alt="upload_lpyggl55ribmy9l8qqed04udq5dygg6y.png" width="70%" loading="lazy"/></p>
<ul>
<li><code>ManagementCompnent</code> 封装了ProTable，通过 <strong>ref</strong> 对外暴露reloadTable等方法；</li>
<li>被两个页面复用：<code>management</code> 页面直接引入，<code>system_management</code> 页面通过Modal包裹引入；</li>
<li>依赖 <code>useGetWarehouseBeta</code> 这个数据字典 Hook，必须等字典数据返回后，ProTable才能正常请求列表（否则会渲染异常）。详见另一篇文章 <a href="https://juejin.cn/post/7377672990408802313" target="_blank" title="https://juejin.cn/post/7377672990408802313">[开发随笔] 前端处理数据字典问题的踩坑与填坑</a></li>
</ul>
<p>此外，原来的 <code>useImperativeHandle</code> 没有显式依赖项,随着 <code>management</code> 页面的需求调整，给它也加上了空依赖，自测页面正常，于是提交部署。</p>
<h2 data-id="heading-1">问题爆发：Modal 里面的表格突然“罢工”</h2>
<p>周一正在思考如何重构基础组件，测试大哥突然丢了一个截图：另外一个（system_management）打开后，表格没数据，<strong>接口也没发！</strong> ，只能点击才能触发请求！</p>
<p>我直接大小眼，<strong>同一个组件，直接引入的页面正常，Modal 包裹的就挂了？这不扯呢</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b15a5248a00047d3b86580f06fa3d661~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyb2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766541066&amp;x-signature=jdcPvrvXsLhGAsYhGRKEKIlrYj4%3D" alt="upload_ey830bd3steqpd6tjte8soee3mx0keis.png" width="30%" loading="lazy"/></p>
<p><strong>先看关键代码（一年前的代码，简直不忍直视🤦‍♂️）</strong></p>
<blockquote>
<p>虽然是自己写的，真的是当时为了赶需求排期瞎写了🤣。<del>什么最佳实践，还能比业务上线重要，还不写注释</del></p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c03bfb581d4f6cb7e4e5f7f49c5db1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyb2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766541066&amp;x-signature=E7HXHRXmRp85sywOFn28gIcU%2BIk%3D" alt="upload_dua7lw5qs2eax5zqm7a0g0jb8i5reetn.png" loading="lazy"/></p>
<h2 data-id="heading-2">Management.tsx 核心逻辑</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { isNil } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">import</span> { forwardRef, useImperativeHandle, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProTable</span>, <span class="hljs-title class_">ActionType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ant-design/pro-table'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DictionaryItem</span>,
  useDictionaryItem <span class="hljs-keyword">as</span> useGetWarehouseBeta,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@siroi/react-utils'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Management</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> tableRef = useRef&lt;<span class="hljs-title class_">ActionType</span>&gt;(); <span class="hljs-comment">// ProTable的ref</span>
  <span class="hljs-keyword">const</span> { tid } = props; <span class="hljs-comment">// 业务唯一标识</span>

  <span class="hljs-comment">// 预请求ref：用于字典数据加载完成后触发回调</span>
  <span class="hljs-keyword">const</span> preRequestRef = useRef&lt;{
    res?: <span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">unknown</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
    callback?: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  }&gt;({ <span class="hljs-attr">res</span>: <span class="hljs-function">() =&gt;</span> {}, <span class="hljs-attr">callback</span>: <span class="hljs-keyword">async</span> () =&gt; {} });

  <span class="hljs-comment">// 数据字典Hook：缓存5分钟，依赖preRequestRef传递回调</span>
  <span class="hljs-keyword">const</span> [tenantRoleData, currentTRD] = <span class="hljs-title function_">useGetWarehouseBeta</span>(
    <span class="hljs-string">'tenant_role'</span>,
    getTenantRoleList,
    <span class="hljs-number">300</span>, <span class="hljs-comment">// 缓存5min</span>
    preRequestRef.<span class="hljs-property">current</span>,
  );

  <span class="hljs-comment">// 对外暴露的ref方法（我加了空依赖[]的地方）</span>
  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">originRef</span>: tableRef.<span class="hljs-property">current</span>,
      <span class="hljs-attr">reloadTable</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 字典数据未加载完成：缓存回调，等待字典加载后执行</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isNil</span>(currentTRD)) {
          preRequestRef.<span class="hljs-property">current</span>.<span class="hljs-property">callback</span> = <span class="hljs-keyword">async</span> (...res) =&gt; {
            <span class="hljs-keyword">return</span> tableRef.<span class="hljs-property">current</span>?.<span class="hljs-property">reload</span>?.();
          };
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            preRequestRef.<span class="hljs-property">current</span>.<span class="hljs-property">res</span> = res;
          });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 字典已存在：直接触发表格刷新</span>
          tableRef.<span class="hljs-property">current</span>?.<span class="hljs-property">reload</span>?.();
        }
      },
      <span class="hljs-comment">// 其他暴露方法...</span>
    };
  }, []); <span class="hljs-comment">// 罪魁祸首：空依赖项</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProTable</span> <span class="hljs-attr">actionRef</span>=<span class="hljs-string">{tableRef}</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>;
});
</code></pre>
<h2 data-id="heading-3">system_management.tsx</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useState, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Modal</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Management</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Management'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">SystemManagement</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [showModal, setShowModal] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> originRef = useRef&lt;<span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Management</span>&gt;&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 异步操作：500ms后调用表格刷新</span>
  <span class="hljs-keyword">const</span> loadTable = (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">resolve</span>();
      }, <span class="hljs-number">500</span>);
    });
  };

  <span class="hljs-comment">// 打开Modal并触发刷新</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setShowModal</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">loadTable</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      originRef.<span class="hljs-property">current</span>?.<span class="hljs-property">reloadTable</span>?.(); <span class="hljs-comment">// 这里没触发表格请求</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>打开表格<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">open</span>=<span class="hljs-string">{showModal}</span> <span class="hljs-attr">destroyOnClose</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Management</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{originRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};
</code></pre>
<h2 data-id="heading-4">根因拆解</h2>
<h3 data-id="heading-5">第一坑：useImperativeHandle 的闭包陷阱</h3>
<p>我当初加空依赖 <code>[]</code> 时，其实心里隐约知道闭包风险，但被三个 “自以为是的理由” 说服了：</p>
<ol>
<li>我有 <strong>DictionaryItem</strong> 兜底，由于它是单例，所以即便 currentTRD 为 null，我的请求也只会发送一次；</li>
<li>如果切换页面整个组件也卸载了，重新进入再走逻辑即可；</li>
<li><del>我发现了问题，但我的钱只有这么些，时间紧，能用就行😘</del>。</li>
</ol>
<h3 data-id="heading-6">第二坑：EventLoop 的执行顺序冲突</h3>
<p>当我意识到闭包问题，给 <em>useImperativeHandle</em> 加上 <code>[currentTRD, tid]</code> 依赖后，新的问题又出现了：Modal 场景下tableRef.current拿不到，reload方法执行失败。</p>
<p><strong>这就涉及到两个关键因素：</strong></p>
<ul>
<li><code>Modal</code> 的 <em>destroyOnClose</em> 属性：关闭后组件卸载，重新打开时需要重新渲染，tableRef的赋值时机晚于reloadTable的调用；</li>
<li><strong>事件循环机制</strong>：useGetWarehouseBeta 内部用 <code>setTimeout（宏任务）</code>处理回调，而loadTable的 500ms 延迟也是宏任务，两者执行顺序冲突，导致preRequestRef.current没及时更新，reload方法一直处于 <em>pending</em> 状态。 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf56d93a5d354c15a3e2503c368c47e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyb2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766541066&amp;x-signature=3yr2WGs9sbtYfqf8oB7TacMyRa0%3D" alt="upload_6yoemm9fma17ifbe5whklm5bm0n9zaby.png" loading="lazy"/></li>
</ul>
<p>简单说：setState（打开 Modal）是类似微任务的异步操作，组件渲染完成的时机晚于 reloadTable 的调用，此时 <code>tableRef.current</code> 还没被赋值，自然执行不了 reload。</p>
<p><strong>之前为什么原来能触发呢？</strong> 原来的 <code>useImperativeHandle</code> 是没有依赖项的，众所周知没有依赖项，那就不存在闭包问题，内部状态更新，ref 就跟着更新，外加上 loadTable 500ms 的延迟所有的 ref 都能正常获取。</p>
<blockquote>
<p>shit on shit！！</p>
</blockquote>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bc581276356429b8f3488b7b58b9d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2lyb2k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766541066&amp;x-signature=C%2BCkvlU4H5kDe1pZsGN%2F8V4wUHA%3D" alt="upload_dua7lw5qs2eax5zqm7a0g0jb8i5reetn.png" loading="lazy"/></p>
<h2 data-id="heading-7">最终解决</h2>
<ol>
<li><strong>补全依赖项，解决闭包问题</strong></li>
<li><strong>0ms 延迟宏任务，保证 tableRef 可访问</strong> 利用 EventLoop 的特性：<code>setTimeout(fn, 0)</code> 会把回调推入下一轮宏任务队列，此时 React 已经完成组件渲染，<code>tableRef.current</code> 已经被正确赋值，就能正常执行 <code>reload</code> 方法.</li>
</ol>
<p>最终优化后的代码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">originRef</span>: tableRef.<span class="hljs-property">current</span>,
    <span class="hljs-attr">reloadTable</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isNil</span>(currentTRD)) {
        <span class="hljs-comment">// 字典未加载：缓存回调，等待字典加载后执行</span>
        preRequestRef.<span class="hljs-property">current</span>.<span class="hljs-property">callback</span> = <span class="hljs-keyword">async</span> (...res) =&gt; {
          <span class="hljs-keyword">return</span> tableRef.<span class="hljs-property">current</span>?.<span class="hljs-property">reload</span>?.();
        };
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          preRequestRef.<span class="hljs-property">current</span>.<span class="hljs-property">res</span> = res;
        });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 字典已加载：用0ms延迟保证tableRef能拿到最新实例</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          tableRef.<span class="hljs-property">current</span>?.<span class="hljs-property">reload</span>?.();
        }, <span class="hljs-number">0</span>);
      }
    },
    <span class="hljs-comment">// 其他暴露方法...</span>
  };
}, [currentTRD, tid]); <span class="hljs-comment">// 补全依赖项，解决闭包问题</span>
</code></pre>
<p>后经测试大哥回归验证，两个页面的场景目前都表现正常， <strong>"问题完美解决🎉"</strong> ，如果后续这个组件还有新的坑，再分享！下课！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android App 换肤原理：用 "装修小房子" 故事浅谈]]></title>    <link>https://juejin.cn/post/7584353612501073961</link>    <guid>https://juejin.cn/post/7584353612501073961</guid>    <pubDate>2025-12-17T01:39:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584353612501073961" data-draft-id="7584357116433973289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android App 换肤原理：用 &quot;装修小房子&quot; 故事浅谈"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-17T01:39:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android童话镇"/> <meta itemprop="url" content="https://juejin.cn/user/2716247406161241"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android App 换肤原理：用 "装修小房子" 故事浅谈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2716247406161241/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android童话镇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:39:42.000Z" title="Wed Dec 17 2025 01:39:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用「给 App 小房子换装修」的故事，结合代码 + 时序图，把换肤原理拆得明明白白 —— 全程无晦涩术语！</p>
<h2 data-id="heading-0">一、先讲个小故事：小白的 "暖心小屋" 换肤记</h2>
<p>小白做了个叫「暖心小屋」的 App（像一间小房子），初始装修是「白天模式」：白墙（<code>bg_main=#FFFFFF</code>）、黑字（<code>text_main=#000000</code>）。但用户吐槽：</p>
<ul>
<li>晚上看太刺眼，想要「暗黑模式」（黑墙白字）；</li>
<li>圣诞节想要「喜庆模式」（红墙绿字）。</li>
</ul>
<p>小白犯难了：总不能为每种风格重做一个 App 吧？我告诉他：<strong>换肤≠重建房子，只是换软装（墙漆、窗帘、沙发）—— 这些软装就是 Android 里的「资源」（颜色、图片、字体），换肤本质是「替换资源加载来源」</strong>。</p>
<h3 data-id="heading-1">故事里的核心对应关系（记牢！）</h3>



































<table><thead><tr><th>现实装修</th><th>Android 概念</th><th>作用</th></tr></thead><tbody><tr><td>房子</td><td>App</td><td>整体框架（代码逻辑）</td></tr><tr><td>软装清单</td><td>R 文件</td><td>记录每个软装的唯一编号（比如<code>R.color.bg_main</code>对应墙漆）</td></tr><tr><td>软装仓库</td><td>Resources</td><td>存放所有软装（根据 R 编号能拿到具体的颜色 / 图片）</td></tr><tr><td>新软装包</td><td>皮肤 Apk</td><td>只装「要替换的软装」的小包（无代码，资源名和主 App 一致）</td></tr><tr><td>搬运工</td><td>AssetManager</td><td>把新软装包搬进房子的工具（默认只搬主 App 的软装）</td></tr></tbody></table>
<h2 data-id="heading-2">二、核心原理拆解：3 步搞定换肤</h2>
<p>换肤的本质是「替换资源加载的来源」—— 从「主 App 仓库」换成「皮肤包仓库」，核心分 3 步：</p>
<ol>
<li>制作皮肤包（只放要替换的新软装）；</li>
<li>加载皮肤包（让搬运工找到新软装，兼容高版本 Android）；</li>
<li>刷新界面（把旧软装换成新的，兼顾性能）。</li>
</ol>
<h2 data-id="heading-3">三、代码实操：手把手写一个「能落地」的简易换肤框架</h2>
<h3 data-id="heading-4">前置准备</h3>
<ol>
<li><strong>权限申请</strong>（AndroidManifest.xml）：适配不同 Android 版本的存储权限</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 基础读存储权限（Android 6.0+需动态申请） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span> 
    <span class="hljs-attr">android:maxSdkVersion</span>=<span class="hljs-string">"29"</span> /&gt;</span> <span class="hljs-comment">&lt;!-- Android 11+用分区存储，不再需要此权限 --&gt;</span>
<span class="hljs-comment">&lt;!-- Android 13+ 读取下载目录资源需加 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_MEDIA_IMAGES"</span> 
    <span class="hljs-attr">android:minSdkVersion</span>=<span class="hljs-string">"33"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">application</span> 
    <span class="hljs-attr">android:requestLegacyExternalStorage</span>=<span class="hljs-string">"true"</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">Android</span> <span class="hljs-attr">10</span> <span class="hljs-attr">过渡适配</span> <span class="hljs-attr">--</span>&gt;</span>
    ...&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<ol start="2">
<li>
<p><strong>制作皮肤包（关键优化：只放「要替换的资源」）</strong> ：新建空 Android 项目（删除 java/kotlin 代码，只留 res 目录），<strong>仅放入需要覆盖的资源</strong>（主 App 有 10 个资源，皮肤包只放要改的 2 个，减少体积）：</p>
<ul>
<li>
<p>目录结构（重点：资源名和主 App 完全一致）：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">skin_night.apk/
└── res/
    └── values/
        └── colors.xml  &lt;!-- 只放要替换的颜色，不用重写所有 --&gt;
</code></pre>
</li>
<li>
<p><code>res/values/colors.xml</code>（暗黑模式）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 只覆盖主App的bg_main和text_main，其他资源用主App默认 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bg_main"</span>&gt;</span>#000000<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span> <span class="hljs-comment">&lt;!-- 黑墙（替换主App的白墙） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">color</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"text_main"</span>&gt;</span>#FFFFFF<span class="hljs-tag">&lt;/<span class="hljs-name">color</span>&gt;</span> <span class="hljs-comment">&lt;!-- 白字（替换主App的黑字） --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
</li>
<li>
<p>编译成 Apk，放到手机「应用私有下载目录」（而非根目录，适配 Android 11+）。</p>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">核心 1：SkinManager（换肤管理器，加性能缓存 + 高版本兼容）</h3>
<p>这是「软装调度中心」，新增<strong>资源 ID 缓存</strong>（避免重复调用<code>getIdentifier</code>），修正<code>AssetManager</code>创建方式（兼容 Android 8.0+）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkinManager</span> {
    <span class="hljs-comment">// 单例：全局只有一个调度中心</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SkinManager sInstance;
    <span class="hljs-keyword">private</span> Resources mAppResources; <span class="hljs-comment">// 主App的默认资源仓库</span>
    <span class="hljs-keyword">private</span> Resources mSkinResources; <span class="hljs-comment">// 皮肤包的资源仓库</span>
    <span class="hljs-keyword">private</span> String mSkinPackageName; <span class="hljs-comment">// 皮肤包的包名（找资源用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isDefaultSkin</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 是否用默认皮肤</span>
    
    <span class="hljs-comment">// 新增：资源ID缓存（key：主App资源名+类型，value：皮肤包资源ID）</span>
    <span class="hljs-comment">// 比如"bg_main+color" → 皮肤包中bg_main的资源ID，避免重复查</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Integer&gt; mSkinResIdCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 初始化：传入主App的Context，拿到默认资源仓库</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">SkinManager</span><span class="hljs-params">(Context context)</span> {
        mAppResources = context.getApplicationContext().getResources();
    }

    <span class="hljs-comment">// 获取单例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SkinManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-keyword">if</span> (sInstance == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (SkinManager.class) {
                sInstance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkinManager</span>(context);
            }
        }
        <span class="hljs-keyword">return</span> sInstance;
    }

    <span class="hljs-comment">/**
     * 加载皮肤包（核心优化：兼容Android 8.0+，用应用私有路径）
     * <span class="hljs-doctag">@param</span> skinPath 皮肤包路径（如：/storage/emulated/0/Android/data/包名/files/Download/skin_night.apk）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadSkin</span><span class="hljs-params">(String skinPath)</span> {
        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(skinPath) || !<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(skinPath).exists()) {
            resetSkin(); <span class="hljs-comment">// 路径为空/文件不存在，回退默认皮肤</span>
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 优化1：兼容Android 8.0+（AssetManager构造函数私有，用context.getAssets()获取实例）</span>
            <span class="hljs-type">AssetManager</span> <span class="hljs-variable">assetManager</span> <span class="hljs-operator">=</span> mAppResources.getAssets(); <span class="hljs-comment">// 代替AssetManager.class.newInstance()</span>
            <span class="hljs-comment">// 反射调用隐藏方法addAssetPath：让AssetManager"认识"皮肤包路径</span>
            <span class="hljs-type">Method</span> <span class="hljs-variable">addAssetPathMethod</span> <span class="hljs-operator">=</span> AssetManager.class.getMethod(<span class="hljs-string">"addAssetPath"</span>, String.class);
            addAssetPathMethod.setAccessible(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 允许调用隐藏方法</span>
            addAssetPathMethod.invoke(assetManager, skinPath);

            <span class="hljs-comment">// 用搬运工创建「皮肤资源仓库」（和主App适配屏幕/语言）</span>
            <span class="hljs-type">DisplayMetrics</span> <span class="hljs-variable">metrics</span> <span class="hljs-operator">=</span> mAppResources.getDisplayMetrics();
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> mAppResources.getConfiguration();
            mSkinResources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Resources</span>(assetManager, metrics, config);

            <span class="hljs-comment">// 获取皮肤包的包名（从Apk文件解析）</span>
            <span class="hljs-type">PackageManager</span> <span class="hljs-variable">pm</span> <span class="hljs-operator">=</span> mAppResources.getPackageManager();
            <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span> pm.getPackageArchiveInfo(skinPath, PackageManager.GET_ACTIVITIES);
            mSkinPackageName = packageInfo.packageName;

            <span class="hljs-comment">// 优化2：加载新皮肤时清空旧缓存</span>
            mSkinResIdCache.clear();
            isDefaultSkin = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 标记：用皮肤包</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            resetSkin(); <span class="hljs-comment">// 加载失败，回退默认</span>
            e.printStackTrace();
        }
    }

    <span class="hljs-comment">// 重置为默认皮肤</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resetSkin</span><span class="hljs-params">()</span> {
        isDefaultSkin = <span class="hljs-literal">true</span>;
        mSkinResources = <span class="hljs-literal">null</span>;
        mSkinPackageName = <span class="hljs-literal">null</span>;
        mSkinResIdCache.clear(); <span class="hljs-comment">// 清空缓存</span>
    }

    <span class="hljs-comment">/**
     * 从皮肤包拿颜色资源（优化：先查缓存，再查皮肤包，最后用默认）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getColor</span><span class="hljs-params">(<span class="hljs-type">int</span> resId)</span> {
        <span class="hljs-keyword">if</span> (isDefaultSkin || mSkinResources == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> mAppResources.getColor(resId, <span class="hljs-literal">null</span>); <span class="hljs-comment">// 适配Android 6.0+的主题</span>
        }

        <span class="hljs-comment">// 1. 生成缓存Key（主App资源名+类型，比如"bg_main+color"）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">resName</span> <span class="hljs-operator">=</span> mAppResources.getResourceEntryName(resId); <span class="hljs-comment">// 资源名：bg_main</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">resType</span> <span class="hljs-operator">=</span> mAppResources.getResourceTypeName(resId); <span class="hljs-comment">// 资源类型：color</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> resName + <span class="hljs-string">"+"</span> + resType;

        <span class="hljs-comment">// 2. 先查缓存：有就直接用，避免重复调用getIdentifier（性能优化）</span>
        <span class="hljs-keyword">if</span> (mSkinResIdCache.containsKey(cacheKey)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">skinResId</span> <span class="hljs-operator">=</span> mSkinResIdCache.get(cacheKey);
            <span class="hljs-keyword">return</span> skinResId == <span class="hljs-number">0</span> ? mAppResources.getColor(resId, <span class="hljs-literal">null</span>) : mSkinResources.getColor(skinResId, <span class="hljs-literal">null</span>);
        }

        <span class="hljs-comment">// 3. 查皮肤包：获取皮肤包中的资源ID</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">skinResId</span> <span class="hljs-operator">=</span> mSkinResources.getIdentifier(resName, resType, mSkinPackageName);
        mSkinResIdCache.put(cacheKey, skinResId); <span class="hljs-comment">// 存入缓存，下次复用</span>

        <span class="hljs-comment">// 4. 皮肤包没有就用主App默认</span>
        <span class="hljs-keyword">return</span> skinResId == <span class="hljs-number">0</span> ? mAppResources.getColor(resId, <span class="hljs-literal">null</span>) : mSkinResources.getColor(skinResId, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * 从皮肤包拿图片资源（同理，加缓存）
     */</span>
    <span class="hljs-keyword">public</span> Drawable <span class="hljs-title function_">getDrawable</span><span class="hljs-params">(<span class="hljs-type">int</span> resId)</span> {
        <span class="hljs-keyword">if</span> (isDefaultSkin || mSkinResources == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> mAppResources.getDrawable(resId, <span class="hljs-literal">null</span>);
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">resName</span> <span class="hljs-operator">=</span> mAppResources.getResourceEntryName(resId);
        <span class="hljs-type">String</span> <span class="hljs-variable">resType</span> <span class="hljs-operator">=</span> mAppResources.getResourceTypeName(resId);
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> resName + <span class="hljs-string">"+"</span> + resType;

        <span class="hljs-keyword">if</span> (mSkinResIdCache.containsKey(cacheKey)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">skinResId</span> <span class="hljs-operator">=</span> mSkinResIdCache.get(cacheKey);
            <span class="hljs-keyword">return</span> skinResId == <span class="hljs-number">0</span> ? mAppResources.getDrawable(resId, <span class="hljs-literal">null</span>) : mSkinResources.getDrawable(skinResId, <span class="hljs-literal">null</span>);
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">skinResId</span> <span class="hljs-operator">=</span> mSkinResources.getIdentifier(resName, resType, mSkinPackageName);
        mSkinResIdCache.put(cacheKey, skinResId);

        <span class="hljs-keyword">return</span> skinResId == <span class="hljs-number">0</span> ? mAppResources.getDrawable(resId, <span class="hljs-literal">null</span>) : mSkinResources.getDrawable(skinResId, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">// 恢复默认皮肤（对外暴露）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">restoreDefault</span><span class="hljs-params">()</span> {
        resetSkin();
    }
}
</code></pre>
<h3 data-id="heading-6">核心 2：BaseSkinActivity（优化 Factory2 时机 + 支持更多属性）</h3>
<p>修正<code>Factory2</code>设置时机（必须在<code>super.onCreate()</code>之前，否则被系统覆盖），新增对<code>src</code>（图片）属性的支持，更贴近实际需求。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseSkinActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-comment">// 存储需要换肤的View和对应的资源ID（比如TextView的textColor、ImageView的src）</span>
    <span class="hljs-keyword">private</span> List&lt;SkinView&gt; mSkinViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 封装：View + 要换的属性（background/textColor/src）+ 资源ID</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkinView</span> {
        View view;
        Map&lt;String, Integer&gt; attrMap; <span class="hljs-comment">// key:属性名，value:资源ID</span>
        SkinView(View view, Map&lt;String, Integer&gt; attrMap) {
            <span class="hljs-built_in">this</span>.view = view;
            <span class="hljs-built_in">this</span>.attrMap = attrMap;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-comment">// 优化：Factory2必须在super.onCreate()之前设置！</span>
        <span class="hljs-comment">// 原因：AppCompatActivity的onCreate会初始化LayoutInflater，之后设会被系统覆盖</span>
        setupLayoutInflaterFactory();
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    }

    <span class="hljs-comment">// 抽取Factory2设置逻辑，更清晰</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setupLayoutInflaterFactory</span><span class="hljs-params">()</span> {
        LayoutInflaterCompat.setFactory2(getLayoutInflater(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">LayoutInflater</span>.Factory2() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> {
                <span class="hljs-comment">// 1. 让系统先创建View（保证TextView、ImageView等原生View正常创建）</span>
                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> getDelegate().createView(parent, name, context, attrs);
                <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 兼容不带前缀的View（如"TextView"而非"android.widget.TextView"）</span>
                    <span class="hljs-keyword">try</span> {
                        view = LayoutInflater.from(context).createView(name, <span class="hljs-string">"android.widget."</span>, attrs);
                    } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {
                        e.printStackTrace();
                    }
                }
                
                <span class="hljs-comment">// 2. 解析View的属性，记录需要换肤的资源（新增src属性支持）</span>
                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
                    parseViewAttr(view, attrs);
                }
                <span class="hljs-keyword">return</span> view;
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span> {
                <span class="hljs-keyword">return</span> onCreateView(<span class="hljs-literal">null</span>, name, context, attrs);
            }
        });
    }

    <span class="hljs-comment">/**
     * 解析View属性：找出需要换肤的属性（background/textColor/src）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseViewAttr</span><span class="hljs-params">(View view, AttributeSet attrs)</span> {
        Map&lt;String, Integer&gt; attrMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-comment">// 遍历View的所有属性</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; attrs.getAttributeCount(); i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">attrName</span> <span class="hljs-operator">=</span> attrs.getAttributeName(i); <span class="hljs-comment">// 属性名：background/textColor/src</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">attrValue</span> <span class="hljs-operator">=</span> attrs.getAttributeValue(i); <span class="hljs-comment">// 属性值：@2131234567（资源ID）</span>
            
            <span class="hljs-comment">// 只处理「引用资源」的属性（以@开头，排除"#FFFFFF"这种直接写的颜色）</span>
            <span class="hljs-keyword">if</span> (attrValue != <span class="hljs-literal">null</span> &amp;&amp; attrValue.startsWith(<span class="hljs-string">"@"</span>)) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">int</span> <span class="hljs-variable">resId</span> <span class="hljs-operator">=</span> Integer.parseInt(attrValue.substring(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 转成资源ID</span>
                    <span class="hljs-comment">// 记录需要换肤的属性（新增src，支持ImageView换图）</span>
                    <span class="hljs-keyword">if</span> (attrName.equals(<span class="hljs-string">"background"</span>) 
                            || attrName.equals(<span class="hljs-string">"textColor"</span>) 
                            || attrName.equals(<span class="hljs-string">"src"</span>)) {
                        attrMap.put(attrName, resId);
                    }
                } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
                    e.printStackTrace();
                }
            }
        }
        <span class="hljs-comment">// 把需要换肤的View加入列表（避免空映射浪费内存）</span>
        <span class="hljs-keyword">if</span> (!attrMap.isEmpty()) {
            mSkinViews.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SkinView</span>(view, attrMap));
        }
    }

    <span class="hljs-comment">/**
     * 刷新皮肤：把新资源设置到View上（支持src属性）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshSkin</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (SkinView skinView : mSkinViews) {
            <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> skinView.view;
            Map&lt;String, Integer&gt; attrMap = skinView.attrMap;
            
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : attrMap.entrySet()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">attrName</span> <span class="hljs-operator">=</span> entry.getKey();
                <span class="hljs-type">int</span> <span class="hljs-variable">resId</span> <span class="hljs-operator">=</span> entry.getValue();
                
                <span class="hljs-keyword">switch</span> (attrName) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"background"</span>:
                        <span class="hljs-comment">// 替换背景（兼容颜色和图片）</span>
                        <span class="hljs-type">Drawable</span> <span class="hljs-variable">drawable</span> <span class="hljs-operator">=</span> SkinManager.getInstance(<span class="hljs-built_in">this</span>).getDrawable(resId);
                        view.setBackground(drawable);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"textColor"</span>:
                        <span class="hljs-comment">// 替换文字颜色</span>
                        <span class="hljs-type">int</span> <span class="hljs-variable">color</span> <span class="hljs-operator">=</span> SkinManager.getInstance(<span class="hljs-built_in">this</span>).getColor(resId);
                        ((TextView) view).setTextColor(color);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"src"</span>:
                        <span class="hljs-comment">// 新增：替换ImageView的图片</span>
                        <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> ImageView) {
                            <span class="hljs-type">Drawable</span> <span class="hljs-variable">srcDrawable</span> <span class="hljs-operator">=</span> SkinManager.getInstance(<span class="hljs-built_in">this</span>).getDrawable(resId);
                            ((ImageView) view).setImageDrawable(srcDrawable);
                        }
                        <span class="hljs-keyword">break</span>;
                }
            }
        }
    }

    <span class="hljs-comment">// 对外提供换肤方法（新增：建议在子线程加载，避免卡界面）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">changeSkin</span><span class="hljs-params">(String skinPath)</span> {
        <span class="hljs-comment">// 优化：皮肤包可能较大（如含图片），子线程加载，主线程刷新</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            SkinManager.getInstance(<span class="hljs-built_in">this</span>).loadSkin(skinPath);
            <span class="hljs-comment">// 刷新界面必须在主线程</span>
            runOnUiThread(<span class="hljs-built_in">this</span>::refreshSkin);
        }).start();
    }
}
</code></pre>
<h3 data-id="heading-7">核心 3：使用示例（MainActivity，适配 Android 11 + 存储路径）</h3>
<p>不再用外部存储根目录，改用「应用私有下载目录」（Android 11 + 无需申请额外权限，安全合规）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseSkinActivity</span> {
    <span class="hljs-comment">// 皮肤包在应用私有目录的路径（如：/Android/data/你的包名/files/Download/skin_night.apk）</span>
    <span class="hljs-keyword">private</span> String mSkinPath;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-comment">// 1. 初始化皮肤包路径（应用私有下载目录，Android 11+可直接访问）</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">skinFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getExternalFilesDir(Environment.DIRECTORY_DOWNLOADS), <span class="hljs-string">"skin_night.apk"</span>);
        mSkinPath = skinFile.getAbsolutePath();

        <span class="hljs-comment">// 2. 切换夜间皮肤（先检查文件是否存在）</span>
        findViewById(R.id.btn_change_skin).setOnClickListener(v -&gt; {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(mSkinPath).exists()) {
                changeSkin(mSkinPath); <span class="hljs-comment">// 调用Base的换肤方法（子线程加载）</span>
            } <span class="hljs-keyword">else</span> {
                Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">"皮肤包不存在，请先放到下载目录"</span>, Toast.LENGTH_SHORT).show();
            }
        });

        <span class="hljs-comment">// 3. 恢复默认皮肤</span>
        findViewById(R.id.btn_restore_skin).setOnClickListener(v -&gt; {
            SkinManager.getInstance(<span class="hljs-built_in">this</span>).restoreDefault();
            refreshSkin(); <span class="hljs-comment">// 主线程刷新</span>
        });
    }
}
</code></pre>
<h3 data-id="heading-8">布局文件（activity_main.xml，新增 ImageView 测试 src 换肤）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/bg_main"</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">要换肤的背景</span> <span class="hljs-attr">--</span>&gt;</span>
    android:orientation="vertical"
    android:padding="20dp"&gt;

    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"暖心小屋"</span>
        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/text_main"</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">要换肤的文字颜色</span> <span class="hljs-attr">--</span>&gt;</span>
        android:textSize="24sp" /&gt;

    <span class="hljs-comment">&lt;!-- 新增：测试src换肤的ImageView --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"100dp"</span>
        <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/ic_home"</span> &lt;!<span class="hljs-attr">--</span> <span class="hljs-attr">要换肤的图片</span>（<span class="hljs-attr">皮肤包需同名</span>） <span class="hljs-attr">--</span>&gt;</span>
        android:layout_margin="20dp" /&gt;

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_change_skin"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"切换夜间模式"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/btn_restore_skin"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"恢复默认皮肤"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">四、时序图</h2>
<p>用时序图展示「实际项目中」的换肤流程（子线程加载皮肤包，主线程刷新，缓存复用）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b29c7f0a31214adabd19b4517f3dbaa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOerpeivnemVhw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766540381&amp;x-signature=PJ9ZRCpjolHXz4pG4%2Fu5sE8cd7o%3D" alt="换肤流程.png" loading="lazy"/></p>
<p>需要换肤的View（TextView/ImageView）皮肤Resources皮肤包(SkinApk)AssetManager（兼容高版本）SkinManager（带缓存）子线程（加载皮肤）MainActivity用户需要换肤的View（TextView/ImageView）皮肤Resources皮肤包(SkinApk)AssetManager（兼容高版本）SkinManager（带缓存）子线程（加载皮肤）MainActivity用户1. 用getAssets()创建AssetManager（兼容8.0+）2. 创建皮肤Resources，清空旧缓存先查缓存→有则直接返回无则查皮肤包+存缓存loop[遍历所有需要换肤的View]点击「切换夜间模式」启动子线程加载皮肤包loadSkin(skinPath)反射调用addAssetPath(skinPath)读取皮肤包资源（仅覆盖的资源）资源路径添加成功new Resources(AssetManager, metrics, config)皮肤Resources创建完成皮肤包加载完成发送主线程刷新信号主线程调用refreshSkin()getColor(resId)/getDrawable(resId)getColor(skinResId)（缓存命中则跳过）返回暗黑模式颜色值返回新资源值设置background/textColor/src资源设置完成界面刷新为夜间模式（无卡顿）</p>
<h2 data-id="heading-10">五、实际项目必看：优化与兼容性</h2>
<h3 data-id="heading-11">1. 性能优化（避免 App 卡顿）</h3>
<ul>
<li><strong>资源缓存</strong>：如 SkinManager 中的<code>mSkinResIdCache</code>，减少<code>getIdentifier</code>调用（该方法需遍历资源表，耗时）；</li>
<li><strong>异步加载</strong>：皮肤包（尤其含图片）放在子线程加载，避免阻塞主线程（如 BaseSkinActivity 的<code>changeSkin</code>方法）；</li>
<li><strong>按需刷新</strong>：只记录需要换肤的 View（如背景 / 文字颜色），而非所有 View，减少刷新耗时。</li>
</ul>
<h3 data-id="heading-12">2. 兼容性处理（覆盖更多场景）</h3>
<ul>
<li>
<p><strong>多属性支持</strong>：除了<code>background/textColor/src</code>，还可扩展<code>drawableLeft</code>（按钮左侧图标）、<code>hintTextColor</code>（输入框提示颜色）等；</p>
</li>
<li>
<p><strong>自定义 View 换肤</strong>：给自定义 View 加「换肤接口」，如<code>ISkinable</code>，在<code>refreshSkin</code>时调用接口方法，示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义View的换肤接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISkinable</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSkinChanged</span><span class="hljs-params">()</span>;
}
<span class="hljs-comment">// 自定义View实现接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCustomView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ISkinable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSkinChanged</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 自定义View的换肤逻辑（如替换自定义属性）</span>
        setMyCustomColor(SkinManager.getInstance(getContext()).getColor(R.color.my_custom_color));
    }
}
<span class="hljs-comment">// BaseSkinActivity中添加自定义View刷新</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseViewAttr</span><span class="hljs-params">(View view, AttributeSet attrs)</span> {
    <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> ISkinable) {
        mSkinableViews.add((ISkinable) view); <span class="hljs-comment">// 单独记录自定义View</span>
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refreshSkin</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 刷新自定义View</span>
    <span class="hljs-keyword">for</span> (ISkinable skinable : mSkinableViews) {
        skinable.onSkinChanged();
    }
}
</code></pre>
</li>
<li>
<p><strong>状态选择器换肤</strong>：如<code>selector</code>（按钮按压 / 正常状态颜色），皮肤包需放同名的<code>selector.xml</code>，且内部引用的颜色也用皮肤包资源。</p>
</li>
</ul>
<h3 data-id="heading-13">3. 工程化设计（让框架可维护）</h3>
<p>实际项目中，建议用「接口 + 实现」的方式解耦，方便扩展，示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 皮肤加载接口（定义能力）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISkinLoader</span> {
    <span class="hljs-comment">// 加载皮肤，带回调（成功/失败）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadSkin</span><span class="hljs-params">(String skinPath, OnSkinLoadListener listener)</span>;
    <span class="hljs-comment">// 恢复默认皮肤</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">restoreDefault</span><span class="hljs-params">()</span>;
    <span class="hljs-comment">// 注册换肤观察者（如Activity/Fragment）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerObserver</span><span class="hljs-params">(ISkinObserver observer)</span>;
    <span class="hljs-comment">// 取消注册（避免内存泄漏）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unregisterObserver</span><span class="hljs-params">(ISkinObserver observer)</span>;
}

<span class="hljs-comment">// 换肤观察者（Activity/Fragment实现，接收换肤通知）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISkinObserver</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSkinChanged</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 皮肤变化时回调</span>
}
</code></pre>
<h2 data-id="heading-14">六、避坑指南</h2>



































<table><thead><tr><th>坑点</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>Android 8.0 + 加载皮肤包失败</td><td>AssetManager 构造函数私有，<code>newInstance()</code>抛异常</td><td>改用<code>context.getAssets()</code>获取 AssetManager 实例</td></tr><tr><td>Android 11 + 读不到皮肤包</td><td>分区存储（Scoped Storage）限制，无法访问外部存储根目录</td><td>把皮肤包放到「应用私有目录」（如<code>getExternalFilesDir</code>），无需额外权限</td></tr><tr><td>Factory2 设置后不生效</td><td>设置时机在<code>super.onCreate()</code>之后，被系统覆盖</td><td>必须在<code>super.onCreate(savedInstanceState)</code>之前调用<code>LayoutInflaterCompat.setFactory2</code></td></tr><tr><td>换肤后部分 View 没刷新</td><td>没记录需要换肤的属性（如 src），或自定义 View 没处理</td><td>扩展<code>parseViewAttr</code>的属性列表，给自定义 View 加换肤接口</td></tr><tr><td>换肤时 App 卡顿</td><td>主线程加载皮肤包，或频繁调用<code>getIdentifier</code></td><td>子线程加载皮肤包，加资源 ID 缓存</td></tr></tbody></table>
<h2 data-id="heading-15">七、核心总结（划重点！）</h2>
<ol>
<li>
<p><strong>本质不变</strong>：换肤 = 替换资源加载来源（从主 App Resources→皮肤包 Resources）；</p>
</li>
<li>
<p><strong>关键优化</strong>：</p>
<ul>
<li>皮肤包只放「要替换的资源」，减少体积；</li>
<li>AssetManager 用<code>getAssets()</code>创建，兼容 Android 8.0+；</li>
<li>资源 ID 缓存，避免重复查；</li>
<li>子线程加载 + 主线程刷新，不卡顿；</li>
<li>用应用私有目录，适配 Android 11 + 分区存储。</li>
</ul>
</li>
<li>
<p><strong>实际项目</strong>：需考虑性能、兼容性、工程化解耦，成熟框架（如 MagicaSakura、Android-Skin-Loader）都是基于这些核心优化扩展的。</p>
</li>
</ol>
<p>最后再用一句话总结：<strong>App 换肤就像给房子换软装 —— 只带要换的新软装（皮肤包只放覆盖资源），用兼容的搬运工（适配的 AssetManager），提前记好软装编号（资源缓存），不打扰主人休息（子线程加载），最后快速换好（按需刷新）！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何防防防之防抓包伪造请求]]></title>    <link>https://juejin.cn/post/7584320417307017267</link>    <guid>https://juejin.cn/post/7584320417307017267</guid>    <pubDate>2025-12-16T23:14:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417307017267" data-draft-id="7584279552433782822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何防防防之防抓包伪造请求"/> <meta itemprop="keywords" content="Android,安全"/> <meta itemprop="datePublished" content="2025-12-16T23:14:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dora"/> <meta itemprop="url" content="https://juejin.cn/user/2656895088205453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何防防防之防抓包伪造请求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2656895088205453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dora
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T23:14:26.000Z" title="Tue Dec 16 2025 23:14:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>通常，我们讨论的话题都是如何写出强大的功能。</p>
<p>但今天，咱们换个视角，聊点不一样的——<br/>
<strong>应用安全：防防防，反反反。</strong></p>
<p><strong>防，不是防用户，而是防“逆向视角下的你自己”。</strong></p>
<p>当攻击者拿到你的 APK / IPA / 可执行文件时，<br/>
TA 不关心你的业务多优雅、架构多清晰，<br/>
TA 只关心三件事：</p>
<ul>
<li>能不能看懂</li>
<li>能不能改</li>
<li>能不能利用，搞钱</li>
</ul>
<p>所谓“防”，本质上就是：<br/>
<strong>让逆向工程变得更慢、更贵、更不确定。</strong></p>
</blockquote>
<p>防静态分析、防动态注入、防抓包、防内存Dump、防SO替换、防Inline Hook、防PLT/GOT劫持、防Java Hook、防Native Hook、防Xposed、防Substrate、防Frida、防Magisk模块、防VirtualXposed、防LSPosed、反调试、反单步、反附加、反Trace、反调试器伪装、反ROOT、 反解锁、反系统篡改、反环境伪造、防重打包、防二次签名、防资源替换、防DEX注入、防脚本、 防自动化、防模拟器、防云手机、防小三，没有啦，后面这个是我刻意搞怪😏加上去的。</p>
<h4 data-id="heading-0">RSA + AES 加密</h4>
<p>防逆向工程的第一步，往往不是混淆、不是反调试，而是<strong>加密</strong>。<br/>
因为只要数据是明文，所有防护最终都会变成“延迟被看懂的时间”。</p>
<p>在密码学的江湖里，最常被拎出来的两位老前辈，非 <strong>RSA 非对称加密</strong> 和 <strong>AES 对称加密</strong> 莫属。<br/>
一个安全、稳重、名门正派，但出手慢；<br/>
一个手快、效率高、杀伤力强，但最大的软肋就是——<strong>密钥怎么安全地交出去</strong>。</p>
<p>所以现实世界里，从来不是二选一。<br/>
<strong>小孩子才做选择，而你，全都要。</strong></p>
<p>你不慌不忙，先在客户端本地生成了一把随机的 <strong>AES Key</strong>。<br/>
这把 key 很短命，只服务当前这一次通信，用完就丢，连自己都不打算再认。<br/>
你用它把真正的业务数据——资源、配置、秘密、惊喜——统统加密成一坨谁也看不懂的密文。</p>
<p>但你心里很清楚：<br/>
<strong>AES 再快，也怕 key 泄露。</strong><br/>
于是你转身请出了 RSA。</p>
<p>你拿起对象早就公开在客户端里的 <strong>RSA 公钥</strong>，<br/>
把刚才那把 AES Key 加密一层。<br/>
现在好了：</p>
<ul>
<li>数据，被 AES 锁住</li>
<li>AES 的钥匙，又被 RSA 锁住</li>
</ul>
<p>双保险。</p>
<p>你把这两样东西——<br/>
<strong>RSA 加密过的 AES Key 和 AES 加密后的密文</strong><br/>
一并发了出去。</p>
<p>此时，无论是抓包、代理、小三、还是半路劫持的人，<br/>
看到的都只是两坨“看不懂，也用不了”的东西。</p>
<p>另一头，你女朋友收到了这份“神秘快递”。<br/>
她当然知道怎么玩这套。</p>
<p>她先拿出自己珍藏、从不外泄的 <strong>RSA 私钥</strong>，<br/>
轻轻一解，<br/>
RSA 的包装就被拆开，真正的 <strong>AES Key</strong> 映入眼帘。</p>
<p>然后，她用这把 key，<br/>
把那段密文慢慢解开。<br/>
数据复原，信息重现，惊喜如约而至。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> site.doramusic.app.http

<span class="hljs-keyword">import</span> dora.util.CryptoUtils
<span class="hljs-keyword">import</span> java.security.SecureRandom

<span class="hljs-keyword">object</span> SecureRequestBuilder {

    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> AES_KEY_LENGTH = <span class="hljs-number">16</span> <span class="hljs-comment">// bytes (128位)</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> RSA_PUBLIC = <span class="hljs-string">""</span>   <span class="hljs-comment">// 等待公钥...</span>

    <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureMode</span> {
        NONE,
        ENC,
        ENC_SIGN
    }

    <span class="hljs-comment">/**
     * 获取随机key。
     */</span>
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRandomKey</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> sb = StringBuilder(AES_KEY_LENGTH)
        <span class="hljs-keyword">val</span> random = SecureRandom()
        repeat(AES_KEY_LENGTH) {
            <span class="hljs-keyword">when</span> (random.nextInt(<span class="hljs-number">3</span>)) {
                <span class="hljs-number">0</span> -&gt; {
                    <span class="hljs-comment">// 0-9</span>
                    sb.append(random.nextInt(<span class="hljs-number">10</span>))
                }
                <span class="hljs-number">1</span> -&gt; {
                    <span class="hljs-comment">// A-Z</span>
                    sb.append((random.nextInt(<span class="hljs-number">26</span>) + <span class="hljs-string">'A'</span>.code).toChar())
                }
                <span class="hljs-number">2</span> -&gt; {
                    <span class="hljs-comment">// a-z</span>
                    sb.append((random.nextInt(<span class="hljs-number">26</span>) + <span class="hljs-string">'a'</span>.code).toChar())
                }
            }
        }
        <span class="hljs-keyword">return</span> sb.toString()
    }

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">(
        req: <span class="hljs-type">BaseReq</span>,
        mode: <span class="hljs-type">SecureMode</span>
    )</span></span>: ReqBody? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (mode) {
            <span class="hljs-comment">// 明文</span>
            SecureMode.NONE -&gt; {
                ReqBody(
                    mode = <span class="hljs-string">"NONE"</span>,
                    <span class="hljs-keyword">data</span> = req.payload
                )
            }
            <span class="hljs-comment">// 端到端加密</span>
            SecureMode.ENC -&gt; {
                <span class="hljs-keyword">val</span> aesKey = getRandomKey()
                ReqBody(
                    mode = <span class="hljs-string">"ENC"</span>,
                    key = CryptoUtils.encryptByPublic(RSA_PUBLIC, aesKey),
                    <span class="hljs-keyword">data</span> = CryptoUtils.encryptAES(aesKey, req.payload)
                )
            }
            <span class="hljs-comment">// 端到端加密 + 客户端签名</span>
            SecureMode.ENC_SIGN -&gt; {
                <span class="hljs-comment">// 不告诉你，这个项目不提供可信客户端能力</span>
                <span class="hljs-literal">null</span>
            }
        }
    }
}
</code></pre>
<p>使用SecureRandom生成完全随机的key。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> site.doramusic.app.http

<span class="hljs-keyword">import</span> com.google.gson.Gson
<span class="hljs-keyword">import</span> dora.util.GlobalContext
<span class="hljs-keyword">import</span> dora.util.LanguageUtils
<span class="hljs-keyword">import</span> java.lang.reflect.Modifier
<span class="hljs-keyword">import</span> java.util.Locale

<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseReq</span> {

    <span class="hljs-comment">/**
     * 根据不同的语种返回本地化的内容。
     */</span>
    <span class="hljs-keyword">var</span> lang: String = <span class="hljs-string">""</span>

    <span class="hljs-comment">/**
     * 数据载体。
     */</span>
    <span class="hljs-keyword">var</span> payload: String = <span class="hljs-string">""</span>

    <span class="hljs-comment">/**
     * 防抓包伪造签名重复请求，签名过期，拒绝请求。
     */</span>
    <span class="hljs-keyword">var</span> timestamp: String = <span class="hljs-string">""</span>

    <span class="hljs-comment">/**
     * 可信客户端签名，ENC_SIGN模式下，签名不正确，拒绝请求。
     */</span>
    <span class="hljs-keyword">var</span> signature: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">init</span> {
        lang = LanguageUtils.getLangTag(GlobalContext.<span class="hljs-keyword">get</span>()).ifEmpty { Locale.getDefault().language }
        timestamp = (System.currentTimeMillis() / <span class="hljs-number">1000</span>).toString()
    }

    <span class="hljs-comment">/**
     * 对数据进行排序，保证唯一性，返回排序后的JSON字符串。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sort</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">val</span> map = sortedMapOf&lt;String, Any?&gt;()
        <span class="hljs-keyword">var</span> clazz: Class&lt;*&gt;? = <span class="hljs-keyword">this</span>.javaClass
        <span class="hljs-keyword">while</span> (clazz != <span class="hljs-literal">null</span> &amp;&amp; clazz != BaseReq::<span class="hljs-keyword">class</span>.java) {
            clazz.declaredFields
                .filter { field -&gt;
                    !field.isSynthetic &amp;&amp;
                            !Modifier.isStatic(field.modifiers)
                }
                .forEach { field -&gt;
                    field.isAccessible = <span class="hljs-literal">true</span>
                    map[field.name] = field[<span class="hljs-keyword">this</span>]
                }
            clazz = clazz.superclass
        }
        <span class="hljs-comment">// 父类字段（显式加入，避免遗漏）</span>
        map[<span class="hljs-string">"lang"</span>] = lang
        map[<span class="hljs-string">"payload"</span>] = payload
        map[<span class="hljs-string">"timestamp"</span>] = timestamp
        <span class="hljs-keyword">return</span> Gson().toJson(map)
    }
}
</code></pre>
<p>大致思路如上，如需查看完整实现与工程细节，可直接进入这个传送门：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdora4%2FDoraMusic" target="_blank" title="https://github.com/dora4/DoraMusic" ref="nofollow noopener noreferrer">github.com/dora4/DoraM…</a>。</p>
<h4 data-id="heading-1">复用</h4>
<p>能提供<strong>无限自由组合的复用能力</strong>，是大工程得以长期演进的基石。<br/>
复用不是复制粘贴，也不是简单封装几个工具类，而是<strong>结构层面的能力释放</strong>。</p>
<p>抽象与提炼的水平，决定了一套工程的成熟度。<br/>
你抽的是“功能”，还是“能力”；<br/>
你复用的是“代码”，还是“模型”；<br/>
这些选择，会在项目规模放大之后，给出完全不同的回报。</p>
<p>当架构设计足够清晰、边界足够稳定时，<br/>
你甚至可以做到——<br/>
<strong>一份后端代码，对接 n 个承载同一品牌理念的 App。</strong></p>
<p>你只需要把真正“通用”的东西抽出来：</p>
<ul>
<li>建议与反馈</li>
<li>FAQ / 帮助中心</li>
<li>App 版本分发与灰度控制</li>
<li>首页横幅广告</li>
<li>首页直播间 / 内容推荐</li>
<li>配置信息与功能开关</li>
<li>系统通知</li>
<li>促销活动</li>
<li>埋点统计与用户行为分析</li>
</ul>
<p>这些模块，只写一次，<br/>
却可以被<strong>全品牌、全产品线、全形态的 App 反复使用</strong>。</p>
<p>而客户端，只负责表现、体验和差异化。<br/>
真正复杂、真正需要稳定演进的部分，<br/>
被牢牢收敛在可控的架构之中。</p>
<p>最终你会发现：<br/>
安全只是起点，<br/>
加密只是手段，<br/>
<strong>架构与复用，才是工程走得远的根本原因。</strong></p>
<blockquote>
<p>工程不是写完一次就结束，<br/>
而是要经得起规模、时间和变化的反复考验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS逆向-哔哩哔哩增加3倍速播放（4）- 竖屏视频·全屏播放场景]]></title>    <link>https://juejin.cn/post/7584340871412531227</link>    <guid>https://juejin.cn/post/7584340871412531227</guid>    <pubDate>2025-12-16T23:49:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584340871412531227" data-draft-id="7584094504631009289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS逆向-哔哩哔哩增加3倍速播放（4）- 竖屏视频·全屏播放场景"/> <meta itemprop="keywords" content="iOS,Swift"/> <meta itemprop="datePublished" content="2025-12-16T23:49:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TouchWorld"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473557143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS逆向-哔哩哔哩增加3倍速播放（4）- 竖屏视频·全屏播放场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473557143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TouchWorld
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T23:49:11.000Z" title="Tue Dec 16 2025 23:49:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e36d3808f834bfe8e04eb7768711c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=Dpg2duP72oWru%2FcbWIj%2FbET4%2Byg%3D" alt="Xnip2025-12-16_11-22-40.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>作为哔哩哔哩的重度用户，我一直期待官方支持 <strong>3 倍速播放</strong>，但该功能迟迟未上线。于是，我利用 <code>iOS</code> 逆向工程知识，为 B 站 App 添加这一功能。</p>
<p><strong>修改前</strong>：最高仅支持 <strong><code>2.0</code></strong> 倍速。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378216715c2f44248c8e2425229c3a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=ucnCpAkX5QA%2F6iqHOrHiX1ueoUo%3D" alt="Screenshot 2025-12-11 at 07.26.05.png" loading="lazy"/></p>
<p><strong>修改后</strong>：成功添加 <strong><code>3.0</code></strong> 倍速选项</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a59b38f386f445e2b309556e3038747b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=cNFHe129Yw0DLX50e7QdOj0pFAs%3D" alt="Screenshot 2025-12-11 at 07.22.57.png" loading="lazy"/></p>
<p>本系列分为多篇，本文聚焦 <strong>竖屏视频·全屏播放</strong> 场景下的 <strong>3 倍速</strong>实现。</p>
<p><strong>系列回顾</strong>：</p>
<ul>
<li>
<p><a href="https://juejin.cn/post/7582063437414285350" target="_blank" title="https://juejin.cn/post/7582063437414285350">iOS逆向-哔哩哔哩增加3倍速（1）-最大播放速度</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7582202149910544393" target="_blank" title="https://juejin.cn/post/7582202149910544393">iOS逆向-哔哩哔哩增加3倍速播放（2）-[横屏视频-半屏播放]增加3倍速播放</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7583910418659409966" target="_blank" title="https://juejin.cn/post/7583910418659409966">iOS逆向-哔哩哔哩增加3倍速播放（3）-[横屏视频-全屏播放]场景</a></p>
</li>
</ul>
<h2 data-id="heading-1">场景说明</h2>
<p>本文分析的具体场景为：<strong>竖屏视频全屏播放</strong>。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f68f33c13e1439fa717b09c4df612cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=6Zpe0tLgx%2FS0hPaACG8bnThdvzQ%3D" alt="499416D4-1488-4417-89CD-E42861795807.png" width="50%" loading="lazy"/>
<h2 data-id="heading-2">开发环境</h2>
<ul>
<li>
<p>哔哩哔哩版本：<code>8.41.0</code></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAloneMonkey%2FMonkeyDev" target="_blank" title="https://github.com/AloneMonkey/MonkeyDev" ref="nofollow noopener noreferrer">MonkeyDev</a></p>
</li>
<li>
<p><code>IDA Professional 9.0</code></p>
</li>
<li>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">安装IDA插件：patching</a></p>
</li>
<li>
<p><code>Lookin</code></p>
</li>
</ul>
<h2 data-id="heading-3">分析</h2>
<h3 data-id="heading-4">1. 播放速度组件定位</h3>
<p>通过 <code>Lookin</code> 分析 UI 层级可以发现，播放速度面板对应的视图组件为：</p>
<pre><code class="hljs">VKSettingView.TabContent
</code></pre>
<p>该组件内部持有一个 <code>VKSettingView.TabModel</code>，用于描述播放速度相关的数据模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e4c6442b278471794a1ec19bacd8cd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=z6ruqxHfU%2Bzlyp8JJ5kgVvZlu5I%3D" alt="157920C7-792E-4FEC-AF23-1AA783CBC33D.png" loading="lazy"/></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Foundation

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VKSettingView</span>.<span class="hljs-title class_">TabContent</span>: <span class="hljs-title class_">VKSettingView</span>.<span class="hljs-title class_">BaseContent</span> {
  <span class="hljs-comment">/* fields */</span>
    <span class="hljs-keyword">var</span> model: <span class="hljs-type">VKSettingView</span>.<span class="hljs-type">TabModel</span> <span class="hljs-operator">?</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">lazy</span> selecter: <span class="hljs-type">VKSettingView</span>.<span class="hljs-type">VKSelectControl</span> <span class="hljs-operator">?</span>
} 
</code></pre>
<h3 data-id="heading-5">2. TabModel 结构分析</h3>
<p>从 <code>Mach-O</code> 中导出的 <code>Swift</code> 文件可以确认，<code>VKSettingView.TabModel</code> 中包含一个 <code>items</code> 属性，其类型为 <code>[String]</code>，极有可能即为 <strong>播放速度数组</strong>。</p>
<p>进一步在 <code>IDA</code> 中查看该类的方法实现，可以发现 <code>items</code> 对应的 setter 方法为：<code>sub_10D8B5FA8</code></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VKSettingView</span>.<span class="hljs-title class_">TabModel</span>: <span class="hljs-title class_">VKSettingView</span>.<span class="hljs-title class_">BaseModel</span> {
  <span class="hljs-comment">/* fields */</span>
    <span class="hljs-keyword">var</span> icon: <span class="hljs-type">String</span>
    <span class="hljs-keyword">var</span> itemsSize: __C.<span class="hljs-type">CGSize</span>
    <span class="hljs-keyword">var</span> items: [<span class="hljs-type">String</span>]
    <span class="hljs-keyword">var</span> selectedIndex: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">var</span> dynamicSelectedString: <span class="hljs-type">String</span>?
    <span class="hljs-keyword">var</span> enableRepeatSelect: <span class="hljs-type">Swift</span>.<span class="hljs-type">Bool</span>
    <span class="hljs-keyword">var</span> selectChangeCallback: ((<span class="hljs-keyword">_</span>:))<span class="hljs-operator">?</span>
  <span class="hljs-comment">/* methods */</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5bc4</span> <span class="hljs-comment">// getter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5c80</span> <span class="hljs-comment">// setter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5cdc</span> <span class="hljs-comment">// modify (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5d64</span> <span class="hljs-comment">// getter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5dfc</span> <span class="hljs-comment">// setter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5e50</span> <span class="hljs-comment">// modify (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5efc</span> <span class="hljs-comment">// getter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5fa8</span> <span class="hljs-comment">// setter (instance)</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">sub_10d8b5ff8</span> <span class="hljs-comment">// modify (instance)</span>
<span class="hljs-operator">...</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab45717245a84ae88dbfbfaf626dc148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=E2Jjl5Z6Fnp0vb%2Fv80uiXspUV7Q%3D" alt="41E4F621-7F23-4445-A24D-0347CB125655.png" loading="lazy"/></p>
<h3 data-id="heading-6">3. items 赋值来源追踪</h3>
<ul>
<li>尝试直接对 <code>sub_10D8B5FA8</code> 添加符号断点并未触发，因此推断该属性可能通过 <strong>Objective-C Runtime</strong> 间接调用。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d09c6eabec8340df812257fc0311ceff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=FmcClt0ZBwDwlni746OIr%2B63wOw%3D" alt="818F4D98-BD7D-4C7F-A134-A566E41E6D99.png" loading="lazy"/></p>
<ul>
<li>结合 <code>Swift / Objective-C</code> 混编特性，对 <code>-[TabModel setItems:]</code> 添加断点后成功捕获调用。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5c941e904b74b8f8859684555aee2bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=DfahTHdJLjf1HCadc1mwIyC1yXw%3D" alt="C1BA5A52-C023-45FE-8436-EB592F188CF1.png" loading="lazy"/></p>
<ul>
<li>
<p>通过 LLDB 打印参数内容可以确认：</p>
<pre><code class="hljs language-objc" lang="objc">(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.75</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">2.0</span>)
</code></pre>
<p>该数组正是当前 <code>UI</code> 中显示的播放速度列表。</p>
</li>
</ul>
<p><strong>LLDB:</strong></p>
<pre><code class="hljs language-objc" lang="objc">(lldb) <span class="hljs-keyword">register</span> read x2
      x2 = <span class="hljs-number">0x000000028044efc0</span>
(lldb) p (<span class="hljs-type">id</span>)<span class="hljs-number">0x000000028044efc0</span>
(__NSArrayI *) <span class="hljs-number">0x000000028044efc0</span> <span class="hljs-string">@"6 elements"</span>
(lldb) po (<span class="hljs-type">id</span>)<span class="hljs-number">0x000000028044efc0</span>
&lt;__NSArrayI <span class="hljs-number">0x28044efc0</span>&gt;(
<span class="hljs-number">0.5</span>,
<span class="hljs-number">0.75</span>,
<span class="hljs-number">1.0</span>,
<span class="hljs-number">1.25</span>,
<span class="hljs-number">1.5</span>,
<span class="hljs-number">2.0</span>
)
</code></pre>
<h3 data-id="heading-7">4. 调用栈分析</h3>
<p>查看调用栈可以发现，<code>items</code> 的赋值逻辑来自：</p>
<pre><code class="hljs language-css" lang="css">-<span class="hljs-selector-attr">[BBPlayerPlaySettingWidgetV2 playbackRate:]</span>
</code></pre>
<p>说明 <strong>播放速度数组是在该方法中被构造并传入 TabModel 的</strong>。</p>
<p><strong>调用堆栈：</strong></p>
<pre><code class="hljs language-objc" lang="objc">(lldb) bt
* thread #<span class="hljs-number">1</span>, queue = <span class="hljs-string">'com.apple.main-thread'</span>, stop reason = breakpoint <span class="hljs-number">10.1</span>
  * frame #<span class="hljs-number">0</span>: <span class="hljs-number">0x000000011084df44</span> bili-universal`-[TabModel setItems:]
    frame #<span class="hljs-number">1</span>: <span class="hljs-number">0x0000000128d2ba78</span> BiliBiliTweak.dylib`_logos_method$App$VKSettingViewTabModel$setItems$(<span class="hljs-keyword">self</span>=<span class="hljs-number">0x00000002821d6220</span>, _cmd=<span class="hljs-string">"setItems:"</span>, items=<span class="hljs-number">6</span> elements) at NJDetailPlayerAd.xm:<span class="hljs-number">418</span>:<span class="hljs-number">5</span>
    frame #<span class="hljs-number">2</span>: <span class="hljs-number">0x000000011062db8c</span> bili-universal`-[BBPlayerPlaySettingWidgetV2 playbackRate:] + <span class="hljs-number">488</span>
    frame #<span class="hljs-number">3</span>: <span class="hljs-number">0x000000011062c17c</span> bili-universal`sub_10D69410C + <span class="hljs-number">112</span>
    frame #<span class="hljs-number">4</span>: <span class="hljs-number">0x000000018ff78ce0</span> CoreFoundation`__NSARRAY_IS_CALLING_OUT_TO_A_BLOCK__ + <span class="hljs-number">16</span>
    frame #<span class="hljs-number">5</span>: <span class="hljs-number">0x000000018fe7cc0c</span> CoreFoundation`-[__NSArrayM enumerateObjectsWithOptions:usingBlock:] + <span class="hljs-number">192</span>
...
</code></pre>
<h3 data-id="heading-8">5. 伪代码验证</h3>
<p>在 <code>IDA</code> 中分析 <code>-[BBPlayerPlaySettingWidgetV2 playbackRate:]</code> 的伪代码，可以清晰看到播放速度数组是通过如下方式写死创建的：</p>
<pre><code class="hljs language-objc" lang="objc">v25[<span class="hljs-number">0</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"0.5"</span>);
v25[<span class="hljs-number">1</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"0.75"</span>);
v25[<span class="hljs-number">2</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.0"</span>);
v25[<span class="hljs-number">3</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.25"</span>);
v25[<span class="hljs-number">4</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.5"</span>);
v25[<span class="hljs-number">5</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"2.0"</span>);
</code></pre>
<p>至此可以确认：<strong>竖屏全屏场景下的播放速度选项并非动态配置，而是硬编码在该方法中</strong>。</p>
<p><strong>伪代码：</strong></p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-type">id</span> __cdecl -[BBPlayerPlaySettingWidgetV2 playbackRate:](BBPlayerPlaySettingWidgetV2 *<span class="hljs-keyword">self</span>, SEL a2, <span class="hljs-type">id</span> a3)
{
...
  v4 = objc_retain(a3);
  v5 = objc_retainAutoreleasedReturnValue(-[BBPlayerObject context](<span class="hljs-keyword">self</span>, <span class="hljs-string">"context"</span>));
  v6 = objc_retainAutoreleasedReturnValue(-[BBPlayerContext status](v5, <span class="hljs-string">"status"</span>));
  v7 = -[BBPlayerStatus isVerticalScreen](v6, <span class="hljs-string">"isVerticalScreen"</span>);
  objc_release(v6);
  objc_release(v5);
  <span class="hljs-keyword">if</span> ( v7 )
  {
    v25[<span class="hljs-number">0</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"0.5"</span>);
    v25[<span class="hljs-number">1</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"0.75"</span>);
    v25[<span class="hljs-number">2</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.0"</span>);
    v25[<span class="hljs-number">3</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.25"</span>);
    v25[<span class="hljs-number">4</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"1.5"</span>);
    v25[<span class="hljs-number">5</span>] = <span class="hljs-built_in">CFSTR</span>(<span class="hljs-string">"2.0"</span>);
    v8 = objc_retainAutoreleasedReturnValue(+[<span class="hljs-built_in">NSArray</span> arrayWithObjects:count:](&amp;OBJC_CLASS___NSArray, <span class="hljs-string">"arrayWithObjects:count:"</span>, v25, <span class="hljs-number">6</span>LL));
    v21 = <span class="hljs-number">0</span>LL;
    v22 = &amp;v21;
...
</code></pre>
<h2 data-id="heading-9">通用解决方案</h2>
<p>由于播放速度数组是通过 <code>+[NSArray arrayWithObjects:count:]</code> 构造的，因此可以采用 <strong>全局 Hook</strong> 的方式，对该方法进行拦截与替换。</p>
<p>核心思路如下：</p>
<ol>
<li>判断 <code>count == 6</code></li>
<li>校验原始数组内容是否与默认倍速数组一致</li>
<li>在满足条件时返回包含 <code>3.0</code> 的新数组</li>
</ol>
<hr/>
<h3 data-id="heading-10">Hook 实现代码</h3>
<pre><code class="hljs language-objc" lang="objc">%hook <span class="hljs-built_in">NSArray</span>

+ (<span class="hljs-keyword">instancetype</span>)arrayWithObjects:(<span class="hljs-type">id</span> *)objects count:(<span class="hljs-built_in">NSUInteger</span>)cnt {
    <span class="hljs-keyword">if</span> (cnt != <span class="hljs-number">6</span>) {
        <span class="hljs-keyword">return</span> %orig;
    }
    <span class="hljs-built_in">NSArray</span> *origArr = %orig(objects, cnt);
    <span class="hljs-comment">// 用 __autoreleasing 修饰数组元素</span>
    __autoreleasing <span class="hljs-type">id</span> oldRates[] = {
        <span class="hljs-string">@"0.5"</span>,
        <span class="hljs-string">@"0.75"</span>,
        <span class="hljs-string">@"1.0"</span>,
        <span class="hljs-string">@"1.25"</span>,
        <span class="hljs-string">@"1.5"</span>,
        <span class="hljs-string">@"2.0"</span>
    };
    <span class="hljs-built_in">NSUInteger</span> oldRatesCount = <span class="hljs-keyword">sizeof</span>(oldRates) / <span class="hljs-keyword">sizeof</span>(oldRates[<span class="hljs-number">0</span>]);
    <span class="hljs-comment">// 传数组名即可，数组名会退化为指针类型 __autoreleasing id *</span>
    <span class="hljs-built_in">NSArray</span> *oldRatesArr = %orig(oldRates, oldRatesCount);
    <span class="hljs-keyword">if</span> (cnt == <span class="hljs-number">6</span> &amp;&amp; [origArr isEqualToArray:oldRatesArr]) {
        __autoreleasing <span class="hljs-type">id</span> newRates[] = {
            <span class="hljs-string">@"0.5"</span>,
            <span class="hljs-string">@"1.0"</span>,
            <span class="hljs-string">@"1.25"</span>,
            <span class="hljs-string">@"1.5"</span>,
            <span class="hljs-string">@"2.0"</span>,
            <span class="hljs-string">@"3.0"</span>
        };
        <span class="hljs-built_in">NSUInteger</span> newRatesCount = <span class="hljs-keyword">sizeof</span>(newRates) / <span class="hljs-keyword">sizeof</span>(newRates[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">NSArray</span> *newRatesArr = %orig(newRates, newRatesCount);
        <span class="hljs-keyword">return</span> newRatesArr;
    }
    <span class="hljs-keyword">return</span> origArr;
}

%end
</code></pre>
<h2 data-id="heading-11">最终效果</h2>
<p>竖屏视频全屏播放场景下，播放速度列表成功新增 <strong>3.0 倍速</strong>，且不影响其他播放场景与现有功能逻辑。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1a40cb3e5ff44eb9857a0238f925b25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG91Y2hXb3JsZA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766533751&amp;x-signature=xRMvl3cUYUBRbJHHqKe0rpZz538%3D" alt="Screenshot 2025-12-16 at 10.18.43.png" width="50%" loading="lazy"/>
<h2 data-id="heading-12">总结</h2>
<p>本文通过 <code>UI</code> 分析、调用栈追踪与伪代码验证，完整定位了 <strong>竖屏视频全屏播放场景</strong> 下播放速度数组的生成位置，并给出了一个 <strong>稳定、通用且侵入性较低</strong> 的 <code>Hook</code> 方案。</p>
<p>该思路同样适用于其他存在硬编码配置的功能修改场景。</p>
<h2 data-id="heading-13">代码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTouchFriend%2FBiliBiliMApp" target="_blank" title="https://github.com/TouchFriend/BiliBiliMApp" ref="nofollow noopener noreferrer">BiliBiliMApp-无广告版哔哩哔哩</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini图像生成宽高比教程：10种比例完整配置指南【2025】]]></title>    <link>https://juejin.cn/post/7584279552434012198</link>    <guid>https://juejin.cn/post/7584279552434012198</guid>    <pubDate>2025-12-17T00:20:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584279552434012198" data-draft-id="7584340871412629531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini图像生成宽高比教程：10种比例完整配置指南【2025】"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-17T00:20:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LaoZhangAI"/> <meta itemprop="url" content="https://juejin.cn/user/1327865776053022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini图像生成宽高比教程：10种比例完整配置指南【2025】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1327865776053022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LaoZhangAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:20:46.000Z" title="Wed Dec 17 2025 00:20:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gemini图像生成支持10种宽高比，包括1:1、16:9、9:16、21:9等主流格式，Gemini 3 Pro还支持1K到4K多种分辨率输出。通过image_config参数或在prompt中声明即可控制输出尺寸，中国用户可通过laozhang.ai国内直连使用，价格比官方便宜最高79%。</p>
<p>本教程将详细介绍所有宽高比的配置方法、不同模型的支持差异、常见问题的解决方案，以及如何在中国稳定使用Gemini图像生成API。无论你是开发者还是内容创作者，都能找到适合自己的使用方式。</p>
<h2 data-id="heading-0">Gemini图像生成支持的10种宽高比</h2>
<p>Gemini 2.5 Flash Image和Gemini 3 Pro Image都支持相同的10种宽高比，这是目前AI图像生成领域支持最全面的宽高比列表之一。这些宽高比覆盖了从社交媒体、视频平台到专业印刷的各种场景需求。</p>
<p>具体来说，支持的宽高比包括：1:1正方形适合Instagram帖子和头像、16:9宽屏适合YouTube封面和博客横幅、9:16竖屏适合抖音和手机壁纸、21:9超宽屏适合电影横幅、4:3和3:4传统屏幕比例、3:2和2:3经典摄影比例、以及5:4和4:5大画幅比例。值得注意的是，Imagen 4.0作为独立模型只支持5种基础宽高比（1:1、4:3、3:4、16:9、9:16），如果你需要21:9超宽屏等特殊比例，必须选择Gemini系列模型。</p>
<p>在分辨率方面，Gemini 2.5 Flash Image默认输出1K分辨率（1024像素），而Gemini 3 Pro Image则支持1K、2K、4K三种分辨率选择。对于需要高清输出的商业用途，比如广告设计或大幅海报，建议使用Gemini 3 Pro Image的4K输出选项。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5bf589077104c5cadab3377257083ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFvWmhhbmdBSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766535646&amp;x-signature=LOlU4mCMU5chcIrhcdtmsAV03Xc%3D" alt="Gemini支持的10种宽高比完整列表" loading="lazy"/></p>
<h2 data-id="heading-1">Python代码配置宽高比的完整示例</h2>
<p>在实际开发中，控制Gemini图像生成的宽高比有两种主要方法。第一种是直接在prompt中声明宽高比，这种方式最简单也最可靠，模型能够准确理解你的意图。例如，当你需要生成一张YouTube封面时，可以这样写："生成一张科技主题的博客封面图，使用16:9宽屏比例"。</p>
<p>第二种方法是通过API参数配置，适合需要程序化控制的场景。如果你使用laozhang.ai的OpenAI兼容格式接口，可以直接在请求中指定模型参数。以下是一个完整的Python代码示例，展示了如何生成不同宽高比的图像：</p>
<p>对于使用Google原生API的开发者，宽高比通过generation_config中的image_config参数设置。可选值包括全部10种宽高比字符串，如"16:9"、"9:16"、"21:9"等。如果需要更高分辨率输出，可以在Gemini 3 Pro模型中添加image_size参数，设置为"2K"或"4K"。</p>
<p>需要注意的是，不同模型的API调用方式略有差异。如果你之前使用过其他图像生成API，可以参考我们的Gemini 3 Pro图像API教程获取更详细的集成指南。laozhang.ai提供了OpenAI兼容格式的接口，只需要修改base_url和api_key就能无缝迁移现有代码。</p>
<h2 data-id="heading-2">Gemini 2.5 Flash vs Gemini 3 Pro vs Imagen对比</h2>
<p>选择合适的模型需要根据你的具体需求来决定。三个模型各有特点：Gemini 2.5 Flash Image适合快速迭代和批量生成，Gemini 3 Pro Image适合高质量专业设计，而Imagen 4.0则是纯粹的图像生成模型。</p>
<p>从宽高比支持来看，Gemini 2.5 Flash和Gemini 3 Pro都支持全部10种宽高比，而Imagen只支持5种基础比例。如果你需要21:9超宽屏或5:4大画幅等特殊比例，就必须选择Gemini系列。从分辨率角度，Gemini 3 Pro支持最高4K输出，是目前三者中分辨率选项最丰富的。</p>
<p>在功能特性上，Gemini 2.5 Flash擅长多图融合和角色一致性，适合需要保持风格统一的系列创作。Gemini 3 Pro则具备清晰文字渲染能力，可以在图像中生成可读的文字内容，这对于需要包含标语或标题的设计非常有用。此外，Gemini 3 Pro还支持最多14张参考图输入和Thinking Mode深度推理。</p>
<p>价格方面的差异也很明显。通过laozhang.ai使用，Gemini 2.5 Flash Image只需<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.025</mn><mi mathvariant="normal">/</mi><mtext>张，比官方价格便宜约</mtext><mn>37.5</mn></mrow><annotation encoding="application/x-tex">0.025/张，比官方价格便宜约37.5%；Gemini 3 Pro Image只需</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.025/</span><span class="mord cjk_fallback">张，比官方价格便宜约</span><span class="mord">37.5</span></span></span></span></span>0.05/张，比官方便宜高达79%。对于需要大量生成的场景，这个价格优势相当可观。更多模型对比细节可以参考Nano Banana与Nano Banana Pro对比。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c77dd1066dc4542ac4fff094c1f13b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFvWmhhbmdBSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766535646&amp;x-signature=iaA5mwIgXFcSbF58E%2FyblgyP0TU%3D" alt="Gemini图像生成模型对比" loading="lazy"/></p>
<h2 data-id="heading-3">按场景选择最佳宽高比</h2>
<p>不同平台和用途对图像尺寸有不同的要求，选对宽高比能让你的图像在目标平台上获得最佳展示效果。以下是按场景分类的宽高比推荐指南。</p>
<p>对于社交媒体内容，各平台的最佳宽高比有明显差异。Instagram帖子推荐1:1正方形，这是平台原生格式，展示效果最好。Instagram Stories和Reels则应该使用9:16竖屏格式，能够占满手机屏幕。抖音和TikTok同样使用9:16竖屏。微博和微信朋友圈可以使用4:3或3:2的传统横向比例。</p>
<p>YouTube和博客封面通常需要16:9宽屏格式，这也是大多数现代显示器的原生比例。如果是做Banner横幅或电影预告风格的图像，21:9超宽屏会更有视觉冲击力。PPT演示文稿可以根据内容选择16:9或4:3，前者更现代，后者更传统。</p>
<p>专业印刷领域有自己的标准。人像摄影通常使用3:4或2:3的竖向比例，这与传统相机的35mm胶片比例一致。杂志封面多采用3:4，而大幅艺术摄影或画廊展示可能需要5:4的大画幅比例。名片和产品图片则常用1:1正方形。</p>
<p>选择宽高比时还要考虑内容本身的特点。横向场景（如风景、建筑）适合16:9或21:9，纵向主体（如人物、高楼）适合9:16或2:3。如果不确定最终用途，1:1正方形是最安全的选择，因为它可以轻松裁剪为任何其他比例。</p>
<h2 data-id="heading-4">宽高比不生效的问题排查与解决</h2>
<p>在使用Gemini图像生成时，有时会遇到宽高比不按预期生效的情况，最常见的问题是输出图像卡在1:1正方形比例。这种情况有几个可能的原因和对应的解决方案。</p>
<p>第一种常见原因是prompt中没有明确声明宽高比。虽然API参数可以控制宽高比，但在prompt中同时声明会更可靠。解决方法是在描述中明确写出期望的比例，例如："生成一张16:9宽屏的海边日落图，不要使用正方形比例"。使用否定语句（"不要使用正方形"）能进一步强化你的意图。</p>
<p>第二种情况是多图输入时宽高比被覆盖。根据Gemini的设计逻辑，当你上传多张参考图时，输出图像会继承最后一张图的宽高比。如果你上传了3张参考图，其中前两张是16:9但最后一张是1:1，输出就会变成正方形。解决方法是确保最后上传的参考图具有你想要的宽高比。</p>
<p>第三种有效的解决方案是使用参考图方法。准备一张目标宽高比的空白图或简单图像作为参考，在请求中包含这张图，模型会自动继承它的宽高比。这种方法比纯文字描述更可靠，特别是对于一些模型可能不太理解的小众比例。</p>
<p>图像编辑模式下通常会自动保持原图宽高比，但如果你在prompt中要求改变比例，需要明确说明。可以使用这样的表达："根据输入图像创作新版本，保持原有宽高比不变"或"将输入图像转换为16:9宽屏格式"。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6e3eff5a7094f009892ac4327743212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFvWmhhbmdBSQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766535646&amp;x-signature=nrM53o4%2BgJmCMKNqHFiG3fCYWAE%3D" alt="Python代码示例与问题排查" loading="lazy"/></p>
<h2 data-id="heading-5">常见问题解答</h2>
<p><strong>Gemini图像生成支持多少种宽高比？</strong></p>
<p>Gemini 2.5 Flash Image和Gemini 3 Pro Image都支持10种宽高比：1:1、16:9、9:16、21:9、4:3、3:4、3:2、2:3、5:4、4:5。Imagen 4.0只支持5种基础比例（1:1、4:3、3:4、16:9、9:16）。</p>
<p><strong>如何在代码中设置宽高比？</strong></p>
<p>有两种方法：一是在prompt中直接声明，例如"生成16:9比例的图像"；二是通过API参数设置image_config中的aspect_ratio字段。推荐在prompt中声明，这种方式更可靠。</p>
<p><strong>为什么我设置了宽高比但输出还是正方形？</strong></p>
<p>最常见的原因是prompt描述不够明确。建议在prompt中明确声明期望比例，并使用否定语句强调，如"使用16:9宽屏，不要正方形"。另一个有效方法是上传一张目标宽高比的参考图。</p>
<p><strong>Gemini 3 Pro的4K输出如何开启？</strong></p>
<p>在generation_config中设置image_size参数为"4K"。注意必须使用大写字母K。可选值包括"1K"、"2K"、"4K"。4K输出的价格会相应更高。</p>
<p><strong>不同平台推荐什么宽高比？</strong></p>
<p>Instagram帖子用1:1，抖音/TikTok/Reels用9:16，YouTube封面用16:9，电影横幅用21:9，PPT演示用16:9或4:3，人像摄影用3:4或2:3。</p>
<p><strong>多图输入时宽高比如何确定？</strong></p>
<p>模型会继承最后一张输入图的宽高比。如果需要特定比例，确保最后上传的图片是目标宽高比，或者在prompt中明确声明。</p>
<p><strong>Gemini 2.5 Flash和3 Pro在宽高比支持上有区别吗？</strong></p>
<p>两者支持的宽高比种类完全相同，都是10种。主要区别在于分辨率：Flash只支持1K，而Pro支持1K/2K/4K三种。在价格上，通过laozhang.ai使用Flash是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.025</mn><mi mathvariant="normal">/</mi><mtext>张，</mtext><mi>P</mi><mi>r</mi><mi>o</mi><mtext>是</mtext></mrow><annotation encoding="application/x-tex">0.025/张，Pro是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0.025/</span><span class="mord cjk_fallback">张，</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">ro</span><span class="mord cjk_fallback">是</span></span></span></span></span>0.05/张。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你封装一个高性能、多功能的 React 锚点导航组件 (Anchor)]]></title>    <link>https://juejin.cn/post/7584298069610692608</link>    <guid>https://juejin.cn/post/7584298069610692608</guid>    <pubDate>2025-12-17T01:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584298069610692608" data-draft-id="7584243498528096256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你封装一个高性能、多功能的 React 锚点导航组件 (Anchor)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-17T01:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JQ_Zhang"/> <meta itemprop="url" content="https://juejin.cn/user/1871846865110249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你封装一个高性能、多功能的 React 锚点导航组件 (Anchor)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1871846865110249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JQ_Zhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:43:25.000Z" title="Wed Dec 17 2025 01:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 手把手教你封装一个高性能、多功能的 React 锚点导航组件 (Anchor)</h2>
<p>在开发长页面（如新闻资讯、产品详情、帮助文档）时，<strong>锚点导航</strong>是一个非常常见的需求。它能让用户快速定位到感兴趣的内容区域，提升阅读体验。</p>
<p>市面上虽然有很多 UI 库提供了 Anchor 组件（如 Ant Design），但在移动端或特定复杂场景下（如吸顶、滚动容器自适应、高度不一），往往还是需要我们自己封装一个更灵活、更轻量的组件。</p>
<p>今天，我就带大家详细解析一下，我们是如何封装一个 <strong>开箱即用、功能强大</strong> 的 Anchor 组件的。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a2020fb45264583bbcf597e212aef7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlFfWmhhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766540605&amp;x-signature=MOKKKDtDv3p9rhapCBCogJRHiGc%3D" alt="popup.gif" loading="lazy"/></p>
<h3 data-id="heading-1">✨ 核心亮点</h3>
<p>这个组件不仅仅是一个简单的“点击跳转”，它解决了许多实际开发中的痛点：</p>
<ol>
<li><strong>开箱即用</strong>：组件内置滚动容器，无需外部再包一层复杂的布局，把内容传进去就能跑。</li>
<li><strong>智能吸顶 (Sticky)</strong>：当页面向上滚动时，导航栏会自动吸附在顶部，不用担心用户找不到导航。</li>
<li><strong>双向联动</strong>：
<ul>
<li><strong>点击导航</strong> -&gt; 平滑滚动到对应内容。</li>
<li><strong>滚动内容</strong> -&gt; 自动高亮对应的导航 Tab。</li>
</ul>
</li>
<li><strong>高度自适应</strong>：无论内容模块是高是矮，都能精准定位，且支持“触底自动选中最后一项”的兜底逻辑。</li>
<li><strong>丝滑无抖动</strong>：完美解决了 Tab 切换时的字体粗细变化导致的布局抖动问题。</li>
<li><strong>极简 API</strong>：直接传递组件数组，自动提取标题，告别手动维护 <code>id</code> 和 <code>key</code> 的烦恼。</li>
<li><strong>高度可定制</strong>：从导航栏到每一个 Tab，样式全开放配置。</li>
</ol>
<hr/>
<h3 data-id="heading-2">🛠️ 使用体验</h3>
<p>在使用这个组件之前，你可能需要手动写很多 ID、监听 Scroll 事件、计算高度……</p>
<p>而现在，你只需要这样：</p>
<ol>
<li>准备你的内容数组，在每个组件上标记 title</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> items = [
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"推荐"</span>&gt;</span>这里是推荐板块的内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"热点"</span>&gt;</span>这里是热点板块的内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"视频"</span>&gt;</span>这里是视频板块的内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,
];
</code></pre>
<ol start="2">
<li>渲染组件</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Anchor</span> 
  items={items} 
  header={<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这里可以放顶部的 Banner<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>}
  style={{ <span class="hljs-attr">height</span>: <span class="hljs-string">'100vh'</span> }} <span class="hljs-comment">// 设置容器高度</span>
/&gt;就这么简单！组件会自动生成导航栏，并处理好所有的滚动逻辑。
</code></pre>
<hr/>
<h3 data-id="heading-3">💡 核心技术实现</h3>
<h4 data-id="heading-4">1. 极简的 Props 设计</h4>
<p>为了让开发者用得爽，我们放弃了传统的 <code>data</code> + <code>content</code> 分离的写法，采用了“<strong>组件即数据</strong>”的思路：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 组件内部自动提取 title</span>
<span class="hljs-keyword">const</span> anchorData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">child, index</span>) =&gt;</span> ({
    <span class="hljs-attr">key</span>: <span class="hljs-string">`anchor-item-<span class="hljs-subst">${index}</span>`</span>,
    <span class="hljs-attr">title</span>: child.<span class="hljs-property">props</span>.<span class="hljs-property">title</span> || <span class="hljs-string">`Tab <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span>, <span class="hljs-comment">// 自动提取</span>
    <span class="hljs-attr">content</span>: child
  }));
}, [items]);
</code></pre>
<h4 data-id="heading-5">2. 精准的滚动定位 (getBoundingClientRect)</h4>
<p>很多组件使用 <code>offsetTop</code> 来计算位置，但在多层嵌套或有 sticky 元素的情况下容易出错。我们统一使用 <code>getBoundingClientRect()</code> 来计算<strong>相对可视区的距离</strong>，确保万无一失。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 计算目标元素距离容器顶部的真实视觉距离</span>
<span class="hljs-keyword">const</span> relativeTop = targetEl.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> - containerEl.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span>;

<span class="hljs-comment">// 目标位置 = 当前滚动 + 相对距离 - 吸顶高度 - 导航栏高度</span>
<span class="hljs-keyword">const</span> scrollTop = containerEl.<span class="hljs-property">scrollTop</span> + relativeTop - offsetTop - navHeight;
</code></pre>
<h4 data-id="heading-6">3. 解决“Tab 切换抖动”</h4>
<p>当选中的 Tab 字体变粗（<code>font-weight: bold</code>）时，宽度会增加，导致整个导航栏“跳”一下。我们使用了一个巧妙的 CSS 技巧：<strong><code>text-shadow</code> 模拟加粗</strong>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.navItem</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#0084ff</span>;
  <span class="hljs-comment">/* 看起来像粗体，但完全不占额外空间 */</span>
  <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> .<span class="hljs-number">25px</span> currentcolor; 
}
</code></pre>
<h4 data-id="heading-7">4. 智能的 ScrollSpy (滚动监听)</h4>
<p>如何判断当前应该高亮哪个 Tab？我们不仅判断了元素位置，还加了一个<strong>触底兜底</strong>逻辑：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 如果滚到底了，强制选中最后一个，防止最后一个模块太矮永远无法被激活</span>
<span class="hljs-keyword">const</span> isBottom = container.<span class="hljs-property">scrollTop</span> + container.<span class="hljs-property">clientHeight</span> &gt;= container.<span class="hljs-property">scrollHeight</span> - <span class="hljs-number">5</span>;
<span class="hljs-keyword">if</span> (isBottom) {
  <span class="hljs-title function_">setActiveKey</span>(lastItem.<span class="hljs-property">key</span>);
  <span class="hljs-keyword">return</span>;
}
</code></pre>
<h4 data-id="heading-8">5. 防抖处理</h4>
<p>在用户快速连续点击 Tab 时，如果仍然触发滚动监听，会导致左侧 Tab 乱跳。我们引入了一个简单的“锁”机制：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 点击时上锁</span>
isManualScrolling.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 滚动结束后解锁 (使用 setTimeout 防抖)</span>
<span class="hljs-built_in">clearTimeout</span>(timer);
timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  isManualScrolling.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
}, <span class="hljs-number">600</span>);---
</code></pre>
<h3 data-id="heading-9">🎨 样式完全定制</h3>
<p>组件提供了丰富的样式接口，你可以把它变成任何你想要的样子：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Anchor</span>
  <span class="hljs-comment">// 定制 Tab 栏背景和边框</span>
  tabBarStyle={{ <span class="hljs-attr">background</span>: <span class="hljs-string">'#f9f9f9'</span>, <span class="hljs-attr">borderBottom</span>: <span class="hljs-string">'1px solid #eee'</span> }}
  <span class="hljs-comment">// 定制 Tab 项间距和字体</span>
  tabItemStyle={{ <span class="hljs-attr">padding</span>: <span class="hljs-string">'10px 20px'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span> }}
  <span class="hljs-comment">// 定制激活状态 (比如变成胶囊按钮)</span>
  activeTabStyle={{ <span class="hljs-attr">background</span>: <span class="hljs-string">'#e6f7ff'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#0084ff'</span>, <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">20</span> }}
  <span class="hljs-comment">// 隐藏默认下划线</span>
  lineStyle={{ <span class="hljs-attr">display</span>: <span class="hljs-string">'none'</span> }}
  <span class="hljs-comment">// ...</span>
/&gt;---
</code></pre>
<h4 data-id="heading-10">5. 完整代码结构+样式</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useRef, useState, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./index.module.scss'</span>;
<span class="hljs-keyword">import</span> classNames <span class="hljs-keyword">from</span> <span class="hljs-string">'classnames'</span>;

<span class="hljs-comment">/**
 * 通用 Anchor 锚点导航组件
 *
 * 功能特点：
 * 1. 自带滚动容器，无需外部包裹，开箱即用。
 * 2. 支持吸顶导航（Sticky），可配置吸顶偏移量。
 * 3. 自动根据滚动位置高亮对应的 Tab。
 * 4. 点击 Tab 平滑滚动到对应内容区域，自动修正吸顶高度遮挡。
 * 5. 解决 Tab 切换抖动问题（使用 text-shadow 模拟加粗）。
 * 6. 支持连续快速点击的防抖处理。
 * 7. 支持高度不一致的内容模块，支持触底自动选中最后一项。
 *
 * 使用方式：
 * 直接传递 React Element 数组作为 items，组件会自动提取元素上的 title 属性作为 Tab 标题。
 *
 * 示例：
 * ```tsx
 * &lt;Anchor
 *   items={[
 *     &lt;div title="推荐"&gt;推荐内容...&lt;/div&gt;,
 *     &lt;div title="热点"&gt;热点内容...&lt;/div&gt;
 *   ]}
 *   header={&lt;div&gt;顶部 Banner&lt;/div&gt;}
 *   style={{ height: '100vh' }}
 *   tabItemStyle={{ fontSize: 16 }}
 *   activeTabStyle={{ color: 'red' }}
 * /&gt;
 * ```
 */</span>

<span class="hljs-comment">// 内部使用的 Item 结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnchorItem</span> {
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  <span class="hljs-attr">content</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-comment">// 接收 React Element 数组，要求每个 Element 有 title 属性</span>
  <span class="hljs-attr">items</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactElement</span>&lt;{ title?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> }&gt;[];
  header?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>; <span class="hljs-comment">// 顶部不需要吸顶的内容</span>

  className?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 最外层容器类名</span>
  style?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>; <span class="hljs-comment">// 最外层容器样式，通常需要设置 height</span>

  offsetTop?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 吸顶距离，默认 0</span>

  <span class="hljs-comment">// 自定义样式配置</span>
  tabBarClassName?: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// 导航条容器类名</span>
  tabItemClassName?: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// Tab 项类名</span>
  activeTabClassName?: <span class="hljs-built_in">string</span>;<span class="hljs-comment">// 激活状态 Tab 项类名</span>
  lineClassName?: <span class="hljs-built_in">string</span>;     <span class="hljs-comment">// 下划线类名</span>

  tabBarStyle?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;   <span class="hljs-comment">// 导航条容器样式</span>
  tabItemStyle?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;  <span class="hljs-comment">// Tab 项样式</span>
  activeTabStyle?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;<span class="hljs-comment">// 激活状态 Tab 项样式</span>
  lineStyle?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;     <span class="hljs-comment">// 下划线样式</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Anchor</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  items,
  header,
  className,
  style,
  offsetTop = <span class="hljs-number">0</span>,

  tabBarClassName,
  tabItemClassName,
  activeTabClassName,
  lineClassName,

  tabBarStyle,
  tabItemStyle,
  activeTabStyle,
  lineStyle
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> scrollContainerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 整个组件的滚动容器</span>
  <span class="hljs-keyword">const</span> navRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 导航条容器（吸顶部分）</span>
  <span class="hljs-keyword">const</span> navScrollRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 导航条内部的水平滚动区域</span>

  <span class="hljs-comment">// 处理 items，生成内部使用的数据结构</span>
  <span class="hljs-keyword">const</span> anchorData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">child, index</span>) =&gt;</span> ({
      <span class="hljs-attr">key</span>: <span class="hljs-string">`anchor-item-<span class="hljs-subst">${index}</span>`</span>,
      <span class="hljs-attr">title</span>: child.<span class="hljs-property">props</span>.<span class="hljs-property">title</span> || <span class="hljs-string">`Tab <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>`</span>,
      <span class="hljs-attr">content</span>: child
    }));
  }, [items]);

  <span class="hljs-keyword">const</span> [activeKey, setActiveKey] = useState&lt;<span class="hljs-built_in">string</span>&gt;(anchorData[<span class="hljs-number">0</span>]?.<span class="hljs-property">key</span>);
  <span class="hljs-keyword">const</span> isManualScrolling = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> scrollTimerRef = useRef&lt;<span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 用于保存定时器</span>

  <span class="hljs-comment">// Tab 自动居中逻辑</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (activeKey &amp;&amp; navScrollRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">const</span> index = anchorData.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">key</span> === activeKey);
      <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> itemNodes = navScrollRef.<span class="hljs-property">current</span>.<span class="hljs-property">children</span>;
        <span class="hljs-keyword">const</span> targetNode = itemNodes[index] <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>;
        <span class="hljs-keyword">if</span> (targetNode) {
          <span class="hljs-keyword">const</span> navContainer = navScrollRef.<span class="hljs-property">current</span>;
          <span class="hljs-keyword">const</span> scrollLeft = targetNode.<span class="hljs-property">offsetLeft</span> + targetNode.<span class="hljs-property">offsetWidth</span> / <span class="hljs-number">2</span> - navContainer.<span class="hljs-property">offsetWidth</span> / <span class="hljs-number">2</span>;
          navContainer.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">left</span>: scrollLeft, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
        }
      }
    }
  }, [activeKey, anchorData]);

  <span class="hljs-comment">// 点击 Tab 处理</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params">item: AnchorItem, e: React.MouseEvent</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();

    <span class="hljs-comment">// 清除之前的定时器，防止过早释放锁</span>
    <span class="hljs-keyword">if</span> (scrollTimerRef.<span class="hljs-property">current</span>) {
      <span class="hljs-built_in">clearTimeout</span>(scrollTimerRef.<span class="hljs-property">current</span>);
    }

    <span class="hljs-title function_">setActiveKey</span>(item.<span class="hljs-property">key</span>);
    isManualScrolling.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">const</span> targetEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(item.<span class="hljs-property">key</span>);
    <span class="hljs-keyword">const</span> containerEl = scrollContainerRef.<span class="hljs-property">current</span>;

    <span class="hljs-keyword">if</span> (targetEl &amp;&amp; containerEl) {
         <span class="hljs-keyword">const</span> navHeight = navRef.<span class="hljs-property">current</span>?.<span class="hljs-property">offsetHeight</span> || <span class="hljs-number">0</span>;

         <span class="hljs-comment">// 目标位置 = 当前scrollTop + (目标相对于视口的top - 容器相对于视口的top) - (吸顶距离 + 导航高度)</span>
         <span class="hljs-keyword">const</span> relativeTop = targetEl.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> - containerEl.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span>;
         <span class="hljs-keyword">let</span> scrollTop = containerEl.<span class="hljs-property">scrollTop</span> + relativeTop - offsetTop - navHeight;

         <span class="hljs-comment">// 边界检查</span>
         scrollTop = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, scrollTop);

         containerEl.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: scrollTop, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });

         <span class="hljs-comment">// 重新设置定时器，确保锁住直到本次滚动大致结束</span>
         scrollTimerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
           isManualScrolling.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
           scrollTimerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
         }, <span class="hljs-number">600</span>);
    }
  };

  <span class="hljs-comment">// 监听页面滚动</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> container = scrollContainerRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (!container) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (isManualScrolling.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> navHeight = navRef.<span class="hljs-property">current</span>?.<span class="hljs-property">offsetHeight</span> || <span class="hljs-number">0</span>;

      <span class="hljs-comment">// 触底判断</span>
      <span class="hljs-keyword">const</span> isBottom = container.<span class="hljs-property">scrollTop</span> + container.<span class="hljs-property">clientHeight</span> &gt;= container.<span class="hljs-property">scrollHeight</span> - <span class="hljs-number">5</span>;
      <span class="hljs-keyword">if</span> (isBottom) {
        <span class="hljs-title function_">setActiveKey</span>(anchorData[anchorData.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]?.<span class="hljs-property">key</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// 判定线：容器可视区顶部 + 吸顶距离 + 导航高度 + 缓冲</span>
      <span class="hljs-comment">// 我们希望当元素的顶部 滚入 到 Anchor 下方时激活</span>
      <span class="hljs-keyword">const</span> checkPoint = container.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + offsetTop + navHeight + <span class="hljs-number">10</span>;

      <span class="hljs-keyword">let</span> currentKey = anchorData[<span class="hljs-number">0</span>]?.<span class="hljs-property">key</span>;

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> anchorData) {
        <span class="hljs-keyword">const</span> targetEl = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(item.<span class="hljs-property">key</span>);
        <span class="hljs-keyword">if</span> (targetEl) {
           <span class="hljs-keyword">const</span> targetTop = targetEl.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span>;
           <span class="hljs-keyword">if</span> (targetTop &lt;= checkPoint) {
             currentKey = item.<span class="hljs-property">key</span>;
           } <span class="hljs-keyword">else</span> {
             <span class="hljs-keyword">break</span>;
           }
        }
      }
      <span class="hljs-title function_">setActiveKey</span>(currentKey);
    };

    container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> container.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);
  }, [anchorData, offsetTop]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames(styles.anchorContainer,</span> <span class="hljs-attr">className</span>)}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{scrollContainerRef}</span>
    &gt;</span>
      {/* 顶部内容区域 */}
      {header &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.header}</span>&gt;</span>{header}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}

      {/* 吸顶导航条 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames(styles.navWrapper,</span> <span class="hljs-attr">tabBarClassName</span>)}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">top:</span> <span class="hljs-attr">offsetTop</span>, <span class="hljs-attr">...tabBarStyle</span> }}
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{navRef}</span>
      &gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.navScrollContainer}</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{navScrollRef}</span>&gt;</span>
            {anchorData.map((item) =&gt; {
              const isActive = activeKey === item.key;
              return (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                  <span class="hljs-attr">key</span>=<span class="hljs-string">{item.key}</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames(styles.navItem,</span> <span class="hljs-attr">tabItemClassName</span>, {
                    [<span class="hljs-attr">styles.active</span>]<span class="hljs-attr">:</span> <span class="hljs-attr">isActive</span>,
                    [<span class="hljs-attr">activeTabClassName</span> || '']<span class="hljs-attr">:</span> <span class="hljs-attr">isActive</span>
                  })}
                  <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
                    <span class="hljs-attr">...tabItemStyle</span>,
                    <span class="hljs-attr">...</span>(<span class="hljs-attr">isActive</span> ? <span class="hljs-attr">activeTabStyle</span> <span class="hljs-attr">:</span> {})
                  }}
                  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleClick(item, e)}
                &gt;
                  {item.title}
                  {isActive &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                      <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames(styles.line,</span> <span class="hljs-attr">lineClassName</span>)}
                      <span class="hljs-attr">style</span>=<span class="hljs-string">{lineStyle}</span>
                    /&gt;</span>
                  )}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              );
            })}
         <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 内容区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.contentWrapper}</span>&gt;</span>
        {anchorData.map((item) =&gt; (
          // 这里我们必须给内容包裹一层，用于定位
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.key}</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{item.key}</span>&gt;</span>
             {item.content}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Anchor</span>;
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.anchorContainer</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">overflow-y</span>: auto; <span class="hljs-comment">// 纵向滚动容器</span>
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch;
}

<span class="hljs-selector-class">.header</span> {
  <span class="hljs-comment">// 顶部区域样式，如果需要</span>
}

<span class="hljs-selector-class">.navWrapper</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">position</span>: sticky; <span class="hljs-comment">// 吸顶</span>
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}

<span class="hljs-selector-class">.navScrollContainer</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">overflow-x</span>: auto; <span class="hljs-comment">// 横向滚动</span>
  <span class="hljs-attribute">white-space</span>: nowrap;
  -webkit-<span class="hljs-attribute">overflow</span>-scrolling: touch;

  &amp;::-webkit-scrollbar {
    <span class="hljs-attribute">display</span>: none;
  }

  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.navItem</span> {
  <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">cursor</span>: pointer;

  &amp;<span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#0084ff</span>;
    <span class="hljs-comment">// 使用 text-shadow 模拟加粗，防止抖动</span>
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> .<span class="hljs-number">25px</span> currentcolor;
  }

  <span class="hljs-selector-class">.line</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">bottom</span>: <span class="hljs-number">6px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">3px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#0084ff</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  }
}

<span class="hljs-selector-class">.contentWrapper</span> {
  <span class="hljs-comment">// 内容区域样式</span>
}
</code></pre>
<h3 data-id="heading-11">📝 总结</h3>
<p>通过封装这个 Anchor 组件，我们将复杂的滚动计算、事件监听、样式处理全部收敛到了内部。对于外部使用者来说，它就是一个简单的、可配置的容器组件。</p>
<p>这不仅提高了开发效率，保证了各处交互的一致性，也让代码变得更加整洁、易维护。</p>
<p>如果你也在做移动端长页面的开发，强烈建议尝试一下这种封装思路！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Foundry 中 remapping.txt 原理详解（2025 最新完整版）]]></title>    <link>https://juejin.cn/post/7584279552433438758</link>    <guid>https://juejin.cn/post/7584279552433438758</guid>    <pubDate>2025-12-16T16:09:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584279552433438758" data-draft-id="7584279552433422374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Foundry 中 remapping.txt 原理详解（2025 最新完整版）"/> <meta itemprop="keywords" content="web3,智能合约"/> <meta itemprop="datePublished" content="2025-12-16T16:09:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RainWeb3"/> <meta itemprop="url" content="https://juejin.cn/user/599705882203355"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Foundry 中 remapping.txt 原理详解（2025 最新完整版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/599705882203355/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RainWeb3
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T16:09:57.000Z" title="Tue Dec 16 2025 16:09:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Foundry 中 remapping.txt 原理详解（2025 最新完整版）</strong></h2>
<hr/>
<blockquote>
<p><strong>更新时间</strong>：2025年10月13日<br/>
<strong>适用 Foundry 版本</strong>：<code>foundry-cli v0.99.0</code> 及以上（兼容 Forge、Cast、Anvil）<br/>
<strong>适用用户</strong>：Solidity 开发者、智能合约工程师、区块链项目维护者<br/>
<strong>文档目标</strong>：深入解析 Foundry 项目中 <code>remappings.txt</code> 文件的原理、用法、最佳实践与高级技巧。</p>
</blockquote>
<ul>
<li>新Github-国外访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Frainweb4.github.io%2F" target="_blank" title="https://rainweb4.github.io/" ref="nofollow noopener noreferrer">rainweb4.github.io/</a></li>
<li>新Github-国内访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRainweb4%2Frainweb3.github.io" target="_blank" title="https://github.com/Rainweb4/rainweb3.github.io" ref="nofollow noopener noreferrer">github.com/Rainweb4/ra…</a></li>
</ul>
<hr/>
<h3 data-id="heading-1"><strong>目录（可点击跳转）</strong></h3>
<ol>
<li><a href="#1-%E6%A6%82%E8%BF%B0%E4%BB%80%E4%B9%88%E6%98%AF-remappingstxt" title="#1-%E6%A6%82%E8%BF%B0%E4%BB%80%E4%B9%88%E6%98%AF-remappingstxt">概述：什么是 remappings.txt？</a></li>
<li><a href="#2-%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3" title="#2-%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3">原理详解</a>
<ul>
<li><a href="#21-solidity-%E7%9A%84-import-%E6%9C%BA%E5%88%B6%E5%9B%9E%E9%A1%BE" title="#21-solidity-%E7%9A%84-import-%E6%9C%BA%E5%88%B6%E5%9B%9E%E9%A1%BE">2.1 Solidity 的 import 机制回顾</a></li>
<li><a href="#22-remapping-%E7%9A%84%E6%9C%AC%E8%B4%A8" title="#22-remapping-%E7%9A%84%E6%9C%AC%E8%B4%A8">2.2 remapping 的本质</a></li>
</ul>
</li>
<li><a href="#3-remappingstxt-%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3" title="#3-remappingstxt-%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">remappings.txt 文件详解</a>
<ul>
<li><a href="#31-%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E4%B8%8E%E4%BC%98%E5%85%88%E7%BA%A7" title="#31-%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E4%B8%8E%E4%BC%98%E5%85%88%E7%BA%A7">3.1 文件位置与优先级</a></li>
<li><a href="#32-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B8%8E%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99" title="#32-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E4%B8%8E%E8%AF%AD%E6%B3%95%E8%A7%84%E5%88%99">3.2 文件格式与语法规则</a></li>
<li><a href="#33-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90" title="#33-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90">3.3 工作流程解析</a></li>
</ul>
</li>
<li><a href="#4-%E4%B8%8E-foundrytoml-%E7%9A%84%E9%9B%86%E6%88%90" title="#4-%E4%B8%8E-foundrytoml-%E7%9A%84%E9%9B%86%E6%88%90">与 foundry.toml 的集成</a></li>
<li><a href="#5-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B" title="#5-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E7%A4%BA%E4%BE%8B">实际应用示例</a>
<ul>
<li><a href="#51-%E6%A0%87%E5%87%86%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84" title="#51-%E6%A0%87%E5%87%86%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">5.1 标准项目结构</a></li>
<li><a href="#52-remappingstxt-%E5%86%85%E5%AE%B9" title="#52-remappingstxt-%E5%86%85%E5%AE%B9">5.2 remappings.txt 内容</a></li>
<li><a href="#53-%E5%9C%A8-solidity-%E4%B8%AD%E4%BD%BF%E7%94%A8" title="#53-%E5%9C%A8-solidity-%E4%B8%AD%E4%BD%BF%E7%94%A8">5.3 在 Solidity 中使用</a></li>
</ul>
</li>
<li><a href="#6-%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#6-%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">高级技巧与最佳实践</a>
<ul>
<li><a href="#61-%E4%BD%BF%E7%94%A8-forge-install-%E8%87%AA%E5%8A%A8%E7%AE%A1%E7%90%86-remappings" title="#61-%E4%BD%BF%E7%94%A8-forge-install-%E8%87%AA%E5%8A%A8%E7%AE%A1%E7%90%86-remappings">6.1 使用 forge install 自动管理 remappings</a></li>
<li><a href="#62-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%BA%93%E5%85%B1%E5%AD%98%E9%AB%98%E7%BA%A7" title="#62-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%BA%93%E5%85%B1%E5%AD%98%E9%AB%98%E7%BA%A7">6.2 多版本库共存（高级）</a></li>
<li><a href="#63-%E8%B7%AF%E5%BE%84%E5%86%B2%E7%AA%81%E4%B8%8E%E8%B0%83%E8%AF%95" title="#63-%E8%B7%AF%E5%BE%84%E5%86%B2%E7%AA%81%E4%B8%8E%E8%B0%83%E8%AF%95">6.3 路径冲突与调试</a></li>
<li><a href="#64-%E6%94%AF%E6%8C%81%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5symlinks" title="#64-%E6%94%AF%E6%8C%81%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5symlinks">6.4 支持符号链接（Symlinks）</a></li>
</ul>
</li>
<li><a href="#7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98faq" title="#7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98faq">常见问题（FAQ）</a></li>
<li><a href="#8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93" title="#8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%80%BB%E7%BB%93">最佳实践总结</a></li>
<li><a href="#9-%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B2025" title="#9-%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B2025">未来展望（2025+）</a></li>
<li><a href="#10-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99" title="#10-%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ol>
<hr/>
<h3 data-id="heading-2"><strong>1. 概述：什么是 remappings.txt？</strong></h3>
<p>在 Foundry（特别是 <code>forge</code>）中，<code>remappings.txt</code> 是一个用于<strong>路径重映射（Path Remapping）<strong>的配置文件。它的核心作用是</strong>将 Solidity 源码中的 <code>import</code> 路径映射到实际的物理文件路径</strong>，从而实现模块化、可复用和跨项目依赖管理。</p>
<h4 data-id="heading-3"><strong>核心价值</strong></h4>
<ul>
<li>解耦 <code>import</code> 语句与物理路径</li>
<li>支持第三方库（如 OpenZeppelin、Solmate）的灵活引入</li>
<li>提高项目结构的可维护性和可移植性</li>
<li>支持多版本依赖管理</li>
</ul>
<hr/>
<h3 data-id="heading-4"><strong>2. 原理详解</strong></h3>
<h4 data-id="heading-5"><strong>2.1 Solidity 的 import 机制回顾</strong></h4>
<p>Solidity 使用 <code>import</code> 语句引入外部文件，例如：</p>
<pre><code class="hljs language-solidity" lang="solidity">import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "src/lib/Math.sol";
</code></pre>
<p>但编译器需要知道 <code>@openzeppelin/...</code> 到底对应哪个物理路径。这就是 <strong>remapping</strong> 发挥作用的地方。</p>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fen%2Flatest%2Flayout-of-source-files.html%23import-paths" target="_blank" title="https://docs.soliditylang.org/en/latest/layout-of-source-files.html#import-paths" ref="nofollow noopener noreferrer">Solidity 官方文档</a>，编译器通过“虚拟文件系统”（VFS）抽象源文件路径，而 remapping 正是连接逻辑路径与物理路径的关键桥梁。</p>
<h4 data-id="heading-6"><strong>2.2 remapping 的本质</strong></h4>
<p>remapping 是一种 <strong>前缀替换规则</strong>。它将 <code>import</code> 语句中的虚拟路径前缀，替换为本地文件系统的实际路径。</p>
<h5 data-id="heading-7"><strong>格式：</strong></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">virtual_prefix</span>&gt;</span>=<span class="hljs-tag">&lt;<span class="hljs-name">physical_path</span>&gt;</span>
</code></pre>
<ul>
<li><code>&lt;virtual_prefix&gt;</code>：你在 <code>import</code> 中使用的前缀（如 <code>@openzeppelin/</code>）</li>
<li><code>&lt;physical_path&gt;</code>：本地磁盘上的实际目录路径（绝对或相对）</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>3. remappings.txt 文件详解</strong></h3>
<h4 data-id="heading-9"><strong>3.1 文件位置与优先级</strong></h4>
<ul>
<li><strong>默认位置</strong>：项目根目录下的 <code>remappings.txt</code></li>
<li><strong>支持多文件</strong>：也可通过 <code>--remappings-path</code> 指定其他文件</li>
<li><strong>优先级顺序</strong>：
<ol>
<li>命令行参数 <code>--remap-imports</code></li>
<li><code>remappings.txt</code> 文件</li>
<li><code>foundry.toml</code> 中的 <code>remappings</code> 配置（见下文）</li>
</ol>
</li>
</ul>
<blockquote>
<p>✅ <strong>推荐</strong>：使用 <code>remappings.txt</code> + <code>foundry.toml</code> 混合管理，兼顾灵活性与可读性。</p>
</blockquote>
<hr/>
<h4 data-id="heading-10"><strong>3.2 文件格式与语法规则</strong></h4>
<h5 data-id="heading-11"><strong>基本语法</strong></h5>
<p>每行一个 remapping，格式为：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">prefix</span>=path/to/directory
</code></pre>
<h5 data-id="heading-12"><strong>示例</strong></h5>
<pre><code class="hljs language-txt" lang="txt">@openzeppelin/=lib/openzeppelin-contracts/
@solmate/=lib/solmate/src/
src/=src/
test/=test/
</code></pre>
<h5 data-id="heading-13"><strong>关键规则</strong></h5>

























<table><thead><tr><th>规则</th><th>说明</th></tr></thead><tbody><tr><td><strong>必须以 <code>/</code> 结尾</strong></td><td><code>prefix</code> 和 <code>path</code> 都应以 <code>/</code> 结尾，确保前缀匹配精确</td></tr><tr><td><strong>支持相对路径</strong></td><td>推荐使用相对于项目根目录的路径</td></tr><tr><td><strong>支持环境变量</strong></td><td>如 <code>${HOME}/.foundry/lib/...</code>（需 shell 解析）</td></tr><tr><td><strong>空行与注释</strong></td><td><code>#</code> 开头为注释，空行忽略</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-14"><strong>3.3 工作流程解析</strong></h4>
<p>当编译器遇到：</p>
<pre><code class="hljs language-solidity" lang="solidity">import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
</code></pre>
<ol>
<li><strong>解析前缀</strong>：<code>@openzeppelin/</code></li>
<li><strong>查找 remapping</strong>：在 <code>remappings.txt</code> 中找到 <code>@openzeppelin/=lib/openzeppelin-contracts/</code></li>
<li><strong>路径替换</strong>：
<ul>
<li>原路径：<code>@openzeppelin/contracts/token/ERC20/ERC20.sol</code></li>
<li>替换后：<code>lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol</code></li>
</ul>
</li>
<li><strong>文件读取</strong>：从该物理路径加载源码</li>
</ol>
<blockquote>
<p>⚠️ <strong>注意</strong>：remapping 是<strong>前缀匹配</strong>，因此顺序很重要。长前缀应放在短前缀之前，避免冲突。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15"><strong>4. 与 foundry.toml 的集成</strong></h3>
<p>从 <code>foundry-cli v0.10+</code> 起，<code>remappings</code> 可直接在 <code>foundry.toml</code> 中定义：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[profile.default]</span>
<span class="hljs-attr">src</span> = <span class="hljs-string">"src"</span>
<span class="hljs-attr">out</span> = <span class="hljs-string">"out"</span>
<span class="hljs-attr">libs</span> = [<span class="hljs-string">"lib"</span>]

<span class="hljs-comment"># 方式一：字符串数组</span>
<span class="hljs-attr">remappings</span> = [
    <span class="hljs-string">"@openzeppelin/=lib/openzeppelin-contracts/"</span>,
    <span class="hljs-string">"@solmate/=lib/solmate/src/"</span>
]

<span class="hljs-comment"># 方式二：键值对（v0.90+ 支持）</span>
<span class="hljs-section">[remappings]</span>
<span class="hljs-attr">"@openzeppelin/"</span> = <span class="hljs-string">"lib/openzeppelin-contracts/"</span>
<span class="hljs-attr">"@solmate/"</span> = <span class="hljs-string">"lib/solmate/src/"</span>
<span class="hljs-attr">"src/"</span> = <span class="hljs-string">"src/"</span>
</code></pre>
<blockquote>
<p>✅ <strong>建议</strong>：对于简单项目，使用 <code>foundry.toml</code>；复杂项目建议使用 <code>remappings.txt</code> 保持清晰。</p>
</blockquote>
<hr/>
<h3 data-id="heading-16"><strong>5. 实际应用示例</strong></h3>
<h4 data-id="heading-17"><strong>5.1 标准项目结构</strong></h4>
<pre><code class="hljs language-bash" lang="bash">my-project/
├── src/
│   └── Token.sol
├── <span class="hljs-built_in">test</span>/
│   └── Token.t.sol
├── lib/
│   └── openzeppelin-contracts/
├── remappings.txt
└── foundry.toml
</code></pre>
<h4 data-id="heading-18"><strong>5.2 remappings.txt 内容</strong></h4>
<pre><code class="hljs language-txt" lang="txt">@openzeppelin/=lib/openzeppelin-contracts/
src/=src/
test/=test/
</code></pre>
<h4 data-id="heading-19"><strong>5.3 在 Solidity 中使用</strong></h4>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "src/lib/Utils.sol";

contract MyToken is ERC20 {
    constructor() ERC20("MyToken", "MTK") {}
}
</code></pre>
<hr/>
<h3 data-id="heading-20"><strong>6. 高级技巧与最佳实践</strong></h3>
<h4 data-id="heading-21"><strong>6.1 使用 forge install 自动管理 remappings</strong></h4>
<pre><code class="hljs language-bash" lang="bash">forge install OpenZeppelin/openzeppelin-contracts
</code></pre>
<p>此命令会：</p>
<ol>
<li>克隆仓库到 <code>lib/openzeppelin-contracts</code></li>
<li><strong>自动生成 remapping</strong>（如果 <code>remappings.txt</code> 不存在）</li>
<li>添加 <code>.gitmodules</code>（如果使用 git）</li>
</ol>
<blockquote>
<p>✅ <strong>推荐</strong>：始终使用 <code>forge install</code> 管理第三方依赖。</p>
</blockquote>
<hr/>
<h4 data-id="heading-22"><strong>6.2 多版本库共存（高级）</strong></h4>
<p>有时需要同时使用不同版本的库：</p>
<pre><code class="hljs language-txt" lang="txt"># remappings.txt
@oz/4.9/=lib/oz-4.9/
@oz/5.0/=lib/oz-5.0/
</code></pre>
<pre><code class="hljs language-solidity" lang="solidity">import "@oz/4.9/contracts/token/ERC20/ERC20.sol";
import "@oz/5.0/contracts/token/ERC721/ERC721.sol";
</code></pre>
<hr/>
<h4 data-id="heading-23"><strong>6.3 路径冲突与调试</strong></h4>
<h5 data-id="heading-24"><strong>常见问题</strong></h5>
<ul>
<li><code>File not found</code>：remapping 前缀未正确匹配</li>
<li><code>Duplicate import</code>：多个 remapping 匹配同一路径</li>
</ul>
<h5 data-id="heading-25"><strong>调试命令</strong></h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前 remappings 配置</span>
forge config --remappings

<span class="hljs-comment"># 编译时显示详细路径解析</span>
forge build --verbose
</code></pre>
<hr/>
<h4 data-id="heading-26"><strong>6.4 支持符号链接（Symlinks）</strong></h4>
<p>在 <code>remappings.txt</code> 中可指向符号链接：</p>
<pre><code class="hljs language-txt" lang="txt">@mylib/=../../shared-libs/mylib/
</code></pre>
<p>适用于 monorepo 架构。</p>
<hr/>
<h3 data-id="heading-27"><strong>7. 常见问题（FAQ）</strong></h3>
<h4 data-id="heading-28"><strong>Q1: remappings.txt 和 libs 的区别？</strong></h4>
<ul>
<li><code>libs</code>：指定依赖库的根目录（如 <code>lib/</code>）</li>
<li><code>remappings.txt</code>：定义具体 import 路径到物理路径的映射</li>
<li>二者配合使用：<code>libs</code> 告诉 forge 去哪找库，<code>remappings</code> 告诉如何解析 import</li>
</ul>
<h4 data-id="heading-29"><strong>Q2: 是否必须使用 @ 符号？</strong></h4>
<p>否。<code>@</code> 只是约定（类似 npm 的 scope），你可以使用：</p>
<pre><code class="hljs language-txt" lang="txt">oz/=lib/openzeppelin-contracts/
contracts/=src/
</code></pre>
<p>但 <code>@</code> 更清晰，推荐使用。</p>
<h4 data-id="heading-30"><strong>Q3: remappings 是否支持 glob 模式？</strong></h4>
<p>不支持。remappings 是精确前缀匹配，不支持通配符。</p>
<hr/>
<h3 data-id="heading-31"><strong>8. 最佳实践总结</strong></h3>

































<table><thead><tr><th>实践</th><th>说明</th></tr></thead><tbody><tr><td>✅ 使用 <code>forge install</code> 安装依赖</td><td>自动处理 remappings</td></tr><tr><td>✅ 保持 <code>remappings.txt</code> 清晰</td><td>每行一个映射，添加注释</td></tr><tr><td>✅ 在 <code>foundry.toml</code> 中统一配置</td><td>提高可移植性</td></tr><tr><td>✅ 使用 <code>@scope/</code> 命名约定</td><td>提升可读性</td></tr><tr><td>✅ 避免循环依赖</td><td>检查 remapping 是否导致无限递归</td></tr><tr><td>✅ 提交 <code>remappings.txt</code> 到版本控制</td><td>确保团队一致性</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-32"><strong>9. 未来展望（2025+）</strong></h3>
<ul>
<li><strong>智能 remapping 推荐</strong>：<code>forge init</code> 自动检测常用库并生成 remappings</li>
<li><strong>remapping 版本锁定</strong>：类似 <code>package-lock.json</code>，确保依赖一致性</li>
<li><strong>IDE 深度集成</strong>：Remapping 错误实时提示（VS Code, JetBrains）</li>
</ul>
<hr/>
<h3 data-id="heading-33"><strong>10. 参考资料</strong></h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgetfoundry.sh%2Fguides%2Fproject-setup%2Fdependencies%23remapping-conflicts" target="_blank" title="https://getfoundry.sh/guides/project-setup/dependencies#remapping-conflicts" ref="nofollow noopener noreferrer">Foundry 官方文档 - Remappings</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.soliditylang.org%2Fen%2Flatest%2Flayout-of-source-files.html%23import-paths" target="_blank" title="https://docs.soliditylang.org/en/latest/layout-of-source-files.html#import-paths" ref="nofollow noopener noreferrer">Solidity 文档 - Import Paths</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffoundry-rs%2Ffoundry" target="_blank" title="https://github.com/foundry-rs/foundry" ref="nofollow noopener noreferrer">Foundry GitHub 仓库</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreadLocal 内存泄漏深度解析：原因、避坑指南与业务最佳实践]]></title>    <link>https://juejin.cn/post/7584357116434055209</link>    <guid>https://juejin.cn/post/7584357116434055209</guid>    <pubDate>2025-12-17T01:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584357116434055209" data-draft-id="7584057497206931499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreadLocal 内存泄漏深度解析：原因、避坑指南与业务最佳实践"/> <meta itemprop="keywords" content="Java,面试"/> <meta itemprop="datePublished" content="2025-12-17T01:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李拾叁的摸鱼日常"/> <meta itemprop="url" content="https://juejin.cn/user/4443539294129722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreadLocal 内存泄漏深度解析：原因、避坑指南与业务最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443539294129722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李拾叁的摸鱼日常
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:43:04.000Z" title="Wed Dec 17 2025 01:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ThreadLocal 是 Java 中用于实现「线程本地存储」的核心工具，能让每个线程拥有独立的变量副本，避免多线程共享变量的并发问题。但它常被诟病「存在内存泄漏风险」—— 多数开发者只知有风险，却不清楚<strong>为什么会泄漏</strong>、<strong>哪些场景会泄漏</strong>，更不知道如何从根源规避。本文从底层原理、泄漏链路、避坑手段到业务实践，全方位拆解 ThreadLocal 的内存泄漏问题。</p>
<h2 data-id="heading-0">一、先澄清：关于 ThreadLocal 内存泄漏的核心误解</h2>
<p>很多人认为「ThreadLocal 的弱引用设计导致了内存泄漏」，这是典型的本末倒置：</p>
<ul>
<li>❌ 误区：弱引用是内存泄漏的「原因」；</li>
<li>✅ 正解：弱引用是内存泄漏的「触发条件」，核心原因是 <strong>ThreadLocalMap 中 Value 的强引用 + 线程长期存活</strong>，弱引用只是让问题暴露出来。</li>
</ul>
<p>要理解泄漏原因，必须先搞懂 ThreadLocal 的底层存储结构。</p>
<h2 data-id="heading-1">二、ThreadLocal 底层存储结构（泄漏的根源基础）</h2>
<p>ThreadLocal 并非直接存储数据，而是通过「线程-ThreadLocalMap-Entry」的三层结构实现线程隔离，这是理解泄漏的关键：</p>
<h3 data-id="heading-2">1. 核心结构关系（文字图解）</h3>
<pre><code class="hljs language-scss" lang="scss">Thread (线程对象)
└── ThreadLocalMap (线程的成员变量，每个 Thread 独有一份)
    └── Entry<span class="hljs-selector-attr">[]</span> (数组，存储多个 ThreadLocal 的键值对)
        └── Entry (键值对)
            ├── key：WeakReference&lt;ThreadLocal&lt;?&gt;&gt; (对 ThreadLocal 对象的弱引用)
            └── value：<span class="hljs-selector-tag">Object</span> (实际存储的线程本地变量，强引用指向业务数据)
</code></pre>
<h3 data-id="heading-3">2. 关键设计细节</h3>
<ul>
<li><strong>ThreadLocalMap 归属</strong>：ThreadLocalMap 是 <code>Thread</code> 类的成员变量（而非 ThreadLocal 类），即「线程持有 Map，Map 存储 ThreadLocal 的值」；</li>
<li><strong>Key 的弱引用</strong>：Entry 的 key 是 ThreadLocal 的弱引用（<code>WeakReference</code>），意味着当 ThreadLocal 对象失去强引用时，GC 会直接回收这个 key；</li>
<li><strong>Value 的强引用</strong>：Entry 的 value 是对业务数据的强引用，只要这个强引用不被断开，业务数据就无法被 GC 回收。</li>
</ul>
<h2 data-id="heading-4">三、ThreadLocal 内存泄漏的完整触发链路</h2>
<p>内存泄漏的本质是「无用的对象无法被 GC 回收，长期占用内存」。ThreadLocal 的泄漏需满足 <strong>3 个核心条件</strong>，缺一不可：</p>
<h3 data-id="heading-5">步骤 1：正常使用 ThreadLocal（存储数据）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 创建 ThreadLocal 对象（假设为局部变量）</span>
ThreadLocal&lt;String&gt; userContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
<span class="hljs-comment">// 2. 存储数据到当前线程的 ThreadLocalMap 中</span>
userContext.set(<span class="hljs-string">"用户ID：1001"</span>);
</code></pre>
<p>此时，当前线程的 ThreadLocalMap 中会生成一个 Entry：</p>
<ul>
<li>key：弱引用指向 <code>userContext</code>（ThreadLocal 对象）；</li>
<li>value：强引用指向字符串「用户ID：1001」。</li>
</ul>
<h3 data-id="heading-6">步骤 2：ThreadLocal 对象失去强引用（触发弱引用回收）</h3>
<p>如果 <code>userContext</code> 是局部变量（如方法内定义），方法执行完毕后，<code>userContext</code> 这个强引用会被销毁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">()</span> {
    ThreadLocal&lt;String&gt; userContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    userContext.set(<span class="hljs-string">"用户ID：1001"</span>);
    <span class="hljs-comment">// 方法执行完毕，userContext 强引用消失</span>
}
</code></pre>
<p>此时，Entry 的 key（弱引用）成为 ThreadLocal 对象的「唯一引用」。</p>
<h3 data-id="heading-7">步骤 3：GC 触发 → Key 被回收，Entry 变成「脏条目」</h3>
<p>当 JVM 执行 GC 时，弱引用的特性会触发：<strong>只要对象仅被弱引用指向，就会被 GC 回收</strong>。</p>
<ul>
<li>Entry 的 key 被回收，变为 <code>null</code>；</li>
<li>Entry 的 value 仍为强引用（指向「用户ID：1001」），且 ThreadLocalMap 不会自动清理「key 为 null」的 Entry；</li>
<li>此时这个 Entry 被称为「脏条目（Dirty Entry）」—— 无可用 key，但 value 仍占用内存。</li>
</ul>
<h3 data-id="heading-8">步骤 4：线程长期存活 → Value 永久无法回收（泄漏核心）</h3>
<p>如果当前线程是「线程池中的线程」（如 Tomcat 线程池、业务自定义线程池），线程会被复用且长期存活：</p>
<ul>
<li>Thread 存活 → ThreadLocalMap 存活 → 脏条目（key=null，value=强引用）存活；</li>
<li>只要线程不结束，value 就无法被 GC 回收，内存被持续占用；</li>
<li>若大量线程产生脏条目，且 value 是大对象（如字节数组、大集合），最终会触发 OOM（内存溢出）。</li>
</ul>
<h3 data-id="heading-9">关键结论：泄漏的核心原因</h3>
<ol>
<li><strong>直接原因</strong>：Entry 的 value 是强引用，且 ThreadLocalMap 未自动清理 null key 的 Entry；</li>
<li><strong>根本原因</strong>：线程长期存活（如线程池复用），导致脏条目无法被回收；</li>
<li><strong>触发条件</strong>：ThreadLocal 对象失去强引用，GC 回收了弱引用的 key。</li>
</ol>
<h2 data-id="heading-10">四、ThreadLocal 内存泄漏的高发场景</h2>
<p>并非所有使用 ThreadLocal 的场景都会泄漏，以下是最易触发泄漏的 4 类场景：</p>



































<table><thead><tr><th>高发场景</th><th>泄漏风险</th><th>核心原因</th></tr></thead><tbody><tr><td>线程池 + 未调用 remove()</td><td>极高</td><td>线程复用，脏条目长期堆积，value 无法回收</td></tr><tr><td>Web 容器（Tomcat/Jetty） + 未清理 ThreadLocal</td><td>极高</td><td>Web 容器的线程池复用，请求结束后线程不销毁</td></tr><tr><td>ThreadLocal 持有大对象（如 100MB 字节数组）</td><td>极高</td><td>少量脏条目就会快速耗尽内存</td></tr><tr><td>静态 ThreadLocal + 线程池</td><td>中高</td><td>静态 ThreadLocal 强引用不会消失（key 不回收），但 value 会被覆盖，若未覆盖则长期占用</td></tr><tr><td>普通线程（非线程池） + 未调用 remove()</td><td>低</td><td>线程执行完毕后会被销毁，ThreadLocalMap 也会被回收，value 随之释放</td></tr></tbody></table>
<h2 data-id="heading-11">五、ThreadLocal 避坑指南（针对性解决泄漏问题）</h2>
<p>避坑的核心原则是：<strong>切断 Value 的强引用，或让线程及时销毁</strong>。以下是 6 条可落地的避坑手段，按优先级排序：</p>
<h3 data-id="heading-12">1. 核心避坑：使用后必须手动调用 remove()（优先级★★★★★）</h3>
<p>这是解决内存泄漏最直接、最有效的手段 —— <code>remove()</code> 会主动清理当前 ThreadLocal 对应的 Entry，断开 Value 的强引用，让 GC 能回收数据。</p>
<h4 data-id="heading-13">正确用法：try-finally 包裹，确保 remove() 执行</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">()</span> {
    ThreadLocal&lt;String&gt; userContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">try</span> {
        userContext.set(<span class="hljs-string">"用户ID：1001"</span>);
        <span class="hljs-comment">// 业务逻辑处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> userContext.get();
        System.out.println(<span class="hljs-string">"处理用户："</span> + userId);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 无论是否异常，都清理 ThreadLocal</span>
        userContext.remove(); 
    }
}
</code></pre>
<h4 data-id="heading-14">关键说明：</h4>
<ul>
<li><code>finally</code> 块能保证即使业务逻辑抛出异常，<code>remove()</code> 也会执行；</li>
<li>若不使用 <code>finally</code>，异常会跳过 <code>remove()</code>，直接导致泄漏。</li>
</ul>
<h3 data-id="heading-15">2. 线程池场景：任务执行完毕后强制清理（优先级★★★★★）</h3>
<p>线程池的线程是复用的，必须在「任务执行完毕」时清理 ThreadLocal，否则下一个任务可能读取到旧值（脏数据）+ 内存泄漏。</p>
<h4 data-id="heading-16">示例：线程池任务中使用 ThreadLocal</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义线程池</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

<span class="hljs-comment">// 提交任务</span>
executor.submit(() -&gt; {
    ThreadLocal&lt;String&gt; taskContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">try</span> {
        taskContext.set(<span class="hljs-string">"任务ID：20251216"</span>);
        <span class="hljs-comment">// 任务业务逻辑</span>
        System.out.println(<span class="hljs-string">"执行任务："</span> + taskContext.get());
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 任务结束，强制清理</span>
        taskContext.remove(); 
    }
});
</code></pre>
<h4 data-id="heading-17">进阶方案：线程池包装器（自动清理）</h4>
<p>对线程池进行包装，任务执行后自动清理 ThreadLocal，避免开发者遗漏：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CleanableExecutorService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutorService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService delegate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CleanableExecutorService</span><span class="hljs-params">(ExecutorService delegate)</span> {
        <span class="hljs-built_in">this</span>.delegate = delegate;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> {
        <span class="hljs-keyword">return</span> delegate.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> task.call();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 清理当前线程的所有 ThreadLocal（慎用，可能清理框架的 ThreadLocal）</span>
                <span class="hljs-comment">// 推荐：只清理业务自己的 ThreadLocal，而非全部</span>
                clearThreadLocal();
            }
        });
    }

    <span class="hljs-comment">// 清理指定的 ThreadLocal（推荐）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearThreadLocal</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 示例：清理业务自定义的 ThreadLocal</span>
        UserContextHolder.remove();
        TaskContextHolder.remove();
    }

    <span class="hljs-comment">// 其他方法（submit(Runnable)、execute 等）同理包装</span>
}
</code></pre>
<h3 data-id="heading-18">3. 避免 ThreadLocal 持有大对象（优先级★★★★）</h3>
<p>即使发生泄漏，小对象（如 String、Integer）对内存的影响也有限；但如果 ThreadLocal 存储大对象（如 100MB 的字节数组、包含上万条数据的 List），少量泄漏就会快速耗尽内存。</p>
<h4 data-id="heading-19">做法：</h4>
<ul>
<li>尽量存储「轻量级数据」（如 ID、标识、配置项），而非完整的大对象；</li>
<li>若必须存储大对象，使用后不仅要 <code>remove()</code>，还要手动将 value 置 null：
<pre><code class="hljs language-java" lang="java">ThreadLocal&lt;<span class="hljs-type">byte</span>[]&gt; bigDataLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
<span class="hljs-keyword">try</span> {
    bigDataLocal.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">100</span>]); <span class="hljs-comment">// 100MB</span>
    <span class="hljs-comment">// 业务处理</span>
} <span class="hljs-keyword">finally</span> {
    bigDataLocal.remove(); <span class="hljs-comment">// 清理 Entry</span>
    <span class="hljs-comment">// 额外：断开大对象的强引用（双重保障）</span>
    <span class="hljs-type">byte</span>[] data = bigDataLocal.get();
    <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) {
        data = <span class="hljs-literal">null</span>;
    }
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-20">4. 慎用静态 ThreadLocal（优先级★★★）</h3>
<p>静态 ThreadLocal 的生命周期与应用一致（强引用不会消失），因此 Entry 的 key 不会被 GC 回收（不会出现 null key），看似不会泄漏，但存在两个问题：</p>
<ul>
<li><strong>内存长期占用</strong>：静态 ThreadLocal 的 value 会随线程存活而长期占用内存；</li>
<li><strong>脏数据问题</strong>：线程池复用线程时，下一个任务会读取到上一个任务的 value。</li>
</ul>
<h4 data-id="heading-21">正确用法：静态 ThreadLocal 需手动清理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 静态 ThreadLocal（用户上下文）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;String&gt; USER_CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUser</span><span class="hljs-params">(String userId)</span> {
    USER_CONTEXT.set(userId);
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> USER_CONTEXT.get();
}

<span class="hljs-comment">// 必须提供清理方法，在业务结束后调用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
    USER_CONTEXT.remove();
}
</code></pre>
<h3 data-id="heading-22">5. 监控 ThreadLocal 使用状态（优先级★★★）</h3>
<p>通过工具监控 ThreadLocal 的使用情况，提前发现泄漏风险：</p>
<ul>
<li><strong>工具选型</strong>：Arthas、VisualVM、JProfiler；</li>
<li><strong>监控指标</strong>：
<ol>
<li>每个线程的 ThreadLocalMap 中 Entry 数量（正常应少量，泄漏时会持续增长）；</li>
<li>null key 的 Entry 数量（脏条目数）；</li>
<li>ThreadLocal 存储的对象大小。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-23">示例：Arthas 查看 ThreadLocal 信息</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看指定线程的 ThreadLocal 详情（替换为线程 ID）</span>
thread -t &lt;线程ID&gt;
<span class="hljs-comment"># 查看 JVM 中所有 ThreadLocal 的统计</span>
jvm threadlocal
</code></pre>
<h3 data-id="heading-24">6. 避免 ThreadLocal 跨线程传递（优先级★★★）</h3>
<p>ThreadLocal 的数据仅属于当前线程，若在异步任务（如 CompletableFuture、线程池）中使用，容易出现「数据丢失+泄漏」：</p>
<ul>
<li>错误做法：在主线程 set ThreadLocal，异步任务中 get（获取不到，且主线程的 ThreadLocal 若未清理会泄漏）；</li>
<li>正确做法：异步任务内部独立 set ThreadLocal，用完后 remove()：
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主线程</span>
ThreadLocal&lt;String&gt; mainLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
mainLocal.set(<span class="hljs-string">"主线程数据"</span>);

<span class="hljs-comment">// 异步任务</span>
CompletableFuture.runAsync(() -&gt; {
    ThreadLocal&lt;String&gt; asyncLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">try</span> {
        asyncLocal.set(<span class="hljs-string">"异步任务数据"</span>);
        <span class="hljs-comment">// 业务处理</span>
    } <span class="hljs-keyword">finally</span> {
        asyncLocal.remove();
    }
});

<span class="hljs-comment">// 主线程清理</span>
mainLocal.remove();
</code></pre>
</li>
</ul>
<h2 data-id="heading-25">六、ThreadLocal 业务场景最佳实践</h2>
<p>ThreadLocal 并非「洪水猛兽」，只要使用得当，是解决线程隔离问题的利器。以下是 5 个核心业务场景的最佳实践：</p>
<h3 data-id="heading-26">场景 1：Web 请求上下文传递（最常用）</h3>
<p><strong>业务需求</strong>：在 Web 请求的整个链路中（控制器、服务、DAO），传递登录用户信息、请求 ID 等，无需层层传参。
<strong>最佳实践</strong>：</p>
<ol>
<li>在拦截器/过滤器中 set 上下文数据；</li>
<li>在拦截器的 <code>afterCompletion</code> 方法中 remove（请求结束必清理）；</li>
<li>封装工具类，统一管理 ThreadLocal 的 set/get/remove。</li>
</ol>
<h4 data-id="heading-27">示例：Spring MVC 拦截器实现用户上下文传递</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 上下文工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContextHolder</span> {
    <span class="hljs-comment">// 静态 ThreadLocal，封装 set/get/remove</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserDTO&gt; USER_CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">UserContextHolder</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUser</span><span class="hljs-params">(UserDTO user)</span> {
        USER_CONTEXT.set(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserDTO <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> USER_CONTEXT.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        USER_CONTEXT.remove();
    }
}

<span class="hljs-comment">// 2. 拦截器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContextInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 从请求头/Token 中解析用户信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"userId"</span>);
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>(userId, <span class="hljs-string">"用户名"</span>);
        <span class="hljs-comment">// 设置上下文</span>
        UserContextHolder.setUser(user);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> {
        <span class="hljs-comment">// 请求结束，强制清理（核心！）</span>
        UserContextHolder.clear();
    }
}

<span class="hljs-comment">// 3. 业务层使用</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 无需传参，直接获取用户上下文</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserContextHolder.getUser();
        System.out.println(<span class="hljs-string">"为用户 "</span> + user.getUserId() + <span class="hljs-string">" 创建订单"</span>);
    }
}
</code></pre>
<h3 data-id="heading-28">场景 2：数据库连接/事务管理</h3>
<p><strong>业务需求</strong>：每个线程持有独立的数据库连接，避免多线程共享连接导致事务混乱（如 JDBC、MyBatis 底层）。
<strong>最佳实践</strong>：</p>
<ol>
<li>获取连接时 set 到 ThreadLocal；</li>
<li>事务提交/回滚后，关闭连接并 remove()；</li>
<li>异常场景下强制清理，避免连接泄漏+ThreadLocal 泄漏。</li>
</ol>
<h4 data-id="heading-29">示例：简易数据库连接管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Connection&gt; CONN_CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DataSource</span> <span class="hljs-variable">DATA_SOURCE</span> <span class="hljs-operator">=</span> getDataSource();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> CONN_CONTEXT.get();
        <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) {
            conn = DATA_SOURCE.getConnection();
            CONN_CONTEXT.set(conn);
        }
        <span class="hljs-keyword">return</span> conn;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> CONN_CONTEXT.get();
        <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                conn.close();
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 清理 Connection 和 ThreadLocal</span>
                CONN_CONTEXT.remove();
            }
        }
    }
}

<span class="hljs-comment">// 业务使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeSql</span><span class="hljs-params">(String sql)</span> {
    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        conn = ConnectionHolder.getConnection();
        <span class="hljs-comment">// 执行 SQL</span>
    } <span class="hljs-keyword">finally</span> {
        ConnectionHolder.closeConnection();
    }
}
</code></pre>
<h3 data-id="heading-30">场景 3：线程级缓存（避免重复计算）</h3>
<p><strong>业务需求</strong>：同一个线程内多次调用某个方法，避免重复查询数据库/调用接口（如获取用户权限）。
<strong>最佳实践</strong>：</p>
<ol>
<li>ThreadLocal 存储缓存数据，首次查询后存入，后续直接获取；</li>
<li>方法执行完毕后 remove()，避免缓存数据长期占用内存；</li>
<li>缓存数据需设置有效期（可选），避免脏缓存。</li>
</ol>
<h4 data-id="heading-31">示例：线程级权限缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionService</span> {
    <span class="hljs-comment">// 线程级缓存：用户ID → 权限列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Map&lt;String, List&lt;String&gt;&gt;&gt; PERM_CACHE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getPermissions</span><span class="hljs-params">(String userId)</span> {
        Map&lt;String, List&lt;String&gt;&gt; cache = PERM_CACHE.get();
        <span class="hljs-keyword">if</span> (cache == <span class="hljs-literal">null</span>) {
            cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            PERM_CACHE.set(cache);
        }
        <span class="hljs-comment">// 缓存命中，直接返回</span>
        <span class="hljs-keyword">if</span> (cache.containsKey(userId)) {
            <span class="hljs-keyword">return</span> cache.get(userId);
        }
        <span class="hljs-comment">// 缓存未命中，查询数据库</span>
        List&lt;String&gt; permissions = queryPermissionsFromDB(userId);
        cache.put(userId, permissions);
        <span class="hljs-keyword">return</span> permissions;
    }

    <span class="hljs-comment">// 清理缓存（业务结束后调用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearPermCache</span><span class="hljs-params">()</span> {
        PERM_CACHE.remove();
    }

    <span class="hljs-comment">// 模拟数据库查询</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">queryPermissionsFromDB</span><span class="hljs-params">(String userId)</span> {
        System.out.println(<span class="hljs-string">"查询数据库获取权限："</span> + userId);
        <span class="hljs-keyword">return</span> Arrays.asList(<span class="hljs-string">"order:create"</span>, <span class="hljs-string">"user:query"</span>);
    }
}

<span class="hljs-comment">// 业务使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPermissionCheck</span><span class="hljs-params">(String userId)</span> {
    <span class="hljs-type">PermissionService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionService</span>();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 第一次查询（查库）</span>
        List&lt;String&gt; perm1 = service.getPermissions(userId);
        <span class="hljs-comment">// 第二次查询（走缓存）</span>
        List&lt;String&gt; perm2 = service.getPermissions(userId);
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 清理缓存</span>
        service.clearPermCache();
    }
}
</code></pre>
<h3 data-id="heading-32">场景 4：分布式追踪（链路追踪）</h3>
<p><strong>业务需求</strong>：在分布式系统中，追踪一个请求的完整链路（如 SkyWalking、Zipkin），通过 TraceID 关联所有日志。
<strong>最佳实践</strong>：</p>
<ol>
<li>在入口处（网关/拦截器）生成 TraceID，set 到 ThreadLocal；</li>
<li>日志框架（如 Logback）配置 MDC，从 ThreadLocal 中获取 TraceID 打印；</li>
<li>请求结束后 remove()，避免 TraceID 污染后续请求。</li>
</ol>
<h4 data-id="heading-33">示例：TraceID 链路追踪</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TraceID 工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraceIdHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;String&gt; TRACE_ID = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    <span class="hljs-comment">// MDC 键名（日志框架使用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MDC_TRACE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"traceId"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTraceId</span><span class="hljs-params">(String traceId)</span> {
        TRACE_ID.set(traceId);
        <span class="hljs-comment">// 同步到 MDC，日志中可直接打印 %X{traceId}</span>
        MDC.put(MDC_TRACE_ID, traceId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTraceId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> TRACE_ID.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        TRACE_ID.remove();
        MDC.remove(MDC_TRACE_ID);
    }
}

<span class="hljs-comment">// 网关拦截器设置 TraceID</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraceIdInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-comment">// 生成 TraceID（UUID）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">traceId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
        TraceIdHolder.setTraceId(traceId);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> {
        TraceIdHolder.clear();
    }
}

<span class="hljs-comment">// 日志配置（logback.xml）</span>
&lt;appender name=<span class="hljs-string">"CONSOLE"</span> class=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;
    &lt;encoder&gt;
        &lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss} [%thread] [%X{traceId}] %-5level %logger{<span class="hljs-number">36</span>} - %msg%n&lt;/pattern&gt;
    &lt;/encoder&gt;
&lt;/appender&gt;
</code></pre>
<h3 data-id="heading-34">场景 5：避免参数泛滥（工具类优化）</h3>
<p><strong>业务需求</strong>：工具类中需要使用某些上下文数据（如当前语言、租户ID），避免在工具方法中层层传参。
<strong>最佳实践</strong>：</p>
<ol>
<li>工具类中封装 ThreadLocal，存储上下文数据；</li>
<li>提供明确的 set/clear 方法，在业务开始/结束时调用；</li>
<li>禁止工具类自动初始化 ThreadLocal，避免无意识泄漏。</li>
</ol>
<h4 data-id="heading-35">示例：租户ID 上下文工具</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;String&gt; TENANT_ID = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">TenantContextHolder</span><span class="hljs-params">()</span> {}

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTenantId</span><span class="hljs-params">(String tenantId)</span> {
        TENANT_ID.set(tenantId);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTenantId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> TENANT_ID.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        TENANT_ID.remove();
    }
}

<span class="hljs-comment">// 工具类使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataUtils</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;DataDTO&gt; <span class="hljs-title function_">queryData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 无需传参，获取当前租户ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">tenantId</span> <span class="hljs-operator">=</span> TenantContextHolder.getTenantId();
        <span class="hljs-keyword">return</span> queryDataByTenant(tenantId);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;DataDTO&gt; <span class="hljs-title function_">queryDataByTenant</span><span class="hljs-params">(String tenantId)</span> {
        <span class="hljs-comment">// 按租户查询数据</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}

<span class="hljs-comment">// 业务使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(String tenantId)</span> {
    <span class="hljs-keyword">try</span> {
        TenantContextHolder.setTenantId(tenantId);
        List&lt;DataDTO&gt; data = DataUtils.queryData();
    } <span class="hljs-keyword">finally</span> {
        TenantContextHolder.clear();
    }
}
</code></pre>
<h2 data-id="heading-36">七、常见误区纠正</h2>





























<table><thead><tr><th>误区</th><th>正确认知</th></tr></thead><tbody><tr><td>ThreadLocal 的弱引用是设计缺陷</td><td>弱引用是合理设计：若 key 是强引用，ThreadLocal 对象即使没用了，也会因 Thread 存活而无法回收，导致 ThreadLocal 本身泄漏。弱引用避免了这个问题，只是暴露了 Value 的泄漏风险。</td></tr><tr><td>只要用线程池就会泄漏</td><td>线程池本身不会导致泄漏，「线程池 + 未调用 remove()」才会。只要用完 remove()，线程池场景也安全。</td></tr><tr><td>静态 ThreadLocal 不会泄漏</td><td>静态 ThreadLocal 的 key 不会被回收（无 null key），但 value 会随线程存活而长期占用内存，若 value 是大对象，仍会导致内存占用过高，需手动清理。</td></tr><tr><td>ThreadLocal 是线程安全的，所以随便用</td><td>ThreadLocal 保证的是「线程隔离」（每个线程独立副本），而非「数据安全」。若在多线程中共享 ThreadLocal 对象，或未清理导致脏数据，仍会出现线程安全问题。</td></tr><tr><td>调用 get() 后返回 null 就是没泄漏</td><td>null 仅表示当前 ThreadLocal 无数据，不代表脏条目已被清理。需通过工具查看 ThreadLocalMap 的 Entry 数量，确认是否有泄漏。</td></tr></tbody></table>
<h2 data-id="heading-37">八、总结</h2>
<p>ThreadLocal 内存泄漏的核心逻辑可总结为：</p>
<pre><code class="hljs language-scss" lang="scss">Thread 长期存活（线程池） + Value 强引用 + 未调用 <span class="hljs-built_in">remove</span>() → 脏条目堆积 → 内存泄漏 → OOM
</code></pre>
<h3 data-id="heading-38">核心避坑口诀：</h3>
<ol>
<li>用完必 remove，finally 来守护；</li>
<li>线程池要注意，任务结束清数据；</li>
<li>大对象别存储，监控要跟得上；</li>
<li>静态 ThreadLocal，清理别忘记。</li>
</ol>
<p>ThreadLocal 是 Java 并发编程的重要工具，只要掌握其底层原理，严格遵循「用完即清理」的原则，就能既发挥其线程隔离的优势，又彻底规避内存泄漏风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring框架深度解析：从核心原理到企业级实战]]></title>    <link>https://juejin.cn/post/7584345932944244787</link>    <guid>https://juejin.cn/post/7584345932944244787</guid>    <pubDate>2025-12-17T01:47:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584345932944244787" data-draft-id="7584345932944212019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring框架深度解析：从核心原理到企业级实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-17T01:47:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树洞RoBot"/> <meta itemprop="url" content="https://juejin.cn/user/3782758452434311"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring框架深度解析：从核心原理到企业级实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782758452434311/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树洞RoBot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T01:47:18.000Z" title="Wed Dec 17 2025 01:47:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<blockquote>
<p>掌握Spring框架的IoC容器、依赖注入和AOP面向切面编程，成为高水准Java工程师的必经之路</p>
</blockquote>
<p>Spring框架作为Java企业级开发的事实标准，已经成为了每个Java开发者必须掌握的核心技能。本文将深入剖析Spring框架的设计思想、核心原理以及企业级应用实践，帮助开发者真正理解并高效运用这一强大框架。</p>
<h3 data-id="heading-1">一、Spring框架概述与设计哲学</h3>
<p>Spring框架由Rod Johnson在2002年创建，最初目的是解决企业级Java应用开发中的复杂性问题。经过二十多年的发展，Spring已经从最初的简单框架演变为一个<strong>全面的开发生态系统</strong>，涵盖了Web开发、数据访问、安全、批处理等各个方面。 Spring的核心设计理念是 <strong>"简化Java开发"</strong> ，它通过依赖注入（DI）、面向切面编程（AOP）和模块化设计，极大地降低了企业级应用的开发复杂度。Spring的非侵入式设计使得应用程序对框架的依赖最小化，保持了代码的纯净性和可测试性。</p>
<h3 data-id="heading-2">二、Spring核心机制深度解析</h3>
<h4 data-id="heading-3">2.1 控制反转（IoC）与依赖注入（DI）</h4>
<p><strong>控制反转</strong>是Spring框架的基石，它通过将对象的创建和依赖关系的管理权从应用程序代码转移给外部容器，实现了组件之间的<strong>松耦合</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统方式：在代码中直接创建依赖对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserDAO</span> <span class="hljs-variable">userDAO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDAOImpl</span>(); <span class="hljs-comment">// 紧耦合</span>
}

<span class="hljs-comment">// Spring方式：通过依赖注入</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> UserDAO userDAO;
    
    <span class="hljs-comment">// 构造函数注入</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserDAO userDAO)</span> {
        <span class="hljs-built_in">this</span>.userDAO = userDAO;
    }
}
</code></pre>
<p>Spring支持三种主要的依赖注入方式：<strong>构造函数注入</strong>、<strong>Setter方法注入</strong>和<strong>字段注入</strong>。其中，构造函数注入被推荐为首选方式，因为它保证了依赖不可变且完全初始化的对象。</p>
<h4 data-id="heading-4">2.2 IoC容器的实现机制</h4>
<p>Spring的IoC容器核心是<code>BeanFactory</code>接口及其实现类（如<code>DefaultListableBeanFactory</code>）。容器通过读取配置元数据（XML、注解或Java配置）来实例化、配置和组装应用程序对象。 Spring在管理Bean时广泛应用了<strong>单例模式</strong>，默认情况下每个Bean在容器中只有一个实例，这种设计节省了资源并提高了性能。</p>
<h3 data-id="heading-5">三、面向切面编程（AOP）原理与实践</h3>
<h4 data-id="heading-6">3.1 AOP的核心概念</h4>
<p><strong>面向切面编程</strong>允许开发者将横切关注点（如日志记录、事务管理、安全性等）从业务逻辑中分离出来，实现关注点的分离。 AOP的核心概念包括：</p>
<ul>
<li><strong>切面（Aspect）</strong> ：横切关注点的模块化，包含通知和切点</li>
<li><strong>连接点（Join point）</strong> ：程序执行过程中的特定点，如方法调用或异常抛出</li>
<li><strong>通知（Advice）</strong> ：在特定连接点执行的动作</li>
<li><strong>切点（Pointcut）</strong> ：匹配连接点的表达式</li>
</ul>
<h4 data-id="heading-7">3.2 Spring AOP的实现方式</h4>
<p>Spring通过<strong>代理模式</strong>实现AOP功能，支持两种代理机制：</p>
<ul>
<li><strong>JDK动态代理</strong>：基于接口的代理，要求目标类实现至少一个接口</li>
<li><strong>CGLIB动态代理</strong>：通过继承目标类生成子类来实现代理，适用于没有接口的类</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AOP切面示例</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingAspect</span> {
    
    <span class="hljs-meta">@Before("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logBefore</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        System.out.println(<span class="hljs-string">"执行方法: "</span> + joinPoint.getSignature().getName());
    }
    
    <span class="hljs-meta">@AfterReturning(pointcut = "execution(* com.example.service.*.*(..))", 
                    returning = "result")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAfterReturning</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {
        System.out.println(<span class="hljs-string">"方法返回: "</span> + result);
    }
}
</code></pre>
<h3 data-id="heading-8">四、Spring事务管理机制</h3>
<h4 data-id="heading-9">4.1 声明式事务管理</h4>
<p>Spring提供了强大的<strong>声明式事务管理</strong>，通过<code>@Transactional</code>注解可以轻松管理数据库事务。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserRepository</span> userRepository;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        userRepository.<span class="hljs-title function_">save</span>(user);
        <span class="hljs-comment">// 如果发生异常，事务将自动回滚</span>
    }
    
    <span class="hljs-meta">@Transactional</span>(readOnly = <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">findUserById</span>(<span class="hljs-params">Long id</span>) {
        <span class="hljs-keyword">return</span> userRepository.<span class="hljs-title function_">findById</span>(id);
    }
}
</code></pre>
<h4 data-id="heading-10">4.2 事务传播行为</h4>
<p>Spring定义了7种事务传播行为，其中最常用的是：</p>
<ul>
<li><strong>REQUIRED</strong>：如果当前存在事务，则加入该事务；如果不存在，则创建新事务</li>
<li><strong>REQUIRES_NEW</strong>：创建新事务，如果当前存在事务，则挂起当前事务</li>
<li><strong>SUPPORTS</strong>：如果当前存在事务，则加入该事务；否则以非事务方式执行</li>
</ul>
<h3 data-id="heading-11">五、Spring模块化设计与项目结构</h3>
<h4 data-id="heading-12">5.1 Spring的核心模块</h4>
<p>Spring框架采用<strong>高度模块化</strong>的设计，开发者可以根据需要选择使用特定模块：</p>
<ul>
<li><strong>Spring Core</strong>：IoC容器和核心工具类</li>
<li><strong>Spring Context</strong>：应用上下文运行时环境</li>
<li><strong>Spring AOP</strong>：面向切面编程支持</li>
<li><strong>Spring DAO</strong>：数据访问抽象和异常层次结构</li>
<li><strong>Spring ORM</strong>：对象关系映射集成支持</li>
<li><strong>Spring Web</strong>：Web开发相关功能</li>
<li><strong>Spring Test</strong>：测试支持</li>
</ul>
<h4 data-id="heading-13">5.2 标准项目结构</h4>
<p>一个典型的Spring项目遵循Maven标准目录布局：</p>
<pre><code class="hljs language-bash" lang="bash">src/
  main/
    java/              <span class="hljs-comment"># Java源代码</span>
      com/example/
        controller/    <span class="hljs-comment"># 控制层</span>
        service/       <span class="hljs-comment"># 业务逻辑层</span>
        repository/    <span class="hljs-comment"># 数据访问层</span>
        entity/        <span class="hljs-comment"># 实体类</span>
        config/        <span class="hljs-comment"># 配置类</span>
    resources/         <span class="hljs-comment"># 资源文件</span>
      application.yml <span class="hljs-comment"># 应用配置</span>
      static/         <span class="hljs-comment"># 静态资源</span>
      templates/      <span class="hljs-comment"># 模板文件</span>
  <span class="hljs-built_in">test</span>/
    java/              <span class="hljs-comment"># 测试代码</span>
    resources/         <span class="hljs-comment"># 测试资源[2](@ref)</span>
</code></pre>
<h3 data-id="heading-14">六、Spring Boot：简化Spring开发</h3>
<p>Spring Boot是Spring生态系统中的重要组成部分，它通过<strong>自动配置</strong>和<strong>约定优于配置</strong>的原则，极大地简化了Spring应用的开发和部署。</p>
<h4 data-id="heading-15">6.1 Spring Boot的核心特性</h4>
<ul>
<li><strong>自动配置</strong>：根据类路径中的jar包依赖，自动配置Spring应用</li>
<li><strong>起步依赖</strong>：简化Maven配置，提供一站式的依赖解决方案</li>
<li><strong>嵌入式容器</strong>：内置Tomcat、Jetty或Undertow服务器，无需部署WAR文件</li>
<li><strong>Actuator</strong>：提供生产级监控和管理端点</li>
</ul>
<h4 data-id="heading-16">6.2 创建一个简单的Spring Boot应用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>, args);
    }
}

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hello"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, Spring Boot!"</span>;
    }
}
</code></pre>
<p>只需几行代码，就可以启动一个完整的Web应用程序，这体现了Spring Boot<strong>高效开发</strong>的理念。</p>
<h3 data-id="heading-17">七、Spring企业级应用最佳实践</h3>
<h4 data-id="heading-18">7.1 依赖注入最佳实践</h4>
<ol>
<li><strong>面向接口编程</strong>：针对接口而非实现类进行编程，降低耦合度</li>
<li><strong>使用构造函数注入</strong>：保证依赖的不可变性和完全初始化</li>
<li><strong>避免循环依赖</strong>：通过设计模式或<code>@Lazy</code>注解解决循环依赖问题</li>
</ol>
<h4 data-id="heading-19">7.2 配置管理最佳实践</h4>
<ul>
<li><strong>使用配置类替代XML配置</strong>：利用<code>@Configuration</code>和<code>@Bean</code>注解</li>
<li><strong>多环境配置</strong>：通过Profile管理不同环境的配置</li>
<li><strong>外部化配置</strong>：将配置信息存储在application.yml或application.properties中</li>
</ul>
<h4 data-id="heading-20">7.3 异常处理最佳实践</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler(ResourceNotFoundException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="hljs-title function_">handleResourceNotFound</span><span class="hljs-params">(
            ResourceNotFoundException ex)</span> {
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-string">"NOT_FOUND"</span>, ex.getMessage());
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(error, HttpStatus.NOT_FOUND);
    }
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="hljs-title function_">handleGenericException</span><span class="hljs-params">(Exception ex)</span> {
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-string">"INTERNAL_ERROR"</span>, 
                <span class="hljs-string">"An unexpected error occurred"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(error, 
                HttpStatus.INTERNAL_SERVER_ERROR);
    }
}
</code></pre>
<h3 data-id="heading-21">八、Spring在微服务架构中的应用</h3>
<p>随着微服务架构的流行，Spring Cloud为构建分布式系统提供了全套解决方案：</p>
<ul>
<li><strong>服务发现</strong>：通过Eureka实现服务注册与发现</li>
<li><strong>配置管理</strong>：Spring Cloud Config实现分布式配置</li>
<li><strong>负载均衡</strong>：Ribbon实现客户端负载均衡</li>
<li><strong>断路器</strong>：Hystrix防止级联故障</li>
</ul>
<h3 data-id="heading-22">总结</h3>
<p>Spring框架通过其<strong>控制反转</strong>、<strong>依赖注入</strong>和<strong>面向切面编程</strong>等核心特性，为Java企业级开发提供了强大而灵活的基础设施。从传统的单体应用到的现代微服务架构，Spring生态系统不断演进，始终保持着在Java企业级开发领域的领先地位。 掌握Spring框架不仅需要理解其核心原理，还需要在实践中不断积累经验。通过遵循最佳实践，合理运用Spring的各种特性，开发者可以构建出<strong>高效、可维护、可扩展</strong>的企业级应用程序。</p>
<blockquote>
<p>随着云原生和微服务架构的普及，Spring Boot和Spring Cloud已成为现代Java开发的标准配置，深入理解Spring框架的原理与实战是每一位Java开发者的必修课。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Foundry 智能合约测试流程讲解指南]]></title>    <link>https://juejin.cn/post/7584345932943065139</link>    <guid>https://juejin.cn/post/7584345932943065139</guid>    <pubDate>2025-12-16T16:20:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584345932943065139" data-draft-id="7584266920642068531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Foundry 智能合约测试流程讲解指南"/> <meta itemprop="keywords" content="web3,智能合约"/> <meta itemprop="datePublished" content="2025-12-16T16:20:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RainWeb3"/> <meta itemprop="url" content="https://juejin.cn/user/599705882203355"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Foundry 智能合约测试流程讲解指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/599705882203355/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RainWeb3
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T16:20:50.000Z" title="Tue Dec 16 2025 16:20:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Foundry 智能合约测试流程讲解指南</h2>
<hr/>
<blockquote>
<p><strong>本文系统阐述如何编写高质量、高覆盖率、高鲁棒性的 Solidity 测试。适用于使用 Forge 进行智能合约开发的团队与个人开发者。</strong></p>
</blockquote>
<hr/>
<blockquote>
<p><strong>作者：RainWeb3</strong><br/>
<strong>更新时间：2025年11月8日</strong><br/>
<strong>目标读者：智能合约开发者、区块链工程师、DevOps 工程师</strong></p>
</blockquote>
<ul>
<li>新Github-国外访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Frainweb4.github.io%2F" target="_blank" title="https://rainweb4.github.io/" ref="nofollow noopener noreferrer">rainweb4.github.io/</a></li>
<li>新Github-国内访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRainweb4%2Frainweb3.github.io" target="_blank" title="https://github.com/Rainweb4/rainweb3.github.io" ref="nofollow noopener noreferrer">github.com/Rainweb4/ra…</a></li>
</ul>
<hr/>
<h3 data-id="heading-1">目录（可点击跳转）</h3>
<ol>
<li>
<p><a href="#1-foundry-%E6%94%AF%E6%8C%81%E7%9A%84%E5%85%AD%E5%A4%A7%E4%B8%BB%E6%B5%81%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E8%AF%A6%E8%A7%A3" title="#1-foundry-%E6%94%AF%E6%8C%81%E7%9A%84%E5%85%AD%E5%A4%A7%E4%B8%BB%E6%B5%81%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E8%AF%A6%E8%A7%A3">Foundry 支持的六大主流测试方式详解</a><br/>
1.1 <a href="#11-%E5%9F%BA%E7%A1%80%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95unit-test" title="#11-%E5%9F%BA%E7%A1%80%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95unit-test">基础单元测试（Unit Test）</a><br/>
1.2 <a href="#12-%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95fuzzing-test" title="#12-%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95fuzzing-test">模糊测试（Fuzzing Test）</a><br/>
1.3 <a href="#13-%E4%B8%8D%E5%8F%98%E9%87%8F%E6%B5%8B%E8%AF%95invariant-test--stateful-fuzzing" title="#13-%E4%B8%8D%E5%8F%98%E9%87%8F%E6%B5%8B%E8%AF%95invariant-test--stateful-fuzzing">不变量测试（Invariant Test / Stateful Fuzzing）</a><br/>
1.4 <a href="#14-%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95forking-test" title="#14-%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95forking-test">分叉测试（Forking Test）</a><br/>
1.5 <a href="#15-%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95parameterized-test" title="#15-%E5%8F%82%E6%95%B0%E5%8C%96%E6%B5%8B%E8%AF%95parameterized-test">参数化测试（Parameterized Test）</a><br/>
1.6 <a href="#16-%E5%BF%AB%E7%85%A7%E6%B5%8B%E8%AF%95snapshot-test" title="#16-%E5%BF%AB%E7%85%A7%E6%B5%8B%E8%AF%95snapshot-test">快照测试（Snapshot Test）</a></p>
</li>
<li>
<p><a href="#2-%E6%B5%8B%E8%AF%95%E7%B1%BB%E5%9E%8B%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E4%B8%8E%E7%BB%84%E5%90%88%E7%AD%96%E7%95%A5" title="#2-%E6%B5%8B%E8%AF%95%E7%B1%BB%E5%9E%8B%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E4%B8%8E%E7%BB%84%E5%90%88%E7%AD%96%E7%95%A5">测试类型命名规范与组合策略</a><br/>
2.1 <a href="#21-%E5%91%BD%E5%90%8D%E7%BA%A6%E5%AE%9A%E7%9A%84%E4%BD%9C%E7%94%A8" title="#21-%E5%91%BD%E5%90%8D%E7%BA%A6%E5%AE%9A%E7%9A%84%E4%BD%9C%E7%94%A8">命名约定的作用</a><br/>
2.2 <a href="#22-%E7%BB%84%E5%90%88%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B%E5%A6%82-testforkfuzz_revertwhen_" title="#22-%E7%BB%84%E5%90%88%E6%B5%8B%E8%AF%95%E7%A4%BA%E4%BE%8B%E5%A6%82-testforkfuzz_revertwhen_">组合测试示例（如 testForkFuzz_RevertWhen_）</a></p>
</li>
<li>
<p><a href="#3-%E6%96%AD%E8%A8%80%E4%B8%8E%E8%B0%83%E8%AF%95%E6%8F%90%E5%8D%87%E5%8F%AF%E8%AF%BB%E6%80%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D%E6%95%88%E7%8E%87" title="#3-%E6%96%AD%E8%A8%80%E4%B8%8E%E8%B0%83%E8%AF%95%E6%8F%90%E5%8D%87%E5%8F%AF%E8%AF%BB%E6%80%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%AE%9A%E4%BD%8D%E6%95%88%E7%8E%87">断言与调试：提升可读性与故障定位效率</a><br/>
3.1 <a href="#31-%E4%BD%BF%E7%94%A8%E6%8F%8F%E8%BF%B0%E6%80%A7%E6%96%AD%E8%A8%80%E6%B6%88%E6%81%AF" title="#31-%E4%BD%BF%E7%94%A8%E6%8F%8F%E8%BF%B0%E6%80%A7%E6%96%AD%E8%A8%80%E6%B6%88%E6%81%AF">使用描述性断言消息</a><br/>
3.2 <a href="#32-%E4%BA%8B%E4%BB%B6%E6%B5%8B%E8%AF%95%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#32-%E4%BA%8B%E4%BB%B6%E6%B5%8B%E8%AF%95%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">事件测试的最佳实践</a></p>
</li>
<li>
<p><a href="#4-%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95-vs-mock%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E6%9D%83%E8%A1%A1%E4%B8%8E%E9%80%89%E6%8B%A9" title="#4-%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95-vs-mock%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E6%9D%83%E8%A1%A1%E4%B8%8E%E9%80%89%E6%8B%A9">分叉测试 vs Mock：生产环境中的权衡与选择</a><br/>
4.1 <a href="#41-%E7%94%9F%E4%BA%A7%E4%B8%AD-mock-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%AF%94%E9%87%8D" title="#41-%E7%94%9F%E4%BA%A7%E4%B8%AD-mock-%E7%9A%84%E4%BD%BF%E7%94%A8%E6%AF%94%E9%87%8D">生产中 Mock 的使用比重</a><br/>
4.2 <a href="#42-mock-%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BB%B7%E5%80%BC" title="#42-mock-%E7%9A%84%E9%A2%9D%E5%A4%96%E4%BB%B7%E5%80%BC">Mock 的额外价值</a><br/>
4.3 <a href="#43-%E8%83%BD%E5%90%A6%E5%AE%8C%E5%85%A8%E4%B8%8D%E7%94%A8-mock%E5%BD%B1%E5%93%8D%E4%B8%8E%E9%A3%8E%E9%99%A9%E5%88%86%E6%9E%90" title="#43-%E8%83%BD%E5%90%A6%E5%AE%8C%E5%85%A8%E4%B8%8D%E7%94%A8-mock%E5%BD%B1%E5%93%8D%E4%B8%8E%E9%A3%8E%E9%99%A9%E5%88%86%E6%9E%90">能否完全不用 Mock？影响与风险分析</a></p>
</li>
<li>
<p><a href="#5-%E6%B5%8B%E8%AF%95-internalprivate-%E5%87%BD%E6%95%B0harness-%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3" title="#5-%E6%B5%8B%E8%AF%95-internalprivate-%E5%87%BD%E6%95%B0harness-%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3">测试 internal/private 函数：Harness 模式详解</a><br/>
5.1 <a href="#51-%E6%B5%8B%E8%AF%95-internal-%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B" title="#51-%E6%B5%8B%E8%AF%95-internal-%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%87%E5%87%86%E6%B5%81%E7%A8%8B">测试 internal 函数的标准流程</a><br/>
5.2 <a href="#52-private-%E5%87%BD%E6%95%B0%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88" title="#52-private-%E5%87%BD%E6%95%B0%E7%9A%84%E6%9B%BF%E4%BB%A3%E6%96%B9%E6%A1%88">private 函数的替代方案</a><br/>
5.3 <a href="#53-%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B" title="#53-%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B">完整示例</a></p>
</li>
<li>
<p><a href="#6-%E5%8F%98%E9%80%9A%E5%87%BD%E6%95%B0workaround-functions%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97" title="#6-%E5%8F%98%E9%80%9A%E5%87%BD%E6%95%B0workaround-functions%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97">“变通函数”（Workaround Functions）实战指南</a><br/>
6.1 <a href="#61-%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81-workaround" title="#61-%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81-workaround">为何需要 workaround？</a><br/>
6.2 <a href="#62-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83" title="#62-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83">实现方式与命名规范</a><br/>
6.3 <a href="#63-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%E5%B9%BD%E7%81%B5%E5%8F%98%E9%87%8Fghost-variables" title="#63-%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95%E5%B9%BD%E7%81%B5%E5%8F%98%E9%87%8Fghost-variables">高级用法：幽灵变量（Ghost Variables）</a></p>
</li>
<li>
<p><a href="#7-%E4%B8%8D%E5%8F%98%E5%BC%8F%E6%B5%8B%E8%AF%95invariant-tests%E4%BF%9D%E9%9A%9C%E7%B3%BB%E7%BB%9F%E9%B2%81%E6%A3%92%E6%80%A7%E7%9A%84%E6%A0%B8%E5%BF%83%E6%89%8B%E6%AE%B5" title="#7-%E4%B8%8D%E5%8F%98%E5%BC%8F%E6%B5%8B%E8%AF%95invariant-tests%E4%BF%9D%E9%9A%9C%E7%B3%BB%E7%BB%9F%E9%B2%81%E6%A3%92%E6%80%A7%E7%9A%84%E6%A0%B8%E5%BF%83%E6%89%8B%E6%AE%B5">不变式测试（Invariant Tests）：保障系统鲁棒性的核心手段</a><br/>
7.1 <a href="#71-%E4%BB%80%E4%B9%88%E6%98%AF%E9%B2%81%E6%A3%92%E6%80%A7" title="#71-%E4%BB%80%E4%B9%88%E6%98%AF%E9%B2%81%E6%A3%92%E6%80%A7">什么是鲁棒性？</a><br/>
7.2 <a href="#72-%E4%B8%8D%E5%8F%98%E5%BC%8F%E6%B5%8B%E8%AF%95%E5%9C%A8%E7%94%9F%E4%BA%A7%E4%B8%AD%E7%9A%84%E5%9C%B0%E4%BD%8D" title="#72-%E4%B8%8D%E5%8F%98%E5%BC%8F%E6%B5%8B%E8%AF%95%E5%9C%A8%E7%94%9F%E4%BA%A7%E4%B8%AD%E7%9A%84%E5%9C%B0%E4%BD%8D">不变式测试在生产中的地位</a><br/>
7.3 <a href="#73-%E4%B8%8E-mock%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95%E7%9A%84%E5%8D%8F%E5%90%8C%E4%BD%BF%E7%94%A8%E7%AD%96%E7%95%A5" title="#73-%E4%B8%8E-mock%E5%88%86%E5%8F%89%E6%B5%8B%E8%AF%95%E7%9A%84%E5%8D%8F%E5%90%8C%E4%BD%BF%E7%94%A8%E7%AD%96%E7%95%A5">与 Mock、分叉测试的协同使用策略</a></p>
</li>
<li>
<p><a href="#8-%E6%80%BB%E7%BB%93%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E9%9D%A0%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%B5%8B%E8%AF%95%E4%BD%93%E7%B3%BB" title="#8-%E6%80%BB%E7%BB%93%E6%9E%84%E5%BB%BA%E9%AB%98%E5%8F%AF%E9%9D%A0%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%B5%8B%E8%AF%95%E4%BD%93%E7%B3%BB">总结：构建高可靠智能合约测试体系</a></p>
</li>
</ol>
<hr/>
<h3 data-id="heading-2">1. Foundry 支持的六大主流测试方式详解</h3>
<h4 data-id="heading-3">1.1 基础单元测试（Unit Test）</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>最常见形式</li>
<li>函数名以 <code>test</code> 开头</li>
<li>每个测试独立（自动 <code>setUp()</code>）</li>
</ul>
<p>✅ <strong>适用场景</strong><br/>
验证单个函数的正确性、边界、revert 行为等。</p>
<p>✅ <strong>示例：<code>test/Counter.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test} from "forge-std/Test.sol";

contract Counter {
    uint256 public count;
    function inc() public returns (uint256) { return ++count; }
    function dec() public { require(count &gt; 0, "Underflow"); count--; }
}

contract CounterTest is Test {
    Counter public counter;

    function setUp() public {
        counter = new Counter();
    }

    function testInc() public {
        assertEq(counter.inc(), 1);
        assertEq(counter.count(), 1);
    }

    function testDecRevertsOnZero() public {
        vm.expectRevert("Underflow");
        counter.dec();
    }
}
</code></pre>
<p>▶️ <strong>运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">forge <span class="hljs-built_in">test</span> -vv
</code></pre>
<hr/>
<h4 data-id="heading-4">1.2 模糊测试（Fuzzing Test）</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>函数参数带 <code>uint256 x</code> 等</li>
<li>Forge 自动用数百个随机值运行</li>
<li>发现边界/异常输入 bug</li>
</ul>
<p>✅ <strong>适用场景</strong><br/>
验证函数对任意输入的鲁棒性（如数学运算、数组索引等）</p>
<p>✅ <strong>示例：<code>test/Math.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test} from "forge-std/Test.sol";

contract Math {
    function add(uint256 a, uint256 b) public pure returns (uint256) {
        return a + b; // Solidity 0.8+ 自动防溢出
    }
}

contract MathTest is Test {
    Math math = new Math();

    // Forge 会自动用 ~256 个随机 a, b 运行此测试
    function testFuzz_AddNoOverflow(uint256 a, uint256 b) public {
        // 可选：过滤无效输入
        vm.assume(a + b &gt;= a); // 避免溢出（其实 0.8+ 不会溢出，仅为演示）

        uint256 result = math.add(a, b);
        assertEq(result, a + b);
    }
}
</code></pre>
<p>▶️ <strong>运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">forge <span class="hljs-built_in">test</span> --mc MathTest -vv
</code></pre>
<p>💡 <code>vm.assume(condition)</code>：跳过不满足条件的输入</p>
<hr/>
<h4 data-id="heading-5">1.3 不变量测试（Invariant Test / Stateful Fuzzing）</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>使用 <code>forge-std/Vm</code> 的 handler 模式</li>
<li>多个操作随机组合</li>
<li>验证“无论怎么操作，某些性质始终成立”</li>
</ul>
<p>✅ <strong>适用场景</strong><br/>
复杂状态机、DeFi 协议（如“总供应量 = 所有用户余额之和”）</p>
<p>✅ <strong>示例：<code>test/CounterInvariant.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test} from "forge-std/Test.sol";
import "./Counter.sol"; // 假设 Counter 在 src/Counter.sol

contract CounterHandler is Test {
    Counter counter;
    uint256 public countSnapshot;

    constructor(Counter _counter) {
        counter = _counter;
    }

    function inc() public {
        counter.inc();
    }

    function dec() public {
        if (counter.count() &gt; 0) {
            counter.dec();
        }
    }

    // 每次操作后，Forge 会调用此函数检查不变量
    function check_count_non_negative() public {
        assertGe(counter.count(), 0); // 始终 &gt;= 0
    }
}

contract CounterInvariantTest is Test {
    Counter counter;
    CounterHandler handler;

    function setUp() public {
        counter = new Counter();
        handler = new CounterHandler(counter);
        // 注册 handler 到模糊引擎
        bytes4[] memory sigs = new bytes4[](2);
        sigs[0] = handler.inc.selector;
        sigs[1] = handler.dec.selector;
        vm.setHandler(address(handler), sigs, true);
    }

    // 运行 100 轮随机 inc/dec 序列
    function invariant_counter_never_negative() public {
        // 不需要写逻辑，Forge 自动调用 handler + check
    }
}
</code></pre>
<p>▶️ <strong>运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">forge <span class="hljs-built_in">test</span> --mc CounterInvariantTest -vv
</code></pre>
<p>⚠️ 注意：需在 <code>setUp</code> 中注册 handler，且测试函数名以 <code>invariant_</code> 开头（非强制，但惯例）</p>
<hr/>
<h4 data-id="heading-6">1.4 分叉测试（Forking Test）</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>从真实主网/测试网分叉状态</li>
<li>测试与现有协议交互（如 Uniswap、Aave）</li>
</ul>
<p>✅ <strong>适用场景</strong><br/>
集成测试、闪电贷模拟、真实资产交互</p>
<p>✅ <strong>示例：<code>test/Fork.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test} from "forge-std/Test.sol";

contract ForkTest is Test {
    address constant USDC = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
    address constant DAI = 0x6B175474E89094C44Da98b954EedeAC495271d0F;

    function testFork_DaiTotalSupply() public {
        // 分叉 Ethereum 主网最新区块
        vm.createFork("mainnet");
        vm.selectFork(vm.activeFork());

        // 调用真实 DAI 合约
        (bool success, bytes memory data) = DAI.call(
            abi.encodeWithSignature("totalSupply()")
        );
        uint256 totalSupply = abi.decode(data, (uint256));
        assertTrue(success);
        console.log("DAI Total Supply:", totalSupply);
        assertTrue(totalSupply &gt; 0);
    }
}
</code></pre>
<p>▶️ <strong>运行（需配置 RPC）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 .env 中设置：MAINNET_RPC_URL=https://...</span>
<span class="hljs-built_in">source</span> .<span class="hljs-built_in">env</span>
forge <span class="hljs-built_in">test</span> --mc ForkTest -vv --fork-url <span class="hljs-variable">$MAINNET_RPC_URL</span>
</code></pre>
<hr/>
<h4 data-id="heading-7">1.5 参数化测试（Parameterized Test）</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>手动提供多组输入</li>
<li>类似 fuzzing，但输入可控</li>
</ul>
<p>✅ <strong>适用场景</strong><br/>
验证特定边界值（如 0, 1, max, min）</p>
<p>✅ <strong>示例：<code>test/Param.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test} from "forge-std/Test.sol";

contract Math {
    function square(uint256 x) public pure returns (uint256) {
        return x * x;
    }
}

contract ParamTest is Test {
    Math math = new Math();

    function testParam_Square() public {
        uint256[4] memory inputs = [0, 1, 10, 100];
        uint256[4] memory expected = [0, 1, 100, 10000];

        for (uint i = 0; i &lt; inputs.length; i++) {
            assertEq(math.square(inputs[i]), expected[i]);
        }
    }
}
</code></pre>
<p>▶️ <strong>运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">forge <span class="hljs-built_in">test</span> --mc ParamTest -vv
</code></pre>
<p>💡 也可结合 fuzzing + <code>vm.assume</code> 实现类似效果，但此方式更直观。</p>
<hr/>
<h4 data-id="heading-8">1.6 快照测试（Snapshot Test）—— 通过 gas / logs 验证行为</h4>
<p>✅ <strong>特点</strong></p>
<ul>
<li>不只验证结果，还验证 gas 消耗、事件日志</li>
<li>用于性能回归、事件完整性测试</li>
</ul>
<p>✅ <strong>示例：<code>test/Snapshot.t.sol</code></strong></p>
<pre><code class="hljs language-solidity" lang="solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.30;

import {Test, console2} from "forge-std/Test.sol";

contract EventEmitter {
    event Incremented(uint256 newValue);
    uint256 public count;
    function inc() public {
        count++;
        emit Incremented(count);
    }
}

contract SnapshotTest is Test {
    EventEmitter emitter;

    function setUp() public {
        emitter = new EventEmitter();
    }

    function testInc_EmitsEventAndGasBound() public {
        vm.expectEmit(true, true, true, true);
        emit emitter.Incremented(1);

        uint256 gasStart = gasleft();
        emitter.inc();
        uint256 gasUsed = gasStart - gasleft();

        // 验证 gas 消耗不超过阈值（防性能退化）
        assertLe(gasUsed, 50000, "Gas used too high");

        // 验证状态
        assertEq(emitter.count(), 1);
    }
}
</code></pre>
<p>▶️ <strong>运行</strong></p>
<pre><code class="hljs language-bash" lang="bash">forge <span class="hljs-built_in">test</span> --mc SnapshotTest -vv
</code></pre>
<hr/>
<h3 data-id="heading-9">2. 测试类型命名规范与组合策略</h3>
<h4 data-id="heading-10">2.1 命名约定的作用</h4>
<p>Foundry 通过命名约定区分测试类型，不仅提升可读性，更支持工具链精准筛选（如 <code>forge test -m "Revert"</code>）。以下是五类核心测试：</p>



































<table><thead><tr><th>测试类型</th><th>命名前缀</th><th>工具支持</th></tr></thead><tbody><tr><td>普通单元测试</td><td><code>test_</code></td><td>默认运行</td></tr><tr><td>模糊测试</td><td><code>testFuzz_</code></td><td>自动 fuzz</td></tr><tr><td>回滚测试</td><td><code>test_RevertWhen_</code> / <code>test_RevertIf_</code></td><td>可通过 <code>-m "Revert"</code> 筛选</td></tr><tr><td>分叉测试</td><td><code>testFork_</code></td><td>可通过 <code>-m "Fork"</code> 筛选</td></tr><tr><td>不变量测试</td><td><code>invariant_</code></td><td>通常配合 handler</td></tr></tbody></table>
<p>✅ <strong>关键原则</strong>：命名不仅是风格问题，更是自动化测试基础设施的一部分。</p>
<h4 data-id="heading-11">2.2 组合测试示例（如 <code>testForkFuzz_RevertWhen_</code>）</h4>
<p><strong>作用</strong>：融合多种测试维度，覆盖最复杂的现实场景。<br/>
<strong>适用场景</strong>：DeFi 协议交互、跨合约调用、经济模型验证等。</p>
<pre><code class="hljs language-solidity" lang="solidity">function testForkFuzz_RevertWhen_InsufficientBalance(uint256 amount) public {
    vm.assume(amount &gt; userBalance);
    vm.expectRevert("Insufficient balance");
    token.transfer(bob, amount);
}
</code></pre>
<hr/>
<h3 data-id="heading-12">3. 断言与调试：提升可读性与故障定位效率</h3>
<h4 data-id="heading-13">3.1 使用描述性断言消息</h4>
<p>Forge 默认不显示失败行号，因此应利用 <code>assertEq</code> 的第三个参数添加简短标识：</p>
<pre><code class="hljs language-solidity" lang="solidity">function test_add() public {
    assertEq(calc.add(2, 3), 5, "1"); // 第一个断言
    assertEq(calc.add(-1, 1), 0, "2"); // 第二个断言
}
</code></pre>
<p>若失败，输出 <code>"Error: Assertion failed: 2"</code>，立即定位问题。</p>
<p>更语义化写法：</p>
<pre><code class="hljs language-solidity" lang="solidity">assertEq(totalSupply, sumBalances, "total_supply_mismatch");
</code></pre>
<h4 data-id="heading-14">3.2 事件测试的最佳实践</h4>
<p>始终使用 <code>vm.expectEmit(true, true, true, true)</code>：</p>
<pre><code class="hljs language-solidity" lang="solidity">function test_transfer_EmitsTransferEvent() public {
    vm.expectEmit(true, true, true, true);
    emit Transfer(address(this), alice, 100);
    token.transfer(alice, 100);
}
</code></pre>
<p>✅ <strong>优势</strong>：</p>
<ul>
<li>自动验证所有 <code>indexed</code> 字段；</li>
<li>新增字段时测试自动失败，防止遗漏。</li>
</ul>
<hr/>
<h3 data-id="heading-15">4. 分叉测试 vs Mock：生产环境中的权衡与选择</h3>
<h4 data-id="heading-16">4.1 生产中 Mock 的使用比重</h4>
<ul>
<li><strong>大型 DeFi 协议</strong>（如 Compound、Lido）：&lt; 10%，优先使用 fork 测试。</li>
<li><strong>小型项目或内部模块</strong>：可能达 20–30%，用于简化未部署依赖。</li>
<li><strong>趋势</strong>：随着 Anvil 和 RPC 缓存优化，Mock 使用比例持续下降。</li>
</ul>
<h4 data-id="heading-17">4.2 Mock 的额外价值</h4>
<p>除了“方便”，Mock 还有：</p>
<ol>
<li><strong>隔离性</strong>：仅测试自身逻辑，不受外部协议变更干扰；</li>
<li><strong>极端状态模拟</strong>：如构造 <code>balance = type(uint).max</code>；</li>
<li><strong>确定性控制</strong>：避免主网状态波动影响 CI 稳定性。</li>
</ol>
<h4 data-id="heading-18">4.3 能否完全不用 Mock？影响与风险分析</h4>
<p><strong>可以，且强烈推荐尽量不用</strong>，原因如下：</p>
<ul>
<li>区块链是开放的：所有已部署代码均可本地运行，无需像 Web2 那样 mock 闭源 API。</li>
<li>Mock 易出错：可能遗漏 modifier、gas 行为、重入防护等细节，导致“测试通过但主网失败”。</li>
</ul>
<p>⚠️ <strong>不用 Mock 的潜在挑战</strong>：</p>





















<table><thead><tr><th>挑战</th><th>解决方案</th></tr></thead><tbody><tr><td>首次 fork 测试慢</td><td>固定 block number + RPC 缓存（后续 &lt; 0.5s）</td></tr><tr><td>依赖 RPC 稳定性</td><td>使用 Alchemy/Infura 免费 archive 节点；CI 中缓存响应</td></tr><tr><td>特定历史状态难复现</td><td>用 <code>anvil_setStorageAt</code> 手动篡改状态</td></tr></tbody></table>
<p>✅ <strong>最佳实践</strong>：优先 fork 测试；仅当外部合约未部署或需极端控制时才 mock。</p>
<hr/>
<h3 data-id="heading-19">5. 测试 internal/private 函数：Harness 模式详解</h3>
<h4 data-id="heading-20">5.1 测试 internal 函数的标准流程</h4>
<p>Solidity 的 <code>internal</code> 函数可被子合约访问，因此可通过继承+暴露的方式测试。</p>
<h4 data-id="heading-21">5.2 private 函数的替代方案</h4>
<p><code>private</code> 函数无法被继承访问，建议：</p>
<ul>
<li>改为 <code>internal</code>（最推荐）；</li>
<li>或将核心逻辑提取到 <code>internal</code> helper 函数中。</li>
</ul>
<h4 data-id="heading-22">5.3 完整示例</h4>
<p><strong>被测合约（<code>src/MyVault.sol</code>）</strong></p>
<pre><code class="hljs language-solidity" lang="solidity">contract MyVault {
    function _calculateFee(uint amount) internal pure returns (uint) {
        return amount * 5 / 100; // 5%
    }
}
</code></pre>
<p><strong>测试文件（<code>test/MyVault.t.sol</code>）</strong></p>
<pre><code class="hljs language-solidity" lang="solidity">import {Test} from "forge-std/Test.sol";
import {MyVault} from "src/MyVault.sol";

// Harness 合约：继承并暴露 internal 函数
contract MyVaultHarness is MyVault {
    function exposed_calculateFee(uint amount) external pure returns (uint) {
        return _calculateFee(amount); // 调用 internal 函数
    }
}

contract MyVaultTest is Test {
    MyVaultHarness vault;

    function setUp() public {
        vault = new MyVaultHarness();
    }

    function test_exposed_calculateFee_ReturnsCorrectValue() public {
        assertEq(vault.exposed_calculateFee(1000), 50, "fee_calc");
    }
}
</code></pre>
<p>📌 <strong>命名规范</strong>：暴露函数使用 <code>exposed_&lt;originalName&gt;</code> 前缀，表明其为测试专用。</p>
<hr/>
<h3 data-id="heading-23">6. “变通函数”（Workaround Functions）实战指南</h3>
<h4 data-id="heading-24">6.1 为何需要 workaround？</h4>
<p>当合约内部状态（如 <code>private</code> 数组长度）没有 <code>public getter</code>，但测试需要访问时。</p>
<h4 data-id="heading-25">6.2 实现方式与命名规范</h4>
<p>通过 harness 合约访问私有成员，并提供 <code>external</code> 接口：</p>
<pre><code class="hljs language-solidity" lang="solidity">contract TaskQueue {
    address[] private tasks;
    function addTask(address task) external { tasks.push(task); }
    // 无 getLength()！
}

contract TaskQueueHarness is TaskQueue {
    function workaround_getTaskCount() external view returns (uint) {
        return tasks.length; // 访问 private 成员
    }
}
</code></pre>
<h4 data-id="heading-26">6.3 高级用法：幽灵变量（Ghost Variables）</h4>
<p>用于不变式测试，记录生产环境不需要但测试必需的信息：</p>
<pre><code class="hljs language-solidity" lang="solidity">contract TokenHarness is Token {
    mapping(address =&gt; bool) public _isHolder; // ghost variable

    function _mint(address to, uint amount) internal override {
        if (balanceOf(to) == 0 &amp;&amp; amount &gt; 0) _isHolder[to] = true;
        super._mint(to, amount);
    }
}
</code></pre>
<p>随后可高效验证：“所有持币人余额之和 = totalSupply”。<br/>
📌 <strong>命名规范</strong>：使用 <code>workaround_&lt;purpose&gt;</code> 前缀。</p>
<hr/>
<h3 data-id="heading-27">7. 不变式测试（Invariant Tests）：保障系统鲁棒性的核心手段</h3>
<h4 data-id="heading-28">7.1 什么是鲁棒性？</h4>
<p>鲁棒性（robustness）是英文音译，意即程序或系统的健壮性——指其在面对异常输入、错误操作或环境扰动时仍能稳定运行或优雅降级的能力。<br/>
一个鲁棒性强的系统不会因畸形数据、边界值或资源异常而崩溃，而是能妥善处理或给出明确错误提示。<br/>
在 Web3 领域尤为重要：智能合约一旦部署便不可更改，任何未考虑到的边界情况都可能导致严重漏洞甚至资金损失。<br/>
因此，开发者常通过模糊测试（Fuzzing）等手段提升代码鲁棒性。<br/>
简言之，<strong>鲁棒性 = 抗压 + 容错 + 可靠</strong>，是高质量软件尤其是高风险系统（如区块链）不可或缺的特性。</p>
<h4 data-id="heading-29">7.2 不变式测试在生产中的地位</h4>
<ul>
<li><strong>DeFi 协议</strong>（借贷、AMM、衍生品）：核心测试手段，审计必查项。</li>
<li><strong>NFT 或简单合约</strong>：较少使用。</li>
<li><strong>使用频率</strong>：在复杂协议中，invariant tests 占测试总量 30% 以上。</li>
</ul>
<h4 data-id="heading-30">7.3 与 Mock、分叉测试的协同使用策略</h4>
<p>三者互补而非互斥：</p>

























<table><thead><tr><th>测试类型</th><th>目标</th><th>场景</th></tr></thead><tbody><tr><td>Unit Tests</td><td>验证单个函数正确性</td><td>开发初期、PR 检查</td></tr><tr><td>Invariant Tests</td><td>验证全局属性永不破坏</td><td>模糊测试、状态机验证</td></tr><tr><td>Fork Tests</td><td>验证真实世界交互安全</td><td>上线前、重大升级</td></tr></tbody></table>
<p>✅ <strong>典型生产实践（组合使用）</strong>：</p>
<pre><code class="hljs language-solidity" lang="solidity">function invariant_totalSupplyEqualsSumOfBalances() public {
    uint total = token.totalSupply();
    uint sum = 0;
    for (address holder : allHolders) {
        sum += token.balanceOf(holder);
    }
    assertEq(total, sum, "Invariant violated: totalSupply != sum of balances");
}
</code></pre>
<p>💡 <strong>关键</strong>：Invariant tests 通常配合 fuzzing + stateful testing（如使用 handler 模式随机调用多个函数），模拟用户各种操作组合，是提升系统鲁棒性的终极武器。</p>
<hr/>
<h3 data-id="heading-31">8. 总结：构建高可靠智能合约测试体系</h3>
<h4 data-id="heading-32">📊 Foundry 六大测试方式对比</h4>















































<table><thead><tr><th>类型</th><th>关键词</th><th>用途</th><th>是否自动运行</th></tr></thead><tbody><tr><td>单元测试</td><td><code>testXxx()</code></td><td>基础功能验证</td><td>✅</td></tr><tr><td>模糊测试</td><td><code>testFuzz_Xxx(type x)</code></td><td>随机输入鲁棒性</td><td>✅（自动 fuzz）</td></tr><tr><td>不变量测试</td><td><code>invariant_xxx()</code> + handler</td><td>状态机正确性</td><td>✅（自动组合）</td></tr><tr><td>分叉测试</td><td><code>vm.createFork()</code></td><td>真实链交互</td><td>✅（需 RPC）</td></tr><tr><td>参数化测试</td><td>手动数组循环</td><td>特定边界值</td><td>✅</td></tr><tr><td>快照测试</td><td><code>vm.expectEmit</code>, <code>gasleft()</code></td><td>事件/gas 验证</td><td>✅</td></tr></tbody></table>
<h4 data-id="heading-33">🎯 推荐实践对照表</h4>

































<table><thead><tr><th>场景</th><th>推荐做法</th></tr></thead><tbody><tr><td>正常逻辑验证</td><td><code>test_</code> + 描述性断言</td></tr><tr><td>边界/异常覆盖</td><td><code>testFuzz_</code> + <code>vm.assume()</code></td></tr><tr><td>外部协议交互</td><td>优先 fork 测试，少用 mock</td></tr><tr><td>internal 函数测试</td><td><code>exposed_</code> harness 模式</td></tr><tr><td>私有状态访问</td><td><code>workaround_</code> 函数</td></tr><tr><td>全局安全性保障</td><td>不变式测试 + 模糊测试</td></tr></tbody></table>
<p>遵循本指南，你将能够：</p>
<ul>
<li>编写出结构清晰、易于维护的测试代码；</li>
<li>实现高覆盖率、高鲁棒性的合约验证；</li>
<li>显著降低主网事故与资金损失风险。</li>
</ul>
<blockquote>
<p><strong>在 Web3 世界，测试不是可选项，而是生存必需品。用好 Foundry，让你的代码坚如磐石。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你写一个VSCode插件，从开发到发布全流程]]></title>    <link>https://juejin.cn/post/7584320417307082803</link>    <guid>https://juejin.cn/post/7584320417307082803</guid>    <pubDate>2025-12-17T00:08:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417307082803" data-draft-id="7584340871412596763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你写一个VSCode插件，从开发到发布全流程"/> <meta itemprop="keywords" content="前端,JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-12-17T00:08:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你写一个VSCode插件，从开发到发布全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:08:02.000Z" title="Wed Dec 17 2025 00:08:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><code>VSCode</code> 几乎是前端开发人员的标配，而现在编辑器往往只提供<strong>代码编辑</strong>、<strong>文件和项目管理</strong>、<strong>终端集成</strong>、<strong>源代码管理</strong>、<strong>调试支持</strong>等核心功能，而一些扩展功能则交给插件来实现。</p>
<p>会编写 <code>VSCode</code> 插件可以极大提升我们的开发效率，本文将介绍如何编写一个简单的 <code>VSCode</code> 插件。</p>
<h2 data-id="heading-1">1、 安装工具，初始化项目</h2>
<p>首先肯定要安装 <code>node</code>，再通过其自带 <code>npm</code> 包管理工具安装 <code>yo</code> 和 <code>generator-code</code>。</p>
<ul>
<li><code>yo</code>：全称叫 <code>Yeoman</code>，是一个现代 Web 应用的脚手架工具（命令行工具），用于快速生成项目。</li>
<li><code>generator-code</code>：<code>VS Code</code> 扩展生成器。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm install -g yo@5 generator-code
</code></pre>
<blockquote>
<p>注意，使用 <code>yo</code> 最新的 <code>6.0.0</code> 版本运行 <code>yo</code> 命令会报错，因此这里指定安装 <code>5</code> 版本。</p>
</blockquote>
<p>安装完成后，运行 <code>yo code</code> 命令，初始化项目。</p>
<pre><code class="hljs language-bash" lang="bash">yo code
</code></pre>
<p>这里按提示即可，我这里选择的是 <code>pnpm + Typescript</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6571f5eb0ef249ac9199dc321c5d75c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=j0VVKybvWZ1Ba86kwjE6WbI1gS0%3D" alt="" loading="lazy"/></p>
<p>其主要项目结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">my-vscode-extension/
├── .vscode/            <span class="hljs-comment"># VS Code 调试配置</span>
│   ├── launch.json
│   └── tasks.json
├── src/
│   ├── <span class="hljs-built_in">test</span>/           <span class="hljs-comment"># 测试文件</span>
│   └── extension.ts    <span class="hljs-comment"># 插件主入口文件</span>
├── .gitignore          <span class="hljs-comment"># git 忽略文件</span>
├── .npmrc              <span class="hljs-comment"># npm 配置文件</span>
├── .vscode-test.mjs    <span class="hljs-comment"># 单测配置文件</span>
├── .vscodeignore       <span class="hljs-comment"># 插件发布忽略文件</span>
├── package.json        <span class="hljs-comment"># 项目依赖管理文件</span>
├── tsconfig.json       <span class="hljs-comment"># TypeScript 配置文件</span>
├── eslint.config.mjs   <span class="hljs-comment"># Eslint 配置文件</span>
└── README.md
</code></pre>
<p>介绍一下 <code>package.json</code> 中提供的几个重要命令：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vscode:prepublish"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm run compile"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -p ./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"watch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -watch -p ./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pretest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm run compile &amp;&amp; pnpm run lint"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"test"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vscode-test"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>npm run compile</code>：编译 TypeScript 代码。</li>
<li><code>npm run watch</code>：监听 TypeScript 文件变化并实时编译。</li>
<li><code>npm run test</code>：运行单元测试。</li>
</ul>
<p>另外是 <code>package.json</code> 中提供的插件命令。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"contributes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-vscode-extension.helloWorld"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello World"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在默认提供的 <code>demo</code> 中，插件命令名字叫 <code>hello world</code>。</p>
<h2 data-id="heading-2">2、调试插件</h2>
<p>在调试插件前，需要先运行下 <code>npm run compile</code> 编译 TypeScript 代码，经编译后会生成 <code>out/</code> 文件，然后便可以开始调试了。</p>
<p>为什么要先编译呢？因为在 <code>package.json</code> 中定义了插件运行的入口文件，也就是 <code>main</code> 字段，默认值为 <code>./out/extension.js</code>，所以如果不先编译生成 <code>out/</code> 文件是会运行报错的。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./out/extension.js"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>有两种启动调试的方式：</p>
<ol>
<li>按快捷键 <code>F5</code>。</li>
<li>点击编辑器左下方的 <code>Run Extension（插件名）</code>。</li>
</ol>
<p>启动后，会自动打开一个新的 VS Code 窗口，并启动调试模式，我们可以在该窗口中调试插件。</p>
<p>先按 <code>Ctrl/Command + Shift + P</code>，输入 <code>hello word</code>，会发现找不到命令。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b98cfcd4c5984c94aef3b4110dfd92b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=gCp%2Ft4IeRIKlioX6GqZVLg6km5Y%3D" alt="" loading="lazy"/></p>
<p>这里是因为我们本地安装的 vscode 版本不符合插件要求，我们在 <code>package.json</code> 找到如下配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vscode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.107.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后我们再查看下本机的 vscode 版本，<code>Code -&gt; About VisualStdio Code</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/665dea952ca64a76b34400dceb7dbda2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=bWeHEXyFKUFY75b17DZd8HPyito%3D" alt="" loading="lazy"/></p>
<p>发现我们本地版本为 <code>1.105.1</code>，不满足 <code>^1.107.0</code>，于是我们把 <code>engines.vscode</code> 修改为 <code>^1.105.0</code>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vscode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.105.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>再通过 <code>F5</code> 或者左下角 <code>Run Extension</code> 启动调试，按 <code>Ctrl/Command + Shift + P</code>，输入<code>hello world</code>，就能看到命令了。这个 <code>hello world</code> 就对应我们上面说的 <code>package.json</code> 文件中的 <code>contributes.commands.title</code> 字段。</p>
<p>成功运行后，会在编辑器右下角看到如下提示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac8da8ab49e415e8959fc7a3b63f2de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=VHfq2ZjmjWH0cx7MiVRnEEm3uKA%3D" alt="" loading="lazy"/></p>
<p>这个提示就是对应 <code>src/extension.ts</code> 的如下代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145e2cfeeca54fac80964d058b5c5b1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=pN%2FYBYxTEGFTVOn1A0O8JzWUP0Q%3D" alt="" loading="lazy"/></p>
<p>然后我们就可以开始编写插件的具体功能了。</p>
<h2 data-id="heading-3">3、编写插件核心逻辑</h2>
<p>我们来实现一个简单的功能，平时我们写代码时，经常会写 <code>console.log</code>，如果每次都写这个太麻烦了，我们希望能实现下面的功能：</p>
<ol>
<li>通过快捷键，可以快速生成 <code>console.log</code> 语句。</li>
<li>光标选中变量并按下快捷键时，能把变量名也显示出来。</li>
</ol>
<h3 data-id="heading-4">3.1 修改 package.json，定义插件名字、描述和快捷键</h3>
<p>定义名字 <code>name</code>，描述 <code>description</code>，快捷键 <code>keybindings</code>，通过 <code>ctrl/command+alt+l</code> 可以运行插件。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log-util"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"displayName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log-util"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"generate log statement"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"contributes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log-util.logUtil"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log util"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"keybindings"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"log-util.logUtil"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ctrl+alt+l"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"mac"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cmd+alt+l"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"when"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"editorTextFocus"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.2 核心功能代码</h3>
<p>修改 <code>src/extension.ts</code> 文件，实现插件功能。</p>
<p>先实现第一步，快速生成 <code>console.log</code> 语句。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> vscode <span class="hljs-keyword">from</span> <span class="hljs-string">"vscode"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">activate</span>(<span class="hljs-params">context: vscode.ExtensionContext</span>) {
  <span class="hljs-keyword">const</span> disposable = vscode.<span class="hljs-property">commands</span>.<span class="hljs-title function_">registerCommand</span>(
    <span class="hljs-string">"log-util.logUtil"</span>,
    <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> editor = vscode.<span class="hljs-property">window</span>.<span class="hljs-property">activeTextEditor</span>;
      <span class="hljs-keyword">if</span> (!editor) {
        vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">showWarningMessage</span>(<span class="hljs-string">"没有打开的编辑器"</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">// 获取配置</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">getConfig</span> = (<span class="hljs-params"/>) =&gt;
        vscode.<span class="hljs-property">workspace</span>.<span class="hljs-title function_">getConfiguration</span>(<span class="hljs-string">"consoleLogGenerator"</span>);
      <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">getConfig</span>();
      <span class="hljs-keyword">const</span> logType = config.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"logType"</span>, <span class="hljs-string">"log"</span>);
      <span class="hljs-keyword">const</span> prefix = config.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"logPrefix"</span>, <span class="hljs-string">"🚀 ~ "</span>);

      <span class="hljs-keyword">const</span> position = editor.<span class="hljs-property">selection</span>.<span class="hljs-property">active</span>;

      <span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = editor.<span class="hljs-property">document</span>;
      <span class="hljs-keyword">const</span> selection = editor.<span class="hljs-property">selection</span>;
      <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getText</span>(selection);

      <span class="hljs-keyword">const</span> statement = <span class="hljs-string">`console.<span class="hljs-subst">${logType}</span>('<span class="hljs-subst">${prefix}</span>:', );`</span>;

      editor
        .<span class="hljs-title function_">edit</span>(<span class="hljs-function">(<span class="hljs-params">editBuilder</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> insertPosition = <span class="hljs-keyword">new</span> vscode.<span class="hljs-title class_">Position</span>(position.<span class="hljs-property">line</span>, position.<span class="hljs-property">character</span> + <span class="hljs-number">1</span>);
          editBuilder.<span class="hljs-title function_">insert</span>(insertPosition, statement);
        })
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">success</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-comment">// 设置光标位置</span>
            <span class="hljs-keyword">const</span> newPosition = <span class="hljs-keyword">new</span> vscode.<span class="hljs-title class_">Position</span>(position.<span class="hljs-property">line</span>, statement.<span class="hljs-property">length</span> + position.<span class="hljs-property">character</span> - <span class="hljs-number">2</span>);
            editor.<span class="hljs-property">selection</span> = <span class="hljs-keyword">new</span> vscode.<span class="hljs-title class_">Selection</span>(newPosition, newPosition);
          }
        });
    }
  );

  context.<span class="hljs-property">subscriptions</span>.<span class="hljs-title function_">push</span>(disposable);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deactivate</span>(<span class="hljs-params"/>) {}

</code></pre>
<p>然后实现第二步，增加对光标选中变量的处理。</p>
<pre><code class="hljs language-diff" lang="diff">		 // 获取变量名
<span class="hljs-addition">+   let variableName = text.trim();</span>
<span class="hljs-deletion">-   const statement = `console.${logType}('${prefix}:', );`;</span>
<span class="hljs-addition">+   const statement = `console.${logType}('${prefix}${variableName ? ` →  ${variableName}` : ''}:', ${variableName});`;</span>
  
    editor.edit(editBuilder =&gt; {
<span class="hljs-deletion">-     const insertPosition = new vscode.Position(position.line, position.character + 1);</span>
<span class="hljs-addition">+     const insertPosition = new vscode.Position(position.line + (variableName ? 1 : 0), variableName ? 0 : position.character + 1);</span>
<span class="hljs-addition">+     if (variableName) {</span>
<span class="hljs-addition">+       editBuilder.insert(insertPosition, '\n');</span>
<span class="hljs-addition">+     }</span>
      editBuilder.insert(insertPosition, statement);
    }).then(success =&gt; {
        if (success) {
          // 设置光标位置
<span class="hljs-deletion">-         const newPosition = new vscode.Position(position.line, statement.length + position.character - 2);</span>
<span class="hljs-addition">+         const newPosition = new vscode.Position(position.line + (variableName ? 1 : 0), variableName ? statement.length : statement.length + position.character - 2);</span>
          editor.selection = new vscode.Selection(newPosition, newPosition);
			}
		});
</code></pre>
<p>测试插件功能：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🚀 ~  →  path:'</span>, path); <span class="hljs-comment">// 光标选中上一行的 path 变量，按 ctrl/command+alt+l 生成</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🚀 ~ :'</span>, ); <span class="hljs-comment">// 在当前行按 ctrl/command+alt+l 生成</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f0ff80370884bd7b277b9d33fa361da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=BL3NsZoOVJiaxzbf1g308uS3PF8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4、发布插件</h2>
<ol>
<li>
<p>进入<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2F" target="_blank" title="https://marketplace.visualstudio.com/" ref="nofollow noopener noreferrer">这个网站</a>，点击 <code>Sign in</code>，先注册一个开发者账号。</p>
</li>
<li>
<p>点击 <code>Public extensions</code>，按照提示一步步发布即可。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8cf7f44940e439899097cebd21e173f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5a-S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766534881&amp;x-signature=5L185gIJAA%2BOUS99N5qDEwx0ZO0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">小结</h2>
<p>本文主要介绍了如何编写一个简单的 VSCode 插件，从开发到发布全流程：</p>
<ol>
<li>安装 <code>yo</code> 和 <code>generator-code</code>。</li>
<li>运行 <code>yo code</code> 命令生成插件项目，这里可以选择插件的开发语言，定义插件的名称、描述等。</li>
<li>修改 <code>package.json</code> 文件，可以修改插件的名称、描述、入口文件，定义插件的快捷键。并要注意设置 <code>engines.vscode</code> 字段，指定插件支持的 VSCode 版本。</li>
<li>在 <code>src/extension.ts</code> 文件中编写插件逻辑。</li>
<li>运行 <code>npm run compile</code> 编译插件，或者运行 <code>npm run watch</code> 监听文件变化并编译。</li>
<li>按快捷键 <code>F5</code>，或者点击编辑器左下方的 <code>Run Extension</code> 进行插件调试。</li>
<li>在调试的新窗口中，使用 <code>Ctrl/Command + Shift + P</code>，输入配置的命令，或者按配置的快捷键，测试插件功能是否正常。</li>
<li>运行 <code>npm run test</code> 测试插件功能。（本文未涉及到单元测试）</li>
<li>发布插件。</li>
</ol>
<p>希望本文对你有所帮助，如果你有任何问题，欢迎在评论区留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot3.0性能优化：这5个冷门配置让我节省了40%内存占用]]></title>    <link>https://juejin.cn/post/7584286241488584744</link>    <guid>https://juejin.cn/post/7584286241488584744</guid>    <pubDate>2025-12-17T00:17:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584286241488584744" data-draft-id="7584319403858755619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot3.0性能优化：这5个冷门配置让我节省了40%内存占用"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-17T00:17:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot3.0性能优化：这5个冷门配置让我节省了40%内存占用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:17:49.000Z" title="Wed Dec 17 2025 00:17:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot3.0性能优化：这5个冷门配置让我节省了40%内存占用</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在微服务架构盛行的今天，Spring Boot 作为 Java 生态中最流行的开发框架之一，其性能表现直接影响着系统的稳定性和资源利用率。尽管 Spring Boot 3.0 在默认配置上已经做了大量优化，但在实际生产环境中，仍有不少开发者忽略了某些“冷门”配置项，导致内存占用居高不下。</p>
<p>本文将分享我在一个高并发项目中通过调整 <strong>5 个鲜为人知的 Spring Boot 3.0 配置项</strong>，成功减少 <strong>40% 内存占用</strong>的经验。这些优化不仅适用于新项目，也能为现有系统提供显著的性能提升。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 调整 JVM 垃圾回收器：从 Parallel GC 切换到 ZGC</h3>
<h4 data-id="heading-4">问题背景</h4>
<p>Spring Boot 默认使用 Parallel GC（并行垃圾回收器），虽然吞吐量高，但在高并发场景下容易导致较长的 STW（Stop-The-World）停顿和较高的内存占用。</p>
<h4 data-id="heading-5">优化方案</h4>
<p>切换到 <strong>ZGC（Z Garbage Collector）</strong>，这是一种低延迟、可扩展的垃圾回收器，尤其适合堆内存较大的应用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># application.properties</span>
spring.jvm.gc.type=zgc
</code></pre>
<p>或者通过启动参数：</p>
<pre><code class="hljs language-bash" lang="bash">java -XX:+UseZGC -jar your-application.jar
</code></pre>
<h4 data-id="heading-6">效果验证</h4>
<ul>
<li><strong>内存占用下降</strong>：ZGC 的分代压缩特性减少了堆内存碎片，降低了整体占用。</li>
<li><strong>延迟降低</strong>：STW 时间从原来的 200ms+ 降至 &lt;1ms。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：ZGC 需要 JDK 17+，且对 Windows/macOS 的支持较弱，建议在 Linux 生产环境使用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">2. 禁用不必要的 Actuator Endpoints</h3>
<h4 data-id="heading-8">问题背景</h4>
<p>Spring Boot Actuator 是监控和管理应用的利器，但默认启用的端点（如 <code>heapdump</code>、<code>env</code>）会占用额外内存，尤其是 <code>heapdump</code> 在触发时可能导致瞬时 OOM。</p>
<h4 data-id="heading-9">优化方案</h4>
<p>仅启用必要的端点：</p>
<pre><code class="hljs language-properties" lang="properties"># application.properties
management.endpoints.web.exposure.include=health,metrics,info
management.endpoint.health.probes.enabled=true
management.endpoint.heapdump.enabled=false
</code></pre>
<h4 data-id="heading-10">效果验证</h4>
<ul>
<li><strong>内存节省</strong>：禁用 <code>heapdump</code> 后减少约 <strong>50MB</strong> 常驻内存。</li>
<li><strong>安全性提升</strong>：避免敏感信息通过 <code>/actuator/env</code>泄露。</li>
</ul>
<hr/>
<h3 data-id="heading-11">3. Spring MVC/WebFlux：优化静态资源处理策略</h3>
<h4 data-id="heading-12">问题背景</h4>
<p>Spring Boot WebFlux/MVC会缓存静态资源（如JS/CSS）的解析结果以提高性能,但这对于纯API服务是多余的。</p>
<p>####优化方案<br/>
针对API-only服务,完全关闭静态资源处理:</p>
<pre><code class="hljs language-properties" lang="properties"># application.properties 
spring.web.resources.add-mappings=false

# WebFlux额外配置(如果使用)
spring.webflux.static-path-pattern=/nonexistent-path/
</code></pre>
<p>####效果验证</p>
<ul>
<li><strong>启动速度提升</strong>:减少约20%的启动时间(实测从4s→3.2s)</li>
<li><strong>常驻内存下降</strong>:节省30-50MB Metaspace占用</li>
</ul>
<hr/>
<p>###4. JPA/Hibernate二级缓存调优</p>
<p>####问题背景<br/>
Hibernate二级缓存默认使用EHCache,但其堆外内存管理较差,容易造成Native Memory泄漏。</p>
<p>####优化方案<br/>
改用Caffeine作为二级缓存实现:</p>
<pre><code class="hljs language-properties" lang="properties"># application.properties
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.jcache.JCacheRegionFactory
spring.jpa.properties.javax.persistence.sharedCache.mode=ENABLE_SELECTIVE

# pom.xml需添加依赖
&lt;dependency&gt;
    &lt;groupId&gt;com.github.ben-manes.caffeine&lt;/groupId&gt;
    &lt;artifactId&gt;jcache&lt;/artifactId&gt;
    &lt;version&gt;3.1.8&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>同时配置Caffeine缓存策略:</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
 <span class="hljs-attr">cache:</span>
   <span class="hljs-attr">caffeine:</span>
     <span class="hljs-attr">spec:</span> <span class="hljs-string">maximumSize=5000,expireAfterWrite=30m</span>
</code></pre>
<p>####效果验证</p>
<ul>
<li><strong>GC压力降低</strong>:相比EHCache减少70%的GC次数(YMMV)</li>
<li><strong>查询性能提升</strong>:高频查询响应时间缩短15%</li>
</ul>
<hr/>
<p>###5.Tomcat/Undertow线程模型优化</p>
<p>####问题背景<br/>
SpringBoot默认使用Tomcat且工作线程数=200,这对于IO密集型服务是严重浪费。</p>
<p>####优化方案<br/>
切换到Undertow并精细化配置:</p>
<pre><code class="hljs language-properties" lang="properties"># application.properties
server.undertow.io-threads=4      # CPU核心数×1~2 
server.undertow.worker-threads=20 # CPU核心数×5~10 
server.compression.enabled=true   #启用响应压缩降低网络开销

# Maven依赖排除Tomcat 
&lt;exclusions&gt;
    &lt;exclusion&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;
    &lt;/exclusion&gt;
&lt;/exclusions&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;
&lt;/dependency&gt; 
</code></pre>
<p>####效果验证</p>
<ul>
<li><strong>内存下降显著</strong>:相比Tomcat节省100MB+内存(相同并发量下)</li>
<li><strong>吞吐量提升</strong>:在IO密集型场景QPS提高18%</li>
</ul>
<hr/>
<p>##总结</p>
<p>通过上述5个方向的优化：</p>
<ol>
<li>ZGC替代Parallel GC →降低延迟&amp;内存碎片<br/>
2.精简Actuator端点 →消除监控组件冗余消耗<br/>
3.关闭静态资源处理 →专精API服务场景<br/>
4.Caffeine替换EHCache →高效缓存管理<br/>
5.Undertow线程调优 →匹配实际工作负载</li>
</ol>
<p>最终我们的订单服务在同等流量下：
▸堆内存占用从2.1GB→1.3GB(-38%)<br/>
▸Full GC频率从每天50+次→完全消失</p>
<p>这些优化证明：SpringBoot的默认配置并非放之四海而皆准。根据实际业务特点进行针对性调参,往往能收获意想不到的效果。建议开发者在性能测试阶段用JProfiler等工具持续观测,找到最适合自己应用的黄金配置点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 值对象实战指南：避免原始类型偏执]]></title>    <link>https://juejin.cn/post/7584353612500697129</link>    <guid>https://juejin.cn/post/7584353612500697129</guid>    <pubDate>2025-12-17T00:24:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584353612500697129" data-draft-id="7584353612500680745" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 值对象实战指南：避免原始类型偏执"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-17T00:24:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 值对象实战指南：避免原始类型偏执
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:24:01.000Z" title="Wed Dec 17 2025 00:24:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 值对象实战指南：避免原始类型偏执</h2>
<p>上一篇文章里，我们聊了<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fprimitive-obsession-in-php" target="_blank" title="https://catchadmin.com/post/2025-12/primitive-obsession-in-php" ref="nofollow noopener noreferrer">原始类型偏执（Primitive Obsession）</a>在 PHP 里为什么这么常见：邮箱、金额、日期、ID……统统用 string/int/float/array 传来传去。领域含义被抹平，校验逻辑散落在各处，代码越写越难改。</p>
<p>这一篇我们继续往下走：值对象（Value Object）不仅能让代码更清晰，还能让协作、测试和后续演进都更省心。不管你用的是 Laravel、Symfony 还是别的框架，只要项目里有明确的领域概念，值对象都能派上用场。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Favoiding-primitive-obsession-in-php-value-objects" target="_blank" title="https://catchadmin.com/post/2025-12/avoiding-primitive-obsession-in-php-value-objects" ref="nofollow noopener noreferrer">原文链接 PHP 值对象实战指南：避免原始类型偏执</a></p>
<h3 data-id="heading-1">1. 重复出现的模式：不只是代码味道</h3>
<p>在 PHP 项目里，某些规则会反复出现。日期就是典型例子：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerEvent</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$eventDate</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$timeZone</span></span>): <span class="hljs-title">void</span>
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^\d{4}-\d{2}-\d{2}$/'</span>, <span class="hljs-variable">$eventDate</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Invalid date format.'</span>);
    }
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$timeZone</span>, <span class="hljs-title class_">DateTimeZone</span>::<span class="hljs-title function_ invoke__">listIdentifiers</span>())) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Invalid time zone.'</span>);
    }
    <span class="hljs-comment">// More logic here...</span>
}
</code></pre>
<p>这里的日期和时区都用 string 表示。问题在于：一旦日期格式要改、或者时区规则有变化，你就会开始在各个角落复制粘贴同样的验证逻辑——漏一处就出事故。</p>
<h3 data-id="heading-2">2. 值对象登场：Date 和 TimeZone</h3>
<p>与其在每个入口都手写校验，不如把“日期”“时区”做成值对象，让它们自己保证合法性。</p>
<h4 data-id="heading-3">2.1 Date 值对象</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Date</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$date</span></span>)
    </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">'/^\d{4}-\d{2}-\d{2}$/'</span>, <span class="hljs-variable">$date</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Invalid date format.'</span>);
        }
        <span class="hljs-variable language_">$this</span>-&gt;value = <span class="hljs-variable">$date</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromString</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$date</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-variable">$date</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">value</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;value;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;value;
    }
}
</code></pre>
<h4 data-id="heading-4">2.2 TimeZone 值对象</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeZone</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$timeZone</span></span>)
    </span>{
        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$timeZone</span>, <span class="hljs-title class_">DateTimeZone</span>::<span class="hljs-title function_ invoke__">listIdentifiers</span>())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Invalid time zone.'</span>);
        }
        <span class="hljs-variable language_">$this</span>-&gt;value = <span class="hljs-variable">$timeZone</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fromString</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$timeZone</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-variable">$timeZone</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">value</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;value;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;value;
    }
}
</code></pre>
<h4 data-id="heading-5">2.3 在业务里怎么用</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">registerEvent</span>(<span class="hljs-params">Date <span class="hljs-variable">$eventDate</span>, TimeZone <span class="hljs-variable">$timeZone</span></span>): <span class="hljs-title">void</span>
</span>{
    <span class="hljs-comment">// No need for repetitive validation</span>
    <span class="hljs-comment">// Logic continues...</span>
}
</code></pre>
<p>参数一眼就能看懂，而且验证逻辑只存在一份：在值对象里。</p>
<h3 data-id="heading-6">3. 给值对象加上行为</h3>
<p>值对象不只是“更强的类型”。它还能承载和这个概念紧密相关的行为。</p>
<p>比如你需要判断活动日期是否在未来，可以把逻辑放进 Date：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Date</span>
</span>{
    <span class="hljs-comment">// ..</span>

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isInTheFuture</span>(<span class="hljs-params"/>): <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-variable">$now</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>();
        <span class="hljs-variable">$eventDate</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTime</span>(<span class="hljs-variable language_">$this</span>-&gt;value);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$eventDate</span> &gt; <span class="hljs-variable">$now</span>;
    }
}
</code></pre>
<p>这样就不用在每个用到日期的地方都重复写一遍比较逻辑，也更符合领域表达：判断未来与否，本来就是“日期”这个概念的一部分。</p>
<h3 data-id="heading-7">4. 金额：用值对象守住精度</h3>
<p>处理金额是原始类型偏执最容易踩坑的地方之一。用 float 表示钱，舍入误差迟早会找上门；再加上币种、汇率，复杂度会迅速拉高。</p>
<p>把金额做成值对象，通常的做法是：</p>
<ul>
<li>用最小单位（比如分）把金额存成 int</li>
<li>币种作为字段和金额绑定在一起</li>
</ul>
<p>下面这个 Money 示例进一步加上了换汇的行为：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Money</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$amount</span>; <span class="hljs-comment">// Stored in minor units (e.g., cents)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$currency</span>;

    <span class="hljs-comment">// Constructor and other methods...</span>

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertToCurrency</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$targetCurrency</span>, <span class="hljs-keyword">float</span> <span class="hljs-variable">$exchangeRate</span></span>): <span class="hljs-title">self</span>
    </span>{
        <span class="hljs-variable">$convertedAmount</span> = (<span class="hljs-keyword">int</span>) <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$this</span>-&gt;amount * <span class="hljs-variable">$exchangeRate</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">self</span>(<span class="hljs-variable">$convertedAmount</span>, <span class="hljs-variable">$targetCurrency</span>);
    }
}
</code></pre>
<p>把规则关在 Money 里，你的业务代码就不用到处关心“这里是分还是元”“币种对不对”“舍入怎么做”。</p>
<h3 data-id="heading-8">5. 在框架里落地</h3>
<p>一旦你开始用值对象，Laravel / Symfony 反而会更好用：你能把“原始数据 ↔ 值对象”的转换放到框架扩展点里，业务层拿到的就都是领域类型。</p>
<h4 data-id="heading-9">5.1 Laravel 示例</h4>
<p>Laravel 里可以用自定义 cast，把数据库字段自动转成值对象：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">CastsAttributes</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoneyCast</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CastsAttributes</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"><span class="hljs-variable">$model</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span>, <span class="hljs-variable">$value</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$attributes</span></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Money</span>::<span class="hljs-title function_ invoke__">fromInt</span>(<span class="hljs-variable">$value</span>, <span class="hljs-string">'USD'</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params"><span class="hljs-variable">$model</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span>, <span class="hljs-variable">$value</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$attributes</span></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> Money ? <span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">amount</span>() : <span class="hljs-variable">$value</span>;
    }
}
</code></pre>
<p>把这个 cast 挂到 Eloquent 模型上后，取出来的就是 Money，而不是裸值，代码会干净很多。</p>
<h4 data-id="heading-10">5.2 Symfony 示例</h4>
<p>Symfony 里可以用 Doctrine 的 embeddables 或自定义 DBAL type，把 Money / EmailAddress 这类复杂类型映射到数据库：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoneyType</span> <span class="hljs-keyword">extends</span> \<span class="hljs-title">Doctrine</span>\<span class="hljs-title">DBAL</span>\<span class="hljs-title">Types</span>\<span class="hljs-title">Type</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MONEY</span> = <span class="hljs-string">'money'</span>; <span class="hljs-comment">// Custom type name</span>

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertToPHPValue</span>(<span class="hljs-params"><span class="hljs-variable">$value</span>, \Doctrine\DBAL\Platforms\AbstractPlatform <span class="hljs-variable">$platform</span></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Money</span>::<span class="hljs-title function_ invoke__">fromInt</span>(<span class="hljs-variable">$value</span>, <span class="hljs-string">'USD'</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">convertToDatabaseValue</span>(<span class="hljs-params"><span class="hljs-variable">$value</span>, \Doctrine\DBAL\Platforms\AbstractPlatform <span class="hljs-variable">$platform</span></span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span> <span class="hljs-keyword">instanceof</span> Money ? <span class="hljs-variable">$value</span>-&gt;<span class="hljs-title function_ invoke__">amount</span>() : <span class="hljs-variable">$value</span>;
    }
}
</code></pre>
<p>这样做的好处是：从数据库到领域层，你始终在用“领域类型”，而不是一堆无意义的 string/int/float。</p>
<h3 data-id="heading-11">6. 怎么迁移现有代码库</h3>
<p>引入值对象不需要推倒重来。最稳妥的方式是渐进式迁移：</p>
<ul>
<li>先改边界层：在 HTTP controller、表单请求、CLI 命令里，把输入的原始值解析成值对象</li>
<li>再改服务层：逐步把 service 方法签名从原始类型换成值对象</li>
<li>配合静态分析：用 PHPStan 或 Psalm 强化类型约束，尽早发现不匹配</li>
</ul>
<h3 data-id="heading-12">7. 结语：让领域自己说话</h3>
<p>值对象的意义，不在于“OO 更纯粹”，而在于让领域概念变得清楚、可约束、可复用。</p>
<p>下次你准备在方法里传一堆 string/int 的时候，不妨停一下问自己：</p>
<p>“这真的是一个简单值吗？还是一个应该被命名、被约束的领域概念？”</p>
<p>做出这个小改变，短期能减少重复校验和隐性 bug；长期则会让整个代码库更稳、更好改——也更照顾未来维护它的你。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-186 Logstash JDBC vs Syslog Input：原理、场景对比与可复用配置（基于 Logstash 7.3.0）]]></title>    <link>https://juejin.cn/post/7584320417307197491</link>    <guid>https://juejin.cn/post/7584320417307197491</guid>    <pubDate>2025-12-17T00:45:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417307197491" data-draft-id="7584279552434094118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-186 Logstash JDBC vs Syslog Input：原理、场景对比与可复用配置（基于 Logstash 7.3.0）"/> <meta itemprop="keywords" content="后端,大数据,Logstash"/> <meta itemprop="datePublished" content="2025-12-17T00:45:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-186 Logstash JDBC vs Syslog Input：原理、场景对比与可复用配置（基于 Logstash 7.3.0）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:45:29.000Z" title="Wed Dec 17 2025 00:45:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：从 MySQL 增量同步结构化数据到 Logstash；同时集中采集 Linux/设备 Syslog 日志并解析。</li>
<li>结论：JDBC 适合“按表/按 SQL 拉取+增量位点”；Syslog 适合“网络日志流入+Grok/Date 解析”，两者瓶颈分别在 DB/查询与网络/解析。</li>
<li>产出：两套可跑通的 Logstash 7.3.0 配置（jdbc.conf、syslog.conf）+ 增量追踪与 rsyslog 转发链路。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83442750aee4466da32a35ba9b2a5071~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=0ezZp9WLTCSILVQ3YKjS709bet0%3D" alt="大数据-186 Logstash JDBC vs Syslog Input：原理、场景对比与可复用配置（基于 Logstash 7.3.0）" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





























<table><thead><tr><th>组件/工具</th><th>配置说明</th></tr></thead><tbody><tr><td>Logstash 7.3.0</td><td>配置路径与命令均以 <code>/opt/servers/logstash-7.3.0</code> 为基准；<code>-t</code> 校验通过截图已体现</td></tr><tr><td>MySQL Connector/J</td><td>使用 <code>jdbc.conf</code> 配置，驱动版本为 8.0.19；MySQL 8 推荐使用 <code>com.mysql.cj.jdbc.Driver</code>（兼容性与时区/SSL 参数更明确）</td></tr><tr><td>MySQL（示例表 user）</td><td>通过 <code>tracking_column =&gt; "id" + id &gt; :sql_last_value</code> 实现增量；适配自增/单调递增列</td></tr><tr><td>rsyslog（Linux）</td><td>在 <code>/etc/rsyslog.conf</code> 中增加 <code>*.* @@host:port</code> 实现 TCP 转发；需执行 <code>systemctl restart rsyslog</code> 生效</td></tr><tr><td>Logstash tcp/udp input</td><td><code>syslog.conf</code> 采用 <code>tcp {} + udp {}</code> 监听 6789 端口，并使用 <code>grok</code> 解析“类 syslog”消息（非 syslog input 插件直配）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f7c20b7a75b4186b5742e09dd0a1d13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=WBQBi50P7LaSfTFnK4d5kT37x8c%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">基本介绍</h2>
<p>Logstash 的 JDBC 和 Syslog 是两种功能各异的 Input 插件，它们分别针对不同的数据源进行优化设计，在数据处理流程中扮演着关键角色。下面将详细阐述它们的技术特性、应用场景及典型配置：</p>
<h4 data-id="heading-3">JDBC 插件深入解析</h4>
<ol>
<li>
<p><strong>核心功能</strong>：</p>
<ul>
<li>支持主流关系型数据库：MySQL (5.7+)、PostgreSQL (9.6+)、Oracle (12c+)、SQL Server (2016+)等</li>
<li>基于 JDBC 4.2 规范实现，使用数据库官方提供的 JDBC 驱动</li>
<li>支持增量数据采集：通过 <code>sql_last_value</code> 参数记录最后处理位置</li>
</ul>
</li>
<li>
<p><strong>典型应用场景</strong>：</p>
<ul>
<li>数据仓库的 ETL 流程</li>
<li>业务系统数据库变更监控</li>
<li>将传统数据库数据导入 Elasticsearch 集群</li>
<li>示例：电商订单数据实时同步</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">     <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> update_time <span class="hljs-operator">&gt;</span> :sql_last_value
</code></pre>
<ol start="3">
<li><strong>关键配置参数</strong>：</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby">   input {
     jdbc {
       jdbc_driver_library =&gt; <span class="hljs-string">"/path/to/mysql-connector-java-8.0.28.jar"</span>
       jdbc_driver_class =&gt; <span class="hljs-string">"com.mysql.jdbc.Driver"</span>
       jdbc_connection_string =&gt; <span class="hljs-string">"jdbc:mysql://localhost:3306/ecommerce"</span>
       jdbc_user =&gt; <span class="hljs-string">"logstash"</span>
       jdbc_password =&gt; <span class="hljs-string">"securepassword"</span>
       schedule =&gt; <span class="hljs-string">"* * * * *"</span>  <span class="hljs-comment"># 每分钟执行</span>
       statement =&gt; <span class="hljs-string">"SELECT * FROM products WHERE last_modified &gt; :sql_last_value"</span>
       use_column_value =&gt; <span class="hljs-literal">true</span>
       tracking_column =&gt; <span class="hljs-string">"last_modified"</span>
     }
   }
</code></pre>
<h4 data-id="heading-4">Syslog 插件技术细节</h4>
<ol>
<li>
<p><strong>协议支持</strong>：</p>
<ul>
<li>RFC3164 (旧版 BSD syslog)</li>
<li>RFC5424 (新版结构化syslog)</li>
<li>支持 TCP/UDP 两种传输协议</li>
</ul>
</li>
<li>
<p><strong>网络配置选项</strong>：</p>
<ul>
<li>端口绑定：默认 514 (UDP) / 6514 (TCP)</li>
<li>支持 TLS 加密传输</li>
<li>可配置多个监听端口实现多租户隔离</li>
</ul>
</li>
<li>
<p><strong>典型部署模式</strong>：</p>
<ul>
<li>网络设备日志收集（路由器/交换机）</li>
<li>Linux 系统日志集中管理</li>
<li>容器环境日志采集（Docker syslog驱动）</li>
<li>示例：防火墙日志处理</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-ruby" lang="ruby">     input {
       syslog {
         port =&gt; <span class="hljs-number">5514</span>
         type =&gt; <span class="hljs-string">"firewall"</span>
         syslog_field =&gt; <span class="hljs-string">"syslog_message"</span>
       }
     }
</code></pre>
<ol start="4">
<li><strong>高级功能</strong>：
<ul>
<li>支持自定义消息解析模式</li>
<li>可配置时区转换</li>
<li>提供消息优先级(PRI)解析</li>
</ul>
</li>
</ol>
<p>两种插件在性能调优方面也存在差异：JDBC 插件需要关注数据库连接池配置和批处理大小，而 Syslog 插件则需要优化网络缓冲区设置和并发处理能力。实际部署时，建议根据数据量级和延迟要求进行针对性调优。</p>
<h3 data-id="heading-5">JDBC Input 插件</h3>
<p>JDBC 插件用于从关系型数据库中提取数据，特别适用于将结构化的业务数据导入到 ELK（Elasticsearch, Logstash, Kibana）堆栈中。它支持定时调度和增量提取，适合数据同步和 ETL 场景。</p>
<p>主要功能：</p>
<ul>
<li>数据库连接：使用 JDBC 驱动来连接各种数据库（例如 MySQL、PostgreSQL、Oracle、SQL Server 等）。</li>
<li>SQL 查询：允许用户通过 SQL 查询语句选择数据，支持复杂的查询条件。</li>
<li>增量提取：可以配置“追踪列”（tracking column），基于某一列（如自增 ID 或时间戳）实现增量数据拉取，避免重复导入。</li>
<li>定时调度：可以设置定时任务，定期查询和同步数据库的数据。</li>
<li>错误重试机制：可以处理连接错误并自动重试，确保数据采集的稳定性。</li>
</ul>
<h3 data-id="heading-6">Syslog Input 插件</h3>
<p>Syslog 插件用于接收基于 Syslog 协议传输的日志数据。Syslog 是一种广泛使用的日志协议，特别是在网络设备和 Linux/Unix 操作系统中。Logstash 的 Syslog 插件能够监听特定的端口，接收和解析这些日志。</p>
<p>主要功能：</p>
<ul>
<li>协议支持：支持 Syslog 协议，包括 RFC 3164 和 RFC 5424 格式的日志。</li>
<li>多种传输方式：支持通过 TCP 和 UDP 协议接收日志，适应不同的传输需求。</li>
<li>日志解析：自动解析 Syslog 消息的头部字段，例如时间戳、主机名、程序名等。</li>
<li>网络监听：可以通过监听指定的 IP 和端口，持续接收并处理来自网络的 Syslog 日志。</li>
</ul>
<h2 data-id="heading-7">JDBC插件</h2>
<p>JDBC插件可以采集某张数据库表当中的数据到Logstash当中来</p>
<h3 data-id="heading-8">准备数据</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `user_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">25</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `gender` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY(`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHRASET<span class="hljs-operator">=</span>utf8;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'zhangsan'</span>, <span class="hljs-string">'male'</span>, <span class="hljs-string">'2024-08-16 00:00:00'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'lisi'</span>, <span class="hljs-string">'female'</span>, <span class="hljs-string">'2024-08-16 00:00:00'</span>);
</code></pre>
<p>目前我们的MySQL服务器是在 h122 节点上的（之前给Hive和HBase等业务使用的），现在我们需要到 h122 数据库中，执行上述的SQL指令。
我这里使用Navicat执行， 执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f4d73cd9bdb4b508b43bda78bd8cb7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=N1CX2DFcdfLQMLmgXkYGjx1Zxnw%3D" alt="Elasticsearch 执行SQL表" loading="lazy"/></p>
<h3 data-id="heading-9">编写配置</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim jdbc.conf
</code></pre>
<p>写入如下的内容（这里注意些自己的环境，我的环境和你的不一样）：</p>
<pre><code class="hljs language-shell" lang="shell">input {
  jdbc {
    jdbc_driver_library =&gt; "/opt/servers/mysql-connector-java-8.0.19.jar"
    jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"
    jdbc_connection_string =&gt; "jdbc:mysql://h122.wzk.icu:3306/es-test"
    jdbc_user =&gt; "hive"
    jdbc_password =&gt; "hive@wzk.icu"
    use_column_value =&gt; "true"
    clean_run =&gt; "false"
    record_last_run =&gt;"true"
    tracking_column =&gt; "id"
    schedule =&gt; "* * * * *"
    last_run_metadata_path =&gt; "/opt/servers/es/.Logstash_user_jdbc_last_run"
    statement =&gt; "SELECT * from user where id &gt; :sql_last_value;"
  }
}

output{
  stdout{
    codec=&gt;rubydebug
  }
}
</code></pre>
<h3 data-id="heading-10">检查配置</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/jdbc.conf -t
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e0c6e692cf412389e4eda9b9474703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=y%2BSooLmZ%2FiWWr79fcZk5uUQdgCU%3D" alt="Elasticsearch 检查配置" loading="lazy"/></p>
<h3 data-id="heading-11">启动服务</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/jdbc.conf
</code></pre>
<p>启动结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79421effd51c4e1c8bcf485749a9ea18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=11vR4ckNBkDxzP%2BB06LdRaKE7BU%3D" alt="Elasticsearch 启动服务" loading="lazy"/>
可以看到获取到了对应的数据：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7169cb230a5c4e938b80e3ac0f525fc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=79Y9VL8h9orAGUx5j1eX4QqxKiU%3D" alt="Elasticsearch 对应的数据" loading="lazy"/></p>
<h3 data-id="heading-12">发送数据</h3>
<p>现在向数据库中写入数据，就可以发现Logstash监听到了：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">3</span>, <span class="hljs-string">'wangwu'</span>, <span class="hljs-string">'female'</span>, <span class="hljs-string">'2024-08-16 00:00:00'</span>);
</code></pre>
<p>对应的Logstash的变化：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea1e21b5969c4b2cb163dea12b8038e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=7k1UsZgQb69PVLgBujSgon1gLtA%3D" alt="Elasticsearch 发送数据" loading="lazy"/></p>
<h2 data-id="heading-13">syslog插件</h2>
<p>syslog机制负责记录内核和应用程序产生的日志信息，管理员可以通过查看日志记录，来掌握系统状况，默认系统已经安装了rsyslog，直接启动即可。</p>
<h3 data-id="heading-14">编写配置</h3>
<p>创建新脚本，syslog.conf</p>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0/config
vim syslog.conf
</code></pre>
<p>写入如下的内容：</p>
<pre><code class="hljs language-shell" lang="shell">input {
  tcp {
    port =&gt; 6789
    type =&gt; "syslog"
  }
  udp {
    port =&gt; 6789
    type =&gt; "syslog"
  }
}

filter {
  if [type] == "syslog" {
    grok {
      match =&gt; {
        "message" =&gt; "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}"
      }
      add_field =&gt; {
        "received_at" =&gt; "%{@timestamp}"
        "received_from" =&gt; "%{host}"
      }
    }
    date {
      match =&gt; [ "syslog_timestamp", "MMM d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }
}

output {
  stdout {
    codec =&gt; rubydebug
  }
}

</code></pre>
<p>写入的内容如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8d4191b454740548d7dd390b5e9dcdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=7BUtLyAQcboRANPlI547ok77JIY%3D" alt="Elasticsearch input配置" loading="lazy"/></p>
<h3 data-id="heading-15">检查配置</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/syslog.conf -t
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dec55d2ee5247988014387e8a356f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=2QbsrRQ3uO6nUcJFzL0Qjg2tCJI%3D" alt="Elasticsearch 检查配置" loading="lazy"/></p>
<h3 data-id="heading-16">启动服务</h3>
<pre><code class="hljs language-shell" lang="shell">cd /opt/servers/logstash-7.3.0
bin/logstash -f /opt/servers/logstash-7.3.0/config/syslog.conf
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9e282bcbb7454ea6ae9708f4c29aab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=ULNiqzj8McP4LVPGV%2BSv4ApVMmk%3D" alt="Elasticsearch 启动服务测试" loading="lazy"/></p>
<h3 data-id="heading-17">发送数据</h3>
<p>修改系统日志配置文件</p>
<pre><code class="hljs language-shell" lang="shell">vim /etc/rsyslog.conf
</code></pre>
<p>添加一行配置：</p>
<pre><code class="hljs language-shell" lang="shell">*.* @@h121.wzk.icu:6789
</code></pre>
<p>写入的效果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2cb122c50c4f9a8bcbd1bec6f0a60d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=zbTPfhfY6qS6qv2pNjapGuqCJjY%3D" alt="Elasticsearch 发送数据" loading="lazy"/>
重启系统日志服务</p>
<pre><code class="hljs language-shell" lang="shell">systemctl restart rsyslog
</code></pre>
<p>查看数据，可以看到如下的效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00160c04b3e043118d08fc7334c3ac85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537129&amp;x-signature=VOzZ5eBvg%2FnFJ9%2FqqBcPc8cg7eg%3D" alt="Elasticsearch 查看 log 日志" loading="lazy"/></p>
<h2 data-id="heading-18">错误速查</h2>







































































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>JDBC 启动报驱动类找不到（ClassNotFound）</td><td>jdbc_driver_library 路径不对 / jar 不存在 / 类名不匹配</td><td>Logstash 启动日志里看 Java::...ClassNotFoundException；确认 jar 实际路径</td><td>校正 jar 路径；MySQL 8 用 com.mysql.cj.jdbc.Driver；确保 jar 对 logstash 进程可读</td></tr><tr><td>JDBC 能连库但不拉数据</td><td>statement 条件与 sql_last_value 初始值不匹配；或追踪列非单调</td><td>打印 stdout 观察是否有 event；检查 last_run_metadata_path 内容</td><td>首次全量：临时 clean_run =&gt; true 或改 SQL 允许全量；确保 tracking_column 单调递增（id/时间戳）</td></tr><tr><td>增量位点不更新/重启后重复拉取</td><td>last_run_metadata_path 无写权限/路径不存在；record_last_run 配置不生效</td><td>查看该路径文件是否生成与更新时间；Logstash 日志搜 last_run</td><td>创建目录并授权；将 record_last_run/clean_run/use_column_value 改为布尔值；固定部署用户与路径</td></tr><tr><td>每分钟调度不执行</td><td>schedule 时区/cron 解析问题；进程未持续运行（前台退出）</td><td>Logstash 日志看是否打印 scheduler tick；确认进程存活</td><td>用标准 cron 表达式；保持进程常驻（systemd/守护进程）；必要时加大日志级别</td></tr><tr><td>拉取速度慢/数据库压力大</td><td>SQL 无索引、全表扫；批次太小/网络慢</td><td>DB 侧看慢查询与执行计划；Logstash 侧看每轮耗时</td><td>给 tracking_column 建索引；只选必要字段；分批分页（statement + 主键范围）；合理调度频率</td></tr><tr><td>syslog 端口无数据</td><td>rsyslog 未转发/防火墙拦截/目标主机不可达</td><td>目标机 ss -lntup 看 6789 是否监听；源机 tcpdump 抓包</td><td>放通 6789 TCP/UDP；确认 @@(TCP) 或 @(UDP)；校验主机名解析与路由</td></tr><tr><td>收到数据但 grok 解析失败（_grokparsefailure）</td><td>消息格式与 grok 模式不匹配（设备/系统差异）</td><td>stdout 里看原始 message；观察字段是否缺失</td><td>按实际日志改 grok；先宽松再收紧；为不同来源做分支匹配</td></tr><tr><td>时间戳不对/时区错乱</td><td>date 匹配格式不全；源日志无年份/时区信息</td><td>看 @timestamp 与 syslog_timestamp；比对时区</td><td>date 增加匹配格式；必要时补 timezone =&gt; "Asia/Shanghai"；或在 rsyslog 侧输出 RFC3339</td></tr><tr><td>UDP 丢日志</td><td>UDP 天然不可靠；高峰期丢包/缓冲区不足</td><td>对比源端日志量与接收端事件量；系统丢包统计</td><td>关键日志改 TCP；提升内核缓冲区；降低单机解析压力（水平扩展/分流端口）</td></tr><tr><td>端口冲突/启动失败</td><td>端口被占用或权限不足（低端口）</td><td>启动日志提示 bind 失败；lsof -i :PORT</td><td>更换端口；释放占用；避免使用 514 等特权端口或用能力授权/前置转发</td></tr></tbody></table>
<h2 data-id="heading-19">其他系列</h2>
<h3 data-id="heading-20">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-21">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-196 消息队列选型：RabbitMQ vs RocketMQ vs Kafka</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-22">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对长上下文能力有不同要求，怎么选择合适的模型？]]></title>    <link>https://juejin.cn/post/7584307643000815659</link>    <guid>https://juejin.cn/post/7584307643000815659</guid>    <pubDate>2025-12-17T00:48:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307643000815659" data-draft-id="7584356212800569385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对长上下文能力有不同要求，怎么选择合适的模型？"/> <meta itemprop="keywords" content="LLM,人工智能,面试"/> <meta itemprop="datePublished" content="2025-12-17T00:48:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对长上下文能力有不同要求，怎么选择合适的模型？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:48:06.000Z" title="Wed Dec 17 2025 00:48:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 当一项技术的参数指标成为行业焦点，我们是否容易落入“数字迷信”的陷阱？在大语言模型竞相宣传“百万级上下文窗口”的今天，更长是否真的意味着更强？我们今天为大家带来的这篇文章，作者的核心观点是：上下文窗口的长度并不能完全代表模型的实际能力，真正决定模型在长文本场景下表现的是其背后的架构设计与技术权衡。</p>
<p>文章系统梳理了当前主流大模型在处理长上下文时所采用的不同技术路径 —— 从优化后的精确注意力机制（如 GPT-5、Mistral）、稀疏或混合注意力机制（如 Claude、Gemini），到彻底脱离注意力范式的状态空间模型（如 Mamba），并深入剖析了每种架构在记忆持久性、推理深度与计算效率之间的权衡。</p>
</blockquote>
<p><strong>作者 | Phuoc Nguyen</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>在过去三年中，大语言模型（LLMs）的上下文窗口已从几千个 token 扩展至数十万量级 —— 在某些系统中甚至达到数百万。Gemini 2.5、Claude 4.5 Sonnet、GPT-5 Pro 和 Llama 4 Scout 均宣称具备百万 token 级别的处理能力。乍看之下，这似乎意味着模型能够“记住”并跨整本书籍、整个代码仓库或数小时的对话进行推理。然而实际上，实际情况要复杂得多。</p>
<p><strong>更长的上下文窗口并不保证更深层次的推理能力或更为准确的记忆能力。</strong> 每种架构 —— Transformer、稀疏/混合架构、混合专家模型（MoE）或状态空间模型（Mamba），与上下文的交互方式各有不同。理解这些差异有助于开发者根据实际需求选择合适的模型，而不是简单地认为所有“百万 token 上下文”的系统都表现一致。</p>
<h2 data-id="heading-0"><strong>01 为什么只看上下文长度这个数字并不能完整判断模型的实际能力</strong></h2>
<p>原始的 Transformer（Vaswani 等人，2017）会对每一对 token 执行自注意力机制，理论上具备全局感知能力。然而，这种二次方复杂度（O(n²)）使得序列长度增长时计算量极速增加。</p>
<p><strong>现代长上下文系统通过工程技巧突破了这一限制 —— 但这些技巧也改变了模型的“思考”方式。</strong></p>
<p>实证测试（如 LongBench、RULER 2025）表明，即使宣称支持 1M-token 输入的模型，也很少能在超过其一半长度的上下文中维持高精度的推理能力。在实际使用中，“有效上下文”通常在达到上下文窗口长度宣传值上限的 30%–60% 时，就会出现记忆衰减。造成这一现象的原因因架构而异。</p>
<h2 data-id="heading-1"><strong>02 长上下文背后的架构技术</strong></h2>
<p>截至 2025 年底，大多数旗舰模型的上下文窗口已稳定在 128k 至 2M token 之间。然而，LongBench 和 RULER 等基准测试持续显示，模型的“有效上下文” （真正能<strong>不丢信息、不乱推理</strong>的上下文长度），往往仅为它们被宣传的最大值的一半左右。这一差距直接源于不同架构设计理念的分歧。</p>
<p><strong>当前的大模型生态已分化为若干独特的架构谱系，各自在推理深度、记忆持久性和计算效率之间做出不同的权衡。</strong> 下表总结了 2025 年底部分主流基础模型的上下文窗口情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4308a3b307ca40f7b3e153d24e3e531b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537286&amp;x-signature=0nBN6n9nu36qYouoWhTqFvcPvto%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>03 大语言模型是如何具体处理和利用其长上下文窗口的</strong></h2>
<p>要理解这些行为，我们需要深入其技术细节。模型的性能表现并非完全不可预测的魔法，其实是工程师为了解决“规模扩展”这个根本难题，被迫做出各种技术权衡后，直接导致的结果。</p>
<h3 data-id="heading-3"><strong>3.1 内存消耗减少的注意力机制</strong></h3>
<p>原始的自注意力机制允许每个 token 查看其他所有 token，其计算复杂度随序列长度呈二次方增长。这种计算复杂度上的陡增，使得处理几千 token 以上的上下文变得极其昂贵。现代架构通过以下几种方式克服这一限制：</p>
<ul>
<li><strong>经过优化的精确注意力机制（Optimized Exact Attention）</strong> ：Mistral 和 GPT-5 等模型并未改变注意力计算的数学本质，而是采用如 FlashAttention-3（GPT-5 据推测使用了该技术）等优化内核。该技术通过“分块”（tiling）大幅减少对 GPU 高带宽内存的慢速读写操作，使精确计算注意力在长达 256k token 甚至更长的序列上变得可行。</li>
<li><strong>稀疏或混合注意力机制（Sparse or Hybrid Attention）（例如 Claude、Gemini）</strong> ：这类架构会动态压缩或摘要部分上下文，以控制内存增长。具体实现大多属于商业机密，但学术研究版本（如 Longformer）表明，稀疏或混合注意力机制能够在序列增长时丢弃或聚合不那么重要的信息，从而维持主题连贯性并降低计算开销。</li>
<li><strong>分布式精确注意力机制（Distributed Exact Attention）</strong> ：对于可扩展系统，Ring Attention（Liu, 2023）能将计算负载分布到多个加速器组成的集群上。每个设备负责计算序列中某一片段的注意力，并将结果以环形的方式传递给下一个设备，从而实现对数百万 token 的精确注意力计算。据传 Google Gemini 1.5 采用了这种方法[1]，但由于其未公开专有架构，我们无法确认。这种架构在生产环境中的一个有趣特性是支持确定性计算模式（deterministic compute mode），有助于开发者获得更强的一致性保障。</li>
</ul>
<p>其影响体现为一种明确的权衡：“使用精确注意力机制的模型（exact attention models）”适合需要极高准确性的精细任务（如法律审阅），而“分布式模型（distributed models）”适合需要处理海量数据的批量任务（如大型媒体文件分析）。</p>
<h3 data-id="heading-4"><strong>3.2 为适应更长上下文而对位置编码方法进行扩展的方案</strong></h3>
<p>Transformer 模型本身不具备顺序感知能力。位置编码用于告诉模型每个 token 所处的位置，但所选用的方法会产生强大且可预测的 biases（译者注：biases 指模型在处理信息时，会系统性地更重视某些位置（比如开头、结尾），而相对忽视另一些位置（比如中间）。）。</p>
<ul>
<li><strong>旋转位置嵌入（Rotary Position Embeddings, RoPE）</strong> ：Llama 4 采用 RoPE，以相对方式编码位置信息。为了处理比训练数据更长的序列，它们使用 RoPE 缩放（RoPE scaling）技术，对位置值进行“拉伸”。虽然这能防止模型因位置混淆而“回绕”（wrap around），却降低了远距离 token 之间的位置分辨率，直接加剧了“中间迷失”（lost in the middle）问题 —— 即上下文中间部分的细节常被忽略或错误回忆。</li>
<li><strong>带线性偏置的注意力（Attention with Linear Biases, ALiBi）</strong> ：ALiBi 最初通过在注意力分数上施加与 token 距离成比例的线性惩罚来实现位置感知，如今 ALiBi 已成为主流的位置编码方案。它通过数学设计，强制模型更关注文本中较新的内容，但这种“近期偏好（recency bias）”是可控且平滑的，使得模型能够稳定地处理比训练时更长的序列。Mistral 系列模型即采用了 ALiBi，并结合使用了 FlashAttention 库。</li>
</ul>
<p><strong>这或许可以解释：在长问答任务中，GPT-5 可能能正确关联两个相距较远的事实，却对中段信息产生幻觉性补充；而某个 Llama 变体则可能完全忽略提示词开头的内容，只关注结尾部分。</strong></p>
<h3 data-id="heading-5"><strong>3.3 稀疏与分块注意力机制（Sparse and Chunked Attention）</strong></h3>
<p>为避免完整的 O(n²) 复杂度的注意力计算，Longformer 或 BigBird 等架构采用稀疏模式（例如分块或滑动窗口），而分块方法将长序列切割成片段，并在处理后续片段时携带并利用之前片段的“状态（译者注：模型对该块内容的理解和记忆。）”（例如 GLM-4 中的 Retentive Transformer）。Claude 4 的混合方案则会动态压缩较旧的上下文。</p>
<p>实际影响：稀疏设计在智能体（agentic）工作流中表现突出 —— 子智能体可分别处理不同片段，进行分层摘要，有效减少了多步骤规划等长程任务中的信息干扰。它们在软件工程中也十分高效，例如分析大型代码库时无需完整重载上下文。</p>
<h2 data-id="heading-6"><strong>04 超越注意力机制：状态空间模型的崛起</strong></h2>
<p>有一类新型架构正在彻底脱离注意力机制的范式。其中最引人注目的是 Mamba（Gu &amp; Dao, 2024），它用选择性状态空间模型（Selective State Space Model, SSM）取代了自注意力机制。<strong>Mamba 并不会逐一比较每对 token，而是维护一个不断演化的隐状态，作为对过去 token 的压缩记忆，并选择性地更新该状态 —— 学习何时覆盖、何时保留信息。</strong></p>
<p>这种方法实现了线性时间处理 —— 每个 token 的处理时间为常数，使 Mamba 的实际扩展复杂度达到 O(n)。在实际应用中，这意味着它能以恒定的内存消耗处理数百万 token，即便是 GPT-5 或 Gemini 等经过高度优化的 Transformer 也难以做到这一点。</p>
<p>与需要显式计算 token 间关系的注意力机制不同，Mamba 的选择性扫描机制（selective scan）更像一个动态滤波器，自主决定将哪些历史信息向前传递。Mamba 不会像 Transformer 那样存储一张清晰的、记录着所有词元之间关系的“地图”，而是维持着一段对序列进行持续压缩而形成的“记忆流”。这种设计使 Mamba 在“大海捞针”式检索、流式数据处理和序列化问答等任务中表现卓越 —— 在这些场景中，持久的记忆能力比精细的关系推理更为关键。</p>
<p>然而其优势伴随相应代价。由于内部状态经过压缩，Mamba 有时会丢失细节，在复杂的多跳推理任务中表现吃力。目前，新兴的混合架构【如 IBM 的 Granite 4.0，以及 Gemini 2.5 Pro（可能）】已开始探索将 Mamba 式的循环记忆与 Transformer 推理层结合，以期兼顾记忆稳定性和逻辑深度。</p>
<p>Granite 4.0 混合模型实际上采用了 9:1 的 Mamba-2 模块与 Transformer 模块比例。其核心理念是：由 Mamba 以轻量高效的方式处理宏观上下文和长程记忆，而周期性插入的 Transformer 层则负责处理精细的关系推理任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c43e615d8d4473ab2684d5d9458712a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537286&amp;x-signature=bmoCIGPpsQrgfkeRlO1nWIveVsA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>05 推理深度 vs. 上下文广度</strong></h2>
<p>研究一再证实，仅靠更长的上下文长度并不能保证稳定的推理能力。Liu 等人（2023）揭示了“中间迷失”（lost in the middle）效应：模型的记忆呈现系统性的 U 型曲线 —— 过度强调最近的和最开始的 token，却忽视了提示词中间部分的信息。这一现象后来被称为上下文衰减（context rot），即便在 2025 年的模型架构中依然存在，只是缓解手段有所演进。IBM 的 Granite 4.0 模型（IBM, 2025）引入了分层记忆路由和混合注意力层，能够显式地在数十万 token 的上下文中保持每个 token 的重要性（译者注：即哪些信息更值得保留和关注），初步展现出超越标准 Transformer 的稳定性。</p>
<ul>
<li><strong>Dense Transformers（如 GPT-5 和 Mistral）</strong></li>
</ul>
<p>它们的失败往往在于毫厘之差，而非千里之谬。由于它们进行完整注意力计算，很少完全崩溃，其错误通常表现为微妙的事实幻觉 —— 例如，第 50,000 个 token 中的某个细节几乎能被正确回忆，却在关键数字或名称上出错。</p>
<ul>
<li><strong>Compression-Hybrids（如 Claude 4.5）</strong></li>
</ul>
<p>其失败源于过度谨慎。其优势在于保持主题连贯性，弱点则是经过对齐微调的模型可能将大量用户提供的文本（如整部小说）误判为受版权保护的内容，从而导致礼貌地拒绝回答。</p>
<ul>
<li><strong>Sparse and Multimodal models（如 Gemini 2.5）</strong></li>
</ul>
<p>它们具备近乎完美的事实回忆能力。主要的失败点往往来自模型外围的安全机制：在处理数百万多模态 token 时，一个过于敏感的安全过滤器可能在噪声中产生误报，导致响应被提前中止。</p>
<ul>
<li><strong>Mixture-of-Experts models（如 Llama 4 和 Qwen）</strong></li>
</ul>
<p>这类模型可能会因为出现“指令漂移”或“不断输出重复内容”而失效。当复杂查询逼近上下文极限时，专家路由机制可能开始失灵，导致模型“迷失位置”，转而输出通用的或重复的内容。</p>
<ul>
<li><strong>State-Space Models（如 Mamba）</strong></li>
</ul>
<p>Mamba 带来了一种新型的失效模式。由于它将信息存储为连续的内部状态，错误通常表现为信息压缩损失，而非直接的幻觉。模型可能准确记得某事实曾在序列早期出现，但在转述时进行了不精确的简化或改写。这种特性使其在超长上下文中极为稳定，但在需要精细分析推理（尤其是依赖上下文的消歧任务）时偶尔不够精确。</p>
<p>同样属于 SSM（State-Space Models） 范畴的，还有 IBM 的 Granite 4.0 系列，它代表了一种“稠密-稀疏混合”架构，结合了混合专家模型与自适应压缩的特性。它并非纯粹将 token 路由到不同专家，而是采用分层聚合和长期记忆层，来减少远距离信息传递中的梯度衰减。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617c75be821d48e1afde1673871ee216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537286&amp;x-signature=Fpdaescw1cIxoOEcqig11i9gGrU%3D" alt="image.png" loading="lazy"/></p>
<p>架构选择直接决定了用户所能体验到的“长上下文”的实际效果</p>
<h2 data-id="heading-8"><strong>06 实际权衡与使用场景</strong></h2>
<p>以下是针对不同架构选择的一些应用场景建议：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f82e8f0014a4620a3bc86552e4ada61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537286&amp;x-signature=OJ6DSoR1hRx94ICMAzwNkwAT1ew%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>07 未来发展方向：更智能，而非更长</strong></h2>
<p>截至2025年末，上下文扩展的重点已非单纯增加词元数量，而是更注重让每个 token 都有意义。高效利用上下文需要结合架构设计（architectural design）、数据扩展（data scaling）和程序化推理（procedural reasoning）。</p>
<p>未来的系统很可能融合这些方向 —— <strong>用状态空间模型保证持久记忆，用注意力机制保障精度，再通过条件推理提升整体效率。</strong></p>
<p>开发者应在不同架构间进行测试比较，而非仅关注上下文窗口大小。如果模型的内在偏好（inductive biases）（比如重视局部连贯性、压缩远距离信息）与任务特性相匹配，一个 128k 上下文窗口大小的稀疏模型完全可能胜过 1M 的密集模型。<strong>归根结底，上下文能力是架构特性的体现，而不仅仅是计算量（或算力规模）的堆砌结果。</strong></p>
<h2 data-id="heading-10"><strong>References</strong></h2>
<p>Gu, A., &amp; Dao, T. (2024). Mamba: Linear-time sequence modeling with selective state spaces. arXiv:2312.00752.</p>
<p>Liu, N. F., Röttger, P., Misra, K., Yu, J., &amp; Levy, O. (2023). Lost in the middle: How language models use long contexts. arXiv:2307.03172</p>
<p>International Business Machines Corporation. (2025, October 2). IBM Granite 4.0: Hyper-efficient, high-performance hybrid models. IBM Newsroom. Retrieved from <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fnew%2Fannouncements%2Fibm-granite-4-0-hyper-efficient-high-performance-hybrid-models" target="_blank" title="https://www.ibm.com/new/announcements/ibm-granite-4-0-hyper-efficient-high-performance-hybrid-models" ref="nofollow noopener noreferrer">www.ibm.com/new/announc…</a></p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓文章指出“长上下文竞赛的重点正从‘记多长’转向‘如何记’”。你是否认同这是未来的主要技术方向？你认为业界接下来最需要突破的架构瓶颈是什么？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40ignacio.de.gregorio.noblejas%2Fis-this-the-secret-to-googles-success-over-chatgpt-b2a545f39ad5" target="_blank" title="https://medium.com/@ignacio.de.gregorio.noblejas/is-this-the-secret-to-googles-success-over-chatgpt-b2a545f39ad5" ref="nofollow noopener noreferrer">medium.com/@ignacio.de…</a></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40phuocnguyen90%2Funderstanding-long-context-windows-in-ai-models-65eeb76ca20a" target="_blank" title="https://medium.com/@phuocnguyen90/understanding-long-context-windows-in-ai-models-65eeb76ca20a" ref="nofollow noopener noreferrer">medium.com/@phuocnguye…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-51、构建乘积数组]]></title>    <link>https://juejin.cn/post/7584279552434110502</link>    <guid>https://juejin.cn/post/7584279552434110502</guid>    <pubDate>2025-12-17T00:49:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584279552434110502" data-draft-id="7582896213855600655" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-51、构建乘积数组"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-17T00:49:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-51、构建乘积数组
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:49:18.000Z" title="Wed Dec 17 2025 00:49:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>给定⼀个数组A[0,1,...,n-1] ,请构建⼀个数组B[0,1,...,n-1] ，其中B 中的元素<code>B[i]=A[0]*A[1]*...*A[i-1]*A[i+1]*...*A[n-1]</code> 。不能使⽤除法。（注意：规定<code>B[0] =A[1] * A[2] * ... * A[n-1]，B[n-1] = A[0] * A[1] * ... * A[n-2]</code> ）</p>
<p>对于A ⻓度为1 的情况，B⽆意义，故⽽⽆法构建，因此该情况不会存在。</p>
<p>输⼊：[1,2,3,4,5]
输出：[120,60,40,30,24]</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">暴力</h3>
<p>对每个B[i]都计算A中除A[i]外所有元素的乘积，双重循环，外层遍历B的每个位置，内层遍历A数组跳过当前元素</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] multiply(<span class="hljs-type">int</span>[] A) {
        <span class="hljs-keyword">if</span> (A == <span class="hljs-literal">null</span> || A.length &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 根据题目要求，长度&lt;=1时返回空数组</span>
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> A.length;
        <span class="hljs-type">int</span>[] B = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];
        
        <span class="hljs-comment">// 遍历每个B[i]</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            <span class="hljs-type">int</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 初始化乘积为1</span>
            
            <span class="hljs-comment">// 计算A中除A[i]外所有元素的乘积</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; n; j++) {
                <span class="hljs-keyword">if</span> (j != i) { <span class="hljs-comment">// 跳过当前元素A[i]</span>
                    product *= A[j];
                }
            }
            
            B[i] = product; <span class="hljs-comment">// 将结果存入B[i]</span>
        }
        
        <span class="hljs-keyword">return</span> B;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n²)，需要嵌套循环遍历数组</li>
<li><strong>空间复杂度</strong>：O(1)，除结果数组外只使用常数空间</li>
</ul>
<h3 data-id="heading-3">左右乘积数组法（空间换时间）</h3>
<p>使用左右两个辅助数组存储乘积信息</p>
<p>思路：left[i]表示A[0]到A[i-1]的乘积，right[i]表示A[i+1]到A[n-1]的乘积</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] multiply(<span class="hljs-type">int</span>[] A) {
        <span class="hljs-keyword">if</span> (A == <span class="hljs-literal">null</span> || A.length &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> A.length;
        <span class="hljs-type">int</span>[] B = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];
        <span class="hljs-type">int</span>[] left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];  <span class="hljs-comment">// 存储左侧乘积</span>
        <span class="hljs-type">int</span>[] right = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n]; <span class="hljs-comment">// 存储右侧乘积</span>
        
        <span class="hljs-comment">// 初始化边界值</span>
        left[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;     <span class="hljs-comment">// B[0]没有左侧元素，乘积为1</span>
        right[n-<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;  <span class="hljs-comment">// B[n-1]没有右侧元素，乘积为1</span>
        
        <span class="hljs-comment">// 计算左侧乘积：left[i] = A[0] × A[1] × ... × A[i-1]</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; n; i++) {
            left[i] = left[i-<span class="hljs-number">1</span>] * A[i-<span class="hljs-number">1</span>];
        }
        
        <span class="hljs-comment">// 计算右侧乘积：right[i] = A[i+1] × A[i+2] × ... × A[n-1]</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> n-<span class="hljs-number">2</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            right[i] = right[i+<span class="hljs-number">1</span>] * A[i+<span class="hljs-number">1</span>];
        }
        
        <span class="hljs-comment">// 合并左右乘积得到最终结果：B[i] = left[i] × right[i]</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) {
            B[i] = left[i] * right[i];
        }
        
        <span class="hljs-keyword">return</span> B;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，三次单层循环</li>
<li><strong>空间复杂度</strong>：O(n)，需要两个辅助数组</li>
</ul>
<p><strong>矩阵视角理解</strong>： 如果把问题看作矩阵，B[i]就是去掉对角线元素A[i]后，该行所有元素的乘积。</p>
<pre><code class="hljs language-text" lang="text">A = [1, 2, 3, 4, 5]

B[0] = 2 × 3 × 4 × 5 = 120  (去掉A[0])
B[1] = 1 × 3 × 4 × 5 = 60   (去掉A[1])  
B[2] = 1 × 2 × 4 × 5 = 40   (去掉A[2])
</code></pre>
<p><strong>左右分解策略：</strong></p>
<ul>
<li><code>left[i]</code>= A[0] × A[1] × ... × A[i-1] （i左边的乘积）</li>
<li><code>right[i]</code>= A[i+1] × A[i+2] × ... × A[n-1] （i右边的乘积）</li>
<li><code>B[i] = left[i] × right[i]</code>（左右乘积相乘正好去掉A[i]）</li>
</ul>
<h3 data-id="heading-4">空间优化（推荐）</h3>
<p>在方法二的基础上优化空间使用，在结果数组B上直接进行左右乘积计算。</p>
<p>先用B数组存储左侧乘积，再用变量动态计算右侧乘积</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] multiply(<span class="hljs-type">int</span>[] A) {
        <span class="hljs-keyword">if</span> (A == <span class="hljs-literal">null</span> || A.length &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> A.length;
        <span class="hljs-type">int</span>[] B = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];
        
        <span class="hljs-comment">// 第一步：计算左侧乘积并直接存入B</span>
        B[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// B[0]没有左侧元素</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; n; i++) {
            <span class="hljs-comment">// B[i] = A[0] × A[1] × ... × A[i-1]</span>
            B[i] = B[i-<span class="hljs-number">1</span>] * A[i-<span class="hljs-number">1</span>];
        }
        
        <span class="hljs-comment">// 第二步：从右向左遍历，用temp变量累积右侧乘积</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 用于累积右侧乘积</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> n-<span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-comment">// B[i]当前存储的是左侧乘积，乘以右侧乘积得到最终结果</span>
            B[i] = B[i] * temp;
            <span class="hljs-comment">// 更新temp，为下一个位置（i-1）准备右侧乘积</span>
            temp = temp * A[i];
        }
        
        <span class="hljs-keyword">return</span> B;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，两次遍历数组</li>
<li><strong>空间复杂度</strong>：O(1)，除结果数组外只使用常数空间</li>
</ul>
<p><strong>算法步骤详解</strong></p>
<ol>
<li>第一步：左侧乘积计算</li>
</ol>
<pre><code class="hljs language-less" lang="less">初始: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[0]</span> = <span class="hljs-number">1</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">1</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[1]</span> = <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[0]</span> × <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[0]</span> = <span class="hljs-number">1</span> × <span class="hljs-number">1</span> = <span class="hljs-number">1</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">2</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[2]</span> = <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[1]</span> × <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[1]</span> = <span class="hljs-number">1</span> × <span class="hljs-number">2</span> = <span class="hljs-number">2</span>  
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">3</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[3]</span> = <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[2]</span> × <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[2]</span> = <span class="hljs-number">2</span> × <span class="hljs-number">3</span> = <span class="hljs-number">6</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">4</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[4]</span> = <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[3]</span> × <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[3]</span> = <span class="hljs-number">6</span> × <span class="hljs-number">4</span> = <span class="hljs-number">24</span>
此时<span class="hljs-selector-tag">B</span> = <span class="hljs-selector-attr">[1, 1, 2, 6, 24]</span> (存储的是各位置的左侧乘积)
</code></pre>
<ol start="2">
<li>第二步：右侧乘积整合</li>
</ol>
<pre><code class="hljs language-less" lang="less">初始: <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">1</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">4</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[4]</span> = <span class="hljs-number">24</span> × <span class="hljs-number">1</span> = <span class="hljs-number">24</span>, <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">1</span> × <span class="hljs-number">5</span> = <span class="hljs-number">5</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">3</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[3]</span> = <span class="hljs-number">6</span> × <span class="hljs-number">5</span> = <span class="hljs-number">30</span>, <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">5</span> × <span class="hljs-number">4</span> = <span class="hljs-number">20</span>  
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">2</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[2]</span> = <span class="hljs-number">2</span> × <span class="hljs-number">20</span> = <span class="hljs-number">40</span>, <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">20</span> × <span class="hljs-number">3</span> = <span class="hljs-number">60</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">1</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[1]</span> = <span class="hljs-number">1</span> × <span class="hljs-number">60</span> = <span class="hljs-number">60</span>, <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">60</span> × <span class="hljs-number">2</span> = <span class="hljs-number">120</span>
<span class="hljs-selector-tag">i</span>=<span class="hljs-number">0</span>: <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[0]</span> = <span class="hljs-number">1</span> × <span class="hljs-number">120</span> = <span class="hljs-number">120</span>, <span class="hljs-selector-tag">temp</span> = <span class="hljs-number">120</span> × <span class="hljs-number">1</span> = <span class="hljs-number">120</span>
最终<span class="hljs-selector-tag">B</span> = <span class="hljs-selector-attr">[120, 60, 40, 30, 24]</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor 可视化编辑器实测：前端效率新利器，但仍需完善]]></title>    <link>https://juejin.cn/post/7584353612500779049</link>    <guid>https://juejin.cn/post/7584353612500779049</guid>    <pubDate>2025-12-17T00:53:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584353612500779049" data-draft-id="7584356212800602153" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor 可视化编辑器实测：前端效率新利器，但仍需完善"/> <meta itemprop="keywords" content="Cursor,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-12-17T00:53:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor 可视化编辑器实测：前端效率新利器，但仍需完善
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:53:54.000Z" title="Wed Dec 17 2025 00:53:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>12月10日，<code>Cursor</code> 发布了 2.2 版本。</p>
<p>这个版本主要包含两个重大特性：</p>
<ol>
<li>在 Ask、Agent、Plan 模式后，增加了 <strong>Debug 模式</strong>，可以更加方便大家调试 bug。</li>
<li>原来测试的内置浏览器升级为<strong>可视化编辑器</strong>了，支持布局调整和样式编辑。</li>
</ol>
<p>今天，先和大家聊聊浏览器这块升级体验如何。</p>
<h2 data-id="heading-0">升级内容</h2>
<p>我尝试下来，提升主要集中在以下两个方面：</p>
<ul>
<li>精准定位</li>
<li>可视化</li>
</ul>
<h3 data-id="heading-1">精准定位</h3>
<p>大家在使用 AI 开发前端的过程中一定遇到类似下面的情况：“请为导航栏中第二行第三个菜单样式增加热点图标，它是我们目前主推的活动。”</p>
<p>就是简单的一个高显效果，但是需要很多额外的文字来保证目标元素的命中。</p>
<p>现在有了可视化浏览器，就可以<strong>直接点选目标</strong>，然后加入对话，进而通过指令进行修改。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/544fa284fa0445b1ab25a53647993f80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=hKG%2FbICqf18joC4YxiRyVC5rcjY%3D" alt="" loading="lazy"/></p>
<p>但这个特性在之前内测的浏览器功能中已经体验过了，并不算很出彩。</p>
<h3 data-id="heading-2">可视化</h3>
<p>另一个升级的重点就是可视化。</p>
<p>第1点，增加了 <code>Design</code> 和 <code>CSS</code> 面板，不用在代码中即可完成页面效果的调整，包括文字内容、颜色样式等。</p>
<p>尤其是 <code>Design</code> 面板，明摆着冲 <code>Figma</code> 等原型工具去的。现阶段 AI 在原型制作阶段已经非常有效果了，如果再加上可视化编辑，必将更加高效。</p>
<p>如果修改内容了，记得点击“Apply”，如果操作错误，也可以“撤销”或者直接“取消”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/443a203c2d5240d79750b4d9f53d36f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=yJl9f4N%2Bs3RqNmnf0Lfcdr1%2FQWs%3D" alt="" loading="lazy"/></p>
<p>第2点，浏览器中的元素，可以直接拖动位置、调整大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39a56e5541b448e5abaa88aae7b049c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=weKFNyUdhUq48LrrGSRbSdTVgrQ%3D" alt="拖动位置后的标题" loading="lazy"/></p>
<p>再也不会出现调整过头、反复优化的问题了，<strong>所见即所得</strong>，一步到位。</p>
<p>调整大小的使用不是很直观，需要将鼠标放到 <code>Layout</code> - <code>Dimensions</code> 下的 <code>W</code> 上，当鼠标变为双向箭头时，拖动即可调整。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e223cbacbc94f5c95d443e5f4bf5d7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=elshBZmz4IRtighDq9jSesu4y3w%3D" alt="双向箭头可调整宽度" loading="lazy"/></p>
<h2 data-id="heading-3">改进的地方</h2>
<p>升级内容体验起来还是不错的，但还有几个地方明显需要继续改进。</p>
<p>一个是，官方宣称的直接修改 <code>props</code> 目前好像<strong>仅支持 React 工程</strong>，Vue 工程是不行的，直接没有 <code>Properties</code> 部分。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5654d9abbf4b35a136f5a8be654cbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=oVIYDCTrp7yJPojoEZwwhFJkae4%3D" alt="" loading="lazy"/></p>
<p>另一个是，页面元素支持直接拖动，但是拖动导致的 <code>DOM</code> 结构变化，会<strong>影响到原有的样式</strong>。应该实现原有样式同步移动并保持效果，这样的拖动才算更加有价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80a6868d895c41c9b712f660313bb296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=CzJRnWbbpUpw9CNOu0jRWyGTkZ8%3D" alt="第二条移动后样式被影响" loading="lazy"/></p>
<p>再有一个就是，<code>Cursor Browser</code> 开放了开发者工具，包括大家常用的 <code>Console</code> 选项卡。</p>
<p>但是，目前 <code>Console</code> 中出现的<strong>错误</strong>，并不能像 <code>TRAE</code> 一样直接<strong>点选加入对话</strong>，需要复制粘贴，不够一体化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbfd024bd08d42d1aea5d4f61d6b7137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537633&amp;x-signature=IyDx5XXi0H758kNFEOJ3RH%2FT1sY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">结语</h2>
<p>在我的使用历程中，内置浏览器及相关特性是由 <code>TRAE</code> 最先提出并实现的，但目前 <code>Cursor</code> 明显做的更加深入了。</p>
<p>其实我挺希望他们可以相互“借鉴”，毕竟，<strong>值得“借鉴”的肯定是反响好的特性，越来越多好特性的升级，必然带来 AI 开发的新体验</strong>。</p>
<p>期待后续各家的升级~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 CSS 伪类和伪元素的本质区别]]></title>    <link>https://juejin.cn/post/7584266184882880546</link>    <guid>https://juejin.cn/post/7584266184882880546</guid>    <pubDate>2025-12-17T00:54:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584266184882880546" data-draft-id="7576936862632411136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 CSS 伪类和伪元素的本质区别"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-17T00:54:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 CSS 伪类和伪元素的本质区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-17T00:54:34.000Z" title="Wed Dec 17 2025 00:54:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在写前端CSS样式的时候，经常用到这种<code>:hover</code>或者<code>::before</code>有冒号的写法。我很疑惑，为什么有些是单冒号，有些又是双冒号呢？</p>
<p>后来我才知道这种写法也区分为<strong>伪类</strong>和<strong>伪元素</strong>。</p>
<h3 data-id="heading-0">伪类和伪元素是什么？</h3>
<p><strong>伪类（Pseudo-classes）</strong>：​用于选择处于特定状态的元素。也可以理解为，当元素处于某种状态的时候，给它加上一个“类”来定义样式。</p>
<ul>
<li>语法：​单个冒号<code>:</code>，例如<code>:hover</code></li>
</ul>
<p><strong>伪元素（Pseudo-elements）</strong>：用于选择元素的特定部分。可以理解为，它在文档中创建了一个虚拟的“元素”来设置样式。</p>
<ul>
<li>语法：双冒号<code>::</code>，例如<code>::before</code></li>
</ul>
<hr/>
<h3 data-id="heading-1">只要是单个冒号的就一定是伪元素吗？</h3>
<p>在现代CSS3点规范中，所有使用双冒号<code>::</code>语法的选择器都被定义为伪元素。这是W3C为了明确区分伪类和伪元素而引入的约定。</p>
<p>但在早期的CSS中，伪元素也使用单冒号，因为当时没有区分语法。所以为了向后兼容，大多数的浏览器还是会支持<code>:before</code>、<code>:after</code>等单冒号的写法。</p>
<p>但新的伪元素只支持双冒号，比如：<code>::selection</code>。</p>
<hr/>
<h3 data-id="heading-2">伪类（Pseudo-classes）</h3>
<p>伪类用于<strong>选择处于特定状态的元素</strong>，比如用户交互状态、结构位置等。</p>
<h4 data-id="heading-3">常见伪类示例：</h4>
<ul>
<li><code>:hover</code>：鼠标悬停时</li>
<li><code>:focus</code>：元素获得焦点时（如输入框）</li>
<li><code>:active</code>：元素被激活时（如点击按钮）</li>
<li><code>:visited</code>：链接已被访问过</li>
<li><code>:first-child</code> / <code>:last-child</code>：第一个/最后一个子元素</li>
<li><code>:nth-child(n)</code>：第 n 个子元素</li>
<li><code>:not(selector)</code>：排除匹配 selector 的元素</li>
</ul>
<h4 data-id="heading-4">示例：</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:focus</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid blue;
}

<span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">font-weight</span>: bold;
}
</code></pre>
<p>伪类使用<strong>单冒号</strong>。</p>
<hr/>
<h3 data-id="heading-5">伪元素（Pseudo-elements）</h3>
<p>伪元素用于<strong>创建并样式化文档中不存在的虚拟元素</strong>，比如段落首字母、选中文本、元素前后插入内容等。</p>
<h4 data-id="heading-6">常见伪元素：</h4>
<ul>
<li><code>::before</code>：在元素内容前插入内容</li>
<li><code>::after</code>：在元素内容后插入内容</li>
<li><code>::first-letter</code>：段落的第一个字母</li>
<li><code>::first-line</code>：段落的第一行</li>
<li><code>::selection</code>：用户选中的文本（部分浏览器需加前缀）</li>
</ul>
<h4 data-id="heading-7">示例：</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span><span class="hljs-selector-pseudo">::first-letter</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2em</span>;
  <span class="hljs-attribute">color</span>: gold;
}

<span class="hljs-selector-class">.quote</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">"“"</span>;
}

<span class="hljs-selector-class">.quote</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">"”"</span>;
}

<span class="hljs-selector-pseudo">::selection</span> {
  <span class="hljs-attribute">background</span>: yellow;
  <span class="hljs-attribute">color</span>: black;
}
</code></pre>
<p>伪元素使用<strong>双冒号</strong>（<code>::before</code>），这是CSS3的规范写法。出于兼容性考虑，旧代码可能仍用单冒号（如<code>:before</code>），现代项目建议用双冒号。</p>
<hr/>
<h3 data-id="heading-8">主要区别</h3>






























<table><thead><tr><th>特性</th><th>伪类（Pseudo-class）</th><th>伪元素（Pseudo-element）</th></tr></thead><tbody><tr><td>作用对象</td><td>已存在的元素的<strong>状态或位置</strong></td><td>创建<strong>不存在的虚拟内容或部分</strong></td></tr><tr><td>语法</td><td>单冒号（如 <code>:hover</code>）</td><td>双冒号（如 <code>::before</code>）</td></tr><tr><td>是否生成内容</td><td>否</td><td>是（常配合 <code>content</code> 属性）</td></tr><tr><td>示例</td><td><code>a:hover</code>, <code>:nth-child(2)</code></td><td><code>::first-letter</code>, <code>::after</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">示例效果</h3>
<p>一个简单的待办事项列表
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0592bd2d56b48c689768cb07b368be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY5aSn5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766537673&amp;x-signature=%2FiRwnx4WTNIkf3UjEJUqOy02d6A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-10">完整代码</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>伪类vs伪元素示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">500px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
        }

        <span class="hljs-selector-tag">h1</span> {
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#2c3e50</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
        }

        <span class="hljs-selector-class">.explanation</span> {
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#3498db</span>;
        }

        <span class="hljs-selector-class">.todo-list</span> {
            <span class="hljs-attribute">list-style</span>: none;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span> {
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">8px</span> <span class="hljs-number">0</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#e9ecef</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
            <span class="hljs-attribute">cursor</span>: pointer;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
            <span class="hljs-attribute">position</span>: relative;
        }

        <span class="hljs-comment">/* === 伪类样式 === */</span>
        <span class="hljs-comment">/* 第一个子元素 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:first</span>-child {
            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">4px</span> solid <span class="hljs-number">#e74c3c</span>;
        }

        <span class="hljs-comment">/* 偶数项 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(even) {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
        }

        <span class="hljs-comment">/* 悬停效果 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:hover</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#aab49b</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">10px</span>);
            <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#aab49b</span>;
        }

        <span class="hljs-comment">/* 点击效果 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:active</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#2ecc71</span>;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.98</span>);
        }

        <span class="hljs-comment">/* === 伪元素样式 === */</span>
        <span class="hljs-comment">/* 前面的图标 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">::before</span> {
            <span class="hljs-attribute">content</span>: <span class="hljs-string">"📌"</span>;
            <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
        }

        <span class="hljs-comment">/* 悬停时图标变化 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::before</span> {
            <span class="hljs-attribute">content</span>: <span class="hljs-string">"🔥"</span>;
            <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
        }

        <span class="hljs-comment">/* 后面的装饰线 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">::after</span> {
            <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">3px</span>;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#e74c3c</span>, <span class="hljs-number">#669521</span>);
            <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> ease;
        }

        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::after</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
        }

        <span class="hljs-comment">/* 首字母样式 */</span>
        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">::first-letter</span> {
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.3em</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#2c3e50</span>;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.todo-list</span> <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::first-letter</span> {
            <span class="hljs-attribute">color</span>: white;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>伪类 vs 伪元素 演示<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"explanation"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>伪类（Pseudo-class）<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>：选择元素的特定<span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>状态<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>伪元素（Pseudo-element）<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>：选择元素的特定<span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>部分<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>学习 CSS 伪类<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>理解伪元素<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>完成项目练习<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>复习知识点<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 添加点击切换完成状态的功能</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.todo-list li'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
            item.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">'completed'</span>);
            });
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>在这个示例中，可以清晰地看到：</p>
<h4 data-id="heading-11">伪类（操作的是整个元素）</h4>
<ul>
<li><code>:first-child</code>：操作第一个<code>&lt;li&gt;</code>元素的整体样式</li>
<li><code>:nth-child(even)</code>：操作偶数位置<code>&lt;li&gt;</code>的整体背景</li>
<li><code>:hover</code>：操作鼠标悬停时<code>&lt;li&gt;</code>的整体状态变化</li>
</ul>
<h4 data-id="heading-12">伪元素（操作的是元素的一部分）</h4>
<ul>
<li><code>::before</code>：在<code>&lt;li&gt;</code>内容之前插入新内容（图标）</li>
<li><code>::after</code>：在<code>&lt;li&gt;</code>内容之后插入装饰线条</li>
<li><code>::first-letter</code>：只样式化<code>&lt;li&gt;</code>文本的第一个字母</li>
</ul>
<p><strong>简单记忆</strong>：伪类是状态选择器，伪元素是内容生成器。</p>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p><strong>伪类</strong>：</p>
<ul>
<li>选择元素的<strong>特定状态</strong>（如:hover、:focus）</li>
<li>语法使用<strong>单冒号</strong>（如<code>:hover</code>）</li>
<li>不生成新内容，只针对元素本身的状态变化</li>
<li>常见用途：用户交互反馈、结构位置选择</li>
</ul>
<p><strong>伪元素</strong>：</p>
<ul>
<li>创建并样式化元素的<strong>特定部分</strong>或<strong>虚拟内容</strong></li>
<li>语法使用<strong>双冒号</strong>（如<code>::before</code>）</li>
<li>常配合<code>content</code>属性生成新内容</li>
<li>常见用途：插入装饰元素、样式化文本部分</li>
</ul>
<p>通过上面的内容，我也终于搞懂了伪类和伪元素的区别。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-14">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3 和 Vue2 的核心区别？很多开发者都没完全搞懂的 10 个细节》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#.NET ref struct 深度解析：语义、限制与最佳实践]]></title>    <link>https://juejin.cn/post/7584266184882700322</link>    <guid>https://juejin.cn/post/7584266184882700322</guid>    <pubDate>2025-12-16T23:19:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584266184882700322" data-draft-id="7584286241488535592" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#.NET ref struct 深度解析：语义、限制与最佳实践"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-16T23:19:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#.NET ref struct 深度解析：语义、限制与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T23:19:59.000Z" title="Tue Dec 16 2025 23:19:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p><code>ref struct</code> 是 <code>C# 7.2</code> 引入的一种特殊结构体类型，
它与普通 <code>struct</code> 的最大区别是 严格限制其分配位置：</p>
<p><code>ref struct</code> 只能分配在栈（<code>stack</code>）上，不能分配在堆（<code>heap</code>）上。</p>
<p>⚡ 设计初衷</p>
<ul>
<li>
<p>提高性能：栈分配比堆分配快，并且无需 <code>GC</code> 回收。</p>
</li>
<li>
<p>提供安全的内存访问：保证生命周期受控，防止内存泄漏和悬空引用。</p>
</li>
<li>
<p>适用于需要直接操作内存的场景，例如 <code>Span&lt;T&gt;</code>、<code>ReadOnlySpan&lt;T&gt;</code>。</p>
</li>
</ul>
<h4 data-id="heading-1">关键特性</h4>
<ul>
<li>
<p>只能分配在栈上，不能分配在堆上</p>
</li>
<li>
<p>不能作为类的字段</p>
</li>
<li>
<p>不能实现接口</p>
</li>
<li>
<p>不能装箱</p>
</li>
<li>
<p>不能作为异步方法或迭代器的局部变量</p>
</li>
</ul>
<h3 data-id="heading-2">基本语法</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> MyStruct
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> X;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Y;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Print</span>()</span> =&gt; Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{X}</span>, <span class="hljs-subst">{Y}</span>"</span>);
}
</code></pre>
<h3 data-id="heading-3">与普通 struct 的区别</h3>













































<table><thead><tr><th>特性</th><th><code>struct</code></th><th><code>ref struct</code></th></tr></thead><tbody><tr><td>分配位置</td><td>栈或堆（例如在类中或装箱时）</td><td><strong>只能栈分配</strong></td></tr><tr><td>装箱（boxing）</td><td>支持（可转为 <code>object</code>）</td><td>❌ 禁止</td></tr><tr><td>接口实现</td><td>支持</td><td>❌ 禁止（不能实现接口）</td></tr><tr><td>异步方法/迭代器</td><td>支持</td><td>❌ 不能被 <code>async</code>/<code>yield</code> 捕获</td></tr><tr><td>闭包捕获</td><td>支持</td><td>❌ 禁止</td></tr><tr><td>泛型约束</td><td>可作为泛型参数</td><td>❌ 禁止用作类泛型参数</td></tr><tr><td>生命周期</td><td>受 GC 管理</td><td><strong>完全受栈作用域约束</strong></td></tr></tbody></table>
<p><code>ref struct</code> 的限制确保它 不会被错误地提升到堆中，保证其生命周期安全。</p>
<h3 data-id="heading-4">使用场景</h3>
<p><code>ref struct</code> 非常适合以下 高性能、低开销 的场景：</p>

























<table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td><strong>内存切片</strong></td><td><code>Span&lt;T&gt;</code>、<code>ReadOnlySpan&lt;T&gt;</code></td></tr><tr><td><strong>避免 GC</strong></td><td>高频分配和释放的临时数据结构</td></tr><tr><td><strong>非托管资源访问</strong></td><td>指针操作、<code>stackalloc</code> 分配的缓冲区</td></tr><tr><td><strong>网络与数据解析</strong></td><td>高性能序列化/反序列化（如 JSON、Protocol Buffers）</td></tr></tbody></table>
<h3 data-id="heading-5">典型示例</h3>
<h4 data-id="heading-6"><code>Span&lt;T&gt;</code>：最常见的 ref struct</h4>
<p><code>Span&lt;T&gt;</code> 是一个表示连续内存区域的类型：</p>
<pre><code class="hljs language-csharp" lang="csharp">Span&lt;<span class="hljs-built_in">int</span>&gt; numbers = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">int</span>[<span class="hljs-number">5</span>] { <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span> };
numbers[<span class="hljs-number">2</span>] = <span class="hljs-number">99</span>;

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> numbers)
    Console.Write(<span class="hljs-string">$"<span class="hljs-subst">{n}</span> "</span>); <span class="hljs-comment">// 输出: 1 2 99 4 5</span>
</code></pre>
<ul>
<li>
<p><code>stackalloc</code> 在栈上分配内存。</p>
</li>
<li>
<p><code>Span&lt;T&gt;</code> 只能存在于当前方法栈中，离开作用域自动回收。</p>
</li>
</ul>
<h4 data-id="heading-7">自定义 ref struct</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> Point
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> X;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> Y;

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">double</span> Length =&gt; Math.Sqrt(X * X + Y * Y);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Demo</span>()</span>
{
    <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> Point { X = <span class="hljs-number">3</span>, Y = <span class="hljs-number">4</span> };
    Console.WriteLine(p.Length); <span class="hljs-comment">// 5</span>
}
</code></pre>
<h4 data-id="heading-8">与 stackalloc 配合</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Span&lt;<span class="hljs-built_in">byte</span>&gt; <span class="hljs-title">CreateBuffer</span>()</span>
{
    Span&lt;<span class="hljs-built_in">byte</span>&gt; buffer = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 栈上分配 1KB</span>
    buffer[<span class="hljs-number">0</span>] = <span class="hljs-number">42</span>;
    <span class="hljs-keyword">return</span> buffer; <span class="hljs-comment">// ❌ 错误：不能返回 ref struct</span>
}
</code></pre>
<p>返回 <code>Span&lt;T&gt;</code> 会导致栈内存逃逸，因此编译器会报错。</p>
<h3 data-id="heading-9">编译器施加的约束</h3>
<p><code>ref struct</code> 的安全限制主要有以下几点：</p>
<h4 data-id="heading-10">不能装箱</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> MyStruct { }
<span class="hljs-built_in">object</span> o = <span class="hljs-keyword">new</span> MyStruct(); <span class="hljs-comment">// ❌ 编译错误</span>
</code></pre>
<p>因为装箱会将值类型复制到堆上。</p>
<h4 data-id="heading-11">不能实现接口</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">ref</span> <span class="hljs-keyword">struct</span> MyStruct : IDisposable { } <span class="hljs-comment">// ❌ 编译错误</span>
</code></pre>
<p>接口调用可能导致提升到堆，破坏生命周期安全。</p>
<h4 data-id="heading-12">不能作为类字段</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClass</span>
{
    <span class="hljs-keyword">public</span> Span&lt;<span class="hljs-built_in">int</span>&gt; SpanField; <span class="hljs-comment">// ❌ 编译错误</span>
}
</code></pre>
<p>因为类实例在堆上，而 <code>ref struct</code> 只能存在栈上。</p>
<h4 data-id="heading-13">不能用作泛型参数</h4>
<pre><code class="hljs language-csharp" lang="csharp">List&lt;Span&lt;<span class="hljs-built_in">int</span>&gt;&gt; list = <span class="hljs-keyword">new</span>(); <span class="hljs-comment">// ❌ 编译错误</span>
</code></pre>
<h4 data-id="heading-14">不能捕获到闭包</h4>
<pre><code class="hljs language-csharp" lang="csharp">Span&lt;<span class="hljs-built_in">int</span>&gt; span = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">int</span>[<span class="hljs-number">10</span>];
Action action = () =&gt; Console.WriteLine(span[<span class="hljs-number">0</span>]); <span class="hljs-comment">// ❌ 编译错误</span>
</code></pre>
<p>闭包会将变量提升到堆中，破坏生命周期。</p>
<h4 data-id="heading-15">不能用于异步方法/迭代器</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> Task <span class="hljs-title">Demo</span>()</span>
{
    Span&lt;<span class="hljs-built_in">int</span>&gt; span = <span class="hljs-keyword">stackalloc</span> <span class="hljs-built_in">int</span>[<span class="hljs-number">10</span>]; <span class="hljs-comment">// ❌ 编译错误</span>
    <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>);
}
</code></pre>
<p>异步状态机会导致变量在堆上存储。</p>
<h3 data-id="heading-16">与其他类型对比</h3>















































<table><thead><tr><th>特性</th><th><code>class</code></th><th><code>struct</code></th><th><code>ref struct</code></th></tr></thead><tbody><tr><td>分配位置</td><td>堆</td><td>栈/堆</td><td><strong>仅栈</strong></td></tr><tr><td>内存回收</td><td>GC</td><td>自动回收/GC</td><td>自动回收（方法退出时）</td></tr><tr><td>接口实现</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td>装箱/拆箱</td><td>❌（本身是引用）</td><td>✅</td><td>❌</td></tr><tr><td>异步/闭包</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td>典型代表</td><td><code>String</code></td><td><code>DateTime</code></td><td><code>Span&lt;T&gt;</code>, <code>ReadOnlySpan&lt;T&gt;</code></td></tr></tbody></table>
<h3 data-id="heading-17">性能优势</h3>






























<table><thead><tr><th>场景</th><th>普通 <code>struct</code></th><th><code>ref struct</code></th></tr></thead><tbody><tr><td>分配/释放速度</td><td>快</td><td><strong>最快（仅栈操作）</strong></td></tr><tr><td>GC 压力</td><td>可能有（装箱）</td><td><strong>无 GC</strong></td></tr><tr><td>内存局部性</td><td>较好</td><td><strong>最佳</strong></td></tr><tr><td>生命周期可控性</td><td>GC 管理</td><td><strong>作用域结束即释放</strong></td></tr></tbody></table>
<h3 data-id="heading-18">实战示例：高性能字符串切片</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">ParseDigits</span>(<span class="hljs-params">ReadOnlySpan&lt;<span class="hljs-built_in">char</span>&gt; span</span>)</span>
{
    <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> c <span class="hljs-keyword">in</span> span)
    {
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">char</span>.IsDigit(c)) <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">value</span> = <span class="hljs-keyword">value</span> * <span class="hljs-number">10</span> + (c - <span class="hljs-string">'0'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;
}

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Demo</span>()</span>
{
    <span class="hljs-built_in">string</span> input = <span class="hljs-string">"12345abc"</span>;
    <span class="hljs-keyword">var</span> slice = input.AsSpan(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 直接操作原字符串内存</span>
    Console.WriteLine(ParseDigits(slice)); <span class="hljs-comment">// 输出 12345</span>
}
</code></pre>
<p>优势：</p>
<ul>
<li>
<p>不会产生 <code>Substring</code> 带来的额外堆分配。</p>
</li>
<li>
<p>内存安全且性能接近指针操作。</p>
</li>
</ul>
<h3 data-id="heading-19">总结</h3>

























<table><thead><tr><th>方面</th><th>说明</th></tr></thead><tbody><tr><td>核心特性</td><td>只能分配在栈上，生命周期由作用域严格控制，无 GC 压力</td></tr><tr><td>主要限制</td><td>不能装箱、不能作为类字段、不能捕获闭包、不能异步/迭代、不能实现接口</td></tr><tr><td>典型应用</td><td><code>Span&lt;T&gt;</code>、<code>ReadOnlySpan&lt;T&gt;</code>、高性能内存处理、网络数据解析</td></tr><tr><td>最佳实践</td><td>使用 <code>using</code> 范围、<code>readonly</code> 修饰、避免逃逸、短生命周期</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里Wan 2.6实测：这回不仅仅是Sora平替，而是AI导演的完全进化]]></title>    <link>https://juejin.cn/post/7584298069610233856</link>    <guid>https://juejin.cn/post/7584298069610233856</guid>    <pubDate>2025-12-16T15:51:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584298069610233856" data-draft-id="7584243498528636928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里Wan 2.6实测：这回不仅仅是Sora平替，而是AI导演的完全进化"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-16T15:51:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里Wan 2.6实测：这回不仅仅是Sora平替，而是AI导演的完全进化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T15:51:23.000Z" title="Tue Dec 16 2025 15:51:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，在OpenAI的Sora迟迟不肯公测的这段日子里，国内的AI视频圈子其实反而更卷了。但我没想到的是，在这个年底，阿里会突然扔出一张王炸——通义万相（Wan）2.6。</p>
<p>大家都在传这是“中国版Sora 2”，甚至LiblibAI等平台刚一首发上线就被挤爆了。我花了一下午时间把玩了这个模型，想撇开那些花哨的营销词，单纯从一个创作者的角度，跟你们聊聊它到底强在哪，以及为什么我觉得它可能真的改变了玩儿法。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fdasdasf.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/dasdasf.webp" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c5191afa0ca437099a051fa42ae0be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766505083&amp;x-signature=A5KxjRgXlMzxm3osgM3QMH6ImAw%3D" alt="dasdasf" loading="lazy"/></a></p>
<p><strong>不仅是“生成”，而是“主演”</strong></p>
<p>玩过AI视频的朋友都知道一个痛点：抽卡容易，控卡难。以前我们生成的视频，人物长相随机变，这一秒是吴彦祖，下一秒可能就变成了苏大强。</p>
<p>Wan 2.6最让我惊喜的，是它的**角色扮演（Roleplay）**功能。这不仅仅是简单的换脸。</p>
<p>你可以直接丢给它一段你自己或者宠物的视频（5秒以内），它就能把这个形象“抠”下来，记住了长相、神态甚至是声音。然后，你通过文字描述，就能让这个角色去演科幻片、古装剧，或者在赛博朋克的街道上吃面。最关键的是，它能保持人物的高度一致性。这对于想做连续剧情短片的创作者来说，简直是救命稻草。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-16_23.26.51-1024x580.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-16_23.26.51-1024x580.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eff1bea373d24190ac010df7ebb1ccfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766505083&amp;x-signature=y38poSP2Wj%2Blu9fINiI%2BX1vMRRo%3D" alt="iShot_2025-12-16_23.26.51" loading="lazy"/></a></p>
<p><strong>AI终于懂什么是“剪辑”了</strong></p>
<p>以前的AI视频模型，大多只能生成那种“一镜到底”的画面，看多了容易腻。</p>
<p>Wan 2.6这次搞了一个<strong>智能分镜</strong>的能力。简单说，它现在的脑子更像一个导演，而不是一个画师。你输入一段复杂的剧情描述，它不会傻傻地挤在一个画面里表现，而是自动给你切分镜头——先来个大远景交代环境，紧接着切特写展示表情，最后拉中景展示动作。</p>
<p>它生成的15秒视频里，可能包含着推拉摇移和景别切换，而且这些镜头之间的逻辑是连贯的。这意味着什么？意味着你不需要再去PR里苦哈哈地把一堆废片拼凑起来，它一次生成就是一个有叙事感的小短片。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-16_23.26.46-1024x476.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-16_23.26.46-1024x476.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/341ce42f9f424ad48eeb83ad208a1588~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766505083&amp;x-signature=GAWzLF9P%2BhcbLr1dnWXjjJYEQro%3D" alt="iShot_2025-12-16_23.26.46" loading="lazy"/></a></p>
<p><strong>关于那个“Sora 2”的标签</strong></p>
<p>媒体很喜欢用“中国版Sora 2”这个词，虽然官方没这么叫，但从技术路线上看，这个比喻有一定道理。</p>
<p>特别是<strong>声画同步</strong>这一点。Wan 2.6不是光生成哑剧，它在生成画面的同时，能顺便把配音、音效、背景音乐全搞定。尤其是人物说话的口型对齐，虽然还不能说完美无缺，但在短视频的信息流里，已经足够以假乱真。</p>
<p>它能做到单次直出15秒的1080P高清画质，这个参数卡得很精准——正好覆盖了目前主流短视频平台完播率最高的时长区间。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-16_23.26.40-1024x374.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-16_23.26.40-1024x374.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b037a11c3b941e2a9af7aacd397d0e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766505083&amp;x-signature=JIoobRQVpRDd90j5kYhQ5SwfavA%3D" alt="iShot_2025-12-16_23.26.40" loading="lazy"/></a></p>
<p><strong>现在就能玩，不用排队</strong></p>
<p>这点必须好评。相比于在大洋彼岸画大饼，Wan 2.6是实打实上线了。</p>
<p>如果你是个人玩家，想尝鲜，直接去<strong>LiblibAI</strong>或者通义万相的官网就能试。对于咱们做内容的，LiblibAI上那种工作流的体验可能更顺手一些。如果你是搞开发的，阿里云百炼的API也开了。</p>
<p><strong>写在最后</strong></p>
<p>Wan 2.6给我的感觉，不是单纯的画质提升，而是它开始试图理解“影视语言”了。</p>
<p>从单一的画面生成，到多镜头的叙事调度，再到角色的一致性控制，这标志着AI视频工具正在从“玩具”向“生产力工具”迈进。虽然它肯定还有穿模、逻辑跳跃这些AI通病，但至少现在，我们离“一个人就是一支队伍”的梦想，又近了结结实实的一大步。</p>
<p>如果你手头有好的创意，别等了，去试试吧。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android15适配之世上本无坑，targetSdkVersion升到35后全是坑]]></title>    <link>https://juejin.cn/post/7584295332340858943</link>    <guid>https://juejin.cn/post/7584295332340858943</guid>    <pubDate>2025-12-16T23:59:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584295332340858943" data-draft-id="7580389111920508991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android15适配之世上本无坑，targetSdkVersion升到35后全是坑"/> <meta itemprop="keywords" content="Android,gradle,前端"/> <meta itemprop="datePublished" content="2025-12-16T23:59:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Coffeeee"/> <meta itemprop="url" content="https://juejin.cn/user/2089524588718126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android15适配之世上本无坑，targetSdkVersion升到35后全是坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2089524588718126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Coffeeee
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T23:59:27.000Z" title="Tue Dec 16 2025 23:59:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>自从2024年初时候，谷歌发布了第一个Android15的预览版，我就一直在关注着这个版本的走向，为什么呢？因为据说Android15里面的变化非常大，后来事实证明果真如此，无论是特性上的改动如预测性返回，edge to edge还是16kb内存页面，或者是编译环境上的改动如targetSdkVersion，Agp，gradle以及jdk的一些升级，都让我觉得这次升级非同一般，来势凶猛，不是那么的好对付，不过好在之前工作上都没有海外上的业务，国内的应用商店对应用的targetSdk也没有太强制的要求，所以Android15跟我都一直保持着一种敌不动我不动的和平局势，但是局势终将是被打破了...</p>
<h2 data-id="heading-1">乱世中的相逢</h2>
<p>前段时间经历了裁员以及三个月的找工作，让我深刻体会到了严峻的行情局势以及可怕的就业压力，促使我不得不降低自己的底线，面了各种未曾尝试过的岗位面试，如车载，FW或者面向谷歌市场开发，有一次面试中：</p>
<ul>
<li>面试官：有开发过谷歌市场的应用吗？</li>
<li>我：好几年前做过，知道现在发布的是aab格式的包</li>
<li>面试官：适配过Android15吗？</li>
<li>我：没有，就只适配过Android12</li>
<li>面试官：哦～～</li>
</ul>
<p>然后offer就来了...虽然明白这个offer不是那么的好接，入职后主要任务就是跟谷歌的一系列政策斗法，但由于行情实在是不容乐观，招聘市场上已经被一堆外包跟短期项目搞得乌烟瘴气了，考虑再三还是接下了这个offer，于是乎我跟Android15之间斗争也拉开了序幕</p>
<h3 data-id="heading-2">升级targetSdkVersion与compileSdkVersion</h3>
<p>接手到项目之后，无意外的被分配到的第一个任务就是谷歌市场合规要求，适配Android15,不得不感慨不到两年前还在庆幸自己与Android15无缘，谁知道这么快就要跟这个“大魔王”面对面接触，实在是世事难料，应了那句话，出来混的，终究要还的，吃Android这碗饭，就要做好适配各种Android新版本的准备，不过另我感到欣慰的是项目并不是特别的老，让我产生一种错觉，应该没有想象中的那么费劲，项目基本配置如下</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/f94af4c7f76046288444fecd98e27ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="70%" loading="lazy"/>
<p>既然如此，废话不多说了，咱先把<code>targetSdk</code>跟<code>compileSdk</code>都升级到35再说，万一跑下来没啥问题呢，我就嘻嘻了，修改了一下<code>gradle.properties</code>中的几个变量</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/0ad1c0bb958f4c29ae727b30e2e6a0f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="70%" loading="lazy"/>
<p>sync一下后发现没啥问题，嗯？就这？run一下试试，发现果然报错了,瞬间不嘻嘻</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/4f96b764f18e49fdb5d2be8c04df107e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="002.png" width="90%" loading="lazy"/>
<p>报了个无法加载sdk路径下/platforms/android-35/android.jar的这个文件，有点摸不着头脑，查了一下马上就知道了，原因很简单，项目中使用的gradle插件以及AGP插件已经不支持targetSdk35了，必须要升级了，升到多少呢，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fbuild%2Freleases%2Fgradle-plugin%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/build/releases/gradle-plugin?hl=zh-cn" ref="nofollow noopener noreferrer">官方文档</a>上看看去</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/3182f631c7974443a65070de4afdbfdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/067bee2a61bb4edeb861104be5616621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>写的很清楚了，当升级到target35后，AGP版本最低需要8.6,此版本对应的gradle最低版本是8.7，那么开始升级这俩插件</p>
<h3 data-id="heading-3">升级gradle和AGP</h3>
<p>首先将项目中gradle/wrapper/gradle-wrapper.properties中的以下代码</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/f7254e7b93de482789b7cf36a6fee586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>替换成</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/758d2a74b88947c1886ffbc35042b04f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>然后再把根目录build.gradle文件里面的AGP插件从</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/b878ff10c1e941969088daf16a6c8775~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>替换成</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/b11a66ae625946ea88326ed5f8bf1171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>一顿操作之后心里就犯怵，这俩插件一下子都抬高了一个大版本，真的没问题吗？编译下看看吧，果然怕啥来啥，出现以下报红</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/85ea4c0bc17f48cb8984228c59f54c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>不过还好还算容易懂，现在用的jdk版本11过低了，需要用更高的jdk版本17才可以。</p>
<h3 data-id="heading-4">升级JDK</h3>
<p>没想到刚开始还没干啥呢，随着升完gradle与AGP之后，jdk版本也要升级了，一下子就感到疑惑了起来，要知道jdk11这个版本大多数项目还是在用的，不过人家<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fbuild%2Freleases%2Fpast-releases%2Fagp-8-0-0-release-notes%3Fhl%3Dzh-cn" target="_blank" title="https://developer.android.google.cn/build/releases/past-releases/agp-8-0-0-release-notes?hl=zh-cn" ref="nofollow noopener noreferrer">gradle插件的changelog</a>里面可是写的清清楚楚，升级到8.0后，jdk的最小版本就要求必须是17了</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/576e8a9b9647440dba11a43a5841ede7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="70%" loading="lazy"/>
<p>那就升吧，升这个东西没啥难的，左上角Android Studio-&gt;Settings-&gt;Build Tools-&gt;Gradle里面选择JDK17,没有的话就去下一个</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/693a06a1820e476a87114cc04d47ee6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>Apply并且ok后我们再编译看看</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/41b1449f19df4cf2b3dc79f0b7d0241c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<h3 data-id="heading-5">添加buildConfig=true配置</h3>
<p>这真是头一次见啊，说的啥debug的build type有一些自定义的BuildConfig的变量，但是被禁用了，说的应该是下面这段代码</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/1807fb2085b844e3901358f83c440e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>这段代码很常见，大多数项目中都会在<code>buildTypes</code>里面定义一些<code>buildConfigField</code>变量，用来区分生产环境跟debug环境，我这里定义了一个布尔类型的<code>Coffee_Test</code>值为<code>true</code>的变量，现在说的是这个已经被禁用了，肯定又是升级gradle带来的副作用，果然在AGP8.0的更新中就有看到</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/b5652e16d01e41159c768c3749f5eff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>同时解决方法也很简单，就是在每个定义过自定义变量的模块的build.gradle文件下添加一句代码<code>android.buildFeatures.buildConfig true</code>就可以了,像这样</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/e8828db1c857421e81290b4a937cb626~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>这个问题也就解决了</p>
<h3 data-id="heading-6">添加namespace</h3>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/df43fb03c36745b0927e358dd512573f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>随着再次编译，又出现上述报错，跟之前的BuildConfig类似，这次是要求在每个模块的build文件中需要添加个<code>namespace</code>的命名空间，这个变更是在AGP7.3中出现，但是AGP8.0就要被强制执行</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/5dd12084bc0849f48c0a7491b256435e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>通常这个命名空间就是指的是当前模块的包名，所以可以看到报错红字下方也提示了，可以借助AGP的升级助手来完成这一步，完成后在你的build.gradle文件中就会多出一行配置</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/18e38faa91a74b3489f16df18b50a526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<h3 data-id="heading-7">使用subprojects统一添加配置</h3>
<p>上面说的添加<code>android.buildFeatures.buildConfig true</code>以及命名空间的做法，在一些小型，模块没几个的项目中，配置起来不是特别难受，但是若是项目规模大一些，动辄十几个几十个模块的话，逐个加那就真的是件很痛苦的事情，那么有没有轻松一点的办法呢？第一个想到的就是新增一个common.gradle的文件，在里面添加一些诸如<code>android.buildFeatures.buildConfig true</code>这样的配置，然后其他模块引入这个common.gradle文件，倒是可以达到效果，但是存在着一些缺点</p>
<ol>
<li>逐个gradle文件添加common.gradle的依赖也需要耗费一些时间精力</li>
<li>如果项目还需要源码依赖一些其他项目的模块，那么其他项目的模块由于没有添加类似配置，也是会报错</li>
</ol>
<p>所以我这里选择的是在项目的根目录的gradle文件中使用<code>subprojects</code>，动态给每个参与到编译的模块添加<code>android.buildFeatures.buildConfig true</code>以及命名空间，代码如下</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/64d1fb58299540a68b71694c4678ae8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>如果这个模块没有定义过命名空间，比如依赖的一些源码库，那么才会给这个模块添加命名空间，至于<code>buildConfig</code>，由于我不知道如何判断gradle文件中已经声明过自定义变量了，所以只能全量添加，这样就能避免某些模块因漏加这两个配置而产生编译报错</p>
<h3 data-id="heading-8">R文件丢失</h3>
<p>言归正传，刚才已经添加完<code>namespace</code>了，我心里琢磨着这下应该差不多了吧，可以正常跑了吧，谁知道Android15给我憋了坨大的，报出以下红字</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/6292fc0c3a0d47bbb8e5442edde62f68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>莫名其妙啊，怎么有些string资源说找不到就找不到了呢？开始没太在意，琢磨着补全R路径就好了,类似于这样</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/9659bc462e3344c78822942dbc35121c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="80%" loading="lazy"/>
<p>这种又奇葩又丑的方式不用想肯定也知道没法解决本质问题，果然再次编译后又报出来一堆找不到资源的R文件，其中包括layout,color,drawable等，这下彻底凌乱了，肯定不能一个个路径去补全，心想这么大的事官网上肯定会有说明吧，找找看果然在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fbuild%2Freleases%2Fpast-releases%2Fagp-8-0-0-release-notes%3Fhl%3Dzh-CN%23kotlin-assignment" target="_blank" title="https://developer.android.google.cn/build/releases/past-releases/agp-8-0-0-release-notes?hl=zh-CN#kotlin-assignment" ref="nofollow noopener noreferrer">gradle8.0的更新日志里</a>以及<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Fbuild%2Fconfigure-app-module%3Fhl%3Dzh-cn%23set-namespace" target="_blank" title="https://developer.android.google.cn/build/configure-app-module?hl=zh-cn#set-namespace" ref="nofollow noopener noreferrer">设置命名空间的介绍里</a>找到了具体更新信息，谷歌引入<code>namespace</code>的主要原因是为了以后在每个模块里面，只会生成当前模块下的资源文件，其他子模块的资源文件就不会生成了，若要访问的话必须使用对应命名空间导入R类，我认为谷歌这一改动就是为了加速构建速度吧，但是真的要我们开发者一个个资源前面补全路径吗，当然不会，谷歌还是给出了对策的</p>
<img src="https://p-xtjj.byted.org/tos-cn-i-73owjymdk6/393d8fee14224f169750752a70f78cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6:q75.image" alt="image.png" width="90%" loading="lazy"/>
<p>在标志项的表格中就看到了两个跟R文件相关的设置</p>
<ul>
<li>android.nonFinalResIds：关闭这个开关AGP 8.0 默认情况下就不会生成包含非最终字段的 <code>R</code> 类</li>
<li>android.nonTransitiveRClass：关闭这个开关AGP 8.0 就不会仅为当前模块中定义的资源生成 <code>R</code> 类</li>
</ul>
<p>将这俩设置加在<code>gradle.properties</code>中后，项目果然可以正常运行了，不容易！终于可以提测了！</p>
<h2 data-id="heading-9">最后</h2>
<p>还是以前搞适配没啥压力啊，每个版本出来就一点变动，现在这个Android15着实有点费体力，光一个编译环境都折腾了那么久，瞅瞅这些坑，我写都写半天，更别说一个个踩了，那些新出来的特性都还没开始正经适配，休息一下，下一篇文章正式领教下edge-to-edge以及16kb内存页面</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型的奥秘：Token与Transformer简单理解]]></title>    <link>https://juejin.cn/post/7584298069610315776</link>    <guid>https://juejin.cn/post/7584298069610315776</guid>    <pubDate>2025-12-16T17:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584298069610315776" data-draft-id="7584319403858673699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型的奥秘：Token与Transformer简单理解"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-12-16T17:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_Shawn"/> <meta itemprop="url" content="https://juejin.cn/user/1855631358965384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型的奥秘：Token与Transformer简单理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631358965384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_Shawn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T17:09:52.000Z" title="Tue Dec 16 2025 17:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大模型是什么</h2>
<p>大模型（Large Model）是指具有大规模参数和复杂计算结构的机器学习模型。这些模型通常由<strong>深度神经网络</strong>构建而成，拥有数十亿甚至数千亿个参数。大模型的设计目的是为了提高模型的表达能力和预测性能，能够处理更加复杂的任务和数据。大模型在各种领域都有广泛的应用，包括<strong>自然语言处理、计算机视觉、语音识别和推荐系统</strong>等。大模型通过训练海量数据来学习复杂的模式和特征，具有更强大的泛化能力，可以对未见过的数据做出准确的预测。</p>
<p>大语言模型（large language model，LLM），也称大语言模型，是由具有大量参数（通常数十亿个权重或更多）的人工神经网络组成的一类语言模型，使用自监督学习或半监督学习对大量未标记文本进行训练。大型语言模型在自然语言处理、文本生成和智能对话等领域有广泛应用。</p>
<p>GPT（Generative Pre-trained Transformer）：GPT 和 ChatGPT 都是基于 Transformer 架构的语言模型，但它们在设计和应用上存在区别：GPT 模型旨在生成自然语言文本并处理各种自然语言处理任务，如文本生成、翻译、摘要等。它通常在单向生成的情况下使用，即根据给定的文本生成连贯的输出。</p>
<p>ChatGPT：ChatGPT 则专注于对话和交互式对话。它经过特定的训练，以更好地处理多轮对话和上下文理解。ChatGPT 设计用于提供流畅、连贯和有趣的对话体验，以响应用户的输入并生成合适的回复。</p>
<p>当然，我们日常说的大模型，更多还是值得是大语言模型，Chatgpt, DeepSeek，Qwen等一开始也都是大语言模型，随着大模型技术不断的更新，成熟，越来越多的模型供应商，开始支持CV，OCR，ASR，SER等模型，形成多模态大模型。</p>
<p>本文还是主要讲述的是大语言模型相关概念和基本原理。</p>
<h2 data-id="heading-1">大模型原理</h2>
<h3 data-id="heading-2">什么是token</h3>
<p>我们在使用chatgpt，deepseek的时候，经常看到计费规则，基本是按照token来计费的，那什么是token？就是一个字符吗？</p>
<p>Token就是大模型处理文本的最小单位。token可以表示单词、单词的一部分，甚至只表示字符。</p>
<p>“今天天气很好，我打算出去打羽毛球”，拿这段话来说，大模型会通过分词器(Tokenizer)，可能会分成如下的token: "今天"，“天气”，“很”，“好”，“我”，“打算”，“出去”，“打”，“羽毛球”。这些token最后都转化为向量，映射到唯一的数值表示，LLM 使用向量数值输入，这种映射允许 LLM 将文本数据作为数字序列进行处理和操作，从而实现高效的计算和建模。</p>
<p>假设上面的文本是输入，大语言模型的输出token又是怎么实现的呢？假设大模型的输出是“是的，今天天气很好，你可以带上你的羽毛球去室外玩”。实际上，大模型的输出也是一个token，一个token的输出，最后组装起来，后一个token是上一个token的概率输出。例如先输出“是的”，后面紧跟着的预测token是“，”，且概率最大，或者高于阈值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62996af715bd46479a238b66f2ad2003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hhd25fU2hhd24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766509791&amp;x-signature=RuEO34VG9p6L%2FIqtWTrEyXBEo5s%3D" alt="" loading="lazy"/></p>
<p>可以看deepseek的流式输出，实际上就是输出一个个token。</p>
<h3 data-id="heading-3">什么是transform</h3>
<p>上面介绍了一下什么是token，那么大模型如何理解token呢？我们很容易想到的第一个方案就是让AI一个个token，顺序读，读了第一个token，记住它，传给大脑；再读第二个token，结合第一个字理解，再传下去。。。</p>
<p>但是这样有两个十分明显的缺点：</p>
<ol>
<li>慢，需要一个接着一个读，同时结合上文，理解。</li>
<li>健忘，如果句子很长，读到最后几个字时，可能已经忘了开头讲什么了（比如“因为……所以……”的逻辑容易断）。</li>
</ol>
<p>这是传统AI的方式，通过<strong>RNN</strong>，循环神经网络来进行处理。但显然，我们日常用的大模型，基本处理速度都比较快，所以大模型显然并没有采用RNN的方式实现，而是通过另外一种方式，Transform架构来实现。</p>
<p>Transform最大的优点就是快，它不是一个个读的，还是整体读，通过<strong>并行计算</strong>，瞬间把整段话的所有token同时记录到脑海里。当然，写还是串行的。</p>
<p>并行的读去token，势必会造成有的token读得快，有的token读得慢，出现乱序行为，但我们再使用过程中发现大模型并没有出现这样的问题，那transform如何解决的？</p>
<p>Transformer 的架构主要分为两部分：</p>
<ul>
<li>编码器 (<strong>Encoder</strong>) —— 负责“读”和“理解”：它把人类的语言（文字）转化成计算机能懂的数字向量（特征）。同时也会记录每个token或者每个特征的<strong>位置编码</strong>，这样就能保证token的顺序性。</li>
<li>解码器 (<strong>Decoder</strong>) —— 负责“写”和“生成”：它拿到编码器给的理解结果，开始生成目标语言（比如把中文翻译成英文，或者回答你的问题）。虽说是生成，但也会计算出每次输出token的<strong>位置编码。</strong></li>
</ul>
<p>Transform还有个非常重要的机制，自注意力机制<strong>self-Attention</strong>。我们以“苹果掉在地上，它摔坏了。”这段话为例。当我们读到“它”的时候，我们人类知道“它”指的是“苹果”。但电脑怎么知道“它”是指“苹果”还是“地”？简单一点理解，Transformer 会让每一个token，都去和其余token进行相关性的算分，取权重最高的那一个token。当模型处理“它”这个字时，会发现“苹果”跟它的关联度（权重）很高，可能有 90 分。而“地”跟它的关联度只有 10 分。于是，模型在理解“它”的时候，会把注意力更多地放在“苹果”身上。</p>
<p>另外，需要说明的是，目前Chatgpt等主流大语言模型，主要采用的是纯<strong>Decoder模式</strong>。</p>
<h2 data-id="heading-4">参考文献</h2>
<p>想要更加深入的理解transformer的同学，可以参考：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftransformers.run%2Fc1%2Ftransformer%2F" target="_blank" title="https://transformers.run/c1/transformer/" ref="nofollow noopener noreferrer">transformers.run/c1/transfor…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F338817680" target="_blank" title="https://zhuanlan.zhihu.com/p/338817680" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/338817680</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么说 AI 赋能前端开发，已经不是选择题，而是必然趋势？]]></title>    <link>https://juejin.cn/post/7584292514959654921</link>    <guid>https://juejin.cn/post/7584292514959654921</guid>    <pubDate>2025-12-16T15:04:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584292514959654921" data-draft-id="7584262116389290010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么说 AI 赋能前端开发，已经不是选择题，而是必然趋势？"/> <meta itemprop="keywords" content="前端,架构,AI编程"/> <meta itemprop="datePublished" content="2025-12-16T15:04:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西陵"/> <meta itemprop="url" content="https://juejin.cn/user/4353721774379054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么说 AI 赋能前端开发，已经不是选择题，而是必然趋势？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721774379054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西陵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T15:04:37.000Z" title="Tue Dec 16 2025 15:04:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>首发于公众号 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcqfeTj6GhIIv7Ief5554Ow" target="_blank" title="https://mp.weixin.qq.com/s/cqfeTj6GhIIv7Ief5554Ow" ref="nofollow noopener noreferrer">code进化论</a>，欢迎关注。</p>
<h2 data-id="heading-0">前言</h2>
<p>这几年 AI 在前端开发里的能力几乎是肉眼可见地进化”。从最早只能帮我们做做代码补全、提示几个参数，例如早期的 comate。到后来能够独立生成一个完整的 React/Vue 组件，连逻辑、样式和交互都能自动写好，例如 cursor 和 claude。再到现在，AI 已经能根据一句自然语言去搭建整个前端项目，自动创建页面、路由、接口层，甚至跑通基础业务流程，例如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv0.dev%2F" target="_blank" title="https://v0.dev/" ref="nofollow noopener noreferrer">v0</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbolt.new%2F" target="_blank" title="https://bolt.new/" ref="nofollow noopener noreferrer">bolt.new</a>。AI 的角色正在从“聪明的编辑器”变成“能独立干活的虚拟工程师”，让前端开发的门槛降低、效率提升，也让更多的精力能够投入到真正有价值的产品设计和体验创新上。</p>
<h2 data-id="heading-1">AI赋能下的范式迁移</h2>
<p>在当前 AI 的发展之下，AI 赋能开发当前还处于最初级的阶段，这里引用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.iamkasong.com%2Fdocs%2F%25E7%25AC%25AC%25E4%25B8%2580%25E8%25AF%25BE%2520%25E9%259D%25A2%25E5%2590%2591%25E6%259C%25AA%25E6%259D%25A5%25E7%259A%2584%25E5%2589%258D%25E7%25AB%25AF%25E5%258F%2591%25E5%25B1%2595%25E8%25B7%25AF%25E5%25BE%2584.html" target="_blank" title="https://doc.iamkasong.com/docs/%E7%AC%AC%E4%B8%80%E8%AF%BE%20%E9%9D%A2%E5%90%91%E6%9C%AA%E6%9D%A5%E7%9A%84%E5%89%8D%E7%AB%AF%E5%8F%91%E5%B1%95%E8%B7%AF%E5%BE%84.html" ref="nofollow noopener noreferrer">卡颂老师画的一张图</a>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59fb4816eebc45779e287a5a3dfa4791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zm1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766502536&amp;x-signature=F3Vs7o4Jd92RiXUFF%2FWmbPzSawA%3D" alt="image.png" loading="lazy"/></p>
<p>当前阶段正处于开发范式的迁移阶段，这里可以回想一下前端开发发展的历程：</p>
<ul>
<li>手写 JS、HTML 代码，手动处理浏览器之间的差异点。</li>
<li>引入 jQuery 统一 DOM 操作，抹平浏览器的差异性。</li>
<li>引入 React、Vue 等前端框架，以数据驱动为核心，将开发者从命令式的开发转为声明式开发。</li>
<li>….</li>
</ul>
<p>现阶段的 AI 也是如此，开发范式的发展到了一定阶段后就会涌现出新的开发技术来降低门槛。</p>
<h2 data-id="heading-2">前端开发角色的转变</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9b9f49e3c894191a4f2d7d973a88429~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zm1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766502536&amp;x-signature=A2WOMH4ev4BPzJ%2FeRvYVB72upks%3D" alt="image.png" loading="lazy"/></p>
<p>在 AI 时代下，前端开发的角色会逐步进行转变，如图所示：</p>
<ul>
<li>
<p><strong>前端工程师</strong></p>
<p>传统意义上的前端工程师掌握 HTML/CSS/JavaScript，能够把设计稿还原成交互界面，熟悉常见框架（如 React/Vue/Angular）和工程化工具（打包、CI、测试）。他们的价值体现在把产品需求转化为稳定、可维护的用户界面，同时需要关注浏览器兼容、性能优化等。</p>
</li>
<li>
<p><strong>使用AI工具的前端</strong></p>
<p>进入 AI 赋能阶段，前端工程师会把 AI 当成放大效率的助手，利用 AI 的代码补全、组件开发、自动化测试生成等能力提高开发效率。结果是同样的工作可以更快交付，工程师把节省下来的时间投入到更高价值的工作上——比如深挖业务逻辑、做复杂的交互设计、或者搭建更稳健的架构。重要变化不是工具本身，而是将工作重心从写代码转向写提示词、review AI 代码、架构决策与业务理解。</p>
</li>
<li>
<p><strong>会开发AI工具的前端</strong></p>
<p>前端工程师开始参与或主导 AI 工具的开发，能把前端场景抽象成可复用的 AI 提效工具。</p>
</li>
<li>
<p><strong>技术全面的专业前端人才</strong></p>
<p>前端工程师不再只负责前端页面的开发，而需要具备更广的技术视野，逐步向“大前端 / 全栈式”方向演用AI进。AI 能帮助工程师把代码在不同技术栈之间快速迁移，但工程师必须具备跨技术领域的理解能力，才能评估、修改和维护 AI 生成的多端代码。因此前端需要掌握后端基础、Node 服务开发、跨端框架、小程序、移动端等多方向知识，使自己从单一前端角色成长为能够处理多端、多栈、多场景的技术型人才。</p>
</li>
</ul>
<h2 data-id="heading-3">AI 如何赋能前端</h2>
<h3 data-id="heading-4">前端开发流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2f48ab73174294b4ed70b1ac23d6d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KW_6Zm1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766502536&amp;x-signature=2ALGd91%2BA9pqrjLXQbib28ENgEY%3D" alt="image.png" loading="lazy"/></p>
<p>理想情况下，如果我们的提示词足够精确，从需求的理解到最后的代码开发，AI 都能帮我们完成开发，开发者唯一要做的就是对生成的结果进行 review，并优化提示词。</p>
<p>对于小型的项目来说这即将成为现实，说残酷点就是只会切图的前端工程师即将失业，但是对于复杂的大型项目来说这条路还很长很长，那现阶段作为前端开发工程师的我们该如何规划，化被动为主动，将 AI 能力内化？</p>
<h3 data-id="heading-5">AI如何开发提效</h3>
<h4 data-id="heading-6">初级阶段</h4>
<p>初级阶段开发者只需要会简单的使用 AI 能力即可：</p>
<ul>
<li>
<p>代码补全&amp;优化</p>
<p>例如 storybook 示例、单测代码等。</p>
</li>
<li>
<p>使用 AI 完成静态页面、纯 UI 组件等功能开发。</p>
<p>例如使用AI + 截图或者AI + Figma Mcp 完成 UI 开发。</p>
</li>
<li>
<p>….</p>
</li>
</ul>
<h4 data-id="heading-7">中级阶段</h4>
<p>该阶段开发者需要理解 <code>AI 提示词工程</code>，开发者需要通过合理的 rules 来约束 AI 的行为，确保其在执行复杂编码任务时的每一步操作都安全、可控且符合预期。例如当前业界接受度比较高的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNeekChaw%2FRIPER-5" target="_blank" title="https://github.com/NeekChaw/RIPER-5" ref="nofollow noopener noreferrer">RIPER-5</a> 规范，这个阶段 AI 可以帮助开发者完成：</p>
<ul>
<li>
<p>通过设置 rules 完成代码的初步 cr。</p>
</li>
<li>
<p>自动重构与技术债治理。</p>
<p>例如重复逻辑抽离、hooks 拆分、package 循环依赖分析&amp;解决。</p>
</li>
<li>
<p>接口对齐与类型推导</p>
</li>
<li>
<p>按照规范完成功能模块的开发&amp;迭代。</p>
</li>
<li>
<p>…</p>
</li>
</ul>
<h4 data-id="heading-8">高级阶段</h4>
<p>在高级阶段，AI 赋能前端开发不再局限于单点效率提升，而是进入能力工程化阶段。开发者一方面需要持续扩展 AI 在工程中的参与深度，另一方面针对 AI 幻觉、上下文限制和行为不确定性等固有缺陷进行系统性治理，并将实践经验沉淀为<code>可复用的工程能力</code>，从而构建稳定、可演进的智能开发体系，并可在团队及社区进行分享。</p>
<p>在 claude code 中已经提出并支持了相关能力，如下所示：</p>
<ul>
<li>Agent Skills</li>
<li>Sub Agent</li>
<li>Plugin</li>
</ul>
<p>详细介绍可查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fsub-agents" target="_blank" title="https://code.claude.com/docs/zh-CN/sub-agents" ref="nofollow noopener noreferrer">官方文档</a>。</p>
<h2 data-id="heading-9">总结</h2>
<p>本篇文章主要介绍了未来 AI 的发展的趋势，以及前端角色的转变，对前端工程师来说 AI 既是一种挑战也是一种机遇，挑战是指未来 AI 将会全面替代初级前端工程师，机遇则是 AI 也能够赋能前端工程师变成一个更全面的人才。最后也介绍了 AI 赋能前端开发提效的三个阶段，从 AI 的基本使用到 AI 能力工程化逐步提升，在后面的系列文章中作者会分享更多 AI 赋能开发的实战技巧和相关理论知识。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【项目踩坑实录】并发环境下，Glide缓存引起的图片加载异常]]></title>    <link>https://juejin.cn/post/7584320417306492979</link>    <guid>https://juejin.cn/post/7584320417306492979</guid>    <pubDate>2025-12-16T15:36:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584320417306492979" data-draft-id="7584279552433242150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【项目踩坑实录】并发环境下，Glide缓存引起的图片加载异常"/> <meta itemprop="keywords" content="Android,Debug,Glide"/> <meta itemprop="datePublished" content="2025-12-16T15:36:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【项目踩坑实录】并发环境下，Glide缓存引起的图片加载异常
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T15:36:54.000Z" title="Tue Dec 16 2025 15:36:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在现实主义者身上，并不是奇迹产生信仰，而是信仰产生奇迹。——《卡拉马佐夫兄弟》</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/533f755d7e0a46a0bdf2510cf43fae57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766504213&amp;x-signature=p2PFiQEVbnTBMSJn7zRJ6qspX5w%3D" alt="glide_logo.png" loading="lazy"/></p>
<h2 data-id="heading-0">背景简述</h2>
<p>在维护智能手表主题管理功能时，我遇到过一个十分有趣的bug，从测试首次发现问题时感到十分困惑且不解，到自己我不断尝试并成功复现，直至最终找到根本原因与解决方案，历经一周左右时间。虽然是存在已久的历史问题，但仍有记录和总结的意义，同时也警醒自己在设计并发模块时，一定要心存敬意、考虑周全。</p>
<h2 data-id="heading-1">问题现象</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ca16b34a864ee2a66ea2fb0b2033bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766504213&amp;x-signature=VnZB9oMnSBbmDU13iJp9AsFfn4g%3D" alt="" loading="lazy"/></p>
<p>问题的表现如上，用户编辑相册表盘后，返回到表盘列表页，预期是可以展示出新设置的相册表盘的预览图，但实际效果却是，图片确实有刷新出来，但又没有完全刷新，只展示了上半部分，下半部分是黑色。</p>
<h2 data-id="heading-2">技术设计方案</h2>
<p>这个模块是我中途接手的，在初期接手时就惊讶其功能复杂之高、逻辑嵌套之深。为了更好地理解问题，有必要介绍一下这个功能的技术方案设计。</p>
<p>暂且称之为“手表主题模块”，用来管理智能手表主题的样式，用户可以自定义智能手表上的字体、颜色、布局、背景图等，当用户完成设置后，生成当前配置下的预览图，并保存在应用数据目录下（<code>Android/data/packageName/files/aaa_111.png</code>），其它页面（例如表盘列表页）监听到预览图变化的事件后，更新 UI，展示出最新的预览图。</p>
<ul>
<li><code>WatchThemePreviewManager</code>：单例类，提供接口更新并保存预览图png，并通知监听者。</li>
<li><code>WatchThemeView</code>：继承自 <code>FrameLayout</code>，是预览图的展示View，在 <code>onAttachedToWindow()/onDetachedFromWindow()</code> 中进行注册/反注册，监听预览图变化。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d08452cee8d4e2f82eb89082ce43f47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766504213&amp;x-signature=V%2BWVETUFSlrIwo39qXdVMgLgsI8%3D" alt="用户操作流程图.png" loading="lazy"/></p>
<p>预期效果是，用户在APP中操作完主题样式设置后，其它所有展示这个手表表盘的页面，都会加载新的样式图。绝大多数场景下，的确表现如预期所想。但测试偶尔会发现前文图中的bug，新的预览图只展示了上半部分，其下半部分是纯黑色。查看应用数据目录后，发现生成的图片是完整的，并不存在缺失现象；从日志中也可以看到回调确实发生了，结果让人百思不得其解。</p>
<h2 data-id="heading-3">归结为2个问题</h2>
<ul>
<li>Q1：为什么图片只展示了局部，另一部分是纯黑的？</li>
<li>Q2：为什么回调发生后，没有把正常的图片刷新出来？</li>
</ul>
<h2 data-id="heading-4">最终分析结论</h2>
<p>略去中间繁琐的分析过程（无非就是在关键节点增加日志、打断点逐步调试等），直接将结论奉上。</p>
<ul>
<li>A1：使用 Glide 显示 png 文件时，文件虽然存在，但其内容尚未完全写入。</li>
<li>A2：Glide 加载同名文件，命中磁盘缓存，不会重新读取文件。</li>
</ul>
<h2 data-id="heading-5">Q1：图片加载不完整的原因</h2>
<p>虽然已经在代码里考虑到，当 png 文件保存完成（大约300ms）后，才回调通知监听者。但存在极限场景，即在“表盘编辑页”编辑后，快速返回到上一级的“表盘列表页”，由于“表盘列表页”在<code>onRestart()</code>时刷新界面，会读取到最新的预览图png路径，文件此时已存在，但尚未完成写入，因此 Glide 加载到的是只写入部分内容的 png，从而发生了图中的错误场景。</p>
<h2 data-id="heading-6">A1：解决方案-先写tmp文件再rename</h2>
<p>实践中，对于这种保存数据到文件的场景，一般采用“保存临时文件-&gt;rename”的方案，先把数据写入到临时文件f.tmp中，写入完成后，再将其rename为f，可以避免外部发生“读取部分文件”的场景。</p>
<p>这里还使用了 <code>FileOutputStream.flush()</code> 和 <code>FileOutputStream.fd.sync()</code>，对于 <strong>高频写入&amp;读取</strong> 的场景，这样做可以保障文件被迅速推给内核和落盘持久化。但 <code>sync()</code> 函数有性能损耗，在工程中慎用。</p>
<p>样例代码如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 原子性保存图片文件，外部不会读取到一部份文件
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveBitmapToFileAtomic</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>, path: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> dst = File(path)
    dst.parentFile?.mkdirs()

    <span class="hljs-keyword">val</span> tmp = File(dst.parentFile, dst.name + <span class="hljs-string">".tmp"</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        FileOutputStream(tmp).use { <span class="hljs-keyword">out</span> -&gt;
            <span class="hljs-keyword">if</span> (!bitmap.compress(Bitmap.CompressFormat.PNG, <span class="hljs-number">100</span>, <span class="hljs-keyword">out</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            <span class="hljs-keyword">out</span>.flush() <span class="hljs-comment">// 把文件推给内核</span>
            <span class="hljs-keyword">out</span>.fd.sync() <span class="hljs-comment">// 把文件强制落盘（更稳，但更慢，勿大批量调用），适用于写完立刻读的场景</span>
        }

        <span class="hljs-comment">// renameTo 在同一分区通常是“原子替换”效果：读者要么看到旧文件，要么看到新完整文件</span>
        <span class="hljs-keyword">if</span> (dst.exists()) dst.delete()
        tmp.renameTo(dst)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        tmp.delete()
        <span class="hljs-literal">false</span>
    }
}
</code></pre>
<h2 data-id="heading-7">Q2：回调后没有触发重新加载图片的原因</h2>
<p>对于同一个 ImageView，使用 Glide 加载同名文件，如果不增加文件签名校验，会导致直接复用前一次产生的缓存。这也就解释了，为什么当真正完成 png 文件保存后，回调触发时，预览图并没有刷新为正常版本。</p>
<h2 data-id="heading-8">A2：解决方案-增加signature</h2>
<p>解决方法是，在调用 Glide 加载图片时，使用 <code>signature()</code> 函数，用于在原有的缓存Key计算方法上增加唯一性校验，其内部使用参数的 <code>equals()</code> 和 <code>hashCode()</code> 实现。接口文档如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">public RequestOptions signature(@NonNull Key signature)

Sets some additional data to be mixed in to the memory and disk cache keys allowing the caller more control over when cached data is invalidated.

Note - The signature does not replace the cache key, it is purely additive.

Parameters:
signature - A unique non-null Key representing the current state of the model that will be mixed in to the cache key.

Returns:
This request builder.

See Also:
ObjectKey
</code></pre>
<p>因此，在使用Glide为此 ImageView 加载图片时，对于文件名不变但内容可能发生变化的场景，建议进一步增加签名校验，常见的 signature 参数有 <code>file.lastModified()</code>、文件字节数、md5等。</p>
<p>这里我使用 <code>文件长度_更新时间</code>，作为唯一key，可以解决文件内容更新的问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadPngIntoImageView</span><span class="hljs-params">(imageView: <span class="hljs-type">ImageView</span>, pngFile: <span class="hljs-type">File</span>)</span></span> {
    glide.with(context)
        .load(pngFile)
        .signature(ObjectKey(<span class="hljs-string">"<span class="hljs-subst">${file.length()}</span>_<span class="hljs-subst">${file.lastModified()}</span>"</span>)) <span class="hljs-comment">// 文件长度_更新时间戳，解决文件更新问题</span>
        <span class="hljs-comment">// 略</span>
        .into(imageView)
}
</code></pre>
<h2 data-id="heading-9">写在最后的反思</h2>
<ol>
<li>这种“先写tmp文件，然后重命名”的模式，适用于大多数写文件的场景。笔者之前开发apk下载工具时，也处理过类似问题，没有下载完成的apk文件，也会被资源管理器识别成安装包，但解析必定失败。</li>
<li>缓存虽好，使用要谨慎。使用Glide加载图片文件，在启用缓存的情况下，如果文件名不变但文件内容发生变化，是不会读取更新后的内容的。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[springboot 项目 从jdk 8 升级到jdk21 会面临哪些问题]]></title>    <link>https://juejin.cn/post/7584307643000078379</link>    <guid>https://juejin.cn/post/7584307643000078379</guid>    <pubDate>2025-12-16T13:31:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307643000078379" data-draft-id="7584273076646166534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="springboot 项目 从jdk 8 升级到jdk21 会面临哪些问题"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-16T13:31:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            springboot 项目 从jdk 8 升级到jdk21 会面临哪些问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T13:31:59.000Z" title="Tue Dec 16 2025 13:31:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>兄弟们最近上班没时间写博客啊，今天又来水一篇！</p>
<p>Spring Boot 项目从 JDK 8 升级到 JDK 21（长期支持版 LTS），会面临哪些问题。 主要就是<strong>API变更、框架适配、第三方依赖、构建工具配置</strong> 问题。</p>
<blockquote>
<p>推荐阅读: <a href="https://juejin.cn/user/2634854380340008/posts" target="_blank" title="https://juejin.cn/user/2634854380340008/posts">JDK从8升级到21的问题集（京东云）</a></p>
</blockquote>
<h2 data-id="heading-1">springboot项目从1.8到21面临的问题</h2>
<h3 data-id="heading-2">一、JDK API 变更导致的问题</h3>
<p>JDK 8 到 21 有大量 API 废弃、移除或行为变更，核心影响点：</p>
<h4 data-id="heading-3">1. 已移除的 API</h4>
<ul>
<li><code>sun.misc.BASE64Encoder/Decoder</code>：JDK 8 中已标记废弃，JDK 16 + 移除，需替换为<code>java.util.Base64</code>；</li>
<li><code>Thread.stop()</code>、<code>Thread.suspend()</code>：JDK 11 + 严格限制，调用会抛 UnsupportedOperationException；</li>
<li><code>com.sun.image.codec.jpeg.JPEGCodec</code>：JDK 9 + 移除，需替换为<code>ImageIO</code>；</li>
<li><code>java.security.acl</code>包：JDK 17 + 标记为废弃，JDK 21 中部分类移除，需改用<code>java.security.Policy</code>。</li>
</ul>
<h4 data-id="heading-4">2. 模块化限制（JPMS）</h4>
<p>JDK 9 + 引入模块系统，默认不允许访问<code>sun.*</code>、<code>com.sun.*</code>等内部 API：</p>
<ul>
<li>
<p>问题表现：运行时抛<code>IllegalAccessError</code>或<code>ModuleNotFoundException</code>；</p>
</li>
<li>
<p>解决方案：</p>
<ul>
<li>替换内部 API 为标准 API（如<code>sun.misc.Unsafe</code>替换为<code>VarHandle</code>）；</li>
<li>若必须使用，需在启动参数中添加<code>--add-exports</code>（如<code>--add-exports java.base/sun.misc=ALL-UNNAMED</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">3. 日期时间 API（可选）</h4>
<p>JDK 8 的<code>Date/Calendar</code>未移除，但 JDK 1.8 引入的<code>java.time</code>（JSR 310）在 21 中更完善，若项目仍用旧 API，需注意：</p>
<ul>
<li><code>SimpleDateFormat</code>的线程安全问题未解决，但 JDK 21 无变更；</li>
<li>推荐逐步替换为<code>LocalDateTime</code>、<code>ZonedDateTime</code>等。</li>
</ul>
<h4 data-id="heading-6">4. 字符串与集合 API 变更</h4>
<ul>
<li><code>String.trim()</code>：JDK 11 + 行为不变，但<code>String.strip()</code>（去除 Unicode 空白）成为推荐替代；</li>
<li><code>Collections.singletonMap()</code>：JDK 9 + 新增<code>Map.of()</code>、<code>List.of()</code>等不可变集合工厂方法，旧代码兼容，但需注意不可变集合的特性（不支持修改）。</li>
</ul>
<h3 data-id="heading-7">二、Maven版本兼容</h3>
<p>JDK 21 对构建工具版本有最低要求，旧版本构建工具无法识别 JDK 21 的编译参数：</p>
<p><strong>Maven</strong>：需升级到 3.8.0+（推荐 3.8.5+），且<code>maven-compiler-plugin</code>需升级到 3.10.0+（否则无法编译 JDK 21 代码）。</p>
<pre><code class="hljs language-pom.xml" lang="pom.xml">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; 
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; 
    &lt;version&gt;3.13.0&lt;/version&gt; 
    &lt;configuration&gt; 
        &lt;release&gt;21&lt;/release&gt;&lt;!-- 统一使用release参数 --&gt; 
    &lt;/configuration&gt; 
&lt;/plugin&gt;

</code></pre>
<h3 data-id="heading-8">三、Spring Boot 框架本身和中间件版本</h3>
<h4 data-id="heading-9">1. Spring Boot 版本必须升级</h4>
<p>JDK 21 仅支持<strong>Spring Boot 3.1+</strong> （官方明确：Spring Boot 3.0 支持 JDK 17，3.1 开始支持 JDK 21），若项目当前是 Spring Boot 2.x（仅支持 JDK 8-17），需先升级到 Spring Boot 3.x，这会带来连锁变更：</p>
<ul>
<li>
<p><strong>Spring Boot 3.x 核心变更</strong>：</p>
<ul>
<li>基于 Spring Framework 6.x，要求 Java 17+（JDK 21 兼容）；</li>
<li>移除对<code>javax.*</code>包的支持，全面迁移到<code>jakarta.*</code>（如<code>jakarta.servlet</code>替代<code>javax.servlet</code>，<code>jakarta.persistence</code>替代<code>javax.persistence</code>）；</li>
<li>自动配置类、starter 依赖有调整（如<code>spring-boot-starter-web</code>底层依赖 Tomcat 10+，而 Tomcat 10 + 也基于 Jakarta EE 9）。</li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li><strong>内嵌容器</strong>：Tomcat 9（JDK 8）→ Tomcat 10+（JDK 17+），Tomcat 10 + 的 Servlet API 从<code>javax.servlet</code>迁移到<code>jakarta.servlet</code>，若项目中有自定义 Servlet/Filter/Listener，需修改包名；</li>
<li><strong>日志框架</strong>：Spring Boot 3.x 默认使用 Logback 1.4+，Logback 1.4 + 要求 JDK 11+，需确认日志配置文件（如<code>logback.xml</code>）是否适配；</li>
<li><strong>缓存、事务等注解</strong>：<code>@Transactional</code>、<code>@Cacheable</code>等注解底层依赖的 API 无大变更，但需确认 Spring Framework 6.x 的行为变更（如事务传播机制、缓存管理器适配）。</li>
</ul>
</blockquote>
<h4 data-id="heading-10">2、第三方依赖兼容问题</h4>
<p>这是升级中最常见的 “坑”，大量第三方库在 JDK 21 下无法运行：</p>
<h5 data-id="heading-11">1. 数据库驱动</h5>
<ul>
<li><strong>MySQL 驱动</strong>：<code>mysql-connector-java</code> 8.0.28 + 才支持 JDK 17+，需升级到 8.0.30+（适配 JDK 21）；</li>
<li><strong>Oracle 驱动</strong>：ojdbc8 仅支持 JDK 8-11，需升级到 ojdbc11（支持 JDK 11-21）；</li>
<li><strong>PostgreSQL 驱动</strong>：42.2.x 仅支持 JDK 8，需升级到 42.5+（支持 JDK 17+）。</li>
</ul>
<h5 data-id="heading-12">2. 中间件客户端</h5>
<ul>
<li><strong>Redis</strong>：<code>jedis</code> 3.7.x 仅支持 JDK 8，需升级到 4.0+（支持 JDK 11+）；</li>
<li><strong>Kafka</strong>：<code>kafka-clients</code> 2.8.x 支持 JDK 8，3.0 + 支持 JDK 11+，需升级到 3.4+（适配 JDK 21）；</li>
<li><strong>Elasticsearch</strong>：7.17.x 支持 JDK 8-17，8.x 支持 JDK 17+，需升级客户端到 8.x（适配 JDK 21）。</li>
</ul>
<h5 data-id="heading-13">3. 其他常用库</h5>
<ul>
<li><strong>MyBatis</strong>：3.5.9 + 支持 JDK 17+，需升级（旧版本 3.5.6 以下在 JDK 21 中会抛类加载异常）；</li>
<li><strong>FastJSON</strong>：1.2.83 以下存在 JDK 17 + 兼容问题，需升级到 2.0+（FastJSON2）；</li>
<li><strong>Apache Commons</strong>：<code>commons-lang3</code>需升级到 3.12.0+，<code>commons-collections4</code>需升级到 4.4+；</li>
<li><strong>Lombok</strong>：1.18.20 以下不支持 JDK 16+，需升级到 1.18.30+（适配 JDK 21），且需在 Maven 中配置<code>lombok.version</code>为最新版。</li>
</ul>
<h3 data-id="heading-14">四、运行时与启动参数问题</h3>
<h4 data-id="heading-15">1. JVM 参数变更</h4>
<ul>
<li>JDK 8 的<code>-XX:+UseConcMarkSweepGC</code>（CMS 垃圾收集器）在 JDK 14 中废弃，JDK 21 中移除，需替换为<code>-XX:+UseG1GC</code>（默认）或<code>-XX:+UseZGC</code>（JDK 15 + 正式支持，低延迟）；</li>
<li><code>-XX:+UseParallelGC</code>仍可用，但推荐适配新 GC；</li>
<li>JDK 11 + 移除<code>-XX:+UseCGroupMemoryLimitForHeap</code>，需改用<code>-XX:+UseContainerSupport</code>（默认开启）。</li>
</ul>
<h4 data-id="heading-16">2. 模块化启动参数</h4>
<p>若项目未适配模块化，需添加启动参数避免模块冲突：</p>
<pre><code class="hljs language-css" lang="css">java <span class="hljs-attr">--add-modules</span> <span class="hljs-attribute">ALL</span>-MODULE-PATH \
     <span class="hljs-attr">--add-exports</span> java<span class="hljs-selector-class">.base</span>/sun<span class="hljs-selector-class">.misc</span>=<span class="hljs-attribute">ALL</span>-UNNAMED \
     -jar your-app<span class="hljs-selector-class">.jar</span>
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p>主要的风险点：spring boot 需要升级到<strong>Spring Boot 3.1+</strong> ，大版的升级就涉及到很多中间件需要跟着升级，其次就是一些API可能被移除了，这块编译就阶段就能解决。还有就是我们maven版本和编译插件需要升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[出海别再 1:1 抄站了:《毛选》给我的 6 条底层思考]]></title>    <link>https://juejin.cn/post/7584286241488273448</link>    <guid>https://juejin.cn/post/7584286241488273448</guid>    <pubDate>2025-12-16T14:03:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584286241488273448" data-draft-id="7584286241488240680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="出海别再 1:1 抄站了:《毛选》给我的 6 条底层思考"/> <meta itemprop="keywords" content="产品,创业,AI编程"/> <meta itemprop="datePublished" content="2025-12-16T14:03:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            出海别再 1:1 抄站了:《毛选》给我的 6 条底层思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T14:03:41.000Z" title="Tue Dec 16 2025 14:03:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>好久不见。前段时间我被甲流 <strong>H3N2</strong> 放倒了，恢复了两周才缓过来，体感不亚于新冠。冬季流感高发，大家注意防护，别硬扛。</p>
<p>躺着休息的这段时间，我一直在想一个问题：</p>
<p><strong>创业到底有没有一套可复用的底层方法论？有没有一种“更底层的思维”，能在不确定性里给我们一个稳定的指南针？</strong></p>
<p>思来想去，我发现答案很朴素：去读《毛选》。</p>
<p>它告诉你<strong>如何认识世界、如何分析问题、如何组织行动</strong>。</p>
<p>把它抽象成方法论，再放回到商业与出海的语境里，会非常好用。</p>
<p>这篇文章我想把自己的实战体会，和《毛选》里几条核心思维做一个对应，供你参考：</p>
<ul>
<li>
<p><strong>实事求是</strong>：用调查替代臆想，让决策对齐现实</p>
</li>
<li>
<p><strong>阶级分析</strong>：看清利益结构，决定团结谁、合作谁、对抗谁</p>
</li>
<li>
<p><strong>主要矛盾</strong>：抓住“牵一发而动全身”的关键问题，避免眉毛胡子一把抓</p>
</li>
<li>
<p><strong>对立统一</strong>：辩证看优劣，把不利条件转化为有利条件</p>
</li>
<li>
<p><strong>持久战</strong>：以时间换空间，在正确战场长期积累优势</p>
</li>
<li>
<p><strong>从群众中来，到群众中去</strong>：用 MVP + 反馈闭环，把认知落到实践里</p>
</li>
</ul>
<h3 data-id="heading-0">01｜实事求是：创业最稀缺的不是聪明，是“事实”</h3>
<p>毛选的思想框架，建立在四个字的基石上面——实事求是。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cd319a2c81a4ab3b9ce3682e298e54e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=BEKnxCrPgstZ7vQrzyPT2RcwFdc%3D" alt="" loading="lazy"/></p>
<p>“实事”就是客观存在着的一切事物，“是”就是客观事物的内部联系，也就是规律性，“求”就是去研究。</p>
<p>实事求是，本质上就是要求我们的思想必须和客观现实精准对应起来。</p>
<p>这听起来理所当然，但是实际并不容易做到。</p>
<p>之前我分享过快思考慢思考，人类的大脑偏向于耗能低的快思考来做决策，也就是说依赖直觉、经验、情绪等等来做判断。</p>
<p>我们经常看到某个人成功了，或者商业模式成功了，就急于去复制它的表象。</p>
<p>在做出海的时候，这种例子太多了，很多人会去 1:1 复制别人的站点，像素级对齐。</p>
<p>但是，我们忽略了它能够成功的“实事”是什么，它的市场环境、用户基础、内部环节之间的“是”。</p>
<p>真正的实事求是，第一步是放下预设的立场和答案，这是一种“空杯心态”，承认自己的无知。</p>
<p>我们需要询问的是“事实究竟是什么”，而不是“我认为/希望事实是什么”。</p>
<p>我们出海做产品的第一步就是去挖掘需求，很容易没有“空杯心态”。</p>
<p>比如，在看到一个“background remove”这个关键词，想当然的认为这就是一个简单的需求，不就是去除背景吗？</p>
<p>你去深入看一下，就知道这是 Photoshop 的核心功能，它围绕这个事情做了多么大量的工作，市场上有多少竞品。</p>
<p>我们团队有的时候做内页的需求，想当然的就是根据关键词让 AI 去生成页面，这是肯定不行的。</p>
<p>第一，AI 的知识库是老旧的，你给他一个关键词，他未必能够深入理解背后的需求，基本上出来的都是废话幻觉。</p>
<p>第二，google 每天都在更新信息，一个词背后可能是一个讨论、一个事件、一个工具等等，你在没有调查之前，根本不知道这个词是什么东西。</p>
<p>没有调查，就没有发言权。我们出海去做产品，肯定要研究市场，研究竞品。斩断一切的臆想和揣测，而且不能太表面的调研。</p>
<p>调研是有方式方法的，查资料要去查一手资料，而不是 AI 总结的幻觉资料。很多人现在都借助 AI 分析需求，这是不好的。</p>
<p>在我们的出海去分析需求的时候，要去 Reddit、Twitter、Facebook、Youtube 等等多种渠道，理解这个需求背后的第一手资料背景，才能深刻明白真正的用户需求。</p>
<p>基于实事求是的思想，去理解需求，我们的调研是深刻的，而不是表面的，是真实的，而不是臆测的，这就是洞察，久而久之，我们就有了洞见。</p>
<p>可以说，掌握了实事求是，就能做到，无论外界环境多么复杂多变，都能找到通往正确方向的道路。</p>
<h3 data-id="heading-1">02｜阶级分析：看清利益结构，才能做出正确站位</h3>
<p>毛选的第二个思想是阶级分析，也就是分清谁是我们的敌人，谁是我们的朋友。这一点非常重要，天下熙熙，皆为利来，在商业世界中，所有的人或事都绑定在利益上面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6fd9c8f437241fca61b07b205fc91ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=quAh5ddJBu2f%2FqWPX%2BieuxzRAps%3D" alt="" loading="lazy"/></p>
<p>每个人的核心诉求和利益都不一样，我们在推动事情和做决策之前，先要划分利益群体，比如对于平台型产品来说，平台方、大 V 创作者、中小创作者、普通用户、广告商，他们就是不同利益阶级的群体。</p>
<p>在我们那个爆发的站点产品上线后，其实有一系列竞争者出现，也有一系列希望合作的邮件出现。这个时候，就需要站在利益的角度，思考如何去做决策，总体的指导思想就是团结朋友，打击敌人。</p>
<p>我之前完全不熟悉海外 Affliate 的这套玩法，在产品上线后，倒闭自己完全将 Affliate 的方式研究透彻，现在我来自于 Affliate 的收入已经超过了千刀，而且已经正式迁移至 Affliate 平台当中，建立了长期的合作关系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a47172e362c441b8604d8b5c9db6054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=eRw6B2TkbPxEl4pjeL5FIxPI4fY%3D" alt="" loading="lazy"/></p>
<p>在我 SEO 排名下降的那段时间，我的收益不降反增，因为排名上升的是我的盟友，通过 Affliate 过来的用户价值远远大于所谓 SEO 排名的流量，这就打了一场很好的防御战。</p>
<p>在现在，我的 SEO 又重回了前三的排名位置，这个战略与阶级分析的思维方法是不谋而合的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb453c3e5994960a58515ed282b998c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=d%2Fq6LDYZq2vsA7deN8TNQccJH48%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">03｜抓主要矛盾：0-1 阶段，先解决“活下去”</h3>
<p>毛选的第三个思想，是抓住主要矛盾。做出海应用，我们面临的场景是复杂多变的，各种各样的细节和矛盾错综复杂，到底应该从何处着手，如果缺乏一个清晰的优先级，就会陷入眉毛胡子一把抓的困境。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f97503f172849179e5b8ba9c59a18db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=Pp1fi2REtpNLMnNFuNBM86T4yyg%3D" alt="" loading="lazy"/></p>
<p>那么，如何判断什么是主要矛盾呢？标准只有一个：看哪个矛盾的存在和发展，规定或影响了其他矛盾的存在和发展。主要矛盾往往就是牵一发而动全身。</p>
<p>在抗日战争时期，有中华民族和帝国主义的民族矛盾，有国内的阶级矛盾，有国民党内部的派系矛盾等等，哪个是主要矛盾？毫无疑问，是民族矛盾，如果这个问题不解决，其他矛盾无从谈起。这就是战略思维。</p>
<p>对于我们初步尝试 0-1 创业的出海业务来说，面临无数问题，有人说 Reddit 非常重要，有人说必须要做 Twitter，有人说应该去美国开个公司，有人说需要办个港卡...</p>
<p>这个时候，就要想清楚什么是主要矛盾，0-1 阶段是生存阶段，所有其他人的建议和经验都是外在表象，0-1 要考虑的首要问题是生存问题，是 PMF 的问题，是能不能活下去的问题。</p>
<p>所以想通了这一点，我们就可以把目标定为 3 个月赚到千刀，那么以上提到的所有事情都是锦上添花，并不是关键因素。那我们需要从结果反推，如何达成目标？所有能想到的关键因素就是主要矛盾。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f50f5a61ce4baa8245fbfb01b250d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=W%2B%2B3%2F7cpYLXEnvqYby%2Bn0O1nBvU%3D" alt="" loading="lazy"/></p>
<p>团队经过 AARRR 模型的反复推演，就可以得出在 0-1 阶段最重要的动作，实际上可以归纳为两个：市场+效率。只要我们选对市场，把效率最大化，利用 AI 编程的杠杆上 100 个站，理论上最有可能达到目标。</p>
<p>这样一拆解，就十分清晰了，主要动作有两个，一个是提升市场洞察力，一个是提升 AI 编程效率，以量变产生质变是核心的战略。当然肯定也不是盲目上站，必然是要经过不断复盘才能够成长，那么细致的 SOP 也就出来了，只要不断执行：找需求-做需求-运营外链-复盘，这个闭环反复做，就可以达成目标。</p>
<p>所以说，抓住主要矛盾是一个很好的方法论，这需要我们有一定的领导意识和战略意识，才能拨开迷雾，看清事情的本质，这和第一性原理有异曲同工之处。</p>
<h3 data-id="heading-3">04｜对立统一：把劣势当变量，而不是定论</h3>
<p>毛选的第四个思想，是矛盾的对立统一法则。其实我们中华传统文化早就已经产生智慧，中庸之道，太极，都是在讲我们不能静止、孤立、片面地看待问题，任何矛盾的双方，相互排斥、相互斗争，又相互依存，相互联结。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31102bc4b83c4b09955d35931785e049~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=AR5zILQq%2FO6yLnbRIbR0hJQX4lk%3D" alt="" loading="lazy"/></p>
<p>所谓阴阳既是对立，又是统一，没有绝对的光芒，也没有绝对的黑暗。在商业市场上，买方希望加个越低越好，卖方希望价格越高越好，看似对立，又必须相互依存，才能共生。</p>
<p>这是一种哲学思想，又是我们看待问题的高度，解决矛盾的目的不是为了消灭某一方，而是要双方在一个更高的水平上达成新的平衡。</p>
<p>从出海创业的这个角度来说，我们的优势劣势本身就是一个对立统一体，在市场上，我们跟大公司竞争，在很多方面都处于劣势，但相对来说，劣势也是优势，所谓“船小好调头”，决策流程、执行力、市场反应灵活，这就是劣势中的有利条件。</p>
<p>其实，我们创业的失败和成功也是一个对立统一的关系，你会发现很多互联网创业成功的大佬，都是连续创业者，屡败屡战，失败并不是一个可怕的事情，关键在于我们能否在创业失败中进行复盘，吸取教训，东山再起。</p>
<h3 data-id="heading-4">05｜《论持久战》：以时间换空间，在正确战场长期积累</h3>
<p>毛选的第五个思想是《论持久战》，这是一部伟大的著作，它揭示了以弱胜强的底层逻辑，为所有劣势地位的奋斗者提供了一部战略宝典。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1326779d6e84c5fb22496c3a510b4b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=5Cwww%2BPTpxWILJmDklAmV684KB0%3D" alt="" loading="lazy"/></p>
<p>它的核心思想是，反对速胜论和亡国论的悲观，主张在客观认识敌我优劣的基础上，通过发挥主观能动性，打一场有计划、有步骤，以时间换空间的持久战。</p>
<p>这个结论需要清醒地认识，速胜是不可能的，因为敌强我弱。亡国也是不可能的，因为敌小我大，敌退步我进步，敌寡助我多助，这奠定了最坚实的认知基础。</p>
<p>这个思维模型告诉我们，当面对一个强大的对手时，不要被其表面的强大所吓到，也不要被自己的弱小所迷惑。必须非常深入的分析，对方的强大背后，有哪些固有的、难以克服的弱点？自身的弱小之中，蕴含着哪些可以被利用、决定未来的优势？</p>
<p>对于出海创业来说，持久战的思想尤为重要。我们个体创业，天然在某些方面存在劣势，如果你去在主战场与巨头证明硬刚，无异于以卵击石。</p>
<p>我们目前看出海的细分市场，实际上正是“巨头看不上”的边缘市场，但是这个市场的蛋糕足够大，我们能够通过灵活的优势，快速抢占这个市场。</p>
<p>所谓“新词”的逻辑，就是以时间和效率优势，快速抢占新的市场，抢占谷歌每天 15%的新检索算力，从而构建了它的商业模式。</p>
<p>所谓“长尾词”的逻辑，就是农村包围城市战略，以小博大，通过细分垂直需求关键词域名，逐步占领长尾词市场，积少成多，以小博大，在持久战中能够超越竞争对手。</p>
<p>这个战略，更考验战略定力和执行的坚韧，也就是所谓的耐心和坚持。所以我常常说，创业不是一般人能够做的，因为大多数人只想赚快钱，只想一夜暴富，很难持久地去做一件事。</p>
<p>我们做创业，需要脚踏实地，一步一个脚印，将目标拆解，踏踏实实地走好每一步。在困难的时候，有坚持下去的勇气和方法，在顺利的时候，保持清醒和谦逊。</p>
<h3 data-id="heading-5">06｜从群众中来，到群众中去：用 MVP + 反馈闭环逼近真相</h3>
<p>毛选的第六个思想，是从群众中来，到群众中去。我们做产品，对这个体会可能会更加深刻，这里的“群众”就是我们的用户。所有的需求，一定不能是凭脑袋空想出来的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b6bc6b29e948db95dd8551d3a7f26d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766498621&amp;x-signature=t2%2FSA3UJ7rbp4VCIWPE1gf%2FWi9g%3D" alt="" loading="lazy"/></p>
<p>其实在精益创业中，有很大的篇幅是介绍了我们应该怎样进行用户研究，用户访谈，从而提炼出真正的需求。对于出海业务，用户访谈可能是一个难题，这就更需要我们拥有产品 Sense。</p>
<p>SEO 相对来说就是一个科学的方法论，通过关键词的分析，来拆解用户背后的诉求，至少这个 idea 不是凭空创造出来的，它是真正的用户需求。</p>
<p>然后我们凭借自己的调研，对于 Serp 站点的深入体验和思考分析，确定用户的实际需求，这个过程，就是从群众中来。最后，我们通过实验的方式，做出产品进行市场验证，就是所谓的“到群众中去”。</p>
<p>一旦我们的 MVP 产品有了初始用户，我们可以通过邮件的方式收到用户反馈，亦或是评价、评论的方式，从多方面收集用户诉求，这样就形成了每一次产品的迭代优化，随着每一次的迭代，我们就深化产品认知，决策完善一步。</p>
<p>这个闭环就是：**实践、认知、再实践、再认知。**你不可能在行动之前就掌握全部真理，很多事情只有去做了，才能真正明白。所以，要敢于实践，敢于试错。</p>
<h3 data-id="heading-6">写在最后：把方法论变成你的行动清单</h3>
<p>回到开头那个问题：创业有没有一套底层思维？</p>
<p>我的答案是：有。至少对我而言，《毛选》给了我一套非常强的“问题解决框架”：</p>
<ul>
<li>
<p><strong>实事求是</strong>：用调查研究搞清楚事实</p>
</li>
<li>
<p><strong>阶级分析</strong>：用利益地图决定合作与竞争</p>
</li>
<li>
<p><strong>主要矛盾</strong>：把主要精力投入到“牵一发而动全身”的关键问题</p>
</li>
<li>
<p><strong>对立统一</strong>：辩证看利弊，把不利因素转化为有利条件</p>
</li>
<li>
<p><strong>持久战</strong>：长期坚持，有目标、有阶段、脚踏实地</p>
</li>
<li>
<p><strong>从群众中来，到群众中去</strong>：用 MVP 最快获得反馈，不断试错与复盘</p>
</li>
</ul>
<p>如果你愿意，欢迎在评论区告诉我：你当下出海/创业的<strong>主要矛盾</strong>是什么？</p>
<p>好了，今天就分享到这里。咱们下期再见！</p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当时序数据不再“只是时间”：金仓数据库如何在复杂场景中拉开与 InfluxDB 的差距]]></title>    <link>https://juejin.cn/post/7584287969214791699</link>    <guid>https://juejin.cn/post/7584287969214791699</guid>    <pubDate>2025-12-16T14:28:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584287969214791699" data-draft-id="7584307643000307755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当时序数据不再“只是时间”：金仓数据库如何在复杂场景中拉开与 InfluxDB 的差距"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T14:28:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当时序数据不再“只是时间”：金仓数据库如何在复杂场景中拉开与 InfluxDB 的差距
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T14:28:37.000Z" title="Tue Dec 16 2025 14:28:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">当时序数据不再“只是时间”：金仓数据库如何在复杂场景中拉开与 InfluxDB 的差距</h2>
<h3 data-id="heading-1">一、时序数据库的“第二阶段”已经到来</h3>
<p>在很长一段时间里，时序数据库的核心问题只有一个：
<strong>如何高效存储按时间不断增长的数据点？</strong></p>
<p>InfluxDB 正是在这一阶段脱颖而出的代表产品。其专门为时间序列设计的存储模型、简洁的写入接口以及良好的初期性能，使其在监控和物联网领域被大量采用。</p>
<p>但随着业务系统逐渐成熟，企业对时序数据的诉求正在发生变化：</p>
<ul>
<li>数据量不再是百万、千万，而是<strong>持续增长的百亿级</strong></li>
<li>查询不再只是画图，而是<strong>实时分析、异常定位、智能决策</strong></li>
<li>时序数据不再独立存在，而是要与<strong>业务数据、设备数据、空间信息</strong>结合</li>
</ul>
<p>这意味着，时序数据库正在进入一个新的阶段——
<strong>从“专用存储工具”向“核心数据能力”的转变。</strong></p>
<p>也正是在这一阶段，金仓数据库（KingbaseES）与 InfluxDB 的差距开始被不断放大。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6bdfa05de7c446491c79ba14269cdd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766500117&amp;x-signature=gu2xDu4i1y8OZDe8RJ%2FqqBVovoU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">二、写入不是终点：高并发之下的可持续能力</h3>
<p>写入性能，往往是评价时序数据库的第一指标。但真正重要的，并不是“单次跑分有多高”，而是：</p>
<blockquote>
<p>在设备规模不断扩大、写入长期持续的情况下，系统是否还能稳定、高效地运行？</p>
</blockquote>
<p>在基于 TSBS 的测试中，模拟了从小规模设备到千万级设备的持续写入压力。测试结果呈现出一个非常清晰的趋势：</p>
<ul>
<li>在小规模写入场景下，两者性能接近</li>
<li>随着设备数量和指标数量增长，金仓的写入吞吐优势逐步显现</li>
<li>在千万级设备压力下，金仓的写入性能达到 InfluxDB 的 <strong>2 倍以上</strong></li>
</ul>
<p>这背后反映的，并不是简单的“写得快”，而是：</p>
<ul>
<li>并发调度能力</li>
<li>存储结构对高基数数据的适应性</li>
<li>分区与索引策略的可扩展性</li>
</ul>
<p>在真实生产系统中，这些因素往往比单次写入延迟更重要。</p>
<hr/>
<h3 data-id="heading-3">三、真正决定上限的，是复杂查询能力</h3>
<p>如果说写入能力决定系统能否“活下来”，那么查询能力决定的，就是系统是否“有价值”。</p>
<p>在大量企业实践中，时序查询往往会经历三个阶段：</p>
<ol>
<li><strong>基础查询</strong>：单指标、短时间窗口</li>
<li><strong>分析查询</strong>：多设备、多指标、分组聚合</li>
<li><strong>业务查询</strong>：最新状态、异常筛选、跨维度分析</li>
</ol>
<h4 data-id="heading-4">1. 简单查询阶段：差距不明显</h4>
<p>在单设备、单指标的聚合查询中，金仓与 InfluxDB 的性能都能保持在毫秒级，整体体验差距有限。</p>
<p>这也是很多团队在早期使用 InfluxDB 时感觉“性能很好”的原因。</p>
<hr/>
<h4 data-id="heading-5">2. 分析查询阶段：优势开始显现</h4>
<p>当查询涉及多设备、多指标，并且需要进行分组统计时，金仓的优势逐步体现。</p>
<p>在典型的“多设备多指标一小时统计”测试中：</p>
<ul>
<li>金仓的响应速度通常为 InfluxDB 的 <strong>3～4 倍</strong></li>
<li>随着时间窗口拉长，这一差距仍能保持稳定</li>
</ul>
<p>这说明，在数据量和计算复杂度同时增长的情况下，金仓的执行计划和资源调度更加高效。</p>
<hr/>
<h4 data-id="heading-6">3. 业务级查询：数量级差距的出现</h4>
<p>在最接近真实业务的查询场景中，两者的性能差距呈现出数量级放大。</p>
<p>例如：</p>
<ul>
<li><strong>Last Point 查询</strong>（获取每个设备的最新数据）</li>
<li><strong>阈值筛选查询</strong>（找出某时间段内超限的设备）</li>
<li><strong>状态统计查询</strong>（按设备维度汇总运行状态）</li>
</ul>
<p>在测试中，面对数百台设备的数据：</p>
<ul>
<li>金仓的查询耗时维持在百毫秒级</li>
<li>InfluxDB 的查询耗时则可能达到数秒甚至十秒以上</li>
</ul>
<p>在部分场景下，性能差距超过 <strong>70 倍</strong>。</p>
<p>对于实时告警、智能调度和自动控制系统而言，这种差距直接决定了系统是否“可用”。</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45b0fe36c4864590bbed424ee0e6f87d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766500117&amp;x-signature=VV7PogJYf4LvlHAOATJEYUwZgV4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">四、架构差异：为什么 InfluxDB 会在复杂场景中“吃力”</h3>
<p>从根本上看，这种性能差距并非偶然，而是架构设计目标不同所导致的必然结果。</p>
<h4 data-id="heading-8">1. 专用模型 vs 通用执行引擎</h4>
<p>InfluxDB 的设计初衷是围绕时间序列进行高度优化，适合指标型数据的快速写入与简单聚合。</p>
<p>而金仓的时序能力，构建在成熟的关系型数据库内核之上，具备：</p>
<ul>
<li>完整的查询优化器</li>
<li>多种索引与执行策略</li>
<li>成熟的并发控制与事务机制</li>
</ul>
<p>当查询逻辑变复杂时，这种通用能力反而成为优势。</p>
<hr/>
<h4 data-id="heading-9">2. SQL 生态带来的长期收益</h4>
<p>金仓原生支持标准 SQL，这一点在企业级场景中意义重大：</p>
<ul>
<li>可直接复用 BI、报表、分析工具</li>
<li>支持复杂关联查询与子查询</li>
<li>统一技术栈，降低学习和维护成本</li>
</ul>
<p>相比之下，InfluxDB 的专用查询语言在简单场景下足够高效，但在复杂分析和系统集成中，往往需要额外的适配和开发工作。</p>
<hr/>
<h3 data-id="heading-10">五、存储与成本：被忽视但极其关键的维度</h3>
<p>在海量时序数据场景中，存储成本往往是长期运营中最大的隐性支出。</p>
<p>金仓在数据生命周期管理方面提供了：</p>
<ul>
<li>自动时间分区</li>
<li>灵活的数据保留策略</li>
<li>高压缩比的历史数据存储</li>
<li>冷热数据分级管理</li>
</ul>
<p>在实际测试中，针对工业传感器类数据，金仓可实现 <strong>1:4 左右的压缩比</strong>，在数据规模持续增长的情况下，这种优势会被不断放大。</p>
<hr/>
<h3 data-id="heading-11">六、从“时序”到“融合”：业务价值的真正释放</h3>
<p>企业真正关心的，并不是“时序数据本身”，而是它所承载的业务含义。</p>
<p>金仓支持在同一数据库内，对以下数据进行统一分析：</p>
<ul>
<li>时序数据</li>
<li>设备与业务主数据</li>
<li>JSON 文档型信息</li>
<li>空间地理数据</li>
</ul>
<p>这使得许多复杂分析场景得以简化，例如：</p>
<blockquote>
<p>“统计过去一周内，某区域内运行异常的设备数量及分布情况”</p>
</blockquote>
<p>在 InfluxDB 中，这通常需要多系统协作完成；而在金仓中，一条 SQL 即可完成。</p>
<hr/>
<h3 data-id="heading-12">七、结语：时序数据库竞争的真正分水岭</h3>
<p>InfluxDB 在时序数据库发展早期，起到了重要推动作用。但随着业务复杂度和数据规模的持续提升，企业对数据库的期待已经发生根本变化。</p>
<p>金仓数据库所展现的优势，并不仅是“跑得更快”，而是：</p>
<ul>
<li>在复杂查询下依然可控、稳定</li>
<li>在企业生态中易于融合</li>
<li>在长期运营中成本可预期</li>
</ul>
<p>当时序数据从“记录状态”走向“驱动决策”，数据库的角色也必须随之进化。</p>
<p>而这，正是金仓在复杂时序场景中逐步领先的根本原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国产时序数据库崛起：金仓凭什么在复杂场景中碾压InfluxDB]]></title>    <link>https://juejin.cn/post/7584073390694973455</link>    <guid>https://juejin.cn/post/7584073390694973455</guid>    <pubDate>2025-12-16T14:33:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584073390694973455" data-draft-id="7584243498528505856" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国产时序数据库崛起：金仓凭什么在复杂场景中碾压InfluxDB"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T14:33:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国产时序数据库崛起：金仓凭什么在复杂场景中碾压InfluxDB
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T14:33:12.000Z" title="Tue Dec 16 2025 14:33:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在物联网、工业互联网与智能运维高速发展的当下，时序数据的处理需求正呈指数级增长。从设备监控到智能决策，企业对数据库的要求早已不再局限于“能写能查”，而是追求高吞吐、低延迟、强一致性以及多维度分析能力。过去，InfluxDB凭借先发优势和简洁架构，成为时序数据库的代表。然而，随着数据量级从“万”跃升至“千万”，其性能瓶颈日益凸显。</p>
<p>一场国产数据库与国际开源方案之间的较量悄然展开。金仓数据库（KingbaseES）以全面领先的性能表现，正在重新定义时序数据库的能力边界。</p>
<hr/>
<h2 data-id="heading-0"><strong>性能全面领先：从写入到分析，金仓全面胜出</strong></h2>
<p>基于业界公认的TSBS（Time Series Benchmark Suite）基准测试，金仓与InfluxDB在多轮对比中展开正面交锋。结果显示：在小规模、简单查询场景下，两者表现接近；但在大规模、复杂分析的真实业务环境中，金仓展现出压倒性优势。</p>
<h3 data-id="heading-1"><strong>写入性能：高并发下稳定领先</strong></h3>
<p>模拟从100台到1000万台设备的数据写入压力，金仓在设备规模达到4000台（每台10个指标）时，写入性能已达InfluxDB的162%。在千万级设备极限测试中，这一优势进一步扩大<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d6d605a72ef42b293962b0fe5f5b935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766500392&amp;x-signature=VE24Ow2%2FbGW10%2FjtnJhTzPoe%2BgY%3D" alt="在这里插入图片描述" loading="lazy"/>
至267%。这意味着，面对高并发、持续写入的海量时序数据，金仓具备更强的扩展能力与稳定性。</p>
<h3 data-id="heading-2"><strong>查询性能：复杂分析场景下碾压式领先</strong></h3>
<p>在查询性能方面，金仓的优势尤为明显，尤其在多维度聚合、跨设备分析等高复杂度查询中：</p>
<ul>
<li><strong>简单聚合查询（如单设备短时间窗口聚合）</strong>：两者响应时间接近，毫秒级完成。</li>
<li><strong>中等复杂度查询（如多指标聚合、跨设备分组）</strong>：金仓响应速度为InfluxDB的3~4倍。</li>
<li><strong>高复杂度关联分析（如Last Point查询、高负载设备筛选）</strong>：金仓性能领先可达数十倍。例如，在“查询某时段内每台设备的最后读数”场景中，金仓耗时仅147毫秒，而InfluxDB超过10秒，性能差距超过70倍。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f8c8cef3efe40108458094b4bbd2014~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766500392&amp;x-signature=WjrsrT6OkNB6GYXOqT4HuLGfO%2Bc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>不止于快：金仓的企业级能力与融合优势</strong></h2>
<p>金仓的优势不仅体现在“跑得快”，更在于其面向企业级应用的深度设计。相比InfluxDB，金仓在以下几个关键维度实现了质的飞跃。</p>
<h3 data-id="heading-4"><strong>1. 完整SQL生态，降低开发与迁移成本</strong></h3>
<p>金仓基于成熟的关系型数据库内核，原生支持标准SQL、存储过程、事务（ACID）与多表关联查询。企业无需学习新的查询语言，现有SQL工具和业务系统可直接对接，极大降低开发与运维成本。相比之下，InfluxDB需使用InfluxQL或Flux语言，集成成本高，且在金融、工控等对一致性要求高的场景中难以胜任。</p>
<h3 data-id="heading-5"><strong>2. 高效存储与生命周期管理</strong></h3>
<p>金仓内置时序组件，支持按时间自动分区、冷热数据分级存储与高压缩比存储。实测显示，其对工业传感器数据可实现高达1:4的压缩比，显著降低存储成本。同时，冷热数据分离机制也提升了查询效率与系统响应速度。</p>
<h3 data-id="heading-6"><strong>3. 多模融合，打破数据孤岛</strong></h3>
<p>金仓首创“时序+”多模融合架构，支持在同一数据库中对时序数据、空间地理信息（GIS）、JSON文档等多种数据类型进行联合查询。例如，在智慧交通场景中，用户可通过一条SQL实现“查询过去一周在机场周边频繁出现的车辆”，而这类时空联合查询在InfluxDB中几乎无法原生支持。</p>
<hr/>
<h2 data-id="heading-7"><strong>实战验证：从测试场走向核心生产系统</strong></h2>
<p>金仓的时序能力已在多个关键行业中落地，成功替代或优于原有方案，成为支撑核心业务的数据底座。</p>
<h3 data-id="heading-8"><strong>案例一：智慧港口</strong></h3>
<p>在某大型港口集团的智能调度系统中，系统需处理日均数十亿条GPS轨迹数据。金仓在写入吞吐量、查询响应速度与系统稳定性方面全面优于InfluxDB，最终成为其核心引擎，支撑集卡调度、区域统计等关键功能。</p>
<h3 data-id="heading-9"><strong>案例二：新能源风电</strong></h3>
<p>某新能源企业需管理上千台风机的运行状态数据。金仓不仅实现每秒数十万点数据的高效写入，还能与设备元数据无缝融合，支持“设备-状态-告警”一体化查询。测试显示，其复杂分析查询性能为InfluxDB的2~70倍，预计可节省超百万元存储成本。</p>
<hr/>
<h2 data-id="heading-10"><strong>结语：从“记录”到“洞察”，金仓定义下一代时序数据库</strong></h2>
<p>InfluxDB或许仍适用于轻量级监控场景，但当企业迈向实时分析、智能决策、系统融合的新阶段，金仓提供了更强大、更成熟、更可控的选择。</p>
<p>它不仅是一个更快的时序数据库，更是一个融合时序、关系、空间等多模数据能力的统一平台。选择金仓，不只是选择一款数据库，更是选择一种面向未来的数据基础设施。</p>
<p>在数据驱动的新时代，金仓正以“洞察未来”的能力，引领国产数据库走向更广阔的舞台。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这 10 个 MySQL 高级用法，让你的代码又快又好看]]></title>    <link>https://juejin.cn/post/7584266184882552866</link>    <guid>https://juejin.cn/post/7584266184882552866</guid>    <pubDate>2025-12-16T14:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584266184882552866" data-draft-id="7576487832089788431" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这 10 个 MySQL 高级用法，让你的代码又快又好看"/> <meta itemprop="keywords" content="后端,MySQL"/> <meta itemprop="datePublished" content="2025-12-16T14:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这 10 个 MySQL 高级用法，让你的代码又快又好看
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T14:50:50.000Z" title="Tue Dec 16 2025 14:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华！</p>
<p>MySQL 有很多高级但实用的功能，能让你的查询变得更简洁、更高效。</p>
<p>今天分享 10 个我在工作中经常使用的 SQL 技巧，不用死记硬背，掌握了就能立刻提升你的数据库操作水平！</p>
<h3 data-id="heading-0">1. CTE（<code>WITH</code> 子句）——让复杂查询变清晰</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 传统子查询，难以阅读</span>
<span class="hljs-keyword">SELECT</span> nickname 
<span class="hljs-keyword">FROM</span> system_users 
<span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> system_dept <span class="hljs-keyword">WHERE</span> `name` <span class="hljs-operator">=</span> <span class="hljs-string">'IT部'</span>
);

<span class="hljs-comment">-- 使用CTE，逻辑清晰</span>
<span class="hljs-keyword">WITH</span> ny_depts <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> system_dept <span class="hljs-keyword">WHERE</span> `name` <span class="hljs-operator">=</span> <span class="hljs-string">'IT部'</span>
)
<span class="hljs-keyword">SELECT</span> u.nickname
<span class="hljs-keyword">FROM</span> system_users u
<span class="hljs-keyword">JOIN</span> ny_depts nd <span class="hljs-keyword">ON</span> u.dept_id <span class="hljs-operator">=</span> nd.id;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>WITH ny_depts AS (...)</code>：先创建一个临时结果集，叫 <code>ny_depts</code>，里面只包含“IT部”的部门名称。</li>
<li><code>SELECT u.nickname FROM system_users u JOIN ny_depts...</code>：再从用户表中找出那些部门ID在<code>ny_depts</code>里的员工昵称。</li>
</ul>
<p><strong>好处</strong>：把找部门和找人分成两步，逻辑更清楚，比嵌套子查询好读多了。</p>
<hr/>
<h3 data-id="heading-1">2. 窗口函数 —— 不分组也能统计</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    name,
    department,
    salary,
    <span class="hljs-built_in">RANK</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">AS</span> rank_in_dept,
    <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> department) <span class="hljs-keyword">AS</span> avg_salary
<span class="hljs-keyword">FROM</span> employees;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>PARTITION BY department</code>：按部门“分组”，但<strong>不合并行</strong>，每行仍然保留。</li>
<li><code>RANK() OVER (...)</code>：在每个部门内部，按薪水从高到低排名（相同薪水并列）。</li>
<li><code>AVG(salary) OVER (...)</code>：计算每个部门的平均工资，并显示在每一行里。</li>
</ul>
<p><strong>对比 GROUP BY</strong>：<code>GROUP BY</code> 会把多行合并成一行，而窗口函数保留原始行，同时加上统计值。</p>
<hr/>
<h3 data-id="heading-2">3. 条件聚合 —— 一行查出多个统计</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    <span class="hljs-keyword">YEAR</span>(created_at) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">year</span>,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> total,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> completed,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span> <span class="hljs-keyword">THEN</span> amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> revenue
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">YEAR</span>(created_at);
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>YEAR(created_at)</code>：提取订单年份。</li>
<li><code>COUNT(*)</code>：该年总订单数。</li>
<li><code>COUNT(CASE WHEN status = 'completed' THEN 1 END)</code>：
如果状态是 <code>'completed'</code>，就返回 <code>1</code>，否则返回 <code>NULL</code>；</li>
<li><code>COUNT()</code> 只统计非 <code>NULL</code> 值，所以这行就是“完成的订单数”。</li>
<li><code>SUM(CASE WHEN ... THEN amount ELSE 0 END)</code>：只对完成的订单求金额总和。</li>
</ul>
<p><strong>关键</strong>：不用写多个子查询，一条语句搞定全年报表！</p>
<hr/>
<h3 data-id="heading-3">4. 自连接 —— 同一张表自己连自己</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> e1.name, e2.name
<span class="hljs-keyword">FROM</span> employees e1
<span class="hljs-keyword">JOIN</span> employees e2 
  <span class="hljs-keyword">ON</span> e1.department <span class="hljs-operator">=</span> e2.department
  <span class="hljs-keyword">AND</span> e1.id <span class="hljs-operator">&lt;</span> e2.id  
  <span class="hljs-keyword">AND</span> <span class="hljs-built_in">ABS</span>(e1.salary <span class="hljs-operator">-</span> e2.salary) <span class="hljs-operator">&lt;=</span> e1.salary <span class="hljs-operator">*</span> <span class="hljs-number">0.1</span>;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>employees e1 JOIN employees e2</code>：把员工表当成两个副本（e1 和 e2）来连接。</li>
<li><code>e1.department = e2.department</code>：只找同一个部门的人。</li>
<li><code>e1.id &lt; e2.id</code>：避免重复配对（比如 Alice-Bob 和 Bob-Alice 只保留一个）。</li>
<li><code>ABS(...)</code>：计算两人薪水差是否 ≤ 10%。</li>
</ul>
<p><strong>用途</strong>：找“相似记录”“配对关系”“上下级”等场景非常有用。</p>
<hr/>
<h3 data-id="heading-4">5. <code>EXISTS</code> 替代 <code>IN</code> —— 更高效的存在判断</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> orders o 
    <span class="hljs-keyword">WHERE</span> o.customer_id <span class="hljs-operator">=</span> c.id <span class="hljs-keyword">AND</span> o.amount <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000</span>
);
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li>对每一位客户 <code>c</code>，检查是否存在一笔订单满足：
<ul>
<li>订单的 <code>customer_id</code> 等于这个客户的 <code>id</code></li>
<li>订单金额 &gt; 1000</li>
</ul>
</li>
<li><code>SELECT 1</code>：这里不需要返回具体字段，只要知道“有没有”就行，所以用 <code>1</code> 最轻量。</li>
<li><strong>为什么快？</strong>：一旦找到一条匹配订单，就立刻停止搜索，不像 <code>IN</code> 可能要加载全部订单 ID。</li>
</ul>
<p>注意：如果子查询可能返回 <code>NULL</code>，<code>IN</code> 会失效（因为 <code>x IN (..., NULL)</code> 永远为 <code>UNKNOWN</code>），而 <code>EXISTS</code> 不受影响。</p>
<hr/>
<h3 data-id="heading-5">6. JSON 函数 —— 轻松读取 JSON 字段</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    name,
    profile<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.address.city'</span> <span class="hljs-keyword">AS</span> city,
    JSON_EXTRACT(profile, <span class="hljs-string">'$.age'</span>) <span class="hljs-keyword">AS</span> age
<span class="hljs-keyword">FROM</span> users
<span class="hljs-keyword">WHERE</span> profile<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'$.city'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'Beijing'</span>;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>profile</code> 是一个 JSON 类型字段，比如：<code>{"address": {"city": "Beijing"}, "age": 30}</code></li>
<li><code>profile-&gt;&gt;'$.address.city'</code>：
<ul>
<li><code>-&gt;&gt;</code> 是简写，等价于 <code>JSON_UNQUOTE(JSON_EXTRACT(...))</code></li>
<li>返回字符串 <code>"Beijing"</code>（去掉引号）</li>
</ul>
</li>
<li><code>JSON_EXTRACT(profile, '$.age')</code>：返回 <code>30</code>（带类型，可能是数字）</li>
<li><code>WHERE profile-&gt;&gt;'$.city' = 'Beijing'</code>：筛选城市是北京的用户。</li>
</ul>
<p><strong>适用场景</strong>：用户偏好、动态表单、日志等结构不固定的字段。</p>
<hr/>
<h3 data-id="heading-6">7. 生成列 —— 数据库自动帮你算</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    width <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    height <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    area <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> (width <span class="hljs-operator">*</span> height) STORED
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (id, width, height) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>);
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>area DECIMAL(...) AS (width * height) STORED</code>：
<ul>
<li>这是一个“存储型生成列”，数据库会自动计算 <code>width * height</code> 并存下来。</li>
<li>如果不加 <code>STORED</code>，就是“虚拟列”（每次查询时计算，不占存储）。</li>
</ul>
</li>
<li>插入时只需给 <code>width</code> 和 <code>height</code>，<code>area</code> 自动变成 <code>50</code>。</li>
</ul>
<p><strong>优势</strong>：避免应用层重复计算，还能给 <code>area</code> 加索引加速查询！</p>
<hr/>
<h3 data-id="heading-7">8. 多表更新 —— 一条语句更新关联数据</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">UPDATE</span> customers c
<span class="hljs-keyword">JOIN</span> (
    <span class="hljs-keyword">SELECT</span> customer_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> customer_id
) o <span class="hljs-keyword">ON</span> c.id <span class="hljs-operator">=</span> o.customer_id
<span class="hljs-keyword">SET</span> c.total_spent <span class="hljs-operator">=</span> o.total;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li>子查询 <code>o</code>：先按客户 ID 统计每个人的总消费。</li>
<li><code>UPDATE customers c JOIN o ...</code>：把客户表和统计结果连接起来。</li>
<li><code>SET c.total_spent = o.total</code>：直接把统计值写回客户表。</li>
</ul>
<p><strong>好处</strong>：不用在程序里循环“查一个、改一个”，减少网络开销，保证原子性。</p>
<hr/>
<h3 data-id="heading-8">9. <code>GROUP_CONCAT</code> —— 多行变一行</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> 
    department,
    GROUP_CONCAT(name <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> salary <span class="hljs-keyword">DESC</span> SEPARATOR <span class="hljs-string">', '</span>) <span class="hljs-keyword">AS</span> members
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> department;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>GROUP BY department</code>：按部门分组。</li>
<li><code>GROUP_CONCAT(name ...)</code>：把每个部门的所有员工名字拼成一个字符串。</li>
<li><code>ORDER BY salary DESC</code>：按薪水从高到低排序后再拼接。</li>
<li><code>SEPARATOR ', '</code>：用逗号加空格分隔名字。</li>
</ul>
<p><strong>典型用途</strong>：导出名单、展示标签、汇总明细等。</p>
<p>默认最多拼 1024 字符，可通过 <code>SET SESSION group_concat_max_len = 1000000;</code> 调大。</p>
<hr/>
<h3 data-id="heading-9">10. <code>INSERT ... ON DUPLICATE KEY UPDATE</code> —— 智能插入/更新</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> page_views (page_url, view_date, view_count)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'/home'</span>, CURDATE(), <span class="hljs-number">1</span>)
<span class="hljs-keyword">ON</span> DUPLICATE KEY <span class="hljs-keyword">UPDATE</span> 
    view_count <span class="hljs-operator">=</span> view_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li>尝试插入一条新记录：页面 <code>/home</code>，今天日期，访问次数为 1。</li>
<li>如果因为<strong>唯一索引冲突</strong>（比如 <code>(page_url, view_date)</code> 是唯一键）导致插入失败：
<ul>
<li>就执行 <code>ON DUPLICATE KEY UPDATE</code> 部分</li>
<li>把原有的 <code>view_count</code> 加 1</li>
</ul>
</li>
<li><strong>效果</strong>：第一次访问创建记录，之后每次访问自动 +1，完美实现计数器！</li>
</ul>
<p><strong>前提</strong>：表必须有主键或唯一索引，否则不会触发更新。</p>
<hr/>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-10">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FbgLoyqb3VLgn3xXAok3kcQ" target="_blank" title="https://mp.weixin.qq.com/s/bgLoyqb3VLgn3xXAok3kcQ" ref="nofollow noopener noreferrer">《如何查看 SpringBoot 当前线程数？3 种方法亲测有效》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FDpjuafW3agyhLEQYif3zJA" target="_blank" title="https://mp.weixin.qq.com/s/DpjuafW3agyhLEQYif3zJA" ref="nofollow noopener noreferrer">《别再乱 new ArrayList！8 大 Java 容器选型案例，一篇看懂》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端如何实现RAG？一文带你速通，使用RAG实现长期记忆]]></title>    <link>https://juejin.cn/post/7584297353419522048</link>    <guid>https://juejin.cn/post/7584297353419522048</guid>    <pubDate>2025-12-16T13:40:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584297353419522048" data-draft-id="7584073390694793231" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端如何实现RAG？一文带你速通，使用RAG实现长期记忆"/> <meta itemprop="keywords" content="前端,AI编程,Node.js"/> <meta itemprop="datePublished" content="2025-12-16T13:40:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天扭码"/> <meta itemprop="url" content="https://juejin.cn/user/3349589831715801"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端如何实现RAG？一文带你速通，使用RAG实现长期记忆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3349589831715801/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天扭码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T13:40:50.000Z" title="Tue Dec 16 2025 13:40:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发者，我们经常遇到一个痛点：<strong>AI 助手无法记住跨会话的历史记录</strong>。本文将从前端的视角出发，深度解析 RAG（检索增强生成）的工作原理，并结合实际项目代码，详细剖析如何使用 <strong>LlamaIndex.js + DeepSeek + Qdrant</strong> 实现 AI 助手的永久记忆。</p>
<h2 data-id="heading-0">一、为什么我们需要 RAG？</h2>
<p>当我调用 DeepSeek API 搭建 AI 对话平台时，很快发现一个致命缺陷：如果用户关闭网页再次进入，AI 会立刻“失忆”。解决这个问题，传统上有几种方案，但都有明显弊端：</p>






























<table><thead><tr><th><strong>方案</strong></th><th><strong>描述</strong></th><th><strong>弊端分析</strong></th></tr></thead><tbody><tr><td><strong>1. 完整上下文传递</strong></td><td>在系统提示词中加入全部历史对话。</td><td><strong>高昂成本与限制</strong>：大量上下文极易超出 LLM 的 Token 上限，导致巨额消耗，且长文本会稀释 AI 的注意力。</td></tr><tr><td><strong>2. 对话摘要记录</strong></td><td>每次对话后，生成一个摘要并不断修改。</td><td><strong>信息丢失与准确性</strong>：摘要有最大长度限制，且 AI 自动生成的摘要难以保证准确性，少量文字无法存储海量信息。</td></tr><tr><td><strong>3. 模型微调（Fine-tuning）</strong></td><td>使用对话记录对模型进行微调。</td><td><strong>高门槛与高成本</strong>：对前端开发者而言，实现难度、资金投入和时间成本过高。</td></tr><tr><td><strong>4. RAG 检索</strong></td><td>每次对话时，检索与当前问题最相关的历史记录作为上下文。</td><td><strong>优异的长期记忆方案</strong>：通过向量化实现语义匹配，精准高效地注入相关记忆。</td></tr></tbody></table>
<p><strong>结论：</strong> RAG 是目前最经济高效、可控性最高的长期记忆实现方案。</p>
<hr/>
<h2 data-id="heading-1">二、什么是 RAG（检索增强生成）？</h2>
<p>RAG 的全称是 <strong>Retrieval-Augmented Generation</strong>。它不是一个新的模型，而是一种<strong>架构</strong>或<strong>框架</strong>，用于提升大型语言模型（LLM）回答的<strong>准确性、时效性</strong>和<strong>知识深度</strong>。</p>
<p>RAG 专门解决 LLM 的两大核心限制：<strong>知识时效性</strong>（模型知识截止于训练数据）和<strong>上下文窗口限制</strong>（短期记忆）。</p>
<h3 data-id="heading-2">核心工作原理</h3>
<p>RAG 的核心思想是：<strong>在 LLM 生成回复之前，先去外部的、特定的知识库中找到相关的“参考资料”，然后将这些资料作为证据提供给 LLM。</strong></p>
<p>RAG 流程分为两大阶段：</p>
<h4 data-id="heading-3">1. 索引阶段 (Indexing) — 知识的存储与向量化</h4>
<p>这个阶段是<strong>预先完成</strong>的，目标是将您的私有数据（例如本项目中的历史对话记录）转换为 LLM 可以快速查找的格式。</p>
<ul>
<li><strong>分块 (Chunking)</strong> ：将长的对话记录或文档切分成较小的、语义完整的片段。</li>
<li><strong>嵌入 (Embedding)</strong> ：使用嵌入模型（如 DeepSeek Embeddings）将每个文本块转换成<strong>数值向量</strong>。</li>
<li><strong>存储 (Storage)</strong> ：将这些向量及其对应的原始文本存储在<strong>向量数据库</strong>（如 Qdrant）中。</li>
</ul>
<h4 data-id="heading-4">2. 运行时阶段 (Runtime) — 记忆的检索与生成</h4>
<p>这个阶段在<strong>每次用户提问时实时发生</strong>：</p>
<ul>
<li><strong>问题嵌入</strong>：将用户当前的问题转换为查询向量。</li>
<li><strong>检索</strong>：系统在向量数据库中进行<strong>相似性搜索</strong>，快速找到与查询向量最相似的 <strong>Top K</strong> 个历史对话记录。</li>
<li><strong>提示词增强 (Augmentation)</strong> ：将用户原始问题与检索到的相关记录一起打包，形成一个 <strong>“增强的提示词”（Augmented Prompt）</strong> 。</li>
<li><strong>生成 (Generation)</strong> ：将增强提示词发送给 DeepSeek Chat API，模型根据上下文生成最终答案。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、如何实现 RAG？（项目实战流程）</h2>
<p>项目github连接——<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FObjecteee%2FaiKnowedge%2Ftree%2Fmain%2Frag%2FLlamaIndex" target="_blank" title="https://github.com/Objecteee/aiKnowedge/tree/main/rag/LlamaIndex" ref="nofollow noopener noreferrer">github.com/Objecteee/a…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f7c3e07337443bd9ea5d87c9052314d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5omt56CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766497249&amp;x-signature=DvW9DBbxqDyOkpHY8oQMkhhamNE%3D" alt="GIF 2025-12-16 21-18-35.gif" loading="lazy"/></p>
<p>我们可以看到发送给ai的提示词已经通过RAG检索到了相似的对话记录,我整理了一下格式如下——</p>
<pre><code class="hljs language-swift" lang="swift">
{

  <span class="hljs-string">"dataType"</span>: <span class="hljs-string">"ChatHistoryContext"</span>,

  <span class="hljs-string">"sourceJsonType"</span>: <span class="hljs-string">"debug"</span>,

  <span class="hljs-string">"systemInstruction"</span>: <span class="hljs-string">"你是一个智能助手。请基于以下提供的背景信息（Context）来回答用户的问题。这些背景信息可能包含相关的知识文档或过去的历史对话记录。如果背景信息与问题无关，请忽略它。"</span>,

  <span class="hljs-string">"contextType"</span>: <span class="hljs-string">"历史对话记录 (Historical Conversation Records)"</span>,

  <span class="hljs-string">"parsedConversations"</span>: [

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"User"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"我们刚刚在玩什么游戏"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"Assistant"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"根据我们的对话记录，我们并没有在玩具体的游戏哦～ <span class="hljs-subst">\n</span>你之前连续发送了几次“你好”和“1”，我都在热情回应你的招呼呢！😊 <span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>如果你想玩点什么，我可以陪你玩猜谜、成语接龙、脑筋急转弯，或者你提议其他小游戏也可以～ 来试试吗？"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"User"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好，我们玩过互相说1的游戏么"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"Assistant"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"是的，我们之前玩过这个游戏！😊 <span class="hljs-subst">\n</span>你让我在你输入“1”时只回复“1”，不加其他内容。 <span class="hljs-subst">\n</span>需要再玩一次吗？"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">3</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"User"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好啊"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">3</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"Assistant"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好啊！😊 今天看起来特别有活力呢～ <span class="hljs-subst">\n</span>有什么想聊的，或者需要我帮忙的吗？"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">4</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"User"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">4</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"Assistant"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好！😊 很高兴见到你！有什么我可以帮助你的吗？"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">5</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"User"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>

    },

    {

      <span class="hljs-string">"id"</span>: <span class="hljs-number">5</span>,

      <span class="hljs-string">"role"</span>: <span class="hljs-string">"Assistant"</span>,

      <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好！😊 很高兴见到你！有什么我可以帮助你的吗？"</span>

    }

  ],

  <span class="hljs-string">"summary"</span>: <span class="hljs-string">"这段数据是 RAG 系统用于增强 LLM 上下文的调试信息。它包含了 AI 的系统指令和五组结构化的用户/助手历史对话记录。"</span>

}

</code></pre>
<p>要构建 RAG 系统，无论技术栈如何，都必须遵循以下三个核心阶段。我们将结合项目源码（<code>rag/LlamaIndex</code>）来具体分析实现细节。</p>
<h3 data-id="heading-6">项目概览：这套 RAG 在做什么</h3>
<p>这套系统的目标不是“把最近 N 条对话塞给模型”，而是：</p>
<ul>
<li><strong>长期记忆</strong>：把每一轮对话（User+Assistant）写入向量库，之后通过<strong>语义检索</strong>召回相关片段作为上下文。</li>
<li><strong>短期记忆</strong>：从 SQLite 取最近 <strong>5 条</strong>（用于“继续”“上面那个”这类指代保持连贯）。</li>
<li><strong>生成</strong>：将“系统指令 + RAG 召回上下文”组成 <code>systemPrompt</code>，再加上短期历史与当前问题，调用 DeepSeek Chat 生成回答。</li>
</ul>
<p>关键入口在：</p>
<ul>
<li>后端 RAG 服务：<code>rag/LlamaIndex/backend/services/ragService.js</code></li>
<li>后端对话接口：<code>rag/LlamaIndex/backend/server.js</code></li>
<li>前端调试输出：<code>rag/LlamaIndex/frontend/src/App.jsx</code></li>
</ul>
<hr/>
<h3 data-id="heading-7">RAG 实现剖析：第一阶段（知识库构建）</h3>
<h4 data-id="heading-8">1. 数据摄取（Loaders）</h4>
<p>目前的知识库来源是 <code>backend/data/</code> 目录下的文件，启动时加载：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">const</span> documents = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> SimpleDirectoryReader().loadData({
  directoryPath: path.<span class="hljs-keyword">join</span>(__dirname, <span class="hljs-string">"../data"</span>),
});
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:56-59</code></p>
<p>这意味着：只要往 <code>backend/data/</code> 放入新文档（如 <code>.md</code>），重建索引或首次初始化时就会被纳入向量库。</p>
<hr/>
<h4 data-id="heading-9">2. 切片逻辑（Chunking）——当前实现与重要说明</h4>
<h5 data-id="heading-10">当前实现是什么？</h5>
<p>当前<strong>没有显式写切片器</strong>（Splitter），而是依赖 LlamaIndex 在 <code>VectorStoreIndex.fromDocuments(...)</code> 内部的默认切片策略（通常是句子/段落优先的 splitter + 默认 chunkSize/overlap）。</p>
<p>真实触发点：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">index</span> = await VectorStoreIndex.fromDocuments(documents, {
  storageContext,
})<span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:105-108</code></p>
<h5 data-id="heading-11">这意味着什么？</h5>
<ul>
<li>
<p><strong>切片确实发生了</strong>，但参数目前由 LlamaIndex 默认值决定。</p>
</li>
<li>
<p>现在系统的“切片质量”主要取决于：</p>
<ul>
<li>文档本身的结构（是否有清晰标题/段落）</li>
<li>LlamaIndex 默认 splitter 策略</li>
</ul>
</li>
</ul>
<h5 data-id="heading-12">切片优化方案（建议按阶段演进）</h5>
<ul>
<li><strong>结构化切片</strong>（推荐优先级最高）：按标题（如 Markdown 的 <code>#</code>/<code>##</code>）、段落分隔符、代码块边界切，减少“跨主题混片”。</li>
<li><strong>Overlap 增大</strong>：如果经常出现“关键句刚好切断”，增加 overlap 可以减少信息断裂。</li>
<li><strong>语义切片</strong>：对长文档先做主题边界识别，再切 chunk，减少噪声召回。</li>
<li><strong>专门为对话记忆设计切片</strong>：现在是一轮对话写成一个 Document（见长期记忆部分），这类数据天然短而密，通常不需要再细切；但如果一轮回答很长，可考虑把一轮对话拆为多段并共享 metadata（如同一 <code>conversationId</code>）。</li>
</ul>
<hr/>
<h4 data-id="heading-13">3. 向量化（Embedding）与存储（Vector Store）</h4>
<h5 data-id="heading-14">向量化模型（Embedding Model）</h5>
<p>这里<strong>不是 DeepSeek Embedding API</strong>，而是本地 HuggingFace Embedding：</p>
<pre><code class="hljs language-arduino" lang="arduino">Settings.embedModel = <span class="hljs-keyword">new</span> <span class="hljs-built_in">HuggingFaceEmbedding</span>({
  modelType: <span class="hljs-string">"Xenova/all-MiniLM-L6-v2"</span>,
  quantized: <span class="hljs-literal">false</span>
});
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:40-43</code></p>
<p>同时为网络环境设置了镜像（用于模型下载）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">env.remoteHost</span> = <span class="hljs-string">"https://hf-mirror.com"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">env.remoteTemplate</span> = <span class="hljs-string">"{model}/resolve/{revision}/{file}"</span><span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:7-8</code></p>
<h5 data-id="heading-15">存储模式：Local / Qdrant</h5>
<p>通过环境变量切换：</p>
<ul>
<li><code>VECTOR_STORE_TYPE=local</code>：落在本地 JSON</li>
<li><code>VECTOR_STORE_TYPE=qdrant</code>：落在 Qdrant（失败会 fallback 到 local）</li>
</ul>
<p>逻辑位置：<code>rag/LlamaIndex/backend/services/ragService.js:63-81</code></p>
<p>Local 模式下的持久化目录是：</p>
<ul>
<li><code>rag/LlamaIndex/backend/storage/</code></li>
</ul>
<h5 data-id="heading-16">如何查看“向量化存储内容”</h5>
<p>在 Local 模式下，最直接可读的文件是：</p>
<ul>
<li><code>backend/storage/doc_store.json</code>：原始文本（切片/对话记忆）内容</li>
<li><code>backend/storage/index_store.json</code>：索引结构信息</li>
<li><code>backend/storage/vector_store_default.json</code>（或类似）：向量本体（大量数值，不太适合人读，但可以确认存在与规模）</li>
</ul>
<p>写入持久化发生在长期记忆写入时（见后文），位置：<code>rag/LlamaIndex/backend/services/ragService.js:159-190</code></p>
<hr/>
<h3 data-id="heading-17">RAG 实现剖析：第二阶段（运行时检索）</h3>
<p>当用户每次提问时，会执行一次向量召回。</p>
<h4 data-id="heading-18">1. 召回逻辑：TopK 相似检索</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">retriever</span> = index.asRetriever({ similarityTopK: <span class="hljs-number">5</span> })<span class="hljs-comment">;</span>
const <span class="hljs-attr">nodes</span> = await retriever.retrieve(queryText)<span class="hljs-comment">;</span>
return nodes.map(<span class="hljs-attr">node</span> =&gt; node.node.text).join(<span class="hljs-string">"\n\n"</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:135-141</code></p>
<p>这里的关键点：</p>
<ul>
<li><strong>TopK=5</strong>：每次最多取 5 条“最相近片段”</li>
<li>返回的是纯文本拼接，作为后续 System Prompt 的“背景信息”</li>
</ul>
<h4 data-id="heading-19">2. 召回的数据来源：知识库 + 历史对话</h4>
<p>因为把“历史对话”也写进了同一个向量索引（见长期记忆写入），所以检索结果可能混合：</p>
<ul>
<li><code>backend/data/</code> 里的知识文档切片</li>
<li>用户历史对话（<code>User:...\nAssistant:...</code>）</li>
</ul>
<p>这也是为什么你在浏览器 Console 看到的 <code>systemPrompt</code> 背景信息里会出现很多轮对话文本。</p>
<hr/>
<h3 data-id="heading-20">RAG 实现剖析：第三阶段（生成回复）</h3>
<h4 data-id="heading-21">1. 增强提示词（System Prompt）的构造规则</h4>
<p>非流式接口 <code>/api/chat</code> 的 System Prompt 组装：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">systemPrompt</span> = <span class="hljs-string">"你是一个智能助手。"</span><span class="hljs-comment">;</span>
if (context) {
  systemPrompt += `请基于以下提供的背景信息（Context）来回答用户的问题。这些背景信息可能包含相关的知识文档或过去的历史对话记录。如果背景信息与问题无关，请忽略它。\n背景信息：\n${context}`<span class="hljs-comment">;</span>
}
const <span class="hljs-attr">systemMessage</span> = { role: <span class="hljs-string">'system'</span>, content: systemPrompt }<span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/server.js:100-112</code></p>
<p><strong>组成结论（非常关键）</strong> ：</p>
<ul>
<li><code>systemPrompt</code> = “基础系统指令” + “RAG 检索出来的 context（可为空）”</li>
<li><code>systemPrompt</code> <strong>不包含</strong> SQLite 的最近 5 条对话，它们是作为单独 message 插入的（下一段）</li>
</ul>
<h4 data-id="heading-22">2. 最终发送给模型的消息列表组成</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">dbHistory</span> = chatHistoryService.getHistory(sessionId, <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">finalMessages</span> = [
  systemMessage,
  ...dbHistory,
  { role: <span class="hljs-string">'user'</span>, content: lastMsg.content }
]<span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/server.js:90-118</code></p>
<p>所以项目中“喂给模型的上下文”来自两条管线：</p>
<ul>
<li><strong>长期记忆（RAG）</strong> ：进 <code>systemPrompt</code></li>
<li><strong>短期记忆（SQLite 最近 5 条）</strong> ：以 <code>messages</code> 数组形式送入模型（更接近“对话上下文”）</li>
</ul>
<h4 data-id="heading-23">3. 将系统提示词暴露给浏览器 Console</h4>
<h5 data-id="heading-24">非流式：直接回传给前端</h5>
<pre><code class="hljs language-php" lang="php">res.<span class="hljs-title function_ invoke__">json</span>({
  <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>,
  <span class="hljs-attr">content</span>: responseContent,
  <span class="hljs-attr">systemPrompt</span>: systemPrompt
});
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/server.js:136-142</code></p>
<p>前端打印：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">group</span>(<span class="hljs-string">"🔍 [DeepSeek Chat] RAG Debug Info"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"User Prompt:"</span>, ...);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"System Prompt (with RAG Context):"</span>, response.<span class="hljs-property">data</span>.<span class="hljs-property">systemPrompt</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">groupEnd</span>();
</code></pre>
<p>位置：<code>rag/LlamaIndex/frontend/src/App.jsx:60-85</code></p>
<h5 data-id="heading-25">流式：在 SSE 开头先发一条 debug 包</h5>
<pre><code class="hljs language-typescript" lang="typescript">res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-keyword">type</span>: <span class="hljs-string">'debug'</span>, systemPrompt })}</span>\n\n`</span>);
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/server.js:198-213</code></p>
<p>前端解析：</p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">parsed.type</span> === <span class="hljs-string">'debug'</span> &amp;&amp; parsed.systemPrompt) {
  console.group("🔍 <span class="hljs-section">[DeepSeek Chat Stream]</span> RAG Debug Info")<span class="hljs-comment">;</span>
  console.log("User Prompt:", ...)<span class="hljs-comment">;</span>
  console.log("System Prompt (with RAG Context):", parsed.systemPrompt)<span class="hljs-comment">;</span>
  console.groupEnd()<span class="hljs-comment">;</span>
  continue<span class="hljs-comment">;</span>
}
</code></pre>
<p>位置：<code>rag/LlamaIndex/frontend/src/App.jsx:127-137</code></p>
<p>这实现了要的：在浏览器控制台完整观察“系统提示词 + 用户提示词”。</p>
<hr/>
<h3 data-id="heading-26">长期记忆（Long-term Memory）在您项目里是怎么实现的？</h3>
<h4 data-id="heading-27">1. 写入规则：每轮对话结束就写入向量库</h4>
<p>当 <code>/api/chat</code> 拿到模型回答后，会调用：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> ragService.insertChatLog(lastMsg.content, responseContent);
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/server.js:133-135</code></p>
<h4 data-id="heading-28">2. 写入内容格式：User + Assistant 合并成一个 Document</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">text</span> = `User: <span class="hljs-variable">${userMsg}</span>\nAssistant: <span class="hljs-variable">${assistantMsg}</span>`<span class="hljs-comment">;</span>
const <span class="hljs-attr">doc</span> = new Document({ text, metadata: { type: <span class="hljs-string">'conversation'</span>, timestamp: ... }})<span class="hljs-comment">;</span>
await index.insert(doc)<span class="hljs-comment">;</span>
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:148-158</code></p>
<h4 data-id="heading-29">3. 持久化规则：Local 模式写到 storage/*.json</h4>
<p>插入后会持久化（Local）：</p>
<pre><code class="hljs language-scss" lang="scss">await storageContext<span class="hljs-selector-class">.docStore</span><span class="hljs-selector-class">.persist</span>(...doc_store.json)
await storageContext<span class="hljs-selector-class">.indexStore</span><span class="hljs-selector-class">.persist</span>(...index_store.json)
for (...) await store<span class="hljs-selector-class">.persist</span>(...vector_store_${key}.json)
</code></pre>
<p>位置：<code>rag/LlamaIndex/backend/services/ragService.js:159-190</code></p>
<hr/>
<h3 data-id="heading-30">与“标准三阶段 RAG”相比：项目有哪些关键差异？</h3>
<ul>
<li><strong>Embedding 不是 DeepSeek Embedding API</strong>：是本地 <code>HuggingFaceEmbedding</code>（更稳定、成本低，但模型选择需要自己评估准确率），见 <code>ragService.js:40-43</code>。</li>
<li><strong>Prompt 不仅有 RAG Context</strong>：额外注入了 SQLite 最近 5 条短期历史（作为 messages），见 <code>server.js:90-118</code>。</li>
<li><strong>长期记忆不是“拉历史记录 N 条”</strong> ：是把对话写入向量库，后续靠相似检索召回，见 <code>insertChatLog</code> 与 <code>retrieveContext</code>。</li>
<li><strong>可观测性加强</strong>：系统提示词会同时在后端终端打印（<code>server.js:105-109</code>/<code>183-187</code>）并在浏览器 Console 打印（<code>App.jsx:70-77</code>/<code>129-137</code>）。</li>
</ul>
<h2 data-id="heading-31">总结</h2>
<p>OK，就写到这儿了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（13）Netty中的事件和回调机制]]></title>    <link>https://juejin.cn/post/7584071941025693711</link>    <guid>https://juejin.cn/post/7584071941025693711</guid>    <pubDate>2025-12-16T12:19:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584071941025693711" data-draft-id="7584286241488093224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（13）Netty中的事件和回调机制"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T12:19:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（13）Netty中的事件和回调机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T12:19:46.000Z" title="Tue Dec 16 2025 12:19:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Netty中，事件和回调机制是实现异步和事件驱动编程的重要组成部分。Netty使用ChannelPipeline和ChannelHandler来处理事件和回调。</p>
<ol>
<li>事件：
Netty中的事件包括连接建立、数据接收、数据发送、连接关闭等。在处理这些事件时，通常需要实现ChannelHandler接口，并重写相应的方法来处理事件。下面是一个简单的示例代码：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 连接建立事件</span>
        System.out.println(<span class="hljs-string">"Connection established"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 数据接收事件</span>
        System.out.println(<span class="hljs-string">"Received data: "</span> + msg);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 数据接收完成事件</span>
        System.out.println(<span class="hljs-string">"Data reception complete"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 异常事件</span>
        System.out.println(<span class="hljs-string">"Exception caught: "</span> + cause.getMessage());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelInactive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 连接关闭事件</span>
        System.out.println(<span class="hljs-string">"Connection closed"</span>);
    }
}
</code></pre>
<p>在上面的示例中，我们创建了一个自定义的ChannelHandler类MyHandler，并重写了channelActive()、channelRead()、channelReadComplete()、exceptionCaught()和channelInactive()方法来处理连接建立、数据接收、数据接收完成、异常和连接关闭事件。</p>
<ol start="2">
<li>回调：
Netty中的回调机制通常用于异步操作的结果通知。当某个异步操作完成时，会调用相应的回调方法来处理操作的结果。下面是一个简单的示例代码：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFutureListener;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 异步操作</span>
        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> ctx.writeAndFlush(<span class="hljs-string">"Hello, Netty!"</span>);

        <span class="hljs-comment">// 注册回调</span>
        future.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelFutureListener</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception {
                <span class="hljs-keyword">if</span> (future.isSuccess()) {
                    System.out.println(<span class="hljs-string">"Data sent successfully"</span>);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"Failed to send data"</span>);
                }
            }
        });
    }
}
</code></pre>
<p>在上面的示例中，我们在channelActive()方法中执行了一个异步操作ctx.writeAndFlush()，并通过addListener()方法注册了一个回调监听器ChannelFutureListener。当异步操作完成时，会调用回调方法operationComplete()来处理操作的结果。</p>
<p>通过事件和回调机制，Netty能够高效地处理各种网络事件和异步操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（14）如何处理Netty中的异常和错误？]]></title>    <link>https://juejin.cn/post/7584266184882241570</link>    <guid>https://juejin.cn/post/7584266184882241570</guid>    <pubDate>2025-12-16T12:21:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584266184882241570" data-draft-id="7584243498528260096" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（14）如何处理Netty中的异常和错误？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T12:21:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（14）如何处理Netty中的异常和错误？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T12:21:05.000Z" title="Tue Dec 16 2025 12:21:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Netty中，可以通过实现ChannelHandler的exceptionCaught()方法来处理异常和错误。该方法会在发生异常时被调用，可以在其中进行异常处理和错误处理逻辑。下面是一个示例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 异常处理逻辑</span>
        System.out.println(<span class="hljs-string">"Exception caught: "</span> + cause.getMessage());

        <span class="hljs-comment">// 发生异常时，关闭连接</span>
        ctx.close();
    }
}
</code></pre>
<p>在上面的示例中，我们创建了一个自定义的ChannelHandler类MyHandler，并重写了exceptionCaught()方法来处理异常。在异常处理逻辑中，我们可以根据具体的业务需求进行相应的处理，比如打印异常信息、记录日志、发送错误响应等。</p>
<p>在异常处理逻辑中，我们也可以选择关闭连接来终止与客户端的通信。通过调用ctx.close()方法，可以主动关闭与客户端的连接，释放相关的资源。</p>
<p>另外，为了更好地捕获异常和错误，还可以使用ChannelFuture的addListener()方法来注册回调监听器，以便在异步操作失败时处理异常。下面是一个示例代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFutureListener;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 异步操作</span>
        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> ctx.writeAndFlush(<span class="hljs-string">"Hello, Netty!"</span>);

        <span class="hljs-comment">// 注册回调</span>
        future.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelFutureListener</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception {
                <span class="hljs-keyword">if</span> (future.isSuccess()) {
                    System.out.println(<span class="hljs-string">"Data sent successfully"</span>);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 异常处理逻辑</span>
                    System.out.println(<span class="hljs-string">"Failed to send data: "</span> + future.cause().getMessage());

                    <span class="hljs-comment">// 发生异常时，关闭连接</span>
                    future.channel().close();
                }
            }
        });
    }
}
</code></pre>
<p>在上面的示例中，我们在channelActive()方法中执行了一个异步操作ctx.writeAndFlush()，并通过addListener()方法注册了一个回调监听器ChannelFutureListener。当异步操作完成时，会调用回调方法operationComplete()来处理操作的结果。如果操作失败，我们可以在回调方法中处理异常，并关闭连接。</p>
<p>通过合理处理异常和错误，可以提高Netty应用程序的稳定性和可靠性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JUnit 5 中的 @ClassTemplate 实战指南]]></title>    <link>https://juejin.cn/post/7584295332340252735</link>    <guid>https://juejin.cn/post/7584295332340252735</guid>    <pubDate>2025-12-16T12:52:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584295332340252735" data-draft-id="7584289165754105910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JUnit 5 中的 @ClassTemplate 实战指南"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2025-12-16T12:52:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JUnit 5 中的 @ClassTemplate 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T12:52:01.000Z" title="Tue Dec 16 2025 12:52:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你在本地、测试环境和 CI 中跑同一组测试时，是否遇到过这样的困惑：同一段业务逻辑在不同配置、不同 Locale 下的表现不尽相同，但你又不想为每种场景复制一堆几乎一样的测试类？如果把所有分支逻辑都塞进一个测试方法里，又会让测试变得臃肿难以维护。有没有一种方式，可以让测试代码保持简洁，却能优雅地在多种“环境切面”下重复执行整套测试？这正是 JUnit 5 中 <code>@ClassTemplate</code> 想要解决的问题。本文就从这个现实场景出发，带你深入理解 Class Template 的执行机制、扩展点设计以及一个实用的多 Locale 示例。</p>
<h2 data-id="heading-0">1. 引言</h2>
<p>有些测试需要在不同的环境中运行。<code>@ClassTemplate</code> 注解可以帮我们做到这一点：它会让整个测试类在多种不同配置下被重复执行。</p>
<p>在这篇教程中，我们会先讨论为什么会有“类模板（Class Template）”这种机制，以及 JUnit 是如何执行它们的；接着会看看它在整体执行模型中的位置；最后，我们会拆解类模板的结构、背后的提供者（provider），并通过一个示例，在不复制任何测试代码的前提下，让同一个测试类在多个 Locale 环境下运行。</p>
<h2 data-id="heading-1">2. 什么是 <code>@ClassTemplate</code></h2>
<p>简单回顾一下，<code>@ClassTemplate</code> 会把一个测试类变成“模板类”，让它按照不同的调用上下文（invocation context）多次执行。提供者负责提供这些上下文，每一个上下文都会触发一次独立的执行，拥有各自的生命周期和扩展。</p>
<p>在实践中，这让我们可以<strong>在不同环境或配置下多次运行同一个测试类，同时保持测试代码本身的简单性</strong>。我们可以改变运行时的环境配置，而不用复制测试类，或者在单个测试方法里加入复杂的分支逻辑。</p>
<h3 data-id="heading-2">2.1. Class Template 如何执行</h3>
<p>一个类模板由两部分组成：<strong>模板类本身，以及为其提供调用上下文的提供者</strong>。模板类在外观上就像一个普通的 JUnit 测试类，但 <code>@ClassTemplate</code> 注解会告诉 JUnit 不要直接运行它，而是等待提供者来定义该类的具体执行方式。</p>
<p>一旦 JUnit 识别出某个类是类模板，提供者就会返回一个或多个上下文，每个上下文都定义了一次完整的执行。对于每个上下文，<strong>JUnit 都会创建一个新的测试实例，应用对应的扩展，并执行生命周期方法和测试方法</strong>。这样，测试类可以专注于业务逻辑本身，而由提供者来塑造运行时环境。</p>
<h3 data-id="heading-3">2.2. Class Template 与 Method Template 对比</h3>
<p>在继续之前，值得先对比一下类模板和方法模板（method template）之间的区别。两者都支持重复执行，但关注的层级不同。方法模板会在不同输入下重复执行<strong>同一个测试方法</strong>；而类模板则会重复执行<strong>整个测试类</strong>，包括它的生命周期回调、扩展以及配置。</p>
<p>因此，当变化点主要体现在整体环境层面——例如 Locale、特性开关或系统级配置——而不是单个方法参数时，<strong>类模板会更加合适</strong>。</p>
<h2 data-id="heading-4">3. 调用上下文提供者</h2>
<p>接下来，我们看看“调用上下文提供者（invocation context provider）”。<strong>这个扩展负责为类模板提供执行上下文</strong>。它需要实现 <code>ClassTemplateInvocationContextProvider</code> 接口，该接口定义了两个核心方法，用来决定提供者如何参与测试执行。</p>
<p>下面我们分别来看。</p>
<h3 data-id="heading-5">3.1. <code>supportsClassTemplate()</code> 方法</h3>
<p>在 JUnit 使用某个提供者之前，它会先检查该提供者是否适用于当前正在发现的测试类。这个检查就是通过 <code>supportsClassTemplate()</code> 方法完成的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsClassTemplate</span><span class="hljs-params">(ExtensionContext context)</span> {
    <span class="hljs-keyword">return</span> context.getTestClass()
        .map(aClass -&gt; aClass.isAnnotationPresent(ClassTemplate.class))
        .orElse(<span class="hljs-literal">false</span>);
}
</code></pre>
<p>JUnit 会对每一个已注册的提供者调用这个方法。只有返回 <code>true</code> 的提供者才会对当前类模板生效。通过这种机制，JUnit 可以<strong>避免提供者被意外激活，避免在无关测试上运行扩展，同时也允许多个提供者并存而互不干扰</strong>。</p>
<h3 data-id="heading-6">3.2. <code>provideClassTemplateInvocationContexts()</code> 方法</h3>
<p>一旦某个提供者被激活，JUnit 就会调用 <code>provideClassTemplateInvocationContexts()</code>，以获取描述模板执行方式的上下文：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Stream&lt;ClassTemplateInvocationContext&gt; <span class="hljs-title function_">provideClassTemplateInvocationContexts</span><span class="hljs-params">(ExtensionContext context)</span> {
    <span class="hljs-keyword">return</span> Stream.of(invocationContext(<span class="hljs-string">"A"</span>), invocationContext(<span class="hljs-string">"B"</span>));
}
</code></pre>
<p><strong>每一个上下文都代表了一次对测试类的完整执行</strong>。单个提供者可以提供一个或多个上下文；如果同时有多个提供者处于激活状态，JUnit 会把它们提供的流拼接起来。每个上下文都可以添加自己的扩展或配置，从而让提供者可以对该次执行的环境进行精细控制。</p>
<p>从这里开始，<strong>JUnit 会为每个上下文创建一个新的测试类实例，应用对应的扩展，并完整运行生命周期方法和测试方法各一次</strong>。</p>
<h2 data-id="heading-7">4. 实用示例</h2>
<p>为了更直观地理解这些概念，我们来构造一个示例：编写一个测试，用来验证在多个 JVM Locale 下的日期格式化逻辑。由于 Locale 会影响整个执行环境，这类需求非常适合用类模板来实现。我们只保留<strong>一个</strong>测试类，然后让提供者在不同配置下多次执行它。</p>
<h3 data-id="heading-8">4.1. 日期格式化逻辑</h3>
<p>首先，从一个小工具类开始，它使用当前 JVM 默认 Locale 来格式化日期。只要默认 Locale 发生变化，它的输出就会随之改变：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DateFormatter</span> {

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(LocalDate date)</span> {
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofLocalizedDate(FormatStyle.LONG)
            .withLocale(Locale.getDefault());

        <span class="hljs-keyword">return</span> date.format(formatter);
    }
}
</code></pre>
<p>有了这个类之后，我们就可以在多种不同的配置下验证它的行为，而这些配置都由类模板来提供。</p>
<h3 data-id="heading-9">4.2. 提供者与扩展</h3>
<p>为了支撑上述需求，我们首先需要一个扩展，用来在单次执行期间设置默认 Locale：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LocaleExtension</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeforeEachCallback</span>, AfterEachCallback {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Locale locale;
    <span class="hljs-keyword">private</span> Locale previous;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeEach</span><span class="hljs-params">(ExtensionContext context)</span> {
        previous = Locale.getDefault();
        Locale.setDefault(locale);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterEach</span><span class="hljs-params">(ExtensionContext context)</span> {
        Locale.setDefault(previous);
    }
}
</code></pre>
<p>这个扩展会在每次测试之前暂时替换 JVM 的默认 Locale，并在测试结束后恢复原有值。<strong>在不同执行之间唯一变化的，就是传入该扩展的 <code>Locale</code> 实例。</strong></p>
<p>接下来，提供者会通过 <code>provideClassTemplateInvocationContexts()</code> 方法来提供不同的上下文。每个上下文都由 <code>invocationContext()</code> 方法创建，该方法通过 <code>getDisplayName()</code> 指定显示名，并通过 <code>getAdditionalExtensions()</code> 安装对应的 <code>LocaleExtension</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DateLocaleClassTemplateProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassTemplateInvocationContextProvider</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Stream&lt;ClassTemplateInvocationContext&gt; <span class="hljs-title function_">provideClassTemplateInvocationContexts</span><span class="hljs-params">(ExtensionContext context)</span> {
        <span class="hljs-keyword">return</span> Stream.of(Locale.US, Locale.GERMANY, Locale.ITALY, Locale.JAPAN)
            .map(<span class="hljs-built_in">this</span>::invocationContext);
    }

    <span class="hljs-keyword">private</span> ClassTemplateInvocationContext <span class="hljs-title function_">invocationContext</span><span class="hljs-params">(Locale locale)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassTemplateInvocationContext</span>() {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDisplayName</span><span class="hljs-params">(<span class="hljs-type">int</span> invocationIndex)</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"Locale: "</span> + locale.getDisplayName();
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> List&lt;Extension&gt; <span class="hljs-title function_">getAdditionalExtensions</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> List.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LocaleExtension</span>(locale));
            }
        };
    }
}
</code></pre>
<p>通过这样的配置，我们就得到了互不相同的执行环境，最终会对同一个测试类执行四次测试。</p>
<h3 data-id="heading-10">4.3. Class Template 测试</h3>
<p>此时，类模板的整体配置已经就位，我们就可以专注于编写一个测试方法了。JUnit 会通过前面配置好的提供者，为每个上下文执行一次这个方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DateFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateFormatter</span>();

<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">givenDefaultLocale_whenFormattingDate_thenMatchesLocalizedOutput</span><span class="hljs-params">()</span> {
    <span class="hljs-type">LocalDate</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> LocalDate.of(<span class="hljs-number">2025</span>, <span class="hljs-number">9</span>, <span class="hljs-number">30</span>);

    <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">expectedFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofLocalizedDate(FormatStyle.LONG)
        .withLocale(Locale.getDefault());

    <span class="hljs-type">String</span> <span class="hljs-variable">expected</span> <span class="hljs-operator">=</span> date.format(expectedFormatter);
    <span class="hljs-type">String</span> <span class="hljs-variable">formatted</span> <span class="hljs-operator">=</span> formatter.format(date);

    LOG.info(<span class="hljs-string">"Locale: {}, Expected: {}, Formatted: {}"</span>, Locale.getDefault(), expected, formatted);

    assertEquals(expected, formatted);
}
</code></pre>
<p>在每次执行中，测试都会基于当前默认 Locale 计算预期值，并与 <code>DateFormatter</code> 的输出进行比较。<strong>类模板和提供者负责在每次执行之间切换环境设置</strong>，因此测试代码本身可以保持简单、干净，不需要任何分支逻辑。</p>
<h3 data-id="heading-11">4.4. 测试输出</h3>
<p>最后，当我们运行这组测试时，同一个测试类会在每个 Locale 下执行一次，而每次的格式化结果都不相同：</p>
<pre><code class="hljs language-text" lang="text">Locale: en_US, Expected: September 30, 2025, Formatted: September 30, 2025
Locale: de_DE, Expected: 30. September 2025, Formatted: 30. September 2025
Locale: it_IT, Expected: 30 settembre 2025, Formatted: 30 settembre 2025
Locale: ja_JP, Expected: 2025年9月30日, Formatted: 2025年9月30日
</code></pre>
<p>可以看到，每一行都对应于一个调用上下文。测试代码在这些运行之间完全没有变化；变化的只是由提供者和扩展配置出来的执行环境。</p>
<h2 data-id="heading-12">5. 总结</h2>
<p>在本文中，我们从基础概念出发，进一步深入了 <code>@ClassTemplate</code> 的使用方式，重点考察了提供者如何为单个测试类提供多个执行上下文。通过 Locale 示例，我们看到提供者和扩展可以在不修改测试代码的前提下灵活地切换测试环境。这使得类模板<strong>成为处理全局设置或配置级行为测试的一种干净而优雅的解决方案</strong>。感谢阅读，如果您对Java内容感兴趣，也可以关注我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fspring4all.com%2Ftags%2Fjava" target="_blank" title="https://spring4all.com/tags/java" ref="nofollow noopener noreferrer">Java专题</a>内容。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vercel AI SDK：构建现代 Web AI 应用指南]]></title>    <link>https://juejin.cn/post/7584289165754155062</link>    <guid>https://juejin.cn/post/7584289165754155062</guid>    <pubDate>2025-12-16T12:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584289165754155062" data-draft-id="7584273076646264838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vercel AI SDK：构建现代 Web AI 应用指南"/> <meta itemprop="keywords" content="前端,AIGC"/> <meta itemprop="datePublished" content="2025-12-16T12:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vercel AI SDK：构建现代 Web AI 应用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T12:52:07.000Z" title="Tue Dec 16 2025 12:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41660f289c874d41be4751f8d93e894e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766494327&amp;x-signature=5h0WgpbEX%2FvyTrgAiVHcTwL2TUE%3D" alt="" loading="lazy"/>
随着大语言模型（LLM）越来越普及，将它们集成到 Web 应用、聊天机器人等场景中成为很多开发者的诉求。但不同模型提供商（DeepSeek、OpenAI、Anthropic、Google 等）在接口、请求方式、返回格式等方面差异很大。 此外，不同 Web 框架（React／Next.js、Vue／Nuxt、Node.js 等）也带来了兼容性和工程复杂性。</p>
<p>Vercel 推出的 Vercel AI SDK，旨在通过 <strong>统一 API + 框架无关 UI 组件 + 多模型适配器</strong> 的设计，将 “调用 LLM + 构建对话/生成 UI” 的复杂性封装起来，让开发者可以更专注于业务逻辑，而不必过多关注模型和框架差异。换句话说，Vercel AI SDK 是为“把 AI（LLM）接入现代 Web 应用” — 从原型到生产 — 提供一种标准、方便、高效的“中间层/基础设施”。如果你在做 ChatBot、知识库问答等项目时，Vercel AI SDK 能大幅降低上下游集成和工程复杂度。</p>
<p>当前，Vercel AI SDK 最新版本为 <strong>AI SDK 6</strong>，不过目前它处于 <strong>Beta 阶段</strong>。如果你不想用 Beta 版本，可以继续使用稳定版，即 AI SDK 5。</p>
<p>Vercel AI SDK 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev%2F" target="_blank" title="https://ai-sdk.dev/" ref="nofollow noopener noreferrer">ai-sdk.dev</a></p>
<p>Vercel AI SDK 开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fai" target="_blank" title="https://github.com/vercel/ai" ref="nofollow noopener noreferrer">github.com/vercel/ai</a></p>
<h2 data-id="heading-1">核心模块</h2>
<p><strong>AI SDK Core</strong></p>
<p>提供统一 API 用于调用语言模型／生成文本、结构化对象／数组、工具调用、流式响应等。通过统一接口屏蔽不同模型 Provider 的差异。SDK 本身不绑死任何模型，而是通过 Provider 机制适配众多模型提供商 (LLM)。如官方支持 DeepSeek、OpenAI、Anthropic、Google、xAI Grok 等，还支持自定义 Provider。</p>
<p><strong>AI SDK UI</strong></p>
<p>提供面向前端／前端框架 (React、Vue、Svelte、Angular 等) 的 hooks 或组件 (如 <code>useChat</code>, <code>useCompletion</code> 等)，方便构建聊天界面、生成式 UI、流式聊天界面、Agent UI 等。可以在多种前端架构中复用。</p>
<h2 data-id="heading-2">各库 (Package) 功能职责与适用场景</h2>
<h3 data-id="heading-3"><code>ai</code> — Core SDK</h3>
<ul>
<li>Core 核心包，提供统一、框架无关的 API，用于调用任意兼容 Provider 的 LLM</li>
<li>支持基础用例：文本生成、结构化数据生成、流式响应 (streaming)</li>
<li>支持多模型，通过 Provider Adapter 机制，如 <code>@ai-sdk/openai</code>) 来适配各家模型，将它们在统一的接口下抽象。</li>
</ul>
<p><strong>何时使用</strong><code>ai</code>：</p>
<ul>
<li>你需要后端 / API route 等调用 LLM、生成文本、结构化输出、执行工具调用 (例如调用外部 API、数据库、文件系统等)，并将结果处理、存储、转发</li>
<li>构建 “Workflow / 后端服务 / CLI 工具 ” 等，不需要前端 UI</li>
<li>跨 Provider (DeepSeek / OpenAI / Google / Anthropic ) 编写通用逻辑，不想为每个提供商写独立处理。</li>
</ul>
<p><strong>如何安装 / 依赖</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm install ai
</code></pre>
<h3 data-id="heading-4"><code>@ai-sdk/openai</code> — OpenAI Provider 适配包</h3>
<ul>
<li>“模型 Provider 适配包” — 用于当你希望使用 OpenAI (或兼容 OpenAI API) 作为 LLM Provider 时，把 OpenAI 整合进 Core；它实现了 Provider 接口。</li>
<li>提供对 OpenAI 规范功能的封装。</li>
</ul>
<p><strong>何时使用</strong><code>@ai-sdk/openai</code>：</p>
<ul>
<li>你计划用 OpenAI 的模型 (GPT-4, GPT-4o, GPT-5, 其他 OpenAI 模型) 作为你的 LLM。</li>
<li>你计划用 兼容 OpenAI 接口规范的模型作为你的 LLM。</li>
</ul>
<p><strong>如何安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @ai-sdk/openai
</code></pre>
<p>同时你还需要 <code>ai</code> (core) 才能一起使用。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { generateText } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-keyword">import</span> { openai } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai'</span>;

<span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(<span class="hljs-string">'gpt-4o'</span>),
  <span class="hljs-attr">prompt</span>: <span class="hljs-string">'介绍一下 Vercel AI SDK'</span>,
});
</code></pre>
<h3 data-id="heading-5"><code>@ai-sdk/react</code> — React UI 层</h3>
<ul>
<li>为 React 应用 (包括基于 React 的框架，如 Next.js) 提供 UI 层抽象 (hooks / 组件)，方便在前端构建聊天 UI /生成 UI /流式 UI。</li>
<li>常见提供的 hook 包括 <code>useChat</code>, <code>useCompletion</code>, <code>useObject</code> 等 —— 它们封装了状态管理 (Messages 列表、用户输入、提交、Request/Response 状态)、UI 更新、与后端 (或由 <code>ai</code> 包提供的 API) 的交互流程。</li>
<li>支持与 <code>ai</code> + Provider 组合使用，通过前端 + 后端 构建完整的 ChatBot 应用。</li>
</ul>
<p><strong>何时使用</strong><code>@ai-sdk/react</code>：</p>
<ul>
<li>你在做前端项目 (SPA / 静态网页 / Next.js / React) 并希望直接给用户展示交互界面 (聊天框、对话、生成内容、流式输出等)。</li>
<li>想快速构建 UI，不用自己从头管理请求 / 响应 /消息列表 /状态 /loading /streaming/ UI 更新。</li>
</ul>
<p><strong>如何安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @ai-sdk/react
</code></pre>
<p><strong>示例 (React / Next.js)</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { messages, sendMessage, status, error } = <span class="hljs-title function_">useChat</span>({
  <span class="hljs-attr">transport</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextStreamChatTransport</span>({
    <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/chat"</span>,
  }),
});
</code></pre>
<p>后端（Next.js API route）使用 <code>ai</code> + <code>@ai-sdk/openai</code> 产生响应。</p>
<h2 data-id="heading-6">根据项目需求选择包</h2>
<ul>
<li>如果你的项目 <strong>只需要后端 / 对 LLM 进行调用 / 生成文本</strong> —— 只安装 <code>ai</code> + 对应 Provider (例如 <code>@ai-sdk/openai</code>)。</li>
<li>如果你的项目 <strong>涉及前端 / 用户交互 / Chat UI /对话界面 /生成 UI</strong> —— 那建议也加上 <code>@ai-sdk/react</code> (或视你前端框架为 <code>@ai-sdk/vue</code>, <code>@ai-sdk/svelte</code> 等) 来处理 UI/交互逻辑。</li>
<li><code>@ai-sdk/openai</code> (或其他 Provider 包) 是必须的，否则 <code>ai</code> 就不知道用哪家模型服务。</li>
</ul>
<h2 data-id="heading-7">快速上手</h2>
<p>以下是一个示例 "利用 Vercel AI SDK 构建简单聊天" 的实践。</p>
<h3 data-id="heading-8">步骤 1: 创建 Next.js 项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建一个新的 Next.js 项目</span>
npx create-next-app@latest ai-chatbot

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> ai-chatbot
</code></pre>
<p>在创建过程中，选择以下选项：</p>
<ul>
<li>✅ TypeScript</li>
<li>✅ ESLint</li>
<li>✅ Tailwind CSS</li>
<li>✅ App Router</li>
<li>🔘 src/ directory (可选)</li>
<li>✅ Turbopack (可选)</li>
</ul>
<h3 data-id="heading-9">步骤 2: 安装 Vercel AI SDK 依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装核心包和 OpenAI Provider</span>
npm install ai @ai-sdk/openai @ai-sdk/react

<span class="hljs-comment"># 或者使用其他 Provider，例如:</span>
<span class="hljs-comment"># npm install ai @ai-sdk/anthropic @ai-sdk/react  # Anthropic Claude</span>
<span class="hljs-comment"># npm install ai @ai-sdk/google @ai-sdk/react     # Google Gemini</span>
</code></pre>
<h3 data-id="heading-10">步骤 3: 配置环境变量</h3>
<p>在项目根目录创建 <code>.env.local</code> 文件（这里我们使用Kimi）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># OpenAI API Key</span>
OPENAI_API_KEY=your_kimi_api_key_here

<span class="hljs-comment"># 如果使用兼容 OpenAI 的服务（如 Kimi），可以配置基础 URL</span>
OPENAI_BASE_URL=https://api.moonshot.cn/v1
</code></pre>
<h3 data-id="heading-11">步骤 4: 创建后端 API Route</h3>
<p>创建文件 <code>app/api/chat/route.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { openai } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai'</span>;
<span class="hljs-keyword">import</span> { streamText } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-comment">// 允许流式响应最多 30 秒</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> maxDuration = <span class="hljs-number">30</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-comment">// 从请求体中提取消息</span>
  <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-comment">// 调用 LLM 生成流式响应</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(<span class="hljs-string">'gpt-4o'</span>),
    messages
  });

  <span class="hljs-comment">// 返回流式响应</span>
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toTextStreamResponse</span>();
}
</code></pre>
<p><strong>如果使用 Kimi（兼容 OpenAI API）</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/openai"</span>;
<span class="hljs-keyword">import</span> { streamText, convertToModelMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;

<span class="hljs-comment">// 创建 Kimi Provider (Moonshot AI)</span>
<span class="hljs-keyword">const</span> kimiClient = <span class="hljs-title function_">createOpenAI</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://api.moonshot.cn/v1"</span>,
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">KIMI_API_KEY</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> maxDuration = <span class="hljs-number">30</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
    <span class="hljs-attr">model</span>: kimiClient.<span class="hljs-title function_">chat</span>(<span class="hljs-string">"moonshot-v1-8k"</span>),
    <span class="hljs-attr">messages</span>: <span class="hljs-title function_">convertToModelMessages</span>(messages),
  });
  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toTextStreamResponse</span>();
}

</code></pre>
<h3 data-id="heading-12">步骤 5: 创建前端聊天页面</h3>
<p>修改 <code>app/page.tsx</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">"use client"</span>;

<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { useChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TextStreamChatTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> { messages, sendMessage, status, error } = <span class="hljs-title function_">useChat</span>({
    <span class="hljs-attr">transport</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextStreamChatTransport</span>({
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/chat"</span>,
    }),
  });

  <span class="hljs-keyword">const</span> isLoading = status === <span class="hljs-string">"streaming"</span> || status === <span class="hljs-string">"submitted"</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex min-h-screen flex-col items-center justify-between p-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full max-w-2xl flex flex-col h-[80vh]"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-3xl font-bold mb-6 text-center"</span>&gt;</span>AI 聊天助手<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

        {/* 消息列表 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 overflow-y-auto mb-4 space-y-4 p-4 bg-gray-50 rounded-lg"</span>&gt;</span>
          {messages.length === 0 &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center text-gray-500 mt-10"</span>&gt;</span>
              开始对话吧！向 AI 助手提问任何问题。
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}

          {messages.map((message) =&gt; {
            // 提取文本内容
            const textContent = message.parts
              ?.filter((part) =&gt; part.type === "text")
              .map((part) =&gt; part.text)
              .join("") || "";

            return (
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{message.id}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">flex</span> ${
                  <span class="hljs-attr">message.role</span> === <span class="hljs-string">"user"</span> ? "<span class="hljs-attr">justify-end</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">justify-start</span>"
                }`}
              &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">max-w-</span>[<span class="hljs-attr">80</span>%] <span class="hljs-attr">rounded-lg</span> <span class="hljs-attr">px-4</span> <span class="hljs-attr">py-2</span> ${
                    <span class="hljs-attr">message.role</span> === <span class="hljs-string">"user"</span>
                      ? "<span class="hljs-attr">bg-blue-500</span> <span class="hljs-attr">text-white</span>"
                      <span class="hljs-attr">:</span> "<span class="hljs-attr">bg-white</span> <span class="hljs-attr">text-gray-800</span> <span class="hljs-attr">border</span> <span class="hljs-attr">border-gray-200</span>"
                  }`}
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs font-semibold mb-1 opacity-70"</span>&gt;</span>
                    {message.role === "user" ? "你" : "AI 助手"}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"whitespace-pre-wrap"</span>&gt;</span>{textContent}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            );
          })}

          {isLoading &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-start"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-white text-gray-800 border border-gray-200 rounded-lg px-4 py-2"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex space-x-2"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-2 h-2 bg-gray-400 rounded-full animate-bounce"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                    <span class="hljs-attr">className</span>=<span class="hljs-string">"w-2 h-2 bg-gray-400 rounded-full animate-bounce"</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">animationDelay:</span> "<span class="hljs-attr">0.1s</span>" }}
                  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
                    <span class="hljs-attr">className</span>=<span class="hljs-string">"w-2 h-2 bg-gray-400 rounded-full animate-bounce"</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">animationDelay:</span> "<span class="hljs-attr">0.2s</span>" }}
                  &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}

          {error &amp;&amp; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center text-red-500 p-4 bg-red-50 rounded-lg"</span>&gt;</span>
              错误：{error.message}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          )}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        {/* 输入表单 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">form</span>
          <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
            e.preventDefault();
            if (input.trim()) {
              sendMessage({ text: input });
              setInput("");
            }
          }}
          className="flex gap-2"
        &gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{input}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setInput(e.target.value)}
            placeholder="输入消息..."
            disabled={isLoading}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
          /&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>
            <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading</span> || !<span class="hljs-attr">input.trim</span>()}
            <span class="hljs-attr">className</span>=<span class="hljs-string">"px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"</span>
          &gt;</span>
            {isLoading ? "发送中..." : "发送"}
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-13">步骤 6: 运行项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动开发服务器</span>
npm run dev
</code></pre>
<p>访问 <code>http://localhost:3000</code>，你就可以看到一个完整的 AI 聊天界面了！效果展示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ad1c4c89f849958f3db15eb42cb9f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766494327&amp;x-signature=JjAue6YF%2Ft93qsIO4NuFYnfB8v8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">总结</h2>
<p>Vercel AI SDK 是目前 Web / JavaScript / TypeScript 生态中，将大语言模型 (LLM) 与现代前端 + 后端框架 (Next.js, React, Vue, Svelte, Node.js, Serverless 等) 整合得最完整、最方便、最全面的开源 SDK 之一。</p>
<ul>
<li>对于想快速构建聊天机器人、生成式应用、agent、文档分析、RAG 系统、多模态应用等的人来说，它大幅降低了技术门槛和工程成本；</li>
<li>对于需要支持多模型、多 provider、跨框架、跨运行时 (server / edge / frontend) 的项目，它提供了稳定、统一、可维护、可扩展的基础设施；</li>
<li>对于只是想在短时间内做原型 / MVP / demo，也非常友好。</li>
</ul>
<p>当然，对于极度定制、高性能、特殊模型 / 极端场景，你仍可能需要绕开 SDK，自己构建更底层或更专门化的方案。如果你 <strong>刚开始做 AI + Web 应用</strong> —— Vercel AI SDK 是一个非常推荐的 “最好实践 / 起点 / 基础设施”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GELab-Zero 技术解析：当豆包联手中兴，开源界如何守住端侧 AI 的“最后防线”？]]></title>    <link>https://juejin.cn/post/7584289165754171446</link>    <guid>https://juejin.cn/post/7584289165754171446</guid>    <pubDate>2025-12-16T12:52:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584289165754171446" data-draft-id="7584273076646281222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GELab-Zero 技术解析：当豆包联手中兴，开源界如何守住端侧 AI 的“最后防线”？"/> <meta itemprop="keywords" content="前端,AIGC"/> <meta itemprop="datePublished" content="2025-12-16T12:52:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GELab-Zero 技术解析：当豆包联手中兴，开源界如何守住端侧 AI 的“最后防线”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T12:52:58.000Z" title="Tue Dec 16 2025 12:52:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p><strong>2025年12月，AI 端侧领域迎来了两大里程碑式突破，标志着端侧智能助手从"能不能用"迈向"能否规模化落地"的关键阶段。</strong></p>
<p>一方面，<strong>字节跳动豆包团队</strong>发布了豆包手机助手技术预览版，首次在手机端实现了持久化本地记忆与跨应用操作能力。特别是其与<strong>中兴手机</strong>的深度合作，通过系统级授权（如 nubia M153 工程样机）实现了语音、侧边键直接唤醒的便捷交互，引发了行业关于"互联网巨头+手机厂商"生态合作模式的热烈讨论。</p>
<p>近日，<strong>阶跃星辰</strong>开源了 <strong>GELab-Zero-4B-preview</strong> 模型及配套工程基建，实现了 4B 级参数模型在主流安卓设备上的轻量化部署。作为开源模型提供方，阶跃选择了赋能开发者的路线，通过提供完整的推理工程基建，解决安卓生态碎片化的难题。</p>
<p>本文将聚焦于开源界的代表作——<strong>GELab-Zero</strong>，通过一个真实的任务执行案例（Session ID: <code>1fe9db3f-92c8-4ae9-89bc-1d035d4bf59b</code>），深入剖析其技术架构、工作原理以及如何在消费级设备上实现 SOTA 级的 GUI 操作能力。</p>
<hr/>
<h2 data-id="heading-1">技术背景：端侧 AI 的战国时代</h2>
<h3 data-id="heading-2">1. 行业格局：三条路线的角逐</h3>
<p>当前手机端侧智能助手领域形成了多元化的竞争格局，主要厂商的技术路线和行业定位各有特色：</p>

































<table><thead><tr><th align="left">厂商类型</th><th align="left">代表厂商/产品</th><th align="left">模型规模</th><th align="left">技术路线特点</th><th align="left">行业定位</th></tr></thead><tbody><tr><td align="left"><strong>手机厂商</strong></td><td align="left"><strong>OPPO</strong> (AndesVL)<br/><strong>vivo</strong> (BlueLM)<br/><strong>华为</strong> (小艺)<br/><strong>荣耀</strong> (MagicGUI)</td><td align="left">0.6B-7B+</td><td align="left"><strong>系统级整合</strong>：多采用多模态模型，深度整合系统底层（如华为 NPU+鸿蒙，OPPO 潮汐引擎）。强调硬件协同与专属体验。</td><td align="left"><strong>系统级智能助理</strong><br/>打造"高效&amp;专属"的差异化体验</td></tr><tr><td align="left"><strong>互联网巨头</strong></td><td align="left"><strong>字节跳动</strong> (豆包)</td><td align="left">未公开</td><td align="left"><strong>轻量化工具+生态合作</strong>：具备端侧持久记忆和跨 App 操作能力。依赖与厂商（如中兴）的合作获得系统级权限。</td><td align="left"><strong>轻量化工具型助手</strong><br/>通过生态合作覆盖多品牌</td></tr><tr><td align="left"><strong>开源模型方</strong></td><td align="left"><strong>阶跃星辰</strong> (GELab-Zero)</td><td align="left">4B</td><td align="left"><strong>开源基建+通用兼容</strong>：提供完整的推理工程基建，解决 ADB 连接、依赖安装等"脏活累活"。支持一键部署。</td><td align="left"><strong>开发者赋能平台</strong><br/>降低端侧 Agent 开发门槛</td></tr></tbody></table>
<h3 data-id="heading-3">2. 深度案例解析：豆包 x 中兴 nubia 的集成机制</h3>
<p>豆包手机助手在中兴 nubia M153 工程机上的实现，展示了**"互联网巨头软件 + 手机厂商硬件"**的典型合作模式：</p>
<h4 data-id="heading-4">A. 集成方式：系统级深度植入 (System-Level Integration)</h4>
<p>不同于普通 App，豆包通过与中兴 OS (MyOS) 的底层打通，实现了硬件级的接管：</p>
<ul>
<li><strong>硬件入口绑定</strong>：将物理<strong>侧边键</strong>映射为 AI 唤醒键，支持熄屏状态下一键直达。</li>
<li><strong>权限白名单</strong>：突破了传统 Accessibility 服务易被后台查杀的限制，获得了<strong>系统级保活</strong>权限，确保持续的感知能力。</li>
</ul>
<h4 data-id="heading-5">B. 模型运行架构：端云协同 (Cloud-Edge Collaboration)</h4>
<ul>
<li><strong>端侧 (On-Device)</strong>：
<ul>
<li><strong>Secure Memory (安全记忆)</strong>：核心差异化功能。利用 Android Keystore 对用户敏感数据（如家庭地址、支付习惯）进行<strong>本地加密存储</strong>，确保隐私不离端。</li>
<li><strong>Executor (执行引擎)</strong>：运行在手机本地的轻量级服务，负责将指令转化为具体的点击/滑动操作。</li>
</ul>
</li>
<li><strong>云端 (Cloud)</strong>：
<ul>
<li><strong>Reasoning Engine (推理大脑)</strong>：处理复杂的长程任务规划（如"跨 App 比价"），利用云端大模型的算力优势进行决策，然后将操作流下发给端侧执行。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">C. 交互闭环</h4>
<ol>
<li><strong>感知</strong>：通过无障碍服务 (Accessibility API) 实时获取屏幕 UI 树信息。</li>
<li><strong>决策</strong>：端侧记忆 + 屏幕信息 + 用户指令 -&gt; 云端推理 -&gt; 下发操作流。</li>
<li><strong>执行</strong>：调用系统级 API 模拟用户操作，遇到敏感场景（如支付）自动降级为"请求用户确认"。</li>
</ol>
<h3 data-id="heading-7">3. GUI Agent 的技术演进</h3>
<h3 data-id="heading-8">移动端 Agent 的三大技术路径</h3>
<p>在移动端 Agent 领域，目前主要存在三种技术实现路径：</p>
<h4 data-id="heading-9">1. <strong>API 接口方案</strong></h4>
<ul>
<li><strong>优势</strong>：精确可靠，延迟低</li>
<li><strong>劣势</strong>：需要 App 厂商深度适配，开发成本高，难以规模化</li>
<li><strong>代表</strong>：需要每个 App 提供专门的 Agent API</li>
</ul>
<h4 data-id="heading-10">2. <strong>辅助功能（Accessibility）方案</strong></h4>
<ul>
<li><strong>优势</strong>：可以获取 UI 树结构，理解界面元素</li>
<li><strong>劣势</strong>：依赖系统权限，部分应用限制访问，兼容性问题多</li>
<li><strong>代表</strong>：Android Accessibility Service</li>
</ul>
<h4 data-id="heading-11">3. <strong>GUI 视觉方案</strong>（GELab-Zero 采用）</h4>
<ul>
<li><strong>优势</strong>：
<ul>
<li><strong>通用兼容</strong>：无需 App 厂商适配，支持所有应用</li>
<li><strong>零成本接入</strong>：基于截屏和坐标操作，开箱即用</li>
<li><strong>真实用户视角</strong>：与人类操作方式一致</li>
</ul>
</li>
<li><strong>劣势</strong>：对视觉理解能力要求高，需要强大的多模态模型</li>
<li><strong>代表</strong>：GELab-Zero、Anthropic Computer Use</li>
</ul>
<h3 data-id="heading-12">为什么选择 GUI 方案？</h3>
<p>移动应用生态具有以下特点：</p>
<ol>
<li><strong>高度碎片化</strong>：中国市场有超过 <strong>数百万个</strong> Android 应用</li>
<li><strong>快速迭代</strong>：应用 UI 频繁更新，API 方案难以维护</li>
<li><strong>权限限制</strong>：许多应用限制 Accessibility 访问</li>
<li><strong>用户习惯</strong>：基于视觉的交互更接近真实用户行为</li>
</ol>
<p>因此，<strong>GUI 方案已成为当前阶段应对复杂移动生态、实现 Agent 能力规模化的最佳路径</strong>。</p>
<h3 data-id="heading-13">行业现状与挑战</h3>
<h4 data-id="heading-14">当前 GUI Agent 面临的核心问题</h4>
<ol>
<li>
<p><strong>工程门槛高</strong></p>
<ul>
<li>多设备 ADB 连接管理</li>
<li>依赖安装和权限配置</li>
<li>推理服务部署（本地 LLM）</li>
<li>任务编排与轨迹回放</li>
<li>可视化调试工具</li>
</ul>
</li>
<li>
<p><strong>模型能力要求高</strong></p>
<ul>
<li>需要强大的视觉理解能力</li>
<li>多步骤任务规划</li>
<li>上下文记忆</li>
<li>异常处理</li>
</ul>
</li>
<li>
<p><strong>隐私安全顾虑</strong></p>
<ul>
<li>云端 API 需要上传截图</li>
<li>用户操作数据泄露风险</li>
<li>敏感信息暴露</li>
</ul>
</li>
</ol>
<h4 data-id="heading-15">主流 Benchmark 的局限性</h4>
<p>当前主流基准测试（如 AndroidWorld）多聚焦于<strong>生产力应用</strong>（邮件、日历），但用户日常高频使用的其实是<strong>生活服务类应用</strong>：</p>
<ul>
<li>🍔 外卖（美团、饿了么）</li>
<li>🚗 打车（滴滴、高德）</li>
<li>🛒 购物（淘宝、京东）</li>
<li>💬 社交（微信、抖音）</li>
<li>💰 支付（支付宝、微信支付）</li>
</ul>
<p>这些场景更能体现 GUI Agent 的实用价值，但缺乏针对性的评估标准。</p>
<h3 data-id="heading-16">GELab-Zero 的技术突破</h3>
<p>针对上述挑战，GELab-Zero 提供了完整的解决方案：</p>
<h4 data-id="heading-17">1. <strong>完整工程基础设施</strong></h4>
<pre><code class="hljs">一键部署脚本
自动设备管理
多设备任务分发
完整日志系统
Streamlit 可视化界面
</code></pre>
<h4 data-id="heading-18">2. <strong>轻量级本地模型</strong></h4>
<ul>
<li><strong>4B 参数</strong>：在消费级硬件（16GB RAM）上流畅运行</li>
<li><strong>多模态能力</strong>：同时理解图像和文本</li>
<li><strong>高准确率</strong>：AndroidDaily 静态测试达到 <strong>73.4%</strong>（超越 GPT-4o 的 19.6%）</li>
</ul>
<h4 data-id="heading-19">3. <strong>完全本地化</strong></h4>
<ul>
<li>所有推理在本地完成（Ollama/vLLM）</li>
<li>截图和日志存储在本地</li>
<li>无需网络传输，保护隐私</li>
</ul>
<h4 data-id="heading-20">4. <strong>真实场景基准</strong></h4>
<ul>
<li><strong>AndroidDaily</strong>：235 个端到端任务</li>
<li>覆盖六大生活场景：食、行、购、住、讯、娱</li>
<li>75.86% 成功率（真实移动场景）</li>
</ul>
<h3 data-id="heading-21">与其他方案的对比</h3>















































<table><thead><tr><th>维度</th><th>API 方案</th><th>Accessibility</th><th>GUI 方案 (GELab-Zero)</th></tr></thead><tbody><tr><td><strong>兼容性</strong></td><td>❌ 需要适配</td><td>⚠️ 部分限制</td><td>✅ 通用兼容</td></tr><tr><td><strong>开发成本</strong></td><td>❌ 高</td><td>⚠️ 中</td><td>✅ 低</td></tr><tr><td><strong>隐私保护</strong></td><td>⚠️ 依赖服务商</td><td>✅ 本地</td><td>✅ 完全本地</td></tr><tr><td><strong>推理速度</strong></td><td>✅ 快</td><td>✅ 快</td><td>⚠️ 中等</td></tr><tr><td><strong>准确性</strong></td><td>✅ 高</td><td>✅ 高</td><td>✅ 高（73.4%）</td></tr><tr><td><strong>可维护性</strong></td><td>❌ 低</td><td>⚠️ 中</td><td>✅ 高</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-22">一、项目概览</h2>
<h3 data-id="heading-23">1.1 核心价值主张</h3>
<p>GELab-Zero 解决了移动端 Agent 落地的三大核心挑战：</p>
<ol>
<li><strong>隐私安全</strong>：完全本地化部署，所有数据处理在本地完成，无需上传云端</li>
<li><strong>即插即用</strong>：提供完整的工程基础设施，开箱即用，无需复杂配置</li>
<li><strong>通用兼容</strong>：基于 GUI 操作，无需 App 厂商适配，支持所有应用</li>
</ol>
<h3 data-id="heading-24">1.2 技术栈组成</h3>
<ul>
<li><strong>模型层</strong>：GELab-Zero-4B-preview（基于 Qwen3-VL-4B-Instruct 微调的 4B 参数多模态视觉模型）</li>
<li><strong>推理服务</strong>：Ollama / vLLM（本地推理）</li>
<li><strong>设备控制</strong>：ADB（Android Debug Bridge）</li>
<li><strong>任务编排</strong>：LocalServer + PU Client</li>
<li><strong>可视化</strong>：Streamlit Web 界面</li>
</ul>
<h3 data-id="heading-25">1.3 开源价值深度解析：商业巨头阴影下的"守火人"</h3>
<p>在字节跳动豆包等商业产品展现出强大的系统级统治力时，GELab-Zero 这样的开源项目并非毫无意义的"重复造轮子"，而是构建了另一条必不可少的技术护城河。虽然在流畅度和系统权限上不如商业产品，但其独特价值在于：</p>
<ol>
<li>
<p><strong>打破"围墙花园"（针对存量市场）</strong>
商业产品（如豆包+中兴）依赖于排他性的厂商合作与私有系统 API。GELab-Zero 证明了<strong>纯视觉方案（Visual-based）<strong>的可行性——即使没有任何厂商特权，仅凭屏幕截图也能实现复杂的 Agent 交互。这意味着它能在数以亿计的</strong>存量旧手机</strong>上运行，而不是强迫用户购买特定的新款"AI 手机"。</p>
</li>
<li>
<p><strong>数据主权的"最后防线"（针对敏感场景）</strong>
商业助手虽然强调"端侧隐私"，但为了追求极致效果，核心的长程推理（Reasoning）往往仍依赖云端大模型（Cloud-Edge Collaboration）。GELab-Zero 是真正的<strong>全链路本地化（Local-First）</strong>，从模型权重到推理过程完全掌握在用户手中。对于<strong>金融审计、医疗数据处理、企业内网办公</strong>等对数据外泄零容忍的场景，这是唯一的选择。</p>
</li>
<li>
<p><strong>透明可控的"白盒"基座（针对开发者）</strong>
对于学术界和开发者，商业助手是"黑盒"，只能调用，无法探究其决策逻辑。GELab-Zero 提供了从数据采集（AndroidDaily）、动作定义（ActTree）到模型训练的完整**白盒（White-box）**流程。它是研究 Agent 幻觉、优化多步推理机制的最佳实验台，为行业建立了公开透明的技术标准。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-26">二、系统架构深度解析</h2>
<h3 data-id="heading-27">2.1 整体架构图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e449caaac2a14ee29499325dee486ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766494378&amp;x-signature=r72fl3npN5PyYiLCZ8FMFHC44NI%3D" loading="lazy"/>
<h3 data-id="heading-28">2.2 核心组件详解</h3>
<h4 data-id="heading-29">2.2.1 LocalServer（任务编排服务器）</h4>
<p><strong>职责</strong>：</p>
<ul>
<li>接收用户任务指令</li>
<li>管理任务执行状态</li>
<li>协调视觉理解和设备控制</li>
<li>记录完整执行轨迹</li>
</ul>
<p><strong>关键配置</strong>：</p>
<pre><code class="hljs language-python" lang="python">tmp_server_config = {
    <span class="hljs-string">"log_dir"</span>: <span class="hljs-string">"running_log/server_log/os-copilot-local-eval-logs/traces"</span>,
    <span class="hljs-string">"image_dir"</span>: <span class="hljs-string">"running_log/server_log/os-copilot-local-eval-logs/images"</span>,
    <span class="hljs-string">"debug"</span>: <span class="hljs-literal">False</span>
}
</code></pre>
<h4 data-id="heading-30">2.2.2 GELab-Zero-4B-preview 模型与架构</h4>
<p><strong>三层架构设计</strong>：
GELab-Zero 采用了类似 MobiAgent 的三层架构，以确保复杂任务的执行能力：</p>
<ol>
<li><strong>Planner (规划师)</strong>：负责任务拆解和整体流程控制。</li>
<li><strong>Decider (决策者)</strong>：根据当前屏幕状态决定具体操作。</li>
<li><strong>Ground (执行者)</strong>：将决策转化为具体的坐标点击或文本输入。</li>
</ol>
<p><strong>模型特性</strong>：</p>
<ul>
<li><strong>参数规模</strong>：4B（40 亿参数），专为消费级硬件优化。</li>
<li><strong>性能表现</strong>：在 ScreenSpot、OSWorld、Android World 等多个基准测试中拿下同尺寸 SOTA。</li>
<li><strong>多模态输入</strong>：手机截图 + 任务描述 + 历史操作。</li>
</ul>
<p><strong>基座模型</strong>：
该模型是基于 <strong>Qwen3-VL-4B-Instruct</strong> 进行微调的。选择 Qwen3-VL 作为基座是因为其在小参数量级下展现出了卓越的视觉理解和指令遵循能力，非常适合端侧部署场景。</p>
<p><strong>技术亮点：ActTree 任务分发</strong>
为了提升效率，系统引入了 <strong>多设备任务分发系统</strong>。通过 ActTree 结构记录并复用历史操作轨迹，大幅减少重复推理。在模拟真实用户习惯（80% 请求集中在 20% 任务）的测试中，<strong>动作复用率可达 60%-85%</strong>，带来 2 到 3 倍的性能提升。</p>
<p><strong>推理配置</strong>：</p>
<pre><code class="hljs language-python" lang="python">local_model_config = {
    <span class="hljs-string">"model_name"</span>: <span class="hljs-string">"gelab-zero-4b-preview"</span>,
    <span class="hljs-string">"model_provider"</span>: <span class="hljs-string">"local"</span>,
    <span class="hljs-string">"args"</span>: {
        <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.1</span>,      <span class="hljs-comment"># 低温度保证稳定性</span>
        <span class="hljs-string">"top_p"</span>: <span class="hljs-number">0.95</span>,
        <span class="hljs-string">"frequency_penalty"</span>: <span class="hljs-number">0.0</span>,
        <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">4096</span>,
    }
}
</code></pre>
<h4 data-id="heading-31">2.2.3 动作空间定义</h4>
<p>系统支持 9 类基础操作：</p>























































<table><thead><tr><th>动作类型</th><th>说明</th><th>参数</th></tr></thead><tbody><tr><td><strong>CLICK</strong></td><td>点击屏幕坐标</td><td>point (x,y)</td></tr><tr><td><strong>TYPE</strong></td><td>输入文本</td><td>value (文本内容), point (输入框位置)</td></tr><tr><td><strong>SLIDE</strong></td><td>滑动操作</td><td>point1 (起点), point2 (终点)</td></tr><tr><td><strong>LONGPRESS</strong></td><td>长按操作</td><td>point (坐标)</td></tr><tr><td><strong>AWAKE</strong></td><td>唤醒应用</td><td>value (应用名称)</td></tr><tr><td><strong>WAIT</strong></td><td>等待</td><td>value (秒数)</td></tr><tr><td><strong>INFO</strong></td><td>询问用户</td><td>value (问题内容)</td></tr><tr><td><strong>COMPLETE</strong></td><td>任务完成</td><td>return (结果报告)</td></tr><tr><td><strong>ABORT</strong></td><td>终止任务</td><td>value (终止原因)</td></tr></tbody></table>
<p><strong>坐标系统</strong>：</p>
<ul>
<li>原点：左上角 (0, 0)</li>
<li>X 轴：向右递增</li>
<li>Y 轴：向下递增</li>
<li>取值范围：0-1000（归一化坐标）</li>
</ul>
<hr/>
<h2 data-id="heading-32">三、实战案例：淘宝购书任务全流程解析</h2>
<h3 data-id="heading-33">3.1 任务背景</h3>
<p><strong>任务描述</strong>：去淘宝帮我买本书<br/>
<strong>Session ID</strong>：<code>1fe9db3f-92c8-4ae9-89bc-1d035d4bf59b</code><br/>
<strong>执行时间</strong>：2025-12-05 18:41:39 - 18:46:55<br/>
<strong>总步骤数</strong>：9 步<br/>
<strong>模型配置</strong>：gelab-zero-4b-preview (本地推理)
<strong>设备环境</strong>：MacBook Pro (Apple M3 Pro, 18GB RAM)
<strong>量化说明</strong>：因 18GB 统一内存运行 FP16 原生模型会触发系统卡死，本案例使用了 Int8 量化模型 (<code>q8_0</code>) 进行推理。</p>
<h3 data-id="heading-34">3.2 完整执行流程</h3>
<h4 data-id="heading-35">步骤 1：应用唤醒（AWAKE）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到的是手机主屏幕。任务是去淘宝买书。第一步就是要打开淘宝应用。我看到屏幕上有'京东'应用，但任务明确要求使用'淘宝'。因此，我需要先启动淘宝应用。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: AWAKE</span>
<span class="hljs-section">value: 淘宝</span>
</code></pre>
<p><strong>推理耗时</strong>：20.43 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li>模型能够区分不同的电商应用（京东 vs 淘宝）</li>
<li>准确理解任务指令中的应用要求</li>
<li>使用 AWAKE 指令直接唤醒应用，而非手动查找点击</li>
</ul>
<hr/>
<h4 data-id="heading-36">步骤 2：搜索框定位（CLICK）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前是淘宝的首页。任务目标是购买一本书。为了找到书，我需要使用搜索功能。我观察到页面顶部有一个搜索框，里面有'干脆面'的提示文字。我需要点击这个搜索框来激活它。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: CLICK</span>
<span class="hljs-section">point: 375,117</span>
</code></pre>
<p><strong>推理耗时</strong>：20.69 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li>准确识别搜索框的视觉位置</li>
<li>理解需要先激活搜索框才能输入</li>
<li>坐标精准定位（屏幕中上部区域）</li>
</ul>
<hr/>
<h4 data-id="heading-37">步骤 3：文本输入（TYPE）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是淘宝的搜索页面，键盘已经弹起，光标在搜索框中。任务目标是购买一本书。现在我需要输入要搜索的关键词。为了找到书，我应该在搜索框中输入'书'。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: TYPE</span>
<span class="hljs-section">value: 书</span>
<span class="hljs-section">point: 213,132</span>
</code></pre>
<p><strong>推理耗时</strong>：22.23 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li>识别输入框的激活状态（键盘弹起）</li>
<li>提取任务关键词（"买书" → 搜索"书"）</li>
<li>TYPE 动作需要同时提供文本内容和输入框位置</li>
</ul>
<hr/>
<h4 data-id="heading-38">步骤 4：执行搜索（CLICK）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是淘宝的搜索页面，搜索框里已经输入了'书'。任务目标是购买一本书，现在需要执行搜索来查看有哪些书可以选。因此，我应该点击搜索框旁边的橙色'搜索'按钮。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: CLICK</span>
<span class="hljs-section">point: 896,130</span>
</code></pre>
<p><strong>推理耗时</strong>：21.06 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li>识别"搜索"按钮的视觉特征（橙色、位置）</li>
<li>理解搜索流程的完整性（输入 → 点击搜索）</li>
<li>右上角按钮的精准点击</li>
</ul>
<hr/>
<h4 data-id="heading-39">步骤 5：信息询问（INFO）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是'书'的搜索结果页。任务目标是购买一本书，但用户没有指定具体书名。为了继续任务，我需要知道用户想买哪一本书。因此，我应该向用户询问。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: INFO</span>
<span class="hljs-section">value: 请问您想买哪本书？</span>
</code></pre>
<p><strong>用户回复</strong>：我想买明朝那些事</p>
<p><strong>推理耗时</strong>：20.63 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li><strong>主动信息获取</strong>：模型意识到任务信息不完整</li>
<li><strong>交互式决策</strong>：通过 INFO 动作暂停执行，等待用户输入</li>
<li><strong>上下文理解</strong>：记住用户回复，继续执行后续步骤</li>
</ul>
<hr/>
<h4 data-id="heading-40">步骤 6：弹窗处理（CLICK）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是'书'的搜索结果页，但有一个'淘宝双12'的消费券弹窗覆盖在上面，阻碍了后续操作。任务目标是购买《明朝那些事》，所以必须先处理掉这个弹窗。我观察到弹窗下方有一个'X'关闭按钮。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: CLICK</span>
<span class="hljs-section">point: 500,710</span>
</code></pre>
<p><strong>推理耗时</strong>：22.28 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li><strong>干扰识别</strong>：准确判断弹窗是阻碍因素</li>
<li><strong>优先级处理</strong>：先清除障碍再继续主任务</li>
<li><strong>细节关注</strong>：定位关闭按钮的位置</li>
</ul>
<hr/>
<h4 data-id="heading-41">步骤 7：商品选择（CLICK）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是'书'的搜索结果列表。任务目标是购买《明朝那些事》。列表中的第一个商品就是'新版全9册 明朝那些事儿全套1-9册'，这正是我要找的书。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: CLICK</span>
<span class="hljs-section">point: 258,445</span>
</code></pre>
<p><strong>推理耗时</strong>：19.94 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li><strong>商品匹配</strong>：从搜索结果中识别目标商品</li>
<li><strong>文本理解</strong>："明朝那些事" = "明朝那些事儿"（近义词匹配）</li>
<li><strong>视觉定位</strong>：在商品列表中准确定位目标</li>
</ul>
<hr/>
<h4 data-id="heading-42">步骤 8：立即购买（CLICK）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是《明朝那些事儿》的商品详情页。任务目标是购买这本书。为了继续购买流程，我需要点击页面底部的'立即购买'按钮。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">action: CLICK</span>
<span class="hljs-section">point: 836,946</span>
</code></pre>
<p><strong>推理耗时</strong>：19.32 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li><strong>页面理解</strong>：识别商品详情页的布局结构</li>
<li><strong>按钮定位</strong>：准确找到底部购买按钮</li>
<li><strong>流程推进</strong>：理解电商购物的标准流程</li>
</ul>
<hr/>
<h4 data-id="heading-43">步骤 9：任务完成（COMPLETE）</h4>
<p><strong>模型思考</strong>：</p>
<blockquote>
<p>"我看到当前界面是订单确认页。任务是购买一本书，我已经完成了商品选择、加入购物车、进入结算的所有步骤。现在页面显示了收货地址、商品信息和支付金额243元。由于这是涉及金钱交易的最后一步，我应该在这里停止操作，并向用户报告订单的详细信息。"</p>
</blockquote>
<p><strong>执行动作</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">action: COMPLETE
return: 我已完成购书流程并到达订单确认页面。
订单详情如下：
<span class="hljs-deletion">- 商品：正版《明朝那些事儿》全套1-9册</span>
<span class="hljs-deletion">- 收货地址：xxx xxxxxxxxxx</span>
<span class="hljs-deletion">- 支付金额：¥243</span>
<span class="hljs-deletion">- 支付方式：先用后付</span>
请您确认以上信息无误后，可以点击页面底部的"先用后付，确认收货后付款 ¥243"按钮继续完成支付。
</code></pre>
<p><strong>推理耗时</strong>：25.83 秒</p>
<p><strong>关键技术点</strong>：</p>
<ul>
<li><strong>安全边界</strong>：在支付前停止，不执行敏感操作</li>
<li><strong>信息提取</strong>：从订单页面提取关键信息</li>
<li><strong>完整汇报</strong>：向用户清晰报告任务完成状态和后续操作建议</li>
</ul>
<hr/>
<h3 data-id="heading-44">3.3 性能统计</h3>





























<table><thead><tr><th>指标</th><th>数值</th></tr></thead><tbody><tr><td><strong>总步骤数</strong></td><td>9 步</td></tr><tr><td><strong>总执行时间</strong></td><td>~5 分钟 16 秒</td></tr><tr><td><strong>平均每步推理时间</strong></td><td>~21 秒</td></tr><tr><td><strong>成功率</strong></td><td>100% (完成到订单确认页)</td></tr><tr><td><strong>用户交互次数</strong></td><td>1 次 (询问书名)</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-45">四、技术亮点与创新</h2>
<h3 data-id="heading-46">4.1 多模态推理能力</h3>
<p>GELab-Zero 的 4B 模型展现了强大的视觉-语言理解能力：</p>
<ol>
<li>
<p><strong>视觉元素识别</strong>：</p>
<ul>
<li>搜索框、按钮、商品列表</li>
<li>弹窗、键盘状态</li>
<li>文字内容（商品名、价格、地址）</li>
</ul>
</li>
<li>
<p><strong>语义理解</strong>：</p>
<ul>
<li>任务目标拆解（"买书" → 搜索 → 选择 → 购买）</li>
<li>近义词匹配（"明朝那些事" ≈ "明朝那些事儿"）</li>
<li>上下文连贯性（记住用户指定的书名）</li>
</ul>
</li>
<li>
<p><strong>逻辑推理</strong>：</p>
<ul>
<li>判断任务完成度</li>
<li>识别阻碍因素（弹窗）</li>
<li>决定何时询问用户、何时停止操作</li>
</ul>
</li>
</ol>
<h3 data-id="heading-47">4.2 安全性设计</h3>
<ol>
<li>
<p><strong>敏感操作保护</strong>：</p>
<ul>
<li>在支付前停止，不执行金融交易</li>
<li>使用 COMPLETE 动作汇报结果，由用户确认</li>
</ul>
</li>
<li>
<p><strong>完全本地化</strong>：</p>
<ul>
<li>所有推理在本地完成</li>
<li>截图和日志存储在本地</li>
<li>无需网络传输用户数据</li>
</ul>
</li>
<li>
<p><strong>轨迹可追溯</strong>：</p>
<ul>
<li>每一步操作都有完整日志</li>
<li>包含模型思考过程（CoT）</li>
<li>可通过 Streamlit 可视化查看</li>
</ul>
</li>
</ol>
<h3 data-id="heading-48">4.3 工程化设计</h3>
<ol>
<li>
<p><strong>模块化架构</strong>：</p>
<ul>
<li>Server 层、Client 层、Frontend 层分离</li>
<li>易于扩展和维护</li>
</ul>
</li>
<li>
<p><strong>日志系统</strong>：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"session_id"</span>: <span class="hljs-string">"唯一标识"</span>,
    <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"时间戳"</span>,
    <span class="hljs-string">"message"</span>: {
        <span class="hljs-string">"environment"</span>: {
            <span class="hljs-string">"image"</span>: <span class="hljs-string">"截图路径"</span>,
            <span class="hljs-string">"user_comment"</span>: <span class="hljs-string">"用户反馈"</span>
        },
        <span class="hljs-string">"action"</span>: {
            <span class="hljs-string">"cot"</span>: <span class="hljs-string">"思考过程"</span>,
            <span class="hljs-string">"explain"</span>: <span class="hljs-string">"动作解释"</span>,
            <span class="hljs-string">"action"</span>: <span class="hljs-string">"动作类型"</span>,
            ...
        },
        <span class="hljs-string">"llm_cost"</span>: {
            <span class="hljs-string">"llm_time"</span>: <span class="hljs-string">"推理耗时"</span>,
            ...
        }
    }
}
</code></pre>
</li>
<li>
<p><strong>可视化工具</strong>：</p>
<ul>
<li>Streamlit Web 界面</li>
<li>展示完整执行轨迹</li>
<li>在截图上标记操作点位</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-49">五、性能优化建议</h2>
<h3 data-id="heading-50">5.1 推理速度优化</h3>
<p><strong>当前瓶颈</strong>：平均每步 ~21 秒</p>
<p><strong>优化方案</strong>：</p>
<ol>
<li>
<p><strong>模型量化（关键！）</strong>：
实测发现，在 Apple M3 Pro (18GB RAM) 等中端配置上，直接运行 FP16 模型可能导致内存溢出甚至系统卡死。<strong>强烈建议使用 Int8 或 Int4 量化版本</strong>。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># INT8 量化（本案例使用，兼顾速度与精度，适合 16GB+ 内存）</span>
ollama create -q q8_0 gelab-zero-4b-preview

<span class="hljs-comment"># INT4 量化（速度最快，适合 8GB/12GB 内存）</span>
ollama create -q Q4_K_M gelab-zero-4b-preview
</code></pre>
</li>
<li>
<p><strong>图像尺寸调整</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"resize_config"</span>: {
    <span class="hljs-string">"is_resize"</span>: <span class="hljs-literal">True</span>,
    <span class="hljs-string">"target_image_size"</span>: (<span class="hljs-number">756</span>, <span class="hljs-number">756</span>)  <span class="hljs-comment"># 降低分辨率</span>
}
</code></pre>
</li>
<li>
<p><strong>硬件升级（立竿见影）</strong>：
如果预算允许，升级硬件是提升体验最直接的方式：</p>
<ul>
<li><strong>Apple Silicon 用户</strong>：建议使用 M3 Max / M4 Max 芯片（配备 36GB+ 统一内存），可流畅运行 FP16 原版模型，推理延迟有望降低至 <strong>3-5秒/步</strong>。</li>
<li><strong>NVIDIA GPU 用户</strong>：使用 RTX 4090 (24GB) 或 A100 (40GB/80GB) 部署，结合 vLLM 推理加速框架，可实现亚秒级响应。</li>
</ul>
</li>
<li>
<p><strong>批处理推理</strong>：</p>
<ul>
<li>对于多设备任务，使用批处理提升吞吐量</li>
</ul>
</li>
</ol>
<h3 data-id="heading-51">5.2 准确性提升</h3>
<ol>
<li>
<p><strong>温度参数调整</strong>：</p>
<ul>
<li>当前：0.1（偏保守）</li>
<li>建议：0.0（完全确定性）或 0.05（平衡）</li>
</ul>
</li>
<li>
<p><strong>Prompt 优化</strong>：</p>
<ul>
<li>增加任务相关的示例</li>
<li>细化动作空间的描述</li>
</ul>
</li>
<li>
<p><strong>多模态融合</strong>：</p>
<ul>
<li>结合 OCR 提取文字</li>
<li>使用 UI 层次结构信息</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-52">六、应用场景拓展</h2>
<h3 data-id="heading-53">6.1 个人助手场景</h3>
<ul>
<li><strong>购物助手</strong>：比价、下单、跟踪物流</li>
<li><strong>出行助手</strong>：打车、订票、导航</li>
<li><strong>社交助手</strong>：自动回复、消息转发</li>
</ul>
<h3 data-id="heading-54">6.2 企业应用场景</h3>
<ul>
<li><strong>自动化测试</strong>：App UI 自动化测试</li>
<li><strong>数据采集</strong>：竞品分析、价格监控</li>
<li><strong>RPA</strong>：重复性任务自动化</li>
</ul>
<h3 data-id="heading-55">6.3 研究方向</h3>
<ul>
<li><strong>多设备协同</strong>：同时控制多台手机</li>
<li><strong>长期记忆</strong>：跨 Session 的任务记忆</li>
<li><strong>多模态输入</strong>：语音指令、手势控制</li>
</ul>
<hr/>
<h2 data-id="heading-56">七、总结与展望</h2>
<h3 data-id="heading-57">7.1 核心优势：为什么是 GELab-Zero？</h3>
<ol>
<li><strong>工程基建的胜利</strong>：覆盖主流 Android 9+ 及 RAM 4GB 以上设备。通过完整的推理工程基建，解决了多设备 ADB 连接、依赖安装等繁琐流程，让开发者从"脏活累活"中解放出来。</li>
<li><strong>隐私与安全的平衡</strong>：类似于豆包手机助手的端侧持久记忆理念，GELab-Zero 坚持完全本地化运行，所有数据在本地闭环，规避了云端隐私泄露风险。</li>
<li><strong>真实场景的打磨</strong>：基于 <strong>AndroidDaily</strong> 自建评测基准，聚焦现代生活六大核心维度（食、行、购、住、讯、娱），在真实复杂任务中（如跨 App 比价、多商品采购）准确率达到 <strong>73.4%</strong>。</li>
</ol>
<h3 data-id="heading-58">7.2 行业发展趋势</h3>
<p>随着 2025 年末端侧 AI 的集中爆发，未来几年我们将看到以下趋势：</p>
<ol>
<li><strong>技术融合</strong>：端侧模型参数将持续增长，3B/4B 模型通过蒸馏技术将逼近 8B 通用模型效果。硬件上，NPU 的普及和存内计算技术将进一步降低功耗。</li>
<li><strong>交互变革</strong>：从单一的触控交互向<strong>语音+视觉+意图理解</strong>的多模态交互演进。正如豆包与中兴的合作所示，系统级入口（侧边键、耳机唤醒）将成为兵家必争之地。</li>
<li><strong>主动服务</strong>：AI 将从"被动工具"转向"主动助理"。具备长期记忆能力的 Agent 将能记住用户的偏好（如"帮我整理下周行程"），并在合适的时机主动提供服务（如"自动比价并领券"）。</li>
</ol>
<h3 data-id="heading-59">7.3 结语：商业闭环与开源价值的思考</h3>
<p>虽然从商业化成熟度和用户体验来看，<strong>豆包手机助手</strong>凭借与手机厂商的系统级深度绑定（如中兴 Nubia），在保活能力、权限获取和交互便捷性上占据了绝对优势，这代表了"极致产品体验"的方向。</p>
<p>但 <strong>GELab-Zero</strong> 的开源价值恰恰在于其<strong>独立性与普惠性</strong>：</p>
<ol>
<li><strong>技术民主化</strong>：它证明了不依赖手机厂商的系统级后门（Backdoor）或特权 API，仅凭纯视觉方案（Visual-based），也能在通用 Android 设备上实现高可用性的 Agent。这为非手机厂商的开发者打开了一扇窗。</li>
<li><strong>隐私底线</strong>：在巨头们纷纷将数据上传云端进行"混合计算"的当下，GELab-Zero 坚守的"全本地推理"（Local Inference）为医疗、金融等高敏感场景提供了一个可信的替代方案。</li>
<li><strong>标准定义者</strong>：它所定义的 ActTree 动作空间、AndroidDaily 评测标准，极有可能成为未来移动端 Agent 开发的行业事实标准。</li>
</ol>
<p>如果说豆包是 iOS 式的封闭花园精品，那么 GELab-Zero 正致力于成为移动端 Agent 时代的 Android——虽然粗糙，但充满无限可能。对于开发者而言，它提供了一个绝佳的实验平台，让你现在就能在自己的电脑和手机上，构建出能够理解世界、操作应用的下一代 AI Agent。</p>
<hr/>
<h2 data-id="heading-60">八、参考资料</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstepfun-ai%2Fgelab-zero" target="_blank" title="https://github.com/stepfun-ai/gelab-zero" ref="nofollow noopener noreferrer">github.com/stepfun-ai/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fstepfun-ai%2FGELab-Zero-4B-preview" target="_blank" title="https://huggingface.co/stepfun-ai/GELab-Zero-4B-preview" ref="nofollow noopener noreferrer">huggingface.co/stepfun-ai/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fmodels%2FQwen%2FQwen3-VL-4B-Instruct" target="_blank" title="https://www.modelscope.cn/models/Qwen/Qwen3-VL-4B-Instruct" ref="nofollow noopener noreferrer">www.modelscope.cn/models/Qwen…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2Fstepfun-ai%2FAndroidDaily" target="_blank" title="https://huggingface.co/datasets/stepfun-ai/AndroidDaily" ref="nofollow noopener noreferrer">huggingface.co/datasets/st…</a></li>
<li><strong>论文</strong>：GUI Exploration Lab: Enhancing Screen Navigation in Agents via Multi-Turn Reinforcement Learning (NeurIPS 2025)</li>
<li><a href="https://juejin.cn/post/7579088065697611816" target="_blank" title="https://juejin.cn/post/7579088065697611816">juejin.cn/post/757908…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DeoY4EIcbFck" target="_blank" title="https://www.youtube.com/watch?v=eoY4EIcbFck" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=eoY…</a></li>
</ol>
<hr/>
<h2 data-id="heading-61">附录：</h2>
<h3 data-id="heading-62">A.1 单任务执行脚本</h3>
<pre><code class="hljs language-python" lang="python">项目中的示例：
python examples/run_single_task.py
</code></pre>
<h3 data-id="heading-63">A.2 轨迹可视化启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 仅本机访问</span>
streamlit run --server.address 127.0.0.1 --server.port 33503 --server.headless <span class="hljs-literal">true</span> visualization/main_page.py

<span class="hljs-comment"># 局域网访问</span>
streamlit run --server.address 0.0.0.0 --server.port 33503 --server.headless <span class="hljs-literal">true</span> visualization/main_page.py
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从概念开始开始C++管道编程]]></title>    <link>https://juejin.cn/post/7584287969214054419</link>    <guid>https://juejin.cn/post/7584287969214054419</guid>    <pubDate>2025-12-16T11:07:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584287969214054419" data-draft-id="7584295332339695679" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从概念开始开始C++管道编程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T11:07:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从概念开始开始C++管道编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T11:07:33.000Z" title="Tue Dec 16 2025 11:07:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一章：管道编程的核心概念</h2>
<h3 data-id="heading-1">1.1 什么是管道？</h3>
<p><strong>管道</strong>是UNIX和类UNIX系统中最古老、最基础的进程间通信（IPC）机制之一。你可以将它想象成现实世界中的水管：数据像水流一样从一个进程"流"向另一个进程。</p>
<p><strong>核心特征</strong>：</p>
<ul>
<li><strong>半双工通信</strong>：数据只能单向流动（要么从A到B，要么从B到A）</li>
<li><strong>字节流导向</strong>：没有消息边界，数据是连续的字节流</li>
<li><strong>基于文件描述符</strong>：使用与文件操作相同的接口</li>
<li><strong>内核缓冲区</strong>：数据在内核缓冲区中暂存</li>
</ul>
<h3 data-id="heading-2">1.2 管道的工作原理</h3>
<p>让我们通过一个简单的比喻来理解管道的工作原理：</p>
<p>想象两个进程要通过管道通信：</p>
<pre><code class="hljs language-css" lang="css">进程<span class="hljs-selector-tag">A</span>（写端） → <span class="hljs-selector-attr">[内核缓冲区]</span> → 进程<span class="hljs-selector-tag">B</span>（读端）
</code></pre>
<p><strong>内核缓冲区的作用</strong>：</p>
<ol>
<li>当进程A写入数据时，数据先进入内核缓冲区</li>
<li>进程B从缓冲区读取数据</li>
<li>如果缓冲区空，读操作会阻塞（等待数据）</li>
<li>如果缓冲区满，写操作会阻塞（等待空间）</li>
</ol>
<p><strong>匿名管道的关键限制</strong>：</p>
<ul>
<li>只能用于有"亲缘关系"的进程间通信（通常是父子进程或兄弟进程）</li>
<li>生命周期随进程结束而结束</li>
<li>无法在无关进程间使用</li>
</ul>
<h2 data-id="heading-3">第二章：入门实践——创建第一个管道</h2>
<h3 data-id="heading-4">2.1 理解文件描述符</h3>
<p>在深入代码之前，必须理解<strong>文件描述符</strong>的概念：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 每个进程都有这三个标准文件描述符：</span>
<span class="hljs-comment">// 0 - 标准输入（stdin）   → 通常从键盘读取</span>
<span class="hljs-comment">// 1 - 标准输出（stdout）  → 通常输出到屏幕</span>
<span class="hljs-comment">// 2 - 标准错误（stderr）  → 错误信息输出</span>

<span class="hljs-comment">// 当创建管道时，系统会分配两个新的文件描述符：</span>
<span class="hljs-comment">// pipefd[0] - 用于读取的端</span>
<span class="hljs-comment">// pipefd[1] - 用于写入的端</span>
</code></pre>
<h3 data-id="heading-5">2.2 创建第一个管道程序</h3>
<p>让我们从最简单的例子开始：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>   <span class="hljs-comment">// pipe(), fork(), read(), write()</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>   <span class="hljs-comment">// strlen()</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span> <span class="hljs-comment">// wait()</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];  <span class="hljs-comment">// 管道文件描述符数组</span>
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];
    
    <span class="hljs-comment">// 步骤1：创建管道</span>
    <span class="hljs-comment">// pipe() 返回0表示成功，-1表示失败</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">-1</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">"管道创建失败"</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">// 步骤2：创建子进程</span>
    <span class="hljs-type">pid_t</span> pid = fork();
    
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>) {
        std::cerr &lt;&lt; <span class="hljs-string">"进程创建失败"</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 子进程代码</span>
        <span class="hljs-comment">// 关闭不需要的写端</span>
        <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">1</span>]);
        
        <span class="hljs-comment">// 从管道读取数据</span>
        <span class="hljs-type">int</span> bytes_read = <span class="hljs-built_in">read</span>(pipefd[<span class="hljs-number">0</span>], buffer, <span class="hljs-built_in">sizeof</span>(buffer));
        <span class="hljs-keyword">if</span> (bytes_read &gt; <span class="hljs-number">0</span>) {
            std::cout &lt;&lt; <span class="hljs-string">"子进程收到: "</span> &lt;&lt; buffer &lt;&lt; std::endl;
        }
        
        <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 父进程代码</span>
        <span class="hljs-comment">// 关闭不需要的读端</span>
        <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">0</span>]);
        
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* message = <span class="hljs-string">"Hello from parent!"</span>;
        
        <span class="hljs-comment">// 向管道写入数据</span>
        <span class="hljs-built_in">write</span>(pipefd[<span class="hljs-number">1</span>], message, <span class="hljs-built_in">strlen</span>(message));
        
        <span class="hljs-comment">// 关闭写端，表示数据发送完毕</span>
        <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">1</span>]);
        
        <span class="hljs-comment">// 等待子进程结束</span>
        <span class="hljs-built_in">wait</span>(<span class="hljs-literal">nullptr</span>);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-6">2.3 关键原理分析</h3>
<p><strong>为什么需要关闭不用的描述符？</strong></p>
<ol>
<li><strong>资源管理</strong>：每个进程都有文件描述符限制，及时关闭避免泄漏</li>
<li><strong>正确终止</strong>：读进程需要知道何时没有更多数据
<ul>
<li>所有写端关闭 → 读端返回0（EOF）</li>
<li>否则读端会一直等待</li>
</ul>
</li>
</ol>
<p><strong>管道的阻塞行为</strong>：</p>
<ul>
<li><strong>读阻塞</strong>：当管道空且仍有写端打开时，读操作会阻塞</li>
<li><strong>写阻塞</strong>：当管道满（默认64KB），写操作会阻塞</li>
<li><strong>非阻塞模式</strong>：可以通过fcntl()设置O_NONBLOCK</li>
</ul>
<h2 data-id="heading-7">第三章：中级应用——双向通信与复杂管道</h2>
<h3 data-id="heading-8">3.1 实现双向通信</h3>
<p>单个管道只能单向通信，要实现双向通信，我们需要两个管道：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BidirectionalPipe</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> parent_to_child[<span class="hljs-number">2</span>];  <span class="hljs-comment">// 父→子管道</span>
    <span class="hljs-type">int</span> child_to_parent[<span class="hljs-number">2</span>];  <span class="hljs-comment">// 子→父管道</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">BidirectionalPipe</span>() {
        <span class="hljs-comment">// 创建两个管道</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(parent_to_child) == <span class="hljs-number">-1</span> || <span class="hljs-built_in">pipe</span>(child_to_parent) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"管道创建失败"</span>);
        }
    }
    
    ~<span class="hljs-built_in">BidirectionalPipe</span>() {
        <span class="hljs-built_in">closeAll</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">parentWrite</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message)</span> </span>{
        <span class="hljs-built_in">write</span>(parent_to_child[<span class="hljs-number">1</span>], message.<span class="hljs-built_in">c_str</span>(), message.<span class="hljs-built_in">length</span>());
    }
    
    <span class="hljs-function">std::string <span class="hljs-title">parentRead</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">char</span> buffer[<span class="hljs-number">256</span>];
        <span class="hljs-type">int</span> n = <span class="hljs-built_in">read</span>(child_to_parent[<span class="hljs-number">0</span>], buffer, <span class="hljs-built_in">sizeof</span>(buffer)<span class="hljs-number">-1</span>);
        <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) {
            buffer[n] = <span class="hljs-string">'\0'</span>;
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(buffer);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">childWrite</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message)</span> </span>{
        <span class="hljs-built_in">write</span>(child_to_parent[<span class="hljs-number">1</span>], message.<span class="hljs-built_in">c_str</span>(), message.<span class="hljs-built_in">length</span>());
    }
    
    <span class="hljs-function">std::string <span class="hljs-title">childRead</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">char</span> buffer[<span class="hljs-number">256</span>];
        <span class="hljs-type">int</span> n = <span class="hljs-built_in">read</span>(parent_to_child[<span class="hljs-number">0</span>], buffer, <span class="hljs-built_in">sizeof</span>(buffer)<span class="hljs-number">-1</span>);
        <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) {
            buffer[n] = <span class="hljs-string">'\0'</span>;
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(buffer);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">closeParentSide</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">close</span>(parent_to_child[<span class="hljs-number">1</span>]);  <span class="hljs-comment">// 关闭父进程的写端</span>
        <span class="hljs-built_in">close</span>(child_to_parent[<span class="hljs-number">0</span>]);  <span class="hljs-comment">// 关闭父进程的读端</span>
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">closeChildSide</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">close</span>(parent_to_child[<span class="hljs-number">0</span>]);  <span class="hljs-comment">// 关闭子进程的读端</span>
        <span class="hljs-built_in">close</span>(child_to_parent[<span class="hljs-number">1</span>]);  <span class="hljs-comment">// 关闭子进程的写端</span>
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">closeAll</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">close</span>(parent_to_child[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">close</span>(parent_to_child[<span class="hljs-number">1</span>]);
        <span class="hljs-built_in">close</span>(child_to_parent[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">close</span>(child_to_parent[<span class="hljs-number">1</span>]);
    }
};
</code></pre>
<h3 data-id="heading-9">3.2 管道链的实现</h3>
<p>管道链是UNIX shell中<code>|</code>操作符的基础，让我们实现一个简单的版本：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;array&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Pipeline</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 存储多个命令</span>
    std::vector&lt;std::vector&lt;std::string&gt;&gt; commands;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addCommand</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;std::string&gt;&amp; cmd)</span> </span>{
        commands.<span class="hljs-built_in">push_back</span>(cmd);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span> </span>{
        std::vector&lt;<span class="hljs-type">int</span>&gt; prev_pipe_read;  <span class="hljs-comment">// 前一个管道的读端</span>
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; commands.<span class="hljs-built_in">size</span>(); ++i) {
            <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
            
            <span class="hljs-comment">// 如果不是最后一个命令，创建管道</span>
            <span class="hljs-keyword">if</span> (i &lt; commands.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"管道创建失败"</span>);
                }
            }
            
            <span class="hljs-type">pid_t</span> pid = fork();
            
            <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 子进程代码</span>
                
                <span class="hljs-comment">// 设置输入重定向（从上一个管道读取）</span>
                <span class="hljs-keyword">if</span> (!prev_pipe_read.<span class="hljs-built_in">empty</span>()) {
                    <span class="hljs-built_in">dup2</span>(prev_pipe_read[<span class="hljs-number">0</span>], STDIN_FILENO);
                    <span class="hljs-built_in">close</span>(prev_pipe_read[<span class="hljs-number">0</span>]);
                }
                
                <span class="hljs-comment">// 设置输出重定向（写入下一个管道）</span>
                <span class="hljs-keyword">if</span> (i &lt; commands.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) {
                    <span class="hljs-built_in">dup2</span>(pipefd[<span class="hljs-number">1</span>], STDOUT_FILENO);
                    <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">0</span>]);
                    <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">1</span>]);
                }
                
                <span class="hljs-comment">// 准备exec参数</span>
                std::vector&lt;<span class="hljs-type">char</span>*&gt; args;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; arg : commands[i]) {
                    args.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(arg.<span class="hljs-built_in">c_str</span>()));
                }
                args.<span class="hljs-built_in">push_back</span>(<span class="hljs-literal">nullptr</span>);
                
                <span class="hljs-comment">// 执行命令</span>
                <span class="hljs-built_in">execvp</span>(args[<span class="hljs-number">0</span>], args.<span class="hljs-built_in">data</span>());
                
                <span class="hljs-comment">// exec失败才执行到这里</span>
                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 父进程代码</span>
                
                <span class="hljs-comment">// 关闭不再需要的描述符</span>
                <span class="hljs-keyword">if</span> (!prev_pipe_read.<span class="hljs-built_in">empty</span>()) {
                    <span class="hljs-built_in">close</span>(prev_pipe_read[<span class="hljs-number">0</span>]);
                }
                
                <span class="hljs-keyword">if</span> (i &lt; commands.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>) {
                    <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">1</span>]);  <span class="hljs-comment">// 父进程不需要写端</span>
                    prev_pipe_read = {pipefd[<span class="hljs-number">0</span>]};  <span class="hljs-comment">// 保存读端用于下一个进程</span>
                }
            }
        }
        
        <span class="hljs-comment">// 父进程等待所有子进程</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; commands.<span class="hljs-built_in">size</span>(); ++i) {
            <span class="hljs-built_in">wait</span>(<span class="hljs-literal">nullptr</span>);
        }
    }
};

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    Pipeline pipeline;
    
    <span class="hljs-comment">// 模拟: ls -l | grep ".cpp" | wc -l</span>
    pipeline.<span class="hljs-built_in">addCommand</span>({<span class="hljs-string">"ls"</span>, <span class="hljs-string">"-l"</span>});
    pipeline.<span class="hljs-built_in">addCommand</span>({<span class="hljs-string">"grep"</span>, <span class="hljs-string">"\\.cpp"</span>});
    pipeline.<span class="hljs-built_in">addCommand</span>({<span class="hljs-string">"wc"</span>, <span class="hljs-string">"-l"</span>});
    
    pipeline.<span class="hljs-built_in">execute</span>();
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-10">3.3 命名管道（FIFO）的深入理解</h3>
<p><strong>命名管道与匿名管道的区别</strong>：</p>






























<table><thead><tr><th>特性</th><th>匿名管道</th><th>命名管道（FIFO）</th></tr></thead><tbody><tr><td>持久性</td><td>进程结束即消失</td><td>文件系统中有实体文件</td></tr><tr><td>进程关系</td><td>必须有亲缘关系</td><td>任意进程都可访问</td></tr><tr><td>创建方式</td><td>pipe()系统调用</td><td>mkfifo()函数</td></tr><tr><td>访问控制</td><td>基于文件描述符继承</td><td>基于文件权限</td></tr></tbody></table>
<p><strong>创建和使用命名管道</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NamedPipe</span> {
<span class="hljs-keyword">private</span>:
    std::string path;
    <span class="hljs-type">int</span> fd;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">NamedPipe</span>(<span class="hljs-type">const</span> std::string&amp; pipePath) : <span class="hljs-built_in">path</span>(pipePath) {
        <span class="hljs-comment">// 创建命名管道（如果不存在）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">mkfifo</span>(path.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0666</span>) == <span class="hljs-number">-1</span>) {
            <span class="hljs-comment">// 如果已存在，忽略EEXIST错误</span>
            <span class="hljs-keyword">if</span> (errno != EEXIST) {
                <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"无法创建命名管道"</span>);
            }
        }
    }
    
    <span class="hljs-comment">// 作为读取者打开</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">openForReading</span><span class="hljs-params">(<span class="hljs-type">bool</span> nonblock = <span class="hljs-literal">false</span>)</span> </span>{
        <span class="hljs-type">int</span> flags = O_RDONLY;
        <span class="hljs-keyword">if</span> (nonblock) flags |= O_NONBLOCK;
        
        fd = <span class="hljs-built_in">open</span>(path.<span class="hljs-built_in">c_str</span>(), flags);
        <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"无法打开命名管道进行读取"</span>);
        }
    }
    
    <span class="hljs-comment">// 作为写入者打开</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">openForWriting</span><span class="hljs-params">(<span class="hljs-type">bool</span> nonblock = <span class="hljs-literal">false</span>)</span> </span>{
        <span class="hljs-type">int</span> flags = O_WRONLY;
        <span class="hljs-keyword">if</span> (nonblock) flags |= O_NONBLOCK;
        
        fd = <span class="hljs-built_in">open</span>(path.<span class="hljs-built_in">c_str</span>(), flags);
        <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"无法打开命名管道进行写入"</span>);
        }
    }
    
    <span class="hljs-comment">// 读取数据</span>
    <span class="hljs-function">std::string <span class="hljs-title">readData</span><span class="hljs-params">(<span class="hljs-type">size_t</span> max_size = <span class="hljs-number">1024</span>)</span> </span>{
        <span class="hljs-type">char</span> buffer[max_size];
        <span class="hljs-type">ssize_t</span> bytes = <span class="hljs-built_in">read</span>(fd, buffer, max_size - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span> (bytes &gt; <span class="hljs-number">0</span>) {
            buffer[bytes] = <span class="hljs-string">'\0'</span>;
            <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">string</span>(buffer);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
    
    <span class="hljs-comment">// 写入数据</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">writeData</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; data)</span> </span>{
        <span class="hljs-built_in">write</span>(fd, data.<span class="hljs-built_in">c_str</span>(), data.<span class="hljs-built_in">length</span>());
    }
    
    ~<span class="hljs-built_in">NamedPipe</span>() {
        <span class="hljs-keyword">if</span> (fd != <span class="hljs-number">-1</span>) {
            <span class="hljs-built_in">close</span>(fd);
        }
        <span class="hljs-comment">// 可以选择是否删除管道文件</span>
        <span class="hljs-comment">// unlink(path.c_str());</span>
    }
};
</code></pre>
<h2 data-id="heading-11">第四章：高级主题——性能与并发</h2>
<h3 data-id="heading-12">4.1 非阻塞管道操作</h3>
<p>非阻塞管道在某些场景下非常有用，比如同时监控多个管道：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NonBlockingPipe</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">NonBlockingPipe</span>() {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"管道创建失败"</span>);
        }
        
        <span class="hljs-comment">// 设置为非阻塞模式</span>
        <span class="hljs-built_in">setNonBlocking</span>(pipefd[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">setNonBlocking</span>(pipefd[<span class="hljs-number">1</span>]);
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setNonBlocking</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> </span>{
        <span class="hljs-type">int</span> flags = <span class="hljs-built_in">fcntl</span>(fd, F_GETFL, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span> (flags == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"获取文件状态失败"</span>);
        }
        
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fcntl</span>(fd, F_SETFL, flags | O_NONBLOCK) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"设置非阻塞模式失败"</span>);
        }
    }
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 非阻塞读取</span>
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">tryRead</span><span class="hljs-params">(std::string&amp; result)</span> </span>{
        <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
        <span class="hljs-type">ssize_t</span> bytes = <span class="hljs-built_in">read</span>(pipefd[<span class="hljs-number">0</span>], buffer, <span class="hljs-built_in">sizeof</span>(buffer) - <span class="hljs-number">1</span>);
        
        <span class="hljs-keyword">if</span> (bytes &gt; <span class="hljs-number">0</span>) {
            buffer[bytes] = <span class="hljs-string">'\0'</span>;
            result = buffer;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bytes == <span class="hljs-number">-1</span> &amp;&amp; errno == EAGAIN) {
            <span class="hljs-comment">// 没有数据可读（非阻塞模式）</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 错误或EOF</span>
    }
};
</code></pre>
<h3 data-id="heading-13">4.2 使用select实现多路复用</h3>
<p>当需要同时监控多个管道时，select是一个非常有效的工具：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PipeMonitor</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;<span class="hljs-type">int</span>&gt; read_fds;  <span class="hljs-comment">// 需要监控的读描述符</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addPipe</span><span class="hljs-params">(<span class="hljs-type">int</span> read_fd)</span> </span>{
        read_fds.<span class="hljs-built_in">push_back</span>(read_fd);
    }
    
    <span class="hljs-comment">// 监控所有管道，返回有数据可读的管道列表</span>
    <span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">monitor</span><span class="hljs-params">(<span class="hljs-type">int</span> timeout_sec = <span class="hljs-number">0</span>)</span> </span>{
        fd_set read_set;
        <span class="hljs-built_in">FD_ZERO</span>(&amp;read_set);
        
        <span class="hljs-type">int</span> max_fd = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> fd : read_fds) {
            <span class="hljs-built_in">FD_SET</span>(fd, &amp;read_set);
            <span class="hljs-keyword">if</span> (fd &gt; max_fd) max_fd = fd;
        }
        
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">timeval</span> timeout;
        timeout.tv_sec = timeout_sec;
        timeout.tv_usec = <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 使用select等待数据</span>
        <span class="hljs-type">int</span> ready = <span class="hljs-built_in">select</span>(max_fd + <span class="hljs-number">1</span>, &amp;read_set, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, 
                          timeout_sec &gt;= <span class="hljs-number">0</span> ? &amp;timeout : <span class="hljs-literal">nullptr</span>);
        
        std::vector&lt;<span class="hljs-type">int</span>&gt; ready_fds;
        <span class="hljs-keyword">if</span> (ready &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> fd : read_fds) {
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">FD_ISSET</span>(fd, &amp;read_set)) {
                    ready_fds.<span class="hljs-built_in">push_back</span>(fd);
                }
            }
        }
        
        <span class="hljs-keyword">return</span> ready_fds;
    }
};
</code></pre>
<h3 data-id="heading-14">4.3 零拷贝技术：splice()</h3>
<p>Linux提供了高级的系统调用来优化管道性能，避免不必要的数据拷贝：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HighPerformancePipe</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">HighPerformancePipe</span>() {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"管道创建失败"</span>);
        }
    }
    
    <span class="hljs-comment">// 使用splice实现零拷贝数据传输</span>
    <span class="hljs-comment">// 将数据从一个文件描述符直接移动到管道</span>
    <span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">transferFrom</span><span class="hljs-params">(<span class="hljs-type">int</span> source_fd, <span class="hljs-type">size_t</span> len)</span> </span>{
        <span class="hljs-comment">// splice从source_fd读取数据，直接写入管道</span>
        <span class="hljs-comment">// 避免了用户空间的内存拷贝</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">splice</span>(source_fd, <span class="hljs-literal">nullptr</span>,        <span class="hljs-comment">// 源文件描述符</span>
                     pipefd[<span class="hljs-number">1</span>], <span class="hljs-literal">nullptr</span>,         <span class="hljs-comment">// 目标管道写端</span>
                     len,                        <span class="hljs-comment">// 传输长度</span>
                     SPLICE_F_MOVE | SPLICE_F_MORE);
    }
    
    <span class="hljs-comment">// 将数据从管道直接传输到目标文件描述符</span>
    <span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">transferTo</span><span class="hljs-params">(<span class="hljs-type">int</span> dest_fd, <span class="hljs-type">size_t</span> len)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">splice</span>(pipefd[<span class="hljs-number">0</span>], <span class="hljs-literal">nullptr</span>,        <span class="hljs-comment">// 源管道读端</span>
                     dest_fd, <span class="hljs-literal">nullptr</span>,          <span class="hljs-comment">// 目标文件描述符</span>
                     len,
                     SPLICE_F_MOVE | SPLICE_F_MORE);
    }
};
</code></pre>
<h2 data-id="heading-15">第五章：最佳实践与错误处理</h2>
<h3 data-id="heading-16">5.1 RAII包装器</h3>
<p>为了避免资源泄漏，使用RAII（资源获取即初始化）模式管理管道：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PipeRAII</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
    <span class="hljs-type">bool</span> valid;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">PipeRAII</span>() : <span class="hljs-built_in">valid</span>(<span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">0</span>) {
            valid = <span class="hljs-literal">true</span>;
        }
    }
    
    ~<span class="hljs-built_in">PipeRAII</span>() {
        <span class="hljs-keyword">if</span> (valid) {
            <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">0</span>]);
            <span class="hljs-built_in">close</span>(pipefd[<span class="hljs-number">1</span>]);
        }
    }
    
    <span class="hljs-comment">// 删除拷贝构造函数和赋值运算符</span>
    <span class="hljs-built_in">PipeRAII</span>(<span class="hljs-type">const</span> PipeRAII&amp;) = <span class="hljs-keyword">delete</span>;
    PipeRAII&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> PipeRAII&amp;) = <span class="hljs-keyword">delete</span>;
    
    <span class="hljs-comment">// 允许移动语义</span>
    <span class="hljs-built_in">PipeRAII</span>(PipeRAII&amp;&amp; other) <span class="hljs-keyword">noexcept</span> 
        : pipefd{other.pipefd[<span class="hljs-number">0</span>], other.pipefd[<span class="hljs-number">1</span>]}, 
          <span class="hljs-built_in">valid</span>(other.valid) {
        other.valid = <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">readEnd</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> valid ? pipefd[<span class="hljs-number">0</span>] : <span class="hljs-number">-1</span>; }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">writeEnd</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> valid ? pipefd[<span class="hljs-number">1</span>] : <span class="hljs-number">-1</span>; }
    
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-keyword">operator</span> <span class="hljs-title">bool</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> valid; }
};

<span class="hljs-comment">// 使用智能指针管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafePipeManager</span> {
<span class="hljs-keyword">private</span>:
    std::unique_ptr&lt;PipeRAII&gt; pipe;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">SafePipeManager</span>() : <span class="hljs-built_in">pipe</span>(std::<span class="hljs-built_in">make_unique</span>&lt;PipeRAII&gt;()) {
        <span class="hljs-keyword">if</span> (!*pipe) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"管道创建失败"</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sendData</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; data)</span> </span>{
        <span class="hljs-keyword">if</span> (pipe) {
            <span class="hljs-built_in">write</span>(pipe-&gt;<span class="hljs-built_in">writeEnd</span>(), data.<span class="hljs-built_in">c_str</span>(), data.<span class="hljs-built_in">length</span>());
        }
    }
};
</code></pre>
<h3 data-id="heading-17">5.2 常见错误与处理</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RobustPipe</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
    
    <span class="hljs-comment">// 安全读取函数</span>
    <span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">safeRead</span><span class="hljs-params">(<span class="hljs-type">void</span>* buf, <span class="hljs-type">size_t</span> count)</span> </span>{
        <span class="hljs-type">ssize_t</span> bytes_read;
        <span class="hljs-keyword">do</span> {
            bytes_read = <span class="hljs-built_in">read</span>(pipefd[<span class="hljs-number">0</span>], buf, count);
        } <span class="hljs-keyword">while</span> (bytes_read == <span class="hljs-number">-1</span> &amp;&amp; errno == EINTR);  <span class="hljs-comment">// 处理信号中断</span>
        
        <span class="hljs-keyword">return</span> bytes_read;
    }
    
    <span class="hljs-comment">// 安全写入函数</span>
    <span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">safeWrite</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* buf, <span class="hljs-type">size_t</span> count)</span> </span>{
        <span class="hljs-type">ssize_t</span> bytes_written;
        <span class="hljs-type">size_t</span> total_written = <span class="hljs-number">0</span>;
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* ptr = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(buf);
        
        <span class="hljs-keyword">while</span> (total_written &lt; count) {
            <span class="hljs-keyword">do</span> {
                bytes_written = <span class="hljs-built_in">write</span>(pipefd[<span class="hljs-number">1</span>], ptr + total_written, 
                                     count - total_written);
            } <span class="hljs-keyword">while</span> (bytes_written == <span class="hljs-number">-1</span> &amp;&amp; errno == EINTR);
            
            <span class="hljs-keyword">if</span> (bytes_written == <span class="hljs-number">-1</span>) {
                <span class="hljs-comment">// 处理真正的错误</span>
                <span class="hljs-keyword">if</span> (errno == EPIPE) {
                    std::cerr &lt;&lt; <span class="hljs-string">"管道断裂：读端已关闭"</span> &lt;&lt; std::endl;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
            }
            
            total_written += bytes_written;
        }
        
        <span class="hljs-keyword">return</span> total_written;
    }
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">RobustPipe</span>() {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(pipefd) == <span class="hljs-number">-1</span>) {
            <span class="hljs-comment">// 检查具体错误</span>
            <span class="hljs-keyword">switch</span> (errno) {
                <span class="hljs-keyword">case</span> EMFILE:
                    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"进程文件描述符耗尽"</span>);
                <span class="hljs-keyword">case</span> ENFILE:
                    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"系统文件描述符耗尽"</span>);
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"未知管道创建错误"</span>);
            }
        }
        
        <span class="hljs-comment">// 设置管道缓冲区大小（可选）</span>
        <span class="hljs-type">int</span> size = <span class="hljs-number">65536</span>;  <span class="hljs-comment">// 64KB</span>
        <span class="hljs-built_in">fcntl</span>(pipefd[<span class="hljs-number">0</span>], F_SETPIPE_SZ, size);
    }
};
</code></pre>
<h2 data-id="heading-18">第六章：实战应用案例</h2>
<h3 data-id="heading-19">6.1 日志收集系统</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;condition_variable&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogCollector</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> log_pipe[<span class="hljs-number">2</span>];
    std::queue&lt;std::string&gt; log_queue;
    std::mutex queue_mutex;
    std::condition_variable queue_cv;
    std::thread worker_thread;
    <span class="hljs-type">bool</span> running;
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">worker</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">char</span> buffer[<span class="hljs-number">4096</span>];
        
        <span class="hljs-keyword">while</span> (running) {
            <span class="hljs-type">ssize_t</span> bytes = <span class="hljs-built_in">read</span>(log_pipe[<span class="hljs-number">0</span>], buffer, <span class="hljs-built_in">sizeof</span>(buffer) - <span class="hljs-number">1</span>);
            
            <span class="hljs-keyword">if</span> (bytes &gt; <span class="hljs-number">0</span>) {
                buffer[bytes] = <span class="hljs-string">'\0'</span>;
                <span class="hljs-function">std::string <span class="hljs-title">log_entry</span><span class="hljs-params">(buffer)</span></span>;
                
                {
                    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(queue_mutex)</span></span>;
                    log_queue.<span class="hljs-built_in">push</span>(log_entry);
                }
                queue_cv.<span class="hljs-built_in">notify_one</span>();
            }
        }
    }
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">LogCollector</span>() : <span class="hljs-built_in">running</span>(<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(log_pipe) == <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"日志管道创建失败"</span>);
        }
        
        worker_thread = std::<span class="hljs-built_in">thread</span>(&amp;LogCollector::worker, <span class="hljs-keyword">this</span>);
    }
    
    ~<span class="hljs-built_in">LogCollector</span>() {
        running = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">close</span>(log_pipe[<span class="hljs-number">1</span>]);  <span class="hljs-comment">// 关闭写端，使读端退出</span>
        <span class="hljs-keyword">if</span> (worker_thread.<span class="hljs-built_in">joinable</span>()) {
            worker_thread.<span class="hljs-built_in">join</span>();
        }
        <span class="hljs-built_in">close</span>(log_pipe[<span class="hljs-number">0</span>]);
    }
    
    <span class="hljs-comment">// 写入日志</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message)</span> </span>{
        <span class="hljs-built_in">write</span>(log_pipe[<span class="hljs-number">1</span>], message.<span class="hljs-built_in">c_str</span>(), message.<span class="hljs-built_in">length</span>());
    }
    
    <span class="hljs-comment">// 获取日志（线程安全）</span>
    <span class="hljs-function">std::string <span class="hljs-title">getLog</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(queue_mutex)</span></span>;
        queue_cv.<span class="hljs-built_in">wait</span>(lock, [<span class="hljs-keyword">this</span>] { <span class="hljs-keyword">return</span> !log_queue.<span class="hljs-built_in">empty</span>(); });
        
        std::string log = log_queue.<span class="hljs-built_in">front</span>();
        log_queue.<span class="hljs-built_in">pop</span>();
        <span class="hljs-keyword">return</span> log;
    }
};
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>管道编程是C++系统编程的重要部分，掌握它需要：</p>
<ol>
<li><strong>理解基本原理</strong>：文件描述符、缓冲区、阻塞行为</li>
<li><strong>掌握核心API</strong>：pipe(), fork(), dup2(), read(), write()</li>
<li><strong>学会高级技术</strong>：非阻塞IO、多路复用、零拷贝</li>
<li><strong>遵循最佳实践</strong>：RAII管理、错误处理、资源清理</li>
</ol>
<p>管道不仅是一种技术，更是一种设计哲学——它鼓励我们创建模块化、可组合的程序，这正是UNIX哲学的核心理念之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code 1.107 更新：多智能体协同与开发体验升级]]></title>    <link>https://juejin.cn/post/7584307642999537707</link>    <guid>https://juejin.cn/post/7584307642999537707</guid>    <pubDate>2025-12-16T11:13:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307642999537707" data-draft-id="7584287969214070803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code 1.107 更新：多智能体协同与开发体验升级"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T11:13:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code 1.107 更新：多智能体协同与开发体验升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T11:13:08.000Z" title="Tue Dec 16 2025 11:13:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年 12 月 10 日，微软正式发布了 VS Code 1.107 版本，这次更新堪称年度最重磅！<strong>多智能体协同开发</strong>成为核心亮点，彻底重构了开发者与 AI 协作的模式。想象一下，你可以同时部署多个 AI 助手分工合作：一个负责代码审查，一个处理单元测试，还有一个在后台默默重构 legacy 代码——这不再是科幻场景！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52455df60c84e1f86b5d74f160b2dbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766488388&amp;x-signature=eNiPuTrnir8zmc9yYe7V5ZexRlY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">多智能体协同：开发效率的革命性突破</h2>
<h3 data-id="heading-1">Agent HQ：你的 AI 团队指挥中心</h3>
<p>VS Code 1.107 引入了全新的 <strong>Agent HQ</strong> 概念，将所有智能体统一管理。现在，GitHub Copilot 不再是孤军奋战，你可以创建、配置多个自定义智能体，并让它们协同完成复杂任务。</p>
<p>最惊艳的是 <strong>会话管理功能</strong>！所有智能体会话都整合到聊天视图中，你能一目了然地看到每个任务的状态、进度和文件更改统计。右键点击会话，还能选择在编辑器标签页或新窗口中打开，灵活度拉满。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cf7048587a944f4871619e7940eb0db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766488388&amp;x-signature=3yONxuXphV23qvW%2F%2FInRYHVFjNo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">背景智能体：让 AI 在后台默默干活</h3>
<p><strong>背景智能体</strong> 彻底改变了工作流！以前用 Copilot 时，你必须等待它完成当前任务才能继续工作。现在，只需点击 <strong>Continue in</strong> 按钮，就能将任务无缝转移到后台智能体，自己继续专注于其他编码工作。</p>
<p>更厉害的是 <strong>Git 工作树隔离</strong> 技术！每个背景智能体都能在独立的 Git 工作树中运行，多个智能体同时修改代码也不会冲突。完成后，你可以一键将更改合并回主工作区，简直是多任务处理的终极解决方案！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/597edcc556e942c685e12af746a53c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766488388&amp;x-signature=ley2Th5PgZStx67vL9F2T8YHUWA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">组织级智能体共享：团队协作新范式</h3>
<p>对于企业用户，1.107 版本带来了 <strong>组织级智能体共享</strong>（实验性功能）。管理员可以在 GitHub 组织级别定义智能体，团队成员无需手动导入就能直接使用。启用方法很简单：</p>
<ul>
<li>打开设置 <code>github.copilot.chat.customAgents.showOrganizationAndEnterpriseAgents</code></li>
<li>将其设为 <code>true</code></li>
</ul>
<p>从此，团队知识库、编码规范、最佳实践都能通过自定义智能体轻松传承，新人上手速度至少提升 50%！</p>
<h2 data-id="heading-4">聊天体验升级：AI 交互更自然</h2>
<h3 data-id="heading-5">语言模型管理：一键切换你的 "AI 大脑"</h3>
<p>面对越来越多的 AI 模型选择，VS Code 新增了 <strong>语言模型编辑器</strong>。在这里，你可以：</p>
<ul>
<li>查看所有可用模型的能力、上下文长度和计费信息</li>
<li>按提供商、能力（工具调用、视觉、智能体）筛选</li>
<li>隐藏不常用模型，让界面更清爽</li>
</ul>
<p>只需按下 <code>Ctrl+Shift+P</code> 并输入 <strong>Chat: Manage Language Models</strong>，就能打开这个强大的管理中心。</p>
<h3 data-id="heading-6">动态内容抓取：连 SPA 网站也能轻松解析</h3>
<p><code>#fetch</code> 工具现在支持 <strong>动态网页内容抓取</strong>！无论是 React、Vue 构建的单页应用，还是 Jira 这样的动态系统，都能准确获取内容。AI 现在能直接分析你公司的内部文档系统，回答问题不再局限于本地代码！</p>
<h3 data-id="heading-7">敏感文件编辑：安全与便捷的完美平衡</h3>
<p>修改 <code>package.json</code> 或 <code>settings.json</code> 这类敏感文件时，VS Code 会自动显示 <strong>差异对比视图</strong>，让你清晰看到每一处变更。再也不用担心 AI 误改配置导致项目崩溃了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d09085ede19746aba3d4ca78bf7ac859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766488388&amp;x-signature=Cl9QvjzYaYeW1hVQhVwlO93C3FQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">编辑器体验优化：细节之处见真章</h2>
<h3 data-id="heading-9">按需悬停提示：告别干扰，专注编码</h3>
<p>终于可以告别烦人的自动悬停提示了！在设置中将 <code>editor.hover.enabled</code> 设为 <code>onKeyboardModifier</code>，悬停信息只会在按住特定修饰键时才显示。默认情况下：</p>
<ul>
<li>如果多光标修饰键是 <code>Ctrl/Cmd</code>，则按住 <code>Alt</code> 显示悬停</li>
<li>如果多光标修饰键是 <code>Alt</code>，则按住 <code>Ctrl</code> 显示悬停</li>
</ul>
<p>这个小改进，却能让编码专注度提升一个档次！</p>
<h3 data-id="heading-10">TypeScript 7.0 预览：原生重构，性能飞跃</h3>
<p>VS Code 1.107 带来了 <strong>TypeScript 7.0 预览支持</strong>！这个完全用原生代码重写的版本，性能提升堪称革命性。目前已支持自动导入、重命名和引用代码透镜，安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3DTypeScriptTeam.native-preview" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=TypeScriptTeam.native-preview" ref="nofollow noopener noreferrer">TypeScript (Native Preview)</a> 扩展即可体验。</p>
<p>根据微软官方数据，TypeScript 7.0 的类型检查速度比 5.0 快 <strong>3-5 倍</strong>，大型项目的编译时间将大幅缩短！</p>
<h2 data-id="heading-11">终端增强：命令行效率倍增</h2>
<h3 data-id="heading-12">终端输出捕获：历史命令随时回溯</h3>
<p>现在，聊天中的终端命令输出会完整保存在 <code>xterm.js</code> 终端中，即使终端已关闭也能随时查看。这意味着你可以：</p>
<ul>
<li>对比不同命令的执行结果</li>
<li>追溯智能体运行的脚本输出</li>
<li>分享完整的错误信息给同事</li>
</ul>
<h3 data-id="heading-13">一键允许所有命令：信任智能体，解放双手</h3>
<p>在聊天中运行终端命令时，新增了 <strong>Allow All Commands in this Session</strong> 选项。启用后，当前会话中的所有终端命令都会自动批准，无需反复确认。对于信任的智能体，这能节省大量交互时间！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/101390277e4a45e084db64c5abb4fbba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqL5ryr6LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766488388&amp;x-signature=PHDwOisPS0GAyIAcTOLs9k4%2FqFM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">企业级特性：安全与管理并重</h2>
<h3 data-id="heading-15">智能体工具权限控制：精细管理 AI 能力</h3>
<p>企业管理员现在可以通过 <code>chat.tools.eligibleForAutoApproval</code> 设置，精确控制哪些智能体工具允许自动批准。对于 <code>runTask</code> 这类高危操作，可以强制要求人工确认，安全性大大提升！</p>
<h3 data-id="heading-16">GitHub 企业策略支持：云端开发无缝衔接</h3>
<p>使用 GitHub Codespaces 的团队，现在能自动应用企业策略。无论是 MCP 注册表配置还是智能体权限，都能在云端开发环境中保持一致，开发体验无缝衔接。</p>
<h2 data-id="heading-17">总结：AI 驱动开发的未来已来</h2>
<p>VS Code 1.107 版本通过 <strong>多智能体协同</strong>、<strong>背景任务处理</strong> 和 <strong>组织级智能体共享</strong>，将 AI 辅助开发推向了新阶段。它不仅是工具的升级，更是开发范式的转变——从 "开发者使用 AI" 到 "开发者指挥 AI 团队"。</p>
<p>最令人兴奋的是，这仅仅是开始。随着 TypeScript 7.0 的成熟和更多 AI 能力的整合，VS Code 正在朝着 "开发者思维放大器" 的方向快速进化。</p>
<p>立即通过 <strong>帮助 &gt; 检查更新</strong> 升级到 1.107 版本，或访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2F" target="_blank" title="https://code.visualstudio.com/" ref="nofollow noopener noreferrer">VS Code 官网</a> 下载最新安装包，体验这场开发效率的革命！</p>
<blockquote>
<p><strong>提示</strong>：想抢先体验未来功能？可以安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Finsiders%2F" target="_blank" title="https://code.visualstudio.com/insiders/" ref="nofollow noopener noreferrer">Insiders 版本</a>，每天获取最新更新！</p>
</blockquote>
<p>Happy Coding！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何查看、生成 github 开源项目star 图表]]></title>    <link>https://juejin.cn/post/7584071941025628175</link>    <guid>https://juejin.cn/post/7584071941025628175</guid>    <pubDate>2025-12-16T11:44:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584071941025628175" data-draft-id="7584266920641314867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何查看、生成 github 开源项目star 图表"/> <meta itemprop="keywords" content="前端,开源,ECharts"/> <meta itemprop="datePublished" content="2025-12-16T11:44:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玄魂"/> <meta itemprop="url" content="https://juejin.cn/user/571401774834093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何查看、生成 github 开源项目star 图表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401774834093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玄魂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T11:44:14.000Z" title="Tue Dec 16 2025 11:44:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">声明</h2>
<blockquote>
<p>重要声明：本应用基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstar-history%2Fstar-history" target="_blank" title="https://github.com/star-history/star-history" ref="nofollow noopener noreferrer">star-history/star-history</a> 改造升级，我们将持续加入更多数据分析能力，感谢原作者！本文档也在原仓库文档的基础上进行改写与完善。</p>
</blockquote>
<p>新的仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxuanhun%2Fgithub-data-analysis-" target="_blank" title="https://github.com/xuanhun/github-data-analysis-" ref="nofollow noopener noreferrer">github-data-analysis-</a></p>
<p>新项目更新了图表实现方式（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.visactor.com%2Fvchart" target="_blank" title="https://www.visactor.com/vchart" ref="nofollow noopener noreferrer">@visactor/vchart</a>)，加入mongodb 进行数据缓存，以减少对 GitHub API 的调用次数，提升性能。
加入了dark 主题，多语言等</p>
<hr/>
<h2 data-id="heading-1">在 GitHub README 中加入实时的 Star 历史图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/041f8a08a9774fcab14c4357c201a1d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=rdN8T4QV2avDcMW%2BdRGWZvLD47U%3D" alt="image.png" loading="lazy"/></p>
<p>我们支持把实时的 Star 历史图嵌入到你的 GitHub README 中。上图是我们自己的项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvisactor%2Fvchart" target="_blank" title="https://github.com/visactor/vchart" ref="nofollow noopener noreferrer">GitHub 数据分析</a> 的截图。</p>
<p>这个功能非常好用：在站点页面查询仓库后，会生成一段代码片段，你只需要把它复制到你的 README（或任何站点/博客）即可。</p>
<img width="1302" height="903" alt="image转存失败，建议直接上传图片文件" src="" loading="lazy"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08dceed37e9948188d51a9ddf51ec87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=6uw%2Fvjwbd5l5IJ6Ixy3Ltu1PDUY%3D" alt="image.png" loading="lazy"/>
下面介绍该功能的设计背景与具体用法。</p>
<h3 data-id="heading-2">使用 <code>&lt;iframe /&gt;</code> 方式嵌入</h3>
<p>在调研常见的网页嵌入实现后，我们选择使用 <code>&lt;iframe /&gt;</code> 作为嵌入容器：它无需后端即可展示原始图表，并且可以与实时数据交互。</p>
<p>由于 GitHub API 对匿名调用有严格限流，我们需要用户提供自己生成的 Token 来提升限额。</p>
<h4 data-id="heading-3"><code>iframe</code> 嵌入的使用步骤</h4>
<ol>
<li>
<p>打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitdata.xuanhun520.com%2F" target="_blank" title="https://gitdata.xuanhun520.com/" ref="nofollow noopener noreferrer">gitdata.xuanhun520.com</a> 并查询目标仓库；</p>
</li>
<li>
<p>点击图表下方的 <code>Embed</code> 按钮；</p>
</li>
<li>
<p>输入你的个人访问 Token；</p>
<img width="745" height="596" alt="image转存失败，建议直接上传图片文件" src="" loading="lazy"/>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c4b955faf39498bbfba4b6b866e183a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=fCwUkjsMQ2OZi%2B9YqBg99s6dOD4%3D" alt="image.png" loading="lazy"/>
4.  点击 <code>Copy</code> 按钮，把代码粘贴到你的站点或博客即可；</p>
<h3 data-id="heading-4">使用 SVG 静态图片嵌入（用于 README）</h3>
<p><code>iframe</code> 嵌入很强大，但也有两点限制：</p>
<ol>
<li>GitHub 的 Markdown 风格不允许渲染 <code>&lt;iframe /&gt;</code>，因此无法直接把交互图嵌到 README；</li>
<li>需要提供个人 Token。虽然我们不在服务器端存储 Token，但在网页源码中仍可看到它，这在公共场景下并不理想。</li>
</ol>
<p>因此，我们提供了基于图片链接的 SVG 方案，适合在公共页面（例如仓库 README）中展示最新星图。</p>
<h4 data-id="heading-5">在 GitHub README 中添加图表的步骤</h4>
<ol>
<li>
<p>打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitdata.xuanhun520.com" target="_blank" title="https://gitdata.xuanhun520.com" ref="nofollow noopener noreferrer">gitdata.xuanhun520.com</a> 并查询仓库；</p>
</li>
<li>
<p>滚动到操作按钮下方的图片嵌入区域；</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/107047db28f84d0ba6c4cc2fa79b247a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=Yk3833YHxok%2BY8VsIXlm7VMWAPg%3D" alt="image.png" loading="lazy"/>
3.  点击 <code>Copy</code> 按钮；</p>
<ol start="4">
<li>
<p>将代码粘贴到你的仓库 README 中；</p>
</li>
<li>
<p>搞定 😎</p>
</li>
</ol>
<p>示例链接（按日期模式展示）：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitdata.xuanhun520.com%2Fapi%2Fstarimg%3Frepos%3Dvisactor%2Fvchart%26type%3DDate%26theme%3Ddark" target="_blank" title="https://gitdata.xuanhun520.com/api/starimg?repos=visactor/vchart&amp;type=Date&amp;theme=dark" ref="nofollow noopener noreferrer">gitdata.xuanhun520.com/api/starimg…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3deef95f4e4689b18a313ca46dc75d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=4vmt40xt5AfN5fie7mHPIXOj28s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">结论</h3>
<p>我们提供两种把实时星图嵌入网页的方式：</p>
<ul>
<li>如果你希望在私有网络页面中放置可自适应且可交互的图表，请使用 <code>&lt;iframe /&gt;</code> 嵌入；</li>
<li>如果你希望在公共页面（例如 GitHub README）中展示最新的星图，请使用 SVG 图片链接方式，例如：</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">https://gitdata.xuanhun520.com/api/starimg?repos=visactor/vchart&amp;<span class="hljs-built_in">type</span>=Date&amp;theme=dark
</code></pre>
<hr/>
<h3 data-id="heading-7">下一步</h3>
<ul>
<li>多语言</li>
<li>加入更多数据分析能力，例如：仓库 forks 历史图、贡献者活动图等；</li>
<li>加入用户认证功能，以支持私有仓库的分析；</li>
<li>加入更多可视化形式，例如信息图，动态图表等</li>
</ul>
<h3 data-id="heading-8">欢迎star</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxuanhun%2Fgithub-data-analysis-" target="_blank" title="https://github.com/xuanhun/github-data-analysis-" ref="nofollow noopener noreferrer">star it </a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/398616932b064d5d87643629d0207605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546E6a2C:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766490254&amp;x-signature=5JYziidoTbedFxoX5a0eIoxi9Tc%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ruoyi集成dmn规则引擎]]></title>    <link>https://juejin.cn/post/7583878719543738377</link>    <guid>https://juejin.cn/post/7583878719543738377</guid>    <pubDate>2025-12-15T10:22:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583878719543738377" data-draft-id="7583871118949236786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ruoyi集成dmn规则引擎"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-15T10:22:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ruoyi集成dmn规则引擎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T10:22:59.000Z" title="Mon Dec 15 2025 10:22:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">环境说明</h2>
<p>基于RuoYi-Vue2q前端如何集成DMN组件<br/>
版本号:3.9.0<br/>
更多关于ruoyi集成工作流，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com%2Fproduct%2F3" target="_blank" title="https://www.ruoyiflow.com/product/3" ref="nofollow noopener noreferrer">若依工作流</a></p>
<h2 data-id="heading-1">集成步骤</h2>
<ul>
<li>安装依赖</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">npm install dmn-js dmn-js-properties-panel --save
npm install --save dmn-moddle
</code></pre>
<ul>
<li>vue.config.js增加dmn.js配置, 在transpileDependencies，alias 进行设置</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">lias: {
    '@': resolve('src'),
    'lezer-feel$': resolve('node_modules/lezer-feel/dist/index.js'),
    '@camunda/feel-builtins$': resolve('node_modules/@camunda/feel-builtins/dist/index.js'),
    'feelers$': resolve('node_modules/feelers/dist/index.js'),
    'feelin$': resolve('node_modules/feelin/dist/index.cjs'),
    '@bpmn-io/feel-lint$': resolve('node_modules/@bpmn-io/feel-lint/dist/index.js'),
    '@bpmn-io/lezer-feel$': resolve('node_modules/@bpmn-io/lezer-feel/dist/index.js'),
    // dmn-moddle 使用 ES 模块，webpack4 需要指向 CJS 版本
    'dmn-moddle$': resolve('node_modules/dmn-moddle/dist/index.cjs')
    }

  transpileDependencies: [
    'quill', 
    'bpmn-js', 
    'diagram-js',
    'bpmn-js-properties-panel',
    '@bpmn-io/properties-panel',
    '@bpmn-io/feel-editor',
    '@bpmn-io/feel-lint', 
    '@bpmn-io/lezer-feel', 
    'feelers', 
    //以下是dmn-js需要的配置，主要是因为dmn-js 使用了 ES6+ 语法，但 webpack 未转译 node_modules 中的这些文件
    'lezer-feel',
    'dmn-js',
    'dmn-js-properties-panel',
    'dmn-js-boxed-expression',
    'dmn-js-decision-table',
    'dmn-js-literal-expression',
    'dmn-js-shared',
    'dmn-moddle'],
</code></pre>
<ul>
<li>前端页面编码</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-container class="dmn-modeler-container"&gt;
    &lt;!-- 头部操作区域 --&gt;
    &lt;el-header class="dmn-header"&gt;
      &lt;div class="header-content"&gt;
        &lt;div class="header-title"&gt;
          &lt;h3&gt;DMN 决策表建模器&lt;/h3&gt;
        &lt;/div&gt;
        &lt;div class="header-actions"&gt;
          &lt;el-button-group&gt;
            &lt;el-button icon="el-icon-folder-opened" @click="openFile"&gt;导入&lt;/el-button&gt;
            &lt;el-button icon="el-icon-download" @click="downloadDiagram"&gt;导出&lt;/el-button&gt;
            &lt;el-button icon="el-icon-document" type="primary" @click="saveDiagram"&gt;部署&lt;/el-button&gt;
          &lt;/el-button-group&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/el-header&gt;
    
    &lt;!-- 主要内容区域 --&gt;
    &lt;el-main class="dmn-main"&gt;
      &lt;div class="dmn-content"&gt;
        &lt;!-- DMN 画布区域 --&gt;
        &lt;div class="canvas-container"&gt;
          &lt;div id="canvas" class="dmn-canvas" v-loading="initializing"&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/el-main&gt;
    
    &lt;!-- 文件输入 --&gt;
    &lt;input 
      ref="fileInput" 
      type="file" 
      accept=".dmn,.xml" 
      style="display: none" 
      @change="handleFileImport"
    /&gt;
  &lt;/el-container&gt;
&lt;/template&gt;

&lt;script&gt;
import DmnModeler from 'dmn-js/lib/Modeler'
import FileSaver from 'file-saver'
import { deployDmnTable } from '@/api/camunda/dmn'

// 样式引入
// 基础样式
import 'dmn-js/dist/assets/diagram-js.css'
// DMN 字体样式
import 'dmn-js/dist/assets/dmn-font/css/dmn.css'
// 决策表相关样式（确保决策表正确显示）
import 'dmn-js/dist/assets/dmn-js-shared.css'
import 'dmn-js/dist/assets/dmn-js-decision-table.css'
import 'dmn-js/dist/assets/dmn-js-decision-table-controls.css'
// DRD (Decision Requirements Diagram) 视图样式
import 'dmn-js/dist/assets/dmn-js-drd.css'

export default {
  name: 'CamundaDmnModeler',
  data() {
    return {
      dmnModeler: null,
      canUndo: false,
      canRedo: false,
      isInitialized: false, // 标记是否初始化成功
      initializing: false, // 初始化或导入中的 loading 状态
      initPromise: null // 记录初始化 Promise，便于后续等待
    }
  },
  mounted() {
    this.$nextTick(() =&gt; {
      this.initModeler()
    })
  },
  beforeDestroy() {
    if (this.dmnModeler) {
      this.dmnModeler.destroy()
      this.dmnModeler = null
    }
    this.initPromise = null
  },
  methods: {
    // 生成随机决策表ID
    generateDecisionId() {
      const randomNum = Math.floor(Math.random() * 10000)
      return `Decision_${randomNum}`
    },

    initModeler() {
      if (this.initializing &amp;&amp; this.initPromise) {
        return this.initPromise
      }

      try {
        // 如果已有实例，先销毁重新创建，避免残留状态
        if (this.dmnModeler) {
          try {
            this.dmnModeler.destroy()
          } catch (destroyErr) {
            console.warn('销毁旧的 DMN Modeler 失败:', destroyErr)
          }
        }

        this.dmnModeler = new DmnModeler({
          container: '#canvas'
        })
        this.initializing = true
        this.isInitialized = false
        
        // 加载空白决策表 - 使用标准的 DMN 1.3 格式
        // 根据 dmn-moddle 11.0.0，使用正确的命名空间
        const decisionId = this.generateDecisionId()
        const decisionTableId = 'DecisionTable_' + Date.now()
        const diagramXML = `&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;definitions xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/" xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI" xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/" xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/" id="Definitions_1" name="决策表" namespace="http://camunda.org/schema/1.0/dmn"&gt;
  &lt;decision id="${decisionId}" name="决策表"&gt;
    &lt;decisionTable id="${decisionTableId}" hitPolicy="UNIQUE"&gt;
      &lt;input id="Input_1" label="输入"&gt;
        &lt;inputExpression id="InputExpression_1" typeRef="string"&gt;
          &lt;text&gt;&lt;/text&gt;
        &lt;/inputExpression&gt;
      &lt;/input&gt;
      &lt;output id="Output_1" label="输出" typeRef="string" /&gt;
    &lt;/decisionTable&gt;
  &lt;/decision&gt;
  &lt;dmndi:DMNDI&gt;
    &lt;dmndi:DMNDiagram id="DMNDiagram_1"&gt;
      &lt;dmndi:DMNShape id="DMNShape_${decisionId}" dmnElementRef="${decisionId}"&gt;
        &lt;dc:Bounds x="100" y="100" width="300" height="200" /&gt;
      &lt;/dmndi:DMNShape&gt;
    &lt;/dmndi:DMNDiagram&gt;
  &lt;/dmndi:DMNDI&gt;
&lt;/definitions&gt;`

        // 使用箭头函数确保 this 上下文正确
        const initTask = this.dmnModeler.importXML(diagramXML)
        this.initPromise = initTask
        initTask.then(() =&gt; {
          // 只有在 importXML 成功后才标记为已初始化
          this.isInitialized = true
          this.initializing = false
          this.$message.success('决策表初始化成功')
          
          // 确保 dmnModeler 已完全初始化后再访问服务
          if (this.dmnModeler &amp;&amp; typeof this.dmnModeler.get === 'function') {
            // 等待 DOM 更新
            this.$nextTick(() =&gt; {
              // 监听撤销重做状态
              const eventBus = this.dmnModeler.get('eventBus')
              if (eventBus) {
                eventBus.on('commandStack.changed', () =&gt; {
                  if (this.dmnModeler &amp;&amp; typeof this.dmnModeler.get === 'function') {
                    const commandStack = this.dmnModeler.get('commandStack')
                    if (commandStack) {
                      this.canUndo = commandStack.canUndo()
                      this.canRedo = commandStack.canRedo()
                    }
                  }
                })
              }
              
            })
          }
        }).catch(err =&gt; {
          console.error('初始化失败:', err)
          console.error('XML 内容:', diagramXML)
          this.isInitialized = false
          this.initializing = false
          this.$message.error('决策表初始化失败: ' + (err.message || '未知错误'))
          // 如果初始化失败，清空 dmnModeler，避免使用不完整的状态
          if (this.dmnModeler) {
            try {
              this.dmnModeler.destroy()
            } catch (e) {
              console.warn('销毁失败的 modeler:', e)
            }
            this.dmnModeler = null
          }
          throw err
        }).finally(() =&gt; {
          // 保持 initPromise 只代表最近一次初始化
          if (this.initPromise === initTask) {
            this.initPromise = null
          }
        })

        return initTask
      } catch (err) {
        console.error('创建 DMN Modeler 失败:', err)
        this.$message.error('创建决策表建模器失败: ' + (err.message || '未知错误'))
        this.initializing = false
        this.isInitialized = false
        this.initPromise = null
        throw err
      }
    },

    async ensureModelerReady() {
      debugger
      if (this.isInitialized &amp;&amp; this.dmnModeler &amp;&amp; typeof this.dmnModeler.get === 'function') {
        return true
      }
      if (!this.initializing || !this.initPromise) {
        try {
          await this.initModeler()
        } catch (err) {
          console.error('重新初始化决策表建模器失败:', err)
          return false
        }
      }
      if (this.initPromise) {
        try {
          await this.initPromise
        } catch (err) {
          console.error('等待决策表建模器初始化失败:', err)
          return false
        }
      }
      return this.isInitialized &amp;&amp; this.dmnModeler &amp;&amp; typeof this.dmnModeler.get === 'function'
    },

    // 确保XML包含必要的命名空间
    ensureDmnNamespace(xml) {
      // 检查是否包含正确的 DMN 1.3 命名空间
      // MODEL 命名空间应该是 https://www.omg.org/spec/DMN/20191111/MODEL/
      if (xml.indexOf('xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/"') === -1 &amp;&amp; 
          xml.indexOf('xmlns:dmn="https://www.omg.org/spec/DMN/20191111/MODEL/"') === -1) {
        // 如果缺少默认命名空间，尝试添加
        if (xml.indexOf('&lt;definitions') !== -1) {
          // 替换 definitions 标签，添加默认命名空间
          xml = xml.replace(
            /&lt;definitions([^&gt;]*)&gt;/,
            '&lt;definitions$1 xmlns="https://www.omg.org/spec/DMN/20191111/MODEL/" xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI" xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/" xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/"&gt;'
          )
        } else if (xml.indexOf('&lt;dmn:definitions') !== -1) {
          // 如果使用 dmn: 前缀，也添加命名空间
          xml = xml.replace(
            /&lt;dmn:definitions([^&gt;]*)&gt;/,
            '&lt;dmn:definitions$1 xmlns:dmn="https://www.omg.org/spec/DMN/20191111/MODEL/" xmlns:dmndi="http://www.omg.org/spec/DMN/20180521/DMNDI" xmlns:di="http://www.omg.org/spec/DMN/20180521/DI/" xmlns:dc="http://www.omg.org/spec/DMN/20180521/DC/"&gt;'
          )
        }
      }
      return xml
    },

    // 从 XML 中提取第一个 decision 的 name 属性
    extractDecisionName(xml) {
      if (!xml || typeof xml !== 'string') {
        return null
      }
      try {
        if (typeof window !== 'undefined' &amp;&amp; window.DOMParser) {
          const parser = new DOMParser()
          const doc = parser.parseFromString(xml, 'text/xml')
          const parserError = doc.getElementsByTagName('parsererror')
          if (parserError &amp;&amp; parserError.length) {
            console.warn('DOMParser 解析 DMN XML 出错，退回正则解析')
          } else {
            // 先尝试不带命名空间的 decision
            let decisionEl = doc.getElementsByTagName('decision')[0]
            if (!decisionEl) {
              // 再尝试带命名空间的 decision
              decisionEl = doc.getElementsByTagNameNS('https://www.omg.org/spec/DMN/20191111/MODEL/', 'decision')[0]
            }
            if (decisionEl) {
              const name = decisionEl.getAttribute('name')
              if (name) {
                return name
              }
            }
          }
        }
      } catch (err) {
        console.warn('DOMParser 提取决策名称失败:', err)
      }

      // 正则后备方案，兼容单引号或双引号
      const match = xml.match(/&lt;\s*(?:dmn:)?decision\b[^&gt;]*\bname=['"]([^'"]+)['"]/i)
      if (match &amp;&amp; match[1]) {
        return match[1]
      }
      return null
    },

    async saveDiagram() {
      try {
        // const ready = await this.ensureModelerReady()
        // if (!ready) {
        //   this.$message.error('决策表建模器未初始化，请稍后再试')
        //   return
        // }
        
        const modeler = this.dmnModeler
        // if (!modeler || typeof modeler.get !== 'function') {
        //   this.$message.error('决策表建模器不可用，请刷新页面后重试')
        //   return
        // }

        const { xml } = await modeler.saveXML({ 
          format: true,
          preamble: true
        })
        
        // 确保XML包含必要的命名空间
        const processedXml = this.ensureDmnNamespace(xml)
        
        // 获取决策表名称：优先读取 XML 中 decision 的 name
        let decisionName = this.extractDecisionName(processedXml)
        
        if (!decisionName) {
          try {
            const elementRegistry = modeler.get('elementRegistry')
            if (elementRegistry) {
              // 尝试从决策表中获取名称
              const decisions = elementRegistry.filter(el =&gt; el.type === 'dmn:Decision')
              if (decisions.length &gt; 0) {
                const decision = decisions[0]
                const bo = decision.businessObject || decision
                decisionName = bo.name || bo.id || decisionName
              }
            }
          } catch (e) {
            console.warn('从 elementRegistry 获取决策表名称失败:', e)
          }
        }

        if (!decisionName) {
          decisionName = 'decision_' + Date.now()
        }
        
        // 准备部署参数
        const deployData = {
          decisionName: decisionName,
          dmnXml: processedXml,
          tenantId: '',
          description: '决策表部署'
        }
        
        // 调用部署API
        this.$message.info('正在部署决策表...')
        const response = await deployDmnTable(deployData)
        
        this.$message.success(`决策表部署成功！决策名称: ${decisionName}`)
        
        console.log('Deployment response:', response)
        // 跳转到决策表列表页面
        this.$router.push('/dmn/list')
        
      } catch (err) {
        console.error('Deployment error:', err)
        const errorMessage = err.response?.data?.message || err.message || '部署失败'
        this.$message.error('部署失败: ' + errorMessage)
      }
    },

    async downloadDiagram() {
      try {
        // const ready = await this.ensureModelerReady()
        // if (!ready) {
        //   this.$message.error('决策表建模器未初始化，请稍后再试')
        //   return
        // }
        
        const modeler = this.dmnModeler
        // if (!modeler || typeof modeler.get !== 'function') {
        //   this.$message.error('决策表建模器不可用，请刷新页面后重试')
        //   return
        // }

        const { xml } = await modeler.saveXML({ 
          format: true,
          preamble: true
        })
        // 确保XML包含必要的命名空间
        const processedXml = this.ensureDmnNamespace(xml)
        const blob = new Blob([processedXml], { type: 'application/xml' })
        FileSaver.saveAs(blob, 'decision-table.dmn')
      } catch (err) {
        this.$message.error('导出失败: ' + (err.message || '未知错误'))
      }
    },

    openFile() {
      this.$refs.fileInput.click()
    },
    
    async handleFileImport(event) {
      const file = event.target.files[0]
      if (!file) return
      
      // const ready = await this.ensureModelerReady()
      // if (!ready) {
      //   this.$message.error('决策表建模器初始化失败，请刷新页面后重试')
      //   return
      // }
      
      const reader = new FileReader()
      reader.onload = (e) =&gt; {
        try {
          const xml = e.target.result
          this.initializing = true
          const modeler = this.dmnModeler
          // if (!modeler || typeof modeler.get !== 'function') {
          //   this.initializing = false
          //   this.$message.error('决策表建模器不可用，请刷新页面后重试')
          //   return
          // }
          modeler.importXML(xml).then(() =&gt; {
            this.isInitialized = true
            this.initializing = false
            this.$message.success('文件导入成功')
          }).catch(error =&gt; {
            console.error('文件导入失败:', error)
            this.isInitialized = false
            this.initializing = false
            this.$message.error('文件导入失败: ' + (error.message || '未知错误'))
          })
        } catch (error) {
          console.error('文件读取失败:', error)
          this.initializing = false
          this.$message.error('文件读取失败: ' + (error.message || '未知错误'))
        }
      }
      reader.readAsText(file)
      
      // 清空文件输入
      event.target.value = ''
    }
  }
}
&lt;/script&gt;

&lt;style scoped&gt;
.dmn-modeler-container {
  width: 100%;
  height: 100vh;
  min-width: 900px;
  display: flex;
  flex-direction: column;
}

/* 头部样式 */
.dmn-header {
  background-color: #f5f7fa;
  border-bottom: 1px solid #e4e7ed;
  padding: 0 20px;
  height: 60px !important;
  display: flex;
  align-items: center;
}

.header-content {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title h3 {
  margin: 0;
  color: #303133;
  font-size: 18px;
  font-weight: 500;
}

.header-actions {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.header-actions .el-button-group {
  margin-right: 0;
}

.header-actions .el-button-group .el-button {
  margin-right: 0;
}

/* 主内容区域样式 */
.dmn-main {
  padding: 0;
  height: calc(100vh - 60px);
  overflow: hidden;
}

.dmn-content {
  display: flex;
  height: 100%;
  width: 100%;
}

/* 画布容器样式 */
.canvas-container {
  flex: 1;
  position: relative;
  display: flex;
  flex-direction: column;
  min-width: 0; /* 允许 flex 子元素缩小 */
}

.dmn-canvas {
  width: 100%;
  height: 100%;
  border: 1px solid #dcdfe6;
  background-color: #fff;
}

&lt;/style&gt;

</code></pre>
<h2 data-id="heading-2">最终页面展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a96e614955d4819805d2fc81d5ca3c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766398979&amp;x-signature=Mz%2BtwnNwYlHxCrRajjgE55UwMz0%3D" alt="dmn1.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>